<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêì üèí üíò Bannerwerbung in iOS-Anwendung üë¨ ü•å üëáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heute er√∂ffnen wir eine Reihe von Artikeln dar√ºber, wor√ºber auf technischen Konferenzen und Tagungen normalerweise nicht gesprochen wird. In diesem un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bannerwerbung in iOS-Anwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/426553/"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Heute er√∂ffnen wir eine Reihe von Artikeln dar√ºber, wor√ºber auf technischen Konferenzen und Tagungen normalerweise nicht gesprochen wird.  In diesem und den folgenden Beitr√§gen erfahren Sie, wie der Monetarisierungsmechanismus in der in den USA beliebten iFunny iOS-Unterhaltungsanwendung funktioniert, die wir entwickeln. <br><a name="habracut"></a><br>  Werbung ist eine der wichtigsten M√∂glichkeiten, um kostenlose Anwendungen zu monetarisieren.  Aber welche Optionen gab es 2011, als iFunny erschien?  Der Service wurde urspr√ºnglich als starkes, nachhaltiges Unternehmen entwickelt. Daher entschied sich das Unternehmen vom ersten Tag an, nicht mit Benutzern zu flirten und sich nicht auf Spiele mit bedingter Kapitalisierung einzulassen. <br><br>  Zu dieser Zeit bestand die Hauptoption f√ºr die Monetarisierung darin, eine kostenlose abgespeckte Version des Dienstes zu erstellen und dann zu versuchen, die Hauptfunktionalit√§t zu verkaufen.  Der Verbraucher war jung, unerfahren und nicht bereit, sich von Betr√§gen √ºber einem Dollar zu trennen. <br><br>  Einfache Mathematik hat gezeigt, dass es bei einer Umwandlung von 10% fast unm√∂glich ist, einen ARPU von mehr als 10 Cent zu erhalten. <br><br>  Dann musste ich dar√ºber nachdenken, wie Sie das Produkt sonst noch monetarisieren k√∂nnen.  Das Werbemodell hat im Web bereits sehr gut funktioniert, und es ist davon auszugehen, dass es bald auch auf Handys aufbl√ºhen wird. <br>  Im Allgemeinen kann der Beginn des mobilen Werbemodells der Monetarisierung als das Erscheinen von AdWhirl betrachtet werden - einem Dienst, mit dem Sie das SDK von Werbenetzwerken integrieren und rotieren konnten.  Durch sein Erscheinen konnte FillRate auf durchschnittlich 50% des Marktes angehoben und die Einnahmen aus dem Werbemodell mindestens mit Ein-Dollar-Verk√§ufen vergleichbar gemacht werden.  Das Prinzip der Umsetzung aller m√∂glichen Nachfragequellen und der Organisation des Wettbewerbs zwischen ihnen ist zum Hauptwachstumstreiber in der Werbebranche geworden und wird bis heute genutzt. <br><br>  Aber je komplexer das System ist, desto weniger stabil wird es, was f√ºr gro√üe Dienste der iFunny-Ebene absolut inakzeptabel ist.  Das Unternehmen begann 2011, sich in diese Richtung zu bewegen, und schuf einen der effektivsten Mechanismen f√ºr die Arbeit mit mobilen Bannern und nativer Werbung. Der Umsatz pro Nutzer konnte um das 40-fache gesteigert werden, wodurch nicht nur interne Projekte entwickelt, sondern auch in andere Unternehmen investiert werden konnten. <br><br><h2>  MoPub und Firma </h2><br>  Seit 2012 sind wir von AdWhirl zu MoPub gewechselt. <br><br>  MoPub ist eine mobile Werbeplattform mit der M√∂glichkeit, eigene Module hinzuzuf√ºgen, die mehrere gro√üartige Tools enthalten: <br><br><ul><li>  MoPub-Marktplatz - eigene Werbeb√∂rse; </li><li>  Vermittler von Werbenetzwerken f√ºr die Arbeit mit externen Netzwerken; </li><li>  Ein Bestellmechanismus, mit dem Sie Banner unabh√§ngig in Ihrer eigenen Anwendung platzieren und ihre Anzeigen anpassen k√∂nnen. </li></ul><br>  Die Hauptvorteile von MoPub: <br><br><ul><li>  in der Lage, mit den meisten Werbenetzwerken zu arbeiten; </li><li>  klarer Mechanismus f√ºr die Verbindung neuer Netzwerke von Drittanbietern; </li><li>  Open Source </li><li>  eine gro√üe Anzahl von Grundeinstellungen und Targeting; </li><li>  Als gro√üe Community rund um das Netzwerk gibt es sogar eine eigene Konferenz. </li></ul><br>  MoPub hat auch Nachteile: <br><br><ul><li> Pool-Anfragen auf GitHub werden nicht akzeptiert und es gibt √ºberhaupt keine Reaktion darauf. </li><li>  Das Control Panel ist sehr komplex und f√ºr den Entwickler dauert es beim Debuggen einige Zeit, sich mit seiner Struktur zu befassen. </li></ul><br><h2>  Die Kraft der Wahrheit </h2><br>  Wie der Held eines russischen Films sagte: "St√§rke ist in Wahrheit."  In diesem Teil werde ich √ºber die Schwierigkeiten sprechen, mit denen wir als Anwendungsentwickler nach den ersten Millionen Downloads von iFunny, dem Wachstum des Publikums und dem Werbeverkehr von mehr als 100 Partnern konfrontiert waren. <br><br><h3>  Inhalt </h3><br>  Der Werbemarkt ist eine sehr geschlossene ‚ÄûKaste‚Äú von Technologieunternehmen, aber gleichzeitig verf√ºgen Aggregatoren √ºber ein gro√ües Netzwerk von Partnern: von gro√üen Unternehmen, die mit Millionen von Budgets arbeiten, bis zu kleinen Unternehmen, die auf bestimmte Zielgruppen zugeschnitten sind. <br><br>  Diese N√§he und Fragmentierung der Partner erm√∂glicht es den ehrlichsten Werbeverk√§ufern trotz der Vormoderation der Banner und der strengen Regeln f√ºr Werbeinhalte nicht, Motive zu ver√∂ffentlichen, die verboten sind oder die Benutzererfahrung in der Anwendung beeintr√§chtigen. <br><br>  Es gibt mehrere Hauptkategorien von ‚Äûobsz√∂nen‚Äú Inhalten in Werbebannern: <br><br><ul><li>  Porno-Inhalt.  In letzter Zeit erscheint es immer weniger, aber es findet dennoch statt.  Wir k√∂nnen diesen Inhalt nicht im Artikel ver√∂ffentlichen, daher wird das Bild nicht hier sein </li><li>  Systemwarnungen in Bannern, ein Beispiel kann unter einem der Benutzer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">twitter.com/IfunnyStates/status/1029393804749668352</a> angezeigt werden </li><li>  zufrieden mit Ton.  Sounds werden von Werbenetzwerken sowie Animationen nicht verboten. Wenn der Sound jedoch ohne Interaktion mit der Benutzeroberfl√§che abgespielt wird, wird dies von den Benutzern als Anwendungsfehler wahrgenommen und wirkt sich negativ auf die Benutzererfahrung aus </li><li>  Aufmerksamkeit erregen.  Ein gutes Banner sollte die Aufmerksamkeit des Benutzers auf sich ziehen, aber dies geschieht nicht immer auf ehrliche Weise: Manchmal fallen flackernde Videos in die Banner.  Eine andere unehrliche M√∂glichkeit, den Benutzer dazu zu bringen, auf das Banner zu tippen, besteht darin, die Anwendungsoberfl√§che zu simulieren, beispielsweise wie folgt: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  √úbrigens kann in Russland ein gew√∂hnliches Tippen auf dieses Banner f√ºr einige Mobilfunkbetreiber ein kostenpflichtiges Abonnement ausstellen, und Sie werden es erst erfahren, wenn Sie die Details sehen.  Dies ist auch eine unehrliche Art, mit Werbung zu arbeiten, aber Betreiber in den USA haben keine solche Gelegenheit. <br><br><h3>  Automatische Klicks </h3><br>  Wie meine Erfahrung zeigt, ist dies ein √§u√üerst negativer Fall f√ºr Benutzer.  Mit den Funktionen von JavaScript, WKWebView oder UIWebView sowie L√ºcken in der Implementierung von Werbebibliotheken k√∂nnen Sie Anzeigen erstellen, die den Bannerinhalt selbst √∂ffnen und den Benutzer aus der Anwendung herausf√ºhren. <br><br>  Um dieses Problem am Beispiel von MoPub zu wiederholen, f√ºgen Sie einfach den Javascript-Code des folgenden Inhalts zum Banner hinzu: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Dies funktionierte lange Zeit in vielen Versionen von MoPub bis zur Version 4.13. <br><br>  Durch die Untersuchung der Implementierung von MoPub konnten komplexere Links generiert werden, mit denen nicht nur Anzeigen im Vollbildmodus ge√∂ffnet, sondern der Benutzer auch an den AppStore an eine bestimmte Anwendung gesendet und die Banneranzeige nicht einmal ber√ºcksichtigt werden konnte. <br><br>  √úbrigens gibt es in den Versionshinweisen f√ºr Version 4.13.0 des MoPub SDK f√ºr iOS keine Informationen zu diesem Fix, da es ein ziemlich schwerwiegendes Loch im SDK war und die unehrlichen Partner von MoPub es ziemlich aktiv ausnutzten.  Wie die Protokolle zeigen, auf die ich sp√§ter noch eingehen werde, musste ich jeden Tag bis zu 2 Millionen Versuche blockieren, das Banner ohne Benutzerinteraktion zu √∂ffnen. <br><br>  Im Fall von MoPub stellte sich heraus, dass das Problem leicht zu finden und zu wiederholen war. Andere Netzwerke, mit denen iFunny arbeitet, haben jedoch einen geschlossenen Code, und Sie m√ºssen sich mit neu auftretenden automatischen Klicks auseinandersetzen, indem Sie Banner blockieren oder sogar Netzwerke f√ºr eine Weile trennen. <br>  iFunny arbeitet eng mit allen Werbepartnern zusammen und informiert sie √ºber solche Banner.  Da das junge Publikum von iFunny f√ºr Werbetreibende interessant ist, treffen sich die Partner bereitwillig mit ihnen und entfernen solche Anzeigen aus der Rotation. <br><br><h3>  Absturz </h3><br>  Absturz ist immer schlimm.  Schlimmer noch, wenn sie aufgrund einer Abh√§ngigkeit von Closed Source auftreten und Sie sie nur indirekt beeinflussen k√∂nnen.  Im Laufe der Jahre der Arbeit mit Werbung bei iFunnu wurden verschiedene Arten von Abst√ºrzen identifiziert, die in mehrere Gruppen unterteilt werden k√∂nnen. <br><br><ul><li>  System </li></ul><br>  Dazu geh√∂ren Ausnahmen in der Netzwerkbibliothek, WKWebView (UIWebView), OpenGL. <br>  Es ist sehr schwierig, diese Art von Abst√ºrzen direkt zu beeinflussen, aber es war immer noch m√∂glich, einige von ihnen zu beeinflussen, nachdem zuvor die Funktionsweise der WebView-Komponente mit WebGL untersucht worden war. <br><br>  So sieht der Stackrace solcher Abst√ºrze aus: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  Dar√ºber hinaus treten sie ausschlie√ülich beim Verlassen im Hintergrund auf.  Dies liegt an der Tatsache, dass die OpenGL-Engine nicht funktionieren sollte, wenn sich die Anwendung im Hintergrund befindet. <br><br>  Die L√∂sung hier erwies sich als recht einfach: <br><br>  Wenn Sie im Hintergrund gehen, m√ºssen Sie einen Screenshot des Banners machen. <br><br>  Entfernen Sie die Werbeansicht vom Bildschirm, damit die WebView-Komponente OpenGL nicht mehr verwendet. <br>  Wenn Sie den Hintergrund verlassen, geben Sie alles so zur√ºck, wie es war. <br><br>  Im Objective-C-Code sieht es folgenderma√üen aus: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Integration </li></ul><br>  Dies sind Probleme, die an der Kreuzung von iFunny, Mopub und dem Werbeanbieter auftreten. <br>  Sie entstehen in der Regel nach der Aktualisierung der Provider-Bibliothek und aufgrund neuer Interaktionsm√∂glichkeiten mit ihnen. <br><br>  Der letzte derartige Fall war im Juni dieses Jahres nach dem n√§chsten Update einer der verwendeten Bibliotheken.  Eine neue Methode zum Initialisieren der Bibliothek schlug vor, Singleton zum Konfigurieren der Netzwerkeinstellungen zu verwenden. <br><br>  Wenn ich zweimal darauf zur√ºckkam, wie es in der Implementierung der Fall war, verursachte dies regelm√§√üig einen Fries des Hauptthreads, sodass ich die Initialisierung in dispatch_once einschlie√üen musste. <br><br>  Die iFunny-QS-Abteilung kann Werbebibliotheken gut testen, sodass dieses Problem beim Testen des Updates festgestellt wurde. <br><br><ul><li>  Unerwartet </li></ul><br>  Diese Art von Abst√ºrzen kann √ºberhaupt nicht kontrolliert werden, da sie ohne √Ñnderungen im Client auftritt. <br><br>  Sie sind mit der Aktualisierung des Backends von Partnern und der mangelnden Abw√§rtskompatibilit√§t verbunden.  Solche Abst√ºrze treten h√§ufig bei gro√üen Werbeanbietern auf, werden jedoch schnell behoben, da sie eine gro√üe Anzahl von Anwendungen gleichzeitig betreffen. <br><br>  Es gab F√§lle, in denen der Absturz von iFunny pro Tag von 99,8% auf 80% sank und die Anzahl der ver√§rgerten Kommentare in der Geschichte bei zehn lag. <br><br><h4>  Leistung </h4><br>  Bannerwerbung verwendet in der Regel WebView-Komponenten, um Werbung anzuzeigen. Jedes angezeigte Banner ist also eine Initialisierung eines neuen WebView mit all seinen Abh√§ngigkeiten. <br><br>  Dar√ºber hinaus verwenden einige Partner WebView auch zur Kommunikation mit ihrem eigenen Backend, da Bannerwerbung auf Mobilger√§ten ein Nachkomme von Werbung im Web ist. <br><br>  Es kommt vor, dass nach dem Upgrade Speicherlecks in der neuen Bibliothek auftreten.  Nach dem Erscheinen des Memory Graph-Tools in Xcode wurde es viel einfacher, Lecks in Bibliotheken von Drittanbietern zu finden, sodass Partner jetzt schnell dar√ºber informiert werden k√∂nnen. <br><br>  Unten ist das GIF von iFunny im Leerlauf, wenn keine Werbung f√ºr den Benutzer vorhanden ist: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  L√∂sungen </h2><br>  Trotz aller oben beschriebenen Probleme ist iFunny stabil und sorgt jeden Tag bei Millionen seiner Benutzer f√ºr ein L√§cheln. <br><br>  W√§hrend der jahrelangen aktiven Arbeit mit Werbung verf√ºgt das Entwicklungsteam √ºber mehrere Tools, mit denen Werbeprobleme erfolgreich √ºberwacht und rechtzeitig behoben werden k√∂nnen. <br><br><h3>  Protokollierungssystem </h3><br>  Jetzt hat sich das Ausnahmeprotokollierungssystem in iFunny auf die gesamte Anwendung ausgeweitet: Dazu verwenden wir unser eigenes Backend mit einer Basis auf ClickHouse und der Anzeige in Grafana. <br><br>  Die erste Aufgabe f√ºr die Arbeit mit Protokollen in der Anwendung war jedoch genau die Protokollierung von Ausnahmesituationen in der Werbung. <br><br>  Es gibt verschiedene verwandte Komponenten, um festzustellen, ob ein Anruf an iFunny weitergeleitet wird.  Ich werde Ihnen mehr √ºber jeden von ihnen erz√§hlen. <br><br><h4>  IFAdView </h4><br>  Dies ist der Nachkomme der MPAdView-Klasse (sie ist f√ºr die Anzeige von Anzeigen in MoPub verantwortlich). <br><br>  Die Methode hitTest: withEvent wird in dieser Klasse √ºberschrieben: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Daher setzen wir den Ausl√∂ser daf√ºr, dass der Benutzer mit der Werbung interagiert. <br><br><h4>  IFURLProtocol </h4><br>  Wir erben von NSURLProtocol und beschreiben die Methode: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  Dies ist ein Ausl√∂ser zum √ñffnen des AppStore in der Anwendung. Wir listen alle verf√ºgbaren URLs daf√ºr auf. <br><br><h4>  IFAdsExceptionManager </h4><br>  Eine Klasse, die Trigger sammelt und einen Ausnahmedatensatz im Protokoll generiert. <br><br>  Um zu verdeutlichen, welche Art von Triggern es gibt, werde ich jede Methode der Schnittstelle dieser Klasse beschreiben. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  Ein Ausl√∂ser, der bestimmt, ob eine Umleitung in iTunes erfolgt. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  Ein Ausl√∂ser, um den Aktivit√§tsverlust einer Anwendung zu bestimmen.  Es vergleicht die beiden vorherigen Trigger. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Trigger zur√ºcksetzen.  Wir nennen es, wenn wir den Hintergrund verlassen oder den AppStore selbst √∂ffnen, beispielsweise wenn wir den Benutzer zur Bewertung in √§lteren Versionen von iOS senden. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Eigenschaften zum Aufzeichnen der zuletzt erfolgreich oder nicht erfolgreich angeforderten und heruntergeladenen Anzeigen.  Muss eine Nachricht an das Protokoll senden. <br><br>  Es ist ersichtlich, dass sich der Algorithmus als recht einfach, aber effektiv herausstellte.  Damit k√∂nnen wir nicht nur automatische Entdeckungen von MoPub, sondern auch von anderen Netzwerken verfolgen. <br><br>  In letzter Zeit √∂ffnen Anzeigen mit automatischer √ñffnung h√§ufig SKStoreProductViewController. Daher arbeiten wir jetzt an der Definition der automatischen √ñffnung dieses Controllers.  Der Algorithmus zum Definieren dieser Ausnahme wird etwas komplizierter sein, aber Objective-C Runtime wird uns hier helfen. <br><br><h2>  Lokaler Stand </h2><br>  Basierend auf dem Protokollierungssystem begann iFunny auch mit der Entwicklung eines lokalen Standes, um Anzeigen zu empfangen und zu debuggen, die Benutzer in Echtzeit sehen. <br><br>  Der Stand besteht aus: <br><br><ul><li>  Build Agent </li><li>  Ger√§te </li><li>  Testsuite f√ºr jeden Anbieter </li></ul><br>  Eine der interessanten L√∂sungen, die am Stand eingesetzt wird, ist IDFA aus Nutzerbeschwerden f√ºr echte Werbung. <br><br>  Seit etwa 2016 erhalten wir keine echten Anzeigen mehr, die nur √ºber VPNs auf die USA ausgerichtet sind. Daher m√ºssen wir IDFA-Ger√§te durch IDFAs f√ºr echte Benutzer ersetzen. <br><br>  Dies geschieht ziemlich einfach mit der Objective-C-Laufzeit und dem Swizzling. <br>  Sie m√ºssen die AdvertisingIdentifier-Methode der ASIdentifierManager-Klasse ersetzen. <br><br>  Hier machen wir es durch die Kategorie: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  Die im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> beschriebene Methode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wird</a> verwendet, um die Benutzer-IDFA vom Build-Agenten auf den Build zu √ºbertragen. <br><br>  Abschlie√üend m√∂chte ich sagen, dass Bannerwerbung in den USA gut funktioniert. Seit sieben Jahren, in denen iFunny aktiv als Hauptmethode f√ºr die Monetarisierung eingesetzt wird, hat iFunny gelernt, gut damit zu arbeiten. <br><br>  Trotz der Tatsache, dass Banner 75% des Umsatzes des Unternehmens ausmachen, wird derzeit an alternativen Monetarisierungsmethoden gearbeitet, und es wurden bereits einige Erfahrungen mit einheimischer Werbung und der Verwendung von Werbeauktionen auf dem US-amerikanischen Markt gesammelt. <br><br>  Im Allgemeinen gibt es etwas zu erz√§hlen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de426553/">https://habr.com/ru/post/de426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de426543/index.html">Stateful Backups in Kubernetes</a></li>
<li><a href="../de426545/index.html">Joker 2018 Boni: kostenloses Online-Streaming, Bofs, Party und Tisch</a></li>
<li><a href="../de426547/index.html">Da der Sch√∂pfer von Android versucht, das erste "Anti-Smartphone" herauszubringen</a></li>
<li><a href="../de426549/index.html">Eine neue Art von Software f√ºr Produktmanager</a></li>
<li><a href="../de426551/index.html">Trekz Air - wie Knochenleitungskopfh√∂rer tats√§chlich klingen</a></li>
<li><a href="../de426555/index.html">PC, aber nicht PC: Interview mit dem Joker Program Committee</a></li>
<li><a href="../de426557/index.html">Die gefragtesten F√§higkeiten in der Datenwissenschaft</a></li>
<li><a href="../de426559/index.html">Neuronale Netze zur Bildverarbeitung. Sagt Alexander Savsunenko von Skylum Software</a></li>
<li><a href="../de426561/index.html">Die Gro√üen F√ºnf: m√ºssen Werkzeuge haben, um die Entwicklung zu beschleunigen</a></li>
<li><a href="../de426563/index.html">Hierarchisches Adressbuch, √Ñnderung der prim√§ren E-Mail und andere Neuerungen in Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>