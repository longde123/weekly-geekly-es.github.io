<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📯 🙉 🥪 通过Asp core + VueJS的示例统一验证规则 📑 💓 🙌</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文介绍了一种统一客户端-服务器应用程序的用户输入验证规则的简单方法。 以一个简单的项目为例，我将展示如何使用Asp net core和Vue js做到这一点。 


 通常，在开发Web应用程序时，我们面临着双重验证用户输入的任务。 一方面，必须在客户端上验证用户输入，以减少对服务器的冗余请求，并...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>通过Asp core + VueJS的示例统一验证规则</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473776/"><p><img src="https://habrastorage.org/webt/aq/-m/hx/aq-mhx5bf0a0_ablfc-ers0kvki.png"><br>  <em>本文介绍了一种统一客户端-服务器应用程序的用户输入验证规则的简单方法。</em>  <em>以一个简单的项目为例，我将展示如何使用Asp net core和Vue js做到这一点。</em> </p><br><p> 通常，在开发Web应用程序时，我们面临着双重验证用户输入的任务。 一方面，必须在客户端上验证用户输入，以减少对服务器的冗余请求，并加快用户的验证速度。 另一方面，谈到验证，服务器无法“信任”接受客户端验证在发送请求之前实际起作用的理由，因为 用户可以禁用或修改验证码。 甚至手动从客户端API发出请求。 </p><a name="habracut"></a><br><p> 因此，经典的客户端-服务器交互具有2个节点，通常具有相同的用户输入验证规则。 整个文章已在多篇文章中进行了讨论；这里将以ASP.Net Core API服务器和Vue js客户端为例来描述轻量级解决方案。 </p><br><p>首先，我们将确定只验证用户（团队）的请求，而不验证实体的请求，并且从经典3层体系结构的角度来看，我们的验证位于表示层中。 </p><br><h1 id="servernaya-chast"> 服务器端 </h1><br><p> 在Visual Studio 2019中，我将使用ASP.NET Core Web应用程序模板和API类型为服务器应用程序创建项目。 现成的ASP具有相当好的和可扩展的验证机制-模型验证，根据该模型，模型的请求属性将标记有特定的验证属性。 </p><br><p> 考虑一个简单的控制器作为示例： </p><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[controller]"</span></span></span><span class="hljs-meta">)</span></span>] [ApiController] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AccountController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { [HttpPost(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Registration))] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Registration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromBody]RegistrationRequest request</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{request.Name}</span></span></span><span class="hljs-string">,  !"</span></span>); } }</code> </pre> <br><p> 注册新用户的请求将如下所示： </p><br><div class="spoiler">  <b class="spoiler_title">注册请求</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RegistrationRequest</span></span> { [StringLength(maximumLength: <span class="hljs-number"><span class="hljs-number">50</span></span>, MinimumLength = <span class="hljs-number"><span class="hljs-number">2</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">"     2  50 "</span></span>)] [Required(ErrorMessage = <span class="hljs-string"><span class="hljs-string">" "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage = <span class="hljs-string"><span class="hljs-string">"  . "</span></span>)] [EmailAddress(ErrorMessage = <span class="hljs-string"><span class="hljs-string">"  . "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage = <span class="hljs-string"><span class="hljs-string">" "</span></span>)] [MaxLength(<span class="hljs-number"><span class="hljs-number">100</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">"{0}    {1} "</span></span>)] [MinLength(<span class="hljs-number"><span class="hljs-number">6</span></span>, ErrorMessage =<span class="hljs-string"><span class="hljs-string">"{0}    {1} "</span></span>)] [DisplayName(<span class="hljs-string"><span class="hljs-string">""</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage = <span class="hljs-string"><span class="hljs-string">" "</span></span>)] [Range(<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">150</span></span>, ErrorMessage = <span class="hljs-string"><span class="hljs-string">"      18  150"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">""</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Culture { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> </div></div><br><p> 它使用System.ComponentModel.DataAnnotations命名空间中的预定义验证属性。 必需的属性用Required属性标记。 因此，当发送空的JSON（“ {}”）时，我们的API将返回： </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"errors"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Age"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" "</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" "</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Email"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"  . "</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"Password"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" "</span></span> ] } }</code> </pre> <br><p> 在此阶段可能遇到的第一个问题是错误描述的本地化。 顺便说一句，ASP具有内置的本地化工具，我们将在以后讨论。 </p><br><p> 要检查字符串数据的长度，可以使用具有语音名称的属性：StringLength，MaxLength和MinLength。 同时，通过格式化字符串（大括号），可以将属性参数集成到消​​息中。 例如，对于用户名，我们在消息中插入最小和最大长度，并在同名属性中指定密码“显示名称”。  Range属性负责检查应在指定范围内的值。 <br> 让我们发送一个用户名和密码短的请求： </p><br><pre> <code class="json hljs"> { <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Password"</span></span> : <span class="hljs-string"><span class="hljs-string">"123"</span></span> }</code> </pre> <br><p> 在服务器的响应中，您可以找到新的验证错误消息： </p><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"     2  50 "</span></span> ], <span class="hljs-string"><span class="hljs-string">"Password"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"    6 "</span></span> ]</code> </pre> <br><p> 目前可能不明显的问题是，客户端应用程序中还必须存在名称和密码长度的边界值。 在两个或两个以上的地方手动设置相同数据的情况可能会滋生错误，这是设计不佳的标志之一。 让我们修复它。 </p><br><p> 我们将把客户需要的一切存储在资源文件中。  Controllers.AccountController.ru.resx中的消息以及共享资源中的文化独立数据：Controllers.AccountController.resx。 我坚持这种格式： </p><br><pre> <code class="json hljs">{PropertyName}DisplayName {PropertyName}{RuleName} {PropertyName}{RuleName}Message</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">因此，我们得到以下图片</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/al/cr/zg/alcrzgje8f1btwzkgwzfrz6mgyq.png"></p></div></div><br><p> 请注意，要验证电子邮件地址  mail用于正则表达式。 对于文化验证，使用自定义规则-“值”（值列表）。 您还需要检查UI上的密码确认字段，稍后我们会看到。 </p><br><p> 要访问特定区域性的资源文件，我们在Startup.ConfigureServices方法中添加了本地化支持，以指示资源文件的路径： </p><br><pre> <code class="cs hljs">services.AddLocalization(options =&gt; options.ResourcesPath = <span class="hljs-string"><span class="hljs-string">"Resources"</span></span>);</code> </pre> <br><p> 同样在Startup.Configure方法中，通过用户请求的标头确定区域性： </p><br><pre> <code class="cs hljs"> app.UseRequestLocalization(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestLocalizationOptions { DefaultRequestCulture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestCulture(<span class="hljs-string"><span class="hljs-string">"ru-RU"</span></span>), SupportedCultures = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-string"><span class="hljs-string">"en-US"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-string"><span class="hljs-string">"ru-RU"</span></span>) }, RequestCultureProviders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IRequestCultureProvider&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AcceptLanguageHeaderRequestCultureProvider() } });</code> </pre> <br><p> 现在，在控制器内部，我们可以访问本地化，我们将在构造函数中实现IStringLocalizer类型的依赖关系，并修改Registration操作的返回表达式： <br></p><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(_localizer[<span class="hljs-string"><span class="hljs-string">"RegisteredMessage"</span></span>], request.Name));</code> </pre> <br><p>  ResxValidatior类将负责检查规则，这些规则将使用创建的资源。 它包含关键字的保留列表，预设卷以及检查它们的方法。 </p><br><div class="spoiler">  <b class="spoiler_title">确认函</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ResxValidator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ValuesSeparator = <span class="hljs-string"><span class="hljs-string">','</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RangeSeparator = <span class="hljs-string"><span class="hljs-string">'-'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Keywords { DisplayName, Message, Required, Pattern, Length, MinLength, MaxLength, Range, MinValue, MaxValue, Values, Compare } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;Keywords, Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; _rules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Keywords, Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;() { [Keywords.Required] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(v), [Keywords.Pattern] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; Regex.IsMatch(v, arg), [Keywords.Range] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(v, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vLong) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg.Split(RangeSeparator)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Trim(), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vMin) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg.Split(RangeSeparator)[<span class="hljs-number"><span class="hljs-number">1</span></span>].Trim(), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vMax) &amp;&amp; vLong &gt;= vMin &amp;&amp; vLong &lt;= vMax, [Keywords.Length] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg.Split(RangeSeparator)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Trim(), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vMin) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg.Split(RangeSeparator)[<span class="hljs-number"><span class="hljs-number">1</span></span>].Trim(), <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vMax) &amp;&amp; v.Length &gt;= vMin &amp;&amp; v.Length &lt;= vMax, [Keywords.MinLength] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; v.Length &gt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(arg), [Keywords.MaxLength] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; v.Length &lt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(arg), [Keywords.Values] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(v) &amp;&amp; arg.Split(ValuesSeparator).Select(x =&gt; x.Trim()).Contains(v), [Keywords.MinValue] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(v) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(v, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vLong) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argLong) &amp;&amp; vLong &gt;= argLong, [Keywords.MaxValue] = (v, arg) =&gt; !<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(v) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(v, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vLong) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.TryParse(arg, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argLong) &amp;&amp; vLong &lt;= argLong }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IStringLocalizer _localizer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResxValidator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStringLocalizer localizer</span></span></span><span class="hljs-function">)</span></span> { _localizer = localizer; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> memberName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rules = _rules.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Name = x.Key, Check = x.Value, String = _localizer.GetString(memberName + x.Key) }).Where(x =&gt; x.String != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !x.String.ResourceNotFound); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rule <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rules) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!rule.Check(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, rule.String?.Value)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageResourceKey = <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{memberName}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{rule.Name}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Keywords.Message}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageResource = _localizer[messageResourceKey]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> displayNameResourceKey = <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{memberName}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Keywords.DisplayName}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> displayNameResource = _localizer[displayNameResourceKey] ?? displayNameResourceKey; message = messageResource != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !messageResource.ResourceNotFound ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(messageResource.Value, displayNameResource, rule.String?.Value) : messageResourceKey; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } message = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </div></div><br><p> 创建我们的验证者将调用的自定义验证属性。 在这里，标准逻辑是获取模型的已验证属性的值，其名称并调用验证程序。 </p><br><div class="spoiler">  <b class="spoiler_title">ResxAttribute</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">public sealed class ResxAttribute : ValidationAttribute { private readonly string _baseName; private string _resourceName; public ResxAttribute(string sectionName, string resourceName = null) { _baseName = sectionName; _resourceName = resourceName; } protected override ValidationResult IsValid(object value, ValidationContext validationContext) { if (_resourceName == null) _resourceName = validationContext.MemberName; var factory = validationContext .GetService(typeof(IStringLocalizerFactory)) as IStringLocalizerFactory; var localizer = factory?.Create(_baseName, System.Reflection.Assembly.GetExecutingAssembly().GetName().Name); ErrorMessage = ErrorMessageString; var currentValue = value as string; var validator = new ResxValidator(localizer); return validator.IsValid(_resourceName, currentValue, out var message) ? ValidationResult.Success : new ValidationResult(message); } }</code> </pre> </div></div><br><p> 最后，您可以将请求中的所有属性替换为通用属性，指明资源的名称： </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Resx(sectionName: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Controllers.AccountController"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre> <br><p> 我们将通过发送相同的请求来测试功能： </p><br><pre> <code class="json hljs"> { <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Password"</span></span> : <span class="hljs-string"><span class="hljs-string">"123"</span></span> }</code> </pre> <br><p> 对于本地化，添加带有英语消息以及标头的Controllers.AccountController.en.resx，以及标有以下区域性的信息：接受语言：zh-CN。 </p><br><p> 请注意，我们现在可以覆盖特定区域性的设置。 在* .en.resx文件中，我指定了最小密码长度8，并且收到了相应的消息： </p><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"Password"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Password must be at least 8 characters"</span></span> ]</code> </pre> <br><p> 要在客户端验证期间显示相同的消息，您必须以某种方式导出客户端部分的整个消息列表。 为简单起见，我们将制作一个单独的控制器，以i18n格式提供客户端应用程序所需的一切。 </p><br><div class="spoiler">  <b class="spoiler_title">区域控制器</b> <div class="spoiler_text"><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[controller]"</span></span></span><span class="hljs-meta">)</span></span>] [ApiController] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LocaleController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IStringLocalizerFactory _factory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _assumbly; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _location; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LocaleController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStringLocalizerFactory factory</span></span></span><span class="hljs-function">)</span></span> { _factory = factory; _assumbly = System.Reflection.Assembly.GetExecutingAssembly().GetName().Name; _location = Path.Combine(Directory.GetCurrentDirectory(), <span class="hljs-string"><span class="hljs-string">"Resources"</span></span>); } [HttpGet(<span class="hljs-string"><span class="hljs-string">"Config"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> culture</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(culture)) { CultureInfo.CurrentCulture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(culture); CultureInfo.CurrentUICulture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(culture); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resources = Directory.GetFiles(_location, <span class="hljs-string"><span class="hljs-string">"*.resx"</span></span>, SearchOption.AllDirectories) .Select(x =&gt; x.Replace(_location + Path.DirectorySeparatorChar, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty)) .Select(x =&gt; x.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, x.IndexOf(<span class="hljs-string"><span class="hljs-string">'.'</span></span>))) .Distinct(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resource <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> resources.Select(x =&gt; x.Replace(<span class="hljs-string"><span class="hljs-string">'\\'</span></span>, <span class="hljs-string"><span class="hljs-string">'.'</span></span>))) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> section = _factory.Create(resource, _assumbly) .GetAllStrings() .OrderBy(x =&gt; x.Name) .ToDictionary(x =&gt; x.Name, x =&gt; x.Value); config.Add(resource.Replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'-'</span></span>), section); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = JsonConvert.SerializeObject(config, Formatting.Indented); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(result); } }</code> </pre> </div></div><br><p> 根据接受语言，它将返回： </p><br><div class="spoiler">  <b class="spoiler_title">接受语言：美国</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"Controllers-AccountController"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"AgeDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Age"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"AgeRange"</span></span>: <span class="hljs-string"><span class="hljs-string">"18 - 150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"AgeRangeMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} must be {1}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailPattern"</span></span>: <span class="hljs-string"><span class="hljs-string">"^[-\\w.]+@([A-z0-9][-A-z0-9]+\\.)+[Az]{2,4}$"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailPatternMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Incorrect email"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailRequired"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailRequiredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Email required"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Language"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageValues"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru-RU, en-US"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageValuesMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Incorrect language. Possible: {1}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Name"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"2 - 50"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Name length must be {1} characters"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmCompare"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmCompareMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Passwords must be the same"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password confirmation"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMaxLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"100"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMaxLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} can't be greater than {1} characters"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMinLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMinLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} must be at least {1} characters"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordRequired"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordRequiredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password required"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RegisteredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}, you've been registered!"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">接受语言：en-RU</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"Controllers-AccountController"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"AgeDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"AgeRange"</span></span>: <span class="hljs-string"><span class="hljs-string">"18 - 150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"AgeRangeMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}     {1}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">" . "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailPattern"</span></span>: <span class="hljs-string"><span class="hljs-string">"^[-\\w.]+@([A-z0-9][-A-z0-9]+\\.)+[Az]{2,4}$"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailPatternMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"  . "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailRequired"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"EmailRequiredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"  . "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageValues"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru-RU, en-US"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LanguageValuesMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">" .  : {1}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"2 - 50"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"NameLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"    {1} "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmCompare"</span></span>: <span class="hljs-string"><span class="hljs-string">"Password"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmCompareMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordConfirmDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordDisplayName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMaxLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"100"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMaxLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}    {1} "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMinLength"</span></span>: <span class="hljs-string"><span class="hljs-string">"6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordMinLengthMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}    {1} "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordRequired"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"PasswordRequiredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RegisteredMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0},  !"</span></span> } }</code> </pre> </div></div><br><p> 剩下要做的最后一件事就是允许客户端的跨域请求。 为此，请在Startup.ConfigureServices中添加： </p><br><pre> <code class="cs hljs"> services.AddCors();</code> </pre> <br><p> 并在Startup.Configure中添加： </p><br><pre> <code class="cs hljs"> app.UseCors(x =&gt; x .AllowAnyOrigin() .AllowAnyMethod() .AllowAnyHeader());</code> </pre> <br><h1 id="klientskaya-chast"> 客户部分 </h1><br><p> 我更喜欢在一个IDE中查看应用程序的所有部分，因此我将使用Visual Studio模板（基本Vue.js Web应用程序）创建一个客户端应用程序项目。 如果您没有/不想使用此类模板堵塞VS，请使用vue cli，我将在此之前安装许多软件包：vuetify，axios，vue-i18n。 </p><br><p> 我们从LocaleController请求转换后的资源文件，在Accept-Language标头中指示区域性，然后将响应放置在locales目录中的en.json和ru.json文件中。 </p><br><p> 接下来，我们需要一个服务来解析来自服务器的错误响应。 </p><br><div class="spoiler">  <b class="spoiler_title">errorHandler.service.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ErrorHandlerService = { parseResponseError (error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.toString().includes(<span class="hljs-string"><span class="hljs-string">'Network Error'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'ServerUnavailable'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.response) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> statusText = error.response.statusText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.response.data &amp;&amp; error.response.data.errors) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> error.response.data.errors) { error.response.data.errors[property].forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry) { message += entry + <span class="hljs-string"><span class="hljs-string">'\n'</span></span> } }) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.response.data &amp;&amp; error.response.data.message) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> error.response.data.message } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusText) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> statusText } } } }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> { ErrorHandlerService }</code> </pre> </div></div><br><p>  Vutify.js内置的vee-validate验证器要求您使用rules属性指定一个验证函数数组，我们将从服务中请求它们以使用资源。 </p><br><div class="spoiler">  <b class="spoiler_title">locale.service.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> i18n <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../i18n'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LocaleService = { getRules(resource, options) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rules = []; options = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prepareOptions(options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addRequireRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addPatternRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addRangeRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addLengthRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addMaxLengthRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addMinLengthRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addValuesRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addCompareRule(rules, resource, options); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rules; }, prepareOptions(options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> getter = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> v; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> compared = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!options){ options = { <span class="hljs-attr"><span class="hljs-attr">getter</span></span>: getter, <span class="hljs-attr"><span class="hljs-attr">compared</span></span>: compared }; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!options.getter) options.getter = getter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!options.compared) options.compared = compared; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> options; }, addRequireRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Required'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); } }, addPatternRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Pattern'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(settings.value).test(options.getter(v)) || settings.message); } }, addRangeRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Range'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> values = settings.value.split(<span class="hljs-string"><span class="hljs-string">'-'</span></span>); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(options.getter(v)) &gt;= values[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(options.getter(v)) &lt;= values[<span class="hljs-number"><span class="hljs-number">1</span></span>] || settings.message); } }, addLengthRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Length'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> values = settings.value.split(<span class="hljs-string"><span class="hljs-string">'-'</span></span>); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> options.getter(v).length &gt;= values[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp;&amp; options.getter(v).length &lt;= values[<span class="hljs-number"><span class="hljs-number">1</span></span>] || settings.message); } }, addMaxLengthRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'MaxLength'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> options.getter(v).length &lt;= settings.value || settings.message); } }, addMinLengthRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'MinLength'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings){ rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> options.getter(v).length &gt;= settings.value || settings.message); } }, addValuesRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Values'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> values = settings.value.split(<span class="hljs-string"><span class="hljs-string">','</span></span>); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!options.getter(v) || settings.message); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> !!values.find(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> x.trim() === options.getter(v)) || settings.message); } }, addCompareRule(rules, resource, options){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleSettings(resource, <span class="hljs-string"><span class="hljs-string">'Compare'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(settings) { rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> settings.value === <span class="hljs-string"><span class="hljs-string">''</span></span> || !!settings.value || settings.message }); rules.push(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> options.getter(v) === options.compared() || settings.message; }); } }, getRuleSettings(resource, rule){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleValue(resource, rule); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRuleMessage(resource, rule, value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value === <span class="hljs-string"><span class="hljs-string">''</span></span> || value ? { <span class="hljs-attr"><span class="hljs-attr">value</span></span>: value, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: message } : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }, getRuleValue(resource, rule){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key =<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resource}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rule}</span></span></span><span class="hljs-string">`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getI18nValue(key); }, getDisplayName(resource){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key =<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resource}</span></span></span><span class="hljs-string">DisplayName`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getI18nValue(key); }, getRuleMessage(resource, rule, value){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key =<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resource}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rule}</span></span></span><span class="hljs-string">Message`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i18n.t(key, [<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getDisplayName(resource), value]); }, getI18nValue(key){ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> value = i18n.t(key); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value !== key ? value : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> { LocaleService }</code> </pre> </div></div><br><p> 完全描述此服务没有任何意义，因为 它部分复制ResxValidator类。 我注意到，要检查“比较”规则，即必须将当前属性的值与另一个属性进行比较，则传递了options对象，在其中比较了委托，该委托返回了要比较的值。 </p><br><p> 因此，典型的表单字段如下所示： </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v-text-field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"displayFor('Name')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:rules</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rulesFor('Name')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"model.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prepend-icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mdi-account"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v-text-field</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> 对于标签，在locale.service上调用包装函数，该函数传递资源的全名以及要获取其显示名称的属性的名称。 规则也是如此。  v模型指定用于存储输入数据的模型。 <br> 对于密码确认属性，在options对象中传递密码本身的值： </p><br><pre> <code class="xml hljs">:rules="rulesFor('PasswordConfirm', { compared:() =&gt; model.Password })"</code> </pre> <br><p> 用于语言选择的v-select具有预定义的元素列表（此操作是为了简化示例），并且onChange是处理程序。 因为 我们做SPA，我们想在用户选择一种语言时更改本地化，因此，在onChange select中，选中了所选择的语言，如果语言已更改，则界面语言会更改： </p><br><pre> <code class="javascript hljs"> onCultureChange (value) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> culture = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cultures.find(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> x.value === value); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.model.Culture = culture.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (culture.locale !== <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$i18n.locale) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$i18n.locale = culture.locale; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$refs.form.resetValidation(); } }</code> </pre> <br><p> 就是这样， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>有一个运行正常的应用程序的存储库。 </p><br><p>  <strong>总结一下，我想指出</strong> ，将资源最初存储为我们从LocaleController要求的单一JSON格式以便将其与ASP框架的细节脱钩是非常好的。 在ResxValidatior中，可以特别添加对可扩展性和自定义规则的支持，并突出显示与locale.service相同的代码，并以JS样式重写以简化支持。 但是，在此示例中，我着重于简单性。 </p><p></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN473776/">https://habr.com/ru/post/zh-CN473776/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN473764/index.html">包裹是我最喜欢的项目建设者</a></li>
<li><a href="../zh-CN473766/index.html">大量Python代码的静态分析：Instagram经验。 第一部分</a></li>
<li><a href="../zh-CN473768/index.html">那些想提高自己技能的前五本书</a></li>
<li><a href="../zh-CN473770/index.html">大量Python代码的静态分析：Instagram经验。 第二部分</a></li>
<li><a href="../zh-CN473774/index.html">DF Cloud上的安全云</a></li>
<li><a href="../zh-CN473778/index.html">图像优化：如何使用Google的Vision AI理解图像排名原则</a></li>
<li><a href="../zh-CN473780/index.html">4K视频中的快速轮廓检测：颜色和复杂形状</a></li>
<li><a href="../zh-CN473784/index.html">如何在本体网络上为WebAssembly编写智能合约？ 第2部分：C ++</a></li>
<li><a href="../zh-CN473786/index.html">里加黑客马拉松的注册工作即将结束。 奖-PhysTech短期培训</a></li>
<li><a href="../zh-CN473788/index.html">蛋白质发现现代生物学的未知方面</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>