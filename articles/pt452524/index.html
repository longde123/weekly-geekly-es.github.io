<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèø üöà üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® Compactando o APK, tentando mant√™-lo funcionando ü§õ üë©üèª‚Äçü§ù‚Äçüë®üèø ü¶Ü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="/ PxHere / PD 


 Otimizar o peso do APK √© uma tarefa n√£o trivial, mas muito relevante nos dias do Instant App. A ativa√ß√£o do programa salva voc√™ de c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compactando o APK, tentando mant√™-lo funcionando</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452524/"><p><img src="https://habrastorage.org/webt/mt/4c/5p/mt4c5phurcqjoygefzy7edmhsxa.jpeg"><br>  <em>/ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PxHere</a> / PD</em> </p><br><p>  Otimizar o peso do APK √© uma tarefa n√£o trivial, mas muito relevante nos dias do Instant App.  A ativa√ß√£o do programa salva voc√™ de c√≥digo desnecess√°rio se suas depend√™ncias puderem ser determinadas no est√°gio de compila√ß√£o, mas existem v√°rios outros tipos de arquivos no APK que podem ser exclu√≠dos do assembly. </p><br><p>  Sob o c√≥digo de como criar depend√™ncias - definidas no est√°gio de compila√ß√£o, quais arquivos podem ser exclu√≠dos do assembly e como faz√™-lo, al√©m de analisarmos como excluir componentes n√£o utilizados do assembly, se voc√™ tiver v√°rios aplicativos com uma base de c√≥digo comum. </p><a name="habracut"></a><br><h1 id="pered-prochteniem">  Antes de ler </h1><br><ul><li>  Antes de aplicar as dicas do artigo, otimize o APK para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guia do Google</a> .  Este artigo √© para aqueles que n√£o possuem otimiza√ß√µes padr√£o suficientes. </li><li>  Por "proguard", quero dizer um compilador de otimiza√ß√£o com minifica√ß√£o. </li><li>  Por componente, quero dizer uma certa caracter√≠stica do produto do ponto de vista comercial.  No nosso caso, isso √© apenas uma cole√ß√£o de arquivos em um determinado pacote.  Temos um m√≥dulo gradle para toda a aplica√ß√£o. </li></ul><br><p> O peso do nosso APK otimizado para o Google era de <code>4.4 </code> . </p><br><h1 id="lishnie-fayly">  Arquivos extras </h1><br><p>  Vamos come√ßar com um simples.  Se voc√™ n√£o usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kotlin-reflect</a> , poder√° excluir da montagem as meta-informa√ß√µes sobre as classes do kotlin.  Voc√™ pode fazer isso da seguinte maneira: <br>  No <code>build.gradle (Module: app)</code> </p><br><pre> <code class="plaintext hljs">android { packagingOptions { exclude("META-INF/*.kotlin_module") exclude("**.kotlin_builtins") exclude("**.kotlin_metadata") } }</code> </pre> <br><p>  A reflex√£o Java n√£o precisa dos <code>*.kotlin_module</code> , <code>*.kotlin_builtins</code> e <code>*.kotlin_metadata</code> .  Determinar qual reflex√£o voc√™ est√° usando √© muito simples.  Se voc√™ escrever <code>obj::class.&lt;method&gt;</code> , use reflex√£o kotlin, se <code>obj::class.java.&lt;method&gt;</code> , em seguida, reflex√£o java. </p><br><p>  <em>O resultado da otimiza√ß√£o para n√≥s: -602,1 kb</em> </p><br><h1 id="zavisimosti">  Depend√™ncias </h1><br><p>  √Äs vezes, as bibliotecas adicionam depend√™ncias para casos que nunca acontecem no seu aplicativo.  Por exemplo, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ktor-client</a> puxa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kotlin-reflect</a> junto com ele (0,5 mb!). <br>  <code>minifyEnabled = true</code> com esses casos da seguinte maneira: coletei o APK com <code>minifyEnabled = true</code> , joguei-o no analisador Android Studio, baixei o <code>mapping.txt</code> e procurei pacotes que, em teoria, n√£o deveriam estar presentes na montagem.  Por exemplo, <code>kotlin.reflect</code> .  Ap√≥s executar <code>./gradlew app:dependencies</code> na pasta do projeto para procurar depend√™ncias (n√£o esque√ßa de aumentar o tamanho do hist√≥rico no terminal. A √°rvore de depend√™ncias pode ser grande!).  Nesta √°rvore, √© f√°cil entender o que se refere a depend√™ncias desnecess√°rias e exclu√≠-las.  No <code>build.gradle</code> seu m√≥dulo: </p><br><pre> <code class="plaintext hljs">dependencies { implementation("io.ktor:ktor-client-core:$ktorVersion") { exclude(group: "org.jetbrains.kotlin", module: "kotlin-reflect") } implementation("io.ktor:ktor-client-okhttp:$ktorVersion") { exclude(group: "org.jetbrains.kotlin", module: "kotlin-reflect") } }</code> </pre> <br><p>  Esse c√≥digo remove a depend√™ncia da biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ktor-client</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kotlin-reflect</a> .  Se voc√™ deseja excluir outra coisa, substitua seus valores. </p><br><p>  <strong>!!!</strong>  <strong>Use este conselho com muito cuidado!</strong>  <strong>Antes de eliminar depend√™ncias, verifique se voc√™ n√£o precisa delas.</strong>  <strong>Caso contr√°rio, o aplicativo poder√° come√ßar a cair na produ√ß√£o !!!</strong> </p><br><p>  <em>O resultado da otimiza√ß√£o para n√≥s: -500,3 kb</em> </p><br><h1 id="proverte-vashi-xml">  Valide seu XML </h1><br><p>  Infelizmente, o programa n√£o remove outros arquivos de marca√ß√£o XML da pasta de layout.  XML n√£o utilizado pode usar widgets "pesados" e o programa n√£o poder√° exclu√≠-los do assembly tamb√©m!  Para evitar isso, remova recursos n√£o utilizados com <code>Refactor -&gt; Remove unused resources...</code> </p><br><h1 id="proverte-vash-di">  Verifique seus di </h1><br><p>  Se voc√™, como n√≥s, usa DI de tempo de execu√ß√£o, verifique se possui provedores para essas depend√™ncias que n√£o est√° usando.  O programa n√£o pode exclu√≠-los do assembly porque eles n√£o s√£o usados ‚Äã‚Äãdo ponto de vista do compilador.  Voc√™ os utiliza ao criar um gr√°fico de depend√™ncia. </p><br><h1 id="isklyuchite-otladochnye-zavisimosti-iz-reliznoy-sborki">  Excluir depend√™ncias de depura√ß√£o das vers√µes da vers√£o </h1><br><p>  As ferramentas de depura√ß√£o podem ocupar muito espa√ßo inesperadamente.  Por exemplo, <code>stetho</code> pesa cerca de <code>0.2 </code> ap√≥s a compacta√ß√£o!  De qualquer forma, √© melhor excluir toda a infraestrutura de depura√ß√£o da compila√ß√£o do release, para que ningu√©m possa aprender muito sobre seu aplicativo simplesmente baixando-o do Google Play. </p><br><p>  Voc√™ pode criar vers√µes diferentes dos mesmos arquivos para depura√ß√£o e lan√ßamento.  Para fazer isso, na pasta <code>src</code> , ao lado de <code>main</code> , crie as pastas de <code>debug</code> e <code>release</code> .  Agora voc√™ pode gravar a fun√ß√£o <code>initStetho</code> que inicializa o Stetho no arquivo <code>src/debug/java/your/pkg/Stetho.kt</code> e a fun√ß√£o <code>initStetho</code> que n√£o faz nada no <code>src/debug/java/your/pkg/Stetho.kt</code> <code>src/release/java/your/pkg/Stetho.kt</code> . </p><br><p>  Por precau√ß√£o, verifique se essa depend√™ncia est√° inclu√≠da apenas nas compila√ß√µes de depura√ß√£o.  Voc√™ pode fazer isso substituindo a <code>implementation</code> por <code>debugImplementation</code> em <code>build.gradle</code> .  Na maioria das vezes, o programa elimina arquivos desnecess√°rios, mesmo sem essa etapa, mas nem sempre.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A resposta para a pergunta "por qu√™?"</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">abaixo no texto do artigo</a> . </p><br><h1 id="platformy">  Plataformas </h1><br><p>  √Äs vezes, na mesma base de c√≥digo, v√°rias vers√µes diferentes de um aplicativo s√£o emitidas.  Podem ser vers√µes diferentes para diferentes pa√≠ses ou regi√µes ou, como no nosso caso, para diferentes clientes.  Abaixo est√£o algumas dicas sobre como descarregar a plataforma. </p><br><p><img src="https://habrastorage.org/webt/5d/oy/ze/5doyzeespts24cj8hqkey7lsros.jpeg"><br>  <em>/ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PxHere</a> / PD</em> </p><br><h1 id="nash-opyt">  Nossa experi√™ncia </h1><br><p>  Estamos desenvolvendo um designer de aplicativos m√≥veis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">E-SHOP</a> .  Temos v√°rias dezenas de clientes e cada um tem seu pr√≥prio conjunto individual de componentes.  Alguns componentes s√£o usados ‚Äã‚Äãpor todos os clientes, outros s√£o apenas parte.  Nossa tarefa √© incluir na montagem do cliente apenas os componentes que ele precisa. </p><br><h1 id="isklyuchenie-komponenta-po-flagu">  Exce√ß√£o de sinalizador </h1><br><p>  Para cada cliente, criamos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">productFlavor</a> separado.  Isso √© conveniente porque √© f√°cil criar recursos diferentes para clientes diferentes, o IDE fornece uma interface gr√°fica para alternar entre sabores e os caches funcionam bem.  E voc√™ tamb√©m pode gerar seu pr√≥prio <code>BuildConfig.java</code> para cada cliente.  Os valores de campo dessa classe s√£o conhecidos no est√°gio de compila√ß√£o.  √â disso que precisamos!  Crie um campo do tipo <code>boolean</code> para cada componente. </p><br><pre> <code class="plaintext hljs">android { productFlavors { client1 { buildConfigField("boolean", "IS_CATALOG_ENABLED", "true") } client2 { buildConfigField("boolean", "IS_CATALOG_ENABLED", "false") } } }</code> </pre> <br><p>  <em>Esta √© uma vers√£o simplificada da configura√ß√£o.</em>  <em>O presente √© complexo devido √† integra√ß√£o com o nosso IC.</em> </p><br><p>  Agora √© sabido se o componente est√° ativo no est√°gio de compila√ß√£o e o programa pode exclu√≠-lo da montagem! </p><br><h1 id="snova-xml">  XML novamente </h1><br><p>  Agora, o problema com layouts XML n√£o utilizados assume uma nova dimens√£o!  Voc√™ n√£o pode simplesmente tirar e remover a marca√ß√£o de um componente simplesmente porque alguns clientes n√£o precisam. </p><br><p>  Em nossa aplica√ß√£o XML de um dos componentes raramente usados, usamos um widget que se refere √† biblioteca de reconhecimento de imagens <code>firebase.ml.vision</code> .  Ele pesa cerca de 0,2 mb, o que √© muito.  Decidiu-se adicionar este widget com c√≥digo em vez de declar√°-lo na marca√ß√£o.  Depois disso, a proguard conseguiu excluir a <code>vision</code> da assembl√©ia para clientes que n√£o precisam dela. </p><br><p>  <em>O resultado da otimiza√ß√£o para n√≥s: -222,3 kb para o APK m√©dio</em> </p><br><h1 id="annotaciya-keep">  <code>@Keep</code> </h1><br><p>  Existem duas maneiras de informar ao proguard que sua classe n√£o pode ser reduzida: escreva uma regra no arquivo <code>proguard-rules.pro</code> ou coloque a anota√ß√£o <code>@Keep</code> .  Na biblioteca <code>play-services-vision</code> , esta anota√ß√£o est√° na classe raiz.  Portanto, 0,2 MB ficaram paralisados ‚Äã‚Äãmesmo nos aplicativos clientes que n√£o precisam de reconhecimento de imagem. </p><br><p>  N√£o encontrei uma maneira simples e segura de remover esta anota√ß√£o.  Se voc√™ souber como - por favor escreva nos coment√°rios. </p><br><p>  Felizmente, a biblioteca <code>firebase.ml.vision</code> , que √© uma vers√£o mais recente do <code>play-services-vision</code> , n√£o usa essa anota√ß√£o e resolvemos o problema. </p><br><h1 id="i-vnov-di">  E novamente DI </h1><br><p>  Por √∫ltimo mas n√£o menos importante.  DI para componentes desconectados.  Tudo √© simples aqui: para cada componente, usamos nosso pr√≥prio cont√™iner e conectamos as depend√™ncias gerais atrav√©s de um m√≥dulo separado. </p><br><p>  <em>O resultado da otimiza√ß√£o para n√≥s: -20,1 kb para o APK m√©dio</em> </p><br><h1 id="vyvody">  Conclus√µes </h1><br><ul><li>  O peso do APK m√©dio diminuiu de <code>4.4 </code> para <code>3.1 </code> e o m√≠nimo - para <code>2.5 </code> ! </li><li>  O c√≥digo do aplicativo n√£o foi prejudicado, mas melhorado.  Agora √© mais f√°cil trabalhar com DI. </li></ul><br><p>  Todas as otimiza√ß√µes apresentadas no artigo s√£o "frutos baixos".  Eles s√£o muito f√°ceis de implementar e obt√™m rapidamente o resultado.  At√© <em>-43%</em> para um APK j√° otimizado no nosso caso.  Espero ter economizado seu tempo listando tudo em um s√≥ lugar. </p><br><h3 id="vsem-spasibo">  Obrigado a todos! </h3></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452524/">https://habr.com/ru/post/pt452524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452514/index.html">Design de jogos para a vida. A Economia do Jogo (Parte II)</a></li>
<li><a href="../pt452516/index.html">Cont√™iner do Docker para gerenciamento de servidores HP com OIT</a></li>
<li><a href="../pt452518/index.html">VMware EMPOWER 2019 - os principais t√≥picos da confer√™ncia, que ser√° realizada de 20 a 23 de maio em Lisboa</a></li>
<li><a href="../pt452520/index.html">‚ÄúElementos‚Äù extravagantes de Euclides no TeX</a></li>
<li><a href="../pt452522/index.html">Oito op√ß√µes pouco conhecidas do Bash</a></li>
<li><a href="../pt452526/index.html">Classe m√©dia: por que os m√∫sicos modernos ganham</a></li>
<li><a href="../pt452528/index.html">Elon Musk: se voc√™ n√£o cortar drasticamente os custos, o dinheiro da Tesla se esgotar√° em 10 meses</a></li>
<li><a href="../pt452530/index.html">Geeks autom√°ticos, fintech e marketing de conte√∫do ou por que a seguradora deve terceirizar edi√ß√µes de TI</a></li>
<li><a href="../pt452532/index.html">Term√¥metro e higr√¥metro Arduino com E-PAPER no nRF52832 - ou o que os fabricantes se esqueceram de lan√ßar</a></li>
<li><a href="../pt452534/index.html">Novas dicas de abordagem de multiplica√ß√£o Como melhorar os computadores qu√¢nticos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>