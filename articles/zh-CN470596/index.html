<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸšŒ ğŸ“± ğŸ›¶ å®æ—¶æœåŠ¡ç¤ºä¾‹ä¸­çš„Qå’ŒKDB +åŠŸèƒ½ ğŸ ğŸ‘³ ğŸš¡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qç¼–ç¨‹è¯­è¨€KDB +æ˜¯ä»€ä¹ˆï¼Œå®ƒä»¬çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥åœ¨æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« å’Œç®€ä»‹ä¸­æ‰¾åˆ°ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åœ¨Qä¸Šå®ç°äº†ä¸€é¡¹æœåŠ¡ï¼Œè¯¥æœåŠ¡å°†å¤„ç†ä¼ å…¥çš„æ•°æ®æµï¼Œå¹¶ä»¥â€œå®æ—¶â€æ¨¡å¼æ¯åˆ†é’Ÿè®¡ç®—å„ç§èšåˆå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå°†è®¾æ³•å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œè®¡æ•°ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ•°æ®ä¸ºæ­¢ï¼‰ã€‚ Qçš„ä¸»è¦ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ç§å‘é‡è¯­è¨€ï¼Œå®ƒä½¿æ‚¨ä¸ä»…å¯ä»¥å¤„ç†å•...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å®æ—¶æœåŠ¡ç¤ºä¾‹ä¸­çš„Qå’ŒKDB +åŠŸèƒ½</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dbtc/blog/470596/">  Qç¼–ç¨‹è¯­è¨€KDB +æ˜¯ä»€ä¹ˆï¼Œå®ƒä»¬çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥åœ¨æˆ‘çš„ä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸€ç¯‡æ–‡ç« </a>å’Œç®€ä»‹ä¸­æ‰¾åˆ°ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬åœ¨Qä¸Šå®ç°äº†ä¸€é¡¹æœåŠ¡ï¼Œè¯¥æœåŠ¡å°†å¤„ç†ä¼ å…¥çš„æ•°æ®æµï¼Œå¹¶ä»¥â€œå®æ—¶â€æ¨¡å¼æ¯åˆ†é’Ÿè®¡ç®—å„ç§èšåˆå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå°†è®¾æ³•å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œè®¡æ•°ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ•°æ®ä¸ºæ­¢ï¼‰ã€‚  Qçš„ä¸»è¦ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ç§å‘é‡è¯­è¨€ï¼Œå®ƒä½¿æ‚¨ä¸ä»…å¯ä»¥å¤„ç†å•ä¸ªå¯¹è±¡ï¼Œè¿˜å¯ä»¥å¤„ç†å®ƒä»¬çš„æ•°ç»„ï¼Œæ•°ç»„æ•°ç»„å’Œå…¶ä»–å¤æ‚å¯¹è±¡ã€‚  QåŠå…¶ç›¸å…³çš„Kï¼ŒJï¼ŒAPLç­‰è¯­è¨€ä»¥å…¶ç®€æ´è€Œé—»åã€‚ é€šå¸¸ï¼Œå¯ä»¥ç”¨å‡ è¡Œä»£ç ä»¥ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆä¾‹å¦‚Javaï¼‰æ¥è·¨è¶Šå¤šä¸ªå±å¹•çš„ç¨‹åºã€‚ è¿™æ­£æ˜¯æˆ‘è¦åœ¨æœ¬æ–‡ä¸­æ¼”ç¤ºçš„å†…å®¹ã€‚ <br><br><img src="https://habrastorage.org/webt/wb/ej/zy/wbejzyzkg_-aypnh92it6kecrtq.jpeg"><br><a name="habracut"></a><br><h3> å¼•è¨€ </h3><br>  KDB +æ˜¯ä¸€ä¸ªåˆ—æ•°æ®åº“ï¼Œä¸“æ³¨äºä»¥æŸç§æ–¹å¼ï¼ˆä¸»è¦æ˜¯æŒ‰æ—¶é—´ï¼‰æ’åºçš„å¤§é‡æ•°æ®ã€‚ é¦–å…ˆï¼Œå®ƒç”¨äºé‡‘èç»„ç»‡-é“¶è¡Œï¼ŒæŠ•èµ„åŸºé‡‘ï¼Œä¿é™©å…¬å¸ã€‚  Qè¯­è¨€æ˜¯KDB +çš„ä¸€ç§å†…éƒ¨è¯­è¨€ï¼Œå¯è®©æ‚¨æœ‰æ•ˆåœ°ä½¿ç”¨æ­¤æ•°æ®ã€‚  Qçš„æ„è¯†å½¢æ€æ˜¯ç®€æ´å’Œé«˜æ•ˆï¼Œè€Œç‰ºç‰²äº†æ¸…æ™°åº¦ã€‚ äº‹å®è¯æ˜ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹çŸ¢é‡è¯­è¨€éƒ½å¾ˆéš¾ç†è§£ï¼Œå¹¶ä¸”å½•éŸ³çš„ç®€æ´æ€§å’Œä¸°å¯Œæ€§ä½¿æ‚¨å¯ä»¥åœ¨ä¸€ä¸ªå±å¹•ä¸Šçœ‹åˆ°ç¨‹åºçš„æ›´å¤§éƒ¨åˆ†ï¼Œä»è€Œæœ€ç»ˆæœ‰åŠ©äºå…¶ç†è§£ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨å®ç°ä¸€ä¸ªå®Œå–„çš„Qç¨‹åºï¼Œæ‚¨å¯èƒ½æƒ³å°è¯•ä¸€ä¸‹ã€‚ ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦Qæœ¬èº«ï¼Œæ‚¨å¯ä»¥åœ¨kxå…¬å¸ç½‘ç«™<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.kx.com</a>ä¸Šä¸‹è½½å…è´¹çš„32ä½ç‰ˆæœ¬ã€‚ å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œå¯ä»¥åœ¨åŒä¸€åœ°æ–¹æ‰¾åˆ°æœ‰å…³Qçš„å‚è€ƒä¿¡æ¯ï¼Œã€Š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸ºçœŸäºº</a>è€Œç”Ÿçš„ä¹¦ã€‹ä»¥åŠæœ‰å…³æ­¤ä¸»é¢˜çš„å„ç§æ–‡ç« ã€‚ <br><br><h3> é—®é¢˜é™ˆè¿° </h3><br> æœ‰ä¸€ä¸ªæºæ¯25æ¯«ç§’å‘é€ä¸€æ¬¡æ•°æ®è¡¨ã€‚ ç”±äºKDB +ä¸»è¦ç”¨äºè´¢åŠ¡ï¼Œå› æ­¤æˆ‘ä»¬å‡è®¾è¿™æ˜¯ä¸€ä¸ªäº¤æ˜“è¡¨ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹åˆ—ï¼šæ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½çš„æ—¶é—´ï¼‰ï¼Œsymï¼ˆäº¤æ˜“æ‰€ä¸Šçš„å…¬å¸åç§°<b>-IBM</b> ï¼Œ <b>AAPL</b> ï¼Œ...ï¼‰ï¼Œä»·æ ¼ï¼ˆä»·æ ¼ï¼‰è´­ä¹°è‚¡ç¥¨çš„æ–¹å¼ï¼‰ï¼Œå¤§å°ï¼ˆäº¤æ˜“å¤§å°ï¼‰ã€‚ å¯ä»¥ä»»æ„é€‰æ‹©25æ¯«ç§’çš„é—´éš”ï¼Œè¯¥é—´éš”ä¸èƒ½å¤ªå°ä¹Ÿä¸èƒ½å¤ªå¤§ã€‚ å®ƒçš„å­˜åœ¨æ„å‘³ç€åˆ°è¾¾æœåŠ¡çš„æ•°æ®å·²ç»è¢«ç¼“å†²ã€‚ æ ¹æ®å½“å‰è´Ÿè½½ï¼Œåœ¨æœåŠ¡ç«¯å®ç°ç¼“å†²ï¼ˆåŒ…æ‹¬åŠ¨æ€ç¼“å†²ï¼‰ä¼šå¾ˆå®¹æ˜“ï¼Œä½†æ˜¯ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åœç•™åœ¨å›ºå®šçš„æ—¶é—´é—´éš”ä¸Šã€‚ <br><br> æœåŠ¡åº”é’ˆå¯¹ç¬¦å·åˆ—ä¸­çš„æ¯ä¸ªä¼ å…¥å­—ç¬¦æ¯åˆ†é’Ÿè€ƒè™‘ä¸€ç»„æ±‡æ€»åŠŸèƒ½-æœ€é«˜ä»·æ ¼ï¼Œå¹³å‡ä»·æ ¼ï¼Œæ€»å’Œç­‰ã€‚ æœ‰ç”¨çš„ä¿¡æ¯ã€‚ ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥å¢é‡è®¡ç®—ï¼Œå³ è¦è·å¾—ä¸€ä¸ªæ–°å€¼ï¼Œå°±è¶³ä»¥çŸ¥é“ä¸¤ä¸ªæ•°å­—-æ—§å€¼å’Œä¼ å…¥å€¼ã€‚ ä¾‹å¦‚ï¼Œå‡½æ•°maxï¼Œaverageï¼Œsumå…·æœ‰æ­¤å±æ€§ï¼Œä½†ä¸­ä½æ•°å‡½æ•°æ²¡æœ‰æ­¤å±æ€§ã€‚ <br><br> æˆ‘ä»¬è¿˜å‡å®šä¼ å…¥æ•°æ®æµæŒ‰æ—¶é—´æ’åºã€‚ è¿™å°†ä½¿æˆ‘ä»¬æœ‰æœºä¼šä»…åœ¨æœ€åä¸€åˆ†é’Ÿå·¥ä½œã€‚ åœ¨å®è·µä¸­ï¼Œåªè¦æœ‰ä»»ä½•æœ€æ–°æ›´æ–°å°±å¯ä»¥ä½¿ç”¨å½“å‰å’Œä¹‹å‰çš„åˆ†é’Ÿå°±è¶³å¤Ÿäº†ã€‚ ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ä¸è€ƒè™‘è¿™ç§æƒ…å†µã€‚ <br><br><h3> æ±‡æ€»åŠŸèƒ½ </h3><br> ä¸‹é¢åˆ—å‡ºäº†å¿…éœ€çš„èšåˆå‡½æ•°ã€‚ æˆ‘å°½å¯èƒ½å¤šåœ°ä½¿ç”¨å®ƒä»¬æ¥å¢åŠ æœåŠ¡è´Ÿè½½ï¼š <br><br><ul><li> é«˜-æœ€é«˜ä»·æ ¼-æ¯åˆ†é’Ÿæœ€é«˜ä»·æ ¼ã€‚ </li><li> ä½-æœ€ä½ä»·æ ¼-æ¯åˆ†é’Ÿçš„æœ€ä½ä»·æ ¼ã€‚ </li><li>  firstPrice-ç¬¬ä¸€ä»·æ ¼-æ¯åˆ†é’Ÿçš„ç¬¬ä¸€ä»·æ ¼ã€‚ </li><li>  lastPrice-æœ€ç»ˆä»·æ ¼-æ¯åˆ†é’Ÿçš„æœ€åä»·æ ¼ã€‚ </li><li>  firstSize-ç¬¬ä¸€å¤§å°-ä¸€åˆ†é’Ÿå†…çš„ç¬¬ä¸€ç¬”äº¤æ˜“å¤§å°ã€‚ </li><li>  lastSize-ä¸Šä¸€äº¤æ˜“é‡-ä¸€åˆ†é’Ÿå†…çš„æœ€åäº¤æ˜“é‡ã€‚ </li><li>  numTrades-è®¡æ•°i-æ¯åˆ†é’Ÿçš„äº¤æ˜“æ•°ã€‚ </li><li> æ•°é‡-æ€»å’Œ-æ¯åˆ†é’Ÿçš„äº¤æ˜“æ€»å’Œã€‚ </li><li>  pvolume-æ€»ä»·-avgPriceå¿…éœ€çš„æ¯åˆ†é’Ÿçš„æ€»ä»·ã€‚ </li><li> å‘¨è½¬ç‡-æ€»ä»·*å¤§å°-æ¯åˆ†é’Ÿçš„æ€»äº¤æ˜“é‡ã€‚ </li><li>  avgPrice-pvolumeï¼…numTrades-æ¯åˆ†é’Ÿçš„å¹³å‡ä»·æ ¼ã€‚ </li><li>  avgSize-äº¤æ˜“é‡ï¼…numTrades-æ¯åˆ†é’Ÿçš„å¹³å‡äº¤æ˜“é‡ã€‚ </li><li>  vwap-è¥ä¸šé¢ï¼…äº¤æ˜“é‡-æ¯åˆ†é’Ÿçš„å¹³å‡ä»·æ ¼ï¼ŒæŒ‰äº¤æ˜“é‡‘é¢åŠ æƒã€‚ </li><li>  cumVolume-æ€»å’Œ-æ•´ä¸ªæ—¶é—´çš„ç´¯è®¡äº¤æ˜“é‡ã€‚ </li></ul><br> ç«‹å³è®¨è®ºä¸€ä¸ªä¸æ˜æ˜¾çš„é—®é¢˜-å¦‚ä½•é¦–æ¬¡ä»¥åŠæ¯éš”ä¸€åˆ†é’Ÿåˆå§‹åŒ–è¿™äº›åˆ—ã€‚ æ¯æ¬¡éƒ½ä¼šå°†firstPriceç±»å‹çš„æŸäº›åˆ—åˆå§‹åŒ–ä¸ºnullï¼Œä½†å…¶å€¼æœªå®šä¹‰ã€‚ å…¶ä»–ç±»å‹çš„éŸ³é‡å¿…é¡»å§‹ç»ˆè®¾ç½®ä¸º0ã€‚ä»ç„¶æœ‰ä¸€äº›åˆ—éœ€è¦ç»„åˆæ–¹æ³•-ä¾‹å¦‚ï¼Œå¿…é¡»ä»å‰ä¸€åˆ†é’Ÿå¤åˆ¶cumVolumeï¼Œå¹¶ä¸”å°†ç¬¬ä¸€ä¸ªè®¾ç½®ä¸º0ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ•°æ®ç±»å‹å­—å…¸ï¼ˆè®°å½•ç±»ä¼¼ï¼‰è®¾ç½®æ‰€æœ‰è¿™äº›å‚æ•°ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// list ! list â€“  , 0n â€“ float null, 0N â€“ long null, `sym â€“  , `sym1`sym2 â€“   initWith:`sym`time`high`low`firstPrice`lastPrice`firstSize`lastSize`numTrades`volume`pvolume`turnover`avgPrice`avgSize`vwap`cumVolume!(`;00:00;0n;0n;0n;0n;0N;0N;0;0;0.0;0.0;0n;0n;0n;0); aggCols:reverse key[initWith] except `sym`time; //    , reverse  </span></span></code> </pre> <br> ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘åœ¨å­—å…¸ä¸­æ·»åŠ äº†ç¬¦å·å’Œæ—¶é—´ï¼Œç°åœ¨initWithæ˜¯æœ€åä¸€ä¸ªæ±‡æ€»è¡¨ä¸­çš„æœ€åä¸€è¡Œï¼Œä¿ç•™å®ƒæ¥è®¾ç½®æ­£ç¡®çš„ç¬¦å·å’Œæ—¶é—´ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨å®ƒå‘è¡¨ä¸­æ·»åŠ æ–°è¡Œã€‚ <br><br> åˆ›å»ºèšåˆå‡½æ•°æ—¶éœ€è¦çš„aggColsã€‚ ç”±äºåœ¨Qä¸­è®¡ç®—è¡¨è¾¾å¼çš„é¡ºåºçš„ç‰¹æ®Šæ€§ï¼ˆä»å³åˆ°å·¦ï¼‰ï¼Œå› æ­¤å¿…é¡»åè½¬åˆ—è¡¨ã€‚ ç›®æ ‡æ˜¯æä¾›ä»é«˜åˆ°cumVolumeçš„æ–¹å‘çš„è®¡ç®—ï¼Œå› ä¸ºæŸäº›åˆ—ä¾èµ–äºå…ˆå‰çš„åˆ—ã€‚ <br><br> è¦å¤åˆ¶åˆ°ä¸Šä¸€åˆ†é’Ÿçš„æ–°åˆ†é’Ÿçš„åˆ—ï¼Œä¸ºæ–¹ä¾¿èµ·è§æ·»åŠ äº†symåˆ—ï¼š <br><br><pre> <code class="cpp hljs">rollColumns:`sym`cumVolume;</code> </pre><br> ç°åœ¨ï¼Œæˆ‘ä»¬æ ¹æ®åº”å¦‚ä½•æ›´æ–°å°†åˆ—åˆ†ä¸ºå‡ ç»„ã€‚ å¯ä»¥åŒºåˆ†ä¸‰ç§ç±»å‹ï¼š <br><br><ol><li> ç”µæ± ï¼ˆä½“ç§¯ï¼Œå‘¨è½¬é‡ï¼Œ..ï¼‰-æˆ‘ä»¬å¿…é¡»å°†è¾“å…¥å€¼æ·»åŠ åˆ°ä¸Šä¸€ä¸ªã€‚ </li><li> å¯¹äºç‰¹æ®Šç‚¹ï¼ˆé«˜ï¼Œä½ï¼Œ..ï¼‰-ä¸€åˆ†é’Ÿå†…ä»è¾“å…¥æ•°æ®ä¸­è·å–ç¬¬ä¸€ä¸ªå€¼ï¼Œå…¶ä½™ä½¿ç”¨è¯¥å‡½æ•°è¿›è¡Œè®¡æ•°ã€‚ </li><li> å…¶ä½™çš„ã€‚ å§‹ç»ˆä½¿ç”¨åŠŸèƒ½è¿›è¡Œè®¡æ•°ã€‚ </li></ol><br> ä¸ºè¿™äº›ç±»å®šä¹‰å˜é‡ï¼š <br><br><pre> <code class="cpp hljs">accumulatorCols:`numTrades`volume`pvolume`turnover; specialCols:`high`low`firstPrice`firstSize;</code> </pre><br><h3> è®¡ç®—é¡ºåº </h3><br> æˆ‘ä»¬å°†åˆ†ä¸¤ä¸ªé˜¶æ®µæ›´æ–°æ±‡æ€»è¡¨ã€‚ ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å°†é¦–å…ˆæ”¶ç¼©ä¼ å…¥è¡¨ï¼Œä»¥ä¾¿æ¯ä¸ªå­—ç¬¦å’Œåˆ†é’Ÿå‰©ä½™ä¸€è¡Œã€‚ æˆ‘ä»¬æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯é€’å¢çš„å’Œå…³è”çš„ï¼Œè¿™ä¸€äº‹å®å‘æˆ‘ä»¬ä¿è¯ï¼Œæ­¤é™„åŠ æ­¥éª¤çš„ç»“æœä¸ä¼šæ”¹å˜ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨selectæŒ¤å‹è¡¨æ ¼ï¼š <br><br><pre> <code class="cpp hljs">select high:max price, low:min price â€¦ by sym,time.minute from table</code> </pre><br> è¯¥æ–¹æ³•çš„ç¼ºç‚¹æ˜¯-è®¡ç®—åˆ—çš„é›†åˆæ˜¯é¢„å®šä¹‰çš„ã€‚ å¹¸è¿çš„æ˜¯ï¼Œåœ¨Qä¸­ï¼Œé€‰æ‹©è¿˜ä½œä¸ºä¸€ä¸ªå‡½æ•°å®ç°ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ›¿æ¢åŠ¨æ€åˆ›å»ºçš„å‚æ•°ï¼š <br><br><pre> <code class="cpp hljs">?[table;whereClause;byClause;selectClause]</code> </pre><br> æˆ‘ä¸ä¼šè¯¦ç»†æè¿°å‚æ•°çš„æ ¼å¼ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œä»…byå’Œselectè¡¨è¾¾å¼æ˜¯ä¸å¹³å‡¡çš„ï¼Œå®ƒä»¬åº”è¯¥æ˜¯è¡¨å•åˆ—çš„å­—å…¸ï¼ å› æ­¤ï¼Œå‹ç¼©å‡½æ•°å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs">selExpression:`high`low`firstPrice`lastPrice`firstSize`lastSize`numTrades`volume`pvolume`turnover!<span class="hljs-function"><span class="hljs-function">parse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">each</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"max price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"min price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"first price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"last price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"first size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"last size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"count i"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum price*size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// each   map  Q    preprocess:?[;();`sym`time!`sym`time.minute;selExpression];</span></span></code> </pre><br> ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä½¿ç”¨äº†parseå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†å¸¦æœ‰Qè¡¨è¾¾å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯ä»¥ä¼ é€’ç»™evalå‡½æ•°çš„å€¼ï¼Œå¹¶ä¸”åœ¨selectå‡½æ•°ä¸­æ˜¯å¿…éœ€çš„ã€‚ è¿˜è¦æ³¨æ„ï¼Œé¢„å¤„ç†è¢«å®šä¹‰ä¸ºé€‰æ‹©å‡½æ•°çš„æŠ•å½±ï¼ˆå³å…·æœ‰éƒ¨åˆ†å®šä¹‰çš„å‚æ•°çš„å‡½æ•°ï¼‰ï¼Œç¼ºå°‘ä¸€ä¸ªå‚æ•°ï¼ˆè¡¨ï¼‰ã€‚ å¦‚æœå°†é¢„å¤„ç†åº”ç”¨äºè¡¨ï¼Œåˆ™ä¼šå¾—åˆ°ç¼©å°çš„è¡¨ã€‚ <br><br> ç¬¬äºŒé˜¶æ®µæ˜¯æ›´æ–°æ±‡æ€»è¡¨ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨ä¼ªä»£ç ç¼–å†™ç®—æ³•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each sym in inputTable idx: row index in agg table <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sym+currentTime; aggTable[idx;`high]: aggTable[idx;`high] | inputTable[sym;`high]; aggTable[idx;`volume]: aggTable[idx;`volume] + inputTable[sym;`volume]; â€¦</code> </pre><br> åœ¨Qä¸­ï¼Œä¹ æƒ¯ä½¿ç”¨map / reduceå‡½æ•°è€Œä¸æ˜¯å¾ªç¯ã€‚ ä½†æ˜¯ç”±äºQæ˜¯å‘é‡è¯­è¨€ï¼Œå¹¶ä¸”æ‰€æœ‰è¿ç®—éƒ½å¯ä»¥ä¸€æ¬¡å®‰å…¨åœ°åº”ç”¨äºæ‰€æœ‰ç¬¦å·ï¼Œå› æ­¤ä½œä¸ºç¬¬ä¸€è¿‘ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨ä¸ä½¿ç”¨å¾ªç¯æ¥è¿›è¡Œä¸€æ¬¡è¿ç®—ï¼Œä¸€æ¬¡æ‰§è¡Œæ‰€æœ‰ç¬¦å·ï¼š <br><br><pre> <code class="cpp hljs">idx:calcIdx inputTable; row:aggTable idx; aggTable[idx;`high]: row[`high] | inputTable`high; aggTable[idx;`volume]: row[`volume] + inputTable`volume; â€¦</code> </pre><br> ä½†æ˜¯æˆ‘ä»¬å¯ä»¥èµ°å¾—æ›´è¿œï¼Œåœ¨Qä¸­ï¼Œæœ‰ä¸€ä¸ªç‹¬ç‰¹è€ŒåŠŸèƒ½å¼ºå¤§çš„è¿ç®—ç¬¦-å¹¿ä¹‰èµ‹å€¼è¿ç®—ç¬¦ã€‚ å®ƒå…è®¸æ‚¨ä½¿ç”¨ç´¢å¼•ï¼Œå‡½æ•°å’Œå‚æ•°çš„åˆ—è¡¨æ¥æ›´æ”¹å¤æ‚æ•°æ®ç»“æ„ä¸­çš„å€¼é›†ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><pre> <code class="cpp hljs">idx:calcIdx inputTable; rows:aggTable idx; <span class="hljs-comment"><span class="hljs-comment">// .[target;(idx0;idx1;..);function;argument] ~ target[idx 0;idx 1;â€¦]: function[target[idx 0;idx 1;â€¦];argument],     â€“   .[aggTable;(idx;aggCols);:;flip (row[`high] | inputTable`high;row[`volume] + inputTable`volume;â€¦)];</span></span></code> </pre><br> ä¸å¹¸çš„æ˜¯ï¼Œè¦åˆ†é…ç»™è¡¨ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªè¡Œè€Œä¸æ˜¯åˆ—çš„åˆ—è¡¨ï¼Œå¹¶ä¸”å¿…é¡»ä½¿ç”¨ç¿»è½¬åŠŸèƒ½å°†çŸ©é˜µï¼ˆåˆ—çš„åˆ—è¡¨è½¬æ¢ä¸ºè¡Œçš„åˆ—è¡¨ï¼‰è¿›è¡Œè½¬ç½®ã€‚ å¯¹äºå¤§è¡¨ï¼Œè¿™æ˜¯ä¸å¿…è¦çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mapå‡½æ•°ï¼ˆçœ‹èµ·æ¥åƒæ’‡å·ï¼‰å°†å¹¿ä¹‰åˆ†é…åˆ†åˆ«åº”ç”¨äºæ¯åˆ—ï¼š <br><br><pre> <code class="sql hljs">.[aggTable;;:;]'[(idx;)each aggCols; (row[`high] | inputTable`high;row[`volume] + inputTable`volume;â€¦)];</code> </pre><br> æˆ‘ä»¬å†æ¬¡ä½¿ç”¨æŠ•å½±åŠŸèƒ½ã€‚ è¿˜è¦æ³¨æ„ï¼Œåœ¨Qä¸­ï¼Œåˆ›å»ºåˆ—è¡¨ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨eachï¼ˆmapï¼‰å‡½æ•°æ¥è°ƒç”¨å®ƒä»¥è·å–åˆ—è¡¨åˆ—è¡¨ã€‚ <br><br> ä¸ºäº†ä½¿è®¡ç®—åˆ—çš„é›†åˆä¸å›ºå®šï¼Œè¯·åŠ¨æ€åˆ›å»ºä¸Šé¢çš„è¡¨è¾¾å¼ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ç”¨äºè®¡ç®—æ¯ä¸€åˆ—çš„å‡½æ•°ï¼Œä½¿ç”¨rowå’Œinpå˜é‡å¼•ç”¨æ±‡æ€»å’Œè¾“å…¥æ•°æ®ï¼š <br><br><pre> <code class="cpp hljs">aggExpression:`high`low`firstPrice`lastPrice`firstSize`lastSize`avgPrice`avgSize`vwap`cumVolume! (<span class="hljs-string"><span class="hljs-string">"row[`high]|inp`high"</span></span>;<span class="hljs-string"><span class="hljs-string">"row[`low]&amp;inp`low"</span></span>;<span class="hljs-string"><span class="hljs-string">"row`firstPrice"</span></span>;<span class="hljs-string"><span class="hljs-string">"inp`lastPrice"</span></span>;<span class="hljs-string"><span class="hljs-string">"row`firstSize"</span></span>;<span class="hljs-string"><span class="hljs-string">"inp`lastSize"</span></span>;<span class="hljs-string"><span class="hljs-string">"pvolume%numTrades"</span></span>;<span class="hljs-string"><span class="hljs-string">"volume%numTrades"</span></span>;<span class="hljs-string"><span class="hljs-string">"turnover%volume"</span></span>;<span class="hljs-string"><span class="hljs-string">"row[`cumVolume]+inp`volume"</span></span>);</code> </pre><br> ä¸€äº›åˆ—æ˜¯ç‰¹æ®Šçš„ï¼›å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå€¼ä¸åº”ç”±å‡½æ•°è®¡ç®—ã€‚ æˆ‘ä»¬å¯ä»¥ç¡®å®šå®ƒæ˜¯åˆ—è¡Œ[`numTrades]ä¸­çš„ç¬¬ä¸€ä¸ª-å¦‚æœå®ƒä¸º0ï¼Œåˆ™è¯¥å€¼ä¸ºç¬¬ä¸€ä¸ªã€‚  Qå…·æœ‰é€‰æ‹©åŠŸèƒ½-ï¼Ÿ[å¸ƒå°”åˆ—è¡¨ï¼›åˆ—è¡¨1ï¼›åˆ—è¡¨2]-æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°çš„æ¡ä»¶ä»åˆ—è¡¨1æˆ–2ä¸­é€‰æ‹©ä¸€ä¸ªå€¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// high -&gt; ?[isFirst;inp`high;row[`high]|inp`high] // @ -         @[`aggExpression;specialCols;{[x;y]"?[isFirst;inp`",y,";",x,"]"};string specialCols];</span></span></code> </pre><br> åœ¨è¿™é‡Œï¼Œæˆ‘ç”¨å‡½æ•°ï¼ˆç”¨èŠ±æ‹¬å·è¡¨ç¤ºï¼‰è°ƒç”¨äº†é€šç”¨åˆ†é…ã€‚ æˆ‘åœ¨ç¬¬4ä¸ªå‚æ•°ä¸­ä¼ é€’çš„å½“å‰å€¼ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰å’Œä¸€ä¸ªé™„åŠ å‚æ•°å°†ä¼ é€’ç»™å®ƒã€‚ <br><br> å¦å¤–ï¼Œæˆ‘ä»¬æ·»åŠ äº†ç”µæ± æ‰¬å£°å™¨ï¼Œå› ä¸ºå®ƒä»¬çš„åŠŸèƒ½ç›¸åŒï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// volume -&gt; row[`volume]+inp`volume aggExpression[accumulatorCols]:{"row[`",x,"]+inp`",x } each string accumulatorCols;</span></span></code> </pre><br> è¿™æ˜¯æŒ‰Qæ ‡å‡†è¿›è¡Œçš„é€šå¸¸åˆ†é…ï¼Œæˆ‘åªä¸€æ¬¡åˆ†é…ä¸€ä¸ªå€¼åˆ—è¡¨ã€‚ æœ€åï¼Œåˆ›å»ºä¸»è¦åŠŸèƒ½ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ":",/:aggExprs ~ map[{":",x};aggExpr] =&gt; ":row[`high]|inp`high"    ,          // string[cols],'exprs ~ map[,;string[cols];exprs] =&gt; "high:row[`high]|inp`high"   . ,'   map[concat] // ";" sv exprs â€“ String from Vector (sv),     â€œ;â€  updateAgg:value "{[aggTable;idx;inp] row:aggTable idx; isFirst:0=row`numTrades; .[aggTable;;:;]'[(idx;)each aggCols;(",(";"sv string[aggCols],'":",/:aggExpression aggCols),")]}";</span></span></code> </pre><br> ä½¿ç”¨æ­¤è¡¨è¾¾å¼ï¼Œæˆ‘å¯ä»¥ä»åŒ…å«ä¸Šé¢å¼•ç”¨çš„è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²ä¸­åŠ¨æ€åˆ›å»ºä¸€ä¸ªå‡½æ•°ã€‚ ç»“æœå°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="sql hljs">{[aggTable;idx;inp] rows:aggTable idx; isFirst:0=row`numTrades; .[aggTable;;:;]'[(idx;)each aggCols ;(cumVolume:row[`cumVolume]+inp`cumVolume;â€¦ ; high:?[isFirst;inp`high;row[`high]|inp`high])]}</code> </pre><br> åˆ—çš„è®¡ç®—é¡ºåºæ˜¯ç›¸åçš„ï¼Œå› ä¸ºåœ¨Qä¸­ï¼Œè®¡ç®—é¡ºåºæ˜¯ä»å³åˆ°å·¦ã€‚ <br><br> ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªè®¡ç®—æ‰€éœ€çš„ä¸»è¦åŠŸèƒ½ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ·»åŠ ä¸€äº›åŸºç¡€æ¶æ„å¹¶ä¸”æœåŠ¡å·²ç»å‡†å¤‡å°±ç»ªã€‚ <br><br><h3> æœ€åæ­¥éª¤ </h3><br> æˆ‘ä»¬å…·æœ‰preprocesså’ŒupdateAggå‡½æ•°ï¼Œå¯ä»¥å®Œæˆæ‰€æœ‰å·¥ä½œã€‚ ä½†æ˜¯ä»ç„¶æœ‰å¿…è¦ç¡®ä¿åœ¨æ•°åˆ†é’Ÿå†…æ­£ç¡®è¿‡æ¸¡å¹¶è®¡ç®—èšåˆç´¢å¼•ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰initå‡½æ•°ï¼š <br><br><pre> <code class="cpp hljs">init:{ tradeAgg:: <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-meta"><span class="hljs-meta">#enlist[initWith]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    , enlist    ,  0#   0    currTime::00:00; //   0, :: ,      currSyms::`u#`symbol$(); // `u# -    ,     offset::0; //   tradeAgg,     rollCache:: `sym xkey update `u#sym from rollColumns#tradeAgg; //     roll ,    sym }</span></span></span></span></code> </pre><br> æˆ‘ä»¬è¿˜å®šä¹‰äº†æ»šåŠ¨åŠŸèƒ½ï¼Œå®ƒå°†æ›´æ”¹å½“å‰åˆ†é’Ÿï¼š <br><br><pre> <code class="cpp hljs">roll:{[tm] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>[currTime&gt;tm; :init[]]; <span class="hljs-comment"><span class="hljs-comment">//    ,    init rollCache,::offset _ rollColumns#tradeAgg; //   â€“  roll   aggTable, ,   rollCache offset::count tradeAgg; currSyms::`u#`$(); }</span></span></code> </pre><br> æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥æ·»åŠ æ–°å­—ç¬¦ï¼š <br><br><pre> <code class="java hljs">addSyms:{[syms] currSyms,::syms; <span class="hljs-comment"><span class="hljs-comment">//     //    sym, time  rollColumns   . //  ^      roll ,     . value flip table     . `tradeAgg upsert @[count[syms]#enlist initWith;`sym`time,cols rc;:;(syms;currTime), (initWith cols rc)^value flip rc:rollCache ([] sym: syms)]; }</span></span></code> </pre><br> æœ€åï¼Œç”±å®¢æˆ·ç«¯è°ƒç”¨çš„updå‡½æ•°ï¼ˆæ­¤å‡½æ•°åœ¨QæœåŠ¡ä¸­çš„ä¼ ç»Ÿåç§°ï¼‰æ·»åŠ æ•°æ®ï¼š <br><br><pre> <code class="cpp hljs">upd:{[tblName;data] <span class="hljs-comment"><span class="hljs-comment">// tblName   ,       tm:exec distinct time from data:() xkey preprocess data; // preprocess &amp; calc time updMinute[data] each tm; //      }; updMinute:{[data;tm] if[tm&lt;&gt;currTime; roll tm; currTime::tm]; //  ,   data:select from data where time=tm; //  if[count msyms:syms where not (syms:data`sym)in currSyms; addSyms msyms]; //   updateAgg[`tradeAgg;offset+currSyms?syms;data]; //   .  ?        . };</span></span></code> </pre><br> ä»…æ­¤è€Œå·²ã€‚ è¿™æ˜¯æˆ‘ä»¬æ‰€æ‰¿è¯ºçš„æœåŠ¡çš„å®Œæ•´ä»£ç ï¼Œä»…å‡ è¡Œï¼š <br><br><pre> <code class="cpp hljs">initWith:`sym`time`high`low`firstPrice`lastPrice`firstSize`lastSize`numTrades`volume`pvolume`turnover`avgPrice`avgSize`vwap`cumVolume!(`;<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>N;<span class="hljs-number"><span class="hljs-number">0</span></span>N;<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0.0</span></span>;<span class="hljs-number"><span class="hljs-number">0.0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>n;<span class="hljs-number"><span class="hljs-number">0</span></span>); aggCols:reverse key[initWith] except `sym`time; rollColumns:`sym`cumVolume; accumulatorCols:`numTrades`volume`pvolume`turnover; specialCols:`high`low`firstPrice`firstSize; selExpression:`high`low`firstPrice`lastPrice`firstSize`lastSize`numTrades`volume`pvolume`turnover!<span class="hljs-function"><span class="hljs-function">parse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">each</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"max price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"min price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"first price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"last price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"first size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"last size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"count i"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum price"</span></span></span></span><span class="hljs-function"><span class="hljs-params">;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sum price*size"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; preprocess:?[;();`sym`time!`sym`time.minute;selExpression]; aggExpression:`high`low`firstPrice`lastPrice`firstSize`lastSize`avgPrice`avgSize`vwap`cumVolume!(<span class="hljs-string"><span class="hljs-string">"row[`high]|inp`high"</span></span>;<span class="hljs-string"><span class="hljs-string">"row[`low]&amp;inp`low"</span></span>;<span class="hljs-string"><span class="hljs-string">"row`firstPrice"</span></span>;<span class="hljs-string"><span class="hljs-string">"inp`lastPrice"</span></span>;<span class="hljs-string"><span class="hljs-string">"row`firstSize"</span></span>;<span class="hljs-string"><span class="hljs-string">"inp`lastSize"</span></span>;<span class="hljs-string"><span class="hljs-string">"pvolume%numTrades"</span></span>;<span class="hljs-string"><span class="hljs-string">"volume%numTrades"</span></span>;<span class="hljs-string"><span class="hljs-string">"turnover%volume"</span></span>;<span class="hljs-string"><span class="hljs-string">"row[`cumVolume]+inp`volume"</span></span>); @[`aggExpression;specialCols;{<span class="hljs-string"><span class="hljs-string">"?[isFirst;inp`"</span></span>,y,<span class="hljs-string"><span class="hljs-string">";"</span></span>,x,<span class="hljs-string"><span class="hljs-string">"]"</span></span>};<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> specialCols]; aggExpression[accumulatorCols]:{<span class="hljs-string"><span class="hljs-string">"row[`"</span></span>,x,<span class="hljs-string"><span class="hljs-string">"]+inp`"</span></span>,x } each <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> accumulatorCols; updateAgg:value <span class="hljs-string"><span class="hljs-string">"{[aggTable;idx;inp] row:aggTable idx; isFirst:0=row`numTrades; .[aggTable;;:;]'[(idx;)each aggCols;("</span></span>,(<span class="hljs-string"><span class="hljs-string">";"</span></span>sv <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[aggCols],<span class="hljs-string"><span class="hljs-string">'":",/:aggExpression aggCols),")]}"; / '</span></span> init:{ tradeAgg::<span class="hljs-number"><span class="hljs-number">0</span></span>#enlist[initWith]; currTime::<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>; currSyms::`u#`symbol$(); offset::<span class="hljs-number"><span class="hljs-number">0</span></span>; rollCache:: `sym xkey update `u#sym from rollColumns#tradeAgg; }; roll:{[tm] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>[currTime&gt;tm; :init[]]; rollCache,::offset _ rollColumns#tradeAgg; offset::count tradeAgg; currSyms::`u#`$(); }; addSyms:{[syms] currSyms,::syms; `tradeAgg upsert @[count[syms]#enlist initWith;`sym`time,cols rc;:;(syms;currTime),(initWith cols rc)^value flip rc:rollCache ([] sym: syms)]; }; upd:{[tblName;data] updMinute[data] each exec distinct time from data:() xkey preprocess data}; updMinute:{[data;tm] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>[tm&lt;&gt;currTime; roll tm; currTime::tm]; data:select from data where time=tm; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>[count msyms:syms where <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (syms:data`sym)in currSyms; addSyms msyms]; updateAgg[`tradeAgg;offset+currSyms?syms;data]; };</code> </pre><br><h3> æµ‹è¯•ä¸­ </h3><br> æ£€æŸ¥æœåŠ¡æ€§èƒ½ã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œå®ƒï¼ˆå°†ä»£ç æ”¾å…¥service.qæ–‡ä»¶ä¸­ï¼‰å¹¶è°ƒç”¨initå‡½æ•°ï¼š <br><br><pre> <code class="plaintext hljs">q service.q â€“p 5566 q)init[]</code> </pre><br> åœ¨å¦ä¸€ä¸ªæ§åˆ¶å°ä¸­ï¼Œå¯åŠ¨ç¬¬äºŒä¸ªQè¿›ç¨‹å¹¶è¿æ¥åˆ°ç¬¬ä¸€ä¸ªï¼š <br><br><pre> <code class="cpp hljs">h:hopen `:host:<span class="hljs-number"><span class="hljs-number">5566</span></span> h:hopen <span class="hljs-number"><span class="hljs-number">5566</span></span> <span class="hljs-comment"><span class="hljs-comment">//     </span></span></code> </pre><br> é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªå­—ç¬¦åˆ—è¡¨-10,000ä¸ªï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå‡½æ•°ä»¥åˆ›å»ºéšæœºè¡¨ã€‚ åœ¨ç¬¬äºŒä¸ªæ§åˆ¶å°ä¸­ï¼š <br><br><pre> <code class="cpp hljs">syms:`IBM`AAPL`GOOG,<span class="hljs-number"><span class="hljs-number">-9997</span></span>?`<span class="hljs-number"><span class="hljs-number">8</span></span> rnd:{[n;t] ([] sym:n?syms; time:t+asc n#til <span class="hljs-number"><span class="hljs-number">25</span></span>; price:n?<span class="hljs-number"><span class="hljs-number">10f</span></span>; size:n?<span class="hljs-number"><span class="hljs-number">10</span></span>)}</code> </pre><br> æˆ‘åœ¨å­—ç¬¦åˆ—è¡¨ä¸­æ·»åŠ äº†ä¸‰ä¸ªå®å­—ç¬¦ï¼Œä»¥ä½¿åœ¨è¡¨ä¸­æŸ¥æ‰¾å®ƒä»¬æ›´åŠ æ–¹ä¾¿ã€‚  rndå‡½æ•°åˆ›å»ºä¸€ä¸ªå…·æœ‰nè¡Œçš„éšæœºè¡¨ï¼Œå…¶ä¸­æ—¶é—´ä»tåˆ°t + 25æ¯«ç§’ä¸ç­‰ã€‚ <br><br> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•å°†æ•°æ®å‘é€åˆ°æœåŠ¡ï¼ˆæ·»åŠ å‰åä¸ªå°æ—¶ï¼‰ï¼š <br><br><pre> <code class="cpp hljs">{h (`upd;`trade;rnd[<span class="hljs-number"><span class="hljs-number">10000</span></span>;x])} each `time$<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> + til <span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br> æ‚¨å¯ä»¥åœ¨æœåŠ¡ä¸­æ£€æŸ¥è¡¨æ˜¯å¦å·²æ›´æ–°ï¼š <br><br><pre> <code class="cpp hljs">\c <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> select from tradeAgg where sym=`AAPL <span class="hljs-number"><span class="hljs-number">-20</span></span>#select from tradeAgg where sym=`AAPL</code> </pre><br> ç»“æœï¼š <br><br><pre> <code class="1c hljs">sym<span class="hljs-string"><span class="hljs-string">|time|high|low|firstPrice|lastPrice|firstSize|lastSize|numTrades|volume|pvolume|turnover|avgPrice|avgSize|vwap|cumVolume --|--|--|--|--|-------------------------------- AAPL|09:27|9.258904|9.258904|9.258904|9.258904|8|8|1|8|9.258904|74.07123|9.258904|8|9.258904|2888 AAPL|09:28|9.068162|9.068162|9.068162|9.068162|7|7|1|7|9.068162|63.47713|9.068162|7|9.068162|2895 AAPL|09:31|4.680449|0.2011121|1.620827|0.2011121|1|5|4|14|9.569556|36.84342|2.392389|3.5|2.631673|2909 AAPL|09:33|2.812535|2.812535|2.812535|2.812535|6|6|1|6|2.812535|16.87521|2.812535|6|2.812535|2915 AAPL|09:34|5.099025|5.099025|5.099025|5.099025|4|4|1|4|5.099025|20.3961|5.099025|4|5.099025|2919</span></span></code> </pre> <br> ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿›è¡Œè´Ÿè½½æµ‹è¯•ï¼Œä»¥æ‰¾å‡ºæœåŠ¡æ¯åˆ†é’Ÿå¯ä»¥å¤„ç†å¤šå°‘æ•°æ®ã€‚ è®©æˆ‘æé†’æ‚¨ï¼Œæˆ‘ä»¬å°†æ›´æ–°é—´éš”è®¾ç½®ä¸º25æ¯«ç§’ã€‚ å› æ­¤ï¼Œæ¯æ¬¡æ›´æ–°æœåŠ¡ï¼ˆå¹³å‡ï¼‰åº”è‡³å°‘é€‚åˆ20æ¯«ç§’ï¼Œä»¥ä½¿ç”¨æˆ·æœ‰æ—¶é—´è¯·æ±‚æ•°æ®ã€‚ åœ¨ç¬¬äºŒä¸ªè¿‡ç¨‹ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="cpp hljs">tm:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.000</span></span> stressTest:{[n] <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[tm],<span class="hljs-string"><span class="hljs-string">" "</span></span>; times,::h ({st:.zT; upd[`trade;x]; .zT-st};rnd[n;tm]); tm+:<span class="hljs-number"><span class="hljs-number">25</span></span>} start:{[n] times::(); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>[<span class="hljs-number"><span class="hljs-number">4800</span></span>;stressTest[n]]; <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>; `min`avg`med`max!(min times;avg times;med times;max times)}</code> </pre><br>  4800æ˜¯ä¸¤åˆ†é’Ÿã€‚ æ‚¨å¯ä»¥å°è¯•æ¯25æ¯«ç§’é¦–å…ˆå¼€å§‹1000è¡Œï¼š <br><br><pre> <code class="cpp hljs">start <span class="hljs-number"><span class="hljs-number">1000</span></span></code> </pre><br> å°±æˆ‘è€Œè¨€ï¼Œæ¯æ¬¡æ›´æ–°çš„ç»“æœå¤§çº¦æ˜¯å‡ æ¯«ç§’ã€‚ å› æ­¤ï¼Œæˆ‘å°†ç«‹å³å°†è¡Œæ•°å¢åŠ åˆ°10.000ï¼š <br><br><pre> <code class="cpp hljs">start <span class="hljs-number"><span class="hljs-number">10000</span></span></code> </pre><br> ç»“æœï¼š <br><br><pre> <code class="cpp hljs">min| <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.004</span></span> avg| <span class="hljs-number"><span class="hljs-number">9.191458</span></span> med| <span class="hljs-number"><span class="hljs-number">9f</span></span> max| <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.030</span></span></code> </pre><br> åŒæ ·ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œä½†è¿™æ˜¯æ¯åˆ†é’Ÿ2400ä¸‡è¡Œï¼Œæ¯ç§’40ä¸‡è¡Œã€‚ åœ¨25åˆ†é’Ÿä»¥ä¸Šçš„æ—¶é—´å†…ï¼Œæ›´æ–°é€Ÿåº¦ä»…é™ä½äº†5å€ï¼Œè¿™æ˜¾ç„¶æ˜¯åœ¨æ›´æ”¹åˆ†é’Ÿæ•°æ—¶è¿›è¡Œçš„ã€‚ å¢åŠ åˆ°100,000ï¼š <br><br><pre> <code class="cpp hljs">start <span class="hljs-number"><span class="hljs-number">100000</span></span></code> </pre><br> ç»“æœï¼š <br><br><pre> <code class="cpp hljs">min| <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.013</span></span> avg| <span class="hljs-number"><span class="hljs-number">25.11083</span></span> med| <span class="hljs-number"><span class="hljs-number">24f</span></span> max| <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.108</span></span> q)sum times <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00.532</span></span></code> </pre><br> å¦‚æ‚¨æ‰€è§ï¼Œè¯¥æœåŠ¡å‹‰å¼ºå¯ä»¥åº”ä»˜ï¼Œä½†ä»ç„¶å¯ä»¥ç»´æŒè¿è½¬ã€‚ è¿™ç§æ•°æ®é‡ï¼ˆæ¯åˆ†é’Ÿ2.4äº¿è¡Œï¼‰éå¸¸å¤§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šè¿è¡ŒæœåŠ¡çš„å¤šä¸ªå…‹éš†ï¼ˆç”šè‡³æ•°åä¸ªå…‹éš†ï¼‰ï¼Œæ¯ä¸ªå…‹éš†ä»…å¤„ç†éƒ¨åˆ†å­—ç¬¦ã€‚ ä½†æ˜¯ï¼Œå¯¹äºè§£é‡Šè¯­è¨€æ¥è¯´ï¼Œå…¶ç»“æœä»¤äººå°è±¡æ·±åˆ»ï¼Œè¯¥è¯­è¨€ä¸»è¦é›†ä¸­åœ¨æ•°æ®å­˜å‚¨ä¸Šã€‚ <br><br> å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ—¶é—´ä¼šéšç€æ¯æ¬¡æ›´æ–°çš„å¤§å°éçº¿æ€§å¢é•¿ã€‚ åŸå› æ˜¯å‹ç¼©å‡½æ•°å®é™…ä¸Šæ˜¯Cå‡½æ•°ï¼Œå…¶å·¥ä½œæ•ˆç‡æ¯”updateAggé«˜å¾—å¤šã€‚ ä»æŸä¸ªæ›´æ–°å¤§å°ï¼ˆå¤§çº¦10.000ï¼‰å¼€å§‹ï¼ŒupdateAggè¾¾åˆ°ä¸Šé™ï¼Œç„¶åå…¶æ‰§è¡Œæ—¶é—´ä¸å–å†³äºæ›´æ–°çš„å¤§å°ã€‚ ç”±äºé¢„å¤‡æ­¥éª¤Qï¼Œè¯¥æœåŠ¡èƒ½å¤Ÿæ¶ˆåŒ–æ­¤ç±»æ•°æ®é‡ã€‚ è¿™å¼ºè°ƒäº†åœ¨å¤„ç†å¤§æ•°æ®æ—¶é€‰æ‹©æ­£ç¡®ç®—æ³•çš„é‡è¦æ€§ã€‚ å¦ä¸€ç‚¹æ˜¯åœ¨å†…å­˜ä¸­æ­£ç¡®å­˜å‚¨æ•°æ®ã€‚ å¦‚æœæ•°æ®æœªå­˜å‚¨åœ¨åˆ—ä¸­æˆ–æœªæŒ‰æ—¶é—´æ’åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ç†Ÿæ‚‰è¯¸å¦‚TLBé«˜é€Ÿç¼“å­˜æœªå‘½ä¸­-å¤„ç†å™¨åœ°å€é«˜é€Ÿç¼“å­˜ä¸­ä¸å­˜åœ¨å†…å­˜é¡µé¢åœ°å€çš„æƒ…å†µã€‚ åœ¨å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼ŒæŸ¥æ‰¾è¯¥åœ°å€å¤§çº¦éœ€è¦30å€çš„æ—¶é—´ï¼Œåœ¨æ•°æ®åˆ†æ•£çš„æƒ…å†µä¸‹ï¼ŒæŸ¥æ‰¾é€Ÿåº¦ä¼šé™ä½æ•°å€ã€‚ <br><br><h3> ç»“è®º </h3><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å±•ç¤ºäº†KDB +å’ŒQæ•°æ®åº“ä¸ä»…é€‚åˆå­˜å‚¨å¤§æ•°æ®å¹¶å¯ä»¥é€šè¿‡é€‰æ‹©è½»æ¾è®¿é—®å®ƒä»¬ï¼Œè€Œä¸”è¿˜é€‚ç”¨äºåˆ›å»ºå³ä½¿åœ¨ä¸€ä¸ªQè¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥æ¶ˆåŒ–æ•°äº¿è¡Œ/åƒå…†å­—èŠ‚æ•°æ®çš„æ•°æ®å¤„ç†æœåŠ¡ã€‚ ã€‚  Qè¯­è¨€æœ¬èº«å…·æœ‰çŸ¢é‡æ€§è´¨ï¼ŒSQLæ–¹è¨€çš„å†…ç½®è§£é‡Šå™¨ä»¥åŠéå¸¸æˆåŠŸçš„åº“å‡½æ•°é›†ï¼Œå› æ­¤å®ƒå¯ä»¥éå¸¸ç®€çŸ­æœ‰æ•ˆåœ°å®ç°ä¸æ•°æ®å¤„ç†æœ‰å…³çš„ç®—æ³•ã€‚ <br><br> æˆ‘å°†æ³¨æ„åˆ°ï¼Œä»¥ä¸Šåªæ˜¯QåŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè¿˜å…·æœ‰å…¶ä»–ç‹¬ç‰¹åŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼Œæå…¶ç®€å•çš„IPCåè®®æ¶ˆé™¤äº†å„ä¸ªQè¿›ç¨‹ä¹‹é—´çš„è¾¹ç•Œï¼Œä½¿æ‚¨å¯ä»¥å°†æ•°ç™¾ä¸ªè¿™äº›è¿›ç¨‹ç»„åˆåˆ°ä¸€ä¸ªç½‘ç»œä¸­ï¼Œè¯¥ç½‘ç»œå¯ä»¥ä½äºä¸–ç•Œå„åœ°çš„æ•°åå°æœåŠ¡å™¨ä¸Šã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN470596/">https://habr.com/ru/post/zh-CN470596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN470578/index.html">æˆ‘ä»¬å¦‚ä½•åœ¨ç§»åŠ¨é“¶è¡Œä¸­â€œäººæ€§åŒ–â€ç°¿è®°</a></li>
<li><a href="../zh-CN470582/index.html">æ£€æŸ¥Telerik UIä»¥ä½¿ç”¨UWPä½œä¸ºPVS-Studioå…¥é—¨</a></li>
<li><a href="../zh-CN470584/index.html">æ£€æŸ¥Telerik UIä»¥è·å–UWPä»¥äº†è§£PVS-Studio</a></li>
<li><a href="../zh-CN470592/index.html">Pleskè¯„ä¼°-æ‰˜ç®¡å’Œç«™ç‚¹æ§åˆ¶é¢æ¿</a></li>
<li><a href="../zh-CN470594/index.html">è«æ–¯ç§‘ç¯å…‰ç§€â€œ Circle of Lightâ€ 2019å¹´çš„æŠ¥é“</a></li>
<li><a href="../zh-CN470598/index.html">ã€Šç°ä»£Javaã€‹ä¸€ä¹¦ã€‚ Lambdaè¡¨è¾¾å¼ï¼Œæµå’Œå‡½æ•°å¼ç¼–ç¨‹â€</a></li>
<li><a href="../zh-CN470600/index.html">å…³äºå®‰å…¨çš„noVNCæ§åˆ¶å°ï¼ŒKubernetesä¸­çš„è‡ªåŠ¨ç¼©æ”¾ï¼ŒOstrovkaä¸­çš„Haproxyä»¥åŠç¨‹åºå‘˜ä¸ç®¡ç†å‘˜çš„åˆä½œ</a></li>
<li><a href="../zh-CN470602/index.html">è«æ–¯ç§‘åœ°é“åœ¨ä¸‰ç»´ä¸–ç•Œä¸­çš„å¤–è§‚</a></li>
<li><a href="../zh-CN470604/index.html">ç”µå­å•†åŠ¡ä¸­ç½‘ç«™åŠ è½½çš„é€Ÿåº¦ï¼šå¯¹ä¿„ç½—æ–¯48å®¶é¡¶çº§åœ¨çº¿å•†åº—çš„åˆ†æ</a></li>
<li><a href="../zh-CN470608/index.html">Unity UIä¼˜åŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>