<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕉️ 🚝 💮 Dasar-dasar routing statis di Mikrotik RouterOS 📺 🏦 🤹🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Routing adalah proses menemukan jalur optimal untuk pengiriman paket pada jaringan TCP / IP. Perangkat apa pun yang terhubung ke jaringan IPv4 berisi ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dasar-dasar routing statis di Mikrotik RouterOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443788/"><p>  Routing adalah proses menemukan jalur optimal untuk pengiriman paket pada jaringan TCP / IP.  Perangkat apa pun yang terhubung ke jaringan IPv4 berisi tabel proses dan rute. </p><br><p>  Artikel ini bukan HOWTO, ini menggambarkan perutean statis di RouterOS sebagai contoh, saya sengaja menghilangkan sisa pengaturan (misalnya, srcnat untuk mengakses Internet), jadi untuk memahami materi ini memerlukan tingkat pengetahuan tertentu tentang jaringan dan RouterOS. </p><a name="habracut"></a><br><h3 id="kommutaciya-i-marshrutizaciya">  Switching dan Routing </h3><br><p><img src="https://habrastorage.org/webt/5v/h7/a2/5vh7a2relrje9g9e5kbonuogsqw.png"></p><br><p>  Switching adalah proses pertukaran paket dalam satu segmen Layer2 (Ethernet, ppp, ...).  Jika perangkat melihat bahwa penerima paket berada pada subnet Ethernet yang sama seperti itu, ia mengenali alamat mac menggunakan protokol arp dan mentransmisikan paket secara langsung, melewati router.  Koneksi ppp (point-to-point) hanya dapat memiliki dua anggota dan paket selalu dikirim ke alamat 0xff yang sama. </p><br><p>  Routing adalah proses pengiriman paket antar segmen Layer2.  Jika perangkat ingin mengirim paket, penerima yang berada di luar segmen Ethernet, ia akan melihat tabel peruteannya dan meneruskan paket tersebut ke gateway yang tahu ke mana harus mengirim paket lebih lanjut (atau mungkin tidak tahu, pengirim asli paket tersebut tidak mengetahui hal ini). </p><br><p>  Cara termudah untuk mempertimbangkan router adalah sebagai perangkat yang terhubung ke dua atau lebih segmen Layer2 dan mampu mengirimkan paket di antara mereka, menentukan rute optimal dari tabel routing. </p><br><p>  Jika semuanya jelas bagi Anda atau Anda sudah mengetahuinya, maka baca terus.  Saya sangat menyarankan agar orang lain membaca artikel kecil tapi sangat komprehensif. </p><br><h3 id="marshrutizaciya-v-routeros-i-packetflow">  Routing di RouterOS dan PacketFlow </h3><br><p>  Hampir semua fungsi yang berkaitan dengan routing statis ada dalam paket <em>sistem</em> .  Paket <em>perutean</em> menambahkan dukungan untuk algoritma perutean dinamis (RIP, OSPF, BGP, MME), Filter Perutean, dan BFD. </p><br><p> Menu utama untuk mengonfigurasi perutean: <code>[IP]-&gt;[Route]</code> .  Skema yang kompleks mungkin memerlukan pelabelan awal dari paket dengan label perutean di: <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> (rantai <code>PREROUTING</code> dan <code>OUTPUT</code> ). </p><br><p>  Ada tiga tempat di PacketFlow di mana keputusan dibuat tentang perutean paket IP: <br><img src="https://habrastorage.org/webt/pk/ie/mp/pkiempktzjkwz6tcwrnwyl1c1dc.png"></p><br><ol><li>  Paket routing yang diterima oleh router.  Pada tahap ini, diputuskan bahwa paket akan pergi ke proses lokal atau akan dikirim lebih jauh ke jaringan.  Paket transit menerima <em>Antarmuka Output</em> </li><li>  Merutekan paket keluar lokal.  Paket keluar menerima <em>Antarmuka Output</em> </li><li>  Langkah perutean tambahan untuk paket keluar memungkinkan Anda untuk mengubah keputusan perutean di <code>[Output|Mangle]</code> </li></ol><br><ul><li>  Jalur paket di blok 1, 2 tergantung pada aturan di <code>[IP]-&gt;[Route]</code> </li><li>  Jalur paket di langkah 1, 2 dan 3 tergantung pada aturan di <code>[IP]-&gt;[Route]-&gt;[Rules]</code> </li><li>  Jalur paket di blok 1, 3 dapat dipengaruhi menggunakan <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li></ul><br><h3 id="rib-fib-routing-cache">  RIB, FIB, Routing Cache </h3><br><p><img src="https://habrastorage.org/webt/fw/jc/ku/fwjckuzqzyxo4udazveb8uhotuq.png"></p><br><p>  <strong>Basis informasi routing</strong> <br>  Basis di mana rute dari protokol routing dinamis dikumpulkan, rute dari ppp dan dhcp, rute statis dan terhubung.  Basis data ini berisi semua rute kecuali yang difilter oleh administrator. </p><br><p>  <em>Berdasarkan konvensi</em> , kita dapat mengasumsikan bahwa <code>[IP]-&gt;[Route]</code> menampilkan RIB. </p><br><p>  <strong>Penerusan basis informasi</strong> <br><img src="https://habrastorage.org/webt/kt/jn/q1/ktjnq1ebrd0--d9afkseuixtap8.png"></p><br><p>  Pangkalan tempat rute terbaik dari RIB pergi.  Semua rute dalam FIB aktif dan digunakan untuk meneruskan paket.  Jika rute menjadi tidak aktif (dinonaktifkan oleh administrator (sistem), atau antarmuka melalui mana paket harus dikirim tidak aktif), rute akan dihapus dari FIB. </p><br><p>  Untuk membuat keputusan tentang perutean, data paket IP berikut digunakan dalam tabel FIB: </p><br><ul><li>  Alamat sumber </li><li>  Alamat tujuan </li><li>  Sumber antarmuka </li><li>  Tanda rute </li><li>  ToS (DSCP) </li></ul><br><p>  Masuk ke paket FIB melalui tahapan berikut: </p><br><ul><li>  Apakah paket dirancang untuk proses router lokal? </li><li>  Apakah paket termasuk dalam sistem PBR atau aturan pengguna? <br><ul><li>  Jika demikian, paket tersebut dikirim ke tabel routing yang ditentukan. </li></ul></li><li>  Paket dikirim ke tabel utama </li></ul><br><p>  <em>Secara konvensi</em> , kita dapat mengasumsikan bahwa <code>[IP]-&gt;[Route Active=yes]</code> menampilkan FIB. </p><br><p>  <strong>Cache perutean</strong> <br>  Mekanisme untuk rute caching.  Perute ingat ke mana paket-paket itu dikirim, dan jika ada yang serupa (mungkin dari koneksi yang sama), itu memulai mereka di sepanjang rute yang sama, tanpa memeriksa di FIB.  Cache rute dihapus secara berkala. </p><br><p>  Untuk administrator, RouterOS tidak memiliki sarana untuk melihat dan mengelola Cache Routing, tetapi dengan itu Anda dapat menonaktifkannya di <code>[IP]-&gt;[Settings]</code> . </p><br><p>  <em>Mekanisme ini telah dihapus dari kernel Linux 3.6, tetapi kernel 3.3.5 masih digunakan di RouterOS, mungkin Routing cache adalah salah satu alasannya.</em> </p><br><h3 id="dialog-dobavleniya-marshruta">  Rute Tambahkan Dialog </h3><br><p> <code>[IP]-&gt;[Route]-&gt;[+]</code> <br> <img src="https://habrastorage.org/webt/th/lb/el/thlbel_kvf2gk-s2125imh_z7cg.png"></p><br><ol><li>  Subnet tempat Anda ingin membuat rute (default: 0.0.0.0/0) </li><li>  Gateway IP atau antarmuka ke mana paket akan dikirim (mungkin ada beberapa, lihat ECMP di bawah) </li><li>  Memeriksa Ketersediaan Gateway </li><li>  Jenis rekaman </li><li>  Jarak (metrik) untuk rute </li><li>  Tabel perutean </li><li>  IP untuk paket keluar lokal melalui rute ini </li><li>  Tujuan Lingkup dan Lingkup Target ditulis di akhir artikel. </li></ol><br><p>  <strong>Bendera rute</strong> <br><img src="https://habrastorage.org/webt/ai/ro/iv/airoivo1bmk3lgbqj_hivpbjdyc.png"></p><br><ul><li>  X - Rute dinonaktifkan oleh administrator ( <code>disabled=yes</code> ) </li><li>  A - Rute digunakan untuk mengirimkan paket. </li><li>  D - Rute ditambahkan secara dinamis (BGP, OSPF, RIP, MME, PPP, DHCP, Connected) </li><li>  C - Subnet terhubung langsung ke router </li><li>  S - Rute Statis </li><li>  r, b, o, m - Rute ditambahkan oleh salah satu protokol routing dinamis </li><li>  B, U, P - Rute pemfilteran (membuang paket alih-alih mengirim) </li></ul><br><h3 id="chto-ukazyvat-v-gateway-ip-adres-ili-interfeys">  Apa yang harus ditentukan di gateway: ip-address atau antarmuka? </h3><br><p>  Sistem ini memungkinkan Anda untuk menentukan keduanya, sementara itu tidak bersumpah dan tidak memberikan petunjuk jika Anda melakukan sesuatu yang salah. </p><br><p>  <strong>Alamat IP</strong> <br>  Alamat gateway harus dapat diakses melalui Layer2.  Untuk Ethernet, ini berarti bahwa router harus memiliki alamat IP dari subnet yang sama pada salah satu antarmuka aktif, untuk ppp - bahwa alamat gateway terdaftar pada salah satu antarmuka aktif sebagai alamat subnet. <br>  Jika kondisi ketersediaan untuk Layer2 tidak terpenuhi, rute dianggap tidak aktif dan tidak termasuk dalam FIB. </p><br><p>  <strong>Antarmuka</strong> <br>  Semuanya lebih rumit dan perilaku router tergantung pada jenis antarmuka: </p><br><ul><li>  PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *) koneksi mengasumsikan bahwa hanya ada dua peserta dan paket akan selalu dikirim ke gateway untuk transmisi, jika gateway mendeteksi bahwa itu adalah penerima itu sendiri, itu akan mentransfer paket ke proses lokalnya. <br><img src="https://habrastorage.org/webt/90/-g/xk/90-gxkgtlplrv8sstcs4r70bxx4.png"></li><li>  Ethernet berasumsi ada banyak peserta dan akan mengirim permintaan ke antarmuka arp dengan alamat penerima paket, ini adalah perilaku yang diharapkan dan cukup normal untuk rute yang terhubung. <br>  Tetapi ketika Anda mencoba menggunakan antarmuka sebagai rute untuk subnet jarak jauh, Anda mendapatkan situasi berikut: rute aktif, ping lewat ke gateway, tetapi tidak mencapai penerima dari subnet yang ditentukan.  Jika Anda melihat antarmuka melalui sniffer, Anda akan melihat permintaan arp dengan alamat dari subnet jarak jauh. <br><img src="https://habrastorage.org/webt/62/si/qp/62siqpa8gbtxi-8x4eymxgv19vi.png"></li></ul><br><p><img src="https://habrastorage.org/webt/i6/-n/nb/i6-nnbyrlylq0jk6pqwefb_2qz8.png"></p><br><p>  Cobalah untuk menentukan alamat ip sebagai gateway bila memungkinkan.  Pengecualian adalah rute yang terhubung (dibuat secara otomatis) dan antarmuka PPP (Async, PPTP, L2TP, SSTP, PPPoE, OpenVPN *). </p><br><p>  <em>OpenVPN tidak mengandung header PPP, tetapi Anda dapat menggunakan nama antarmuka OpenVPN untuk membuat rute.</em> </p><br><h3 id="more-specific-route">  Rute yang lebih spesifik </h3><br><p>  Aturan dasar routing.  Rute yang menggambarkan subnet yang lebih kecil (dengan subnet mask terbesar) memiliki prioritas yang lebih tinggi ketika memutuskan perutean paket.  Posisi entri dalam tabel perutean tidak terkait dengan pemilihan - aturan dasar lebih spesifik. </p><br><p><img src="https://habrastorage.org/webt/sm/cy/i9/smcyi9gkebkm8iq-yjcbev8-vs0.png"></p><br><p>  Semua rute dari skema yang ditentukan aktif (terletak di FIB), karena  arahkan ke subnet yang berbeda dan tidak saling bertentangan. </p><br><p>  Jika salah satu gateway menjadi tidak tersedia, rute terkait akan dianggap tidak aktif (dihapus dari FIB) dan paket akan dicari dari rute yang tersisa. </p><br><p>  Sebuah rute dengan subnet dari 0.0.0.0/0 kadang-kadang diberikan arti khusus dan disebut "Rute Default" atau "gerbang pilihan terakhir".  Bahkan, tidak ada yang ajaib di dalamnya dan itu hanya mencakup semua alamat IPv4 yang mungkin, tetapi nama-nama ini menggambarkan tujuannya dengan baik - ini menunjukkan gateway tempat untuk meneruskan paket yang tidak ada rute lain yang lebih akurat. </p><br><p>  Subnet mask maksimum yang mungkin untuk IPv4 adalah / 32; rute ini menunjuk ke host tertentu dan dapat digunakan dalam tabel routing. </p><br><p>  <em>Memahami Rute yang Lebih Spesifik sangat penting untuk setiap perangkat TCP / IP.</em> </p><br><h3 id="distance">  Jarak </h3><br><p>  Jarak (atau Metrik) diperlukan untuk penyaringan administratif rute ke satu subnet yang dapat diakses melalui beberapa gateway.  Rute dengan metrik lebih rendah dianggap prioritas dan akan berada di FIB.  Jika rute dengan metrik yang lebih rendah berhenti aktif, maka di FIB akan diganti dengan rute dengan metrik yang lebih tinggi. <br><img src="https://habrastorage.org/webt/dz/yz/mh/dzyzmhb2y_fjqpbkbp2juyhfxsi.png"></p><br><p>  Jika ada beberapa rute ke subnet yang sama dengan metrik yang sama, router hanya akan menambahkan satu dari mereka ke tabel FIB, dipandu oleh logika internalnya. </p><br><p>  Metrik dapat mengambil nilai dari 0 hingga 255: <br><img src="https://habrastorage.org/webt/rh/fk/j1/rhfkj1shnnjhqmvwhcc7o0itq8i.png"></p><br><ul><li>  0 - Metrik untuk rute yang terhubung.  Jarak 0 tidak dapat ditetapkan oleh administrator </li><li>  1-254 - Metrik tersedia untuk administrator untuk menetapkan rute.  Metrik dengan nilai lebih rendah diutamakan. </li><li>  255 - Metrik tersedia untuk administrator untuk menetapkan rute.  Tidak seperti 1-254, rute dengan metrik 255 selalu tetap tidak aktif dan tidak termasuk dalam FIB </li><li>  Metrik khusus.  Rute yang diterima dari protokol routing dinamis memiliki nilai metrik standar </li></ul><br><h3 id="check-gateway">  Periksa gateway </h3><br><p>  Periksa gateway - ekstensi MikroTik RoutesOS untuk memeriksa ketersediaan gateway melalui icmp atau arp.  Sekali setiap 10 detik (tidak dapat diubah), permintaan dikirim ke gateway, jika jawabannya tidak datang dua kali, rute dianggap tidak tersedia dan dihapus dari FIB.  Jika gateway pemeriksaan telah menonaktifkan rute verifikasi, rute berlanjut dan rute menjadi aktif kembali setelah satu pemeriksaan berhasil. <br><img src="https://habrastorage.org/webt/a_/km/vd/a_kmvd8xeoeyrnjqz78ciry1ja4.png"></p><br><p>  Check gateway menonaktifkan entri yang dikonfigurasi dan semua entri lainnya (di semua tabel routing dan rute ecmp) dengan gateway yang ditentukan. </p><br><p>  Secara umum, periksa gateway berfungsi dengan baik jika tidak ada masalah dengan paket loss ke gateway.  Check gateway tidak tahu apa yang terjadi dengan komunikasi di luar gateway yang diperiksa, untuk ini diperlukan alat tambahan: skrip, perutean berulang, protokol perutean dinamis. </p><br><p>  Sebagian besar VPN dan protokol tunneling berisi alat bawaan untuk memeriksa aktivitas koneksi, memungkinkan gateway check untuk mereka adalah beban tambahan (tetapi sangat kecil) pada kinerja jaringan dan perangkat. </p><br><h3 id="ecmp-marshruty">  Rute ECMP </h3><br><p>  Equal-Cost Multi-Path - mengirim paket ke penerima menggunakan beberapa gateway secara bersamaan dengan algoritma Round Robin. </p><br><p>  Rute ECMP dibuat oleh administrator dengan menetapkan beberapa gateway untuk satu subnet (atau otomatis, jika ada dua rute setara OSPF). <br><img src="https://habrastorage.org/webt/4v/gz/yh/4vgzyh240kmasdj186yz2c3ovws.png"></p><br><p>  ECMP digunakan untuk menyeimbangkan beban antara dua saluran, secara teori, jika ada dua saluran dalam rute ecmp, maka untuk setiap paket saluran keluar harus berbeda.  Tetapi mekanisme cache Routing mengirimkan paket-paket dari koneksi di sepanjang rute yang paket pertama pergi, sebagai hasilnya, kita mendapatkan semacam balancing pemuatan per-koneksi. </p><br><p>  Jika Anda menonaktifkan Routing Cache, maka paket-paket dalam rute ECMP akan dibagi dengan benar, tetapi ada masalah dengan NAT.  Aturan NAT hanya memproses paket pertama dari koneksi (sisanya diproses secara otomatis) dan situasinya adalah bahwa paket dengan satu alamat sumber pergi dari antarmuka yang berbeda. <br><img src="https://habrastorage.org/webt/gj/cw/bl/gjcwblj73dmsczyhyqyuchcpdw0.png"></p><br><p>  Periksa gateway (bug RouterOS) tidak berfungsi dalam rute ECMP.  Tetapi Anda dapat mengatasi batasan ini jika Anda membuat rute tambahan untuk verifikasi, yang akan menonaktifkan entri dalam ECMP. </p><br><h3 id="filtraciya-sredstvami-routing">  Penyaringan Routing </h3><br><p>  Opsi Type menentukan apa yang harus dilakukan dengan paket: </p><br><ul><li>  unicast - kirim ke gateway (antarmuka) yang ditentukan </li><li>  blackhole - jatuhkan paket </li><li>  larangan, tidak terjangkau - jatuhkan paket dan kirim pesan icmp ke pengirim </li></ul><br><p>  Penyaringan biasanya digunakan ketika Anda perlu mengamankan pengiriman paket dengan cara yang salah, tentu saja Anda dapat memfilter ini melalui firewall. </p><br><h3 id="para-primerov">  Beberapa contoh </h3><br><p>  Untuk memperbaiki hal-hal dasar tentang perutean. </p><br><p>  <strong>Router Rumah Khas</strong> <br><img src="https://habrastorage.org/webt/2a/fk/xx/2afkxxlv7lhluitqufsybt3s5pg.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1</code> </pre> <br><ol><li>  Rute statis ke 0.0.0.0/0 (rute default) </li><li>  Rute yang terhubung pada antarmuka dengan penyedia </li><li>  Rute yang terhubung pada antarmuka LAN </li></ol><br><p>  <strong>Router Rumah PPPoE Khas</strong> <br><img src="https://habrastorage.org/webt/im/wn/8p/imwn8pafrqins6erowkhiek2dqa.png"></p><br><ol><li>  Rute statis ke rute default, ditambahkan secara otomatis sejak  ini ditunjukkan dalam properti koneksi </li><li>  Rute yang terhubung untuk koneksi PPP </li><li>  Rute yang terhubung pada antarmuka LAN </li></ol><br><p>  <strong>Router rumah khas dengan dua penyedia dan redundansi</strong> <br><img src="https://habrastorage.org/webt/wq/2a/v0/wq2av0eskridghrj9yroknjz76o.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 distance=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><ol><li>  Rute statis ke rute default melalui penyedia pertama dengan metrik 1 dan memeriksa ketersediaan gateway </li><li>  Rute statis ke rute default melalui penyedia kedua dengan metrik 2 </li><li>  Rute yang Terhubung </li></ol><br><p>  Lalu lintas ke 0.0.0.0/0 melewati 10.10.10.1, sementara gateway ini tersedia, jika tidak maka beralih ke 10.20.20.1 </p><br><p>  <em>Skema seperti itu dapat dianggap reservasi saluran, tetapi bukan tanpa kekurangan.</em>  <em>Jika terjadi kerusakan di luar gerbang penyedia (misalnya, di dalam jaringan operator), router Anda tidak akan mengetahuinya dan akan terus mempertimbangkan rute yang aktif.</em> </p><br><p>  <strong>Router rumah khas dengan dua penyedia, redundansi dan ECMP</strong> <br><img src="https://habrastorage.org/webt/un/fj/aw/unfjawyzmjdzo6_ekmmg93vlsk8.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1,10.20.20.1 distance=1</code> </pre> <br><ol><li>  Rute statis untuk memeriksa chack gateway </li><li>  Rute ECMP </li><li>  Rute yang Terhubung </li></ol><br><p>  Rute untuk memeriksa biru (warna rute tidak aktif), tetapi ini tidak mengganggu pengoperasian gateway pemeriksaan.  Dalam versi saat ini (6.44) RoS, prioritas otomatis diberikan ke rute ECMP, tetapi lebih baik untuk menambahkan rute uji ke tabel routing lainnya (opsi <code>routing-mark</code> ) </p><br><p>  Tidak akan ada peningkatan kecepatan pada Speedtest dan situs serupa lainnya (ECMP membagi lalu lintas dengan koneksi, bukan paket), tetapi aplikasi P2P harus memuat lebih cepat. </p><br><p>  <strong>Memfilter melalui Routing</strong> <br><img src="https://habrastorage.org/webt/gv/bj/nh/gvbjnhvblrebv9051hd_x8adklo.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 add dst-address=192.168.200.0/24 gateway=10.30.30.1 distance=1 add dst-address=192.168.200.0/24 gateway=10.10.10.1 distance=2 type=blackhole</code> </pre> <br><ol><li>  Rute statis ke rute default </li><li>  Rute statis ke 192.168.200.0/24 melalui terowongan ipip </li><li>  Melarang rute statis ke 192.168.200.0/24 melalui router penyedia </li></ol><br><p>  Opsi penyaringan di mana lalu lintas terowongan tidak pergi ke router penyedia ketika antarmuka ipip dinonaktifkan.  Skema seperti itu jarang diperlukan, karena  dimungkinkan untuk menerapkan pemblokiran melalui firewall. </p><br><p>  <strong>Routing loop</strong> <br>  Routing loop adalah situasi di mana paket berjalan di antara router sebelum ttl berakhir.  Biasanya itu adalah konsekuensi dari kesalahan konfigurasi, dalam jaringan besar diperlakukan oleh implementasi protokol routing dinamis, dalam jaringan kecil - dengan hati-hati. </p><br><p>  Itu terlihat seperti ini: <br><img src="https://habrastorage.org/webt/ii/h8/-v/iih8-vpacnim4b6flslcvy-v0eg.png"></p><br><p>  Contoh (paling sederhana) cara mendapatkan hasil yang serupa: <br><img src="https://habrastorage.org/webt/ky/9v/gv/ky9vgvnxvno8x79cbu79be0_buu.png"></p><br><p>  Contoh loop Routing tidak memiliki penggunaan praktis, tetapi itu menunjukkan bahwa router tidak tahu tentang tabel routing tetangga mereka. </p><br><h3 id="policy-base-routing-i-dopolnitelnye-tablicy-marshrutizacii">  Routing Basis Kebijakan dan Tabel Routing Tambahan </h3><br><p>  Saat memilih rute, router hanya menggunakan satu bidang dari header paket (Alamat Dst) - ini adalah rute dasar.  Perutean berdasarkan kondisi lain, seperti alamat sumber, jenis lalu lintas (ToS), penyeimbangan tanpa ECMP, merujuk ke Policy Base Routing (PBR) dan menggunakan tabel perutean tambahan. </p><br><p><img src="https://habrastorage.org/webt/cf/31/fj/cf31fjsrsjd2aszbzkl_hmg9wuw.png"></p><br><p>  <em>Rute Lebih Spesifik</em> adalah aturan dasar untuk memilih rute dalam tabel routing. </p><br><p>  Secara default, semua aturan perutean ditambahkan ke tabel utama.  Administrator dapat membuat sejumlah tabel routing dan paket rute tambahan sewenang-wenang.  Aturan dalam tabel yang berbeda tidak saling bertentangan.  Jika paket tidak menemukan aturan yang sesuai di tabel yang ditentukan, itu akan pergi ke tabel utama. </p><br><p>  Contoh distribusi melalui Firewall: <br><img src="https://habrastorage.org/webt/uw/nd/jz/uwndjzt8mtfett8l84vg-n65p90.png"></p><br><ul><li>  192.168.100.10 -&gt; 8.8.8.8 <br><ol><li>  Lalu lintas dari 192.168.100.10 menerima <em>label via-isp1</em> di <code>[Prerouting|Mangle]</code> </li><li>  Pada tahap Routing, dalam tabel <em>via-isp1, sebuah rute</em> dicari hingga 8.8.8.8 </li><li>  Rute ditemukan, lalu lintas dikirim ke gateway 10.10.10.1 </li></ol></li><li>  192.168.200.20 -&gt; 8.8.8.8 <br><ol><li>  Lalu lintas dari 192.168.200.20 menerima <em>label via-isp2</em> di <code>[Prerouting|Mangle]</code> </li><li>  Pada tahap Routing, tabel <em>via-isp2 mencari</em> rute hingga 8.8.8.8 </li><li>  Rute ditemukan, lalu lintas dikirim ke gateway 10.20.20.1 </li></ol></li><li>  Jika salah satu gateway (10.10.10.1 atau 10.20.20.1) menjadi tidak tersedia, maka paket akan pergi ke tabel <em>utama</em> dan akan mencari rute yang sesuai di sana </li></ul><br><h3 id="problemy-terminologii">  Masalah terminologi </h3><br><p>  RouterOS memiliki masalah terminologi tertentu. <br>  Ketika bekerja dengan aturan dalam <code>[IP]-&gt;[Routes]</code> tabel routing ditunjukkan, meskipun dikatakan bahwa label: <br><img src="https://habrastorage.org/webt/8i/kh/kh/8ikhkhsxvmlwnh9hd9g-quxnk18.png"></p><br><p>  Dalam <code>[IP]-&gt;[Routes]-&gt;[Rule]</code> semuanya benar, dalam label kondisi dalam tindakan tabel: <br><img src="https://habrastorage.org/webt/0m/hl/5j/0mhl5jj73m7rfm4rvtb5qwpbix4.png"></p><br><h3 id="kak-otpravit-paket-v-opredelennuyu-tablicu-marshrutizacii">  Cara mengirim paket ke tabel routing tertentu </h3><br><p>  RouterOS menyediakan beberapa alat: </p><br><ul><li>  Aturan dalam <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> </li><li>  Merute label ( <code>action=mark-routing</code> ) di <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code> </li><li>  VRF </li></ul><br><p>  <strong>Aturan <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Aturan diproses secara berurutan, jika paket cocok dengan kondisi aturan, itu tidak melangkah lebih jauh. </p><br><p>  Aturan Perutean memungkinkan Anda untuk memperluas kemampuan perutean, tidak hanya mengandalkan alamat penerima, tetapi juga alamat sumber dan antarmuka tempat paket diterima. </p><br><p><img src="https://habrastorage.org/webt/hg/ip/py/hgippyt0pgilh0l9zouqqqpbsoe.png"></p><br><p>  Aturan terdiri dari kondisi dan tindakan: </p><br><ul><li>  Ketentuan  Mereka praktis mengulangi daftar tanda-tanda dimana paket diperiksa dalam FIB, hanya ToS yang hilang. </li><li>  Tindakan <br><ul><li>  lookup - mengirim paket ke tabel </li><li>  lihat saja di tabel - kunci paket di dalam tabel, jika rute tidak ditemukan paket tidak akan pergi ke tabel utama </li><li>  drop - drop paket </li><li>  tidak dapat dijangkau - jatuhkan paket pemberitahuan pengirim </li></ul></li></ul><br><p>  Dalam FIB, lalu lintas ke proses lokal diproses melewati aturan <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : <br><img src="https://habrastorage.org/webt/yk/f4/gt/ykf4gt4ywwzgbklpyzlyulije8k.png"></p><br><p>  <strong>Menandai <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Label rute memungkinkan Anda mengatur gateway untuk paket menggunakan hampir semua kondisi Firewall: <br><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><p>  <em>Praktis, karena tidak semuanya masuk akal, dan beberapa mungkin bekerja tidak stabil.</em> </p><br><p><img src="https://habrastorage.org/webt/6b/_m/om/6b_mom-f6nde0zyuy-mr62asho4.png"></p><br><p>  Ada dua cara untuk menandai suatu paket: </p><br><ul><li>  Setel <em>tanda perutean</em> segera </li><li>  Pertama-tama atur <em>tanda-koneksi</em> , kemudian berdasarkan pada <em>tanda-koneksi</em> atur <em>tanda-rute</em> </li></ul><br><p>  Dalam sebuah artikel tentang firewall, saya menulis bahwa opsi kedua lebih disukai karena  mengurangi beban pada cpu, dalam hal penandaan rute - ini tidak sepenuhnya benar.  Metode penandaan ini tidak selalu setara dan biasanya digunakan untuk menyelesaikan berbagai masalah. </p><br><h3 id="primery-ispolzovaniya">  Contoh Penggunaan </h3><br><p>  Kami menyampaikan contoh-contoh menggunakan Routing Basis Kebijakan, jauh lebih mudah untuk menunjukkan kepada mereka mengapa semua ini diperlukan. </p><br><p>  <strong>MultiWAN dan respons lalu lintas keluar (Output)</strong> <br>  Masalah umum dengan konfigurasi MultiWAN: Mikrotik dapat diakses dari Internet hanya melalui penyedia "aktif". <br><img src="https://habrastorage.org/webt/ob/1p/ph/ob1pph0eph9qvz9nqvt759mptiq.png"></p><br><p>  Tidak masalah bagi router apa IP permintaan datang, ketika menghasilkan respons, itu akan mencari rute dalam tabel routing, di mana rute melalui isp1 aktif.  Selanjutnya, paket seperti itu kemungkinan besar akan disaring dalam perjalanan ke penerima. </p><br><p>  <em>Poin menarik lainnya.</em>  <em>Jika "simple" source nat dikonfigurasi pada antarmuka ether1: <code>/ip fi nat add out-interface=ether1 action=masquerade</code> paket akan menuju jaringan dengan src.</em>  <em>address = 10.10.10.100, yang akan semakin memperburuk situasi.</em> </p><br><p>  Ada beberapa cara untuk memperbaiki masalah, tetapi salah satu dari mereka akan memerlukan tabel routing tambahan: <br><img src="https://habrastorage.org/webt/g9/65/vy/g965vychbnzbsksplywfc3npi90.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 check-gateway=ping distance=1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 check-gateway=ping distance=2 add dst-address=0.0.0.0/0 gateway=10.10.10.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 routing-mark=over-isp2</code> </pre> <br><p>  <strong>Menggunakan <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br>  Tentukan tabel routing yang akan digunakan untuk paket dengan IP Sumber yang ditentukan. <br><img src="https://habrastorage.org/webt/na/lm/b3/nalmb3u0yrde35z0mzdjm1xygr4.png"></p><br><pre> <code class="plaintext hljs">/ip route rule add src-address=10.10.10.100/32 action=lookup-only-in-table table=over-isp1 add src-address=10.20.20.200/32 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>  <em>Anda dapat menggunakan <code>action=lookup</code> , tetapi untuk lalu lintas keluar lokal, opsi ini sepenuhnya mengecualikan koneksi dari antarmuka yang salah.</em> </p><br><ul><li>  Sistem menghasilkan paket respons dengan Src.  Alamat: 10.20.20.200 </li><li>  Pada tahap Routing Decision (2), <code>[IP]-&gt;[Routes]-&gt;[Rules]</code> dicentang dan paket dikirim ke tabel routing <em>over-isp2</em> </li><li>  Sesuai dengan tabel routing, paket harus dikirim ke gateway 10.20.20.1 melalui antarmuka ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/k-/zf/sg/k-zfsgxxdpqbufnwoobbno8d_aq.png"></p><br><p>  Metode ini tidak memerlukan Pelacak Koneksi yang berfungsi, tidak seperti menggunakan tabel Mangle. </p><br><p>  <strong>Menggunakan <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>  Koneksi dimulai dengan paket yang masuk, jadi kami menandainya ( <code>action=mark-connection</code> ), untuk paket keluar dari koneksi yang ditandai kami mengatur label rute ( <code>action=mark-routing</code> ). <br><img src="https://habrastorage.org/webt/lg/4v/ni/lg4vni1mt8eteade7mcitz_3s3g.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle #   add chain=input in-interface=ether1 connection-state=new action=mark-connection new-connection-mark=from-isp1 add chain=input in-interface=ether2 connection-state=new action=mark-connection new-connection-mark=from-isp2 #      add chain=output connection-mark=from-isp1 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=output connection-mark=from-isp2 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p> <em>      ip,     <code>dst-address</code>  .</em> </p><br><ul><li>   ether2    .    <code>[INPUT|Mangle]</code>         <em>from-isp2</em> </li><li>      Src. Address: 10.20.20.200 </li><li>   Routing Decision(2)          10.20.20.1   ether1.        <code>[OUTPUT|Filter]</code> </li><li>   <code>[OUTPUT|Mangle]</code>       <em>from-isp2</em>      <em>over-isp2</em> </li><li>   Routing Adjusment(3)             </li><li>            10.20.20.1   ether2 </li></ul><br><p><img src="https://habrastorage.org/webt/rd/mr/qs/rdmrqst9dam9m7r9s4jsnudwdly.png"></p><br><h3 id="multiwan-i-otvetnyy-dst-nat-trafik"> MultiWAN   dst-nat  </h3><br><p>  ,        ( web)             . </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether1 action=dst-nat to-address=192.168.100.100 add chain=dstnat proto=tcp dst-port=80,443 in-interface=ether2 action=dst-nat to-address=192.168.100.100</code> </pre> <br><p>     ,      Firewall Mangle,     : <br><img src="https://habrastorage.org/webt/3w/9i/pq/3w9ipqogda4itpjkpvqbw7ewxrg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting connection-state=new in-interface=ether1 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp1 add chain=prerouting connection-state=new in-interface=ether2 protocol=tcp dst-port=80,443 action=mark-connection new-connection-mark=web-input-isp2 add chain=prerouting connection-mark=web-input-isp1 in-interface=ether3 action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting connection-mark=web-input-isp2 in-interface=ether3 action=mark-routing new-routing-mark=over-isp2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/fb/qf/np/fbqfnpzfpcshxwzl2ruppyjh5qw.png"><br> <em>    NAT,      .</em> </p><br><h3 id="multiwan-i-ishodyaschie-soedineniya"> MultiWAN    </h3><br><p>    PBR    vpn (  SSTP)     . </p><br><p><img src="https://habrastorage.org/webt/pt/jg/m3/ptjgm36vdijiuvygzwl8csvwg5q.png"></p><br><p>   : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=192.168.100.1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 routing-mark=over-isp3 add dst-address=0.0.0.0/0 gateway=192.168.100.1 distance=1 add dst-address=0.0.0.0/0 gateway=192.168.200.1 distance=2 add dst-address=0.0.0.0/0 gateway=192.168.0.1 distance=3</code> </pre> <br><p>  : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output dst-address=10.10.10.100 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp1 passtrough=no add chain=output dst-address=10.10.10.101 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp2 passtrough=no add chain=output dst-address=10.10.10.102 proto=tcp dst-port=443 action=mark-routing new-routing-mark=over-isp3 passtrough=no</code> </pre> <br><p>   NAT,        Src. Address: </p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=srcnat out-interface=ether1 action=masquerade add chain=srcnat out-interface=ether2 action=masquerade add chain=srcnat out-interface=ether3 action=masquerade</code> </pre> <br><p> : </p><br><ul><li>     SSTP </li><li>   Routing Decision (2)     ,     main.       Src. Address    ether1 </li><li>  <code>[Output|Mangle]</code>        </li><li>         Routing Adjusment        </li><li>       Src. Address  ether1,   <code>[Nat|Srcnat]</code>       </li></ul><br><p> ,        : <br><img src="https://habrastorage.org/webt/i9/gd/x0/i9gdx0o9s0iqnr4shoxdtfqnh2i.png"></p><br><p> Connection Tracker   <code>[Mangle]</code>  <code>[Srcnat]</code> ,       ,      <code>Replay Dst. Address</code>    NAT: <br><img src="https://habrastorage.org/webt/ps/op/qa/psopqak9ysxfem9lebg7woyizk4.png"></p><br><p>  VPN  (      )         : <br><img src="https://habrastorage.org/webt/s7/nc/jz/s7ncjzninvkxn_a6-p3wdd5ywnw.png"></p><br><p> <strong> </strong> <br>   ,         : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=10.10.10.100 gateway=192.168.100.1 add dst-address=10.10.10.101 gateway=192.168.200.1 add dst-address=10.10.10.102 gateway=192.168.0.1</code> </pre> <br><p>              . ,        vpn      ,     6   <code>[IP]-&gt;[Routes]</code>  <code>type=blackhole</code> .    — 3   <code>[IP]-&gt;[Route]-&gt;[Rules]</code> . </p><br><h3 id="raspredelenie-soedineniy-polzovateley-po-kanalam-svyazi">       </h3><br><p> ,  .      : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2</code> </pre> <br><p> <strong> <code>[IP]-&gt;[Route]-&gt;[Rules]</code></strong> <br><img src="https://habrastorage.org/webt/-m/4o/jv/-m4ojve7wspajkjoc00afbpsbru.png"></p><br><pre> <code class="plaintext hljs">/ip route rules add src-address=192.168.100.0/25 action=lookup-only-in-table table=over-isp1 add src-address=192.168.100.128/25 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>action=lookup</code> ,           main     .     —   . </p><br><p> <strong>   <code>[IP]-&gt;[Firewall]-&gt;[Mangle]</code></strong> <br>     ip .       . <em>  layer7,      ,      ,       .</em> <br><img src="https://habrastorage.org/webt/u8/k5/yi/u8k5yito7_iuseo5cki-nhkaz5o.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address-list=users-over-isp1 dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 add chain=prerouting src-address-list=users-over-isp2 dst-address-type=!local action=mark-routing new-routing-mark=over-isp2</code> </pre> <br><p> ""        <code>[IP]-&gt;[Route]-&gt;[Rules]</code> : </p><br><pre> <code class="plaintext hljs">/ip route rules add routing-mark=over-isp1 action=lookup-only-in-table table=over-isp1 add routing-mark=over-isp2 action=lookup-only-in-table table=over-isp2</code> </pre> <br><p>   <code>[IP]-&gt;[Firewall]-&gt;[Filter]</code> : </p><br><pre> <code class="plaintext hljs">/ip firewall filter add chain=forward routing-mark=over-isp1 out-interface=!ether1 action=reject add chain=forward routing-mark=over-isp2 out-interface=!ether2 action=reject</code> </pre> <br><p> <strong>  <code>dst-address-type=!local</code></strong> <br>   <code>dst-address-type=!local</code>           (dns, winbox, ssh, ...).       ,          ,   <code>dst-address-table</code> . </p><br><p>     <code>[IP]-&gt;[Route]-&gt;[Rules]</code>   ,      .   ,    FIB    <code>[PREROUTING|Mangle]</code>           main,    .    Routing Rules,            User PBR      . </p><br><p> <strong> <code>[IP]-&gt;[Firewall]-&gt;[Mangle action=route]</code></strong> <br>      <code>[Prerouting|Mangle]</code>            ,    : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting src-address=192.168.100.0/25 action=route gateway=10.10.10.1 add chain=prerouting src-address=192.168.128.0/25 action=route gateway=10.20.20.1</code> </pre> <br><p>  <code>route</code>        ( <code>[IP]-&gt;[Route]-&gt;[Rules]</code> ).          ,    <code>action=route</code>    <code>action=mark-route</code> ,     (    <code>passtrough</code> ),   . <br> <em> wiki            ,               .</em> </p><br><h3 id="dinamicheskaya-balansirovka-na-osnove-ppc">     PPC </h3><br><p> Per Connection Classificator —     ECMP.    ECMP       (ECMP     ,     Routing Cache   ). </p><br><p> PCC  <em> </em>  ip ,    32-     <em></em> .       <em></em>    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> .  ,  . <br><img src="https://habrastorage.org/webt/md/xn/kz/mdxnkzst4p7nxatp2bnvjbrlsoe.png"></p><br><p>    : </p><br><pre> <code class="plaintext hljs">192.168.100.10: 192+168+100+10 = 470 % 3 = 2 192.168.100.11: 192+168+100+11 = 471 % 3 = 0 192.168.100.12: 192+168+100+12 = 472 % 3 = 1</code> </pre> <br><p>      src.address   : <br><img src="https://habrastorage.org/webt/sq/dn/rt/sqdnrtcsgypqle5ftv2rg23xvmg.png"></p><br><pre> <code class="plaintext hljs">#  /ip route add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=2 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=3 check-gateway=ping add dst-address=0.0.0.0/0 gateway=10.10.10.1 dist=1 routing-mark=over-isp1 add dst-address=0.0.0.0/0 gateway=10.20.20.1 dist=1 routing-mark=over-isp2 add dst-address=0.0.0.0/0 gateway=10.30.30.1 dist=1 routing-mark=over-isp3 #    /ip firewall mangle add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/0 action=mark-connection new-connection-mark=conn-over-isp1 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/1 action=mark-connection new-connection-mark=conn-over-isp2 add chain=prerouting in-interface=br-lan dst-address-type=!local connection-state=new per-connection-classifier=src-address:3/2 action=mark-connection new-connection-mark=conn-over-isp3 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp1 action=mark-routing new-routing-mark=over-isp1 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp2 action=mark-routing new-routing-mark=over-isp2 add chain=prerouting in-interface=br-lan connection-mark=conn-over-isp3 action=mark-routing new-routing-mark=over-isp3</code> </pre> <br><p>      : <code>in-interface=br-lan</code> ,    <code>action=mark-routing</code>               . </p><br><h3 id="pereklyuchenie-kanalov-svyazi">    </h3><br><p> Check ping —  ,        IP ,                 ,            ,   check ping          . <br>           BGP,                 . </p><br><p>   ,        ip    ,      ,  google dns: 8.8.8.8. 8.8.4.4.    Mikrotik      . </p><br><p> <strong>    </strong> <br>      Multihop BGP               MikroTik,          check gateway       . </p><br><p>         scope/target scope       : <br><img src="https://habrastorage.org/webt/_m/kz/aw/_mkzawioocf0friubndc9q2pofw.png"></p><br><ol><li>           scope      main      target scope </li><li>     ,        </li><li>   connected        </li></ol><br><p>        ,    : <br><img src="https://habrastorage.org/webt/s4/jo/tv/s4jotv0vsxcofu8pcod2uzugfo4.png"></p><br><ul><li> 1-3  connected    ,       </li><li> 4-6   connected   ""  </li></ul><br><p>        RIB,   FIB    : <code>0.0.0.0/0 via 10.10.10.1 on ether1</code> . </p><br><p> <strong>      </strong> <br><img src="https://habrastorage.org/webt/f1/gd/hj/f1gdhjwli1fqi4yk7i-cfdyf2l0.png"></p><br><p> : <br><img src="https://habrastorage.org/webt/d8/bb/ae/d8bbaepprp0wswv54ly0ryzphhc.png"></p><br><pre> <code class="plaintext hljs">/ip route add dst-address=0.0.0.0/0 gateway=8.8.8.8 check-gateway=ping distance=1 target-scope=10 add dst-address=8.8.8.8 gateway=10.10.10.1 scope=10 add dst-address=0.0.0.0/0 gateway=10.20.20.1 distance=2</code> </pre> <br><p>  ,      10.10.10.1: <br><img src="https://habrastorage.org/webt/k6/nq/a9/k6nqa98jmecubjxx8e2zndbclcc.png"></p><br><p> Check gateway          ping'   8.8.8.8,  (   main)    10.10.10.1. </p><br><p>      10.10.10.1  8.8.8.8,    ,   (  ping)  8.8.8.8    10.10.10.1: <br><img src="https://habrastorage.org/webt/hj/v2/tg/hjv2tg5bnkaae2gyr7iunr74kt4.png"></p><br><p>      ether1,    ,    8.8.8.8    : <br><img src="https://habrastorage.org/webt/rt/_d/ad/rt_dadf8--ghn5pmgyg7q1ya258.png"></p><br><p>  ,    NetWatch      8.8.8.8.    NetWatch            .     : </p><br><pre> <code class="plaintext hljs">/ip route add dst-address=8.8.8.8 gateway=10.20.20.1 distance=100 type=blackhole</code> </pre> <br><p><img src="https://habrastorage.org/webt/ks/6e/k3/ks6ek3swyj9uyiih0bkbef1i6eu.png"></p><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> ,    NetWatch   . </p><br><p>  ,      8.8.8.8       ,       dns    . </p><br><h3 id="para-slov-pro-virtual-routing-and-forwarding-vrf">    Virtual Routing and Forwarding (VRF) </h3><br><p>  VRF         ,        (    MPLS)    L3VPN     : <br><img src="https://habrastorage.org/webt/hk/0l/ep/hk0lep0gncmeajzj1pkp2wix6yk.png"></p><br><p>  VRF  Mikrotik         ,   ip      VRF,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a> . </p><br><p>   vrf: <br><img src="https://habrastorage.org/webt/gl/g8/k8/glg8k8isgjjsgyjodp7-rnqq5fi.png"></p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0</code> </pre> <br><p>     ether2 ,   ping      vrf (  ),   ping    : <br><img src="https://habrastorage.org/webt/pz/a7/h_/pza7h_xts_jyk6czos89h47q45u.png"></p><br><p>            main (  vrf   route leaking): <br><img src="https://habrastorage.org/webt/on/p-/5z/onp-5z4cvah-erroi_flwnjn2ik.png"></p><br><pre> <code class="plaintext hljs">/ip route add distance=1 gateway=172.17.0.1@main routing-mark=vrf1 add distance=1 gateway=172.17.0.1%wlan1 routing-mark=vrf2</code> </pre> <br><p> <em>    route leaking:   : <code>172.17.0.1@main</code>    : <code>172.17.0.1%wlan1</code> .</em> </p><br><p>        <code>[PREROUTING|Mangle]</code> : <br><img src="https://habrastorage.org/webt/ge/w3/pa/gew3paz7vdzqkzc0-pt0mz5b6yg.png"></p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=prerouting in-interface=ether1 action=mark-connection new-connection-mark=from-vrf1 passthrough=no add chain=prerouting connection-mark=from-vrf1 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting in-interface=ether2 action=mark-connection new-connection-mark=from-vrf2 passthrough=no add chain=prerouting connection-mark=from-vrf2 routing-mark=!vrf1 action=mark-routing new-routing-mark=vrf2 passthrough=no</code> </pre> <br><p><img src="https://habrastorage.org/webt/i8/dd/kx/i8ddkxzzdogtht7gvzyo-rzcr-g.png"></p><br><p> <strong>   </strong> <br>            VRF  netmap: <br><img src="https://habrastorage.org/webt/yl/vx/kb/ylvxkbg-tyalsczpx9datttwgs0.png"></p><br><p>  : </p><br><pre> <code class="plaintext hljs">/ip route vrf add interfaces=ether1 routing-mark=vrf1 add interfaces=ether2 routing-mark=vrf2 /ip address add address=192.168.100.1/24 interface=ether1 network=192.168.100.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 add address=192.168.0.1/24 interface=ether3 network=192.168.0.0</code> </pre> <br><p>  firewall: </p><br><pre> <code class="plaintext hljs">#        /ip firewall mangle add chain=prerouting dst-address=192.168.101.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf1 passthrough=no add chain=prerouting dst-address=192.168.102.0/24 in-interface=ether3 action=mark-routing new-routing-mark=vrf2 passthrough=no # netmap   ""     /ip firewall nat add chain=dstnat dst-address=192.168.101.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24 add chain=dstnat dst-address=192.168.102.0/24 in-interface=ether3 action=netmap to-addresses=192.168.100.0/24</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">#      route leaking,       connected  /ip route add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf1 add distance=1 dst-address=192.168.0.0/24 gateway=ether3 routing-mark=vrf2</code> </pre> <br><p> <strong>    dhcp    </strong> <br> VRF   ,       (  dhcp client)    . </p><br><p>    vrf: </p><br><pre> <code class="plaintext hljs">/ip route vrf add interface=ether1 routing-mark=over-isp1</code> </pre> <br><p>     (  )   <em>over-isp1</em> : </p><br><pre> <code class="plaintext hljs">/ip firewall mangle add chain=output out-interface=!br-lan action=mark-routing new-routing-mark=over-isp1 passthrough=no add chain=prerouting in-interface=br-lan dst-address-type=!local action=mark-routing new-routing-mark=over-isp1 passthrough=no</code> </pre> <br><p> ,      : </p><br><pre> <code class="plaintext hljs">/interface bridge add name=bare /ip route add dst-address=0.0.0.0/0 gateway=bare</code> </pre> <br><p>            Routing decision (2)  <code>[OUTPUT|Mangle]</code>    ,         0.0.0.0/0   main   . <br><img src="https://habrastorage.org/webt/ff/p-/qh/ffp-qhi41y5wxswp6wzrtp69bjk.png"></p><br><h3 id="cepochki-connected-in-i-dynamic-in-v-routing---filters">  <code>connected-in</code>  <code>dynamic-in</code>  <code>[Routing] -&gt; [Filters]</code> </h3><br><p>   (  ) —           (      <em>routing</em> ),        : </p><br><ul><li> connected-in —  connected  </li><li> dynamic-in —     PPP  DCHP </li></ul><br><p>      ,     : distance, routing-mark, comment, scope, target scope, ... </p><br><p>         -  Routing Filters (  ),    Routing Filters,           .     Routing Filters      . </p><br><p> <strong> Routing Mark   </strong> <br>    .     VPN            .     -      : </p><br><pre> <code class="plaintext hljs">#  vpn    default route    /interface pptp-client add connect-to=XXXX add-default-route=yes default-route-distance=101 ... add connect-to=YYYY add-default-route=yes default-route-distance=100 ... #             /routing filter add chain=dynamic-in distance=100 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn1 add chain=dynamic-in distance=101 prefix=0.0.0.0/0 action=passthrough set-routing-mark=over-vpn2</code> </pre> <br><p> <em>  ,  ,    vrf  ppp ,    0.0.0.0/0     main.      .</em> </p><br><p> <strong> Connected </strong> <br>    : </p><br><pre> <code class="plaintext hljs">/route filter add chain=connected-in prefix=192.168.100.0/24 action=reject</code> </pre> <br><h3 id="instrumenty-otladki">   </h3><br><p> RouterOS      : </p><br><ul><li> <code>[Tool]-&gt;[Torch]</code> —      </li><li> <code>/ip route check</code> —        ,      </li><li> <code>/ping routing-table=&lt;name&gt;</code>  <code>/tool traceroute routing-table=&lt;name&gt;</code> — ping       </li><li> <code>action=log</code>  <code>[IP]-&gt;[Firewall]</code> —  ,       packet flow,         </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id443788/">https://habr.com/ru/post/id443788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id443774/index.html">Bagaimana Neurobiologi Mengganggu Pemilihan Presiden AS</a></li>
<li><a href="../id443776/index.html">Tiongkok memperkenalkan sistem pengenalan wajah eksperimental saat membayar metro</a></li>
<li><a href="../id443780/index.html">Proyek MCDM. Bagian 1. Konsep</a></li>
<li><a href="../id443782/index.html">Pengembang sekarang dapat menggunakan API jaringan Valve untuk game Steam mereka</a></li>
<li><a href="../id443786/index.html">Analisis kontes kuis Android kedua dari stand HeadHunter di Mobius 2018 Moscow</a></li>
<li><a href="../id443790/index.html">Kesalahan Survivor</a></li>
<li><a href="../id443792/index.html">Kesalahan umum ketika bekerja dengan PostgreSQL. Bagian 2</a></li>
<li><a href="../id443794/index.html">Arahan utama untuk startup IT di bidang penjualan real estat</a></li>
<li><a href="../id443798/index.html">Zotero hacks: penyimpanan yang disinkronkan tanpa batas dan penggunaannya yang mulus dengan rmarkdown</a></li>
<li><a href="../id443804/index.html">C # adalah bahasa tingkat rendah?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>