<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎅🏻 🙎🏻 📦 Client HTML + JS pour système de surveillance en ligne 👨🏼‍🎓 🎤 🙆🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chez Geektimes, je rencontre souvent et j'aime lire des articles de la série DIY. Ayant décidé d'apporter une petite contribution au trésor d'expérien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Client HTML + JS pour système de surveillance en ligne</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/devline/blog/409999/"><img src="https://habrastorage.org/webt/ac/om/m5/acomm5x6os3ra7c0uew3upys2tm.jpeg"><br><br>  Chez Geektimes, je rencontre souvent et j'aime lire des articles de la série DIY.  Ayant décidé d'apporter une petite contribution au trésor d'expériences précieuses réunies ici, je vais décrire en détail le processus de création d'un client pour le web basé sur les serveurs Line. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le système de surveillance en ligne</a> fournit une API ouverte, et les développeurs disent qu'il est possible d'écrire votre propre client en fonction pour visualiser les archives vidéo et les caméras en ligne.  De plus, si vous le souhaitez, vous pouvez implémenter des fonctions telles que l'ajout d'événements à l'archive, la superposition de l'OSD sur la vidéo.  Une description de toutes les fonctionnalités est présentée dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">spécifications sur le site officiel</a> . <br><br>  Cet article est un exemple réel de la façon dont moi, un utilisateur ayant une connaissance initiale de JS, HTML, a écrit ma propre application qui met en œuvre les principes de base de l'utilisation des serveurs de ligne via le serveur Web intégré. <br><a name="habracut"></a><br>  Entrer les données <br><br>  <b>L'auteur</b> est un débutant dans le développement d'un client HTML, et est impliqué dans le développement du système de vidéosurveillance Line. <br>  <b>Niveau de connaissance de JS, HTML</b> - initial. <br>  <b>La tâche</b> consiste à écrire un client HTML pour travailler avec des appareils basés sur le logiciel Line en utilisant les spécifications du site. <br><br>  Je vais révéler tout de suite l'intrigue principale - je suis arrivé à deux conclusions: <br><br><ol><li>  La spécification est réelle, elle est décrite assez clairement, vous pouvez écrire un client en C ++, PHP. </li><li>  Vous ne pouvez pas écrire un client HTML à part entière en utilisant uniquement JS - uniquement une surveillance en ligne conformément aux spécifications avant RPC. </li></ol><br>  La première conclusion est assez logique, étant donné le grand nombre d'intégrations avec des programmes tiers.  Tous sont décrits sur le site: il existe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des systèmes de contrôle d'accès</a> , de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">poids</a> , des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">systèmes POS</a> , des programmes pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">déterminer les numéros de voiture</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1C</a> . <br><br>  La deuxième conclusion est plus intéressante, considérez-la ci-dessous. <br><br><h2>  Pourquoi ne pouvez-vous pas créer un client à part entière en HTML + JS? </h2><br>  Réponse: demandes interdomaines. <br><br>  Pour le moment, le serveur Web de la ligne est limité et il est impossible d'obtenir simplement la copie du code dans le dossier www.  Cependant, les développeurs promettent que dans la nouvelle version pour Linux et dans "Line 8.0" le serveur web fonctionnera en standard: en cas de demande, s'il y a un fichier, il le renverra. <br><br>  Créez maintenant un nouveau projet et commencez à coder.  Comme tous les nouveaux venus dans la programmation pour le Web, en spécifiant que le serveur "Lines" répond "*" dans l'en-tête Access-Control-Allow-Origin, j'ai commencé à travailler dur sur le code, en vérifiant le résultat sur Firefox 57.0.4 (64 bits).  Les demandes au serveur ont été envoyées par XMLHttpRequest. <br><br>  Dans un premier temps, il serait utile d'étudier les informations sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette ressource</a> .  Tout y est décrit en détail, mais je voulais vraiment terminer rapidement la tâche.  Et, malheureusement, faute d'information, une demi-journée s'est perdue sur un coup de tête sur le mur de la politique de sécurité des navigateurs modernes. <br><br>  Au moment d'écrire ces lignes, quatre principaux navigateurs modernes n'autorisent pas les en-têtes de lecture reçus du serveur.  Selon la spécification, il est nécessaire d'implémenter l'authentification Digest, ce qui est impossible sans en-têtes. <br><br>  À la fin du premier jour, j'ai réalisé que sans ajouter le traitement OPTIONS au serveur Web de la ligne, rien ne fonctionnerait, car pour les demandes avec une méthode «difficile» ou des en-têtes spéciaux, le navigateur fait une pré-demande OPTIONS, en les indiquant dans la méthode de demande de contrôle d'accès et en-têtes de demande de contrôle d'accès.  J'ai donc commencé à chercher d'autres options d'autorisation, mais le vrai Basic ou Digest n'a pas décollé. <br><br>  Une méthode alternative a déjà été décrite dans le cahier des charges, il restait à passer un peu de temps à correspondre avec le département programme de "Lines".  Comme de telles difficultés ne surviennent pas pour la première fois, il existe déjà une béquille pour l'autorisation, et elle est même mentionnée dans le cahier des charges: <br><blockquote>  Sur les clients où il est impossible d'autoriser la demande à l'aide de moyens standard (HTTP Digest / Basic Authentication), l'en-tête Authorization peut être envoyé à l'aide de l'un des paramètres de la demande, par exemple <br>  /kfd3ado1sdrms/streaming/main.flv?authorization=Basic%20d2ViOg== </blockquote><br>  Après toutes les manipulations, la requête interdomaine standard a commencé à s'exécuter correctement!  Il est également nécessaire d'ajouter l'en-tête Accept avec le type correct à la demande - j'ai décidé d'utiliser JSON. <br><br>  Code de demande: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_request_url</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method,current_server_data, resource, additional</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = current_server_data.server_ip + <span class="hljs-string"><span class="hljs-string">':'</span></span> +current_server_data.port +resource+<span class="hljs-string"><span class="hljs-string">'?authorization=Basic '</span></span>+ utf8_to_b64(current_server_data.user+<span class="hljs-string"><span class="hljs-string">':'</span></span>+current_server_data.password); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (additional != <span class="hljs-string"><span class="hljs-string">''</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> additional != <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>) { request += <span class="hljs-string"><span class="hljs-string">'&amp;'</span></span> + additional; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_request_of_resource</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">server_index , resource, auth_attempt</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = get_request_url(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, servers_array[server_index], resource,<span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req_ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); req_.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://'</span></span>+ request, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//req_.timeout = 9000; //  ,    req_.onreadystatechange = function() { if (this.readyState == 2) { if (this.status == 401) { //console.log('---unauthorized'); hideModal(); update_nessecary_structure(resource, 'unauthorized', server_index); } } else if (this.readyState === 4) { if (this.status === 0) { hideModal(); update_nessecary_structure(resource, 'server_down',server_index) } if (this.status == 200) { if (auth_attempt) hideModal(); else resource =(resource =='/cameras') ? resource+'_update_info': resource; //console.log('200' + this.responseText); update_nessecary_structure(resource, this.responseText, server_index); } else if (this.status == 404) { //console.log('404'); update_nessecary_structure(resource, '404', server_index); } } }; //   req_.setRequestHeader('Content-type', 'text/plain; charset=utf-8'); req_.setRequestHeader('Accept', 'application/json'); req_.send(); }</span></span></code> </pre> <br>  Nous changeons la ressource en celle dont nous avons besoin selon les spécifications et obtenons telle ou telle donnée.  La variable supplémentaire contient des paramètres supplémentaires pour la demande, si nécessaire.  Sur ce point, le développement de la première moitié de la spécification, à savoir la réception / envoi de données texte via des requêtes GET, peut être considéré comme clos. <br><br>  De plus, je suis tombé sur le fait que la balise IMG dans IE ne lit pas le flux MJPEG, et vous devez implémenter indépendamment la mise à jour des images des caméras.  Le code est ouvert, il peut être consulté et modifié si vous le souhaitez.  Dans l'implémentation actuelle, la lecture simultanée d'un maximum de six flux MJPEG est disponible, vous devrez donc faire le travail avec une vue qui affiche plus de caméras.  Tout cela est dans l' <a href="">exemple</a> , si vous le souhaitez, vous pouvez trouver et comprendre, mais si vous avez des questions, assurez-vous de poser dans les commentaires. <br><br><h2>  Spécification RPC </h2><br>  Nous sommes invités à envoyer et recevoir des données soit en JSON (version du serveur "Lines 7.1.1" et plus) ou MessagePack (version "Line 7.0" et plus).  Il est mentionné que MessagePack pèse moins et fonctionne plus rapidement, mais pour être honnête, je choisirais JSON (il est déjà construit en JS), sinon pour une chose mais dans la spécification: la réception de trames de l'archive n'est possible que dans MessagePack.  J'ai dû aller sur leur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">site officiel</a> et télécharger le fichier JS, qui contient les méthodes d'encodage et de décodage. <br><br>  La fonction d'envoi de demande est prête!  Mais il est trop tôt pour célébrer la victoire: lorsque vous essayez de changer l'en-tête de la demande de type de contenu, le navigateur jure et n'envoie pas de données au serveur.  Le fait est que le serveur Lines analyse ce champ et l’analyse en fonction du type.  Je ne pouvais pas le faire moi-même. <br><br>  J'ai envoyé une demande au département du programme, et après discussion, ils m'ont ajouté une béquille, comme dans le cas d'une autorisation, - le type de contenu sera transmis dans la demande d'url: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rpc_request_of_resource</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">current_server_data , rpc_method, rpc_request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = get_request_url(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, current_server_data, <span class="hljs-string"><span class="hljs-string">'/rpc'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">//console.log("i'm here request = " + request + ' '+ current_server_data.user); request += "&amp;content-type='application/x-msgpack'"; var req_ = new XMLHttpRequest(); req_.open('POST', 'http://'+ request, true); //  ,    req_.responseType = 'arraybuffer'; req_.onreadystatechange = function() { if (this.readyState == 2) { if (this.status == 401) { //console.log('401' + this.getAllResponseHeaders()); console.log('unauthorized'); } } else if (this.readyState == 4) { if (this.status == 200) { //if (auth_attempt) hideModal(); //console.log('200' + this.responseText); rpc_update_nessecary_method(rpc_method, this.response); } else if (this.status == 404) { console.log('404'); } else if (this.status == 500) { //console.log('500'); rpc_update_nessecary_method(rpc_method, '500'); } } }; //   //req_.setRequestHeader('Content-type', 'text/plain; charset=utf-8'); //req_.setRequestHeader('Content-type', 'application/x-msgpack'); req_.setRequestHeader('Accept', 'application/x-msgpack'); req_.send(rpc_request); }</span></span></code> </pre> <br>  Cette modification fonctionnera avec la version «Ligne 7.4.1» et supérieure.  Pour tous les serveurs sous cette version, le travail avec la ressource / rpc ne sera pas disponible. <br><br>  Au final, je tiens à remercier tous les clients qui nous ont envoyé des questions / souhaits liés à la mise en œuvre d'applications basées sur notre API.  Grâce à vous, une étude a été menée, dans le cadre de laquelle certaines lacunes ont été identifiées et corrigées. <br><br>  L'exemple décrit dans cet article deviendra progressivement un client HTML à part entière pour Lines.  Tout le code sera lisible, vous pouvez le modifier ou l'utiliser comme base pour construire vos propres solutions.  L'API, au fil du temps, sera remplie de fonctionnalités encore plus, dont nous informerons certainement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr409999/">https://habr.com/ru/post/fr409999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr409989/index.html">La lutte contre le réchauffement climatique nécessite une technologie dont nous ne disposons pas</a></li>
<li><a href="../fr409991/index.html">Nakraudfandili: les meilleurs projets pour janvier 2018</a></li>
<li><a href="../fr409993/index.html">Projet Samsung Academy IoT - Enseignement des technologies de l'Internet des objets</a></li>
<li><a href="../fr409995/index.html">Comment construire le processus d'apprentissage de l'anglais - de zéro à intermédiaire</a></li>
<li><a href="../fr409997/index.html">Trois documentaires d'intérêt pour les ingénieurs</a></li>
<li><a href="../fr410001/index.html">Comment la perception humaine de l'espace s'est-elle développée et pourquoi avons-nous besoin de mesures</a></li>
<li><a href="../fr410003/index.html">Résultats de recherche: le piratage aide à améliorer les ventes de nombreux artistes</a></li>
<li><a href="../fr410005/index.html">Éliminez l'électricité</a></li>
<li><a href="../fr410007/index.html">Distr. Examen des programmes utiles tard depuis 16 ans</a></li>
<li><a href="../fr410009/index.html">La blockchain est-elle une sécurité personnelle ou un danger personnel?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>