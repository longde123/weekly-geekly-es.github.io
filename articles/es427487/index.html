<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë©üèª üòå ‚ù§Ô∏è Pruebas de configuraci√≥n para desarrolladores de Java: experiencia pr√°ctica üïû üñïüèø ‚ú≥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Con las pruebas para el c√≥digo, todo est√° claro (bueno, al menos el hecho de que deben escribirse). Con las pruebas de configuraci√≥n, todo es mucho me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pruebas de configuraci√≥n para desarrolladores de Java: experiencia pr√°ctica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/427487/"><img src="https://habrastorage.org/webt/9o/r3/24/9or324raqccmfaeghrlyaagxmja.jpeg"><br><br>  Con las pruebas para el c√≥digo, todo est√° claro (bueno, al menos el hecho de que deben escribirse).  Con las pruebas de configuraci√≥n, todo es mucho menos obvio, comenzando con su propia existencia.  ¬øAlguien los escribe?  ¬øEs importante?  ¬øEs dificil?  ¬øQu√© tipo de resultados se pueden lograr con su ayuda? <br><br>  Resulta que esto tambi√©n es muy √∫til, comenzar a hacerlo es muy simple, y al mismo tiempo hay muchos matices en la prueba de la configuraci√≥n.  Cu√°les: pintadas debajo del corte seg√∫n la experiencia pr√°ctica. <br><a name="habracut"></a><br>  <i>El material se basa en una transcripci√≥n de un informe de <b>Ruslan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">cheremin</a> Cheremin</b> (desarrollador de Java en Deutsche Bank).</i>  <i>El siguiente es el discurso en primera persona.</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Tk_nmV-mWOA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Mi nombre es Ruslan, trabajo para Deutsche Bank.  Comenzamos con esto: <br><br><img src="https://habrastorage.org/webt/vg/xr/rq/vgxrrqh1taa98cujjske1r5usa4.jpeg"><br><br>  Hay mucho texto, desde lejos puede parecer que es ruso.  Pero esto no es cierto.  Este es un lenguaje muy antiguo y peligroso.  Hice una traducci√≥n al ruso simple: <br><br><ul><li>  Todos los personajes est√°n compuestos </li><li>  Usar con precauci√≥n </li><li>  Funeral a su cargo </li></ul><br><br>  Describir√© brevemente de qu√© voy a hablar hoy.  Supongamos que tenemos un c√≥digo: <br><br><img src="https://habrastorage.org/webt/qv/ip/gd/qvipgdp4a8n1bjo79z29aicqmik.jpeg"><br><br>  Es decir, inicialmente ten√≠amos alg√∫n tipo de tarea, escribimos un c√≥digo para resolverlo y supuestamente nos genera dinero.  Si por alguna raz√≥n este c√≥digo no funciona correctamente, resuelve la tarea incorrecta y nos genera el dinero equivocado.  A las empresas no les gusta ese tipo de dinero: se ven mal en los estados financieros. <br><br>  Por lo tanto, para nuestro c√≥digo importante, tenemos pruebas: <br><br><img src="https://habrastorage.org/webt/0e/9g/-k/0e9g-klbunmtoyvlhf9q0-vl-4o.jpeg"><br><br>  Por lo general all√≠.  Ahora, probablemente, casi todos lo tienen.  Las pruebas verifican que el c√≥digo resuelve el problema correcto y genera el dinero correcto.  Pero el servicio no se limita al c√≥digo, y al lado del c√≥digo tambi√©n hay una configuraci√≥n: <br><br><img src="https://habrastorage.org/webt/z7/75/sq/z775sqxlsy1nha5hrclznn6biq0.jpeg"><br><br>  Al menos en casi todos los proyectos en los que particip√©, esta configuraci√≥n fue, de una forma u otra.  (Solo puedo recordar un par de casos de mis primeros a√±os en la interfaz de usuario, donde no hab√≠a archivos de configuraci√≥n, pero todo estaba configurado a trav√©s de la interfaz de usuario) En esta configuraci√≥n, hay puertos, direcciones y par√°metros de algoritmo. <br><br><h2>  ¬øPor qu√© es importante probar la configuraci√≥n? </h2><br>  Aqu√≠ est√° el truco: los errores en la configuraci√≥n da√±an la ejecuci√≥n del programa no menos que los errores en el c√≥digo.  Ellos tambi√©n pueden hacer que el c√≥digo realice la tarea incorrecta, y vea m√°s arriba. <br><br>  Y encontrar errores en la configuraci√≥n es a√∫n m√°s dif√≠cil que en el c√≥digo, ya que la configuraci√≥n generalmente no se compila.  Cit√© los archivos de propiedades como ejemplo, en general hay diferentes opciones (JSON, XML, alguien almacena en YAML), pero es importante que nada de esto se compile y, en consecuencia, no est√© marcado.  Si se sella accidentalmente en un archivo Java, lo m√°s probable es que simplemente no pase la compilaci√≥n.  Un error tipogr√°fico aleatorio en la propiedad no entusiasmar√° a nadie, ir√° a trabajar. <br><br>  Y el IDE tampoco resalta el error en la configuraci√≥n, porque solo conoce lo m√°s primitivo sobre el formato (por ejemplo) de los archivos de propiedades: que debe haber una clave y un valor, y "igual", dos puntos o un espacio entre ellos.  Pero el hecho de que el valor debe ser un n√∫mero, un puerto de red o una direcci√≥n, el IDE no sabe nada. <br><br>  E incluso si prueba la aplicaci√≥n en un UAT o en un entorno de ensayo, esto tampoco garantiza nada.  Debido a que la configuraci√≥n, como regla, en cada entorno es diferente, y en la UAT solo prob√≥ la configuraci√≥n de UAT. <br><br>  Otra sutileza es que incluso en la producci√≥n, los errores de configuraci√≥n a veces no aparecen de inmediato.  Es posible que un servicio no se inicie en absoluto, y este es un buen escenario.  Pero puede comenzar y funcionar durante mucho tiempo, hasta el momento X, cuando ser√° necesario exactamente el par√°metro en el que se produjo el error.  Y aqu√≠ encontrar√° que un servicio que ni siquiera ha cambiado mucho recientemente ha dejado de funcionar repentinamente. <br><br>  Despu√©s de todo lo que dije, parece que probar las configuraciones deber√≠a ser un tema candente.  Pero en la pr√°ctica se parece a esto: <br><br><img src="https://habrastorage.org/webt/9o/r3/24/9or324raqccmfaeghrlyaagxmja.jpeg"><br><br>  Al menos ese fue el caso con nosotros, hasta cierto punto.  Y una de las tareas de mi informe es dejar de verte as√≠ tambi√©n.  Espero poder empujarte a esto. <br><br>  Hace tres a√±os en nuestro Deutsche Bank, en mi equipo, Andrei Satarin trabaj√≥ como l√≠der de control de calidad.  Fue √©l quien trajo la idea de probar configuraciones, es decir, simplemente tom√≥ y cometi√≥ la primera prueba de este tipo.  Hace seis meses, en el Heisenbug anterior, dio una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">charla</a> sobre probar la configuraci√≥n tal como la ve.  Le recomiendo que mire, porque all√≠ dio una mirada amplia al problema: tanto desde el lado de los art√≠culos cient√≠ficos como desde la experiencia de las grandes empresas que han encontrado errores de configuraci√≥n y sus consecuencias. <br><br>  Mi informe ser√° m√°s limitado: sobre la experiencia pr√°ctica.  Hablar√© sobre qu√© problemas, como desarrollador, encontr√© cuando escrib√≠ las pruebas de configuraci√≥n, y c√≥mo resolv√≠ estos problemas.  Mis decisiones pueden no ser las mejores decisiones, estas no son las mejores pr√°cticas: esta es mi experiencia personal, intent√© no hacer generalizaciones amplias. <br><br>  Esquema general del informe: <br><br><ul><li>  "Lo que puede hacer antes del lunes por la tarde": ejemplos simples y √∫tiles. </li><li>  "Lunes, dos a√±os despu√©s": d√≥nde y c√≥mo hacerlo mejor. </li><li>  Soporte para refactorizar la configuraci√≥n: c√≥mo lograr una cobertura densa;  modelo de configuraci√≥n de software. </li></ul><br><br>  La primera parte es motivadora: describir√© las pruebas m√°s simples con las que todo comenz√≥ con nosotros.  Habr√° una gran variedad de ejemplos.  Espero que al menos uno de ellos resuene contigo, es decir, ver√°s alg√∫n tipo de problema similar y su soluci√≥n. <br><br>  Las pruebas en s√≠ mismas en la primera parte son simples, incluso primitivas: desde el punto de vista de la ingenier√≠a no hay ciencia espacial.  Pero solo que se puedan hacer r√°pidamente es especialmente valioso.  Esta es una "entrada f√°cil" en las pruebas de configuraci√≥n, y es importante porque existe una barrera psicol√≥gica para escribir estas pruebas.  Y quiero mostrar que "usted puede hacer esto": ahora lo hicimos, funcion√≥ bien para nosotros, y aunque nadie ha muerto, hemos estado viviendo durante tres a√±os. <br><br>  La segunda parte es sobre qu√© hacer despu√©s.  Cuando escribiste muchas pruebas simples, surge la cuesti√≥n del soporte.  Algunos de ellos comienzan a caer, entiendes los errores que supuestamente resaltaron.  Resulta que esto no siempre es conveniente.  Y surge la pregunta de escribir pruebas m√°s complejas: despu√©s de todo, ya ha cubierto casos simples, quiero algo m√°s interesante.  Y aqu√≠ nuevamente no hay mejores pr√°cticas, solo describir√© algunas de las soluciones que funcionaron para nosotros. <br><br>  La tercera parte trata sobre c√≥mo las pruebas pueden soportar la refactorizaci√≥n de una configuraci√≥n bastante compleja y confusa.  De nuevo estudio de caso: c√≥mo lo hicimos.  Desde mi punto de vista, este es un ejemplo de c√≥mo las pruebas de configuraci√≥n se pueden escalar para resolver tareas m√°s grandes, y no solo para tapar peque√±os agujeros. <br><br><h2>  Parte 1. "Puedes hacerlo as√≠" </h2><br>  Ahora es dif√≠cil entender cu√°l fue la primera prueba de configuraci√≥n con nosotros.  Andrei est√° sentado en el pasillo, puede decir que ment√≠.  Pero me parece que todo comenz√≥ con esto: <br><br><img src="https://habrastorage.org/webt/6t/dr/d8/6tdrd8-mwyj8otcngbcjsjqi3ge.jpeg"><br><br>  La situaci√≥n es esta: tenemos n servicios en el mismo host, cada uno de ellos levanta su propio servidor JMX en su puerto, exporta algunos JMX de monitoreo.  Los puertos para todos los servicios se configuran en el archivo.  Pero el archivo ocupa varias p√°ginas y hay muchas otras propiedades: a menudo resulta que los puertos de diferentes servicios entran en conflicto.  Es f√°cil cometer un error.  Entonces, todo es trivial: algunos servicios no aumentan, despu√©s de eso no aumentan para quienes dependen de ellos; los evaluadores est√°n furiosos. <br><br>  Este problema se resuelve en varias l√≠neas.  Esta prueba, que (me parece) fue la primera, se ve√≠a as√≠: <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  No es nada complicado: vamos a trav√©s de la carpeta donde se encuentran los archivos de configuraci√≥n, los cargamos, los analizamos como propiedades, filtramos los valores cuyo nombre contiene "jmx.port" y verificamos que todos los valores sean √∫nicos.  No hay necesidad de convertir valores a enteros.  Presumiblemente, solo hay puertos. <br><br>  Mi primera reacci√≥n cuando vi esto fue mixta: <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  Primera impresi√≥n: ¬øqu√© hay en mis hermosas pruebas unitarias?  ¬øPor qu√© subimos al sistema de archivos? <br><br>  Y entonces lleg√≥ la sorpresa: "¬øQu√©, podr√≠a ser eso?" <br><br>  Estoy hablando de esto porque parece haber alg√∫n tipo de barrera psicol√≥gica que hace que sea dif√≠cil escribir tales pruebas.  Han pasado tres a√±os desde entonces, el proyecto est√° lleno de tales pruebas, pero a menudo veo que mis colegas, que se topan con un error cometido en la configuraci√≥n, no escriben pruebas en √©l.  Para el c√≥digo, todos ya est√°n acostumbrados a escribir pruebas de regresi√≥n, por lo que el error encontrado ya no se reproduce.  Pero no lo hacen por configuraci√≥n, algo est√° interfiriendo.  Hay alg√∫n tipo de barrera psicol√≥gica que debe abordarse; es por eso que menciono tal reacci√≥n para que la reconozca usted mismo si aparece. <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  El siguiente ejemplo es casi el mismo, pero ligeramente modificado: elimin√© todos los "jmx".  Esta vez verificamos todas las propiedades llamadas algo all√≠ puerto.  Deben ser valores enteros y ser un puerto de red v√°lido.  Matcher validNetworkPort () oculta nuestro Hamcrest personalizado Matcher, que verifica que el valor est√© por encima del rango de puertos del sistema, por debajo del rango de puertos ef√≠meros, bueno, sabemos que algunos puertos en nuestros servidores est√°n ocupados previamente; aqu√≠ est√° la lista completa de ellos oculta en este es matcher <br><br>  Esta prueba sigue siendo muy primitiva.  Tenga en cuenta que no hay ninguna indicaci√≥n en √©l de qu√© propiedad espec√≠fica estamos verificando: es masiva.  Una sola de estas pruebas puede verificar 500 propiedades con el nombre "... puerto", y verificar que todos ellos sean enteros en el rango deseado, con todas las condiciones necesarias.  Una vez que escribieron, una docena de l√≠neas, y eso es todo.  Esta es una caracter√≠stica muy conveniente, parece porque la configuraci√≥n tiene un formato simple: dos columnas, una clave y un valor.  Por lo tanto, puede ser tan procesado en masa. <br><br>  Otro ejemplo de prueba.  ¬øQu√© estamos comprobando aqu√≠? <br><br><img src="https://habrastorage.org/webt/7j/wt/wr/7jwtwr0zn93gy0fhfaqykbeyeyy.jpeg"><br><br>  Comprueba que las contrase√±as reales no se filtren en la producci√≥n.  Todas las contrase√±as deber√≠an verse as√≠: <br><br><img src="https://habrastorage.org/webt/yg/4_/ft/yg4_ftjvkm_bhqqzmdxppafoaii.jpeg"><br><br>  Puede escribir muchas pruebas para archivos de propiedades.  No dar√© m√°s ejemplos: no quiero repetirme, la idea es muy simple, entonces todo deber√≠a estar claro. <br><br>  ... y despu√©s de escribir suficientes de estas pruebas, surge una pregunta interesante: ¬øqu√© queremos decir con configuraci√≥n, d√≥nde est√° su borde?  Consideramos el archivo de propiedades como una configuraci√≥n, lo cubrimos, ¬øy qu√© m√°s se puede cubrir con el mismo estilo? <br><br><h2>  Qu√© considerar una configuraci√≥n </h2><br>  Resulta que hay muchos archivos de texto en el proyecto que no se compilan, al menos en el proceso de compilaci√≥n normal.  No se verifican de ninguna manera hasta que se ejecutan en el servidor, es decir, los errores en ellos aparecen tarde.  Todos estos archivos, con cierta extensi√≥n, se pueden llamar configuraci√≥n.  Al menos, se probar√°n aproximadamente lo mismo. <br><br>  Por ejemplo, tenemos un sistema de parches SQL que se incluyen en la base de datos durante el proceso de implementaci√≥n. <br><br><img src="https://habrastorage.org/webt/jz/bk/c7/jzbkc7m5zo0k6phy-9kuzvkqkam.jpeg"><br><br>  Est√°n escritos para SQL * Plus.  SQL * Plus es una herramienta de los a√±os 60 y requiere todo tipo de cosas extra√±as: por ejemplo, para asegurarse de que el final del archivo est√© en una nueva l√≠nea.  Por supuesto, las personas regularmente olvidan poner el final de la l√≠nea all√≠, porque no nacieron en los a√±os 60. <br><br><img src="https://habrastorage.org/webt/nr/oj/3w/nroj3wxkhriqqeqa-iwxwus0a0a.jpeg"><br><br>  Y nuevamente se resuelve con la misma docena de l√≠neas: seleccionamos todos los archivos SQL, verificamos que haya una barra diagonal al final.  Simple, conveniente, r√°pido. <br><br>  Otro ejemplo de "como un archivo de texto" es crontabs.  Nuestros servicios crontab comienzan y se detienen.  Con mayor frecuencia causan dos errores: <br><br><img src="https://habrastorage.org/webt/02/i0/ch/02i0chpobgao-lexobckwr5ffd4.jpeg"><br><br>  En primer lugar, el formato de expresi√≥n de programaci√≥n.  No es tan complicado, pero nadie lo revisa antes del lanzamiento, por lo que es f√°cil poner un espacio extra, una coma y cosas similares. <br><br>  En segundo lugar, como en el ejemplo anterior, el final del archivo tambi√©n debe estar en una nueva l√≠nea. <br><br>  Y todo esto es bastante f√°cil de verificar.  El final del archivo es comprensible, pero para verificar la programaci√≥n, puede encontrar bibliotecas listas para usar que analizan la expresi√≥n cron.  Antes del informe, busqu√© en Google: hab√≠a al menos seis de ellos.  Encontr√© seis, pero en general puede haber m√°s.  Cuando escribimos, tomamos el m√°s simple de los encontrados, porque no necesit√°bamos verificar el contenido de la expresi√≥n, sino solo su correcci√≥n sint√°ctica, de modo que cron la carg√≥ con √©xito. <br><br>  En principio, puede liquidar m√°s cheques: verifique que comience el d√≠a correcto de la semana, que no interrumpa los servicios en la mitad del d√≠a laboral.  Pero esto result√≥ no ser tan √∫til para nosotros, y no nos molestamos. <br><br>  Otra idea que funciona muy bien son los scripts de shell.  Por supuesto, escribir en Java un analizador completo de secuencias de comandos bash es un placer para los valientes.  Pero la conclusi√≥n es que una gran cantidad de estos scripts no son una fiesta completa.  S√≠, hay scripts de bash donde el c√≥digo es directo, el infierno y el infierno, donde entran una vez al a√±o y, jurando, huyen.  Pero muchos scripts de bash tienen las mismas configuraciones.  Hay una serie de variables del sistema y variables de entorno que se establecen en el valor deseado, configurando as√≠ otros scripts que usan estas variables.  Y tales variables son f√°ciles de extraer de este archivo bash y verificar algo sobre ellas. <br><br><img src="https://habrastorage.org/webt/5s/4d/z_/5s4dz_wtejguewyqrat5ipxa7by.jpeg"><br><br>  Por ejemplo, verifique que JAVA_HOME est√© instalado en cada entorno, o que alguna biblioteca jni que usemos est√© ubicada en LD_LIBRARY_PATH.  De alguna manera, pasamos de una versi√≥n de Java a otra y ampliamos la prueba: verificamos que JAVA_HOME contiene "1.8" en ese mismo subconjunto de entorno, que gradualmente transferimos a la nueva versi√≥n. <br><br>  Aqu√≠ hay algunos ejemplos.  Perm√≠tanme resumir la primera parte de las conclusiones: <br><br><ul><li>  Las pruebas de configuraci√≥n son confusas al principio, hay una barrera psicol√≥gica.  Pero despu√©s de superarlo, hay muchos lugares en la aplicaci√≥n que no est√°n cubiertos por cheques y pueden estar cubiertos. </li><li>  Luego se escriben <b>f√°cil y alegremente</b> : hay muchas "frutas bajas" que r√°pidamente brindan grandes beneficios). </li><li>  Reduzca el <b>costo de</b> detectar y corregir errores de configuraci√≥n.  Dado que estas son, de hecho, pruebas unitarias, puede ejecutarlas en su computadora, incluso antes de comprometerse, esto reduce en gran medida la retroalimentaci√≥n.  Muchos de ellos, por supuesto, habr√≠an sido probados en la etapa de implementaci√≥n de prueba, por ejemplo.  Y muchos no ser√≠an probados, si esta es una configuraci√≥n de producci√≥n.  Y as√≠ se verifican directamente en la computadora local. </li><li>  Dan una segunda juventud.  En el sentido de que existe la sensaci√≥n de que todav√≠a puedes probar muchas cosas interesantes.  De hecho, en el c√≥digo ya no es tan f√°cil encontrar lo que puede probar. </li></ul><br><br><h2>  Parte 2. Casos m√°s complejos </h2><br>  Pasemos a pruebas m√°s complejas.  Despu√©s de cubrir la mayor√≠a de los controles triviales, como los que se muestran aqu√≠, surge la pregunta: ¬øes posible verificar algo m√°s complicado? <br><br>  ¬øQu√© significa "m√°s dif√≠cil"?  Las pruebas que acabo de describir tienen aproximadamente la siguiente estructura: <br><br><img src="https://habrastorage.org/webt/er/an/sx/eransxujnuprewkr1lcrk1nweui.jpeg"><br><br>  Comprueban algo contra un archivo espec√≠fico.  Es decir, revisamos los archivos, aplicamos una cierta verificaci√≥n de condici√≥n a cada uno.  Por lo tanto, se puede verificar mucho, pero hay escenarios m√°s √∫tiles: <br><br><ul><li>  La aplicaci√≥n UI se conecta al servidor de <b>su</b> entorno. </li><li>  Todos los servicios del mismo entorno se conectan al <b>mismo</b> servidor de administraci√≥n. </li><li>  Todos los servicios en el mismo entorno usan <b>la misma</b> base de datos. </li></ul><br><br>  Por ejemplo, una aplicaci√≥n de IU se conecta a su servidor de entorno.  Lo m√°s probable es que la interfaz de usuario y el servidor sean m√≥dulos diferentes, si no proyectos, y tienen configuraciones diferentes, es poco probable que usen los mismos archivos de configuraci√≥n.  Por lo tanto, tendr√° que vincularlos para que todos los servicios de un entorno est√©n conectados a un servidor de administraci√≥n de claves a trav√©s del cual se distribuyen los comandos.  Una vez m√°s, lo m√°s probable es que estos sean m√≥dulos diferentes, servicios diferentes y, en general, equipos diferentes los desarrollen. <br><br>  O todos los servicios usan la misma base de datos, lo mismo: servicios en diferentes m√≥dulos. <br><br>  De hecho, existe una imagen de este tipo: muchos servicios, cada uno de ellos tiene su propia estructura de configuraciones, debe reducir algunos de ellos y verificar algo en la intersecci√≥n: <br><br><img src="https://habrastorage.org/webt/tw/et/op/twetop-jheecrf02felhlhchnvi.jpeg"><br><br>  Por supuesto, puede hacer exactamente eso: cargar uno, el segundo, sacar algo en alguna parte, pegarlo en el c√≥digo de prueba.  Pero puedes imaginar qu√© tan grande ser√° el c√≥digo y qu√© tan legible ser√°.  Partimos de esto, pero luego nos dimos cuenta de lo dif√≠cil que es.  ¬øC√≥mo hacerlo mejor? <br><br>  Si sue√±as, ser√≠a m√°s conveniente, entonces so√±√© que la prueba parecer√≠a que la explico en lenguaje humano: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eachEnvironmentIsXXX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Environment environment )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( Server server : environment.servers() ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( Service service : server.services() ) { Properties config = buildConfigFor( environment, server, service ); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ check {something} about config } } }</span></span></code> </pre> <br>  Para cada entorno, se cumple una condici√≥n.  Para verificar esto, necesita del entorno encontrar una lista de servidores, una lista de servicios.  Luego cargue las configuraciones y verifique algo en la intersecci√≥n.  En consecuencia, necesito tal cosa, lo llam√© Dise√±o de implementaci√≥n. <br><br><img src="https://habrastorage.org/webt/cs/um/3u/csum3u7sucokbnlydgulc18cdhs.jpeg"><br><br>  Necesitamos una oportunidad del c√≥digo para obtener acceso a c√≥mo se implementa la aplicaci√≥n: en qu√© servidores se colocan los servicios, dentro de qu√© entorno, para obtener esta estructura de datos.  Y a partir de ello, comienzo a cargar la configuraci√≥n y procesarla. <br><br>  El dise√±o de implementaci√≥n es espec√≠fico para cada equipo y cada proyecto.  He dibujado: este es un caso general: generalmente hay un conjunto de servidores, servicios, un servicio a veces tiene un conjunto de archivos de configuraci√≥n, y no solo uno.  A veces se requieren par√°metros adicionales que son √∫tiles para las pruebas, deben agregarse.  Por ejemplo, el bastidor en el que se encuentra el servidor puede ser importante.  Andrey en su informe dio un ejemplo cuando era importante para sus servicios que los servicios de respaldo / primario deben estar en diferentes bastidores; para su caso, necesitar√≠a mantener una referencia al bastidor en el dise√±o de implementaci√≥n: <br><br><img src="https://habrastorage.org/webt/gj/oh/ip/gjohipszob-edpgkekfr1zvdfp0.jpeg"><br><br>  Para nuestros prop√≥sitos, la regi√≥n del servidor es importante, el centro de datos espec√≠fico, en principio, tambi√©n, por lo que Backup / Primary est√° en diferentes centros de datos.  Estas son todas las propiedades adicionales del servidor, son espec√≠ficas del proyecto, pero en la diapositiva es un denominador tan com√∫n. <br><br>  ¬øD√≥nde obtener el dise√±o de implementaci√≥n?  Parece que en cualquier gran empresa hay un sistema de Gesti√≥n de Infraestructura, todo se describe all√≠, es confiable, confiable y todo eso ... en realidad no. <br><br>  Al menos, mi pr√°ctica en dos proyectos ha demostrado que es m√°s f√°cil codificar primero y luego, despu√©s de tres a√±os ... dejar la piel dura. <br><br>  Llevamos tres a√±os viviendo con este proyecto.  Parece que en el segundo todav√≠a nos integramos con la Gesti√≥n de Infraestructura en un a√±o, pero todos estos a√±os hemos vivido as√≠.  Seg√∫n la experiencia, tiene sentido posponer la tarea de integraci√≥n con IM para obtener pruebas listas lo antes posible, lo que demostrar√° que funcionan y son √∫tiles.  Y luego puede resultar que esta integraci√≥n puede no ser tan necesaria, porque la distribuci√≥n de servicios entre servidores no se cambia con tanta frecuencia. <br><br>  El c√≥digo duro puede ser literalmente as√≠: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Environment { PROD( PROD_UK_PRIMARY, PROD_UK_BACKUP, PROD_US_PRIMARY, PROD_US_BACKUP, PROD_SG_PRIMARY, PROD_SG_BACKUP ) ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Server[] servers() {‚Ä¶} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Server { PROD_UK_PRIMARY(‚Äúrflx-ldn-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_UK_BACKUP("</span></span>rflx-ldn-<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_US_PRIMARY(‚Äúrflx-nyc-1"</span></span>), PROD_US_BACKUP(<span class="hljs-string"><span class="hljs-string">"rflx-nyc-2"</span></span>), PROD_SG_PRIMARY(‚Äúrflx-sng-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_SG_BACKUP("</span></span>rflx-sng-<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-string"><span class="hljs-string">"), public Service[] services() {‚Ä¶} }</span></span></code> </pre><br>  La forma m√°s f√°cil que utilizamos en nuestro primer proyecto es enumerar Environment con una lista de servidores en cada uno de ellos.  Hay una lista de servidores y, al parecer, deber√≠a haber una lista de servicios, pero enga√±amos: tenemos scripts de inicio (que tambi√©n son parte de la configuraci√≥n). <br><br><img src="https://habrastorage.org/webt/m0/ww/jw/m0wwjwoo1xhqahbdppfbf8q5rno.jpeg"><br><br>  Ejecutan servicios para cada entorno.  Y el m√©todo services () simplemente grep'a todos los servicios del archivo de su servidor.  Esto se hace porque no hay tantos entornos, y los servidores tambi√©n rara vez se agregan o eliminan, pero hay muchos servicios y se barajan con bastante frecuencia.  Ten√≠a sentido cargar el dise√±o real de los servicios desde los scripts para no cambiar el dise√±o codificado con demasiada frecuencia. <br><br>  Despu√©s de crear dicho modelo de configuraci√≥n de software, aparecen bonificaciones agradables.  Por ejemplo, puede escribir una prueba como esta: <br><br><img src="https://habrastorage.org/webt/ht/-o/lk/ht-olkpuql9rl2jhdkpm23yfnlm.jpeg"><br><br>  La prueba es que en cada entorno todos los servicios clave est√°n presentes.  Supongamos que hay cuatro servicios clave, y el resto puede o no existir, pero sin estos cuatro no tiene sentido.  Puede verificar que no los haya olvidado en ninguna parte, que todos tengan copias de seguridad dentro del mismo entorno.  En la mayor√≠a de los casos, estos errores se producen al configurar la UAT de estas instancias, pero tambi√©n puede filtrarse en PROD.  Al final, los errores en la UAT tambi√©n pierden tiempo y nervios de los evaluadores. <br><br>  Se plantea la cuesti√≥n de mantener la relevancia del modelo de configuraci√≥n.  Tambi√©n puedes escribir una prueba para esto. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HardCodedLayoutConsistencyTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> eachHardCodedEnvironmentHasConfigFiles(Environment env){ ‚Ä¶ } <span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> eachConfigFileHasHardCodedEnvironment(File configFile){ ‚Ä¶ } }</code> </pre><br>  Hay archivos de configuraci√≥n y hay un dise√±o de implementaci√≥n en el c√≥digo.  Y puede verificar eso para cada entorno / servidor / etc.  hay un archivo de configuraci√≥n correspondiente y, para cada archivo del formato requerido, el entorno correspondiente.  Tan pronto como se olvide de agregar algo a un lugar, la prueba caer√°. <br><br>  La conclusi√≥n es el dise√±o de implementaci√≥n: <br><br><ul><li>  Simplifica la escritura de pruebas complejas que re√∫nen configuraciones de diferentes partes de la aplicaci√≥n. </li><li>  Los hace m√°s claros y m√°s legibles.  Se ven de la manera que piensas sobre ellos a un alto nivel, y no de la forma en que pasan por las configuraciones. </li><li>  Durante su creaci√≥n, cuando las personas hacen preguntas, resultan muchas cosas interesantes sobre la implementaci√≥n.  Las limitaciones, el conocimiento sagrado impl√≠cito, surgen, por ejemplo, con respecto a la posibilidad de alojar dos entornos en un servidor.  Resulta que los desarrolladores piensan de manera diferente y escriben sus servicios en consecuencia.  Y esos momentos son √∫tiles para establecerse entre los desarrolladores. </li><li>  Bien complementa la documentaci√≥n (especialmente si no lo es).  Incluso si lo hay, es m√°s agradable para m√≠, como desarrollador, ver esto en el c√≥digo.  Adem√°s, all√≠ puedes escribir comentarios importantes para m√≠ y no para otra persona.  Y tambi√©n puedes codificar.  Es decir, si decide que no puede haber dos entornos en el mismo servidor, puede insertar un cheque, y ahora no lo har√°.  Al menos sabr√°s si alguien lo intenta.  Es decir, esta es documentaci√≥n con la capacidad de hacerla cumplir.  Esto es muy √∫til </li></ul><br>  Sigamos adelante.  Despu√©s de que se escribieron las pruebas, se "asentaron" durante un a√±o, algunas comienzan a caer.  Algunos comienzan a caer antes, pero no da tanto miedo.  Da miedo cuando cae una prueba escrita hace un a√±o, miras su mensaje de error y no lo entiendes. <br><img src="https://habrastorage.org/webt/gm/e1/kb/gme1kb6jzdvbvfpfxlxydbxbktw.jpeg"><br><br>  Supongamos que entiendo y acepto que este es un puerto de red no v√°lido, pero ¬ød√≥nde est√°?  Antes de la charla, analic√© el hecho de que tenemos 1,200 archivos de propiedades en el proyecto, dispersos en m√°s de 90 m√≥dulos, con un total de 24,000 l√≠neas en ellos.  (Aunque me sorprendi√≥, pero si cuenta, entonces este no es un n√∫mero tan grande, para un servicio para 4 archivos). ¬øD√≥nde est√° este puerto? <br><br>  Est√° claro que afirmar que () tiene un argumento de mensaje, puede ingresar algo que lo ayudar√° a identificar el lugar.  Pero cuando escribes una prueba, no piensas en ello.  E incluso si piensas, todav√≠a tienes que adivinar qu√© descripci√≥n ser√° lo suficientemente detallada como para ser entendida en un a√±o.  Me gustar√≠a automatizar este momento, para que haya una forma de escribir pruebas con la generaci√≥n autom√°tica de una descripci√≥n m√°s o menos clara, mediante la cual pueda encontrar un error. <br><br>  Nuevamente, so√±√© y so√±√© con algo como esto: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> environment, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>, component, configLocation, propertyName, propertyValue <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> configuration(environment, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>, component) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> propertyName <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> ‚Äú%.port%‚Äù <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> propertyValue <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> validNetworkPort()</code> </pre><br>  Este es un pseudo-SQL, bueno, solo conozco SQL, y el cerebro arroj√≥ la soluci√≥n de lo que es familiar.  La idea es que la mayor√≠a de las pruebas de configuraci√≥n consisten en varias piezas del mismo tipo.  Primero, la condici√≥n selecciona un subconjunto de par√°metros: <br><br><img src="https://habrastorage.org/webt/ig/om/g_/igomg_lacmbr2w7xdnuqtxgrnoc.jpeg"><br><br>  Luego, con respecto a este subconjunto, verificamos algo con respecto al valor: <br><br><img src="https://habrastorage.org/webt/xm/zr/1p/xmzr1p3brb_ixbgiafqteeiltgg.jpeg"><br><br>  Y luego, si hubo propiedades cuyos valores no satisfacen el deseo, esta es la "hoja" que queremos recibir en el mensaje de error: <br><br><img src="https://habrastorage.org/webt/6d/ci/jr/6dcijrp9yesvndnn6hq2udo5fw8.jpeg"><br><br>  En un momento incluso pens√© si podr√≠a escribir un analizador sint√°ctico como SQL, ya que ahora no es dif√≠cil.  Pero luego me di cuenta de que el IDE no lo admitir√≠a y lo sugerir√≠a, por lo que las personas tendr√≠an que escribir a ciegas en este "SQL" hecho a s√≠ mismo, sin indicaciones del IDE, sin compilaci√≥n, sin verificar, esto no es muy conveniente.  Por lo tanto, tuve que buscar soluciones compatibles con nuestro lenguaje de programaci√≥n.  Si tuvi√©ramos .NET, LINQ ayudar√≠a, es casi como SQL. <br><br>  No hay LINQ en Java, lo m√°s cerca posible de las transmisiones.  As√≠ es como deber√≠a verse esta prueba en las transmisiones: <br><br><pre> <code class="java hljs">ValueWithContext[] incorrectPorts = flattenedProperties( environment ) .filter( propertyNameContains( <span class="hljs-string"><span class="hljs-string">".port"</span></span> ) ) .filter( !isInteger( propertyValue ) || !isValidNetworkPort( propertyValue ) ) .toArray(); assertThat( incorrectPorts, emptyArray() );</code> </pre><br>  flattenedProperties () toma todas las configuraciones de este entorno, todos los archivos para todos los servidores, servicios y los expande a una tabla grande.  Esta es esencialmente una tabla similar a SQL, pero en forma de un conjunto de objetos Java.  Y flattenedProperties () devuelve este conjunto de cadenas como una secuencia. <br><br><img src="https://habrastorage.org/webt/8b/ep/jb/8bepjbpkln50gcn1hlgdizwxkxe.jpeg"><br><br>  Luego agrega algunas condiciones en este conjunto de objetos Java.  En este ejemplo: seleccionamos aquellos que contienen "puerto" en el propertyName y filtramos aquellos donde los valores no se convierten a Integer, o no desde el rango v√°lido.  Estos son valores err√≥neos y, en teor√≠a, deber√≠an ser un conjunto vac√≠o. <br><br><img src="https://habrastorage.org/webt/4z/8i/db/4z8idb1t_vtoprcjg3f23ct0aeq.jpeg"><br><br>  Si no son un conjunto vac√≠o, arrojamos un error que se ver√° as√≠: <br><br><img src="https://habrastorage.org/webt/ia/wq/wy/iawqwytklkjtldsc-afzmw7-cui.jpeg"><br><br><h2>  Parte 3. Pruebas como soporte para refactorizaci√≥n </h2><br>  Por lo general, la prueba de c√≥digo es uno de los soportes de refactorizaci√≥n m√°s potentes.  La refactorizaci√≥n es un proceso peligroso, hay que rehacer mucho y quiero asegurarme de que despu√©s de eso la aplicaci√≥n siga siendo viable.  Una forma de asegurarse de esto es superponer primero todo con pruebas en todos los lados y luego refactorizarlo. <br><br>  Y ahora, ante m√≠ estaba la tarea de refactorizar la configuraci√≥n.  Hay una aplicaci√≥n que fue escrita hace siete a√±os por una persona inteligente.  La configuraci√≥n de esta aplicaci√≥n se ve as√≠: <br><br><img src="https://habrastorage.org/webt/d4/vc/wz/d4vcwzxtgvecd-be0n51ysi9mho.jpeg"><br><br>  Este es un ejemplo, hay muchos m√°s.  Permutaciones de anidamiento triples, y esto se usa en toda la configuraci√≥n: <br><br><img src="https://habrastorage.org/webt/ua/gt/t7/uagtt7xt289h6xfpc0swrmfztca.jpeg"><br><br>  Hay pocos archivos en la configuraci√≥n en s√≠, pero est√°n incluidos entre s√≠.  Utiliza una peque√±a extensi√≥n de Propiedades de iu - Configuraci√≥n de Apache Commons, que solo admite inclusiones y permisos entre llaves. <br><br>  Y el autor hizo un trabajo fant√°stico usando solo estas dos cosas.  Creo que construy√≥ una m√°quina de Turing all√≠ sobre ellos.  En algunos lugares, realmente parece que est√° tratando de hacer c√°lculos utilizando inclusiones y sustituciones.  No s√© si este sistema de Turing est√° completo, pero √©l, en mi opini√≥n, trat√≥ de demostrar que es as√≠. <br><br>  Y el hombre se fue.  Escribi√≥, la aplicaci√≥n funciona, y dej√≥ el banco.  Todo funciona, solo que nadie entiende completamente la configuraci√≥n. <br><br>  Si tomamos un servicio por separado, entonces resulta 10 inclusiones, a triple profundidad, y en total, si todo se expande, 450 par√°metros.  De hecho, este servicio en particular utiliza el 10-15% de ellos, el resto de los par√°metros son para otros servicios, porque los archivos son compartidos, son utilizados por varios servicios.  Pero lo que exactamente el 10-15% usa este servicio en particular no es tan f√°cil de entender.  El autor aparentemente entendi√≥.  Persona muy inteligente, muy. <br><br>  La tarea, respectivamente, era simplificar la configuraci√≥n, su refactorizaci√≥n.  Al mismo tiempo, quer√≠a mantener la aplicaci√≥n funcionando, porque en esta situaci√≥n, las posibilidades de que esto sea bajo.  Quiero: <br><br><ul><li>  Simplifica la configuraci√≥n. </li><li>  De modo que despu√©s de refactorizar, cada servicio todav√≠a tiene todos sus par√°metros necesarios. </li><li>  Para que no tenga par√°metros adicionales.  El 85% de los que no est√°n relacionados con √©l no deben abarrotar la p√°gina. </li><li>  Que los servicios todav√≠a se conectan con √©xito en grupos y realizan la colaboraci√≥n. </li></ul><br>  El problema es que no se sabe qu√© tan bien se conectan ahora, porque el sistema es altamente redundante.  Por ejemplo, mirando hacia el futuro: durante la refactorizaci√≥n, result√≥ que en una de las configuraciones de producci√≥n deber√≠a haber cuatro servidores en el clip de respaldo, pero en realidad hab√≠a dos.  Debido al alto nivel de redundancia, nadie se dio cuenta de esto: el error surgi√≥ accidentalmente, pero de hecho el nivel de redundancia fue durante mucho tiempo m√°s bajo de lo que esper√°bamos.  El punto es que no podemos confiar en el hecho de que la configuraci√≥n actual es correcta en todas partes. <br><br>  Llevo al hecho de que no puedes comparar la nueva configuraci√≥n con la anterior.  Puede ser equivalente, pero permanecer al mismo tiempo en alg√∫n lugar equivocado.  Es necesario verificar el contenido l√≥gico. <br><br>  Programa m√≠nimo: a√≠sle cada par√°metro separado de cada servicio que necesita y verifique que sea correcto, que el puerto es un puerto, la direcci√≥n es una direcci√≥n, TTL es un n√∫mero positivo, etc.  Y verifique las relaciones clave que los servicios b√°sicamente conectan en los puntos finales principales.  Quer√≠a lograr esto, al menos.  Es decir, a diferencia de los ejemplos anteriores, la tarea aqu√≠ no es verificar par√°metros individuales, sino cubrir toda la configuraci√≥n con una red completa de verificaciones. <br><br>  ¬øC√≥mo probarlo? <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleComponent</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Configuration conf )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port = conf.getInt( <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( port &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(); String ip = conf.getString( <span class="hljs-string"><span class="hljs-string">"Address"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ip == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(); ‚Ä¶ } ‚Ä¶ }</code> </pre><br>  ¬øC√≥mo resolv√≠ este problema?  Hay alg√∫n componente simple, en el ejemplo se simplifica al m√°ximo.  (Para aquellos que no se han encontrado con la Configuraci√≥n de Apache Commons: el objeto de Configuraci√≥n es como Propiedades, solo que todav√≠a tiene los m√©todos mecanografiados getInt (), getLong (), etc .; podemos suponer que estos son juProperties en esteroides peque√±os). Supongamos que un componente necesita dos par√°metros: por ejemplo, una direcci√≥n TCP y un puerto TCP.  Los sacamos y revisamos.  ¬øCu√°les son las cuatro partes comunes aqu√≠? <br><br><img src="https://habrastorage.org/webt/ou/s0/0k/ous00k4owrh8kqvf20fqqpzrfg0.jpeg"><br><br>  Este es el nombre del par√°metro, tipo, valores predeterminados (aqu√≠ son triviales: nulo y -1, a veces hay valores razonables) y algunas validaciones.  El puerto aqu√≠ se valida de manera demasiado simple e incompleta: puede especificar el puerto que lo atravesar√°, pero no ser√° un puerto de red v√°lido.  Por lo tanto, me gustar√≠a mejorar este momento tambi√©n.  Pero antes que nada, quiero convertir estas cuatro cosas en una sola.  Por ejemplo, esto: <br><br><pre> <code class="java hljs">IProperty&lt;Integer&gt; PORT_PROPERTY = intProperty( <span class="hljs-string"><span class="hljs-string">"Port"</span></span> ) .withDefaultValue( -<span class="hljs-number"><span class="hljs-number">1</span></span> ) .matchedWith( validNetworkPort() ); IProperty&lt;String&gt; ADDRESS_PROPERTY = stringProperty( <span class="hljs-string"><span class="hljs-string">"Address"</span></span> ) .withDefaultValue( <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) .matchedWith( validIPAddress() );</code> </pre><br>  Tal objeto compuesto es una descripci√≥n de una propiedad que conoce su nombre, valor predeterminado, puede hacer la validaci√≥n (aqu√≠ uso de nuevo el emparejador de Hamcrest).  Y este objeto tiene algo como esta interfaz: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IProperty</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* (name, defaultValue, matcher‚Ä¶) */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** lookup (or use default), * convert type, * validate value against matcher */</span></span> <span class="hljs-function"><span class="hljs-function">FetchedValue&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Configuration config )</span></span></span><span class="hljs-function"> } class FetchedValue&lt;T&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String propertyName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T propertyValue; ‚Ä¶ }</code> </pre><br>  Es decir, despu√©s de crear un objeto espec√≠fico para una implementaci√≥n espec√≠fica, puede pedirle que extraiga el par√°metro que representa de la configuraci√≥n.  Y extraer√° este par√°metro, verificar√° el proceso, si no hay ning√∫n par√°metro, le dar√° un valor predeterminado, lo llevar√° al tipo deseado y lo devolver√° inmediatamente con el nombre. <br><br>  Es decir, aqu√≠ est√° el nombre del par√°metro y un valor tan real que el servicio ver√° si lo solicita desde esta configuraci√≥n.  Esto le permite ajustar varias l√≠neas de c√≥digo en una entidad, esta es la primera simplificaci√≥n que necesitar√©. <br><br>  La segunda simplificaci√≥n que necesitaba para resolver el problema era introducir un componente que necesita varias propiedades para su configuraci√≥n.  Modelo de configuraci√≥n de componentes: <br><br><img src="https://habrastorage.org/webt/gf/rr/ku/gfrrkugkjdimk8kcunvu4vijrsu.jpeg"><br><br>  Ten√≠amos un componente que usaba estas dos propiedades, hay un modelo para su configuraci√≥n: la interfaz IConfigurationModel, que implementa esta clase.  IConfigurationModel hace todo lo que hace el componente, pero solo la parte que se relaciona con la configuraci√≥n.  Si el componente necesita par√°metros en un cierto orden con ciertos valores predeterminados, IConfigurationModel combina esta informaci√≥n en s√≠ misma, la encapsula.  Todas las dem√°s acciones del componente no son importantes para √©l.  Este es un modelo de componente en t√©rminos de acceso a la configuraci√≥n. <br><br><img src="https://habrastorage.org/webt/1v/-b/0d/1v-b0dpycb6qscw_n5sul8tbzec.jpeg"><br><br>  El truco de esta vista es que los modelos son combinables.  Si hay un componente que usa otros componentes y se combinan all√≠, de la misma manera, el modelo de este componente complejo puede fusionar los resultados de las llamadas de dos subcomponentes. <br><br>  Es decir, es posible construir una jerarqu√≠a de modelos de configuraci√≥n paralela a la jerarqu√≠a de los propios componentes.  En el modelo superior, llame a fetch (), que devolver√° la hoja de los par√°metros que extrajo de la configuraci√≥n con sus nombres, exactamente aquellos que el componente correspondiente necesitar√° en tiempo real.  Si escribimos todos los modelos correctamente, por supuesto. <br><br>  Es decir, la tarea es escribir dichos modelos para cada componente de la aplicaci√≥n que tiene acceso a la configuraci√≥n.  En mi aplicaci√≥n, hab√≠a bastantes componentes de este tipo: la aplicaci√≥n en s√≠ es bastante frondosa, pero reutiliza activamente el c√≥digo, por lo que solo se configuran 70 clases principales.  Para ellos, tuve que escribir 70 modelos. <br><br>  Lo que cost√≥: <br><br><ul><li>  12 servicios </li><li>  70 clases configurables </li><li>  =&gt; 70 modelos de configuraci√≥n (~ 60 son triviales); </li><li>  1-2 personas semanas. </li></ul><br>  Simplemente abr√≠ la pantalla con el c√≥digo del componente que se configura solo, y en la siguiente pantalla escrib√≠ el c√≥digo para el Modelo de configuraci√≥n correspondiente.  La mayor√≠a de ellos son triviales, como el ejemplo que se muestra.  En algunos casos, hay ramas y transiciones condicionales; all√≠ el c√≥digo se vuelve m√°s ramificado, pero tambi√©n todo est√° resuelto.  En una y media o dos semanas resolv√≠ este problema, para los 70 componentes describ√≠ los modelos. <br><br>  Como resultado, cuando lo juntamos todo, obtenemos el siguiente c√≥digo: <br><br><img src="https://habrastorage.org/webt/dq/ab/vf/dqabvfz99qwfnortpempmtvaalm.jpeg"><br><br>  Para cada servicio / entorno / etc.  tomamos el modelo de configuraci√≥n, es decir, el nodo superior de este √°rbol, y pedimos obtener todo de la configuraci√≥n.  En este punto, todas las validaciones pasan al interior, cada una de las propiedades, cuando se extrae de la configuraci√≥n, verifica su valor para verificar que sea correcto.  Si al menos uno no pasa, saldr√° una excepci√≥n.  Todo el c√≥digo se obtiene comprobando que todos los valores son v√°lidos de forma aislada. <br><br><h2>  Interdependencias de servicio </h2><br>  Todav√≠a ten√≠amos una pregunta sobre c√≥mo verificar la interdependencia de los servicios.  Esto es un poco m√°s complicado, debes ver qu√© tipo de interdependencia hay.  Result√≥ que las interdependencias se reducen al hecho de que los servicios deber√≠an "encontrarse" en los puntos finales de la red.  El servicio A debe escuchar exactamente la direcci√≥n a la que el servicio B env√≠a paquetes, y viceversa.  En mi ejemplo, todas las dependencias entre las configuraciones de diferentes servicios se redujeron a esto.  Fue posible resolver este problema de una manera tan directa: obtenga puertos y direcciones de diferentes servicios y verif√≠quelos.  Habr√≠a muchas pruebas, ser√≠an voluminosas.  Soy una persona perezosa y no quer√≠a esto.  Por lo tanto, hice lo contrario. <br><br>  En primer lugar, quer√≠a abstraer de alguna manera este punto final de la red.  Por ejemplo, para una conexi√≥n TCP solo necesita dos par√°metros: direcci√≥n y puerto.  Para una conexi√≥n de multidifusi√≥n, cuatro par√°metros.  Me gustar√≠a colapsarlo en alg√∫n tipo de objeto.  Hice esto en el objeto Endpoint, que en su interior oculta todo lo que necesita.  La diapositiva es un ejemplo de OutcomingTCPEndpoint, una conexi√≥n de red TCP saliente. <br><br><pre> <code class="java hljs">IProperty&lt;IEndpoint&gt; TCP_REQUEST = outcomingTCP( <span class="hljs-comment"><span class="hljs-comment">// (+matchers, +default values) ‚ÄúTCP.Request.Address‚Äù, ‚ÄúTCP.Request.Port¬ª ); class OutcomingTCPEndpoint implements IEndpoint { //(localInterface, localAddress, multicastGroup, port) @Override boolean matches( IEndpoint other); }</span></span></code> </pre><br>    Endpoint    matches(),      Endpoint,  ,           . <br><br>  ¬´ ¬ª?     ,    : , ,  -   ,          ‚Äî        .   ,     ,  /  . ,  ,          . <br><br> ,    , ---,     ,  Endpoint.    ConfigurationModels    ‚Äî  , .    ?        : <br><br><pre> <code class="java hljs">ValueWithContext[] allEndpoints = flattenedConfigurationValues(environment) .filter( valueIsEndpoint() ) .toArray(); ValueWithContext[] unpairedEndpoints = Arrays.stream( allEndpoints ) .filter( e -&gt; !hasMatchedEndpoint(e, allEndpoints) ) .toArray(); assertThat( unpairedEndpoints, emptyArray() );</code> </pre><br>      environment'  endpoint',    ,   ,      ,     .          .     ¬´  ¬ª  O(n^2),     ,   endpoint'  ,    . <br><br>      Endpoint      ,   ,    .     ,        ,  -     . <br><br> ,  ,     ,   ¬´¬ª ‚Äî     ,   .      .  ,          ,       .  ,       . <br><br>      .   , ,   .        , ,      ,   c,  ,        . <br><br>    ConfigurationModel : <br><br><ul><li>     </li><li>     (‚Äú udp-,     ‚Äù) </li><li>        . </li></ul><br>          ,       .         ,     ,   ,    ‚Äî   .    :          ,      .        ,      ,      ,     ,  . <br><br>   .    ,   ConfigurationModels,      .      ,   UDP-      ,    ,   . <br><br>  ,      endpoints      ,   .dot.      .     ‚Äî      . <br><br>    .  Conclusiones: <br><br><ul><li>   ,   ,   ‚Äî    . </li><li>     ,     .    ,     . </li><li>    ,    ,     ,       . </li></ul><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le gust√≥ este informe del Piter Heisenbug 2018, tenga en cuenta: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del 6 al 7 de diciembre, el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√≥ximo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heisenbug</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se llevar√° a cabo </font><b><font style="vertical-align: inherit;">en Mosc√∫</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La mayor√≠a de las descripciones de los nuevos informes ya est√°n disponibles </font><font style="vertical-align: inherit;">en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el sitio web de la conferencia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y a partir del 1 de noviembre, los precios de las entradas est√°n aumentando, por lo que tiene sentido tomar una decisi√≥n ahora.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427487/">https://habr.com/ru/post/es427487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427477/index.html">Estamos preparando la agrupaci√≥n jer√°rquica, o c√≥mo identifiqu√© especializaciones en el curr√≠culum</a></li>
<li><a href="../es427479/index.html">El uso de datos de usuario y la venta de big data propuestos para legitimar</a></li>
<li><a href="../es427481/index.html">Caracter√≠sticas de la construcci√≥n de una red Wi-Fi en la producci√≥n innovadora de alimentos.</a></li>
<li><a href="../es427483/index.html">Escuela de Inteligencia Artificial en el Distrito Binario</a></li>
<li><a href="../es427485/index.html">El problema con Windows no es la tasa de actualizaci√≥n, sino el proceso de desarrollo</a></li>
<li><a href="../es427489/index.html">HomeData: c√≥mo se usa el an√°lisis de datos en arquitectura y urbanismo</a></li>
<li><a href="../es427491/index.html">vDud en ingl√©s: 7 entrevistadores occidentales, de los cuales todos toman un ejemplo</a></li>
<li><a href="../es427493/index.html">Amplificadores de clases de baja frecuencia: A, B, AB, D, G, H</a></li>
<li><a href="../es427495/index.html">¬øCu√°nto cuesta Habr + instrucciones para saber cu√°nto ganan otras compa√±√≠as?</a></li>
<li><a href="../es427499/index.html">¬øSobre qu√© escriben en el soporte t√©cnico del transmisor de video?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>