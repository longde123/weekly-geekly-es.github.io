<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>驕덢잺 游댠 游꿁 Soluciones arquitect칩nicas para un juego m칩vil. Parte 2: Comando y sus colas 游돜游 游녩游낗 游</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la primera parte del art칤culo, examinamos c칩mo se debe organizar el modelo para que sea f치cil de usar, pero depurarlo y atornillar interfaces es si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soluciones arquitect칩nicas para un juego m칩vil. Parte 2: Comando y sus colas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435704/"><img src="https://habrastorage.org/webt/1n/ji/xq/1njixqpyay22mmuyckufhgouye8.jpeg"><br><br>  En la primera parte del art칤culo, examinamos c칩mo se debe organizar el modelo para que sea f치cil de usar, pero depurarlo y atornillar interfaces es simple.  En esta parte consideraremos la devoluci칩n de comandos para cambios en el modelo, en toda su belleza y diversidad.  Como antes, la prioridad para nosotros ser치 la conveniencia de la depuraci칩n, minimizando los gestos que un programador debe hacer para crear una nueva caracter칤stica, as칤 como la legibilidad del c칩digo para una persona. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect칩nicas para un juego m칩vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1: modelo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Soluciones arquitect칩nicas para un juego m칩vil.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3: Ver en el empuje del jet</a> <br><a name="habracut"></a><br><h2>  Por qu칠 comando </h2><br>  El patr칩n de comando suena fuerte, pero de hecho es solo un objeto en el que se agrega y almacena todo lo necesario para la operaci칩n solicitada.  Elegimos este enfoque, al menos porque nuestros equipos ser치n enviados a trav칠s de la red, e incluso obtendremos algunas copias del estado del juego para uso oficial.  Entonces, cuando el usuario hace clic en el bot칩n, se crea una instancia de la clase de comando y se env칤a al destinatario.  El significado de la letra C en la abreviatura MVC es algo diferente. <br><br><h2>  Predicci칩n de resultados y verificaci칩n de comandos a trav칠s de la red. </h2><br>  En este caso, el c칩digo espec칤fico es menos importante que la idea.  Y aqu칤 est치 la idea: <br><br>  Un juego respetuoso no puede esperar una respuesta del servidor antes de reaccionar al bot칩n.  Por supuesto, Internet est치 mejorando y puedes tener un mont칩n de servidores en todo el mundo, y conozco incluso un par de juegos exitosos que esperan una respuesta del servidor, uno de ellos es incluso Invocando Guerras, pero a칰n as칤 no necesitas hacer eso.  Debido a que los retrasos de Internet m칩vil de 5-15 segundos son m치s propensos a ser la norma que una excepci칩n, en Mosc칰 al menos el juego deber칤a ser realmente excelente para que los jugadores no le presten atenci칩n. <br><br>  En consecuencia, tenemos un estado de juego que representa toda la informaci칩n necesaria para la interfaz, y los comandos se aplican inmediatamente y solo despu칠s de eso se env칤an al servidor.  Por lo general, los programadores de Java que trabajan duro se sientan en el servidor duplicando todas las nuevas funcionalidades una a una en otro idioma.  En nuestro proyecto "ciervo", su n칰mero lleg칩 a 3 personas, y los errores cometidos al portar fueron una fuente constante de alegr칤a evasiva.  En cambio, podemos hacerlo de manera diferente.  Ejecutamos en el servidor .Net y ejecutamos en el lado del servidor el mismo c칩digo de comando que en el cliente. <br><br>  El modelo descrito en el 칰ltimo art칤culo nos brinda una nueva oportunidad interesante para la autoevaluaci칩n.  Despu칠s de ejecutar el comando en el cliente, calcularemos el hash del cambio que ocurri칩 en el 치rbol GameState y lo aplicaremos al equipo.  Si el servidor ejecuta el mismo c칩digo de comando y el hash de los cambios no coincide, entonces algo sali칩 mal. <br><br>  Primeras ventajas: <br><br><ul><li>  Esta soluci칩n acelera enormemente el desarrollo y minimiza el n칰mero de programadores de servidores. </li><li>  Si el programador cometi칩 errores que condujeron a un comportamiento no determinista, por ejemplo, obtuvo el primer valor del Diccionario, o us칩 DateTime.now, y generalmente us칩 algunos valores que no est치n escritos expl칤citamente en los campos de comando, entonces cuando heh se inicia en el servidor, no coincidir치n, y lo descubriremos </li><li>  El desarrollo del cliente puede llevarse a cabo por el momento sin un servidor.  Incluso puede entrar en alfa amigable sin tener un servidor.  Esto es 칰til no solo para los desarrolladores independientes que se pierden el juego de sus sue침os por la noche.  Cuando estaba en Piksonik hubo un caso en el que el programador del servidor perdi칩 todos los pol칤meros, y nuestro juego se vio obligado a sufrir moderaci칩n, teniendo en lugar del servidor un mu침eco que defend칤a est칰pidamente todo el estado del juego de vez en cuando. </li></ul><br>  Una desventaja que por alguna raz칩n se subestima sistem치ticamente: <br><br><ul><li>  Si el programador del cliente hizo algo mal y es invisible durante las pruebas, por ejemplo, la probabilidad de que haya productos en los cuadros misteriosos, entonces no hay nadie que escriba lo mismo por segunda vez y encuentre un error.  El c칩digo autoportable requiere una actitud mucho m치s responsable hacia las pruebas. </li></ul><br><h2>  Informaci칩n de depuraci칩n detallada </h2><br>  Una de nuestras prioridades declaradas es la conveniencia de depuraci칩n.  Si durante la ejecuci칩n del equipo atrapamos la ejecuci칩n: todo est치 claro, retrocedemos el estado del juego, enviamos el estado completo a los registros y serializamos el comando que lo dej칩 caer, todo es conveniente y hermoso.  La situaci칩n es m치s complicada si tenemos una desincronizaci칩n con el servidor.  Debido a que el cliente ya ha completado varios otros comandos desde entonces, y resulta que no solo descubre en qu칠 estado se encontraba el modelo antes de ejecutar el comando que condujo al desastre, sino que realmente quiero hacerlo.  Clonar un estado de juego frente a cada equipo es demasiado complicado y costoso.  Para resolver el problema, complicamos el esquema cosido debajo del cap칩 del motor. <br><br>  En el cliente no tendremos un estado de juego, sino dos.  El primero sirve como interfaz principal para renderizar, los comandos se aplican inmediatamente.  Despu칠s de eso, los comandos aplicados se ponen en cola para enviarlos al servidor.  El servidor realiza la misma acci칩n por su parte y confirma que todo est치 bien y es correcto.  Una vez recibida la confirmaci칩n, el cliente toma el mismo comando y lo aplica al segundo estado del juego, llev치ndolo al estado que el servidor ya ha confirmado como correcto.  Al mismo tiempo, tambi칠n tenemos la oportunidad de comparar el hash de los cambios realizados para que sea seguro, y tambi칠n podemos comparar el hash completo de todo el 치rbol en el cliente, que podemos calcular despu칠s de ejecutar el comando, pesa un poco y se considera lo suficientemente r치pido.  Si el servidor no dice que todo est치 bien, le pide al cliente detalles de lo que sucedi칩, y el cliente puede enviarle un segundo estado de juego serializado exactamente como se ve칤a antes de que el comando se ejecutara con 칠xito en el cliente. <br>  La soluci칩n parece muy atractiva, pero da lugar a dos problemas que deben resolverse a nivel de c칩digo: <br><br><ul><li>  Entre los par치metros de comando, puede haber no solo tipos simples, sino tambi칠n enlaces a modelos.  En otro estado de juego, exactamente en el mismo lugar se encuentran otros objetos del modelo.  Resolvemos este problema de la siguiente manera: antes de ejecutar el comando en el cliente, serializamos todos sus datos.  Entre ellos puede haber enlaces a modelos, que escribiremos en forma de Path to the model desde la ra칤z del estado del juego.  Hacemos esto ante el equipo, porque despu칠s de su ejecuci칩n los caminos pueden cambiar.  Luego enviamos esta ruta al servidor, y el estado del juego del servidor podr치 obtener un enlace a su modelo en el camino.  De manera similar, cuando un equipo se aplica al segundo estado del juego, el modelo se puede obtener del segundo estado del juego. </li><li>  Adem치s de los tipos y modelos elementales, un equipo puede tener enlaces a colecciones.  Diccionario &lt;clave, Modelo&gt;, Diccionario &lt;Modelo, clave&gt;, Lista &lt;Modelo&gt;, Lista &lt;Valor&gt;.  Para todos, tienen que escribir serializadores.  Es cierto que no puede precipitarse en esto, en un proyecto real, tales campos surgen sorprendentemente raramente. </li><li>  Enviar comandos al servidor de uno en uno no es una buena idea, porque el usuario puede producirlos m치s r치pido de lo que Internet puede arrastrarlos de un lado a otro, en Internet deficiente crecer치 el conjunto de comandos que el servidor no ha elaborado.  En lugar de enviar comandos uno a la vez, los enviaremos en lotes de varias piezas.  En este caso, despu칠s de recibir una respuesta del servidor de que algo sali칩 mal, primero deber치 aplicar al segundo estado todos los comandos anteriores del mismo paquete que fueron confirmados por el servidor, y solo luego borrar y enviar el segundo estado de control al servidor. </li></ul><br><h2>  Comodidad y facilidad para escribir comandos </h2><br>  El c칩digo de ejecuci칩n del comando es el segundo c칩digo m치s grande y el primero m치s responsable del juego.  Cuanto m치s simple y claro sea, y cuanto menos necesite el programador hacer un extra con sus manos para escribirlo, m치s r치pido se escribir치 el c칩digo, menos errores se cometer치n y, muy inesperadamente, m치s feliz ser치 el programador.  Coloco el c칩digo de ejecuci칩n directamente en el comando en s칤, adem치s de las piezas y funciones generales que se encuentran en clases de reglas est치ticas separadas, con mayor frecuencia en forma de extensiones a las clases de modelo con las que trabajan.  Te mostrar칠 un par de ejemplos de comandos de mi proyecto favorito, uno muy simple y el otro un poco m치s complicado: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetSideCostCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//              protected override bool DetaliedLog { get { return true; } } public FCMatchModel match; public int newCost; protected override void HexApply(HexKingdomsRoot root) { match.sideCost = newCost; match.CalculateAssignments(); match.CalculateNextUnassignedPlayer(); } } }</span></span></code> </pre> <br>  Y aqu칤 est치 el registro que este comando deja despu칠s de s칤 mismo, si este registro no est치 deshabilitado para 칠l. <br><br><pre> <code class="json hljs">[FCSetSideCostCommand id=<span class="hljs-number"><span class="hljs-number">1</span></span> match=FCMatchModel[<span class="hljs-number"><span class="hljs-number">0</span></span>] newCost=<span class="hljs-number"><span class="hljs-number">260</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0027546</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0008689</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"0"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"SIDE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}}}}</code> </pre> <br>  La primera vez que se indica en el registro es el tiempo durante el cual se realizaron todos los cambios necesarios en el modelo, y la segunda es el tiempo durante el cual los controladores de interfaz resolvieron todos los cambios.  Esto debe mostrarse en el registro para no hacer accidentalmente algo terriblemente lento o para darse cuenta a tiempo si las operaciones comienzan a tomar demasiado tiempo simplemente por el tama침o del modelo en s칤. <br><br>  Adem치s de las llamadas a objetos persistentes en Id-shniks, que reducen en gran medida la legibilidad del registro, que, por cierto, podr칤a haberse evitado aqu칤, el c칩digo de comando en s칤 y el registro que hizo con el estado del juego son incre칤blemente claros.  Tenga en cuenta que en el texto del comando el programador no realiza un solo movimiento adicional.  Todo lo que necesita lo hace el motor debajo del cap칩. <br><br>  Ahora veamos un ejemplo de un equipo m치s grande <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetUnitForPlayerCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//            protected override bool DetaliedLog { get { return true; } } public FCSelectArmyScreenModel screen; public string unit; public int count; protected override void HexApply(HexKingdomsRoot root) { if (count == 0 &amp;&amp; screen.player.units.ContainsKey(unit)) { screen.player.units.Remove(unit); screen.selectedUnits.Remove(unit); } else if (count != 0) { if (screen.player.units.ContainsKey(unit)) { screen.player.units[unit] = count; screen.selectedUnits[unit].count = count; } else { screen.player.units.Add(unit, count); screen.selectedUnits[unit] = new ReferenceUnitModel() { type = unit, count = count }; } } screen.SetSelectedReferenceUnits(); screen.player.CalculateUnitsCost(); var side = screen.match.sides[screen.side]; screen.match.CalculatePlayerAssignmentsAcceptablity(side); screen.match.CalculateNextUnassignedPlayer(screen.player); } } }</span></span></code> </pre> <br>  Y aqu칤 est치 el registro dejado por el equipo: <br><br><pre> <code class="json hljs">[FCSetUnitForPlayerCommand id=<span class="hljs-number"><span class="hljs-number">3</span></span> screen=/UI_SCREENS[main] unit=militia count=<span class="hljs-number"><span class="hljs-number">1</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0065625</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0004573</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}}, <span class="hljs-attr"><span class="hljs-attr">"ASSIGNED"</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>}}}, <span class="hljs-attr"><span class="hljs-attr">"UI_SCREENS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"SELECTED_UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"@new"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"TYPE"</span></span>:<span class="hljs-string"><span class="hljs-string">"militia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"REMARK"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"COUNT"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"SELECTED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DISABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_GREEN"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_RED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"BUTTON_ENABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}}}}}}}</code> </pre> <br>  Como dicen, es mucho m치s claro.  T칩mese el tiempo para equipar al equipo con un registro conveniente, compacto e informativo.  Esta es la clave de tu felicidad.  El modelo debe funcionar muy r치pido, por lo que utilizamos una variedad de trucos con m칠todos de almacenamiento y acceso a los campos.  Los comandos se ejecutan en el peor de los casos una vez por cuadro, de hecho, varias veces con menos frecuencia, por lo que haremos la serializaci칩n y deserializaci칩n de los campos de comando sin ning칰n tipo de fantas칤a, solo a trav칠s de la reflexi칩n.  Solo clasificamos los campos por nombres para que el orden sea fijo, bueno, compilaremos la lista de campos una vez durante la vida del comando y leeremos y escribiremos usando m칠todos nativos C #. <br><br><h2>  Modelo de informaci칩n para la interfaz. </h2><br>  Vamos a dar el siguiente paso para complicar nuestro motor, un paso que parece aterrador, pero simplifica enormemente la escritura y la depuraci칩n de las interfaces.  Muy a menudo, especialmente en el patr칩n MVP relacionado, el modelo contiene solo l칩gica de negocios controlada por el servidor, y la informaci칩n sobre el estado de la interfaz se almacena dentro del presentador.  Por ejemplo, desea pedir cinco boletos.  Ya seleccion칩 su n칰mero, pero a칰n no ha hecho clic en el bot칩n "ordenar".  La informaci칩n sobre exactamente cu치ntos boletos ha elegido en el formulario se puede almacenar en alg칰n lugar de los rincones secretos de la clase, lo que sirve como una junta entre el modelo y su pantalla.  O, por ejemplo, el jugador cambia de una pantalla a otra, pero nada cambia en el modelo, y d칩nde estaba cuando ocurri칩 la tragedia, el programador de depuraci칩n solo lo sabe por las palabras de un probador extremadamente disciplinado.  El enfoque es simple, comprensible, casi siempre usado y un poco malicioso, en mi opini칩n.  Porque si algo sali칩 mal, el estado de este presentador, que condujo a un error, es absolutamente imposible de descubrir.  Especialmente si el error ocurri칩 en el servidor de batalla durante la operaci칩n por $ 1000, y no en el probador en un entorno controlado y reproducible. <br><br>  En lugar de este enfoque habitual, prohibimos que cualquier persona, excepto el modelo, contenga informaci칩n sobre el estado de la interfaz.  Esto tiene, como de costumbre, ventajas y desventajas que deben ser combatidas. <br><br><ul><li>  <b>(+1)</b> La ventaja m치s importante, ahorrar meses de trabajo de programaci칩n: si algo sale mal, el programador simplemente carga el estado del juego antes del accidente y recibe exactamente el mismo estado no solo del modelo de negocio, sino de toda la interfaz hasta el 칰ltimo bot칩n de la pantalla. </li><li>  <b>(+2)</b> Si alg칰n equipo cambi칩 algo en la interfaz, el programador puede ir f치cilmente al registro y ver qu칠 ha cambiado exactamente en un conveniente formulario json, como en la secci칩n anterior. </li><li>  <b>(-1)</b> En el modelo aparece una gran cantidad de informaci칩n redundante que no es necesaria para comprender la l칩gica comercial del juego y que el servidor no la necesita dos veces. </li></ul><br>  Para resolver este problema, marcaremos algunos campos como notServerVerified, se ve as칤, por ejemplo, as칤: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EDictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; uiScreens { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UI_SCREENS.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; UI_SCREENS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> };</code> </pre> <br>  Esta parte del modelo y todo lo que est치 debajo se relacionar치 exclusivamente con el cliente. <br><br>  Si a칰n recuerda, los indicadores de lo que necesita exportar y lo que no se ve as칤: <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }</code> </pre> <br>  En consecuencia, al exportar o calcular un hash, puede especificar si exporta el 치rbol completo o solo esa parte que el servidor verifica. <br><br>  La primera complicaci칩n obvia que surge de aqu칤 es la necesidad de crear comandos separados que el servidor debe verificar y aquellos que no son necesarios, pero tambi칠n hay otros que deben verificarse no del todo.  Para no cargar al programador con operaciones innecesarias para configurar el comando, intentaremos nuevamente hacer todo lo necesario con el cap칩 del motor. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;    ,      &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;         &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyClientSide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  El programador que crea el comando puede anular una o ambas funciones.  Todo esto, por supuesto, es maravilloso, pero 쯖칩mo puedo asegurarme de que el programador no estrope칩 nada, y si arruin칩 algo, 쯖칩mo puede ayudarlo a solucionarlo r치pida y f치cilmente?  Hay dos formas  Apliqu칠 el primero, pero puede que te guste el segundo m치s. <br><br><h3>  Primera forma </h3><br>  Utilizamos las caracter칤sticas interesantes de nuestro modelo: <br><br><ol><li>  El motor llama a la primera funci칩n, despu칠s de lo cual recibe un hash de cambios en la parte del estado del juego verificada por el servidor.  Si no hay cambios, entonces estamos tratando exclusivamente con el equipo del cliente. </li><li>  Obtenemos el hash modelo de cambios en todo el modelo, no solo el verificado por el servidor.  Si difiere del hash anterior, el programador cometi칩 un error y cambi칩 algo en la parte del modelo que el servidor no comprob칩.  Rodeamos el 치rbol de estado y volcamos al programador como una ejecuci칩n de una lista completa de los campos notServerVerified = true y los que se encuentran debajo del 치rbol que 칠l cambi칩. </li><li>  Llamamos a la segunda funci칩n.  Obtenemos del modelo un resumen de los cambios que ocurrieron en la parte marcada.  Si no coincide con el hash despu칠s de la primera llamada, en la segunda funci칩n el programador ha hecho algo.  Si queremos obtener un registro muy informativo en este caso, revertimos todo el modelo a su estado original, lo serializamos en un archivo, luego el programador ser치 칰til para la depuraci칩n, luego lo clonar치 completo (dos l칤neas - serializaci칩n-deserializaci칩n), y ahora primero aplicamos el primero funci칩n, luego confirmamos los cambios para que el modelo se vea sin cambios, despu칠s de lo cual aplicamos la segunda funci칩n.  Y luego exportamos todos los cambios en la parte comprobada por el servidor en forma de JSON y los incluimos en la ejecuci칩n abusiva, para que el programador avergonzado pueda ver de inmediato qu칠 y d칩nde cambi칩, qu칠 no se debe cambiar. </li></ol><br>  Parece, por supuesto, aterrador, pero de hecho son 7 l칤neas, porque las funciones que hacen esto es todo (excepto atravesar el 치rbol desde el segundo p치rrafo) estamos listos.  Y como se trata de recepci칩n, podemos permitirnos actuar de manera no 칩ptima. <br><br><h3>  Segunda forma </h3><br>  Un poco m치s brutal, ahora en ModelRoot tenemos un campo de bloqueo, pero podemos dividirlo en dos, uno bloquear치 solo los campos marcados en el servidor y el otro solo los campos marcados.  En este caso, el programador que hizo algo mal recibir치 una explicaci칩n al respecto de inmediato con un v칤nculo con el lugar donde lo hizo.  El 칰nico inconveniente de este enfoque es que si en nuestro 치rbol una propiedad modelo est치 marcada como desmarcada, entonces todo lo que se encuentra en el 치rbol debajo de 칠l con respecto al c치lculo de hashes y el control de cambios no se inspeccionar치, incluso si cada campo no se marc칩.  Un bloqueo, por supuesto, no mirar치 dentro de la jerarqu칤a, lo que significa que todos los campos de la parte no marcada del 치rbol tendr치n que estar marcados, y no funcionar치 en algunos lugares para usar las mismas clases en la interfaz de usuario y la parte habitual del 치rbol.  Como opci칩n, tal construcci칩n es posible (la escribir칠 simplificada): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameState</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelData data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelLocal local; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; } }</code> </pre> <br>  Entonces resulta que cada sub치rbol tiene su propio bloqueo.  GameState hereda modelos, porque es m치s f치cil que crear una implementaci칩n separada de la misma funcionalidad. <br><br><h3>  Mejoras necesarias </h3><br>  Por supuesto, el gerente responsable del procesamiento de los equipos tendr치 que agregar una nueva funcionalidad.  La esencia de los cambios ser치 que no todos los comandos se enviar치n al servidor, sino solo aquellos que crean los cambios marcados.  El servidor de su lado no elevar치 todo el 치rbol de estado del juego, sino solo la parte que se verifica y, en consecuencia, el hash coincidir치 solo para la parte que se verifica.  Cuando se ejecuta el comando, solo la primera de las dos funciones del comando se iniciar치 en el servidor, y al resolver referencias a modelos en el estado del juego, si la ruta conduce a una parte no verificable del 치rbol, se colocar치 un valor nulo en la variable del comando en lugar del modelo.  Todos los equipos que no env칤an se alinear치n honestamente con los habituales, pero se considerar치n confirmados.  Tan pronto como lleguen a la l칤nea y no haya personas sin confirmar antes de ellos, se aplicar치n inmediatamente al segundo estado. <br><br>  No hay nada fundamentalmente complicado en la implementaci칩n.  Es solo que la propiedad de cada campo del modelo tiene una condici칩n m치s, un recorrido del 치rbol. <br><br>  Otro refinamiento necesario: necesitar치 una F치brica separada para ParsistentModel en las partes marcadas y no marcadas del 치rbol y NextFreeId para ellas ser치 diferente. <br><br><h2>  Comandos iniciados por el servidor </h2><br>  Hay alg칰n problema si el servidor quiere enviar su comando al cliente, porque el estado del cliente en relaci칩n con el servidor ya podr칤a avanzar unos pasos.  La idea principal es que si el servidor necesita enviar su comando, env칤a la notificaci칩n del servidor al cliente con la siguiente respuesta, y lo escribe en el campo para las notificaciones enviadas a este cliente.  El cliente recibe una notificaci칩n, forma un comando sobre la base y lo coloca al final de su cola, despu칠s de aquellos que se han completado en el cliente pero a칰n no han llegado al servidor.  Despu칠s de un tiempo, el comando se env칤a al servidor como parte del proceso normal de trabajo con el modelo.  Habiendo recibido este comando para el procesamiento, el servidor arroja la notificaci칩n fuera de la cola saliente.  Si el cliente no respondi칩 a la notificaci칩n dentro del tiempo establecido con el siguiente paquete, se le env칤a un comando de reinicio.  Si el cliente que recibi칩 la notificaci칩n se ha ca칤do, se conecta m치s tarde o, por alguna raz칩n, carga el juego, entonces el servidor convertir치 todas las notificaciones en comandos antes de darle el estado, las ejecutar치 de su lado y solo despu칠s de eso le dar치 al cliente que se une su nuevo estado.  Tenga en cuenta que un jugador puede tener un estado conflictivo con recursos negativos cuando el jugador logr칩 gastar el dinero exactamente en el momento en que el servidor se los quit칩.  La coincidencia es poco probable, pero con una DAU grande, es casi inevitable.  Por lo tanto, la interfaz y las reglas del juego no deben morir en tal situaci칩n. <br><br><h2>  Comandos para ejecutar que necesita saber la respuesta del servidor </h2><br>  Un error t칤pico es pensar que solo se puede obtener un n칰mero aleatorio del servidor.  Nada le impide tener el mismo generador de n칰meros pseudoaleatorio ejecut치ndose simult치neamente desde el cliente y el servidor, comenzando desde un sid com칰n.  Adem치s, la semilla actual se puede almacenar directamente en el estado del juego.  A algunos les puede resultar dif칤cil sincronizar la respuesta de este generador.  De hecho, para esto es suficiente tener un n칰mero m치s en el mismo art칤culo, exactamente cu치ntos n칰meros se recibieron del generador hasta este momento.  Si su generador por alguna raz칩n no converge, entonces tiene un error en alguna parte y el c칩digo no funciona de manera determinista.  Y este hecho no debe ocultarse debajo de la alfombra, sino que debe resolverse y buscar un error.  Para la gran mayor칤a de los casos, incluso las cajas misteriosas, este enfoque es suficiente. <br><br>  Sin embargo, hay momentos en que esta opci칩n no es adecuada.  Por ejemplo, est치s jugando un premio muy costoso y no quieres que el astuto compa침ero descompile el juego, y escribe un bot que te diga de antemano qu칠 se caer치 de la caja de diamantes si lo abres ahora mismo, y qu칠 pasa si giras el tambor en otro lugar antes de eso.  Puede almacenar semillas para cada variable aleatoria por separado, esto proteger치 contra la pirater칤a frontal, pero no ayudar치 de ninguna manera a un bot que le diga cu치ntas cajas tiene el producto que necesita actualmente.  Bueno, el caso m치s obvio es que es posible que no desee brillar en la configuraci칩n del cliente con informaci칩n sobre la probabilidad de alg칰n evento raro.  En resumen, a veces es necesario esperar una respuesta del servidor. <br>  Dichas situaciones deben resolverse no a trav칠s de las capacidades adicionales del motor, sino dividiendo al equipo en dos: la primera prepara la situaci칩n y pone la interfaz en un estado de espera para notificaciones, la segunda en realidad, con la respuesta que necesita.  Incluso si bloquea estrictamente la interfaz entre ellos en el cliente, puede pasar otro comando, por ejemplo, una unidad de energ칤a se restaurar치 a tiempo. <br><br>  Es importante comprender que tales situaciones no son la regla, sino la excepci칩n.  De hecho, la mayor칤a de los juegos solo necesitan un equipo esperando una respuesta: GetInitialGameState.  Otro paquete de tales comandos es la interacci칩n entre jugadores en un metajuego, GetLeaderboard, por ejemplo.  Todas las otras doscientas piezas son deterministas. <br><br><h2>  Almacenamiento de datos del servidor y el tema turbio de la optimizaci칩n del servidor </h2><br>  Admito de inmediato que soy un cliente, y a veces he escuchado tales ideas y algoritmos de servidores de servidores familiares que ni siquiera se me han metido en la cabeza.  Al comunicarme con mis colegas, de alguna manera desarroll칠 una imagen de c칩mo deber칤a funcionar mi arquitectura en el lado del servidor en el caso ideal.  Sin embargo: existen contraindicaciones, es necesario consultar con un servidor especializado. <br><br>  Primero sobre el almacenamiento de datos.  Es su lado del servidor el que puede tener restricciones adicionales.  Por ejemplo, se le puede prohibir el uso de campos est치ticos.  Adem치s, el c칩digo de comandos y modelos es autoportable, pero el c칩digo de propiedad en el cliente y en el servidor no tiene que coincidir en absoluto.  All칤 se puede ocultar cualquier cosa, hasta la inicializaci칩n diferida de los valores de campo de la memoria cach칠, por ejemplo.  Los campos de propiedades tambi칠n pueden recibir par치metros adicionales que son utilizados por el servidor, pero no afectan el trabajo del cliente. <br><br>  La primera diferencia cardinal del servidor: donde los campos se serializan y deserializan.  Una soluci칩n razonable es que la mayor칤a del 치rbol de estado se serializa en un gran campo binario o json.  Al mismo tiempo, algunos campos se toman de las tablas.  Esto es necesario porque los valores de algunos campos ser치n constantemente necesarios para que funcionen los servicios de interacci칩n entre jugadores.  Por ejemplo, el 칤cono y el nivel se mueven constantemente por una variedad de personas.  Se guardan mejor en una base de datos regular.  Raramente, cuando alguien decide buscar en su territorio, necesitar치 un estado completo o parcial, pero detallado de una persona que no sea 칠l. <br><br>  Adem치s, extraer los campos de la base uno a la vez es inconveniente, y puede llegar a arrastrar todo durante mucho tiempo.  Una soluci칩n muy no est치ndar, disponible solo para nuestra arquitectura, puede consistir en el hecho de que el cliente, cuando ejecuta un comando, recopila informaci칩n sobre todos los campos almacenados por separado en tablas cuyos captadores lograron tocar y agrega esta informaci칩n al comando para que el servidor pueda generar este grupo de campos Una solicitud a la base de datos.  Por supuesto, con restricciones razonables, para no rogar por DDOS causado por programadores curvos que tocaron todo sin prestar atenci칩n. <br><br>  Con dicho almacenamiento separado, uno deber칤a considerar los mecanismos de transaccionalidad cuando un jugador se arrastra a los datos de otro, por ejemplo, le roba dinero.  Pero en el caso general, lo hacemos mediante notificaci칩n.  Es decir, el ladr칩n recibe su dinero de inmediato, y la persona robada recibe una notificaci칩n con instrucciones para cancelar el dinero cuando se trata de eso. <br><br><h2>  C칩mo se dividen los equipos entre servidores </h2><br>  Ahora es el segundo momento importante para el servidor.  Hay dos enfoques.  Al principio, para procesar cualquier solicitud (o un paquete de solicitudes), todo el estado se eleva desde la base de datos o cach칠 a la memoria, se procesa y luego se devuelve a la base de datos.  Las operaciones se resuelven at칩micamente en un grupo de servidores de ejecuci칩n diferentes, y solo tienen una base com칰n, y aun as칤 no siempre.  Como cliente, elevar todo el estado a cada equipo es impactante, pero vi c칩mo funciona, y funciona de manera muy confiable y escalable.  La segunda opci칩n es que el estado una vez aumenta en la memoria y permanece all칤 hasta que el cliente se cae solo ocasionalmente agregando su estado actual a la base de datos.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No soy competente para decirle las ventajas y desventajas de este o aquel m칠todo. Ser치 bueno que alguien en los comentarios me explique por qu칠 el primero tiene derecho a la vida en general. La segunda opci칩n plantea preguntas sobre c칩mo interactuar entre jugadores que por casualidad se criaron en diferentes servidores. Esto puede ser cr칤tico, por ejemplo, si varios miembros del clan se est치n preparando para lanzar un ataque conjunto. No puede mostrar a otros el estado de su miembro del grupo con un retraso de 10 salvados. Desafortunadamente, no lo abrir칠 aqu칤, la interacci칩n a trav칠s de las notificaciones descritas anteriormente, los comandos de un servidor a otro, en este momento est치 fuera de turno para guardar el estado actual del jugador planteado all칤. Si los servidores tienen el mismo nivel de disponibilidad desde diferentes lugares,y puede administrar el equilibrador, puede intentar transferir silenciosamente el reproductor de un servidor a otro. Si conoce mejor una soluci칩n, aseg칰rese de describirla en los comentarios.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Baila con el tiempo </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comencemos con la pregunta, que realmente me gusta derribar a las personas en las entrevistas: aqu칤 tiene un cliente y un servidor, cada uno tiene su propio reloj bastante preciso. </font><font style="vertical-align: inherit;">C칩mo averiguar cu치nto difieren. </font><font style="vertical-align: inherit;">Un intento de resolver este problema en una cafeter칤a con una servilleta revela las mejores y peores cualidades de un programador. </font><font style="vertical-align: inherit;">El hecho es que el problema no tiene una soluci칩n formal matem치ticamente correcta. </font><font style="vertical-align: inherit;">Pero el entrevistado es consciente de esto, por lo general, tome un minuto en el quinto y solo despu칠s de las preguntas principales. </font><font style="vertical-align: inherit;">Y la forma en que conoce esta idea y lo que hace a continuaci칩n, dice mucho sobre lo m치s importante de su personaje, lo que har치 esta persona cuando comiencen los problemas reales en su proyecto.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mejor soluci칩n que conozco me permite descubrir no la diferencia exacta, sino aclarar el rango en el que cae a trav칠s de muchas solicitudes de respuesta hasta el momento del mejor paquete que se ejecut칩 de cliente a servidor, m치s el tiempo del mejor paquete que se ejecut칩 de servidor a cliente. En total, esto le dar치 algunas decenas de milisegundos de precisi칩n. Esto es muchas veces mejor de lo necesario para el metajuego del juego m칩vil, aqu칤 no tenemos multijugador de realidad virtual o CS, pero todav칤a es bueno para el programador representar la escala y la naturaleza de las dificultades con la sincronizaci칩n del reloj. Lo m치s probable es que sea suficiente para que sepa el retraso promedio tomado como un ping a la mitad, durante mucho tiempo con un l칤mite de desviaciones de m치s del 30%.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La segunda situaci칩n interesante que es probable que encuentres es organizar un juego de deslizamiento y transferir el reloj a tu tel칠fono. En ambos casos, el tiempo en la aplicaci칩n cambiar치 dram치ticamente y abruptamente, y esto debe resolverse correctamente. Al menos reinicie el juego, pero es mejor, por supuesto, no reiniciar despu칠s de cada deslizamiento, por lo que no puede usar el tiempo que ha pasado en la aplicaci칩n desde su lanzamiento.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tercer lugar, la situaci칩n, por alguna raz칩n, es un problema que algunos programadores deben comprender, aunque existe una soluci칩n correcta: las operaciones no pueden realizarse absolutamente en tiempo de servidor. Por ejemplo, comience la producci칩n de bienes cuando llegue una solicitud de producci칩n al servidor. De lo contrario, desp칤dase de su determinismo y obtenga 35 mil desincronizaciones por d칤a causadas por diferentes opiniones del cliente y el servidor sobre si ya es posible hacer clic en el premio. La decisi칩n correcta es que el equipo registra informaci칩n sobre el momento en que se ejecut칩. El servidor, a su vez, verifica si la diferencia horaria entre la hora actual del servidor y la hora en el comando cae dentro del intervalo permitido, y si lo hace, ejecuta el comando por su parte usando el tiempo declarado por el cliente.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra tarea para la entrevista: Tiempo de espera despu칠s del cual el cliente intentar치 reiniciar - 30 segundos. 쮺u치les son los l칤mites de la diferencia horaria aceptable para el servidor? Consejo # 1: El intervalo no es sim칠trico. Consejo # 2: Vuelva a leer el primer p치rrafo de esta secci칩n nuevamente, especifique c칩mo extender el intervalo para no detectar 3000 errores por d칤a en los efectos de borde. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que esto funcione de manera hermosa y correcta, es mejor agregar un par치metro adicional a los par치metros de llamada de comando: el tiempo de llamada.</font></font> Algo como esto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface Command { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y mi consejo para ti, por cierto, no uses tipos de Unidad nativos por tiempo en el modelo: te ahogar치s. Es mejor almacenar UnixTime en tiempo de servidor, siempre que necesite tener a mano m칠todos de conversi칩n a mano, y almacenarlos en el modelo en un campo PTime especial que difiera de PValue &lt;long&gt; solo en que al exportar a JSON agrega informaci칩n redundante entre par칠ntesis que no se puede leer cuando Importar: Tiempo en un formato legible para humanos. No puedes obedecerme. Te lo advert칤</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarta situaci칩n: en el estado del juego, hay situaciones en las que un equipo debe iniciarse sin la participaci칩n de un jugador, a tiempo, por ejemplo, la recuperaci칩n de energ칤a. Una situaci칩n muy com칰n, de hecho. Quiero tener un campo, est치 practicando convenientemente. Por ejemplo, PTimeOut, en el que ser치 posible grabar un punto en el tiempo despu칠s del cual se debe crear y ejecutar un comando. En el c칩digo, puede verse as칤:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PTimeOut RESTORE_ENERGY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PTimeOut() {command = (model, property) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestoreEnergyCommand() { model = model}} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> restoreEnergy { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RESTORE_ENERGY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { RESTORE_ENERGY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); }} }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por supuesto, durante la carga inicial del reproductor, el servidor primero debe provocar la creaci칩n y ejecuci칩n de todos estos comandos, y solo entonces debe entregar el estado al jugador. El peligro aqu칤 es que todo esto interfiere con las notificaciones que el jugador podr칤a recibir durante este tiempo. Por lo tanto, ser치 necesario desenroscar primero el tiempo anterior a la hora de la primera notificaci칩n, si necesita extraer un mont칩n de comandos al mismo tiempo, luego crear un comando desde la notificaci칩n en s칤, luego desenroscar el tiempo hasta la pr칩xima notificaci칩n, luego resolverlo y as칤 sucesivamente. Si todo este feriado de la vida no encaja en el tiempo de espera del servidor, y esto es posible si el jugador recibi칩 muchas notificaciones, escribimos el estado actual de la memoria a la base de datos y respondemos con un comando para volver a conectar con el cliente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos estos comandos deben de alguna manera aprender sobre lo que necesitan crear y ejecutar. Mi soluci칩n un poco crujiente pero conveniente es que el modelo tiene un desaf칤o m치s, que se extiende por toda la jerarqu칤a del modelo, que se mueve despu칠s de ejecutar cada comando y tambi칠n en el temporizador. Por supuesto, esta es una sobrecarga adicional para caminar alrededor del 치rbol casi en una actualizaci칩n, en lugar de eso, puede suscribirse o darse de baja del evento CurrentTime que sobresale del estado del juego con cada cambio en este campo:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCurrentTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; } vs <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> event Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; setCurrentTime; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto es bueno, pero el problema es que los modelos que se eliminan del 치rbol de modelos para siempre y que contienen dicho campo permanecer치n suscritos a este evento, y tendr치n que resolverlo correctamente. </font><font style="vertical-align: inherit;">Antes de enviar un comando, verifique si todav칤a est치n en el 치rbol y si tienen un enlace d칠bil a este evento o inversi칩n de control, de modo que debido a esto no sean inaccesibles para GC.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ap칠ndice 1, un caso t칤pico tomado de la vida real </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomo de los comentarios a la primera parte. En los juguetes, muy a menudo algunas acciones no tienen lugar inmediatamente despu칠s del comando al modelo, sino al final de alg칰n tipo de animaci칩n. En nuestra pr치ctica, hubo un caso en el que se abrieron las cajas misteriosas y, por supuesto, el dinero deber칤a cambiar solo cuando la animaci칩n se desarrolla hasta el final. Uno de nuestros desarrolladores decidi칩 simplificar su vida, y no cambiar el valor en el comando, pero decirle al servidor que cambi칩, y al final de la animaci칩n ejecutar una devoluci칩n de llamada, que corregir치 los valores en el modelo a los deseados. Bien hecho, en resumen. Hizo estas cajas misteriosas durante dos semanas, y luego otros tres errores dif칤ciles de atrapar que surgieron como resultado de su trabajo y tuvimos que pasar tres semanas m치s para completarlos, a pesar de que el tiempo para "reescribir como normal" fue, por supuesto, nadie pudo destacar. De lo cual se desprende v칤vidamenteCreo que la conclusi칩n es que era mejor hacer todo desde el principio con una reactividad normal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, mi decisi칩n es algo como esto. Por supuesto, el dinero no se encuentra en un campo separado, sino que es uno de los objetos en el diccionario de inventario, pero esto no es tan importante en este momento. El modelo tiene una parte que es verificada por el servidor, y sobre la base de la cual funciona la l칩gica de negocios, y la otra que existe solo en el cliente. El dinero en el modelo principal se acumula inmediatamente despu칠s de tomar la decisi칩n, y en la segunda parte de la lista de "presentaci칩n diferida", se crea un elemento por la misma cantidad que inicia la animaci칩n por el hecho de su aparici칩n, y cuando la animaci칩n termina, se lanza un comando que elimina este elemento. Tal nota puramente del cliente "todav칤a no muestra esta cantidad". Y en un campo real, no solo se muestra el valor del campo, sino el valor del campo menos todos los aplazamientos del cliente. La divisi칩n en esos dos equipos se hace porque쯈u칠 pasa si el cliente se reinicia despu칠s del primer equipo, pero antes del segundo todo el dinero recibido por el jugador estar치 en su cuenta sin ninguna marca y excepci칩n? En el c칩digo, ser치 algo como esto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenMisterBox</span></span></span><span class="hljs-class"> :</span></span> Command { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BoxItemModel item; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> slot; <span class="hljs-comment"><span class="hljs-comment">//        ,  . public override void Apply(GameState state) { state.inventory[item.revardKey] += item.revardCount; } //       . public override void Apply(GameState state) { var cause = state.NewPersistent&lt;WaitForCommand&gt;(); cause.key = item.key; cause.value = item.value; state.ui.delayedInventoryVisualization.Add(cause); state.ui.mysteryBoxScreen.animations.Add(new Animation() {cause = item, slot = slot})); } } public class MysteryBoxView : View { /* ... */ public override void ConnectModel(MysteryBoxScreenModel model, List&lt;Control&gt; c) { model.Get(c, MysteryBoxScreenModel.ANIMATIONS) .Control(c, onAdd = item =&gt; animationFactory(item, OnComleteOrAbort =&gt; { AsincQueue(new RemoveAnimation() {cause = item.cause, animation = item}) }), onRemove = item =&gt; {} ) } } public class InventoryView : View&lt;InventoryItem&gt; { public Text text; public override void ConnectModel(InventoryItem model, List&lt;Control&gt; c) { model.GameState.ui.Get(c, UIModel.DELAYED_INVENTORY_VISUALIZATION). .Where(c, item =&gt; item.key == model.key) .Expression(c, onChange = (IList&lt;InventoryItem&gt; list) =&gt; { int sum = 0; for (int i = 0; i &lt; list.Count; i++) sum += list[i].value; return sum; }, onAdd = null, onRemove = null ) //      .Join (c, model.GameState.Get(GameState.INVENTORY).ItemByKey(model.key)) .Expression(c, (delay, count) =&gt; count - delay) .SetText(c, text); //     ,      ,   ,  ,   ,       ,     : model.inventory.CreateVisibleInventoryItemCount(c, model.key).SetText(c, text); } } public class RemoveDelayedInventoryVisualization : Command { public DelayCauseModel cause; public override void Apply(GameState state) { state.ui.delayedInventoryVisualization.Remove(cause); } } public class RemoveAnimation : RemoveDelayedInventoryVisualization { public Animation animation public override void Apply(GameState state) { base.Apply(state); state.ui.mysteryBoxScreen.animations.Remove(animation); } }</span></span></code> </pre> <br>  쯈u칠 tenemos al final?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay dos vistas, en una de ellas se reproduce una animaci칩n, cuyo final est치 esperando que el dinero se muestre en una vista completamente diferente, que no tiene idea de qui칠n y por qu칠 quiere mostrar un significado diferente. Todo es reactivo. En cualquier momento, puede cargar el estado completo de GameState en el juego y comenzar치 a reproducirse exactamente desde donde lo dejamos, incluida la animaci칩n que se inicia. La verdad comenzar치 desde el principio, porque no borramos la etapa de animaci칩n, pero si realmente la necesitamos, podemos borrarla incluso.</font></font><br><br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dise침ar la l칩gica empresarial del juego a trav칠s de modelos, equipos y archivos est치ticos con reglas, encerr치ndolos por todos lados con hermosos registros detallados y generados autom치ticamente y adjuntando ejecuciones informativas de muchos errores t칤picos cometidos por un programador que muestra nuevas caracter칤sticas, esta es, en mi opini칩n, la forma correcta de vivir. luz blanca Y no solo porque puede presentar nuevas funciones varias veces m치s r치pido. Esto sigue siendo muy importante, porque si te resulta f치cil descargar y depurar una nueva funci칩n, entonces el dise침ador del juego tendr치 tiempo de realizar varias veces m치s experimentos de dise침o de juegos con los mismos programadores. Con el debido respeto a nuestro trabajo, depende de nosotros si el juego falla o no, pero si dispara o no depende de los gamedismos, y necesitan espacio para los experimentos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y ahora te pido que respondas preguntas muy importantes para m칤. </font><font style="vertical-align: inherit;">Si tiene ideas sobre c칩mo hacer lo que he hecho mal, o simplemente desea comentar mis respuestas, los estoy esperando en los comentarios. </font><font style="vertical-align: inherit;">Una propuesta de cooperaci칩n e instrucciones sobre numerosos errores de sintaxis, por favor en PM.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es435704/">https://habr.com/ru/post/es435704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es435694/index.html">C칩mo y por qu칠 optimizamos el algoritmo para limpiar cach칠s SLAB en el kernel de Linux</a></li>
<li><a href="../es435696/index.html">Antig칲edades: 1997 Computer Advertising</a></li>
<li><a href="../es435698/index.html">Escribiendo tu propio buen administrador de memoria</a></li>
<li><a href="../es435700/index.html">8 peores preguntas de la entrevista de Vue.js</a></li>
<li><a href="../es435702/index.html">Los trolls de patentes comienzan y ganan: c칩mo me qued칠 sin un juego</a></li>
<li><a href="../es435706/index.html">Usamos rcm para implementar la configuraci칩n en cualquier carpeta</a></li>
<li><a href="../es435708/index.html">Fayal: un lugar de encuentro en el Atl치ntico</a></li>
<li><a href="../es435712/index.html">Procter & Gamble lanza una impresora de piel antienvejecimiento</a></li>
<li><a href="../es435714/index.html">Los desarrolladores ucranianos tuvieron acceso a los archivos de todas las c치maras Ring del mundo.</a></li>
<li><a href="../es435718/index.html">Bombeamos Angular NGSW usando l칩gica personalizada en Service Worker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>