<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👵🏾 〽️ 👨🏻‍⚖️ 迁移到Google Cloud Platform（Google Cloud Platform-GCP） 🍧 🧑🏾 👩🏿‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[第2部分，共2部分] 


 [第1部分，共2部分] 





 我们是怎么做到的 


 我们决定改用GCP来提高应用程序性能-在扩大规模的同时，却不会产生大笔成本。 整个过程耗时超过2个月。 为了解决这个问题，我们组成了一个特殊的工程师小组。 


 在本出版物中，我们将讨论所选的方法及其实...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>迁移到Google Cloud Platform（Google Cloud Platform-GCP）</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/430874/"><h3 id="chast-2-iz-2">  [第2部分，共2部分] </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">[第1部分，共2部分]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos"> 我们是怎么做到的 </h2><br><p> 我们决定<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">改用GCP</a>来提高应用程序性能-在扩大规模的同时，却不会产生大笔成本。 整个过程耗时超过2个月。 为了解决这个问题，我们组成了一个特殊的工程师小组。 </p><br><p> 在本出版物中，我们将讨论所选的方法及其实施以及我们如何实现主要目标-尽可能平稳地执行此过程并将整个基础架构转移到Google Cloud Platform，而不会影响用户服务的质量。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="图片"></p><a name="habracut"></a><br><h2 id="planirovanie"> 规划中 </h2><br><ol><li> 准备了详细的清单，以标识每个可能的步骤。 已创建流程图来描述顺序。 </li><li> 已经制定了重置计划，我们可以使用该重置计划。 </li></ol><br><p> 进行了几次集思广益的会议-我们已经确定了实施主动-主动方案的最容易理解和最简单的方法。 它包含以下事实：一小群用户托管在一个云上，其余用户托管在另一个云上。 但是，这种方法引起了问题，尤其是在客户端（与DNS管理有关），并且导致了数据库复制的延迟。 因此，几乎不可能安全地实施它。 显而易见的方法没有提供必要的解决方案，因此我们必须制定专门的策略。 </p><br><p> 根据依赖关系图和操作安全要求，我们将基础结构服务分为9个模块。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="图片"></p><br><p>  <em>（用于部署托管基础结构的基本模块）</em> </p><br><p> 每个基础架构组管理共同的内部和外部服务。 </p><br><p>  ⊹ <strong>基础架构消息服务</strong> ：MQTT，HTTP，Thrift，Gunicorn服务器，排队模块，异步客户端，Jetty服务器，Kafka集群。 <br>  ⊹ <strong>数据仓库服务</strong> ：分布式集群MongoDB，Redis，Cassandra，Hbase，MySQL和MongoDB。 <br>  ⊹ <strong>基础架构分析服务</strong> ：Kafka集群，数据仓库集群（HDFS，HIVE）。 </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu"> 为重要的一天做准备： </h2><br><p>  ✓每个服务切换到GCP的详细计划：顺序，数据仓库，重置计划。 <br>  ✓GCP中的跨项目网络交互（共享的虚拟私有云VPC [XPN]）可隔离基础架构的不同部分，优化管理，提高安全性和连接性。 <br>  ✓GCP与正在运行的虚拟私有云（VPC）之间的多个VPN隧道可简化复制过程中网络上大量数据的传输，以及随后可能部署的并行系统。 <br>  ✓使用Chef系统自动安装和配置整个堆栈。 <br>  ✓用于部署，监视，记录等的脚本和自动化工具。 <br>  ✓为系统流配置所有必需的子网和托管防火墙规则。 <br>  ✓在所有存储系统的多个数据中心（Multi-DC）中进行复制。 <br>  ✓配置负载平衡器（GLB / ILB）和托管实例组（MIG）。 <br>  ✓使用检查点将对象存储容器传输到GCP Cloud Storage的脚本和代码。 </p><br><p> 很快，我们满足了所有必要的先决条件，并准备了将基础架构移至GCP平台的元素清单。 经过大量讨论，并考虑了服务的数量及其依赖关系图，我们决定在三晚之内将云基础架构转移到GCP，以涵盖所有服务器端和数据存储服务。 </p><br><h2 id="perehod"> 过渡期 </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki"> 负载均衡器转移策略： </h3><br><p> 我们用全局负载平衡器替换了以前使用的HAProxy管理的群集，以每天处理数千万的活动用户连接。 </p><br><p>  ⊹ <strong>阶段1：</strong> </p><br><ul><li> 使用数据包转发规则创建MIG，以将所有流量转发到现有云中的MQTT IP地址。 </li><li> 已使用MIG作为服务器部分创建了SSL和TCP代理平衡器。 </li><li> 对于MIG，将以MQTT服务器作为服务器部分启动HAProxy。 </li><li> 在DNS中，基于权重的路由策略已添加了外部GLB IP地址。 </li></ul><br><p> 用户连接在跟踪其性能的同时逐步部署。 </p><br><p>  ⊹ <strong>步骤2：</strong>里程碑过渡，开始在GCP中部署服务。 <br>  ⊹ <strong>阶段3：</strong>过渡的最后阶段，所有服务都转移到GCP。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="图片"></p><br><p>  <em>（负载均衡器的转移阶段）</em> </p><br><p> 在这个阶段，一切都按预期进行。 很快，考虑到系数的权重，是时候在带有路由的GCP中部署几个内部HTTP服务了。 我们密切监控所有指标。 当我们开始逐渐增加流量时，即计划进行过渡的前一天，通过VPN进行VPC交互的延迟（记录了40毫秒-100毫秒的延迟，尽管之前的延迟小于10毫秒）有所增加。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="图片"></p><br><p>  <em>（两个VPC交互时检查网络延迟的快照）</em> </p><br><p> 监控清楚地表明：使用VPN隧道的两个云网络通道都出了问题。 甚至VPN隧道的吞吐量也没有达到最佳标记。 这种情况已开始对我们的某些用户服务产生负面影响。 我们立即将所有先前迁移的HTTP服务恢复为原始状态。 我们联系了TAM和云服务支持团队，提供了必要的初始数据，并开始理解为什么延迟越来越大。 支持专家得出的结论是，在两个云服务提供商之间的云通道中实现了最大的网络带宽。 因此，内部系统传输期间网络延迟的增长。 </p><br><p> 此事件迫使中止向云的过渡。 云服务提供商无法足够快地将带宽加倍。 因此，我们回到了计划阶段并修改了策略。 我们决定将云基础架构从一晚而不是三晚转移到GCP，并且计划中包括服务器部分和数据存储的所有服务。 当“ X”小时到来时，一切顺利进行：工作负载成功转移到Google Cloud，我们的用户没有注意到！ </p><br><h2 id="strategiya-perenosa-bazy-dannyh"> 数据库迁移策略： </h2><br><p> 必须为关系型DBMS，内存中的存储以及NoSQL以及低延迟的分布式和可伸缩群集转移50多个数据库端点。 我们已将所有数据库的副本放置在GCP中。 除HBase之外，所有其他部署均已完成此操作。 </p><br><p>  ⊹ <strong>主从复制：</strong>针对MySQL，Redis，MongoDB和MongoS集群实现。 <br>  <strong>多多DC复制：</strong>为Cassandra群集实现。 <br>  ⊹ <strong>双群集：</strong>已在GCP中为Gbase配置了并行群集。 迁移了现有数据，并根据维护两个群集中数据一致性的策略配置了两次输入。 </p><br><p> 对于HBase，问题出在Ambari。 在将群集放置在多个数据中心中时，我们遇到了一些困难，例如，DNS，机架识别脚本等存在问题。 </p><br><p> 最后的步骤（在移动服务器之后）包括将副本移动到主服务器并关闭旧数据库。 按照计划，确定数据库传输的优先级，我们将Zookeeper用于应用程序集群的必要配置。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="图片"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy"> 应用服务迁移策略 </h2><br><p> 为了将应用程序服务的工作负载从当前托管转移到GCP云，我们使用了“提升并转移”的方法。 对于每个应用程序服务，我们创建了一组具有自动扩展功能的托管实例（MIG）。 </p><br><p> 根据详细计划，我们开始考虑到数据仓库的顺序和依赖性，将服务迁移到GCP。 所有消息传递堆栈服务均已迁移到GCP，而没有任何停机时间。 是的，有一些小故障，但我们立即对其进行了处理。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="图片"></p><br><p> 早晨，随着用户活动的增加，我们认真遵循了所有仪表板和指示器以快速发现问题。 确实出现了一些困难，但是我们能够迅速消除它们。 问题之一是由于内部负载均衡器（ILB）的限制，该负载均衡器最多可以处理20,000个并发连接。 我们还需要8倍！ 因此，我们在连接管理层中添加了其他ILB。 </p><br><p> 在过渡之后的高峰负载的最初几个小时，我们特别仔细地控制了所有参数，因为消息传递堆栈的整个负载已转移到GCP。 我们很快处理了一些小故障。 在迁移其他服务时，我们采用了相同的方法。 </p><br><h2 id="perenos-hranilischa-obektov"> 对象存储迁移： </h2><br><p> 我们主要通过三种方式使用对象存储服务。 </p><br><p>  ⊹存储发送到个人或群聊的媒体文件。 保留期限由生命周期管理策略确定。 <br>  ⊹存储用户配置文件的图像和缩略图。 <br>  ⊹存储“历史记录”和“时间轴”部分中的媒体文件以及相应的缩略图。 </p><br><p> 我们使用Google的存储传输工具将旧对象从S3复制到GCS。 当需要特殊逻辑时，我们还使用了基于Kafka的自定义MIG将对象从S3传输到GCS。 </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi"> 从S3到GCS的过渡包括以下步骤： </h3><br><p>  ●对于对象存储库的第一个用例，我们开始将新数据写入S3和GCS，到期后，我们开始使用应用程序侧的逻辑从GCS读取数据。 传输旧数据没有意义，并且这种方法具有成本效益。 <br>  ●对于第二和第三个用例，我们开始将新对象写入GCS，并更改了读取数据的路径，以便首先在GCS中执行搜索，然后在找不到对象的情况下才在S3中进行搜索。 <br> 计划，验证概念的正确性，准备和制作原型花了<strong>几个月的时间</strong> ，但后来我们决定过渡，并很快实施了它。 我们评估了风险，并意识到快速迁移是可取的，而且几乎不可察觉。 <br> 这个大型项目帮助我们在许多领域获得了强大的地位，并提高了团队的生产力，因为管理云基础架构的大多数手动操作现在都已过去。 <br>  ●对于用户，现在我们已收到确保其最高质量服务所必需的一切。 停机时间几乎消失了，新功能的实施速度更快。 <br>  ●我们的团队在维护任务上花费的时间更少，可以专注于自动化项目和创建新工具。 <br>  ●我们获得了前所未有的用于处理大数据的工具集，以及用于机器学习和分析的现成功能。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>查看详细信息<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">。</a> <br>  ●Google Cloud与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes</a>开源项目合作的承诺也符合我们今年的发展计划。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN430874/">https://habr.com/ru/post/zh-CN430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN430864/index.html">火柴不是玩具吗？</a></li>
<li><a href="../zh-CN430866/index.html">北京将在2020年为居民引入社会评级</a></li>
<li><a href="../zh-CN430868/index.html">购买NGFW时要记住什么？ 检查清单</a></li>
<li><a href="../zh-CN430870/index.html">在Ubuntu 16.04上安装BigBlueButton</a></li>
<li><a href="../zh-CN430872/index.html">谁将赢得网状辩论与ESB之争</a></li>
<li><a href="../zh-CN430876/index.html">通过测试进行开发：提高技能</a></li>
<li><a href="../zh-CN430878/index.html">可用的PhpStorm 2018.3</a></li>
<li><a href="../zh-CN430880/index.html">另一个数据处理实现</a></li>
<li><a href="../zh-CN430882/index.html">小米Aqara将重做从ZigBee切换到Z-Wave</a></li>
<li><a href="../zh-CN430884/index.html">印刷厂：为什么“ LANIT-Integration”开设了自己的“印刷厂”</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>