<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèª üí¨ ‚ôªÔ∏è C√≥mo nos hicimos amigos en la infraestructura bancaria usando ManageIQ ü§πüèΩ üë∞üèø üìÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace un par de a√±os, las principales tendencias fueron la automatizaci√≥n, las pr√°cticas de DevOps y la aceleraci√≥n de la entrega de valores al mercado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo nos hicimos amigos en la infraestructura bancaria usando ManageIQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/homecredit/blog/461891/"><p>  Hace un par de a√±os, las principales tendencias fueron la automatizaci√≥n, las pr√°cticas de DevOps y la aceleraci√≥n de la entrega de valores al mercado.  Home Credit Bank decidi√≥ mantenerse al d√≠a y se dirigi√≥ al desarrollo de la tecnolog√≠a, m√°s a√∫n cuando el susurro abierto de los usuarios que estaban cansados ‚Äã‚Äãde esperar varios d√≠as para esperar nuevos recursos para sus importantes proyectos se extendi√≥ m√°s en el espacio abierto. </p><br><p>  Decidimos comenzar con el proceso de aprobaci√≥n de solicitudes por departamentos, que, como en muchas grandes empresas, requer√≠a tiempo y esfuerzo.  Como primera tarea, elegimos el proceso de creaci√≥n de una m√°quina virtual independientemente del entorno de virtualizaci√≥n.  Al hacer una lista de tareas, nos dimos cuenta de que ser√≠a necesario integrarlo con otros sistemas utilizados en la infraestructura de nuestro banco, por ejemplo, a trav√©s de API. </p><br><p><img src="https://habrastorage.org/webt/tt/h7/br/tth7br6euodgo1dklwgmaqhdxu4.png" alt="imagen"></p><a name="habracut"></a><br><p> La soluci√≥n m√°s adecuada fue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ManageIQ</a> .  Este es un proyecto que Red Hat adquiri√≥ en 2012 y basado en √©l cre√≥ el producto comercial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Red Hat CloudForms</a> .  Al mismo tiempo, ManageIQ se mantuvo en el estado de un producto de c√≥digo abierto y se est√° desarrollando en paralelo con CloudForms. </p><br><p>  ManageIQ est√° escrito en Ruby y admite una gran cantidad de proveedores diferentes de virtualizaci√≥n, nubes p√∫blicas y contenedorizaci√≥n.  Por el momento, estamos utilizando una versi√≥n de Gaprindashvili en la configuraci√≥n de alta disponibilidad en el hogar. </p><br><h2>  C√≥mo ha cambiado el proceso </h2><br><p>  Anteriormente, cada equipo requer√≠a configuraciones separadas en su √°rea de responsabilidad.  Despu√©s de la preparaci√≥n preliminar, todos los datos se recopilaron y se enviaron al administrador, quien implement√≥ y configur√≥ la m√°quina virtual.  Luego fue necesario informar, por ejemplo, al equipo de monitoreo de que hab√≠a aparecido un nuevo host que necesitaba ser agregado al monitoreo.  Los retrasos en la comunicaci√≥n, la carga de trabajo de los especialistas, los errores causados ‚Äã‚Äãpor el factor humano, podr√≠an extender este proceso a varios d√≠as. </p><br><p>  Habiendo encajado todo el proceso en ManageIQ, obtuvimos los siguientes resultados: </p><br><div class="scrollable-table"><table><thead><tr><th>  Tipo de recurso virtual </th><th>  Antes de presentar ManageIQ </th><th>  Despu√©s de implementar ManageIQ </th></tr></thead><tbody><tr><td>  M√°quina virtual Linux en VMware / oVirt </td><td>  A uno </td><td>  ~ 10 minutos </td></tr><tr><td>  Entorno de m√°quina virtual de rancher </td><td>  trabajando </td><td>  ~ 15 minutos </td></tr><tr><td>  M√°quina virtual de Windows en VMware </td><td>  semanas </td><td>  ~ 25 minutos </td></tr></tbody></table></div><br><p>  La diferencia horaria se debe al hecho de que, en el segundo caso, se requiere tiempo adicional para preparar el host para trabajar con Docker, descargar e integrar im√°genes para contenedores de infraestructura de Artifactory, porque en esta etapa todav√≠a no hay acceso al Docker Hub.  En el caso de Windows, la diferencia se logra debido al hecho de que, en primer lugar, el tiempo de creaci√≥n de una VM Linux sin personalizaci√≥n es de aproximadamente 2 minutos, y el de una VM de Windows es de 6 minutos.  En segundo lugar, la personalizaci√≥n de Windows en s√≠ lleva unos 10 minutos, frente a 2 minutos para Linux. </p><br><p>  10 minutos no es tan r√°pido, dado que se gastan aproximadamente 2-3 minutos directamente en el proceso de creaci√≥n de una VM.  Para el tiempo restante, ManageIQ logra hacer lo siguiente: </p><br><ol><li>  El sistema recopila los par√°metros especificados por el usuario en el formulario de pedido y los descompone en variables. </li><li>  Se crea una nueva solicitud de cambio en el sistema de gesti√≥n de incidentes, que muestra datos sobre el nuevo recurso. </li><li>  El sistema de consulta de nombre de recurso ManageIQ env√≠a un valor para un nuevo recurso. </li><li>  El sistema de administraci√≥n de direcciones IP emite una nueva direcci√≥n basada en los par√°metros ingresados. </li><li>  Se registra un nuevo registro DNS en el servidor DNS local. </li><li>  Seg√∫n los par√°metros, el entorno y la carga de recursos, se selecciona el tipo de virtualizaci√≥n y el cl√∫ster para la ubicaci√≥n. </li><li>  A continuaci√≥n, el proceso de creaci√≥n de una m√°quina virtual con los par√°metros especificados. </li><li>  Cuando la m√°quina virtual se implementa desde la plantilla, debe ejecutar scripts que realizar√°n la configuraci√≥n final: <br><ul><li>  expansi√≥n de disco a un tama√±o especificado, </li><li>  generar una nueva contrase√±a de root, cambiarla en un host de Linux y escribir en un administrador de contrase√±as, </li><li>  creando un archivo YAML de configuraci√≥n para Puppet en GitLab, </li><li>  ejecutar runbooks que traen las configuraciones y actualizaciones necesarias para m√°quinas virtuales de Windows o </li><li>  inicie Puppet, que actualizar√° y configurar√° m√°quinas Linux. </li></ul></li><li>  Despu√©s de todo esto, la solicitud de cambio creada en el paso 2 se cierra.  Se le agregan datos nuevos, como la direcci√≥n IP y el nombre de host. </li><li>  Se registra una nueva unidad en la Base de administraci√≥n de recursos inform√°ticos (CMDB). </li><li>  La m√°quina virtual se registra en Zabbix y se agrega a la supervisi√≥n. </li><li>  El cliente y otras partes interesadas reciben un correo electr√≥nico con informaci√≥n sobre la nueva unidad creada con ManageIQ. </li></ol><br><h2 id="chto-vnutri">  Que hay dentro </h2><br><p>  Profundicemos en los detalles t√©cnicos del producto.  De manera predeterminada, ManageIQ puede crear una m√°quina virtual a partir de una plantilla.  ¬øC√≥mo difiere esto de lo que hacemos, por ejemplo, en vCenter?  La respuesta correcta es nada.  ManageIQ utiliza los mismos m√©todos que los sistemas de virtualizaci√≥n, pero lo hace desde un solo lugar.  Adem√°s de esto, puede agregar sus propios scripts que no se ajustan al conjunto est√°ndar de caracter√≠sticas.  Por lo tanto, si tiene recursos, por ejemplo, en Azure p√∫blico, en vCenter, que se implementa en su propio hardware, adem√°s de que el cl√∫ster de Kubernetes est√° girando en otro lugar, todo esto se puede administrar convenientemente desde ManageIQ. </p><br><p>  Adem√°s de una amplia variedad de proveedores para la integraci√≥n, ManageIQ tiene herramientas convenientes para la personalizaci√≥n.  Esto, por ejemplo, creando formas convenientes para resolver su problema: </p><br><p><img src="https://habrastorage.org/webt/ku/7y/l3/ku7yl3xi9trq-9wndv-ad_vlpvu.png"></p><br><p>  Gracias a esto, fue posible construir una interfaz completa para ordenar una m√°quina virtual, ajustando todos los par√°metros necesarios en ella: </p><br><p><img src="https://habrastorage.org/webt/v7/ey/tf/v7eytf_hbcxxjcpw4hvrzuwyzve.png"></p><br><p>  Seleccionamos la cantidad de recursos inform√°ticos, SO, completamos toda la informaci√≥n adicional que se necesita para la integraci√≥n con sistemas externos.  Adem√°s, utilizando mecanismos internos (sobre ellos un poco m√°s tarde), el sistema elige d√≥nde se colocar√°n los nuevos recursos: el centro de datos, el cl√∫ster, el host y el almac√©n de datos se seleccionan en funci√≥n de todos los par√°metros ingresados ‚Äã‚Äãy los recursos se cargan. </p><br><p>  No olvides que las personas pueden pedir demasiados recursos o nada de lo que realmente necesitan.  Aqu√≠ entra en juego el sistema de solicitudes y confirmaciones: </p><br><p><img src="https://habrastorage.org/webt/mj/yv/28/mjyv28hsy0ggf6t68jjdkgc8mwc.png"></p><br><p>  Cualquier recurso solicitado por el usuario debe ser aprobado por la persona responsable.  En Home, un grupo de arquitectos hace esto. </p><br><h2 id="struktura-avtomatizacii">  Estructura de automatizaci√≥n </h2><br><p>  Si descompone todos los procesos de automatizaci√≥n en ManageIQ en partes peque√±as, notar√° una cierta estructura. </p><br><h3 id="automate-domain">  Automatizar Dominio </h3><br><img align="right" src="https://habrastorage.org/webt/xy/ea/c_/xyeac_nx3if-e4txuiuriic4h0w.png"><br><p>  El almac√©n de datos aloja todos los dominios que ManageIQ tiene. </p><br><p>  Por defecto, hay un dominio ManageIQ, que est√° bloqueado y es algo as√≠ como un modelo de referencia.  Si necesita realizar cambios, se crea otro dominio, en el que los elementos del dominio ManageIQ se copian y cambian para sus propias tareas. </p><br><h3 id="automate-namespace">  Automatizar espacio de nombres </h3><br><img align="right" src="https://habrastorage.org/webt/yf/e1/t3/yfe1t3kjxb4rhvenndkfkwtsad4.png"><br><p>  En el interior, los dominios se dividen en partes que son responsables de los procesos individuales: esta puede ser la secci√≥n responsable de administrar la infraestructura (Infraestructura) o de trabajar con los servicios (Servicio).  Tenemos nuestro propio espacio de nombres, que contiene todo lo relacionado con los sistemas del banco. </p><br><p>  Considere la estructura con m√°s detalle utilizando el ejemplo del proceso de aprovisionamiento para una nueva m√°quina virtual.  Se describe en la clase Automatizar llamada <em>VMProvision_VM</em> . </p><br><h3 id="automate-class">  Automatizar clase </h3><br><p>  La clase tiene una estructura que incluye <strong>instancias</strong> , <strong>m√©todos</strong> , <strong>propiedades</strong> y <strong>esquema</strong> .  Desde el punto de vista de la automatizaci√≥n, Schema es de gran inter√©s: <br><img src="https://habrastorage.org/webt/vm/jt/lf/vmjtlfd9qpyrqpdpemtxfw2yczs.png"></p><br><p>  El dise√±o es similar a la tuber√≠a en los sistemas CI / CD.  Describe los pasos que se realizar√°n en el proceso de automatizaci√≥n. </p><br><h3 id="automate-instance">  Instancia automatizada </h3><br><img align="right" src="https://habrastorage.org/webt/ie/wj/fj/iewjfjuzq9rplkcszwsh7wemsqu.png"><br><p>  La clase descrita anteriormente tiene dos instancias de automatizaci√≥n.  Cada uno de ellos hereda del circuito las etapas para las que se establece el <em>Valor predeterminado</em> .  Las etapas que tienen valores nulos se describen en la instancia. </p><br><p><img src="https://habrastorage.org/webt/wy/sl/5c/wysl5c2zze_9_sfplsnykplbf_m.png"></p><br><p>  En la instancia, los valores aparecieron para los pasos que estaban vac√≠os en la descripci√≥n del esquema.  Tambi√©n puede ver qui√©n y cu√°ndo realiz√≥ el √∫ltimo cambio. </p><br><p>  Veamos qu√© representa uno de los valores de Valor: <br><img src="https://habrastorage.org/webt/rd/j_/v7/rdj_v7hc3wgt7dty2zckjltiacg.png"></p><br><p>  Esta es una clase de automatizaci√≥n llamada m√©todos, que tiene una instancia de automatizaci√≥n.  Su diagrama describe el atributo <em>ipam_base_uri</em> y el m√©todo de <em>ejecuci√≥n</em> .  El m√©todo de ejecuci√≥n, a su vez, llama al M√©todo de Automate <em>adquirir_ip</em> . </p><br><h3 id="automate-method">  M√©todo de automatizaci√≥n </h3><br><p>  Este es un script Ruby que permite que una m√°quina virtual se comunique a trav√©s de la API REST con otros sistemas.  Por ejemplo, como es el caso con el sistema de gesti√≥n de espacio de direcciones IPAM.  En IPAM obtenemos la direcci√≥n, la m√°scara, la subred y la VLAN para la VM.  La dificultad es que la m√°quina se puede implementar en un entorno de prueba o productivo, para aplicaciones o bases de datos.  O tal vez el servicio de seguridad decidi√≥ colocarlo en el bucle PCI-DSS.  Toda esta informaci√≥n se recopila en la etapa de creaci√≥n de la VM o se transmite en los par√°metros de la instancia llamada (en la captura de pantalla anterior, puede ver que el par√°metro contiene la uri por la cual el m√©todo acceder√° a IPAM): </p><br><div class="spoiler">  <b class="spoiler_title">Aqu√≠ hay un c√≥digo Ruby</b> <div class="spoiler_text"><pre><code class="ruby hljs">base_uri = $evm.object[<span class="hljs-string"><span class="hljs-string">'ipam_base_uri'</span></span>] prov = $evm.root[<span class="hljs-string"><span class="hljs-string">"miq_provision"</span></span>] site = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:site</span></span>) app = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_list_information_system</span></span>) crq = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:crq</span></span>) descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_textarea_box_usernotes</span></span>) owner = $evm.root[<span class="hljs-string"><span class="hljs-string">'user'</span></span>].name scope = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_scope</span></span>) environment = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:landscape</span></span>)</code> </pre> <br><p>  <em>$ evm.root</em> es un m√©todo que devuelve todo lo que se puede almacenar en ManageIQ.  Puede ser informaci√≥n sobre el usuario, el entorno, las variables, la solicitud actual ('miq_request'), etc.  Estamos interesados ‚Äã‚Äãen el proceso de provisi√≥n actual. <br><img src="https://habrastorage.org/webt/4m/hz/lm/4mhzlmb6p_lvkagsl7apu41mpdm.png"></p><br><p>  A continuaci√≥n, podemos recoger los valores necesarios: <em>get_option (: site)</em> recoge el valor que se transfiri√≥ en una de las etapas anteriores y, por ejemplo, <em>get_option (: dialog_dropdown_list_information_system)</em> recoge del formulario que el usuario llena al solicitar nuevos recursos. <br>  Todos los valores recibidos son transmitidos por variables en el cuerpo de la solicitud en formato JSON: </p><br><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">body:</span></span> { <span class="hljs-string"><span class="hljs-string">"site"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{site}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"env"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{env}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"app"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{app}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"scope"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{scope}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"role"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{role}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"crq"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{crq}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{descr}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"owner"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{owner}</span></span></span><span class="hljs-string">"</span></span>, }.to_json, }</code> </pre> <br><p>  Usando este conjunto de par√°metros, IPAM determinar√° inequ√≠vocamente en qu√© VLAN debe ubicarse la m√°quina virtual y devolver√° los par√°metros de red. </p></div></div><br><p>  Adem√°s de recibir datos para la configuraci√≥n correcta de VM, ManageIQ tambi√©n puede generar informaci√≥n adicional con el fin de realizar algunas configuraciones en la etapa del llamado aprovisionamiento posterior (despu√©s de que la m√°quina virtual se implemente y se inicie).  En Home, utilizamos Puppet para administrar las configuraciones de host de Linux.  Para cada unidad inform√°tica, cree un archivo GAML en YAML con un conjunto de grupos: </p><br><div class="spoiler">  <b class="spoiler_title">Un poco m√°s de c√≥digo Ruby</b> <div class="spoiler_text"><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Private-Token"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{api_token}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, } body = { <span class="hljs-string"><span class="hljs-string">"branch"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{branch}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"email@your.domain"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ManageIQ Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"commit_message"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"New host created by ManageIQ"</span></span>, } descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:long_description</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) &amp;&amp; descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n - user-devops-UDCR"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{$is_id}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Los grupos dependen del tipo de m√°quina virtual, el entorno en el que se crea y el sistema de informaci√≥n. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1i/hv/ig/1ihvigmykpbqlihq2l8oturxxk0.png"></div><br><p>  Despu√©s de completar con √©xito el procedimiento, el usuario recibe un correo electr√≥nico con informaci√≥n: <br><img src="https://habrastorage.org/webt/qf/j-/br/qfj-brpfqe1ukkcvrw_jdtdpigm.png"></p><br><p>  El texto de la carta tambi√©n se puede ajustar agregando la informaci√≥n necesaria. <br>  Si se produce un error en cualquiera de las etapas cr√≠ticas del proceso, puede agregar una condici√≥n que indique expl√≠citamente que el proceso debe interrumpirse.  Si el error no tiene consecuencias fatales, indique tambi√©n qu√© se puede continuar, a pesar del problema. </p><br><h2 id="logirovanie">  Registro </h2><br><p>  ManageIQ escribe registros de todo lo que se puede rastrear.  El proceso de automatizaci√≥n est√° escrito en automation.log.  Adem√°s, hay registros de API, varios proveedores de nube, registros de seguridad, incluso se registra la salida del comando superior. </p><br><p>  Para cada evento en el circuito, puede configurar una entrada de registro de su inicio y finalizaci√≥n: <br><img src="https://habrastorage.org/webt/tv/z0/yy/tvz0yyygspvyltb6d_x4ja00hpg.png"></p><br><p>  Adem√°s, puede escribir sus mensajes en los registros: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Call job status uri: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{item_uri}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{job_id}</span></span></span><span class="hljs-string">/api/json"</span></span>)</code> </pre> <br><p>  Esto es muy √∫til cuando se accede a los sistemas por API para comprender por qu√© algo sali√≥ mal.  O, para rastrear el estado actual de un proceso largo, como ejecutar un trabajo de Jenkins o un Runbook de SCCM: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"acquire_osname --- naming jobStatus: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{jobStatus}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> jobStatus.to_s == <span class="hljs-string"><span class="hljs-string">"Completed"</span></span></code> </pre> <br><p>  Puede usar las funciones est√°ndar para excepciones para escribir en los registros: </p><br><pre> <code class="ruby hljs">raise ‚ÄúVM <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> specified‚Äù <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vm.<span class="hljs-literal"><span class="hljs-literal">nil</span></span>?</code> </pre> <br><p>  Por defecto, todos los registros se almacenan en la secci√≥n / var / log / manageiq / *, pero desde mi propia experiencia puedo decir que buscar un problema a trav√©s de tail y grep no es la soluci√≥n m√°s conveniente.  Dado que ManageIQ escribe muchos registros diferentes, debe tener cuidado de redirigir los registros, por ejemplo, a la pila ELK. </p><br><h2 id="manageiq-api">  API ManageIQ </h2><br><p>  Adem√°s de una interfaz web f√°cil de usar, ManageIQ tiene una API funcional.  Con √©l, por ejemplo, resolvimos el problema de determinar din√°micamente el identificador de la plantilla que se especificar√° </p><br><div class="spoiler">  <b class="spoiler_title">al crear una VM:</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vendor, os, ems)</span></span></span></span> user = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">'</span></span> pass = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">'</span></span> options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Accept"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"*/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"accept-encoding"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"gzip, deflate"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">basic_auth:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">"</span></span> }, } response = HTTParty.get(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{host}</span></span></span><span class="hljs-string">/api/templates?filter[]=vendor=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{vendor}</span></span></span><span class="hljs-string">%27&amp;filter[]=name=%27%2A</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{os}</span></span></span><span class="hljs-string">%2A%27&amp;filter[]=ems_id=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{ems}</span></span></span><span class="hljs-string">%27"</span></span>, options).to_s link = JSON.parse(response) link[<span class="hljs-string"><span class="hljs-string">"resources"</span></span>].each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|r|</span></span> $url = r[<span class="hljs-string"><span class="hljs-string">"href"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> response = HTTParty.get($url,options).to_s template = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'id'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>+<span class="hljs-string"><span class="hljs-string">", "</span></span>+<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'name'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Usando una solicitud POST y especificando filtros para la b√∫squeda, obtenemos la plantilla deseada. <br>  Adem√°s de resolver problemas internos, puede crear nuevos m√©todos API para uso de sistemas externos.  Al comienzo del art√≠culo, se mostr√≥ el proceso de ordenar una nueva m√°quina virtual utilizando la interfaz web.  Y as√≠ es como se ve si lo haces con </p><br><div class="spoiler">  <b class="spoiler_title">Solicitud POST:</b> <div class="spoiler_text"><pre> <code class="ruby hljs">curl -X POST \ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/Manageiq.hostname/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/service_catalogs/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>/service_templates/<span class="hljs-number"><span class="hljs-number">31</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Authorization: Basic Token-Value'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{ "action": "order", "resource": { "radio_button_vcpu": "a_2", "radio_button_vram": "a_2", "hdd_size": "40", "dropdown_os": "CentOS", "text_box_filter": "dns", "dropdown_list_information_system": "DNS ", "text_box_validator": "OK (DNS )", "textarea_box_usernotes": " ", "dropdown_env": "production", "date_control_retirement_dt": "2022-05-21", "dropdown_scope": "-" } }'</span></span></code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><h3 id="plyusy">  Pros: </h3><br><ul><li>  Flexibilidad incre√≠ble: ManageIQ no solo le permite personalizar el proceso de automatizaci√≥n seg√∫n lo necesite, sino que tambi√©n le permite cambiar su parte visual agregando botones, campos, etc. </li><li>  Editor de c√≥digo incorporado con resaltado de sintaxis y validaci√≥n de c√≥digo.  Me pareci√≥ una muy buena soluci√≥n, si necesitas arreglar algo r√°pidamente. </li><li>  Una gran cantidad de fuentes con las que el sistema puede trabajar.  Nubes: Amazon EC2, Google Compute Engine, Azure, OpenStack, VMware vCloud.  Infraestructura: Microsoft SCVMM, OpenStack Platform Director, Red Hat Virtualization, VMware vCenter.  Contenedores: Kubernetes, OpenShift. </li></ul><br><h3 id="minusy">  Contras: </h3><br><ul><li>  Las grandes capacidades de la herramienta tambi√©n tienen un punto negativo.  No toda la documentaci√≥n est√° bien estructurada y, a veces, es dif√≠cil determinar d√≥nde buscar lo que necesita.  Sin embargo, vale la pena se√±alar que la situaci√≥n est√° cambiando para mejor, la documentaci√≥n se complementa y mejora. </li><li>  Peque√±a comunidad  Si encuentra alg√∫n problema muy espec√≠fico, es posible que no pueda "googlear" r√°pidamente la respuesta.  O no tener √©xito en absoluto. </li><li>  Un p√°rrafo que se sigue de los dos anteriores.  Algunas cosas b√°sicas, configuraciones y escenarios se pueden encontrar en la documentaci√≥n o en Internet, pero las preguntas m√°s espec√≠ficas y limitadas requieren mucho tiempo para comprender y estudiar, incluido el m√©todo de b√∫squeda cient√≠fica: sonrisa:. </li></ul><br><h3 id="kak-u-nas-seychas">  Como tenemos ahora: </h3><br><p>  Debido al hecho de que ManageIQ puede aprovechar al m√°ximo el lenguaje Ruby, pudimos integrarlo para trabajar con las siguientes API: </p><br><ul><li>  Administrador de contrase√±as  Genera una contrase√±a ra√≠z de acuerdo con los requisitos del servicio de seguridad, la escribe en su base de datos y ManageIQ la usa dentro del sistema operativo; </li><li>  Centro de servicios Servicios de orquestaci√≥n para administrar registros DNS y nombres de host; </li><li>  Remedio BMC.  Todo el proceso se registra como comentarios en la solicitud.  Despu√©s de una ejecuci√≥n exitosa, la solicitud se cierra; </li><li>  CMDB  La informaci√≥n sobre las nuevas unidades de configuraci√≥n se crea en la base de datos con todos los datos necesarios. </li><li>  Zabbix  Dependiendo de la afiliaci√≥n con el sistema de informaci√≥n y el entorno, los hosts se agregan a los grupos de monitoreo correspondientes. </li><li>  Ranchero.  Implement√© la creaci√≥n de nuevos entornos, la instalaci√≥n de agentes y el registro de hosts en entornos existentes. </li><li>  Jenkins  Jenkins ejecuta trabajos para configurar m√°quinas virtuales en oVirt; </li><li>  LDAP  Cree nuevos grupos que se utilizan para controlar el acceso en entornos Rancher y para configurar pol√≠ticas en Vault; </li><li>  B√≥veda  En Home, la integraci√≥n de este producto en los procesos bancarios acaba de comenzar, pero ya hemos creado m√©todos para crear nuevos grupos, pol√≠ticas y secciones para el almacenamiento; </li><li>  Puppet e IPAM se mencionaron anteriormente. </li></ul><br><p>  La funcionalidad y las capacidades del sistema son muy amplias, y me familiaric√© con muchas de ellas y sigo familiariz√°ndome con el proceso de implementaci√≥n del sistema. <br>  Por ejemplo, no mencion√© que el sistema tiene la capacidad de crear sus propios paneles con estad√≠sticas, configuraciones de facturaci√≥n o botones, a los que puede adjuntar guiones individuales o guiones completos.  Puede agregar sus propios campos para registrar informaci√≥n adicional sobre servicios y m√°quinas virtuales, etc. </p><br><h3 id="k-chemu-stremitsya-houm">  Para qu√© se esfuerza Home: </h3><br><ul><li>  Una actualizaci√≥n a la versi√≥n Hammer, en la que en el modo HA puede intentar trabajar con el Ansible incorporado. </li><li>  La transici√≥n de la coordinaci√≥n para cada unidad de recursos virtuales a la gesti√≥n.  Los equipos podr√°n recibir nuevas m√°quinas virtuales a√∫n m√°s r√°pido si la cuota no se agota. </li><li>  Desarrollo de nuevos m√©todos para su posterior suministro a sistemas externos. </li><li>  Por ejemplo, varios SaaS como jenkins, logstash, etc. </li><li>  Implementaci√≥n de nuevos m√©todos API en un portal existente para propietarios de sistemas de informaci√≥n.  Los usuarios no necesitar√°n pensar en c√≥mo integrarse con el nuevo elemento de infraestructura, solo lo usar√°n como un servicio para obtener nuevos recursos o cambiar los existentes. </li></ul><br><p>  <em>Al final, me gustar√≠a recordarles que las herramientas son excelentes, pero no olviden la importancia de la interacci√≥n entre los diferentes equipos.</em>  <em>Los cambios descritos en el art√≠culo no habr√≠an sido posibles sin una comunicaci√≥n bien establecida y una interacci√≥n constante sobre temas emergentes de todas las partes interesadas.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461891/">https://habr.com/ru/post/461891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461877/index.html">Java vs Kotlin para Android: opiniones de desarrolladores</a></li>
<li><a href="../461879/index.html">El libro "Linux en acci√≥n"</a></li>
<li><a href="../461881/index.html">Gu√≠a de registro de Node.js</a></li>
<li><a href="../461885/index.html">EDS es otro tipo de fraude</a></li>
<li><a href="../461887/index.html">Entrando en Aeronet Episodio 2: Homing Drone</a></li>
<li><a href="../461895/index.html">Aprenda mientras viaja: c√≥mo conducimos el 1er D√≠a Europeo del An√°lisis Empresarial</a></li>
<li><a href="../461897/index.html">C√≥mo mantenemos la estabilidad de la aplicaci√≥n Lamoda</a></li>
<li><a href="../461899/index.html">Event Generation, CQRS y Laravel</a></li>
<li><a href="../461901/index.html">Tres a√±os de autotest: c√≥mo aumentar la velocidad y no solo</a></li>
<li><a href="../461903/index.html">Adversario misterioso: pr√©stamos borrosos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>