<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФе ЁЯАДя╕П ЁЯди рд╣рдо рдХреИрдорд░реЗ рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП DVR рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ PHP рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ ЁЯЪ░ ЁЯС╢ ЁЯСйЁЯП╛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ, рдореИрдВрдиреЗ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджрд┐рдЦрд╛рдиреЗ рдХрд╛ рд╡рд╛рджрд╛ рдХрд┐рдпрд╛ рдерд╛ рдЬреЛ рдХреИрдорд░реЗ рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдЦреАрдВрдЪрддреА рд╣реИ рдФрд░, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕рдордп рдмреАрдд рдЪреБрдХрд╛ рд╣реИ, рд╡рд╛рджреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд╣рдо рдХреИрдорд░реЗ рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП DVR рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ PHP рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/"> <a href="https://habr.com/ru/post/482864/">рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ,</a> рдореИрдВрдиреЗ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджрд┐рдЦрд╛рдиреЗ рдХрд╛ рд╡рд╛рджрд╛ рдХрд┐рдпрд╛ рдерд╛ рдЬреЛ рдХреИрдорд░реЗ рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдЦреАрдВрдЪрддреА рд╣реИ рдФрд░, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕рдордп рдмреАрдд рдЪреБрдХрд╛ рд╣реИ, рд╡рд╛рджреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП рдореИрдВ рдХрд░ рд░рд╣рд╛ рд╣реВрдВред <br><br>  рдпрд╣ рд╕рд┐рд░реНрдл рдЗрддрдирд╛ рд╣реБрдЖ рдХрд┐ рд╕рд░реНрд╡рд░ рд╡реЗрдм рдХреА рджреБрдирд┐рдпрд╛ рдореЗрдВ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХрддрд╛ рдХреЗ рд╕рд╛рде рд╕рдм рдХреБрдЫ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИ, рд▓реЗрдХрд┐рди PHP рдирд╣реАрдВред <br><br>  рдареАрдХ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐, рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ, рдпрд╣ рдорд░рдиреЗ рд╡рд╛рд▓рд╛ рдореЙрдбрд▓, рдореЗрдореЛрд░реА рд▓реАрдХ, рдФрд░ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ PHP рдореЗрдВ рдмреЙрдХреНрд╕ рд╕реЗ рдмрд╛рд╣рд░ рдХреБрдЫ рднреА рдирд╣реАрдВ рд╣реИ рд╕рд┐рд╡рд╛рдп <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_select ()</a> рдФрд░ <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_set_blocking () рдХреЗ</a> ред <br><br>  рдХрд╣реАрдВ рди рдХрд╣реАрдВ, PECL рдкрд░, рдХреБрдЫ рдкреНрд░рдХрд╛рд░ рдХреА <a href="https://pecl.php.net/package/uv">рд▓рд┐рдмреНрдпреВ рд╣реИ</a> , рдЬреЛ рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ рдореВрд▓ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдореВрд▓ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд┐рд░реНрдл рдПрдХ рдЖрд╡рд░рдг рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ рдХреБрдЫ рдЪреБрдиреМрддрд┐рдпрд╛рдВ рджреЗрддрд╛ рд╣реИред  рд╡реИрд╕реЗ рднреА, рдЙрдирдХреЗ рд╕рд╣реА рджрд┐рдорд╛рдЧ рдореЗрдВ рдХреМрди рдРрд╕рд╛ рдХрд░реЗрдЧрд╛? <br><br>  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдо PHP4 рдХреА рджреБрдирд┐рдпрд╛ рдореЗрдВ рд░рд╣рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВ рдФрд░ рдЖрдзреБрдирд┐рдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛рдУрдВ рдореЗрдВ рдереЛрдбрд╝рд╛ рд▓реМрдЯрддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рд╣рд╛рд▓ рдХреЗ рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдЪреАрдЬреЗрдВ рдХреБрдЫ рд╣рдж рддрдХ рдмрджрд▓ рдЧрдИ рд╣реИрдВред  рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <b>ReactPHP</b> рдФрд░ <b>AmPHP</b> рдЬреИрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдЙрдкрдХрд░рдг рд╣реИрдВ, рдЬрд┐рдирдХреЗ рдШрдЯрдХ Node.js рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХрд╡рд░ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдЬрдирд░реЗрдЯрд░ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рд╣рдореЗрдВ <i>async / рдкреНрд░рддреАрдХреНрд╖рд╛ рдХреА</i> рддрд░рд╣ рдПрдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╢реИрд▓реА рдореЗрдВ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдХреЙрд▓рдмреИрдХ рдФрд░ рдХрд┐рд▓реЛрдореАрдЯрд░ рдЪреЗрди рдореЗрдВ рд╕рднреА рдЕрдВрддрд╣реАрди рдХреЙрд▓рдмреИрдХ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдПред <i>)ред рддрдм () рддрдм ()</i> ред <br><br>  рддреЛ рдЕрдм рдРрд╕рд╛ рдХреНрдпреЛрдВ рд╣реИ, рдпрд╣ рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ, Node.js рдХреА рджреБрдирд┐рдпрд╛ рд╕реЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рдХреЛрдИ рдХрд╛рд░реНрдп рдирд╣реАрдВ рд╣реИ рдЬреЛ PHP рд╣рд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЕрднреА рднреА рдХреБрдЫ рд╣реИрдВ, рддреЛ рд╕рдм рдХреБрдЫ рдХреЗрд╡рд▓ рдХреБрдЫ рдЕрд▓рдЧ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ, рди рдХрд┐ рдЕрд╡рд╕рд░реЛрдВ рдХреА рдХрдореАред <br><blockquote>  рд▓реЛрдЧреЛрдВ рдХреЛ рдпрд╣ рдЬрд╛рдирдХрд░ рдЖрд╢реНрдЪрд░реНрдп рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ PHP рдорд╛рдирдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рдм рдХреБрдЫ рд╣реИ рдЬреЛ рд╣рдореЗрдВ рдЗрд╡реЗрдВрдЯ-рд╕рдВрдЪрд╛рд▓рд┐рдд рдФрд░ рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рдо рдЗрд╕ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдХреЗрд╡рд▓ рдореВрд▓ PHP рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреА рд╕реАрдорд╛ рддрдХ рдкрд╣реБрдБрдЪрддреЗ рд╣реИрдВ рдЬрдм рд╣рдо рдЗрд╕реЗ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ IO рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЗ рд▓рд┐рдП рд╣рдЬрд╛рд░реЛрдВ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд╕рд░реНрд╡реЗрдХреНрд╖рдг рдХреЗ рд▓рд┐рдП рдХрд╣рддреЗ рд╣реИрдВред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рднреА, рд╣рд╛рд▓рд╛рдВрдХрд┐ рджреЛрд╖ PHP рдХреЗ рд╕рд╛рде рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╕рд┐рд╕реНрдЯрдо рдЪрдпрди () рдХреЙрд▓ рдЬреЛ рд▓реЛрдб рдмрдврд╝рдиреЗ рдХреЗ рд╕рд╛рде рдЕрдкрдиреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдЧрд┐рд░рд╛рд╡рдЯ рдореЗрдВ рд░реИрдЦрд┐рдХ рд╣реИред <br><br>  <i><a href="https://amphp.org/amp/event-loop/">amphp.org/amp/event-loop</a></i> </blockquote><a name="habracut"></a><br>  рдмреЗрд╢рдХ, рдЙрддреНрдкрд╛рджрди рдореЗрдВ рдЗрд╕ рд╕рдм рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рд╕рд╡рд╛рд▓ рдЕрднреА рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдмрдВрдж рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ, рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЧрд▓рдд рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рдХрд┐ рдХреЛрдИ рдЕрдиреНрдп рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рд░рдирдЯрд╛рдЗрдо рд╡рд╛рддрд╛рд╡рд░рдг рдЖрдкрдХреЛ рдорд╛рдл рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рддреЛ рд╕рдм рдХреБрдЫ рдареАрдХ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред <br><br><h3>  DVRIP </h3><br>  рд╣рдо рдЪреАрдиреА рджреНрд╡рд╛рд░рд╛ рдХрдерд┐рдд рддреМрд░ рдкрд░ рдЖрд╡рд┐рд╖реНрдХрд╛рд░ рдХрд┐рдП рдЧрдП рдПрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВрдЧреЗ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд┐рдЧрд░рд╛рдиреА рдХреИрдорд░реЛрдВ рдХреЗ рд╕рд╛рде рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдХреЛ рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br>  рдпрд╣ рд╕рднреА TCP рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ DVRIP (рдХрднреА-рдХрднреА рд╕реЛрдлрд┐рдпрд╛) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЬрдм рддрдХ рдореБрдЭреЗ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рддрдм рддрдХ рдореБрдЭреЗ рдХреЗрд╡рд▓ рджреЛ рдпрд╛ рдЕрдзрд┐рдХ рд╕реЗрдВрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдорд┐рд▓реАрдВ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдПрдХ рдХреЛ рдЖрдорддреМрд░ рдкрд░ рдХреЗрд╡рд▓ рдХреИрдорд░реЗ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдФрд░ рдХреБрдЫ рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдЖрджрд╛рди-рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдкреИрдХреЗрдЬ рд╣реЗрдбрд░ рд╡рд┐рд╡рд░рдг рдЬрд┐рд╕рдиреЗ рдореБрдЭреЗ рдмрд╣реБрдд рдорджрдж рдХреАред <br><br>  рджреВрд╕рд░реЗ рдХреЛ рдереЛрдбрд╝реА рджреЗрд░ рдмрд╛рдж рдкрд╛рдпрд╛ рдЧрдпрд╛, рдПрдХреНрд╕рд░реНрд╕рд╛рдЗрдЬ рдХреЗ рд╕рдордп рдореЗрд░реЗ рд╕рд┐рдВрдбреНрд░реЛрдо рдХрд╛ рдпрд╣рд╛рдВ рдЖрд╡рд┐рд╖реНрдХрд╛рд░ рдирд╣реАрдВ рд╣реБрдЖ рдерд╛, рдФрд░ рдЗрд╕рдиреЗ рдереЛрдбрд╝рд╛ рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рдЬреЛ рдореБрдЭреЗ рдкрд╕рдВрдж рдЖрдПрдЧрд╛ред <br><br>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдПрдХ рд╕реНрдирд┐рдлрд╝рд░ рдФрд░ рдкреИрдХреЗрдЬ рд╣реЗрдбрд░ рдХреЗ рд╡рд┐рд╡рд░рдг рдХреЗ рд╕рд╛рде рд╕рд╢рд╕реНрддреНрд░, рдореИрдВрдиреЗ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рд╕реНрдХреЗрдЪ рдХрд┐рдпрд╛ рдЬреЛ рдореЗрд░реЗ рд╕рд░реНрд╡рд░ рдкрд░ рдХрд╣реАрдВ рди рдХрд╣реАрдВ рдШреВрдо рд░рд╣рд╛ рд╣реИ, рдФрд░ рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдЕрд╡рдзрд╛рд░рдгрд╛ рдХреЗ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдкреНрд░рдорд╛рдг рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред <br><br>  рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕реНрд╡рдпрдВ рдЬрдЯрд┐рд▓ рдирд╣реАрдВ рд╣реИ рдФрд░ рдкреИрдХреЗрдЬ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: <br><br><ul><li>  20 рдмрд╛рдЗрдЯреНрд╕ рдХреЗ рд╣реЗрдбрд░, рдЬреЛ PHP рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ <br><br><pre><code class="php hljs">unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, $buffer)</code> </pre> </li><li>  рд╣реЗрдбрд░ рдПрдХ рд▓рдВрдмреЗ рд▓реЗрди рд╕рдВрджреЗрд╢ рдХреЗ рдмрд╛рдж рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ рджреЛ рдмрд╛рдЗрдЯреНрд╕ \ x0a \ x00, рдпрд╛ рдмрд╛рдЗрдирд░реА рдбреЗрдЯрд╛ рджреНрд╡рд╛рд░рд╛ рдкреВрд░рдХ рдпрд╛ рддреЛ рдЬрд╕рди рд╣реЛ рд╕рдХрддрд╛ рд╣реИред </li></ul><br>  рд╣рдо рдХреЗрд╡рд▓ рдЬрд╕рди рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рд╣рдо рджреЛрдиреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред <br><br>  рдЙрддреНрддрд░ (рдпрджрд┐ рдпрд╣ рдПрдХ рдкреИрдХреЗрдЬ рд╣реИ рдЬреЛ рдХрд┐ рдЬреМрди рдХреЗ рд╕рд╛рде рд╣реИ) рдЖрдорддреМрд░ рдкрд░ рд╣рдорд╛рд░реЗ рдЕрдиреБрд░реЛрдз рдХреА рд╕рдлрд▓рддрд╛ рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ <b>рд░рд┐рдЯ</b> рдлреАрд▓реНрдб рд╣реЛрддрд╛ рд╣реИред  рдПрдХ <b>рд░рд┐рдЯ</b> рдХреЛрдб рдпреБрдХреНрдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдВ рдЬреЛ <b>100</b> рдпрд╛ <b>515 рдХреЗ</b> рдмрд░рд╛рдмрд░ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдЬрд╛рдирдмреВрдЭрдХрд░ рдЧрд▓рдд рдорд╛рдирд╛ рдЬрд╛рдПрдЧрд╛ред <br><br>  рдЗрд╕ рдмреБрдирд┐рдпрд╛рджреА рдЬреНрдЮрд╛рди рдХреЗ рд╕рд╛рде, рдЪрд▓реЛ рдХреИрдорд░реЗ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ рдФрд░ рд╕рдордЭреЗрдВред <br>  рд╣рдореЗрдВ рджреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - <a href="https://github.com/amphp/socket">рдПрдореНрдлрд╝рдкреА / рд╕реЙрдХреЗрдЯ</a> , рдЬреЛ рд╣рдореЗрдВ рдЬрд╝рд░реВрд░рдд рдХреА рд▓рдЧрднрдЧ рд╣рд░ рдЪреАрдЬрд╝ рдХреЛ <a href="https://github.com/amphp/socket">рдЦреАрдВрдЪ</a> рд▓реЗрдЧрд╛, рдФрд░ <a href="https://packagist.org/packages/evenement/evenement">рд╢рд╛рдо / рд╢рд╛рдо</a> , рдЬреЛ рдХрд┐ рдкреИрдХрдЧрд┐рд╕реНрдЯ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИрдВ рдФрд░ рдХрд┐рд╕реА рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред <br><br>  Amp рдореЗрдВ TCP рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд╣реИ: <br><br><pre> <code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">"tcp://{$addr}:{$port}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($chunk = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $chunk; } $socket-&gt;close(); });</code> </pre> <br>  DVRIP рдЖрдорддреМрд░ рдкрд░ 34567 рдкреЛрд░реНрдЯ рдкрд░ рдЪрд▓рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрд╣ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рд╣реЛрдЧрд╛: <br><br><pre> <code class="php hljs">$socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://192.168.0.200:34567'</span></span>);</code> </pre> <br>  рдЗрд╕рдХреЗ рдмрд╛рдж, рд╣рдо рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢ рдХреЛ рдХреИрдорд░реЗ рдореЗрдВ рднреЗрдЬрдХрд░ рд▓реЙрдЧ рдЗрди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХреА рдЧрдгрдирд╛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рдХреА рдЬрд╛рддреА рд╣реИ: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); }</code> </pre> <br>  рд╕рдлрд▓ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╣рдо рдПрдХ рд╡реАрдбрд┐рдпреЛ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ рдФрд░, рдЕрдЧрд░ рдХреИрдорд░рд╛ рд╣рдореЗрдВ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╣рдо рдЗрд╕реЗ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред <br><br>  рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХрд╛рд░ рдХреЗ рдкреИрдХреЗрдЬ рдХрд╛ рдЕрдкрдирд╛ msgId рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рд╕рдордЭ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдореЗрдВ рдХрд┐рд╕ рдЕрдиреБрд░реЛрдз рдХрд╛ рдЬрд╡рд╛рдм рдорд┐рд▓рд╛ред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдзреВрд▓ рднрд░реА рдиреМрдХрд░реА рдирд╣реАрдВред <br><br>  рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП, рдЖрдЗрдП рдкрд╣рд▓реЗ рд╣рдорд╛рд░реЗ рдкреИрдХреЗрдЬ рдХреЗ рд▓рд┐рдП рдХрдХреНрд╖рд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } }</code> </pre> <br>  рдФрд░ рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЕрдиреБрд░реЛрдз рднреЗрдЬрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ]));</code> </pre> <br>  рд╣рд╛рдБ, рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ред  рд╣рдордиреЗ рдХрдиреЗрдХреНрдЯ рдХрд┐рдпрд╛ рдФрд░ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛, рд▓реЗрдХрд┐рди рд╣рдо рдпрд╣ рднреА рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдХреИрдорд░рд╛ рд╕рд╣реА рдерд╛ рдФрд░ рдХрдо рд╕реЗ рдХрдо рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдЙрд╕ рдкрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЧрдИ рдереАред  рд╣рдореЗрдВ рдХрд┐рд╕реА рддрд░рд╣ рдЙрддреНрддрд░ рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдЪрд▓реЛ рдЗрд╕реЗ рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рд░реВрдк рд╕реЗ рдХрд░рддреЗ рд╣реИрдВ), рдЗрд╕рдореЗрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреИрдХреЗрдЯ рдЪреБрдиреЗрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдбреАрдХреЛрдб рдХрд░реЗрдВред <br><br>  рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдкреИрдХреЗрдЯреЛрдВ рдХреЗ рддрд░реНрдХ рдХреЛ рдХрд┐рд╕реА рддрд░рд╣ рдЕрд▓рдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ <b>рд╢рд╛рдо рдХреЗ</b> рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдФрд░ рдЗрд╕рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╡рд░реНрдЧ рдХреЛ рд╕реНрдХреЗрдЪ рдХрд┐рдпрд╛ рдЬреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдбрд┐рдХреЛрдб рдХрд┐рдП рдЧрдП рдкреИрдХреЗрдЯ рдХреЛ рдлреЗрдВрдХ рджреЗрдЧрд╛ <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  рдФрд░ рд╣рдорд╛рд░реЗ рдкреИрдХреЗрдЯ рд╡рд░реНрдЧ рдореЗрдВ рдХреБрдЫ рд╕реНрдерд┐рд░ рддрд░реАрдХреЛрдВ рдХреЛ рдЬреЛрдбрд╝рд╛, рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдбреЗрдЯрд╛ рд╕реНрдЯреНрд░реАрдо рд╕реЗ рдкреИрдХреЗрдЯ рдХреЛ рдирд┐рдХрд╛рд▓реЗрдВрдЧреЗ рдФрд░ рдбрд┐рдХреЛрдб рдХрд░реЗрдВрдЧреЗред <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; }</code> </pre><br>  рдЕрдм, <b>рдИрд╡рдирдореЗрдВрдЯ</b> рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, рд╣рдо рдлреЙрд░реНрдо рдореЗрдВ рдЕрдкрдиреЗ рддрд░реНрдХ рдХрд╛ рд╡рд░реНрдгрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ <br><br><pre> <code class="php hljs">$reader-&gt;on($packetType, $handler);</code> </pre> <br>  рдФрд░ рдЗрд╕рд▓рд┐рдП рдореБрдЭреЗ рдпрд╣ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдорд┐рд▓реА, рдЬрд╣рд╛рдБ рдореИрдВрдиреЗ рдПрдХ рдФрд░ Keep Alive рдФрд░ SIGINT / SIGTERM рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЬреЛрдбрд╝рд╛: <br><br><pre> <code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout());</code> </pre> <br>  рдпрд╣ рдмрд┐рдирд╛ рдХрд╣реЗ рдЪрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд╕реНрдЯрдбрдЖрдЙрдЯ рдХреЗ рдмрдЬрд╛рдп, рд╣рдо рдЬрд╣рд╛рдВ рдЪрд╛рд╣реЗрдВ, рд╡реАрдбрд┐рдпреЛ рд╕реНрдЯреНрд░реАрдо рдХреЛ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br><div class="spoiler">  <b class="spoiler_title">рдЕрдВрддрд┐рдо рд╕реНрдХреНрд░рд┐рдкреНрдЯ</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Emitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Promise</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">InputStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">IteratorStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Evenement</span></span>\<span class="hljs-title"><span class="hljs-title">EventEmitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">call</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCoroutine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStderr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStdout</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">pipe</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Socket</span></span>\<span class="hljs-title"><span class="hljs-title">connect</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } } Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout()); });</code> </pre> </div></div><br>  рдЕрдм рд╣рдо рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдХрд╛ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд░рд┐рдХреЙрд░реНрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ <br><br><pre> <code class="bash hljs">$ php recorder.php &gt; output.h264</code> </pre> <br>  рд╣рдордиреЗ рдПрдХ SIGINT рд╣реИрдВрдбрд▓рд░ рдЬреЛрдбрд╝рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬрдм рдЖрдк рдердХ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдмрд╕ Ctrl + C рджрдмрд╛рдПрдВ рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╡реАрдбрд┐рдпреЛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХреЛ рд░реЛрдХ рджреЗрдЧрд╛ рдФрд░ рдХрдиреЗрдХреНрд╢рди рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдмрдВрдж рдХрд░ рджреЗрдЧрд╛ред <br><br>  рдФрд░ рд╣рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, ffmpeg рдХреЗ рд▓рд┐рдП рд╕реНрдЯреНрд░реАрдо рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░реЗрдВ рдФрд░ рдордХреНрдЦреА рдкрд░ рдЯреНрд░рд╛рдВрд╕рдХреЛрдб рдХрд░реЗрдВред <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code> </pre> <br>  рдФрд░ рдЖрдк рдлрд╛рд░реНрдо рдХреА рдЙрдиреНрдорддреНрдд рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ...</code> </pre> <br>  рдХрд┐рд╕реА рднреА рддрд░рд╣ рдХреА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде рдпрд╣ рд╕рдм рд╢реБрд░реВ рдХрд░рдирд╛ рдЬреЛ рд╣рд░ рдШрдВрдЯреЗ рд╢реБрд░реВ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ 1 рдШрдВрдЯреЗ рддрдХ рдЪрд▓рдиреЗ рд╡рд╛рд▓реЗ рдЪрд┐рдХрдиреЗ рдЯреБрдХрдбрд╝реЗ рдорд┐рд▓реЗрдВрдЧреЗ, рдЬрд╣рд╛рдВ рднреА рд╣рдореЗрдВ рдЬрд░реВрд░рдд рд╣реЛрдЧреАред <br><br><h3>  рдХреНрдпреЛрдВ? </h3><br>  рдореБрдЭреЗ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╣реИ рдХрд┐ рдпрд╣ рд▓реЗрдЦ "рдХреНрдпреЛрдВ?"  рдХреИрдорд░реЛрдВ рд╕реЗ рдкрдВрдЬреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╕рдорд╛рдзрд╛рди рд╣реИрдВ, рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдХреИрдорд░реЗ рдЦреБрдж рдмрд╣реБрдд рд╕рд╛рд░реЗ рдХрд╛рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЛрдВрдиреЗ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдореЗрдВ рд╕рд╣реА рдЖрдкрддреНрддрд┐ рдХреА рдереА, рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░ рдЗрд╕реЗ рдмрд╣реБрдд рдЖрд╕рд╛рди рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдерд╛ред <br><br>  рдпрд╣ рд╕рд┐рд░реНрдл рдЗрддрдирд╛ рд╣реИ рдХрд┐ рдореЗрд░реЗ рдкрд╛рд╕ рдЦрд╛рд▓реА рд╕рдордп рдерд╛ рдЬреЛ рдореБрдЭреЗ рдХрд╣реАрдВ рдФрд░ рдХрд░рдирд╛ рдерд╛, рдЕрдкрдиреА рддрд░рд╣ рд╕реЗ рдмрдирд╛рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рдФрд░ рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдкрд░рд┐рд╣рд╛рд░реНрдп рд▓рд╛рд▓рд╕рд╛ред <br><br>  рдФрд░ рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред <br><br>  рдмреЗрд╢рдХ, рд▓реЗрдЦ рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдХреБрдЫ рд╕рдВрд╢реЛрдзрдиреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдФрд░ рдЖрдкрдХреЛ рдЗрд╕реЗ рдЗрд╕ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП - рдореИрдВ рджреЛрд╣рд░рд╛рддрд╛ рд╣реВрдВ, рдпрд╣ рдЕрд╡рдзрд╛рд░рдгрд╛ рдХрд╛ рдкреНрд░рдорд╛рдг рд╣реИред  рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдореИрдВ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдШрд░ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдШреБрдЯрдиреЗ рд╕реЗ рдКрдВрдЪреЗ рдШрд░ рд╕реЗ рдмрдиреЗ рдЙрддреНрдкрд╛рджреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХрдбрд╝реА рдЪреЗрддрд╛рд╡рдиреА рджреЗрддрд╛ рд╣реВрдВред <br>  рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛ рдЗрддрдиреА рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╡рд┐рдХрд▓реНрдк рдХрд╛рдо рдХрд░реЗрдЧрд╛ред  рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд░ рдирдЬрд░ рд░рдЦрдиреЗ рд╡рд╛рд▓рд╛ рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд░ рдХрддрд╛рдИ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬреЛ рдзрд╛рд░рд╛ рдХреЛ ffmpeg рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдШрдВрдЯреЗ рджреНрд╡рд╛рд░рд╛ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рд░рд┐рдХреЙрд░реНрдб рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╡реАрдХреЗ рдкрд░ рдЕрдкрд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдПрдХ рдбрд┐рд╕реНрдХрдиреЗрдХреНрд╢рди рдпрд╛ рдХреБрдЫ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдШрдЯрдирд╛рдУрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рддрд╛ рд╣реИред <br><br>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдпрд╣ рд╕рдм рдЯреАрд╕реАрдПрд╕ рдкрд░ рдЖрд░рдЯреАрдПрд╕рдкреА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡реАрдбрд┐рдпреЛ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рдиреЗ рд╕реЗ рдмрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдерд╛, рдЬреИрд╕рд╛ рдХрд┐ рдореИрдВрдиреЗ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╕реБрдЭрд╛рд╡ рджрд┐рдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди ffmpeg рдиреЗ рд╕рдордп рдкрд░ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдХреНрд╖рдг рдореЗрдВ рдореВрд░реНрдЦрддрд╛рдкреВрд░реНрдг рд╕реНрдЯрд╛рд▓ рдХреЛ рдкрд╕рдВрдж рдХрд┐рдпрд╛ рдФрд░ рдХреЗрд╡рд▓ SIGKILL рдХреЛ рдЬрд╡рд╛рдм рджреЗрдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛ред <br><br>  рдореБрдЭреЗ рд╕рдВрджреЗрд╣ рд╣реЛрдиреЗ рд▓рдЧрд╛ рдХрд┐ рдпрд╣ рд╕рдм рдЗрд╕рд▓рд┐рдП рдерд╛ рдХреНрдпреЛрдВрдХрд┐ рдкреИрд░реЗрдВрдЯ рд╕реНрдХреНрд░рд┐рдкреНрдЯ-рд╡реЙрдЪ рдХреЛ рдореБрдХреБрдЯ рджреНрд╡рд╛рд░рд╛ рдЪрд▓рд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ рдЙрд╕реЗ рдХрдо рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдорд┐рд▓реА рдереА, рд▓реЗрдХрд┐рди рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдмрдврд╝рдиреЗ рд╕реЗ рд╕рдорд╕реНрдпрд╛ рдХреА рдЖрд╡реГрддреНрддрд┐ рдХрдо рд╣реЛ рдЧрдИред <br><br>  рдЙрдкрд░реЛрдХреНрдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕рдм рдХреБрдЫ рдмрд╣реБрдд рдЕрдзрд┐рдХ рд╕реНрдерд┐рд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрднреА рддрдХ рдХрд┐рд╕реА рднреА рд╢рд┐рдХрд╛рдпрдд рдХреЛ рдирд╣реАрдВ рдЙрдард╛рдпрд╛ рд╣реИред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi484518/">https://habr.com/ru/post/hi484518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi484502/index.html">рдлреЗрд╕рдмреБрдХ рдореЙрдбрд░реЗрдЯрд░реНрд╕ рдХреЛ рдЕрдкрдиреЗ рдХрд╛рдо рдХреЗ рдШрдВрдЯреЗ рдХреЛ рджреВрд╕рд░реЗ рддрдХ рдкрд╣реБрдВрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рддрд╛ рд╣реИ - рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдЯреЙрдпрд▓реЗрдЯ рддрдХ рднреА</a></li>
<li><a href="../hi484504/index.html">$ 10 рд╕реЗ рдХрдо рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдпрд░ рдЖрдпрдирд╛рдЗрдЬрд╝рд░ рдмрдирд╛рдирд╛</a></li>
<li><a href="../hi484506/index.html">рдореИрдВ рдПрдХ рдлреЛрдЯреЛрдЧреНрд░рд╛рдлрд░ рд╣реВрдВ рдФрд░ рдореИрдВ рдЦреБрдж рдХреЛ рдПрдХ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдЙрдкрдХрд░рдг рдмрдирд╛рдКрдВрдЧрд╛</a></li>
<li><a href="../hi484512/index.html">рд╢реАрд░реНрд╖ 25 рд╕рдмрд╕реЗ рдмрдбрд╝реЗ рдЖрдИрд╕реАрдУ: рдЕрдм рдЙрдирдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдорд╛рдорд▓рд╛ рд╣реИ?</a></li>
<li><a href="../hi484514/index.html">рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рд░реВрдЯрд┐рдВрдЧ</a></li>
<li><a href="../hi484520/index.html">рдЬрд╝рд┐рдк рдЖрд░реНрдХрд╛рдЗрд╡ рдХреИрд╕рд╛ рджрд┐рдЦрддрд╛ рд╣реИ рдФрд░ рд╣рдо рдЗрд╕рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рднрд╛рдЧ 3 - рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧ</a></li>
<li><a href="../hi484522/index.html">DEFCON рд╕рдореНрдореЗрд▓рди 27. рдкреБрд▓рд┐рд╕ рдХреЛ рд╣реИрдХ рдХрд░реЗрдВред рднрд╛рдЧ реи</a></li>
<li><a href="../hi484526/index.html">Android рдкрд░ рдЪрд▓рдиреЗ рдХреЗ рд▓рд┐рдП SDL2 рдкреНрд░реЛрдЬреЗрдХреНрдЯ рддреИрдпрд╛рд░ рдХрд░рдирд╛</a></li>
<li><a href="../hi484528/index.html">рдореИрдВрдиреЗ рдЕрдкрдиреЗ рд╣реЙрдмреА рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЛ k8s рдореЗрдВ рдХреИрд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛</a></li>
<li><a href="../hi484530/index.html">рдкреЙрд▓рд┐рдорд░ рд╕рд╛рдордЧреНрд░реА рдХреЗ рдкреНрд▓рд╛рдЬреНрдорд╛ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг / рд╕рдВрд╢реЛрдзрди рдХреЗ рд▓рд┐рдП рд╕реАрдПрдирд╕реА рдорд╢реАрди</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>