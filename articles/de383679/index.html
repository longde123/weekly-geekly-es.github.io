<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧕🏿 💓 🙍 Schnelles Zuhause Smart Home ✍🏼 📵 🚁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Master Kit-Module teilen weiterhin Lösungen mit uns : 
 „Als Experiment habe ich mich hier entschlossen, schnell und zu minimalen Kosten eine Art„ Sma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schnelles Zuhause Smart Home</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/masterkit/blog/383679/"><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master Kit-Module</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> teilen weiterhin Lösungen mit uns </font><font style="vertical-align: inherit;">: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
„Als Experiment habe ich mich hier entschlossen, schnell und zu minimalen Kosten eine Art„ Smart Home “-Prototyp herzustellen. </font><font style="vertical-align: inherit;">Es gab viele Hoteliers: Licht, Belüftung, Fenster, Wasser und IR-Steuerung von Elektrogeräten. </font><font style="vertical-align: inherit;">Zunächst beschloss ich, mich auf ein Minimum an Aufgaben zu beschränken: Belüftung und Beleuchtung im Raum.</font></font><br>
<br>
<img src="https://habrastorage.org/files/d29/3ba/b3c/d293bab3c8e74a03bd2efc794bd85b98.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das System basierte auf dem Arduino Uno mit der Fähigkeit, vier Pins unabhängig voneinander zu steuern, und mehreren drahtlosen Steuermodulen aus dem Master Kit: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einkanal-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweikanal-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Relais </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">MP3328</font></a><font style="vertical-align: inherit;"> und </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">MP3330</font></a><font style="vertical-align: inherit;"> übernahmen die Rolle von Exekutivgeräten </font><font style="vertical-align: inherit;">, und die Signale werden über einen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Achtkanal-</font></a><font style="vertical-align: inherit;"> Sender an sie übertragen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MP3329</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bei einer Frequenz von 433 MHz. </font></font><br>
<br>
<img src="https://habrastorage.org/files/245/9e3/4a0/2459e34a025d4ed7b82eba1b1de97bd9.jpg" width="270"> <img src="https://habrastorage.org/files/325/1f5/709/3251f5709c59488cbd440baa8fbd6f0d.jpg" width="270"> <img src="https://habrastorage.org/files/a8b/ffa/657/a8bffa657e7848aaa1fd046a3a72302f.jpg" width="270"><br>
<br>
<img src="https://habrastorage.org/files/130/dc8/2ac/130dc82ac36446b2b3684ae3083a3e8c.JPG"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf dem MP3330 ich die Kontrolle über zwei LED - </font><font style="vertical-align: inherit;">Streifen über das Sofa, aufgehängt - eine gemütliche Hintergrundbeleuchtung für den </font><font style="vertical-align: inherit;">Abend zu </font><font style="vertical-align: inherit;">lesen, - und auf der MP3328 - die Steuerung eines </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servo Maschine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zum Öffnen / Schließen des Fensters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe die Antriebsstruktur aus improvisierten Materialien gebaut, nämlich aus den Teilen des LEGO Designers.</font></font><br>
<br>
<img src="https://habrastorage.org/files/5ca/73a/92f/5ca73a92faab408c9c18cf7f83584240.JPG"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, und natürlich reichte mir eine einfache Funksteuerung nicht aus: Ich brauchte Zugriff auf das gesamte System über eine Weboberfläche und eine Echtzeit-Statusüberwachung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Speicherressource habe ich Standard-MySQL verwendet, in dem ich aus Sicherheitsgründen eine Tabelle mit den Kennungen der Controller, Pins und dem Statuswert der einzelnen Steuerungen erstellt habe, wobei jeder eine gemeinsame Systemkennung zugeordnet wurde. Außerdem habe ich die Möglichkeit, einen festen Timer zum Ändern des Status einzustellen, fest verdrahtet, und dafür ist auch ein Feld vorgesehen. </font></font><br>
<br>
<img src="https://habrastorage.org/files/0cd/a7b/c0c/0cda7bc0c4334f88b1108a9d681cc18a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Arbeit mit Web-Sockets war Arduino leicht fehlerhaft, und es war keine Zeit, die Gründe herauszufinden. Deshalb habe ich es auf einfache Weise skizziert: mit Ajax-Anfragen alle 100 ms. Dies ist natürlich katastrophal für den Verkehr (fast 30 MB pro Tag), aber für eine Wohnung mit unbegrenztem Internet reicht es zum ersten Mal aus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das einfachste Webinterface: 4 Tasten, eine für jeden Pin. </font><font style="vertical-align: inherit;">Durch einmaliges Drücken wird der Status geändert, und durch langes Drücken wird der Timer (ich habe bisher 3 Minuten fest verdrahtet) eingestellt, um ihn zu ändern. </font></font><br>
<br>
<img src="https://habrastorage.org/files/292/562/4a3/2925624a3e8a49b1af311f0997925b99.JPG" width="250"> <img src="https://habrastorage.org/files/642/449/4f3/6424494f306c41178c9b57e4698aa83c.JPG" width="250"> <img src="https://habrastorage.org/files/02e/c67/b48/02ec67b48735456d9793e36837b50dbe.JPG" width="250"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen lautet die vereinfachte Version der Logik wie folgt: Die </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webschnittstelle greift auf den Server zu und überprüft den Status der Steuerungen. Anschließend wird die Schnittstelle für die Arbeit mit dem System angezeigt: 4 Schaltflächen im entsprechenden Status:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skripte</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">$.ajax({
			<span class="hljs-attr">url</span>: <span class="hljs-string">'engine/ajax.php'</span>,
			<span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
			<span class="hljs-attr">dataType</span>: <span class="hljs-string">'json'</span>,
			<span class="hljs-attr">data</span>: {<span class="hljs-attr">action</span>: <span class="hljs-string">'getStates'</span>},<font></font>
		})<font></font>
		.done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			<span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> data.success){
				<span class="hljs-keyword">var</span> controller = data.success[key];
				<span class="hljs-keyword">if</span>($(<span class="hljs-string">'.btn#btn_'</span> + controller.id).length === <span class="hljs-number">0</span>){<font></font>
					html = <span class="hljs-string">''</span>;<font></font>
					html += <span class="hljs-string">'&lt;div '</span>;
					<span class="hljs-keyword">if</span> (controller.timer_switch &gt; <span class="hljs-number">0</span>){
						<span class="hljs-keyword">var</span> seconds = <span class="hljs-number">60</span>  - (controller.timer_switch % <span class="hljs-number">60</span>)<font></font>
						html += <span class="hljs-string">'seconds="'</span> + seconds + <span class="hljs-string">'"'</span>;<font></font>
					}<font></font>
					html += <span class="hljs-string">'id="btn_'</span> + controller.id + <span class="hljs-string">'" class="btn" state="'</span> + controller.state + <span class="hljs-string">'"&gt;&lt;div class="btn_timer"&gt;&lt;/div&gt;&lt;/div&gt;'</span>;<font></font>
					$(<span class="hljs-string">'#btn_placer'</span>).append(html);<font></font>
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">if</span> (controller.state == <span class="hljs-number">1</span>){<font></font>
						$(<span class="hljs-string">'.btn#btn_'</span> + controller.id).removeClass(<span class="hljs-string">'btn_off'</span>).addClass(<span class="hljs-string">'btn_on'</span>);<font></font>
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (controller.state == <span class="hljs-number">0</span>){<font></font>
						$(<span class="hljs-string">'.btn#btn_'</span> + controller.id).removeClass(<span class="hljs-string">'btn_on'</span>).addClass(<span class="hljs-string">'btn_off'</span>);<font></font>
					}<font></font>
					<span class="hljs-keyword">if</span> (controller.timer_switch &gt; <span class="hljs-number">0</span>){
						<span class="hljs-keyword">var</span> seconds = <span class="hljs-number">60</span> - controller.timer_switch % <span class="hljs-number">60</span>;
						<span class="hljs-keyword">var</span> minutes = <span class="hljs-built_in">Math</span>.floor(controller.timer_switch / <span class="hljs-number">60</span>);<font></font>
						$(<span class="hljs-string">'.btn#btn_'</span> + controller.id).addClass(<span class="hljs-string">'seconds'</span>).css(<span class="hljs-string">'background-position'</span>, (-seconds * <span class="hljs-number">100</span>) + <span class="hljs-string">'px 0px'</span>).find(<span class="hljs-string">'.btn_timer'</span>).text(minutes + <span class="hljs-string">'M'</span>);<font></font>
					} <span class="hljs-keyword">else</span> {<font></font>
						$(<span class="hljs-string">'.btn#btn_'</span> + controller.id).css(<span class="hljs-string">'background-position'</span>, <span class="hljs-string">'0px 0px'</span>).removeClass(<span class="hljs-string">'seconds'</span>).find(<span class="hljs-string">'.btn_timer'</span>).text(<span class="hljs-string">''</span>);<font></font>
					}<font></font>
				}<font></font>
			}<font></font>
			setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
				getStates();<font></font>
			}, <span class="hljs-number">1000</span>);<font></font>
		})<font></font>
		.fail(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error'</span>);<font></font>
		});<font></font>
<font></font>
</code></pre><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStates</span>(<span class="hljs-params">$sql</span>)</span>{<font></font>
	$result = $sql-&gt;query(<span class="hljs-string">"SELECT * FROM `controllers` WHERE `home_id` = '1' ORDER BY `order`"</span>);
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($result-&gt;rows)){<font></font>
		$result = $result-&gt;rows;<font></font>
		<span class="hljs-keyword">foreach</span> ($result <span class="hljs-keyword">as</span> $key =&gt; $value) {
			<span class="hljs-keyword">if</span> (strtotime($result[$key][<span class="hljs-string">'timer'</span>]) &gt; <span class="hljs-number">-62169990000</span>){
				<span class="hljs-comment">// echo strtotime($result[$key]['timer']);</span>
				$timer_switch = strtotime($result[$key][<span class="hljs-string">'timer'</span>]) - strtotime(date(<span class="hljs-string">"Y-m-d H:i:s"</span>));<font></font>
				$result[$key][<span class="hljs-string">'timer_switch'</span>] = $timer_switch;
				<span class="hljs-keyword">if</span> ($timer_switch &lt; <span class="hljs-number">0</span>){<font></font>
					$sql-&gt;query(<span class="hljs-string">"UPDATE `controllers` SET `state` = '"</span>.$result[$key][<span class="hljs-string">'timer_state'</span>].<span class="hljs-string">"', `timer` = '0000-00-00 00:00:00', `timer_state` = '' WHERE `id` = '"</span>.$result[$key][<span class="hljs-string">'id'</span>].<span class="hljs-string">"'"</span>);<font></font>
				}<font></font>
			}<font></font>
		}<font></font>
		$res[<span class="hljs-string">'success'</span>] = $result;<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		$res[<span class="hljs-string">'error'</span>] = <span class="hljs-string">' '</span>;<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> $res;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die entsprechende Schaltfläche gedrückt wird, wird eine POST-Anforderung an die Datei ajax.php gesendet:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javascript</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">$(<span class="hljs-built_in">document</span>).on(<span class="hljs-string">'mousedown'</span>, <span class="hljs-string">'.btn'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)</span>{<font></font>
			event.preventDefault();<font></font>
			<span class="hljs-keyword">var</span> id = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'id'</span>).replace(<span class="hljs-string">'btn_'</span>, <span class="hljs-string">''</span>));<font></font>
			click_wait = <span class="hljs-literal">false</span>;<font></font>
			mousetimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
				click_wait = <span class="hljs-literal">true</span>;<font></font>
				setTimer(id);	<font></font>
			}, <span class="hljs-number">2000</span>);<font></font>
		});<font></font>
<font></font>
		$(<span class="hljs-built_in">document</span>).on(<span class="hljs-string">'mouseup'</span>, <span class="hljs-string">'.btn'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
			clearTimeout(mousetimer);<font></font>
			<span class="hljs-keyword">if</span> (!click_wait){
				<span class="hljs-keyword">var</span> id = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'id'</span>).replace(<span class="hljs-string">'btn_'</span>, <span class="hljs-string">''</span>));<font></font>
				switchController(id);<font></font>
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'click !!!'</span>);<font></font>
				click_wait = <span class="hljs-literal">false</span>;<font></font>
			}<font></font>
		});<font></font>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchController</span>(<span class="hljs-params">id</span>)</span>{
		<span class="hljs-keyword">var</span> el = $(<span class="hljs-string">'.btn#btn_'</span> + id);
		<span class="hljs-keyword">var</span> state = <span class="hljs-built_in">parseInt</span>($(el).attr(<span class="hljs-string">'state'</span>));
		<span class="hljs-keyword">var</span> need_state;
		<span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>){<font></font>
			need_state = <span class="hljs-number">1</span>;<font></font>
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state == <span class="hljs-number">1</span>){<font></font>
			need_state = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
		$(el).addClass(<span class="hljs-string">'waiting'</span>);<font></font>
		$.ajax({<font></font>
			<span class="hljs-attr">url</span>: <span class="hljs-string">'engine/ajax.php'</span>,
			<span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
			<span class="hljs-attr">dataType</span>: <span class="hljs-string">'json'</span>,
			<span class="hljs-attr">data</span>: {<span class="hljs-attr">action</span>: <span class="hljs-string">'setState'</span>, <span class="hljs-attr">id</span>: id, <span class="hljs-attr">state</span>: state, <span class="hljs-attr">need_state</span>: need_state},<font></font>
		})<font></font>
		.done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			<span class="hljs-keyword">if</span> (data.success == <span class="hljs-string">'ok'</span>){<font></font>
				$(el).attr(<span class="hljs-string">'state'</span>, need_state);<font></font>
				$(el).removeClass(<span class="hljs-string">'waiting'</span>).removeClass(<span class="hljs-string">'btn_on'</span>).removeClass(<span class="hljs-string">'btn_off'</span>);
				<span class="hljs-keyword">if</span>(need_state == <span class="hljs-number">1</span>){<font></font>
					$(el).addClass(<span class="hljs-string">'btn_on'</span>);<font></font>
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(need_state == <span class="hljs-number">0</span>){<font></font>
					$(el).addClass(<span class="hljs-string">'btn_off'</span>);<font></font>
				}<font></font>
			}<font></font>
		})<font></font>
		.fail(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error'</span>);<font></font>
		});<font></font>
	}<font></font>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTimer</span>(<span class="hljs-params">id</span>)</span>{
		<span class="hljs-keyword">var</span> el = $(<span class="hljs-string">'.btn#btn_'</span> + id);
		<span class="hljs-keyword">var</span> state = <span class="hljs-built_in">parseInt</span>($(el).attr(<span class="hljs-string">'state'</span>));
		<span class="hljs-keyword">var</span> need_state;
		<span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>){<font></font>
			need_state = <span class="hljs-number">1</span>;<font></font>
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state == <span class="hljs-number">1</span>){<font></font>
			need_state = <span class="hljs-number">0</span>;<font></font>
		}<font></font>
		$(el).attr(<span class="hljs-string">'seconds'</span>, <span class="hljs-number">0</span>);<font></font>
		$(el).addClass(<span class="hljs-string">'seconds'</span>);<font></font>
		$.ajax({<font></font>
			<span class="hljs-attr">url</span>: <span class="hljs-string">'engine/ajax.php'</span>,
			<span class="hljs-attr">type</span>: <span class="hljs-string">'POST'</span>,
			<span class="hljs-attr">dataType</span>: <span class="hljs-string">'json'</span>,
			<span class="hljs-attr">data</span>: {<span class="hljs-attr">action</span>: <span class="hljs-string">'setTimer'</span>, <span class="hljs-attr">id</span>: id, <span class="hljs-attr">state</span>: state, <span class="hljs-attr">need_state</span>: need_state},<font></font>
		})<font></font>
		.done(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{<font></font>
		})<font></font>
		.fail(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'error'</span>);<font></font>
		});<font></font>
	}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Variablen-ID übergeben wir den Bezeichner des Controllers und im Variablenstatus den Wert seines Status. </font><font style="vertical-align: inherit;">In der Datei ajax.php erhalten wir eine POST-Anfrage und fügen die neuen Daten in die Datensatzwerte der entsprechenden ID ein.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Php</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setState</span>(<span class="hljs-params">$sql</span>)</span>{<font></font>
	$need_state = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'need_state'</span>];<font></font>
	$state = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'state'</span>];<font></font>
	$id = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'id'</span>];<font></font>
<font></font>
	$result = $sql-&gt;query(<span class="hljs-string">"UPDATE `controllers` SET `state` = '"</span>.$need_state.<span class="hljs-string">"', `timer` = '0000-00-00 00:00:00' WHERE `id` = '"</span>.$id.<span class="hljs-string">"'"</span>);
	<span class="hljs-comment">//   Arduino</span>
	$result = $sql-&gt;query(<span class="hljs-string">"SELECT `state` FROM `controllers` WHERE `id` = '"</span>.$id.<span class="hljs-string">"'"</span>);
	<span class="hljs-keyword">if</span> ($need_state == $result-&gt;row[<span class="hljs-string">'state'</span>]){<font></font>
		$res[<span class="hljs-string">'success'</span>] = <span class="hljs-string">'ok'</span>;<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		$res[<span class="hljs-string">'success'</span>] = <span class="hljs-string">'err'</span>;<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> $res;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTimer</span>(<span class="hljs-params">$sql</span>)</span>{<font></font>
	$need_state = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'need_state'</span>];<font></font>
	$state = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'state'</span>];<font></font>
	$id = (<span class="hljs-keyword">int</span>)$_POST[<span class="hljs-string">'id'</span>];<font></font>
<font></font>
	$result = $sql-&gt;query(<span class="hljs-string">"UPDATE `controllers` SET `timer` = NOW() + INTERVAL 3 MINUTE, `timer_state` = '"</span>.$need_state.<span class="hljs-string">"' WHERE `id` = '"</span>.$id.<span class="hljs-string">"'"</span>);
	<span class="hljs-comment">//   Arduino</span>
	$result = $sql-&gt;query(<span class="hljs-string">"SELECT `state` FROM `controllers` WHERE `id` = '"</span>.$id.<span class="hljs-string">"'"</span>);
	<span class="hljs-keyword">if</span> ($need_state == $result-&gt;row[<span class="hljs-string">'state'</span>]){<font></font>
		$res[<span class="hljs-string">'success'</span>] = <span class="hljs-string">'ok'</span>;<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		$res[<span class="hljs-string">'success'</span>] = <span class="hljs-string">'err'</span>;<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> $res;<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arduino wiederum greift über Ethernet auf den Webserver zu, überprüft den eindeutigen Systemschlüssel, die Controller-Werte, analysiert die empfangene Zeichenfolge und wechselt die Pin-Werte. </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Php</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'key'</span>]) &amp;&amp; $_GET[<span class="hljs-string">'key'</span>] !== <span class="hljs-string">''</span>){<font></font>
		$key = $_GET[<span class="hljs-string">'key'</span>];<font></font>
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">die</span>;<font></font>
	}<font></font>
	<font></font>
$key = $sql-&gt;escape($key);<font></font>
	$result = $sql-&gt;query(<span class="hljs-string">"SELECT * FROM `controllers` WHERE `home_id` = '1' AND `key` = '"</span>.$key.<span class="hljs-string">"' ORDER BY `order`"</span>);
	<span class="hljs-keyword">foreach</span> ($result-&gt;rows <span class="hljs-keyword">as</span> $key =&gt; $value) {
		<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'id'</span>] == <span class="hljs-string">'1'</span>){
			<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'1'</span>){<font></font>
				$ar .= <span class="hljs-string">'Q'</span>;<font></font>
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'0'</span>) {<font></font>
				$ar .= <span class="hljs-string">'q'</span>;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'id'</span>] == <span class="hljs-string">'2'</span>){
			<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'1'</span>){<font></font>
				$ar .= <span class="hljs-string">'W'</span>;<font></font>
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'0'</span>) {<font></font>
				$ar .= <span class="hljs-string">'w'</span>;<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'id'</span>] == <span class="hljs-string">'3'</span>){
			<span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'1'</span>){<font></font>
				$ar .= <span class="hljs-string">'E'</span>;<font></font>
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($value[<span class="hljs-string">'state'</span>] == <span class="hljs-string">'0'</span>) {<font></font>
				$ar .= <span class="hljs-string">'e'</span>;<font></font>
			}<font></font>
		}<font></font>
	}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach wird eine Zeile der Form „% qUerTY“ in eine Skizze übertragen, in der sie abhängig von fest verdrahteten Regeln analysiert wird: Jeder Buchstabe entspricht seiner PIN-Nummer, und das Register ist für den Endwert verantwortlich: Großbuchstaben - 1, Kleinbuchstaben - 0.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino</font></font></b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readData</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">if</span> (led_connect){<font></font>
    digitalWrite(<span class="hljs-number">6</span>, HIGH);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    digitalWrite(<span class="hljs-number">6</span>, LOW);<font></font>
  }<font></font>
  digitalWrite(<span class="hljs-number">4</span>, LOW);<font></font>
  previousMillis = currentMillis;<font></font>
  <font></font>
  led_connect = !led_connect;<font></font>
    <span class="hljs-keyword">while</span> (client.available()){      
      <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">char</span> c = client.read()) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'Q'</span>:<font></font>
          digitalWrite(<span class="hljs-number">9</span>, HIGH);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'q'</span>:<font></font>
          digitalWrite(<span class="hljs-number">9</span>, LOW);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'W'</span>:<font></font>
          digitalWrite(<span class="hljs-number">8</span>, HIGH);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'w'</span>:<font></font>
          digitalWrite(<span class="hljs-number">8</span>, LOW);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'E'</span>:<font></font>
          digitalWrite(<span class="hljs-number">7</span>, HIGH);<font></font>
          myservo.write(<span class="hljs-number">0</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'e'</span>:<font></font>
          digitalWrite(<span class="hljs-number">7</span>, LOW);<font></font>
          myservo.write(<span class="hljs-number">180</span>);
          <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können Werte von 0 bis 180 (Drehpunkte) an den für die Servomaschine zuständigen Pin und beispielsweise an den Dimmer übertragen - bis zu 255. Ich habe immer noch zwei Werte: 0 oder 1. </font></font><br>
<br>
<img src="https://habrastorage.org/files/141/631/8c6/1416318c6a664a5d90e299894b6ba46f.JPG"><br>
<br>
<img src="https://habrastorage.org/files/059/b6c/c6a/059b6cc6ad224f8eab3ece4bdd303d0e.JPG"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab keine Probleme beim Anschließen der Module: beide Die Relais werden einmal mit dem Sender gekoppelt, ohne dass eine erneute Bindung erforderlich ist, und erfüllen ihre Aufgabe perfekt. </font></font><br>
<br>
<img src="https://habrastorage.org/files/239/123/1e0/2391231e0f7646f9ab352d321dee4703.JPG"><br>
<br>
<img src="https://habrastorage.org/files/61b/5d3/aea/61b5d3aea1c24afd91ce04fbb1895af5.JPG"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber mit der Kraft der Servomaschine habe ich mich ein wenig verrechnet: Ich habe 6 kg genommen - was im Allgemeinen ausreicht, um den Fensterflügel, den er unter seinem eigenen Gewicht öffnete, abzudecken und loszulassen -, aber es ist besser, etwas Stärkeres anzunehmen bei starkem Wind oder Zugluft. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen ist der Spielraum für Kreativität unbegrenzt: Sie können beispielsweise Sensoren anschließen, z. B. CO2 oder Temperatur, und das Fenster öffnen / schließen, wenn bestimmte Indikatoren erreicht sind.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich habe ich vor, das gesamte System auf Web-Sockets umzuschreiben, um Anforderungen zu vereinfachen - und die Übertragung und Analyse von Parameterwerten flexibler zu gestalten. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skizze für Arduino</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Kleines Video </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hintergrundbeleuchtung</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/W4LJ5nh4K9U%3Ffeature%3Doembed&amp;usg=ALkJrhjPk7335v0v0ZjU6TPZWlJHu8L3bA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fenster öffnen</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/dpH-pXnNcS4%3Ffeature%3Doembed&amp;usg=ALkJrhjWUGKfFZbHGW9eflnzM9_2lCcZtA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kuznetsov "</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de383679/">https://habr.com/ru/post/de383679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de383669/index.html">Präsentation neuer Lenovo Produkte in Berlin</a></li>
<li><a href="../de383671/index.html">LISA Pathfinder Space Telescope Startbereit</a></li>
<li><a href="../de383673/index.html">DEXP Ixion Energy Test: Flaggschiff-Smartphone mit einem Rekord-5000-mAh-Akku und Power Bank-Funktion</a></li>
<li><a href="../de383675/index.html">Wie auf Yulmart, um Zugang zu den Einkäufen von Organisationen nicht durch ein Loch, sondern durch eine Tür zu erhalten</a></li>
<li><a href="../de383677/index.html">Autos für Musikliebhaber</a></li>
<li><a href="../de383681/index.html">Warum kann die Autobatterie nicht in der USV verwendet werden?</a></li>
<li><a href="../de383683/index.html">Terminator namens Anushka: Überprüfung des bb-mobile Techno 7.85 3G M785AN Metalltabletts</a></li>
<li><a href="../de383685/index.html">Xperia Z5, Z5 Compact und Z5 Premium. Erste Details</a></li>
<li><a href="../de383689/index.html">Fliegende Autos - eine radikale Lösung für das Problem der Überlastung</a></li>
<li><a href="../de383691/index.html">Marsillusionen und irdische Wahnvorstellungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>