<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüåæ üëºüèΩ üë©üèª‚Äç‚úàÔ∏è Analyse de la porte d√©rob√©e de Turla Cybergroup Outlook üêá üì• üà¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla (Snake, Uroboros) est un groupe de cyberespionnage qui a acquis sa renomm√©e en 2008 apr√®s avoir pirat√© des objets prot√©g√©s, y compris le r√©seau ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse de la porte d√©rob√©e de Turla Cybergroup Outlook</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421399/"><p>  Turla (Snake, Uroboros) est un groupe de cyberespionnage qui a acquis sa renomm√©e en 2008 apr√®s avoir pirat√© des objets prot√©g√©s, y compris le r√©seau du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Commandement central des forces arm√©es am√©ricaines</a> .  Depuis, il se sp√©cialise dans les attaques contre les installations militaires et les agences diplomatiques du monde entier.  Les victimes c√©l√®bres incluent le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">minist√®re des Affaires √©trang√®res de Finlande</a> en 2013, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">soci√©t√© de d√©fense suisse RUAG</a> de 2014 √† 2016.  et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le gouvernement allemand</a> fin 2017 - d√©but 2018. </p><br><p>  Apr√®s le dernier incident, plusieurs m√©dias ont publi√© des informations sur les m√©thodes des attaquants - en utilisant des pi√®ces jointes aux e-mails pour contr√¥ler les logiciels malveillants et transf√©rer les donn√©es vol√©es du syst√®me.  Cependant, aucune information technique n'a √©t√© fournie sur la porte d√©rob√©e.  Dans ce rapport, nous publions l'analyse de la porte d√©rob√©e Turla, qui a √©t√© g√©r√©e √† l'aide de pi√®ces jointes PDF par e-mail. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l_/db/ws/l_dbws8skuoavwqn1vorwdhobgo.jpeg"></div><a name="habracut"></a><br><p>  Selon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les m√©dias</a> , plusieurs ordinateurs du minist√®re allemand des Affaires √©trang√®res ont √©t√© infect√©s par une porte d√©rob√©e.  Apparemment, l'attaque a commenc√© en 2016 et a √©t√© d√©couverte par les services de s√©curit√© fin 2017. Initialement, les assaillants ont compromis l'√©cole secondaire f√©d√©rale d'administration publique (Hochschule des Bundes), apr√®s quoi ils ont p√©n√©tr√© √† l'int√©rieur de son r√©seau jusqu'√† ce qu'ils aient acc√®s au r√©seau du minist√®re des Affaires √©trang√®res en mars 2017. .  Les op√©rateurs Turla ont eu acc√®s √† certaines donn√©es confidentielles (par exemple, le courrier √©lectronique des employ√©s du minist√®re allemand des Affaires √©trang√®res) pendant environ un an. </p><br><p>  Notre enqu√™te r√©v√®le √©galement que ce malware ciblant Microsoft Outlook a √©t√© utilis√© contre divers services politiques et militaires.  Nous nous sommes assur√©s que les minist√®res des Affaires √©trang√®res des deux autres pays europ√©ens et le principal entrepreneur de la d√©fense √©taient √©galement compromis.  Notre enqu√™te nous a permis d'√©tablir des dizaines d'adresses e-mail enregistr√©es par les op√©rateurs Turla pour cette campagne et utilis√©es pour obtenir des donn√©es de victimes exfiltr√©es. </p><br><h2>  1. Points cl√©s </h2><br><p>  La porte d√©rob√©e Outlook de Turla Group a deux fonctions. </p><br><p>  Premi√®rement, c'est le vol de lettres sortantes qui sont transmises √† l'attaquant.  Affecte principalement Microsoft Outlook, mais concerne √©galement The Bat!, Populaire en Europe de l'Est. </p><br><p>  Deuxi√®mement, l'utilisation des lettres comme couche de transport de son protocole C&amp;C.  Les fichiers demand√©s via la commande de porte d√©rob√©e sont exfiltr√©s dans des documents PDF sp√©cialement cr√©√©s en tant que pi√®ce jointe aux lettres.  Les commandes de porte d√©rob√©e sont √©galement envoy√©es dans des pi√®ces jointes PDF.  Cela permet le secret.  Il est important de noter que les attaquants n'exploitent aucune vuln√©rabilit√© dans les lecteurs PDF ou Microsoft Outlook.  Un logiciel malveillant peut d√©coder les donn√©es des documents PDF et les interpr√©ter comme des commandes. </p><br><p>  Les objectifs de la campagne sont typiques de Turla.  Nous avons identifi√© plusieurs agences gouvernementales europ√©ennes et entreprises de d√©fense compromises par cette porte d√©rob√©e.  Il est probable que les attaquants l'utilisent pour assurer la persistance dans les r√©seaux √† acc√®s restreint, o√π des pare-feu bien configur√©s ou d'autres outils de s√©curit√© r√©seau bloquent efficacement les communications traditionnelles avec les serveurs C&amp;C via HTTP (S).  La figure ci-dessous r√©pertorie les lignes de code de porte d√©rob√©e qui mentionnent certains domaines de premier niveau du gouvernement.  mfa est le domaine du minist√®re des Affaires √©trang√®res, .gouv est un sous-domaine du gouvernement fran√ßais (.gouv.fr), ocse est l'Organisation pour la s√©curit√© et la coop√©ration en Europe. </p><br><img src="https://habrastorage.org/webt/xt/ix/e9/xtixe9vxop-os9ktobaea5qqdbu.png"><br><p>  <i>Figure 1. Domaines associ√©s aux services publics trouv√©s dans le code Malvari</i> </p><br><p>  Sur la base des donn√©es d'analyse et de t√©l√©m√©trie, nous avons constat√© que cette porte d√©rob√©e est distribu√©e dans la nature depuis au moins 2013.  Comme toujours avec Turla, nous ne pouvons pas nous concentrer sur les horodatages de compilation, car ils sont g√©n√©ralement falsifi√©s.  Cependant, nous pensons que les premi√®res versions ont √©t√© compil√©es avant 2013, car la version de cette ann√©e √©tait d√©j√† assez avanc√©e.  Apr√®s cela, nous avons trouv√© une version plus similaire √† celle de base, dont la compilation √©tait dat√©e de 2009.  Il n'est pas encore possible de d√©terminer la date de sortie exacte.  La chronologie ci-dessous est bas√©e sur notre t√©l√©m√©trie et les donn√©es de sources ouvertes: </p><br><p>  <b>2009</b> : horodatage de la compilation (peut-√™tre faux) de la version de base de la porte d√©rob√©e Outlook.  Seul instantan√© du contenu de l'e-mail. <br>  <b>2013</b> : am√©lior√©: la porte d√©rob√©e peut ex√©cuter des commandes.  Ils sont envoy√©s par e-mail au format XML. <br>  <b>2013</b> : La derni√®re version connue destin√©e √† The Bat! .. <br>  <b>2016</b> : am√©lior√©: les √©quipes sont envoy√©es sous forme de pi√®ces jointes dans des documents PDF sp√©cialement cr√©√©s. <br>  <b>2017</b> : Am√©lior√©: Une porte d√©rob√©e est capable de cr√©er des documents PDF pour exfiltrer des donn√©es par un attaquant. <br>  <b>Mars 2018</b> : Pr√©sentation d'un compromis sur le r√©seau du gouvernement allemand. <br>  <b>Avril 2018</b> : am√©lior√©: Backdoor peut ex√©cuter des commandes PowerShell √† l'aide d'Empire PSInject. </p><br><h2>  2. Architecture globale </h2><br><p>  Dans les versions r√©centes, la porte d√©rob√©e est une DLL autonome, dans laquelle il existe du code pour l'auto-installation et l'interaction avec Outlook et The Bat!, Clients de messagerie, m√™me si seule l'installation pour Outlook est impl√©ment√©e.  Il peut facilement √™tre supprim√© par n'importe quel composant Turla qui vous permet d'effectuer des processus suppl√©mentaires. </p><br><p>  Dans cette section, notre analyse est bas√©e sur un √©chantillon diffus√© au premier semestre 2017.  Des informations sur des √©chantillons plus anciens ou plus r√©cents peuvent √™tre incluses. </p><br><h3>  2.1.  L'installation </h3><br><p>  Pour √©tablir une porte d√©rob√©e, les attaquants exportent une DLL appel√©e Installer ou l'enregistrent avec regsvr32.exe.  L'argument est le client de messagerie cible.  La figure ci-dessous montre les valeurs possibles.  Dans les derni√®res versions, seule l'installation pour Outlook est impl√©ment√©e. </p><br><img src="https://habrastorage.org/webt/9g/8r/qm/9g8rqm3z7keq_phkhvlztwzwtyo.png"><br><p>  <i>Figure 2. Arguments d'installation possibles</i> </p><br><p>  Puisqu'il n'y a pas de chemin cod√© en dur, le fichier DLL peut √™tre situ√© n'importe o√π sur le disque. </p><br><h4>  2.1.1.  Microsoft Outlook </h4><br><p>  Les d√©veloppeurs Turla s'appuient sur le d√©tournement d'objets COM pour garantir la persistance des logiciels malveillants.  Il s'agit d'une m√©thode bien connue utilis√©e dans la nature depuis de nombreuses ann√©es, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notamment par le groupe Turla</a> .  L'essence de la m√©thode consiste √† rediriger l'objet COM utilis√© par l'application cible en modifiant l'entr√©e CLSID correspondante dans le registre Windows. </p><br><p>  Dans notre cas, les modifications suivantes ont √©t√© apport√©es au registre Windows: </p><br><pre><code class="hljs powershell">HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>} = Mail Plugin HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32 = [<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-type"><span class="hljs-type">to</span></span> <span class="hljs-type"><span class="hljs-type">the</span></span> <span class="hljs-type"><span class="hljs-type">backdoor</span></span> <span class="hljs-type"><span class="hljs-type">DLL</span></span>] HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32\ThreadingModel = Apartment HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">84</span></span>DA0A92<span class="hljs-literal"><span class="hljs-literal">-25E0</span></span><span class="hljs-literal"><span class="hljs-literal">-11D3</span></span><span class="hljs-literal"><span class="hljs-literal">-B9F7</span></span><span class="hljs-literal"><span class="hljs-literal">-00C04F4C8F5D</span></span>}\TreatAs = {<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}</code> </pre> <br><p>  <code>{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}</code> - CLSID captur√©.  Il correspond au gestionnaire de protocole Outlook et, en th√©orie, charge la DLL Outlook <code>OLMAPI32.DLL</code> l√©gitime.  <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> associ√© √† aucun logiciel connu.  Ce CLSID est arbitraire et n'est utilis√© que comme espace r√©serv√© pour la redirection COM. </p><br><p>  Une fois la modification termin√©e, la DLL de porte d√©rob√©e sera charg√©e √† chaque fois qu'Outlook charge son objet COM.  Selon nos observations, cela se produit lors du d√©marrage d'Outlook. </p><br><p>  La redirection COM ne n√©cessite pas de droits d'administrateur, car elle s'applique uniquement √† l'utilisateur actuel.  Des mesures de protection sont en place pour emp√™cher de telles redirections malveillantes.  Selon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MSDN</a> : ¬´Avec Windows Vista et Windows Server 2008, si le niveau d'int√©grit√© du processus est sup√©rieur √† la moyenne, le runtime COM ignore la configuration COM de l'utilisateur et acc√®de uniquement √† la configuration COM pour chaque machine.¬ª </p><br><p>  Le processus Outlook s'ex√©cute avec une int√©grit√© moyenne, comme indiqu√© dans l'image ci-dessous.  Par cons√©quent, il n'est pas prot√©g√© contre le transfert COM pour chaque utilisateur. </p><br><img src="https://habrastorage.org/webt/q4/uq/zt/q4uqzt_g3c6vgonoluf_7ttrqpw.png"><br><p>  <i>Figure 3. Niveau d'int√©grit√© du processus Outlook</i> </p><br><p>  Enfin, l'utilisation de la capture d'objets COM permet √† la porte d√©rob√©e d'√©viter la d√©tection, car le chemin d'acc√®s √† la porte d√©rob√©e ( <code>C:\Users\User\Documents\mapid.tlb</code> dans notre exemple) n'appara√Æt pas dans la liste des plugins, comme le montre la figure suivante. </p><br><img src="https://habrastorage.org/webt/4l/cj/s3/4lcjs3tai1gd5gopfekwd7skjra.png"><br><p>  <i>Figure 4. Liste des plugins Outlook - mapid.tlb n'appara√Æt pas</i> </p><br><p>  M√™me si le programme malveillant n'appara√Æt pas dans la liste des modules compl√©mentaires, l'API Microsoft standard - MAPI (Messaging Application Programming Interface) est utilis√©e pour interagir avec Outlook. </p><br><h4>  2.1.2.  La chauve-souris! </h4><br><p>  Comme indiqu√© dans la chronologie, les derni√®res versions de la porte d√©rob√©e n'incluent plus le code d'enregistrement pour le plugin The Bat! .. Cependant, tout le code de gestion des bo√Ætes aux lettres et des messages existe toujours.  Si n√©cessaire, il peut √™tre configur√© manuellement. </p><br><p>  Pour vous inscrire en tant que plugin pour The Bat!  le logiciel malveillant a modifi√© le <code>%appdata%\The Bat!\Mail\TBPlugin.INI</code> .  C'est un moyen l√©gitime d'enregistrer un plugin pour The Bat!, Certains plugins (par exemple, antispam) l'utilisent √©galement. </p><br><p>  Apr√®s vous √™tre inscrit √† chaque fois que vous d√©marrez The Bat!  la DLL de porte d√©rob√©e est appel√©e.  La figure ci-dessous montre comment la DLL impl√©mente l'exportation requise pour les plugins. </p><br><img src="https://habrastorage.org/webt/xq/x7/zs/xqx7zsv5pwjjmhonegcsmpmnwx0.png"><br><p>  <i>Figure 5. Exportation standard pour le plugin Bat!</i> </p><br><h3>  2.2.  Interaction avec le client de messagerie </h3><br><p>  L'interaction avec le client de messagerie d√©pend de l'objectif. </p><br><h4>  2.2.1.  Microsoft Outlook </h4><br><p>  Microsoft prend en charge la Messaging Application Programming Interface (MAPI), qui permet aux applications d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interagir avec Outlook</a> .  La porte d√©rob√©e Turla utilise cette API pour acc√©der et g√©rer les bo√Ætes aux lettres d'un utilisateur / d'utilisateurs d'un syst√®me compromis. </p><br><p>  Tout d'abord, la porte d√©rob√©e se connecte au syst√®me de messagerie √† l'aide de MAPILogonEx, comme illustr√© dans la figure. </p><br><img src="https://habrastorage.org/webt/nf/fp/u1/nffpu1duhw9u7rmxytdm1chwpey.png"><br><p>  <i>Figure 6. Connexion MAPI</i> </p><br><p>  Le deuxi√®me param√®tre (lpszProfileName) est vide, l'indicateur <code>MAPI_USE_DEFAULT</code> est <code>MAPI_USE_DEFAULT</code> .  Selon la documentation: "Le sous-syst√®me de messagerie doit remplacer le nom de profil par d√©faut pour le param√®tre lpszProfileName. L'indicateur <code>MAPI_EXPLICIT_PROFILE</code> ignor√© sauf si lpszProfileName est NULL ou vide." </p><br><p>  En revanche, l'indicateur <code>MAPI_NEW_SESSION</code> pas d√©fini.  Selon la documentation: ¬´Le param√®tre <code>lpszProfileName</code> ignor√© s'il existe une session pr√©c√©dente appel√©e MapiLogonEx avec l'indicateur <code>MAPI_ALLOW_OTHERS</code> et si l'indicateur <code>MAPI_NEW_SESSION</code> pas d√©fini.¬ª </p><br><p>  √Ä notre avis, Outlook ouvre une session par d√©faut avec l'indicateur <code>MAPI_ALLOW_OTHERS</code> .  Ainsi, la porte d√©rob√©e utilisera une session pr√©c√©demment ouverte pour acc√©der au profil par d√©faut de la bo√Æte aux lettres.  Cela explique l'absence de demande de nom d'utilisateur et de mot de passe lors de l'initialisation du plugin de porte d√©rob√©e. </p><br><p>  Cela fait, la porte d√©rob√©e aura acc√®s √† la bo√Æte aux lettres et pourra facilement la g√©rer √† l'aide d'autres fonctions MAPI.  Il parcourra plusieurs magasins de messages, analysera les lettres et ajoutera des rappels aux messages entrants et sortants.  Le fichier journal affiche ce processus (nom d'utilisateur et adresse modifi√©s): </p><br><pre> <code class="hljs pgsql">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ========= Analyzing msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Service <span class="hljs-type"><span class="hljs-type">name</span></span>:MSUPST MS Pst <span class="hljs-type"><span class="hljs-type">path</span></span>:C:\Users\[username]\Documents\Outlook Files\[email address].pst Wait main <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> count = <span class="hljs-number"><span class="hljs-number">46</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> message store PUSH store <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> list &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _____________ FOLDERS _____________ Setting sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> folders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> stores. ========Process msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Account: [email address] Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Outbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store. Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Inbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store.</code> </pre> <br><p>  Il configure un rappel dans chaque bo√Æte de r√©ception et bo√Æte d' <code>HrAllocAdviseSink</code> √† l'aide de la fonction <code>HrAllocAdviseSink</code> , comme indiqu√©. </p><br><img src="https://habrastorage.org/webt/ud/df/js/uddfjs5ub7qj9n3gxlxslirppcq.png"><br><p>  <i>Figure 7. Enregistrement d'un rappel dans la bo√Æte d'envoi</i> </p><br><p>  <b>2.2.1.1.</b>  <b>Bo√Æte de r√©ception de rappel</b> </p><br><p>  Le rappel dans la bo√Æte de r√©ception enregistre les m√©tadonn√©es du message entrant, y compris les adresses des exp√©diteurs et des destinataires, les noms des sujets et des pi√®ces jointes.  Exemple ci-dessous (orthographe de d√©veloppeur enregistr√©e): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">RECIVE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt;{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: sender@example.com To: receiver@example.net Cc: Bcc: Subj: Mail subject Att: an_attachment.pdf }</code> </pre> <br><p>  Il analyse ensuite la lettre et les pi√®ces jointes au sujet des √©quipes des attaquants.  Cette fonction est d√©crite dans la section 2.3. </p><br><p>  Enfin, il intercepte les rapports de non-remise en v√©rifiant les messages entrants avec l'adresse e-mail de l'op√©rateur.  Toute lettre contenant l'adresse de l'op√©rateur sera refus√©e.  Cela peut entra√Æner des probl√®mes si la victime soup√ßonne que quelque chose ne va pas et contacte le service d'assistance sans voir les r√©ponses. </p><br><p>  <b>2.2.1.2.</b>  <b>Rappel dans la bo√Æte d'envoi</b> </p><br><p>  Comme dans la bo√Æte de r√©ception, la bo√Æte d'envoi enregistre les m√©tadonn√©es de tous les e-mails envoy√©s.  L'enregistrement suivant est g√©n√©r√© (l'adresse de l'op√©rateur a chang√©): </p><br><pre> <code class="hljs css">21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEND</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: To: recipient@example.com Cc: Bcc: Subj: My title Att: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"last_presentation.pdf"</span></span> } 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sending</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENTRYID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Message ENTRYID]</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">send</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[redacted]</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmx</span></span>[.]<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> From: Subj: My title <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Set last time. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Spawned thread for cleaning up outgoing messages (id <span class="hljs-number"><span class="hljs-number">2848</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Ending work, client: Outlook <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of messages to remove: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Message ENTRYID: [Message ENTRYID] <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> DeleteMessages executed successfully. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of not removed messages: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Vous remarquerez peut-√™tre qu'il transmet tous les messages sortants √† l'adresse des attaquants, <code>[‚Ä¶]@gmx[.]com</code> .  GMX - un service de messagerie gratuit populaire;  les attaquants l'ont probablement choisi, car les organisations ne bloquent g√©n√©ralement pas le domaine gmx.com. </p><br><p>  Cette adresse e-mail est cod√©e en dur dans l'√©chantillon que nous avons √©tudi√©, comme le montre l'image ci-dessous.  Cependant, il peut √™tre mis √† jour √† l'aide de l'une des fonctions de porte d√©rob√©e.  Les attaquants semblent enregistrer au moins une adresse e-mail pour chaque cible <br>  les organisations utilisant le format <code>firstname.lastname@gmx[.]com</code> avec le nom du v√©ritable employ√©.  Cela √©vite la d√©tection, car il est souvent difficile de distinguer une telle adresse de la bo√Æte aux lettres personnelle d'un v√©ritable employ√©.  Au moment de l'analyse des √©chantillons en juin 2018, l'adresse n'√©tait pas disponible. </p><br><img src="https://habrastorage.org/webt/9c/tr/-d/9ctr-dcusp0p35kcuhiqw4pypns.png"><br><p>  <i>Figure 8. Adresse cod√©e en dur des op√©rateurs</i> </p><br><p>  La porte d√©rob√©e envoie des rapports √† l'adresse des op√©rateurs √† certains intervalles.  Le rapport comprend des identificateurs uniques, y compris l'adresse MAC, le fichier journal complet et les r√©sultats des commandes, le cas √©ch√©ant.  Ensuite, il crypte les donn√©es √† l'aide de MISTY1, comme d√©crit plus en d√©tail dans la section 2.3.2.2, et cr√©e un fichier PDF valide avec un contenu crypt√©.  Avant ce blob de donn√©es crypt√©es, le document contient une image blanche 1x1 en jpeg, cod√©e en dur dans un programme malveillant.  Cela vous permet de cr√©er un PDF valide qui, une fois ouvert, n'affiche qu'une seule page vierge. </p><br><p>  Enfin, la porte d√©rob√©e joint le PDF et envoie un e-mail aux attaquants.  La figure ci-dessous est un exemple de fichier PDF cr√©√© par une porte d√©rob√©e. </p><br><img src="https://habrastorage.org/webt/d4/6f/yx/d46fyxd9n7e-ziu9jwjxdtedqke.png"><br><p>  <i>Figure 9. D√©but d'un document PDF cr√©√© par une porte d√©rob√©e pour exfiltrer des donn√©es</i> </p><br><p>  Le rapport est envoy√© √† l'aide de la fonction de rappel dans la bo√Æte d'envoi.  Cela signifie que la lettre quittera en m√™me temps que l'envoi de messages d'utilisateurs l√©gitimes.  La porte d√©rob√©e ne peut pas envoyer de lettres contenant des donn√©es vol√©es √† un moment inhabituel pour l'utilisateur et √©vite donc la d√©tection.  Gr√¢ce √† la furtivit√©, ce m√©canisme de contr√¥le et de contr√¥le est tr√®s difficile √† d√©tecter dans la nature. </p><br><h4>  2.2.2.  D√©guisement d'un comportement d'utilisateur malveillant </h4><br><p>  √âtant donn√© que la porte d√©rob√©e agit lorsque l'utilisateur travaille avec l'ordinateur et Outlook, le logiciel malveillant tente de masquer les activit√©s malveillantes, par exemple les messages entrants des op√©rateurs. </p><br><p>  Tout d'abord, une porte d√©rob√©e supprime toujours le courrier envoy√© ou re√ßu des op√©rateurs.  Comme le montre la figure ci-dessous, pendant quelques secondes, vous pouvez voir qu'un nouveau message est apparu, mais qu'il n'appara√Æt pas dans la bo√Æte aux lettres. </p><br><img src="https://habrastorage.org/webt/o7/pc/wh/o7pcwhrtwemk2qfqrfdtgjb6p0o.png"><br><p>  <i>Figure 10. Message non lu</i> </p><br><p>  Deuxi√®mement, la porte d√©rob√©e intercepte la <code>CreateWindowsEx</code> , comme illustr√© dans les figures ci-dessous.  Cela emp√™che la cr√©ation de fen√™tres telles que NetUIHWND qu'Outlook utilise pour les notifications qui apparaissent dans le coin inf√©rieur droit de l'√©cran. </p><br><img src="https://habrastorage.org/webt/7y/wn/xq/7ywnxqshbevin9-ncsw8lhprkvo.png"><br><p>  <i>Figure 11. Configuration de la capture de la fonction CreateWindowsEx</i> </p><br><img src="https://habrastorage.org/webt/ki/1_/zr/ki1_zrks5vaspkm-bpz2j-z9asu.png"><br><p>  <i>Figure 12. Interception de CreateWindowsEx</i> </p><br><p>  La figure ci-dessous montre un exemple de la fen√™tre NetUIHWND, qui s'affiche g√©n√©ralement sur le bureau lorsqu'un nouveau message est re√ßu.  √Ä la suite de l'interception de <code>CreateWindowEx</code> , une notification ne s'affiche pas lorsque les attaquants envoient une lettre √† la porte d√©rob√©e. </p><br><img src="https://habrastorage.org/webt/bd/5n/3b/bd5n3bq_pijmhlosvf6muvjcyjq.png"><br><p>  <i>Figure 13. Notification de nouveau message</i> </p><br><h4>  2.2.3.  La chauve-souris! </h4><br><p>  Malgr√© le fait que la fonction d'enregistrement du plugin pour The Bat!  n'existe plus, il existe du code h√©rit√© qui ex√©cute les m√™mes fonctions que pour Outlook √† l'aide de l'API The Bat !. </p><br><p>  Comme le montre la figure suivante, la porte d√©rob√©e utilise le canal de communication avec The Bat! Pour recevoir des informations utilisateur, lire et envoyer des lettres.  Cependant, toutes les autres fonctions, par exemple, utilis√©es pour consigner des messages ou ex√©cuter des commandes, sont identiques √† Outlook. </p><br><img src="https://habrastorage.org/webt/iy/qb/ub/iyqbubrelp4uwudy8n4gby7n6lq.png"><br><p>  <i>Figure 14. Le canal Bat!</i> </p><br><h3>  2.3.  Porte d√©rob√©e </h3><br><p>  Comme indiqu√© dans la section pr√©c√©dente, les logiciels malveillants peuvent traiter et filtrer les messages.  En m√™me temps, il s'agit d'une porte d√©rob√©e enti√®rement fonctionnelle pilot√©e par e-mail qui peut fonctionner ind√©pendamment de tout autre composant Turla.  La porte d√©rob√©e n'a pas besoin d'une connexion Internet permanente et peut fonctionner sur n'importe quel ordinateur qui envoie des messages √† des adresses externes.  Ceci est utile dans les r√©seaux strictement contr√¥l√©s, par exemple, en utilisant le filtrage du trafic Internet.  De plus, m√™me si l'adresse e-mail des attaquants est inactive, ils peuvent reprendre le contr√¥le en envoyant une commande √† partir d'une adresse diff√©rente.  Dans ce cas, la lettre sera √©galement cach√©e √† l'utilisateur, car elle contiendra des commandes interpr√©t√©es par la porte d√©rob√©e.  Ainsi, une porte d√©rob√©e est aussi tol√©rante aux pannes qu'un rootkit qui v√©rifie le trafic r√©seau entrant. </p><br><h4>  2.3.1.  Format pdf </h4><br><p>  D√©but 2018, plusieurs m√©dias ont d√©clar√© que les op√©rateurs Turla utilisent des pi√®ces jointes pour g√©rer les ordinateurs infect√©s.  Les m√©dias avaient raison.  Une analyse de la porte d√©rob√©e de Turla Outlook a r√©v√©l√© comment il envoie et interpr√®te les commandes. </p><br><p>  Les commandes sont envoy√©es par courrier √©lectronique √† l'aide de pi√®ces jointes PDF sp√©cialement cr√©√©es.  Nous n'avons pas pu trouver un v√©ritable exemple de PDF avec des commandes, mais ce sont probablement des documents PDF valides, ainsi que des fichiers PDF cr√©√©s par la porte d√©rob√©e pour l'exfiltration. </p><br><p>  √Ä partir de documents PDF, une porte d√©rob√©e peut restaurer ce que les op√©rateurs appellent un conteneur dans les magazines.  Il s'agit d'un objet blob avec un format sp√©cial qui contient des commandes chiffr√©es pour la porte d√©rob√©e.  La figure ci-dessous montre la proc√©dure de retrait de ce conteneur.  Techniquement, l'application ne doit pas √™tre un document PDF valide.  La seule exigence est qu'il inclut le conteneur dans le format correct. </p><br><img src="https://habrastorage.org/webt/hb/r_/yf/hbr_yfy47qewou5f_tqbrpdn5ck.png"><br><p>  <i>Figure 15. Extraction du conteneur de commandes du PDF</i> </p><br><p>  Le conteneur a une structure complexe avec de nombreux contr√¥les diff√©rents.  Il pourrait √™tre con√ßu pour √©viter les erreurs de communication, mais nous pensons que la structure a √©t√© cr√©√©e principalement pour contrer l'ing√©nierie inverse.  La structure du conteneur est illustr√©e dans la figure ci-dessous. </p><br><img src="https://habrastorage.org/webt/ud/aa/6w/udaa6wvubnjskhmfrgsoalfke70.png"><br><p>  <i>Figure 16. Structure du conteneur de commandes</i> </p><br><p>  Imm√©diatement avant le vecteur d'initialisation, il y a une liste de descripteurs de commandes.  Diff√©rentes valeurs d'ID sont pr√©sent√©es dans le tableau: </p><br><img src="https://habrastorage.org/webt/jy/sg/5o/jysg5opuoyhwir5hre-xi9quhxq.png"><br><p><br>  Les descripteurs d'ID 2 et 4 sont utilis√©s pour extraire les fonctions de chiffrement et de d√©compression, comme illustr√© dans la figure suivante.  Cependant, le programme malveillant impl√©mente un seul algorithme de chiffrement et un algorithme de compression.  Ainsi, le seul but de ces champs est de compliquer l'analyse de la porte d√©rob√©e. </p><br><img src="https://habrastorage.org/webt/h8/sh/gu/h8shgunmwafcbx6h1shccn9-ndo.png"><br><p>  <i>Figure 17. Fonctions de d√©compression et de d√©cryptage d√©cal√©es</i> </p><br><p>  Les √©quipes sont dans la derni√®re partie de la structure.  Ils sont chiffr√©s √† l'aide de MISTY1 et compress√©s avec bzip2.  Il peut y avoir de nombreuses commandes diff√©rentes dans le m√™me fichier PDF, et chacune peut avoir plusieurs arguments. </p><br><h4>  2.3.2.  Cryptographie </h4><br><p>  Nous d√©crivons ici les algorithmes de chiffrement utilis√©s. </p><br><p>  <b>2.3.2.1.</b>  <b>Chiffrement XOR</b> </p><br><p>  Une partie du conteneur (en commen√ßant par le premier CRC32) est chiffr√©e avec XOR avec le flux d'octets g√©n√©r√© par la fonction d√©finie par l'utilisateur.  Il faut une graine, qui est pass√©e √† <code>srand</code> pour g√©n√©rer un deuxi√®me nombre en appelant rand.  La deuxi√®me valeur de d√©part est utilis√©e dans la fonction illustr√©e ci-dessous comme argument pour les donn√©es dans XOR. </p><br><pre> <code class="hljs powershell">int __usercall F_bytestream_xor<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;eax&gt;(unsigned int len<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;edx&gt;, int ciphertext<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;ecx&gt;, unsigned int seed) { unsigned int v3; // ebx int v4; // esi unsigned int v5; // edi int result; // eax unsigned int v7; // ecx char *v8; // edx unsigned int v9; // esi byte key[<span class="hljs-number"><span class="hljs-number">512</span></span>]; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">204</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] char *v11; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] v3 = len; v11 = (char *)ciphertext; srand(seed); v4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; v5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = rand(); *(_DWORD *)&amp;key[<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-type"><span class="hljs-type">v5</span></span>++] = result; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v5 &lt; <span class="hljs-number"><span class="hljs-number">128</span></span> ); v7 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; v8 = v11; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { v8[<span class="hljs-type"><span class="hljs-type">v7</span></span>] ^= key[<span class="hljs-type"><span class="hljs-type">v4</span></span>]; v9 = v4 + <span class="hljs-number"><span class="hljs-number">1</span></span>; result = -(v9 &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>); v4 = result &amp; v9; ++v7; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v7 &lt; v3 ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  <strong>2.3.2.2.</strong>  <strong>MISTY1</strong> </p><br><p>  Les d√©veloppeurs Turla pr√©f√®rent utiliser des algorithmes de cryptage moins courants ou modifi√©s dans leurs backdoors: </p><br><ul><li>  en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">carbone et serpent</a> - CAST-128 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gazer</a> - impl√©mentation RSA personnalis√©e </li><li>  dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mosquito</a> - Blum Blum Shub comme g√©n√©rateur de nombres al√©atoires pour le flux d'octets XOR </li><li>  dans le rootkit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Uroburos</a> - une version modifi√©e de ThreeFish </li></ul><br><p>  Dans la porte d√©rob√©e d'Outlook, ils ont impl√©ment√© MISTY1, un algorithme de chiffrement sym√©trique d√©velopp√© par les cryptographes Mitsubishi Electric en 1995.  Il a les propri√©t√©s suivantes: </p><br><ul><li>  est sym√©trique </li><li>  a une cl√© de 128 bits </li><li>  utilise deux tables pr√©calcul√©es: s7 (128 octets) et s9 (2048 octets) </li><li>  utilise trois fonctions: FL, FO, FI <br>  o FL effectue certaines op√©rations XOR entre l'√©criture d'octets et la cl√© √©tendue <br>  o FO effectue des op√©rations XOR entre l'enregistrement et la cl√© √©tendue, et utilise √©galement FI <br>  o FI effectue une expansion non lin√©aire en utilisant s7 et s9 </li><li>  fonctionne avec des blocs de 64 bits </li><li>  effectue huit cycles (cycle - appeler la fonction FO) </li><li>  utilise le chiffrement Feistel </li></ul><br><img src="https://habrastorage.org/webt/jf/d4/_i/jfd4_iplej2iexnsc2pkxkeracy.png"><br><p>  <em>Figure 18. MISTY1</em> </p><br><img src="https://habrastorage.org/webt/08/qc/_h/08qc_hxb2xju1yxbfsqmizuocwy.png"><br><p>  <em>Figure 19. Huit cycles pour le chiffrement par bloc</em> </p><br><p>  Les d√©veloppeurs de Turla ont l√©g√®rement modifi√© l'algorithme: </p><br><ul><li>  a ajout√© deux op√©rations XOR √† la fonction FI comme indiqu√© dans la figure ci-dessous </li><li>  Une cl√© de 128 bits est g√©n√©r√©e √† partir de deux cl√©s de 1024 bits cod√©es en dur et d'un vecteur d'initialisation de 2048 bits </li><li>  chang√© les tables s7 et s9.  Cela perturbe le fonctionnement de tous les outils qui reconnaissent les algorithmes cryptographiques bas√©s sur les valeurs de la table s.  Les tables S modifi√©es et originales contiennent les m√™mes valeurs, elles ont simplement √©t√© m√©lang√©es </li></ul><br><img src="https://habrastorage.org/webt/74/ge/qg/74geqg_tqugk_mgizdhn07hrcp0.png"><br><p>  <em>Figure 20. Comparaison des fonctions FI (original √† gauche, d√©veloppement Turla √† droite)</em> </p><br><h4 id="233-funkcii">  2.3.3.  Les fonctions </h4><br><p>  La porte d√©rob√©e a de nombreuses fonctions, de l'exfiltage de fichiers √† l'ex√©cution de commandes.  La description des diff√©rentes fonctions est pr√©sent√©e dans le tableau ci-dessous. </p><br><img src="https://habrastorage.org/webt/zk/ij/od/zkijodwltfd9en0cxuya189_758.png"><br><p><br>  Pour la fonction 0x29, les d√©veloppeurs Turla ont copi√© le code du projet Empire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PSInject</a> .  Cela vous permet d'ex√©cuter du code PowerShell dans un fichier ex√©cutable sp√©cial appel√© PowerShell Runner sans appeler <code>powershell.exe</code> .  Le principal avantage est que le malware peut toujours ex√©cuter les commandes PowerShell m√™me si le fichier <code>powershell.exe</code> est verrouill√© sur un ordinateur compromis. </p><br><p>  Apr√®s avoir analys√© la porte d√©rob√©e, nous avons pu cr√©er un document PDF qui peut √™tre interpr√©t√© avec succ√®s par un programme malveillant.  La figure suivante montre l'ex√©cution de MessageBox et le lancement de la calculatrice ( <code>calc.exe</code> ) apr√®s qu'Outlook a re√ßu un e-mail contenant ce PDF.  Cela d√©montre que la porte d√©rob√©e, probablement destin√©e √† recevoir des commandes dans des pi√®ces jointes PDF, est fonctionnelle et peut √™tre contr√¥l√©e par quiconque comprend ce format personnalis√©. </p><br><img src="https://habrastorage.org/webt/-t/xc/lr/-txclr3f050ahxdxykqgnimnr5g.png"><br><p>  <em>Figure 21. Ex√©cution des commandes sp√©cifi√©es dans le document PDF</em> </p><br><h3 id="24-dopolnitelnye-funkcii">  2.4.  Fonctions suppl√©mentaires </h3><br><p>  En plus des capacit√©s de porte d√©rob√©e impl√©ment√©es en tant que plug-in pour le client de messagerie, le malware a d'autres fonctions. </p><br><h4 id="241-virtualnaya-faylovaya-sistema">  2.4.1.  Syst√®me de fichiers virtuel </h4><br><p>  Le programme malveillant n'utilise aucun fichier de configuration, mais prend en charge un petit syst√®me de fichiers virtuel dans la <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> registre Windows <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> .  D'autres backdoors Turla, comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gazer</a> , stockent √©galement le syst√®me de fichiers virtuel dans le registre Windows.  Nous avons pu d√©terminer certaines valeurs de registre, comme indiqu√© dans le tableau suivant. </p><br><img src="https://habrastorage.org/webt/gi/g-/wt/gig-wt39jwfeznw0kpe7qjzvhpm.png"><br><h4 id="242-zhurnaly">  2.4.2.  Magazines </h4><br><p>  Comme mentionn√© pr√©c√©demment, le programme enregistre un journal, qui est r√©guli√®rement envoy√© √† l'op√©rateur par e-mail dans un document PDF sp√©cialement cr√©√©.  Il est stock√© dans <code>%appdata%/Microsoft/Windows/scawrdot.db</code> et est chiffr√© √† l'aide d'une cl√© XOR cod√©e en dur de 512 octets.  Le fichier journal est effac√© apr√®s chaque exfiltration vers les op√©rateurs.  Ainsi, lors de l'examen m√©dico-l√©gal, il serait impossible de voir toutes les actions pass√©es de la porte d√©rob√©e, seulement la derni√®re. </p><br><p>  Les journaux sont assez informatifs, ils permettent aux op√©rateurs Turla de suivre les actions de porte d√©rob√©e.  La figure ci-dessous montre un exemple de journal d√©chiffr√©. </p><br><img src="https://habrastorage.org/webt/yo/q_/z6/yoq_z6lfqy5b3ozw3f4lh6reqr4.png"><br><p>  <em>Figure 22. Fichier journal d√©chiffr√©</em> </p><br><h2 id="3-vyvody">  3. Conclusions </h2><br><p>  Le rapport a montr√© que les d√©veloppeurs Turla ont suffisamment d'id√©es lorsqu'ils d√©veloppent des portes d√©rob√©es.  √Ä notre connaissance, Turla est le seul groupe de cyberespionnage qui utilise actuellement une porte d√©rob√©e enti√®rement g√©r√©e par e-mail, ou plut√¥t par des pi√®ces jointes PDF. </p><br><p>  La porte d√©rob√©e Turla n'est pas la premi√®re √† utiliser la vraie bo√Æte aux lettres de la victime pour recevoir des commandes et exfiltrer des donn√©es.  Cependant, c'est la premi√®re porte d√©rob√©e √† apprendre √† l'aide de l'API standard (MAPI) pour interagir avec Microsoft Outlook.  Il s'agit d'une am√©lioration significative par rapport √† la version pr√©c√©dente que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nous avons √©tudi√©e</a> , qui utilisait Outlook Express.  En revanche, la nouvelle porte d√©rob√©e Turla fonctionne m√™me avec les derni√®res versions d'Outlook. </p><br><p>  Gr√¢ce √† la capacit√© de contr√¥ler les communications apparemment l√©gitimes d'un poste de travail infect√©, ainsi qu'√† l'ind√©pendance vis-√†-vis de toute adresse e-mail particuli√®re, la porte d√©rob√©e Turla est cach√©e et tol√©rante aux pannes.      ,   Uroburos,      . </p><br><p>   ,         Turla,  ,    .     ,  ,     .  ,      -   ,        . </p><br><p>    ,     PDF-,     Turla,      ,     . </p><br><p>  ESET     Turla,        . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><h2 id="4-indikatory-komprometacii"> 4.   </h2><br><h3 id="41-heshi">  4.1.  Hashs </h3><br><p> 8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 ‚Äî  Win32/Turla.N;   (GMT) 2013-06-28 14:15:54 <br> F992ABE8A67120667A01B88CD5BF11CA39D491A0 ‚Äî  Win32/Turla.AW; GMT 2014-12-03 20:50:08 <br> CF943895684C6FF8D1E922A76B71A188CFB371D7 ‚Äî  Win32/Turla.R; GMT 2014-12-03 20:44:27 <br> 851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 ‚Äî  Win32/Turla.DA; GMT 2016-09-15 08:14:47 </p><br><h3 id="42-imena-faylov">  4.2.   </h3><br><p> %appdata%/Microsoft/Windows/scawrdot.db <br> %appdata%/Microsoft/Windows/flobcsnd.dat <br> mapid.tlb </p><br><h3 id="43-klyuchi-reestra">  4.3.   </h3><br><p> HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\ <br> HKCU\Software\Classes\CLSID{49CBB1C7-97D1-485A-9EC1-A26065633066} <br> HKCU\Software\Classes\CLSID{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421399/">https://habr.com/ru/post/fr421399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421389/index.html">S√©paration des pouvoirs administratifs √† Zimbra</a></li>
<li><a href="../fr421391/index.html">HackThings - un grand hackathon sur l'Internet des objets du 7 au 9 septembre √† Skoltech</a></li>
<li><a href="../fr421393/index.html">Panier Mailchimp abandonn√©: un guide pour les paresseux</a></li>
<li><a href="../fr421395/index.html">Rapport du Club de Rome 2018, chapitre 3.7: ¬´Climat: bonne nouvelle mais gros probl√®mes¬ª</a></li>
<li><a href="../fr421397/index.html">Lancez la Mini AI Cup # 3. Bataille m√©canique dans des espaces confin√©s</a></li>
<li><a href="../fr421401/index.html">Anatomie des syst√®mes de recommandation. Deuxi√®me partie</a></li>
<li><a href="../fr421403/index.html">Semaine de la s√©curit√© 32: drame Fortnite-Android</a></li>
<li><a href="../fr421407/index.html">R√©union technique √† Saint-P√©tersbourg le 13 septembre - Comment faire de grands changements sur le backend</a></li>
<li><a href="../fr421409/index.html">Espionner les choses: garder un secret</a></li>
<li><a href="../fr421411/index.html">Introduction aux modules Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>