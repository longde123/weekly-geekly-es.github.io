<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§™ üßñüèº üåó 5 hacks vital√≠cios para otimizar consultas SQL no Greenplum ü§Ωüèª ‚¨áÔ∏è üêøÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qualquer processo relacionado ao banco de dados, mais cedo ou mais tarde, encontra problemas com o desempenho de consultas a esse banco de dados. 

 O...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 hacks vital√≠cios para otimizar consultas SQL no Greenplum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/442758/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/-5/0k/gz/-50kgzc35o2xwh_r_xzqqavfglg.jpeg"></a> <br><br>  Qualquer processo relacionado ao banco de dados, mais cedo ou mais tarde, encontra problemas com o desempenho de consultas a esse banco de dados. <br><br>  O data warehouse da Rostelecom √© constru√≠do no Greenplum, a maioria dos c√°lculos (transforma√ß√£o) √© realizada por consultas sql, que iniciam (ou geram e executam) o mecanismo ETL.  O DBMS possui suas pr√≥prias nuances que afetam significativamente o desempenho.  Este artigo √© uma tentativa de destacar os aspectos mais cr√≠ticos do trabalho com o Greenplum em termos de desempenho e compartilhamento de experi√™ncia. <br><br><div class="spoiler">  <b class="spoiler_title">Em poucas palavras sobre Greenplum</b> <div class="spoiler_text"> Greenplum - servidor de banco de dados <abbr title="Processamento paralelo maci√ßo">MPP</abbr> , cujo n√∫cleo √© constru√≠do no PostgreSql. <br><br>  Representa v√°rias inst√¢ncias diferentes do processo PostgreSql (inst√¢ncias).  Um deles √© o ponto de entrada para o cliente e √© chamado de inst√¢ncia principal (mestre), todos os outros s√£o chamados de inst√¢ncias de segmento (segmento, inst√¢ncias independentes, cada uma com seus pr√≥prios dados).  Cada servidor (host do segmento) pode executar de um a v√°rios servi√ßos (segmento).  Isso √© feito para melhor utilizar os recursos do servidor e principalmente os processadores.  O assistente armazena metadados, √© respons√°vel por comunicar clientes com dados e tamb√©m distribui trabalho entre segmentos. <br><br><img src="https://habrastorage.org/webt/pd/9n/sa/pd9nsaodhcjqwwhzsfvvdflqlou.jpeg"><br><br>  Leia mais na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> . <br></div></div><br>  Al√©m disso, no artigo, haver√° muitas refer√™ncias ao plano de solicita√ß√£o.  Informa√ß√µes para Greenplum est√£o dispon√≠veis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h2>  Como escrever boas consultas no Greenplum (bem, ou pelo menos n√£o muito triste) </h2><a name="habracut"></a><br>  Como estamos lidando com um banco de dados distribu√≠do, √© importante n√£o apenas como a consulta sql √© gravada, mas tamb√©m como os dados s√£o armazenados. <br><br><h3>  1. Distribui√ß√£o </h3><br>  Os dados s√£o fisicamente armazenados em diferentes segmentos.  Voc√™ pode separar dados por segmentos aleatoriamente ou pelo valor da fun√ß√£o hash de um campo ou um conjunto de campos. <br><br>  Sintaxe (ao criar uma tabela): <br><br><pre><code class="sql hljs">DISTRIBUTED BY (some_field)</code> </pre> <br>  Ou ent√£o: <br><br><pre> <code class="sql hljs">DISTRIBUTED RANDOMLY</code> </pre> <br>  O campo de distribui√ß√£o deve ter boa seletividade e n√£o ter valores nulos (ou ter um m√≠nimo de tais valores), pois os registros com esses campos ser√£o distribu√≠dos em um segmento, o que pode levar a distor√ß√µes nos dados. <br><br>  O tipo de campo √© preferencialmente inteiro.  O campo √© usado para ingressar nas tabelas.  A jun√ß√£o de hash √© uma das melhores maneiras de ingressar em tabelas (em termos de execu√ß√£o de consulta), funciona melhor com esse tipo de dados. <br><br>  Para distribui√ß√£o, √© aconselh√°vel escolher n√£o mais que dois campos e, √© claro, um √© melhor que dois.  Os campos adicionais nas chaves de distribui√ß√£o, em primeiro lugar, requerem tempo adicional para o hash e, em segundo lugar, (na maioria dos casos) exigir√£o a transfer√™ncia de dados entre segmentos ao executar jun√ß√µes. <br><br>  Voc√™ pode usar a distribui√ß√£o aleat√≥ria se n√£o conseguir selecionar um ou dois campos adequados, bem como para r√≥tulos pequenos.  Mas devemos levar em conta que essa distribui√ß√£o funciona melhor para inser√ß√£o de dados em massa, e n√£o para um registro.  O GreenPlum distribui os dados de acordo com o algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≠clico</a> e inicia um novo ciclo para cada opera√ß√£o de pastilha, come√ßando no primeiro segmento, que, com pequenas pastilhas frequentes, leva a distor√ß√µes (distor√ß√£o de dados). <br><br>  Com um campo de distribui√ß√£o bem escolhido, todos os c√°lculos ser√£o realizados no segmento, sem enviar dados para outros segmentos.  Al√©m disso, para uma jun√ß√£o ideal de tabelas (jun√ß√£o), os mesmos valores devem estar localizados no mesmo segmento. <br><br><div class="spoiler">  <b class="spoiler_title">Distribui√ß√£o em imagens</b> <div class="spoiler_text">  <i>Boa chave de distribui√ß√£o:</i> <br><img src="https://habrastorage.org/webt/x-/r9/8i/x-r98iuubqw2tkoea-tblqbgj-m.jpeg" height="700"><br><br>  <i>Chave de distribui√ß√£o ruim:</i> <br><img src="https://habrastorage.org/webt/79/ft/-g/79ft-gs67yhdwwq156dmxlsz74o.png"><br><br>  <i>Distribui√ß√£o aleat√≥ria:</i> <br><img src="https://habrastorage.org/webt/r8/eo/xr/r8eoxrz1t0eksmnylw7yco33rkm.png" height="700"><br></div></div><br>  O tipo de campos usados ‚Äã‚Äãna jun√ß√£o deve ser o mesmo em todas as tabelas. <br>  <b>Importante:</b> n√£o use como campos de distribui√ß√£o aqueles que s√£o usados ‚Äã‚Äãpara filtrar consultas em onde, pois nesse caso a carga durante a consulta tamb√©m n√£o ser√° distribu√≠da uniformemente. <br><br><h3>  2. Particionamento </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O particionamento</a> permite dividir tabelas grandes, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fatos</a> , em partes logicamente separadas.  O Greenplum divide fisicamente sua tabela em tabelas separadas, cada uma das quais √© dividida em segmentos com base nas configura√ß√µes da p√°gina 1. <br><br>  As tabelas devem ser divididas em se√ß√µes logicamente; para esse fim, selecione o campo frequentemente usado no bloco where.  Nas tabelas de fatos, esse ser√° o per√≠odo.  Portanto, com acesso adequado √† tabela em consultas, voc√™ trabalhar√° apenas com parte de toda a tabela grande. <br><br>  Em geral, o particionamento √© um t√≥pico bastante conhecido, e eu queria enfatizar que voc√™ n√£o deve escolher o mesmo campo para particionamento e distribui√ß√£o.  Isso levar√° ao fato de que a solicita√ß√£o ser√° executada inteiramente em um segmento. <br><br>  √â hora de ir, de fato, aos pedidos.  A solicita√ß√£o ser√° executada em segmentos de acordo com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plano</a> espec√≠fico: <br><br><h3>  3. O otimizador </h3><br>  O Greenplum possui dois otimizadores, o otimizador herdado incorporado e o otimizador Orca de terceiros: GPORCA - Orca - Otimizador de consulta din√¢mica. <br><br>  Ative o GPORCA mediante solicita√ß√£o: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> optimizer = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;</code> </pre> <br>  <b>Como regra</b> , o otimizador GPORCA √© melhor que o embutido.  Funciona de forma mais adequada com subconsultas e <abbr title="Express√µes de tabela comuns">CTE</abbr> (mais detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ). <br>  Fez uma chamada para uma tabela grande no CTE com filtragem m√°xima de dados (n√£o se esque√ßa da remo√ß√£o de parti√ß√£o) e uma lista de campos explicitamente especificada - ela funciona muito bem. <br><br>  Modifica levemente o plano de consulta, por exemplo, exibe as parti√ß√µes digitalizadas: <br><br>  <i>Otimizador padr√£o:</i> <br><br><img src="https://habrastorage.org/webt/hg/0u/rq/hg0urqdrlaefwysxwszfpww18mc.png"><br><br>  <i>Orca:</i> <br><br><img src="https://habrastorage.org/webt/ct/hv/dz/cthvdzt2s5p126cdu1olhb5teci.png"><br><br>  O GPORCA tamb√©m permite a atualiza√ß√£o dos campos de parti√ß√£o / distribui√ß√£o.  Embora existam situa√ß√µes em que o otimizador embutido tenha um desempenho melhor.  Um otimizador de terceiros √© muito exigente em estat√≠stica; √© importante n√£o esquecer de <abbr title="analisar">analisar</abbr> . <br><br>  N√£o importa o qu√£o bom seja o otimizador, uma consulta mal escrita nem estender√° o Orca: <br><br><h3>  4. Manipula√ß√µes com campos nas condi√ß√µes where block ou join </h3><br>  √â importante lembrar que a fun√ß√£o aplicada ao campo de filtro ou as condi√ß√µes da jun√ß√£o s√£o aplicadas a <b>cada</b> registro. <br><br>  No caso do campo de particionamento (por exemplo, date_trunc para o campo de particionamento - date), mesmo o GPORCA n√£o pode funcionar corretamente nesse caso, as <abbr title="poda de parti√ß√£o">parti√ß√µes de recorte</abbr> n√£o funcionar√£o. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where date_trunc('month',tech_dt) between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second' ;</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sc/qo/qv/scqoqv3h43a7ezkr4ug2zu8i9ta.png"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where tech_dt between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second'</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mo/xz/ah/moxzahjrapobpn_4dss02qykihc.png"><br><br>  <i>Tamb√©m chamo a aten√ß√£o para a exibi√ß√£o de parti√ß√µes.</i>  <i>O otimizador interno exibir√° parti√ß√µes em uma lista:</i> <br><br><img src="https://habrastorage.org/webt/lf/it/wk/lfitwkzpj9xkbvnteyq6ynzc-rw.png"><br><br>  Aplique cuidadosamente fun√ß√µes a constantes nos mesmos filtros de parti√ß√£o.  Um exemplo √© o mesmo date_trunc: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))</code> </pre> <br><img src="https://habrastorage.org/webt/t8/ox/u1/t8oxu1zcmjm0ymsmgj0-we_dp7m.png"><br><br>  O GPORCA lidar√° completamente com essa simula√ß√£o e funcionar√° corretamente, o otimizador padr√£o n√£o funcionar√° mais.  No entanto, ao fazer uma convers√£o de tipo expl√≠cita, voc√™ pode faz√™-la funcionar: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))::timestamp without time zone</code> </pre> <br><img src="https://habrastorage.org/webt/5y/in/3p/5yin3ppep3f9wuzd9ib_kxa2bdm.png"><br><br>  E se tudo for feito errado? <br><br><h3>  5. Mo√ß√µes </h3><br>  Outro tipo de opera√ß√£o que pode ser observado no <i>plano de consulta</i> s√£o os movimentos.  Movimentos de dados t√£o marcados entre segmentos: <br><br><ul><li>  <b>Reunir movimento</b> - ser√° exibido em quase todos os planos, significa combinar os resultados da execu√ß√£o de consultas de todos os segmentos em um fluxo (geralmente para o mestre). <br><br>  Duas tabelas, distribu√≠das por uma chave, usada para a jun√ß√£o, executam todas as opera√ß√µes nos segmentos, sem mover dados.  Caso contr√°rio, ocorrer√° um movimento de transmiss√£o ou um movimento de redistribui√ß√£o: </li><li>  <b>Movimento de transmiss√£o</b> - cada segmento envia sua c√≥pia dos dados para outros segmentos.  Em uma situa√ß√£o ideal, a transmiss√£o ocorre apenas para tabelas pequenas. </li><li>  <b>Movimento de redistribui√ß√£o</b> - para unir tabelas grandes distribu√≠das por chaves diferentes, a redistribui√ß√£o √© executada para fazer conex√µes localmente.  Para tabelas grandes, isso pode ser uma opera√ß√£o bastante cara. </li></ul><br>  Transmiss√£o e redistribui√ß√£o s√£o opera√ß√µes bastante desvantajosas.  Eles s√£o executados toda vez que a solicita√ß√£o √© executada.  √â recomend√°vel evit√°-los.  Tendo visto esses pontos no plano de consulta, vale a pena prestar aten√ß√£o nas chaves de distribui√ß√£o.  Opera√ß√µes distintas e sindicais tamb√©m causam movimentos. <br><br>  Esta lista n√£o √© exaustiva e baseia-se principalmente na experi√™ncia do autor.  N√£o funcionou para encontrar tudo imediatamente na Internet ao mesmo tempo.  Aqui, tentei identificar os fatores mais cr√≠ticos que afetam o desempenho da solicita√ß√£o e entender por que e por que isso est√° acontecendo. <br><br>  <i>Este artigo foi preparado pela equipe de gerenciamento de dados Rostelecom</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442758/">https://habr.com/ru/post/pt442758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442744/index.html">Solu√ß√£o RIPE e suas consequ√™ncias para a exclus√£o de dois LIRs russos (Netup, gcxc.net)</a></li>
<li><a href="../pt442746/index.html">Aplicativo tolo para a Windows Store</a></li>
<li><a href="../pt442748/index.html">A coisa do chap√©u: os 10 principais relat√≥rios do Heisenbug 2018 em Moscou</a></li>
<li><a href="../pt442750/index.html">Djinn virtual em 8 de mar√ßo - ou como surpreender seus funcion√°rios em um dia de primavera</a></li>
<li><a href="../pt442754/index.html">Bancos de dados operacionais e anal√≠ticos: armazenamento de coluna x linha</a></li>
<li><a href="../pt442760/index.html">Um artigo sobre como o CommVault faz backup do PostgreSQL</a></li>
<li><a href="../pt442762/index.html">O estagi√°rio Vasya e suas hist√≥rias sobre a API de idempot√™ncia</a></li>
<li><a href="../pt442764/index.html">Resumo do Gerenciamento de Produto. O que excita produtos e profissionais de marketing em 2019</a></li>
<li><a href="../pt442770/index.html">Vis√£o geral dos scanners de c√≥digo de barras JavaScript</a></li>
<li><a href="../pt442772/index.html">Matem√°tica para cientista de dados: se√ß√µes necess√°rias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>