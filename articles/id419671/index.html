<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌵 ⚖️ 💆🏻 Keterbatasan itu perlu dilanggar atau bagaimana kami mempercepat tes fungsional tiga kali 🙍🏾 👨🏿‍🤝‍👨🏼 👨🏽‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tes fungsional adalah hal yang bermanfaat. Pada awalnya, mereka tidak membutuhkan banyak waktu, tetapi proyek ini terus berkembang, dan semakin banyak...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Keterbatasan itu perlu dilanggar atau bagaimana kami mempercepat tes fungsional tiga kali</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/419671/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/t0/cx/ye/t0cxyeb2tn7qjezwopepfwjy1ne.jpeg" alt="gambar"></a> <br><br>  Tes fungsional adalah hal yang bermanfaat.  Pada awalnya, mereka tidak membutuhkan banyak waktu, tetapi proyek ini terus berkembang, dan semakin banyak tes yang diperlukan.  Kami tidak bermaksud mentolerir perlambatan dalam kecepatan pengiriman, dan, mengumpulkan kekuatan kami, kami mempercepat tes fungsional tiga kali.  Dalam artikel ini Anda akan menemukan tips universal, namun, Anda akan melihat efek khusus pada proyek-proyek besar. <br><a name="habracut"></a><br><h3>  Secara singkat tentang aplikasi </h3><br>  Tim saya sedang mengembangkan API publik yang menyediakan data untuk pengguna 2GIS.  Ketika Anda pergi ke 2gis.ru dan mencari "Supermarket", Anda mendapatkan daftar organisasi - ini adalah data dari API kami.  Pada 2000+ RPS kami, hampir setiap masalah menjadi kritis jika beberapa jenis fungsi rusak. <br><br>  Aplikasi ini ditulis dalam Scala, tes ditulis dalam PHP, database-nya adalah PostgreSQL-9.4.  Kami memiliki sekitar 25.000 tes fungsional, mereka membutuhkan waktu 30 menit untuk menyelesaikan pada mesin virtual khusus untuk regresi umum.  Durasi tes tidak terlalu mengganggu kami - kami terbiasa dengan fakta bahwa tes bisa memakan waktu 60 menit pada kerangka lama. <br><br><h3>  Bagaimana kami mempercepat apa yang disebut tes "cepat" </h3><br>  Semuanya berawal dari kecelakaan.  Seperti biasa terjadi.  Kami mendukung satu fitur demi satu, lulus tes pada saat yang sama.  Jumlah mereka bertambah, dan waktu yang diperlukan untuk menyelesaikannya juga.  Begitu tes mulai merangkak keluar dari batas waktu yang diberikan kepada mereka, dan karena itu proses eksekusi mereka diselesaikan dengan paksa.  Tes yang tidak lengkap penuh dengan masalah yang terlewat dalam kode. <br><br>  Kami menganalisis kecepatan tes dan tugas mempercepatnya menjadi relevan.  Maka dimulailah studi yang disebut "Tes bekerja lambat - perbaiki." <br><br>  Berikut adalah tiga masalah besar yang kami temukan dalam tes. <br><br><h3>  Masalah 1: jsQuery disalahgunakan </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4g/t9/0a/4gt90azsdwffnvwr2zy7pdsafiq.gif"></div><br>  Semua data yang kita miliki disimpan dalam database PostgreSQL.  Sebagian besar dalam bentuk json, jadi kami aktif menggunakan jsQuery. <br><br>  Berikut adalah contoh kueri yang kami buat di database untuk mendapatkan data yang diperlukan: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'address_name = *'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'contact_groups.#.contacts.#.type = “website”'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Sangat mudah untuk memperhatikan bahwa contoh menggunakan json_data beberapa kali berturut-turut, meskipun akan benar untuk menulis ini: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = “website”'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Kekurangan seperti itu tidak terlalu mencolok, karena dalam tes kami tidak menulis semua pertanyaan dengan tangan kami, tetapi kami menggunakan QueryBuilders, yang mereka buat sendiri setelah menentukan fungsi yang diperlukan.  Kami tidak berpikir bahwa ini dapat mempengaruhi kecepatan eksekusi permintaan.  Dengan demikian, dalam kode itu terlihat seperti ini: <br><br><pre> <code class="php hljs">$qb = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>&gt;createQueryBulder() -&gt;selectAllBranchFields() -&gt;fromBranchPartition() -&gt;hasRubric() -&gt;hasAddressName() -&gt;hasWebsite() -&gt;orderByRandom() -&gt;setMaxResults(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  <b>Jangan ulangi kesalahan kami</b> : jika ada beberapa kondisi dalam satu bidang JSONB, jelaskan semuanya dalam kerangka operator tunggal '@@'.  Setelah kami redid, kami mempercepat waktu eksekusi dari setiap permintaan dua kali.  Sebelumnya, permintaan yang diuraikan membutuhkan 7500 ms, tetapi sekarang dibutuhkan 3500 ms. <br><br><h3>  Masalah 2: Data Uji Ekstra </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yz/ko/yc/yzkoyc5ixzl8pmj6vtkdltnubbc.gif"></div><br>  Akses ke API kami disediakan oleh kunci, setiap pengguna memiliki API sendiri.  Sebelumnya, dalam pengujian, seringkali perlu untuk mengubah pengaturan kunci.  Karena itu, tes jatuh. <br><br>  Kami memutuskan untuk membuat beberapa kunci dengan pengaturan yang diperlukan untuk setiap proses regresi untuk menghindari masalah persimpangan.  Dan karena membuat kunci baru tidak memengaruhi fungsionalitas seluruh aplikasi, pendekatan ini dalam pengujian tidak akan memengaruhi apa pun.  Mereka hidup dalam kondisi seperti itu selama sekitar satu tahun, sampai mereka mulai berurusan dengan produktivitas. <br><br>  Tidak banyak kunci - 1000 buah.  Untuk mempercepat aplikasi, kami menyimpannya di memori dan memperbaruinya setiap beberapa menit atau sesuai permintaan.  Dengan demikian, setelah menyimpan kunci berikutnya, tes memulai proses sinkronisasi, yang akhirnya tidak kami tunggu - kami terima dalam respons "504", yang ditulis dalam log.  Pada saat yang sama, aplikasi tidak menandakan masalah dengan cara apa pun, dan kami pikir semuanya bekerja dengan baik untuk kami.  Proses pengujian regresi itu sendiri berlanjut.  Dan pada akhirnya ternyata kami selalu beruntung dan kunci kami diselamatkan. <br><br>  Kami hidup dalam ketidaktahuan sampai kami memeriksa log.  Ternyata kami membuat kunci, tetapi tidak menghapusnya setelah menjalankan tes.  Dengan demikian, kami telah mengakumulasikan 500.000 di antaranya. <br><br>  <b>Jangan ulangi kesalahan kami:</b> jika Anda mengubah database dalam pengujian, pastikan untuk memastikan bahwa database tersebut dikembalikan ke kondisi semula.  Setelah kami membersihkan database, proses pembaruan utama dipercepat 500 kali. <br><br><h3>  Masalah 3: Pengambilan Sampel Acak </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/s4/yw/x7s4ywwe8d2kg4upx_y0-k98k4a.gif"></div><br>  Kami senang menguji aplikasi pada data yang berbeda.  Kami memiliki banyak data, dan masalah ditemukan secara berkala.  Misalnya, ada kasus ketika kami tidak mengunggah data tentang iklan, tetapi pengujian menangkap masalah ini tepat waktu.  Itu sebabnya dalam setiap permintaan pengujian kami, Anda dapat melihat ORDER BY RANDOM () <br><br>  Ketika kami melihat hasil kueri, dengan dan tanpa keacakan, dengan EXPLAIN, kami melihat peningkatan kinerja 20 kali.  Jika kita berbicara tentang contoh di atas, maka tanpa pengacakan itu berhasil selama 160 ms.  Kami serius memikirkan apa yang harus dilakukan, karena kami tidak benar-benar ingin meninggalkan rumah acak. <br><br>  Misalnya, di Novosibirsk ada sekitar 150 ribu perusahaan, dan ketika kami mencoba menemukan perusahaan yang memiliki alamat, situs web, dan tajuk, kami menerima catatan acak dari hampir seluruh database.  Kami memutuskan untuk mengurangi seleksi menjadi 100 perusahaan pertama yang sesuai dengan kondisi kami.  Hasil dari pikiran adalah kompromi antara pemilihan konstan berbagai data dan kecepatan: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> firm_1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> json_data @@ <span class="hljs-string"><span class="hljs-string">'rubrics.@# &gt; 0 AND address_name = * AND contact_groups.#.contacts.#.type = "website"'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>) random_hack <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RANDOM() <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  Dengan cara sederhana ini, kami hampir tidak kehilangan apa pun pada akselerasi 20x.  Waktu pelaksanaan permintaan seperti itu adalah 180ms. <br><br>  <b>Jangan ulangi kesalahan kita:</b> momen ini, tentu saja, hampir tidak bisa disebut kesalahan.  Jika Anda benar-benar memiliki banyak tes, selalu pikirkan seberapa banyak Anda membutuhkan keacakan dalam data.  Trade-off antara kecepatan eksekusi query ke dalam database dan keunikan pilihan membantu kami mempercepat query SQL sebanyak 20 kali. <br><br><h3>  Sekali lagi daftar tindakan singkat: </h3><br><ol><li>  Jika kami menetapkan beberapa kondisi untuk memilih data di bidang JSONB, maka mereka harus terdaftar dalam satu operator '@@'. </li><li>  Jika kami membuat data uji, pastikan untuk menghapusnya.  Sekalipun kehadiran mereka tampaknya tidak memengaruhi fungsionalitas aplikasi. </li><li>  Jika Anda membutuhkan data acak untuk setiap proses, kami menemukan kompromi antara keunikan sampel dan kecepatan eksekusi. </li></ol><br>  Kami mempercepat regresi tiga kali berkat modifikasi sederhana (dan untuk beberapa, bahkan mungkin jelas).  Sekarang tes 25K kami lulus dalam 10 menit.  Dan ini bukan batasnya - kami mengoptimalkan kode selanjutnya.  Tidak diketahui berapa banyak penemuan tak terduga yang menunggu kita di sana. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id419671/">https://habr.com/ru/post/id419671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id419661/index.html">Membuat stasiun radio dari GTA: San Andreas</a></li>
<li><a href="../id419663/index.html">Organisasi pemerintah memikat pencipta pH ultra-kecil dengan kontrak, bonus, dan penyederhanaan birokrasi</a></li>
<li><a href="../id419665/index.html">Pengalaman menggunakan LoRaWAN dalam sistem ASKUE dalam kondisi kota nyata</a></li>
<li><a href="../id419667/index.html">Pilihan bahan yang berguna di Azure. Bagian 1 - buku</a></li>
<li><a href="../id419669/index.html">Sepuluh mouse gaming terbaik untuk dompet apa pun</a></li>
<li><a href="../id419673/index.html">Alam semesta awal 6. Dinamika alam semesta yang mengembang secara homogen, bagian 2</a></li>
<li><a href="../id419675/index.html">Ulasan sewa per menit skuter listrik di Moskow, musim panas 2018</a></li>
<li><a href="../id419677/index.html">Cara mengendus lalu lintas HTTPS dari perangkat iOS</a></li>
<li><a href="../id419679/index.html">Menerapkan Spring Framework API dari awal. Panduan untuk pemula. Bagian 1</a></li>
<li><a href="../id419683/index.html">Apa arti metrik untuk tim tangkas?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>