<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🚀 🙆🏻 👨‍🏫 So beschreiben Sie eine reduzierende Symbolleiste deklarativ ☝🏾 👧🏾 ⏩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich möchte eine Lösung für die Beschreibung der CollapsingToolbar vorstellen, wobei der Schwerpunkt auf der Lesbarkeit des Codes liegt. Der Artikel er...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So beschreiben Sie eine reduzierende Symbolleiste deklarativ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426369/"><img src="https://habrastorage.org/webt/8g/0f/wn/8g0fwn_juqzn2hdlqfsnpxncz1w.gif"><br><br>  Ich möchte eine Lösung für die Beschreibung der CollapsingToolbar vorstellen, wobei der Schwerpunkt auf der Lesbarkeit des Codes liegt.  Der Artikel erklärt nicht, was ist und wie Sie Ihr CoordinatorLayout.Behavior schreiben.  Wenn der Leser daran interessiert ist, dies zu verstehen, gibt es viele Artikel, einschließlich der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">über den Habr</a> .  Wenn Sie nicht verstehen möchten, ist es in Ordnung: Ich habe versucht, die Schreibweise von CollapsingToolbar zu ermitteln, damit ich von CoordinatorLayout.Behavior und OnOffsetChangedListener abstrahieren kann. <br><a name="habracut"></a><br><h4>  Bedingungen </h4><br><ul><li>  Symbolleiste - Eine Reihe von Ansichten, die oben auf dem Bildschirm angezeigt werden sollen (nicht android.widget.Toolbar). </li><li>  NestedScroll - jede scrollbare Ansicht, die AppBarLayout zugeordnet werden kann (RecyclerView, NestedScrollView). </li></ul><br><h3>  Warum mussten Sie Ihre Entscheidung schreiben? </h3><br>  Ich habe mir verschiedene Ansätze im „Internet“ angesehen und fast alle wurden wie folgt aufgebaut: <br><br><ol><li>  Legt eine feste Höhe für AppBarLayout fest. </li><li>  CoordinatorLayout.Behavior wird geschrieben, bei dem mit einigen Berechnungen (die zwischengespeicherte Ansichtshöhe wird am unteren Rand einer anderen Ansicht hinzugefügt und abzüglich des Randes mit der hier berechneten Schriftrolle multipliziert) eine Ansicht geändert wird. </li><li>  Andere Ansichten ändern sich im OnOffsetChangedListener des AppBarLayout. </li></ol><br>  Hier ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel für Verhalten</a> mit dem beschriebenen Ansatz, 2,5k Sterne auf Github. <br><br><div class="spoiler">  <b class="spoiler_title">Warten</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/7q/vv/7e/7qvv7emfjzhrkn_shib-a0pivxu.gif"></div></div><br><div class="spoiler">  <b class="spoiler_title">Realität: Setzen Sie Ihren OnePlus auf</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/wn/aa/4b/wnaa4b5bdkbta85lg71cegvwdoa.png"></div></div><br>  Sie können das Layout für diese Lösung korrigieren, aber etwas anderes verwirrt mich.  Einige Ansichten werden über OnOffsetChangedListener verwaltet, andere über Behaviour.  Um das ganze Bild zu verstehen, muss der Entwickler viele Klassen durchgehen. Wenn für eine neue Ansicht ein Verhalten hinzugefügt werden muss, das von einem anderen Verhalten und den Ansichten abhängt, die sich in OnOffsetChangedListener ändern, können Krücken und Fehler aus heiterem Himmel wachsen <br><br>  Darüber hinaus zeigt dieses Beispiel nicht, was zu tun ist, wenn der Symbolleiste zusätzliche Elemente hinzugefügt werden, die sich auf die Höhe dieser Symbolleiste auswirken. <br><br>  Im GIF am Anfang des Artikels können Sie sehen, wie TextView ausgeblendet wird, indem Sie auf die Schaltfläche klicken - und NestedScroll wird höher gezogen, damit kein Leerzeichen vorhanden ist. <br><br><div class="spoiler">  <b class="spoiler_title">Wieder GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8g/0f/wn/8g0fwn_juqzn2hdlqfsnpxncz1w.gif"></div></div><br>  Wie kann man das machen?  Die Lösungen, die zuerst in den Sinn kommen, bestehen darin, ein weiteres CoordinatorLayout.Behavior für NestedScroll zu schreiben (wobei die Logik des zugrunde liegenden AppBarLayout.Behavior beibehalten wird) oder die Symbolleiste in AppBarLayout einzufügen und in OnOffsetChangedListener zu ändern.  Ich habe beide Lösungen ausprobiert, und es stellte sich heraus, dass ein Code an Implementierungsdetails gebunden war, der für andere schwer zu verstehen war und nicht wiederverwendet werden konnte. <br><br>  Ich würde mich freuen, wenn jemand ein Beispiel teilt, in dem eine solche Logik „sauber“ implementiert ist, aber jetzt werde ich meine Lösung zeigen.  Die Idee ist, <b>an einem Ort deklarativ beschreiben zu können,</b> welche Ansichten und wie sie sich verhalten sollen. <br><br><h3>  Wie sieht API aus? </h3><br>  Um CoordinatorLayout.Behavior zu erstellen, benötigen Sie: <br><br><ul><li>  erbe BehaviorByRules; </li><li>  Überschreiben Sie Methoden, die AppBarLayout, CollapsingToolbarLayout und die Bildlauflänge (AppBarLayout-Höhe) zurückgeben. </li><li>  überschreiben Sie die setUpViews-Methode - beschreiben Sie die Regeln für das Verhalten der Ansicht, wenn sich die Bildlaufleiste der AppBar ändert. </li></ul><br>  TopInfoBehavior für die Symbolleiste aus dem GIF am Anfang des Artikels sieht folgendermaßen aus (später im Artikel werde ich erklären, wie es funktioniert): <br><br><div class="spoiler">  <b class="spoiler_title">Layout</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_z/f1/yz/_zf1yzlonsivwsvfevlillcopc0.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">TopInfoBehavior.kt</b> <div class="spoiler_text"><pre><code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TopInfoBehavior</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Context</span></span></span><span class="hljs-class">?, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AttributeSet</span></span></span><span class="hljs-class">? ) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BehaviorByRules</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">) { override fun calcAppbarHeight(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> = with(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">) { return (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toolbar_height</span></span></span><span class="hljs-class">)).toInt() } override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.provideAppbar(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppBarLayout</span></span></span><span class="hljs-class"> = ablAppbar override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.provideCollapsingToolbar(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CollapsingToolbarLayout</span></span></span><span class="hljs-class"> = ctlToolbar override fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.setUpViews(): </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">&gt; = listOf( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewGroupTopDetails</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zero</span></span></span><span class="hljs-class">), max = pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toolbar_height</span></span></span><span class="hljs-class">) ) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewTopDetails</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAlpha</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0.6</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) .workInRange(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">appearedUntil</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleXOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">big_margin</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">()) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pixels</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zero</span></span></span><span class="hljs-class">), max = pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pad</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LinearInterpolator</span></span></span><span class="hljs-class">()) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(0.1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleScale</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0.8</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = 1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewPainIsTheArse</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isAppearedUntil</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewCollapsedTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(0.1</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textViewTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleAppear</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isAppearedUntil</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class">) ), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LinearInterpolator</span></span></span><span class="hljs-class">()), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop2</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">(0.7</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">)), buildRuleForIcon(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop3</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AccelerateInterpolator</span></span></span><span class="hljs-class">()) ) private fun </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class">.buildRuleForIcon( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ImageView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpolator</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Interpolator</span></span></span><span class="hljs-class"> ) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RuledView</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleYOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ivTop3</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tvCollapsedTop</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">), max = 0f, interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DecelerateInterpolator</span></span></span><span class="hljs-class">(1.5</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">) ), </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BRuleXOffset</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> = 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tvCollapsedTop</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">toFloat</span></span></span><span class="hljs-class">() + pixels(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">R</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dimen</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">huge_margin</span></span></span><span class="hljs-class">), interpolator = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReverseInterpolator</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interpolator</span></span></span><span class="hljs-class">) ) ) companion object { const val </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GONE_VIEW_THRESHOLD</span></span></span><span class="hljs-class"> = 0.8f } }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">XML-Layout (offensichtliche Attribute zur besseren Lesbarkeit entfernt)</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CoordinatorLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.AppBarLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CollapsingToolbarLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_scrollFlags</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"scroll|exitUntilCollapsed"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v7.widget.Toolbar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@dimen/toolbar_height"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_collapseMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pin"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CollapsingToolbarLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.AppBarLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RelativeLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:translationZ</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_behavior</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TopInfoBehavior"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v4.widget.NestedScrollView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_behavior</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/appbar_scrolling_view_behavior"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.v4.widget.NestedScrollView</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.FloatingActionButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_anchor</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@id/nesteScroll"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_anchorGravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"right"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android.support.design.widget.CoordinatorLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><h3>  Wie funktioniert es? </h3><br>  Die Aufgabe besteht darin, die Regeln zu schreiben: <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BehaviorRule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> view to be changed * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> details view's data when first attached * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ratio in range [0, 1]; 0 when toolbar is collapsed */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">manage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ratio: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">, details: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">InitialViewDetails</span></span></span></span><span class="hljs-function"><span class="hljs-params">, view: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre><br>  Hier ist alles klar - ein Gleitkommawert von 0 bis 1 wird eingegeben, der den Prozentsatz des ActionBar-Bildlaufs, eine Ansicht und ihren Anfangszustand widerspiegelt.  Es sieht interessanter aus BaseBehaviorRule - eine Regel, von der andere Grundregeln geerbt werden. <br><br><pre> <code class="hljs pgsql">abstract <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BaseBehaviorRule : BehaviorRule { abstract val interpolator: Interpolator abstract val min: <span class="hljs-type"><span class="hljs-type">Float</span></span> abstract val max: <span class="hljs-type"><span class="hljs-type">Float</span></span> final override fun manage( ratio: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> ) { val interpolation = interpolator.getInterpolation(ratio) val <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = normalize( oldValue = interpolation, newMin = min, newMax = max ) <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, details, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>) } <span class="hljs-comment"><span class="hljs-comment">/** * @param offset normalized with range from [min] to [max] with [interpolator] */</span></span> abstract fun <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>) } <span class="hljs-comment"><span class="hljs-comment">/** * Affine transform value form one range into another */</span></span> fun normalize( oldValue: <span class="hljs-type"><span class="hljs-type">Float</span></span>, newMin: <span class="hljs-type"><span class="hljs-type">Float</span></span>, newMax: <span class="hljs-type"><span class="hljs-type">Float</span></span>, oldMin: <span class="hljs-type"><span class="hljs-type">Float</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>f, oldMax: <span class="hljs-type"><span class="hljs-type">Float</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>f ): <span class="hljs-type"><span class="hljs-type">Float</span></span> = newMin + ((oldValue - oldMin) * (newMax - newMin)) / (oldMax - oldMin)</code> </pre><br>  Für die Grundregeln wird der Wertebereich (min, max) und der Interpolator festgelegt.  Dies reicht aus, um fast jedes Verhalten zu beschreiben. <br><br>  Angenommen, wir möchten das Alpha für unsere Ansicht im Bereich von 0,5 bis 0,9 festlegen.  Wir möchten auch, dass die Bildlaufansicht zuerst schnell transparent wird und dann die Änderungsrate sinkt. <br>  Die Regel sieht folgendermaßen aus: <br><br><pre> <code class="hljs lisp">BRuleAlpha(<span class="hljs-name"><span class="hljs-name">min</span></span> = <span class="hljs-number"><span class="hljs-number">0.5</span></span>f, max = <span class="hljs-number"><span class="hljs-number">0.9</span></span>f, interpolator = DecelerateInterpolator())</code> </pre> <br>  Und hier ist die Implementierung von BRuleAlpha: <br><br><div class="spoiler">  <b class="spoiler_title">BRuleAlpha.kt</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/** * [min], [max] — values in range [0, 1] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BRuleAlpha( override val min: <span class="hljs-type"><span class="hljs-type">Float</span></span>, override val max: <span class="hljs-type"><span class="hljs-type">Float</span></span>, override val interpolator: Interpolator = LinearInterpolator() ) : BaseBehaviorRule() { override fun <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>: <span class="hljs-type"><span class="hljs-type">Float</span></span>, details: InitialViewDetails, <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">View</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.alpha = <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> } }</code> </pre><br></div></div><br>  Und schließlich der BehaviorByRules-Code.  Für diejenigen, die ihr Verhalten geschrieben haben, sollte alles offensichtlich sein (außer was in onMeasureChild enthalten ist, werde ich unten darüber sprechen): <br><br><div class="spoiler">  <b class="spoiler_title">BehaviorByRules.kt</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BehaviorByRules</span></span></span></span>( context: Context?, attrs: AttributeSet? ) : CoordinatorLayout.Behavior&lt;View&gt;(context, attrs) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> views: List&lt;RuledView&gt; = emptyList() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastChildHeight = -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needToUpdateHeight: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">layoutDependsOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependency <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> AppBarLayout } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDependentViewChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (views.isEmpty()) views = child.setUpViews() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> progress = calcProgress(parent) views.forEach { performRules(offsetView = it, percent = progress) } tryToInitHeight(child, dependency, progress) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMeasureChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parentWidthMeasureSpec: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, widthUsed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parentHeightMeasureSpec: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, heightUsed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canUpdateHeight = canUpdateHeight(calcProgress(parent)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (canUpdateHeight) { parent.post { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newChildHeight = child.height <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newChildHeight != lastChildHeight) { lastChildHeight = newChildHeight setUpAppbarHeight(child, parent) } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { needToUpdateHeight = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onMeasureChild( parent, child, parentWidthMeasureSpec, widthUsed, parentHeightMeasureSpec, heightUsed ) } <span class="hljs-comment"><span class="hljs-comment">/** * If you use fitsSystemWindows=true in your coordinator layout, * you will have to include statusBar height in the appbarHeight */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcAppbarHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpViews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;RuledView&gt; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideAppbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: AppBarLayout <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideCollapsingToolbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: CollapsingToolbarLayout <span class="hljs-comment"><span class="hljs-comment">/** * You man not want to update height, if height depends on views, that are currently invisible */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canUpdateHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(progress: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcProgress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoordinatorLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Float</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> appBar = parent.provideAppbar() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scrollRange = appBar.totalScrollRange.toFloat() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scrollY = Math.abs(appBar.y) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> scroll = <span class="hljs-number"><span class="hljs-number">1</span></span> - scrollY / scrollRange <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> { scroll.isNaN() -&gt; <span class="hljs-number"><span class="hljs-number">1f</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; scroll } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpAppbarHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewGroup</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { parent.provideCollapsingToolbar().setHeight(calcAppbarHeight(child)) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryToInitHeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(child: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, dependency: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, scrollPercent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needToUpdateHeight &amp;&amp; canUpdateHeight(scrollPercent)) { setUpAppbarHeight(child, dependency <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ViewGroup) needToUpdateHeight = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performRules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(offsetView: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">RuledView</span></span></span></span><span class="hljs-function"><span class="hljs-params">, percent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> view = offsetView.view <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> details = offsetView.details offsetView.rules.forEach { rule -&gt; rule.manage(percent, details, view) } } }</code> </pre><br></div></div><br>  Was ist mit onMeasureChild los? <br><br>  Dies ist notwendig, um das Problem zu lösen, über das ich oben geschrieben habe: Wenn ein Teil der Symbolleiste verschwindet, sollte NestedScroll höher verschoben werden.  Damit es höher fährt, müssen Sie die Höhe des CollapsingToolbarLayout verringern. <br><br>  Es gibt eine andere nicht offensichtliche Methode - canUpdateHeight.  Es wird benötigt, damit Sie dem Erben erlauben können, eine Regel festzulegen, wenn Sie die Höhe nicht ändern können.  Zum Beispiel, wenn die Ansicht, von der die Höhe abhängt, derzeit ausgeblendet ist.  Ich bin nicht sicher, ob dies alle Fälle abdeckt, aber wenn jemand Ideen hat, wie man es besser machen kann, schreibe bitte in einen Kommentar oder in eine persönliche Nachricht. <br><br><h3>  Rechen, auf den Sie bei der Arbeit mit CollapsingToolbarLayout treten können </h3><br><ul><li>  Wenn Sie Ansichten ändern, sollten Sie onLayout vermeiden.  Beispielsweise sollten Sie layoutParams oder textSize in einer BehaviorRule nicht ändern, da sonst die Leistung drastisch beeinträchtigt wird. </li><li>  Wenn Sie über OnOffsetChangedListener mit der Symbolleiste arbeiten möchten, ist onLayout noch gefährlicher - die onOffsetChanged-Methode wird auf unbestimmte Zeit ausgelöst. </li><li>  CoordinatorLayout.Behavior sollte nicht von der Ansicht (layoutDependsOn) abhängen, die in die Sichtbarkeit GONE übergehen kann.  Wenn diese Ansicht zu View.VISIBLE zurückkehrt, reagiert Behavior nicht. </li><li>  Wenn sich die Symbolleiste außerhalb des AppBarLayout befindet, müssen Sie der übergeordneten ViewGroup der Symbolleiste das android-Attribut hinzufügen, damit die Symbolleiste sie nicht blockiert: translationZ = "5dp". </li></ul><br><h3>  Abschließend </h3><br>  Wir haben eine Lösung, mit der Sie Ihr CollapsingToolbarLayout schnell mit einer Logik skizzieren können, die relativ einfach zu lesen und zu ändern ist.  Alle Regeln und Abhängigkeiten werden im Rahmen einer Klasse gebildet - CoordinatorLayout.Behavior.  Der Code kann auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github angezeigt werden</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de426369/">https://habr.com/ru/post/de426369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de426359/index.html">Yandex-Initiative zur Bekämpfung von Piraterie, die nicht von Copyright-Inhabern genehmigt wurde</a></li>
<li><a href="../de426361/index.html">Über das Wunder der Biene und wie wir sie töten</a></li>
<li><a href="../de426363/index.html">Fakten und Hypothesen zum Unfall "Union MS-10"</a></li>
<li><a href="../de426365/index.html">Vertraue nicht, dass Facebook zu spät ist</a></li>
<li><a href="../de426367/index.html">Microsoft hat zwei Drittel seiner Patente an das Open Invention Network (OIN) erteilt.</a></li>
<li><a href="../de426371/index.html">Audio Digest: 17 Materialien und praktische Anleitungen zum Thema professionelle Akustik</a></li>
<li><a href="../de426373/index.html">Funktionen in der Konsole erstellen. Teil 1</a></li>
<li><a href="../de426375/index.html">Technologieanalyse: Wo soll mit der Arbeit an der Patentlandschaft begonnen werden?</a></li>
<li><a href="../de426377/index.html">Spiel mit Mathe-Diagrammen anstelle von Diagrammen</a></li>
<li><a href="../de426379/index.html">Illusionen los</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>