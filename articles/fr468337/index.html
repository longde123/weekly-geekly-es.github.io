<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüíº üë©üèº‚Äçüé§ üôãüèæ Utilisation de cron pour Android et ajout d'un script shell pour l'ex√©cution automatique au d√©marrage de l'appareil ü§´ üßóüèæ üè§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Du fait que les appareils mobiles disposent depuis longtemps de fonctionnalit√©s √©tendues, les t√¢ches d'automatisation peuvent y √™tre facilement transf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation de cron pour Android et ajout d'un script shell pour l'ex√©cution automatique au d√©marrage de l'appareil</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468337/"><img src="https://habrastorage.org/webt/t2/ia/uo/t2iauogb45suwvzulewv9wbktr8.jpeg"><br><br>  Du fait que les appareils mobiles disposent depuis longtemps de fonctionnalit√©s √©tendues, les t√¢ches d'automatisation peuvent y √™tre facilement transf√©r√©es.  Et, aussi bien que possible, cron est tout aussi bon pour les ex√©cuter.  Mais si cron prend un peu de temps dans les syst√®mes Linux "ordinaires", un appareil Android n√©cessite un travail plus compliqu√© pour le configurer. <br><br>  Si vous √™tes int√©ress√© par le sujet de l'automatisation et que vous souhaitez que vos scripts shell s'ex√©cutent imm√©diatement apr√®s le d√©marrage de l'appareil, et pourraient m√™me d√©marrer sur une minuterie - bienvenue au chat! <br><a name="habracut"></a><br><h2>  Pr√©face </h2><br>  Je suis engag√© dans l'automatisation des appareils mobiles pour Android.  Et lors de l'ex√©cution de scripts automatiques, de nombreuses situations impr√©vues se produisent, m√™me si les m√™mes appareils sont utilis√©s pour les tests. <br><br>  Probl√®mes les plus courants: <br><br>  0. Le script d'automatisation ne fait pas ce que vous vouliez. <br>  1. L'application mobile est t√©l√©charg√©e automatiquement <br>  2. Red√©marrage automatique du t√©l√©phone <br>  3. L'application mobile ne d√©marre pas automatiquement apr√®s un red√©marrage <br>  4. Le module Wi-Fi s'√©teint de mani√®re al√©atoire, ne trouve pas le r√©seau, ne se connecte pas au r√©seau <br>  5. Le r√©seau mobile a soudainement disparu <br>  6. Le t√©l√©phone est pass√© en mode veille <br>  7. Le proxy a chut√© ou le serveur lui-m√™me ou le serveur a renvoy√© une r√©ponse √©trange <br><br>  Pour cette raison, vous devez constamment surveiller l'appareil et d√©tecter ces situations impr√©vues. <br><br><img src="https://habrastorage.org/webt/93/fb/-1/93fb-1wjpwjs3tcpvv4jzg9b2zw.png"><br><br>  Ainsi, je suis arriv√© √† la conclusion que cron avec les scripts "corrects" vous permettra de suivre les pannes logicielles et de restaurer le script d'automatisation ou de le relancer.  Mais il s'est av√©r√© que, bien qu'Android contienne le noyau Linux, il y a des nuances sp√©ciales avec lesquelles j'ai d√ª faire face.  Commen√ßons donc la configuration! <br><br><h2>  Configuration de Cron </h2><br><h3>  Personnalisez l'environnement </h3><br><ol><li>  Installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adb</a> pour acc√©der √† l'appareil via le shell √† l'aide d'un c√¢ble USB. </li><li>  Nous ouvrons la section <b>Pour les d√©veloppeurs</b> .  Pour ce faire, allez dans la section <b>√Ä propos du t√©l√©phone</b> et faites quelques clics sur le <b>num√©ro de build</b> ou quelque chose de similaire. </li><li>  Nous allons √† la section <b>Pour les d√©veloppeurs</b> et l'activons.  Nous connectons l'appareil √† l'ordinateur et autorisons l'acc√®s sur cet ordinateur √† cet appareil. </li><li>  Ajoutez la <b>racine</b> pour votre appareil.  Les options les plus courantes sont <b>SuperSu</b> , <b>Magisk</b> et <b>Kingroot</b> .  Acc√©dez √† w3bsit3-dns.com et recherchez l'option racine pour votre appareil.  Malheureusement, il n'y a pas de racine universelle. </li><li>  Nous installons <b>BusyBox</b> (c'est aussi sur w3bsit3-dns.com, par exemple), car il contient juste un programme cron. </li></ol><br><h3>  R√©glage de d√©marrage manuel </h3><br><ol><li>  Nous nous connectons au t√©l√©phone √† l'aide <b>du shell adb</b> (si adb n'est pas enregistr√© dans votre variable d'environnement, ajoutez le chemin complet. </li><li>  Passez en mode root avec la commande <b>su</b> </li><li>  Nous v√©rifions la pr√©sence du programme cron et voyons les param√®tres √† l'aide de la commande <b>crond -h</b> </li></ol><br><div class="spoiler">  <b class="spoiler_title">r√©sultat d'ex√©cution</b> <div class="spoiler_text"><pre><code class="bash hljs">crond: invalid option -- h BusyBox v1.29.2-Stericson (2018-08-12 11:19:12 EDT) multi-call binary. Usage: crond -fbS -l N -d N -L LOGFILE -c DIR -f Foreground -b Background (default) -S Log to syslog (default) -l N Set <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> level. Most verbose 0, default 8 -d N Set <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> level, <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> to stderr -L FILE Log to FILE -c DIR Cron dir. Default:/var/spool/cron/crontabs</code> </pre> <br></div></div><br>  Comme vous pouvez le voir sur la derni√®re ligne, les instructions par d√©faut doivent √™tre stock√©es dans le r√©pertoire <b>/ var / spool / cron / crontabs</b> , qui n'est pas cr√©√© automatiquement et si nous <b>ex√©cutons</b> la commande <pre> <code class="bash hljs">crond -b</code> </pre>  puis v√©rifiez si le processus a commenc√© <pre> <code class="bash hljs">ps | grep crond</code> </pre>  , alors il peut ne pas √™tre l√†, car  il n'a pu obtenir aucune instruction.  Ex√©cutons donc la commande <pre> <code class="bash hljs">crond -b -fd0</code> </pre>  et voyez quelle est la raison.  Vous aurez probablement une erreur similaire: <br>  <code>crond: can't change directory to '/var/spool/cron/crontabs': No such file or directory</code> .  Dans ce cas, c'est normal, car  √† l'avenir, nous indiquerons nous-m√™mes le chemin vers le fichier ex√©cutable crontab. <br><br>  4. Cr√©ez un fichier crontab simple: <br><br><pre> <code class="bash hljs">mkdir /data/crontab <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"*/1 * * * * echo 'text' &gt;&gt; /sdcard/test.txt"</span></span> &gt; /data/crontab/root</code> </pre> <br>  Nous avons maintenant une t√¢che qui, chaque minute, ajoutera le mot <i>texte</i> au fichier <b>/sdcard/test.txt</b> <br>  Nous lan√ßons: <pre> <code class="bash hljs">crond -b -fd0 -c /data/crontab</code> </pre>  et obtenez le journal suivant: <br><br><pre> <code class="bash hljs">crond: crond (busybox 1.29.2-Stericson) started, <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> level 0 crond: ignoring file <span class="hljs-string"><span class="hljs-string">'root'</span></span> (no such user) ...</code> </pre> <br>  Bien s√ªr, c'est un peu surprenant, car si nous <b>ex√©cutons la commande whoami,</b> elle retournera <b>root</b> en cons√©quence. <br><br>  5. Ajoutez l'utilisateur root, car crond demande: <br><br><pre> <code class="bash hljs">mount -o remount,rw /system; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"root:x:0:0::/system/etc/crontabs:/system/bin/sh"</span></span> &gt;&gt; /system/etc/passwd; mount -o remount,ro /system;</code> </pre> <br>  En raison de l'absence de ce fichier, j'ai r√©alis√© que dans le syst√®me Android, il n'√©tait pas du tout impliqu√©.  Si vous √™tes s√ªr de l'emplacement de stockage de vos fichiers crontab, vous pouvez remplacer la ligne <b>/ system / etc / crontabs</b> par celle dont vous avez besoin.  Ex√©cutez √† nouveau la commande <br><br><pre> <code class="bash hljs">crond -b -fd0 -c /data/crontab</code> </pre> <br>  Et nous obtenons ce qui suit: <br><br><pre> <code class="bash hljs">crond: user:root entry:*/1 * * * * <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt 111111111111111111111111111111111111111111111111111111111111 111111111111111111111111 11111111111111111111111111111111 111111111111 1111111 crond: wakeup dt=16 crond: file root: crond: line <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt crond: job: 0 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt crond: can<span class="hljs-string"><span class="hljs-string">'t change directory to '</span></span>/system/etc/crontabs<span class="hljs-string"><span class="hljs-string">' crond: can'</span></span>t change directory to <span class="hljs-string"><span class="hljs-string">'/var/spool/cron'</span></span>: No such file or directory crond: USER root pid 12849 cmd <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt</code> </pre> <br>  Bien que, selon le journal, la t√¢che ait √©t√© enregistr√©e dans crond, mais dans mon cas, le fichier n'a pas √©t√© cr√©√©.  Le probl√®me peut √™tre r√©solu tr√®s simplement: <br><br><pre> <code class="bash hljs">mkdir -p /system/etc/crontabs</code> </pre> <br>  Eh bien, il veut qu'un r√©pertoire existe l√†-bas, qui sommes-nous pour lui interdire!  Nous recommen√ßons et voyons: <br><br><pre> <code class="bash hljs">crond: user:root entry:*/1 * * * * <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt 111111111111111111111111111111111111111111111111111111111111 111111111111111111111111 11111111111111111111111111111111 111111111111 1111111 crond: wakeup dt=12 crond: file root: crond: line <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt crond: job: 0 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt crond: child running /system/bin/sh crond: USER root pid 13033 cmd <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'text'</span></span> &gt;&gt; /sdcard/test.txt</code> </pre> <br>  Les erreurs ont disparu et la ligne <b>crond: enfant ex√©cutant / system / bin / sh est apparue</b> .  Enfin, cron a √©t√© cl√¥tur√© avec succ√®s, et vous pouvez passer √† la deuxi√®me partie! <br><br><h2>  T√©l√©chargement automatique du script shell </h2><br>  Le syst√®me Linux a un r√©pertoire <b>init.d</b> qui est responsable du d√©marrage automatique imm√©diatement apr√®s le d√©marrage du syst√®me, alors essayons de cette fa√ßon! <br><br>  1. V√©rifiez si ce r√©pertoire existe sur votre appareil (c'est <b>/etc/init.d</b> ou <b>/system/etc/init.d</b> - c'est la m√™me partition mont√©e, etc.).  Dans mon cas, ce n'est pas le cas.  Eh bien, alors cr√©ez: <br><br><pre> <code class="bash hljs">mount -o remount,rw /system mkdir /system/etc/init.d chmod 0755 /system/etc/init.d mount -o remount,ro /system</code> </pre> <br>  Maintenant, ajoutez-y un script simple, par exemple: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"echo 'Init.d is working !!!' &gt;&gt; /sdcard/init_test.log"</span></span> &gt; /system/etc/init.d/90my_script chmod 777 /system/etc/init.d/90my_script</code> </pre> <br>  Nous red√©marrons l'appareil et voyons si un miracle s'est produit ... Malheureusement, mon fichier n'est pas apparu. <br><br>  Nous examinons le syst√®me plus loin et recherchons un fichier init qui peut ex√©cuter des scripts apr√®s le lancement.  J'avais un fichier dans <b>/init.rc</b> sur mon appareil.  Eh bien, essayons de le changer et de red√©marrer l'appareil: <br><br><pre> <code class="bash hljs">mount -o remount,rw / <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"echo 'Init.d is working !!!' &gt;&gt; /sdcard/init_test.log"</span></span> &gt;&gt; /init.rc mount -o remount,ro / reboot</code> </pre> <br>  Mais le fichier n'a pas √©t√© recr√©√©.  Nous allons regarder le fichier <b>/init.rc</b> et notre dossier a disparu et le fichier ne semble pas changer, car  la date de cr√©ation est assez √©trange (dans mon cas, 1er janvier 70 05:00:00). <br><br>  Nous continuons √† comprendre, et il s'av√®re que ce fichier est stock√© dans <b>boot.img</b> , et chaque fois qu'il en sort.  Et pour changer la fonctionnalit√© du fichier <b>init.rc</b> , <b>vous</b> devez faire tout <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cela</a> . <br><br>  Mais il existe un moyen plus simple de r√©soudre ce probl√®me.  Pour cette m√©thode, nous pouvons utiliser le script shell suivant (merci √† Ryuinferno): <br><br><div class="spoiler">  <b class="spoiler_title">Script shell</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/system/bin/sh #Script to enable init.d by Ryuinferno @ XDA error_msg(){ echo "You do not need this mod..." sleep 1 echo "If you are reapplying, please delete these files if present:" echo "/system/bin/sysinit" sleep 1 echo "/system/etc/install-recovery.sh" sleep 1 echo "/system/etc/install-recovery-2.sh" sleep 1 echo "And run again..." sleep 1 echo "If init.d is still not working, read the FAQ part in my thread..." sleep 1 echo "Aborting..." mount -o remount,ro -t auto /system echo "" echo "Ryuinferno @ XDA" exit 1 } echo "Init.d Enabler by Ryuinferno @ XDA" echo "" sleep 1 id=`id`; id=`echo ${id#*=}`; id=`echo ${id%%\(*}`; id=`echo ${id%% *}` if [ "$id" != "0" ] &amp;&amp; [ "$id" != "root" ]; then echo "Script NOT running as root!" sleep 1 echo "Superuser access not granted!" sleep 1 echo "Please type 'su' first before running this script..." exit 1 else echo "Hello Supaa User! :P" echo "" sleep 1 fi if [ ! "'which busybox'" ]; then echo "busybox NOT INSTALLED!" sleep 1 echo "Please install busybox first!" exit 1 else echo "busybox found!" sleep 1 fi bbb=0 if [ ! "`which grep`" ]; then bbb=1 echo "grep applet NOT FOUND!" sleep 1 else echo "Awesome! grep found! :D" sleep 1 fi if [ ! "`which run-parts`" ]; then bbb=1 echo "run-parts applet NOT FOUND!" sleep 1 else echo "Good! run-parts found! :)" echo "" sleep 1 fi if [ $bbb -eq 1 ] ; then echo "" echo "Required applets are NOT FOUND!" echo "" sleep 1 echo "Please reinstall busybox!" exit 1 fi echo "Great! Let's proceed..." echo "" sleep 1 echo "Press enter to continue..." read enterKey clear sleep 1 echo "Mounting system as rewritable..." mount -o remount,rw -t auto /system sleep 1 echo "Removing old sysinit file" rm /system/bin/sysinit sleep 1 echo "" echo "Checking for the presence of sysinit in /system/bin..." sleep 1 if [ -e /system/bin/sysinit ]; then echo "sysinit found..." if [ -z "`cat /system/bin/sysinit | grep "init.d"`" ]; then echo "Adding lines to sysinit..." echo "" &gt;&gt; /system/bin/sysinit echo "# init.d support" &gt;&gt; /system/bin/sysinit echo "" &gt;&gt; /system/bin/sysinit echo "export PATH=/sbin:/system/sbin:/system/bin:/system/xbin" &gt;&gt; /system/bin/sysinit echo "run-parts /system/etc/init.d" &gt;&gt; /system/bin/sysinit echo "" &gt;&gt; /system/bin/sysinit else echo "" echo "Your sysinit should already be running the scripts in init.d folder at boot..." error_msg fi else echo "sysinit not found, creating file..." echo "#!/system/bin/sh" &gt; /system/bin/sysinit echo "# init.d support" &gt;&gt; /system/bin/sysinit echo "" &gt;&gt; /system/bin/sysinit echo "export PATH=/sbin:/system/sbin:/system/bin:/system/xbin" &gt;&gt; /system/bin/sysinit echo "run-parts /system/etc/init.d" &gt;&gt; /system/bin/sysinit echo "" &gt;&gt; /system/bin/sysinit fi sleep 1 echo "Setting correct permissions and ownership for sysinit..." chmod 755 /system/bin/sysinit chown 0.2000 /system/bin/sysinit sleep 1 echo "" echo "Checking for the presence of install-recovery.sh..." sleep 1 if [ -f /system/etc/install-recovery.sh ] &amp;&amp; [ -z "`cat /system/etc/install-recovery.sh | grep "daemon"`" ]; then if [ ! -z "`cat /system/etc/install-recovery.sh | grep "init.d"`" ];then echo "Your install-recovery.sh seems to be already modified for init.d..." error_msg fi echo "install-recovery.sh found, renaming it as install-recovery-2.sh..." mv /system/etc/install-recovery.sh /system/etc/install-recovery-2.sh echo "Recreating install-recovery.sh..." echo "#!/system/bin/sh" &gt; /system/etc/install-recovery.sh echo "# init.d support" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh echo "/system/bin/sysinit" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh echo "# excecuting extra commands" &gt;&gt; /system/etc/install-recovery.sh echo "/system/etc/install-recovery-2.sh" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh elif [ -f /system/etc/install-recovery.sh ] &amp;&amp; [ ! -z "`cat /system/etc/install-recovery.sh | grep "daemon"`" ]; then if [ -f /system/etc/install-recovery-2.sh ] &amp;&amp; [ ! -z "`cat /system/etc/install-recovery-2.sh | grep "init.d"`" ];then echo "Your install-recovery-2.sh seems to be already modified for init.d..." error_msg fi echo "install-recovery.sh is used for superuser, using install-recovery-2.sh instead..." if [ -f /system/etc/install-recovery-2.sh ]; then echo "" &gt;&gt; /system/etc/install-recovery-2.sh echo "# init.d support" &gt;&gt; /system/etc/install-recovery-2.sh echo "/system/bin/sysinit" &gt;&gt; /system/etc/install-recovery-2.sh echo "" &gt;&gt; /system/etc/install-recovery-2.sh else echo "#!/system/bin/sh" &gt; /system/etc/install-recovery-2.sh echo "# init.d support" &gt;&gt; /system/etc/install-recovery-2.sh echo "" &gt;&gt; /system/etc/install-recovery-2.sh echo "/system/bin/sysinit" &gt;&gt; /system/etc/install-recovery-2.sh echo "" &gt;&gt; /system/etc/install-recovery-2.sh fi if [ -z "`cat /system/etc/install-recovery.sh | grep "install-recovery-2.sh"`" ]; then echo "" &gt;&gt; /system/etc/install-recovery.sh echo "# extra commands" &gt;&gt; /system/etc/install-recovery.sh echo "/system/etc/install-recovery-2.sh" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh fi else echo "install-recovery.sh not found, creating it..." echo "#!/system/bin/sh" &gt; /system/etc/install-recovery.sh echo "# init.d support" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh echo "/system/bin/sysinit" &gt;&gt; /system/etc/install-recovery.sh echo "" &gt;&gt; /system/etc/install-recovery.sh fi sleep 1 echo "Setting the correct permissions and ownership for install-recovery.sh..." echo "Also for install-recovery-2.sh if it exists..." chmod 755 /system/etc/install-recovery.sh chown 0.0 /system/etc/install-recovery.sh if [ -f /system/etc/install-recovery-2.sh ]; then chmod 755 /system/etc/install-recovery-2.sh chown 0.0 /system/etc/install-recovery-2.sh fi sleep 1 echo "" echo "Checking for the presence of the init.d folder..." sleep 1 if [ -d /system/etc/init.d ]; then echo "init.d folder found..." else echo "init.d folder not found, creating the folder..." mkdir /system/etc/init.d fi sleep 1 echo "" echo "Creating basic init.d scripts..." echo "#!/system/bin/sh" &gt; /system/etc/init.d/08setperm echo "#set correct permissions to /system/etc/init.d folder" &gt;&gt; /system/etc/init.d/08setperm echo "" &gt;&gt; /system/etc/init.d/08setperm echo "mount -o remount,rw -t auto /system" &gt;&gt; /system/etc/init.d/08setperm echo "chmod -R 777 /system/etc/init.d" &gt;&gt; /system/etc/init.d/08setperm echo "mount -o remount,ro -t auto /system" &gt;&gt; /system/etc/init.d/08setperm echo "" &gt;&gt; /system/etc/init.d/08setperm echo "#!/system/bin/sh" &gt; /system/etc/init.d/00test echo "#init.d test" &gt;&gt; /system/etc/init.d/00test echo "" &gt;&gt; /system/etc/init.d/00test echo "if [ -f /data/Test.log ]; then" &gt;&gt; /system/etc/init.d/00test echo "rm /data/Test.log" &gt;&gt; /system/etc/init.d/00test echo "fi" &gt;&gt; /system/etc/init.d/00test echo "" &gt;&gt; /system/etc/init.d/00test echo 'echo "Init.d is working !!!" &gt;&gt; /data/Test.log' &gt;&gt; /system/etc/init.d/00test echo 'echo "excecuted on $(date +"%d-%m-%Y %r" )" &gt;&gt; /data/Test.log' &gt;&gt; /system/etc/init.d/00test echo "" &gt;&gt; /system/etc/init.d/00test sleep 1 echo "Creating permissive SELinux script..." sleep 1 echo "#!/system/bin/sh" &gt;&gt; /system/etc/init.d/01permissive echo "#Init.d Permissive SELinux" &gt;&gt; /system/etc/init.d/01permissive echo "" &gt;&gt; /system/etc/init.d/01permissive echo "busybox mount -o remount,rw -t auto /system" &gt;&gt; /system/etc/init.d/01permissive echo "" &gt;&gt; /system/etc/init.d/01permissive echo "setenforce 0" &gt;&gt; /system/etc/init.d/01permissive echo "SELINUX=permissive" &gt;&gt; /system/etc/init.d/01permissive echo "" &gt;&gt; /system/etc/init.d/01permissive sleep 1 echo "Setting correct permissions and ownership for init.d folder and scipts..." chmod 777 /system/etc/init.d chmod 777 /system/etc/init.d/08setperm chmod 777 /system/etc/init.d/00test chmod 777 /system/etc/init.d/01permissive chown 0.0 /system/etc/init.d chown 0.0 /system/etc/init.d/08setperm chown 0.0 /system/etc/init.d/00test chown 0.0 /system/etc/init.d/01permissive sleep 1 echo "" echo "Mounting system as read-only..." mount -o remount,ro -t auto /system sleep 1 echo "" echo "Done!!!" sleep 1 echo "Please reboot at least twice before checking /data..." sleep 1 echo "If init.d is working, you will see a Test.log in /data..." sleep 1 echo "" echo "Enjoy!!! =)" echo "Ryuinferno @ XDA 2013" exit</span></span></code> </pre><br></div></div><br>  Premiers pas avec le script!  Dans mon cas, il s'appellera init.sh. <br>  1. T√©l√©chargez le fichier sur la carte SD de l'appareil mobile: <br><pre> <code class="bash hljs">adb push /tmp/init.sh /sdcard</code> </pre> <br>  2. Copiez dans la m√©moire de l'appareil mobile et d√©finissez les droits n√©cessaires: <br><pre> <code class="bash hljs">adb shell su cp /sdcard/init.sh /data/init.sh chmod 777 /data/init.sh</code> </pre> <br>  3. Ex√©cuter pour ex√©cution: <br><pre> <code class="bash hljs">/data/init.sh</code> </pre> <br>  Et faites attention au journal qui s'affiche.  Voici mon journal: <br><div class="spoiler">  <b class="spoiler_title">Ex√©cuter le journal</b> <div class="spoiler_text"><pre> <code class="bash hljs">Init.d Enabler by Ryuinferno @ XDA Hello Supaa User! :P busybox found! Awesome! grep found! :D Good! run-parts found! :) Great! Let<span class="hljs-string"><span class="hljs-string">'s proceed... Press enter to continue... Mounting system as rewritable... Removing old sysinit file rm: /system/bin/sysinit: No such file or directory Checking for the presence of sysinit in /system/bin... sysinit not found, creating file... Setting correct permissions and ownership for sysinit... Checking for the presence of install-recovery.sh... install-recovery.sh not found, creating it... Setting the correct permissions and ownership for install-recovery.sh... Also for install-recovery-2.sh if it exists... Checking for the presence of the init.d folder... init.d folder found... Creating basic init.d scripts... Creating permissive SELinux script... Setting correct permissions and ownership for init.d folder and scipts... Mounting system as read-only... Done!!! Please reboot at least twice before checking /data... If init.d is working, you will see a Test.log in /data... Enjoy!!! =) Ryuinferno @ XDA 2013</span></span></code> </pre> <br></div></div><br>  Comme vous pouvez le voir dans le journal, il n'y a aucune erreur, alors n'h√©sitez pas √† red√©marrer l'appareil!  Peut-√™tre que quelqu'un a d√©j√† travaill√© et que vous pouvez trouver le fichier <b>/data/Test.log</b> , mais je ne l'ai pas.  V√©rifiez le r√©pertoire <b>/system/etc/init.d</b> √† l'aide de la <b>commande ls</b> : <br><br><pre> <code class="bash hljs">00test 01permissive 08setperm</code> </pre> <br>  Comme vous pouvez le voir, les t√¢ches ont √©t√© cr√©√©es avec succ√®s.  Vous devrez peut-√™tre encore modifier <b>boot.img</b> , mais v√©rifions au d√©but, o√π se trouve le fichier <b>install-recovery.sh</b> avec la commande <br><br><pre> <code class="bash hljs">find / -name <span class="hljs-string"><span class="hljs-string">"install-recovery.sh"</span></span> ... /system/bin/install-recovery.sh /system/etc/install-recovery.sh ...</code> </pre> <br>  Comme nous pouvons le voir, nous avons 2 fichiers qui se trouvent √† diff√©rents endroits.  √Ä la date de cr√©ation, nous pouvons remarquer que le script a cr√©√© le fichier dans le r√©pertoire <b>/system/etc/install-recovery.sh</b> , bien que, dans certains cas, il doive peut-√™tre le cr√©er dans <b>/ system / etc.</b>  Renommons le fichier en bin et copions le fichier depuis etc: <br><br><pre> <code class="bash hljs">mount -o remount,rw /system mv /install-recovery.sh /system/bin/install-recovery2.sh cp /install-recovery.sh /system/bin/</code> </pre> <br><br>  <b>UPD</b> : Veuillez noter que le contexte de s√©curit√© pour les deux fichiers doit correspondre.  Et si vous vous √™tes soudainement perdu lors de la copie (bien qu'en th√©orie cela ne devrait pas l'√™tre), vous devrez le restaurer (par exemple, via l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chcon</a> ).  Voir les informations compl√®tes sur le fichier avec <b>ls -lZ</b> : <br><pre> <code class="bash hljs">ls -lZ /system/etc/install-recovery.sh <span class="hljs-comment"><span class="hljs-comment"># -rwxr-xr-x root root u:object_r:system_file:s0 install-recovery.sh</span></span></code> </pre><br>  Ici <b>u: object_r: system_file: s0</b> correspond aux contextes de s√©curit√©. <br><br>  Et encore une fois, nous red√©marrons l'appareil ... Et maintenant, enfin, le SUCC√àS tant attendu!  Le fichier <b>/data/Test.log est</b> apparu! <br><br>  Une fois que tout fonctionne, allez dans <b>/system/etc/init.d</b> et cr√©ez un script shell.  Et dedans, lancez simplement notre crond pour ex√©cuter: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"#!/system/bin/sh crond -b -L /sdcard/error.log -c /data/crontab"</span></span> &gt; /system/etc/init.d/99cronstart chmod 777 /system/etc/init.d/99cronstart reboot</code> </pre> <br>  Apr√®s le t√©l√©chargement, v√©rifiez si crond a d√©marr√©: <br><br><pre> <code class="bash hljs">ps | grep crond root 414 1 9532 236 hrtimer_na 000dcf90 S crond</code> </pre> <br>  Et nous pourrions terminer maintenant, mais attendons une minute et voyons s'il y avait un enregistrement dans notre dossier ... Eh bien, comme vous l'avez d√©j√† compris, encore une fois, rien n'a fonctionn√©.  Le fait est que ce processus doit √™tre ex√©cut√© √† partir d'un super utilisateur.  Modifiez le script dans le fichier <b>99cronstart</b> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"#!/system/bin/sh /su/bin/su -c crond -b -L /sdcard/error.log -c /data/crontab"</span></span> &gt; /system/etc/init.d/99cronstart reboot</code> </pre> <br><br>  <b>UPD</b> : Peut-√™tre que dans votre cas, <b>su</b> aura un chemin diff√©rent, puis utilisez la commande <b>su</b> et remplacez le chemin par le v√¥tre. <br><br>  Maintenant, notre appareil Android prend en charge les t√¢ches cron et peut contenir des scripts shell pour un lancement automatique! <br><br>  Et enfin, le script qui va ex√©cuter notre application, s'il n'est pas dans les processus et enregistrer des informations sur ce qui √©tait sur l'√©cran principal avant de lancer notre application: <br><br><pre> <code class="bash hljs">proc=$(ps | grep <span class="hljs-string"><span class="hljs-string">"com.test.app"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$proc</span></span></span><span class="hljs-string">"</span></span> == <span class="hljs-string"><span class="hljs-string">""</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> dumpsys window | grep CurrentFocus &gt; /sdcard/current_focus.dump sleep 1 am start -n com.test.app/com.test.app.activities.MainActivity <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468337/">https://habr.com/ru/post/fr468337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468323/index.html">Quel bruit aide √† se concentrer et √† se d√©tendre, et emp√™che √©galement la perte d'audition dans les accidents graves</a></li>
<li><a href="../fr468327/index.html">Gap - un brillant avenir pour l'indentation dans Flexbox (comme dans Grid)</a></li>
<li><a href="../fr468329/index.html">Le test A / B ne suffit pas</a></li>
<li><a href="../fr468331/index.html">Moments de vie de Stephen Wolfram - cr√©ateur de Mathematica, Wolfram | Alpha, un nouveau type de science et bien plus encore</a></li>
<li><a href="../fr468333/index.html">Comment d√©boguer et profiler n'importe quel fichier EXE √† l'aide de Visual Studio</a></li>
<li><a href="../fr468339/index.html">Pr√©sentation du th√®me sombre pour Visual Studio App Center</a></li>
<li><a href="../fr468341/index.html">Azure Cloud Shell sur Windows Terminal</a></li>
<li><a href="../fr468343/index.html">Jeff Bezos: ¬´Aller dans l'espace pour le bien de la Terre¬ª</a></li>
<li><a href="../fr468345/index.html">GitHub lance ses tentacules dans la gestion des CI / CD et des artefacts</a></li>
<li><a href="../fr468347/index.html">MetricKit. Analyse des performances des applications iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>