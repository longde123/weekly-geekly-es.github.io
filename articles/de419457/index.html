<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìé üßë üêï RabbitMQ - SQL Server üßöüèø üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø üë©üèº‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor ein oder zwei Wochen sah ich im RabbitMQ-Benutzerforum eine Nachricht dar√ºber, wie das Senden von Nachrichten von SQL Server an RabbitMQ eingerich...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RabbitMQ - SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419457/">  Vor ein oder zwei Wochen sah ich im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RabbitMQ-Benutzerforum</a> eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nachricht</a> dar√ºber, wie das Senden von Nachrichten von SQL Server an RabbitMQ eingerichtet wird.  Da wir eng mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Derivco zusammenarbeiten</a> , habe ich dort einige Vorschl√§ge hinterlassen und auch gesagt, dass ich einen Blog dar√ºber schreibe, wie das geht.  Ein Teil meiner Nachricht war nicht ganz wahr - zumindest bis zu diesem Moment (sorry, Bro, er war sehr besch√§ftigt). <br><br>  Tolle Sache, das ist dein <b>SQL Server</b> .  Die Verwendung ist sehr einfach, um Informationen in eine Datenbank zu stellen.  Das Abrufen von Daten aus einer Datenbank mithilfe einer Abfrage ist ebenso einfach.  Das Abrufen der gerade aktualisierten oder eingef√ºgten Daten ist jedoch bereits etwas schwieriger.  Denken Sie an Echtzeitereignisse.  Ein Kauf wird get√§tigt - jemand muss sofort dar√ºber informiert werden, sobald dies geschehen ist.  Vielleicht wird jemand sagen, dass solche Daten nicht aus der Datenbank, sondern von einem anderen Ort entfernt werden sollten.  Das ist nat√ºrlich der Fall, aber oft haben wir einfach keine Wahl. <br><a name="habracut"></a><br>  Wir hatten eine Aufgabe: Ereignisse aus der Datenbank zur weiteren Verarbeitung nach drau√üen senden, und die Frage war: Wie geht das? <br><br><h3>  SQL Server und externe Kommunikation </h3><br>  W√§hrend der Existenz von SQL Server gab es mehrere Versuche, die Kommunikation au√üerhalb der Datenbank zu organisieren.  <b>SQL Server Notification Services</b> (NS), die in SQL Server 2000 und sp√§ter in SQL Server 2005 <b>angezeigt wurden</b> , wurden in <b>SQL Server Service Broker</b> (SSB) angezeigt.  Ich habe sie in meinem Buch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ein erster Blick auf SQL Server 2005 f√ºr Entwickler</a> zusammen mit Bob Boshemen und Dan Sullivan beschrieben.  NS erschien wie gesagt in SQL Server 2000 und wurde in der Beta-Version von SQL Server 2005 neu gestaltet. NS wurde jedoch <s>vollst√§ndig</s> von der verkaufsfertigen Version (RTM) von SQL Server 2005 ausgeschlossen. <br><blockquote>  <b>Hinweis:</b> Wenn Sie das Buch lesen, finden Sie dort eine Reihe von Funktionen, die nicht in der RTM-Version enthalten waren. </blockquote>  SSB √ºberlebte und Microsoft f√ºhrte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Service Broker External Activator</a> (EA) in sein SQL Server 2008 Feature Pack ein.  Es erm√∂glicht √ºber den SSB die Interaktion au√üerhalb der lokalen Datenbank.  Theoretisch klingt es gut, aber in der Praxis ist es umst√§ndlich und verwirrend.  Wir haben einige Tests durchgef√ºhrt und schnell festgestellt, dass es nicht das tut, was wir brauchen.  Au√üerdem hat uns SSB nicht die Leistung geliefert, die wir brauchten, also mussten wir etwas anderes erfinden. <br><br><h3>  SQLCLR </h3><br>  Das Ergebnis war die SQLCLR-Technologie.  SQLCLR ist eine .NET-Plattform, die in den SQL Server-Kern integriert ist und zum Ausf√ºhren von .NET-Code im Kernel verwendet werden kann.  Da wir .NET-Code ausf√ºhren, k√∂nnen wir fast alles wie in einer normalen .NET-Anwendung ausf√ºhren. <br><blockquote>  <b>Hinweis:</b> Ich habe oben ‚Äûfast‚Äú geschrieben, da es tats√§chlich einige Einschr√§nkungen gibt.  In diesem Zusammenhang haben diese Einschr√§nkungen fast keine Auswirkungen auf das, was wir tun werden. <br></blockquote>  Das Funktionsprinzip von SQLCLR lautet wie folgt: Der Code wird in eine DLL-Bibliothek kompiliert und anschlie√üend mit den SQL Server-Tools registriert: <br><br>  Baugruppe erstellen <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [RabbitMQ.SqlServer] AUTHORIZATION rmq <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'F:\some_path\RabbitMQSqlClr4.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span>; GO</code> </pre> <br>  <b>Code-Snippet 1:</b> Erstellen einer Assembly entlang eines absoluten Pfads <br><br>  Der Code f√ºhrt die folgenden Aktionen aus: <br><br><ul><li>  <code>CREATE ASSEMBLY</code> - Erstellt eine Assembly mit dem angegebenen Namen (unabh√§ngig davon, wie sie aussehen soll). </li><li>  <code>AUTHORIZATION</code> - Zeigt den Eigent√ºmer der Baugruppe an.  In diesem Fall ist rmq eine vordefinierte SQL Server-Rolle. </li><li>  <code>FROM</code> - Bestimmt, wo sich die urspr√ºngliche Baugruppe befindet.  In der <code>FROM</code> k√∂nnen Sie den Pfad auch in Bin√§r- oder UNC-Formaten angeben.  Die Installationsdateien f√ºr dieses Projekt verwenden eine bin√§re Darstellung. </li><li>  <code>WITH PERMISSION_SET</code> - Legt Berechtigungen fest.  <code>UNSAFE</code> ist weniger streng und in diesem Fall notwendig. </li></ul><br><blockquote>  <b>Hinweis:</b> Unabh√§ngig von der in der <code>AUTHORIZATION</code> Klausel verwendeten Rolle oder Anmeldung muss die Appdomain-Klasse mit demselben Namen erstellt werden wie beim Laden der Assembly in die Dom√§ne.  Es wird empfohlen, Assemblys mit unterschiedlichen Namen von Appdomain-Klassen zu trennen, damit der Rest nicht herunterf√§llt, wenn eine Assembly fehlschl√§gt.  Wenn Assemblys jedoch voneinander abh√§ngig sind, k√∂nnen sie nicht in verschiedene Klassen unterteilt werden. <br></blockquote>  Wenn die Assembly erstellt wird, erstellen wir darin Wrapper f√ºr .NET-Methoden: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> rmq.pr_clr_PostRabbitMsg @EndpointID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @Message <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [RabbitMQ.SqlServer].[RabbitMQSqlClr.RabbitMQSqlServer].[pr_clr_PostRabbitMsg]; GO</code> </pre><br>  <b>Code-Snippet 2:</b> .NET Method Wrapper <br><br>  Der Code f√ºhrt die folgenden Aktionen aus: <br><br><ul><li>  Erstellt eine gespeicherte T-SQL-Prozedur mit dem Namen <code>rmq.pr_clr_PostRabbitMsg</code> , die zwei Parameter <code>rmq.pr_clr_PostRabbitMsg</code> .  <code>@EndpointID</code> und <code>@Message</code> . </li><li>  Anstelle des Hauptteils der Prozedur wird eine externe Quelle verwendet, die besteht aus: <br><ul><li>  Zusammenbauen namens <code>RabbitMQ.SqlServer</code> , t. E. Das Ger√§t , dass wir oben im <b>Code</b> - <b>Schnipsel 1</b> erstellt haben <b>.</b> </li><li>  Vollst√§ndiger Typ (Namespace und Klasse): <code>RabbitMQSqlClr.RabbitMQSqlServer</code> </li><li>  Die Methode aus dem obigen Namespace und der Klasse lautet: <code>pr_clr_PostRabbitMsg</code> . </li></ul></li></ul><br>  Wenn <code>rmq.pr_clr_PostRabbitMsg</code> , wird die Methode <code>pr_clr_PostRabbitMsg</code> aufgerufen. <br><blockquote>  <b>Hinweis:</b> Beim Erstellen einer Prozedur wird beim Namen der Assembly im Gegensatz zum vollst√§ndigen Namen des Typs und der Methode nicht zwischen Gro√ü- und Kleinschreibung unterschieden.  Es ist nicht erforderlich, dass der Name der zu erstellenden Prozedur mit dem Namen der Methode √ºbereinstimmt.  Die endg√ºltigen Datentypen f√ºr die Parameter m√ºssen jedoch √ºbereinstimmen. </blockquote>  Wie ich bereits sagte, haben wir Derivco ein Bedarf Daten au√üerhalb von SQL Server zu senden, damit wir die SQLCLR und verwenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RabbitMQ</a> (RMQ). <br><br><h3>  Rabbitmq </h3><br>  RMQ ist ein Open Source Message Broker, der das Advanced Message Queuing Protocol (AMQP) implementiert und in Erlang geschrieben ist. <br><br>  Da RMQ ein Nachrichtenbroker ist, m√ºssen AMQP-Clientbibliotheken eine Verbindung herstellen.  Die Anwendung verweist auf Clientbibliotheken und √∂ffnet mit ihrer Hilfe eine Verbindung und sendet Nachrichten - beispielsweise, wenn √ºber ADO.NET ein Aufruf an SQL Server erfolgt.  Im Gegensatz zu ADO.NET, bei dem die Verbindung h√∂chstwahrscheinlich bei jedem Zugriff auf die Datenbank ge√∂ffnet wird, bleibt die Verbindung hier f√ºr den gesamten Zeitraum der Anwendung ge√∂ffnet. <br><br>  Um mit RabbitMQ aus der Datenbank interagieren zu k√∂nnen, ben√∂tigen wir die Anwendung und die .NET-Clientbibliothek f√ºr RabbitMQ. <br><blockquote>  <b>Hinweis:</b> Im folgenden Teil dieses Artikels wird RabbitMQ Codefragmente auftreten, aber ohne detaillierte Erkl√§rung , was sie tun.  Wenn Sie mit der Arbeit mit RabbitMQ noch nicht vertraut sind, empfehlen wir Ihnen, sich die verschiedenen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RabbitMQ-Tutorials</a> anzusehen, um den Zweck des Codes zu verstehen.  Das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hello World</a> C # -Tutorial ist ein guter Anfang.  Einer der Unterschiede zwischen Lehrb√ºchern und Codebeispielen besteht darin, dass in den Beispielen keine Austauscher deklariert sind.  Sie sollen vordefiniert sein. </blockquote><h3>  RabbitMQ.SqlServer </h3><br>  <b>RabbitMQ.SqlServer</b> ist eine Assembly, die die .NET-Clientbibliothek f√ºr RabbitMQ verwendet und die M√∂glichkeit bietet, Nachrichten aus der Datenbank an einen oder mehrere RabbitMQ-Endpunkte (VHosts und Austauscher) zu senden.  Der Code kann von meinem Repository <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RabbitMQ-SqlServer</a> auf GitHub heruntergeladen / gegabelt werden.  Es enth√§lt Assembly-Quellen und Installationsdateien (d. H. Sie m√ºssen diese nicht selbst kompilieren). <br><blockquote>  <b>Hinweis:</b> Dies ist nur ein Beispiel, um zu zeigen, wie SQL Server mit RabbitMQ interagieren kann.  Dies ist KEIN fertiges Produkt oder sogar ein Teil davon.  Wenn dieser Code Ihr Gehirn bricht - beschuldigen Sie mich nicht, denn dies ist nur ein Beispiel. <br></blockquote><h3>  Funktionalit√§t </h3><br>  Wenn die Assembly geladen wird oder wenn ihre Initialisierung explizit oder indirekt aufgerufen wird, l√§dt die Assembly zum Zeitpunkt des Aufrufs der Wrapper-Prozedur die Verbindungszeichenfolge in die lokale Datenbank, in der sie installiert wurde, sowie die RabbitMQ-Endpunkte, mit denen sie verbunden ist: <br><br>  Verbindung <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { connFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionFactory(); connFactory.Uri = connString; connFactory.AutomaticRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; connFactory.TopologyRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; RabbitConn = connFactory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; channels; x++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = RabbitConn.CreateModel(); rabbitChannels.Push(ch); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  <b>Code-Snippet 3:</b> Stellen Sie eine Verbindung zum Endpunkt her <br><br>  Gleichzeitig erstellt ein Teil der Verbindung zum Endpunkt auch IModels f√ºr die Verbindung, die beim Senden (Hinzuf√ºgen zur Warteschlange) von Nachrichten verwendet werden: <br><br>  Nachrichten senden <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> exchange, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] msg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topic</span></span></span><span class="hljs-function">)</span></span> { IModel <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> channelTryCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((!rabbitChannels.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) &amp;&amp; channelTryCount &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) { channelTryCount += <span class="hljs-number"><span class="hljs-number">1</span></span>; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (channelTryCount == <span class="hljs-number"><span class="hljs-number">100</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errMsg = <span class="hljs-string"><span class="hljs-string">$"Channel pool blocked when trying to post message to Exchange: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{exchange}</span></span></span><span class="hljs-string">."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(errMsg); } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.BasicPublish(exchange, topic, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, msg); rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  Die <code>Post</code> Methode wird von der <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> Methode <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> , die als Prozedur unter Verwendung der <code>CREATE PROCEDURE</code> Klausel in Codefragment 2 dargestellt wurde: <br><br>  Methode nach dem Aufruf <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pr_clr_PostRabbitMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> endPointId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msgToPost</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(endPointId == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">"EndpointId cannot be 0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isInitialised) { pr_clr_InitialiseRabbitMq(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = Encoding.UTF8.GetBytes(msgToPost); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endPointId == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rep <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> remoteEndpoints) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exch = rep.Value.Exchange; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> topic = rep.Value.RoutingKey; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pub <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rabbitPublishers.Values) { pub.Post(exch, msg, topic); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { RabbitPublisher pub; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rabbitPublishers.TryGetValue(endPointId, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> pub)) { pub.Post(remoteEndpoints[endPointId].Exchange, msg, remoteEndpoints[endPointId].RoutingKey); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">$"EndpointId: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{endPointId}</span></span></span><span class="hljs-string">, does not exist"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  <b>Code-Snippet 5:</b> Darstellung einer Methode als Prozedur <br><br>  Wenn die Methode ausgef√ºhrt wird, wird angenommen, dass der Aufrufer die Kennung des Endpunkts sendet, an den die Nachricht gesendet werden muss, und tats√§chlich die Nachricht selbst.  Wenn der Wert -1 als Kennung des Endpunkts √ºbergeben wird, durchlaufen wir alle Punkte und senden jedem eine Nachricht.  Die Nachricht kommt in Form einer Zeichenfolge, aus der wir mithilfe von <code>Encoding.UTF8.GetBytes</code> Bytes <code>Encoding.UTF8.GetBytes</code> .  In einer Produktionsumgebung sollte der Aufruf <code>Encoding.UTF8.GetBytes</code> durch Serialisierung ersetzt werden. <br><br><h3>  Installation </h3><br>  Zum Installieren und Ausf√ºhren des Beispiels ben√∂tigen Sie alle Dateien im Ordner <code>src\SQL</code> .  Gehen Sie zur Installation folgenderma√üen vor: <br><br><ul><li>  F√ºhren Sie das Skript <code>01.create_database_and_role.sql</code> .  Er wird schaffen: <br><ul><li>  <code>RabbitMQTest</code> Testdatenbank, in der die Assembly erstellt wird. </li><li>  <code>rmq</code> Rolle, die als Assembly-Eigent√ºmer zugewiesen werden soll </li><li>  Schema, das auch als <code>rmq</code> .  In diesem Diagramm werden verschiedene Datenbankobjekte erstellt. <br></li></ul><br></li><li>  F√ºhren Sie die Datei <code>02.create_database_objects.sql</code> .  Er wird schaffen: <br><br><ul><li>  die Tabelle <code>rmq.tb_RabbitSetting</code> , in der die Verbindungszeichenfolge zur lokalen Datenbank gespeichert wird. </li><li>  Die Tabelle <code>rmq.tb_RabbitEndpoint</code> , in der ein oder mehrere <code>RabbitMQ</code> Endpunkte gespeichert werden. </li></ul><br></li><li>  Die Datei <code>03.create_localhost_connstring.sql</code> den Wert der Variablen √§ndern <code>@connString</code> die richtige Verbindungszeichenfolge der Datenbank <code>RabbitMQTest</code> , erstellt in Schritt 1 und das Skript ausf√ºhren. <br></li></ul><br>  Bevor Sie fortfahren k√∂nnen, m√ºssen Sie √ºber eine laufende Instanz des RabbitMQ-Brokers und von VHost verf√ºgen (standardm√§√üig wird VHost als / dargestellt).  In der Regel haben wir mehrere VHost, nur zur Isolation.  Dieser Host ben√∂tigt auch einen Austauscher. In dem Beispiel verwenden wir <code>amq.topic</code> .  Wenn Sie den RabbitMQ-Broker bereit haben, bearbeiten Sie die Prozedurparameter <code>rmq.pr_UpsertRabbitEndpoint</code> , die sich in der Datei <code>04.upsert_rabbit_endpoint.sql</code> : <br><br>  Endpoint RabbitMQ <br><br><pre> <code class="cs hljs">EXEC rmq.pr_UpsertRabbitEndpoint @Alias = <span class="hljs-string"><span class="hljs-string">'rabbitEp1'</span></span>, @ServerName = <span class="hljs-string"><span class="hljs-string">'RabbitServer'</span></span>, @Port = <span class="hljs-number"><span class="hljs-number">5672</span></span>, @VHost = <span class="hljs-string"><span class="hljs-string">'testHost'</span></span>, @LoginName = <span class="hljs-string"><span class="hljs-string">'rabbitAdmin'</span></span>, @LoginPassword = <span class="hljs-string"><span class="hljs-string">'some_secret_password'</span></span>, @Exchange = <span class="hljs-string"><span class="hljs-string">'amq.topic'</span></span>, @RoutingKey = <span class="hljs-string"><span class="hljs-string">'#'</span></span>, @ConnectionChannels = <span class="hljs-number"><span class="hljs-number">5</span></span>, @IsEnabled = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  <b>Code-Snippet 6:</b> Erstellen eines Endpunkts in RabbitMQ <br><br>  Zu diesem Zeitpunkt ist es Zeit, Assemblys bereitzustellen.  Es gibt Unterschiede bei den Bereitstellungsoptionen f√ºr Versionen von SQL Server vor SQL Server 2014 (2005, 2008, 2008R2, 2012) und f√ºr 2014 und h√∂her.  Der Unterschied liegt in der unterst√ºtzten Version der CLR.  Vor SQL Server 2014 wurde die .NET-Plattform in der CLR-Version 2 ausgef√ºhrt, und in SQL Server 2014 und h√∂her wurde Version 4 verwendet. <br><br><h3>  SQL Server 2005 - 2012 </h3><br>  Beginnen wir mit Versionen von SQL Server, die auf CLR 2 ausgef√ºhrt werden, da sie ihre eigenen Merkmale haben.  Wir m√ºssen die erstellte Assembly bereitstellen und gleichzeitig die .NET-Bibliothek des RabbitMQ-Clients ( <code>RabbitMQ.Client</code> ) bereitstellen.  In unserer Assembly beziehen wir uns auf die RabbitMQ-Clientbibliothek.  Weil  Da wir CLR 2 verwenden wollten, sollten unsere Assembly und <code>RabbitMQ.Client</code> auf Basis von .NET 3.5 kompiliert werden.  Es gibt Probleme. <br><br>  Alle neuesten Versionen der <code>RabbitMQ.Client</code> Bibliothek wurden f√ºr die CLR 4-Umgebung kompiliert, sodass sie in unserer Assembly nicht verwendet werden k√∂nnen.  Die neueste Version der Clientbibliotheken f√ºr CLR 2 ist in .NET 3.4.3 kompiliert.  Aber selbst wenn wir versuchen, diese Assembly bereitzustellen, wird eine Fehlermeldung angezeigt: <br><br><img src="https://habrastorage.org/webt/db/yo/uj/dbyouj4az0fzhnwpkvtdkgj6i-q.png"><br>  <i><b>Abbildung 1:</b> Fehlende System.ServiceModel-Assembly</i> <br><br>  Diese Version von <code>RabbitMQ.Client</code> bezieht sich auf eine Assembly, die nicht Teil der SQL Server-CLR ist.  Dies ist eine WCF-Assembly, und dies ist eine der oben erw√§hnten Einschr√§nkungen in SQLCLR: Diese bestimmte Assembly ist f√ºr Aufgabentypen vorgesehen, die in SQL Server nicht ausgef√ºhrt werden d√ºrfen.  Neuere Versionen von <code>RabbitMQ.Client</code> haben diese Abh√§ngigkeiten nicht, sodass sie problemlos verwendet werden k√∂nnen, mit Ausnahme der l√§stigen Anforderungen der CLR 4. Was soll ich tun? <br><br>  Wie Sie wissen, ist RabbitMQ Open Source, aber wir sind Entwickler, oder?  ;) Also lasst uns neu kompilieren!  In der Version vor den neuesten Versionen (d. H. Version &lt;3.5.0) von <code>RabbitMQ.Client</code> ich die Links zu <code>System.ServiceModel</code> gel√∂scht und neu kompiliert.  Ich musste einige Codezeilen mithilfe der <code>System.ServiceModel</code> Funktionalit√§t <code>System.ServiceModel</code> , dies waren jedoch geringf√ºgige √Ñnderungen. <br><br>  In diesem Beispiel habe ich keine Client-Version 3.4.3 verwendet, aber ich habe die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">stabile Version 3.6.6 verwendet</a> und mit .NET 3.5 (CLR 2) neu kompiliert.  Es funktionierte fast :), mit der Ausnahme , dass die sp√§teren Versionen <code>RabbitMQ.Client</code> verwenden Sie <code>Task</code> ‚Äöund dass zun√§chst nicht Teil von .NET 3.5. <br><br>  Gl√ºcklicherweise gibt es eine Version von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>System.Threading.dll</code></a> f√ºr .NET 3.5, die <code>Task</code> .  Ich habe es heruntergeladen, die Links eingerichtet und alles ging!  Hier ist der Haupttrick, dass <code>System.Threading.dll</code> mit der Assembly installiert werden sollte. <br><blockquote>  <b>Hinweis: Die</b> Quelle von <code>RabbitMQ.Client</code> , aus der ich eine Version von .NET 3.5 kompiliert habe, befindet sich in meinem Repository auf GitHub <a href="">RabbitMQ Client 3.6.6 .NET 3.5</a> .  Die DLL-Bin√§rdatei befindet sich zusammen mit <code>System.Threading.dll</code> f√ºr .NET 3.5 auch im <code>lib\NET3.5</code> Repositorys <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(RabbitMQ-SqlServer)</a> . <br></blockquote>  <code>System.Threading</code> zum Installieren der erforderlichen Assemblys ( <code>System.Threading</code> , <code>RabbitMQ.Client</code> und <code>RabbitMQ.SqlServer</code> ) die Installationsskripts aus dem Verzeichnis <code>src\sql</code> in der folgenden Reihenfolge aus: <br><br><ol><li>  <code>05.51.System.Threading.sql2k5-12.sql</code> - System.Threading </li><li>  <code>05.52.RabbitMQ.Client.sql2k5-12.sql</code> - RabbitMQ.Client </li><li>  <code>05.53.RabbitMQ.SqlServer.sql2k5-12.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL Server 2014+ </h3><br>  In SQL Server 2014 und h√∂her wird die Assembly unter .NET 4.XX kompiliert (mein Beispiel ist 4.5.2), und Sie k√∂nnen auf jede der neuesten Versionen von <code>RabbitMQ.Client</code> verweisen, die mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NuGet</a> abgerufen werden k√∂nnen.  In meinem Beispiel verwende ich 4.1.1.  <code>RabbitMQ.Client</code> , der sich ebenfalls im <code>lib\NET4</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repositorys befindet (RabbitMQ-SqlServer)</a> . <br><br>  F√ºhren Sie zur Installation die Skripte aus dem Verzeichnis <code>src\sql</code> in der folgenden Reihenfolge aus: <br><br><ol><li>  <code>05.141.RabbitMQ.Client.sql2k14+.sql</code> - RabbitMQ.Client </li><li>  <code>05.142.RabbitMQ.SqlServer.sql2k14+.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL Method Wrapper </h3><br>  F√ºhren Sie das Skript <code>06.create_sqlclr_procedures.sql</code> aus, um Prozeduren zu erstellen, die in unserer Assembly (3.5 oder 4) <code>06.create_sqlclr_procedures.sql</code> .  Er wird T-SQL-Prozeduren f√ºr drei .NET-Methoden erstellen: <br><br><ul><li>  <code>rmq.pr_clr_InitialiseRabbitMq</code> ruft <code>pr_clr_InitialiseRabbitMq</code> .  Wird zum Laden und Initialisieren der RabbitMQ.SqlServer-Assembly verwendet. </li><li>  <code>rmq.pr_clr_ReloadRabbitEndpoints</code> verursacht <code>pr_clr_ReloadRabbitEndpoints</code> .  L√§dt verschiedene RabbitMQ-Endpunkte. </li><li>  <code>rmq.pr_clr_PostRabbitMsg</code> ruft <code>pr_clr_PostRabbitMsg</code> .  Wird zum Senden von Nachrichten an RabbitMQ verwendet. </li></ul><br>  Das Skript erstellt auch eine einfache T-SQL-Prozedur - <code>rmq.pr_PostRabbitMsg</code> , die f√ºr <code>rmq.pr_clr_PostRabbitMsg</code> .  Dies ist eine Wrapper-Prozedur, die wei√ü, was mit Daten zu tun ist, Ausnahmen behandelt usw.  In einer Produktionsumgebung gibt es mehrere √§hnliche Verfahren, mit denen verschiedene Arten von Nachrichten verarbeitet werden.  Lesen Sie weiter unten mehr dar√ºber. <br><br><h3>  Verwenden Sie </h3><br>  Aus alledem geht hervor, dass wir zum Senden von Nachrichten an RabbitMQ <code>rmq.pr_PostRabbitMsg</code> oder <code>rmq.pr_clr_PostRabbitMsg</code> und in den Parametern die Kennung des Endpunkts und die Nachricht selbst als Zeichenfolge √ºbergeben.  Das alles ist nat√ºrlich cool, aber ich w√ºrde gerne sehen, wie es in der Realit√§t funktionieren wird. <br><br>  In Produktionsumgebungen erfassen wir in gespeicherten Prozeduren, die die an RabbitMQ zu sendenden Daten verarbeiten, die zu sendenden Daten und rufen im Verbindungsblock eine Prozedur wie <code>rmq.pr_PostRabbitMsg</code> .  Das Folgende ist ein sehr vereinfachtes Beispiel f√ºr ein solches Verfahren: <br><br>  Datenverarbeitungsverfahren <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.pr_SomeProcessingStuff @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-comment"><span class="hljs-comment">--     DECLARE @endPointId int; --    DECLARE @msg nvarchar(max) = '{' --        SET @msg = @msg + '"Id":' + CAST(@id AS varchar(10)) + ',' --  -  SET @msg = @msg + '"FName":"Hello",'; SET @msg = @msg + '"LName":"World"'; SET @msg = @msg + '}'; -- -  --     -,  -  SELECT @endPointId = 1; --    --     EXEC rmq.pr_PostRabbitMsg @Message = @msg, @EndpointID = @endPointId; END TRY BEGIN CATCH DECLARE @errMsg nvarchar(max); DECLARE @errLine int; SELECT @errMsg = ERROR_MESSAGE(), @errLine = ERROR_LINE(); RAISERROR('Error: %s at line: %d', 16, -1, @errMsg, @errLine); END CATCH END</span></span></code> </pre> <br>  Im <b>Codefragment 7 sehen</b> wir, wie die erforderlichen Daten in der Prozedur erfasst und verarbeitet und nach der Verarbeitung gesendet werden.  F√ºhren Sie zur Verwendung dieser Prozedur das Skript <code>07.create_processing_procedure.sql</code> aus dem Verzeichnis <code>src\SQL</code> . <br><br><h3>  Lassen Sie uns alles laufen </h3><br>  An diesem Punkt sollten Sie bereit sein, einige Nachrichten zu senden.  <code>rmq.tb_RabbitEndpoint</code> Sie vor dem Testen sicher, dass Warteschlangen in RabbitMQ an den Endpunktaustauscher in <code>rmq.tb_RabbitEndpoint</code> . <br><br>  Um zu beginnen, m√ºssen Sie Folgendes tun: <br>  √ñffnen Sie die Datei <code>99.test_send_message.sql</code> . <br>  Ausf√ºhren <br><br><pre> <code class="sql hljs">EXEC rmq.pr_clr_InitialiseRabbitMq;</code> </pre> <br>  um die Assembly zu initialisieren und die RabbitMQ-Endpunkte zu laden.  Dies ist kein erforderlicher Schritt. Es wird jedoch empfohlen, die Assembly nach dem Erstellen oder √Ñndern vorab zu laden. <br><br>  Ausf√ºhren <br><br><pre> <code class="sql hljs">EXEC dbo.pr_SomeProcessingStuff @id = 101</code> </pre> <br>  (Sie k√∂nnen eine beliebige andere Kennung verwenden). <br><br>  Wenn alles fehlerfrei funktioniert hat, sollte eine Meldung in der RabbitMQ-Warteschlange angezeigt werden!  Sie haben also SQLCLR verwendet, um eine Nachricht an RabbitMQ zu senden. <br><br>  Gl√ºckwunsch! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de419457/">https://habr.com/ru/post/de419457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de419443/index.html">Die NASA wird wieder zum Mond fliegen und alle Elemente des Flugzeugs herstellen</a></li>
<li><a href="../de419445/index.html">Unit-Tests f√ºr Arduino-Projekte</a></li>
<li><a href="../de419449/index.html">Redux vs. React Context API</a></li>
<li><a href="../de419451/index.html">Erstellen Sie Schritt f√ºr Schritt ein Bundle f√ºr Symfony 4</a></li>
<li><a href="../de419453/index.html">Numerische Methoden zur L√∂sung nichtlinearer Gleichungssysteme</a></li>
<li><a href="../de419459/index.html">Blei-S√§ure-Batterien: Pulsladungsalphabet</a></li>
<li><a href="../de419461/index.html">Waschrauml√ºftung</a></li>
<li><a href="../de419467/index.html">Von einer Gl√ºhbirne √ºber einen Staubsauger bis hin zu einer Drohne - wie wir Alice beigebracht haben, Hunderte von Ger√§ten zu verwalten</a></li>
<li><a href="../de419469/index.html">UE4 | Der Zyklus von Tag und Nacht √Ñnderung von SkySphere</a></li>
<li><a href="../de419471/index.html">Migrationsoption von jQuery zu reinem Javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>