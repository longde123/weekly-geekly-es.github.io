<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòû üçÉ üçí Estaci√≥n meteorol√≥gica en Arduino de la A a la Z. Parte 5 üèÅ üòé üë®‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El final La parte anterior . 


 Tabla de contenido: 


- Parte 1. Requisitos. La elecci√≥n del hierro. Esquema general 
- Parte 2. Software. Unidad ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Estaci√≥n meteorol√≥gica en Arduino de la A a la Z. Parte 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p>  El final  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La parte anterior</a> . </p><br><p>  Tabla de contenido: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1. Requisitos.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La elecci√≥n del hierro.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Esquema general</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2. Software.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Unidad central, hierro</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3. Unidad central, software</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 4. Sensor de ventana</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Sensor fueraborda.  Software </h1><br><p>  Hable sobre el software para el sensor en el extranjero.  Despu√©s de eso, obtendr√° un sistema completo con el que ya puede experimentar. </p><br><p>  Perm√≠tame recordarle que el <em>servidor</em> es una unidad dom√©stica central que puede comunicarse con Internet a trav√©s de WiFi, y el <em>cliente</em> es un sensor remoto y listo para usar que transmite datos al servidor por el aire. </p><br><p> El c√≥digo fuente tanto para el servidor como para el cliente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√° aqu√≠</a> . <br>  Los textos fuente se proporcionan con comentarios detallados. </p><br><p>  Casi nada necesita ser configurado en el cliente. </p><a name="habracut"></a><br><p>  El transmisor de radio nRF24L01 +, m√°s precisamente la biblioteca RadioHead, requiere que se especifiquen las direcciones del servidor y del cliente.  Se proporcionan direcciones en caso de que tenga m√°s de un servidor y cliente.  Una direcci√≥n es cualquier n√∫mero entero.  Cuando un cliente env√≠a un paquete de datos a un servidor, indica para qu√© servidor es este paquete.  El servidor, conociendo su propia direcci√≥n, a su vez, determina si este paquete est√° destinado a √©l. </p><br><p> Por lo tanto, <code>SERVER_ADDRESS</code> en el servidor y en el cliente deber√≠a ser el mismo, pero <code>CLIENT_ADDRESS</code> para diferentes clientes deber√≠a ser diferente.  En otras palabras, si conecta otro sensor nuevo a nuestro sistema en el futuro, entonces <code>CLIENT_ADDRESS</code> deber√° cambiarse para ello. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  El <code>RF_CHANNEL</code> canal de radio <code>RF_CHANNEL</code> debe ser el mismo para todos.  Por defecto es 2. Cambi√© el n√∫mero predeterminado, puede elegir cualquier otro. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  La configuraci√≥n del volt√≠metro para medir el voltaje de alimentaci√≥n de la bater√≠a debe cambiarse: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  Para ahorrar energ√≠a, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliza la biblioteca Lightweight low power para Arduino</a> . </p><br><p>  Aqu√≠ est√°n mis medidas de consumo real para el Arduino Pro Mini con esta lib: </p><br><ul><li>  generalmente 25mA </li><li>  cuando se trabaja con DHT lo mismo </li><li>  con transmisi√≥n de radio 38 mA </li><li>  en LowPower.idle 15 mA </li><li>  en LowPower.powerdown 7.5 mA </li></ul><br><p>  El cliente toma medidas de temperatura, humedad y voltaje de suministro, agrupa todo esto en una estructura de datos, env√≠a los datos al servidor y se "queda dormido".  Si ocurrieron errores durante la transferencia, la transferencia se repite inmediatamente. </p><br><p>  El servidor (central, unidad dom√©stica), a su vez, recibe datos, confirma la recepci√≥n y los procesa. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Base de datos, MySQL, PHP, servidor WWW </h1><br><p>  Despu√©s del trabajo realizado, tenemos un dise√±o completamente funcional de la estaci√≥n meteorol√≥gica.  Pero ahora hay diez centavos por docena de estaciones meteorol√≥gicas, las artesan√≠as locales ya no est√°n de moda.  Despu√©s de todo, tenemos un Internet de las cosas. </p><br><p>  Por lo tanto, hablaremos sobre c√≥mo se realiza el acceso a su Internet, adjuntaremos una base de datos y una cara web a nuestra estaci√≥n meteorol√≥gica. </p><br><p>  La declaraci√≥n del problema para la "c√°mara web": </p><br><ul><li>  recibir y almacenar datos de la estaci√≥n meteorol√≥gica: temperatura, humedad, presi√≥n atmosf√©rica, voltaje de suministro </li><li>  mostrar estos datos </li><li>  construir gr√°ficos </li></ul><br><p>  En este caso, necesitamos hosting con soporte para Apache, PHP y MySQL con el m√≥dulo mysqli.  Y estas condiciones son satisfechas por casi cualquier alojamiento en el planeta Tierra.  O, en lugar de alojar, su computadora desempe√±ar√° el papel de un servidor conectado a un enrutador de red dom√©stica y tendr√° acceso a Internet. </p><br><h2 id="sozdanie-bazy-dannyh">  Creaci√≥n de base de datos. </h2><br><p>  Comencemos desde el principio, es decir, con el dise√±o y la creaci√≥n de la base de datos. </p><br><p>  Las bases de datos son su mundo y puede estudiarlo durante mucho tiempo, por lo que abordaremos brevemente solo aquellas cosas que necesitamos directamente. </p><br><p>  Todos los scripts SQL se encuentran en el directorio <code>weather-station/server/php-sql/</code> </p><br><p>  ¬øD√≥nde comienza el dise√±o de la base de datos?  Con una representaci√≥n l√≥gica y f√≠sica. </p><br><p>  Vista l√≥gica o esquema de base de datos: </p><br><ul><li>  Tabla de temperatura y humedad DHT </li><li>  tabla de datos BMP del sensor de presi√≥n y temperatura </li><li>  las tablas indicadas no tienen ninguna relaci√≥n entre s√≠; m√°s precisamente, los enlaces no son necesarios. </li></ul><br><p>  El esquema f√≠sico se basa en un DBMS espec√≠fico y tipos de datos.  Es m√°s f√°cil desmontar con un ejemplo espec√≠fico.  El <code>make_tables.sql</code> SQL <code>make_tables.sql</code> los esquemas l√≥gicos y f√≠sicos. </p><br><p>  Cada tabla debe tener un campo de tipo </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  El nombre del campo puede diferir en diferentes bases de datos, pero solo hay un sentido: este es un identificador √∫nico, una clave de registro.  Para el futuro, si ve una base de datos en tablas que no tienen dicho contador, debe saber que esta base de datos fue dise√±ada por una persona muy alejada de la programaci√≥n, probablemente de las humanidades. </p><br><p>  Almacenamos los datos de los sensores del mismo tipo en una tabla; para sensores de otro tipo, creamos otra tabla.  Esto complica un poco la base de datos y el enlace de PHP, pero simplifica la extensi√≥n o modificaci√≥n de todo el sistema en el futuro. </p><br><p>  Hay dos tablas en nuestro proyecto.  La tabla <code>arduino_dht</code> almacena datos de los sensores del tipo DHT (temperatura, humedad), la tabla <code>arduino_bmp</code> almacena datos de los sensores del tipo BMP (temperatura, presi√≥n).  Si en el futuro desea tener, por ejemplo, un sensor de gas o un detector de movimiento, cree tablas adicionales, no sea perezoso.  Si conecta otro sensor del tipo DHT11 o DHT22, entonces no necesita crear una tabla adicional, use la tabla <code>arduino_dht</code> .  Espero que el principio sea claro: una entidad f√≠sica separada es una tabla separada. </p><br><p>  Si los datos de varios sensores del mismo tipo se almacenar√°n en una tabla, ¬øc√≥mo se pueden distinguir?  Para hacer esto, ingrese un campo en cada tabla </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  De hecho, esto es <code>CLIENT_ADDRESS</code> que registramos en el <code>client/client.ino</code> para cada instancia del cliente-cliente remoto y en <code>server/server.ino</code> para el sensor que est√° conectado directamente al servidor, la unidad central. </p><br><p>  En los sistemas industriales, deber√≠a haber otra tabla: la correspondencia de <code>idSensor</code> y su descripci√≥n verbal y legible.  Por ejemplo, un sensor con <code>idSensor</code> = 2 es <em>"Temperatura, humedad en el apartamento"</em> , etc.  Pero en nuestro proyecto no nos complicaremos, solo recuerda que: </p><br><ul><li>  un sensor con <code>idSensor</code> , es <code>CLIENT_ADDRESS</code> , igual a 11 - este es el sensor de inicio en el servidor - la unidad central, </li><li>  un sensor con <code>idSensor</code> , tambi√©n es <code>CLIENT_ADDRESS</code> , igual a 20; este es el primer (en nuestro proyecto y el √∫nico) cliente de sensor basado en ventanas. </li></ul><br><p>  Siguiente  Las tablas almacenan los siguientes datos: </p><br><ul><li>  ipRemote: direcci√≥n IP de la estaci√≥n meteorol√≥gica (servidor) de donde provienen los datos, √∫til para depurar y monitorear, </li><li>  dateCreate: fecha en que se cre√≥ el registro, </li><li>  millis: √∫til para depurar, este es el tiempo en milisegundos desde el inicio del boceto en Arduino, </li><li>  temperatura - temperatura </li><li>  humedad - humedad </li><li>  voltaje - voltaje de suministro, </li><li>  presi√≥n - presi√≥n </li><li>  errores: la cantidad de errores (no utilizados).  Estaba destinado a almacenar el n√∫mero de errores de transmisi√≥n, etc., para que pueda evaluar de forma remota el estado de todo el sistema. </li></ul><br><p>  Como puede ver, las <code>arduino_bmp</code> <code>arduino_dht</code> y <code>arduino_bmp</code> muy similares, la diferencia es solo en los campos de presi√≥n y humedad, y existe el deseo de volcar todo en un mont√≥n (tabla).  Pero la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera forma normal</a> no ordena hacer esto, muchos programadores principiantes trataron de evitarlo, pero ninguno de ellos tuvo √©xito, y nosotros no lo haremos.  As√≠ es como no notar la ley de la gravitaci√≥n universal, por el momento bien puede resultar. </p><br><p>  La tabla <code>arduino_error_log</code> √∫til para la depuraci√≥n: es un registro de errores y otros mensajes del sistema. </p><br><p>  La creaci√≥n de una base de datos y su usuario con derechos se describe en <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  Esto se hace una vez, el nombre de la base de datos y el nombre de usuario pueden ser los suyos.  Y lo que debe hacerse exactamente es establecer su contrase√±a. </p><br><h2 id="php-i-veb-server">  PHP y servidor web </h2><br><p>  Todas las configuraciones de la interfaz web se almacenan en <code>config.php</code> .  Modif√≠quelo seg√∫n la configuraci√≥n de su base de datos. </p><br><p>  Configura tu zona horaria en formato PHP </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Todas las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">zonas horarias</a> disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se describen aqu√≠</a> . </p><br><p>  Establezca su clave secreta para el acceso (como un n√∫mero) que debe coincidir con la constante <code>SOURCE_KEY</code> del bosquejo <code>server.ino</code> </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  En nuestro servidor web no hay autorizaci√≥n, ingreso de contrase√±a, esto complicar√≠a todo el dise√±o.  Para un prototipo, esto no es necesario.  Por lo tanto, toda la protecci√≥n se basa en el archivo <code>robots.txt</code> , la ausencia de <code>index.php</code> y esta clave secreta para el acceso. </p><br><p>  El script PHP principal <code>weather.php</code> acepta una simple solicitud HTTP GET con datos y la almacena en las tablas de bases de datos correspondientes.  Si la clave <code>$access_key</code> no coincide, la solicitud ser√° rechazada. </p><br><p>  El <code>weather-view.php</code> usa para ver tablas de datos y contiene hiperv√≠nculos a otros scripts de interfaz web.  Ll√°malo as√≠ </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  Por ejemplo </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> muestra etiquetas simples donde debe recordar que: </p><br><ul><li>  el sensor con id 11 es el sensor de inicio en el servidor, </li><li>  El sensor con id 20 es un sensor de ventana. </li></ul><br><p>  El script <code>function.php</code> contiene funciones comunes a todos los scripts PHP. </p><br><p>  El <code>chart-dht.php</code> es responsable de los gr√°ficos usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google Charts</a> .  Aqu√≠, por ejemplo, hay un gr√°fico de la tensi√≥n de alimentaci√≥n del sensor en el extranjero.  El voltaje aumenta en un d√≠a soleado debido a la bater√≠a solar, y luego la fuente de alimentaci√≥n de las bater√≠as se descarga gradualmente. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Graph"></p><br><p>  <code>export-dht.php</code> exporta datos de las tablas de la base de datos MySQL a un archivo CSV.  Para mayor importaci√≥n y an√°lisis en hojas de c√°lculo. </p><br><p>  <code>export-voltage.php</code> exporta datos sobre el voltaje de suministro desde el sensor de ventana desde la base de datos MySQL a un archivo CSV.  √ötil para la depuraci√≥n. </p><br><p>  <code>truncate.php</code> borra todas las tablas, es decir  elimina todos nuestros datos  √ötil para la depuraci√≥n.  No hay enlaces a este script desde <code>weather-view.php</code> , por lo que debe llamarlo a trav√©s de un enlace directo en la barra de direcciones de su navegador con <code>$access_key</code> . </p><br><p>  Al recibir datos, la funci√≥n <code>mysqli_real_escape_string()</code> se usa com√∫nmente para evitar que valores incorrectos ingresen a la base de datos. </p><br><p>  No olvide poner <code>robots.txt</code> en la ra√≠z de su sitio para evitar que entre en los motores de b√∫squeda. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi y transferencia de datos </h1><br><p>  Y ahora volvamos al boceto <code>server.ino</code> , a la parte del mismo que se conecta al punto de acceso WiFi y env√≠a datos al servidor web. </p><br><p>  Como ya escrib√≠, no pude encontrar una biblioteca normal para que Arduino controlara el m√≥dulo ESP8266 usando comandos AT, tuve que "cultivar colectivamente".  Perm√≠tame tambi√©n recordarle que debe actualizar una versi√≥n espec√≠fica de firmware en ESP8266-01.  Y ahora, cuando todo est√© listo, veamos c√≥mo funciona. </p><br><p>  Para acceder al servidor web en el boceto <code>server.ino</code> , debe cambiar estas constantes </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p>  En <code>server.ino</code> en la funci√≥n <code>void setup()</code> , el ESP8266 se cambia primero al modo Station, es decir  comienza a funcionar como un cliente WiFi </p><br><pre> <code class="hljs lisp">espSendCmd(¬´AT+CWMODE_CUR=1¬ª, ¬´OK¬ª, <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  y luego conectarse al punto de acceso </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Si no se produce la conexi√≥n, el intento se repite (una vez) </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Luego seleccione el modo de conexi√≥n √∫nica TCP / IP </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Cuando se env√≠an datos desde sensores del tipo DHT al servidor web, se utiliza una funci√≥n que indica el <code>type=dht</code> datos como <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Cuando se env√≠an datos desde sensores BMP a un servidor web, se utiliza la misma funci√≥n con el tipo de datos indicado como <code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  La funci√≥n <code>espSendData()</code> acepta una cadena de solicitud HTTP GET y la env√≠a al servidor web seg√∫n lo previsto. </p><br><p>  Dentro de s√≠ mismo, <code>espSendData()</code> verifica la disponibilidad del m√≥dulo ESP envi√°ndole el comando "AT", luego verifica la conexi√≥n WiFi y se vuelve a conectar si es necesario.  Luego se env√≠an los datos y se cierra la conexi√≥n TCP. </p><br><h1 id="android-prilozhenie">  Aplicaci√≥n de Android </h1><br><p>  Hoy en d√≠a, cuando todos pueden parpadear un LED, no sorprender√° a nadie con una estaci√≥n meteorol√≥gica.  Pero si la nave sabe c√≥mo comunicarse con el servidor a trav√©s de WiFi, tiene una cara web y una aplicaci√≥n m√≥vil, ¬°esto es algo!  Por servidor aqu√≠ nos referimos, por supuesto, al servidor de aplicaciones, es decir  en nuestro caso, este es un enlace PHP y un DBMS MySQL.  No hay suficientes cerezas en el pastel, es decir, la aplicaci√≥n de Android, que escribiremos ahora. </p><br><h2 id="arhitektura">  Arquitectura </h2><br><p>  La arquitectura de toda la plataforma de software de la estaci√≥n meteorol√≥gica es simple: </p><br><ul><li>  La parte del servidor (unidad central) de la estaci√≥n meteorol√≥gica recopila datos de clientes de sensores remotos </li><li>  luego transfiere datos al servidor web de aplicaciones, que guarda estos datos en la base de datos </li><li>  La aplicaci√≥n de Android (o cualquier otra aplicaci√≥n remota: iOS, navegador) solicita datos de un servidor web y los muestra en la pantalla. </li></ul><br><p>  En la pantalla del dispositivo Android, mostraremos las lecturas actuales y m√°s recientes del sensor. </p><br><h2 id="http-get-i-json">  HTTP GET y JSON </h2><br><p>  La pregunta que debe resolverse en primer lugar es c√≥mo se transferir√°n los datos del servidor web a la aplicaci√≥n de Android. </p><br><p>  No hay necesidad de inventar nada aqu√≠, todo ya ha sido inventado para nosotros: estos son HTTP GET y JSON. </p><br><p>  En nuestro caso, una simple solicitud GET al servidor web puede compilarse y depurarse manualmente mientras la aplicaci√≥n de Android a√∫n no est√° lista. </p><br><p>  En Java y Android, hay bibliotecas listas para procesar datos en formato JSON.  JSON es un formato de texto legible por humanos, que es √∫til para la depuraci√≥n. </p><br><p>  Para generar datos actuales de los sensores de la estaci√≥n meteorol√≥gica, cree un nuevo script PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">last-data-to-json.php</a> en el servidor web. </p><br><p>  Llamada de gui√≥n: </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  donde <code>&lt;access_key&gt;</code> , como recordamos, es la clave secreta de acceso a la base de datos. </p><br><p>  Ejemplo de respuesta en formato JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  Hay que recordar que tenemos 3 sensores.  Su identificaci√≥n y tipo (DHT o BMP) est√°n codificados en todo el c√≥digo de la estaci√≥n meteorol√≥gica.  Este m√©todo de codificaci√≥n hardcore es ideol√≥gicamente incorrecto, pero para un prototipo dibujado por la rodilla (donde se necesita una soluci√≥n r√°pida y f√°cil) este es un compromiso razonable. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  El <code>last-data-to-json.php</code> toma los √∫ltimos datos de estos sensores heterog√©neos de la base de datos y los empaqueta en el formato JSON.  La selecci√≥n de datos de la base de datos "desde el final" procede de esta manera: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Ahora escribiremos una aplicaci√≥n simple de Android que solicita, recibe, decodifica datos JSON y muestra informaci√≥n en la pantalla. </p><br><p>  Nuestra aplicaci√≥n de Android ser√° lo m√°s simple posible, solo la esencia de la tecnolog√≠a.  M√°s all√° de este "esqueleto" ya ser√° posible terminar con varias "bellezas". </p><br><p>  Aqu√≠ hay una captura de pantalla de lo que deber√≠a resultar en </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  Como puede ver, la interfaz de usuario es solo espartana, basada en LinearLayout, nada m√°s. </p><br><p>  En la parte superior de TextView, se muestra la ID de los sensores y sus datos meteorol√≥gicos.  El bot√≥n Actualizar inicia una segunda solicitud al servidor web.  Lo siguiente en EditText es la √∫nica configuraci√≥n del programa: esta es la URL de solicitud en el formulario </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  ¬øQu√© se debe tener en cuenta? </p><br><p>  En el manifiesto, agregue l√≠neas que permitan Internet y verifiquen el estado de la conexi√≥n de red: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Trabajar con la red y recibir datos del sitio web es el siguiente. </p><br><p>  Usamos AsyncTask para crear una tarea en segundo plano separada del hilo principal de la interfaz de usuario.  Esta tarea en segundo plano toma la URL de solicitud y la usa para crear <code>HttpURLConnection</code> . </p><br><p>  Una vez establecida la conexi√≥n, AsyncTask carga el contenido de la p√°gina web (JSON) como InputStream.  A continuaci√≥n, InputStream se convierte en una cadena, que se decodifica con JSONObject y se muestra en la interfaz de usuario con el m√©todo <code>onPostExecute()</code> . </p><br><p>  En MainActivity.java cambie la URL a su: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  se usar√° de manera predeterminada la primera vez que ejecute una aplicaci√≥n de Android. </p><br><h2 id="epilog">  Ep√≠logo </h2><br><p>  Bueno, algo ya ha funcionado.  Entonces puede optimizar algo, reemplazar algo, puede tirar todo, pero tambi√©n pedir prestado algo. </p><br><p>  Un gran punto separado es <strong>el consumo de energ√≠a</strong> .  Recomiendo leer comentarios en publicaciones donde hay muchos consejos pr√°cticos. </p><br><p>  <em>Hasta el infinito ... y m√°s all√°.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es426019/">https://habr.com/ru/post/es426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es426001/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 11: Ur / Lenguaje de programaci√≥n web, Parte 3</a></li>
<li><a href="../es426009/index.html">Epic fail resistencia 1 o Fox se escabulleba desapercibido. Prueba de anonimato y seguridad + VPN para el usuario</a></li>
<li><a href="../es426013/index.html">Esteroides profesionales</a></li>
<li><a href="../es426015/index.html">El uso de drones civiles aserrados para fotograf√≠a a√©rea geod√©sica profesional de la zona.</a></li>
<li><a href="../es426017/index.html">C√≥mo reducir el n√∫mero de experimentos con animales.</a></li>
<li><a href="../es426021/index.html">libgdx y sentimientos</a></li>
<li><a href="../es426023/index.html">Lecci√≥n abierta "Laboratorio virtual en Vagrant"</a></li>
<li><a href="../es426025/index.html">Usar m√©todos ofensivos para enriquecer la Inteligencia de amenazas</a></li>
<li><a href="../es426027/index.html">Servicios de Amazon Cloud y an√°lisis de cartera de inversiones</a></li>
<li><a href="../es426029/index.html">¬øTe rindes y quieres abandonar la tarea? As√≠ es como se ve la capacitaci√≥n efectiva para desarrolladores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>