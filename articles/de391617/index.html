<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👦‍👦 🛌 ♈️ Ersetzen der analogen Einstellung durch die digitale im Labornetzteil HY3005D 🙃 😦 🥉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel wird der Austausch von Standardpotentiometern durch mechanische EC11-Encoder (Akkumulationswinkelsensoren) in einem Mastech HY3005D-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ersetzen der analogen Einstellung durch die digitale im Labornetzteil HY3005D</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/391617/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In diesem Artikel wird der Austausch von Standardpotentiometern durch mechanische EC11-Encoder (Akkumulationswinkelsensoren) in einem Mastech HY3005D-Netzteil unter Verwendung eines PIC16F1829-Mikrocontrollers und eines Schieberegisters 74HC595 erläutert, das einen DAC auf einer R2R-Widerstandsmatrix implementiert</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorwort</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vor einigen Jahren habe ich ein Mastech HY3005D-Netzteil gekauft. Vor nicht allzu langer Zeit gab es Probleme mit der Spannungsregelung - die Graphitbeschichtung der Rheostate war abgenutzt und das Einstellen der erforderlichen Spannung wurde zu einer schwierigen Aufgabe. Es gab keine geeigneten Rheostate, und ich beschloss, keine ähnlichen zu kaufen, sondern die Anpassungsmethode zu ändern. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Der Pegel der Ausgangsspannung und des Ausgangsstroms wird durch die Referenzspannung eingestellt, die den Operationsverstärkern zugeführt wird. Auf diese Weise können Sie die Potentiometer vollständig entfernen, indem Sie sie durch einen DAC ersetzen, der Spannung im gewünschten Bereich liefern kann.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Im Mikrochip-Katalog konnte ich keinen geeigneten Mikrocontroller finden, der zwei DACs an Bord hat, und externe DACs haben keinen kleinen Preis und zu viel zusätzliche Funktionalität. </font><font style="vertical-align: inherit;">Daher habe ich die Schieberegister 74HC595 und Widerstände für die R2R-Matrix erworben. </font><font style="vertical-align: inherit;">Der Mikrocontroller PIC16F1829 war bereits auf Lager. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Um zur ursprünglichen Schaltung zurückkehren zu können, werden alle Änderungen minimiert und die auf einer separaten Platine vorgenommene Einstelleinheit ersetzt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellenbeschreibung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Die Schaltung basiert auf dem Mikrocontroller </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIC16F1829</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der mit einer Frequenz von 32 MHz arbeitet. Die Taktfrequenz wird vom eingebauten Taktgenerator eingestellt, laut Datenblatt ist sie nicht zu genau, aber für diese Schaltung nicht kritisch. Der Vorteil dieses MK ist das Vorhandensein von Pull-up-Widerständen an allen digitalen Eingängen und zwei MSSP-Modulen, die SPI implementieren. Alle 18 Logikpins des Mikrocontrollers werden verwendet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Auf vier Schieberegistern </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">74HC595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und R2R-Matrizen implementierten zwei 16-Bit-DACs. Die Vorteile dieses Registers umfassen das Vorhandensein eines separaten Schieberegisters und Speicherregisters. Auf diese Weise können Sie Daten in das Register schreiben, ohne die aktuellen Ausgabewerte zu unterbrechen. Die R2R-Matrix wird auf Widerständen mit einem Fehler von 1% zusammengesetzt. Es ist anzumerken, dass selektive Messungen einen Fehler von nicht mehr als 10 Ohm zeigten. Ursprünglich war geplant, 3 Register zu verwenden, aber bei der Verkabelung der Platine schien es mir keine gute Lösung zu sein, außerdem war es notwendig, Knabbereien hinzuzufügen.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Die im MC eingebauten Pull-up-Widerstände werden an allen Eingängen aktiviert und vereinfachen die Schaltung. Alle Ausgänge der Encoder sind direkt mit den MK-Klemmen verbunden. Insgesamt 4 Encoder haben jeweils zwei Ausgänge für den Rotationssensor selbst und einen für die eingebaute Taste. Insgesamt 12 Schlussfolgerungen MK werden zur Verarbeitung von Eingabedaten verwendet. Der Kontaktsprung wird mit einer Kapazität von 100 nF geglättet. Nach dem Ändern der Werte der 16-Bit-Strom- und Spannungspuffer gemäß den Eingangsdaten von den Codierern werden die Werte über SPI an die Schieberegister 74HC595 übertragen. Um die Datenübertragungszeit zu verkürzen, werden zwei SPI-Module verwendet, mit denen Daten gleichzeitig für Strom und Spannung übertragen werden können. Nachdem die Daten in das Register übertragen wurden, wird ein Befehl zum Übertragen von Daten vom Verschiebungspuffer in den Speicherpuffer gesendet. Die Ausgänge des Registers sind mit der Matrix R2R verbunden, die als Teiler für den DAC fungiert.Die Ausgangsspannung von der Matrix wird an die Eingänge der Operationsverstärker übertragen.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Die in die Encoder eingebauten Tasten stellen das Minimum (Encodertaste für eine reibungslose Einstellung) bzw. das Maximum (Encodertaste für die Grobeinstellung) für Strom oder Spannung ein.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schema</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Im Internet habe ich kein Schema gefunden, das vollständig mit meinem übereinstimmt, also habe ich den ersten Link genommen. </font><font style="vertical-align: inherit;">Korrekturen an den aufgedeckten Inkonsistenzen vorgenommen und dann die Änderungen hinzugefügt. </font><font style="vertical-align: inherit;">Ich habe ein Diagramm des Einstellblocks in TinyCAD gezeichnet - laden Sie die Datei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HY3005D-regulator.dsn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunter </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Original</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/c04/fe1/917/c04fe19174fe4b469bd80b9a6c45139c.gif"><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach gefundenen Ungenauigkeiten</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/484/820/123/4848201239bc4dfd95b06a98798a6289.gif"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das endgültige Schema nach der Verfeinerung Die </font></font><br>
<img src="https://habrastorage.org/files/b3e/41c/9f1/b3e41c9f1ed941efb654903269157775.gif"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tragbare Einheit mit Anpassung (rot hervorgehoben) wurde in ein separates Schema gestellt. </font></font><br>
<img src="https://habrastorage.org/files/306/7ff/1b6/3067ff1b6f29462ba6d4adffad1526f7.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein digitales Voltmeter mit einer Anzeige auf der Vorderseite (nicht in den Diagrammen angegeben) wird an den J3-Anschluss angeschlossen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendete Komponenten</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Unten finden Sie eine Liste der verwendeten Komponenten (der Fall ist in Klammern angegeben). </font><font style="vertical-align: inherit;">Alle wurden zu unterschiedlichen Zeiten in China gekauft. </font><font style="vertical-align: inherit;">Es ist wichtig, LEDs mit den gleichen Eigenschaften wie native zu verwenden </font><font style="vertical-align: inherit;">Sie stehen in Reihe im Ausgangsstromkreis von Operationsverstärkern (ich habe die gleichen genommen, die auf meinem Motherboard standen).</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U1: PIC16F1829I / ML-Mikrocontroller (QFN)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U2 - U5: Schieberegister 74HC595BQ (DHVQFN16 oder SOT-763)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U6: AMS1117 5V linearer Spannungsregler (SOT-223)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RE1 - RE4: mechanischer Akkumulationswinkelsensor EC11</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1-, R2- und R2R-Matrizen: 1 und 2 kΩ-Widerstände (SMD 0402)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C1 - C12, C14-C17: Keramikkondensatoren GRM21BR71E104KA01L 100nF (SMD 0805)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C13: Tantalkondensator 22 mkF 16 V (tiv B)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1, D2: Spannungs- / Strom-LEDs auf der Vorderseite</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gebühr</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ich habe das Board in Sprint Layout 6 gezüchtet - laden Sie die Datei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HY3005D-regulator.lay6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunter </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Leider wurde das Original, auf dem ich meine Version erstellt habe, nicht erhalten, und zwar im Lay6-Format, wobei bereits während der Montage Korrekturen festgestellt wurden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe Jumper neben der Firmware-Schnittstelle zur Interrupt-Verbindung des Encoders für die reibungslose Stromregelung hinzugefügt, weil </font><font style="vertical-align: inherit;">Kapazitäten, die den Kontaktsprung filtern, verhinderten das Blinken des Controllers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlende Jumper für Boden zwischen den Seiten hinzugefügt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verschob die 5-V-Stabilisierungsbaugruppe auf die andere Seite, um sie durch Jumper zu reduzieren</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glättungskondensatoren auf der Stromleitung hinzugefügt ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diskussion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
</ol><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto nach dem Ätzen und Bohren (erste Version)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/593/555/618/593555618b46cfb0ea30bc3fb40f31e6.jpg"><br>
<img src="https://habrastorage.org/getpro/geektimes/post_images/6ec/ebc/c47/6ecebcc4789fd48ab80a8ef7f690049a.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hergestellt mit Filmfotolack. </font><font style="vertical-align: inherit;">Ich habe lange unter einer kleinen Verkabelung von Registern gelitten. </font><font style="vertical-align: inherit;">In der letzteren Version gab es kleine Fehler, die nach dem Ätzen gereinigt werden mussten. </font><font style="vertical-align: inherit;">Aber im Allgemeinen ist das Board gescheitert. </font><font style="vertical-align: inherit;">Es gibt immer noch nicht genug zwei Jumper, um den Boden auf der Vorder- und Rückseite zu verbinden.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach Eingabe der identifizierten Probleme (zweite Version)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/450/175/2fe/4501752fed894a78be212939a76b2794.png"><br>
<img src="https://habrastorage.org/files/a69/089/610/a6908961064b4f25984f5c1ee53dd8b6.png"><br>
       0    SMD 0805.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto nach dem Entlöten und Einbau</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/be4/678/8d1/be46788d12079fd0ca782c1f084cf166.jpg"><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     .   —     .          —   12.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wie Sie sehen können, sind die Änderungen minimal, alle alten Anschlüsse blieben unverändert. </font><font style="vertical-align: inherit;">Ich musste Essen separat hinzufügen, weil </font><font style="vertical-align: inherit;">Die einzige Spannung, die an die 2,5-V-Einstellkarte ankommt, ist nicht für den nativen Teiler geeignet. </font><font style="vertical-align: inherit;">Wenn Sie die Zenerdiode auf 2,5 V (V5A) auf der Hauptplatine des Netzteils entfernen und anstelle des Widerstands (R1A) einen Jumper einsetzen, können Sie auf eine zusätzliche Versorgung mit 12 V verzichten.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C-Code für den XC8-Compiler. </font><font style="vertical-align: inherit;">Genäht das Original PICkit 3.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title">config.h</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// PIC16F1829 Configuration Bit Settings</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// 'C' source line config statements</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#include &lt;xc.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// #pragma config statements should precede project file includes.</span></span>
<span class="hljs-comment"><span class="hljs-comment">// Use project enums instead of #define for ON and OFF.</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// CONFIG1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FOSC = INTOSC    // Oscillator Selection (INTOSC oscillator: I/O function on CLKIN pin)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WDTE = OFF       // Watchdog Timer Enable (WDT disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PWRTE = OFF      // Power-up Timer Enable (PWRT disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config MCLRE = OFF      // MCLR Pin Function Select (MCLR/VPP pin function is digital input)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CP = OFF         // Flash Program Memory Code Protection (Program memory code protection is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CPD = OFF        // Data Memory Code Protection (Data memory code protection is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BOREN = OFF      // Brown-out Reset Enable (Brown-out Reset disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config CLKOUTEN = OFF   // Clock Out Enable (CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config IESO = OFF       // Internal/External Switchover (Internal/External Switchover mode is disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config FCMEN = OFF      // Fail-Safe Clock Monitor Enable (Fail-Safe Clock Monitor is disabled)</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// CONFIG2</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config WRT = OFF        // Flash Memory Self-Write Protection (Write protection off)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config PLLEN = OFF      // PLL Enable (4x PLL disabled)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config STVREN = ON      // Stack Overflow/Underflow Reset Enable (Stack Overflow or Underflow will cause a Reset)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config BORV = LO        // Brown-out Reset Voltage Selection (Brown-out Reset Voltage (Vbor), low trip point selected.)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> config LVP = OFF        // Low-Voltage Programming Enable (High-voltage on MCLR/VPP must be used for programming)</span></span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">main.c</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#include "config.h"</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _XTAL_FREQ 32000000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> intrinsic(_delay)</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _delay(unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>);
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_us(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000000.0)))</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __delay_ms(x) _delay((unsigned long)((x)*(_XTAL_FREQ/4000.0)))</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TransferNotDone          !(SSP2STAT&amp;0b00000001)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> StoreAll                 LATA4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ResetAll                 LATC6</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHA          RC1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpCHB          RC0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSharpBTN          RA2</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHA         RB5</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothCHB         RB4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageSmoothBTN         RC2</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHA          RC5</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpCHB          RC4</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSharpBTN          RC3</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHA         RA1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothCHB         RA0</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentSmoothBTN         RA3</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSharp         0x0100</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageRateSmooth        0x0010</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSharp         0x0040</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentRateSmooth        0x0004</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMax               0xC000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMax               0x5000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageMin               0x0000</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentMin               0x0000</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> VoltageStart             0x1E00</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CurrentStart             CurrentMax</span></span><font></font>
<font></font>
unsigned <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> VoltageBuff;<font></font>
unsigned <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> CurrentBuff;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> interrupt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tc_int</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {<font></font>
    SSP1BUF = VoltageBuff&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>;<font></font>
    SSP2BUF = CurrentBuff&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( TransferNotDone );<font></font>
    SSP1BUF = VoltageBuff;<font></font>
    SSP2BUF = CurrentBuff;<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( TransferNotDone );<font></font>
    StoreAll = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
    StoreAll = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {
    <span class="hljs-comment"><span class="hljs-comment">// Configure oscillator for 32MHz</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    OSCCON     = <span class="hljs-number"><span class="hljs-number">0b11110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Enable individual pull-ups</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    OPTION_REG = <span class="hljs-number"><span class="hljs-number">0b01111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure analog port (1 - enable, 0 - disable)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    ANSELA     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span>
    ANSELB     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span>
    ANSELC     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B3</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Reset latch</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    LATA       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    LATB       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    LATC       = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Alternate pin function (set SDO2 on RA5)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    APFCON0    = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span>
    APFCON1    = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B2</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure digital port (1 - input, 0 - output)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    TRISA      = <span class="hljs-number"><span class="hljs-number">0b00001111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span>
    TRISB      = <span class="hljs-number"><span class="hljs-number">0b00110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span>
    TRISC      = <span class="hljs-number"><span class="hljs-number">0b00111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B1</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure input level (1 - CMOS, 0 - TTL)</span></span>
    INLVLA     = <span class="hljs-number"><span class="hljs-number">0b11000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span>
    INLVLB     = <span class="hljs-number"><span class="hljs-number">0b00001111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span>
    INLVLC     = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B7</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure individual pull-ups (1 - enable, 0 - disable)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
    WPUA       = <span class="hljs-number"><span class="hljs-number">0b00111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    WPUB       = <span class="hljs-number"><span class="hljs-number">0b11110000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    WPUC       = <span class="hljs-number"><span class="hljs-number">0b11111111</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span><font></font>
<font></font>
    ResetAll = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    ResetAll = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// Configure SPI in master mode</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//             76543210</span></span>
  <span class="hljs-comment"><span class="hljs-comment">//SSP1ADD    = 0b00000000; //B4</span></span>
    SSP1STAT   = <span class="hljs-number"><span class="hljs-number">0b01000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP1CON3   = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP1CON1   = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
  <span class="hljs-comment"><span class="hljs-comment">//SSP1ADD    = 0b00000000; //B4</span></span>
    SSP2STAT   = <span class="hljs-number"><span class="hljs-number">0b01000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP2CON3   = <span class="hljs-number"><span class="hljs-number">0b00000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span>
    SSP2CON1   = <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//B4</span></span><font></font>
<font></font>
    VoltageBuff = VoltageStart;<font></font>
    CurrentBuff = CurrentStart;<font></font>
    __delay_ms(<span class="hljs-number"><span class="hljs-number">50</span></span>);<font></font>
    SendData();<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span> ) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSharpCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageSharpCHB ) { VoltageBuff-=VoltageRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; }
                              <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VoltageBuff+=VoltageRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSharpCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSmoothCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageSmoothCHB ) { VoltageBuff-=VoltageRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMin; }
                               <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VoltageBuff+=VoltageRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( VoltageBuff &gt; VoltageMax ) VoltageBuff = VoltageMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSmoothCHA ); <font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSharpCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentSharpCHB ) { CurrentBuff-=CurrentRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; }
                              <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CurrentBuff+=CurrentRateSharp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSharpCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSmoothCHA ) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentSmoothCHB ) { CurrentBuff-=CurrentRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMin; }
                               <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CurrentBuff+=CurrentRateSmooth; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( CurrentBuff &gt; CurrentMax ) CurrentBuff = CurrentMax; }
            <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSmoothCHA );<font></font>
            SendData();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSharpBTN  ) { VoltageBuff = VoltageMax; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSharpBTN  ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !VoltageSmoothBTN ) { VoltageBuff = VoltageMin; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !VoltageSmoothBTN ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSharpBTN  ) { CurrentBuff = CurrentMax; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSharpBTN  ); SendData(); }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !CurrentSmoothBTN ) { CurrentBuff = CurrentMin; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( !CurrentSmoothBTN ); SendData(); }<font></font>
    };<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Für die Mindestwerte werden VoltageMin und CurrentMin auf 1 gesetzt, weil Bei 0 im Puffer funktioniert die Anpassung nicht mehr, bis ich verstehe, wo das Problem liegt. Preise * Rate * ausgewählt mehrfach und meiner Meinung nach am bequemsten. Für die SendData-Methode habe ich keine Variablen als Parameter übergeben, um Maschinenanweisungen und Speicher zu speichern. Der LVP-Modus (Low Voltage Firmware) muss ausgeschaltet sein, sonst funktioniert RA3 nicht als digitaler Eingang. Interrupts werden nicht verwendet, die Methode tc_int ist im Code vorhanden, sodass der Compiler den Hauptblock am Anfang des ROM platziert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Für die Firmware reicht es aus, die Jumper zu entfernen, das PICkit 3 (oder einen anderen Programmierer) anzuschließen und die Firmware auszuführen. In der ersten Version gab es keine Jumper an CLK und DAT, daher musste ich die Glättungskondensatoren ablöten, flashen und dann zurücklöten. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach der Installation zusätzlicher Kapazitäten in der Stromleitung verschwand das Problem, den Zähler aus der Nullposition zu verlassen. </font><font style="vertical-align: inherit;">Ich musste auch die Drehrichtung ändern. </font><font style="vertical-align: inherit;">Anscheinend verhinderte das Rauschen des Gleichrichters AMS1117 die korrekte Erkennung des Zustands der Encoder. </font><font style="vertical-align: inherit;">Zusätzlich habe ich eine Einstellung der Startwerte hinzugefügt, jetzt ist die Standardspannung auf 5 Volt eingestellt (der Strom ist immer noch maximal). </font><font style="vertical-align: inherit;">Vor dem ersten Senden der Daten wurde eine Verzögerung von 50 ms in die Register eingefügt (der Verzögerungswert wurde mit großem Abstand angenommen), um auf die Initialisierung der SPI-Module zu warten.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausgangsspannungseigenschaften</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nach der Endmontage des Gerätes wurde eine Spannungsmessung zwischen den Kontakten J4.1 - J4.2 (Spannungsregelung) und J4.1 - J4.7 (Stromregelung) durchgeführt. </font><font style="vertical-align: inherit;">Entsprechend den erhaltenen Daten werden Diagramme (unten unter dem Spoiler) der Wert- / Spannungsabhängigkeiten für den DAC aufgezeichnet.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafiken</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/2d2/2ca/05e/2d22ca05eaf84ab9bebb6ae56a42c00c.png"><br>
<img src="https://habrastorage.org/files/ef9/598/de4/ef9598de451f4cec96892e3486ada893.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die berechneten Werte der Spannungen werden durch die Formel (U * D) / (2 ^ K) erhalten, wobei </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U die Spannung am Ausgang des Registers unter Berücksichtigung der Teiler im Hauptstromkreis ist (für den DAC-Strom - 4950 mV, für die DAC-Spannung - 3550 mV); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D ist der Dezimalwert des DAC-Zählers; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K - DAC-Bittiefe (16 Bit)</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was kann verbessert werden</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timer-Werte speichern</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binden Sie die Standardwerte an die Encoder-Tasten, z. B. für die Spannung: 3.3; </font><font style="vertical-align: inherit;">5,0; </font><font style="vertical-align: inherit;">7,5; </font><font style="vertical-align: inherit;">12V</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zum Schutz vor einem unbekannten Wert beim Start ist es besser, MR an 1 anzuschließen und die OE durch den Widerstand auf 1 zu ziehen und nach dem Initialisieren des MK auf 0 zurückzusetzen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie den DAC durch ein PWM mit einer Glättungskette ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LampTester </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vorgeschlagen   </font><font style="vertical-align: inherit;">).</font></font></li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de391617/">https://habr.com/ru/post/de391617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de391607/index.html">Die Geschichte von Chuwi - von MP3-Playern im Jahr 2004 bis zu Tablets unter Windows 10 im Jahr 2016</a></li>
<li><a href="../de391609/index.html">Все космические исследовательские миссии на одной инфографике</a></li>
<li><a href="../de391611/index.html">Парк куриного периода: учёные вырастили ногу динозавра у курицы</a></li>
<li><a href="../de391613/index.html">Die US-Behörden möchten auf WhatsApp-Benutzerdaten zugreifen. Messenger führt die Verschlüsselung des Sprachverkehrs ein</a></li>
<li><a href="../de391615/index.html">Fotos und Videos der Sonnenfinsternis 9. März 2016</a></li>
<li><a href="../de391619/index.html">Western Digital stellte am Pi Day eine 46-Dollar-Festplatte mit einer Kapazität von 314 GB speziell für den Raspberry Pi vor</a></li>
<li><a href="../de391621/index.html">Runder Tisch bei HSE: Trends in der Spielebranche</a></li>
<li><a href="../de391623/index.html">Gestohlene Technologie: die „fliegende Festung“ der UdSSR</a></li>
<li><a href="../de391625/index.html">Budget Auto Honda Civic LX mit Autopilot auf der Autobahn</a></li>
<li><a href="../de391631/index.html">M-Commerce wächst 300% schneller als E-Commerce</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>