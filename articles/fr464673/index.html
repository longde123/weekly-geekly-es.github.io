<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜñ üêè üë©‚Äçüåæ TinyFL - pilote de lampe de poche pour microcontr√¥leur üë©üèæ‚Äçü§ù‚Äçüë®üèª üåÇ üçö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Habr! 


 Je veux raconter une histoire sur la fa√ßon dont je suis tomb√© entre les mains d'une lampe frontale chinoise sur une LED Cree XM-L et c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TinyFL - pilote de lampe de poche pour microcontr√¥leur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464673/"><p>  Salut Habr! </p><br><p>  Je veux raconter une histoire sur la fa√ßon dont je suis tomb√© entre les mains d'une lampe frontale chinoise sur une LED Cree XM-L et ce qui lui est arriv√© ensuite. </p><br><p><img src="https://habrastorage.org/webt/ec/vx/uq/ecvxuq8hlp8-x_b6iacutkxyrmo.jpeg"></p><a name="habracut"></a><br><h2 id="predystoriya">  Contexte </h2><br><p>  Il √©tait une fois, j'ai command√© une lampe de poche avec une LED brillante sur un site chinois.  La lampe de poche s'est av√©r√©e assez ergonomique (bien que cela puisse √™tre plus facile), mais son pilote laissait beaucoup √† d√©sirer. </p><br><p>  Il brillait suffisamment, mais le conducteur ne disposait que de 3 modes - tr√®s lumineux, lumineux et stroboscopique, la commutation entre ceux-ci se faisant au simple toucher d'un bouton.  Afin d'allumer et d'√©teindre simplement la lampe de poche, il fallait √† chaque fois trier ces 3 modes.  De plus, cette lampe de poche, lorsqu'elle est allum√©e, a d√©charg√© la batterie jusqu'√† la fin - une paire de mes bo√Ætes 18650 s'est donc d√©charg√©e profond√©ment. </p><br><p>  Tout cela √©tait inconfortable et ennuyeux, alors √† un moment donn√©, j'ai d√©cid√© de faire mon chauffeur, ce qui sera la suite de l'histoire. </p><br><div class="spoiler">  <b class="spoiler_title">Lampe de poche avec un ancien chauffeur</b> <div class="spoiler_text"><p>  <em>Voici une lampe de poche, beaucoup ont probablement trait√© de</em> <br><img src="https://habrastorage.org/webt/lp/8j/cy/lp8jcyodmsrehdop-qawqouaw-g.jpeg"></p><br><p>  <em>Il ressemble au pilote d'origine</em> <br><img src="https://habrastorage.org/webt/g-/cr/-w/g-cr-w88dmljau5oknxtpcxbrmu.jpeg"></p></div></div><br><h2 id="tehnicheskoe-zadanie">  Mandat </h2><br><p>  Comme vous le savez, pour obtenir un bon r√©sultat, tout d√©veloppement doit avoir de bonnes sp√©cifications techniques, je vais donc essayer de le formuler moi-m√™me.  Ainsi, le conducteur doit: </p><br><ul><li>  Pour pouvoir allumer / √©teindre par une courte pression sur un bouton (un bouton sans fixation).  C'est peut-√™tre la principale raison pour laquelle tout cela a commenc√©. </li><li>  Avoir un contr√¥le de luminosit√© doux (en continu), du plus brillant - "turbo" au "clair de lune" lorsque la diode est √† peine allum√©e.  La luminosit√© devrait changer uniform√©ment. </li><li>  N'oubliez pas la luminosit√© r√©gl√©e pour le temps libre. </li><li>  Surveillez la charge de la batterie, avertissant lorsqu'elle est presque d√©charg√©e (environ 3,3 V) et s'√©teignant lorsqu'elle est compl√®tement d√©charg√©e (environ 2,9 V).  Pour diff√©rentes batteries, ces param√®tres peuvent √™tre diff√©rents.  Par cons√©quent, la tension de fonctionnement doit √™tre comprise entre 2,7 et 4,5 V. </li><li>  Avoir 2 modes sp√©ciaux - balise d'urgence et stroboscope (enfin, pourquoi pas?) </li><li>  Pour pouvoir allumer / √©teindre la LED arri√®re (cela est vrai lorsque vous roulez √† v√©lo la nuit, il se r√©v√®le quelque chose comme un feu de position). </li><li>  Avoir une protection contre l'inversion de polarit√© et l'√©lectricit√© statique.  Pas n√©cessairement, mais ce sera un bel ajout, car dans l'obscurit√©, vous pouvez par erreur mettre la batterie du mauvais c√¥t√©. </li><li>  √ätre plus petit que le pilote d'origine, mais avoir la m√™me empreinte.  Le pilote chinois est tout simplement √©norme, il ne sera pas facile de l'agrandir. </li></ul><br><p>  Eh bien, si la lampe de poche est modifi√©e, pourquoi ne pas int√©grer un chargeur avec un connecteur micro-USB?  J'ai toujours un tel c√¢ble et un chargeur USB √† port√©e de main, et je dois chercher une alimentation native. </p><br><h2 id="zhelezo">  Le fer </h2><br><p>  J'ai une certaine exp√©rience avec Arduino, il a donc √©t√© d√©cid√© de faire un pilote sur la famille AVR MK.  Ils sont largement disponibles, faciles √† programmer et ont des modes de faible consommation (veille). </p><br><p>  Le microcontr√¥leur Attiny13a a √©t√© choisi comme ¬´cerveau¬ª du conducteur - c'est l'un des MC Atmel les moins chers (maintenant absorb√© par Microchip), il a tout √† bord - un GPIO pour connecter un bouton et une LED, une minuterie pour g√©n√©rer un signal PWM, un ADC pour mesurer tension et EEPROM pour enregistrer les param√®tres.  Seulement 1 Ko de m√©moire flash est disponible (mais combien est n√©cessaire pour une lampe de poche), ainsi que 64 B de RAM et la m√™me quantit√© d'EEPROM. <br>  Attiny13 est disponible en plusieurs options de bo√Ætier, en particulier en DIP-8, qui peuvent √™tre ins√©r√©es directement dans une planche √† pain ordinaire avec un pas de 2,54 mm. </p><br><p>  √âtant donn√© que seulement 3 fils vont de l'arri√®re √† la t√™te de la lampe de poche, le bouton est forc√© de court-circuiter √† la terre (sur l'impossibilit√© de court-circuiter √† plus - plus tard), vous devrez commuter la LED dans le plus - ce qui signifie que vous avez besoin d'un p√¥le √† canal P.  J'ai pris AO3401 en tant que tel transistor, mais vous pouvez prendre SI2323, il est plus cher, mais a une r√©sistance de canal moins ouverte (40 mOhm, tandis que AO3401 a 60 mOhm, √† 4,5 V), par cons√©quent, le pilote chauffera moins. </p><br><p>  <em>Des paroles aux actes, je recueille sur une planche √† pain une version pr√©liminaire</em> <br><img src="https://habrastorage.org/webt/6g/tx/89/6gtx89n9apulzr9kwouv9v-vkn8.jpeg"></p><br><p>  Il est actuellement aliment√© directement par le programmateur, avec une tension de 5 V (en fait moins en raison des pertes dans le c√¢ble USB).  Au lieu de la LED, le XM-L a jusqu'√† pr√©sent coll√© une LED r√©guli√®re sur les jambes et mis un transistor faible avec une tension de seuil √©lev√©e. <br>  Ensuite, dans le programme Altium Designer, un sch√©ma a √©t√© dessin√©, que j'ai compl√©t√© par une protection contre les inversions de polarit√© et les d√©charges √©lectrostatiques. </p><br><p><img src="https://habrastorage.org/webt/nt/cv/re/ntcvrepefjh36tyfclmcwze_e4o.png"></p><br><div class="spoiler">  <b class="spoiler_title">Description d√©taill√©e et objectif de tous les composants</b> <div class="spoiler_text"><h4 id="obyazatelnye-komponenty">  Pr√©requis: </h4><br><p>  U1 - Microcontr√¥leur Attiny13a en bo√Ætier 8S1 (index SSU) </p><br><p>  C1 - condensateur de d√©couplage pour l'alimentation du microcontr√¥leur, doit √™tre de l'ordre de 0,1 microfarads, cas 1206 ou 0805, coefficient de temp√©rature X7R </p><br><p>  R1-R2 est un diviseur de r√©sistance pour mesurer la tension de la batterie, toutes les valeurs nominales peuvent √™tre d√©finies, ici le rapport principal (750K / 220K, rapport de division 4.41) et le courant de fuite, qui sera plus √©lev√© si les valeurs nominales sont augment√©es (au courant, il est d'environ 4 ŒºA).  Comme un ION interne est utilis√© (1,1 V, selon la fiche technique, il peut √™tre compris entre 1,0 V et 1,2 V), la tension maximale √† la sortie du diviseur ne doit pas d√©passer 1 V. Avec un diviseur 750/220, la tension maximale admissible √† l'entr√©e du diviseur sera de 4,41 V, ce qui largement suffisant pour tous les types de batteries au lithium. <br>  J'ai calcul√© le diviseur √† l'aide de cette <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">calculatrice</a> . </p><br><p>  R3 - prot√®ge la sortie du port du microcontr√¥leur d'un court-circuit (si PB1 est soudainement tir√© vers VCC, un courant important passera √† travers la broche et le MC peut br√ªler) </p><br><p>  R4 - en tirant RESET MK pour alimenter, sans lui, les red√©marrages √† partir de micros sont possibles. </p><br><p>  Q1 - Transistor √† effet de champ √† canal P dans le bo√Ætier SOT-23, j'ai install√© l'AO3401, mais tout autre avec un brochage appropri√© (par exemple, SI2323) </p><br><p>  R7 est une r√©sistance de grille de limitation de courant.  √âtant donn√© que la grille du transistor a une certaine capacit√©, lors de la charge de cette capacit√©, un gros courant peut traverser la broche et la broche peut √©chouer.  Vous pouvez le r√©gler dans la r√©gion de 100-220 Ohms (il ne devrait plus l'√™tre, le transistor commencera √† √™tre dans un √©tat semi-ferm√© pendant longtemps, et, par cons√©quent, il chauffera davantage). </p><br><p>  R6 - obturateur de traction de r√©sistance √† l'alimentation.  Dans le cas o√π PB0 passe dans un √©tat de haute imp√©dance, la logique 1 sera install√©e √† travers cette r√©sistance sur la grille Q1 et le transistor sera ferm√©.  Cela peut se produire en raison d'une erreur dans le code ou en mode de programmation. </p><br><p>  D2 - diode de "verrouillage" - permet un "affaissement" de la tension (lorsque la LED s'allume pendant une courte p√©riode √† pleine luminosit√©) pour alimenter le MK depuis le condensateur pendant un certain temps, il prot√®ge √©galement contre l'inversion de polarit√©. <br>  Vous pouvez mettre n'importe quelle diode Schottky dans le paquet SOD323 avec une chute de tension minimale, je mets BAT60. </p><br><p>  Initialement, la protection contre l'inversion de polarit√© de l'alimentation √©tait r√©alis√©e sur le transistor √† effet de champ (cela se voit sur les cartes fabriqu√©es par le butin).  Une caract√©ristique d√©sagr√©able est apparue apr√®s le c√¢blage - lorsque la charge a √©t√© allum√©e, une chute de tension s'est produite et le MK a red√©marr√©, car le travailleur sur le terrain ne limite pas le courant dans la direction oppos√©e.  Au d√©but, j'ai soud√© un condensateur √©lectrolytique de 200 uF entre VCC et GND, mais je n'ai pas aim√© cette solution en raison de sa taille.  J'ai d√ª souder le transistor et mettre une diode √† sa place, car les SOT-23 et SOD-323 ont des dimensions similaires. </p><br><p>  Au total, dans le circuit, seuls 10 composants sont n√©cessaires pour l'installation. </p><br><h4 id="neobyazatelnye-komponenty">  Composants optionnels: </h4><br><p>  R5 et D1 sont responsables du r√©tro√©clairage (LED2).  La cote minimale de R5 est de 100 ohms.  Plus la valeur nominale est √©lev√©e, plus la LED arri√®re est faible (elle s'allume en mode constant, sans PWM).  D1 - toute LED dans le cas 1206, je mets vert, car  visuellement, ils sont plus brillants aux m√™mes courants que les autres. </p><br><p>  D3 et D4 sont des diodes de protection (TVS), j'ai utilis√© PESD5V0 (5.0V) dans le paquet SOD323.  D3 prot√®ge contre les surtensions par l'alimentation, D4 - par un bouton.  Si le bouton est recouvert d'une membrane, il n'y a pas de signification particuli√®re.  Il vaut probablement la peine d'utiliser des diodes de protection bidirectionnelles, sinon, lorsque la polarit√© est invers√©e, le courant les traversera et elles br√ªleront (voir CVC d'une diode de protection bidirectionnelle). </p><br><p>  C2 - un condensateur au tantale dans le cas A (similaire √† 1206), il est logique de le r√©gler lorsque le pilote est instable (la tension d'alimentation peut √™tre comprim√©e √† des courants de commutation √©lev√©s de la LED) </p><br><p>  Toutes les r√©sistances de taille 0603 (pour moi, c'est une limite ad√©quate pour le soudage manuel) </p></div></div><br><p>  Tout est clair avec les composants, vous pouvez faire une carte de circuit imprim√© selon le sch√©ma ci-dessus. <br>  La premi√®re chose √† faire est de construire un mod√®le 3D de la future carte, avec les trous - √† mon humble avis, dans Altium Designer, c'est le moyen le plus pratique pour d√©terminer la g√©om√©trie du PCB. <br>  J'ai mesur√© les dimensions de l'ancien pilote et ses trous de montage - la carte devrait y √™tre attach√©e, mais avoir des dimensions plus petites (pour plus de polyvalence, vous devez soudainement le construire ailleurs). <br>  Un minimum raisonnable s'est av√©r√© quelque part autour de 25x12,5 mm (rapport d'aspect 2: 1) avec deux trous d'un diam√®tre de 2 mm pour la fixation au bo√Ætier de la lampe avec des vis natives. </p><br><p>  J'ai cr√©√© un mod√®le 3D dans SolidWorks, puis export√© vers Altium Designer sous STEP. <br>  Ensuite, j'ai plac√© les composants sur la carte, fait les contacts dans les coins (il est plus pratique et plus facile de souder le sol), Attiny13 plac√© au centre, le transistor plus proche des contacts LED. <br>  J'ai √©tal√© les pistes de puissance, plac√© les composants restants comme il s'est av√©r√© et s√©par√© les pistes de signal.  Pour faciliter la connexion de la m√©moire, j'ai apport√© des contacts s√©par√©s pour celle-ci, qui dupliquent les contacts de la batterie. <br>  J'ai fait tout le c√¢blage (√† l'exception d'un cavalier) sur la couche sup√©rieure - afin de pouvoir faire une carte √† la maison avec LUT. <br>  La largeur minimale des trajets du signal est de 0,254 mm / 10 mil, celles de puissance ont une largeur maximale lorsque cela est possible. </p><br><p>  <em>Voici √† quoi ressemble la carte filaire dans Altium Designer</em> <br><img src="https://habrastorage.org/webt/yu/i4/bo/yui4bosmzwqjagvmj_clljr09ck.png"></p><br><p>  Altium Designer a la possibilit√© de voir √† quoi ressemblera la carte en 3D (pour cela, vous avez besoin de mod√®les pour tous les composants, dont certains que vous avez d√ª construire vous-m√™me). <br>  Peut-√™tre que quelqu'un ici dira que le mode 3D n'est pas n√©cessaire pour le traceur, mais pour moi personnellement, c'est une fonction pratique qui facilite le placement des composants pour la commodit√© de la soudure. </p><br><p><img src="https://habrastorage.org/webt/my/jk/1r/myjk1rvgvm50odtu4iy77czuy3i.png"></p><br><p>  Au moment de la r√©daction, 3 versions de la carte ont √©t√© fabriqu√©es - la premi√®re pour LUT, la seconde pour la fabrication industrielle et la 3√®me, finale avec quelques corrections. </p><br><h2 id="izgotovlenie-plat">  Fabrication de planches </h2><br><h3 id="samodelnyy-sposob">  Fa√ßon maison </h3><br><p>  LUT - technologie de repassage laser, une m√©thode pour produire des cartes de circuits imprim√©s √† l'aide de la gravure sur un masque obtenu en convertissant le toner du papier en cuivre.  Cette m√©thode est id√©ale pour les cartes simples √† simple face comme ce pilote. <br>  Le r√©seau a beaucoup d'articles sur cette technologie, donc je n'entrerai pas dans les d√©tails, mais je vais seulement vous expliquer bri√®vement comment je le fais. </p><br><p>  Vous devez d'abord pr√©parer un mod√®le qui sera imprim√© sur du papier thermique.  J'exporte la couche top_layer au format PDF, j'obtiens une image vectorielle. </p><br><p><img src="https://habrastorage.org/webt/lq/f3/dm/lqf3dmub3ivxcx3y32uijk9dy2a.png"></p><br><p>  Comme la carte est petite, il est logique de prendre un morceau de PCB avec des dimensions plusieurs fois plus grandes et de faire ce que l'industrie appelle des panneaux. <br>  √Ä ces fins, CorelDraw est tr√®s pratique, mais vous pouvez utiliser n'importe quel autre √©diteur de vecteur. <br>  Je place des copies de mod√®les sur le document, je fais des espaces de 0,5 √† 1 mm entre les planches (cela d√©pend de la m√©thode de s√©paration, plus sur celle-ci plus tard), les planches doivent √™tre situ√©es sym√©triquement - sinon il sera difficile de les s√©parer. </p><br><p>  Je prends un morceau de PCB unilat√©ral avec des dimensions l√©g√®rement plus grandes que le panneau assembl√©, nettoie et d√©graisse (je pr√©f√®re frotter avec une gomme √† effacer puis avec de l'alcool).  J'imprime un mod√®le pour la gravure sur papier thermique (ici il est important de ne pas oublier de refl√©ter le mod√®le). <br>  Avec l'aide d'un fer et de patience, en caressant doucement le papier, je le traduis en textolite.  J'attends qu'il refroidisse et d√©colle soigneusement le papier. <br>  Les zones libres de cuivre (non recouvertes de toner) peuvent √™tre vernies ou coll√©es (plus la zone de cuivre est petite, plus la r√©action de gravure est rapide). </p><br><p>  <em>Un tel lambris √† la maison - un grand nombre de planches peuvent compenser les d√©fauts de fabrication</em> <br><img src="https://habrastorage.org/webt/ob/f-/fk/obf-fkjp7lq5fcrxrr_x7rprgw8.jpeg"></p><br><p>  J'empoisonne les planches avec de l'acide citrique dans une solution de peroxyde d'hydrog√®ne, c'est le moyen le plus abordable, bien que ce soit plut√¥t lent. <br>  Les proportions sont les suivantes: pour 100 ml de peroxyde √† 3% soit 30 g d'acide citrique et environ 5 g de sel, le tout est m√©lang√© et vers√© dans un r√©cipient avec textolite. <br>  Le r√©chauffement de la solution acc√©l√©rera la r√©action, mais peut d√©coller le toner. </p><br><p>  <em>La magie chimique inconnue commence: le cuivre est recouvert de bulles et la solution prend une teinte bleue</em> <br><img src="https://habrastorage.org/webt/bc/jh/pz/bcjhpzjgqcrcmqq1wr8j_def1yw.jpeg"></p><br><p>  Apr√®s un certain temps, je sors la planche grav√©e et la nettoie du toner.  Je ne peux pas le laver avec des solvants, je le retire donc m√©caniquement avec du papier √©meri √† grain fin. </p><br><p>  Il reste maintenant √† √©tamer la carte - cela aidera au soudage et prot√©gera le cuivre de l'oxydation et facilitera le soudage.  Je pr√©f√®re l'√©tamage avec l'alliage Rose - cet alliage fond √† une temp√©rature d'environ 95 degr√©s, ce qui lui permet d'√™tre √©tam√© dans de l'eau bouillante (oui, peut-√™tre pas la composition la plus fiable pour l'√©tamage, mais pour les circuits imprim√©s faits maison). </p><br><p><img src="https://habrastorage.org/webt/a5/fs/lk/a5fslka8zacdyhd2mrfad4irlx0.jpeg"></p><br><p>  Apr√®s l'√©tamage, je perce une planche (pour les contacts j'utilise des forets carbure f1.0, pour les jumpers - f0.7), je perce avec un dremel faute d'un autre outil.  Je n'aime pas couper le textolite √† cause de la poussi√®re, donc apr√®s le per√ßage, je coupe les planches avec un couteau de bureau - des deux c√¥t√©s, je fais plusieurs coupes en une seule ligne, puis je le casse en coupe.  Cela rappelle la m√©thode de coupe en V utilis√©e dans l'industrie, seulement il y a une incision faite par un moulin. </p><br><p>  <em>Il ressemble √† une planche pr√™te √† souder</em> <br><img src="https://habrastorage.org/webt/xw/3v/6n/xw3v6ns0nrje-n8saj5gobrvces.jpeg"></p><br><p>  Lorsque la carte est pr√™te, vous pouvez commencer √† c√¢bler les composants.  Tout d'abord, je soude un peu (r√©sistances 0603), puis tout le reste.  Les r√©sistances sont adjacentes au MK, donc le soudage dans l'ordre inverse peut √™tre probl√©matique.  Apr√®s le soudage, je v√©rifie s'il y a un court-circuit pour alimenter le pilote, apr√®s quoi il est d√©j√† possible de d√©marrer le firmware MK. </p><br><p>  <em>Pilotes pr√™ts √† t√©l√©charger le firmware</em> <br><img src="https://habrastorage.org/webt/4u/au/jk/4uaujk48pqllmzplxcxuy_yfig8.jpeg"></p><br><h3 id="promyshlennyy-sposob">  Mani√®re industrielle </h3><br><p>  Le LUT est rapide et abordable, mais la technologie a ses inconv√©nients (comme presque toutes les m√©thodes de fabrication de PP ¬´maison¬ª).  Faire une planche double face est probl√©matique, les pistes peuvent √™tre grav√©es et on ne peut que r√™ver de m√©talliser les trous. </p><br><p>  Heureusement, les Chinois entreprenants offrent depuis longtemps des services pour la fabrication de circuits imprim√©s de mani√®re industrielle. <br>  Curieusement, une carte monocouche chinoise co√ªtera plus cher qu'une carte √† deux couches, j'ai donc d√©cid√© d'ajouter une deuxi√®me couche (inf√©rieure) √† la carte de circuit imprim√©.  Les chemins d'alimentation et la masse sont dupliqu√©s sur cette couche.  De plus, il est devenu possible de faire un dissipateur de chaleur √† partir du transistor (polygones de cuivre sur la couche inf√©rieure), ce qui permettra au conducteur de travailler √† des courants plus √©lev√©s. </p><br><p>  <em>La couche inf√©rieure de la carte dans Altium Designer</em> <br><img src="https://habrastorage.org/webt/x0/hf/b9/x0hfb9uk6flm6d7pat30fzm9lyu.png"></p><br><p>  Pour ce projet, j'ai d√©cid√© de commander une carte de circuit imprim√© sur le site PcbWay.  Le site dispose d'une calculatrice pratique pour calculer le co√ªt des planches, en fonction de leurs param√®tres, tailles et quantit√©s.  Apr√®s avoir calcul√© le co√ªt, j'ai t√©l√©charg√© le fichier gerber cr√©√© pr√©c√©demment dans Altium Designer, les Chinois l'ont v√©rifi√© et la carte est all√©e en production. </p><br><p>  Faire un ensemble de 10 planches TinyFL m'a co√ªt√© 5 $.  Lors de l'inscription d'un nouvel utilisateur, un rabais de 5 $ est accord√© pour la premi√®re commande, donc je n'ai pay√© que les frais d'exp√©dition, qui co√ªtent √©galement environ 5 $. <br>  Sur ce site il y a la possibilit√© de mettre le projet dans le domaine public, donc si quelqu'un veut commander ces planches, vous pouvez simplement ajouter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce projet</a> au panier. </p><br><p>  Apr√®s quelques semaines, les m√™mes planches sont venues √† moi, seulement <del>  jolie </del>  fabriqu√©s industriellement.  Ils ne peuvent √™tre d√©compress√©s et remplis qu'avec le firmware. </p><br><p><img src="https://habrastorage.org/webt/lp/j7/jk/lpj7jktyacb_h-atbtpze-9qzcw.jpeg"></p><br><h2 id="programma-proshivka">  Programme (firmware) </h2><br><p>  La principale difficult√© rencontr√©e lors de l'√©criture du firmware du pilote est li√©e √† la taille extr√™mement petite de la m√©moire flash - Attiny13 ne dispose que de 1024 octets. <br>  De plus, comme le changement de luminosit√© est fluide, une t√¢che non triviale consistait √† le changer uniform√©ment - pour cela, nous avons d√ª faire une correction gamma. </p><br><h4 id="algoritm-upravleniya-drayverom">  Algorithme de contr√¥le du conducteur </h4><br><p>  Le conducteur s'allume par une courte pression sur le bouton, il s'√©teint par lui. <br>  Le mode de luminosit√© s√©lectionn√© est enregistr√© pendant la dur√©e de l'arr√™t. </p><br><p>  Si, pendant le fonctionnement, vous appuyez deux fois bri√®vement sur un bouton (double-clic), la LED suppl√©mentaire s'allume / s'√©teint. <br>  En appuyant longuement pendant le fonctionnement, la luminosit√© de la lampe changera progressivement.  Un appui long et r√©p√©t√© change de direction (plus fort / plus faible). </p><br><p>  Le conducteur v√©rifie p√©riodiquement la tension de la batterie et, si elle est inf√©rieure aux valeurs d√©finies, avertit l'utilisateur d'une d√©charge, puis s'√©teint pour √©viter une d√©charge profonde. </p><br><div class="spoiler">  <b class="spoiler_title">Une description plus d√©taill√©e de l'algorithme du pilote</b> <div class="spoiler_text"><ol><li>  Lorsque l'alimentation est fournie au MK, les p√©riph√©riques sont configur√©s et le MK se met en veille (si STARTSLEEP est d√©fini).  Lorsque le pilote est aliment√©, les deux LED clignotent un certain nombre de fois si STARTBLINKS est d√©fini. </li><li>  Dormir  Attiny13 s'endort en mode hors tension (c'est le mode le plus √©conomique, selon la fiche technique, la consommation de MK sera ~ 1 ŒºA), dont il ne peut sortir que par une interruption.  Dans ce cas, il s'agit d'une interruption INT0 - en appuyant sur un bouton (r√©glage PC1 sur 0 logique). <br>  Sur PC1, un pull-up interne faible doit √™tre activ√©.  L'ADC et le comparateur sont les principaux consommateurs de courant de toute la p√©riph√©rie, ils doivent donc √©galement √™tre √©teints.  Pendant le sommeil, le contenu des registres et de la RAM est stock√©, donc l'EEPROM n'est pas n√©cessaire pour se souvenir de la luminosit√©. </li><li>  Apr√®s le sommeil, les p√©riph√©riques et le PWM sont allum√©s et le conducteur entre dans un cycle sans fin dans lequel le bouton est surveill√© et la tension de la batterie est p√©riodiquement v√©rifi√©e. </li><li>  Si le bouton est enfonc√©, l'heure est enfonc√©e. <br>  4.1.  Si la presse est courte, un double clic est attendu (si BTN_DBCLICK est d√©fini). <br>  Si c'√©tait le cas, les commutateurs LED2 suppl√©mentaires <br>  Sinon, passez √† l'√©tape 2 (sommeil) <br>  4.2.  Si la presse est longue (plus longue que BTN_ONOFF_DELAY) - le mode de contr√¥le de la luminosit√© est activ√©.  Dans ce mode: <br><ul><li>    (/)   %  ,   . </li><li>   /  (RATE_MAX / RATE_MIN),   ; </li><li>   n- (AUXMODES_DELAY)     ,   .    ‚Äî  (   25 ,  8 )    (     50,  1 ).        ,     -    . </li></ul></li><li>       ‚Äî    ADC2,     . <br><ul><li>      BAT_WARNING ‚Äì   </li><li>   BAT_WARNING ‚Äì    ,    . -     . ,         5 . </li><li>   BAT_SHUTDOWN ‚Äî    .2 (). </li></ul></li></ol></div></div><br><h4 id="upravlenie-yarkostyu-svetodioda">    </h4><br><p>  ,      ‚Äî   ,     -     ,  . -    ,     ,       .     P-  ,        ,    ‚Äî ,  .               . <br>      rate, 255 rate = 100% . <br>    1.2      1,     1200000/256 = 4.7 .     (  ),         (,   ,  ,   ).  ,      9.6 (CKSEL[1:0]=10, CKDIV8=1)  4.8  (CKSEL[1:0]=01, CKDIV8=1),      8   4  ,       . </p><br><p> ,         ,         .     ,      (      )      ,         ,  ,               1.5 ,   2        (   Cree XM-L   ‚Äî 3 ). <br>               ,     (rate=255)     3.          ,        .   ,    RATE_MAX     .   ,     SI2323DS      4 ,     2 ,     . </p><br><h4 id="gamma-korrekciya"> - </h4><br><p>      .     ,   5-10%       ,     75-100%      .     ,   n   ,  ,            ,        . </p><br><p>   ,          -.    ,       1      12   .       ,      rate_step_array.  , ,       . </p><br><h4 id="kontrol-napryazheniya-batarei">    </h4><br><p>  n- (      BAT_PERIOD)    .   ,    VIN      R1-R2,       PB4 (  ADC2   ). </p><br><p>        ,    ,      Vref,          1.1 .        ‚Äî     ,      (,  1.1       1023  255,   8- ).   ,        6   ,  255     1.1 ,   4.33  (  4.03),      . </p><br><p>     ,        .    BAT_WARNING       (  ,    ‚Äî    BAT_INFO_STEP,   ),    BAT_SHUTDOWN  . <br>         , ..    ,      . </p><br><p> ,     ,      . ,   4.03  R1 = 1M  R2 = 330,    R = 1330K     4  = 3 . <br>      ()    1 .      ,    ,     (  -       ‚Äî  ). </p><br><h4 id="vnesenie-izmeneniy-v-proshivku">     </h4><br><p>   ,       Arduino    C/C++. <br>      ,          (defines)   flashlight.h. <br>        Arduino IDE   Attiny13(a)  Atmel Studio ‚Äì   ,  Arduino IDE,   . </p><br><div class="spoiler"> <b class="spoiler_title">Arduino IDE</b> <div class="spoiler_text"><p>      Attiny13  IDE.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . <br>      Tools&gt;Board Attiny13(a)    Tools&gt;Frequency 1.2MHz. <br> ""      .ino,       ‚Äî      .   ,   ‚Äî      Arduino IDE.       - ,    .cpp. <br>       ,  ,          *.hex.        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">Atmel Studio</b> <div class="spoiler_text"><p>    IDE    flashlight.atsln,   ‚Äî   flashlight.h   ()  flashlight.cpp   . <br>         ‚Äî    . <br>        F7,   ( ,   ,  ).   debug  flashlight.hex,        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p>          USBASP     AVRDUDEPROG.      GUI   avrdude,      ‚Äî      .       (   Attiny13(a),    Fuses    read.   ,      ,   .     programm,      .       flashlight.h </p><br><p> Pour t√©l√©charger le firmware, allez dans l'onglet Programme, s√©lectionnez le fichier du firmware compil√© au format HEX (flashlight.hex) dans la ligne Flash et cliquez sur Program.  L'√©tat du micrologiciel sera affich√© dans la fen√™tre ci-dessous.  Si le t√©l√©chargement √©choue, cela peut √™tre un mauvais contact, cela arrive - cela vaut la peine d'essayer √† nouveau.  √Ä propos, pour cette raison, le param√®tre STARTBLINKS a √©t√© cr√©√© - un seul clignotement de la LED2 au moment de l'alimentation du pilote sert d'indication du contact du conducteur avec le programmeur. <br>  Au lieu d'USBASP, vous pouvez utiliser Arduino pour t√©l√©charger le firmware, plus de d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> </p><br><p>  <em>Programmateur USBASP connect√© au pilote via un clip avec boucle</em> <br><img src="https://habrastorage.org/webt/7f/b2/sy/7fb2syr5zqnwqejhoqpxqqa_-vw.jpeg"></p><br><p>  Pour connecter USBASP √† un tinka, j'utilise un clip pour un SOIC 8 broches.  Ce n'est pas un appareil tr√®s pratique, vous devez tourmenter 10 minutes avant d'attraper le contact (peut-√™tre que je viens de tomber sur un clip d√©fectueux).  Il existe √©galement des adaptateurs SOIC-DIP dans lesquels le microcircuit est ins√©r√© avant la soudure et le firmware y est vers√© - cette option est plus pratique, mais la possibilit√© de programmer le pilote en circuit est perdue (c'est-√†-dire, mettre √† jour le firmware apr√®s avoir soud√© le MK √† la carte). <br>  Si tout cela n'est pas l√†, vous pouvez simplement souder les fils aux bornes du MK, qui se fixent ensuite √† l'Arduino. </p></div></div><br><h4 id="kalibrovka">  Calibration </h4><br><p>  Les courants traversant le driver et la LED ne doivent pas d√©passer les valeurs maximales.  Pour la LED XM-L, c'est 3 A, pour le pilote cela d√©pend du transistor utilis√©, par exemple, pour SI2323 le courant maximum est d'environ 4 A, mais il vaut mieux piloter √† des courants plus faibles en raison d'un √©chauffement excessif.  Pour r√©duire le courant √† la luminosit√© maximale, le param√®tre RATE_MAX est utilis√© (#define RATE_MAX xx, o√π xx est la luminosit√© maximale de 0 √† 255). <br>  L'√©talonnage de l'ADC n'est pas une proc√©dure obligatoire, mais si vous voulez que le pilote surveille avec pr√©cision la tension de seuil, vous devrez le bricoler. </p><br><p>  Les calculs ne donneront pas une grande pr√©cision des mesures, car, d'une part, les r√©sistances peuvent varier dans la tol√©rance (g√©n√©ralement 1-5%), et d'autre part, l'ion interne peut avoir une dispersion de 1,0 √† 1,2 V. <br>  Par cons√©quent, la seule fa√ßon acceptable est de d√©finir la valeur en unit√©s ADC (BAT_WARNING et BAT_SHUTDOWN), en la s√©lectionnant exp√©rimentalement pour celle souhait√©e.  Pour ce faire, vous aurez besoin de patience, d'un programmeur et d'une source d'alimentation r√©glable. <br>  J'ai r√©gl√© la valeur BAT_PERIOD √† 1000 dans le firmware (en v√©rifiant la tension une fois par seconde) et j'ai progressivement r√©duit la tension d'alimentation.  Lorsque le conducteur a commenc√© √† avertir de la d√©charge, j'ai laiss√© la valeur actuelle de BAT_WARNING au besoin. <br>  Ce n'est pas le moyen le plus pratique, peut-√™tre qu'√† l'avenir, vous devrez effectuer une proc√©dure d'√©talonnage automatique avec enregistrement des valeurs dans l'EEPROM. </p><br><h2 id="sborka-fonarika">  Ensemble lampe de poche </h2><br><p>  Lorsque la carte √©tait pr√™te et que le firmware √©tait inond√©, vous pouviez enfin le mettre √† la place de l'ancien pilote.  J'ai dessoud√© l'ancien pilote et soud√© un nouveau √† sa place. </p><br><div class="spoiler">  <b class="spoiler_title">Le nouveau pilote est connect√© √† la place de l'ancien selon ce sch√©ma</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ar/7c/6j/ar7c6jgy4zprzi6crl9aogualo8.png"></p></div></div><br><p>  Apr√®s avoir v√©rifi√© s'il y avait un court-circuit dans l'alimentation, j'ai branch√© l'alimentation et v√©rifi√© l'op√©rabilit√©.  Ensuite, j'ai mont√© la carte de charge (TP4056), pour cela, j'ai d√ª percer un trou dans le connecteur de charge avec un petit dremel et le fixer avec de la colle chaude (il √©tait important que la colle ne coule pas dans le connecteur, il serait difficile de la retirer). </p><br><p>  Je n'ai pas attach√© la carte avec des vis, car le fil dans le bo√Ætier s'est cass√© √† cause de torsions r√©p√©t√©es, mais j'ai simplement vers√© de la colle dessus, √©galement coll√© les fils dans les points de soudure afin qu'ils ne s'effilochent pas.  J'ai d√©cid√© de recouvrir le pilote et le chargeur de vernis acrylique incolore, cela devrait aider contre la corrosion. </p><br><p><img src="https://habrastorage.org/webt/5g/qs/do/5gqsdoxgldinymg3njvlpsmnxz8.jpeg"></p><br><h2 id="testirovanie-i-raschet-stoimosti-izgotovleniya">  Test et calcul des co√ªts de fabrication </h2><br><p>  Apr√®s toutes les op√©rations, il a √©t√© possible de commencer √† tester les pilotes.  Le courant a √©t√© mesur√© avec un multim√®tre conventionnel, le connectant au circuit ouvert de l'alimentation. </p><br><p>  Consommation d'√©nergie de l'ancien pilote (mesur√©e √† 4,04 V): </p><br><ol><li>  Pendant le sommeil - non mesur√© </li><li>  Mode maximum: 0,60 A </li><li>  Mode moyen: 0,30 A </li><li>  Stroboscope: 0,28 A </li></ol><br><p>  Consommation √©lectrique du nouveau pilote (mesur√©e √† 4,0 V): </p><br><ol><li>  En mode veille, il consomme environ 4 ŒºA, ce qui est beaucoup moins que le courant d'autod√©charge d'une batterie lithium-ion.  Le courant principal dans ce mode passe √† travers un diviseur de r√©sistance. </li><li>  Dans le mode minimum, le ¬´clair de lune¬ª est d'environ 5-7 mA, si nous supposons que la capacit√© d'une cellule 18650 est d'environ 2500 mA * h, alors nous obtenons environ <strong>20 jours de fonctionnement continu</strong> .  MK lui-m√™me consomme quelque part entre 1,2 et 1,5 mA (√† une fr√©quence de fonctionnement de 1,2 MHz). </li><li>  En mode maximum, "turbo" - consomme environ 1,5 A, dans ce mode, il fonctionnera pendant environ une heure et demie.  La LED sur ces courants commence √† devenir tr√®s chaude, ce mode n'est donc pas destin√© √† un fonctionnement √† long terme. </li><li>  Balise de d√©tresse - consomme en moyenne environ 80 mA, dans ce mode, la lampe de poche fonctionnera jusqu'√† 30 heures. </li><li>  Stroboscope - consomme environ 0,35 A, fonctionnera jusqu'√† 6 heures. </li></ol><br><h4 id="cena-voprosa">  Prix ‚Äã‚Äãd'√©mission </h4><br><p>  Si vous achetez des composants dans Chip and Deep, environ 100 roubles sortiront (60 roubles Attiny13, ~ 40 roubles le reste de la poudre libre).  Il est logique de commander en Chine, si plusieurs pi√®ces sont fabriqu√©es - alors en termes de pi√®ce, ce sera moins cher, les Chinois vendent g√©n√©ralement en lots de 10 pi√®ces ou plus. <br>  Les frais seront d√©bloqu√©s √† un prix de l'ordre de 300 roubles pour 10 pi√®ces (sans livraison), si command√© en Chine. <br>  Le c√¢blage et le clignotement d'un pilote prennent environ une heure. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  La lampe de poche chinoise est devenue beaucoup plus pratique, m√™me si j'ai maintenant des plaintes concernant sa m√©canique - la partie avant est trop lourde et la mise au point n'est pas vraiment n√©cessaire. <br>  √Ä l'avenir, je pr√©vois de faire une version de ce pilote pour lampes de poche avec un bouton d'alimentation (avec fixation).  Certes, je suis confus par l'abondance de ces projets.  Pensez-vous que cela vaut la peine d'en faire un autre? </p><br><p>  <em>Pilote de gros plan (version 2_t)</em> <br><img src="https://habrastorage.org/webt/2f/sd/sl/2fsdslzywcu7izjgclyshshwjvy.jpeg"></p><br><p>  <strong>UPD</strong> : Ajout du support pour Arduino IDE. </p><br><p>  Le code source du firmware, du circuit et du c√¢blage de la carte est maintenant sur le github, vous pouvez le t√©l√©charger ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/madcatdev/tinyfl_t</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464673/">https://habr.com/ru/post/fr464673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464657/index.html">Corniche √©lectrique d'ing√©nierie inverse AM82TV</a></li>
<li><a href="../fr464659/index.html">S√©curit√© des applications ou Comment int√©grer la s√©curit√© dans le d√©veloppement personnalis√©. Exp√©rience personnelle chez AGIMA</a></li>
<li><a href="../fr464661/index.html">A qui confier la conception des √©quipements techniques de r√©√©quipement et de reconstruction</a></li>
<li><a href="../fr464665/index.html">Partitionnement dans SQL Server</a></li>
<li><a href="../fr464671/index.html">Recevez des SMS r√©guliers vers les messageries instantan√©es Viber et Telegram (en utilisant les passerelles GoIP)</a></li>
<li><a href="../fr464677/index.html">Investissements en bourse et co√ªts associ√©s: combien co√ªtent les services d'une soci√©t√© de bourse</a></li>
<li><a href="../fr464679/index.html">Voxgun - un service pour cr√©er du contenu vid√©o professionnel sans effort suppl√©mentaire</a></li>
<li><a href="../fr464685/index.html">T√©l√©graphe optique, r√©seau micro-ondes et tour Tesla: tours de communication inhabituelles</a></li>
<li><a href="../fr464687/index.html">Si vous voulez sauver le monde, le v√©ganisme n'est pas une option</a></li>
<li><a href="../fr464689/index.html">Contenu de Panda Frontend Meetup # 22: plugins, donn√©es sophistiqu√©es, tests, d√©claration angulaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>