<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔱 👄 ☎️ Rhinoceros dentro del gato: ejecute el firmware en el emulador Kopycat 🚽 🙄 🧜🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En el marco de la reunión 0x0A DC7831 DEF CON Nizhny Novgorod el 16 de febrero, presentamos un informe sobre los principios básicos de la emulación de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rhinoceros dentro del gato: ejecute el firmware en el emulador Kopycat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/445798/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/pb/7e/gipb7e8ucwinvebjerxy1fk2d-8.jpeg" width="80%"></div><br><p>  En el marco de la reunión 0x0A DC7831 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DEF CON Nizhny Novgorod</a> el 16 de febrero, presentamos un informe sobre los principios básicos de la emulación de código binario y nuestro propio desarrollo: un emulador de plataformas de hardware <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kopycat</a> . </p><br><p>  En el artículo, describiremos el lanzamiento del firmware del dispositivo en el emulador, demostraremos la interacción con el depurador y realizaremos un pequeño análisis dinámico del firmware. </p><a name="habracut"></a><br><h2 id="predystoriya">  Antecedentes </h2><br><p><del>  Hace mucho tiempo en una galaxia muy muy lejana </del></p><br><p>  Hace un par de años en nuestro laboratorio era necesario estudiar el firmware del dispositivo.  El firmware fue comprimido, descomprimido por el gestor de arranque.  Lo hizo de una manera muy confusa, varias veces cambiando datos en la memoria.  Sí, y el firmware en sí mismo interactuó activamente con los periféricos.  Y todo esto en el núcleo de MIPS. </p><br><p> Por razones objetivas, los emuladores existentes no nos convenían, pero aún así quería ejecutar el código.  Luego decidimos hacer nuestro propio emulador, que hará un mínimo y permitirá descomprimir el firmware principal.  Lo intentamos, resultó.  Pensamos, ¿y si agregamos periféricos para también realizar el firmware principal?  No fue muy doloroso, y también funcionó.  Pensamos de nuevo y decidimos hacer un emulador completo. </p><br><p>  El resultado fue un emulador de sistemas informáticos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kopycat</a> . </p><br><img src="https://habrastorage.org/webt/eb/cx/b6/ebcxb6pxtiypy0s-usvu6i_hdwu.png" align="right"><br><div class="spoiler">  <b class="spoiler_title">¿Por qué kopycat?</b> <div class="spoiler_text"><p>  Hay un juego de palabras. </p><br><ol><li>  <em>copycat</em> (inglés, n. [ˈkɒpɪkæt]) - copycat, imitador </li><li>  <em>cat</em> (inglés, n. [ˈkæt]) - un gato, un gato - un animal favorito de uno de los creadores del proyecto </li><li>  Letra "K" - del lenguaje de programación Kotlin </li></ol></div></div><br><h2 id="kopycat">  Kopycat </h2><br><p>  Al crear el emulador, se establecieron objetivos absolutamente específicos: </p><br><ul><li>  la capacidad de crear rápidamente una nueva periferia, módulo, núcleo de procesador; </li><li>  la capacidad de ensamblar un dispositivo virtual desde varios módulos; </li><li>  la capacidad de cargar cualquier dato binario (firmware) en la memoria del dispositivo virtual; </li><li>  la capacidad de trabajar con instantáneas (instantáneas del estado del sistema); </li><li>  la capacidad de interactuar con el emulador a través del depurador incorporado; </li><li>  Agradable lenguaje moderno para desarrollar. </li></ul><br><p>  Como resultado, Kotlin fue elegido para la implementación, la arquitectura del bus (esto es cuando los módulos se comunican entre sí a través de buses de datos virtuales), JSON como el formato de descripción del dispositivo y GDB RSP como el protocolo para interactuar con el depurador. </p><br><p>  El desarrollo ha estado ocurriendo durante un poco más de dos años y está en curso.  Durante este tiempo, se implementaron los núcleos de procesador MIPS, x86, V850ES, ARM, PowerPC. </p><br><p>  El proyecto está creciendo y es hora de presentarlo al público en general.  Haremos una descripción detallada del proyecto más adelante, pero ahora nos centraremos en usar Kopycat. </p><br><p>  Para los más impacientes: la versión promocional del emulador se puede descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . </p><br><h2 id="nosorog-v-emulyatore">  Rhino en el emulador </h2><br><p>  Recuerde que anteriormente para la conferencia SMARTRHINO-2018, se creó un dispositivo de prueba "Rhinoceros" para la capacitación en habilidades de ingeniería inversa.  El proceso de análisis de firmware estático se describió en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este artículo</a> . </p><br><p>  Ahora intentemos agregar "altavoces" y ejecutar el firmware en el emulador. </p><br><p>  Necesitaremos: <br>  1) Java 1.8 <br>  2) Python y el módulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Jep</a> para usar Python dentro del emulador.  El ensamblaje WHL del módulo Jep para Windows se puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargar aquí</a> . </p><br><p>  <strong>Para Windows:</strong> <br>  1) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">com0com</a> <br>  2) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PuTTY</a> </p><br><p>  <strong>Para Linux:</strong> <br>  1) socat </p><br><p>  Puede usar Eclipse, IDA Pro o radare2 como cliente GDB. </p><br><h2 id="kak-eto-rabotaet">  Como funciona </h2><br><p>  Para realizar el firmware en el emulador, debe "ensamblar" un dispositivo virtual, que es un análogo de un dispositivo real. </p><br><p>  El dispositivo real ("rinoceronte") se puede mostrar en un diagrama de bloques: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nh/ph/ph/nhphph7rjwm3xiv52mvp_uefdq8.jpeg" alt="Circuito de dispositivo real" width="60%"></div><br><p>  El emulador tiene una estructura modular y el dispositivo virtual final se puede describir en un archivo JSON. </p><br><div class="spoiler">  <b class="spoiler_title">JSON en 105 líneas</b> <div class="spoiler_text"><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"top"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, // Plugin name should be the same as file name (or full path from library start) <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"rhino"</span></span>, // Directory where plugin places <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, // Plugin parameters (constructor parameters if jar-plugin version) <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_dbg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"firmware"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: <span class="hljs-string"><span class="hljs-string">"NUL"</span></span>} ], // Plugin outer ports <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: [ ], // Plugin internal buses <span class="hljs-attr"><span class="hljs-attr">"buses"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS30"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nand"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"4"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"gpio"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS32"</span></span> } ], // Plugin internal components <span class="hljs-attr"><span class="hljs-attr">"modules"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"u1_stm32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"STM32F042"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"firmware:String"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.firmware"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"usart_debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_dbg"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"term_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_bt"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bluetooth"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"BT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_12"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_13"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_14"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_15"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> } ], // Plugin connection between components <span class="hljs-attr"><span class="hljs-attr">"connections"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_0.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x00"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_1.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x01"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_2.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x02"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_3.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x03"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_4.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x04"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_5.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x05"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_6.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x06"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_7.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x07"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_8.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x08"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_9.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x09"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_10.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0A"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_11.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0B"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_12.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0C"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_13.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0D"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_14.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0E"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_15.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0F"</span></span>] ] }</code> </pre> <br><p>  Preste atención al parámetro de <em>firmware</em> en la sección de parámetros: este es el nombre del archivo que se puede descargar al dispositivo virtual como firmware. </p></div></div><br><p>  Un dispositivo virtual y su interacción con el sistema operativo principal se pueden representar de la siguiente manera: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m9/i_/27/m9i_27btauj0onjugttzj3srmfg.jpeg" alt="Dispositivo de circuito emulado" width="80%"></div><br><p>  La instancia de prueba actual del emulador implica la interacción con los puertos COM del sistema operativo principal (depuración UART y UART para el módulo Bluetooth).  Estos pueden ser puertos reales a los que están conectados los dispositivos o puertos COM virtuales ( <em>com0com / socat es</em> solo para esto <em>)</em> . </p><br><p>  Actualmente hay dos formas principales de interactuar con el emulador desde el exterior: </p><br><ul><li>  Protocolo GDB RSP (respectivamente, compatible con este protocolo, herramientas: Eclipse / IDA / radare2); </li><li>  línea de comando interna del emulador (Argparse o Python). </li></ul><br><h3 id="virtualnye-com-porty">  Puertos COM virtuales </h3><br><p>  Para interactuar con el UART del dispositivo virtual en la máquina local a través del terminal, debe crear un par de puertos COM virtuales conectados.  En nuestro caso, un puerto usa un emulador y el segundo un programa de terminal (PuTTY o pantalla): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5d/jr/0w/5djr0wz88dgdaiw1xaasrof2wyk.png" alt="Puertos COM virtuales" width="80%"></div><br><h4 id="ispolzovanie-com0com">  Usando com0com </h4><br><p>  Los puertos COM virtuales se configuran con la utilidad de configuración del kit com0com (la versión de la consola es <em>C: \ Archivos de programa (x86) \ com0com \ setup.exe,</em> o la versión de la GUI es <em>C: \ Archivos de programa (x86) \ com0com \ setupg.exe</em> ) : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/j9/pf/v-j9pfquunpiezqhkcr6cuyq-9k.png" alt="Configurar puertos COM virtuales"></div><br><p>  <strong><em>Marque las casillas</em></strong> de <strong><em>verificación de desbordamiento del búfer de habilitación</em></strong> para todos los puertos virtuales creados; de lo contrario, el emulador esperará una respuesta del puerto COM. </p><br><h4 id="ispolzovanie-socat">  Usando socat </h4><br><p>  En los sistemas UNIX, el emulador crea automáticamente puertos COM virtuales utilizando la utilidad socat, para esto es suficiente especificar el prefijo <code>socat:</code> en el nombre del puerto al iniciar el emulador. </p><br><h3 id="vnutrenniy-interfeys-komandnoy-stroki-argparse-ili-python">  Interfaz de línea de comando interna (Argparse o Python) </h3><br><p>  Como Kopycat es una aplicación de consola, el emulador proporciona dos opciones para que la interfaz de línea de comandos interactúe con sus objetos y variables: Argparse y Python. </p><br><p>  Argparse es la CLI integrada en Kopycat, siempre está disponible para todos. </p><br><p>  Una CLI alternativa es el intérprete de Python.  Para usarlo, debe instalar el módulo Jep Python y configurar el emulador para que funcione con Python (se utilizará el intérprete de Python instalado en el sistema principal del usuario). </p><br><h4 id="ustanovka-python-modulya-jep">  Instalar el módulo Python Jep </h4><br><p>  Bajo Linux, Jep se puede instalar a través de pip: </p><br><pre> <code class="bash hljs">pip install jep</code> </pre> <br><p>  Para instalar Jep en Windows, primero debe instalar el SDK de Windows y el Microsoft Visual Studio correspondiente.  Simplificamos un poco su tarea e hicimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ensamblajes WHL</a> JEP para las versiones actuales de Python para Windows, para que el módulo se pueda instalar desde un archivo: </p><br><pre> <code class="bash hljs">pip install jep-3.8.2-cp27-cp27m-win_amd64.whl</code> </pre> <br><p>  Para verificar la instalación de Jep, debe ejecutar la línea de comando: </p><br><pre> <code class="bash hljs">python -c <span class="hljs-string"><span class="hljs-string">"import jep"</span></span></code> </pre> <br><p>  En respuesta, se debe recibir un mensaje: </p><br><pre> <code class="bash hljs">ImportError: Jep is not supported <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> standalone Python, it must be embedded <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Java.</code> </pre> <br><p>  En el archivo por lotes del emulador para su sistema ( <em>kopycat.bat</em> para Windows, <em>kopycat</em> para Linux) agregue el parámetro adicional <code>Djava.library.path</code> a la lista de parámetros <code>DEFAULT_JVM_OPTS</code> ; debe contener la ruta al módulo Jep instalado. </p><br><p>  Como resultado, para Windows, debería obtener una línea como esta: </p><br><pre> <code class="plaintext hljs">set DEFAULT_JVM_OPTS="-XX:MaxMetaspaceSize=256m" "-XX:+UseParallelGC" "-XX:SurvivorRatio=6" "-XX:-UseGCOverheadLimit" "-Djava.library.path=C:/Python27/Lib/site-packages/jep"</code> </pre> <br><h2 id="zapusk-kopycat">  Lanzamiento de Kopycat </h2><br><p>  El emulador es una aplicación JVM de consola.  El lanzamiento se realiza a través de la secuencia de comandos de la línea de comandos del sistema operativo (sh / cmd). </p><br><p>  Comando para ejecutar bajo Windows: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=firmware\rhino_pass.bin,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><p>  El comando para ejecutar en Linux usando la utilidad socat: </p><br><pre> <code class="plaintext hljs">./bin/kopycat -g 23946 -n rhino -l user -y library -p firmware=./firmware/rhino_pass.bin,tty_dbg=socat:./COM26,tty_bt=socat:./COM28</code> </pre> <br><ul><li>  <code>-g 23646</code> : puerto TCP que estará abierto para acceder al servidor GDB; </li><li>  <code>-n rhino</code> : el nombre del módulo principal del sistema (ensamblaje del dispositivo); </li><li>  <code>-l user</code> : el nombre de la biblioteca para buscar el módulo principal; </li><li>  <code>-y library</code> : la ruta para buscar los módulos incluidos en el dispositivo; </li><li>  <code>firmware\rhino_pass.bin</code> - ruta al archivo de firmware; </li><li>  COM26 y COM28 son puertos COM virtuales. </li></ul><br><p>  El resultado será el <code>Argparse &gt;</code> <code>Python &gt;</code> (o <code>Argparse &gt;</code> ): </p><br><pre> <code class="plaintext hljs">18:07:59 INFO [eFactoryBuilder.create ]: Module top successfully created as top 18:07:59 INFO [ Module.initializeAndRes]: Setup core to top.u1_stm32.cortexm0.arm for top 18:07:59 INFO [ Module.initializeAndRes]: Setup debugger to top.u1_stm32.dbg for top 18:07:59 WARN [ Module.initializeAndRes]: Tracer wasn't found in top... 18:07:59 INFO [ Module.initializeAndRes]: Initializing ports and buses... 18:07:59 WARN [ Module.initializePortsA]: ATTENTION: Some ports has warning use printModulesPortsWarnings to see it... 18:07:59 FINE [ ARMv6CPU.reset ]: Set entry point address to 08006A75 18:07:59 INFO [ Module.initializeAndRes]: Module top is successfully initialized and reset as a top cell! 18:07:59 INFO [ Kopycat.open ]: Starting virtualization of board top[rhino] with arm[ARMv6Core] 18:07:59 INFO [ GDBServer.debuggerModule ]: Set new debugger module top.u1_stm32.dbg for GDB_SERVER(port=23946,alive=true) Python &gt;</code> </pre> <br><h2 id="vzaimodeystvie-s-ida-pro">  Interacción con IDA Pro </h2><br><p>  Para simplificar las pruebas, utilizamos el firmware de Rhino como un <a href="">archivo ELF</a> (la metainformación se guarda allí) como el archivo fuente para el análisis en IDA. </p><br><p>  También puede usar el firmware principal sin metainformación. </p><br><p>  Después de iniciar Kopycat en IDA Pro, en el menú Depurador, vaya al elemento " <em>Cambiar depurador ...</em> " y seleccione " <em>Depurador de GDB remoto</em> ".  A continuación, configure la conexión: Menú del <em>depurador - Opciones de proceso ...</em> </p><br><p>  Establecer los valores: </p><br><ul><li>  Aplicación - cualquier valor </li><li>  Nombre de host: 127.0.0.1 (o la dirección IP de la máquina remota donde se ejecuta Kopycat) </li><li>  Puerto: 23946 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/kw/-l/mxkw-lbzq_igoewovazplw4moho.png" alt="Configurar la conexión al servidor GDB"></div><br><p>  Ahora el botón de inicio de depuración está disponible (tecla F9): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/mu/-q/afmu-qpi0ymfpsga-orunargmas.png"></div><br><p>  Presiónelo: se conecta al módulo depurador en el emulador.  IDA entra en modo de depuración, ventanas adicionales están disponibles: información sobre registros, sobre la pila. </p><br><p>  Ahora podemos usar todas las características estándar de trabajar con el depurador: </p><br><ul><li>  ejecución paso a paso de instrucciones ( <em>Paso a</em> <em>paso</em> y <em>Paso a paso</em> - teclas F7 y F8, respectivamente); </li><li>  iniciar y pausar la ejecución; </li><li>  creando puntos de interrupción tanto en código como en datos (tecla F2). </li></ul><br><p>  Conectarse al depurador no significa iniciar el código de firmware.  La posición actual para la ejecución debe ser la dirección <code>0x08006A74</code> , el comienzo de la función <em>Reset_Handler</em> .  Si se desplaza hacia abajo en la lista a continuación, puede ver la llamada a la función <em>principal</em> .  Puede colocar el cursor en esta línea (dirección <code>0x08006ABE</code> ) y ejecutar la operación <em>Ejecutar hasta el cursor</em> (tecla F4). </p><br><p><img src="https://habrastorage.org/webt/wx/k4/3r/wxk43r-316cpnsdabb9eydkzus4.png" alt="imagen"></p><br><p>  A continuación, puede presionar F7 para ingresar a la función <em>principal</em> . </p><br><p>  Si ejecuta el comando <em>Continuar proceso</em> (tecla F9), la ventana "Espere" aparecerá con un solo botón <em>Suspender</em> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9e/78/tg/9e78tgoterc50rqvmosunzp1u5i.png"></div><br><p>  Cuando <em>se</em> presiona <em>Suspender</em> , la ejecución del código de firmware se suspende y puede continuar desde la misma dirección en el código donde se interrumpió. </p><br><p>  Si continúa ejecutando el código, en las terminales conectadas a los puertos COM virtuales, puede ver las siguientes líneas: </p><br><p><img src="https://habrastorage.org/webt/fi/vi/j-/fivij-hshz3izcxoo0lnewnznc8.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/2m/cn/oq/2mcnoqd__te1i0sq5z28jd29mdg.png" alt="imagen"></p><br><p>  La presencia de la cadena "omisión de estado" indica que el módulo Bluetooth virtual ha cambiado al modo de recepción de datos desde el puerto COM del usuario. </p><br><p>  Ahora en el terminal Bluetooth (en la figura - COM29) puede ingresar comandos de acuerdo con el protocolo Rhino.  Por ejemplo, la cadena "mur-mur" vuelve al comando "MEOW" en el terminal Bluetooth: </p><br><img src="https://habrastorage.org/webt/yq/td/ab/yqtdabgfdd3jlzswsrk3rvbdzds.png"><br><br><h3 id="emuliruy-menya-ne-polnostyu">  Emularme no completamente </h3><br><p>  Al construir un emulador, puede elegir el grado de detalle / emulación de un dispositivo.  Entonces, por ejemplo, el módulo Bluetooth se puede emular de diferentes maneras: </p><br><ul><li>  dispositivo completamente emulado con un conjunto completo de comandos; </li><li>  Los comandos AT se emulan y el flujo de datos se recibe desde el puerto COM del sistema principal; </li><li>  dispositivo virtual proporciona redirección de datos completa a un dispositivo real; </li><li>  como un trozo simple que siempre devuelve "OK". </li></ul><br><p>  En la versión actual del emulador, se utiliza el segundo enfoque: el módulo Bluetooth virtual realiza la configuración, luego de lo cual cambia al modo "proxy" de datos desde el puerto COM del sistema principal al puerto UART del emulador. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e6/5c/m_/e65cm_tl2bggpbg0-q0azjvdz64.jpeg"></div><br><p>  Considere la posibilidad de instrumentación simple del código si alguna parte de la periferia no está implementada.  Por ejemplo, si no se crea un temporizador que controle la transferencia de datos en DMA (la verificación se realiza en la función <em>ws2812b_wait</em> ubicada en <code>0x08006840</code> ), el firmware siempre esperará a que el indicador de <em>ocupado</em> ubicado en <code>0x200004C4</code> restablezca la línea de datos DMA: </p><br><img src="https://habrastorage.org/webt/pt/jj/su/ptjjsutfya2dkoqdoshkeyeeqzw.png"><br><p>  Podemos sortear esta situación restableciendo manualmente el indicador de <em>ocupado</em> inmediatamente después de configurarlo.  En IDA Pro, puede crear una función de Python y llamarla en punto de interrupción, y el punto de interrupción debe establecerse en el código después de escribir el valor 1 en el indicador <em>ocupado</em> . </p><br><h4 id="breakpoint-obrabotchik">  Controlador de punto de interrupción </h4><br><p>  Primero, cree una función Python en la IDA.  Menú <em>Archivo - Comando de script ...</em> </p><br><p>  Agregue un nuevo fragmento en la lista de la izquierda, asígnele un nombre (por ejemplo, <em>BPT</em> ), <br>  En el cuadro de texto a la derecha, ingresamos el código de función: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_dma</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Skipping wait ws2812..."</span></span> value = Byte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value == <span class="hljs-number"><span class="hljs-number">1</span></span>: PatchDbgByte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zi/za/-d/ziza-ddx3arqlqfbd-o6jvdmnjc.png"></div><br><p>  Después de eso, haga clic en <em>Ejecutar</em> y cierre la ventana del script. </p><br><p>  Ahora vamos al código en <code>0x0800688A</code> , establezca el punto de interrupción (tecla F2), <code>0x0800688A</code> ( <em>Editar punto de interrupción ...</em> menú contextual), no olvide establecer el tipo de script - Python: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fo/pn/1v/fopn1vb8fbxqrhn6xoia_rgnsau.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h6/yq/b2/h6yqb29r1m9sngr3csfimxcxsew.png"></div><br><p>  Si el valor actual de la bandera de <em>ocupado</em> es 1, entonces la función <em>skip_dma</em> debe <em>ejecutarse</em> en la línea de script: </p><br><img src="https://habrastorage.org/webt/m-/t8/in/m-t8in2th7ei6neigdzgzq17kxy.png"><br><p>  Si ejecuta el firmware para su ejecución, el código del controlador de punto de interrupción se puede ver en el IDA en la ventana <em>Salida</em> en la línea <code>Skipping wait ws2812...</code>  Ahora el firmware no esperará para restablecer el indicador de <em>ocupado</em> . </p><br><h4 id="vzaimodeystvie-s-emulyatorom">  Interacción del emulador </h4><br><p>  La emulación por el bien de la emulación es poco probable que cause deleite y alegría.  Es mucho más interesante si el emulador ayuda al investigador a ver los datos en la memoria o a establecer la interacción de los flujos. </p><br><p>  Mostramos cómo establecer dinámicamente la interacción de las tareas RTOS.  Primero, pause la ejecución del código si se está ejecutando.  Si cambia a la función <em>bluetooth_task_entry</em> en la rama de procesamiento de comandos "LED" (dirección <code>0x080057B8</code> ), puede ver lo que se creó primero y luego se envía un mensaje a la cola del sistema <em>ledControlQueueHandle</em> . </p><br><p><img src="https://habrastorage.org/webt/po/bk/zm/pobkzmapmust02eaafle7d_pxba.png" alt="imagen"></p><br><p>  Debe establecer el punto de interrupción para acceder a la variable <em>ledControlQueueHandle</em> ubicada en <code>0x20000624</code> y continuar ejecutando el código: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/wo/g3/evwog3vrv7ozxlxjozd4itvve0a.png"></div><br><p>  Como resultado, al principio se detendrá en la dirección <code>0x080057CA</code> antes de llamar a la función <em>osMailAlloc</em> , luego a <code>0x08005806</code> antes de llamar a la función <em>osMailPut</em> , luego después de un tiempo en la dirección <code>0x08005BD4</code> (antes de llamar a la función <em>osMailGet</em> ), que pertenece a la función <em>leds_task_entry</em> (tarea LED), es decir hubo un cambio de tarea, y ahora el control ha recibido la tarea LED. </p><br><p><img src="https://habrastorage.org/webt/th/ni/zh/thnizhzqykfn20l9-btkuqhawlc.png" alt="imagen"></p><br><p>  De una manera tan simple, puede establecer cómo las tareas RTOS interactúan entre sí. </p><br><p>  Por supuesto, en realidad, la interacción de tareas puede ser más complicada, pero usar un emulador para rastrear esta interacción se vuelve menos difícil. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aquí</a> puede ver un breve video del lanzamiento del emulador y la interacción con IDA Pro. </p><br><h2 id="zapusk-s-radare2">  Lanzamiento con Radare2 </h2><br><p>  No puede ignorar una herramienta tan universal como Radare2. </p><br><p>  Para conectarse al emulador usando r2, el comando se verá así: </p><br><pre> <code class="plaintext hljs">radare2 -A -a arm -b 16 -d gdb://localhost:23946 rhino_fw42k6.elf</code> </pre> <br><p>  Ahora el inicio ( <code>dc</code> ) y la ejecución de pausa (Ctrl + C) están disponibles. </p><br><p>  Desafortunadamente, en este momento en r2 hay problemas al trabajar con un servidor gdb de hardware y marcado de memoria, debido a esto, los puntos de interrupción y los Pasos (el comando <code>ds</code> ) no funcionan.  Esperamos que esto se solucione en el futuro cercano. </p><br><h2 id="zapusk-s-eclipse">  Lanzamiento con Eclipse </h2><br><p>  Una de las opciones para usar el emulador es depurar el firmware del dispositivo en desarrollo.  Para mayor claridad, también utilizaremos el firmware de Rhino.  Puede descargar las fuentes de firmware <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desde aquí</a> . </p><br><p>  Utilizaremos el Eclipse del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">System Workbench para la</a> suite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">STM32</a> como IDE. </p><br><p>  Para que el firmware compilado directamente en Eclipse se cargue en el emulador, debe agregar el parámetro <code>firmware=null</code> al comando de inicio del emulador: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=null,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><h3 id="nastroyka-debug-konfiguracii">  Configuración de depuración </h3><br><p>  En Eclipse, seleccione el menú <em>Ejecutar - Configuraciones de depuración ...</em> En la ventana que se abre, en la sección <em>Depuración de hardware de GDB</em> , debe agregar una nueva configuración y luego especificar el proyecto y la aplicación actual para la depuración en la pestaña "Principal": </p><br><img src="https://habrastorage.org/webt/f-/yk/eo/f-ykeob2i5vg25qbrz_egbqntou.png"><br><p>  En la pestaña Depurador, debe especificar el comando GDB: <br> <code>${openstm32_compiler_path}\arm-none-eabi-gdb</code> </p> <br><p>  Y también ingrese los parámetros para conectarse al servidor GDB (host y puerto): </p><br><img src="https://habrastorage.org/webt/ef/ud/fo/efudfommb7a9gkr4kcvp0vtnqfm.png"><br><p>  Los siguientes parámetros deben especificarse en la pestaña "Inicio": </p><br><ul><li>  active la casilla de verificación <em>Cargar imagen</em> (para que la imagen de firmware ensamblada se cargue en el emulador); </li><li>  active la marca de verificación <em>Cargar símbolos</em> ; </li><li>  agregue un comando de inicio: <code>set $pc = *0x08000004</code> (establezca el valor de la memoria en el registro de la PC en la dirección <code>0x08000004</code> : la dirección de <code>0x08000004</code> se almacena allí). </li></ul><br><p>  <strong>Tenga en cuenta</strong> que si no desea descargar el archivo de firmware de Eclipse, no necesita especificar los parámetros <em>Cargar imagen</em> y <em>Ejecutar comandos</em> . </p><br><img src="https://habrastorage.org/webt/w3/q8/2f/w3q82fvei4c91385rlcipmuiy_i.png"><br><p>  Después de hacer clic en Depurar, puede trabajar en modo de depuración: </p><br><ul><li>  ejecución de código paso a paso <br><img src="https://habrastorage.org/webt/1h/6n/ax/1h6nax1gpgcdyrwakdmzzlu6_x8.png"></li><li>  interacción con puntos de interrupción <br><img src="https://habrastorage.org/webt/4d/n1/5e/4dn15e4hzaukbif58ggwhy_wg18.png"></li></ul><br><p>  <strong><em>Nota</em></strong>  <em>Eclipse tiene, hmm ... algunas características ... y tienes que vivir con ellas.</em>  <em>Por ejemplo, si aparece el mensaje "No hay fuente disponible para" 0x0 "" al iniciar el depurador, ejecute el comando Paso (F5)</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/uz/ko/rauzko55hgnj1y_uapnqbz8ftrw.png"></div><br><h2 id="vmesto-zaklyucheniya">  En lugar de una conclusión </h2><br><p>  La emulación de código nativo es algo muy interesante.  Para un desarrollador de dispositivos, es posible depurar el firmware sin un dispositivo real.  Para el investigador: la capacidad de realizar análisis de código dinámico, que no siempre es posible incluso con un dispositivo. </p><br><p>  Queremos proporcionar a los especialistas una herramienta que sea conveniente, moderadamente simple y que no requiera mucho esfuerzo y tiempo para configurar e iniciar. </p><br><p>  Escriba en los comentarios sobre su experiencia con el uso de emuladores de hardware.  Te invitamos a una discusión y estaremos encantados de responder preguntas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445798/">https://habr.com/ru/post/445798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445786/index.html">Criptografía en Java. Clase KeyStore</a></li>
<li><a href="../445788/index.html">Videovigilancia en la nube hágalo usted mismo: nuevas características de Ivideon Web SDK</a></li>
<li><a href="../445792/index.html">Cómo desarrollamos documentación en un proyecto abierto de Embox</a></li>
<li><a href="../445794/index.html">Gigantes de TI presentan una solución de implementación de nube híbrida híbrida</a></li>
<li><a href="../445796/index.html">Fintech Digest: Dorsey paga con bitcoins, la estrategia blockchain de Australia, la salida a bolsa de Levi, el alcalde de Chicago y la inevitabilidad de bitcoin</a></li>
<li><a href="../445800/index.html">Mónadas en 15 minutos</a></li>
<li><a href="../445802/index.html">5 cosas sobre las tendencias de Internet que todo el mundo debería saber</a></li>
<li><a href="../445804/index.html">Encapsulación para samurai real, o los matices asociados con la palabra clave interna en C #</a></li>
<li><a href="../445806/index.html">Cómo la inteligencia artificial está cambiando la ciencia</a></li>
<li><a href="../445808/index.html">Odiamos y cazamos: la vida peligrosa de un virus que está haciendo enemigos poderosos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>