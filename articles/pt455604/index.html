<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåõ üßòüèº ‚úàÔ∏è Respons√°vel por gerenciar a configura√ß√£o do Windows. Hist√≥ria de sucesso ü§∑üèª üë¶ ‚ÜòÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em uma das reuni√µes da comunidade .net de St. Petersburg dos desenvolvedores da comunidade SpbDotNet, realizamos um experimento e decidimos falar sobr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Respons√°vel por gerenciar a configura√ß√£o do Windows. Hist√≥ria de sucesso</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/455604/"><p>  Em uma das reuni√µes da comunidade .net de St. Petersburg dos desenvolvedores da comunidade SpbDotNet, realizamos um experimento e decidimos falar sobre como voc√™ pode aplicar abordagens que h√° muito se tornaram padr√£o no mundo Linux para automatizar as infraestruturas do Windows.  Mas, para n√£o levar tudo ao ponto de sinalizar o sinalizador Ansible, decidiu-se mostrar isso pelo exemplo da implanta√ß√£o de um aplicativo ASP.Net. </p><br><p>  Aleksey Chernov, desenvolvedor s√™nior da equipe que desenvolve a biblioteca de componentes de interface do usu√°rio para nossos projetos, ofereceu-se como orador.  E sim, n√£o lhe pareceu: um desenvolvedor de JavaScript esteve na frente de um p√∫blico .Net. </p><br><p>  Qualquer pessoa interessada no resultado de um experimento desse tipo, seja bem-vinda, abaixo do corte para decodifica√ß√£o. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nEA3sSE33U4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Ol√°) Eles j√° estragaram um pouco e disseram que sou um front-end, ent√£o voc√™ j√° pode divergir =) Meu nome √© Alexei, venho fazendo todo tipo de coisa sobre desenvolvimento da Web h√° algum tempo.  Comecei com Perl, depois havia PHP, um pouco de RoR, um pouco, um pouco disso.  E ent√£o o JavaScript entrou na minha vida, e desde ent√£o eu tenho feito quase tudo isso. </p><br><p>  Al√©m do JS, ultimamente tenho escrito muitos autotestes (al√©m disso, no mesmo JS) e, portanto, tenho que lidar com a automa√ß√£o da implanta√ß√£o de bancos de teste e a infraestrutura para eles. </p><br><p>  <strong>Antecedentes</strong> </p><br><p>  Dois anos atr√°s, acabei na Veeam, onde eles est√£o desenvolvendo produtos para Windows.  Naquele momento, fiquei muito surpreso, mas aconteceu que acontece =).  Mas, acima de tudo, fiquei surpreso com o n√≠vel incomumente baixo de automa√ß√£o de tudo relacionado √† implanta√ß√£o, com a implanta√ß√£o de aplicativos, com testes etc. </p><br><p>  N√≥s, aqueles que desenvolvemos para Linux, h√° muito que estamos acostumados ao fato de que tudo deve estar no Docker, existe o Kubernetes e tudo se desenrola com um √∫nico clique.  E quando eu acabei em um ambiente onde tudo isso n√£o est√° l√°, chocou.  E quando comecei a realizar testes autom√°ticos, percebi que esse sucesso era de apenas 20% e tudo o mais estava preparando a infraestrutura para eles. </p><br><p><img src="https://habrastorage.org/webt/5v/rm/ca/5vrmcacwrpdrkb1dejapgmjzfqa.png"><br>  <em>Meus sentimentos no come√ßo</em> </p><br><p>  <strong>Condi√ß√µes atuais</strong> </p><br><p>  Vou falar um pouco sobre como tudo est√° organizado conosco, o que precisamos automatizar e o que fazemos. </p><br><p> Temos um monte de produtos diferentes, a maioria deles est√° no Windows, h√° v√°rios no Linux e at√© algo no Solaris.  Muitas compila√ß√µes s√£o coletadas diariamente para todos os produtos.  Portanto, √© necess√°rio distribuir tudo isso nos laborat√≥rios de teste, tanto para o controle de qualidade quanto para os pr√≥prios desenvolvedores, para que eles possam verificar a integra√ß√£o de aplicativos.  Tudo isso requer uma enorme infraestrutura de muitos servidores de ferro e m√°quinas virtuais.  E, √†s vezes, fazemos testes de desempenho, quando precisamos aumentar imediatamente mil m√°quinas virtuais e ver com que rapidez nossos aplicativos funcionar√£o. </p><br><p>  <strong>Os problemas</strong> </p><br><p>  Obviamente, nos primeiros est√°gios (leia-se h√° muito tempo), ao tentar automatizar tudo de frente, o PowerShell era usado.  A ferramenta √© poderosa, mas os scripts de implanta√ß√£o s√£o extremamente complicados.  Outro problema foi a falta de gerenciamento centralizado desse processo.  Alguns scripts foram executados localmente por desenvolvedores, outros em m√°quinas virtuais criadas na era dos mamutes, etc.  Como resultado: foi dif√≠cil obter um √∫nico resultado e entender o que funciona e o que n√£o funciona.  Voc√™ vem para o trabalho, abra o navegador - o servidor est√° indispon√≠vel.  Por que n√£o est√° dispon√≠vel, o que aconteceu, onde quebrou - n√£o estava completamente claro.  N√£o havia um √∫nico ponto de entrada, e eu tinha que procurar a verdade nas salas de bate-papo em funcionamento, e √© bom que algu√©m atenda. </p><br><p>  Outro problema, n√£o t√£o √≥bvio, s√£o os novatos.  Foi dif√≠cil para eles.  Na primeira semana de trabalho, eles apenas se aprofundaram no que estava acontecendo.  Habitualmente viv√≠amos com isso, assegurando a n√≥s mesmos que a vida √© uma coisa dif√≠cil e que devemos atend√™-la.  Entender e perdoar, por assim dizer. </p><br><p>  Mas em algum momento eles encontraram a for√ßa interior para super√°-la e olhar em volta.  Provavelmente, de alguma forma, voc√™ pode lidar com isso. </p><br><p><img src="https://habrastorage.org/webt/kg/ra/io/kgraiod0cirwgawpngochydtu2e.png"><br>  <em>O primeiro passo para resolver o problema √© aceit√°-lo.</em> </p><br><p>  <strong>Sele√ß√£o de solu√ß√£o</strong> </p><br><p>  Quando voc√™ n√£o souber o que fazer, veja o que os outros est√£o fazendo. </p><br><p>  E, para come√ßar, fizemos nossa lista de requisitos para o que queremos obter no final. </p><br><ul><li>  Base de c√≥digo unificada.  Todos os scripts de implanta√ß√£o devem estar no mesmo local.  Deseja implantar algo ou ver como ele se desenrola: aqui est√° um reposit√≥rio para voc√™, v√° l√°. </li><li>  Todo mundo sabe como isso funciona.  As perguntas devem desaparecer √† la "Eu n√£o entendo como implant√°-lo, ent√£o no segundo dia n√£o consigo fechar o bug". </li><li>  Capacidade de iniciar pelo bot√£o.  Precisamos ser capazes de controlar implanta√ß√µes.  Por exemplo, algum tipo de interface da web, para onde voc√™ vai, pressione um bot√£o e o produto desejado √© implantado no host desejado. </li></ul><br><p>  Depois de garantir que essa lista cubra os requisitos m√≠nimos e necess√°rios para a nossa felicidade, come√ßamos a tentar.  Tradicionalmente, a primeira coisa que tentavam resolver problemas era o m√©todo de ataque frontal.  Temos muitos scripts do PowerShell?  Ent√£o, vamos combin√°-los em um reposit√≥rio.  Mas o problema n√£o √© que havia muitos scripts, mas que equipes diferentes fizeram a mesma coisa com scripts diferentes.  Andei por equipes diferentes, ouvi seus requisitos, coletei os mesmos scripts, tentei pentear e parametriz√°-los de alguma forma e depois os coloquei em um √∫nico reposit√≥rio. </p><br><p>  <strong>Falha: A</strong> tentativa falhou.  Em primeiro lugar, come√ßamos a discutir muito sobre por que estamos fazendo isso e n√£o dessa maneira.  Por que esse m√©todo foi usado, e n√£o outro, etc.  E, como resultado, havia muitos que queriam refazer tudo "como deveria", com o princ√≠pio de "vou bifurcar e reescrever tudo para voc√™".  E, √© claro, n√£o ser√° poss√≠vel combinar filiais com essa abordagem. </p><br><p>  Tentativa n√∫mero dois: era necess√°rio pegar nosso servidor de CI (TeamCity), criar alguns modelos e, usando heran√ßa, fechar o problema principal desde a primeira tentativa.  Mas, como voc√™ deve ter adivinhado imediatamente, <strong>Fail tamb√©m estava</strong> esperando por n√≥s <strong>:</strong> voc√™ pode usar o modelo apenas para a vers√£o mais recente, o que significa que n√£o obteremos o controle de vers√£o necess√°rio.  E a consequ√™ncia de um grande n√∫mero de equipes - os modelos se tornaram muitos, tornou-se mais dif√≠cil gerenci√°-los e, no horizonte, um novo p√¢ntano era claramente vis√≠vel. </p><br><p><img src="https://habrastorage.org/webt/10/mb/ai/10mbain0xddl-fwxwkvtmebrl-i.png"></p><br><p>  Cansado de cair de bru√ßos em qualquer tentativa de decolar, decidiu-se sentar novamente e pensar muito.  Portanto, temos um monte de scripts ps, por um lado, e um grande n√∫mero de virtuais, por outro.  Mas est√°vamos errados, porque  essa n√£o era a raiz do problema.  O problema era que sempre havia uma pessoa entre essas coisas.  N√£o importa se √© um desenvolvedor, um testador ou outra pessoa, a seguinte cadeia l√≥gica sempre ocorreu na cabe√ßa: </p><br><ul><li>  Ent√£o, eu preciso de uma m√°quina virtual para testes </li><li>  Sim, aqui temos um pool de host </li><li>  E aqui est√° o script que eu preciso, agora eu vou execut√°-lo, e tudo vai acontecer </li></ul><br><p>  Com a realiza√ß√£o de uma coisa aparentemente simples, o problema geral come√ßou a brincar com novas cores.  Aconteceu que todas as nossas dores s√£o decorrentes da falta de uma √∫nica descri√ß√£o de nossa infraestrutura.  Estava na mente das pessoas que o criaram, eles se sentaram em departamentos diferentes, n√£o tentaram document√°-lo de alguma forma e, geralmente, todos viviam em seu pr√≥prio estado separado. <br>  Nesse momento, chegamos √† conclus√£o de que a resposta para todos os nossos problemas √©: </p><br><p>  <strong>Infraestrutura como um c√≥digo</strong> </p><br><p>  √â precisamente que toda a nossa infraestrutura deve ser descrita em c√≥digo e colocada no reposit√≥rio.  Todas as m√°quinas virtuais, todos os seus par√¢metros, tudo o que est√° instalado l√° - tudo precisa ser descrito no c√≥digo. </p><br><p>  Surge uma pergunta leg√≠tima - por qu√™? </p><br><p>  Respondemos: essa abordagem nos dar√° a oportunidade de aplicar as melhores pr√°ticas do mundo do desenvolvimento, √†s quais estamos todos t√£o acostumados: </p><br><ul><li>  Controle de vers√£o.  Sempre podemos entender o que e quando mudou.  N√£o h√° mais hosts saindo do nada ou indo a lugar nenhum.  Sempre ficar√° claro quem fez as altera√ß√µes. </li><li>  Revis√£o de c√≥digo.  Poderemos controlar os processos de implanta√ß√£o para que alguns n√£o violem outros. </li><li>  Integra√ß√£o Cont√≠nua. </li></ul><br><p>  <strong>Sele√ß√£o de ferramenta</strong> </p><br><p>  Como todos sabemos, existem muitas ferramentas de gerenciamento de configura√ß√£o.  Optamos pelo Ansible, pois cont√©m um conjunto de recursos que precisamos. <br>  Antes de tudo, queremos que o sistema de automa√ß√£o n√£o execute nenhum instalador, algo para migrar para algum lugar etc.  Primeiro de tudo, a partir de um sistema assim, queremos que, depois de pressionar um bot√£o, veremos a interface do aplicativo que precisamos. </p><br><p>  Portanto, o principal recurso para n√≥s √© a idempot√™ncia.  Ansible n√£o importa o que aconteceu antes.  Depois de iniciar o manual desejado, sempre obtemos o mesmo resultado.  Isso √© muito importante quando voc√™ diz n√£o "Instalar o IIS", mas "Deve haver o IIS", e n√£o precisa pensar se ele j√° estava l√° antes ou n√£o.  √â muito dif√≠cil conseguir isso com scripts, e os manuais Ansible oferecem essa oportunidade. </p><br><p>  Tamb√©m vale mencionar a aus√™ncia de agente da Ansible.  A maioria dos sistemas de automa√ß√£o trabalha com agentes.  H√° muitas vantagens nisso - por exemplo, o melhor desempenho -, mas era importante para n√≥s que n√£o houvesse agente para que o sistema n√£o precisasse ser preparado de alguma forma adicional. </p><br><p>  PowerShell: </p><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$url</span></span> = <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> <span class="hljs-variable"><span class="hljs-variable">$output</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSSscriptRoot</span></span></span><span class="hljs-string">\build.msi"</span></span> Invoke-WebRequest -Uri <span class="hljs-variable"><span class="hljs-variable">$url</span></span> -OutFile <span class="hljs-variable"><span class="hljs-variable">$output</span></span></code> </pre> <br><p>  Ansible: </p><br><pre> <code class="bash hljs">name: Download build hosts: all tasks: name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"build.msi"</span></span> force: no</code> </pre> <br><p>  Aqui vemos que no exemplo b√°sico, o script ps ser√° ainda mais conciso do que o manual Ansible.  3 linhas de script versus 7 linhas de playbook para fazer o download de um arquivo. </p><br><p>  Mas, Petka, h√° uma nuance (s).  Assim que quisermos aderir ao princ√≠pio da idempot√™ncia e, por exemplo, para garantir que o arquivo no servidor n√£o tenha sido alterado e n√£o precise ser baixado, ser√° necess√°rio implementar uma solicita√ß√£o HEAD no script, que adiciona cerca de 200 linhas.  E no manual - um.  O m√≥dulo Ansible win_get_url, que faz todas as verifica√ß√µes para voc√™, cont√©m 257 linhas de c√≥digo que voc√™ n√£o precisa inserir em cada script. </p><br><p>  E este √© apenas um exemplo de uma tarefa muito simples. </p><br><p><img src="https://habrastorage.org/webt/ca/tz/el/catzel2r3lxpzk_yaz0moo6s-c0.png"></p><br><p>  E se voc√™ pensar bem, precisamos de idempot√™ncia em todos os lugares: </p><br><ul><li>  Verifique a exist√™ncia de uma m√°quina virtual.  No caso de scripts, corremos o risco de produzir um n√∫mero infinito deles, ou o script falhar√° no in√≠cio. </li><li>  Quais pacotes msi existem na m√°quina?  Na melhor das hip√≥teses, nada cair√° aqui; na pior das hip√≥teses, a m√°quina deixar√° de funcionar adequadamente. </li><li>  Preciso fazer o download de artefatos de constru√ß√£o novamente?  √â bom que suas constru√ß√µes pesem uma d√∫zia de megabytes.  E os que t√™m alguns gigabytes? </li></ul><br><p>  E outros exemplos, onde a sa√≠da √© aumentar os scripts com ramifica√ß√µes infinitas de ifs que n√£o podem ser adequadamente depurados e imposs√≠veis de gerenciar. </p><br><p>  Entre outras coisas importantes para n√≥s, o Ansible n√£o usa agentes para gerenciar seus hosts e m√°quinas.  No Linux, √© claro, ele roda no ssh, enquanto no Windows o WinRM √© usado.  Da√≠ a conseq√º√™ncia √≥bvia: o Ansible √© multiplataforma.  Ele suporta um n√∫mero fant√°stico de plataformas, at√© equipamentos de rede. </p><br><p>  E o √∫ltimo, mas n√£o menos importante, √© o formato de grava√ß√£o de configura√ß√£o YAML.  Todos est√£o acostumados, √© f√°cil de ler e √© f√°cil descobrir o que est√° acontecendo l√°. </p><br><p>  Mas nem tudo √© t√£o doce, h√° problemas: </p><br><ul><li>  O problema √© duvidoso: para executar playbooks, voc√™ ainda precisa de uma m√°quina Linux, mesmo que toda a sua infraestrutura seja exclusivamente Windows.  Embora este n√£o seja um problema t√£o grande no mundo moderno, porque  no Windows 10, agora existe o WSL, onde voc√™ pode executar o Ubuntu, sob o qual direciona playbooks. </li><li>  √Äs vezes, os playbooks s√£o realmente dif√≠ceis de depurar.  Ansible √© escrito em python, e a √∫ltima coisa que quero ver √© uma folha de pilha de pilha de cinco telas em python.  E um erro de digita√ß√£o no nome do m√≥dulo </li></ul><br><p>  <strong>Como isso funciona?</strong> <br>  Primeiro, precisamos de uma m√°quina Linux.  Na terminologia Ansible, isso √© chamado de M√°quina de Controle. <br>  Os playbooks come√ßar√£o a partir dele e toda a magia acontece nele. </p><br><p>  Nesta m√°quina, precisaremos de: </p><br><ul><li>  Python e o gerenciador de pacotes python pip.  Muitas distribui√ß√µes est√£o prontas para uso, por isso n√£o h√° surpresas aqui. </li><li>  Instale o Ansible via pip, da maneira mais universal: pip install ansible </li><li>  Adicione um m√≥dulo winrm para acessar as m√°quinas Windows: pip install pywinrm [credssp] </li><li>  E nas m√°quinas que queremos controlar, precisamos ativar o winrm, porque  est√° desativado por padr√£o.  H√° muitas maneiras de fazer isso, e todas s√£o descritas na documenta√ß√£o Ansible.  Mas o mais simples √© pegar o script finalizado no reposit√≥rio Ansible e execut√°-lo com a op√ß√£o de autoriza√ß√£o necess√°ria: ConfigureRemotingForAnsible.ps1 -EnableCredSSP </li></ul><br><p>  A parte mais importante que precis√°vamos para parar de sofrer com os scripts ps foi o Inventory.  Um arquivo YAML (no nosso caso), que descreve nossa infraestrutura e onde voc√™ sempre pode procurar entender onde isso est√° implantado.  E, √© claro, os pr√≥prios manuais.  No futuro, o trabalho parecer√° lan√ßar um manual com o arquivo de invent√°rio necess√°rio e par√¢metros adicionais. </p><br><pre> <code class="bash hljs">all: children: webservers: hosts: spbdotnet-test-host.dev.local: dbservers: hosts: spbdotnet-test-host.dev.local: vars: ansible_connection: winrm ansible_winrm_transport: credssp ansible_winrm_server_cert_validation: ignore ansible_user: administrator ansible_password: 123qweASD</code> </pre> <br><p>  Tudo √© simples aqui: o grupo raiz √© todo e dois subgrupos, servidores da web e dbservers.  Tudo o resto √© intuitivo, mas chamarei sua aten√ß√£o para o fato de o Ansible, por padr√£o, considerar o Linux em todo lugar; portanto, no Windows, voc√™ deve especificar o winrm e o tipo de autoriza√ß√£o. </p><br><p>  A senha de forma clara, √© claro, n√£o precisa ser armazenada no manual, aqui est√° apenas um exemplo.  As senhas podem ser armazenadas, por exemplo, no Ansible-Vault.  Usamos o TeamCity para isso, que transmite segredos por vari√°veis ‚Äã‚Äãde ambiente e n√£o aciona nada. </p><br><p>  <strong>M√≥dulos</strong> </p><br><p>  Tudo o que o Ansible faz, faz com a ajuda dos m√≥dulos.  M√≥dulos para Linux s√£o escritos em python, para Windows no PowerShell.  E uma rever√™ncia pela idempot√™ncia: o resultado do m√≥dulo sempre vem na forma de um arquivo json, que indica se houve altera√ß√µes no host ou n√£o. </p><br><p>  No caso geral, executaremos uma constru√ß√£o da lista de m√≥dulos do arquivo de invent√°rio do grupo de hosts ansible do formul√°rio: </p><br><p><img src="https://habrastorage.org/webt/dt/ww/s7/dtwws7ix1i1k1jqbtpp0cnowrus.png"></p><br><p>  <strong>Playbooks</strong> </p><br><p>  Um manual √© uma descri√ß√£o de como e onde vamos executar os m√≥dulos Ansible. </p><br><pre> <code class="bash hljs">- name: Install AWS CLI hosts: all vars: aws_cli_download_dir: c:\downloads aws_cli_msi_url: https://s3.amazonaws.com/aws-cli/AWSCLI32PY3.msi tasks: - name: Ensure target directory exists win_file: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}"</span></span> state: directory - name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_msi_url }}"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> force: no - name: Install AWS CLI win_package: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> state: present</code> </pre> <br><p>  Neste exemplo, temos tr√™s tarefas.  Cada tarefa √© uma chamada de m√≥dulo.  Neste manual, primeiro criamos um diret√≥rio (verifique se ele existe), depois baixamos a CLI da AWS e instalamos usando o m√≥dulo win_packge. </p><br><p>  Ao executar este manual, obtemos esse resultado. </p><br><p><img src="https://habrastorage.org/webt/ga/2x/sd/ga2xsdh7zgvlxvioliy_g3ijkxo.png"></p><br><p>  O relat√≥rio mostra que quatro tarefas foram conclu√≠das com √™xito e tr√™s das quatro fizeram algumas altera√ß√µes no host. </p><br><p>  Mas o que acontece se voc√™ executar este manual novamente?  N√£o escrevemos em nenhum lugar que devemos criar o diret√≥rio, baixar o arquivo do instalador e execut√°-lo.  Simplesmente verificamos a disponibilidade de cada item e pulamos, se dispon√≠vel. </p><br><p><img src="https://habrastorage.org/webt/8m/ro/de/8mrodes1ld9oocapp3qhnypwkcw.png"></p><br><p>  Essa √© a idempot√™ncia que n√£o conseguimos com o PowerShell. </p><br><p>  <strong>Pr√°tica</strong> </p><br><p>  Este √© um exemplo um pouco simplificado, mas, em princ√≠pio, √© exatamente isso que fazemos todos os dias. <br>  Implementaremos um aplicativo que consiste em um servi√ßo do Windows e um aplicativo da Web no IIS. </p><br><pre> <code class="bash hljs">- name: Setup App hosts: webservers tasks: - name: Install IIS win_feature: name: - Web-Server - Web-Common-Http include_sub_features: True include_management_tools: True state: present register: win_feature - name: reboot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installing Web-Server feature requires it win_reboot: when: win_feature.reboot_required</code> </pre> <br><p>  Primeiro, precisamos verificar se existe algum IIS no host e instal√°-lo, se n√£o houver.  E seria bom adicionar imediatamente ferramentas de gerenciamento e todos os recursos dependentes.  E √© muito bom se o host for reiniciado, se necess√°rio. </p><br><p>  A primeira tarefa que resolvemos √© o m√≥dulo win_feature, que est√° envolvido no gerenciamento de recursos do Windows.  E aqui, pela primeira vez, temos as vari√°veis ‚Äã‚Äãde ambiente Ansible, no item de registro.  Lembre-se, eu disse que as tarefas sempre retornam um objeto json?  Agora, depois de concluir a tarefa Instalar IIS, a sa√≠da do m√≥dulo win_feature fica na vari√°vel win_feature (desculpe-me pela tautologia). </p><br><p>  Na pr√≥xima tarefa, chamamos o m√≥dulo win_reboot.  Mas n√£o precisamos reiniciar nosso servidor todas as vezes.  N√≥s o recarregaremos apenas se o m√≥dulo win_feature retornar esse requisito para n√≥s na forma de uma vari√°vel. </p><br><p>  O pr√≥ximo passo √© instalar o SQL.  Um milh√£o de maneiras j√° foram inventadas para fazer isso.  Estou usando o m√≥dulo win_chocolatey aqui.  Este √© um gerenciador de pacotes para Windows.  Sim, √© exatamente com isso que estamos t√£o acostumados no Linux.  Os m√≥dulos s√£o suportados pela comunidade e agora j√° existem mais de seis mil deles.  Eu recomendo fortemente que voc√™ tente. </p><br><pre> <code class="bash hljs">- name: SQL Server hosts: dbservers tasks: - name: Install MS SQL Server 2014 win_chocolatey: name: mssqlserver2014express state: present</code> </pre> <br><p>  Ent√£o, preparamos o host para o lan√ßamento do aplicativo, vamos implant√°-lo! </p><br><pre> <code class="plaintext hljs">- name: Deploy binaries hosts: webservers vars: myapp_artifacts: files/MyAppService.zip myapp_workdir: C:\myapp tasks: - name: Remove Service if exists win_service: name: MyAppService state: absent path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  Por precau√ß√£o, a primeira coisa que fazemos √© excluir o servi√ßo existente. </p><br><pre> <code class="plaintext hljs">- name: Delete old files win_file: path: "{{ myapp_workdir }}\\" state: absent - name: Copy artifacts to remote machine win_copy: src: "{{ myapp_artifacts }}" dest: "{{ myapp_workdir }}\\" - name: Unzip build artifacts win_unzip: src: "{{ myapp_workdir }}\\MyAppService.zip" dest: "{{ myapp_workdir }}"</code> </pre> <br><p>  A pr√≥xima etapa √© fazer upload de novos artefatos no host.  Este manual implica que ele √© executado em um servidor de constru√ß√£o, todos os arquivos est√£o em uma pasta conhecida e indicamos o caminho para eles com vari√°veis.  Ap√≥s a c√≥pia (win_copy), os arquivos s√£o descompactados (win_unzip).  Depois, basta registrar o servi√ßo, dizer o caminho para o exe e que ele deve ser iniciado. </p><br><pre> <code class="plaintext hljs"> - name: Register and start the service win_service: name: ReporterService start_mode: auto state: started path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  <strong>Feito!?</strong> </p><br><p>  Parece que nosso servi√ßo est√° pronto para o trabalho e a defesa, no entanto, existe um "mas" - n√£o observamos o princ√≠pio da idempot√™ncia.  Sempre exclu√≠mos o c√≥digo existente e, em seguida, implantamos o novo. </p><br><p>  E esse √© o problema.  Se excluirmos o servi√ßo fora de servi√ßo antigo e ap√≥s algum tipo de erro e o manual n√£o concluir seu trabalho, obteremos um host com defeito.  Ou, por exemplo, implantamos v√°rios aplicativos ao mesmo tempo, dos quais um n√£o foi alterado, e tamb√©m n√£o precisamos implant√°-lo. </p><br><p>  O que pode ser feito?  Como alternativa, voc√™ pode verificar a soma de verifica√ß√£o de nossos artefatos e compar√°-los com os do servidor. </p><br><pre> <code class="plaintext hljs"> - name: Get arifacts checksum stat: path: "{{ myapp_artifacts }}" delegate_to: localhost register: myapp_artifacts_stat - name: Get remote artifacts checksum win_stat: path: "{{ myapp_workdir }}\\MyAppService.zip" register: myapp_remote_artifacts_stat</code> </pre> <br><p>  Usamos o m√≥dulo stat, que fornece todos os tipos de informa√ß√µes sobre arquivos, incluindo a soma de verifica√ß√£o.  Em seguida, usando o registro de diretiva familiar, escrevemos o resultado em uma vari√°vel.  De interessante: delegate_to indica que isso deve ser feito na m√°quina local em que o manual √© iniciado. </p><br><pre> <code class="plaintext hljs"> - name: Stop play if checksums match meta: end_play when: - myapp_artifacts_stat.stat.checksum is defined - myapp_remote_artifacts_stat.stat.checksum is defined - myapp_artifacts_stat.stat.checksum == myapp_remote_artifacts_stat.stat.checksum</code> </pre> <br><p>  E com a ajuda do meta-m√≥dulo, dizemos que precisamos terminar o manual se as somas de verifica√ß√£o dos artefatos nas m√°quinas local e remota corresponderem.  Foi assim que observamos o princ√≠pio da idempot√™ncia. </p><br><pre> <code class="plaintext hljs"> - name: Ensure that the WebApp application exists win_iis_webapplication: name: WebApp physical_path: c:\webapp site: Default Web Site state: present</code> </pre> <br><p>  Agora, vamos olhar para o nosso aplicativo da web.  N√≥s omitimos a parte sobre copiar arquivos, vamos direto ao ponto.  Nosso servidor de cria√ß√£o criou o editor, carregou todos os arquivos soltos no host e usou o m√≥dulo interno para trabalhar com aplicativos IIS.  Ele criar√° o aplicativo e o executar√°. </p><br><p>  <strong>Reutiliza√ß√£o de c√≥digo</strong> </p><br><p>  Uma das tarefas que definimos foi: permitir que qualquer engenheiro da empresa inicie facilmente uma implanta√ß√£o.  Ele escreve seu manual a partir de m√≥dulos prontos, diz que precisa executar tal e qual produto em tal host. </p><br><p>  Para isso, o Ansible tem fun√ß√µes.  Isto √© essencialmente uma conven√ß√£o.  Criamos uma pasta / functions / no servidor e colocamos nossas fun√ß√µes nela.  Cada fun√ß√£o √© um conjunto de arquivos de configura√ß√£o: uma descri√ß√£o de nossos dispositivos, vari√°veis, arquivos de servi√ßo etc.  Geralmente, alguma entidade isolada desempenha um papel.  A instala√ß√£o do IIS √© um √≥timo exemplo se precisarmos n√£o apenas instal√°-lo, mas tamb√©m configur√°-lo de alguma forma ou verific√°-lo com tarefas adicionais.  N√≥s desempenhamos uma fun√ß√£o separada e, portanto, isolamos todos os manuais relacionados ao IIS na pasta de fun√ß√µes.  No futuro, simplesmente chamamos essa fun√ß√£o com a diretiva include_role% role_name%. </p><br><p>  Naturalmente, criamos fun√ß√µes para todos os aplicativos, deixando a oportunidade para os engenheiros de alguma forma personalizarem o processo usando par√¢metros de configura√ß√£o. </p><br><pre> <code class="plaintext hljs">- name: Run App hosts: webservers tasks: - name: "Install IIS" include_role: name: IIS - name: Run My App include_role: name: MyAppService vars: myapp_artifacts: ./buld.zip</code> </pre> <br><p>  Neste exemplo, a fun√ß√£o Executar Meu Aplicativo tem a capacidade de transferir algum caminho para artefatos. </p><br><p>  Aqui voc√™ deve colocar uma palavra sobre o Ansible Galaxy - um reposit√≥rio de solu√ß√µes padr√£o comumente dispon√≠veis.  Como de costume em uma sociedade decente, muitos problemas j√° foram resolvidos diante de n√≥s.  E se houver a sensa√ß√£o de que agora come√ßaremos a reinventar a roda, primeiro voc√™ precisar√° examinar a lista de m√≥dulos internos e depois mergulhar no Ansible Galaxy.  √â prov√°vel que o manual de que voc√™ precisa j√° tenha sido elaborado por outra pessoa.  H√° um grande n√∫mero de m√≥dulos l√°, para todas as ocasi√µes. </p><br><p>  <strong>Mais flexibilidade</strong> </p><br><p>  Mas e se n√£o houver um m√≥dulo embutido ou uma fun√ß√£o adequada no Galaxy?  Existem duas op√ß√µes: ou estamos fazendo algo errado ou temos realmente uma tarefa √∫nica. </p><br><p>  No caso da segunda op√ß√£o, sempre podemos escrever nosso m√≥dulo.  Como mostrei a voc√™ no in√≠cio, o Ansible torna poss√≠vel escrever o m√≥dulo mais simples em literalmente 10 minutos, e quando voc√™ se aprofunda, documenta√ß√£o bastante detalhada vem em seu aux√≠lio, cobrindo muitas perguntas. </p><br><p>  <strong>Ci</strong> <br>  Em nosso departamento, gostamos muito do TeamCity, mas pode haver qualquer outro servidor de CI de sua escolha.  Por que precisamos compartilh√°-los? </p><br><p>  Em primeiro lugar, sempre podemos verificar a sintaxe de nossos playbooks.  Embora o YAML considere as guias um erro de sintaxe, esse √© um recurso muito √∫til. </p><br><p>  Tamb√©m no servidor de CI, executamos o ansible-lint.  Este √© um analisador est√°tico de configura√ß√µes ansible, que fornece uma lista de recomenda√ß√µes. </p><br><p><img src="https://habrastorage.org/webt/mc/rf/ks/mcrfks9tz2igullrdgqeedqkyim.png"></p><br><p>  Por exemplo, aqui ele diz que temos um espa√ßo extra no final da linha e, para uma tarefa, nenhum nome √© dado.  Isso √© importante porque  o nome do m√≥dulo pode ocorrer v√°rias vezes no mesmo manual e todas as tarefas devem ser nomeadas. </p><br><p>  Claro, voc√™ ainda pode escrever testes para playbooks.  Podemos nos dar ao luxo de n√£o fazer isso porque  iremos implantar no ambiente de teste e nada cr√≠tico acontecer√°.  Mas se voc√™ implantar no produto, seria melhor verificar tudo.  O benef√≠cio do ansible permite testar n√£o apenas playbooks, mas tamb√©m m√≥dulos individuais.  Portanto, preste aten√ß√£o nisso. </p><br><p>  E o segundo principal motivo para usar o servidor de CI √© lan√ßar playbooks.  Este √© o mesmo bot√£o m√°gico "Fa√ßa bem", o que nos d√° o TeamCity.  Apenas criamos algumas configura√ß√µes simples para diferentes produtos, onde dizemos: ansible-playbook reporter_vm.yml -i invent√°rio.yml -vvvv e obtemos o bot√£o Implementar. </p><br><p>  Conveni√™ncia de b√¥nus: voc√™ pode criar vers√µes dependendo das vers√µes.  Assim que algo se consolida, o TeamCity inicia o processo de reimplanta√ß√£o, ap√≥s o qual s√≥ podemos olhar os logs se algo quebrar de repente. </p><br><p>  <strong>Total</strong> </p><br><ul><li>  Scripts confusos e d√≠spares do PowerShell substitu√≠dos por YAML-configs. </li><li>  Substitu√≠mos v√°rias implementa√ß√µes dos mesmos problemas por fun√ß√µes comuns que podem ser reutilizadas.  Um reposit√≥rio foi criado onde est√£o as fun√ß√µes.  Se o papel combina com voc√™, basta us√°-lo.  Se n√£o combina com voc√™, basta enviar a solicita√ß√£o de pool, e combina com voc√™ =) </li><li>  Agora voc√™ pode verificar o sucesso da implanta√ß√£o em um √∫nico local. </li><li>  Todo mundo sabe onde procurar logs. </li><li>  Os problemas de comunica√ß√£o tamb√©m foram resolvidos por meio de um reposit√≥rio comum e do TeamCity.  Todas as pessoas interessadas sabem onde est√£o os manuais e como eles funcionam. </li></ul><br><p>  PS Todos os exemplos do artigo podem ser encontrados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455604/">https://habr.com/ru/post/pt455604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455594/index.html">Microsoft Edge do CVE ao RCE no Windows 10</a></li>
<li><a href="../pt455596/index.html">DevConfX :: Management - relat√≥rios de gerentes em palavras simples</a></li>
<li><a href="../pt455598/index.html">Atualize urgentemente o Exim para 4.92 - h√° uma infec√ß√£o ativa</a></li>
<li><a href="../pt455600/index.html">Plataforma 3DEXPERIENCE ajuda a criar transporte p√∫blico do futuro</a></li>
<li><a href="../pt455602/index.html">Provocando Falhas no Navegador com Fuzzing Comportamental</a></li>
<li><a href="../pt455606/index.html">Aprendizado de m√°quina e an√°lise de dados: programa de mestrado na Escola Superior de Economia de S√£o Petersburgo</a></li>
<li><a href="../pt455608/index.html">√çndices de bitmap no Go: velocidade de pesquisa inacredit√°vel</a></li>
<li><a href="../pt455610/index.html">Lend√°rio Intel Core i7-2600K: testando Sandy Bridge em 2019 (parte 1)</a></li>
<li><a href="../pt455612/index.html">Pensamos nos personagens dos jogos e di√°logos, nos conselhos dos escritores e no exemplo dos apoiadores da teoria da Terra plana</a></li>
<li><a href="../pt455614/index.html">FFI: escrevendo em Rust em um programa PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>