<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë®üèΩ üòø üï∫üèº Sichere M√∂glichkeit zum Austausch von JWT in ASP.NET Core + SPA ü§¶üèΩ ‚¨ÜÔ∏è üë©‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A. A.  Eintrag 
 Die JWT-Authentifizierung (JSON Web Token) ist ein ziemlich einheitlicher, konsistenter Authentifizierungs- und Authentifizierungsmec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sichere M√∂glichkeit zum Austausch von JWT in ASP.NET Core + SPA</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468401/">  A. A. <h2>  Eintrag </h2><br>  Die JWT-Authentifizierung (JSON Web Token) ist ein ziemlich einheitlicher, konsistenter Authentifizierungs- und Authentifizierungsmechanismus zwischen Server und Clients.  Der Vorteil von JWT besteht darin, dass wir den Zustand weniger verwalten und gut skalieren k√∂nnen.  Es ist nicht √ºberraschend, dass die Autorisierung und Authentifizierung mit ihrer Hilfe zunehmend in modernen Webanwendungen verwendet wird. <br><a name="habracut"></a><br>  Bei der Entwicklung von Anwendungen mit JWT stellt sich h√§ufig die Frage: Wo und wie wird empfohlen, das Token zu speichern?  Wenn wir eine Webanwendung entwickeln, haben wir zwei der h√§ufigsten Optionen: <br><br><ul><li>  HTML5-Webspeicher (localStorage oder sessionStorage) <br></li><li>  Cookies <br></li></ul><br>  Wenn wir diese Methoden vergleichen, k√∂nnen wir sagen, dass beide Werte im Browser des Clients speichern, beide recht einfach zu verwenden sind und eine gemeinsame Speicherung von Schl√ºssel-Wert-Paaren darstellen.  Der Unterschied liegt in der Speicherumgebung. <br><br>  Auf den Webspeicher (localStorage / sessionStorage) kann √ºber JavaScript in derselben Dom√§ne zugegriffen werden.  Dies bedeutet, dass jeder JavaScript-Code in Ihrer Anwendung Zugriff auf Web Storage hat. Dies f√ºhrt zu einer Sicherheitsanf√§lligkeit f√ºr XSS-Angriffe (Cross-Site Scripting).  Als Speicher-Engine bietet Web Storage keine M√∂glichkeit, Ihre Daten w√§hrend der Speicherung und Freigabe zu sichern.  Wir k√∂nnen es nur f√ºr Zusatzdaten verwenden, die wir beim Aktualisieren (F5) oder Schlie√üen der Registerkarte behalten m√∂chten: Status und Seitenzahl, Filter usw. <br><br>  Token k√∂nnen auch √ºber Browser-Cookies √ºbertragen werden.  Mit dem <b>httpOnly-</b> Flag verwendete Cookies <b>sind von</b> XSS nicht betroffen.  httpOnly ist ein Flag f√ºr den Zugriff auf das Lesen, Schreiben und L√∂schen von Cookies nur auf dem Server.  Auf sie kann auf dem Client nicht √ºber JavaScript zugegriffen werden, sodass der Client nichts √ºber das Token wei√ü und die Autorisierung auf der Serverseite vollst√§ndig verarbeitet wird. <br><br>  Wir k√∂nnen auch ein <b>sicheres</b> Flag setzen, um sicherzustellen, dass Cookies nur √ºber HTTPS √ºbertragen werden.  Angesichts dieser Vorteile fiel meine Wahl auf Cookies. <br><br>  Dieser Artikel beschreibt einen Ansatz zum Implementieren der Authentifizierung und Authentifizierung mithilfe von httpOnly Secure Cookies + JSON Web Token in ASP.NET Core Web Api in Verbindung mit SPA.  Es wird die Option ber√ºcksichtigt, bei der Server und Client unterschiedlichen Ursprungs sind. <br><br><h2>  Einrichten Ihrer lokalen Entwicklungsumgebung </h2><br>  Um Client-Server-Beziehungen √ºber HTTPS korrekt zu konfigurieren und zu debuggen, empfehle ich dringend, die lokale Entwicklungsumgebung sofort so zu konfigurieren, dass sowohl der Client als auch der Server √ºber eine HTTPS-Verbindung verf√ºgen. <br><br>  Wenn Sie dies nicht sofort tun und versuchen, Beziehungen ohne HTTPS-Verbindung aufzubauen, werden in Zukunft viele Details angezeigt, ohne die sichere Cookies und zus√§tzliche Sicherheitsrichtlinien in der Produktion mit HTTPS nicht ordnungsgem√§√ü funktionieren. <br><br>  Ich werde ein Beispiel f√ºr die Konfiguration von HTTPS unter Windows 10, Server - ASP.NET Core, SPA - React zeigen. <br><br>  Sie k√∂nnen HTTPS in ASP.NET Core mithilfe des Flags " <u>F√ºr HTTPS konfigurieren"</u> beim Erstellen eines Projekts <u>konfigurieren</u> oder, falls dies beim Erstellen nicht der Fall war, die entsprechende Option in den Eigenschaften aktivieren. <br><br>  Um SPA zu konfigurieren, m√ºssen Sie das Skript auf <i>"Start"</i> √§ndern und auf <i>"HTTPS = true setzen" setzen</i> .  Mein Setup ist wie folgt: <br><br><pre><code class="bash hljs"><span class="hljs-string"><span class="hljs-string">'start'</span></span>: <span class="hljs-string"><span class="hljs-string">'set HTTPS=true&amp;&amp;rimraf ./build&amp;&amp;react-scripts start'</span></span></code> </pre> <br>  Ich empfehle Ihnen, HTTPS f√ºr die Entwicklungsumgebung in anderen Umgebungen unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://create-react-app.dev/docs/using-">create-react-app.dev/docs/using-https-in-development einzurichten</a> <br><br><h2>  Konfigurieren Sie ASP.NET Core Server </h2><br><h3>  JWT-Setup </h3><br>  In diesem Fall die h√§ufigste Implementierung von JWT aus der Dokumentation oder einem Artikel mit zus√§tzlichen Einstellungsoptionen.RequireHttpsMetadata <code>options.RequireHttpsMetadata = true;</code>  Da unsere Entwicklungsumgebung HTTPS verwendet: <br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddAuthentication(options =&gt; { options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultSignInScheme = JwtBearerDefaults.AuthenticationScheme; options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, options =&gt; { options.RequireHttpsMetadata = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; options.SaveToken = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; options.TokenValidationParameters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TokenValidationParameters { <span class="hljs-comment"><span class="hljs-comment">//  .  }; });</span></span></code> </pre> <br><h3>  Konfigurieren einer CORS-Richtlinie </h3><br>  <b>Wichtig</b> : Die CORS-Richtlinie muss <code>AllowCredentials()</code> .  Dies ist erforderlich, um eine Anforderung von <i>XMLHttpRequest.withCredentials zu erhalten</i> und Cookies an den Client zur√ºckzusenden.  Mehr dazu wird sp√§ter geschrieben.  Andere Optionen werden abh√§ngig von den Anforderungen des Projekts konfiguriert. <br><br>  Wenn sich der Server und der Client auf demselben Ursprung befinden, wird die gesamte unten stehende Konfiguration nicht ben√∂tigt. <br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddCors();</code> </pre> <br>  <i>Konfigurieren</i> <br><br><pre> <code class="java hljs">app.UseCors(x =&gt; x .WithOrigins(<span class="hljs-string"><span class="hljs-string">"https://localhost:3000"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//    SPA  .AllowCredentials() .AllowAnyMethod() .AllowAnyHeader());</span></span></code> </pre> <br><h3>  Festlegen der Cookie-Richtlinie </h3><br>  Erzwinge die Cookie-Richtlinie auf httpOnly und sicher. <br><br>  Wenn m√∂glich, setzen Sie <code>MinimumSameSitePolicy = SameSiteMode.Strict;</code>  - Dies verbessert die Cookie-Sicherheit f√ºr Anwendungstypen, die nicht auf der Verarbeitung von Ursprungsanfragen beruhen. <br><br>  <i>Konfigurieren</i> <br><br><pre> <code class="java hljs">app.UseCookiePolicy(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookiePolicyOptions { MinimumSameSitePolicy = SameSiteMode.Strict, HttpOnly = HttpOnlyPolicy.Always, Secure = CookieSecurePolicy.Always });</code> </pre> <br><h3>  Die Idee eines sicheren Token-Austauschs </h3><br>  Dieser Teil ist ein Konzept.  Wir werden zwei Dinge tun: <br><br><ol><li>  Werfen Sie ein Token mithilfe von httpOnly und sicheren Flags in eine HTTP-Anforderung. </li><li>  Empfangen und validieren Sie Clientanwendungstoken von einer HTTP-Anforderung. </li></ol><br>  Dazu brauchen wir: <br><br><ul><li>  Schreiben Sie das Token beim Anmelden in das httpOnly-Cookie und l√∂schen Sie es beim Anmelden von dort. </li><li>  Wenn Cookies ein Token enthalten, ersetzen Sie das Token im HTTP-Header jeder nachfolgenden Anforderung. </li><li>  Wenn Cookies kein Token enthalten, ist der Header leer und die Anforderung wird nicht autorisiert. </li></ul><br><h3>  Middleware </h3><br>  Die Hauptidee besteht darin, benutzerdefinierte Middleware zu implementieren, um ein Token in eine eingehende HTTP-Anforderung einzuf√ºgen.  Nach der Benutzerautorisierung speichern wir das Cookie unter einem bestimmten Schl√ºssel, zum Beispiel: <i>".AspNetCore.Application.Id"</i> .  Ich empfehle, einen Namen festzulegen, der nichts mit Autorisierung oder Token zu tun hat. In diesem Fall sieht ein Cookie mit einem Token wie eine <u>unauff√§llige</u> Systemkonstante f√ºr die AspNetCore-Anwendung aus.  Es besteht also eine h√∂here Wahrscheinlichkeit, dass der Angreifer viele Systemvariablen sieht und, ohne zu verstehen, welcher Autorisierungsmechanismus verwendet wird, weiter geht.  Nat√ºrlich, wenn er diesen Artikel nicht liest und nicht speziell auf eine solche Konstante achtet. <br><br>  Als n√§chstes m√ºssen wir dieses Token in alle nachfolgenden eingehenden HTTP-Anforderungen einf√ºgen.  Dazu schreiben wir einige Zeilen Middleware-Code.  Dies ist nichts anderes als eine HTTP-Pipeline. <br><br><img src="https://habrastorage.org/webt/7e/u-/7k/7eu-7k-3ekk6f0ite96eyh_ti7m.png"><br><br>  <i>Konfigurieren</i> <br><br><pre> <code class="java hljs">app.Use(async (context, next) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = context.Request.Cookies[<span class="hljs-string"><span class="hljs-string">".AspNetCore.Application.Id"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrEmpty(token)) context.Request.Headers.Add(<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span> + token); <span class="hljs-function"><span class="hljs-function">await </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }); app.UseAuthentication();</code> </pre> <br>  Wir k√∂nnen diese Logik auf einen separaten Middleware-Dienst √ºbertragen, um Startup.cs nicht zu verstopfen. Die Idee wird sich nicht √§ndern. <br><br>  Um den Wert in Cookies zu schreiben, m√ºssen wir der Autorisierungslogik nur die folgende Zeile hinzuf√ºgen: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) HttpContext.Response.Cookies.Append(<span class="hljs-string"><span class="hljs-string">".AspNetCore.Application.Id"</span></span>, token, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieOptions { MaxAge = TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">60</span></span>) });</code> </pre><br>  Unter Verwendung unserer Cookie-Richtlinien werden diese Cookies automatisch als httpOnly und sicher gesendet.  Sie m√ºssen ihre Richtlinien in den Cookie-Optionen nicht neu definieren. <br><br>  In CookieOptions k√∂nnen Sie MaxAge so einstellen, dass eine Lebensdauer angegeben wird.  Es ist n√ºtzlich, bei der Ausgabe des Tokens zusammen mit JWT Lifetime anzugeben, damit das Cookie nach einer Weile verschwindet.  Andere Eigenschaften von CookieOptions werden abh√§ngig von den Anforderungen des Projekts konfiguriert. <br><br>  Aus Sicherheitsgr√ºnden empfehle ich, Middleware die folgenden Header hinzuzuf√ºgen: <br><br><pre> <code class="java hljs">context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Content-Type-Options"</span></span>, <span class="hljs-string"><span class="hljs-string">"nosniff"</span></span>); context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Xss-Protection"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>); context.Response.Headers.Add(<span class="hljs-string"><span class="hljs-string">"X-Frame-Options"</span></span>, <span class="hljs-string"><span class="hljs-string">"DENY"</span></span>);</code> </pre><br><ul><li>  Der Header <b>X-Content-Type-Options</b> wird zum Schutz vor MIME-Sniffing-Schwachstellen verwendet.  Diese Sicherheitsanf√§lligkeit kann auftreten, wenn Benutzer auf einer Website Inhalte herunterladen k√∂nnen, der Benutzer jedoch einen bestimmten Dateityp als etwas anderes tarnt.  Dies kann Angreifern die M√∂glichkeit geben, standort√ºbergreifende Skriptskripte auszuf√ºhren oder eine Website zu gef√§hrden. </li><li>  Alle modernen Browser verf√ºgen √ºber integrierte XSS-Filterfunktionen, die versuchen, XSS-Schwachstellen zu erkennen, bevor die Seite uns vollst√§ndig angezeigt wird.  Standardm√§√üig sind sie im Browser aktiviert, aber der Benutzer ist m√∂glicherweise schwieriger und deaktiviert sie.  Mithilfe des <b>X-XSS-Protection-</b> Headers k√∂nnen wir den Browser anweisen, die Aktionen des Benutzers zu ignorieren und den integrierten Filter anzuwenden. </li><li>  <b>X-Frame-Options</b> teilt dem Browser mit, dass nichts angezeigt wird, wenn Ihre Site in einem HTML-Frame platziert ist.  Dies ist sehr wichtig, wenn Sie versuchen, sich vor Clickjacking-Versuchen zu sch√ºtzen. </li></ul><br>  Ich habe weit entfernt von allen Schlagzeilen beschrieben.  Es gibt viel mehr M√∂glichkeiten, um die Sicherheit von Webanwendungen zu erh√∂hen.  Ich empfehle Ihnen, sich auf die Sicherheitscheckliste aus der Ressource securityheaders.com zu konzentrieren. <br><br><h2>  SPA-Client-Setup </h2><br>  Wenn sich Client und Server an einem anderen Ursprung befinden, ist auf dem Client auch eine zus√§tzliche Konfiguration erforderlich.  Sie m√ºssen jede Anforderung mit <i>XMLHttpRequest.withCredentials umschlie√üen</i> . <br><br>  Ich habe meine Methoden wie folgt verpackt: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> axios <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"axios"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> api = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: process.env.REACT_APP_API_URL }); api.interceptors.request.use(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function"> =&gt;</span></span> requestInterceptor(request)) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestInterceptor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) =&gt;</span></span> { request.withCredentials = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> api;</code> </pre> <br>  Wir k√∂nnen unsere Anforderungskonfiguration auf jede Art und Weise <b>umbrechen.</b> Hauptsache, <b>withCredentials = true ist da</b> . <br><br>  Die Eigenschaft <i>XMLHttpRequest.withCredentials</i> bestimmt, ob dom√§nen√ºbergreifende Anforderungen mithilfe von Anmeldeinformationen wie Cookies, Autorisierungsheadern oder TLS-Zertifikaten generiert werden sollen. <br><br>  Dieses Flag wird auch verwendet, um zu bestimmen, ob in der Antwort gesendete Cookies ignoriert werden.  XMLHttpRequest von einer anderen Dom√§ne kann kein Cookie f√ºr eine eigene Dom√§ne setzen, wenn das withCredentials-Flag vor dem Erstellen dieser Anforderung nicht auf true gesetzt ist. <br><br>  Mit anderen Worten, wenn Sie dieses Attribut nicht angeben, wird unser Cookie nicht vom Browser gespeichert, d. H.  Wir k√∂nnen das Cookie nicht an den Server zur√ºcksenden, und der Server findet das gew√ºnschte Cookie mit JWT nicht und signiert das Bearer Token nicht in unserer HTTP-Pipeline. <br><br><h2>  Wof√ºr ist das alles? </h2><br>  Oben habe ich eine XSS-resistente Methode zum Austausch von Token beschrieben.  Lassen Sie uns das Ergebnis der implementierten Funktionalit√§t betrachten. <br><br>  Wenn Sie in die Entwicklertools gehen, sehen wir die <b>begehrten</b> Flags <b>nur</b> und <b>sicher</b> : <br><br><img src="https://habrastorage.org/webt/kd/qh/ek/kdqheko2bzbn4esbtkjthcuo7a8.png"><br><br>  Lassen Sie uns einen Crush-Test durchf√ºhren und versuchen, die Cookies aus dem Client herauszuholen: <br><br><img src="https://habrastorage.org/webt/fh/vp/sq/fhvpsqvupevuf1p5lubho6jt-hy.png"><br><br>  Wir beobachten '', d.h.  Auf Cookies kann nicht √ºber den Dokumentbereich zugegriffen werden, sodass sie nicht mit Skripten gelesen werden k√∂nnen. <br><br>  Wir k√∂nnen versuchen, diese Cookies mithilfe zus√§tzlicher Tools oder Erweiterungen abzurufen, aber alle Tools, die ich ausprobiert habe, haben die native Implementierung aus dem Dokumentbereich aufgerufen. <br><br><h2>  Demo-Projekt </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Startanweisungen finden Sie in README.MD</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><br></a> <br><br><h2>  UPD: Schutz gegen CSRF </h2><br><h3>  Konfigurieren Sie ASP.NET Core Server </h3><br>  <i>Middleware-Dienste</i> <br><br><div class="spoiler">  <b class="spoiler_title">XsrfProtectionMiddleware.cs</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XsrfProtectionMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly IAntiforgery _antiforgery; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly RequestDelegate _next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XsrfProtectionMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RequestDelegate next, IAntiforgery antiforgery)</span></span></span><span class="hljs-function"> </span></span>{ _next = next; _antiforgery = antiforgery; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeAsync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpContext context)</span></span></span><span class="hljs-function"> </span></span>{ context.Response.Cookies.Append( <span class="hljs-string"><span class="hljs-string">".AspNetCore.Xsrf"</span></span>, _antiforgery.GetAndStoreTokens(context).RequestToken, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CookieOptions {HttpOnly = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, Secure = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, MaxAge = TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">60</span></span>)}); <span class="hljs-function"><span class="hljs-function">await </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context)</span></span></span></span>; } }</code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">MiddlewareExtensions.cs</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MiddlewareExtensions</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseXsrfProtection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder builder, IAntiforgery antiforgery)</span></span></span><span class="hljs-function"> </span></span>=&gt; builder.UseMiddleware&lt;XsrfProtectionMiddleware&gt;(antiforgery); }</code> </pre> <br></div></div><br><br>  <i>ConfigureServices</i> <br><br><pre> <code class="java hljs">services.AddAntiforgery(options =&gt; { options.HeaderName = <span class="hljs-string"><span class="hljs-string">"x-xsrf-token"</span></span>; }); services.AddMvc();</code> </pre> <br><br>  <i>Konfigurieren</i> <br><br><pre> <code class="java hljs">app.UseAuthentication(); app.UseXsrfProtection(antiforgery);</code> </pre> <br><h3>  SPA-Einrichtung </h3><br><div class="spoiler">  <b class="spoiler_title">api.axios.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> axios <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"axios"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cookie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-cookies'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> api = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: process.env.REACT_APP_API_URL }); api.interceptors.request.use(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function"> =&gt;</span></span> requestInterceptor(request)) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestInterceptor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) =&gt;</span></span> { request.headers[<span class="hljs-string"><span class="hljs-string">'x-xsrf-token'</span></span>] = cookie.load(<span class="hljs-string"><span class="hljs-string">'.AspNetCore.Xsrf'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> api;</code> </pre> <br></div></div><br><h3>  Verwenden Sie </h3><br>  Um unsere API-Methoden zu sch√ºtzen, m√ºssen Sie das Attribut <code>[AutoValidateAntiforgeryToken]</code> f√ºr den Controller oder <code>[ValidateAntiForgeryToken]</code> f√ºr die Methode hinzuf√ºgen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468401/">https://habr.com/ru/post/de468401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468389/index.html">Artyom Galonsky, STO-B√ºro des B√ºros: ‚ÄûIch bin gegen so etwas wie einen DevOps-Ingenieur.‚Äú</a></li>
<li><a href="../de468393/index.html">Mit einem guten Mikrocontroller vergeht die Zeit schnell oder mit einem Wochenendoszilloskop</a></li>
<li><a href="../de468395/index.html">Cloud-Sicherheits√ºberwachung. Teil 2</a></li>
<li><a href="../de468397/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 477 (09/03/2019 - 09.09.2019)</a></li>
<li><a href="../de468399/index.html">C / C ++. Verwendung eingebetteter Anwendungsressourcen bei der Arbeit in GCC unter Linux</a></li>
<li><a href="../de468403/index.html">Integrierte Laufzeitsteuerung f√ºr Softwareanwendungen</a></li>
<li><a href="../de468405/index.html">Zwei Browser betreten irgendwie die Bildlaufleiste ...</a></li>
<li><a href="../de468407/index.html">5G - eine Technologie, die das Web wahrscheinlich verlangsamen wird</a></li>
<li><a href="../de468409/index.html">Servicemitarbeiter im Slack Client: On Download-Beschleunigung und Offline-Modus</a></li>
<li><a href="../de468411/index.html">Eine Geschichte √ºber das L√∂sen des Leistungsproblems von Moment.j.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>