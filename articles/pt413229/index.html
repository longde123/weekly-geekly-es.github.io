<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìà üíª üå≤ Crie o Caffe no Google Colaboratory: placa gr√°fica gratuita na nuvem üìµ üï¥Ô∏è üôçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Google Colaboratory √© um servi√ßo de nuvem lan√ßado recentemente, que visa simplificar a pesquisa em aprendizado de m√°quina e aprendizado profundo. Us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crie o Caffe no Google Colaboratory: placa gr√°fica gratuita na nuvem</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413229/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Google Colaboratory</a> √© um servi√ßo de nuvem lan√ßado recentemente, que visa simplificar a pesquisa em aprendizado de m√°quina e aprendizado profundo.  Usando o Colaboratory, voc√™ pode obter acesso remoto a uma m√°quina com uma placa de v√≠deo conectada e √© totalmente gratuito, o que simplifica bastante a vida quando voc√™ precisa treinar redes neurais profundas.  Podemos dizer que √© um an√°logo dos documentos do Google para o Jupyter Notebook. <br><br>  O Colaboratory possui o Tensorflow pr√©- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instalado</a> e quase todas as bibliotecas Python necess√°rias para o trabalho.  Se um pacote estiver faltando, ele √© facilmente instalado em qualquer lugar atrav√©s do <code>pip</code> ou <code>apt-get</code> .  Mas e se voc√™ precisar criar um projeto a partir da fonte e se conectar √† GPU?  Acontece que isso pode n√£o ser t√£o simples que eu descobri durante a constru√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSD-Caffe</a> .  Nesta publica√ß√£o, darei uma breve descri√ß√£o do Colaborat√≥rio, descreverei as dificuldades encontradas e como resolv√™-las, al√©m de fornecer alguns truques √∫teis. <br><br>  Todo o c√≥digo est√° dispon√≠vel no meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://vk.com/away.php%3Futf%3D1%26to%3D">Caderno Colaborativo</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b0/fv/v8/b0fvv8egfxlwczpdifnoyazgfng.png"></div><a name="habracut"></a><br><h2>  Brevemente sobre Colaboratory </h2><br>  Grosso modo, o Colaboratory permite executar o Jupyter Notebook em uma m√°quina remota.  Os arquivos colaborativos s√£o "laptops" .ipynb comuns e s√£o armazenados no disco do Google.  H√° tamb√©m um conjunto de fun√ß√µes que permite fazer upload de arquivos de uma m√°quina remota para o disco do Google e vice-versa.  Voc√™ tamb√©m pode compartilhar esses arquivos com outras pessoas, escrever coment√°rios sobre eles, como nos documentos do Google. <br><br>  No Colaborat√≥rio, voc√™ pode usar a GPU, ou seja, o Tesla K80.  Para fazer isso, conecte-o nas configura√ß√µes: Tempo de execu√ß√£o <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.845ex" height="2.419ex" viewBox="0 -780.1 5100 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-69" x="701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-67" x="1047" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-68" x="1527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-74" x="2104" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-61" x="2465" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="2995" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="3446" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-6F" x="3898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-77" x="4383" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> \ rightarrow </script>  Alterar o tipo de tempo de execu√ß√£o <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.845ex" height="2.419ex" viewBox="0 -780.1 5100 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-69" x="701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-67" x="1047" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-68" x="1527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-74" x="2104" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-61" x="2465" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="2995" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-72" x="3446" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-6F" x="3898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhi-2rj7BSuBnV7ObyxsHZtUmxjB7w#MJMATHI-77" x="4383" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> \ rightarrow </script>  Acelerador de hardware.  Vale ressaltar que nem sempre as GPUs est√£o dispon√≠veis e, em seguida, o Colaboratory oferecer√° iniciar a m√°quina sem ela. <br><br>  Parece que nada pode ser iniciado, exceto o pr√≥prio Jupyter Notebook, mas h√° acesso indireto ao terminal: para isso, √© necess√°rio adicionar um ponto de exclama√ß√£o na frente do comando do terminal, por exemplo <code>!mkdir images</code> .  Em geral, podemos assumir que estamos lidando com uma m√°quina comum perfeita na qual o Ubuntu 17.10 est√° instalado (no momento da escrita), mas conectado remotamente.  Daqui resulta que tudo o que pode ser feito atrav√©s do terminal (n√£o interativamente) pode ser feito nele, incluindo: <br><br><ul><li>  clonar reposit√≥rios usando <code>git clone</code> , </li><li>  carregar dados usando o <code>wget</code> (a prop√≥sito, at√© arquivos grandes s√£o carregados quase instantaneamente em um disco do Google), </li><li>  use <code>make</code> (e provavelmente <code>cmake</code> ) </li><li>  instalar ferramentas e bibliotecas usando o <code>apt-get</code> e o <code>pip</code> </li></ul><br>  Mais alguns coment√°rios sobre o Colaboratory: <br><br><ul><li>  Parece que o usu√°rio tem acesso ilimitado a todos os arquivos do sistema (qualquer comando precisa ser escrito sem o <code>sudo</code> ); </li><li>  O estado do terminal n√£o √© transferido entre equipes, mesmo que estejam na mesma c√©lula (por exemplo, <code>cd dir</code> se necess√°rio, voc√™ precisar√° escrever no in√≠cio de cada comando); </li><li>  Se voc√™ se desconectar do Colaboratory por um longo tempo, todas as altera√ß√µes na m√°quina virtual ser√£o apagadas, incluindo todos os pacotes instalados e arquivos baixados; portanto, √© recomend√°vel que a instala√ß√£o dos pacotes seja inclu√≠da no Jupyter Notebook; </li><li>  Ap√≥s 12 horas de uso cont√≠nuo, a m√°quina desliga automaticamente, mas pode ser reiniciada (em teoria, na pr√°tica, a GPU pode n√£o estar dispon√≠vel). </li></ul><br><h2>  Constru√ß√£o SSD-Caffe </h2><br>  Eu queria experimentar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Single Shot Detector (SSD)</a> , ou seja, sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o Caffe</a> no Google Colaboratory, mas, para isso, o projeto precisava ser montado a partir da fonte. <br><br>  A prop√≥sito, se qualquer vers√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Caffe</a> √© adequada para voc√™, existe uma maneira muito mais f√°cil (funciona mesmo, embora eu n√£o tenha tentado executar nada): <br><br><pre> <code class="bash hljs">!apt install caffe-cuda</code> </pre> <br>  A montagem do SSD-Caffe a partir da fonte √© uma busca bastante longa de v√°rias etapas, o que s√≥ pode ser feito com muletas. <br><br>  <b>Etapa 1: instalando depend√™ncias</b> <br><br>  Aqui devemos baixar todas as depend√™ncias do Caffe usando o <code>apt</code> .  No entanto, antes de fazer isso, voc√™ deve permitir que o <code>apt</code> download do c√≥digo fonte da depend√™ncia.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O guia de instala√ß√£o do Caffe</a> diz que isso requer uma "linha deb-src no arquivo sources.list".  Infelizmente, n√£o h√° detalhes l√°, ent√£o apenas descomentei todas as linhas <code>deb-src</code> no arquivo <code>/etc/apt/sources.list</code> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/etc/apt/sources.list'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: txt = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/etc/apt/sources.list'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(txt.replace(<span class="hljs-string"><span class="hljs-string">'# deb-src'</span></span>,<span class="hljs-string"><span class="hljs-string">'deb-src'</span></span>))</code> </pre><br>  E funcionou.  Resta apenas fazer o download das depend√™ncias: <br><br><pre> <code class="bash hljs">!apt update !apt build-dep caffe-cuda</code> </pre><br>  <b>Etapa 2: precisar de outro compilador</b> <br><br>  Aqui est√° o problema: <code>g++-7</code> , que √© o padr√£o por padr√£o, √©, por algum motivo, incompat√≠vel com o compilador <code>nvcc</code> CUDA, portanto, voc√™ deve usar outra coisa.  Eu baixei o <code>g++-5</code> e fiz dele o compilador padr√£o: <br><br><pre> <code class="bash hljs">!apt install g++-5 !update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 20 !update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 20</code> </pre><br>  <b>Etapa 3: precisa criar impulso</b> <br><br>  Se voc√™ tentar criar o Caffe nesta fase, surgir√£o problemas quando voc√™ tentar conectar o boost, porque ele foi criado por outro compilador, ent√£o voc√™ precisa fazer o download de suas fontes e tamb√©m construir usando o <code>g++-5</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais no site do boost</a> ): <br><br><pre> <code class="bash hljs">!wget https://dl.bintray.com/boostorg/release/1.67.0/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/boost_1_67_0.tar.bz2 !tar --bzip2 -xf boost_1_67_0.tar.bz2 !<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> boost_1_67_0 &amp;&amp; ./bootstrap.sh --<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-prefix=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> --with-libraries=system,filesystem,regex,thread,python --with-python-version=2.7 --with-python-root=/usr !<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> boost_1_67_0 &amp;&amp; ./b2 install</code> </pre><br>  <b>Etapa 4: Configurar Makefile</b> <br><br>  Clone Caffe com GitHub: <br><br><pre> <code class="bash hljs">!git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/weiliu89/caffe.git &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> caffe &amp;&amp; git checkout ssd</code> </pre><br>  E alteramos os campos necess√°rios no Makefile.config - alterei o caminho para CUDA, alterei a op√ß√£o BLAS, alterei a vers√£o do OpenCV para um terceiro, adicionamos uma camada Python e tamb√©m todos os caminhos para as bibliotecas instaladas, mas por algum motivo n√£o foram encontrados (tudo isso √© conveniente feito usando Python): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile.config.example'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: config = f.read() comment = [<span class="hljs-string"><span class="hljs-string">'CUDA_DIR := /usr/local/cuda'</span></span>, <span class="hljs-string"><span class="hljs-string">'BLAS := open'</span></span>] uncomment = [<span class="hljs-string"><span class="hljs-string">'# CUDA_DIR := /usr'</span></span>, <span class="hljs-string"><span class="hljs-string">'# BLAS := atlas'</span></span>, <span class="hljs-string"><span class="hljs-string">'# OPENCV_VERSION := 3'</span></span>, <span class="hljs-string"><span class="hljs-string">'# WITH_PYTHON_LAYER := 1'</span></span>] <span class="hljs-comment"><span class="hljs-comment"># replace = [('INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include', 'INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial /usr/local/lib/python2.7/dist-packages/numpy/core/include/'), ('LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib', 'LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial')] for c in uncomment: config = config.replace(c, c[2:]) for c in comment: config = config.replace(c, '# '+c) for c1,c2 in replace: config = config.replace(c1, c2) with open('caffe/Makefile.config', 'w') as f: f.write(config)</span></span></code> </pre><br>  Al√©m disso, no Makefile, eu tive que substituir todas as tags <code>-isystem</code> por <code>-I</code> : ambas s√£o respons√°veis ‚Äã‚Äãpor encontrar os cabe√ßalhos, mas s√£o processadas de maneira um pouco diferente e sem esses problemas de substitui√ß√£o j√° ocorreram quando o stdlib foi conectado ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais detalhes aqui</a> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: mfile = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(mfile.replace(<span class="hljs-string"><span class="hljs-string">'-isystem'</span></span>,<span class="hljs-string"><span class="hljs-string">'-I'</span></span>))</code> </pre><br>  <b>Etapa 5: criar</b> <br><br>  Havia uma √∫ltima muleta restante - para corrigir o <code>c++config.h</code> , caso contr√°rio, h√° problemas com os tipos nan ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais</a> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: txt = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(txt.replace(<span class="hljs-string"><span class="hljs-string">'/* #undef _GLIBCXX_USE_C99_MATH */'</span></span>, <span class="hljs-string"><span class="hljs-string">'/* #undef _GLIBCXX_USE_C99_MATH */\n#define _GLIBCXX_USE_C99_MATH 1'</span></span>))</code> </pre><br>  Agora, de fato, voc√™ pode criar o Caffe: <br><br><pre> <code class="bash hljs">!<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> caffe &amp;&amp; make -j8 &amp;&amp; make pycaffe &amp;&amp; make <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -j8 &amp;&amp; make distribute !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib &gt;&gt; /etc/ld.so.conf &amp;&amp; ldconfig !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /content/caffe/distribute/lib &gt;&gt; /etc/ld.so.conf &amp;&amp; ldconfig</code> </pre><br>  As duas √∫ltimas linhas adicionam os caminhos da biblioteca, nomeadamente boost e Caffe. <br><br>  Agora o Caffe pode ser usado (voc√™ s√≥ precisa especificar o caminho para ele no PYTHONPATH): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys caffe_path = !cd caffe/python &amp;&amp; pwd sys.path.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, caffe_path[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> caffe</code> </pre><br>  Para test√°-lo, testei o projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mobilenet-SSD</a> : o c√≥digo tamb√©m est√° no meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://vk.com/away.php%3Futf%3D1%26to%3D">Caderno de Colabora√ß√£o</a> . <br><br>  Em particular, medi o tempo de previs√£o de uma imagem e a acelera√ß√£o na GPU foi de cerca de 3,8. <br><br><h2>  B√¥nus: alguns truques √∫teis </h2><br>  H√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√≥timo tutorial</a> sobre Medium no Google Colaboratory.  Tamb√©m no pr√≥prio Colaborat√≥rio h√° arquivos com exemplos de quase tudo o que pode ser necess√°rio. <br><br>  Monte um disco do Google no sistema de arquivos de uma m√°quina virtual: <br><br><pre> <code class="bash hljs">!apt-get install -y -qq software-properties-common python-software-properties module-init-tools !add-apt-repository -y ppa:alessandro-strada/ppa 2&gt;&amp;1 &gt; /dev/null !apt-get update -qq 2&gt;&amp;1 &gt; /dev/null !apt-get -y install -qq google-drive-ocamlfuse fuse from google.colab import auth auth.authenticate_user() from oauth2client.client import GoogleCredentials creds = GoogleCredentials.get_application_default() import getpass !google-drive-ocamlfuse -headless -id={creds.client_id} -secret={creds.client_secret} &lt; /dev/null 2&gt;&amp;1 | grep URL vcode = getpass.getpass() !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> {vcode} | google-drive-ocamlfuse -headless -id={creds.client_id} -secret={creds.client_secret}</code> </pre><br>  Este c√≥digo retornar√° o link e fornecer√° uma janela de entrada.  Voc√™ precisa seguir o link, copiar o c√≥digo e inseri-lo na janela.  Por alguma raz√£o, tenho que fazer isso duas vezes.  Seguinte: <br><br><pre> <code class="bash hljs">!mkdir -p drive !google-drive-ocamlfuse drive</code> </pre><br>  Depois disso, voc√™ pode usar seu disco do Google como um diret√≥rio regular.  Al√©m disso, todas as altera√ß√µes neste diret√≥rio s√£o sincronizadas automaticamente com o Google-drive. <br><br>  Instala√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Keras</a> : <br><br><pre> <code class="python hljs">!pip install -q keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras</code> </pre><br>  Instale o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PyTorch</a> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wheel.pep425tags <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_abbr_impl, get_impl_ver, get_abi_tag platform = <span class="hljs-string"><span class="hljs-string">'{}{}-{}'</span></span>.format(get_abbr_impl(), get_impl_ver(), get_abi_tag()) accelerator = <span class="hljs-string"><span class="hljs-string">'cu80'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> path.exists(<span class="hljs-string"><span class="hljs-string">'/opt/bin/nvidia-smi'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'cpu'</span></span> !pip install -q http://download.pytorch.org/whl/{accelerator}/torch<span class="hljs-number"><span class="hljs-number">-0.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.post4-{platform}-linux_x86_64.whl torchvision <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch</code> </pre><br>  Alterar diret√≥rio de trabalho: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os os.chdir(<span class="hljs-string"><span class="hljs-string">"/path/to/wdir"</span></span>)</code> </pre><br>  Apague todas as altera√ß√µes e reinicie a m√°quina: <br><br><pre> <code class="bash hljs">!<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -9 -1</code> </pre> <br>  Fa√ßa o upload do arquivo para a m√°quina local: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.colab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> files files.download(<span class="hljs-string"><span class="hljs-string">'file.ext'</span></span>)</code> </pre><br>  Obtenha o dicion√°rio dos arquivos enviados para o disco do Google: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.colab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> files uploaded = files.upload()</code> </pre><br>  Silenciar a sa√≠da do comando do terminal (redirecionar para vari√°vel): <br><br><pre> <code class="python hljs">lines_list = !pwd</code> </pre><br>  Em geral, o Google Colaboratory oferece uma boa oportunidade para realizar o treinamento de redes neurais na nuvem.  √â verdade que isso pode n√£o ser suficiente para grades muito grandes.  Outra vantagem √© a capacidade de executar c√≥digo independentemente do sistema operacional local (o que √© bom para a reprodutibilidade) e tamb√©m trabalhar juntos no mesmo projeto.  Como uma captura, a GPU pode n√£o estar dispon√≠vel, inclusive por um longo tempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413229/">https://habr.com/ru/post/pt413229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413219/index.html">Bem-vindo ao SuperJob de controle de qualidade</a></li>
<li><a href="../pt413221/index.html">Bact√©rias sobrevivem em uma "sala limpa" durante a montagem da sonda, comendo produtos de limpeza</a></li>
<li><a href="../pt413223/index.html">Dicion√°rio Habra. Parte 1</a></li>
<li><a href="../pt413225/index.html">Semana 20 de Seguran√ßa: ataques cibern√©ticos n√£o triviais</a></li>
<li><a href="../pt413227/index.html">O que √© deus em roupas</a></li>
<li><a href="../pt413231/index.html">Introdu√ß√£o aos contratos inteligentes</a></li>
<li><a href="../pt413233/index.html">O servi√ßo uLogin envia dados de formul√°rios (correio, telefone) para um site de terceiros e fica em sil√™ncio quanto a isso</a></li>
<li><a href="../pt413235/index.html">Apostando em melhores previs√µes: nova matem√°tica das previs√µes meteorol√≥gicas</a></li>
<li><a href="../pt413237/index.html">O Facebook nega enviar aos fabricantes de dispositivos os mesmos dados que o desenvolvedor Alexander Kogan</a></li>
<li><a href="../pt413239/index.html">Como tornar um smartphone um pouco mais burro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>