<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜó üì™ üë©‚Äçüè´ Hackear una pulsera de fitness barata üí• üë©‚Äç‚ù§Ô∏è‚Äçüë® üöï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es una traducci√≥n. Art√≠culo publicado el 27 de mayo de 2018 


 Rastreador de ejercicios antes y despu√©s del desmontaje 

 Cuando llegu√© a la com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackear una pulsera de fitness barata</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413895/">  <font color="gray">Esta es una traducci√≥n.</font>  <font color="gray"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo</a> publicado el 27 de mayo de 2018</font> <br><br><img src="https://habrastorage.org/webt/4n/-9/ah/4n-9ah3fvyxx23aobpo2tvx0jg4.jpeg"><br>  <i><font color="gray">Rastreador de ejercicios antes y despu√©s del desmontaje</font></i> <br><br>  Cuando llegu√© a la compa√±√≠a actual, el primer d√≠a me dieron un conjunto de regalos.  Entre ellos estaba este brazalete con un rastreador de ejercicios.  Independientemente de su amor por el ejercicio, este es un dispositivo incre√≠blemente genial desde un punto de vista puramente t√©cnico: <br><br><ul><li>  un factor de forma realmente peque√±o (aproximadamente 15 √ó 40 mm); </li><li>  Bluetooth de baja energ√≠a (BLE); </li><li>  Pantalla OLED (96 √ó 32 p√≠xeles); </li><li>  bateria </li><li>  Carga USB </li><li>  aceler√≥metro </li><li>  motor de vibraci√≥n; </li><li>  El precio es de aproximadamente $ 10 (!). </li></ul><a name="habracut"></a><br>  En el exterior, el √∫nico identificador en el panel posterior es la etiqueta "FCC ID: 2AHFTID115".  Si lo buscas en Google, parece corresponder al dispositivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ID115</a> e incluso puedes encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">varias fotos de</a> su interior.  Mirando hacia atr√°s en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una de estas fotograf√≠as</a> , si te esfuerzas, puedes ver el nombre del circuito integrado (IC) m√°s grande: N51822.  Esto sugiere que puede haber un microcontrolador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">n√≥rdico</a> (MCU) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nRF51822</a> , un procesador ARM M0 de 32 bits con soporte BLE incorporado, que en teor√≠a es bastante f√°cil de programar para otras cosas que un brazalete deber√≠a hacer. <br><br>  Antes de desarmar el dispositivo, busqu√© en Google un poco m√°s y descubr√≠ que en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">algunas pulseras similares</a> se instala el mismo chip, y las personas lo programaron con √©xito. <br><br>  Abrir el caso no fue tan f√°cil.  La cubierta de pl√°stico negro est√° pegada al fondo gris.  Prob√© con un secador de pelo para suavizar el pegamento y pacientemente lo cort√© con un cuchillo peque√±o, tratando de no da√±ar demasiado el pl√°stico.  Despu√©s de abrir, me asegur√© de que realmente hay nRF51822.  M√°s tarde compr√© una pulsera MCU casi id√©ntica de Texas Instrument.  Tenga en cuenta que hay opciones. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2e6/0af/a75/2e60afa757e9f5859408e49d7f76e54f.jpg"></a> <br>  <i><font color="gray">nRF51822 y bol√≠grafo para escala</font></i> <br><br><h1>  Encontrar una manera de comunicarse </h1><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> dice que el chip puede ser programado / depurado usando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">interfaz de</a> dos pines ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serial Wire Debug</a> (SWD).  Si queremos establecer un canal de comunicaci√≥n con un chip, esto significa dos cosas: <br><br><ul><li>  Necesitamos un programador SWD (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Segger J-Link</a> ). </li><li>  Necesitaremos acceso a los dos pines SWD en el microcontrolador, a saber, SWDIO (datos) y SWDCLK (pulsos de reloj). </li></ul><br>  Afortunadamente, hay varios pads disponibles en el tablero.  Aunque su existencia se explica claramente por la necesidad de depuraci√≥n, prueba y verificaci√≥n, prefiero pensar que alg√∫n ingeniero genial los dej√≥ all√≠ como peque√±os obsequios para personas como nosotros.  No todos est√°n debidamente etiquetados, por lo que sugiero los siguientes c√≥digos: <br><br><img src="https://habrastorage.org/webt/fc/gd/y9/fcgdy9fj-73b3cdtcsbgdqdjovw.jpeg"><br><br><img src="https://habrastorage.org/webt/et/-t/_4/et-t_46am8apprgxc3mtkyyg0gq.jpeg"><br>  <i><font color="gray">Anverso y reverso de la placa de circuito.</font></i>  <i><font color="gray">Bol√≠grafo para escala y nombres semi-arbitrarios para almohadillas abiertas</font></i> <br><br>  Usando el mismo <a href="">microscopio USB</a> barato <a href="">,</a> tom√© varias fotos de los lados frontal y posterior de la placa e intent√© rastrear las pistas desde el microcontrolador hasta las almohadillas. <br><br><img src="https://habrastorage.org/webt/pc/oe/-h/pcoe-ha9fus65p5oenznunhxx30.jpeg"><br><br><img src="https://habrastorage.org/webt/nk/hy/ed/nkhyedqu2al7dvuxmbqs8ns9g9u.jpeg"><br>  <i><font color="gray">Pistas a los pines SWDIO y SWDCLK en la parte frontal y posterior de la placa</font></i> <br><br>  Tenga en cuenta que esta es una placa de circuito impreso de varias capas con agujeros pasantes, por lo que debe verificar las pistas en ambos lados de la placa.  A partir de estas fotos, puede rastrear las pistas desde los contactos SWDIO y SWDCLK en el chip hasta los pads IO y CLK.  Por lo tanto, nos aseguraremos de que la marca CLK en la placa corresponda a SWDCLK en la MCU, y el contacto sin etiqueta es el pin SWDIO.  Ahora puedes preparar nuestra primera tabla de mapeo: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descripci√≥n </th></tr><tr><td>  SWDIO </td><td>  IO </td><td>  Salida de datos para programar SWD </td></tr><tr><td>  SWDCLK </td><td>  CLK </td><td>  Salida de reloj para programaci√≥n SWD </td></tr></tbody></table><br><h1>  Cirug√≠a post mortem </h1><br>  Habiendo obtenido acceso a dos almohadillas SWD, sold√© cables muy delgados a ellos y a todos los dem√°s contactos disponibles. <br><br> <a href=""><img src="https://habrastorage.org/webt/hf/cm/6j/hfcm6jaswn6gf08oxc8ypaehmtu.jpeg"></a> <br><br><h1>  Parpadea un poco </h1><br>  La siguiente tarea es intentar programar el dispositivo para alguna tarea.  Para ejecutar el programa m√°s simple, debemos asegurarnos de lo siguiente: <br><br><ul><li>  Rastreamos correctamente los contactos de SWDIO / SWDCLK. </li><li>  El programador SWD se est√° ejecutando y la computadora puede emitir comandos. </li><li>  Podemos compilar el programa Arm y usar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SDK n√≥rdico</a> correctamente. </li><li>  Podemos actualizar el programa compilado en el chip. </li><li>  El chip funciona correctamente y carga nuestro programa. </li></ul><br>  En este caso, "hola, mundo" puede ser un programa que enciende y apaga el LED.  E incluso esto no es elemental, porque no hay un LED incorporado en la placa, y si agrega uno externo, a√∫n necesita averiguar a qu√© conectarlo.  Esto agrega otra dimensi√≥n al modelo espacial del problema.  De acuerdo con la falta de teorema del queso libre, acabo de conectar dos LED a los pines <code>P1</code> y <code>P2</code> con la esperanza de poder llegar a estos pads con el MCU. <br><br> <a href=""><img src="https://habrastorage.org/webt/vj/t0/ab/vjt0abxchpbfjiyq87acqsyq4n4.jpeg"></a> <br>  <i><font color="gray">Mal dia</font></i> <br><br>  Los controladores y los programas de l√≠nea de comandos para el programador J-Link SWD se encuentran en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el sitio web de Segger</a> .  Si est√° en macOS y usa Homebrew, busque la f√≥rmula de Cask en <code>caskroom/drivers/segger-jlink</code> .  La comunicaci√≥n con el programador SWD se establece desde la <code>JLinkExe</code> l√≠nea de comandos <code>JLinkExe</code> . <br><br>  Luego descargu√© el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SDK n√≥rdico nRF5</a> (estoy usando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n 12.3.0</a> ).  A partir de los ejemplos de SDK, est√° claro que necesitamos un compilador capaz de compilar programas de Arm.  As√≠ que instal√© <code>gcc-arm-embedded</code> (tambi√©n disponible en Homebrew). <br><br>  Despu√©s de examinar la documentaci√≥n del SDK y los foros de desarrolladores n√≥rdicos, descubr√≠ que sus SDK se usan con mayor frecuencia en placas de desarrollo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">como esta</a> .  El SDK est√° preconfigurado para varias variantes de dichos tableros.  Dado que estamos en contacto directo con el controlador, deber√° configurar algunos par√°metros del SDK. <br><br>  Pas√© <i>mucho</i> tiempo entendiendo el ecosistema nRF5, ¬°pero al final todav√≠a pude ejecutar el programa en un chip!  El <a href="">video</a> muestra dos LED parpadeantes.  En este punto, cre√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un repositorio de Github</a> y descargu√© un programa con un <code>Makefile</code> funcionando <code>Makefile</code> .  Uno de los principales secretos es que, de hecho, hay varias opciones para nRF51822, y en el m√≠o solo hay 16 KB de memoria.  As√≠ que a√∫n ten√≠a que <a href="">arreglar el script del enlazador</a> . <br><br><h1>  Entrada / salida digital </h1><br>  Como ya dije, la tarea con los LED parpadeantes proporcion√≥ algunas esperanzas y un m√©todo de empuje, cu√°l de los contactos de MCU conduce a <code>P1</code> y <code>P2</code> , donde est√°n conectados los LED.  La estrategia m√°s simple es conectar todas las salidas a su vez y aplicar alto y bajo voltaje a su vez.  Para mi sorpresa, ¬°ambos LED se iluminaron!  ¬°Estaba a√∫n m√°s sorprendido cuando el vibromotor comenz√≥ a funcionar! <br><br>  Entonces, el m√©todo de empuje agregado a la tabla: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descripci√≥n </th></tr><tr><td>  P0.30 </td><td>  P1 </td><td>  GPIO digital </td></tr><tr><td>  P0.00 </td><td>  P2 </td><td>  GPIO digital </td></tr><tr><td>  P0.01 </td><td>  - </td><td>  Motor de vibraci√≥n </td></tr></tbody></table><br><h1>  printf </h1><br>  La capacidad de transferir datos a una computadora es indispensable para la depuraci√≥n.  El programador J-Link admite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la transmisi√≥n en tiempo real (RTT)</a> para enviar y recibir datos desde el chip.  Para usar RTT, debe <code>#include "SEGGER_RTT.h"</code> y llamar a <code>SEGGER_RTT_WriteString()</code> .  Para recibir datos en una computadora, llame a la <code>jlinkrttlogger</code> l√≠nea de comando <code>jlinkrttlogger</code> , que se suministra con J-Link. <br><br><h1>  OLED </h1><br>  Otro desaf√≠o es hacer que OLED funcione.  El OLED m√°s com√∫n en el mercado ejecuta el controlador / controlador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ssd1306</a> y, por lo general, la comunicaci√≥n con el MCU se realiza a trav√©s de una interfaz en serie utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SPI</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">I¬≤C</a> .  Aqu√≠ hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo de Adafruit</a> . <br><br>  No encontr√© tal exhibici√≥n en ninguna de las tiendas ordinarias.  Y el tama√±o de 96 √ó 32 no es est√°ndar.  Una b√∫squeda por identificador QT1316P01A en la pantalla muestra sitios chinos como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aliexpress</a> , pero no hay documentaci√≥n excepto los nombres de las conclusiones: <br><br><img src="https://habrastorage.org/webt/jh/we/dj/jhwedjuvdabshgmklscu3wk6edi.png"><br>  <i><font color="gray">Nombre de PIN OLED con Aliexpress</font></i> <br><br>  Si la lista no miente, los contactos <code>SCL</code> , <code>SDA</code> y <code>RES#</code> nos dicen que esta es una opci√≥n I¬≤C.  Si hay pistas entre los tres pines de nRF51822 y estos tres pines de OLED, entonces daremos un paso adelante.  Volvamos al microscopio. <br><br><img src="https://habrastorage.org/webt/vw/dg/9d/vwdg9dxuopykb2umzrjt1zskvv4.jpeg"><br><br><img src="https://habrastorage.org/webt/zq/zl/ym/zqzlymrnmspwkcroh4argcj_udo.jpeg"><br>  <i><font color="gray">Pistas de contacto de datos OLED</font></i> <br><br>  Actualizamos la tabla de correspondencia: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descripci√≥n </th></tr><tr><td>  P0.21 </td><td>  - </td><td>  Salida OLED SDA </td></tr><tr><td>  P0.22 </td><td>  - </td><td>  Pin OLED SCL </td></tr><tr><td>  P0.24 </td><td>  - </td><td>  Salida OLED RES # </td></tr></tbody></table><br>  El protocolo I¬≤C es mucho m√°s avanzado que cualquier protocolo serie simple como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UART</a> .  Una de las ventajas es que admite m√∫ltiples dispositivos maestros y esclavos en el mismo bus.  Esto complica un poco las cosas: al menos necesita decirle a la MCU para qu√© comandos esclavos se emiten.  Entonces, a un nivel alto, adem√°s de los contactos f√≠sicos, tambi√©n hay una direcci√≥n "l√≥gica" de la pantalla OLED. <br><br>  Afortunadamente, un ejemplo en el SDK nRF5 es el esc√°ner I¬≤C.  √âl interroga desde todas las direcciones l√≥gicas posibles e informa si algo est√° instalado all√≠.  Mi versi√≥n modificada est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Produce el siguiente registro: <br><br> <code>$ make <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> TWI scanner. <br> TWI device detected at 0x3c.</code> <br> <br>  ¬°Buenas noticias!  Tenemos buenas razones para creer que la pantalla est√° correctamente identificada y que, de hecho, es una variante I¬≤C.  Una b√∫squeda en <code>0x3c</code> dice que <code>0x3c</code> es una direcci√≥n t√≠pica para tales dispositivos. <br><br>  Ahora estamos listos para enviar algunos p√≠xeles a la pantalla.  En este nivel, no hay abstracci√≥n a trav√©s de la biblioteca.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Consulte la</a> documentaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ssd1306</a> para ver una forma de bajo nivel de transferir datos.  El proceso consiste en una secuencia de comandos de configuraci√≥n que establecen la orientaci√≥n de la pantalla, el modo de grabaci√≥n, el tama√±o, etc.  Luego, una secuencia de bytes que se muestran en la pantalla se env√≠a a la memoria de visualizaci√≥n gr√°fica (GDDRAM). <br><br>  Para la configuraci√≥n correcta, estudi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la biblioteca ssd1306 de Adafruit</a> e intent√© emular comandos similares.  Eso es lo que tom√≥ la mayor parte del tiempo en este proyecto.  Descubrir todos los detalles result√≥ ser una tarea que consume mucho tiempo, y a√∫n as√≠ no puedo explicar algunas cosas.  Sin embargo, funciona! <br><br> <a href=""><img src="https://habrastorage.org/webt/lr/ix/r7/lrixr7dxh_7j9098jx677drocxm.jpeg"></a> <br>  <i><font color="gray">Mostrar un mapa de bits codificado</font></i> <br><br>  El c√≥digo para este ejemplo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Con esta configuraci√≥n, la pantalla se divide en 4 filas (p√°ginas) y 96 columnas.  Entonces las p√°ginas tienen 8 p√≠xeles de alto.  El primer byte enviado se ubicar√° "verticalmente" en la primera columna de la primera p√°gina.  El segundo byte ocupar√° la segunda columna, luego la tercera y as√≠ sucesivamente, hasta la columna 96, cuando <i>regrese</i> y comience desde la primera columna en la segunda p√°gina. <br><br>  Este es el comportamiento <i>esperado</i> .  Como se <a href="">muestra en el video</a> , el comportamiento <i>observado</i> es diferente: primero se rellenan las columnas impares, luego las pares, y solo luego vuelve a la segunda p√°gina. <br><br>  Pas√© mucho tiempo para comprender la raz√≥n de un comportamiento de visualizaci√≥n tan est√∫pido, y luego m√°s tiempo para configurarlo para solucionarlo.  Al final, me tragu√© mi orgullo y todav√≠a implement√© una l√≥gica de representaci√≥n tan extra√±a en el programa para terminarla. <br><br><h1>  Viaja a Arduino </h1><br>  Al profundizar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la biblioteca Adafruit ssd1306</a> para Arduino, siempre pens√© que ser√≠a bueno tener una forma de "simular" bits Arduino espec√≠ficos para probarlos en nRF51822.  Resulta que las personas mucho m√°s experimentadas tambi√©n pensaron en este tema: esto es lo que hace el incre√≠ble proyecto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sandeepmistry / arduino-nRF5</a> .  Implementa las principales bibliotecas Arduino utilizando el SDK nRF5. <br><br>  Con este proyecto, podemos abrir el IDE de Arduino, seleccionar la placa nRF5 y usar el rico ecosistema de Arduino.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bifurqu√© el proyecto</a> y agregu√© soporte para el tablero desde nuestro brazalete.  Puede seleccionarlo en el men√∫ desplegable <code>Tools &gt; Board &gt; ID115 Fitness Bracelet (nRF51822)</code> . <br><br> <a href=""><img src="https://habrastorage.org/webt/jx/ts/2h/jxts2hki_rpefinf1cjd2ms7k1w.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/50/gn/dm/50gndm8tzezp_frgdrile7la5hs.jpeg"></a> <br>  <i><font color="gray">Biblioteca Adafruit ssd1306 en su forma original (arriba) y con un parche (abajo)</font></i> <br><br>  Tambi√©n significa que ahora podemos usar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca OLED Adafruit</a> .  Para mi sorpresa y alivio, ¬°el mismo comportamiento extra√±o sucedi√≥ al completar primero columnas OLED pares e impares!  Con gusto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bifurqu√© la</a> biblioteca e implement√© el mismo truco.  En comparaci√≥n con el enfoque de bajo nivel, ahora tenemos acceso a una variedad de abstracciones geniales, como la salida de texto: <br><br> <a href=""><img src="https://habrastorage.org/webt/gd/62/xf/gd62xfqutmoq_szmosnzvpbdu1i.jpeg"></a> <br>  <i><font color="gray">El m√°s familiar "¬°Hola, mundo!"</font></i> <br><br><h1>  Entrada / salida anal√≥gica </h1><br>  Adem√°s de las se√±ales digitales de encendido / apagado, el nRF51822 tiene 10 pines para entrada anal√≥gica.  Esto es √∫til, por ejemplo, para leer la carga actual de la bater√≠a.  A juzgar por la documentaci√≥n, la lectura de contactos anal√≥gicos produce un valor de 10 bits.  Por lo tanto, si hay <code>0V</code> en la entrada, entonces leeremos <code>0</code> , y si hay <code>VCC</code> , leeremos <code>1023</code> con valores intermedios entre ellos. <br><br>  Peri√≥dicamente leo los valores de las entradas anal√≥gicas y trazo las se√±ales m√°s interesantes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/483/446/36c/48344636cddd789c9c1f86c15ffca411.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3c/3ab/38c/b3c3ab38ce708082b19a67ed9cdb30ae.png"><br>  <i><font color="gray">El efecto de sacudir la placa y cargar la bater√≠a de acuerdo con los datos de las entradas anal√≥gicas</font></i> <br><br>  Estoy convencido de que el contacto <code>P0.05</code> refiere a la carga de la bater√≠a, porque el valor aumenta y disminuye a medida que se carga y descarga.  Sospecho que el pin <code>P0.26</code> conectado a una de las salidas del aceler√≥metro, ya que se vuelve loco cuando sacude la placa.  Los contactos <code>P0.03</code> y <code>P0.04</code> tambi√©n se pueden conectar a varias salidas del aceler√≥metro, pero aqu√≠ un cierto efecto de segundo orden probablemente se superpone a la se√±al de la entrada.  Por ejemplo, en el primer gr√°fico, observe c√≥mo cambia el nivel de la bater√≠a (pin 5) cuando el aceler√≥metro necesita m√°s energ√≠a.  Este es un ejemplo de un efecto de segundo orden. <br><br>  El c√≥digo se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este boceto</a> .  Los datos de origen y el gui√≥n gr√°fico est√°n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Ahora podemos agregar varias filas a nuestra tabla de correspondencia: <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descripci√≥n </th></tr><tr><td>  P0.05 </td><td>  - </td><td>  Entrada anal√≥gica: conectada a la bater√≠a </td></tr><tr><td>  P0.26 </td><td>  - </td><td>  Entrada anal√≥gica: aceler√≥metro de un eje </td></tr><tr><td>  P0.03 </td><td>  - </td><td>  Entrada anal√≥gica: un eje del aceler√≥metro (probable) </td></tr><tr><td>  P0.04 </td><td>  - </td><td>  Entrada anal√≥gica: un eje del aceler√≥metro (probable) </td></tr></tbody></table><br><h1>  Bot√≥n </h1><br>  En el firmware original, tocar el brazalete en cierto punto enciende la pantalla.  Sosteniendo este punto comienza el cron√≥metro, si no recuerdo mal.  Este no es un bot√≥n f√≠sico, sino una especie de cosa t√°ctil capacitiva que funciona sorprendentemente bien.  Utilizando el mismo enfoque que para buscar salidas digitales, <a href="">encontr√© un lugar para conectarme a la MCU (video)</a> . <br><br>  El codigo esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqui</a> . <br><br><table><tbody><tr><th>  NRF51822 pin </th><th>  Parque infantil </th><th>  Descripci√≥n </th></tr><tr><td>  P0.10 </td><td>  - </td><td>  Entrada digital - Bot√≥n incorporado </td></tr></tbody></table><br><h1>  Bluetooth de baja energ√≠a (BLE) </h1><br>  La funcionalidad BLE en chips nRF5 se implementa a trav√©s de algo llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SoftDevice</a> .  Este es un binario precompilado con una pila BLE.  Se cose independientemente de la aplicaci√≥n.  Hay muchas versiones de SoftDevice, dependiendo de la versi√≥n del SDK y la versi√≥n del chip. <br><br>  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> proporciona una cierta matriz de dependencia (desafortunadamente, no puede ponerle un enlace directo).  Muestra con qu√© SDK vienen las diferentes versiones del chip, y qu√© versi√≥n de SoftDevice es.  En nuestro caso, el chip est√° marcado como QFAAH0, este chip tiene 256 KB de memoria flash, 16 KB de RAM y se declara la compatibilidad con SoftDevice s130. <br><br>  Mi SDK versi√≥n 12.3 ya contiene algunos ejemplos de uso de SoftDevice s130.  En comparaci√≥n con los programas anteriores que est√°n directamente conectados a microchips desde la direcci√≥n <code>0x0</code> , ahora necesita flashear SoftDevice desde la direcci√≥n <code>0x0</code> y el programa mismo desde la direcci√≥n <code>0x1b000</code> .  Despu√©s de cargar e inicializar, el archivo binario SoftDevice ir√° a esta direcci√≥n y transferir√° el control a nuestro programa.  Para ilustrar, tom√© el mismo ejemplo con LED parpadeantes, pero lo cambi√© por el firmware ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digo</a> ) de SoftDevice.  El comportamiento observado no ha cambiado, excepto que debe pre-flashear SoftDevice: <br><br> <code>$ make <br> # ... <br> $ make flash-softdevice <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> Hello, world!</code> <br> <br>  Quiz√°s la aplicaci√≥n m√°s simple para Bluetooth es convertir el dispositivo en una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">baliza</a> .  El dispositivo solo transmite su presencia.  Un ejemplo de esto est√° en el SDK llamado <code>ble_app_beacon</code> .  Se supone que SoftDevice <code>s130</code> ya <code>s130</code> . <br><br>  Aqu√≠, tambi√©n, la comunicaci√≥n de bajo nivel con el chip complica todo en comparaci√≥n con la programaci√≥n a trav√©s del SDK.  Adem√°s de ajustar el tama√±o de la RAM (este conocimiento fue dif√≠cil para m√≠ en el ejemplo con LED), se revel√≥ otro problema dif√≠cil de rastrear.  Al final result√≥ que, la pila BLE utiliza un generador de reloj para realizar tareas urgentes.  En los ejemplos de SDK, se supone un oscilador de cristal externo.  Cuando me di cuenta de esto despu√©s de miles de intentos de <code>printf</code> , cambi√© la bandera de configuraci√≥n para usar un generador de reloj sint√©tico, y el problema se resolvi√≥.  El c√≥digo fuente de la baliza est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h1>  BLE + Arduino </h1><br>  Cuando el ejemplo BLE funcion√≥ con el SDK nRF5, sabiendo las trampas con RAM y un generador, volv√≠ a mirar el entorno de Arduino.  Y de nuevo, estaba el glorioso proyecto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sandeepmistry / arduino-BLEPeripheral</a> (del mismo tipo que arduino-nRF5!), Que proporciona excelentes abstracciones en la parte superior de la configuraci√≥n interna de BLE. <br><br>  Para mi sorpresa, ni siquiera tuve que bifurcar la biblioteca.  El autor del proyecto arduino-nrf5 pas√≥ tiempo y agreg√≥ la configuraci√≥n de todos los tableros y configuraciones, por lo que ahora elegir el generador de reloj adecuado para SoftDevice se reduce a una opci√≥n simple en el men√∫ desplegable <code>Tools &gt; Low Frequency Clock &gt; Synthesized</code> .  Impresionante  R√°pidamente escrib√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo</a> con el LED verde encendido a trav√©s de Bluetooth (con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta aplicaci√≥n</a> ).  Su trabajo se <a href="">muestra en el video</a> . <br><br><h1>  Planes adicionales </h1><br>  Despu√©s de quejarse con esta tabla durante incontables horas, me pican las manos durante varias semanas para pegarla m√°s lejos en la lavadora y olvidarla por un tiempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413895/">https://habr.com/ru/post/es413895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413881/index.html">Imagen acoplable de 5,94 metros con Telegram MTProxy</a></li>
<li><a href="../es413885/index.html">Evaluaci√≥n de Cavium ThunderX2: El sue√±o del servidor Arm se hace realidad (Parte 1, Introducci√≥n)</a></li>
<li><a href="../es413889/index.html">Fecha l√≠mite perdida, o por qu√© m√°s de la mitad de las empresas no estaban listas para el RGPD</a></li>
<li><a href="../es413891/index.html">C√≥mo se organiza el Registro Estatal Unificado de Entidades Legales: un registro estatal unificado de entidades legales</a></li>
<li><a href="../es413893/index.html">Un agujero como herramienta de seguridad - 2, o c√≥mo atrapar el "cebo vivo" de APT</a></li>
<li><a href="../es413897/index.html">Unity3D ECS y sistema de trabajo</a></li>
<li><a href="../es413899/index.html">Datos personales biom√©tricos de los rusos.</a></li>
<li><a href="../es413901/index.html">Control del robot de autoequilibrio EduMip con el joystick PS4 Dualshock 4 a trav√©s de ROS</a></li>
<li><a href="../es413903/index.html">C√≥mo Cambridge Analytica convierte los clics en voces</a></li>
<li><a href="../es413907/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 256 (4 de junio - 12 de junio)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>