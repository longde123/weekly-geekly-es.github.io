<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàÇÔ∏è üëåüèº üèØ Kunci Prioritas di .NET üì∞ üßîüèº üèùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Setiap programmer yang menggunakan lebih dari satu utas dalam programnya telah mengalami sinkronisasi primitif. Dalam konteks .NET, ada banyak dari me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kunci Prioritas di .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458160/">  Setiap programmer yang menggunakan lebih dari satu utas dalam programnya telah mengalami sinkronisasi primitif.  Dalam konteks .NET, ada banyak dari mereka, saya tidak akan mencantumkannya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MSDN</a> telah melakukan ini untuk saya. <br><br>  Saya harus menggunakan banyak dari primitif ini, dan mereka dengan sempurna membantu mengatasi tugas.  Tetapi dalam artikel ini saya ingin berbicara tentang kunci biasa dalam aplikasi desktop dan bagaimana primitif baru (setidaknya untuk saya) muncul, yang dapat disebut PriorityLock. <br><a name="habracut"></a><br><h4>  Masalah </h4><br>  Ketika mengembangkan aplikasi multithreaded yang sangat, seorang manajer muncul di suatu tempat yang memproses utas yang tak terhitung jumlahnya.  Begitu juga dengan saya.  Dan manajer ini berhasil, memproses banyak permintaan dari ratusan utas.  Dan semuanya baik-baik saja dengannya, tetapi di dalam kunci biasa berfungsi. <br><br>  Dan kemudian suatu hari seorang pengguna (misalnya, saya) mengklik tombol di antarmuka aplikasi, aliran terbang ke manajer (bukan aliran UI tentu saja) dan mengharapkan untuk melihat penerimaan yang super ramah, tetapi sebaliknya, ia bertemu dengan Bibi Klava dari penerimaan klinik paling padat di klinik paling padat dengan kata-kata ‚ÄúSaya tidak peduli siapa yang mengarahkan Anda.  Saya punya 950 lebih seperti Anda.  Pergi dan dapatkan mereka.  Saya tidak peduli bagaimana Anda mengetahuinya. "  Ini adalah cara kerja kunci di .NET.  Dan semuanya tampak baik-baik saja, semuanya akan dieksekusi dengan benar, tetapi pengguna jelas tidak berencana untuk menunggu beberapa detik untuk menanggapi tindakannya. <br><br>  Di sinilah kisah memilukan berakhir dan solusi untuk masalah teknis dimulai. <br><br><h4>  Solusi </h4><br>  Setelah mempelajari primitif standar, saya tidak menemukan opsi yang cocok.  Oleh karena itu, saya memutuskan untuk menulis kunci saya, yang akan memiliki entri standar dan prioritas tinggi.  Ngomong-ngomong, setelah menulis, aku belajar nuget juga, aku tidak menemukan yang seperti itu di sana, walaupun aku mungkin mencari dengan buruk. <br><br>  Untuk menulis primitif seperti itu (atau tidak lagi primitif) saya membutuhkan operasi SemaphoreSlim, SpinWait dan Interlocked.  Di spoiler, saya mengutip versi pertama PriorityLock saya (hanya kode sinkron, tetapi itu yang paling penting), dan penjelasan untuk itu. <br><br><div class="spoiler">  <b class="spoiler_title">Teks tersembunyi</b> <div class="spoiler_text">  Dalam hal sinkronisasi, tidak ada penemuan, saat seseorang terkunci, orang lain tidak bisa masuk.  Jika prioritas tinggi telah datang, itu didorong ke depan oleh semua orang yang menunggu prioritas rendah. <br><br>  Kelas LockMgr, diusulkan untuk bekerja dengannya dalam kode Anda.  Dialah yang menjadi objek utama sinkronisasi.  Membuat objek Locker dan HighLocker, berisi semaphores, SpinWait's, penghitung yang ingin masuk ke bagian kritis, utas saat ini, dan rekursi rekursi. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LockMgr</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HighCount; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LowCount; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> Thread CurThread; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RecursionCount; <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> SemaphoreSlim Low = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SemaphoreSlim(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> SemaphoreSlim High = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SemaphoreSlim(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> SpinWait LowSpin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpinWait(); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> SpinWait HighSpin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpinWait(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Locker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HighLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HighLocker(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Locker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> high = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Locker(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, high); } }</code> </pre> <br>  Kelas Locker mengimplementasikan antarmuka IDisposable.  Untuk menerapkan rekursi saat mengambil kunci, kita mengingat Id dari stream, lalu memeriksanya.  Selanjutnya, tergantung pada prioritas, dalam hal prioritas tinggi, kami segera mengatakan bahwa kami tiba (menambah penghitung HighCount), mendapatkan semafor Tinggi, dan menunggu (jika perlu) untuk melepaskan kunci dari prioritas rendah, setelah itu kami siap untuk mendapatkan kunci.  Dalam hal prioritas rendah, semaphore rendah didapat, maka kami menunggu penyelesaian semua arus prioritas tinggi, dan, dengan mengambil semaphore tinggi sebentar, tambahkan LowCount. <br><br>  Perlu disebutkan bahwa arti dari HighCount dan LowCount berbeda, HighCount menampilkan jumlah utas prioritas yang datang ke kunci, ketika LowCount hanya berarti bahwa utas (satu tunggal) dengan prioritas rendah masuk ke kunci. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Locker</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _isHigh; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LockMgr _mgr; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Locker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LockMgr mgr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isHigh = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { _isHigh = isHigh; _mgr = mgr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mgr.CurThread == Thread.CurrentThread) { mgr.RecursionCount++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isHigh) { Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> mgr.HighCount); mgr.High.Wait(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Interlocked.CompareExchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> mgr.LowCount, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) mgr.HighSpin.SpinOnce(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mgr.Low.Wait(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Interlocked.CompareExchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> mgr.HighCount, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) mgr.LowSpin.SpinOnce(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mgr.High.Wait(); Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> mgr.LowCount); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { mgr.High.Release(); } } mgr.CurThread = Thread.CurrentThread; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_mgr.RecursionCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { _mgr.RecursionCount--; _mgr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } _mgr.RecursionCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; _mgr.CurThread = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isHigh) { _mgr.High.Release(); Interlocked.Decrement(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _mgr.HighCount); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _mgr.Low.Release(); Interlocked.Decrement(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _mgr.LowCount); } _mgr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HighLocker</span></span> : <span class="hljs-title"><span class="hljs-title">Locker</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HighLocker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LockMgr mgr</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mgr, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br></div></div><br>  Menggunakan objek kelas LockMgr sangat ringkas.  Contoh ini dengan jelas menunjukkan kemungkinan menggunakan kembali _lockMgr di dalam bagian kritis, sementara prioritas tidak lagi penting. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PriorityLock.LockMgr _lockMgr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PriorityLock.LockMgr(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LowPriority</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (_lockMgr.Lock()) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (_lockMgr.HighLock()) { <span class="hljs-comment"><span class="hljs-comment">// your code } } } public void HighPriority() { using (_lockMgr.HighLock()) { using (_lockMgr.Lock()) { // your code } } }</span></span></code> </pre><br>  Jadi saya memecahkan masalah saya.  Pemrosesan aksi pengguna mulai dilakukan dengan prioritas tinggi, tidak ada yang terluka, semua orang menang. <br><br><h4>  Sinkronisasi </h4><br>  Karena objek dari kelas SemaphoreSlim mendukung penantian asinkron, saya juga menambahkan kesempatan ini untuk diri saya sendiri.  Kode berbeda minimal dan pada akhir artikel saya akan memberikan tautan ke kode sumber. <br><br>  Penting untuk dicatat di sini bahwa Tugas tidak dilampirkan ke utas dengan cara apa pun, oleh karena itu, penggunaan kembali asinkron dari kunci tidak dapat dilaksanakan dengan cara yang serupa.  Selain itu, properti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Task.CurrentId</a> seperti yang dijelaskan oleh MSDN tidak menjamin apa pun.  Di sinilah opsi saya berakhir. <br><br>  Dalam mencari solusi, saya menemukan proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">NeoSmart.AsyncLock</a> , dalam deskripsi yang mendukung untuk menggunakan kembali kunci asinkron ditunjukkan.  Secara teknis, menggunakan kembali bekerja.  Namun sayangnya kunci itu sendiri bukan kunci.  Hati-hati jika Anda menggunakan paket ini, ketahuilah bahwa BUKAN itu berfungsi dengan benar! <br><br><h4>  Kesimpulan </h4><br>  Hasilnya adalah kelas yang mendukung operasi sinkron dengan penggunaan kembali, dan operasi asinkron tanpa menggunakan kembali.  Operasi asinkron dan sinkron dapat digunakan berdampingan, tetapi tidak dapat digunakan bersama!  Semua karena kurangnya dukungan untuk menggunakan kembali opsi asinkron. <br><br>  Saya harap saya tidak sendirian dalam masalah seperti itu dan solusi saya akan berguna bagi seseorang.  Saya memposting perpustakaan di github dan nuget. <br><br>  Ada tes di repositori yang menunjukkan kesehatan PriorityLock.  Pada bagian asinkron pengujian ini, NeoSmart.AsyncLock diuji, dan pengujian gagal. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tautan ke nuget</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tautan Github</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id458160/">https://habr.com/ru/post/id458160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id458142/index.html">Mengembangkan Breakout on Svelte</a></li>
<li><a href="../id458150/index.html">Peoptimasi mikro optimasi dalam kompiler C ++ dan C #</a></li>
<li><a href="../id458154/index.html">Kisah luar biasa tentang asal port USB yang mengubah segalanya</a></li>
<li><a href="../id458156/index.html">Benchmarking PostgreSQL dengan FreeBSD, CentOS, Ubuntu Debian, dan openSUSE</a></li>
<li><a href="../id458158/index.html">Mencari asteroid - proyek Hubble Asteroid Hunter</a></li>
<li><a href="../id458168/index.html">Juni Machine Learning dan Intelijen Berita Buatan Intisari</a></li>
<li><a href="../id458170/index.html">Perendaman dalam jaringan saraf convolutional. Bagian 5/10 - 18</a></li>
<li><a href="../id458176/index.html">Penghalang exaflops akan diatasi pada 2021</a></li>
<li><a href="../id458184/index.html">Haxe dan PHP: pengetikan statis, fungsi panah, metaprogramming, dan banyak lagi</a></li>
<li><a href="../id458186/index.html">WAL di PostgreSQL: 1. Buffer cache</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>