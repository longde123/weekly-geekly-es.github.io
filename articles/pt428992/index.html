<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçé üë®‚Äçüë¶‚Äçüë¶ üßîüèª Desvio seletivo de bloqueios em roteadores com firmware Padavan e Keenetic OS üôåüèª üé† ü§πüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um grande n√∫mero de instru√ß√µes foi publicado com v√°rias op√ß√µes para ignorar o bloqueio de recursos da Internet. Mas o t√≥pico n√£o perde relev√¢ncia. Ain...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desvio seletivo de bloqueios em roteadores com firmware Padavan e Keenetic OS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428992/"> Um grande n√∫mero de instru√ß√µes foi publicado com v√°rias op√ß√µes para ignorar o bloqueio de recursos da Internet.  Mas o t√≥pico n√£o perde relev√¢ncia.  Ainda mais frequentemente, iniciativas est√£o sendo ouvidas no n√≠vel legislativo para bloquear artigos sobre m√©todos para contornar bloqueios.  E havia rumores de que Roskomnadzor receber√° outro pacote de dinheiro dos contribuintes por bloqueios "melhores".  Usu√°rios experientes n√£o aprender√£o nada de novo ou √∫til neste artigo.  Outros, por√©m, receber√£o instru√ß√µes passo a passo prontas para o desvio seletivo simples e eficaz de bloqueios em roteadores populares com firmware Padavan e Keenetic. <br><br><img src="https://habrastorage.org/webt/is/kb/td/iskbtdxuaisqiyg3r4tsrjhj6aw.jpeg"><br><a name="habracut"></a><br><h1>  Conte√∫do </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. Introdu√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como voc√™ conseguir√° ignorar bloqueios ap√≥s a configura√ß√£o?</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Princ√≠pio de funcionamento</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando um roteador Padavan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando um roteador com o Keenetic OS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">M√©todos b√°sicos para diagnosticar erros ap√≥s a configura√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ignorar extra para filtrar consultas DNS pelo provedor</a> </li></ul><br><a name="con1"></a><h1>  1. Introdu√ß√£o </h1><br>  Eu usei a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">op√ß√£o de desvio de bloqueio</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Zolg</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">por</a> cerca de dois anos.  Muitas instru√ß√µes na rede s√£o baseadas nela.  Mina inclusive. <br><br>  Tudo estava bem, mas "o melhor √© sempre o inimigo do bem".  Em primeiro lugar, alguns novos programas tornaram-se muito "inteligentes" e resolver√£o dom√≠nios usando seus pr√≥prios m√©todos, ignorando o servidor DNS do roteador.  Isso n√£o permite que o dnsmasq no roteador adicione o endere√ßo ao ipset definido para desbloqueio e leva a um resultado l√≥gico - o recurso permanece bloqueado.  No Android 9, suporte nativo para DNS sobre TLS, ou seja,  esse m√©todo de ignorar o bloqueio para de funcionar (se o outro dispositivo n√£o tiver acessado o dnsmasq antes).  Em segundo lugar, atualizar toda a lista de dom√≠nios do antizapret gera sempre resultados imprevis√≠veis.  A lista pode incluir dom√≠nios realmente n√£o bloqueados e cuja opera√ß√£o √© importante atrav√©s do canal principal.  Voc√™ precisa estar constantemente em alerta e editar os arquivos gerados com as m√£os.  Em terceiro lugar, estou cansado de ‚Äúarrastar‚Äù uma enorme lista de dom√≠nios com dezenas de milhares de cassinos e similares, que simplesmente n√£o s√£o necess√°rios.  Com o tempo, percebi que precisava apenas de uma pequena lista espec√≠fica de recursos bloqueados. <br><br>  Ent√£o, h√° um ano eu uso um m√©todo de desbloqueio ligeiramente modificado, com o qual estou completamente satisfeito: <br><br><ul><li>  Simplicidade e facilidade de controle (ap√≥s a configura√ß√£o). </li><li>  Controle total sobre quais recursos voc√™ precisa desbloquear. </li><li>  Requisitos m√≠nimos para recursos do processador e RAM do roteador. </li><li>  Ampla cobertura de nuances ao ignorar bloqueios. </li></ul><br>  √â importante observar que minha op√ß√£o n√£o se destina ao caso em que voc√™ precisa desbloquear centenas e milhares de dom√≠nios.  Porque quando o roteador inicia, cada dom√≠nio da lista fornecida √© resolvido.  Quanto mais dom√≠nios na lista, maior a inicializa√ß√£o de muitos ipset para desbloquear. <br><br>  A base para ignorar bloqueios √© a mesma - a rede Tor.  Seu uso √© devido a dois fatores simples - gratuitamente, e a probabilidade de o Tor ser bloqueado na R√∫ssia √© quase nula, diferente de qualquer servi√ßo VPN.  Tor √© a base do narcotr√°fico na R√∫ssia, de meio a baixo.  O Locking Tor levar√° √† busca de novas ferramentas para o mercado e reduzir√° o n√≠vel de anonimato, o que implicar√° a ativa√ß√£o bem-sucedida do trabalho das ag√™ncias policiais locais.  Por fim, isso, como um v√≠rus, come√ßar√° a afetar negativamente o link superior.  Dadas as √∫ltimas not√≠cias surpreendentes sobre o relacionamento de altos funcion√°rios do governo com o tr√°fico global de drogas com a R√∫ssia, o bloqueio de Tor na R√∫ssia √© apenas um tabu, embora seja trivial.  Nem Roskomnadzor, n√£o importa quantos bilh√µes sejam alocados a esta ag√™ncia, nem um √∫nico tribunal na R√∫ssia tem permiss√£o "de cima" para bloquear Tor.  E nem surpreende nem assusta ningu√©m, mesmo que a R√∫ssia esteja simplesmente se afogando em drogas (qualquer aluno sabe o que vai fazer e, ap√≥s 30 minutos, √© realmente poss√≠vel em qualquer cidade com uma popula√ß√£o de 10 mil pessoas obter drogas livremente na pr√°tica. em qualquer quantidade - uma verdade t√£o m√° da vida).  No modo atual, a probabilidade de bloquear a rede Tor √© menor do que a probabilidade de bloquear o site do museu Hermitage. <br><br>  As instru√ß√µes fornecidas s√£o f√°ceis de adaptar para roteadores com o OpenWrt.  Al√©m disso, pequenas altera√ß√µes facilitam a substitui√ß√£o do Tor pelo OpenVPN. <br><br><a name="con11"></a><h1>  Como voc√™ conseguir√° ignorar bloqueios ap√≥s a configura√ß√£o? </h1><br>  Tudo √© muito simples.  Voc√™ tem o arquivo /opt/etc/unblock.txt - uma lista simples para desbloquear.  Voc√™ pode desbloquear um dom√≠nio, endere√ßo IP, intervalo de endere√ßos ou CIDR.  Uma linha - um elemento.  Linhas vazias s√£o permitidas e voc√™ pode usar o caractere # no in√≠cio da linha para ignorar. <br><br><div class="spoiler">  <b class="spoiler_title">Aqui est√° um exemplo do meu arquivo pessoal</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br>  Ap√≥s editar este arquivo, voc√™ simplesmente executa o comando para aplicar a nova configura√ß√£o: <br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Todos os recursos do unblock.txt s√£o desbloqueados sem a necessidade de reiniciar o roteador. <br><br><a name="con12"></a><h1>  Princ√≠pio de funcionamento </h1><br><ul><li>  A inicializa√ß√£o do roteador cria um conjunto vazio de endere√ßos IP de ipset chamado desbloquear. </li><li>  Uma regra para redirecionar todos os pacotes com destinos de desbloqueio para o servi√ßo Tor √© adicionada ao firewall. </li><li>  O servi√ßo Tor inicia no modo proxy transparente. </li><li>  O script especial unblock_ipset.sh √© iniciado, que resolve todos os dom√≠nios de unblock.txt e adiciona seus endere√ßos IP ao conjunto de desbloqueio.  Endere√ßos IP, intervalos e CIDRs desse arquivo tamb√©m s√£o adicionados ao desbloqueio. </li><li>  O Dnsmasq √© iniciado com um arquivo de configura√ß√£o adicional, unblock.dnsmasq, que indica a adi√ß√£o de endere√ßos IP de dom√≠nio de unblock.txt ao conjunto de desbloqueio ao resolver. </li><li>  O cron executa unblock_ipset.sh com uma certa frequ√™ncia para compensar parcialmente poss√≠veis casos com nuances. </li><li>  Se necess√°rio, todos os dom√≠nios de unblock.txt (e somente eles) ser√£o resolvidos por meio de dnscrypt-proxy se o provedor filtrar o DNS. </li></ul><br><a name="con2"></a><h1>  Configurando um roteador Padavan </h1><br>  Voc√™ deve ter um roteador com firmware Padavan instalado e um gerenciador de pacotes Entware j√° configurado.  No Windows, voc√™ pode usar o cliente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PuTTY</a> para conectar-se ao roteador via SSH. <br><br>  Verifique se voc√™ est√° usando o Entware, n√£o o Entware-ng herdado.  Veja o conte√∫do da pasta / opt / var / opkg-lists.  Haver√° um arquivo entware ou entware-ng.  No segundo caso, voc√™ precisa atualizar o firmware Padavan do seu roteador para a vers√£o mais recente e reinstalar o gerenciador de pacotes do Entware.  Somente ent√£o prossiga com as instru√ß√µes passo a passo. <br><br>  Como as an√°lises mostraram, surgem principalmente problemas para quem tem o Entware configurado incorretamente inicialmente (ou seja, os scripts do init.d n√£o s√£o carregados) na mem√≥ria interna do roteador.  Se voc√™ possui o Xiaomi Mi Router 3 ou 3G e n√£o tem certeza de que o Entware na mem√≥ria interna funcione corretamente (inicializa√ß√£o autom√°tica), basta configurar tudo novamente.  Tome PROMETHEUS.  Atualiza o script (1).  Atualize o c√≥digo fonte (2).  Colete e atualize o firmware mais atual (4).  Redefinir as configura√ß√µes de firmware (NVRAM e armazenamento de arquivos) - Avan√ßado&gt; Administra√ß√£o&gt; Configura√ß√µes.  Configure o acesso √† Internet no roteador e ative o SSH.  Execute no firmware PROMETHEUS&gt; Formata√ß√£o RWFS.  Escolha Avan√ßado&gt; Administra√ß√£o&gt; Configura√ß√µes&gt; Montar sistema de arquivos na se√ß√£o R / W&gt; UBIFS.  Reinicie o roteador.  Todos os scripts de inicializa√ß√£o atuais do Entware da mem√≥ria interna ser√£o registrados automaticamente e tudo funcionar√° como um rel√≥gio. <br><br>  Para testes, usei o popular Xiaomi Mi Router 3G (o Entware est√° instalado na mem√≥ria interna) com o firmware mais recente - 32a93db.  Tudo funcionar√° mesmo no lend√°rio beb√™ WT3020 AD / F / H por US $ 10. <br><br><img src="https://habrastorage.org/webt/th/kf/2k/thkf2kvtt2rhtnbxvmx0qri7dsk.jpeg"><br><br><h3>  1. Instalando o software necess√°rio no roteador </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron</code> </pre> <br>  <b>mc</b> - gerenciador de arquivos Midnight Commander.  √â necess√°rio apenas por causa do conveniente editor do mcedit.  Se voc√™ est√° acostumado a usar outro editor de texto, o mc n√£o pode ser instalado. <br>  <b>tor</b> - servi√ßo Tor. <br>  <b>tor-geoip</b> - banco de dados geo-IP para o Tor. <br>  <b>bind-dig</b> - cliente DNS (an√°logo de nslookup e host). <br>  <b>cron</b> - agendador de tarefas. <br><cut></cut><br><h3>  2. Inicialize o ipset, crie v√°rios endere√ßos IP de desbloqueio (start_script.sh) </h3><br>  Conecte os m√≥dulos necess√°rios e crie um conjunto vazio de endere√ßos com o nome <b>desbloquear</b> quando o roteador inicializar.  Para fazer isso, abra o arquivo <b>/etc/storage/start_script.sh</b> no editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/start_script.sh</code> </pre> <br>  Adicione no final: <br><br><pre> <code class="bash hljs">modprobe ip_set modprobe ip_set_hash_ip modprobe ip_set_hash_net modprobe ip_set_bitmap_ip modprobe ip_set_list_set modprobe xt_set ipset create unblock <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Para colar do buffer, use Shift + Insert, salve - F2, saia - F10. <br><br><img src="https://habrastorage.org/webt/tr/zp/cq/trzpcqqnadbonhsb0x3ebe7ltpo.png"><br><br>  Se desejar, voc√™ pode editar o arquivo start_script.sh na interface da web do roteador - "Avan√ßado"&gt; "Personaliza√ß√£o"&gt; "Scripts"&gt; "Executar antes de inicializar o roteador".  Ap√≥s a edi√ß√£o, clique em "Aplicar". <br><br><img src="https://habrastorage.org/webt/yr/aa/8q/yraa8qgcfwu-vesrp3wvvne2vui.png"><br><br><h3>  3. Configura√ß√£o do Tor </h3><br>  Exclua o conte√∫do do arquivo de configura√ß√£o do Tor: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Abra o arquivo de configura√ß√£o do Tor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs">User admin PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Se necess√°rio, substitua <b>192.168.0.1</b> pelo endere√ßo interno do seu roteador (LAN).  Breve descri√ß√£o da configura√ß√£o: <br><br><ul><li>  Excluir n√≥s de sa√≠da: R√∫ssia, Ucr√¢nia, Arm√™nia Quirguist√£o, Bielorr√∫ssia. </li><li>  Pendure um proxy transparente no endere√ßo 192.168.0.1, porta 9141. </li><li>  Negue ser um ponto de sa√≠da. </li></ul><br><h3>  4. A lista de dom√≠nios (e n√£o apenas) para ignorar o bloqueio (unblock.txt) </h3><br>  unblock.txt √© uma lista simples para desbloquear.  Voc√™ pode desbloquear um dom√≠nio, endere√ßo IP, intervalo ou CIDR.  Uma linha - um elemento.  Linhas vazias (incluindo espa√ßos e tabula√ß√µes) s√£o ignoradas.  Voc√™ pode usar o caractere # no in√≠cio de uma linha para ignor√°-lo. <br><br>  Crie o arquivo <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Cada linha pode conter um nome de dom√≠nio, endere√ßo IP, intervalo ou CIDR.  Voc√™ pode usar o caractere # para comentar nas linhas. <br><br><div class="spoiler">  <b class="spoiler_title">Aqui est√° um exemplo do meu arquivo pessoal</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Um script para preencher um conjunto de endere√ßos IP de desbloqueio de uma determinada lista de dom√≠nios (unblock_ipset.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  O script √© bastante simples, √© a ess√™ncia do seu trabalho ... Estamos aguardando a resolu√ß√£o do dom√≠nio google.com funcionar (se isso n√£o for feito, muitos desbloqueios n√£o ser√£o preenchidos quando o roteador inicializar, porque o roteador ainda estar√° em processo de inicializa√ß√£o).  Lemos as linhas no arquivo unblock.txt.  As linhas de leitura excluem automaticamente espa√ßos e guias no in√≠cio e no final.  Pule as linhas vazias.  Pule as linhas que come√ßam com o caractere #.  N√≥s estamos olhando na linha CIDR.  Se o CIDR for encontrado, adicione-o para desbloquear.  Estamos procurando um intervalo na string.  Se for encontrado, adicione-o para desbloquear.  Estamos procurando o endere√ßo IP na string.  Se o IP for encontrado, adicione-o para desbloquear.  Vamos resolver uma linha atrav√©s de dig.  Todos os endere√ßos IP do resultado s√£o adicionados ao desbloqueio. <br><br><h3>  6. Um script para gerar um arquivo de configura√ß√£o dnsmasq adicional a partir de uma determinada lista de dom√≠nios (unblock_dnsmasq.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  O script √© bastante simples, essa √© a ess√™ncia do seu trabalho ... Lemos sequencialmente as linhas de /opt/etc/unblock.txt.  As linhas de leitura excluem automaticamente espa√ßos e guias no in√≠cio e no final.  Pule as linhas vazias.  Pule as linhas que come√ßam com #.  Ignoramos as linhas que cont√™m o endere√ßo IP (IP, intervalo, CIDR), ou seja,  estamos interessados ‚Äã‚Äãapenas em strings com nomes de dom√≠nio.  No arquivo /opt/etc/unblock.dnsmasq, adicionamos linhas no formato "ipset = / domain_name / unblock".  Isso significa que, depois de determinar os endere√ßos IP de um dom√≠nio espec√≠fico, eles ser√£o adicionados automaticamente ao conjunto de desbloqueio. <br><br>  Certifique-se de executar o script para gerar o arquivo unblock.dnsmasq: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Verifique se o arquivo unblock.dnsmasq foi criado: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. O script para atualiza√ß√£o for√ßada manual do sistema ap√≥s editar a lista de dom√≠nios (unblock_update.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh restart_dhcpd sleep 3 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script para preencher automaticamente um conjunto de desbloqueio ao inicializar um roteador (S99unblock) </h3><br>  Crie o script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9. Encaminhando pacotes com destinos de desbloqueio para Tor (post_iptables_script.sh) </h3><br>  Abra o arquivo <b>/etc/storage/post_iptables_script.sh</b> no editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/post_iptables_script.sh</code> </pre> <br>  Adicione no final: <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i br0 -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> <br><img src="https://habrastorage.org/webt/af/u2/dl/afu2dld3v0nrhtjwfekvo6i-wsi.png"><br><br>  Se desejar, voc√™ pode editar o arquivo post_iptables_script.sh na interface da web do roteador - "Avan√ßado"&gt; "Personaliza√ß√£o"&gt; "Scripts"&gt; "Executar ap√≥s reiniciar as regras de firewall".  Ap√≥s a edi√ß√£o, clique em "Aplicar". <br><br><img src="https://habrastorage.org/webt/pv/be/ot/pvbeotspo0xhzrukgp3dgvu5aws.png"><br><br>  Voc√™ pode adicionar (isso √© opcional) ao mesmo arquivo para redirecionar todas as solicita√ß√µes para a porta externa 53 para si mesmo.  Isso √© necess√°rio para que os clientes na rede local n√£o usem servi√ßos DNS de terceiros.  Os pedidos passar√£o pelo servidor DNS regular. <br><br><pre> <code class="bash hljs">iptables -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 iptables -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1</code> </pre> <br>  Se necess√°rio, substitua <b>192.168.0.1</b> pelo endere√ßo interno do seu roteador (LAN). <br><br><h3>  10. Conectando um arquivo de configura√ß√£o adicional ao dnsmasq </h3><br>  Precisamos conectar o arquivo unblock.dnsmasq criado ao dnsmasq.  Para fazer isso, abra o arquivo <b>/etc/storage/dnsmasq/dnsmasq.conf</b> no editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/dnsmasq/dnsmasq.conf</code> </pre> <br>  Adicione no final: <br><br><pre> <code class="bash hljs">conf-file=/opt/etc/unblock.dnsmasq</code> </pre> <br>  Se desejar (isso √© opcional), voc√™ pode adicionar um servidor adicional para resolu√ß√£o e confiabilidade: <br><br><pre> <code class="bash hljs">server=8.8.8.8</code> </pre> <br>  Se desejar, voc√™ pode editar o arquivo dnsmasq.conf atrav√©s da interface da web do roteador - "Avan√ßado"&gt; "LAN"&gt; "Servidor DHCP"&gt; "Arquivo de configura√ß√£o do usu√°rio dnsmasq.conf".  Ap√≥s a edi√ß√£o, clique em "Aplicar". <br><br><img src="https://habrastorage.org/webt/x0/ar/4c/x0ar4cm6v9pgsluqabh74qck-s0.png"><br><br><h3>  11. Incluindo uma tarefa no cron para atualizar periodicamente o conte√∫do do conjunto de desbloqueio </h3><br>  Este √© um seguro adicional caso programas / dispositivos usem seu pr√≥prio m√©todo de resolu√ß√£o e o endere√ßo IP do dom√≠nio tenha sido alterado.  Tudo o que voc√™ precisa fazer √© executar o script unblock_ipset.sh na frequ√™ncia desejada.  Por exemplo, lan√ßaremos todos os dias √†s 6 da manh√£. <br><br>  Substitua o nome raiz por admin no arquivo de configura√ß√£o cron: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/root/admin/g'</span></span> /opt/etc/crontab</code> </pre> <br>  Abra o arquivo <b>/ opt / etc / crontab</b> no editor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br>  Adicione no final: <br><br><pre> <code class="bash hljs">00 06 * * * admin /opt/bin/unblock_ipset.sh</code> </pre> <br>  Se desejar, voc√™ pode comentar todas as outras tarefas de modelo.  Aqui est√° a apar√™ncia do seu arquivo crontab: <br><br><img src="https://habrastorage.org/webt/hf/lb/fc/hflbfcv04lpvzlrjmehoc3l51ts.png"><br><br><h3>  12. Reiniciando o roteador </h3><br>  Execute o comando: <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br>  Ap√≥s a reinicializa√ß√£o, abra o site check.torproject.org no seu navegador (ele deve ser adicionado ao arquivo unblock.txt).  Se voc√™ fez tudo corretamente, ver√° a inscri√ß√£o ‚ÄúParab√©ns.  Este navegador est√° configurado para usar o Tor. ": <br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con3"></a><h1>  Configurando um roteador com o Keenetic OS </h1><br>  Voc√™ deve ter um roteador Keenetic / Zyxel com o Entware Package Manager (OPKG) j√° configurado.  Por exemplo, aqui est√° uma lista de alguns roteadores que suportam o Entware: Keenetic II, Keenetic III, Extra, Extra II, Giga II, Giga III, Omni, Omni II, Viva, Ultra, Ultra II, Omni (KN-1410), Extra (KN -1710), Giga (KN-1010), Ultra (KN-1810), Viva (KN-1910), DSL (KN-2010), Duo (KN-2110).  As instru√ß√µes para configurar o Entware podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> (at√© 10 pontos). <br><br>  Se anteriormente (com firmware abaixo de 2.07) voc√™ j√° adicionou o suporte ao Entware, verifique se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° usando o Entware-ng desatualizado</a> . <br><br>  Certifique-se de ativar "M√≥dulos de kernel do subsistema Netfilter" - Configura√ß√µes gerais&gt; Alterar conjunto de componentes.  Se n√£o estiver na lista de dispon√≠veis, tente instalar o componente do protocolo IPv6 primeiro.  Se ap√≥s isso n√£o aparecer, tente sem ele, mas h√° uma alta probabilidade de que voc√™ n√£o consiga desbloquear por intervalo e CIDR (porque n√£o haver√° suporte para o conjunto hash: net). <br><br><img src="https://habrastorage.org/webt/vv/dh/hi/vvdhhirhcktuefrgbxh3fkx5i0i.png"><br><br>  Para testes, usei o Keenetic Ultra (KN-1810) com o firmware mais recente - 2.14.C.0.0-4. <br><br>  <u>Nota importante.</u>  <u>Voc√™ ter√° que desativar o servidor DNS regular no sistema; em vez disso, usaremos o dnsmasq.</u>  <u>Voc√™ perder√° a capacidade de atribuir servi√ßos DNS (Yandex.DNS / SkyDNS / AdGuard DNS) individualmente para clientes, mas poder√° us√°-los globalmente atrav√©s das configura√ß√µes do dnsmasq, se necess√°rio.</u> <br><br><h3>  1. Instalando o software necess√°rio no roteador </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron dnsmasq-full ipset iptables</code> </pre> <br>  <b>mc</b> - gerenciador de arquivos Midnight Commander.  √â necess√°rio apenas por causa do conveniente editor do mcedit.  Se voc√™ est√° acostumado a usar outro editor de texto, o mc n√£o pode ser instalado. <br>  <b>tor</b> - servi√ßo Tor. <br>  <b>tor-geoip</b> - banco de dados geo-IP para o Tor. <br>  <b>bind-dig</b> - cliente DNS (an√°logo de nslookup e host). <br>  <b>cron</b> - agendador de tarefas. <br>  <b>dnsmasq-full</b> - servidor DNS. <br>  <b>O ipset e o iptables</b> s√£o utilit√°rios do console do <b>ipset e do iptables</b> (eles podem j√° estar no sistema e n√£o s√£o necess√°rios, eu os adicionei por seguran√ßa). <br><br><h3>  2. Inicialize o ipset, crie v√°rios endere√ßos IP de desbloqueio (100-ipset.sh) </h3><br>  Verifique se o sistema do seu roteador suporta muitos hash: net (como se viu, nem todos os roteadores Keenetic o possuem): <br><br><pre> <code class="bash hljs">ipset create <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  Se a equipe n√£o deu nenhum erro ou mensagem, existe suporte e basta seguir as instru√ß√µes.  Caso contr√°rio (h√° um erro) no script a seguir, voc√™ precisar√° substituir <b>hash: net</b> por <b>hash: ip</b> .  Nesse caso, voc√™ perde a capacidade de desbloquear o alcance e o CIDR. <br><br>  Crie um conjunto vazio de endere√ßos chamado <b>desbloquear</b> quando o roteador inicializar.  Para fazer isso, crie o arquivo <b>/opt/etc/ndm/fs.d/100-ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 ipset create unblock hash:net -exist exit 0</span></span></code> </pre> <br>  Para colar do buffer, use Shift + Insert, salve - F2, saia - F10. <br><br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br><h3>  3. Configura√ß√£o do Tor </h3><br>  Exclua o conte√∫do do arquivo de configura√ß√£o do Tor: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Abra o arquivo de configura√ß√£o do Tor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs">User root PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  Se necess√°rio, substitua <b>192.168.0.1</b> pelo endere√ßo interno do seu roteador (LAN).  Breve descri√ß√£o da configura√ß√£o: <br><br><ul><li>  Excluir n√≥s de sa√≠da: R√∫ssia, Ucr√¢nia, Arm√™nia Quirguist√£o, Bielorr√∫ssia. </li><li>  Pendure um proxy transparente no endere√ßo 192.168.0.1, porta 9141. </li><li>  Negue ser um ponto de sa√≠da. </li></ul><br><h3>  4. A lista de dom√≠nios (e n√£o apenas) para ignorar o bloqueio (unblock.txt) </h3><br>  unblock.txt √© uma lista simples para desbloquear.  Voc√™ pode desbloquear um dom√≠nio, endere√ßo IP, intervalo ou CIDR.  Uma linha - um elemento.  Linhas vazias (incluindo espa√ßos e tabula√ß√µes) s√£o ignoradas.  Voc√™ pode usar o caractere # no in√≠cio de uma linha para ignor√°-lo. <br><br>  Crie o arquivo <b>/opt/etc/unblock.txt</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Cada linha pode conter um nome de dom√≠nio, endere√ßo IP, intervalo ou CIDR.  Voc√™ pode usar o caractere # para comentar nas linhas. <br><br><div class="spoiler">  <b class="spoiler_title">Aqui est√° um exemplo do meu arquivo pessoal</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megatfile.cc megapeer.org megapeer.ru tapochek.net tparser.org tparser.me rustorka.com uniongang.tv fast-torrent.ru ###    rezka.ag hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flibusta.is flibs.me flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me telegra.ph web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.160.0/20 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 109.239.140.0/24 67.198.55.0/24 ### 7-zip.org edem.tv 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Um script para preencher um conjunto de endere√ßos IP de desbloqueio de uma determinada lista de dom√≠nios (unblock_ipset.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  O script √© bastante simples, √© a ess√™ncia do seu trabalho ... Estamos aguardando a resolu√ß√£o do dom√≠nio google.com funcionar (se isso n√£o for feito, muitos desbloqueios n√£o ser√£o preenchidos quando o roteador inicializar, porque o roteador ainda estar√° em processo de inicializa√ß√£o).  Lemos as linhas no arquivo unblock.txt.  As linhas de leitura excluem automaticamente espa√ßos e guias no in√≠cio e no final.  Pule as linhas vazias.  Pule as linhas que come√ßam com o caractere #.  N√≥s estamos olhando na linha CIDR.  Se o CIDR for encontrado, adicione-o para desbloquear.  Estamos procurando um intervalo na string.  Se for encontrado, adicione-o para desbloquear.  Estamos procurando o endere√ßo IP na string.  Se o IP for encontrado, adicione-o para desbloquear.  Vamos resolver uma linha atrav√©s de dig.  Todos os endere√ßos IP do resultado s√£o adicionados ao desbloqueio. <br><br><h3>  6. Um script para gerar um arquivo de configura√ß√£o dnsmasq adicional a partir de uma determinada lista de dom√≠nios (unblock_dnsmasq.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  O script √© bastante simples.  Lemos sequencialmente as linhas de /opt/etc/unblock.txt.  As linhas de leitura excluem automaticamente espa√ßos e guias no in√≠cio e no final.  Pule as linhas vazias.  Pule as linhas que come√ßam com #.  Ignorar linhas que cont√™m um endere√ßo IP (IP ou CIDR), ou seja,  estamos interessados ‚Äã‚Äãapenas em strings com nomes de dom√≠nio.  No arquivo /opt/etc/unblock.dnsmasq, adicionamos linhas no formato "ipset = / domain_name / unblock".  Isso significa que, depois de determinar os endere√ßos IP de um dom√≠nio espec√≠fico, eles ser√£o adicionados automaticamente ao conjunto de desbloqueio. <br><br>  Certifique-se de executar o script para gerar o arquivo unblock.dnsmasq: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Verifique se o arquivo unblock.dnsmasq foi criado: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. O script para atualiza√ß√£o for√ßada manual do sistema ap√≥s editar a lista de dom√≠nios (unblock_update.sh) </h3><br>  Crie o script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh /opt/etc/init.d/S56dnsmasq restart /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script para preencher automaticamente um conjunto de desbloqueio ao inicializar um roteador (S99unblock) </h3><br>  Crie o script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Cole (Shift + Insert) o conte√∫do: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Conceder direitos de execu√ß√£o: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9. Encaminhando pacotes com destinos de desbloqueio para Tor (100-redirect.sh) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para fazer isso, crie o arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/etc/ndm/netfilter.d/100-redirect.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cole (Shift + Insert) o conte√∫do: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$type" == "ip6tables" ] &amp;&amp; exit 0 if [ -z "$(iptables-save 2&gt;/dev/null | grep unblock)" ]; then ipset create unblock hash:net -exist iptables -w -t nat -A PREROUTING -i br0 -p tcp -m set --match-set unblock dst -j REDIRECT --to-port 9141 fi exit 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ usou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: ip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na etapa 2 em </font><font style="vertical-align: inherit;">vez de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: net</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , substitua hash: net por hash: ip. De fato, duplicamos adicionalmente a fun√ß√£o de criar um conjunto de desbloqueio a partir de 2 etapas. Isso √© necess√°rio para seguran√ßa, se os scripts do fs.d ainda n√£o come√ßaram a ser executados e os scripts netfilter.d j√° est√£o em execu√ß√£o. N√£o h√° problema se o desbloqueio j√° tiver sido criado anteriormente, o comando ser√° simplesmente ignorado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode adicionar (isso √© opcional) ao mesmo arquivo para redirecionar todas as solicita√ß√µes para a porta externa 53 para si mesmo. Isso √© necess√°rio para que os clientes na rede local n√£o usem servi√ßos DNS de terceiros. Os pedidos passar√£o pelo servidor DNS regular. Antes da √∫ltima sa√≠da, adicione:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "udp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "tcp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se necess√°rio, substitua </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelo endere√ßo interno do seu roteador (LAN). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conceder direitos de execu√ß√£o:</font></font><br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Configurando o dnsmasq e anexando um arquivo de configura√ß√£o adicional ao dnsmasq </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exclua o conte√∫do do arquivo de configura√ß√£o dnsmasq: </font></font><br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Abra o arquivo de configura√ß√£o dnsmasq: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cole (Shift + Insert) o conte√∫do: </font></font><br><br><pre> <code class="bash hljs">user=nobody bogus-priv no-negcache clear-on-reload <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dynamic listen-address=192.168.0.1 listen-address=127.0.0.1 min-port=4096 cache-size=1536 expand-hosts <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-async conf-file=/opt/etc/unblock.dnsmasq server=8.8.8.8</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se necess√°rio, substitua </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelo endere√ßo interno do seu roteador (LAN).</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Incluindo uma tarefa no cron para atualizar periodicamente o conte√∫do do conjunto de desbloqueio </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este √© um seguro adicional caso programas / dispositivos usem seu pr√≥prio m√©todo de resolu√ß√£o e o endere√ßo IP do dom√≠nio tenha sido alterado. </font><font style="vertical-align: inherit;">Tudo o que voc√™ precisa fazer √© executar o script unblock_ipset.sh na frequ√™ncia desejada. </font><font style="vertical-align: inherit;">Por exemplo, lan√ßaremos todos os dias √†s 6 da manh√£. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abra o arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ opt / etc / crontab</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adicione no final: </font></font><br><br><pre> <code class="bash hljs">00 06 * * * root /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se desejar, voc√™ pode comentar todas as outras tarefas de modelo. </font><font style="vertical-align: inherit;">Aqui est√° a apar√™ncia do seu arquivo crontab:</font></font><br><br><img src="https://habrastorage.org/webt/le/y5/sl/ley5slcvjfvs-9odj9air9qdd8s.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12. Desabilitando o servidor DNS comum e reiniciando o roteador </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte-se √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CLI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Keenetic Router</font></a><font style="vertical-align: inherit;"> (porta 23 para Telnet e 22 para SSH se o componente ‚ÄúSSH Server‚Äù for adicionado ao sistema). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execute o comando:</font></font><br><br><pre> <code class="bash hljs">opkg dns-override system configuration save system reboot</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O servidor DNS incorporado ao firmware ser√° desativado e o dnsmasq do Entware ser√° usado. </font><font style="vertical-align: inherit;">O roteador, na inicializa√ß√£o, verifica se a pasta opt est√° montada (existe uma unidade flash USB / unidade com o Entware). </font><font style="vertical-align: inherit;">Se houver, um servidor DNS comum n√£o ser√° usado. </font><font style="vertical-align: inherit;">Caso contr√°rio, use.</font></font> I.e.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">removendo a unidade flash e reiniciando o roteador, tudo funcionar√° para voc√™, como antes (antes de configurar). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s a reinicializa√ß√£o, abra o site check.torproject.org no seu navegador (ele deve ser adicionado ao arquivo unblock.txt). </font><font style="vertical-align: inherit;">Se voc√™ fez tudo corretamente, ver√° a inscri√ß√£o ‚ÄúParab√©ns. </font><font style="vertical-align: inherit;">Este navegador est√° configurado para usar o Tor. ":</font></font><br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con31"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√©todos b√°sicos para diagnosticar erros ap√≥s a configura√ß√£o </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a verifica√ß√£o no site check.torproject.org (que deve ser adicionada ao unblock.txt) for aprovada, mas o stub do provedor continuar aberto para outros recursos (ou n√£o abrir), provavelmente o provedor ir√° interferir no tr√°fego DNS, substituindo as respostas - voc√™ Uma solu√ß√£o alternativa adicional √© necess√°ria para filtrar as consultas DNS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se ap√≥s a configura√ß√£o algo n√£o funcionar como deveria, use comandos simples para determinar a etapa do problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exiba o conte√∫do do conjunto de desbloqueio:</font></font><br><br><pre> <code class="bash hljs">ipset list unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o sistema relatar que n√£o existem conjuntos, o erro est√° na etapa 2 ou voc√™ n√£o ativou o m√≥dulo Netfilter no sistema (no caso do Keenetic). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o conjunto estiver vazio, o script unblock_ipset.sh n√£o funcionou, o que, por sua vez, deve ser iniciado pelo script de inicializa√ß√£o S99unblock. Execute esse script unblock_ipset.sh manualmente. Se o conjunto estiver cheio, o erro estar√° na etapa 8. Se o script n√£o puder ser executado (provavelmente, ele est√° aguardando a resolu√ß√£o do google.com), o erro estar√° em algum lugar do lado do servidor DNS, possivelmente na etapa 10 ou 6. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifique se h√° um redirecionamento no iptables :</font></font><br><br><pre> <code class="bash hljs">iptables-save 2&gt;/dev/null | grep unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se n√£o estiver l√°, o erro est√° na etapa 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se todos os sites n√£o funcionarem, ou seja, </font><font style="vertical-align: inherit;">O DNS n√£o funciona, o erro est√° em algum lugar no est√°gio 6 ou 10. Talvez, no est√°gio 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se todos os sites do unblock.txt n√£o funcionarem (o tempo limite for excedido), mas todos os outros funcionarem, o problema est√° no lado do Tor, erro no est√°gio 3.</font></font><br><br><br><a name="con4"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ignorar extra para filtrar consultas DNS pelo provedor </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se um provedor interferir no tr√°fego DNS, substituindo respostas por recursos bloqueados, √© muito f√°cil contornar isso. </font><font style="vertical-align: inherit;">Para isso, usaremos dnscrypt-proxy. </font><font style="vertical-align: inherit;">Se voc√™ deseja e experimenta, pode substituir facilmente o dnscrypt por stubby (DNS sobre TLS). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O dnscrypt ser√° usado apenas para dom√≠nios listados em unblock.txt. </font><font style="vertical-align: inherit;">Todas as outras consultas passar√£o por servidores DNS regulares. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ tiver certeza de que seu provedor n√£o filtra as consultas DNS, n√£o precisar√° fazer essa configura√ß√£o adicional. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ j√° deve ter configurado o desvio dos bloqueios descritos acima. </font><font style="vertical-align: inherit;">As configura√ß√µes a seguir s√£o id√™nticas para o Padavan e o Keenetic OS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instale software adicional no roteador:</font></font><br><br><pre> <code class="bash hljs">opkg update opkg install dnscrypt-proxy2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Abra o arquivo de configura√ß√£o dnscrypt-proxy: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnscrypt-proxy.toml</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Localize os par√¢metros listen_addresses, fallback_resolver, cache e altere-os: </font></font><br><br><pre> <code class="bash hljs">listen_addresses = [<span class="hljs-string"><span class="hljs-string">'127.0.0.1:9153'</span></span>] fallback_resolver = <span class="hljs-string"><span class="hljs-string">'77.88.8.8:1253'</span></span> cache = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">77.88.8.8:1253 √© o endere√ßo do servidor DNS Yandex com uma porta n√£o padr√£o. </font><font style="vertical-align: inherit;">√â um backup, caso o dnscrypt-proxy tenha algum problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execute o dnscrypt-proxy:</font></font><br><br><pre> <code class="bash hljs">/opt/etc/init.d/S09dnscrypt-proxy2 start</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verifique se o dnscrypt-proxy est√° funcionando (voc√™ deve ver uma lista de endere√ßos IP em resposta): </font></font><br><br><pre> <code class="bash hljs">dig +short google.com @localhost -p 9153</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abra o script </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_ipset.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Substitua o conte√∫do por: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost -p 9153) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost -p 9153 | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fizemos uma pequena altera√ß√£o - agora, procurar por resolver n√£o usa um servidor DNS comum, mas dnscrypt-proxy com porta 9153. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abra o script </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_dnsmasq.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Substitua o conte√∫do por: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq echo "server=/$line/127.0.0.1#9153" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fizemos uma pequena altera√ß√£o - agora, ao gerar o arquivo unblock.dnsmasq, linhas adicionais como "server = / domain_name / 127.0.0.1 # 9153" s√£o adicionadas. </font><font style="vertical-align: inherit;">Isso significa que a resolu√ß√£o de dom√≠nios da lista ocorrer√° atrav√©s do dnscrypt-proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execute unblock_update.sh:</font></font><br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Feito.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todas as configura√ß√µes complicadas est√£o por tr√°s. </font><font style="vertical-align: inherit;">Agora voc√™ editar√° a lista unblock.txt apenas se necess√°rio, adicionando ou removendo dom√≠nios ou endere√ßos IP para desbloqueio, e ativando as altera√ß√µes feitas com o comando unblock_update.sh. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATUALIZA√á√ÉO 21/01/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Muitas vezes, v√™m mensagens pessoais no artigo com perguntas t√≠picas. </font><font style="vertical-align: inherit;">Vou responder aqui o mais comum. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como disponibilizar sites da zona de dom√≠nio .onion? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em torrc adicione:</font></font><br><pre> <code class="bash hljs">VirtualAddrNetwork 10.254.0.0/16 DNSPort 127.0.0.1:9053 AutomapHostsOnResolve 1</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para acessar todos os dom√≠nios da zona da cebola, adicione ao dnsmasq.conf: </font></font><br><pre> <code class="bash hljs">server=/onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/onion/unblock</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se voc√™ n√£o deseja abrir o acesso a todos os dom√≠nios da zona da cebola, mas apenas a determinados, adicione as seguintes entradas no dnsmasq.conf: </font></font><br><pre> <code class="bash hljs">server=/rutorc6mqdinc4cz.onion/127.0.0.1<span class="hljs-comment"><span class="hljs-comment">#9053 ipset=/rutorc6mqdinc4cz.onion/unblock server=/nnmclub5toro7u65.onion/127.0.0.1#9053 ipset=/nnmclub5toro7u65.onion/unblock server=/flibustahezeous3.onion/127.0.0.1#9053 ipset=/flibustahezeous3.onion/unblock</span></span></code> </pre> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ignorar bloqueios para clientes de um servidor VPN em execu√ß√£o em um roteador? </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No torrc, substitua a linha pelo TransPort por:</font></font><br><pre> <code class="bash hljs">TransPort 0.0.0.0:9141</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adicione um redirecionamento adicional com a interface necess√°ria (INTERFACE - interface de rede VPN): </font></font><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i  -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt428992/">https://habr.com/ru/post/pt428992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt428982/index.html">Como escrever D no ARM</a></li>
<li><a href="../pt428984/index.html">Julia e retratos de fase de sistemas din√¢micos</a></li>
<li><a href="../pt428986/index.html">Confer√™ncia ThinkJava # 8 em Kharkov</a></li>
<li><a href="../pt428988/index.html">Dicas da Natureza - Nublado Night Light</a></li>
<li><a href="../pt428990/index.html">Exemplos de configura√ß√£o de UIViewControllers usando RouteComposer</a></li>
<li><a href="../pt428994/index.html">Rede no Android usando Corutin e Retrofit</a></li>
<li><a href="../pt428996/index.html">Club of Santa Cl√°usulas an√¥nimas 2018-2019 no Habrahabr</a></li>
<li><a href="../pt428998/index.html">Como usar o novo recurso experimental do Profiler no React</a></li>
<li><a href="../pt429000/index.html">Por que Bill Gates inventou o banheiro por US $ 233 bilh√µes</a></li>
<li><a href="../pt429006/index.html">China: ‚Äúoficina de montagem do mundo‚Äù n√£o √© t√£o simples quanto parece</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>