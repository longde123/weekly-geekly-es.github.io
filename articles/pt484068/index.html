<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ñ üõµ üå®Ô∏è gRPC como um protocolo de comunica√ß√£o entre servi√ßos. Relat√≥rio Yandex üêå üîò üìñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O gRPC √© uma estrutura de c√≥digo aberto para chamada de procedimento remoto. No Yandex.Market, o gRPC √© usado como uma alternativa mais conveniente ao...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>gRPC como um protocolo de comunica√ß√£o entre servi√ßos. Relat√≥rio Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/484068/"> O gRPC √© uma estrutura de c√≥digo aberto para chamada de procedimento remoto.  No Yandex.Market, o gRPC √© usado como uma alternativa mais conveniente ao REST.  Sergey Fedoseenkov, que executa o servi√ßo de desenvolvimento de ferramentas para parceiros de mercado, compartilhou sua experi√™ncia de usar o gRPC como um protocolo para criar integra√ß√µes entre os servi√ßos Java e C ++.  No relat√≥rio, voc√™ aprender√° como evitar problemas comuns se come√ßar a usar o gRPC ap√≥s o REST, como retornar erros, implementar rastreamento, depurar consultas e testar chamadas de clientes.  <a href="https://habr.com/ru/company/yandex/blog/484068">No final,</a> h√° um registro n√£o oficial do relat√≥rio. <br><br>  - Primeiro, gostaria de apresentar alguns fatos sobre o Yandex.Market, que ser√£o √∫teis como parte do relat√≥rio.  Primeiro fato: escrevemos servi√ßos em diferentes idiomas.  Isso imp√µe os requisitos do cliente para servi√ßos. <br><a name="habracut"></a><br>  E se tivermos um servi√ßo em Java, seria bom se o cliente fosse, por exemplo, tamb√©m um plus ou um pequeno. <br><br><img src="https://habrastorage.org/webt/fk/km/ek/fkkmekzj1zv6uobtlxcypvjb5bq.jpeg"><br><br>  Todos os servi√ßos que temos s√£o independentes, n√£o h√° grandes lan√ßamentos planejados para todo o mercado.  Os microsservi√ßos ser√£o lan√ßados independentemente e a compatibilidade com vers√µes anteriores √© importante para n√≥s aqui, para que o protocolo o suporte. <br><br>  O terceiro fato: temos integra√ß√£o s√≠ncrona e ass√≠ncrona.  No relat√≥rio, falarei principalmente sobre s√≠ncrono. <br><br>  O que usamos?  Agora, √© claro, a base de nossas integra√ß√µes s√£o servi√ßos REST ou semelhantes a REST que trocam XML / JSON sobre HTTP 1.1.  Tamb√©m existe XML-RPC - n√≥s o usamos principalmente na integra√ß√£o com o c√≥digo Python, ou seja, o Python possui um servidor XML-RPC embutido.  √â conveniente implement√°-lo l√°, e n√≥s o apoiamos. <br><br>  Certa vez, tivemos o CORBA.  Felizmente, n√≥s a abandonamos.  Agora principalmente REST e XML / JSON sobre HTTP. <br><br><img src="https://habrastorage.org/webt/mw/we/q6/mwweq653dwqkzn9afcvtqt3temm.jpeg"><br><br>  As integra√ß√µes s√≠ncronas t√™m problemas com os protocolos existentes.  Encontramos esses problemas e tentamos trat√°-los com o gRPC.  Quais s√£o esses problemas?  Como eu disse, quero ter clientes em diferentes idiomas.  √â aconselh√°vel que eles ainda n√£o tenham que ser escritos por n√≥s mesmos.  E, em geral, seria legal se o cliente pudesse ser s√≠ncrono e ass√≠ncrono - dependendo dos objetivos do usu√°rio do servi√ßo. <br><br>  Eu tamb√©m gostaria do protocolo que usamos para suportar a compatibilidade com vers√µes anteriores o suficiente: isso √© muito importante em vers√µes independentes paralelas.  Todos os nossos lan√ßamentos s√£o compat√≠veis com vers√µes anteriores, n√£o interrompemos o feedback.  Se voc√™ o quebrou, isso √© um bug e voc√™ s√≥ precisa corrigi-lo o mais r√°pido poss√≠vel. <br><br>  Tamb√©m √© necess√°ria uma abordagem coerente ao tratamento de erros: todos que criaram servi√ßos REST sabem que voc√™ n√£o pode apenas usar o status HTTP.  Eles geralmente n√£o permitem uma descri√ß√£o detalhada do problema, √© necess√°rio inserir alguns de seus status, seus detalhes.  Nos servi√ßos REST, todos apresentam sua pr√≥pria implementa√ß√£o desses erros, sempre que voc√™ precisa trabalhar de maneira diferente com isso.  Isso nem sempre √© conveniente. <br><br>  Eu tamb√©m gostaria de ter um gerenciamento de tempo limite no lado do cliente.  Novamente, aqueles que trabalham com HTTP entendem que, se definirmos um tempo limite no lado do cliente e ele expirar, o cliente deixar√° de aguardar a conclus√£o da solicita√ß√£o, mas o servidor n√£o saber√° nada sobre ela e continuar√° a execut√°-la.  Al√©m disso, no meio, existem v√°rios proxies que definem tempos limite globais.  E o cliente pode simplesmente n√£o saber nada sobre eles e configur√°-los nem sempre √© trivial. <br><br>  E, finalmente, o problema da documenta√ß√£o.  Nem sempre √© claro onde obter a documenta√ß√£o para recursos REST ou para alguns m√©todos, quais par√¢metros eles aceitam, qual corpo pode ser transferido e como comunicar essa documenta√ß√£o com os consumidores do servi√ßo.  √â claro que existe o Swagger, mas tamb√©m n√£o √© tudo trivial. <br><br><h3>  gRPC  Teoria </h3><br>  Eu gostaria de falar sobre a parte te√≥rica do gRPC - o que √©, quais s√£o as id√©ias.  E ent√£o vamos seguir praticando. <br><br><img src="https://habrastorage.org/webt/4t/ly/cn/4tlycnzym8eeecxp8_-j2fwedwe.jpeg"><br><br>  Em geral, o gRPC √© uma especifica√ß√£o abstrata.  Ele descreve uma RPC abstrata (chamada de procedimento remoto), ou seja, uma chamada de procedimento remoto que possui determinadas propriedades.  Agora vamos list√°-los.  A primeira propriedade √© o suporte para chamadas √∫nicas e streaming.  Ou seja, todos os servi√ßos que implementam essa especifica√ß√£o suportam ambas as op√ß√µes.  O pr√≥ximo item √© a disponibilidade de metadados, ou seja, para que, juntamente com a carga √∫til, voc√™ possa passar algum tipo de metadado - condicionalmente, cabe√ßalhos.  E - suporte para cancelar uma solicita√ß√£o e tempos limite fora da caixa. <br><br>  Ele tamb√©m pressup√µe que a descri√ß√£o das mensagens e dos pr√≥prios servi√ßos seja realizada por meio de uma determinada linguagem de defini√ß√£o de interface ou IDL.  A especifica√ß√£o tamb√©m descreve o protocolo de conex√£o por HTTP / 2, ou seja, o gRPC assume que ele funciona apenas por HTTP / 2. <br><br><img src="https://habrastorage.org/webt/e0/s9/5n/e0s95ncgptmoczazqnei0yns3b4.jpeg"><br><br>  Existe uma implementa√ß√£o t√≠pica de gRPC usada na maioria dos casos.  Tamb√©m o usamos e agora vamos v√™-lo.  O formato proto √© usado como IDL.  O plug-in gRPC para o compilador proto permite que voc√™ obtenha as fontes dos servi√ßos gerados a partir da descri√ß√£o do proto.  E existem bibliotecas de tempo de execu√ß√£o em diferentes linguagens - Java, C ++, Python.  Em geral, quase todos os idiomas populares s√£o suportados, existem bibliotecas de tempo de execu√ß√£o para eles.  E como as mensagens trocadas entre os servi√ßos, uma mensagem proto √© usada, mensagens estilizadas de acordo com o esquema protobuf. <br><br><img src="https://habrastorage.org/webt/wy/zp/bh/wyzpbhu3uhozqntsux32nyvpejw.jpeg"><br><br>  Quero mergulhar um pouco em alguns recursos espec√≠ficos.  Aqui est√£o eles.  Digita√ß√£o forte, ou seja, uma mensagem proto, √© uma mensagem fortemente digitada.  Aqueles que trabalharam com o protobuf sabem que l√° voc√™ pode descrever os campos em sua mensagem com tipos.  Existem tipos primitivos e string, matrizes de bytes.  Eles podem ser escalares, podem ser vetoriais.  E, de fato, as mensagens podem, como um campo, conter outras mensagens, o que √© bastante conveniente, em geral, qualquer modelo pode ser representado. <br><br><img src="https://habrastorage.org/webt/29/oz/e6/29oze6gv_s9vazqemxztvqyrrbs.jpeg"><br><br>  Sobre compatibilidade com vers√µes anteriores.  Gostaria de observar que o proto IDL √© um formato no qual a compatibilidade com vers√µes anteriores √© disponibilizada, ou seja, foi concebida com uma reserva de compatibilidade com vers√µes anteriores, e o Google lan√ßou uma vers√£o do proto3 que, em compara√ß√£o com o proto2, melhora ainda mais a compatibilidade com vers√µes anteriores.  Al√©m disso, existem todos os tipos de especifica√ß√µes, como e o que pode ser alterado para que a compatibilidade com vers√µes anteriores seja preservada em alguns casos n√£o triviais. <br><br>  Existe a possibilidade de valores padr√£o, voc√™ pode adicionar novos campos e o consumidor n√£o precisa alterar nada.  Todos os campos no proto3 s√£o opcionais e, por exemplo, podem ser exclu√≠dos e o acesso ao campo remoto n√£o causa erros no cliente. <br><br><img src="https://habrastorage.org/webt/dl/ws/kh/dlwskhpcodspqbqkwe-q1ihxaas.jpeg"><br><br>  Outro recurso do gRPC √© que o cliente e o servidor s√£o gerados usando o compilador proto e o plug-in gRPC com base na descri√ß√£o do proto.  H√° uma possibilidade no momento em que o c√≥digo est√° sendo gravado para escolher qual cliente ser√° usado.  Ou seja, escolha um cliente ass√≠ncrono ou s√≠ncrono, dependendo do tipo de c√≥digo que voc√™ escreve.  Por exemplo, um cliente ass√≠ncrono √© muito adequado para c√≥digo reativo.  E essa oportunidade √© para qualquer idioma.  Ou seja, depois de escrever uma proto-descri√ß√£o, voc√™ poder√° gerar um cliente para qualquer idioma e n√£o precisar√° desenvolv√™-los separadamente de alguma forma.  Voc√™ pode distribuir a interface para o seu servi√ßo simplesmente como uma proto-descri√ß√£o.  Qualquer consumidor pode gerar um cliente para si mesmo. <br><br><img src="https://habrastorage.org/webt/ny/at/qr/nyatqr7l4jcnnxrzwudubg0u_wc.jpeg"><br><br>  Sobre o cancelamento da solicita√ß√£o e os prazos, gostaria de observar que a solicita√ß√£o pode ser cancelada no servidor e no cliente.  Se entendermos tudo, n√£o precisamos atender mais √† solicita√ß√£o, ent√£o podemos cancel√°-la.  √â poss√≠vel definir um tempo limite a pedido.  No gRPC, a maioria das bibliotecas de tempo de execu√ß√£o usa um prazo como conceito de tempo limite.  Mas, de fato, √© o mesmo.  Ou seja, √© o momento em que a solicita√ß√£o deve ser conclu√≠da. <br><br>  E o mais interessante √© que o servidor pode descobrir o cancelamento da solicita√ß√£o e a expira√ß√£o do tempo limite e parar de executar a solicita√ß√£o de lado.  Isso √© muito legal, parece-me que n√£o h√° muito mais. <br><br>  Sobre a documenta√ß√£o, gostaria de observar que, como o formato proto √© usado no IDL para gRPC, esse √© um c√≥digo comum.  L√° voc√™ pode escrever coment√°rios, incluindo os muito detalhados.  E voc√™ precisa entender que, para integrar-se ao seu servi√ßo, seus usu√°rios precisam ter esse proto-formato em sua casa, e eles os receber√£o juntamente com os coment√°rios, eles n√£o estar√£o em outro lugar.  √â muito conveniente  E voc√™ pode expandir essa descri√ß√£o, ou seja, √© um recurso t√£o conveniente que a documenta√ß√£o vem ao lado do c√≥digo, assim como pode estar ao lado de m√©todos na forma de javadoc ou qualquer outro coment√°rio. <br><br><h3>  chamada un√°ria de gRPC.  Pr√°tica </h3><br>  Vamos seguir em frente, veja um pouco de pr√°tica.  E o exemplo mais b√°sico de uso do gRPC √© a chamada chamada un√°ria ou chamada √∫nica.  Este √© um esquema cl√°ssico - enviamos uma solicita√ß√£o ao servidor e obtemos uma resposta do servidor.  Parece que isso funciona em HTTP. <br><br><img src="https://habrastorage.org/webt/dd/lh/kd/ddlhkdqueihh4_s65obi4t9qxns.jpeg"><br><br>  Considere o exemplo do servi√ßo de eco que prestamos.  O servidor ser√° gravado em vantagens, o cliente em Java.  O circuito de balanceamento cl√°ssico foi usado aqui.  Ou seja, o cliente endere√ßa o balanceador e, em seguida, o balanceador j√° seleciona um back-end espec√≠fico para processar a solicita√ß√£o. <br><br>  Eu queria prestar aten√ß√£o - como o gRPC funciona em HTTP / 2, uma conex√£o TCP √© usada.  Al√©m disso, v√°rios fluxos passam por ele.  Aqui voc√™ pode ver que a conex√£o entre o cliente e o balanceador √© estabelecida uma vez e permanece persistente e, em seguida, o balanceador equilibra a carga em back-end diferentes para cada chamada.  Se voc√™ olhar, acontece assim e assim se as mensagens forem distribu√≠das. <br><br><img src="https://habrastorage.org/webt/yc/tn/fe/yctnfe9-06tb1-en3lvbxlmqbsu.jpeg"><br><br>  Aqui est√° um c√≥digo de amostra para o nosso arquivo proto.  Voc√™ pode perceber que primeiro descrevemos a mensagem, ou seja, temos o EchoRequest e o EchoResponse.  Ele possui apenas um campo de sequ√™ncia que armazena a mensagem. <br><br>  A segunda etapa, descrevemos nosso procedimento.  O procedimento de entrada aceita EchoRequest, retorna EchoResponse como resultado, tudo √© bastante trivial.  Esta √© a descri√ß√£o do servi√ßo gRPC e das mensagens que ser√£o perseguidas. <br><br><br><img src="https://habrastorage.org/webt/yo/ti/mi/yotimiyugzrzit8vy2xdfn-yely.jpeg"><br><br>  Vamos ver como isso est√° indo no caso de vantagens, por exemplo.  √â montado em tr√™s etapas.  No primeiro est√°gio, nossa tarefa √© gerar fontes de mensagens.  Com essa equipe, estamos fazendo isso.  Chamamos o proto-compilador, passamos o arquivo-proto para a entrada, indicamos onde colocar os arquivos de sa√≠da. <br><br>  A segunda equipe.  Tamb√©m geramos servi√ßos da mesma maneira.  A √∫nica diferen√ßa com o comando anterior √© que passamos o plug-in e, com base na descri√ß√£o, que est√° no formato proto, gera servi√ßos. <br><br>  A terceira etapa - coletamos tudo isso em um bin√°rio para que nosso servidor possa ser iniciado. <br><br>  Um sinalizador adicional √© passado para o vinculador, chamado grpc ++ _ reflection.  Quero observar - o servidor gRPC tem esse recurso, reflex√£o do servidor.  Permite explorar que tipo de servi√ßos, chamadas RPC e mensagens que o servi√ßo possui.  Por padr√£o, est√° desativado e voc√™ pode acessar o servi√ßo apenas se tiver um proto-formato em m√£os.  Mas, por exemplo, para depura√ß√£o, √© muito conveniente, sem o proto-formato dispon√≠vel, basta ligar o servidor com o recurso de reflex√£o e receber informa√ß√µes imediatamente. <br><br><br><img src="https://habrastorage.org/webt/yl/h-/fw/ylh-fw1j3sykaipf5_4c3zvvhgi.jpeg"><br><br>  Agora vamos ver a implementa√ß√£o.  A implementa√ß√£o tamb√©m √© minimalista.  Ou seja, nossa principal tarefa √© implementar o servi√ßo de eco gerado.  Ele tem um m√©todo getEcho.  Ele apenas gera mensagens e as envia de volta.  Status OK - status de sucesso. <br><br>  Em seguida, criamos o ServerBuilder, registramos nosso servi√ßo nele, que constru√≠mos um pouco mais alto. <br><br><br><img src="https://habrastorage.org/webt/u8/6l/yz/u86lyzlselt_gi1khgl7l5umzw8.jpeg"><br><br>  Agora, apenas come√ßamos e aguardamos as solicita√ß√µes recebidas. <br><br><br><img src="https://habrastorage.org/webt/bd/v9/bl/bdv9blqsyc3gbw-atarolnny0ha.jpeg"><br><br><br>  Agora vamos ver o cliente em Java.  Eu coleciono gradle.  Nossa tarefa √© conectar o plug-in protobuf primeiro. <br><br>  H√° um conjunto b√°sico de depend√™ncias que precisamos arrastar para o nosso servi√ßo; elas s√£o necess√°rias no est√°gio de compila√ß√£o. <br><br>  Tamb√©m quero observar que existe uma biblioteca de tempo de execu√ß√£o.  Para Java, ele usa netty como servidor e cliente, suporta HTTP / 2, √© bastante conveniente e de alto desempenho. <br><br>  Em seguida, configuramos o compilador proto.  O pr√≥prio compilador n√£o precisa ser instalado localmente para Java; ele pode ser retirado de artefatos. <br><br>  A mesma coisa com os plugins.  Localmente para Java, n√£o √© necess√°rio.  Voc√™ pode arrastar um artefato.  E √© importante simplesmente configur√°-lo para que todos os shuffles tamb√©m sejam chamados, para que stubs sejam gerados. <br><br><br><img src="https://habrastorage.org/webt/iu/n7/v6/iun7v66-lubn0f1qrwb1napvw6s.jpeg"><br><br><br>  Vamos para o c√≥digo Java.  Aqui somos os primeiros a criar o esbo√ßo do nosso servi√ßo.  Essa √© a nossa tarefa para o Java fornecer Canal.  H√° um ChannelBuilder na biblioteca de tempo de execu√ß√£o com o qual podemos construir este canal.  Aqui, ativamos manualmente o texto sem formata√ß√£o para simplificar, mas o HTTP2 e o gRPC criptografam tudo por padr√£o e usam o TLS. <br><br>  Temos um esbo√ßo do nosso cliente, um cliente s√≠ncrono √© gerado aqui.  Da mesma forma, voc√™ pode gerar um cliente ass√≠ncrono, existem outras op√ß√µes. <br><br>  Em seguida, criamos nossa solicita√ß√£o de protobuff, ou seja, constru√≠mos uma mensagem protobuff. <br><br><br><img src="https://habrastorage.org/webt/kn/qo/1u/knqo1uengqboh-vagqyfyipqvrs.jpeg"><br><br><br>  Isso √© tudo, envie-o. Em nosso cliente, chamamos getEcho e imprimimos o resultado.  Tudo √© simples.  Como voc√™ pode ver, √© necess√°rio um pouco de c√≥digo e a integra√ß√£o √© criada. <br><br><h3>  streaming de gRPC.  Pr√°tica </h3><br>  Agora, vamos olhar para uma coisa mais avan√ßada, isso √© streaming.  Vou lhe dizer como funciona e, mais tarde, como us√°-lo. <br><br><img src="https://habrastorage.org/webt/ly/pu/15/lypu157vtebmx4q8sw11d70gemo.jpeg"><br><br>  O cliente-servidor de streaming parece arquiteturalmente o mesmo.  Ou seja, temos uma conex√£o persistente entre o cliente e o balanceador.  Ent√£o as diferen√ßas come√ßam.  A ess√™ncia do streaming √© que o cliente est√° conectado a algum back-end final e a conex√£o √© salva.  Ou seja, continua assim.  E assim  Aqui, gostaria de observar separadamente que o uso de um balanceador n√£o √© t√≠pico para streaming, ou seja, voc√™ precisa entender que as solicita√ß√µes de streaming podem durar bastante.  Ou seja, voc√™ pode abri-los e trocar mensagens por um longo tempo.  E essas mensagens passar√£o pelo balanceador, mas, na verdade, sempre v√£o para o mesmo back-end.  E n√£o est√° muito claro por que √© necess√°rio. <br><br>  Uma pr√°tica comum √© quando um servi√ßo, por exemplo, √© puramente streaming, ou principalmente streaming, e a descoberta de servi√ßo √© usada.  O GRPC possui um ponto de extens√£o em que a descoberta de servi√ßo pode ser incorporada. <br><br><img src="https://habrastorage.org/webt/dm/5f/lq/dm5flqilbfrmpdwlz-xi-0dn9nw.jpeg"><br><br>  O que precisamos para implementar servi√ßos de streaming?  Temos o mesmo formato proto.  Estamos adicionando outro RPC e aqui voc√™ pode perceber que adicionamos duas palavras-chave antes da solicita√ß√£o e antes da resposta.  Assim, declaramos os fluxos EchoRequest e EchoResponse. <br><br><br><img src="https://habrastorage.org/webt/y7/ji/8i/y7ji8idykqbfsumuuj91t1fwwde.jpeg"><br><br>  O mais interessante come√ßa.  Nossa compila√ß√£o n√£o muda de forma alguma para os servi√ßos de streaming.  Nossa pr√≥xima tarefa √© substituir nosso novo m√©todo em nosso servi√ßo Echo, que funcionar√° com fluxos.  No caso do servidor, tudo isso √© um pouco mais f√°cil.  Ou seja, podemos ler constantemente do fluxo e responder a alguma coisa.  N√≥s podemos responder de forma ass√≠ncrona.  Ou seja, eles s√£o independentes, transmitem para escrever e transmitem para ler, e aqui tudo √© simples para um cen√°rio simples. <br><br><img src="https://habrastorage.org/webt/vv/ih/as/vvihasd7g8s9s8jfxte2lgdkae0.jpeg"><br><br>  Aqui est√° a leitura agora, aqui est√° a grava√ß√£o. <br><br><br><img src="https://habrastorage.org/webt/v_/rb/l_/v_rbl_m4pyxndxrkveev_ibze2q.jpeg"><br><br>  Nos clientes Java, as coisas s√£o um pouco mais complicadas.  L√° voc√™ n√£o pode usar nenhuma API s√≠ncrona, ou seja, ela simplesmente n√£o funciona com fluxos.  E a API ass√≠ncrona √© usada.  Ou seja, nossa tarefa √© implementar o modelo Observer.  Existe uma interface StreamObserver l√°.  Ele cont√©m tr√™s m√©todos: onNext, onCompleted e onError.  Aqui, por simplicidade, eu implementei apenas o Next.  Ele se contrai apenas quando a resposta chega do servidor. <br><br><br><img src="https://habrastorage.org/webt/o5/ma/2r/o5ma2rsuawum-empf1enylvayos.jpeg"><br><br>  Aqui, coloquei uma fila para enviar mensagens entre threads. <br><br><img src="https://habrastorage.org/webt/wt/pu/zd/wtpuzdzh5dlmkgdxqpkieddlegg.jpeg"><br><br>  Qual a diferen√ßa?  Em vez de blockStStub, apenas criamos newStub.  Esta √© uma implementa√ß√£o ass√≠ncrona que pode funcionar apenas com o Observer.  De fato, voc√™ pode fazer chamadas un√°rias ao Observer, apenas n√£o t√£o conveniente.  N√≥s, pelo menos, n√£o o usamos de maneira t√£o ativa. <br><br>  Em seguida, constru√≠mos nosso Observador. <br><br>  E fazemos nossa liga√ß√£o RPC.  Passamos o ResponseObserver para a entrada e, na sa√≠da, emite RequestObserver para n√≥s.  Al√©m disso, podemos fazer chamadas no RequestObserver, transmitindo mensagens para o servidor.  E o nosso ResponseObserver ir√° se contrair e processar as mensagens. <br><br>  Aqui est√° um exemplo.  Estamos apenas fazendo uma liga√ß√£o.  Ligue para a pr√≥xima, passe Solicita√ß√£o l√°. <br><br>  Al√©m da fila, esperamos que o servidor responda e imprima. <br><br><br><img src="https://habrastorage.org/webt/bg/ta/hq/bgtahqaqbyqbzp72lhix4tzsmii.jpeg"><br><br><br>  Quero chamar a aten√ß√£o para o fato de que nossa tarefa aqui, como as pessoas respons√°veis ‚Äã‚Äãpela implementa√ß√£o do streaming, √© lidar corretamente com o fechamento deste RequestObserver.  Ou seja, em caso de erro, devemos chamar o m√©todo onError e, em caso de conclus√£o bem-sucedida, quando acreditamos que o fluxo pode ser fechado, devemos chamar o m√©todo onCompleted. <br><br><img src="https://habrastorage.org/webt/js/4a/ze/js4aze1vr9sb4t9clbpq0obdywy.jpeg"><br><br>  N√≥s seguimos em frente.  Quais s√£o os aplicativos de streaming?  Isso √© algo mais avan√ßado, n√£o o fato de ser diretamente √∫til a todos, mas √†s vezes ser usado.  Ou seja, o primeiro √© o download e o upload de grandes quantidades de dados.  O servidor ou cliente pode produzir dados em algumas partes.  Essas partes j√° podem, de alguma forma, ser agrupadas no cliente ou no servidor.  Ou seja, voc√™ j√° pode fazer otimiza√ß√µes adicionais aqui. <br><br>  Al√©m disso, o esquema de streaming √© adequado para envio por servidor.  Voc√™ precisa entender que eu considerei a op√ß√£o mais extrema quando temos streaming bidirecional.  E talvez fluindo em uma dire√ß√£o.  Por exemplo, de cliente para servidor ou de servidor para cliente.  No caso de um servidor para um cliente, podemos nos conectar a algum servidor, e ele enviar√° pushies para n√≥s e, para isso, n√£o precisaremos pesquisar regularmente. <br><br>  A pr√≥xima vantagem do streaming √© vinculativa a uma m√°quina.  Como eu disse, uma conex√£o de ponta a ponta ser√° estabelecida para todas as mensagens dentro do fluxo, e essa conex√£o ser√° vinculada a uma m√°quina e, definitivamente, n√£o ser√° alterada em lugar algum.  Portanto, √© poss√≠vel, em primeiro lugar, simplificar algo, algum tipo de sincroniza√ß√£o entre servidores e, al√©m disso, voc√™ pode fazer coisas transacionais. <br><br>  E o streaming bidirecional, apenas um exemplo que mostrei, √© a capacidade de criar alguns dos meus pr√≥prios protocolos.  Coisa interessante o suficiente.  Temos filas internas no Yandex que usam apenas o fluxo bidirecional.  E se de repente algu√©m tiver essas tarefas, haver√° uma oportunidade suficientemente boa para us√°-lo. <br><br>    ,     .            .            . ,     -   ,      ,      .      .  gRPC    . <br><br><h3>   </h3><br>  ,      gRPC. <br><br><img src="https://habrastorage.org/webt/wl/un/lo/wlunloh9hz1t6cklr4zaqzketmm.jpeg"><br><br>     ,   .   -  .   gRPC    . , ,  ,   , ,   .   ,    runtime- .  ,   .      ,   OK,       runtime- . <br><br> ,  Java      .                    .  google.rpc.Status  3 :  ,   .     ,   .        ,    .  ‚Äî  ,      ,    . <br><br>      error details,   ,   .   : ,   , , stack traces,      .   ,    . <br><br>    ‚Äî   ,  HTTP   ,     ?       .     BadRequest   .   ,     ,      error details,   . <br><br>   .   , , BadRequest  -  (   ),     - error detail.       , ,      ,   - .    ,    . <br><br><img src="https://habrastorage.org/webt/dk/dn/zl/dkdnzlcnav_kpnc7e29mv7j5hqa.jpeg"><br><br>       .  .   ,    , ,     .   - -   ,  - - ,     ,  .       .  , , Zipkin.   ,  HTTP    ,  ‚Äî  metadata.         . <br><br>       ,   .       ,        - ,    ,    ,     . <br><br>     runtime-,           - ,   .  Java  ClientInterceptor  ServerInterceptor.  ,    ,   . ,   ,  ,       ,    ,   - . ,  - API - .    ,  ,  , ,   - .  ,     gRPC,      ,  - .       ,  ,   - , ,  ,  . <br><br><img src="https://habrastorage.org/webt/fy/8u/iz/fy8uiztm6gwxntcvzc8m0qdcply.jpeg"><br><br>   -   .     -.   Java  .       ,       ,    -  .   -  ,     . <br><br><img src="https://habrastorage.org/webt/sb/zx/th/sbzxthmnnf_fh8iyxl9ghv02s4y.jpeg"><br><br>  .   gRPC ‚Äî  . HTTP/2  .   -   ,   ?    : , .    .   ,    gRPC   grpc_cli,  curl.   ,      . , -,  .    ,    gRPC    ,       . <br><br>    ,  evans.   ,    CLI:   ,     ,  ,  .  ,   .  - , ,  ,   , ,  . <br><br>  -  UI ‚Äî ,   Postman, ‚Äî  BloomRPC.     Postman .  Postman, , ,    .   , BloomRPC ,   . <br><br>  -  ,   .  , ,     grpc_cli.          .   ,   .  ,   ,  .       ,       .  , - -  .    ‚Äî . <br><br><img src="https://habrastorage.org/webt/7y/oe/w3/7yoew3fwgydkvdgiaxm1acueyki.jpeg"><br><br> ,     ,    gRPC.       . -    , -  ,  .  Swagger. ,    HTTP/1    .     OpenAPI   ,        .       . ,        HTTP/2,  Swagger ‚Äî   . <br><br> WSDL ‚Äî  ,  .   .       Swagger,     ,   .    .   -. <br><br>  ,  , ,       ,  JAX-RS,   Java  .    . <br><br>     Twirp.   ?     Go,     .     . ,  ,   Go ,   gRPC  Twirp.   ?  ,  gRPC ‚Äî   ,   , ,  IDL .     proto-  ,        gRPC-.      protoc,       ,       . <br><br>  Twirp     .   proto-      ,    HTTP/1.1    ,   JSON.    ,  Twirp      Go.       ,    ,   Java      Jetty.    ,    . <br><br><img src="https://habrastorage.org/webt/fn/p3/bi/fnp3bihwdt68ttten4_mpx7qal4.jpeg"><br><br>     ? gRPC ‚Äî    REST   .    ,     ,   , ,  HTTP/2 balancer.   service discovery,    . gRPC ,   .    . <br><br>      gRPC ‚Äî  ,  .   CLI,   UI. ,        . <br><br>    ,      gRPC.  inter-process-. , sidecar pattern.  ,          .      ,    . ,   -.    -     ,              ,     -.              .      ,  , ,    ,     - . <br><br> ,       .  gRPC    .   ,  .    ,   unary-.         ,      . <br><br>   : <br> ‚Äî <a href="https://grpc.io/">C  gRPC</a> ‚Äî   , .  ,    , ,      . <br> ‚Äî <a href="https://github.com/grpc-ecosystem/awesome-grpc">Awesome gRPC</a> ‚Äî   GitHub      .      ,    ,   , .  .    ‚Äî  ,  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode encontrar muitos outros recursos na Internet, em alguns slides. </font><font style="vertical-align: inherit;">Mas eu gostei mais disso. </font><font style="vertical-align: inherit;">O c√≥digo ligeiramente modificado da apresenta√ß√£o est√° </font></font><a href="https://github.com/homer-j/grpc-examples"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font> Obrigada <br><br><a name="video1"></a><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grava√ß√£o informal de relat√≥rios</font></font></b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/AciUs4Yq7oU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484068/">https://habr.com/ru/post/pt484068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484052/index.html">Tarefas para a base lunar</a></li>
<li><a href="../pt484056/index.html">Seu projeto realmente precisa de testes?</a></li>
<li><a href="../pt484062/index.html">Aprendendo ingl√™s com MEMASICS</a></li>
<li><a href="../pt484064/index.html">Como preparar um jogo para localiza√ß√£o? 10 Regras B√°sicas</a></li>
<li><a href="../pt484066/index.html">Dinheiro vs equipe. N√£o s√£o os aspectos mais √≥bvios do relacionamento de empreendedores, fundadores e investidores</a></li>
<li><a href="../pt484070/index.html">Como escrevemos um sistema antifraude em quatro m√£os e tr√™s cabe√ßas</a></li>
<li><a href="../pt484072/index.html">5. Introdu√ß√£o ao Fortinet v6.0. NAT</a></li>
<li><a href="../pt484076/index.html">Onde armazenar criptomoedas: tributa√ß√£o de criptomoedas em diferentes pa√≠ses</a></li>
<li><a href="../pt484084/index.html">1C-Bitrix e uma tentativa de introduzi-lo</a></li>
<li><a href="../pt484088/index.html">Desfile de senhas (an√°lise de ~ 5 bilh√µes de senhas devido a vazamentos)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>