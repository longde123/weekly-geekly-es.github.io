<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÖ üö∫ üé£ Du d√©butant aux ic√¥nes de style: comment nous avons remport√© des prix dans 2GIS üîü üôèüèª üßò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque jour, les utilisateurs de 2GIS nous aident √† maintenir l'exactitude des donn√©es: ils informent sur les nouvelles soci√©t√©s, ajoutent des √©v√©neme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Du d√©butant aux ic√¥nes de style: comment nous avons remport√© des prix dans 2GIS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/470942/"><img src="https://habrastorage.org/webt/kl/9g/ja/kl9gjaqo9dmcbsimconigs2pnxo.png"><br><br>  Chaque jour, les utilisateurs de 2GIS nous aident √† maintenir l'exactitude des donn√©es: ils informent sur les nouvelles soci√©t√©s, ajoutent des √©v√©nements de trafic, t√©l√©chargent des photos et r√©digent des avis.  Auparavant, nous ne pouvions les remercier que par des mots ou organiser un cadeau.  Mais au fil du temps, les mots sont oubli√©s et tout le monde ne re√ßoit pas de cadeaux.  Par cons√©quent, nous avons d√©cid√© de nous assurer que tous ceux qui se soucient de 2GIS voient leur contribution au produit et notre gratitude pour cela. <br><br>  Il y avait donc des r√©compenses - des m√©dailles virtuelles que nous accumulons pour divers types de t√¢ches: t√©l√©charger des photos sur des cartes de caf√©, √©crire des critiques sur les th√©√¢tres, sp√©cifier les heures de travail des organisations, etc.  Les utilisateurs voient les r√©compenses gagn√©es dans leur profil 2GIS personnel et sur l'onglet ¬´Mon 2GIS¬ª dans l'application mobile.  L√†, nous montrons combien il reste jusqu'√† la prochaine r√©alisation. <br><br>  Pour impl√©menter cette fonctionnalit√©, nous avons appris √† traiter un flux d'√©v√©nements avec un volume de 500 000 enregistrements par heure (par endroits jusqu'√† 50 000 enregistrements par seconde) et √† analyser les donn√©es de plusieurs services.  Et aussi - ils ont ajout√© un peu de m√©taprogrammation afin de simplifier la configuration lors du d√©veloppement de nouvelles r√©compenses. <br><br>  En collaboration avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Rapter</a> , nous vous dirons ce qui est sous le capot du processus d'attribution. <br><a name="habracut"></a><br><h2>  Concept </h2><br>  Afin de comprendre la complexit√© de la fonctionnalit√©, vous devez comprendre comment le probl√®me technique a sonn√©.  Ensuite, consid√©rez l'id√©e de mise en ≈ìuvre et le sch√©ma g√©n√©ral des composants du syst√®me.  C'est ce que nous allons faire dans cette section. <br><br><h3>  Conditions requises pour les r√©sum√©s </h3><br>  Exigences - une chose plut√¥t ennuyeuse, donc nous ne peindrons pas toutes les nuances, nous nous concentrerons sur les choses les plus importantes: <br><br><ul><li>  les r√©compenses ne sont accord√©es qu'aux utilisateurs autoris√©s; </li><li>  la mise √† jour des progr√®s sur une r√©compense doit √™tre aussi rapide que possible; </li><li>  r√©compense - le r√©sultat d'un utilisateur effectuant un ensemble d'actions dans le produit: t√©l√©chargement d'une photo, r√©daction d'un avis, recherche d'un itin√©raire, etc. Il existe de nombreuses sources de donn√©es. </li></ul><br><h3>  Id√©e architecturale </h3><br>  L'id√©e de mise en ≈ìuvre n'est pas tr√®s compliqu√©e.  Elle peut s'exprimer de mani√®re th√©matique: <br><br><ul><li>  l'attribution se compose de t√¢ches dont les r√©sultats sont combin√©s selon la formule sp√©cifi√©e lors de la configuration de l'attribution; </li><li>  la t√¢che r√©pond aux √©v√©nements sur les actions des utilisateurs venant de l'ext√©rieur, les filtre et enregistre le changement en cours sous forme de compteurs; </li><li>  Les ¬´√©v√©nements externes¬ª sont g√©n√©r√©s par des syst√®mes ma√Ætres (photo, r√©troaction, services de raffinement, etc.) ou des services auxiliaires qui transforment ou filtrent des flux d'√©v√©nements d√©j√† existants; </li><li>  le traitement des √©v√©nements se produit de mani√®re asynchrone et peut √™tre arr√™t√© √† tout moment si n√©cessaire; </li><li>  l'utilisateur voit l'√©tat actuel de ses r√©compenses; </li><li>  tout le reste, ce sont les d√©tails ... </li></ul><br><h3>  Entit√©s cl√©s </h3><br>  Le diagramme ci-dessous montre les principales entit√©s du domaine et leur relation: <br><br><img src="https://habrastorage.org/webt/vi/ya/59/viya59qa7bnnad3hogutbunyds4.png"><br><br>  Deux zones sont distingu√©es dans le sch√©ma: <br><br><ul><li>  Scheme - une zone pour d√©crire la structure des r√©compenses et les r√®gles de leur accumulation; </li><li>  Donn√©es - Zone d'attribution pour des utilisateurs sp√©cifiques et des donn√©es li√©es √† leur statut actuel. </li></ul><br>  Les entit√©s dans le diagramme: <br><br><ul><li>  Atteindre - informations sur le prix qui peuvent √™tre obtenues.  Comprend des m√©ta-informations et une description de la fa√ßon de combiner les r√©sultats des t√¢ches - une strat√©gie. </li><li>  Objectif - une t√¢che dont les conditions doivent √™tre remplies pour progresser vers l'obtention d'un prix. </li><li>  UserAchieve - l'√©tat actuel de la r√©compense pour un utilisateur particulier. </li><li>  UserObjective - l'√©tat actuel du travail de r√©compense de l'utilisateur. </li><li>  Utilisateur - informations sur l'utilisateur, n√©cessaires pour les notifications et la compr√©hension de son √©tat actuel (les r√©compenses √† distance et interdites ne sont pas n√©cessaires). </li><li>  ProcessingLog - un journal des charges √† payer pour les t√¢ches.  Contient des informations sur la mani√®re dont une action sp√©cifique a influenc√© la progression de la mission. </li><li>  √âv√©nement - les informations minimales n√©cessaires sur un √©v√©nement qui ont influenc√© d'une mani√®re ou d'une autre la progression des t√¢ches de l'utilisateur. </li></ul><br><h3>  Structure de service </h3><br>  Consid√©rons maintenant les principaux composants du service et leurs d√©pendances: <br><br><img src="https://habrastorage.org/webt/qi/dp/k_/qidpk_jo7rqnh2x5dywk0sg0ij4.png"><br><br><ul><li>  Bus d'√©v√©nements - un bus d'√©v√©nements qui peut √™tre utilis√© pour effectuer des t√¢ches.  Nous utilisons Apache Kafka. </li><li>  Les bases de donn√©es ma√Ætre et esclave sont le principal entrep√¥t de donn√©es.  Dans ce cas, un cluster PostgreSQL. </li><li>  ConsumingWorkers - gestionnaires d'√©v√©nements de bus.  La t√¢che principale consiste √† lire les √©v√©nements d'une source sp√©cifique (photos, avis, etc.), √† les appliquer aux t√¢ches utilisateur et √† enregistrer le r√©sultat. </li><li>  AchievesWorker - raconte la progression des r√©compenses des utilisateurs en fonction de l'√©tat des t√¢ches. </li><li>  NotificationWorkers - un ensemble de gestionnaires pour planifier et envoyer des notifications sur la r√©ception des r√©compenses, les annonces de nouvelles r√©alisations possibles, etc. </li><li>  API publique - une interface REST publique pour les applications Web et mobiles. </li><li>  API priv√©e - Interface REST pour le panneau d'administration, qui aide √† l'enqu√™te sur les incidents et au support technique.  Il est disponible pour les d√©veloppeurs et les √©quipes de support. </li></ul><br>  Chacun des composants est isol√© en termes de logique et de domaines de responsabilit√©, ce qui √©vite les int√©grations inutiles et les blocages lors de la modification des donn√©es.  Ci-dessous, nous ne consid√©rons qu'une partie du sch√©ma associ√© au traitement des √©v√©nements et √† leur conversion en r√©compenses. <br><br><h2>  Gestion des √©v√©nements </h2><br><h3>  Le contenu </h3><br>  Les r√©compenses sont principalement un service d'agr√©gation de donn√©es.  Chaque syst√®me ma√Ætre g√©n√®re plusieurs types d'√©v√©nements.  En r√®gle g√©n√©rale, chaque type d'√©v√©nement est √©troitement li√© √† l'√©tat du contenu, √† son mod√®le de statut.  Ainsi, une photo peut √™tre mod√©r√©e, supprim√©e, bloqu√©e, masqu√©e ou active.  Ce sont tous des √©v√©nements diff√©rents qui sont g√©r√©s par un travailleur distinct sp√©cialis√© dans une source particuli√®re.  √Ä l'heure actuelle, il existe une interaction avec les sources suivantes (syst√®mes ma√Ætres): <br><br><ul><li>  Photo - g√©n√®re divers √©v√©nements li√©s aux op√©rations effectu√©es par les utilisateurs sur des photographies. </li><li>  Avis - √©v√©nements li√©s aux op√©rations sur les avis des utilisateurs. </li><li>  Datafeedback - √©v√©nements li√©s aux op√©rations de raffinement.  La clarification est un changement d'informations sur un objet sur une carte, que ce soit une entreprise ou un monument. </li><li>  Check - √©v√©nements li√©s √† l'application 2GIS Check. </li><li>  Les BSS sont des √©v√©nements d'analyse qui g√©n√®rent des applications 2GIS.  Par exemple, l'ouverture d'une certaine entreprise, des voyages sur le navigateur, etc. </li></ul><br><img src="https://habrastorage.org/webt/vg/xy/zb/vgxyzbizbytl_up3fllx5epasue.png"><br><br>  Les √©v√©nements g√©n√©r√©s par le syst√®me ma√Ætre entrent dans le sujet Kafka dans l'ordre de changer leurs statuts, ce qui permet de faire avancer la r√©compense pour l'utilisateur non seulement en avant, mais aussi en arri√®re.  Par exemple, si la photo √©tait dans le statut ¬´actif¬ª, puis qu'elle a acquis pour une raison quelconque le statut ¬´bloqu√©e¬ª, la progression de l'attribution devrait changer √† la baisse.  La progression des r√©compenses est une interpr√©tation des objets internes appel√©s compteurs de contenu. <br><br>  Les compteurs peuvent varier pour diff√©rentes donn√©es.  Par exemple, pour les √©v√©nements concernant la photo, ils sont les suivants: le nombre d'approbations, le nombre de mod√©ration, le nombre de blocages et pour les √©v√©nements d'ouverture de cartes, vous devez consid√©rer uniquement le nombre de cartes ouvertes par l'utilisateur.  Sur la base des valeurs actuelles des compteurs de contenu, pour un utilisateur particulier, dans le cadre d'un prix sp√©cifique, les r√©ponses aux questions suivantes sont d√©termin√©es: <br><br><ul><li>  Le prix a-t-il commenc√©? </li><li>  quel est le progr√®s </li><li>  La r√©compense est-elle enti√®rement termin√©e </li></ul><br><h3>  Filtres et r√®gles </h3><br>  Les compteurs d'emplois d'un prix particulier ne sont modifi√©s que si un √©v√©nement est arriv√© avec le type de contenu souhait√©, ainsi qu'avec les donn√©es n√©cessaires pour recevoir le prix. <br><br>  Afin de ne sauter que le contenu appropri√© pour le prix, nous organisons chaque √©v√©nement √† travers une s√©rie de filtres et de r√®gles. <br><br>  Un filtre est une certaine restriction impos√©e au contenu.  Il ne souhaite que r√©pondre √† la question: ¬´Un nouvel √©v√©nement correspond-il ou non √† cette condition?¬ª <br>  Une r√®gle est un filtre sp√©cial dont le but est de dire: "Si un √©v√©nement correspond √† la condition, alors comment les compteurs devraient-ils changer?"  La r√®gle comprend un algorithme pour changer les compteurs.  Chaque prix contient une seule r√®gle. <br><br>  L'impl√©mentation des filtres et des r√®gles est dans le code du projet, et la description des filtres (r√®gle) appartenant √† un prix particulier est dans la base de donn√©es au format JSON.  Nous n'avons pas pris une telle d√©cision tout de suite.  Initialement, les filtres et les r√®gles ne pouvaient pas √™tre d√©finis √† l'aide de la configuration via la base de donn√©es, l'attribution √©tait enti√®rement d√©crite dans le code, seul son identifiant √©tait stock√© dans la table.  Cette d√©cision pr√©sente un certain nombre d'inconv√©nients importants: <br><br><ul><li>  Le probl√®me de la prise en charge de plusieurs environnements.  Si vous souhaitez d√©ployer un √©tat de la liste des r√©compenses dans l'environnement de test et en envoyer un autre au combat, vous devez conna√Ætre le code d'environnement dans le code du projet ou disposer d'un fichier de configuration avec la liste des r√©compenses.  En m√™me temps, il n'est pas possible d'utiliser des bases de donn√©es diff√©rentes pour cette t√¢che, bien qu'elles existent d√©j√† pour chaque environnement. </li><li>  Possibilit√© de configurer le filtrage uniquement par le d√©veloppeur.  √âtant donn√© que tout est d√©crit dans le code, seule une personne connaissant le projet et le langage de programmation pourrait apporter des modifications, j'aimerais qu'il soit possible de le faire simplement via l'API priv√©e ou la base de donn√©es. </li><li>  L'inconv√©nient de la visualisation.  Il existe de nombreuses r√©compenses, parfois vous devez voir les filtres qu'ils utilisent.  Chaque fois, faire cela en regardant le code est assez fastidieux. </li></ul><br>  Au d√©but de l'application, nous comparons par le nom des filtres charg√©s √† partir de la base de donn√©es et les mettons dans une r√©compense sp√©cifique.  Exemple de description de filtre: <br><br><pre><code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"SourceFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"sources"</span></span>:[<span class="hljs-string"><span class="hljs-string">"reviews"</span></span>] } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewsLengthFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"allowed_length"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } } ]</code> </pre> <br>  Dans ce cas, nous ne prendrons que les avis (cela est indiqu√© par le premier objet de description du tableau de filtres), dont le texte contient plus de 100 caract√®res (le deuxi√®me filtre de la liste). <br><br>  Exemple de description de r√®gle: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewUniqueByObjectRule"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{}}</code> </pre><br>  Cette r√®gle vous permettra de modifier les compteurs uniquement si l'utilisateur a r√©dig√© une √©valuation pour l'objet, alors qu'une seule √©valuation sera prise en compte pour un objet. <br><br><h3>  Bss </h3><br>  Arr√™tons-nous s√©par√©ment sur le travail avec le flux d'√©v√©nements BSS.  Il y a au moins trois raisons √† cela: <br><br><ul><li>  Les √©v√©nements Analytics ne peuvent pas √™tre annul√©s, ils ne contiennent aucun mod√®le d'√©tat, ce qui est g√©n√©ralement logique, car la conduite via le navigateur ou la cr√©ation d'un itin√©raire ne peut pas √™tre annul√©e.  L'action √©tait l√† ou non. </li><li>  Volumes.  Permettez-moi de vous rappeler que l'audience totale de 2GIS est de plus de 50 millions d'utilisateurs par mois.  Ensemble, ils effectuent plus de 1,5 milliard de requ√™tes de recherche, ainsi que de nombreuses autres actions: lancement de l'application, visualisation de la carte de l'objet, etc. Au plus fort, le nombre d'√©v√©nements peut atteindre 50 000 par seconde.  Nous devons transmettre toutes ces informations √† travers des filtres afin de r√©compenser l'utilisateur. </li><li>  Les √©v√©nements Analytics ont des fonctionnalit√©s: plusieurs formats, une grande vari√©t√© de types. </li></ul><br>  Tout cela a grandement influenc√© le traitement des donn√©es du sujet BSS, car si nous avons besoin de temps r√©el, nous avons besoin d'un temps de traitement tr√®s proche. <br><br>  Pour r√©duire les diff√©rences d√©crites, un service distinct a √©t√© cr√©√© qui pr√©pare ces √©v√©nements.  Le service peut fonctionner avec toute la vari√©t√© de formats de messages provenant de l'analyse.  L'essence de son travail est la suivante: l'ensemble du flux d'√©v√©nements du BSS est lu, √† partir duquel seuls ceux qui sont n√©cessaires pour les prix sont extraits.  Un tel filtre de service r√©duit consid√©rablement la charge (apr√®s filtrage, le d√©bit est de ‚âà300 √©v√©nements par seconde) des r√©compenses du processeur de flux BSS, et g√©n√®re √©galement des √©v√©nements dans un format unique, nivelant l'inconv√©nient associ√© √† l'historique du d√©veloppement de l'analyse interne. <br><br><h2>  R√©compenses </h2><br>  Nous avons donc compris comment g√©rer les √©v√©nements et calculer la progression des affectations.  Il est maintenant temps de jeter un coup d'≈ìil au processus d'attribution des r√©compenses aux utilisateurs. <br><br>  La premi√®re question qui se pose est: pourquoi allouer la sortie √† un travailleur s√©par√©, ne peut-elle pas √™tre recompt√©e lors du traitement de chaque √©v√©nement?  R√©ponse: possible, mais pas la peine. <br><br>  Il y a plusieurs raisons pour attribuer l'extradition √† un processus distinct: <br><br><ol><li>  En transf√©rant le recomptage √† chaque ConsumingWorker, nous obtenons la condition de course pour l'op√©ration de mise √† jour de la progression par r√©compense, car chaque gestionnaire tentera de mettre √† jour la progression en fonction de l'√©tat connu des t√¢ches, et d'autres changeront activement cet √©tat. </li><li>  Chaque lot ConsumingWorker traite les √©v√©nements de Kafka dans une transaction.  En ajoutant un insert √† la table des r√©compenses de l'utilisateur, nous appellerons des verrous suppl√©mentaires au niveau de la base de donn√©es, ce qui emp√™chera les autres gestionnaires. </li><li>  Dans le processus de d√©livrance des r√©compenses, il existe une logique d'envoi de notifications qui ne fera que ralentir le traitement du flux d'√©v√©nements, ce qui n'est pas souhaitable. </li></ol><br>  Les raisons de l'√©mergence d'un AchievesWorker distinct (gestionnaire pour la d√©livrance des r√©compenses) ont √©t√© tri√©es.  Vous devez maintenant traiter deux parties importantes du traitement: <br><br><ol><li>  Il y a un ensemble de qu√™tes dans la r√©compense.  Il existe un ensemble de compteurs pour ces t√¢ches.  Comment comprendre le montant de la r√©compense et comment l'exprimer en code? <br>  Exemple: vous devez √©crire 3 avis ou t√©l√©charger 3 photos.  L'utilisateur a 1 avis et 2 photos.  Quelle est la progression du prix?  R√©ponse: 3, car l'utilisateur sera certain que vous en aurez besoin de 3 au total. </li><li>  Nous avons un gestionnaire distinct pour l'√©mission des r√©compenses.  Chaque fois, compter des dizaines de r√©compenses pour chaque utilisateur autoris√©, c'est-√†-dire plusieurs dizaines de millions, a peu de chances de r√©ussir rapidement.  Comment peut-il conna√Ætre la progression de quels utilisateurs particuliers et quelles t√¢ches ont chang√© depuis le dernier traitement? </li></ol><br>  Nous consid√©rerons chaque partie s√©par√©ment. <br><br><h3>  Flux de progr√®s </h3><br>  Pour mieux comprendre comment vous pouvez d√©crire comment transformer l'avancement des t√¢ches en progr√®s par r√©compense, nous divisons les r√©compenses en cat√©gories et examinons les transformations. <br><br>  <b>"Terminez une t√¢che par X unit√©s."</b>  Exemple: Conduisez 10 km sur le navigateur. <br><br><img src="https://habrastorage.org/webt/vv/qu/x5/vvqux5yb09uehrul3dkd3mux3wm.png"><br><br>  <b>"Remplissez plusieurs t√¢ches pour X unit√©s chacune."</b>  Exemple: t√©l√©chargez 5 photos et √©crivez 5 avis sur des cartes - seulement 10 unit√©s de contenu. <br><br><img src="https://habrastorage.org/webt/fe/n8/oc/fen8oc0kbm372ozvyvr3a7fj8jo.png"><br><br>  <b>"Compl√©tez plusieurs t√¢ches pour X unit√©s au total."</b>  Exemple: r√©digez 5 avis ou t√©l√©chargez 5 photos. <br><br><img src="https://habrastorage.org/webt/d-/ld/gd/d-ldgdazj8xt2eysdzqhgauaxgc.png"><br><br>  <b>"Effectuez plusieurs t√¢ches regroup√©es par type."</b>  Exemple: t√©l√©chargez 5 unit√©s de contenu (photos ou avis) et parcourez 10 km sur le navigateur. <br><br><img src="https://habrastorage.org/webt/ue/c3/ck/uec3ckf33tcm4pjcfmtkfbmv9eq.png"><br><br>  Th√©oriquement, il pourrait y avoir des combinaisons imbriqu√©es plus complexes.  Cependant, dans des conditions r√©elles, il n'est pas possible d'expliquer √† l'utilisateur en deux ou trois phrases la combinaison logique complexe qui doit √™tre effectu√©e pour recevoir la r√©compense.  Par cons√©quent, dans la plupart des cas, ces options sont suffisantes. <br><br>  Nous avons appel√© la m√©thode de conversion une strat√©gie et avons essay√© de la rendre plus ou moins universelle en √©laborant une description formelle sous la forme d'un objet JSON.  Vous pourriez, bien s√ªr, penser √† √©crire sous la forme d'une formule, mais il vous faudrait alors utiliser des similitudes pour √©valuer ou d√©crire la grammaire et la mettre en ≈ìuvre, et c'est clairement une sur-application.  Le stockage de la strat√©gie pour chaque r√©compense dans le code source n'est pas tr√®s pratique, car la description de la r√©compense (partie dans la base de donn√©es et partie dans le code) sera rompue, et elle ne permettra pas non plus de collecter des r√©compenses √† partir de composants pr√™ts √† l'emploi sans d√©veloppement. <br><br>  La strat√©gie est pr√©sent√©e sous la forme d'un arbre, o√π chaque n≈ìud: <br><br><ul><li>  Fait r√©f√©rence √† la progression actuelle de l'affectation ou est un groupe d'autres n≈ìuds. </li><li>  Peut avoir une restriction sup√©rieure - en fait une indication de la n√©cessit√© d'utiliser min (). </li><li>  Peut avoir un coefficient de normalisation.  N√©cessaire pour les conversions simples en multipliant le r√©sultat par un nombre.  Nous sommes utiles pour convertir des m√®tres en kilom√®tres. </li></ul><br>  Pour d√©crire les exemples ci-dessus, une op√©ration suffit - somme.  La somme est id√©ale pour montrer clairement la progression de l'utilisateur avec un seul num√©ro, mais d'autres op√©rations peuvent √™tre utilis√©es si vous le souhaitez. <br><br>  Voici un exemple de description de strat√©gie pour la derni√®re cat√©gorie: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"photo"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"reviews"</span></span> } ] }, { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"navi"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"normalization_factor"</span></span>: <span class="hljs-number"><span class="hljs-number">0.001</span></span> } ] } ] }</code> </pre><br><h3>  Mises √† jour requises </h3><br>  Il existe plusieurs gestionnaires qui analysent sans rel√¢che les √©v√©nements des utilisateurs et appliquent des modifications √† la progression des t√¢ches.  Une recherche r√©guli√®re de tous les utilisateurs avec chaque r√©compense m√®nera √† une analyse de plusieurs dizaines de millions de r√©compenses - pas tr√®s encourageant, √† condition que les mises √† jour r√©elles soient mesur√©es en milliers.  Comment apprendre seulement sur des milliers et ne pas gaspiller des millions de CPU? <br><br>  L'id√©e de recalculer les progr√®s uniquement sur les r√©compenses qui ont r√©ellement chang√© est venue assez rapidement.  Il est bas√© sur l'utilisation de montres vectorielles. <br><br>  Avant la description, je rappellerai les entit√©s: <br><br><ul><li>  UserObjective - donn√©es sur la progression de l'utilisateur en d√©finissant le prix. </li><li>  UserAchieve - r√©compense les donn√©es de progression de l'utilisateur. </li></ul><br>  L'impl√©mentation ressemble √† ceci: <br><br><ul><li>  Nous obtenons le champ de version pour UserObjective et UserAchieve et Sequence dans PostgreSQL. </li><li>  Chaque mise √† jour de l'entit√© UserObjective change de version.  La valeur est tir√©e de la s√©quence (nous l'avons commune √† tous les enregistrements). </li><li>  La valeur de version pour UserAchieve sera d√©termin√©e comme le maximum des versions de UserObjective associ√©. </li><li>  √Ä chaque cycle de traitement, AchievesWorker recherche un tel UserObjective pour lequel il n'y a pas UserAchieve ou UserAchieve.version &lt;UserObjective.version.  Le probl√®me est r√©solu par une seule requ√™te dans la base de donn√©es. </li></ul><br>  Il convient de noter imm√©diatement que la solution a des limites sur le nombre d'entr√©es dans les tableaux des r√©compenses et des t√¢ches, ainsi que sur la fr√©quence des changements en cours sur les t√¢ches, mais avec quelques dizaines de millions de r√©compenses et le nombre de mises √† jour moins de mille par minute, il est tout √† fait possible de vivre avec une telle solution.  D'une mani√®re ou d'une autre, nous expliquerons s√©par√©ment comment nous avons optimis√© l'√©mission pour le concours ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2GIS Agents</a> ¬ª. <br><br><h2>  Conclusions </h2><br>  Malgr√© le fait que l'article se soit av√©r√© assez volumineux, beaucoup de nuances sont rest√©es dans les coulisses, car il ne serait pas possible d'en parler bri√®vement. <br><br>  Quelles conclusions avons-nous tir√©es gr√¢ce aux prix: <br><br><ul><li>  Le principe de ¬´diviser pour r√©gner¬ª dans ce cas a jou√© entre nos mains.  L'allocation de gestionnaires d'√©v√©nements √† chaque source nous aide √† √©voluer si n√©cessaire.  Leur travail est isol√© selon les donn√©es et ne se recoupe que dans de petites zones.  La mise en √©vidence de la logique de r√©compense vous permet de r√©duire les frais g√©n√©raux des gestionnaires d'√©v√©nements. </li><li>  Si vous avez besoin de dig√©rer beaucoup de donn√©es et que le traitement est assez co√ªteux, vous devriez imm√©diatement r√©fl√©chir √† la fa√ßon de filtrer ce qui n'est certainement pas n√©cessaire.  L'exp√©rience du filtrage d'un flux BSS en est un exemple. </li><li>  Encore une fois, nous √©tions convaincus que l'int√©gration de services via un bus d'√©v√©nements commun est tr√®s pratique et vous permet d'√©viter une charge inutile sur d'autres services.  Si le service Rewards recevait des donn√©es des services Photo, Avis, etc. via des requ√™tes http, plusieurs services devraient √™tre pr√©par√©s pour un chargement suppl√©mentaire. </li><li>  Un peu de m√©taprogrammation peut aider √† maintenir arbitrairement l'int√©grit√© de la configuration des donn√©es et des environnements s√©par√©s.  Le stockage des filtres, des r√®gles et des strat√©gies dans la base de donn√©es a simplifi√© le processus de d√©veloppement et de publication de nouvelles r√©compenses. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470942/">https://habr.com/ru/post/fr470942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470928/index.html">Meilleures pratiques pour ex√©cuter Buildah dans un conteneur</a></li>
<li><a href="../fr470930/index.html">Gamification du produit. Historique Ratatype</a></li>
<li><a href="../fr470934/index.html">Gu√©rit avant le mariage: prolif√©ration cellulaire et capacit√©s r√©g√©n√©ratrices des m√©duses</a></li>
<li><a href="../fr470938/index.html">Comment ouvrir un lien en Python. Travailler avec WebBrowser et r√©soudre un probl√®me avec Internet Explorer</a></li>
<li><a href="../fr470940/index.html">Meetup MSK VUE.JS # 3 au groupe Mail.ru: mat√©riaux de mitap</a></li>
<li><a href="../fr470950/index.html">bear_hug: jeux en art ASCII en Python3.6 +</a></li>
<li><a href="../fr470952/index.html">Trucs et astuces de Digital Forensics: Forensics de l'application ¬´Votre t√©l√©phone¬ª</a></li>
<li><a href="../fr470954/index.html">Installez Zimbra OSE 8.8.15 et Zextras Suite Pro sur Ubuntu 18.04 LTS</a></li>
<li><a href="../fr470958/index.html">Les sondes de vitalit√© √† Kubernetes peuvent √™tre dangereuses</a></li>
<li><a href="../fr470962/index.html">JSConf Budapest 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>