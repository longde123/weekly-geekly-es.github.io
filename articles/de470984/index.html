<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚û°Ô∏è üôçüèª ‚úçüèª Analyse von Commits und Pull-Anfragen in Travis CI, Buddy und AppVeyor mit PVS-Studio üë®üèΩ‚Äçüíª üîç üåÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ab Version 7.04 kann der PVS-Studio Analyzer f√ºr C- und C ++ - Sprachen unter Linux und MacOS die Liste der angegebenen Dateien testen. Im neuen Modus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse von Commits und Pull-Anfragen in Travis CI, Buddy und AppVeyor mit PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470984/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Bild 11"></div><br>  Ab Version 7.04 kann der PVS-Studio Analyzer f√ºr C- und C ++ - Sprachen unter Linux und MacOS die Liste der angegebenen Dateien testen.  Im neuen Modus k√∂nnen Sie den Analysator so konfigurieren, dass Commits √ºberpr√ºft und Anforderungen abgerufen werden.  In diesem Artikel erfahren Sie, wie Sie das √úberpr√ºfen der Liste der ge√§nderten Dateien eines GitHub-Projekts in so beliebten CI-Systemen (Continuous Integration) wie Travis CI, Buddy und AppVeyor konfigurieren. <br><a name="habracut"></a><br><h2>  √úberpr√ºfungsmodus f√ºr Dateilisten </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PVS-Studio</a> ist ein Tool zum Erkennen von Fehlern und potenziellen Schwachstellen im Quellcode von Programmen, die in C, C ++, C # und Java geschrieben wurden.  Es funktioniert auf 64-Bit-Systemen unter Windows, Linux und MacOS. <br><br>  In PVS-Studio Version 7.04 f√ºr Linux und macOS wurde der Modus zum √úberpr√ºfen der Liste der Quelldateien angezeigt.  Dies funktioniert f√ºr Projekte, deren Build-System die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Generierung der</a> Datei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">compile_commands.json</a> erm√∂glicht.  Es wird ben√∂tigt, damit der Analysator Informationen √ºber die Kompilierung der angegebenen Dateien extrahieren kann.  Wenn Ihr Build-System die Generierung der Datei compile_commands.json nicht unterst√ºtzt, k√∂nnen Sie versuchen, eine solche Datei mit dem Dienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bear</a> zu generieren. <br><br>  Der Dateilistenpr√ºfmodus kann auch zusammen mit dem Strace-Trace-Protokoll der Compiler-Starts (pvs-studio-analyzer trace) verwendet werden.  Dazu m√ºssen Sie zun√§chst eine vollst√§ndige Montage des Projekts durchf√ºhren und verfolgen, damit der Analysator vollst√§ndige Informationen √ºber die Kompilierungsparameter aller getesteten Dateien sammelt. <br><br>  Diese Option hat jedoch einen erheblichen Nachteil: Sie m√ºssen entweder bei jedem Start eine vollst√§ndige Ablaufverfolgung der gesamten Projektbaugruppe erstellen, was der Idee einer schnellen √úberpr√ºfung des Commits widerspricht.  Wenn das Trace-Ergebnis selbst zwischengespeichert wird, ist der nachfolgende Start des Analysators m√∂glicherweise nicht abgeschlossen, wenn sich die Abh√§ngigkeitsstruktur der Quelldateien nach dem Trace √§ndert (z. B. wird einer der Quelldateien ein neues #include hinzugef√ºgt). <br><br>  Daher empfehlen wir nicht, den Dateilistenpr√ºfmodus mit dem Ablaufverfolgungsprotokoll zum √úberpr√ºfen von Commits oder Pull-Anforderungen zu verwenden.  Wenn Sie beim √úberpr√ºfen eines Commits eine inkrementelle Assemblierung durchf√ºhren k√∂nnen, sollten Sie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">inkrementellen Analysemodus verwenden</a> . <br><br>  Die Liste der zu analysierenden Quelldateien wird in einer Textdatei gespeichert und mit dem Parameter <i>-S</i> an den Analysator √ºbertragen: <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  In dieser Datei werden relative oder absolute Pfade zu den Dateien angegeben, und jede neue Datei sollte sich in einer neuen Zeile befinden.  Es ist zul√§ssig, nicht nur die Namen der zu analysierenden Dateien, sondern auch verschiedene Texte anzugeben.  Der Analysator erkennt, dass dies keine Datei ist, und ignoriert die Zeile.  Dies kann zum Kommentieren hilfreich sein, wenn Dateien manuell angegeben werden.  W√§hrend der Analyse in CI wird jedoch h√§ufig eine Liste von Dateien generiert. Dies k√∂nnen beispielsweise Dateien aus einer Festschreibungs- oder Pull-Anforderung sein. <br><br>  In diesem Modus k√∂nnen Sie jetzt schnell neuen Code √ºberpr√ºfen, bevor er in den Hauptentwicklungszweig gelangt.  Damit das Verifizierungssystem auf Warnungen des Analysators reagieren kann, wurde dem <i>Dienstprogramm</i> <i>plog-converter</i> das <i>Flag --indicate-warnings</i> hinzugef√ºgt: <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Mit diesem Flag gibt der Konverter einen Code ungleich Null zur√ºck, wenn der Analysatorbericht Warnungen enth√§lt.  Mit dem R√ºckkehrcode k√∂nnen Sie den Pre-Commit-Hook, die Commit- oder Pull-Anforderung blockieren und den generierten Analysebericht auf dem Bildschirm anzeigen, freigeben oder per E-Mail senden. <br><br>  <i>Hinweis</i>  <i>Wenn Sie zum ersten Mal eine Dateilistenanalyse ausf√ºhren, wird das gesamte Projekt analysiert, da</i>  <i>Der Analysator muss aus den Header-Dateien eine Datei mit Abh√§ngigkeiten der Projektquelldateien generieren.</i>  <i>Dies ist eine Funktion der Analyse von C- und C ++ - Dateien.</i>  <i>In Zukunft kann die Abh√§ngigkeitsdatei zwischengespeichert werden und wird vom Analysator automatisch aktualisiert.</i>  <i>Der Vorteil der √úberpr√ºfung von Commits bei Verwendung des Dateilisten√ºberpr√ºfungsmodus gegen√ºber der Verwendung des inkrementellen Analysemodus besteht darin, dass Sie nur diese Datei zwischenspeichern m√ºssen, nicht die Objektdateien.</i> <br><br><h2>  Allgemeine Prinzipien der Pull-Request-Analyse </h2><br>  Die Analyse des gesamten Projekts nimmt viel Zeit in Anspruch, daher ist es sinnvoll, nur einen bestimmten Teil davon zu √ºberpr√ºfen.  Das Problem ist, dass Sie die neuen Dateien von den √ºbrigen Projektdateien trennen m√ºssen. <br><br>  Betrachten Sie ein Beispiel f√ºr einen Festschreibungsbaum mit zwei Zweigen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Bild 5"></div><br><br>  Stellen wir uns vor, dass Commit <i>A1</i> eine ziemlich gro√üe Menge an Code enth√§lt, der bereits getestet wurde.  Etwas fr√ºher haben wir einen Zweig aus dem Commit <i>A1 erstellt</i> und einige Dateien ge√§ndert. <br><br>  Nat√ºrlich haben Sie bemerkt, dass es nach <i>A1</i> zwei weitere Commits gab, aber dies waren auch Fusionen anderer Niederlassungen, da wir keine <i>Master-</i> Commits durchf√ºhren.  Und jetzt ist die Zeit gekommen, in der der <i>Hotfix</i> fertig ist.  Daher erschien eine Pull-Anfrage f√ºr die Fusion von <i>B3</i> und <i>A3</i> . <br><br>  Nat√ºrlich k√∂nnte man das gesamte Ergebnis ihrer Fusion √ºberpr√ºfen, aber dies w√§re zu lang und ungerechtfertigt, da nur wenige Dateien ge√§ndert wurden.  Daher ist es effizienter, nur die ge√§nderten zu analysieren. <br><br>  Dazu erhalten wir den Unterschied zwischen den Zweigen, die sich im KOPF des Zweigs befinden, von dem aus wir zum Master verschmelzen m√∂chten: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  <i>$ MERGE_BASE werden</i> wir sp√§ter genauer betrachten.  Tatsache ist, dass nicht jeder CI-Dienst die erforderlichen Informationen √ºber die Grundlage f√ºr das Zusammenf√ºhren bereitstellt. Daher m√ºssen Sie jedes Mal neue Wege finden, um diese Daten abzurufen.  Dies wird nachstehend in jedem der beschriebenen Webdienste detailliert beschrieben. <br><br>  Wir haben also den Unterschied zwischen den Zweigen oder besser gesagt eine Liste der Dateinamen, die ge√§ndert wurden.  Jetzt m√ºssen wir die <i>.pvs-pr.list-Datei</i> (wir haben die Ausgabe oben darauf umgeleitet) an den Analysator √ºbergeben: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Nach der Analyse m√ºssen wir die Protokolldatei (PVS-Studio.log) in ein Format konvertieren, das leicht zu lesen ist: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Dieser Befehl listet Fehler in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">stderr</a> (Standard-Ausgabestream f√ºr Fehlermeldungen) auf. <br><br>  Erst jetzt m√ºssen wir nicht nur Fehler anzeigen, sondern auch unseren Service f√ºr die Montage und Pr√ºfung von Problemen informieren.  Zu diesem <i>Zweck</i> wurde dem Konverter das Flag <i>-W</i> ( <i>--indicate-warnings</i> ) hinzugef√ºgt.  Wenn mindestens eine Analysatorwarnung <i>vorliegt</i> , √§ndert sich der R√ºckkehrcode des <i>Plog-Converter-</i> Dienstprogramms in 2, wodurch der CI-Dienst √ºber m√∂gliche Fehler in den Pull-Anforderungsdateien informiert wird. <br><br><h2>  Travis ci </h2><br>  Die Konfiguration erfolgt als <i>.travis.yml-</i> Datei.  Der <i>Einfachheit</i> <i>halber</i> empfehle ich Ihnen, alles in ein separates Bash-Skript mit Funktionen zu stellen, die aus der Datei <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ) <i>aufgerufen werden</i> . <br><br>  Wir werden den erforderlichen Code zum <i>Bash-</i> Skript hinzuf√ºgen, damit wir mehr Funktionalit√§t erhalten.  Schreiben Sie im <i>Installationsabschnitt</i> Folgendes: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Wenn Sie Anweisungen hatten, k√∂nnen Sie diese durch Entfernen von Bindestrichen in das Skript √ºbertragen. <br><br>  √ñffnen Sie die Datei <i>.travis.sh</i> und f√ºgen Sie die <i>Analyse-</i> Installation zur Funktion <i>travis_install () hinzu</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  F√ºgen Sie nun den Analyselauf zum <i>Skriptabschnitt hinzu</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  Und im Bash-Skript: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Dieser Code muss nach dem Erstellen des Projekts ausgef√ºhrt werden, wenn Sie beispielsweise CMake erstellt haben: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Es wird sich so herausstellen: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Sie haben wahrscheinlich bereits die angegebenen Umgebungsvariablen <i>$ TRAVIS_PULL_REQUEST</i> und <i>$ TRAVIS_BRANCH bemerkt</i> .  Travis CI k√ºndigt sie selbst an: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> speichert die Pull- <i>Anforderungsnummer</i> oder <i>false,</i> wenn es sich um eine regul√§re Verzweigung handelt. </li><li>  <i>$ TRAVIS_REPO_SLUG</i> speichert den Namen des Projekt-Repositorys. </li></ul><br>  Der Algorithmus dieser Funktion: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9e2/d21/1c5/9e2d211c559a48b4bf144bdd606e4bc7.png" alt="Bild 7"></div><br>  Travis CI reagiert auf R√ºckkehrcodes, sodass das Vorhandensein von Warnungen den Dienst anweist, das Commit als fehlerhaft zu markieren. <br><br>  Schauen wir uns nun diese Codezeile genauer an: <br><br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  Tatsache ist, dass Travis CI Zweige w√§hrend der Pull-Anforderungsanalyse automatisch zusammenf√ºhrt: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Bild 8"></div><br>  Daher analysieren wir <i>A4</i> , nicht <i>B3-&gt; A3</i> .  Aufgrund dieser Funktion m√ºssen wir die Differenz mit <i>A3</i> berechnen, das genau die Spitze des Zweigs vom <i>Ursprung ist</i> . <br><br>  Ein wichtiges Detail blieb - das Zwischenspeichern von Abh√§ngigkeiten von Header-Dateien von kompilierten √úbersetzungseinheiten (* .c, * .cc, * .cpp usw.).  Der Analysator berechnet diese Abh√§ngigkeiten beim ersten Start im √úberpr√ºfungsmodus der Dateiliste und speichert sie dann im Verzeichnis .PVS-Studio.  Mit Travis CI k√∂nnen Sie Ordner zwischenspeichern, sodass wir die Daten des <i>Verzeichnisses .PVS-Studio / speichern</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Dieser Code muss zur Datei <i>.travis.yml</i> hinzugef√ºgt werden.  In diesem Verzeichnis werden verschiedene Daten gespeichert, die nach der Analyse erfasst wurden. Dies beschleunigt den sp√§teren Start der Dateilistenanalyse oder der inkrementellen Analyse erheblich.  Ist dies nicht der Fall, analysiert der Analysator jedes Mal alle Dateien. <br><br><h2>  Kumpel </h2><br>  Wie Travis CI bietet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Buddy</a> die M√∂glichkeit, Projekte, die auf GitHub gespeichert sind, automatisch zu erstellen und zu testen.  Im Gegensatz zu Travis CI wird es √ºber die Weboberfl√§che konfiguriert (Bash-Unterst√ºtzung ist verf√ºgbar), sodass keine Konfigurationsdateien im Projekt gespeichert werden m√ºssen. <br><br>  Zun√§chst m√ºssen wir dem Flie√üband eine neue Aktion hinzuf√ºgen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Bild 1"></div><br>  Wir geben den Compiler an, mit dem das Projekt erstellt wurde.  Achten Sie auf den Docker-Container, der in dieser Aktion installiert ist.  Zum Beispiel gibt es einen speziellen Container f√ºr GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Bild 6"></div><br>  Installieren Sie nun PVS-Studio und die erforderlichen Dienstprogramme: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Bild 2"></div><br>  F√ºgen Sie dem Editor die folgenden Zeilen hinzu: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Gehen Sie nun zur Registerkarte Ausf√ºhren (erstes Symbol) und f√ºgen Sie den folgenden Code in das entsprechende Feld des Editors ein: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Wenn Sie den Abschnitt √ºber Travs-CI lesen, ist Ihnen dieser Code bereits bekannt. Jetzt ist jedoch eine neue Phase erschienen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/615/40f/ec9/61540fec9bc7edf2032a84bdaf5a28fe.png" alt="Bild 9"></div><br>  Tatsache ist, dass wir jetzt nicht das Ergebnis der Fusion analysieren, sondern den HEAD des Zweigs, von dem aus die Pull-Anfrage gestellt wird: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Bild 10"></div><br>  Daher befinden wir uns im bedingten Commit <i>B3</i> und m√ºssen den Unterschied zu <i>A3 ermitteln</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Verwenden Sie die GitHub-API, um <i>A3</i> zu bestimmen: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Wir haben die folgenden Variablen verwendet, die Buddy bereitstellt: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - <i>Anforderungsnummer</i> ziehen; </li><li>  <i>$ BUDDY_REPO_SLUG</i> - Kombination aus Benutzername und Repository (zum Beispiel max / test). </li></ul><br>  Speichern Sie nun die √Ñnderungen √ºber die Schaltfl√§che unten und aktivieren Sie die Pull-Anforderungsanalyse: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Bild 3"></div><br>  Im Gegensatz zu Travis CI m√ºssen wir <i>.pvs-studio nicht</i> f√ºr das Caching angeben, da Buddy automatisch alle Dateien f√ºr nachfolgende Starts zwischenspeichert.  Daher m√ºssen Sie als letztes den Login und das Passwort f√ºr PVS-Studio in Buddy speichern.  Nach dem Speichern der √Ñnderungen kehren wir zur Pipeline zur√ºck.  Wir m√ºssen mit dem Einrichten der Variablen fortfahren und den Login und den Schl√ºssel f√ºr PVS-Studio hinzuf√ºgen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Bild 4"></div><br>  Danach l√∂st das Erscheinen einer neuen Pull-Anforderung oder eines neuen Commits eine Pr√ºfung aus.  Wenn das Commit Fehler enth√§lt, gibt Buddy dies auf der Pull-Anforderungsseite an. <br><br><h2>  F√∂rderer </h2><br>  Das AppVeyor-Setup √§hnelt Buddy, da alles in der Weboberfl√§che geschieht und keine * .yml-Datei zum Projekt-Repository hinzugef√ºgt werden muss. <br><br>  Gehen Sie in der Projekt√ºbersicht zur Registerkarte Einstellungen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Bild 12"></div><br>  Scrollen Sie auf dieser Seite nach unten und aktivieren Sie das Speichern des Caches, um Pull-Anforderungen zu erstellen: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Bild 18"></div><br>  Wechseln Sie nun zur Registerkarte Umgebung, auf der wir das Image f√ºr die Assembly und die erforderlichen Umgebungsvariablen angeben: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Bild 19"></div><br>  Wenn Sie die vorherigen Abschnitte gelesen haben, sind Sie mit diesen beiden Variablen - <i>PVS_KEY</i> und <i>PVS_USERNAME</i> - <i>gut</i> <i>vertraut</i> .  Wenn nicht, erinnere ich Sie daran, dass sie zur √úberpr√ºfung der Lizenz des PVS-Studio-Analysators erforderlich sind.  In Zukunft werden wir sie in Bash-Skripten wieder sehen. <br><br>  Auf derselben Seite unten geben wir den Ordner f√ºr das Caching an: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Bild 15"></div><br>  Wenn wir dies nicht tun, analysieren wir das gesamte Projekt anstelle eines Dateipaares, erhalten jedoch die Ausgabe aus den angegebenen Dateien.  Daher ist es wichtig, den richtigen Verzeichnisnamen einzugeben. <br><br>  Jetzt ist es Zeit f√ºr das Skript zu √ºberpr√ºfen.  √ñffnen Sie die Registerkarte Tests und w√§hlen Sie Skript: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Bild 20"></div><br>  F√ºgen Sie den folgenden Code in dieses Formular ein: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Beachten Sie den folgenden Teil des Codes: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  Die ziemlich spezifische Zuordnung des Werts des Befehls pwd zu der Variablen, die diesen Standardwert speichern soll, erscheint auf den ersten Blick seltsam, ich werde jedoch jetzt alles erkl√§ren. <br><br>  Bei der Konfiguration des Analysators in AppVeyor bin ich auf ein √§u√üerst seltsames Verhalten des Analysators gesto√üen.  Einerseits hat alles richtig funktioniert, aber die Analyse hat nicht begonnen.  Ich habe viel Zeit damit verbracht zu bemerken, dass wir uns im Verzeichnis / home / appveyor / projects / testcalc / befinden und der Analysator sicher ist, dass wir uns in / opt / appveyor / build-agent / befinden.  Dann wurde mir klar, dass die Variable $ PWD ein wenig l√ºgt.  Aus diesem Grund habe ich den Wert vor dem Start der Analyse manuell aktualisiert. <br><br>  Und dann alles wie bisher: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/4b9/a33/0aa4b9a3398ce2f52cc8e1df0833f459.png" alt="Bild 17"></div><br>  Betrachten Sie nun den folgenden Ausschnitt: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  Darin erhalten wir die Differenz zwischen den Zweigen, √ºber die die Pull-Anforderung deklariert wird.  Dazu ben√∂tigen wir folgende Umgebungsvariablen: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - Nummer der Pull-Anfrage; </li><li>  $ APPVEYOR_REPO_NAME - Projektbenutzername und Repository. </li></ul><br><h2>  Fazit </h2><br>  Nat√ºrlich haben wir nicht alle m√∂glichen Dienste einer kontinuierlichen Integration in Betracht gezogen, aber alle haben sehr √§hnliche Arbeitsspezifikationen.  Mit Ausnahme des Caching stellt jeder Dienst sein eigenes ‚ÄûFahrrad‚Äú her, sodass immer alles anders ist. <br><br>  Irgendwo, wie in Travis-CI, funktionieren ein paar Zeilen Code und Caching einwandfrei.  Irgendwo, wie in AppVeyor, m√ºssen Sie nur den Ordner in den Einstellungen angeben.  Aber irgendwo m√ºssen Sie eindeutige Schl√ºssel erstellen und versuchen, das System davon zu √ºberzeugen, dass Sie das zwischengespeicherte Fragment √ºberschreiben k√∂nnen.  Wenn Sie daher die Analyse von Pull-Anforderungen f√ºr den Continuous Integration Service konfigurieren m√∂chten, die oben nicht erl√§utert wurde, stellen Sie zun√§chst sicher, dass Sie keine Probleme mit dem Caching haben. <br><br>  Vielen Dank f√ºr Ihre Aufmerksamkeit.  Wenn etwas nicht funktioniert, k√∂nnen Sie sich gerne an uns wenden.  Wir werden umgehend bitten und helfen. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Wenn Sie diesen Artikel einem englischsprachigen Publikum zug√§nglich machen m√∂chten, verwenden Sie bitte den Link zur √úbersetzung: Maxim Zvyagintsev.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Analyse von Commits und Pull-Anfragen in Travis CI, Buddy und AppVeyor mit PVS-Studio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de470984/">https://habr.com/ru/post/de470984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de470974/index.html">Passives DNS in den H√§nden des Analysten</a></li>
<li><a href="../de470976/index.html">Song of Ice (Bloody Enterprise) und Flames (DevOps und IaC)</a></li>
<li><a href="../de470978/index.html">Analysten-Marktforschung: Wo studieren sie, welche Tools verwenden sie und wie viel verdienen sie?</a></li>
<li><a href="../de470980/index.html">Die Aufgaben, die Softwareroboter (RPAs) im Bankensektor l√∂sen</a></li>
<li><a href="../de470982/index.html">Analyse von Commits und Pull-Anfragen in Travis CI, Buddy und AppVeyor mit PVS-Studio</a></li>
<li><a href="../de470988/index.html">Die Registrierung f√ºr Slerm DevOps in Moskau ist offen</a></li>
<li><a href="../de470990/index.html">Online-Marketing-Toolkit: 3 Apps zur Verbesserung der visuellen Kommunikation</a></li>
<li><a href="../de470994/index.html">JavaScript-Vererbung aus der Sicht eines gelangweilten Nerds: Constructors Factory</a></li>
<li><a href="../de470996/index.html">Wie kann ein einfaches <img> -Tag ein hohes Risiko f√ºr ein Unternehmen darstellen?</a></li>
<li><a href="../de470998/index.html">Holzspielzeug, Teil 10 - 1996</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>