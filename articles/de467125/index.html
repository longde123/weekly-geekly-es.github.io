<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí® üç≤ üßôüèª Modernes NES-Spiel in einer Lisp-√§hnlichen Sprache üë©üèæ‚Äçü§ù‚Äçüë®üèø üßöüèæ üòê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What Remains ist ein narratives Abenteuerspiel f√ºr die 8-Bit-Videospielkonsole NES, das im M√§rz 2019 als kostenloses ROM im Emulator ver√∂ffentlicht wu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modernes NES-Spiel in einer Lisp-√§hnlichen Sprache</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467125/">  What Remains ist ein narratives Abenteuerspiel f√ºr die 8-Bit-Videospielkonsole NES, das im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">M√§rz 2019</a> als kostenloses ROM im Emulator ver√∂ffentlicht wurde.  Es wurde von einem kleinen Team von Iodine Dynamics f√ºr zwei Jahre mit Unterbrechungen erstellt.  Im Moment befindet sich das Spiel in der Implementierungsphase der Hardware: Wir erstellen einen begrenzten Satz von Patronen aus recycelten Teilen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db4/d1a/663/db4d1a6633208845a7e7ce5d670d82ac.jpg"></div><br>  Das Spiel hat 6 Level, auf denen der Spieler mehrere Szenen mit Vier-Wege-Scrolling-Karten durchl√§uft, mit dem NPC kommuniziert, Hinweise sammelt, seine Welt kennenlernt, Minispiele spielt und einfache R√§tsel l√∂st.  Ich war der Chefingenieur des Projekts und hatte daher viele Schwierigkeiten, die Vision des Teams zu verwirklichen.  Angesichts der schwerwiegenden Einschr√§nkungen der NES-Ausr√ºstung ist es ziemlich schwierig, ein Spiel daf√ºr zu erstellen, ganz zu schweigen von einem Projekt mit so viel Inhalt wie in What Remains.  Nur dank der erstellten n√ºtzlichen Subsysteme, mit denen wir diese Komplexit√§t verbergen und verwalten k√∂nnen, konnten wir als Team arbeiten und das Spiel abschlie√üen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/956/a4d/921/956a4d9217a209643bb35b68e25694b5.png"></div><br>  In diesem Artikel werde ich √ºber einige technische Details einzelner Teile der Spiel-Engine sprechen.  Ich hoffe, dass andere Entwickler sie n√ºtzlich oder zumindest neugierig finden. <br><a name="habracut"></a><br><h2>  NES-Ausr√ºstung </h2><br>  Bevor Sie mit dem Code beginnen, werde ich Ihnen ein wenig √ºber die Spezifikationen der Ger√§te erz√§hlen, mit denen wir arbeiten.  NES ist eine Spielekonsole, die 1983 ver√∂ffentlicht wurde (Japan, 1985 - Amerika).  Im Inneren befindet sich eine 8-Bit-CPU 6502 [1] mit einer Frequenz von 1,79 MHz.  Da die Konsole 60 Frames pro Sekunde produziert, werden ungef√§hr 30.000 CPU-Zyklen pro Frame zugewiesen, und dies ist ziemlich klein, um alles zu berechnen, was im Hauptspielzyklus passiert. <br><br>  Dar√ºber hinaus verf√ºgt die Konsole √ºber insgesamt 2048 Byte RAM (die mit zus√§tzlichem RAM auf 10.240 Byte erweitert werden k√∂nnen, was wir nicht getan haben).  Es kann auch jeweils 32 KB ROM adressieren, was durch Bankwechsel erweitert werden kann (What Remains verwendet 512 KB ROM).  Das Wechseln von Banken ist ein komplexes Thema [2], mit dem sich moderne Programmierer nicht befassen.  Kurz gesagt, der der CPU zur Verf√ºgung stehende Adressraum ist kleiner als die im ROM enthaltenen Daten, dh wenn manuell geschaltet wird, bleiben ganze Speicherbl√∂cke unzug√§nglich.  Wollten Sie eine Funktion aufrufen?  Erst wenn Sie die Bank durch Aufrufen des Bankwechselbefehls ersetzen.  Wenn dies nicht getan wird, st√ºrzt das Programm ab, wenn die Funktion aufgerufen wird. <br><br>  Tats√§chlich ist es bei der Entwicklung eines Spiels f√ºr NES am schwierigsten, all dies gleichzeitig zu ber√ºcksichtigen.  Das Optimieren eines Aspekts des Codes, z. B. der Speichernutzung, kann h√§ufig andere Auswirkungen haben, z. B. die CPU-Leistung.  Der Code sollte effektiv sein und gleichzeitig eine bequeme Unterst√ºtzung bieten.  Normalerweise wurden Spiele in Assemblersprache programmiert. <br><br><h2>  CO2 </h2><br>  Aber in unserem Fall war es nicht so.  Stattdessen h√§tte ein Tandem mit dem Spiel eine eigene Sprache entwickelt.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Co2</a> ist eine Lisp-√§hnliche Sprache, die auf dem Racket-Schema basiert und in Assembler 6502 kompiliert wurde. Urspr√ºnglich wurde die Sprache von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dave Griffiths erstellt</a> , um die What Remains-Demo zu erstellen, und ich habe beschlossen, sie f√ºr das gesamte Projekt zu verwenden. <br><br>  Mit Co2 k√∂nnen Sie bei Bedarf integrierten Assembler-Code schreiben, es verf√ºgt jedoch auch √ºber allgemeine Funktionen, die einige Aufgaben vereinfachen.  Es implementiert lokale Variablen, die sowohl hinsichtlich des RAM-Verbrauchs als auch der Zugriffsgeschwindigkeit wirksam sind [2].  Es verf√ºgt √ºber ein sehr einfaches Makrosystem, mit dem Sie lesbaren und gleichzeitig effizienten Code schreiben k√∂nnen [3].  Aufgrund der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Homokonizit√§t von</a> Lisp wird die Anzeige von Daten direkt in der Quelle erheblich vereinfacht. <br><br>  Das Schreiben eigener Tools ist in der Spieleentwicklung weit verbreitet, das Erstellen einer vollst√§ndigen Programmiersprache ist jedoch weitaus seltener.  Wir haben es jedoch geschafft.  Es ist nicht sehr klar, ob sich die Komplexit√§t der Entwicklung und Unterst√ºtzung von CO2 bew√§hrt hat, aber es hatte definitiv Vorteile, die uns geholfen haben.  In dem Beitrag werde ich nicht im Detail auf die Arbeit von Co2 eingehen (dies verdient einen separaten Artikel), aber ich werde es st√§ndig erw√§hnen, da seine Verwendung ziemlich eng mit dem Entwicklungsprozess verkn√ºpft ist. <br><br>  Hier ist ein Beispiel f√ºr einen Co2-Code, der den Hintergrund f√ºr eine Szene zeichnet, die gerade geladen wurde, bevor sie gedimmt wird: <br><br><pre><code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Render the nametable for the scene at the camera position (defsub (create-initial-world) (camera-assign-cursor) (set! camera-cursor (+ camera-cursor 60)) (let ((preserve-camera-v)) (set! preserve-camera-v camera-v) (set! camera-v 0) (loop i 0 60 (set! delta-v #xff) (update-world-graphics) (when render-nt-span-has (set! render-nt-span-has #f) (apply-render-nt-span-buffer)) (when render-attr-span-has (set! render-attr-span-has #f) (apply-render-attr-span-buffer))) (set! camera-v preserve-camera-v)) (camera-assign-cursor))</span></span></code> </pre> <br><h2>  Entit√§tssystem </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee6/d87/ad4/ee6d87ad406879dbc9433c61fa4e3a5b.png"></div><br>  Jedes Echtzeitspiel, das komplexer als Tetris ist, ist von Natur aus ein "System von Entit√§ten".  Dies ist eine Funktionalit√§t, die es verschiedenen unabh√§ngigen Akteuren erm√∂glicht, gleichzeitig zu handeln und f√ºr ihren eigenen Zustand verantwortlich zu sein.  Obwohl What Remains keineswegs ein aktives Spiel ist, gibt es immer noch viele unabh√§ngige Akteure mit komplexem Verhalten: Sie animieren und rendern sich selbst, suchen nach Kollisionen und verursachen Dialoge. <br><br>  Die Implementierung ist recht typisch: Ein gro√ües Array enth√§lt eine Liste von Entit√§ten in der Szene, jeder Datensatz enth√§lt entit√§tsbezogene Daten sowie eine Typbezeichnung.  Die Aktualisierungsfunktion im Hauptspielzyklus umgeht alle Entit√§ten und implementiert das entsprechende Verhalten je nach Typ. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Called once per frame, to update each entity (defsub (update-entities) (when (not entity-npc-num) (return)) (loop k 0 entity-npc-num (let ((type)) (set! type (peek entity-npc-data (+ k entity-field-type))) (when (not (eq? type #xff)) (update-single-entity k type)))))</span></span></code> </pre> <br>  Interessanter ist die Art und Weise, wie Entit√§tsdaten gespeichert werden.  Im Allgemeinen hat das Spiel so viele einzigartige Einheiten, dass die Verwendung einer gro√üen Anzahl von ROMs zu einem Problem werden kann.  Hier zeigt Co2 seine Kraft und erm√∂glicht es uns, jede Essenz der Szene in einer pr√§zisen, aber lesbaren Form darzustellen - als Strom von Schl√ºssel-Wert-Paaren.  Zus√§tzlich zu Daten wie der Anfangsposition ist fast jeder Schl√ºssel optional, sodass sie nur bei Bedarf f√ºr Entit√§ten deklariert werden k√∂nnen. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">bytes</span></span> npc-diner-a <span class="hljs-number"><span class="hljs-number">172</span></span> <span class="hljs-number"><span class="hljs-number">108</span></span> prop-palette <span class="hljs-number"><span class="hljs-number">1</span></span> prop-hflip prop-picture picture-smoker-c prop-animation simple-cycle-animation prop-anim-limit <span class="hljs-number"><span class="hljs-number">6</span></span> prop-head hair-flip-head-tile <span class="hljs-number"><span class="hljs-number">2</span></span> prop-dont-turn-around prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-4 on-my-third my-dietician) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-3 have-you-tried-the-pasta the-real-deal) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-diner-is-clean omg-this-cherry-pie its-like-a-party) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-1 cant-taste-food puff-poof) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-4 tea-party-is-not) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-3 newspaper-owned-by-dnycorp) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-2 they-paid-a-pr-guy) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-1 it-seems-difficult) prop-customize (<span class="hljs-name"><span class="hljs-name">progress-stage-2</span></span> stop-smoking) <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  In diesem Code legt die <code>prop-palette</code> die Farbpalette fest, die f√ºr die Entit√§t verwendet wird, die <code>prop-anim-limit</code> legt die Anzahl der Animationsrahmen fest und die <code>prop-dont-turn-around</code> verhindert, dass sich der NPC dreht, wenn der Spieler versucht, von der anderen Seite mit ihm zu sprechen.  Au√üerdem werden einige Bedingungen gesetzt, die das Verhalten der Entit√§t beim Weitergeben des Spiels durch den Spieler √§ndern. <br><br>  Diese Art der Pr√§sentation ist f√ºr die Speicherung im ROM sehr effektiv, beim Zugriff zur Laufzeit jedoch sehr langsam und f√ºr das Gameplay zu ineffizient.  Wenn ein Spieler eine neue Szene betritt, werden daher alle Objekte in dieser Szene in den RAM geladen und verarbeiten alle Bedingungen, die sich auf ihren Ausgangszustand auswirken k√∂nnen.  Sie k√∂nnen jedoch keine Details f√ºr jede Entit√§t herunterladen, da dies mehr RAM beanspruchen w√ºrde, als verf√ºgbar ist.  Die Engine l√§dt nur das Notwendigste f√ºr jede Entit√§t sowie einen Zeiger auf ihre vollst√§ndige Struktur im ROM, der in Situationen wie der Behandlung von Dialogen dereferenziert wird.  Diese spezifischen Kompromisse erm√∂glichten es uns, ein ausreichendes Leistungsniveau bereitzustellen. <br><br><h2>  Portale </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c41/9dd/b90/c419ddb90349fbfb890c935e15bdfb95.png"></div><br>  Das Spiel What Remains hat viele verschiedene Orte, mehrere Szenen auf der Stra√üe mit scrollenden Karten und viele Szenen in R√§umen, die statisch bleiben.  Um von einem zum anderen zu wechseln, m√ºssen Sie feststellen, dass der Spieler den Ausgang erreicht hat, eine neue Szene laden und den Spieler dann an der gew√ºnschten Stelle platzieren.  In den fr√ºhen Entwicklungsstadien wurden solche √úberg√§nge auf einzigartige Weise als zwei miteinander verbundene Szenen beschrieben, z. B. ‚ÄûErste Stadt‚Äú und ‚ÄûCaf√©‚Äú, und Daten in der if-Anweisung √ºber die Position der T√ºren in jeder Szene.  Um zu bestimmen, wo der Spieler nach dem √Ñndern der Szene platziert werden soll, mussten Sie nur √ºberpr√ºfen, woher er kam und wohin, und ihn neben dem entsprechenden Ausgang platzieren. <br><br>  Als wir jedoch begannen, die Szene der ‚Äûzweiten Stadt‚Äú zu f√ºllen, die an zwei verschiedenen Orten mit der ersten Stadt verbunden ist, begann ein solches System auseinanderzufallen.  Pl√∂tzlich passt das Paar <code>(_, _)</code> nicht mehr.  Nachdem wir dar√ºber nachgedacht hatten, stellten wir fest, dass die Verbindung selbst wirklich wichtig ist, was im Spielcode das ‚ÄûPortal‚Äú nennt.  Um diesen √Ñnderungen Rechnung zu tragen, wurde die Engine neu geschrieben.  was uns zu einer entit√§ts√§hnlichen Situation f√ºhrte.  Portale k√∂nnten Listen von Schl√ºssel-Wert-Paaren speichern und am Anfang der Szene laden.  Beim Betreten des Portals k√∂nnen Sie dieselben Positionsinformationen wie beim Verlassen des Portals verwenden.  Dar√ºber hinaus wurde das Hinzuf√ºgen von Bedingungen vereinfacht, √§hnlich wie bei den Entit√§ten: An bestimmten Punkten im Spiel konnten wir Portale √§ndern, z. B. T√ºren √∂ffnen oder schlie√üen. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; City A (bytes city-a-scene #x50 #x68 look-up portal-customize (progress-stage-5 remove-self) ; to Diner diner-scene #xc0 #xa0 look-down portal-width #x20 0)</span></span></code> </pre> <br>  Es vereinfachte auch das Hinzuf√ºgen von ‚ÄûTeleportationspunkten‚Äú, die h√§ufig in Filmbeilagen verwendet wurden, bei denen der Spieler je nach Geschehen in der Handlung zu einem anderen in der Szene wechseln musste. <br><br>  So sieht Teleportation zu Beginn von Level 3 aus: <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Jenny's home (bytes jenny-home-scene #x60 #xc0 look-up portal-teleport-only jenny-back-at-home-teleport 0)</span></span></code> </pre> <br>  Achten Sie auf den <code>look-up</code> , der die Richtung f√ºr den "Eingang" zu diesem Portal angibt.  Beim Verlassen des Portals schaut der Spieler in die andere Richtung.  In diesem Fall ist Jenny (die Hauptfigur des Spiels) zu Hause, w√§hrend sie nach unten schaut. <br><br><h2>  Textblock </h2><br>  Das Rendern eines Textblocks erwies sich als einer der komplexesten Codeteile im gesamten Projekt.  Die grafischen Einschr√§nkungen von NES sind zum Trick gezwungen.  Zun√§chst verf√ºgt NES nur √ºber eine Ebene f√ºr Grafikdaten. Um also Speicherplatz f√ºr einen Textblock freizugeben, m√ºssen Sie einen Teil der Karte vor dem Hintergrund l√∂schen und nach dem Schlie√üen des Textblocks wiederherstellen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b8/7a5/d6f/6b87a5d6f4f44f8eb4fa9cf3b3242392.png"></div><br>  Dar√ºber hinaus muss die Palette f√ºr jede einzelne Szene Schwarzwei√üfarben zum Rendern des Texts enthalten, was dem K√ºnstler zus√§tzliche Einschr√§nkungen auferlegt.  Um Farbkonflikte mit dem Rest des Hintergrunds zu vermeiden, sollte der Textblock am 16 √ó 16-Raster ausgerichtet sein [5].  Das Zeichnen eines Textblocks in einer Szene mit einem Raum ist viel einfacher als in einer Stra√üe, in der sich die Kamera bewegen kann, da in diesem Fall Grafikpuffer ber√ºcksichtigt werden m√ºssen, die vertikal und horizontal scrollen.  Schlie√ülich ist die Pausenbildschirmmeldung ein leicht modifiziertes Standarddialogfeld, da sie unterschiedliche Informationen anzeigt, aber fast denselben Code verwendet. <br><br>  Nach einer unendlichen Anzahl fehlerhafter Versionen des Codes gelang es mir schlie√ülich, eine L√∂sung zu finden, bei der die Arbeit in zwei Phasen unterteilt ist.  Zun√§chst werden alle Berechnungen durchgef√ºhrt, die bestimmen, wo und wie der Textblock gezeichnet werden soll, einschlie√ülich des Verarbeitungscodes f√ºr alle Grenzf√§lle.  Somit werden all diese Schwierigkeiten an einen Ort gebracht. <br><br>  Dann wird ein Textblock mit Zustandserhaltung zeilenweise gezeichnet und die Berechnungen aus der ersten Stufe werden verwendet, um den Code nicht zu komplizieren. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Called once per frame as the text box is being rendered (defsub (text-box-update) (when (or (eq? tb-text-mode 0) (eq? tb-text-mode #xff)) (return #f)) (cond [(in-range tb-text-mode 1 4) (if (not is-paused) ; Draw text box for dialog. (text-box-draw-opening (- tb-text-mode 1)) ; Draw text box for pause. (text-box-draw-pausing (- tb-text-mode 1))) (inc tb-text-mode)] [(eq? tb-text-mode 4) ; Remove sprites in the way. (remove-sprites-in-the-way) (inc tb-text-mode)] [(eq? tb-text-mode 5) (if (not is-paused) ; Display dialog text. (when (not (crawl-text-update)) (inc tb-text-mode) (inc tb-text-mode)) ; Display paused text. (do (create-pause-message) (inc tb-text-mode)))] [(eq? tb-text-mode 6) ; This state is only used when paused. Nothing happens, and the caller ; has to invoke `text-box-try-exiting-pause` to continue. #t] [(and (&gt;= tb-text-mode 7) (&lt; tb-text-mode 10)) ; Erase text box. (if (is-scene-outside scene-id) (text-box-draw-closing (- tb-text-mode 7)) (text-box-draw-restoring (- tb-text-mode 7))) (inc tb-text-mode)] [(eq? tb-text-mode 10) ; Reset state to return to game. (set! text-displaying #f) (set! tb-text-mode 0)]) (return #t))</span></span></code> </pre> <br>  Wenn Sie sich an den Lisp-Stil gew√∂hnt haben, wird der Code ganz bequem gelesen. <br><br><h2>  Sprite Z-Schichten </h2><br>  Am Ende werde ich √ºber ein kleines Detail sprechen, das das Gameplay nicht besonders beeinflusst, aber eine nette Geste hinzuf√ºgt, auf die ich stolz bin.  NES besteht nur aus zwei grafischen Komponenten: einer Namenstabelle (Namenstabelle), die f√ºr statische und gitterausgerichtete Hintergr√ºnde verwendet wird, und Sprites - Objekte mit einer Gr√∂√üe von 8 x 8 Pixel, die an beliebigen Stellen platziert werden k√∂nnen.  Elemente wie der Charakter des Spielers und NPCs werden normalerweise als Sprites erstellt, wenn sie √ºber den Grafiken der Namenstabelle stehen sollen. <br><br>  NES-Ger√§te bieten jedoch auch die M√∂glichkeit, einen Teil der Sprites anzugeben, die vollst√§ndig unter der Namenstabelle platziert werden k√∂nnen.  Auf diese Weise k√∂nnen Sie m√ºhelos einen coolen 3D-Effekt erzielen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c6/4e0/c48/1c64e0c481f82d2b6569aa6326ea00a1.png"></div><br>  Es funktioniert wie folgt: Die f√ºr die aktuelle Szene verwendete Palette behandelt die Farbe an Position 0 auf besondere Weise: Es handelt sich um die globale Hintergrundfarbe.  Dar√ºber wird eine Namenstabelle gezeichnet, und Sprites mit einer Z-Ebene werden zwischen zwei anderen Ebenen gezeichnet. <br><br>  Hier ist die Palette dieser Szene: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23c/2c6/391/23c2c6391ae6301f9b527259250ee0e5.png"></div><br>  Daher wird die dunkelgraue Farbe in der linken Ecke als globale Hintergrundfarbe verwendet. <br><br>  Die Wirkung von Ebenen funktioniert wie folgt: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d30/0ae/f89/d300aef890a928421a48d94968a263f9.png"></div><br>  In den meisten anderen Spielen endet dies alles, jedoch hat What Remains einen weiteren Schritt nach vorne gemacht.  Das Spiel platziert Jenny nicht vollst√§ndig vor oder unter den Grafiken der Namenstabelle - ihr Charakter wird auf die richtige Weise zwischen ihnen aufgeteilt.  Wie Sie sehen k√∂nnen, sind Sprites 8 x 8 Einheiten gro√ü und die Grafiken des gesamten Charakters bestehen aus mehreren Sprites (von 3 bis 6, abh√§ngig vom Animationsrahmen).  Jedes Sprite kann eine eigene Z-Ebene festlegen. Das hei√üt, einige Sprites befinden sich vor der Namenstabelle, andere dahinter. <br><br>  Hier ist ein Beispiel f√ºr diesen Effekt in Aktion: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86b/3a3/ae5/86b3a3ae58931ef34d44640d7ff4c449.png"></div><br>  Der Algorithmus zur Implementierung dieses Effekts ist ziemlich schwierig.  Zun√§chst werden Kollisionsdaten untersucht, die den Spieler umgeben, insbesondere Kacheln, f√ºr deren Zeichnen m√∂glicherweise ein ganzer Charakter erforderlich ist.  In diesem Diagramm werden durchgezogene Kacheln in roten Quadraten angezeigt, und gelbe Kacheln geben den Teil mit der Z-Schicht an. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10d/162/38c/10d16238cc137b14b8719479624f7245.png"></div><br>  Mithilfe verschiedener Heuristiken werden sie kombiniert, um einen ‚ÄûReferenzpunkt‚Äú und eine Bitmaske aus vier Bits zu erstellen.  Vier Quadranten relativ zum Referenzpunkt entsprechen vier Bits: 0 bedeutet, dass sich der Spieler vor der Namenstabelle 1 befinden muss, die sich dahinter befindet. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccb/3a4/ff9/ccb3a4ff911243e0e771c3bd64e10134.png"></div><br>  Wenn Sie einzelne Sprites zum Rendern des Players platzieren, wird deren Position mit dem Referenzpunkt verglichen, um die Z-Ebene dieses bestimmten Sprites zu bestimmen.  Einige von ihnen befinden sich in der vorderen Schicht, andere in der hinteren. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ee/f36/273/0eef362737679bb6483465264ada9ba4.png"></div><br><h2>  Fazit </h2><br>  Ich habe kurz √ºber die verschiedenen Aspekte des Innenlebens unseres neuen modernen Retro-Spiels gesprochen.  Die Codebasis ist viel interessanter, aber ich habe einen wesentlichen Teil dessen beschrieben, was das Spiel zum Funktionieren bringt. <br><br>  Die wichtigste Lektion, die ich aus diesem Projekt gelernt habe, sind die Vorteile, die datengesteuerte Engines erzielen k√∂nnen.  Mehrmals gelang es mir, eine eindeutige Logik durch eine Tabelle und einen Mini-Interpreter zu ersetzen, und dank dessen wurde der Code einfacher und lesbarer. <br><br>  Ich hoffe dir hat der Artikel gefallen! <br><br><hr><br><h3>  Anmerkungen </h3><br>  [1] Genau genommen wurde in NES eine Art CPU 6502 namens Ricoh 2A03 installiert. <br><br>  [2] Tats√§chlich hat mich dieses Projekt √ºberzeugt, dass das Wechseln von Banken / Verwalten von ROMs die Hauptbeschr√§nkung f√ºr jedes NES-Projekt darstellt, das eine bestimmte Gr√∂√üe √ºberschreitet. <br><br>  [3] Daf√ºr sollte man sich beim ‚ÄûCompiled Stack‚Äú bedanken - einem Konzept, das bei der Programmierung eingebetteter Systeme verwendet wird, obwohl ich kaum Literatur dar√ºber gefunden habe.  Kurz gesagt, Sie m√ºssen ein vollst√§ndiges Diagramm der Projektaufrufe erstellen, es von den Blattknoten bis zum Stamm sortieren und dann jedem Knoten einen Speicher zuweisen, der seinen Anforderungen + der maximalen Anzahl von untergeordneten Knoten entspricht. <br><br>  [4] Makros wurden in relativ sp√§ten Entwicklungsstadien hinzugef√ºgt, und ehrlich gesagt konnten wir sie nicht besonders nutzen. <br><br>  [5] Weitere Informationen zu NES-Grafiken finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">meiner Artikelserie</a> .  Farbkonflikte werden durch die im ersten Teil beschriebenen Attribute verursacht. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de467125/">https://habr.com/ru/post/de467125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de467111/index.html">Radikale Tipps, wie Sie weniger an Ihrem Telefon h√§ngen k√∂nnen</a></li>
<li><a href="../de467113/index.html">Wie halte ich den Benutzer auf der Website? Usability-Geheimnisse</a></li>
<li><a href="../de467115/index.html">Atypisches "ls" - Habr Edition</a></li>
<li><a href="../de467117/index.html">Manuskripte brennen nicht: Das Geheimnis der Langlebigkeit der Schriftrollen vom Toten Meer aus dem Jahr 250 v</a></li>
<li><a href="../de467119/index.html">Spielen Sie IT-Alias ‚Äã‚Äãmit Badoo Engineers</a></li>
<li><a href="../de467127/index.html">Testen von APIs mit Postman und Excel</a></li>
<li><a href="../de467129/index.html">Kognitive Begradigung 2: Illusionen und Verzerrungen lernen</a></li>
<li><a href="../de467131/index.html">CLRium # 6: Paarbericht √ºber Lock-Free, viel Theorie und praktisches Wissen</a></li>
<li><a href="../de467135/index.html">USB-Pedal zum Umschalten zwischen Computern</a></li>
<li><a href="../de467137/index.html">Sicherstellung eines zuverl√§ssigen Betriebs des Zextras-Teams in komplexen Unternehmensnetzwerken</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>