<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•´ üíµ ü§≥ 6 historias pr√°cticas de nuestros d√≠as de semana SRE üë∑üèª üïê üßìüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La infraestructura web moderna consta de muchos componentes para diversos fines, con evidentes y poco interconectados. Esto se hace especialmente evid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 historias pr√°cticas de nuestros d√≠as de semana SRE</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br>  La infraestructura web moderna consta de muchos componentes para diversos fines, con evidentes y poco interconectados.  Esto se hace especialmente evidente cuando se utilizan aplicaciones que utilizan diferentes paquetes de software, que con la llegada de los microservicios comenzaron a ocurrir literalmente en cada paso.  Los factores externos (API de terceros, servicios, etc.) se agregan a la "diversi√≥n" general, lo que complica una imagen ya dif√≠cil. <br><br>  En general, incluso si estas aplicaciones van a estar unidas por ideas y soluciones arquitect√≥nicas comunes, para eliminar problemas inusuales en ellas, a menudo tienen que atravesar los pr√≥ximos entornos desconocidos.  Si ocurren tales problemas es solo cuesti√≥n de tiempo.  Estos son los ejemplos de nuestra √∫ltima pr√°ctica a la que se dedica este art√≠culo.  Reparto: Golang, Sentry, RabbitMQ, nginx, PostgreSQL y otros. <a name="habracut"></a><br><br><h2>  Historia No. 1.  Golang y HTTP / 2 </h2><br>  La ejecuci√≥n de un punto de referencia que realiza muchas solicitudes HTTP a una aplicaci√≥n web ha dado lugar a resultados inesperados.  Una aplicaci√≥n Go simple en el proceso de referencia va a otra aplicaci√≥n Go ubicada detr√°s de la entrada / openresty.  Cuando HTTP / 2 est√° habilitado, obtenemos errores con el c√≥digo 400 para algunas solicitudes. Para comprender el motivo de este comportamiento, eliminamos la aplicaci√≥n Go en el otro extremo de la cadena e hicimos una ubicaci√≥n simple en Ingress, que siempre devuelve 200. ¬°El comportamiento no ha cambiado! <cut></cut><br><br>  Luego se decidi√≥ reproducir el script fuera del entorno de Kubernetes, en una pieza diferente de hardware.  El resultado fue un Makefile, con la ayuda de la cual se lanzan dos contenedores: en uno, puntos de referencia que van a nginx, en el otro, en Apache.  Ambos escuchan HTTP / 2 con un certificado autofirmado.  El tiempo de funcionamiento final se ve en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://github.com/flant/examples/tree/master/2019/09-">este repositorio</a> . <br><br>  Ejecute los puntos de referencia con <code>concurrency=200</code> : <br><br>  1.1.  Nginx: <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2.  Apache <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br>  Suponemos que el punto aqu√≠ es una implementaci√≥n menos estricta de HTTP / 2 en Apache. <br><br>  Probemos con <code>concurrency=1000</code> : <br><br>  2.1.  Nginx: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2.  Apache <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br>  Al mismo tiempo, notamos que los resultados <i>no se reproducen siempre</i> : algunos de los lanzamientos pasan sin problemas. <br><br>  Una b√∫squeda de problemas en el github del proyecto Golang condujo a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="># 25009</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="># 32441</a> .  A trav√©s de ellos fuimos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PR 903</a> : ¬°deshabilitamos HTTP / 2 en Go por defecto! <br><br>  Interpretar los resultados de referencia sin profundizar en la arquitectura de los servidores web anteriores es bastante dif√≠cil.  En un caso espec√≠fico, fue suficiente deshabilitar HTTP / 2 para el servicio especificado. <br><br><h2>  Historia No. 2.  Viejo symfony y centinela </h2><br>  En uno de los proyectos, una versi√≥n muy antigua del framework PHP de Symfony (v2.3) sigue funcionando.  Un antiguo cliente de Raven y una clase autoescrita en PHP se adjuntan "en el kit", lo que complica un poco la depuraci√≥n. <br><br>  Despu√©s de la transferencia de uno de los servicios en Kubernetes a Sentry, utilizado para rastrear errores en la aplicaci√≥n de este proyecto, los eventos de repente dejaron de llegar.  Para reproducir este comportamiento, utilizamos ejemplos del sitio web de Sentry, tomamos dos opciones y copiamos el DSN de la configuraci√≥n de Sentry.  Visualmente, todo funcion√≥: los mensajes de error (supuestamente) se enviaron uno tras otro. <br><br>  Opci√≥n de verificaci√≥n de JavaScript: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  Del mismo modo en Python: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br>  Sin embargo, no entraron en Sentry.  Al enviar un mensaje, se crea la ilusi√≥n de que el mensaje se envi√≥, porque los clientes generan inmediatamente un hash para el problema. <br><br>  Como resultado, el problema se resolvi√≥ de manera muy simple: el env√≠o de eventos fue a HTTP, y el servicio Sentry solo escuch√≥ HTTPS.  Se proporcion√≥ una redirecci√≥n de HTTP a HTTPS, pero el cliente anterior (el c√≥digo en el lado de Symfony) no pudo seguir las redirecciones, lo que no espera de forma predeterminada en estos d√≠as. <br><br><h2>  Historia No. 3.  RabbitMQ y proxy de terceros </h2><br>  En un proyecto, la nube Evotor se usa para conectar cajas registradoras.  De hecho, funciona como un proxy: las solicitudes POST de Evotor van directamente a RabbitMQ, a trav√©s del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento STOMP</a> implementado a trav√©s de conexiones WebSocket. <br><br>  Uno de los desarrolladores realiz√≥ solicitudes de prueba utilizando Postman y recibi√≥ las respuestas esperadas de <code>200 OK</code> , sin embargo, las solicitudes a trav√©s de la nube llevaron a un inesperado <code>405 Method Not Allowed</code> . <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405 M√©todo no permitido</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Solicitud de tcpdump de Evotor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Solicitud de tcpdump hecha por curl</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br>  El ojo entrenado de un ingeniero ve inmediatamente la diferencia: <br><br><ul><li>  curl: <code>POST /api/queues/%2Fclient‚Ä¶</code> </li><li>  Evotor: <code>POST /api/queues//client‚Ä¶</code> </li></ul><br>  El caso fue que en un caso <code>//vhost</code> <code>%2Fvhost</code> incomprensible (para RabbitMQ) <code>//vhost</code> y en el otro - <code>%2Fvhost</code> , que es el comportamiento esperado cuando: <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br>  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tema</a> del proyecto RabbitMQ sobre este tema, el desarrollador explica: <br><br><blockquote>  No reemplazaremos la codificaci√≥n%.  Es una forma est√°ndar de codificaci√≥n de ruta URL y lo ha sido durante siglos.  Suponiendo que la codificaci√≥n porcentual en las herramientas basadas en HTTP desaparecer√° debido incluso al marco m√°s popular, suponiendo que tales rutas de URL sean "maliciosas" es miope e ingenua.  El nombre de host virtual predeterminado se puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cambiar a cualquier valor</a> (como uno que no utilice barras o cualquier otro car√°cter que requiera una codificaci√≥n%) y al menos con la versi√≥n Pivotal BOSH de RabbitMQ, el host virtual predeterminado se elimina en el momento de la implementaci√≥n. . </blockquote><br>  El problema se resolvi√≥ sin una mayor participaci√≥n de nuestros ingenieros (en el lado de Evotor despu√©s de contactarlos). <br><br><h2>  Historia No. 4.  Gene en PostgreSQL </h2><br>  PostgreSQL tiene un √≠ndice muy √∫til, que a menudo se olvida.  Esta historia comenz√≥ con quejas sobre los frenos en la aplicaci√≥n.  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo reciente,</a> ya dimos un ejemplo de un flujo de trabajo aproximado al analizar tales situaciones.  Y aqu√≠ nuestro APM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Atatus</a> - mostr√≥ la siguiente imagen: <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br>  A las 10 de la ma√±ana hay un aumento en el tiempo que la aplicaci√≥n pasa trabajando con la base de datos.  Como se esperaba, la raz√≥n radica en las respuestas lentas del DBMS.  Para nosotros, analizar consultas, identificar √°reas problem√°ticas e √≠ndices "colgantes" es una rutina comprensible.  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">okmeter</a> que utilizamos ayuda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mucho</a> : hay paneles est√°ndar para monitorear el estado de los servidores y la capacidad de construir <i>r√°pidamente el</i> nuestro, con el resultado de m√©tricas problem√°ticas: <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  Los gr√°ficos de carga de la CPU indican que una de las bases de datos est√° cargada al 100%.  Por qu√©  Los nuevos paneles PostgreSQL le preguntar√°n: <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br>  La causa de los problemas es evidente de inmediato: el principal consumidor de la CPU: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br>  Teniendo en cuenta el plan de trabajo de la consulta del problema, descubrimos que el filtrado por campos indexados de la tabla ofrece una selecci√≥n demasiado grande: la base de datos recibe m√°s de 70 mil filas por <code>id</code> y <code>field_1</code> , y luego busca una subcadena entre ellas.  Resulta que <code>LIKE</code> en una subcadena itera sobre una gran cantidad de datos de texto, lo que conduce a una desaceleraci√≥n grave en la ejecuci√≥n de consultas y un aumento en la carga de la CPU. <br><br>  <i>Aqu√≠ puede notar correctamente que no se descarta un problema arquitect√≥nico (se requiere una correcci√≥n l√≥gica de la aplicaci√≥n o incluso un motor de texto completo ...), pero no hay tiempo para volver a trabajar, pero deber√≠a haber funcionado r√°pidamente hace 15 minutos.</i>  <i>Al mismo tiempo, la palabra de b√∫squeda es en realidad un identificador (y ¬øpor qu√© no en un campo separado? ..), que produce unidades de l√≠neas.</i>  <i>De hecho, si pudi√©ramos componer un √≠ndice en este campo de texto, todos los dem√°s ser√≠an innecesarios.</i> <br><br>  La soluci√≥n actual final es agregar un √≠ndice GIN para <code>field_2</code> .  Ese es el h√©roe del d√≠a, ese mismo "genio".  En resumen, GIN es un tipo de √≠ndice que funciona muy bien en la b√∫squeda de texto completo, aceler√°ndolo cualitativamente.  Puede leer m√°s sobre esto, por ejemplo, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este maravilloso material</a> . <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br>  Como puede ver, esta operaci√≥n simple permiti√≥ eliminar la carga adicional, y con ella, y ahorrar dinero para el cliente. <br><br><h2>  Historia No. 5.  Almacenamiento en cach√© de s3 en nginx </h2><br>  El almacenamiento en la nube compatible con S3 ha estado firmemente en la lista de tecnolog√≠as utilizadas por muchos proyectos.  Si necesita un almacenamiento de im√°genes confiable para su sitio o para datos de red neuronal, Amazon S3 es una excelente opci√≥n.  La fiabilidad del almacenamiento y la alta disponibilidad de datos (y la falta de la necesidad de "cercar el jard√≠n") es cautivadora. <br><br>  Sin embargo, a veces para ahorrar dinero, porque generalmente el pago de S3 va por solicitudes y por tr√°fico, una buena soluci√≥n es instalar un servidor proxy de almacenamiento en cach√© frente al almacenamiento.  Este m√©todo reducir√° los costos cuando se trata, por ejemplo, de avatares de usuarios, de los cuales hay muchos en cada p√°gina. <br><br>  ¬øParece que es m√°s f√°cil que tomar nginx y configurar proxies con almacenamiento en cach√©, revalidaci√≥n, actualizaci√≥n de fondo y otro blackjack?  Sin embargo, como en otros lugares, hay algunos matices ... <br><br>  La configuraci√≥n aproximada de tal proxy con almacenamiento en cach√© se ve√≠a as√≠: <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br>  Y, en general, funcion√≥: se mostraban im√°genes, todo estaba bien con el cach√© ... sin embargo, surgieron problemas con los clientes de AWS S3.  En particular, el cliente de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aws-sdk-php</a> dej√≥ de funcionar.  El an√°lisis de los registros nginx mostr√≥ que el flujo ascendente devolvi√≥ el c√≥digo 403 para las solicitudes HEAD, y la respuesta conten√≠a un error espec√≠fico: <code>SignatureDoesNotMatch</code> .  Cuando vimos que nginx realiza una solicitud GET para el flujo ascendente, todo encaj√≥. <br><br>  El hecho es que el cliente S3 firma cada solicitud y el servidor verifica esta firma.  En el caso de un proxy simple, todo funciona bien: la solicitud llega al servidor sin cambios.  Sin embargo, cuando el almacenamiento en cach√© est√° habilitado, nginx comienza a optimizar el trabajo con el backend y reemplaza las solicitudes HEAD con GET.  La l√≥gica es simple: es mejor recuperar y guardar todo el objeto, y luego todas las solicitudes HEAD del cach√© tambi√©n.  Sin embargo, en nuestro caso, la solicitud no se puede modificar porque est√° firmada. <br><br>  Hay esencialmente dos soluciones: <br><br><ol><li>  No conduzca clientes S3 a trav√©s de servidores proxy; </li><li>  si es "necesario", desactive la opci√≥n <code>proxy_cache_convert_head</code> y agregue <code>$request_method</code> a la clave de almacenamiento en cach√©.  En este caso, nginx env√≠a solicitudes HEAD "tal cual" y almacena las respuestas en cach√© por separado. </li></ol><br><h2>  Historia No. 6.  DDoS y contenido de usuario de Google </h2><br>  El domingo por la noche no presagi√≥ problemas hasta que, de repente.  - La cola de invalidaci√≥n de cach√© en servidores perimetrales no ha crecido, lo que da tr√°fico a usuarios reales.  Este es un s√≠ntoma muy extra√±o: despu√©s de todo, la memoria cach√© se implementa en la memoria y no est√° vinculada a los discos duros.  Vaciar el cach√© en la arquitectura utilizada es una operaci√≥n barata, por lo que este error solo puede aparecer en el caso de una carga realmente alta.  Esto se confirm√≥ por el hecho de que los mismos servidores comenzaron a notificar la aparici√≥n de 500 errores <i>(picos de l√≠nea roja en el gr√°fico a continuaci√≥n)</i> . <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br>  Una oleada tan aguda condujo a desbordamientos de la CPU: <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br>  Un an√°lisis r√°pido mostr√≥ que las solicitudes no llegaron a los dominios principales, pero a partir de los registros qued√≥ claro que estaban en vhost predeterminado.  En el camino, result√≥ que muchos usuarios estadounidenses acudieron al recurso ruso.  Tales circunstancias siempre plantean preguntas de inmediato. <br><br>  Habiendo recopilado datos de los registros de nginx, revelamos que estamos lidiando con cierta botnet: <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br>  Se traza un patr√≥n comprensible en los registros: <br><br><ul><li>  verdadero agente de usuario; </li><li>  una solicitud a la URL ra√≠z con un argumento GET aleatorio para evitar ingresar al cach√©; </li><li>  el √°rbitro indica que la solicitud provino de un motor de b√∫squeda. </li></ul><br>  Recopilamos las direcciones y verificamos su afiliaci√≥n: todas pertenecen a <code>googleusercontent.com</code> , con dos subredes (107.178.192.0/18 y 34.64.0.0/10).  Estas subredes contienen m√°quinas virtuales GCE y diversos servicios, como la traducci√≥n de p√°ginas. <br><br>  Afortunadamente, el ataque no dur√≥ tanto (aproximadamente una hora) y disminuy√≥ gradualmente.  Parece que los algoritmos de protecci√≥n dentro de Google han funcionado, por lo que el problema se resolvi√≥ "por s√≠ mismo". <br><br>  Este ataque no fue destructivo, pero plante√≥ preguntas √∫tiles para el futuro: <br><br><ul><li>  ¬øPor qu√© no funciona el anti-ddos?  Se utiliza un servicio externo, al que enviamos una solicitud correspondiente.  Sin embargo, hab√≠a muchas direcciones ... </li><li>  ¬øC√≥mo protegerse de esto en el futuro?  En nuestro caso, incluso las opciones para cerrar el acceso sobre una base geogr√°fica son posibles. </li></ul><br><h2>  PS </h2><br>  Lea tambi√©n en nuestro blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">De la vida con Kubernetes: c√≥mo los espa√±oles no se quejaron del servidor HTTP</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">6 errores de sistema entretenidos en el funcionamiento de Kubernetes [y su soluci√≥n]</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3 casos inusuales sobre el subsistema de red Linux</a> ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471892/">https://habr.com/ru/post/471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471878/index.html">¬øC√≥mo escribir un contrato inteligente para WebAssembly en una red Ontology? Parte 1: √≥xido</a></li>
<li><a href="../471880/index.html">Idea para Geek Halloween, o tiempo para elegir GeekMask</a></li>
<li><a href="../471884/index.html">10 utilidades gratuitas de ApexSQL para administrar bases de datos de Microsoft SQL Server</a></li>
<li><a href="../471886/index.html">VMmanager 6: presentaci√≥n de la caja y comparaci√≥n con la generaci√≥n anterior</a></li>
<li><a href="../471890/index.html">Inferencia variacional: ¬øqu√© es y qu√© come?</a></li>
<li><a href="../471896/index.html">El libro de jugadas interior. Funciones de red en el nuevo Ansible Engine 2.9</a></li>
<li><a href="../471904/index.html">Planificador de recursos en HPE InfoSight</a></li>
<li><a href="../471906/index.html">Los peligros de optimizaciones incorrectas</a></li>
<li><a href="../471908/index.html">La belleza inesperada de los n√∫meros primos</a></li>
<li><a href="../471912/index.html">Aprender ingl√©s: 7 formas pr√°cticas de ampliar tu vocabulario</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>