<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèª üöù üßëüèø Wir √ºberpr√ºfen die geschlossene Sicherheitsanf√§lligkeit und erhalten vier neue CVEs üêñ ü•ñ üíÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich wurde gebeten, die Artikelserie √ºber das Schlie√üen von Schwachstellen und deren Schlie√üung fortzusetzen (unser erster Artikel kann hier gelesen we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir √ºberpr√ºfen die geschlossene Sicherheitsanf√§lligkeit und erhalten vier neue CVEs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/430408/">  Ich wurde gebeten, die Artikelserie √ºber das Schlie√üen von Schwachstellen und deren Schlie√üung fortzusetzen (unser erster Artikel kann hier gelesen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> ).  Das letzte Mal haben wir herausgefunden, dass selbst wenn der Hersteller √ºber das Schlie√üen der Sicherheitsanf√§lligkeit berichtet, in Wirklichkeit m√∂glicherweise nicht alles so ist. <br><br><img src="https://habrastorage.org/webt/me/ds/nj/medsnjr0lbtdxy9vots_csy_bbg.jpeg"><br><a name="habracut"></a><br><h3>  Auswahlkriterien: </h3><br>  Die Auswahlkriterien f√ºr die diesmal betrachteten Schwachstellen waren dieselben (au√üer dass ich diesmal andere Arten von Schwachstellen untersuchen wollte): <br><br><ul><li>  Es sollte einen Exploit geben - wir wollen sehen, dass vor dem Update alles <s>gut und</s> schlecht <s>ausgenutzt</s> wurde und danach gut wurde. </li><li>  Die Verwundbarkeit sollte kritisch sein (idealerweise RCE) und eine hohe Punktzahl aufweisen. </li><li>  Das Produkt muss Open Source sein. </li><li>  Das Produkt darf nicht aufgegeben und aktiv genutzt werden. </li><li>  Verwundbarkeit sollte relativ neu sein; </li><li>  Hauptsache, wie immer w√§ren wir selbst interessiert. </li></ul><br><h3>  Was und wie ich gew√§hlt habe: </h3><br>  Ich ging zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vulners.com</a> und bat darum, alle Exploits mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Exploit-db.com</a> in den letzten Wochen zu zeigen.  Dieses Mal in der Webkategorie wurden fast alle Exploits von Ihsan Sencan verfasst, aber aufgrund der Tatsache, dass sie sich am h√§ufigsten auf SQL-Injektionen in alten nicht unterst√ºtzten Anwendungen und Plugins beziehen, habe ich sie entfernt.  Von den verbleibenden Produkten fiel nur das ProjeQtOr Project Management Tool 7.2.5 mit der Sicherheitsanf√§lligkeit CVE-2018-18924 in die Kategorie ‚Äûnicht aufgegeben und aktiv entwickelt‚Äú. <br>  Diese Sicherheitsanf√§lligkeit erf√ºllte alle Auswahlkriterien: <br><br><ul><li>  es gibt einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Exploit</a> ; </li><li>  RCE-Sicherheitsanf√§lligkeit (obwohl daf√ºr der Benutzer autorisiert sein muss); </li><li>  das Produkt ist ziemlich Open Source; </li><li>  Das Produkt wird nicht aufgegeben. 2018 gab es 28 Releases und nur sourceforge.net gab es 702 Downloads (und die meisten Update-Downloads l√∂sen das CVE-Problem, was h√∂chstwahrscheinlich darauf hinweist, dass die Leute CVE gesehen und mit dem Update begonnen haben). </li><li>  CVE vom 4. November, ein Exploit vom 25. Oktober, erf√ºllt die Anforderungen der Neuheit; </li><li>  Ich habe mir das Problem und seine L√∂sung angesehen und mich daf√ºr interessiert (dazu sp√§ter mehr). </li></ul><br><h4>  Grundlegendes zum ProjeQtOr-Projektmanagement-Tool </h4><br>  Wir lesen die Beschreibung des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Exploits</a> und die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschreibung von CVE auf nist.gov</a> . Wir verstehen, dass Version 7.2.5 nur f√ºr einen autorisierten Benutzer anf√§llig ist.  Au√üerdem k√∂nnen Sie eine .shtml-Datei als Bild hochladen. Obwohl die Fehlermeldung <i>"Diese Datei ist kein g√ºltiges Bild"</i> angezeigt wird, wird die Datei dennoch in Bildern auf dem Server gespeichert und ist √ºber einen direkten Link in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">host / files /</a> zug√§nglich. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">images / image_name</a> . <br><br><img src="https://habrastorage.org/webt/8d/wu/0x/8dwu0x1uezs-x_ws7egw9szchue.png"><br><br>  Der Zugriff √ºber einen direkten Link ist gut, aber hier m√ºssen Sie noch den Namen erraten, unter dem die Datei heruntergeladen wird.  Wir haben Gl√ºck und es ist kein Zufall, sondern wird aus der aktuellen Zeit im Format generiert: Jahr, Monat, Tag, Stunden, Minuten, Sekunden.  Das Ergebnis ist diese Nummer 20181114140320. Als N√§chstes durchlaufen die Benutzer-ID und dann der urspr√ºngliche Dateiname den Unterstrich.  Es gibt einige Unbekannte: <br><br><ul><li>  Zeitzone auf dem Server </li><li>  wenn die Uhr auf dem Server nicht funktioniert; </li><li>  Benutzer-ID </li></ul><br>  Und wieder haben wir Gl√ºck: Wenn Sie ein g√ºltiges Bild hochladen, werden uns alle diese Parameter gemeldet.  Es ist nicht schwierig, mehrere Optionen von Links durchzugehen (mehrere, da es Sekunden gibt, aber es ist schwierig, sofort darauf zuzugreifen). <br><br><img src="https://habrastorage.org/webt/zq/ce/lh/zqcelhvlhrk7496dafoiqart2nk.png"><br><br>  Im Allgemeinen ist das Abrufen des Dateinamens kein Problem.  Wir gehen weiter.  Und wir denken, warum nicht einfach ein PHP-Skript hochladen?  Wir versuchen es herunterzuladen. Das gleiche Fenster wird angezeigt, aber die Datei wird nicht im Verzeichnis angezeigt.  Es ist Zeit, in den Code zu schauen! <br><br>  Das Skript uploadImage.php ist f√ºr das Hochladen des Bildes auf den Server in Version 7.2.5 verantwortlich. Wir sind an den Zeilen 100 bis 117 interessiert. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>])) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { traceHack(<span class="hljs-string"><span class="hljs-string">"Try to upload php file as image in CKEditor"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ! move_uploaded_file($uploadedFile[<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploadfile)) { $error = htmlGetErrorMessage(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); errorLog(i18n(<span class="hljs-string"><span class="hljs-string">'errorUploadFile'</span></span>,<span class="hljs-string"><span class="hljs-string">'hacking ?'</span></span>)); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); } }</code> </pre> <br>  Zeile 100 ist f√ºr die √úberpr√ºfung der Dateierweiterung verantwortlich: Wenn es sich um PHP oder PHTM handelt, wird die Datei verworfen und nicht gespeichert.  Daher werden PHP-Dateien nicht im Verzeichnis "files / images /" angezeigt.  Zeile 115 erzeugt den Fehler, den wir sehen, macht aber nichts mit der Datei. <br><br>  Lassen Sie uns den Exploit nicht verlassen und laden Sie die Datei mit der Erweiterung .shtml hoch.  Hier lohnt es sich, einen kleinen Exkurs zu machen und zu sagen, was .shtml ist und womit es gegessen wird. <br><br><h4>  SHTML und SSI </h4><br>  Wikipedia-Definition: <br><br>  SSI (Server Side Includes - Einbeziehung auf der Serverseite) - eine einfache Sprache f√ºr die dynamische "Zusammenstellung" von Webseiten auf dem Server aus den einzelnen Komponenten und die √úbermittlung des empfangenen HTML-Dokuments an den Client.  Wird auf dem Apache-Webserver mithilfe des Moduls mod_include implementiert.  Mit der in den Standardeinstellungen des Webservers enthaltenen Funktion k√∂nnen Sie HTML-Dateien einschlie√üen. Um die Anweisungen verwenden zu k√∂nnen, muss die Datei mit der Erweiterung .shtml, .stm oder .shtm enden. <br><br>  In deinen eigenen Worten: <br><br>  SHTML ist HTML, das serverseitige Befehlss√§tze ausf√ºhren kann.  Von den n√ºtzlichen gibt es eine exec-Funktion, die beliebige Befehle auf dem Server ausf√ºhrt (ja, wir k√∂nnen die Datei mit HTML-Code herunterladen und ausf√ºhren). <br><br>  Hier ist ein Beispielcode zum Ausf√ºhren von beliebigem Code: <br><br><pre> <code class="php hljs">&lt;!--<span class="hljs-comment"><span class="hljs-comment">#exec cmd=‚Äùls‚Äù --&gt;</span></span></code> </pre> <br>  Die gute Nachricht ist, dass diese Funktionalit√§t auf dem Apache2-Server nicht standardm√§√üig aktiviert ist. Um sie zu aktivieren, m√ºssen Sie mit einem Tamburin tanzen.  In ein paar Stunden nach Auswahl der Konfiguration konnte ich die R√ºckgabe von Umgebungsvariablen zum Funktionieren bringen, nicht jedoch den Befehl.  Hier ist mein SSI-Code: <br><br><pre> <code class="php hljs">&lt;html&gt; &lt;head&gt; &lt;title&gt;thegeekstuff.com&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt; Today is &lt;!--<span class="hljs-comment"><span class="hljs-comment">#echo var="DATE_LOCAL" --&gt; &lt;!--#exec cmd="ls" --&gt; &lt;/p&gt; &lt;/body&gt; &lt;/html&gt;  : Today is Wednesday, 14-Nov-2018 17:29:14 MSK [an error occurred while processing this directive]</span></span></code> </pre><br>  Wenn dir jemand sagt, was du in die Konfiguration schreiben sollst, damit es richtig funktioniert, w√ºrde ich es gerne lesen. <br><br><h4>  Sicherheitsl√ºcke ausnutzen </h4><br>  Wenn die Sterne konvergieren, k√∂nnen Sie die HTML-Datei herunterladen und beliebige Befehle ausf√ºhren (oder wie ich die Uhrzeit auf dem Server anzeigen). <br><br><h4>  Beobachten Sie den Patch </h4><br>  Die n√§chste Version ist 7.2.6, aber es gibt keine √Ñnderungen in Bezug auf die Sicherheitsanf√§lligkeit, an der wir interessiert sind (nist.gov erneut get√§uscht). <br><br>  Wir schauen uns Version 7.2.7 an und dort scheint alles repariert zu sein (die Entwickler selbst sagen, dass alles nur in dieser Version repariert ist).  Es gibt zwei wichtige √Ñnderungen: <br><br>  1. Unter den verbotenen Erweiterungen wurde "shtm" hinzugef√ºgt (wenn die ersten 4 Zeichen solche sind, f√§llt auch shtml hierher): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) {</code> </pre> <br><br>  2. Dateien, die keine Bilder sind, werden jetzt gel√∂scht: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(@!getimagesize($uploadfile)) { $error=i18n(<span class="hljs-string"><span class="hljs-string">'errorNotAnImage'</span></span>); kill($uploadfile); }</code> </pre> <br>  Es scheint, dass Sie abweichen k√∂nnen, da Nicht-Bilder gel√∂scht werden und shtml nicht einmal versucht, fortzufahren.  Aber es hat mir immer nicht gefallen, wenn sie versucht haben, ein Problem mit schwarzen Listen zu l√∂sen.  In einigen L√§ndern verbieten Unternehmen beispielsweise soziale Netzwerke.  Dies f√ºhrt dazu, dass Benutzer beginnen, die ‚ÄûSpiegel‚Äú sozialer Netzwerke zu verwenden, in denen ihre Benutzernamen und Passw√∂rter gestohlen werden.  Ihre Passw√∂rter stimmen mit den Firmenpassw√∂rtern √ºberein, aber dann kann es viel gr√∂√üere Probleme geben, als wenn ein Mitarbeiter bei einer Tasse Kaffee durch ein Instagram bl√§ttert. <br><br>  In der Webprogrammierung und ihrer Sicherheit sind schwarze Listen ebenfalls b√∂se. <br><br><h4>  Umgehen Sie die schwarze Liste von ProjeQtOr </h4><br>  Nun, alles ist einfach.  Lassen Sie uns zun√§chst sehen, welche Dateien Apache2 + PHP in den Standardeinstellungen interpretieren kann (alles wurde unter Ubuntu 16.04 mit einem aktualisierten Repository installiert).  Die Direktive ‚ÄûFilesMatch‚Äú ist f√ºr die Interpretation von Dateien verantwortlich.  Wir suchen danach mit dem Befehl "grep -r" &lt;FilesMatch "/ etc / apache2" und hier ist das Ergebnis: <br><br><pre> <code class="php hljs">/etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.ph(p[3457]?|t|tml)$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">".+\.phps$"</span></span>&gt; /etc/apache2/mods-available/php7<span class="hljs-number"><span class="hljs-number">.0</span></span>.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ph(p[3457]?|t|tml|ps)$"</span></span>&gt; /etc/apache2/sites-available/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl.conf: &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.(cgi|shtml|phtml|php)$"</span></span>&gt; /etc/apache2/apache2.conf:&lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"^\.ht"</span></span>&gt;</code> </pre> <br>  In der Konfiguration default-ssl.conf werden alle Erweiterungen einfach vollst√§ndig aufgelistet. Dies sind: cgi, shtml, phtml, php.  Leider wird alles au√üer CGI in ProjeQtOr herausgefiltert. <br><br>  Die Konfiguration von php7.0.conf ist viel interessanter, da die Erweiterungen durch den regul√§ren Ausdruck festgelegt werden.  Wir bekommen: <br><table><tbody><tr><th>  Erweiterung </th><th>  Was wird gefiltert? </th></tr><tr><td>  php </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php3 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php4 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php5 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  php7 </td><td>  substr ($ ext, 0.3) == 'php' </td></tr><tr><td>  pht </td><td>  NICHTS </td></tr><tr><td>  phtml3 </td><td>  substr ($ ext, 0.4) == 'phtm' </td></tr></tbody></table><br>  Gro√üartig, eine Dateierweiterung, die nicht gefiltert wird, wurde gefunden.  Wir √ºberpr√ºfen, ob es wirklich interpretiert wird. <br><br>  Erstellen Sie eine test.pht-Datei mit folgendem Inhalt: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br>  Wir gehen zu dieser Datei im Browser und sehen Informationen √ºber die installierte PHP.  Bemerkenswerterweise wurde die schwarze Liste umgangen, w√§hrend f√ºr nicht standardm√§√üige Einstellungen aus irgendeinem Grund andere Erweiterungen f√ºr die Interpretation zul√§ssig sein k√∂nnten. <br><br>  Wir laden unsere Testdatei in das ProjeQtOr Project Management Tool.  Nat√ºrlich erhalten wir eine Fehlermeldung, da dies kein Bild ist (in der Version vor 7.2.7 haben wir bereits Codeausf√ºhrung auf dem Server, da es nicht schwierig ist, phpinfo in die Ausf√ºhrung von Befehlen zu √§ndern).  In Version 7.2.7 wird die Datei gel√∂scht und der Code nicht ausgef√ºhrt. <br><br>  Aber wir sind nicht ver√§rgert und umgehen die Pr√ºfung auf dem Bild. <br><br><h4>  PHP Bild </h4><br>  Die √úberpr√ºfung, ob die heruntergeladene Datei ein Bild im ProjeQtOr Project Management Tool ist, erfolgt mit der Funktion getimagesize, die einfach den Header der √ºbertragenen Datei betrachtet. <br><br>  Unter Ausnutzung der Tatsache, dass die PHP-Datei m√∂glicherweise M√ºll enth√§lt und die Interpretation des PHP-Codes nur mit den Zeichen ‚Äû&lt;? Php‚Äú beginnt, schreiben wir einen kleinen Code, der zuerst das Bild und dann den ben√∂tigten PHP-Code schreibt.  Als Bild senden wir einen Screenshot des Fehlerfensters.  3 Zeilen Python-Code und fertig: <br><br><pre> <code class="python hljs">data = open (<span class="hljs-string"><span class="hljs-string">'test.png'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() data += open (<span class="hljs-string"><span class="hljs-string">'test.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>).read() open (<span class="hljs-string"><span class="hljs-string">'new_pht_png.pht'</span></span>,<span class="hljs-string"><span class="hljs-string">'wb'</span></span>).write(data)</code> </pre> <br>  Wahrscheinlich k√∂nnten Sie einfach einen g√ºltigen Bildheader am Anfang der Datei schreiben, aber es ist einfacher, und noch mehr, das Bild wird in jedem Betrachter angezeigt. <br><br>  Wir laden diese Kreation auf den Server hoch und siehe da, sie wird geladen (und im Viewer als Bild angezeigt). Au√üerdem ist es sch√∂n, dass uns der vollst√§ndige Name angezeigt wird, mit dem diese Datei hochgeladen wurde. <br><br><img src="https://habrastorage.org/webt/xi/px/mh/xipxmhyuzvcaqbxl28pcrrezd1q.png"><br><br>  Wir gehen zur heruntergeladenen Datei <a href="">localhost / files / images / 20181114171730_1_new_pht_png.pht</a> und sehen das heruntergeladene Bild als Text und die phpinfo-Ausgabe darunter.  Es ist klar, dass es nicht schwierig ist, phpinfo durch eine einfache Web-Shell zu ersetzen.  Zum Beispiel: &lt;? Php system ($ _ GET ['cmd']); <br><br><img src="https://habrastorage.org/webt/m-/kv/ad/m-kvadznv4ev99yge_zwwsgzf6m.png"><br><br>  Sobald Sie mit dem Ausw√§hlen von Dateidownloads begonnen haben, m√ºssen Sie den Job beenden und sehen, wo sonst Dateien mit oder ohne Blacklists heruntergeladen werden. <br><br><h4>  Ein weiterer Datei-Upload </h4><br>  Wir werden in der neuesten verf√ºgbaren Version sehen.  Angenommen, Sie verwenden dieselbe Funktion zum Hochladen von Dateien wie zuvor, d. H.  move_uploaded_file suchen wir im Projektverzeichnis "grep -r" move_uploaded_file "./".  Wir erhalten die folgenden 5 Dateien: <br><br>  ./tool/uploadImage.php <br>  ./tool/saveDocumentVersion.php <br>  ./tool/uploadPlugin.php <br>  ./tool/import.php <br>  ./tool/saveAttachment.php <br><br>  Datei uploadImage.php - schon gesucht. <br>  Datei saveDocumentVersion.php - L√§dt Versionen von Dokumenten herunter (wie der Name schon sagt).  Wir versuchen, ein Dokument herunterzuladen und es anzusehen (zun√§chst laden wir immer ein Bild).  Nach dem Herunterladen sehen wir, dass die Erweiterung .1 zur Datei hinzugef√ºgt wird.  Wir sehen uns im Code an, wie der Name erhalten wird (dies erfolgt in Zeile 229): <br><br><pre> <code class="php hljs">$uploadfile = $dv-&gt;getUploadFileName();</code> </pre> <br>  Die Funktion getUploadFileName ist in der Datei DocumentVersionMain.php deklariert.  Dort sehen wir in Zeile 227, dass "." Zum zur√ºckgegebenen Namen hinzugef√ºgt wird.  und Dokument-ID.  Wir k√∂nnen nicht einmal den zus√§tzlichen Punkt umgehen: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $uploaddir . $paramPathSeparator . $fileName . <span class="hljs-string"><span class="hljs-string">'.'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id;</code> </pre> <br>  Die Datei uploadPlugin.php ist nur f√ºr Administratoren zug√§nglich. Die Tatsache, dass das Plugin m√∂glicherweise fehlerhaften Code enth√§lt, ist sehr logisch und schwer zu beseitigen, ohne dass die Plugin-Validierung eingegeben werden muss (wie dies bei g√§ngigen CMS der Fall ist).  Wenn Sie versuchen, dort etwas herunterzuladen, wird es nat√ºrlich erfolgreich geladen und dann ausgef√ºhrt. <br><br>  Die Datei import.php steht auch nur Administratoren zur Verf√ºgung.  Beim Herunterladen einer Datei wird uns mitgeteilt, dass es sich um eine CSV-Datei oder eine XLSX-Datei handeln sollte.  Nat√ºrlich versuchen wir die PHP-Datei zu laden und sehen einen Fehler: <br><br><h4>  FEHLER - Der angegebene Dateityp und das ausgew√§hlte Dateiformat stimmen nicht √ºberein </h4><br>  Import abgebrochen <br><br>  Das Problem ist, dass die Datei wie im urspr√ºnglichen Fehler von CVE nicht gel√∂scht wird, sondern unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">localhost / files / attach / import / test.php</a> verf√ºgbar bleibt. <br><br>  Die Datei saveAttachment wird beim Laden von Anh√§ngen verwendet (z. B. beim Laden Ihres eigenen Bildes).  Das PHP-Skript wird dort nicht gecrawlt, da das Formular gesch√ºtzt ist: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>)==<span class="hljs-string"><span class="hljs-string">'php'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'phtm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> substr($ext,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)==<span class="hljs-string"><span class="hljs-string">'shtm'</span></span>) { $attachment‚ÜífileName.=<span class="hljs-string"><span class="hljs-string">".projeqtor"</span></span>;</code> </pre> <br>  es stellt sich heraus, dass zu den Erweiterungsdateien php *, phtm *, shtm * die Erweiterung ".projeqtor" hinzugef√ºgt wird, dh offensichtlich wird unsere pht-Datei dort crawlen (auch ohne die Bilder zu crawlen).  Wir versuchen es und bekommen alles unter der Adresse <a href="">localhost / files / attach / attachment_1 / test.pht</a> . <br><br>  Insgesamt f√ºnf schnell gefundene Speicherorte f√ºr das Herunterladen von Dateien: <br><br><ul><li>  schaffte es 4 mal PHP oder Pht Skript zu laden; </li><li>  Die Validierung der schwarzen Liste erfolgt in zwei Teilen. </li><li>  Die Validierung der wei√üen Liste ist nirgendwo; </li><li>  einmal konnte die Datei nicht heruntergeladen werden (fehlgeschlagen, aber nicht ausgef√ºhrt), weil  Die Expansion ver√§nderte sich </li></ul><br><h3>  Schlussfolgerungen zum ProjeQtOr Project Management Tool und CVE-2018-18924 </h3><br><br><ul><li>  Die gemeldete Sicherheitsanf√§lligkeit wurde praktisch beseitigt. </li><li>  Es gibt andere Schwachstellen im Code (die den Entwicklern gemeldet wurden und sogar Whitelists f√ºr Erweiterungen versprochen haben). </li><li>  Eine ordnungsgem√§√üe Konfiguration des Apache2-Servers k√∂nnte uns vor allem bewahren (beschr√§nken Sie die ausf√ºhrbaren Formate auf nur das Notwendige, verbieten Sie die Ausf√ºhrung von Skripten in Benutzerordnern). </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nist.gov</a> enth√§lt nicht die neueste anf√§llige Version. </li></ul><br><h3>  Herrin Notiz </h3><br><ul><li>  wo immer m√∂glich schwarze Listen ablehnen (ich wei√ü nicht, wo dies unm√∂glich ist); </li><li>  Seien Sie vorsichtig und aufmerksam, wenn Sie heruntergeladene Dateien verarbeiten (es ist besser, wenn Sie sich an einem Ort befinden und nicht um 5 verteilt sind). </li><li>  Ein ordnungsgem√§√ü konfigurierter Webserver erspart viele Probleme im Projektcode (es ist wichtig, Code zu schreiben und den Server gut zu konfigurieren). </li></ul><br><h3>  Detaillierte Antwort von Entwicklern </h3><br>  Die erste Antwort der Entwickler lautete: "Wir haben alles repariert, sehen Sie sich also den korrigierten Code an."  Ich musste sehr detailliert malen, wo einige Probleme sind und wie sie ausgenutzt werden k√∂nnen. <br><br>  Dann erhielt er eine ausf√ºhrliche Antwort: ‚ÄûJa, es gibt Probleme, die in Version 7.3.0 behoben werden.  Es werden auch wei√üe Listen f√ºr Bilder f√ºr xlslx und csv hinzugef√ºgt. ‚Äú  Sie haben auch geschrieben, dass sie eine Empfehlung haben, die Verzeichnisse "Anh√§nge" und "Dokumente" au√üerhalb des Webzugriffs in die Installationsanweisungen aufzunehmen. <br><br>  Die Entwickler erlaubten mir, CVE zu registrieren und nach dem Update einen Artikel zu schreiben (der herauskam und zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Download</a> zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verf√ºgung steht</a> ). <br><br><h3>  Fazit </h3><br>  Wie ich zu Beginn schrieb, haben einige Leute das Update heruntergeladen, das CVE entscheidet (mehr als 500 Downloads), und es ist cool, dass Leute ihre anf√§llige Software aktualisieren, aber es ist traurig, dass die Software weiterhin anf√§llig bleibt. <br><br>  Infolgedessen wurden mir und unserem Unternehmen vier CVEs zugewiesen: CVE-2018-19307, CVE-2018-19308, CVE-2018-19309, CVE-2018-19310. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430408/">https://habr.com/ru/post/de430408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430398/index.html">Wie Sie verstehen, dass Sie nicht willkommen sind oder Methoden diskutieren, um Mitarbeiter aus dem Unternehmen zu verdr√§ngen</a></li>
<li><a href="../de430400/index.html">Erfahrung mit einem Tastatur-Maus-Hybrid in der Programmierung</a></li>
<li><a href="../de430402/index.html">Was sagt developer.android.com √ºber RecyclerView?</a></li>
<li><a href="../de430404/index.html">Wir sammeln Daten zum Kundenverhalten auf der Website</a></li>
<li><a href="../de430406/index.html">C ++ 20 und Module, Netzwerk, Coroutinen, Bereiche, Grafiken. Ergebnisse des Treffens in San Diego</a></li>
<li><a href="../de430410/index.html">‚ÄûEs muss sich immer entwickeln‚Äú: Ein Interview mit Evgeny Kuvshinov (ManyChat) √ºber die Entwicklung in einem Startup</a></li>
<li><a href="../de430412/index.html">Fuzzy-Logik gegen PID. Wir √ºberqueren den Igel und die Schlange. Algorithmen zur Steuerung von Flugzeugtriebwerken und KKW</a></li>
<li><a href="../de430414/index.html">Azure DevOps f√ºr Commodore 64?</a></li>
<li><a href="../de430418/index.html">Pers√∂nliche Erfahrung mit N√§herungssensoren in der Entwicklung</a></li>
<li><a href="../de430420/index.html">Konferenz "Inhalt" - jetzt mit Unterst√ºtzung f√ºr Hyper-Threading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>