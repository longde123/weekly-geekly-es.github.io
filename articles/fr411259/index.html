<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è üë∞üèæ üõ´ Nous connectons un compteur d'eau √† une maison intelligente üïâÔ∏è üßóüèª üêÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois que les syst√®mes domotiques, ou comme ils sont souvent appel√©s ¬´maison intelligente¬ª, √©taient terriblement chers et seuls les riches pouvaien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous connectons un compteur d'eau √† une maison intelligente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411259/">  Une fois que les syst√®mes domotiques, ou comme ils sont souvent appel√©s ¬´maison intelligente¬ª, √©taient terriblement chers et seuls les riches pouvaient se les permettre.  Aujourd'hui, sur le march√©, vous pouvez trouver des kits assez bon march√© avec des capteurs, des boutons / interrupteurs et des actionneurs pour contr√¥ler l'√©clairage, les prises, la ventilation, l'alimentation en eau et d'autres consommateurs.  Et m√™me le <s>plus krivoruky</s> DIY-shnik peut rejoindre les beaux et collecter des appareils pour une maison intelligente √† peu de frais. <br><br><img src="https://habrastorage.org/webt/-a/k2/x6/-ak2x6li6an5gyqbrg2ett_-_au.jpeg"><br><br>  En r√®gle g√©n√©rale, les dispositifs propos√©s sont soit des capteurs soit des actionneurs.  Ils facilitent la mise en ≈ìuvre de sc√©narios tels que ¬´allumer la lumi√®re lorsque le d√©tecteur de mouvement est d√©clench√©¬ª ou ¬´l'interrupteur √† la sortie √©teint la lumi√®re dans tout l'appartement¬ª.  Mais la t√©l√©m√©trie n'a pas fonctionn√©.  Au mieux, il s'agit d'un graphique de la temp√©rature et de l'humidit√©, ou de la puissance instantan√©e dans une prise particuli√®re. <br><br>  R√©cemment, j'ai install√© un compteur d'eau avec une sortie d'impulsion.  Un interrupteur √† lames est d√©clench√© √† travers chaque litre du compteur et ferme le contact.  La seule chose qui reste est de s'accrocher aux fils et d'essayer d'en tirer profit.  Par exemple, analysez la consommation d'eau par heure et jour de la semaine.  Eh bien, s'il y a plusieurs √©l√©vateurs d'eau dans l'appartement, il est plus pratique de voir tous les indicateurs actuels sur un seul √©cran que de gravir des niches difficiles d'acc√®s avec une lampe de poche. <br><br>  Sous la coupe, ma version de l'appareil est bas√©e sur l'ESP8266, qui compte les impulsions des compteurs d'eau et envoie des lectures au serveur domestique intelligent via MQTT.  Nous allons programmer en micropython en utilisant la biblioth√®que uasyncio.  Lors de la cr√©ation du firmware, j'ai rencontr√© plusieurs difficult√©s int√©ressantes, dont je parlerai √©galement dans cet article.  C'est parti! <br><a name="habracut"></a><br><h3>  Sch√©ma </h3><br><img src="https://habrastorage.org/webt/i-/w2/o7/i-w2o7b8mfsommteri_mss88oa8.png"><br><br>  Le c≈ìur de l'ensemble du circuit est le module du microcontr√¥leur ESP8266.  L'ESP-12 √©tait initialement pr√©vu, mais le mien s'est r√©v√©l√© d√©fectueux.  Je devais me contenter du module ESP-07, qui √©tait disponible.  Heureusement, ils sont les m√™mes √† la fois dans les conclusions et dans les fonctionnalit√©s, la diff√©rence ne concerne que l'antenne - l'ESP-12 l'a int√©gr√©e et l'ESP-07 en a une externe.  Cependant, m√™me sans antenne WiFi, le signal dans ma salle de bain est capt√© normalement. <br><br>  La liaison du module est standard: <br><br><ul><li>  bouton de r√©initialisation avec une bretelle et un condensateur (bien que les deux soient d√©j√† √† l'int√©rieur du module) </li><li>  Activer le signal (CH_PD) tir√© √† l'alimentation </li><li>  GPIO15 s'est arr√™t√© au sol.  Cela n'est n√©cessaire qu'au d√©but, mais je n'ai plus rien √† m'accrocher √† cette jambe </li></ul><br>  Pour mettre le module en mode firmware, vous devez fermer le GPIO2 √† la terre, et pour le rendre plus pratique, j'ai fourni le bouton Boot.  Dans des conditions normales, cette broche est tir√©e au courant. <br><br>  L'√©tat de la ligne GPIO2 n'est v√©rifi√© qu'au d√©but du travail - lorsque l'alimentation est appliqu√©e ou imm√©diatement apr√®s une r√©initialisation.  Le module se charge donc comme d'habitude ou passe en mode firmware.  Apr√®s le chargement, cette sortie peut √™tre utilis√©e comme un GPIO standard.  Eh bien, puisqu'il y a d√©j√† un bouton, vous pouvez y mettre une fonction utile. <br><br>  Pour la programmation et le d√©bogage, je vais utiliser l'UART, qui a amen√© au peigne.  Si n√©cessaire - je branche simplement un adaptateur USB-UART.  Vous avez juste besoin de vous rappeler que le module est aliment√© par 3,3 V.  Si vous oubliez de commuter l'adaptateur √† cette tension et appliquez 5V, le module sera tr√®s probablement grill√©. <br><br>  Je n'ai aucun probl√®me avec l'√©lectricit√© dans la salle de bain - la prise est situ√©e √† environ un m√®tre des compteurs, donc je vais l'alimenter √† partir de 220V.  En tant que source d'alimentation, je travaillerai un petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bloc de HLK-</a> PM03 de Tenstar Robot.  Personnellement, je suis proche de l'√©lectronique analogique et de puissance, mais voici une alimentation finie dans un petit bo√Ætier. <br><br>  Pour signaler les modes de fonctionnement, j'ai fourni une LED connect√©e √† GPIO2.  Cependant, je n'ai pas commenc√© √† le souder, car  le module ESP-07 poss√®de d√©j√† une LED, par ailleurs, connect√©e au m√™me GPIO2.  Mais que ce soit sur le tableau - tout d'un coup, je veux apporter cette LED au bo√Ætier. <br><br>  Nous passons au plus int√©ressant.  Les compteurs d'eau n'ont pas de logique, on ne peut pas leur demander les lectures actuelles.  La seule chose √† notre disposition est les impulsions - fermant les contacts du commutateur √† lames √† chaque litre.  Les conclusions des interrupteurs reed sont d√©finies dans GPIO12 / GPIO13.  Je vais activer la r√©sistance de pull-up par programmation √† l'int√©rieur du module. <br><br>  Au d√©part, j'ai oubli√© de fournir des r√©sistances R8 et R9, et dans ma version de la carte, elles ne le sont pas.  Mais √©tant donn√© que je mets d√©j√† le syst√®me √† la disposition du public, cela vaut la peine de corriger cet oubli.  Des r√©sistances sont n√©cessaires pour ne pas br√ªler le port si le micrologiciel est bugg√© et met l'unit√© sur la broche, et le commutateur √† lames court-circuite cette ligne √† la masse (maximum 3,3 V / 1000 Ohm = 3,3 mA circuleront avec la r√©sistance). <br><br>  Il est temps de r√©fl√©chir √† ce qu'il faut faire en cas de panne d'√©lectricit√©.  La premi√®re option consiste √† demander au serveur les compteurs initiaux au d√©but.  Mais cela n√©cessiterait une complication importante du protocole d'√©change.  De plus, l'op√©rabilit√© de l'appareil dans ce cas d√©pend de l'√©tat du serveur.  Si, apr√®s avoir √©teint la lumi√®re, le serveur ne d√©marre pas (ou d√©marre plus tard), le compteur d'eau ne pourra pas demander les valeurs initiales et fonctionnera incorrectement. <br><br>  J'ai donc d√©cid√© d'impl√©menter le stockage des valeurs de compteur dans une puce m√©moire connect√©e via I2C.  Je n'ai pas d'exigences particuli√®res pour la taille de la m√©moire flash - je dois enregistrer seulement 2 chiffres (le nombre de litres par compteur d'eau chaude et froide).  M√™me le plus petit module fera l'affaire.  Mais sur le nombre de cycles d'enregistrement, vous devez faire attention.  Pour la plupart des modules, c'est 100 000 cycles, pour certains jusqu'√† un million. <br><br>  Il semblerait qu'un million, c'est beaucoup.  Mais pendant 4 ans de vie dans mon appartement j'ai consomm√© un peu plus de 500 m√®tres cubes d'eau, soit 500 mille litres!  Et 500 000 entr√©es en un clin d'≈ìil.  Et ce n'est que de l'eau froide.  Vous pouvez bien s√ªr souder la puce tous les deux ans, mais il s'est av√©r√© qu'il existe des puces FRAM.  D'un point de vue programmation, c'est la m√™me EEPROM I2C, mais avec un tr√®s grand nombre de cycles de r√©√©criture (des centaines de millions).  C'est juste jusqu'√† ce que tout atteigne le magasin avec de telles puces de quelque mani√®re que ce soit, donc pour l'instant le 24LC512 habituel se tiendra. <br><br><h3>  Circuit imprim√© </h3><br>  Au d√©part, j'avais pr√©vu de faire des frais √† la maison.  Par cons√©quent, la planche a √©t√© con√ßue comme unilat√©rale.  Mais apr√®s une longue heure avec un fer √† repasser laser et un masque de soudure (sans √ßa en quelque sorte comme il faut), j'ai quand m√™me d√©cid√© de commander des planches aux chinois. <br><br><img src="https://habrastorage.org/webt/en/si/rz/ensirzhmczp3bs9n7a6a8plmzl4.png"><br><br>  Presque avant de commander la carte, j'ai r√©alis√© qu'en plus de la puce de m√©moire flash sur le bus I2C, vous pouvez prendre quelque chose d'autre utile, comme un √©cran.  Qu'est-ce que la sortie est toujours une question, mais vous devez vous reproduire sur la carte.  Eh bien, puisque j'allais commander les cartes √† l'usine, cela n'avait aucun sens de me limiter √† une carte simple face, donc les lignes sur I2C sont les seules √† l'arri√®re de la carte. <br><br>  Un grand montant √©tait √©galement associ√© √† un c√¢blage unilat√©ral.  Parce que  la carte √©tait dessin√©e d'un c√¥t√©, les pistes et les composants SMD devaient √™tre plac√©s d'un c√¥t√©, et les composants de sortie, les connecteurs et l'alimentation √©lectrique de l'autre.  Lorsque j'ai re√ßu les planches dans un mois, j'ai oubli√© le plan initial et d√©zipp√© tous les composants de la face avant.  Et seulement quand il s'agissait de souder l'alimentation, il s'est av√©r√© que le plus et le moins √©taient divorc√©s au contraire.  J'ai d√ª faire des fermes collectives avec des cavaliers.  Dans l'image ci-dessus, j'ai d√©j√† chang√© le c√¢blage, mais la masse est projet√©e d'une partie de la carte √† l'autre via les sorties du bouton Boot (bien qu'il soit possible de dessiner une piste sur la deuxi√®me couche). <br><br>  Il s'est av√©r√© comme √ßa <br><br><img src="https://habrastorage.org/webt/au/-d/cs/au-dcsvpehh9p5g9iqyob5hjslu.jpeg"><br><br><h3>  Logement </h3><br>  La prochaine √©tape est le logement.  Avec une imprimante 3D, ce n'est pas un probl√®me.  Je n'ai pas trop d√©rang√© - j'ai juste dessin√© une bo√Æte de la bonne taille et fait des d√©coupes aux bons endroits.  Le couvercle est fix√© au corps par de petites vis. <br><br><img src="https://habrastorage.org/webt/qq/lu/zp/qqluzptanq4d24dsv4jdlb9uif8.png"><br><br>  J'ai d√©j√† mentionn√© que le bouton de d√©marrage peut √™tre utilis√© comme un bouton √† usage g√©n√©ral - ici, nous le pr√©sentons sur le panneau avant.  Pour ce faire, j'ai dessin√© un ¬´puits¬ª sp√©cial o√π se trouve le bouton. <br><br><img src="https://habrastorage.org/webt/dv/xg/gn/dvxggnexv-fiqy0jqtptpdk1dvy.png"><br><br>  √Ä l'int√©rieur du bo√Ætier, il y a √©galement des souches sur lesquelles la carte est install√©e et fix√©e avec une seule vis M3 (il n'y avait plus d'espace sur la carte) <br><br>  L'affichage a √©t√© s√©lectionn√© lorsque j'ai imprim√© la premi√®re version adapt√©e du bo√Ætier.  La ligne standard √† deux lignes ne convenait pas dans ce cas, mais un √©cran OLED SSD1306 128x32 a √©t√© trouv√© dans le cardan.  C'est petit, mais je n'ai pas √† le regarder tous les jours - √ßa va rouler. <br><br>  Estimant les deux sens et la fa√ßon dont les fils seront pos√©s √† partir de lui, j'ai d√©cid√© de coller l'√©cran au milieu du bo√Ætier.  L'ergonomie, bien s√ªr, sous la plinthe - un bouton en haut, un √©cran en bas.  Mais j'ai d√©j√† dit que l'id√©e de visser l'√©cran √©tait venue trop tard et qu'il √©tait trop paresseux de r√©organiser la carte pour d√©placer le bouton. <br><br>  L'appareil est termin√©.  Le module d'affichage est coll√© aux buses thermofusibles <br><br><img src="https://habrastorage.org/webt/sn/qr/xf/snqrxfyyihzqwiwwwf-1yly545m.jpeg"><br><br><img src="https://habrastorage.org/webt/ow/bh/2o/owbh2oguwv4tiez2basnv11hgvw.jpeg"><br><br>  Le r√©sultat final peut √™tre vu sur KDPV <br><br><h3>  Firmware </h3><br>  Passons √† la partie logiciel.  Pour ces petits m√©tiers, j'aime vraiment utiliser le langage Python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">micropython</a> ) - le code est tr√®s compact et compr√©hensible.  Heureusement, il n'est pas n√©cessaire de descendre au niveau des registres pour presser les microsecondes - tout peut √™tre fait √† partir de python. <br><br>  Il semble que tout soit simple, mais pas tr√®s - plusieurs fonctions ind√©pendantes sont d√©crites dans l'appareil: <br><br><ul><li>  L'utilisateur enfonce un bouton et regarde l'√©cran </li><li>  Les litres cochent et mettent √† jour les valeurs dans la m√©moire flash </li><li>  Le module surveille le signal WiFi et se reconnecte si n√©cessaire </li><li>  Eh bien, sans lumi√®re clignotante, vous ne pouvez pas </li></ul><br>  Il est impossible de supposer qu'une fonction n'a pas fonctionn√© si l'autre est stupide pour une raison quelconque.  J'ai d√©j√† mang√© des cactus dans d'autres projets et maintenant je vois des p√©pins dans le style de "manquer un autre litre, car √† ce moment l'affichage a √©t√© mis √† jour" ou "l'utilisateur ne peut rien faire pendant que le module se connecte au WiFi".  Bien s√ªr, certaines choses peuvent √™tre effectu√©es par le biais d'interruptions, mais vous pouvez rencontrer une limitation de la dur√©e, l'imbrication des appels ou un changement non atomique de variables.  Eh bien, le code qui fait tout et se transforme imm√©diatement en d√©sordre. <br><br>  Dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet,</a> j'ai utilis√© plus s√©rieusement le multit√¢che pr√©emptif classique et FreeRTOS, mais dans ce cas, le mod√®le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">coroutines et la biblioth√®que uasync</a> se sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">av√©r√©s</a> beaucoup plus adapt√©s.  De plus, la mise en ≈ìuvre Pitonovskiy de la corutine n'est qu'une bombe - pour le programmeur, tout est fait simplement et commod√©ment.  √âcrivez simplement votre propre logique, dites-moi simplement √† quels endroits vous pouvez basculer entre les threads. <br><br>  Je sugg√®re d'explorer les diff√©rences entre l'√©viction et le multit√¢che comp√©titif en option.  Passons maintenant au code. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Counter class - implements a single water counter on specified pin ##################################### class Counter(): debounce_ms = const(25) def __init__(self, pin_num, value_storage): self._value_storage = value_storage self._value = self._value_storage.read() self._value_changed = False self._pin = Pin(pin_num, Pin.IN, Pin.PULL_UP) loop = asyncio.get_event_loop() loop.create_task(self._switchcheck()) # Thread runs forever</span></span></code> </pre> <br>  Chaque compteur est trait√© par une instance de la classe Counter.  Tout d'abord, la valeur initiale du compteur est soustraite de l'EEPROM (value_storage) - c'est ainsi que la r√©cup√©ration apr√®s une panne de courant est mise en ≈ìuvre. <br><br>  La broche est initialis√©e avec un pull-up int√©gr√© √† l'alimentation: si l'interrupteur √† lames est ferm√©, il est √† z√©ro sur la ligne, si la ligne est ouverte, la ligne est tir√©e √† l'alimentation et le contr√¥leur en lit une. <br><br>  En outre, une t√¢che distincte est lanc√©e ici, qui interrogera la broche.  Chaque compteur ex√©cutera sa propre t√¢che.  Voici son code <br><br><pre> <code class="python hljs"> <span class="hljs-string"><span class="hljs-string">""" Poll pin and advance value when another litre passed """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_switchcheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> last_checked_pin_state = self._pin.value() <span class="hljs-comment"><span class="hljs-comment"># Get initial state # Poll for a pin change while True: state = self._pin.value() if state != last_checked_pin_state: # State has changed: act on it now. last_checked_pin_state = state if state == 0: self._another_litre_passed() # Ignore further state changes until switch has settled await asyncio.sleep_ms(Counter.debounce_ms)</span></span></code> </pre> <br>  Un d√©lai de 25 ms est n√©cessaire pour filtrer le rebond de contact, et en m√™me temps, il r√©gule la fr√©quence √† laquelle la t√¢che se r√©veille (pendant que cette t√¢che est en sommeil, d'autres t√¢ches fonctionnent).  Toutes les 25 ms, la fonction se r√©veille, v√©rifie la broche et si les contacts de l'interrupteur √† lames sont ferm√©s, alors un autre litre a travers√© le compteur et cela doit √™tre trait√©. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_another_litre_passed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value += <span class="hljs-number"><span class="hljs-number">1</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self._value_storage.write(self._value)</code> </pre> <br>  Le traitement du litre suivant est trivial - le compteur augmente simplement.  Eh bien, une nouvelle valeur serait bien d'√©crire sur un lecteur flash. <br><br>  Pour faciliter l'utilisation, des ¬´accesseurs¬ª sont fournis. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._value = value self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  Eh bien, maintenant nous allons profiter des plaisirs de python et de la biblioth√®que uasync et rendre le compteur d'objet attendable (comment cela peut-il √™tre traduit en russe? Celui auquel on peut s'attendre?) <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._value_changed: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.value() __iter__ = __await__</code> </pre> <br>  Il s'agit d'une fonction tr√®s pratique qui attend la mise √† jour de la valeur du compteur - la fonction se r√©veille de temps en temps et v√©rifie l'indicateur _value_changed.  La plaisanterie de cette fonction est que le code appelant peut s'endormir lors d'un appel √† cette fonction et dormir jusqu'√† ce qu'une nouvelle valeur soit re√ßue. <br><br><div class="spoiler">  <b class="spoiler_title">Mais qu'en est-il des interruptions?</b> <div class="spoiler_text">  Oui, √† cet endroit, vous pouvez me troller, en disant qu'il a lui-m√™me dit au sujet des interruptions, mais en fait, il a organis√© un stupide sondage de l'√©pingle.  En fait, les interruptions sont la premi√®re chose que j'ai essay√©e.  Dans ESP8266, vous pouvez organiser une interruption sur le bord, et m√™me √©crire un gestionnaire pour cette interruption en python.  Dans cette interruption, vous pouvez mettre √† jour la valeur d'une variable.  Cela suffirait probablement si le compteur √©tait un appareil esclave - un appareil qui attend jusqu'√† ce qu'on lui demande cette valeur. <br><br>  Malheureusement (ou heureusement?) Mon appareil est actif, il doit envoyer des messages en utilisant le protocole MQTT et √©crire des donn√©es dans l'EEPROM.  Et ici, les restrictions existent d√©j√† - vous ne pouvez pas allouer de m√©moire et utiliser une grande pile d'interruptions, ce qui signifie que vous pouvez oublier d'envoyer des messages sur le r√©seau.  Il y a des petits pains comme micropython.schedule () qui vous permettent d'ex√©cuter une sorte de fonction "d√®s que tout de suite", mais la question est "quel est le point?".  Tout √† coup, nous envoyons une sorte de message en ce moment, et ici l'interruption coince et g√¢che les valeurs des variables.  Ou, par exemple, une nouvelle valeur de compteur est arriv√©e du serveur alors que nous n'avons toujours pas not√© l'ancien.  En g√©n√©ral, vous devez cl√¥turer la synchronisation ou sortir diff√©remment. <br><br>  Et de temps en temps, RuntimeError plante: la pile de planification est pleine et qui sait pourquoi? <br><br>  Avec un sondage explicite et uasync, il est dans ce cas en quelque sorte plus beau et plus fiable. <br></div></div><br>  J'ai pris du travail avec EEPROM dans une petite classe <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROM</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> i2c_addr = const(<span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c)</span></span></span><span class="hljs-function">:</span></span> self.i2c = i2c self.i2c_buf = bytearray(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Avoid creation/destruction of the buffer on each call def read(self, eeprom_addr): self.i2c.readfrom_mem_into(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16) return ustruct.unpack_from("&lt;I", self.i2c_buf)[0] def write(self, eeprom_addr, value): ustruct.pack_into("&lt;I", self.i2c_buf, 0, value) self.i2c.writeto_mem(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16)</span></span></code> </pre> <br>  En python, travailler directement avec des octets est difficile, mais ce sont des octets qui sont √©crits en m√©moire.  J'ai d√ª corriger la conversion entre entier et octets √† l'aide de la biblioth√®que ustruct. <br><br>  Afin de ne pas transf√©rer l'objet I2C et l'adresse de la cellule m√©moire √† chaque fois, j'ai envelopp√© le tout dans un petit classique pratique <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROMValue</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c, eeprom_addr)</span></span></span><span class="hljs-function">:</span></span> self._eeprom = EEPROM(i2c) self._eeprom_addr = eeprom_addr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._eeprom.read(self._eeprom_addr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._eeprom.write(self._eeprom_addr, value)</code> </pre> <br>  L'objet I2C lui-m√™me est cr√©√© avec de tels param√®tres <br><br><pre> <code class="python hljs">i2c = I2C(freq=<span class="hljs-number"><span class="hljs-number">400000</span></span>, scl=Pin(<span class="hljs-number"><span class="hljs-number">5</span></span>), sda=Pin(<span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br>  Nous abordons la chose la plus int√©ressante - la mise en ≈ìuvre de la communication avec le serveur via MQTT.  Eh bien, le protocole lui-m√™me n'a pas besoin d'√™tre impl√©ment√© - une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impl√©mentation asynchrone pr√™te √† l'emploi a</a> √©t√© trouv√©e sur Internet.  Ici, nous allons l'utiliser. <br><br>  Tous les plus int√©ressants sont rassembl√©s dans la classe CounterMQTTClient, qui est bas√©e sur la biblioth√®que MQTTClient.  Commen√ßons par la p√©riph√©rie <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Class handles both counters and sends their status to MQTT ##################################### class CounterMQTTClient(MQTTClient): blue_led = Pin(2, Pin.OUT, value = 1) button = Pin(0, Pin.IN) hot_counter = Counter(12, EEPROMValue(i2c, EEPROM_ADDR_HOT_VALUE)) cold_counter = Counter(13, EEPROMValue(i2c, EEPROM_ADDR_COLD_VALUE))</span></span></code> </pre> <br>  Ici, des broches d'ampoules et de boutons sont cr√©√©es et configur√©es, ainsi que des objets de compteurs d'eau froide et chaude. <br><br>  Avec l'initialisation, tout n'est pas si trivial <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.internet_outages = <span class="hljs-number"><span class="hljs-number">0</span></span> self.internet_outage_start = ticks_ms() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"config.txt"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> config_file: config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'server'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'client_id'</span></span>] = config_file.readline().rstrip() self._mqtt_cold_water_theme = config_file.readline().rstrip() self._mqtt_hot_water_theme = config_file.readline().rstrip() self._mqtt_debug_water_theme = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'subs_cb'</span></span>] = self.mqtt_msg_handler config[<span class="hljs-string"><span class="hljs-string">'wifi_coro'</span></span>] = self.wifi_connection_handler config[<span class="hljs-string"><span class="hljs-string">'connect_coro'</span></span>] = self.mqtt_connection_handler config[<span class="hljs-string"><span class="hljs-string">'clean'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> config[<span class="hljs-string"><span class="hljs-string">'clean_init'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> super().__init__(config) loop = asyncio.get_event_loop() loop.create_task(self._heartbeat()) loop.create_task(self._counter_coro(self.cold_counter, self._mqtt_cold_water_theme)) loop.create_task(self._counter_coro(self.hot_counter, self._mqtt_hot_water_theme)) loop.create_task(self._display_coro())</code> </pre> <br>  Pour d√©finir les param√®tres de la biblioth√®que mqtt_as, un grand dictionnaire de diff√©rents param√®tres est utilis√© - config.  La plupart des param√®tres par d√©faut nous conviennent, mais de nombreux param√®tres doivent √™tre d√©finis explicitement.  Afin de ne pas enregistrer les param√®tres directement dans le code, je les stocke dans le fichier texte config.txt.  Cela vous permet de changer le code ind√©pendamment des param√®tres, ainsi que de riveter plusieurs appareils identiques avec des param√®tres diff√©rents. <br><br>  Le dernier bloc de code ex√©cute plusieurs coroutines pour servir diverses fonctions du syst√®me.  Voici un exemple de coroutine au service des compteurs <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_counter_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, counter, topic)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Publish initial value value = counter.value() await self.publish(topic, str(value)) # Publish each new value while True: value = await counter await self.publish_msg(topic, str(value))</span></span></code> </pre> <br>  Dans un cycle, Corutin attend une nouvelle valeur de compteur et d√®s qu'elle appara√Æt, envoie un message en utilisant le protocole MQTT.  Le premier morceau de code envoie la valeur initiale m√™me si l'eau ne coule pas dans le compteur. <br><br>  La classe de base MQTTClient se sert d'elle-m√™me, lance une connexion WiFi et se reconnecte lorsque la connexion est perdue.  Lorsque l'√©tat de la connexion WiFi change, la biblioth√®que nous informe en appelant wifi_connection_handler <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, state)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state: self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is up.'</span></span>) duration = ticks_diff(ticks_ms(), self.internet_outage_start) // <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_debug_msg(<span class="hljs-string"><span class="hljs-string">'ReconnectedAfter'</span></span>, duration) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.internet_outages += <span class="hljs-number"><span class="hljs-number">1</span></span> self.internet_outage_start = ticks_ms() self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is down.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  La fonction est honn√™tement l√©ch√©e des exemples.  Dans ce cas, il prend en compte le nombre de d√©connexions (internet_outages) et leur dur√©e.  Lorsqu'une connexion est r√©tablie, le temps d'arr√™t est envoy√© au serveur. <br><br>  Soit dit en passant, le dernier sommeil n'est n√©cessaire que pour que la fonction devienne asynchrone - dans la biblioth√®que, elle est appel√©e via attendent, et seules les fonctions dans le corps dont il y a un autre attente peuvent √™tre appel√©es. <br><br>  En plus de vous connecter au WiFi, vous devez √©galement √©tablir une connexion avec le courtier MQTT (serveur).  La biblioth√®que le fait √©galement, mais nous avons la possibilit√© de faire quelque chose d'utile lorsque la connexion est √©tablie. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, client)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_cold_water_theme) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_hot_water_theme)</code> </pre> <br>  Ici, nous souscrivons √† plusieurs messages - le serveur a d√©sormais la possibilit√© de d√©finir les valeurs de compteur actuelles en envoyant le message appropri√©. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_msg_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topic, msg)</span></span></span><span class="hljs-function">:</span></span> topicstr = str(topic, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) self.dprint(<span class="hljs-string"><span class="hljs-string">"Received MQTT message topic={}, msg={}"</span></span>.format(topicstr, msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_cold_water_theme: self.cold_counter.set_value(int(msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_hot_water_theme: self.hot_counter.set_value(int(msg))</code> </pre> <br>  Cette fonction traite les messages entrants, et selon le sujet (nom du message), les valeurs de l'un des compteurs sont mises √† jour <br><br>  Quelques fonctions d'assistance <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Publish a message if WiFi and broker is up, else discard async def publish_msg(self, topic, msg): self.dprint("Publishing message on topic {}: {}".format(topic, msg)) if not self.internet_outage: await self.publish(topic, msg) else: self.dprint("Message was not published - no internet connection")</span></span></code> </pre> <br>  Cette fonction envoie des messages si une connexion est √©tablie.  S'il n'y a pas de connexion, le message est ignor√©. <br><br>  Et ce n'est qu'une fonction pratique qui g√©n√®re et envoie des messages de d√©bogage. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_debug_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, subtopic, msg)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_msg(<span class="hljs-string"><span class="hljs-string">"{}/{}"</span></span>.format(self._mqtt_debug_water_theme, subtopic), str(msg))</code> </pre><br>  Tant de texte, mais nous n'avons pas clignot√© une LED.  Ici <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Blink flash LED if WiFi down async def _heartbeat(self): while True: if self.internet_outage: self.blue_led(not self.blue_led()) # Fast blinking if no connection await asyncio.sleep_ms(200) else: self.blue_led(0) # Rare blinking when connected await asyncio.sleep_ms(50) self.blue_led(1) await asyncio.sleep_ms(5000)</span></span></code> </pre> <br>  J'ai fourni 2 modes de clignotement.  Si la connexion est perdue (ou en cours d'√©tablissement), l'appareil clignote rapidement.  Si la connexion est √©tablie, l'appareil clignote toutes les 5 secondes.  Si n√©cessaire, vous pouvez ici impl√©menter d'autres modes de clignotement. <br><br>  Mais la LED est si choyante.  Nous avons toujours salu√© l'affichage. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_display_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> display = SSD1306_I2C(<span class="hljs-number"><span class="hljs-number">128</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>, i2c) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: display.poweron() display.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"COLD: {:.3f}"</span></span>.format(self.cold_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"HOT: {:.3f}"</span></span>.format(self.hot_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) display.show() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) display.poweroff() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.button(): <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br>  C'est ce dont j'ai parl√© - comment simple et pratique avec les coroutines.  Cette petite fonction d√©crit TOUTES les interactions utilisateur.  Corutin n'attend qu'un bouton pour appuyer et allume l'√©cran pendant 3 secondes.  L'√©cran affiche les relev√©s actuels du compteur. <br><br>  Il y a encore quelques petites choses.  Voici la fonction qui ex√©cute toute la batterie (re).  Le cycle principal ne traite que de l'envoi de diverses informations de d√©bogage une fois par minute.  En g√©n√©ral, je cite tel quel - en particulier un commentaire, je pense, n'est pas n√©cessaire <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._connect_to_WiFi() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._run_main_loop() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.dprint(<span class="hljs-string"><span class="hljs-string">'Global communication failure: '</span></span>, e) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_connect_to_WiFi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connecting to WiFi and MQTT'</span></span>) sta_if = network.WLAN(network.STA_IF) sta_if.connect(config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>]) conn = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> conn: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.connect() conn = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connected!'</span></span>) self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_run_main_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Loop forever mins = 0 while True: gc.collect() # For RAM stats. mem_free = gc.mem_free() mem_alloc = gc.mem_alloc() try: await self.publish_debug_msg("Uptime", mins) await self.publish_debug_msg("Repubs", self.REPUB_COUNT) await self.publish_debug_msg("Outages", self.internet_outages) await self.publish_debug_msg("MemFree", mem_free) await self.publish_debug_msg("MemAlloc", mem_alloc) except Exception as e: self.dprint("Exception occurred: ", e) mins += 1 await asyncio.sleep(60)</span></span></code> </pre> <br>  Eh bien, quelques param√®tres et constantes suppl√©mentaires pour compl√©ter la description <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Constants and configuration ##################################### config['keepalive'] = 60 config['clean'] = False config['will'] = ('/ESP/Wemos/Water/LastWill', 'Goodbye cruel world!', False, 0) MQTTClient.DEBUG = True EEPROM_ADDR_HOT_VALUE = const(0) EEPROM_ADDR_COLD_VALUE = const(4)</span></span></code> </pre> <br>  √áa commence comme √ßa <br><br><pre> <code class="python hljs">client = CounterMQTTClient() loop = asyncio.get_event_loop() loop.run_until_complete(client.main())</code> </pre> <br><br><h3>  Quelque chose avec ma m√©moire est devenu </h3><br>  Donc, tout le code est l√†.  J'ai t√©l√©charg√© les fichiers √† l'aide de l'utilitaire ampy - il leur permet d'√™tre t√©l√©charg√©s sur le lecteur flash interne (celui qui se trouve dans ESP-07 lui-m√™me), puis accessibles depuis le programme en tant que fichiers normaux.  L√†, j'ai t√©l√©charg√© les biblioth√®ques mqtt_as, uasyncio, ssd1306 et collections (utilis√©es dans mqtt_as) que j'utilise. <br><br>  Nous commen√ßons et ... Nous recevons MemoryError.  De plus, plus j'essayais de comprendre exactement o√π la m√©moire fuyait, plus j'organisais le d√©bogage des impressions, plus t√¥t cette erreur s'√©tait produite.  Un court gugelezh m'a fait comprendre que, en principe, le microcontr√¥leur ne dispose que de 30 Ko de m√©moire dans lesquels 65 Ko de code (avec les biblioth√®ques) ne correspondent en aucune fa√ßon. <br><br>  Mais il y a un moyen.  Il s'av√®re que micropython n'ex√©cute pas le code directement √† partir du fichier .py - ce fichier est d'abord compil√©.  Et il compile directement sur le microcontr√¥leur, se transforme en bytecode, qui est ensuite stock√© en m√©moire.  Eh bien, pour que le compilateur fonctionne, vous avez √©galement besoin d'une certaine quantit√© de RAM. <br><br>  L'astuce consiste √† sauver le microcontr√¥leur d'une compilation gourmande en ressources.  Vous pouvez compiler des fichiers sur un grand ordinateur et remplir le bytecode fini dans le microcontr√¥leur.  Pour ce faire, t√©l√©chargez le micrologiciel micropython et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cr√©ez l'utilitaire mpy-cross</a> . <br><br>  Je n'ai pas √©crit de Makefile, mais j'ai parcouru manuellement et compil√© tous les fichiers n√©cessaires (y compris les biblioth√®ques) comme celui-ci <br><br><pre> <code class="bash hljs">mpy-cross water_counter.py</code> </pre> <br>  Il ne reste plus qu'√† t√©l√©charger des fichiers avec l'extension .mpy, sans oublier de supprimer d'abord le .py correspondant du syst√®me de fichiers de l'appareil. <br><br>  J'ai r√©alis√© tout le d√©veloppement du programme (IDE?) ESPlorer.  Il vous permet de t√©l√©charger des scripts sur le microcontr√¥leur et de les ex√©cuter imm√©diatement.  Dans mon cas, toute la logique et la cr√©ation de tous les objets se trouvent dans le fichier water_counter.py (.mpy).  Mais pour que tout cela d√©marre automatiquement, au d√©but, il doit y avoir un autre fichier appel√© main.py.  Et ce devrait √™tre exactement .py, et non un .mpy pr√©-compil√©.  Voici son contenu trivial <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> water_counter</code> </pre> <br>  Nous commen√ßons - tout fonctionne.  Mais il y a dangereusement peu de m√©moire libre - environ 1 Ko.  J'ai toujours l'intention d'√©tendre les fonctionnalit√©s de l'appareil, et ce kilo-octet ne sera √©videmment pas suffisant pour moi.  Mais il s'est av√©r√© qu'il y avait une issue √† cette affaire. <br><br>  Voici le truc.  M√™me si les fichiers sont compil√©s en bytecode et se trouvent sur le syst√®me de fichiers interne, en fait, ils sont toujours charg√©s dans la RAM et ex√©cut√©s √† partir de l√†.  Mais il s'av√®re que le micropython est capable d'ex√©cuter le bytecode directement √† partir de la m√©moire flash, mais pour cela, vous devez l'int√©grer directement dans le firmware.  Ce n'est pas difficile, m√™me si cela a pris un temps d√©cent sur mon netbook (seulement l√†, j'ai eu Linux). <br><br>  L'algorithme est le suivant: <br><br><ul><li>  T√©l√©chargez et installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP Open SDK</a> .  Cette chose construit un compilateur et des biblioth√®ques pour les programmes sous ESP8266.  Il est assembl√© selon les instructions de la page principale du projet (j'ai choisi le r√©glage STANDALONE = oui) </li><li>  T√©l√©charger <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Micropython Sorts</a> </li><li>  D√©posez les biblioth√®ques n√©cessaires dans les ports / esp8266 / modules √† l'int√©rieur de l'arborescence de micropython </li><li>  Nous assemblons le firmware selon les instructions du <a href="">fichier ports / esp8266 / README.md</a> </li><li>  Versez le firmware dans le microcontr√¥leur (je le fais sur Windows avec les programmes ESP8266Flasher ou Python esptool) </li></ul><br>  Voil√†, maintenant 'import ssd1306' augmentera le code directement depuis le firmware et la RAM ne sera pas d√©pens√©e pour cela.  Avec cette astuce, j'ai t√©l√©charg√© uniquement le code de la biblioth√®que dans le firmware, tandis que le code du programme principal est ex√©cut√© √† partir du syst√®me de fichiers.  Cela vous permet de modifier facilement le programme sans recompiler le firmware.  Pour le moment, j'ai environ 8,5 Ko de RAM libre.  Cela permettra de mettre en ≈ìuvre un grand nombre de fonctionnalit√©s utiles diff√©rentes √† l'avenir.  Eh bien, s'il n'y a pas assez de m√©moire, vous pouvez √©galement pousser le programme principal dans le firmware. <br><br><h3>  Et qu'en faire maintenant? </h3><br>  Ok, le mat√©riel est soud√©, le firmware est √©crit, la bo√Æte est imprim√©e, l'appareil est coll√© au mur et clignote joyeusement avec une ampoule.  Mais alors que tout cela est une bo√Æte noire (au sens litt√©ral et figur√©) et le sens de celui-ci n'est toujours pas suffisant.  Il est temps de faire quelque chose avec les messages MQTT qui sont envoy√©s au serveur. <br><br>  Ma ¬´maison intelligente¬ª tourne sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le syst√®me Majordomo</a> .  Le module MQTT est soit pr√™t √† l'emploi, soit il peut √™tre facilement install√© √† partir du march√© des modules compl√©mentaires - je ne me souviens plus d'o√π il vient.  Chose MQTT n'est pas autosuffisant - le soi-disant  broker - un serveur qui re√ßoit, trie et redirige les messages MQTT vers les clients.  J'utilise moustique, qui (comme majordomo) s'ex√©cute tous sur le m√™me netbook. <br><br>  Une fois que l'appareil a envoy√© un message au moins une fois, la valeur appara√Æt imm√©diatement dans la liste. <br><br><img src="https://habrastorage.org/webt/hf/ip/db/hfipdb1coxh_lsaaz600mi-39y0.png"><br><br>  Ces valeurs peuvent d√©sormais √™tre associ√©es √† des objets syst√®me, elles peuvent √™tre utilis√©es dans des scripts d'automatisation et soumises √† diverses analyses - tout cela est hors de port√©e de cet article.  Qui s'int√©resse au syst√®me majordomo, je peux recommander <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le canal Electronics In Lens</a> - un ami construit √©galement une maison intelligente et parle intelligemment de la configuration du syst√®me. <br><br>  Je ne montrerai que quelques graphiques.  Il s'agit d'un simple graphique de valeurs quotidiennes. <br><br><img src="https://habrastorage.org/webt/km/hw/xr/kmhwxruql1fk0kmykb1gpcpci_0.png"><br>  On peut voir que presque personne n'utilisait d'eau la nuit.  Quelques fois, quelqu'un est all√© aux toilettes, et il semble qu'un filtre √† osmose inverse suce quelques litres par nuit.  Le matin, la consommation augmente consid√©rablement.  Habituellement, j'utilise l'eau d'une chaudi√®re, mais je voulais ensuite prendre un bain et passer temporairement √† l'eau chaude de la ville - cela est √©galement clairement visible sur le graphique du bas. <br><br>  Gr√¢ce √† ce programme, j'ai appris qu'aller aux toilettes, c'est 6-7 litres d'eau, prendre une douche - 20-30 litres, laver la vaisselle environ 20 litres, et pour prendre un bain, vous avez besoin de 160 litres.  Pendant une journ√©e, ma famille consomme quelque part entre 500 et 600 litres. <br><br>  Pour les plus curieux, vous pouvez consulter les entr√©es pour chaque valeur individuelle <br><br><img src="https://habrastorage.org/webt/8l/8i/su/8l8isu_aiaswajdeeuexytpwffi.png"><br><br>  De l√†, j'ai appris qu'avec le robinet ouvert, l'eau coule √† une vitesse d'environ 1 litre en 5 secondes. <br><br>  Mais sous cette forme, les statistiques ne sont probablement pas tr√®s pratiques √† regarder.  √Ä majordomo, il est toujours possible de voir les graphiques de consommation par jour, semaine et mois.  Par exemple, un graphique de la consommation en colonnes <br><br><img src="https://habrastorage.org/webt/m3/wa/sf/m3wasfzbvxb2tz1yhemod2ewwdy.png"><br><br>  Jusqu'√† pr√©sent, je n'ai que des donn√©es pour une semaine.  Dans un mois, ce graphique sera plus indicatif - une colonne s√©par√©e correspondra √† chaque jour.  Les ajustements des valeurs que j'entre g√¢chent manuellement l'image un peu (la plus grande colonne).  Et il n'est pas encore clair si j'ai mal r√©gl√© les premi√®res valeurs de presque un cube de moins, ou si c'est un bug dans le firmware et que tous les litres ne sont pas entr√©s dans la compensation.  Cela prend plus de temps. <br><br>  Il faut encore √©voquer les graphiques eux-m√™mes, blanchir, colorer.  Peut-√™tre que je vais √©galement construire un graphique de la consommation de m√©moire √† des fins de d√©bogage - soudain, quelque chose fuit.  Peut-√™tre que je vais en quelque sorte afficher les p√©riodes o√π Internet n'√©tait pas disponible.  Alors que tout cela tourne au niveau des id√©es. <br><br><h3>  Conclusion </h3><br>  Aujourd'hui, mon appartement est devenu un peu plus intelligent.  Avec un si petit appareil, il sera plus pratique pour moi de surveiller la consommation d'eau dans la maison.  Si plus t√¥t j'√©tais indign√© "encore une fois ils ont consomm√© beaucoup d'eau en un mois", maintenant je peux trouver la source de cette consommation. <br><br>  Il semblerait √©trange √† quelqu'un de regarder les lectures sur l'√©cran s'il est √† un m√®tre du compteur lui-m√™me.  Mais dans un avenir pas trop lointain, je pr√©vois de d√©m√©nager dans un autre appartement, o√π il y aura plusieurs colonnes montantes, et les compteurs eux-m√™mes seront tr√®s probablement situ√©s sur le palier.  Un appareil de lecture √† distance serait donc tr√®s utile. <br><br>  Je pr√©vois √©galement d'√©tendre les fonctionnalit√©s de l'appareil.  Je regarde d√©j√† les vannes motoris√©es.  Maintenant, pour changer l'eau de la chaudi√®re, je dois ouvrir 3 robinets dans une niche inaccessible.  Il serait beaucoup plus pratique de le faire avec un seul bouton avec l'indication appropri√©e.  Eh bien, bien s√ªr, il vaut la peine de mettre en ≈ìuvre une protection contre les fuites. <br><br>  Dans l'article, j'ai expliqu√© ma version de l'appareil bas√© sur ESP8266.  √Ä mon avis, j'ai obtenu une version tr√®s int√©ressante du microprogramme micropython utilisant coroutine - simple et jolie.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai essay√© de d√©crire les nombreuses nuances et √©coles que j'ai rencontr√©es avec la campagne. </font><font style="vertical-align: inherit;">J'ai peut-√™tre tout d√©crit avec trop de d√©tails, pour moi personnellement, en tant que lecteur, il est plus facile de gaspiller trop que de penser ce qui n'a pas √©t√© dit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme toujours, je suis ouvert √† des critiques constructives. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Circuit de </font></a></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mod√®le de bo√Ætier de carte</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr411259/">https://habr.com/ru/post/fr411259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr411249/index.html">Comment j'ai fait mon Yandex.Transport avec les horaires et les bus</a></li>
<li><a href="../fr411251/index.html">Les utilisateurs ne sont pas satisfaits des fichiers de num√©risation Chrome sur le disque local</a></li>
<li><a href="../fr411253/index.html">La fusion des √©toiles √† neutrons a mis fin aux alternatives de la mati√®re noire et de l'√©nergie noire</a></li>
<li><a href="../fr411255/index.html">Des applications d√©centralis√©es pour des millions d'utilisateurs sur Ethereum</a></li>
<li><a href="../fr411257/index.html">Aux √âtats-Unis, ils cr√©ent un syst√®me laser qui effrayera l'ennemi par le son</a></li>
<li><a href="../fr411261/index.html">R√©ponse vibratoire dans les proth√®ses: une nouvelle fa√ßon d'am√©liorer le contr√¥le des membres bioniques</a></li>
<li><a href="../fr411263/index.html">Bouton magique pour LED sur ATtiny4</a></li>
<li><a href="../fr411265/index.html">Cas d'espionnage (partie 3)</a></li>
<li><a href="../fr411267/index.html">Qui est vraiment derri√®re les nouveaux smartphones de marque Nokia?</a></li>
<li><a href="../fr411269/index.html">Les trois composantes de ¬´LOAD¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>