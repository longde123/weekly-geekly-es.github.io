<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèø üïë üßíüèº Piratage d'une cartouche couleur HP: la transformer en imprimante portable üíÜ üíè üß°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 
 Depuis la jeunesse, lorsque nous avions l'ancien DeskJet, je m'int√©ressais aux cartouches d'imprimante √† jet d'encre. Ces cartouches se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Piratage d'une cartouche couleur HP: la transformer en imprimante portable</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443582/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/78b/dee/afd/78bdeeafddeac0cebecd298e836e42d1.jpg" alt="image"></div><br><h1>  Pr√©sentation </h1><br>  Depuis la jeunesse, lorsque nous avions l'ancien DeskJet, je m'int√©ressais aux cartouches d'imprimante √† jet d'encre.  Ces cartouches semblaient tr√®s int√©ressantes et d√®s qu'elles manquaient d'encre, je les prenais imm√©diatement pour moi.  A cette √©poque, je ne pouvais rien faire avec eux, sauf pour d√©monter et me salir les mains ... Bien que je sache qu'il y avait une sorte d'√©lectronique complexe √† l'int√©rieur, mais quand les contacts ont touch√© la batterie, rien d'int√©ressant ne s'est pass√©, et ma connaissance de l'√©lectronique pour plus pas assez. <br><br>  Un peu plus tard, quand je suis devenu √©tudiant, j'ai r√©ussi √† me procurer une vieille imprimante √† jet d'encre.  A cette √©poque, j'utilisais moi-m√™me une imprimante laser, donc √ßa ne m'int√©ressait pas beaucoup, mais c'√©tait int√©ressant d'examiner les cartouches et d'essayer de les d√©sosser.  J'ai en fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit un article</a> sur la gestion de ces cartouches, et m√™me si elles fonctionnaient assez bien, il y avait aussi des inconv√©nients: je ne pouvais toujours pas d√©terminer l'ordre exact des buses, la cartouche √©tait uniquement monochrome (imprim√©e avec un magenta), et √©galement assez ancienne, et donc la r√©solution s'est av√©r√© assez faible. <br><br>  R√©cemment, ma petite amie a commenc√© √† peindre, donc c'√©tait une bonne excuse pour revenir aux cartouches d'encre dans l'espoir que je serais en mesure de dessiner quelque chose sur toile.  Cette fois, j'ai eu de la chance: j'ai r√©ussi √† trouver un moyen de lier toutes les buses aux bons signaux.  De plus, les cartouches d'imprimante contr√¥lent aujourd'hui plus de buses en utilisant moins de signaux, ce qui simplifie la gestion des cartouches et augmente la surface pouvant √™tre couverte en un seul passage. <br><a name="habracut"></a><br>  J'ai finalement r√©ussi √† contr√¥ler la cartouche trichromique et √† imprimer en quadrichromie! <br><br>  Si vous voulez aller avec moi du tas d'imprimantes au contr√¥le complet de la cartouche d'imprimante, j'en ai fait un rapport √† Hackaday Supercon 2018. L'enregistrement vid√©o du discours est ajout√© ci-dessous.  Si vous √™tes int√©ress√© par les d√©tails de la r√©tro-ing√©nierie, consultez-la.  Dans l'article, je parlerai des d√©tails techniques de l'√©lectronique que j'ai cr√©√©e, ainsi que des d√©tails sp√©cifiques de la gestion de la cartouche afin que vous puissiez vous-m√™me dessiner le Nyancat en utilisant ESP32 ou un autre microcontr√¥leur. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/KjACWDPQ8nw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1>  Attachement de pr√©sentation </h1><br>  Si vous n'avez pas regard√© la vid√©o, voici un bref r√©sum√©: j'ai d√©mont√© la cartouche couleur pour l'imprimante HP1112 (en Chine, il s'agit d'une cartouche HP 803, mais le num√©ro d'article d√©pend de la r√©gion), j'ai pris des photos du cristal et j'ai essay√© de comprendre comment cela fonctionne.  Quand je n'ai pas pu en savoir beaucoup, j'ai commenc√© √† lire les signaux transmis entre l'imprimante et la cartouche, j'ai d√©termin√© quels signaux envoyer pour que la cartouche ob√©isse √† mes commandes, puis j'ai imprim√© Nyancat et d'autres choses amusantes. <br><br>  La partie de synchronisation du signal de l'√©tude √©tait principalement un processus d'essais et d'erreurs.  Je ne peux que deviner quel type de connexion existe entre les signaux, il √©tait donc assez difficile de comprendre l'ordre entre les bords et quels signaux peuvent √™tre retard√©s et lesquels doivent √™tre transmis √† temps.  J'ai √©tudi√© une cartouche de silicium pour cette information.  Il s'est av√©r√© que j'ai r√©ussi √† l'obtenir en pla√ßant la cartouche sous le microscope, mais pas du tout comme je m'y attendais. <br><br>  Avant de parler √† Supercon, j'ai √©tudi√© les cartouches couleur car elles me semblaient les plus int√©ressantes.  √Ä mon retour de Supercon, je voulais faire de l'ing√©nierie inverse de la cartouche noire: sa t√™te d'impression est plus grande que celle de la cartouche couleur, donc je pouvais imprimer plus √† la fois.  Il n'est probablement pas difficile non plus d'ajouter un support pour cette cartouche: la disposition des broches semble la m√™me, et je savais que le protocole serait probablement similaire, car j'avais d√©j√† essay√© de connecter la cartouche noire √† mon mat√©riel.  M√™me si le logiciel transmettait des images en couleur, il a quand m√™me r√©ussi √† imprimer quelque chose. <br><br>  Voici ce que j'ai fait avec la cartouche couleur: je l'ai coll√©e sous le microscope, retir√© le rev√™tement en silicone des contacts et pr√©par√© √† combiner plusieurs clich√©s en une seule grande image.  Cependant, la cartouche noire diff√©rait de la couleur en ce qu'il y avait plus d'inscriptions sur sa plaque m√©tallique avec des buses: sous le rev√™tement en silicone, il y avait des noms de signaux cach√©s pour tous les contacts! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/31c/cd7/ceb/31ccd7cebca89ee82bf17246cc42970b.jpg" alt="image"></div><br>  (Au fait, si vous voulez voir des images au microscope compl√®tes dans toute la grandeur de 40 m√©gapixels, alors voici le <a href="">bouclier</a> et le <a href="">silicium de la</a> cartouche couleur! Admirez la complexit√© des <a href="">buses</a> et l' <a href="">image cristalline de la</a> cartouche noire!) <br><br>  Bien que cela puisse ne pas sembler beaucoup, dans une mer de cartes de circuits imprim√©s non marqu√©es, de puces sans mat√©riaux de r√©f√©rence et articles qui ne m√®nent nulle part, les noms de plusieurs signaux sont une vraie trouvaille.  Sur une intuition, j'ai conduit des noms de signaux individuels avec le nom "Hewlett Packard" dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google Brevets</a> et d√©couvert un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">brevet sp√©cifique</a> (et un autre, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus ancien</a> r√©f√©renc√© par le premier) avec une description claire des technologies et des signaux utilis√©s dans les cartouches.  Cela me ferait gagner beaucoup de temps lorsque je me d√©battais avec le timing des cartouches ... eh bien.  Je peux dire sinc√®rement que cet indice √©tait tr√®s difficile √† trouver: les signaux √©taient non seulement recouverts d'un film de silicone, mais aussi minuscules: les lettres ne mesurent que 30 microm√®tres, ce qui est inf√©rieur √† l'√©paisseur d'un cheveu humain. <br><br>  Le brevet d√©crit le fonctionnement interne de la cartouche et m√©rite d'√™tre lu (si vous pouvez comprendre le jargon juridique utilis√© ici) juste pour comprendre comment la logique √©trange que HP utilise parfois pour contr√¥ler toutes les buses.  Le brevet lui-m√™me est utile, mais pas suffisant pour contr√¥ler la cartouche;  au moins la majeure partie du travail d'ing√©nierie inverse que j'ai entrepris serait encore n√©cessaire, m√™me si j'avais ce brevet. <br><br>  Ici et ci-dessous, j'utiliserai les noms des signaux et contacts utilis√©s dans le brevet.  Veuillez noter que dans le code mes propres noms de signaux peuvent toujours √™tre trouv√©s;  Je vais inclure une table de traduction avec la documentation. <br><br><h1>  Encodage des donn√©es </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e3d/a27/9b5/e3da279b5a469d8257956df6e1b213d0.jpg"></div><br>  Voici donc √† quoi ressemblent les cartouches √† l'√©tude.  √Ä premi√®re vue, ce sont des appareils assez simples: √† l'int√©rieur, ils sont presque enti√®rement constitu√©s d'une √©ponge imbib√©e d'encre.  Dans le cas de la cartouche livr√©e avec l'imprimante, il y a tr√®s peu d'encre: seulement la moiti√© de l'espace dans la cartouche est occup√©e par les √©ponges, et les √©ponges elles-m√™mes sont √©galement √† moiti√© vides: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d9/8c5/236/1d98c523675454d7f5cd6dbb88a2c685.jpg"></div><br>  Sur le c√¥t√©, 16 contacts partent du bas o√π se trouve la t√™te d'impression.  Comme vous pouvez le voir au microscope, il y a environ 336 buses dans la t√™te d'impression de la cartouche noire et 612 buses dans la cartouche couleur.  Les buses sont dispos√©es en rang√©es verticales sur la t√™te d'impression, et chaque buse peut √™tre contr√¥l√©e √©lectroniquement de sorte qu'elle tire une petite goutte d'encre vers le bas du c√¥t√© du papier ins√©r√© dans l'imprimante.  En d√©pla√ßant la t√™te verticalement, l'imprimante peut imprimer une ¬´bande¬ª ou toute autre image;  dans le cas d'une cartouche noire, cette bande mesure environ 15 mm de long et 8 mm pour une cartouche couleur. <br><br>  De toute √©vidence, les buses peuvent √™tre contr√¥l√©es √† l'aide de contacts.  Selon les minuscules inscriptions des t√™tes d'impression, les contacts contiennent les signaux suivants: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c4/10e/534/4c410e5349ffd16a8c97aed093121492.jpg"></div><br>  Puisqu'il n'y a que 16 contacts, il doit y avoir une sorte de sch√©ma de multiplexage pour contr√¥ler toutes les buses.  Le brevet explique comment cela fonctionne: le contr√¥le des buses est divis√© en 14 groupes distincts.  Ces groupes sont d√©clench√©s s√©quentiellement: ils re√ßoivent d'abord leurs donn√©es et le groupe 1 est d√©clench√©, puis le groupe 2, etc.  Chaque groupe contr√¥le un maximum de 24 buses, et leurs donn√©es sont transmises via trois bus de donn√©es.  Dans le cas d'une cartouche couleur, les donn√©es dans les trois bus correspondent aux couleurs: D1 sont les donn√©es jaunes, D2 sont les donn√©es magenta et D3 contr√¥le les buses cyan. <br><br>  Dans le brevet, le travail est d√©crit en d√©tail en utilisant un bus de donn√©es comme exemple.  Cette figure du brevet montre les signaux utilis√©s: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8f/554/372/a8f554372c6edfc81bf606ff6cf9907f.png"></div><br>  Le bus de donn√©es contient huit octets, 0-7.  M√™me les octets sont contr√¥l√©s par le bord arri√®re de DCLK, les octets impairs sont contr√¥l√©s par les bords arri√®re de S1-S4.  Les buses dont les donn√©es sont contr√¥l√©es par les quatre premiers octets peuvent √™tre activ√©es en fournissant de l'√©nergie via le bus d'alimentation F3;  les buses associ√©es aux quatre derniers bits sont activ√©es par le bus F5. <br><br>  Je ne sais pas pourquoi HP a d√©cid√© d'utiliser un circuit aussi complexe pour g√©rer les donn√©es des buses.  Nous pouvons dire que quelque chose d'√©vident, comme un registre √† d√©calage, aurait fonctionn√© normalement ici.  Je comprends que HP utilise ses brevets comme une arme contre les soci√©t√©s de recharge de cartouches;  peut-√™tre que quelqu'un a d√©j√† brevet√© une solution plus simple, et il a d√ª trouver cette solution plus complexe pour √™tre unique. <br><br>  Sur ce graphique, r√©alis√© par mes soins sur un analyseur logique, il n'est pas difficile de retrouver les signaux d√©crits dans le brevet: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/50e/35e/025/50e35e02575c1508d44b21ba29acb909.png"></div><br>  En plus de contr√¥ler les buses, la cartouche a √©galement besoin d'un signal (csync) pour passer au groupe de buses suivant ou pour se r√©initialiser et revenir au premier groupe.  Il peut √™tre vu dans l'image de l'analyseur logique: il montre l'avant-dernier et le dernier groupe de 14, et le signal csync a une forme reconnaissable dans le dernier groupe;  il effectue une ¬´r√©initialisation¬ª de la cartouche afin que le premier groupe re√ßoive ensuite les donn√©es.  Ce signal peut √©galement √™tre utilis√© pour contourner des groupes de buses dans l'ordre inverse;  ceci est utile lorsque la t√™te d'impression se d√©place de gauche √† droite et de droite √† gauche.  Bien que le deuxi√®me brevet d√©crive comment cela fonctionne, j'ai d√©cid√© de simplement coder la transition vers le groupe suivant et de r√©initialiser les signaux affich√©s dans mes images par la ligne csync. <br><br>  Notez que tout cela se produit √† une vitesse assez √©lev√©e;  le retard entre les deux fronts avant du signal DCLK est d'environ 0,4 ¬µs, et la distance entre les groupes est d'environ 4 ¬µs. <br><br>  Nous savons maintenant que chaque bit de ces trois bus de donn√©es de 14 octets contient une commande d'op√©ration pour une buse.  Si le bit est 0, la buse correspondante est d√©clench√©e;  s'il est √©gal √† 1, la buse ne fonctionne pas.  Ce que nous ne savons pas, c'est la correspondance entre les bits et les buses.  Si vous avez regard√© la pr√©sentation, vous savez comment j'ai r√©ussi √† le comprendre: j'ai imprim√© un motif connu sur une imprimante en √©tat de marche, interceptant les signaux √† l'aide d'un analyseur logique, puis j'ai d√©termin√© l'ordre des signaux afin de d√©coder les signaux vers l'image d'origine. <br>  . <br>  Malheureusement, la correspondance des bits aux buses semble assez constante, mais pas compl√®tement logique.  Il semble que cela soit principalement d√ª √† la n√©cessit√© de d√©placer physiquement les buses simultan√©ment √† une distance suffisante (pour √©viter une surchauffe ou l'apparition d'un vide local dans le r√©servoir d'encre).  En outre, j'ai √©galement constat√© que la facilit√© de routage des signaux dans une cartouche peut rendre la correspondance entre les bits et les buses assez d√©routante.  Dans mon firmware, j'ai simplement impl√©ment√© ce mappage comme un ensemble de tables de recherche. <br><br><h1>  √âlectronique </h1><br>  Maintenant que nous savons comment fonctionnent les signaux, nous pouvons contr√¥ler la cartouche d'imprimante avec un simple microcontr√¥leur, non?  Enfin, pas tout de suite.  La cartouche d'imprimante n'utilise pas une logique simple 5 V ou 3,3 V. Les bus de donn√©es sont contr√¥l√©s par des bus 16 V ou 9 V. Les bus d'alimentation sont √©galement contr√¥l√©s par 16 V et, en fait, en fonction du nombre de buses d√©clench√©es, ils peuvent √™tre tir√©s jusqu'au courant d'alimentation .  Nous devons effectuer une conversion de niveau. <br><br>  En tant que convertisseur de niveau, j'ai choisi le MC14504.  Il s'agit d'une ancienne puce de conversion de niveau hexad√©cimale unidirectionnelle qui peut augmenter la tension √† 18 V.Bien que cette puce fonctionne √©galement, avec le recul, je peux dire que ce n'√©tait pas le meilleur choix: elle ne peut produire que quelques mA et a un retard de propagation assez important.  Je pense qu'il fournit un retard de certains signaux de sortie en fonction de la cartouche et de la charge appliqu√©e aux sorties de la puce.  J'ai au moins une cartouche qui a besoin d'un petit ajustement de synchronisation pour que les signaux fonctionnent, et je pense que c'est la raison.  Malheureusement, les convertisseurs de niveau 16V pr√™ts √† l'emploi ne sont pas aussi accessibles aujourd'hui, donc je ne peux pas le remplacer par quelque chose de mieux.  Cependant, cette puce classique avec un peu d'ajustement suffit amplement. <br><br>  Avec les bus √©lectriques, les choses sont un peu plus compliqu√©es.  En plus du fait que ces contacts absorbent une grande partie du courant, ils sont √©galement directement connect√©s aux r√©sistances des buses incluses: si, pour une raison quelconque, l'alimentation est fournie trop longtemps, ces minuscules r√©sistances br√ªleront et la buse √©chouera compl√®tement.  De plus, ce ¬´trop long¬ª est assez simple √† r√©aliser: il suffit d'allumer les buses pendant seulement quelques microsecondes, et si vous n'alimentez que pendant une milliseconde, elles s'√©vaporeront simplement, cassant compl√®tement la buse.  Pour √©viter que cela ne se produise en raison d'un bug logiciel ou d'une mauvaise connexion, j'ai ajout√© une logique mat√©rielle qui garantit que l'impulsion est limit√©e √† un petit multiple de 10 Œºs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/802/293/dd0/802293dd067f458f2505e2db8036ab96.png"></div><br>  Dans le premier prototype, j'ai laiss√© plusieurs convertisseurs de niveau et je ne savais pas comment le logiciel fonctionnerait, j'ai donc r√©solu le probl√®me avec un v√©ritable multivibrateur √† cycle unique.  Dans ce circuit, deux multivibrateurs sont utilis√©s dans le 74HC123, g√©n√©rant des impulsions, dont la largeur est d√©finie par la combinaison de R / C connect√© √† la broche RCExt.  L'impulsion r√©sultante est g√©n√©r√©e uniquement avec un signal d'entr√©e croissant, de sorte qu'un signal constamment √©lev√© ne conduira √† rien d'autre qu'une impulsion de sortie d√©finie avec pr√©cision, mais parasite.  Apr√®s cela, le canal MC14504 est utilis√© comme convertisseur de niveau pour augmenter la tension √† +16 V, et le transistor MOS √† canal P fournit le courant n√©cessaire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99b/b17/97f/99bb1797fd10e01c1c8f3a7ddceb6c8f.png"></div><br>  Sur la deuxi√®me carte de circuit imprim√©, j'ai r√©alis√© que si je change la logique des contacts de puissance afin qu'ils n'utilisent pas deux canaux du circuit de d√©calage de niveau, alors seulement deux puces MC14504 suffiront.  Maintenant, j'ai un bon contr√¥le programmatique sur la largeur d'impulsion, mais je veux toujours avoir une protection contre un signal de contact d'entr√©e constamment √©lev√©.  Voici le sch√©ma auquel je suis arriv√©.  Cela fonctionne comme ceci: dans l'√©tat normal avec un signal faible PWRB_IN, le condensateur C28 est vide, car toute tension y circule lentement le long de R20 et R21: la grille du transistor Q4 est √©lev√©e, et PWRB_OUT est d√©connect√© du bus d'alimentation 16 V. D√®s que PWRB_IN √©lev√© appara√Æt √©lev√© signal, Q6 masse une extr√©mit√© de C28;  comme la tension aux bornes de celle-ci est de 0 V, cela abaisse √©galement son autre c√¥t√©, qui est connect√© √† la grille Q4.  Le fait de tirer l'obturateur Q4 vers le bas le rend conducteur, ce qui permet au courant de circuler de +16 V √† PWRB_OUT.  Dans l'√©tat normal, PWRB_IN revient assez rapidement √† l'√©tat bas, fermant la porte Q4 et interrompant le courant.  Cependant, alors que PWRB_IN est faible, le C28 se charge lentement: un c√¥t√© est mis √† la terre √† Q6, et l'autre est connect√© √† 16 V via R21 et R31.  Lorsque le condensateur est suffisamment charg√©, Q4 ¬´voit¬ª un niveau √©lev√© sur sa grille et coupe le courant dans PWRB_OUT, m√™me si PWRB_IN est toujours dans un √©tat de signal √©lev√©.  Ce m√©canisme garantit que PWRB_OUT ne fournit de l'√©nergie que pendant une dur√©e limit√©e. <br><br>  Le circuit poss√®de √©galement une petite r√©sistance connect√©e en s√©rie avec le bus d'alimentation 16 V (R31), ainsi qu'un petit condensateur connect√© en parall√®le avec le signal de sortie (C15).  Ils sont n√©cessaires pour "rel√¢cher la tension" du signal de puissance: sans eux, une mise en marche / arr√™t nette Q4 induira un tas d'interf√©rences √©lectromagn√©tiques, d√©formant les signaux transmis √† la cartouche. <br><br>  √Ä part cette logique, rien de plus n'est n√©cessaire.  √âvidemment, des convertisseurs de niveau +9 V et +16 V sont n√©cessaires. L'alimentation +9 V devrait √™tre assez modeste: je n'ai pas remarqu√© que ces bus utilisaient g√©n√©ralement plus de quelques mA.  Puisqu'elle alimente les r√©sistances des buses, la source 16 V devrait √™tre un peu plus forte: je l'ai fait pour que la mienne puisse fournir au moins 400 mA en continu, et j'ai √©galement ajout√© beaucoup de capacit√© de d√©couplage. <br><br>  Enfin, le fardeau le plus important du traitement de l'image et de la g√©n√©ration du signal incombe au microcontr√¥leur.  Pour cela, j'ai choisi ESP32, principalement parce que j'ai pris quelques morceaux de travail, mais aussi parce qu'il a un contr√¥leur I2S assez puissant qui utilise un mode parall√®le tr√®s pratique: en fait, on peut juste r√©gler la fr√©quence d'horloge, sp√©cifiez la zone de m√©moire pour le contr√¥leur I2S et il sortira ces octets en parall√®le.  Gr√¢ce √† cela, il est id√©al pour g√©n√©rer les signaux de commande n√©cessaires;  Le fait qu'il dispose de deux c≈ìurs puissants de 240 MHz contribue √©galement au traitement d'image. <br><br><h1>  Prototype </h1><br>  Bien s√ªr, plusieurs convertisseurs et transistors MOS ne peuvent pas √† eux seuls devenir un contr√¥leur de cartouche d'imprimante fonctionnel.  Par cons√©quent, j'ai cr√©√© un appareil s√©par√©, con√ßu comme une plate-forme pour exp√©rimenter avec une cartouche et ses capacit√©s.  Il poss√®de un module ESP32, la logique n√©cessaire pour contr√¥ler la cartouche et plusieurs alimentations pour travailler √† partir d'une cellule lithium-ion.  Il est √©galement √©quip√© de plusieurs capteurs con√ßus pour compenser les mouvements imparfaits des mains d'une personne, ainsi que de boutons et d'un √©cran qui fournit des informations sur les images imprim√©es.  Jetons un coup d'≈ìil aux composants, peut-√™tre que pour quelqu'un, cela deviendra une inspiration pour le piratage des cartouches: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d4d/0e1/214/d4d0e12142a11a23f9e31aebcba561ae.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/054/607/540/054607540b0ff66f45b62cbc3fec15cb.png"></div><br>  Commen√ßons par la source d'alimentation.  L'alimentation est fournie par une cellule lithium-ion et convertie en 3,3 V, 16 V et 9 V. Une tension de 3,3 V est requise pour les capteurs et l'ESP32;  il est g√©n√©r√© √† l'aide d'un simple r√©gulateur LD78 HT7833.  9   16     ,       XR2203. ,    16     ,    9 ;    9    .         ,          . <br><br>       - ,   -   .     ,      -    TP4056,        USB- . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ad/aed/33b/1adaed33b3e6be049b8ea9d8fc255575.png"></div><br>     ESP-Wrover32.     8  -  8   SPI;       .     5- ,     ,    ,            . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/080/061/edb/080061edb43ce76036ca339ce4168de7.png"></div><br>       -  160x80.    SPI        SPI-,   ESP32. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1b/7b3/b34/c1b7b3b34741f26232e4cc0686195d29.png"></div><br>   .   ,    .      MC14504,    9      16 .       /,    . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/155/4c5/b7e/1554c5b7eb0ee9f845f605ead1906127.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9d/34c/a7f/d9d34ca7fde4f19bdc9bc7431525f7b8.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f8f/02c/928/f8f02c928f1c353a9b12272b1971118c.png"></div><br>      .        I2C,    ESP32     GPIO.     MPU9250 (,    )   ,     VL53L0X (  ),  ,   .    ,    ,      .  , ,       .  ‚Äî    TCS3472.       ;     ¬´¬ª        ,    . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2be/cb9/e3a/2becb9e3abd6af17cdc70f6b36f114a4.png"></div><br>       GPIO,      GPIO.        ,    -,      - ( ),    ,       ,   -.      ,        I2C-.     ,  I2C-  .          I2C-,        I2C-. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e6/daf/fc5/4e6daffc5f3e191d8470724ea9fac785.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici le circuit imprim√© que j'ai con√ßu en fonction du circuit. </font><font style="vertical-align: inherit;">Il a une forme √©trange, car il doit √™tre divis√© en quatre cartes distinctes et "entourer" la cartouche d'imprimante. </font><font style="vertical-align: inherit;">Ils sont connect√©s √©lectriquement et physiquement; </font><font style="vertical-align: inherit;">l'avantage de cela est que les fabricants de cartes de circuits imprim√©s ne consid√®rent pas un tel circuit comme quatre cartes distinctes et que vous ne devez en payer qu'une.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be1/9c8/2ff/be19c82ff2d96aa49100c6608d06eba6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un autre avantage est que je peux assembler la carte en un seul √©l√©ment, puis la tester lorsque tous les composants sont sur le m√™me plan. </font><font style="vertical-align: inherit;">Cela me permet de ne pas √©quilibrer soigneusement le p√©riph√©rique assembl√© pendant le d√©bogage. </font><font style="vertical-align: inherit;">Une petite remarque: les capteurs VL53L0X utilisent un faisceau laser infrarouge; </font><font style="vertical-align: inherit;">Il semble qu'il soit assez fort pour percer le filtre de protection contre les rayonnements infrarouges dans mon ¬´miroir¬ª et appara√Æt dans le cadre comme de petits points violets de lumi√®re.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/78b/dee/afd/78bdeeafddeac0cebecd298e836e42d1.jpg"></div><br>        . ,         .       ,          . ,          FPC PCB  flex-rigid PCB,       . <br><br>            ,    <a href="">  KiCad</a> (     pdf  gerber)    ,    . <br><br>    ,  ‚Ä¶ .     ,    ,  ,       ,       ,        Nyancat   .  ,               .       ,     git  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> URL. <br><br>      ,         ESP32 (         ),   . <br><br><h1>    </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour permettre aux autres artisans d'utiliser plus facilement les cartouches d'imprimante dans leurs propres projets, j'ai √©galement cr√©√© une version de travail minimale du pilote. Il ne prend pas en charge tous les p√©riph√©riques et les hacks du code prototype, mais l'architecture est nettoy√©e et peut donc devenir une base solide pour un d√©veloppement ult√©rieur. Le pilote a un exemple simple d'un programme qui imprime lorsque le bouton HELLO! Est enfonc√© cartouche couleur ou noire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je n'ai pas cr√©√© d'√©quipement sp√©cialis√© pour cela, mais en fait, vous pouvez r√©utiliser le mat√©riel de la section pr√©c√©dente: prenez simplement une </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alimentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et des </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertisseurs de niveau</font></font></a>      .         :       BOOST_EN,    9 /16    . (    .) <br><br>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> ,      ESP-IDF.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">components/printcart</a> ; ,    ,   ,       <a href="">main/main.c</a> .        rgb-. <br><br>    : <a href="">printcart_i2s.c</a>         I2S  ESP32.         16-    3,3   GPIO ( 16 ). (   GPIO    ,  .)           . <br><br>     <a href="">printcart_buffer_filler.c</a> .               <a href="">printcart_genwaveform.c</a> ,         .      (  ),    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tools/waveform_editor.html</a> . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'un autre c√¥t√©, la file d'attente de donn√©es de buse est la proc√©dure de boucle dans main.c. Il attend qu'un bouton soit press√© et lorsqu'il est press√©, il g√©n√®re des donn√©es de buse en analysant un simple fichier image converti en donn√©es RVB brutes et incorpor√© dans un fichier binaire assembl√©, en balayant les donn√©es de gauche √† droite. Gr√¢ce √† cela, vous pouvez appuyer sur le bouton, balayer la cartouche sur le papier et imprimer le contenu de l'image sous la forme d'une bande d'encre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√©sultat final ressemble √† ceci:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/624/9e9/bfc/6249e9bfca9c9fc52ff3da8f581db653.jpg"></div><br>   ,           ,   (0,7   1,5 ),          ,     .   ,   main.c  define,    ;     .   ,       : ,     ,   ,     .     ,      . <br><br><h1>  En conclusion </h1><br> -      ,        ;      (:    ID?),  ,      ,   . ,       ,     ,      .   ,     ,   .     -    ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . <br><br>       ‚Ä¶ ‚Ä¶     ? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/491/722/895/49172289578ace93f8bd04a051d1866e.jpg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443582/">https://habr.com/ru/post/fr443582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443570/index.html">Nous ne nous y attendions pas: une lettre ouverte annuelle de Bill et Melinda Gates</a></li>
<li><a href="../fr443572/index.html">Une autre fa√ßon d'√©crire des applications multiplateformes: les internes de Neutralinojs et la comparaison avec Electron et NW.js</a></li>
<li><a href="../fr443574/index.html">D√©boguer les applications CLI angulaires dans VSCode √† l'aide de l'aper√ßu du navigateur</a></li>
<li><a href="../fr443576/index.html">[Peter] Conteneurs et distributions - Rencontre JUG.ru avec Dmitry Chuiko et Alexander Belokrylov</a></li>
<li><a href="../fr443578/index.html">Premiers rapports sur PHDays: interception de vid√©oconf√©rence, nouvelle version de GhostTunnel, attaques sur Java Card</a></li>
<li><a href="../fr443584/index.html">Surveillez les sorties de films num√©riques de haute qualit√© sans chichi</a></li>
<li><a href="../fr443586/index.html">GeekBrains lance un marathon de travail √† distance en ligne gratuit</a></li>
<li><a href="../fr443588/index.html">Un professeur du Massachusetts Institute of Technology d√©voile l'avenir des proth√®ses √† TED</a></li>
<li><a href="../fr443590/index.html">Data Science: pr√©dire les √©v√©nements m√©tier pour am√©liorer le service</a></li>
<li><a href="../fr443592/index.html">Norme frontale RFID ISO 11785 provenant d'un ancien r√©cepteur FM et de d√©bris d'ascenseur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>