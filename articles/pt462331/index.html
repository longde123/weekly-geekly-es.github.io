<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ôüèæ üë©üèº‚Äçüîß üåÆ Brinquedo GAZ-66 no painel de controle. Parte 2 üë©üèº‚Äçü§ù‚Äçüë®üèø üèîÔ∏è üë®üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nesta parte, falaremos sobre o componente de software, como a m√°quina ganhou vida. Qual sistema operacional foi usado, qual idioma foi escolhido, quai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Brinquedo GAZ-66 no painel de controle. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462331/"><p><img src="https://habrastorage.org/webt/ix/tf/mx/ixtfmxmnpt-9rkvbc2kqpdtol2c.jpeg" alt="imagem"></p><br><p>  Nesta parte, falaremos sobre o componente de software, como a m√°quina ganhou vida.  Qual sistema operacional foi usado, qual idioma foi escolhido, quais problemas foram enfrentados. </p><a name="habracut"></a><br><h3 id="1-kak-rabotaet-v-2-h-slovah">  1. Como funciona em 2 palavras </h3><br><p>  O sistema consiste em um servidor que est√° instalado em uma m√°quina de escrever e um cliente que est√° instalado no console.  O servidor eleva o ponto de acesso <strong>wifi</strong> e aguarda at√© o cliente se conectar.  O servidor executa comandos do cliente e tamb√©m transmite o v√≠deo da c√¢mera para ela. </p><br><h3 id="2-os">  2. SO </h3><br><p>  Agora vamos falar sobre os sistemas operacionais usados. </p><br><p>  Como todo o sistema √© baseado no <strong>Raspberry pi 3</strong> , o sistema operacional oficial foi usado.  No momento da cria√ß√£o, a vers√£o mais recente era <strong>Stretch</strong> , era e foi selecionada para uso em uma m√°quina de escrever e controle remoto.  Mas aconteceu que ele tem um bug (atormentado por uma semana) por causa do qual √© imposs√≠vel aumentar o ponto de acesso wifi.  Portanto, para aumentar o ponto de acesso, foi usada uma vers√£o anterior de <strong>Jessie</strong> que n√£o apresentava esses problemas. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo como aumentar um ponto de acesso.</a>  Muito detalhado, fez tudo. </p><br><p>  O controle remoto se conecta automaticamente √† m√°quina quando eleva o ponto de acesso. <br>  A conex√£o autom√°tica ao nosso ponto, no arquivo <strong>/ etc / network / interfaces,</strong> adiciona: </p><br><pre><code class="plaintext hljs">auto wlan0 iface wlan0 inet dhcp wpa-ssid {ssid} wpa-psk {password}</code> </pre> <br><h3 id="2-yazyk">  2. Idioma </h3><br><p>  Eu escolhi o <strong>python</strong> porque √© f√°cil e simples. </p><br><h3 id="3-server">  3. Servidor </h3><br><p>  Por servidor nesta se√ß√£o, quero dizer software escrito por mim para controlar a m√°quina e trabalhar com v√≠deo. </p><br><p>  O servidor consiste em 2 partes.  Servidor de v√≠deo e servidor de gerenciamento. </p><br><h3 id="31-video-server">  3.1 Servidor de v√≠deo </h3><br><p>  Havia 2 op√ß√µes de como trabalhar com uma c√¢mera de v√≠deo.  1¬∫ uso do m√≥dulo <strong>picamera</strong> e 2¬∫ uso <strong>do software mjpg-streamer</strong> .  Sem pensar duas vezes, decidi usar os dois e qual deles usar nas configura√ß√µes. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conf.conf.VideoServerType == <span class="hljs-string"><span class="hljs-string">'m'</span></span> : cmd = <span class="hljs-string"><span class="hljs-string">"cd /home/pi/projects/mjpg-streamer-experimental &amp;&amp; "</span></span> cmd += <span class="hljs-string"><span class="hljs-string">'./mjpg_streamer -o "./output_http.so -p {0} -w ./www" -i "./input_raspicam.so -x {1} -y {2} -fps 25 -ex auto -awb auto -vs -ISO 10"'</span></span>.format(conf.conf.videoServerPort, conf.conf.VideoWidth, conf.conf.VideoHeight) print(cmd) os.system(cmd) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> picamera.PiCamera(resolution = str(conf.conf.VideoWidth) + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(conf.conf.VideoHeight) , framerate = conf.conf.VideoRate) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Camera: output = camera.StreamingOutput() camera.output = output Camera.start_recording(output, format = <span class="hljs-string"><span class="hljs-string">'mjpeg'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: address = (conf.conf.ServerIP, conf.conf.videoServerPort) server = camera.StreamingServer(address, camera.StreamingHandler) server.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: Camera.stop_recording()</code> </pre> <br><p>  Como eles seguem as mesmas configura√ß√µes, eles trabalham no mesmo endere√ßo.  N√£o h√° problemas na comunica√ß√£o com o controle remoto ao alternar de um para outro.  A √∫nica coisa que acho que o <strong>mjpg-streamer</strong> funciona mais r√°pido. </p><br><h3 id="32-server-upravleniya">  3.2 Servidor de Gerenciamento </h3><br><h4 id="321-vzaimodeystvie-mezhdu-klientom-i-serverom">  3.2.1 Intera√ß√£o entre cliente e servidor </h4><br><p>  O servidor e o cliente trocam comandos na forma de json strings: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'turn'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span>}</code> </pre> <br><ul><li>  tipo - 'remoto' ou 'carro', dependendo de quem envia o comando (cliente ou servidor) </li><li>  cmd - uma string com o nome do bot√£o correspondente ao nome do bot√£o no <strong>Game HAT</strong> , por exemplo: <br><ul><li>  Bot√£o Iniciar - Iniciar </li><li>  Bot√£o Selecionar - Selecionar </li><li>  Bot√£o Y - Y </li><li>  etc. </li><li>  turn - o comando para alterar o estado do joystick, √© respons√°vel por girar as rodas </li></ul></li><li>  status - Verdadeiro ou Falso, dependendo de o bot√£o estar pressionado ou n√£o.  Um evento de status do bot√£o √© despachado toda vez que seu estado muda. </li><li>  val - velocidade e dire√ß√£o do movimento do motor de -1 ... 1, valor do tipo <strong>float</strong> .  Par√¢metro significativo apenas para bot√µes de movimento. </li><li>  x - desvio do joystick ao longo do eixo x de -100 ... 100, valor do tipo <strong>int</strong> </li><li>  y - desvio do joystick ao longo do eixo y de -100 ... 100, valor do tipo <strong>int</strong> </li></ul><br><p>  Em seguida, vem a minha vergonha, refazer quais m√£os n√£o alcan√ßam.  A m√°quina levanta o soquete do servidor e aguarda at√© que o cliente se conecte a ele.  Al√©m disso, para cada nova conex√£o, ele cria um fluxo separado, e cada novo cliente que se conectar √† m√°quina poder√° control√°-la)).  Isso n√£o pode ser t√£o longe, porque ningu√©m mais tem esse controle remoto, e eu levanto minha rede wifi fechada. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> TCP_IP = conf.conf.ServerIP TCP_PORT = conf.conf.controlServerPort BUFFER_SIZE = conf.conf.ServerBufferSize self.tcpServer = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self.tcpServer.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) self.tcpServer.bind((TCP_IP, TCP_PORT)) threads = [] <span class="hljs-comment"><span class="hljs-comment">#     . self.tcpServer.listen(1) while True: print("Car server up : Waiting for connections from TCP clients...") (conn, (ip, port)) = self.tcpServer.accept() newthread = ClientThread(conn, ip, port) newthread.start() self.threads.append(newthread)</span></span></code> </pre> <br><h4 id="322-upravlenie-zhelezom">  3.2.2 Gerenciamento de ferro </h4><br><p>  Ao trabalhar com o Raspberry, foi utilizado o sistema de numera√ß√£o de pinos <strong>GPIO.BCM</strong> . </p><br><p>  <strong>A luz √©</strong> controlada via gpio 17, √© conectada ao segundo pino no <strong>L293</strong> .  Em seguida, sempre que o comando incluir: </p><br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.HIGH)</code> </pre> <br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.LOW)</code> </pre> <br><p>  comandos correspondentes s√£o chamados. </p><br><p>  <strong>O servoconversor</strong> √© <strong>controlado</strong> atrav√©s da placa <strong>PCA9685</strong> atrav√©s do barramento I2C, por isso precisamos da biblioteca apropriada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Adafruit_PCA9685</a> .  O PCA9685 est√° conectado ao servo via 7 pinos.  A frequ√™ncia PWM necess√°ria para trabalhar com servo √© de 50 Hz ou um per√≠odo de 20 ms. </p><br><p>  O princ√≠pio de opera√ß√£o do servo: </p><br><p><img src="https://habrastorage.org/webt/h2/z-/ns/h2z-nsefbtnvntcwbmmt9qoikjc.jpeg" alt="imagem"></p><br><p>  Quando um sinal de 1,5 ms √© aplicado, as rodas ser√£o centralizadas.  Em 1 ms.  o servo girar√° o mais longe poss√≠vel para a direita, 2 ms.  para a esquerda, tanto quanto poss√≠vel.  As juntas de dire√ß√£o nas pontes para essas voltas n√£o s√£o projetadas, portanto o √¢ngulo de rota√ß√£o teve que ser selecionado experimentalmente. </p><br><p>  Os valores que podem ser passados ‚Äã‚Äãpara a API Adafruit_PCA9685 variam de 0..4095, 0 sem sinal, 4095 cheio.  Portanto, nessa faixa, foi necess√°rio escolher os valores adequados para minhas rodas.  A maneira mais f√°cil de determinar os valores para as rodas exatamente definidas √© transferir 1,5 ms para um valor na faixa de ~ 307. </p><br><p>  O valor m√°ximo para a direita √© 245, para a esquerda 369. </p><br><p>  Os valores provenientes do joystick assumem valores de -100 ... 100, portanto, eles tiveram que ser traduzidos no intervalo de 245 a 369. Novamente, o centro √© o mais f√°cil, se 0 for 307. Esquerda e direita de acordo com a f√≥rmula: </p><br><pre> <code class="python hljs">val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero))</code> </pre> <br><ul><li>  HardwareSetting._turnCenter - 307 </li><li>  turn - valor do joystick de -100 ... 100 </li><li>  HardwareSetting._turnDelta - 62, a diferen√ßa entre o centro e o desvio m√°ximo para o lado (307 - 245 = 62) </li><li>  HardwareSetting.yZero - 100, o valor m√°ximo recebido do joystick </li></ul><br><p>  Rodas retas: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnCenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Vire √† esquerda: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Vire √† direita: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  <strong>O controle do motor</strong> tamb√©m ocorre atrav√©s da placa <strong>PCA9685</strong> atrav√©s do barramento I2C, por isso usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Adafruit_PCA9685</a> .  Os pinos 10 a 15 no PCA9685 est√£o conectados ao L298N (eu uso 2 canais nele para absorver energia).  10 e 11 para ENA e ENB (eu os preencho com PWM para controlar a velocidade).  12, 13, 14, 15 a IN1, IN2, IN3, IN4 - s√£o respons√°veis ‚Äã‚Äãpelo sentido de rota√ß√£o do motor.  A frequ√™ncia PWM n√£o √© muito importante aqui, mas eu tamb√©m uso 50 Hertz (meu valor padr√£o). </p><br><p>  A m√°quina fica parada: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><p>  Avan√ßando: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH)</code> </pre> <br><p>  Movimento para tr√°s: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><h3 id="4-klient">  4. Cliente </h3><br><h3 id="41-klaviatura">  4.1 Teclado </h3><br><p>  Havia alguns problemas com ela, no come√ßo eu queria torn√°-la agitada (foram necess√°rias ~ 2 semanas de tormento).  Mas os bot√µes mec√¢nicos contribu√≠ram, o barulho dos contatos levou a falhas constantes e imprevis√≠veis (os algoritmos de controle que eu inventei funcionavam imperfeitamente).  Ent√£o meu colega me contou como os teclados s√£o feitos.  E eu decidi fazer o mesmo, agora eu pesquiso o estado a cada 0.005 segundos (por que sim e quem sabe).  E se ele mudou, envie o valor ao servidor. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.pins : p = self.pins[pin] status = p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GPIO.input(pin) == GPIO.HIGH : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] != status : p[<span class="hljs-string"><span class="hljs-string">'callback'</span></span>](pin) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: GPIO.cleanup()</code> </pre><br><h3 id="42-dzhoystik">  4.2 Joystick </h3><br><p>  <strong>A leitura das leituras</strong> ocorre atrav√©s da placa <strong>ADS1115</strong> atrav√©s do barramento I2C; portanto, a biblioteca apropriada para ela √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Adafruit_PCA9685</a> .  O joystick tamb√©m √© propenso a contatos trepidantes, por isso tomo leituras dele por analogia com o teclado. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: X = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">0</span></span>, gain=self.GAIN) / HardwareSetting.valueStep Y = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">1</span></span>, gain=self.GAIN) / HardwareSetting.valueStep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> X &gt; HardwareSetting.xZero : X = X - HardwareSetting.xZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : X = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.xZero - X) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Y &gt; HardwareSetting.yZero : Y = Y - HardwareSetting.yZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : Y = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.yZero - Y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(X) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : X = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(Y) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : Y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(self.x - X) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abs(self.y - Y) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span>) : self.sendCmd(round(X), round(Y)) self.x = X self.y = Y time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>)</code> </pre> <br><p>  Quando alimentado a partir de 3,3 volts, a faixa de valores que o ADS1115 fornece com um joystick de 0 a 26500.  Trago isso para o intervalo de -100 ... 100.  No meu intervalo em torno de 0, ele sempre flutua; portanto, se os valores n√£o excederem 5, considero que √© 0 (caso contr√°rio, ele inundar√°).  Assim que os valores mudarem, envie-os para a m√°quina de escrever. </p><br><h3 id="43-podklyuchenie-k-serveru-upravleniya">  4.3 Conectando ao servidor de gerenciamento </h3><br><p>  Conectar-se ao servidor √© uma coisa simples: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> : tcpClient = socket.socket(socket.AF_INET, socket.SOCK_STREAM) tcpClient.settimeout(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) tcpClient.connect((conf.conf.ServerIP, conf.conf.controlServerPort)) self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"+"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.tcpClient = tcpClient <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> socket.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> time.sleep(conf.conf.timeRecconect) self.tcpClient = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.tcpClient : self.tcpClient.settimeout(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>  Mas quero prestar aten√ß√£o a uma coisa.  Se voc√™ n√£o usar o tempo limite na conex√£o, ele poder√° congelar e voc√™ ter√° que esperar alguns minutos (isso acontece quando o cliente foi iniciado antes do servidor).  Resolvi isso da seguinte maneira, defino o tempo limite para a conex√£o.  Assim que a conex√£o ocorre, removo o tempo limite. </p><br><p>  Tamb√©m guardo o estado da conex√£o, para saber se o controle est√° perdido e exibi-lo na tela. </p><br><h3 id="44-proverka-podklyucheniya-k-wifi">  4.4 Verificando a conex√£o WiFi </h3><br><p>  Verifico o status do wifi para conex√£o com o servidor.  E se eu tamb√©m me notifico de problemas. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">1.0</span></span>) self.ps = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'iwgetid'</span></span>], stdout=subprocess.PIPE, stderr=subprocess.STDOUT) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: output = subprocess.check_output((<span class="hljs-string"><span class="hljs-string">'grep'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESSID'</span></span>), stdin=self.ps.stdout) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.search(<span class="hljs-string"><span class="hljs-string">r'djvu-car-pi3'</span></span>, str(output)) : self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> subprocess.CalledProcessError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi-'</span></span>) self.ps.kill()</code> </pre> <br><h3 id="45-podklyuchenie-k-video-serveru">  4.5 Conectando a um servidor de v√≠deo </h3><br><p>  Para isso, todo o poder do <strong>Qt5 era necess√°rio</strong> , a prop√≥sito, na distribui√ß√£o <strong>Stretch</strong> , √© mais recente e, na minha opini√£o, mostra-se melhor.  <strong>Jessie</strong> eu tentei tamb√©m. </p><br><p>  Para exibi√ß√£o eu usei: </p><br><pre> <code class="python hljs">self.videoWidget = QVideoWidget()</code> </pre> <br><p>  E ele deduziu: </p><br><pre> <code class="python hljs">self.mediaPlayer = QMediaPlayer(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, QMediaPlayer.LowLatency) self.mediaPlayer.setVideoOutput(self.videoWidget)</code> </pre> <br><p>  Conex√£o ao streaming de v√≠deo: </p><br><pre> <code class="python hljs">self.mediaPlayer.setMedia(QMediaContent(QUrl(<span class="hljs-string"><span class="hljs-string">"http://{}:{}/?action=stream"</span></span>.format(conf.conf.ServerIP, conf.conf.videoServerPort)))) self.mediaPlayer.play()</code> </pre> <br><p>  Mais uma vez, pe√ßo desculpas pela tautologia).  Monitoro o status da conex√£o de v√≠deo para conex√£o com o servidor de v√≠deo.  E se eu tamb√©m me notifico de problemas. </p><br><p>  √â assim que parece quando tudo n√£o funciona: </p><br><p><img src="https://habrastorage.org/webt/ea/6a/ug/ea6augn3vrdv3ejjom8v6qrnpvu.jpeg" alt="imagem"></p><br><ul><li>  <strong>W</strong> - significa que n√£o h√° conex√£o com wifi </li><li>  <strong>B</strong> - significa que n√£o h√° v√≠deo </li><li>  <strong>Y</strong> - significa que n√£o h√° controle </li></ul><br><p>  Caso contr√°rio, n√£o h√° letras vermelhas, h√° um v√≠deo da c√¢mera.  Vou postar uma foto e um v√≠deo com o trabalho no futuro) Espero que a montagem da c√¢mera chegue no futuro pr√≥ximo e finalmente a anexarei normalmente. </p><br><h3 id="5-nastroyka-raspberry-os">  5 Configurando o Raspberry OS </h3><br><p>  A prop√≥sito, o trabalho com a c√¢mera e outras coisas necess√°rias devem estar ativadas (no cliente e no servidor).  Depois de carregar o sistema operacional: </p><br><p><img src="https://habrastorage.org/webt/ex/ye/gz/exyegz24x9ec0ee0cdp7qpm5kog.jpeg" alt="imagem"></p><br><p>  E ligue quase tudo: camera, ssh, i2c, gpio </p><br><p><img src="https://habrastorage.org/webt/ye/fu/z4/yefuz4_ioqh5g1j_f1n1mgwf_cg.png" alt="imagem"></p><br><h3 id="demonstraciya">  Demonstra√ß√£o </h3><br><p>  Existe apenas um canal de v√≠deo (a c√¢mera permanece em funcionamento).  Pe√ßo desculpas por sua aus√™ncia, vou anex√°-lo na segunda-feira. </p><br><img alt="Chap√©u de jogo" width="400" src="https://habrastorage.org/webt/5q/yt/ox/5qytoxmp0ojxi7bheduksv8qipg.jpeg"><br><p>  Trabalho em v√≠deo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D6ZT90L6q00" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="ishodnye-kody">  C√≥digo fonte </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digo-fonte do servidor e do cliente</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pacote de inicializa√ß√£o do servidor Daemon</a> </p><br><h3 id="ssylki">  Refer√™ncias </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462331/">https://habr.com/ru/post/pt462331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462317/index.html">Dicas para otimizar sua arquitetura Laravel com a AWS</a></li>
<li><a href="../pt462321/index.html">SEO internacional | Fatores internacionais de classifica√ß√£o de SEO</a></li>
<li><a href="../pt462323/index.html">Obesidade - relaxe e envolva</a></li>
<li><a href="../pt462327/index.html">Ru√≠do de um tumor de c√¢ncer: cientistas do NUST ‚ÄúMISiS‚Äù desenvolveram um ultra-som a laser para o diagn√≥stico de c√¢ncer</a></li>
<li><a href="../pt462329/index.html">Movendo a fonte de alimenta√ß√£o para a frente do chassi</a></li>
<li><a href="../pt462333/index.html">Criando um chatbot de conversa√ß√£o simples em python</a></li>
<li><a href="../pt462335/index.html">N√£o leia, releia</a></li>
<li><a href="../pt462337/index.html">Estat√≠sticas do site e seu pequeno reposit√≥rio</a></li>
<li><a href="../pt462339/index.html">Como o treinamento manual est√° relacionado aos padr√µes internos da Amazon e como isso afetou a vis√£o de mundo da empresa?</a></li>
<li><a href="../pt462347/index.html">Os primeiros dez dias entre uma coruja e um madrugador: sono, dieta, dieta e exerc√≠cio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>