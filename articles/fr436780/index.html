<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úåüèæ üßñüèæ üî™ Pi√®ges du d√©veloppement instantan√© de Google Play üîì üõå üë¶üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je m'appelle Kamo Spertsyan, je suis engag√© dans le d√©veloppement Android chez PROFI.RU. J'ai r√©cemment √©crit une application de lancem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pi√®ges du d√©veloppement instantan√© de Google Play</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436780/"><img src="https://habrastorage.org/webt/8s/0b/hr/8s0bhr6qfo6kdcob953wsyx_0ci.png"><br><br>  Bonjour, Habr!  Je m'appelle Kamo Spertsyan, je suis engag√© dans le d√©veloppement Android chez PROFI.RU.  J'ai r√©cemment √©crit une application de lancement instantan√© pour nos clients.  Si vous n'√™tes pas familier avec la technologie, je vous invite √† visiter d'abord <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les d√©veloppeurs Android</a> . <br><br>  Plus de deux ans se sont √©coul√©s depuis la pr√©sentation des applications instantan√©es (Google Play Instant) sur Google I / O 2016.  Il existe de nombreux articles sur le Web sur la fa√ßon de cr√©er des applications avec un lancement instantan√©.  A en juger par eux, il n'y a rien de compliqu√© √† cela.  Mais en r√©alit√©, ce n'est pas enti√®rement vrai.  Je vais essayer de d√©crire les principales difficult√©s que j'ai eu √† traverser de la cr√©ation d'un projet vide √† la publication d'Instant App sur Google Play.  J'esp√®re que cet article sera utile aux d√©veloppeurs qui n'ont pas encore venir. <br><a name="habracut"></a><br><h3>  Choix de l'approche </h3><br>  La plupart des sources d√©crivent le processus de conversion de l'application enti√®re vers l'application instantan√©e.  Cependant, notre application n'a en aucun cas respect√© la limite de 4 Mo et a fourni beaucoup plus de fonctionnalit√©s que n√©cessaire pour nous familiariser avec le service avant l'installation.  Maintenant en mode test, Google a augment√© la taille autoris√©e de l'application avec un lancement instantan√© √† 10 Mo. <br><br>  J'avais le choix entre deux approches pour cr√©er l'application instantan√©e.  La premi√®re consiste √† prendre l'application termin√©e et √† en supprimer les fonctionnalit√©s inutiles.  La seconde consiste √† cr√©er un projet vide et √† y transf√©rer les fonctionnalit√©s n√©cessaires.  Ayant consid√©r√© la premi√®re option comme √©tant rapide, mes coll√®gues et moi l'avons test√©e sur un hackathon local et en m√™me temps nous sommes convaincus de son d√©sespoir.  Tout d'abord, cela a pris beaucoup de temps (environ 40 heures-homme).  Deuxi√®mement, la taille de l'application s'est av√©r√©e tr√®s importante en raison d'un exc√®s de code et de ressources.  Troisi√®mement, la maintenance compliqu√©e du code suppl√©mentaire.  Nous avons fr√©n√©tiquement essay√© d'int√©grer l'application r√©sultante dans 4 Mo pendant le hackathon, et √† la fin nous n'avions toujours pas le temps. <br><br><h3>  Transfert de fonctionnalit√©s </h3><br>  Enseign√© par une exp√©rience am√®re, j'ai cr√©√© un projet vide et j'ai commenc√© √† y copier uniquement les modules d'application n√©cessaires.  Nous prenons en charge l'architecture modulaire, c'√©tait donc facile √† faire.  Ici, je suis tomb√© sur le premier probl√®me - vous ne pouvez pas utiliser les services dans Instant Apps.  Dans mon cas, cette restriction n'√©tait pas critique: nous avons utilis√© le service pour t√©l√©charger des photos, et dans l'application instantan√©e, nous avons refus√© cette fonctionnalit√©, motivant les utilisateurs √† t√©l√©charger l'application principale.  Mais ce point m√©rite d'√™tre consid√©r√© si votre application utilise √©galement des services. <br><br>  √Ä ma grande surprise, l'application obtenue en copiant uniquement les morceaux de code n√©cessaires ne cadrait toujours pas dans les 4 Mo valides et pesait environ 5 Mo.  Dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article,</a> Google donne des conseils sur cette affaire, mais ils m'ont un peu aid√©.  La seule chose que nous pouvions refuser √©tait les polices personnalis√©es, mais leur poids n'affectait pas de mani√®re significative la taille de l'APK. <br><br>  Ensuite, je me suis souvenu que ProGuard dans notre projet √©tait d√©sactiv√© sur les assemblys de d√©bogage.  Inclusion simple <br><br><pre><code class="kotlin hljs">minifyEnabled <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br>  r√©duit la taille de l'application de pr√®s de la moiti√©.  Oh miracle - la limite de 4 Mo est atteinte! <br><br><h3>  Migration de donn√©es </h3><br>  Ensuite, le probl√®me de la migration des donn√©es devait √™tre r√©solu.  Comme vous le savez, les applications instantan√©es sont prises en charge par le syst√®me d'exploitation Android √† partir de la version 5.0.  Dans le m√™me temps, la migration automatique des donn√©es ne fonctionne que depuis Android 8.0.  Pour ce faire, il suffit d'utiliser des fichiers de pr√©f√©rences partag√©es portant le m√™me nom dans les deux applications.  Pour les versions 5.0 √† 7.1, la migration doit √™tre √©crite manuellement √† l'aide de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API cookie</a> ou de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API de stockage</a> .  J'ai utilis√© Cookie et je n'ai rencontr√© aucun probl√®me particulier - cependant, cela a n√©cessit√© des modifications non seulement du c√¥t√© de l'application instantan√©e, mais √©galement dans l'application install√©e.  Donc, √† la fin, j'ai d√ª publier une nouvelle version de l'application et la diffuser √† l'ensemble du public pour la sortie d'Instant App. <br><br><h3>  D√©bogage </h3><br>  Avec le d√©bogage, tout n'√©tait pas si simple. <br><br>  Tout d'abord, Google Play Instant ne prend pas en charge les connexions r√©seau non s√©curis√©es, alors oubliez http, uniquement https.  Pour moi, cela signifiait des tests sur les serveurs de production, car tous les bancs de test fonctionnaient sur http.  Pas critique, mais pas assez agr√©able. <br><br>  Deuxi√®mement, le lancement de l'application instantan√©e elle-m√™me: vous pouvez tester l'application comme normale, installable, mais uniquement pour le moment.  Lors du d√©marrage d'Android Studio, il est impossible de v√©rifier la mise √† jour instantan√©e de l'application pour une application "compl√®te".  Par exemple, pour tester le transfert correct des donn√©es utilisateur.  Pour ce faire, ex√©cutez l'application avec un lancement instantan√©, tout comme l'application instantan√©e.  Il existe deux fa√ßons de proc√©der: <br><br><ol><li>  lancer l'application √† l'aide d'un utilitaire sp√©cial √† partir du SDK Android; </li><li>  mettez-le dans la console pour les tests internes et parcourez le Play Market. </li></ol><br>  La premi√®re m√©thode est assez pratique.  L'utilitaire est inclus dans le SDK Android, mais n'est pas install√© par d√©faut.  Pour installer dans Android Studio, vous devez suivre ces √©tapes: <br><br><ol><li>  allez dans <i>Pr√©f√©rences</i> -&gt; <i>Apparence et comportement</i> -&gt; <i>Param√®tres syst√®me</i> -&gt; <i>SDK Android</i> ; </li><li>  s√©lectionnez l'onglet <i>Outils SDK</i> ; </li><li>  cochez la case en <i>regard du SDK de d√©veloppement instantan√© de Google Play</i> et cliquez sur <i>Appliquer</i> . </li></ol><br><img src="https://habrastorage.org/webt/v4/js/dw/v4jsdwq8brx2kcids6tgeann2-8.gif"><br>  √Ä la derni√®re √©tape, faites attention au r√©pertoire dans lequel l'utilitaire sera install√©.  Plus loin sur ce chemin, nous serons int√©ress√©s par le fichier <abbr>./extras/google/instantapps/ia</abbr> .  Avec lui, vous pouvez simuler un lancement instantan√© de l'application en ex√©cutant la commande <br><br><pre> <code class="java hljs">ia run &lt;  APK-, bundle-  URL&gt;</code> </pre> <br>  Jusqu'au moment o√π je suis tomb√© sur cet utilitaire, j'ai utilis√© la deuxi√®me m√©thode, avec la publication constante de l'application dans la console Google Play.  Mais puisque l'application publi√©e n'appara√Æt pas tout de suite dans le magasin, mais apr√®s un temps ind√©fini (cela m'a pris une demi-heure √† un jour), cette fa√ßon de tester n'√©tait pas bonne.  Cependant, il n'est pas destin√© √† cela.  Soit dit en passant, si vous publiez l'application instantan√©e sur la console Google Play √† grande fr√©quence, je vous conseille d'envisager la possibilit√© de d√©terminer le code de version de l'application apr√®s le lancement.  Sinon, il peut √™tre difficile de comprendre si la derni√®re version publi√©e ou la pr√©c√©dente a √©t√© lanc√©e. <br><br><h3>  Publication </h3><br>  Enfin, lorsque votre application est test√©e et pr√™te √† √™tre publi√©e, ne vous pr√©cipitez pas pour vous d√©tendre!  Premi√®rement, le code de version ( <i>versionCode</i> ) de l'application instantan√©e ne doit pas d√©passer le code de version de l'application install√©e.  Je vous recommande de donner de l'espace √† l'avance pour la cr√©ativit√©: lorsque vous lib√©rez l'application principale, sp√©cifiez la valeur √©videmment significative du code afin de ne pas vous lier les mains.  La suppression de l'application instantan√©e publi√©e de la console afin de ¬´lib√©rer¬ª le code de version d'un autre assembly √©chouera.  Formellement, vous avez la possibilit√© <code><i>NM</i></code> de lancer Instant App pendant que vous avez l'application principale avec <code><i>versionCode = N</i></code> et l'application avec lancement instantan√© avec <code><i>versionCode = M</i></code> sur Google Play. <br><br>  De plus, pour la version de l'application instantan√©e, assurez-vous qu'elle ne sera pas disponible pour un public plus large que l'application principale.  En d'autres termes, chaque utilisateur d'Instant App devrait pouvoir installer l'application principale. <br><br>  L'audience est principalement affect√©e par les autorisations de l'application sp√©cifi√©es dans le fichier manifeste ( <i>autorisations</i> ) - elles doivent √™tre les m√™mes pour les deux applications (√† l'exception des autorisations qui n'affectent pas l'audience).  Supposons que si votre application principale n√©cessite une autorisation pour d√©terminer la g√©olocalisation, et dans l'application instantan√©e, cela n'est pas n√©cessaire, vous devez toujours le sp√©cifier l√† et l√†. <br><br>  De plus, certaines biblioth√®ques de support peuvent restreindre le cercle des utilisateurs finaux.  C'√©tait donc dans notre cas.  La console a lanc√© une erreur de <i>"diff√©rence d'apk de ciblage"</i> , bien que les autorisations des deux applications soient les m√™mes.  √Ä la recherche d'une solution, je suis tomb√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce probl√®me</a> avec Stack Overflow, o√π il est conseill√© d' <i>ex√©cuter les</i> fichiers APK de <i>l'</i> application via l'utilitaire <i>aapt</i> .  Il affichera des informations d√©taill√©es sur les fichiers, y compris toutes les d√©pendances.  Apr√®s avoir calcul√© la diff√©rence de sortie pour les deux fichiers, j'ai remarqu√© un indice: l'application en cours d'installation avait la ligne <code>uses-gl-es: '0x20000'</code> , qui √©tait absente dans l'application instantan√©e.  Une courte navigation sur le r√©seau m'a conduit √† une solution: cette ligne indique que l'application utilise la biblioth√®que OpenGL, qui, √† son tour, est utilis√©e dans les cartes.  En effet, notre application principale utilisait la biblioth√®que <code>play-services-maps</code> , mais pas l'application instantan√©e.  L'ajout de cette d√©pendance √† l'application instantan√©e m'a permis de finalement lib√©rer l'application. <br><br><h3>  Pour r√©sumer </h3><br><ol><li>  Les applications instantan√©es ne peuvent pas utiliser les services et les r√©seaux non s√©curis√©s (http).  La taille du fichier APK final ne doit pas d√©passer 4 Mo (cette restriction sera peut-√™tre bient√¥t simplifi√©e √† 10 Mo). </li><li>  Pour r√©duire la taille du fichier APK, vous pouvez utiliser des optimiseurs et des obfuscateurs de code (par exemple, ProGuard). </li><li>  Les pr√©f√©rences partag√©es sont transf√©r√©es de l'application instantan√©e vers l'application principale automatiquement pour Android 8.0+, pour les versions ant√©rieures, il est n√©cessaire d'√©crire manuellement via l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API de cookie</a> ou l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API de stockage</a> .  Il convient de tenir compte de la n√©cessit√© de publier une application pr√©par√©e pour la migration des donn√©es avant de publier Instant App. </li><li>  Pour d√©boguer l'application instantan√©e, vous pouvez utiliser l'utilitaire sp√©cial du SDK de d√©veloppement instantan√© Google Play inclus dans le SDK Android. </li><li>  L'apparition de l'application instantan√©e publi√©e dans la console sur les appareils finaux peut se produire avec un retard d'une demi-heure √† un jour.  Il convient de prendre soin de pouvoir d√©terminer sans ambigu√Øt√© quelle version de l'application instantan√©e a √©t√© lanc√©e depuis le Play Market. </li><li>  Le code de version de l'application instantan√©e ne doit pas d√©passer le code de version de l'application principale. </li><li>  La liste des appareils sur lesquels l'application instantan√©e sera disponible ne doit pas d√©passer la liste des appareils sur lesquels l'application principale est disponible.  Pour ce faire, vous devez sp√©cifier les m√™mes autorisations dans les fichiers manifeste, ainsi que faire attention aux limitations possibles dues aux biblioth√®ques auxiliaires. </li></ol><br>  C‚Äôest tout.  J'esp√®re que vous trouverez ces informations utiles.  Je serai heureux de toute r√©troaction! <br><br><h4>  Sources utiles: </h4><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation instantan√©e de Google Play sur les d√©veloppeurs Android</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conseils pour r√©duire la taille du fichier APK de l'application instantan√©e</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FAQ instantan√©e de Google Play</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration des cookies</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration des donn√©es √† l'aide de l'API de stockage</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436780/">https://habr.com/ru/post/fr436780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436770/index.html">Les op√©rateurs mobiles russes gagnent dans les nuages</a></li>
<li><a href="../fr436772/index.html">Loi "sur les communications" et vuln√©rabilit√© des messagers</a></li>
<li><a href="../fr436774/index.html">La m√©thode de d√©tournement de comptes "en vrac" en acc√©dant aux services d'un op√©rateur mobile</a></li>
<li><a href="../fr436776/index.html">De la zone de confort aux meilleurs d√©veloppeurs</a></li>
<li><a href="../fr436778/index.html">defi.js est une biblioth√®que r√©active bas√©e sur Object.defineProperty</a></li>
<li><a href="../fr436784/index.html">Thimble (Mozilla) passe √† Glitch</a></li>
<li><a href="../fr436786/index.html">Comment nous avons surveill√© Black Hat Europe 2018</a></li>
<li><a href="../fr436790/index.html">256 lignes de C ++ nu: √©criture d'un ray tracer √† partir de z√©ro en quelques heures</a></li>
<li><a href="../fr436792/index.html">Conf√©rence DEFCON 19. Anonyme et nous. Partie 1</a></li>
<li><a href="../fr436794/index.html">Conf√©rence DEFCON 19. Anonyme et nous. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>