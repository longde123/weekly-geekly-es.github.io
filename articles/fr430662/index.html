<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âš•ï¸ ğŸ‘´ğŸ½ ğŸ¤¥ Surveillance des serveurs Windows sur MS SQL pur et comment je l'ai implÃ©mentÃ© secrÃ¨tement ğŸ¤ ğŸ‘¶ğŸ» â™Šï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois, dans une galaxie lointaine et lointaine, il y avait une entreprise qui avait longtemps Ã©voluÃ© Ã  partir d'une startup, mais qui restait encor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance des serveurs Windows sur MS SQL pur et comment je l'ai implÃ©mentÃ© secrÃ¨tement</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430662/"> Une fois, dans une galaxie lointaine et lointaine, il y avait une entreprise qui avait longtemps Ã©voluÃ© Ã  partir d'une startup, mais qui restait encore assez compacte et efficace.  La sociÃ©tÃ© a hÃ©bergÃ© (sur son matÃ©riel) des centaines de serveurs Windows, et cela a dÃ» Ãªtre surveillÃ©.  Avant mÃªme d'y arriver, NetIQ a Ã©tÃ© choisi comme solution. <br><br>  J'ai Ã©tÃ© chargÃ© de mettre en place NetIQ, et celui qui l'a fait avant moi n'en a pas dit un mot.  ImprimÃ©.  J'ai vite compris pourquoi.  Steve Jobs tourne probablement dans la tombe, regardant une interface similaire: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="image"></div><br>  En une ligne, la logique des Â«oiseauxÂ» est positive (Ã©vÃ©nement Raise).  Dans un autre nÃ©gatif (ne pas dÃ©clencher d'Ã©vÃ©nement).  Comment Â«ne dÃ©clencher les Ã©vÃ©nements que lorsqueÂ» fonctionne avec un ensemble diffÃ©rent de cases Ã  cocher, je ne l'ai gÃ©nÃ©ralement compris qu'expÃ©rimentalement (et j'ai dÃ©jÃ  oubliÃ©). <br><a name="habracut"></a><br>  Cependant, une caractÃ©ristique bien pire de NetIQ Ã©tait sa fragilitÃ©.  Son agent, installÃ© sur chaque serveur, Ã©tait nettement plus vulnÃ©rable que Windows lui-mÃªme.  Pas assez de mÃ©moire?  L'agent s'est envolÃ©.  CPU 100%?  L'agent ne rÃ©pond pas.  0 octet restant sur le disque - qu'en pensez-vous?  Pour envoyer un message, l'agent doit d'abord le crÃ©er sur disque, sous forme de fichier ... Eh bien, vous comprenez. <br><br>  NÃ©anmoins, ils ont vÃ©cu avec elle jusqu'Ã  ce que l'entreprise soit rachetÃ©e par l'entreprise encore plus.  Lorsqu'un monstre mange une toute petite entreprise, cette entreprise se dissout comme une goutte dans la mer.  Dans notre cas, nous-mÃªmes, selon les normes informatiques, n'Ã©tions que lÃ©gÃ¨rement infÃ©rieurs Ã  ceux qui nous ont achetÃ©s, et il Ã©tait immÃ©diatement Ã©vident que le processus de fusion serait trÃ¨s difficile.  Si compliquÃ© que pendant un certain temps nous n'avons pas Ã©tÃ© touchÃ©s du tout et en interne tous les processus sont restÃ©s les mÃªmes.  Cet Ã©tat Ã©tait similaire au moment oÃ¹ l'anneau de toute-puissance est tombÃ© sur la lave, mais n'a pas encore commencÃ© Ã  fondre: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg"></div><br>  En attendant, j'ai mis Ã  niveau NetIQ de la version 7 Ã  8 puis Ã  9, lorsque nos problÃ¨mes ont commencÃ©.  NetIQ n'a surveillÃ© que quelques Ã©lÃ©ments: la disponibilitÃ© du serveur lui-mÃªme, de la mÃ©moire, du processeur, du disque et, surtout, des services.  Si nos services auto-Ã©crits Ã©taient en Automatique, alors ils auraient dÃ» fonctionner.  Cela ne devrait pas Ãªtre comme Ã§a: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg"></div><br>  Ces Ã©vÃ©nements dans la plupart des cas et ont cessÃ© de surveiller NetIQ.  AprÃ¨s une semaine d'expÃ©riences et une semaine de travail avec le support, nous avons dÃ©couvert que Â«ce n'est pas un bug, c'est une fonctionnalitÃ©Â» et qu'une alerte est gÃ©nÃ©rÃ©e uniquement avec un certain code de sortie.  Et nos services tombaient parfois sous n'importe quel code. <br><br>  Beaucoup de temps s'est Ã©coulÃ© et il Ã©tait trop tard pour revenir en arriÃ¨re.  Comme vous le comprenez, aprÃ¨s avoir dÃ©couvert que notre infrastructure critique n'est pas surveillÃ©e, nous n'avons immÃ©diatement ... euh ... rien fait.  Parce qu'Ã  ce moment-lÃ , la Â«dissolutionÂ» de notre entreprise Ã©tait entrÃ©e en grande partie dans la phase active, et elle ressemblait Ã  ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg"></div><br>  Des coups de tonnerre lointains, des cris, des Ã©clairs m'ont atteint, et il semblait que le destin du monde Ã©tait en train d'Ãªtre dÃ©cidÃ©, et je grimpais avec une sorte de problÃ¨me technique mineur ... Mais je ne pouvais pas dormir paisiblement, sachant que notre surveillance Ã©tait Ã  moitiÃ© aveugle. <br><br>  RÃ©alisant qu'il n'y avait nulle part oÃ¹ attendre de l'aide, j'ai dÃ©cidÃ© d'Ã©crire rapidement un scanner de service qui contournerait tous les serveurs et enverrait un e-mail si quelque chose n'allait pas comme NetIQ.  Vous pensez probablement que j'ai utilisÃ© Powershell?  Non.  Si vous avez un marteau entre les mains, alors tout est clou, et si vous utilisez DBA et travaillez avec SQL depuis la version 6.0, alors ... Un court extrait du code pour que vous puissiez comprendre de quoi il s'agit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png"></div><br>  Je l'ai fait en quelques heures.  Au cours des prochains jours, il y a eu un audit des messages, paramÃ¨tres et autres goodies.  AprÃ¨s avoir lu la commande WMIC, je n'ai pas pu m'arrÃªter.  Puis quelques semaines dans un brouillard.  Je me suis rÃ©veillÃ© lorsque tout ce que nous avons utilisÃ© dans NetIQ a Ã©tÃ© rÃ©Ã©crit et a fonctionnÃ© avec fracas. <br><br>  La fonctionnalitÃ© n'Ã©tait pas seulement copiÃ©e - j'ai rÃ©alisÃ© tous mes fantasmes, tout ce que j'aimerais d'un tel systÃ¨me.  LOWDISK - vous obtenez Ã©galement un graphique de la faÃ§on dont l'espace libre sur le disque s'est comportÃ© rÃ©cemment - si cette croissance est normale ou si quelque chose s'est mal passÃ©.  Il n'y a pas assez de mÃ©moire - c'est le calendrier, et la liste des processus et combien ils prennent, et pour w3wp.exe, nous terminerons le nom du pool d'applications, les rappels intelligents et bien plus encore.  Soit dit en passant, le systÃ¨me pourrait prendre seul la liste des serveurs de VMware.  Un coup d'Å“il rapide aux sujets d'alertes au tÃ©lÃ©phone a suffi pour comprendre ce qui se passait: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png"></div><br>  Les programmeurs modernes sont tellement habituÃ©s Ã  penser de maniÃ¨re abstraite qu'ils ne peuvent pas Ã©crire un systÃ¨me de surveillance autre que "pour le serveur, nous exÃ©cutons un ensemble de scripts de surveillance abstraits, et nous ne nous soucions pas de ce qu'il y a Ã  l'intÃ©rieur", tout en surveillant chaque Ã©tat - disque, mÃ©moire, CPU, services - Ã  sa maniÃ¨re sont uniques.  En rÃ©alisant cela Â«de maniÃ¨re abstraiteÂ», vous vous en sortez tout aussi mal pour chaque cas, et c'est ce qui se passe: (Ceci est une capture d'Ã©cran de l'e-mail de SCOM. SÃ»rement fait strictement selon le mandat) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png"></div><br>  Un Ã©norme avantage du nouveau systÃ¨me Ã©tait qu'il Ã©tait sans agent, respectivement, il n'y avait aucun problÃ¨me avec l'installation de l'agent, ses plantages - il n'y avait tout simplement rien Ã  y faire.  Le systÃ¨me Ã©tait simple et fiable comme un marteau. <br><br>  Les mois suivants, je suis venu travailler le matin, je me suis tenu devant mon idÃ©e originale, comme un artiste devant une toile, et j'ai appliquÃ© quelques coups, ce qui le rend encore plus idÃ©al.  Comme je n'avais pas de dÃ©lais, la dette technique a Ã©tÃ© minimisÃ©e.  Ã€ un moment donnÃ©, je me suis encore forcÃ© Ã  arrÃªter. <br><br>  NetIQ fonctionnait toujours, mais tout le monde aimait plus le nouveau type d'alertes, et progressivement j'ai transfÃ©rÃ© tout le monde aux alertes du nouveau systÃ¨me, sans dÃ©sactiver l'ancien, cependant.  Entre-temps, le processus de Â«fusionÂ» est entrÃ© dans sa phase finale: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg"></div><br>  Eh bien, le conte de fÃ©es devait se terminer.  J'ai moi-mÃªme Ã©tÃ© surpris de pouvoir m'amuser autant dans une grande entreprise bureaucratique.  AprÃ¨s un mois de prÃ©paration, ils m'ont dit qu'en une semaine, nous avons Ã©teint NetIQ et nous sommes passÃ©s Ã  SCOM.  J'ai dÃ©sactivÃ© NetIQ (je l'avoue, je le dÃ©testais tellement que j'Ã©tais trÃ¨s content) et j'ai commencÃ© Ã  attendre SCOM.  Mais Ã  l'heure fixÃ©e, il n'Ã©tait pas lÃ .  Pas aprÃ¨s une semaine et aprÃ¨s un mois. <br><br>  SCOM est apparu seulement six mois plus tard - quelqu'un a oubliÃ© le nombre de serveurs que nous avons et le nombre de licences dont nous avons besoin pour SCOM.  En six mois, de nombreux systÃ¨mes ont commencÃ© Ã  dÃ©pendre de mon systÃ¨me, qui a commencÃ© Ã  conserver les inventaires, les mesures et bien plus encore, qui est restÃ© tranquillement deuxiÃ¨me - non officiel.  Pour les auditeurs, il y a SCOM, et tout ce qui est vraiment utile est dans le deuxiÃ¨me systÃ¨me. <br><br>  Parfois, les gestionnaires de diffÃ©rents niveaux se demandaient - d'oÃ¹ viennent ces courriels automatisÃ©s?  RÃ©cemment, je leur ai dÃ©crit en dÃ©tail l'histoire que j'ai exposÃ©e dans cet article, et ils ont ri joyeusement.  Bien que ce soit encore parfois trÃ¨s drÃ´le pour moi, comment dans une grande entreprise bureaucratique vous pouvez "traÃ®ner dans une morgue silencieuse" beaucoup de choses.  Oui, et c'est bien d'Ã©crire simplement le code, comme au bon vieux temps. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430662/">https://habr.com/ru/post/fr430662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430650/index.html">Sex est un vendeur de jeux d'arcade classiques. Et qui est l'acheteur?</a></li>
<li><a href="../fr430654/index.html">Devleads Meetup: nous rÃ©unissons une Ã©quipe efficace, optimisons le dÃ©veloppement, discutons des problÃ¨mes actuels</a></li>
<li><a href="../fr430656/index.html">Programme SAFeÂ® certifiÃ©</a></li>
<li><a href="../fr430658/index.html">Comment Ã§a a commencÃ© - La naissance des jeux vidÃ©o</a></li>
<li><a href="../fr430660/index.html">Passer Ã  Androidx ou une aventure de rÃ¢teau passionnante</a></li>
<li><a href="../fr430664/index.html">Le rÃ´le du chef d'Ã©quipe dans le recrutement</a></li>
<li><a href="../fr430666/index.html">Comment Ã©valuer les performances d'une Ã©quipe</a></li>
<li><a href="../fr430668/index.html">Seul sur le terrain n'est pas un guerrier. La voie vers un travail d'Ã©quipe efficace</a></li>
<li><a href="../fr430670/index.html">Gestion des arrangements</a></li>
<li><a href="../fr430672/index.html">Version texte du rapport Â«Acteurs vs CSP vs TÃ¢ches ...Â» avec C ++ CoreHard Automne 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>