<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëí üë©üèº‚Äç‚öñÔ∏è üôç FreePBX Configurando o Asterisk para notifica√ß√µes por email de chamadas perdidas na fila üë©üèø‚Äçüéì üå± üñïüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IP ATC Asterisk √© um poderoso processador de telefonia IP. E a interface baseada na Web FreePBX criada para o Asterisk simplifica muito a configura√ß√£o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>FreePBX Configurando o Asterisk para notifica√ß√µes por email de chamadas perdidas na fila</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463829/"><img src="https://habrastorage.org/webt/ke/dl/08/kedl08qszm8sgw39uk2zteenbja.png" alt="imagem"><br>  IP ATC Asterisk √© um poderoso processador de telefonia IP.  E a interface baseada na Web FreePBX criada para o Asterisk simplifica muito a configura√ß√£o e reduz o limite de logon. <br>  Se voc√™ pode criar algum tipo de tarefa relacionada √† telefonia IP, quase certamente ela pode ser implementada no Asterisk.  Mas certifique-se de que perseveran√ßa e resist√™ncia ser√£o exigidas de voc√™. <br><br>  Enfrentamos a tarefa de configurar notifica√ß√µes por email de chamadas perdidas.  Mais precisamente, para notificar por e-mail os casos em que uma chamada recebida foi colocada na fila, mas ningu√©m (dos agentes) respondeu a essa chamada. <br><br>  Surpreendentemente, n√£o encontramos nenhuma ferramenta regular para resolver esse problema no FreePBX.  Vou falar sobre como resolvemos esse problema por baixo. <br><a name="habracut"></a><br>  <b>Pref√°cio</b> <br><br>  Antes de resolver o problema "de frente", certamente procuramos informa√ß√µes na Internet, mas n√£o encontramos solu√ß√µes prontas para o uso (talvez elas estivessem mal, mas o que voc√™ pode fazer ...). <br><br>  N√£o existem tantas habilidades de trabalho diretamente no Asterisk quanto gostar√≠amos, portanto a solu√ß√£o proposta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> n√£o foi totalmente compreendida e foi descartada. <br><br>  Gostei da solu√ß√£o proposta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , embora n√£o tenha funcionado.  Por isso, enfatizaram que trabalhar no Asterisk √© necess√°rio no contexto de [ext-queues].  E como trabalhamos no Freepbx, precisamos trabalhar no arquivo de configura√ß√£o "extensions_override_freepbx.conf".  Percebemos que √© conveniente "capturar chamadas perdidas" antes do evento hangupcall (final de uma chamada). <br>  Depois de ler a discuss√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , surgiu a id√©ia de que precisamos filtrar a vari√°vel "Disposition" no CDR para todos os agentes na fila.  E depois de ler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">essas</a> informa√ß√µes, etapas bastante espec√≠ficas foram formadas para resolver a tarefa. <br><br>  <b>O que temos:</b> <br><br>  Existe o FreePBX 13.0.197 que usa o Asterisk 13.12.1.  Vers√£o do SO SHMZ vers√£o 6.6 (Final).  A distribui√ß√£o √© baseada no CentOS. <br><br>  O Asterisk √© configurado com IVR (menu de voz), espalhando as chamadas recebidas em diferentes filas (filas).  Os agentes (agentes) s√£o atribu√≠dos a cada fila, ou seja, agentes. <br><br>  <b>Teoria</b> <br><br>  <b>O que est√° acontecendo no Asterisk</b> <br><br>  Quando uma chamada de entrada chega ao Asterisk, essa chamada vai para o IVR.  O chamador faz uma escolha pressionando um n√∫mero espec√≠fico no telefone e entra em uma fila espec√≠fica.  Depois disso, todos os agentes livres da fila recebem simultaneamente uma chamada. <br><br>  Para entender melhor o que est√° acontecendo neste momento e o que acontece a seguir, passamos ao Report CDR (Fig. 1). <br><br><img src="https://habrastorage.org/webt/sv/qg/86/svqg86ls1ot8x4lcl5syw7oq3w0.png" alt="imagem"><br>  <i>Fig. 1</i> <br><br>  Quando uma chamada recebida entra na fila, para todos os agentes, o valor da vari√°vel "Disposi√ß√£o" torna-se igual a "SEM RESPOSTA" se os agentes n√£o estiverem ocupados naquele momento.  A vari√°vel "Disposi√ß√£o" pode assumir outros valores (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://asterisk-pbx.ru/wiki/asterisk/cf/cdr</a> ), exceto o valor "RESPONDIDO".  E no momento em que um dos agentes atende a chamada, o valor da vari√°vel "Disposi√ß√£o" desse agente se torna igual a "RESPONDIDO". <br>  No CDR do relat√≥rio, voc√™ pode ver que quando a chamada est√° na fila (na coluna Aplicativo, o valor se torna "Fila"), todos os eventos aparecem com o mesmo "ID exclusivo" (coluna Sistema). <br><br>  <b>CDR em breve</b> <br><br>  √â importante entender o que √© um CDR e em que momento no CDR s√£o inseridos os dados que observamos no CDR do relat√≥rio.  O CDR, relativo ao sistema operacional, √© o banco de dados no qual o Asterisk grava um relat√≥rio de chamadas detalhado (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://asterisk-pbx.ru/wiki/asterisk/cf/cdr</a> ).  No nosso caso, este √© um banco de dados chamado asteriskcdrdb, localizado no mysql.  Empiricamente, descobrimos que os dados sobre uma chamada com um determinado "uniqueid" n√£o s√£o inseridos no asteriskcdrdb imediatamente ap√≥s a ocorr√™ncia de um evento, mas ap√≥s o evento hangupcall (final da chamada). <br><br>  <b>O princ√≠pio da solu√ß√£o criada</b> <br><br>  Como temos mais conhecimento em bash do que conhecimento em Asterisk, a id√©ia principal √© a seguinte.  Antes do evento hangupcall, chame o script bash.  Passe 3 par√¢metros para esse script.  O primeiro par√¢metro √© "uniqueid", para filtrar os dados recebidos do CDR.  O segundo par√¢metro √© "CALLERID (num)" (o n√∫mero do chamador) para saber para quem ligar de volta.  O terceiro par√¢metro √© "NODEST" (n√∫mero da fila), para o qual a chamada foi recebida, para saber qual problema houve uma chamada e para quem enviar uma notifica√ß√£o por email de uma chamada perdida. <br>  O script bash deve se conectar ao banco de dados asteriskcdrdb no mysql e pegar todos os valores da vari√°vel "Disposition" com um "uniqueid" espec√≠fico.  Dos dados obtidos, √© necess√°rio excluir os valores: ‚ÄúSEM RESPOSTA‚Äù, ‚ÄúOCUPADO‚Äù, ‚ÄúFALHADO‚Äù, ‚ÄúDESCONHECIDO‚Äù.  Como resultado, ‚ÄúRESPONDIDO‚Äù permanecer√° - eles atenderam a chamada recebida ou nada - a chamada perdida. <br><br>  Al√©m disso, se a chamada foi perdida, o script deve enviar uma notifica√ß√£o por email. <br>  No futuro, observo um ponto importante.  O Asterisk executa os comandos sequencialmente, aguardando sua execu√ß√£o (o que geralmente √© l√≥gico).  E chamaremos o script bash antes que o comando hangupcall seja executado.  Assim, no momento em que o script √© executado diretamente, as informa√ß√µes sobre o ID √∫nico que estamos procurando ainda n√£o ser√£o inseridas no CDR.  Para resolver esse problema, chamaremos o script bash com o par√¢metro "&amp;" para que o Asterisk prossiga imediatamente para a pr√≥xima etapa, ou seja, hangupcall.  E dentro do script bash, no in√≠cio, definiremos um pequeno atraso para que o Asterisk insira os dados com o ‚Äúuniqueid‚Äù de seu interesse no CDR. <br><br>  <b>Pr√°tica</b> <br><br>  Antes de continuar configurando o Asterisk e criar um script bash, voc√™ precisa configurar o envio de notifica√ß√µes por email.  Para isso, usaremos o utilit√°rio postfix. <br><br>  <b>Configura√ß√£o do Postfix</b> <br><br>  Temos um dom√≠nio de correio "lucky.ru" localizado em Yandex.  Vamos configurar o postfix no modo smtp-client e enviaremos cartas da conta asterisk@lucky.ru. <br>  A solu√ß√£o √© retirada daqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.dmosk.ru/miniinstruktions.php?mini=postfix-over-yandex</a> . <br><br>  Primeiro instale / atualize / verifique os pacotes: <br><br><pre><code class="bash hljs">yum install postfix yum install mailx yum install cyrus-sasl cyrus-sasl-lib cyrus-sasl-plain</code> </pre> <br>  N√£o sobrescreveremos o arquivo de configura√ß√£o principal do postfix "/etc/postfix/main.cf", mas faremos o backup: <br><br><pre> <code class="bash hljs">cp /etc/postfix/main.cf /etc/postfix/main.cf.sav</code> </pre> <br>  Editamos o arquivo ‚Äú/etc/postfix/main.cf‚Äù e o trazemos para o seguinte formato: <br><br><pre> <code class="bash hljs">nano /etc/postfix/main.cf <span class="hljs-comment"><span class="hljs-comment">##################### relayhost = smtp_sasl_auth_enable = yes smtp_sasl_password_maps = hash:/etc/postfix/private/sasl_passwd smtp_sasl_security_options = noanonymous smtp_sasl_type = cyrus smtp_sasl_mechanism_filter = login smtp_sender_dependent_authentication = yes sender_dependent_relayhost_maps = hash:/etc/postfix/private/sender_relay smtp_generic_maps = hash:/etc/postfix/generic smtp_tls_CAfile = /etc/postfix/ca.pem smtp_use_tls = yes smtputf8_autodetect_classes = all #####################</span></span></code> </pre> <br>  Nem todas as linhas em "/etc/postfix/main.cf" podem ser comentadas.  Os coment√°rios em algumas linhas n√£o s√£o determinados pelo analisador e s√£o passados ‚Äã‚Äãpara o processamento, e isso leva a erros.  √â melhor recusar coment√°rios dentro deste arquivo.  Voc√™ pode experimentar isso executando ‚Äútail -f / var / log / messages‚Äù na pr√≥xima janela. <br><br>  Vou marcar a linha "smtputf8_autodetect_classes = all".  Esta entrada inclui utf-8 por padr√£o, que permite usar o alfabeto cir√≠lico no corpo da letra e na linha de assunto sem manipula√ß√µes adicionais (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.postfix.org/SMTPUTF8_README.html</a> ). <br><br>  Crie um diret√≥rio para os arquivos de configura√ß√£o: <br><br><pre> <code class="bash hljs">mkdir /etc/postfix/private</code> </pre> <br>  Editamos o arquivo "/ etc / postfix / private / sender_relay".  Nele, voc√™ precisa especificar a qual servidor smtp voc√™ deve se referir ao usar nosso dom√≠nio de email: <br><br><pre> <code class="bash hljs">nano /etc/postfix/private/sender_relay <span class="hljs-comment"><span class="hljs-comment">##################### @lucky.ru smtp.yandex.ru #####################</span></span></code> </pre> <br>  N√≥s editamos o arquivo "/ etc / postfix / private / sasl_passwd".  Nele, indicaremos o endere√ßo de e-mail que usaremos para enviar cartas, bem como o nome de usu√°rio e a senha dessa conta (especificamos o nome de usu√°rio e a senha por meio de dois pontos): <br><br><pre> <code class="bash hljs">nano /etc/postfix/private/sasl_passwd <span class="hljs-comment"><span class="hljs-comment">##################### asterisk@lucky.ru asterisk@lucky.ru:password_asterisk #####################</span></span></code> </pre> <br>  Editando o arquivo / etc / postfix / generic.  Nele, escreveremos as regras para substituir o endere√ßo de sa√≠da (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://wiki.merionet.ru/ip-telephoniya/30/postfix-nastrojka-otpravki-pochty-v-asterisk/</a> ): <br><br><pre> <code class="bash hljs">nano /etc/postfix/generic <span class="hljs-comment"><span class="hljs-comment">##################### root asterisk@lucky.ru root@localhost asterisk@lucky.ru root@localhost.localdomain asterisk@lucky.ru root@freepbx asterisk@lucky.ru root@freepbx.localdomain asterisk@lucky.ru root@asterisk asterisk@lucky.ru root@asterisk.localdomain asterisk@lucky.ru asterisk asterisk@lucky.ru asterisk@localhost asterisk@lucky.ru asterisk@localhost.localdomain asterisk@lucky.ru asterisk@freepbx asterisk@lucky.ru asterisk@freepbx.localdomain asterisk@lucky.ru asterisk@asterisk asterisk@lucky.ru asterisk@asterisk.localdomain asterisk@lucky.ru root@localdomain.localdomain asterisk@lucky.ru #####################</span></span></code> </pre> <br>  O endere√ßo de sa√≠da inicial depende do conte√∫do de "/ etc / hosts" e "/ etc / hostname", bem como do nome do usu√°rio que enviar√° a carta.  Ou seja, apesar de usarmos o cliente smtp e enviarmos cartas de asterisk@lucky.ru, o postfix substituir√° inicialmente "algo pr√≥prio" no endere√ßo do remetente e isso deve ser corrigido com as regras deste arquivo de configura√ß√£o. <br><br>  Vou listar o conte√∫do do meu arquivo / etc / hosts: <br><br><pre> <code class="bash hljs">cat /etc/hosts <span class="hljs-comment"><span class="hljs-comment">##################### 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 asterisk.localdomain 127.0.0.1 localhost.localdomain localhost ::1 asterisk localhost localhost6 #####################</span></span></code> </pre> <br>  √â importante que o servidor tenha qualquer dom√≠nio (o valor ap√≥s o per√≠odo), porque o utilit√°rio de correio ‚Äúprocura‚Äù o nome de dom√≠nio em ‚Äú/ etc / hosts‚Äù e se ‚Äún√£o o encontrar‚Äù imediatamente, continuar√° fazendo isso por mais alguns minutos e s√≥ ent√£o envie uma carta.  Ou seja, se o dom√≠nio n√£o estiver registrado, a carta sair√° com um atraso de v√°rios minutos. <br><br>  Vou listar o conte√∫do do meu arquivo / etc / hostname: <br><br><pre> <code class="bash hljs">cat /etc/hostname <span class="hljs-comment"><span class="hljs-comment">##################### asterisk #####################</span></span></code> </pre> <br>  Em seguida, voc√™ precisa transferir os arquivos de configura√ß√£o criados para os bancos de dados indexados; para isso, execute o seguinte comando: <br><br><pre> <code class="bash hljs">postmap /etc/postfix/generic &amp;&amp; postmap /etc/postfix/private/{sasl_passwd,sender_relay}</code> </pre> <br>  Em seguida, precisamos baixar e colocar o certificado smtp.yandex.ru no servidor, para fazer isso, execute o seguinte comando: <br><br><pre> <code class="bash hljs">openssl s_client -starttls smtp -crlf -connect smtp.yandex.ru:25 &gt; /etc/postfix/ca.pem</code> </pre> <br>  Mas depois que as informa√ß√µes t√©cnicas aparecerem na tela, a equipe "continuar√° travando".  Pressione Ctrl + C para abort√°-lo. <br><br>  Agora exclua manualmente todo o lixo do arquivo resultante e deixe apenas o certificado.  Voc√™ deve obter algo como isto: <br><br><pre> <code class="bash hljs">nano /etc/postfix/ca.pem <span class="hljs-comment"><span class="hljs-comment">##################### -----BEGIN CERTIFICATE----- MIIGazCCBVOgAwIBAgIQcUU9mJXW4OUs5Gf0JfLtsjANBgkqhkiG9w0BAQsFADBf ... nRG0DfdqYIuPGApFORYe -----END CERTIFICATE----- #####################</span></span></code> </pre> <br>  Por fim, reinicie o postfix: <br><br><pre> <code class="bash hljs">service postfix restart</code> </pre> <br>  Enviamos uma carta de teste: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"  "</span></span> | mail -s <span class="hljs-string"><span class="hljs-string">" "</span></span> admin@lucky.ru</code> </pre> <br>  admin@lucky.ru - endere√ßo de destino <br><br>  Isso completa a configura√ß√£o do posfix. <br><br>  <b>Escrevendo um script bash</b> <br><br>  Crie um diret√≥rio para armazenar um script bash (aqui algu√©m gosta onde): <br><br><pre> <code class="bash hljs">mkdir /home/asterisk/scripts</code> </pre> <br>  Crie um arquivo de script bash: <br><br><pre> <code class="bash hljs">touch /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  Damos permiss√µes ao arquivo de script para executar: <br><br><pre> <code class="bash hljs">chmod +x /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  Se houver d√∫vidas sobre os direitos do arquivo, durante a depura√ß√£o, voc√™ poder√° conceder acesso total ao arquivo.  Mas n√£o √© "seguro". <br><br><pre> <code class="bash hljs">chmod 777 /home/asterisk/scripts/noanswer.sh</code> </pre> <br>  O texto do script bash: <br><br><pre> <code class="bash hljs">nano /home/asterisk/scripts/noanswer.sh <span class="hljs-comment"><span class="hljs-comment">##################### #!/bin/bash sleep 7 res_sql="SELECT disposition FROM cdr WHERE uniqueid = '$1'" answer=`mysql -u freepbxuser -pPassword_freepbxuser -D asteriskcdrdb -B -N -e "$res_sql" | grep -E -v "NO ANSWER|BUSY|FAILED|UNKNOWN" | head -n 1` error_kod=0 if [ "$answer" != "ANSWERED" ] then case $3 in 68800) address="big_boss@lucky.ru" subject="  " ;; 63100) address="debian@lucky.ru" subject="  linux debian" ;; 63200) address="windows@lucky.ru" subject="  windows" ;; 63300) address="freebsd@lucky.ru" subject="  freebsd" ;; 63400) address="ubuntu@lucky.ru" subject="  linux ubuntu" ;; 63500) address="centos@lucky.ru" subject="  linux centos" ;; *) address="admin@lucky.ru" error_kod=1 ;; esac case $error_kod in 0) echo "    $2,  $subject." | mail -s "   $2" $address echo "   $address   $2,  $subject. uid=$1" | mail -s "   $2" admin@lucky.ru ;; 1) echo "   $2.  . uid=$1" | mail -s "   $2" admin@lucky.ru ;; esac fi #####################</span></span></code> </pre> <br>  Uma breve an√°lise do script: <br>  "Dormir 7": <br><br>  Este √© o mesmo atraso de tempo que escrevi anteriormente.  Temos um atraso de 7 segundos.  Embora, eu acho, um segundo seja suficiente. <br><br><pre> <code class="sql hljs">¬´res_sql="<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> disposition <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> cdr <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> uniqueid = <span class="hljs-string"><span class="hljs-string">'$1'</span></span><span class="hljs-string"><span class="hljs-string">"¬ª:</span></span></code> </pre> <br>  A consulta no mysql √© colocada em uma vari√°vel separada por conveni√™ncia. <br><br>  Em seguida, fazemos uma solicita√ß√£o no mysql e filtramos a sa√≠da resultante.  Removemos todas as op√ß√µes, exceto "RESPONDIDO", se houver.  Se houver v√°rios valores "RESPONDIDOS", apenas um dever√° ser deixado.  No final, na vari√°vel ‚Äúresposta‚Äù, obtemos ‚ÄúRESPOSTA‚Äù ou ‚Äú‚Äù. <br>  Se o valor da vari√°vel de resposta n√£o for igual a RESPONDIDO, esta ser√° uma chamada perdida.  Dependendo do n√∫mero da fila, usando o operador case, definiremos o endere√ßo para o qual √© necess√°rio enviar uma notifica√ß√£o por e-mail e o que escrever nesta mensagem (parte vari√°vel da mensagem). <br><br>  A seguir, uma op√ß√£o quando a fila √© configurada no Asterisk, mas n√£o descrita no script.  Nesse caso, admin@lucky.ru receber√° uma carta informando que a fila n√£o √© conhecida pelo script. <br><br>  Se a fila for descrita, uma carta de destino e uma carta duplicada ser√£o enviadas para admin@lucky.ru indicando ‚Äúuniqueid‚Äù, para que voc√™ possa rastrear eventos nessa chamada, se necess√°rio. <br><br>  Isso termina o script. <br><br>  Observo que, para conectar ao mysql, usamos o nome de usu√°rio e a senha que reconhecemos previamente.  No FreePBX, para descobrir o login do usu√°rio do Asterisk no mysql, execute o seguinte comando: <br><br><pre> <code class="bash hljs">cat /etc/amportal.conf | grep AMPDBUSER</code> </pre> <br>  E, para descobrir a senha do usu√°rio do Asterisk no mysql, execute o seguinte comando: <br><br><pre> <code class="bash hljs">cat /etc/amportal.conf | grep AMPDBPASS</code> </pre> <br>  <b>Configurar o Asterisk</b> <br><br>  N√≥s usamos o FreePBX.  O FreePBX possui diferentes tipos de arquivos de configura√ß√£o (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://asterisk-pbx.ru/wiki/freepbx/files</a> ), alguns deles s√£o substitu√≠dos pelo FreePBX ap√≥s a reinicializa√ß√£o e outros n√£o s√£o substitu√≠dos (chamados de personalizados), pois s√£o especialmente projetados para o usu√°rio. <br><br>  Trabalharemos com o arquivo de configura√ß√£o ‚Äúextensions_override_freepbx.conf‚Äù, pois √© do tipo customizado. <br><br>  Primeiro, verifique se o arquivo ‚Äúextensions_override_freepbx.conf‚Äù est√° conectado no arquivo ‚Äú/etc/asterisk/extensions.conf‚Äù.  Para fazer isso, execute o seguinte comando: <br><br><pre> <code class="bash hljs">cat /etc/asterisk/extensions.conf | grep extensions_override_freepbx.conf <span class="hljs-comment"><span class="hljs-comment">##################### #include extensions_override_freepbx.conf #####################</span></span></code> </pre> <br>  Editamos o arquivo "/etc/asterisk/extensions_override_freepbx.conf" e o trazemos para o seguinte formato: <br><br><pre> <code class="bash hljs">nano /etc/asterisk/extensions_override_freepbx.conf <span class="hljs-comment"><span class="hljs-comment">##################### [ext-queues] exten =&gt; h,1,System(/home/asterisk/scripts/noanswer.sh ${CDR(uniqueid)} ${CALLERID(num)} ${NODEST} &amp;) exten =&gt; h,2,Macro(hangupcall,) #####################</span></span></code> </pre> <br>  Como escrevi anteriormente, o s√≠mbolo "&amp;" no final √© necess√°rio.  Como trabalharemos em um script bash com dados CDR diretamente do banco de dados mysql, e esses dados s√£o inseridos no mysql somente ap√≥s a execu√ß√£o de ‚Äúexten =&gt; h, 2, Macro (hangupcall,)‚Äù, n√£o precisamos aguardar a conclus√£o do script bash e prossiga para a pr√≥xima etapa no Asterisk.  E o pr√≥prio script bash deve conter um atraso de tempo antes de executar sua parte principal. <br><br>  Para que as altera√ß√µes no arquivo de configura√ß√£o ‚Äú/etc/asterisk/extensions_override_freepbx.conf‚Äù entrem em vigor, √© necess√°rio reiniciar o kernel do Asterisk com o seguinte comando: <br><br><pre> <code class="bash hljs">/usr/sbin/asterisk -rx <span class="hljs-string"><span class="hljs-string">"core restart now"</span></span></code> </pre> <br>  Isso precisa ser feito ap√≥s a cria√ß√£o do script bash. <br><br>  <b>Conclus√£o</b> <br><br>  Esta √© provavelmente a maneira 1001 de "capturar chamadas perdidas" no Asterisk.  Compartilhe nos coment√°rios como voc√™ resolve esse problema.  E o que, na sua opini√£o, pode ser melhorado / refeito / otimizado.  Seremos gratos pelas id√©ias construtivas. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt463829/">https://habr.com/ru/post/pt463829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt463817/index.html">20 gerentes de produto e a estrutura matricial mais multidimensional de todos. Conversa com Skyeng</a></li>
<li><a href="../pt463819/index.html">Bloqueios do PostgreSQL: 2. Bloqueios de string</a></li>
<li><a href="../pt463821/index.html">AMO, Bitrix, 1C e outros: como escolher por onde come√ßar?</a></li>
<li><a href="../pt463823/index.html">Vers√£o Rust 1.37.0: Otimiza√ß√£o guiada por perfil, constantes sem nome e fornecedor de carga</a></li>
<li><a href="../pt463825/index.html">Ferramenta de gerenciamento de projetos do Planilhas Google</a></li>
<li><a href="../pt463831/index.html">O que h√° de errado com a educa√ß√£o em TI na R√∫ssia</a></li>
<li><a href="../pt463833/index.html">Uma pequena pesquisa sobre bloqueadores</a></li>
<li><a href="../pt463835/index.html">Esta Internet das coisas perigosa: amea√ßas e solu√ß√µes de neg√≥cios</a></li>
<li><a href="../pt463839/index.html">Museum DataArt. Lunolet e calculadoras sovi√©ticas</a></li>
<li><a href="../pt463845/index.html">Telegrama, quem √©?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>