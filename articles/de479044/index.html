<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶🏾 🛌🏿 🤞🏻 Meine Ringpuffer-Implementierung in NOR-Flash 🧑🏾‍🤝‍🧑🏼 👳🏿 ⚜️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hintergrund 


 Es gibt Automaten nach eigenem Design. Im Raspberry Pi und ein bisschen Umreifen auf einem separaten Brett. Ein Münzprüfer, ein Geldsc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Meine Ringpuffer-Implementierung in NOR-Flash</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479044/"><h1 id="predystoriya">  Hintergrund </h1><br><p>  Es gibt Automaten nach eigenem Design.  Im Raspberry Pi und ein bisschen Umreifen auf einem separaten Brett.  Ein Münzprüfer, ein Geldscheinprüfer, ein Bankautomat sind angeschlossen ... Ein selbst geschriebenes Programm verwaltet alles.  Die gesamte Geschichte der Arbeit wird auf einem Flash-Laufwerk (MicroSD) in das Journal geschrieben, das dann über das Internet (unter Verwendung eines USB-Modems) an den Server übertragen und dort der Datenbank hinzugefügt wird.  Verkaufsinformationen werden in 1s geladen, es gibt auch ein einfaches Webinterface zum Überwachen usw. </p><br><p>  Das heißt, das Magazin ist von entscheidender Bedeutung - für die Buchhaltung (dort Einnahmen, Verkäufe usw.), die Überwachung (alle Arten von Fehlern und andere Umstände höherer Gewalt);  das können Sie sagen, alle Informationen, die wir über diese Maschine haben. </p><br><h1 id="problema">  Das problem </h1><br><p>  Flash-Laufwerke zeigen sich als sehr unzuverlässige Geräte.  Sie scheitern mit beneidenswerter Regelmäßigkeit.  Dies führt sowohl zu Maschinenausfällen als auch (falls das Journal aus irgendeinem Grund nicht online übertragen werden konnte) zu Datenverlust. </p><br><p>  <em>Dies ist nicht die erste Erfahrung mit der Verwendung von Flash-Laufwerken, bevor es ein weiteres Projekt mit mehr als hundert Geräten gab, in denen das Magazin auf USB-Flash-Laufwerken gespeichert war, gab es auch Probleme mit der Zuverlässigkeit, wenn die Anzahl der Ausfälle pro Monat bei zehn lag.</em>  <em>Wir haben verschiedene Flash-Laufwerke ausprobiert, darunter auch Marken-Laufwerke mit SLC-Speicher. Einige Modelle sind zuverlässiger als andere, aber das Ersetzen von Flash-Laufwerken hat das Problem nicht radikal gelöst.</em> </p><a name="habracut"></a><br><p>  <strong>Achtung!</strong>  Longrid!  Wenn Sie sich nicht für das Warum interessieren, sondern nur für das Wie, können Sie sofort <a href="https://habr.com/ru/post/479044/">zum Ende des</a> Artikels gehen. </p><br><h1 id="reshenie">  Lösung </h1><br><p>  Das erste, was mir in den Sinn kommt: MicroSD verlassen, zum Beispiel SSD einsetzen und davon booten.  Theoretisch ist dies wahrscheinlich möglich, aber relativ teuer und nicht so zuverlässig (ein USB-SATA-Adapter wird hinzugefügt; bei Budget-SSDs ist die Ausfallstatistik ebenfalls nicht gut). </p><br><p>  USB HDD sieht auch nicht besonders attraktiv aus. </p><br><p>  Aus diesem Grund haben wir diese Option gewählt: Verlassen Sie den Download von MicroSD, verwenden Sie sie jedoch im schreibgeschützten Modus, und speichern Sie das Betriebsprotokoll (und andere Informationen, die nur für eine bestimmte Hardwarekomponente gelten - Seriennummer, Sensorkalibrierungen usw.) an einer anderen Stelle. </p><br><p>  Das Thema Nur-Lese-FS für Himbeeren wurde bereits eingehend untersucht. Ich werde nicht auf die Implementierungsdetails in diesem Artikel eingehen <em>(aber wenn Interesse besteht, schreibe ich möglicherweise einen Mini-Artikel zu diesem Thema)</em> .  Der einzige Punkt, den ich erwähnen möchte: sowohl aus persönlicher Erfahrung als auch aus Bewertungen, die bereits einen Gewinn an Zuverlässigkeit erzielt haben, ist.  Ja, es ist unmöglich, Ausfälle vollständig zu beseitigen, aber es ist durchaus möglich, deren Häufigkeit erheblich zu verringern.  Ja, und die Karten werden vereinheitlicht, was den Austausch für das Wartungspersonal erheblich vereinfacht. </p><br><h2 id="apparatnaya-chast">  Hardware </h2><br><p>  Es gab keinen Zweifel an der Wahl des Speichertyps - NOR Flash. <br>  Argumente: </p><br><ul><li>  einfache Verbindung (am häufigsten der SPI-Bus, dessen Erfahrung bereits vorhanden ist, sodass keine "Eisen" -Probleme zu erwarten sind); </li><li>  lächerlicher Preis; </li><li>  Standard-Betriebsprotokoll (die Implementierung ist bereits im Linux-Kernel, wenn Sie möchten, können Sie einen Dritten mitnehmen, der ebenfalls vorhanden ist, oder sogar Ihren eigenen schreiben, der Vorteil ist einfach); </li><li>  Zuverlässigkeit und Ressource: <br>  aus einem typischen Datenblatt: Daten werden 20 Jahre lang gespeichert, 100.000 Löschzyklen für jeden Block; <br>  aus Quellen von Drittanbietern: Extrem niedrige BER, es wird postuliert, dass keine Fehlerkorrekturcodes erforderlich sind <em>(in einigen Veröffentlichungen wird ECC für NOR berücksichtigt, aber normalerweise ist MLC NOR dort gemeint, es passiert)</em> . </li></ul><br><p>  Lassen Sie uns den Bedarf an Volumen und Ressourcen abschätzen. </p><br><p>  Ich möchte die Garantie haben, Daten für mehrere Tage zu speichern.  Dies ist notwendig, damit bei Problemen mit der Verbindung die Verkaufshistorie nicht verloren geht.  Wir konzentrieren uns auf 5 Tage, in diesem Zeitraum <em>(auch unter Berücksichtigung von Wochenenden und Feiertagen) können</em> wir das Problem lösen. </p><br><p>  Wir tippen derzeit ungefähr 100 KB Zeitschriften pro Tag (3-4.000 Datensätze), aber allmählich nimmt diese Zahl zu - die Detaillierung nimmt zu, neue Ereignisse werden hinzugefügt.  Außerdem kommt es manchmal zu Bursts (einige Sensoren senden beispielsweise Spam-Mails mit False-Positives).  Wir werden zehntausend Datensätze von 100 Bytes - Megabytes pro Tag berechnen. </p><br><p>  Es werden insgesamt 5 MB saubere (gut komprimierbare) Daten ausgegeben.  Sie auch <em>(grobe Schätzung) 1</em> MB Service-Daten. </p><br><p>  Das heißt, wir benötigen einen 8-MB-Mikrochip, wenn Sie keine Komprimierung verwenden, oder 4 MB, wenn Sie ihn verwenden.  Ganz reelle Zahlen für diesen Speichertyp. </p><br><p>  Was die Ressource betrifft: Wenn wir vorhaben, dass der gesamte Speicher nicht mehr als einmal alle 5 Tage neu geschrieben wird, erhalten wir in 10 Dienstjahren weniger als tausend Überschreibzyklen. <br>  Ich erinnere mich, der Hersteller verspricht hunderttausend. </p><br><div class="spoiler">  <b class="spoiler_title">Ein bisschen über NOR vs NAND</b> <div class="spoiler_text"><p>  Heute ist der NAND-Speicher natürlich viel beliebter, aber für dieses Projekt würde ich ihn nicht verwenden: NAND erfordert im Gegensatz zu NOR unbedingt die Verwendung von Fehlerkorrekturcodes, eine Tabelle mit fehlerhaften Blöcken usw. und die Beine von NAND-Chips normalerweise viel mehr. </p><br><p>  Die Nachteile von NOR sind: </p><br><ul><li>  kleines Volumen (und dementsprechend hoher Preis pro Megabyte); </li><li>  niedriger Wechselkurs (hauptsächlich aufgrund der Tatsache, dass eine serielle Schnittstelle verwendet wird, normalerweise SPI oder I2C); </li><li>  langsames Löschen (je nach Größe des Blocks dauert es Bruchteile von einer Sekunde bis zu mehreren Sekunden). </li></ul><br><p>  Es scheint nichts kritisches für uns zu sein, also mach weiter. </p></div></div><br><p>  Wenn die Details interessant sind, wurde der <a href="https://www.adestotech.com/wp-content/uploads/doc3686.pdf" rel="nofollow">at25df321a-</a> Chip ausgewählt <em>(dies ist jedoch unerheblich, es gibt viele Analoga auf dem Markt, die mit der Steckerbelegung und dem Befehlssystem kompatibel sind; selbst wenn wir den Chip von einem anderen Hersteller und / oder einer anderen Lautstärke verwenden möchten, funktioniert alles, ohne den Code zu ändern)</em> . </p><br><p>  Ich verwende den im Linux-Kernel integrierten Treiber unter Raspberry. Dank der Unterstützung für Gerätebaum-Overlays ist alles sehr einfach. Sie müssen das kompilierte Overlay in / boot / oversays einfügen und /boot/config.txt ein wenig ändern. </p><br><div class="spoiler">  <b class="spoiler_title">Beispiel dts Datei</b> <div class="spoiler_text"><p>  Ehrlich gesagt bin ich mir nicht sicher, was fehlerfrei geschrieben wurde, aber es funktioniert. </p><br><pre><code class="plaintext hljs">/* * Device tree overlay for at25 at spi0.1 */ /dts-v1/; /plugin/; / { compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709"; /* disable spi-dev for spi0.1 */ fragment@0 { target = &lt;&amp;spi0&gt;; __overlay__ { status = "okay"; spidev@1{ status = "disabled"; }; }; }; /* the spi config of the at25 */ fragment@1 { target = &lt;&amp;spi0&gt;; __overlay__ { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; flash: m25p80@1 { compatible = "atmel,at25df321a"; reg = &lt;1&gt;; spi-max-frequency = &lt;50000000&gt;; /* default to false: m25p,fast-read ; */ }; }; }; __overrides__ { spimaxfrequency = &lt;&amp;flash&gt;,"spi-max-frequency:0"; fastread = &lt;&amp;flash&gt;,"m25p,fast-read?"; }; };</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Und noch eine Zeile in config.txt</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dtoverlay=at25:spimaxfrequency=50000000</code> </pre> </div></div><br><p>  Ich werde die Beschreibung des Verbindens des Chips mit dem Himbeer-Pi weglassen.  Einerseits bin ich kein Experte für Elektronik, andererseits ist auch für mich alles trivial: Die Mikroschaltung hat nur 8 Beine, von denen wir Masse, Leistung, SPI (CS, SI, SO, SCK) benötigen;  Stufen stimmen mit denen von Raspberry Pi überein, es ist keine zusätzliche Bindung erforderlich - schließen Sie einfach die angegebenen 6 Kontakte an. </p><br><h2 id="postanovka-zadachi">  Erklärung des Problems </h2><br><p>  Wie üblich durchläuft die Formulierung des Problems mehrere Iterationen, es scheint mir, dass die Zeit für die nächste gekommen ist.  Also hören wir auf, fassen zusammen, was bereits geschrieben wurde, und klären die im Schatten verbleibenden Details. </p><br><p>  Daher haben wir beschlossen, dass das Protokoll in SPI NOR Flash gespeichert wird. </p><br><div class="spoiler">  <b class="spoiler_title">Was ist NOR Flash für diejenigen, die es nicht wissen</b> <div class="spoiler_text"><p>  Dies ist ein nichtflüchtiger Speicher, mit dem Sie drei Vorgänge ausführen können: </p><br><ol><li>  Lesen: <br>  Am häufigsten wird gelesen: Wir übergeben die Adresse und lesen so viele Bytes, wie wir benötigen. </li><li>  Rekord: <br>  Das Schreiben in NOR-Flash sieht wie ein gewöhnliches aus, hat jedoch eine Besonderheit: Sie können nur 1 in 0 ändern, nicht jedoch umgekehrt.  Wenn sich beispielsweise 0x55 in der Speicherzelle befindet, wird 0x05 nach dem Schreiben von 0x0f bereits dort gespeichert <em>(siehe nachstehende Tabelle)</em> . </li><li>  Löschen: <br>  Natürlich müssen wir auch in der Lage sein, den umgekehrten Vorgang auszuführen - ändern Sie 0 zu 1, weshalb der Löschvorgang vorhanden ist.  Im Gegensatz zu den ersten beiden arbeitet es nicht in Bytes, sondern in Blöcken (der minimale Löschblock in der ausgewählten Mikroschaltung beträgt 4 kb).  Löschen zerstört den gesamten Block und dies ist die einzige Möglichkeit, 0 in 1 zu ändern. Wenn Sie mit Flash-Speichern arbeiten, müssen Sie daher häufig Datenstrukturen am Rand des Löschblocks ausrichten. <br>  In NOR Flash aufnehmen: </li></ol><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Binäre Daten </th></tr></thead><tbody><tr><td>  <strong>War</strong> </td><td> <code>01010101</code> </td> </tr><tr><td>  <strong>Aufgenommen</strong> </td><td> <code>00001111</code> </td> </tr><tr><td>  <strong>Ist geworden</strong> </td><td> <code>00000101</code> </td> </tr></tbody></table></div></div></div><br><p>  Das Journal selbst repräsentiert eine Folge von Datensätzen variabler Länge.  Eine typische Aufzeichnungslänge beträgt ungefähr 30 Bytes (obwohl manchmal Aufzeichnungen mit einer Länge von mehreren Kilobytes vorkommen).  <em>In diesem Fall arbeiten wir mit ihnen wie mit einer Reihe von Bytes. Wenn Sie jedoch interessiert sind, wird CBOR in den Datensätzen verwendet.</em> </p><br><p>  Zusätzlich zum Journal müssen einige aktualisierte „Tuning“ -Informationen gespeichert werden: eine bestimmte Geräte-ID, Sensorkalibrierung, das Flag „Gerät ist vorübergehend deaktiviert“ usw. <br>  Bei diesen Informationen handelt es sich um eine Reihe von Schlüsselwertdatensätzen, die ebenfalls in CBOR gespeichert sind. Wir haben nicht viel von diesen Informationen (maximal einige Kilobyte), sie werden nur selten aktualisiert. <br>  In Zukunft werden wir es Kontext nennen. </p><br><p>  Wenn Sie sich erinnern, wo dieser Artikel begonnen hat, ist es sehr wichtig, die Zuverlässigkeit der Datenspeicherung und, wenn möglich, den Dauerbetrieb auch bei Hardwareausfällen / Datenkorruption sicherzustellen. </p><br><p>  Welche Problemquellen können berücksichtigt werden? </p><br><ul><li>  Während Schreib- / Löschvorgängen ausschalten.  Dies ist aus der Kategorie "gegen Schrott kein Empfang". <br>  Informationen aus der <a href="https://electronics.stackexchange.com/questions/225956/what-would-happen-in-case-of-power-outage-during-nor-flash-erase-or-programming" rel="nofollow">Diskussion</a> zum Stack-Austausch: Wenn die Stromversorgung ausgeschaltet wird, während mit Flash gearbeitet wird, führt das Löschen (Einstellung auf 1) und Schreiben (Einstellung auf 0) zu undefiniertem Verhalten: Daten können geschrieben, teilweise geschrieben werden (dh wir haben 10 Byte / 80 Bit übertragen) , und nur 45 Bits können aufgezeichnet werden), ist es auch möglich, dass sich einige der Bits im "Zwischen" -Zustand befinden (Lesen kann entweder 0 oder 1 ergeben); </li><li>  Fehler im Flash-Speicher selbst. <br>  BER ist zwar sehr niedrig, kann aber nicht gleich Null sein. </li><li>  Busfehler <br>  Die über SPI übertragenen Daten sind in keiner Weise geschützt, es kann durchaus zu Einzelbitfehlern oder Synchronisationsfehlern kommen - Verlust oder Einfügung von Bits (was zu massiven Datenverzerrungen führt); </li><li>  Sonstige Fehler / Ausfälle <br>  Fehler im Code, Himbeer "Pannen", Alien Intervention ... </li></ul><br><p>  Ich habe Anforderungen formuliert, deren Erfüllung meiner Meinung nach notwendig ist, um die Zuverlässigkeit zu gewährleisten: </p><br><ul><li>  Aufzeichnungen sollten sofort in den Flash-Speicher geschrieben werden, anstehende Aufzeichnungen werden nicht berücksichtigt. - Wenn ein Fehler auftritt, sollte er so schnell wie möglich erkannt und verarbeitet werden. - Das System sollte nach Möglichkeit eine Fehlerbehebung durchführen. <br>  <em>(Ein Beispiel aus dem Leben "wie es nicht sein sollte", das sich meiner Meinung nach alle getroffen haben: Nach einem Notfall-Neustart ist das Dateisystem "kaputt" und das Betriebssystem bootet nicht.)</em> </li></ul><br><h2 id="idei-podhody-razmyshleniya">  Ideen, Ansätze, Gedanken </h2><br><p>  Als ich über diese Aufgabe nachdachte, schoss mir ein paar Ideen durch den Kopf, zum Beispiel: </p><br><ul><li>  Verwenden Sie die Datenkomprimierung </li><li>  Verwenden Sie knifflige Datenstrukturen, und speichern Sie beispielsweise Datensatzheader getrennt von den Datensätzen, damit Sie den Rest problemlos lesen können, wenn in einem Datensatz ein Fehler auftritt. </li><li>  Verwenden Sie Bitfelder, um die Vollständigkeit der Aufzeichnung beim Ausschalten zu kontrollieren. </li><li>  Speichern Sie Prüfsummen für alles und alles; </li><li>  Verwenden Sie eine Art fehlerkorrigierende Codierung. </li></ul><br><p>  Einige dieser Ideen wurden verwendet, andere abgelehnt.  Gehen wir in Ordnung. </p><br><h3 id="szhatie-dannyh">  Datenkomprimierung </h3><br><p>  Die Ereignisse, die wir im Tagebuch selbst aufzeichnen, sind ziemlich gleich und wiederholbar ("warf eine Münze von 5 Rubel", "klickte auf die Schaltfläche" Zustellung ändern ", ...).  Daher sollte die Komprimierung sehr effektiv sein. </p><br><p>  Der Overhead für die Komprimierung ist unbedeutend (der Prozessor, den wir haben, ist ziemlich leistungsfähig, selbst auf dem ersten Pi gab es einen Kern mit einer Frequenz von 700 MHz, auf aktuellen Modellen gab es mehrere Kerne mit einer Frequenz von mehr als einem Gigahertz), die Geschwindigkeit des Austauschs mit dem Speicher ist gering (mehrere Megabyte pro Sekunde), die Aufzeichnungsgröße ist gering.  Wenn sich die Komprimierung auf die Leistung auswirkt, ist dies im Allgemeinen nur positiv <em>(absolut unkritisch, nur mit Angabe)</em> .  Außerdem haben wir kein echtes eingebettetes, sondern gewöhnliches Linux - daher sollte die Implementierung keinen großen Aufwand erfordern (verknüpfen Sie einfach die Bibliothek und verwenden Sie mehrere Funktionen daraus). </p><br><p>  Ein Stück des Protokolls wurde aus dem Arbeitsgerät entnommen (1,7 MB, 70.000 Datensätze) und zunächst mit den auf dem Computer verfügbaren gzip, lz4, lzop, bzip2, xz, zstd auf Komprimierbarkeit überprüft. </p><br><ul><li>  gzip, xz, zstd zeigten ähnliche Ergebnisse (40 KB). <br>  Ich war überrascht, dass sich das modische xz hier auf der gzip- oder zstd-Ebene zeigte. </li><li>  lzip mit Standardeinstellungen ergab ein etwas schlechteres Ergebnis; </li><li>  lz4 und lzop zeigten keine sehr guten Ergebnisse (150Kb); </li><li>  bzip2 zeigte überraschend gute Ergebnisse (18Kb). </li></ul><br><p>  Die Daten sind also sehr gut komprimiert. <br>  Wenn wir also keine schwerwiegenden Fehler finden, sollte es zu einer Komprimierung kommen!  Nur weil mehr Daten auf dasselbe Flash-Laufwerk passen. </p><br><p>  Denken wir über die Mängel nach. </p><br><p>  Das erste Problem: Wir haben uns bereits darauf geeinigt, dass jede Aufnahme sofort aufblitzen soll.  Normalerweise sammelt der Archivierer Daten aus dem Eingabestream, bis er entscheidet, dass es Zeit ist, in die Ausgabe zu schreiben.  Wir müssen sofort einen komprimierten Datenblock abrufen und nichtflüchtig speichern. </p><br><p>  Ich sehe drei Möglichkeiten: </p><br><ol><li>  Komprimieren Sie jeden Eintrag mithilfe der Wörterbuchkomprimierung anstelle der oben beschriebenen Algorithmen. <br>  Es ist eine funktionierende Option, aber ich mag es nicht.  Um eine mehr oder weniger gute Komprimierung zu gewährleisten, sollte das Wörterbuch für bestimmte Daten „geschärft“ werden. Jede Änderung führt dazu, dass die Komprimierungsstufe katastrophal abfällt.  Ja, das Problem wird gelöst, indem eine neue Version des Wörterbuchs erstellt wird. Dies bereitet jedoch Kopfzerbrechen. Wir müssen alle Versionen des Wörterbuchs speichern.  In jedem Eintrag müssen wir angeben, mit welcher Version des Wörterbuchs es komprimiert wurde ... </li><li>  Komprimieren Sie jeden Eintrag mit "klassischen" Algorithmen, jedoch unabhängig von den anderen. <br>  Die betrachteten Komprimierungsalgorithmen sind nicht für die Arbeit mit Datensätzen dieser Größe (zehn Bytes) ausgelegt. Der Komprimierungskoeffizient ist eindeutig kleiner als 1 (dh eine Erhöhung der Datenmenge anstelle der Komprimierung). </li><li>  FLUSH nach jeder Aufnahme. <br>  Viele Komprimierungsbibliotheken unterstützen FLUSH.  Dies ist ein Befehl (oder ein Parameter für die Komprimierungsprozedur), bei dessen Empfang der Archivierer einen komprimierten Stream generiert, sodass auf seiner Basis <strong>alle</strong> unkomprimierten Daten wiederhergestellt werden können, die bereits empfangen wurden.  Solch ein Analogon der <code>sync</code> in Dateisystemen oder Festschreibung in SQL. <br>  Was wichtig ist, nachfolgende Komprimierungsvorgänge können das akkumulierte Wörterbuch verwenden und das Komprimierungsverhältnis wird nicht so stark leiden wie in der vorherigen Version. </li></ol><br><p>  Ich denke, es ist offensichtlich, dass ich die dritte Option gewählt habe. Lassen Sie uns genauer darauf eingehen. </p><br><p>  Es gab einen <a href="https://www.bolet.org/~pornin/deflate-flush.html" rel="nofollow">großartigen Artikel</a> über FLUSH in zlib. </p><br><p>  Ich habe einen motivierten Test basierend auf dem Artikel durchgeführt und 70.000 Tagebucheinträge von einem realen Gerät mit einer Seitengröße von 60 KB entnommen <em>(wir kehren zur Seitengröße zurück)</em> : </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Ausgangsdaten </th><th>  Gzip -9 Komprimierung (ohne FLUSH) </th><th>  zlib mit Z_PARTIAL_FLUSH </th><th>  zlib mit Z_SYNC_FLUSH </th></tr></thead><tbody><tr><td>  <strong>Volumen, Kb</strong> </td><td>  1692 </td><td>  40 </td><td>  352 </td><td>  604 </td></tr></tbody></table></div><br><p>  Auf den ersten Blick ist der von FLUSH eingeführte Preis übermäßig hoch, aber in Wirklichkeit haben wir eine schlechte Wahl - entweder überhaupt nicht zu komprimieren oder mit FLUSH (und sehr effizient) zu komprimieren.  Vergessen Sie nicht, dass wir 70.000 Datensätze haben. Die durch Z_PARTIAL_FLUSH eingeführte Redundanz beträgt nur 4-5 Bytes pro Datensatz.  Und das Kompressionsverhältnis betrug fast 5: 1, was mehr als ein hervorragendes Ergebnis ist. </p><br><div class="spoiler">  <b class="spoiler_title">Es mag unerwartet erscheinen, aber tatsächlich ist Z_SYNC_FLUSH eine effizientere Möglichkeit, FLUSH auszuführen</b> <div class="spoiler_text"><p>  Bei Verwendung von Z_SYNC_FLUSH sind die letzten 4 Bytes jedes Datensatzes immer 0x00, 0x00, 0xff, 0xff.  Und wenn wir sie kennen, können wir sie nicht speichern, sodass die Gesamtgröße nur 324 KB beträgt. </p><br><p>  Der Artikel, auf den ich mich beziehe, hat eine Erklärung: </p><br><blockquote>  Ein neuer Block vom Typ 0 mit leerem Inhalt wird angehängt. <br><br>  Ein Block vom Typ 0 mit leerem Inhalt besteht aus: <br><ul><li>  der Drei-Bit-Block-Header; </li><li>  0 bis 7 Bits gleich Null, um eine Byte-Ausrichtung zu erreichen; </li><li>  die Vier-Byte-Sequenz 00 00 FF FF. </li></ul><br></blockquote><p>  Wie Sie sehen können, kommen im letzten Block vor diesen 4 Bytes 3 bis 10 Nullbits.  Die Praxis hat jedoch gezeigt, dass Null-Bits tatsächlich mindestens 10 sind. </p><br><p>  Es stellt sich heraus, dass solche kurzen Datenblöcke normalerweise (immer?) Mit einem Block vom Typ 1 (fester Block) codiert werden, der notwendigerweise mit 7 Nullbits endet, sodass wir 10-17 garantierte Nullbits erhalten (und der Rest wird mit einer Wahrscheinlichkeit von etwa 50% Null sein). </p><br><p>  Bei Testdaten gibt es in 100% der Fälle vor 0x00, 0x00, 0xff, 0xff ein Null-Byte und mehr als im dritten Fall zwei Null-Bytes <em>(möglicherweise ist dies die Tatsache, dass ich binäres CBOR verwende, und wenn ich Text-CBOR verwende JSON würde mit größerer Wahrscheinlichkeit Blöcke vom Typ 2 erfüllen - dynamische Blöcke bzw. Blöcke würden ohne zusätzliche Null-Bytes vor 0x00, 0x00, 0xff, 0xff auftreten</em> . </p><br><p>  Insgesamt können die verfügbaren Testdaten in weniger als 250 KB komprimierte Daten passen. </p><br><p>  Sie können etwas mehr sparen, indem Sie Bits jonglieren: Jetzt ignorieren wir das Vorhandensein mehrerer Null-Bits am Ende des Blocks, einige Bits am Anfang des Blocks ändern sich auch nicht ... <br>  Aber dann habe ich eine willensstarke Entscheidung getroffen, aufzuhören, sonst können Sie in einem solchen Tempo die Entwicklung Ihres Archivierers erreichen. </p></div></div><br><p>  Insgesamt habe ich 3-4 Bytes pro Datensatz aus meinen Testdaten erhalten, das Kompressionsverhältnis betrug mehr als 6: 1.  Ehrlich gesagt habe ich nicht mit einem solchen Ergebnis gerechnet. Meiner Meinung nach ist alles, was besser als 2: 1 ist, bereits ein Ergebnis, das die Verwendung von Komprimierung rechtfertigt. </p><br><p>  Alles ist in Ordnung, aber zlib (deflate) ist immer noch <del>  archaisch </del>  wohlverdienter und etwas altmodischer Kompressionsalgorithmus.  Die bloße Tatsache, dass die letzten 32 KB aus dem unkomprimierten Datenstrom als Wörterbuch verwendet werden, sieht heute seltsam aus (dh, wenn ein Datenblock dem Datenstrom mit 40 KB sehr ähnlich ist, wird er erneut archiviert, jedoch nicht siehe den letzten Eintrag).  In <del>  modisch </del>  Die Größe eines modernen Archivierungswörterbuchs wird häufig eher in Megabyte als in Kilobyte gemessen. </p><br><p>  Also setzen wir unsere Mini-Studie der Archivare fort. </p><br><p>  Als nächstes wurde bzip2 getestet (erinnere dich, ohne FLUSH zeigte es ein fantastisches Kompressionsverhältnis von fast 100: 1).  Leider zeigte sich bei FLUSH sehr schlecht, dass die Größe der komprimierten Daten größer war als die der unkomprimierten. </p><br><div class="spoiler">  <b class="spoiler_title">Meine Vermutungen über die Gründe für das Scheitern</b> <div class="spoiler_text"><p>  Libbz2 bietet nur eine Flush-Option, die das Wörterbuch zu löschen scheint (ähnlich wie Z_FULL_FLUSH in zlib). Es gibt keinen Grund, von einer effizienten Komprimierung zu sprechen. </p></div></div><br><p>  Und zstd wurde als letztes getestet.  Abhängig von den Parametern wird es entweder auf der Ebene von gzip komprimiert, aber viel schneller, oder gzip ist besser. </p><br><p>  Leider hat er sich mit FLUSH als "nicht sehr" erwiesen: Die Größe der komprimierten Daten betrug etwa 700 KB. </p><br><p>  Ich <a href="https://github.com/facebook/zstd/issues/900" rel="nofollow">habe eine Frage</a> auf der Projektseite in Github gestellt und eine Antwort erhalten, dass es sich lohnt, für jeden Block komprimierter Daten mit bis zu 10 Byte Servicedaten zu rechnen, was nahe an den Ergebnissen liegt. Das Abfangen von deflate funktioniert nicht. </p><br><p>  Ich habe mich dazu entschlossen, in Experimenten mit Archiven damit aufzuhören (ich erinnere Sie daran, dass sich xz, lzip, lzo, lz4 im Teststadium nicht ohne FLUSH zeigten, aber exotischere Kompressionsalgorithmen nicht in Betracht zogen). </p><br><p>  Wir kehren zu den Problemen der Archivierung zurück. </p><br><p>  Das zweite (wie sie sagen, in der Reihenfolge, aber nicht im Wert) Problem - die komprimierten Daten sind ein einzelner Stream, in dem ständig an vorherige Abschnitte gesendet wird.  Wenn also ein Abschnitt der komprimierten Daten beschädigt wird, verlieren wir nicht nur den Block der nicht komprimierten Daten, sondern auch alle nachfolgenden. </p><br><p>  Es gibt einen Lösungsansatz für dieses Problem: </p><br><ol><li>  Verhindern Sie das Auftreten eines Problems - fügen Sie den komprimierten Daten Redundanz hinzu, um Fehler zu identifizieren und zu korrigieren.  wir werden später darüber sprechen; </li><li>  Minimieren Sie die Konsequenzen im Falle eines Problems <br>  Wir haben bereits früher gesagt, dass es möglich ist, jeden Datenblock einzeln zu komprimieren, und dass das Problem von selbst verschwindet (Datenkorruption eines Blocks führt nur zum Verlust von Daten dieses Blocks).  Dies ist jedoch ein extremer Fall, in dem die Datenkomprimierung ineffizient ist.  Das gegenteilige Extrem: Verwenden Sie alle 4 MB unseres Mikrokreislaufs als ein einziges Archiv, wodurch wir eine hervorragende Komprimierung erzielen, aber katastrophale Folgen im Falle einer Datenkorruption haben. <br>  <em>Ja, ein Kompromiss hinsichtlich der Zuverlässigkeit ist erforderlich.</em>  <em>Wir müssen jedoch bedenken, dass wir ein Datenspeicherformat für nichtflüchtigen Speicher mit einer extrem niedrigen BER und einer angegebenen Datenspeicherdauer von 20 Jahren entwickeln.</em> </li></ol><br><p>  Im Verlauf der Experimente stellte ich fest, dass bei komprimierten Datenblöcken mit einer Größe von weniger als 10 KB mehr oder weniger spürbare Verluste im Komprimierungsgrad auftreten. <br>  Es wurde bereits erwähnt, dass der verwendete Speicher eine Seitenorganisation hat. Ich sehe keinen Grund, warum Sie die Korrespondenz "eine Seite - ein Block komprimierter Daten" nicht verwenden sollten. </p><br><p>  Das heißt, die minimale angemessene Seitengröße beträgt 16 KB (mit einer Spanne für Serviceinformationen).  Eine so kleine Seitengröße führt jedoch zu erheblichen Einschränkungen der maximalen Aufzeichnungsgröße. </p><br><p>  Obwohl ich immer noch keine komprimierten Aufzeichnungen von mehr Kilobyte-Einheiten erwarte, habe ich mich für die Verwendung von 32 KB-Seiten (insgesamt 128 Seiten pro Chip) entschieden. </p><br><p>  <strong>Zusammenfassung:</strong> </p><br><ul><li>  Wir speichern Daten, die mit zlib (deflate) komprimiert wurden. </li><li>  Setzen Sie für jeden Datensatz Z_SYNC_FLUSH; </li><li>  Für jeden komprimierten Datensatz werden die letzten Bytes <em>abgeschnitten (z. B. 0x00, 0x00, 0xff, 0xff)</em> .  Geben Sie im Header an, wie viele Bytes wir schneiden. </li><li>  Wir speichern Daten auf 32-KB-Seiten.  Innerhalb der Seite befindet sich ein einzelner Strom komprimierter Daten.  Auf jeder Seite wird die Komprimierung erneut gestartet. </li></ul><br><p>  Und bevor ich mit der Komprimierung fertig bin, möchte ich darauf hinweisen, dass wir nur wenige Bytes an Schreibdaten erhalten. Daher ist es äußerst wichtig, die Serviceinformationen nicht zu vergrößern, da jedes Byte gezählt wird. </p><br><h3 id="hranenie-zagolovkov-dannyh">  Speichern von Datenköpfen </h3><br><p>  Da wir Datensätze mit variabler Länge haben, müssen wir irgendwie den Ort / die Grenzen der Datensätze bestimmen. </p><br><p>  Ich kenne drei Ansätze: </p><br><ol><li>  Alle Datensätze werden in einem fortlaufenden Stream gespeichert. Zuerst wird der Datensatzkopf mit der Länge und dann der Datensatz selbst angezeigt. <br>  In dieser Ausführungsform können sowohl die Header als auch die Daten eine variable Länge haben. <br>  Tatsächlich erhalten wir eine einfach verknüpfte Liste, die ständig verwendet wird. </li><li>  Header und Datensätze selbst werden in separaten Streams gespeichert. <br>  Mit Headern konstanter Länge stellen wir sicher, dass Schäden an einem Header den Rest nicht beeinträchtigen. <br>  Ein ähnlicher Ansatz wird beispielsweise in vielen Dateisystemen verwendet. </li><li>  Datensätze werden in einem kontinuierlichen Datenstrom gespeichert, die Grenze des Datensatzes wird durch einen Marker (Symbol / Zeichenfolge, die in Datenblöcken verboten ist / ist) festgelegt.  Wenn ein Marker im Datensatz gefunden wird, ersetzen wir ihn durch eine bestimmte Sequenz (Escape-Zeichen). <br>  Ein ähnlicher Ansatz wird beispielsweise im PPP-Protokoll verwendet. </li></ol><br><p>  Ich werde es veranschaulichen. </p><br><p>  Variante 1: <br><img src="https://habrastorage.org/webt/b3/yu/q8/b3yuq8z6elbufkrice2g_vjtuhe.png" alt="Variante 1"><br>  Hier ist alles ganz einfach: Wenn wir die Länge des Datensatzes kennen, können wir die Adresse des nächsten Headers berechnen.  Also bewegen wir uns durch die Header, bis wir auf eine Region treffen, die mit 0xff (freie Region) oder dem Ende der Seite gefüllt ist. </p><br><p>  Option 2: <br><img src="https://habrastorage.org/webt/kf/qy/_7/kfqy_7qzi7pzmk-g5cqa4r6s75q.png" alt="Option 2"><br>  Aufgrund der variablen Länge des Datensatzes können wir nicht im Voraus sagen, wie viele Datensätze (und damit die Überschriften) pro Seite wir benötigen.  Sie können die Überschriften und die Daten selbst auf verschiedene Seiten verteilen, aber ich bevorzuge einen anderen Ansatz: Wir platzieren die Überschriften und die Daten auf derselben Seite, die Überschriften (mit konstanter Größe) befinden sich jedoch am Anfang der Seite und die Daten (mit variabler Länge) am Ende.  Sobald sie sich "treffen" (es ist nicht genügend Speicherplatz für einen neuen Datensatz vorhanden) - betrachten wir diese Seite als voll. </p><br><p>  Option 3: <br><img src="https://habrastorage.org/webt/-q/u1/qj/-qu1qjmqlcvfi570ovsdy_nzzny.png" alt="Option 3"><br>  Es ist nicht erforderlich, die Länge oder andere Informationen über den Speicherort der Daten im Header zu speichern. Es gibt genügend Markierungen, die die Grenzen der Datensätze angeben.  Die Daten müssen jedoch während des Schreibens / Lesens verarbeitet werden. <br>  Als Markierung würde ich 0xff verwenden (welches die Seite nach dem Löschen füllt), so dass der freie Bereich definitiv nicht als Daten behandelt wird. </p><br><p>  Vergleichstabelle: </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Variante 1 </th><th>  Option 2 </th><th>  Option 3 </th></tr></thead><tbody><tr><td>  <strong>Fehlertoleranz</strong> </td><td>  - </td><td>  + </td><td>  + </td></tr><tr><td>  <strong>Kompaktheit</strong> </td><td>  + </td><td>  - </td><td>  + </td></tr><tr><td>  <strong>Komplexität der Implementierung</strong> </td><td>  * </td><td>  ** </td><td>  ** </td></tr></tbody></table></div><br><p>  Option 1 hat einen schwerwiegenden Fehler: Wenn einer der Header beschädigt ist, wird unsere gesamte nachfolgende Kette zerstört.  Mit anderen Optionen können Sie einen Teil der Daten auch bei massivem Schaden wiederherstellen. <br>  Wir möchten jedoch daran erinnern, dass wir uns entschlossen haben, die Daten in komprimierter Form zu speichern, und daher alle Daten auf der Seite nach dem "kaputten" Datensatz verlieren, sodass wir dies nicht berücksichtigen, obwohl die Tabelle negativ ist. </p><br><p>  Kompaktheit: </p><br><ul><li>  In der ersten Version müssen wir nur die Länge im Header speichern. Wenn Ganzzahlen mit variabler Länge verwendet werden, können wir in den meisten Fällen mit einem Byte arbeiten. </li><li>  In der zweiten Option müssen wir die Startadresse und die Startlänge speichern.  Der Datensatz sollte eine konstante Größe haben. Ich schätze 4 Bytes pro Datensatz (zwei Bytes pro Versatz und zwei Bytes pro Länge). </li><li>  Bei der dritten Option ist nur ein Zeichen ausreichend, um den Beginn der Aufzeichnung anzuzeigen, und die Aufzeichnung selbst wächst aufgrund der Überprüfung um 1 bis 2%.  Im Allgemeinen ungefähre Parität mit der ersten Option. </li></ul><br><p>        (   ).      ,     . </p><br><p> <em>, -  -    . ,        ,      —     ,  , ...</em> </p><br><p>     :          ,      ,      .. , , ,      —     ,   . </p><br><p> <strong>:</strong>       "   —   " -    . </p><br><h3 id="ispolzovanie-bitovyh-poley-dlya-kontrolya-uspeshnosti-operaciy-zapisi">         </h3><br><p>    ,    ,     : <br>         . <br> <em>   ,  erase    1,     1  0,   .</em>    "  "  1,  " " — 0. </p><br><p>          flash: </p><br><ol><li>   “  ”; </li><li>  ; </li><li>   “  ”; </li><li>  ; </li><li>   “ ”. </li></ol><br><p>  ,     “ ”,  4  . </p><br><p>          “1111” —     “1000” —   ;         ,        . </p><br><p>  ,           , , , ,      (   )   . </p><br><p> <strong>:</strong>      . </p><br><h3 id="kontrolnye-summy">   </h3><br><p>       (  )     ,     . ,       ,   . </p><br><p>      ,     ,           <em>( , ,   —       )</em> . </p><br><p>  ,    ,   ,   —  . </p><br><p>         — CRC.   ,     100%    ,   —               <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mi>n</mi></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.659ex" height="2.298ex" viewBox="0 -883.9 1575.6 989.6" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mo>−</mo><mi>n</mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1">2^{-n}</script>  .      ,      ,       :       ,      .  —      . </p><br><p>   : <a href="http://amsoftware.narod.ru/algo.html" rel="nofollow"> 1</a> , <a href="http://amsoftware.narod.ru/algo2.html" rel="nofollow"> 2</a> <em>(  narod.ru, )</em> . </p><br><p>       , CRC —     .    ,    . </p><br><p>        ,     . </p><br><p> : <br>         <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>10</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mn>3</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.658ex" height="2.419ex" viewBox="0 -935.7 2005.4 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-30" x="500" y="0"></use><g transform="translate(1001,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-33" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mrow class="MJX-TeXAtom-ORD"><mo>−</mo><mn>3</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2">10^{-3}</script>    ,       : </p><br><div class="scrollable-table"><table><thead><tr><th> ,  </th><th>  ,  </th><th>   </th><th>    </th><th>    </th></tr></thead><tbody><tr><td>  1 </td><td>  0 </td><td> 1000 </td><td>  0 </td><td> 1000 </td></tr><tr><td>  1 </td><td>  1 </td><td>  4 </td><td>  999 </td><td>  1003 </td></tr><tr><td>  1 </td><td>  2 </td><td> ≈0 </td><td>  1997 </td><td>  1997 </td></tr><tr><td>  1 </td><td>  4 </td><td> ≈0 </td><td> 3990 </td><td> 3990 </td></tr><tr><td>  10 </td><td>  0 </td><td>  9955 </td><td>  0 </td><td>  9955 </td></tr><tr><td>  10 </td><td>  1 </td><td>  39 </td><td>  990 </td><td>  1029 </td></tr><tr><td>  10 </td><td>  2 </td><td> ≈0 </td><td>  1979 </td><td>  1979 </td></tr><tr><td>  10 </td><td>  4 </td><td> ≈0 </td><td> 3954 </td><td> 3954 </td></tr><tr><td> 1000 </td><td>  0 </td><td> 632305 </td><td>  0 </td><td> 632305 </td></tr><tr><td> 1000 </td><td>  1 </td><td> 2470 </td><td> 368 </td><td>  2838 </td></tr><tr><td> 1000 </td><td>  2 </td><td>  10 </td><td>  735 </td><td>  745 </td></tr><tr><td> 1000 </td><td>  4 </td><td> ≈0 </td><td>  1469 </td><td>  1469 </td></tr></tbody></table></div><br><p>  ,   —               —    . </p><br><p> ,      : ,       ,           .     ,  <a href="https://habr.com/ru/post/428746/">   </a> . </p><br><p> ,        ,      32    <em>(   64     -)</em> . </p><br><p>   ,    ,      , -   32-   (16  ,    0.01%;  24 ,  ,     ). </p><br><p>    :          ,    4  ?           ?  ,   <em> </em> ,      . </p><br><p>       ,     CRC-32C. <br>    6      22  (,     c), 4      655  (    ), 2           . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p> <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" rel="nofollow"> </a>  CRC. </p><br><p> <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0x8f6e37a0_len.txt" rel="nofollow">  crc-32c</a>  <a href="http://users.ece.cmu.edu/~koopman/crc/notes.html" rel="nofollow"> </a> — ,    CRC  . </p><br><p>  <a href="http://users.ece.cmu.edu/~koopman/networks/dsn02/dsn02_koopman.pdf" rel="nofollow"> </a>  <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0xfa567d89_len.txt" rel="nofollow">   </a> ,          ,      ,    ,         . </p></div></div><br><p> ,      ,  :       ? </p><br><p>  ""     : </p><br><ul><li>          —       (         /, ,     ..); </li><li>  deflate  zlib      <em> </em>   ""  ,  ,         ,      (        , zlib      ). </li></ul><br><p>  ""     : </p><br><ul><li> CRC ""     ,    - (          ,  ,  ,   "" ); </li><li>          , <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-72/product_id-1820/GNU-Zlib.html" rel="nofollow">  </a> ,   . </li></ul><br><p>              . </p><br><p> <strong>:</strong>  CRC-32C,        ,      flash ( ). </p><br><h3 id="izbytochnost">  </h3><br><p>     , ,   , ,    (   )     . </p><br><p>        ,   . <br>       ,  - ,           RAID-6         . <br>         ,   ,           ,     . </p><br><p>   ,       .        ? </p><br><ol><li>   ( -      ,  Raspberry, ...) <br> ,             ; </li><li>   ( -   flash-   ,  ) <br>      ,         ; </li><li>       ; </li><li>   <br>            . </li></ol><br><p>       (    )       . ,   -  . </p><br><p> <strong>:</strong>      , ,      ,      (     ,      ). </p><br><h3 id="prochee">  Andere </h3><br><p> ,          <em>(      )</em> ,      ,   . </p><br><ul><li>     "" <br>     -    ,    ..,    ,      . <br>     ,    ,    ; </li><li>     . <br>       — ! <br>         Magic Number (),        <em>( ,       )</em> ; </li><li>    (  )   ,         1 ; </li><li>               . </li></ul><br><p>   <a href="https://planetcalc.com/2481/" rel="nofollow">-</a>  .          . </p><br><h1 id="anchorformatanchoropisanie-formata-hraneniya-dannyh"><a name="format"></a>     </h1><br><h2 id="byte-order"> Byte order </h2><br><p> ,    ,   big-endian  (network byte order),   0x1234   0x12, 0x34. </p><br><h2 id="delenie-na-stranicy">    </h2><br><p>  -     . </p><br><p>     32,   ,  1/4      (   4  128 ). </p><br><p>        (          ). </p><br><p>       (   ),    0 (     0,  —  32,  —  64  ..) </p><br><p>       (ring buffer),          0,    1, ...,     ,          . </p><br><h2 id="vnutri-stranicy">   </h2><br><p><img src="https://habrastorage.org/webt/7r/sr/fa/7rsrfafqrc263dsu8zd5ptceqga.png" alt="Seite"><br>     4-  ,     (CRC-32C),      ", ,  ". </p><br><p>   (  -)  : </p><br><ul><li>   Magic Number (  —   ) <br>        <code>0xed00 ⊕  </code> ; </li><li>   " " (   ). </li></ul><br><p>        (  deflate).          (  ),       .              (   ). </p><br><p>      Z_SYNC_FLUSH,        4  0x00, 0x00, 0xff, 0xff, , ,      . <br>   ( 4, 5  6 )      -. </p><br><p>      1, 2  3 , : </p><br><ul><li>   (T),   : 0 — , 1 — ; </li><li>    (S)  1  7 ,     "",       ; </li><li>   (L). </li></ul><br><p>   S: </p><br><div class="scrollable-table"><table><thead><tr><th>  S </th><th>  ,  </th><th>   ,  </th></tr></thead><tbody><tr><td> <code>0</code> </td> <td>  1 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>10</code> </td> <td>  1 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>110</code> </td> <td>  2 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1110</code> </td> <td>  2 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>11110</code> </td> <td>  2 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111100</code> </td> <td>  3 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1111101</code> </td> <td>  3 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111110</code> </td> <td>  3 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr></tbody></table></div><br><p>  ,  ,   : <br><img src="https://habrastorage.org/webt/iu/fu/bp/iufubpdgxnpv9czd45tomt-0vtc.png" alt="  "><br>     T,  —  S,  L (    ),  —  ,  —    ,     -. </p><br><p>  ,      ( 63+5    )     . </p><br><p>       CRC-32C,       (init)      . </p><br><p> <em>CRC   "",  (-    )  :</em> <math> </math><em><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="43.505ex" height="2.66ex" viewBox="0 -832 18731.1 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="760" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="1520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="2280" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="2670" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="3015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="3616" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-74" x="3961" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="4323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-41" x="4768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-7C" x="5518" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-7C" x="5797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-42" x="6075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="6835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-3D" x="7502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="8558" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="9319" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="10078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="10839" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="11228" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="11989" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="12748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="13509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="13898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="14244" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="14844" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-74" x="15190" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="15551" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-41" x="15996" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="16747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="17136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-42" x="17582" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="18341" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy="false">)</mo><mo>,</mo><mi>B</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3">CRC(init, A || B) = CRC(CRC(init, A), B)</script></em>   <em>.</em> <em><br>      CRC         .</em> </p><br><p>        . </p><br><p>    ,         0x00  0xff (       0xff,      ; 0x00    ). </p><br><h2 id="primernye-algoritmy">   </h2><br><h3 id="chtenie-iz-flesh-pamyati">   - </h3><br><p>       . <br>      —       -  . </p><br><p> <em>(  , Linux     NOR Flash, )</em> </p><br><h3 id="zapis-v-flesh-pamyat">   - </h3><br><p>  . <br>  . </p><br><p>        —       . </p><br><h3 id="podgotovka-novoy-mikroshemy-k-rabote">      </h3><br><p>     ( )      1. <br>         ( UUID    ). </p><br><p> , -   . </p><br><h3 id="zagruzka-avtomata">   </h3><br><p>     8    ( + CRC),    Magic Number   CRC . <br>  ""      ,    ,   . <br>   ,   CRC,   "".    —    .   —   ,    "" . <br>      , ,    "" . <br>   zlib (      ). </p><br><p> ,  ,  ,  . </p><br><h3 id="dobavlenie-zapisi-v-zhurnal">     </h3><br><p>     ,  Z_SYNC_FLUSH.,       . <br>    (     CRC) —    (. ). <br>    CRC.    —   . </p><br><h3 id="novaya-stranica">   </h3><br><p>       (              ).     —       ,     . <br>    erase.    0xff.  -   —    ,  .. <br>     ,     ,  —    (  ). </p><br><h1 id="primenimost-formata">   </h1><br><p>   ,       -    ( , JSON, MessagePack, CBOR, , protobuf)  NOR Flash. </p><br><p> ,  ""  SLC NOR Flash. </p><br><p>         BER,  NAND  MLC NOR <em>(      ?        )</em> . </p><br><p>  ,      ,   FTL: USB flash, SD, MicroSD, etc <em>(          512 ,          —   ""        )</em> . </p><br><p>             128 (16)  1 (128).         , , ,     <em>(      ,   NOR Flash    )</em> . </p><br><p>  -   ,         — ,   ,      github. </p><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  ,      <em>  </em> . </p><br><p>        ,  :     - , ,         . ,  () -         . </p><br><p>    ,   ? , .   , ,      .   -        . </p><br><p>        ?  ,       ,   .    . </p><br><p>    ,       ,   " ". </p><br><p>        ,       <em>()</em>   , ,    ""  (, ,     ;      ).        <em>(    —   )</em> . </p><br><p>          ,      . </p><br><h1 id="literatura">  Literatur </h1><br><p>        ,       . </p><br><p>      ,     ,        ,      : </p><br><ol><li>  <a href="https://github.com/madler/infgen/" rel="nofollow">infgen</a>   zlib.        deflate/zlib/gzip.         deflate ( gzip) —  . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de479044/">https://habr.com/ru/post/de479044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de479034/index.html">Herstellen einer Verbindung zu einem Unternehmens-VPN unter Linux mithilfe von openconnect und vpn-slice</a></li>
<li><a href="../de479036/index.html">Intel kann die Nachfrage nach Prozessoren nicht befriedigen. HP und Dell leiden darunter</a></li>
<li><a href="../de479038/index.html">Digitale Transformation Leroy Merlin: Entwerfen einer Schnittstelle für die Arbeit mit Kundenanrufen</a></li>
<li><a href="../de479040/index.html">Visuelle Regressionstests. Starten Sie neu</a></li>
<li><a href="../de479042/index.html">Mit der Y-Methode können Sie ganz einfach einen Rubik's Cube erstellen</a></li>
<li><a href="../de479048/index.html">Node.js Streams für Dummies oder wie man mit Streams arbeitet</a></li>
<li><a href="../de479050/index.html">Patentrecherche in der IT. Der Kurs des jungen Kämpfers. Teil II Informationsquellen für die Patentrecherche</a></li>
<li><a href="../de479052/index.html">[Supercomputing 2019]. Multi-Cloud-Speicher als Anwendung für neue Kingston DC1000M-Laufwerke</a></li>
<li><a href="../de479054/index.html">Mobile Umfrage am Freitag</a></li>
<li><a href="../de479056/index.html">Über das Leben reden? DREAM Team bei der Alexa Prize Socialbot Challenge 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>