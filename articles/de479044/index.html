<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèæ üõåüèø ü§ûüèª Meine Ringpuffer-Implementierung in NOR-Flash üßëüèæ‚Äçü§ù‚Äçüßëüèº üë≥üèø ‚öúÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hintergrund 


 Es gibt Automaten nach eigenem Design. Im Raspberry Pi und ein bisschen Umreifen auf einem separaten Brett. Ein M√ºnzpr√ºfer, ein Geldsc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Meine Ringpuffer-Implementierung in NOR-Flash</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479044/"><h1 id="predystoriya">  Hintergrund </h1><br><p>  Es gibt Automaten nach eigenem Design.  Im Raspberry Pi und ein bisschen Umreifen auf einem separaten Brett.  Ein M√ºnzpr√ºfer, ein Geldscheinpr√ºfer, ein Bankautomat sind angeschlossen ... Ein selbst geschriebenes Programm verwaltet alles.  Die gesamte Geschichte der Arbeit wird auf einem Flash-Laufwerk (MicroSD) in das Journal geschrieben, das dann √ºber das Internet (unter Verwendung eines USB-Modems) an den Server √ºbertragen und dort der Datenbank hinzugef√ºgt wird.  Verkaufsinformationen werden in 1s geladen, es gibt auch ein einfaches Webinterface zum √úberwachen usw. </p><br><p>  Das hei√üt, das Magazin ist von entscheidender Bedeutung - f√ºr die Buchhaltung (dort Einnahmen, Verk√§ufe usw.), die √úberwachung (alle Arten von Fehlern und andere Umst√§nde h√∂herer Gewalt);  das k√∂nnen Sie sagen, alle Informationen, die wir √ºber diese Maschine haben. </p><br><h1 id="problema">  Das problem </h1><br><p>  Flash-Laufwerke zeigen sich als sehr unzuverl√§ssige Ger√§te.  Sie scheitern mit beneidenswerter Regelm√§√üigkeit.  Dies f√ºhrt sowohl zu Maschinenausf√§llen als auch (falls das Journal aus irgendeinem Grund nicht online √ºbertragen werden konnte) zu Datenverlust. </p><br><p>  <em>Dies ist nicht die erste Erfahrung mit der Verwendung von Flash-Laufwerken, bevor es ein weiteres Projekt mit mehr als hundert Ger√§ten gab, in denen das Magazin auf USB-Flash-Laufwerken gespeichert war, gab es auch Probleme mit der Zuverl√§ssigkeit, wenn die Anzahl der Ausf√§lle pro Monat bei zehn lag.</em>  <em>Wir haben verschiedene Flash-Laufwerke ausprobiert, darunter auch Marken-Laufwerke mit SLC-Speicher. Einige Modelle sind zuverl√§ssiger als andere, aber das Ersetzen von Flash-Laufwerken hat das Problem nicht radikal gel√∂st.</em> </p><a name="habracut"></a><br><p>  <strong>Achtung!</strong>  Longrid!  Wenn Sie sich nicht f√ºr das Warum interessieren, sondern nur f√ºr das Wie, k√∂nnen Sie sofort <a href="https://habr.com/ru/post/479044/">zum Ende des</a> Artikels gehen. </p><br><h1 id="reshenie">  L√∂sung </h1><br><p>  Das erste, was mir in den Sinn kommt: MicroSD verlassen, zum Beispiel SSD einsetzen und davon booten.  Theoretisch ist dies wahrscheinlich m√∂glich, aber relativ teuer und nicht so zuverl√§ssig (ein USB-SATA-Adapter wird hinzugef√ºgt; bei Budget-SSDs ist die Ausfallstatistik ebenfalls nicht gut). </p><br><p>  USB HDD sieht auch nicht besonders attraktiv aus. </p><br><p>  Aus diesem Grund haben wir diese Option gew√§hlt: Verlassen Sie den Download von MicroSD, verwenden Sie sie jedoch im schreibgesch√ºtzten Modus, und speichern Sie das Betriebsprotokoll (und andere Informationen, die nur f√ºr eine bestimmte Hardwarekomponente gelten - Seriennummer, Sensorkalibrierungen usw.) an einer anderen Stelle. </p><br><p>  Das Thema Nur-Lese-FS f√ºr Himbeeren wurde bereits eingehend untersucht. Ich werde nicht auf die Implementierungsdetails in diesem Artikel eingehen <em>(aber wenn Interesse besteht, schreibe ich m√∂glicherweise einen Mini-Artikel zu diesem Thema)</em> .  Der einzige Punkt, den ich erw√§hnen m√∂chte: sowohl aus pers√∂nlicher Erfahrung als auch aus Bewertungen, die bereits einen Gewinn an Zuverl√§ssigkeit erzielt haben, ist.  Ja, es ist unm√∂glich, Ausf√§lle vollst√§ndig zu beseitigen, aber es ist durchaus m√∂glich, deren H√§ufigkeit erheblich zu verringern.  Ja, und die Karten werden vereinheitlicht, was den Austausch f√ºr das Wartungspersonal erheblich vereinfacht. </p><br><h2 id="apparatnaya-chast">  Hardware </h2><br><p>  Es gab keinen Zweifel an der Wahl des Speichertyps - NOR Flash. <br>  Argumente: </p><br><ul><li>  einfache Verbindung (am h√§ufigsten der SPI-Bus, dessen Erfahrung bereits vorhanden ist, sodass keine "Eisen" -Probleme zu erwarten sind); </li><li>  l√§cherlicher Preis; </li><li>  Standard-Betriebsprotokoll (die Implementierung ist bereits im Linux-Kernel, wenn Sie m√∂chten, k√∂nnen Sie einen Dritten mitnehmen, der ebenfalls vorhanden ist, oder sogar Ihren eigenen schreiben, der Vorteil ist einfach); </li><li>  Zuverl√§ssigkeit und Ressource: <br>  aus einem typischen Datenblatt: Daten werden 20 Jahre lang gespeichert, 100.000 L√∂schzyklen f√ºr jeden Block; <br>  aus Quellen von Drittanbietern: Extrem niedrige BER, es wird postuliert, dass keine Fehlerkorrekturcodes erforderlich sind <em>(in einigen Ver√∂ffentlichungen wird ECC f√ºr NOR ber√ºcksichtigt, aber normalerweise ist MLC NOR dort gemeint, es passiert)</em> . </li></ul><br><p>  Lassen Sie uns den Bedarf an Volumen und Ressourcen absch√§tzen. </p><br><p>  Ich m√∂chte die Garantie haben, Daten f√ºr mehrere Tage zu speichern.  Dies ist notwendig, damit bei Problemen mit der Verbindung die Verkaufshistorie nicht verloren geht.  Wir konzentrieren uns auf 5 Tage, in diesem Zeitraum <em>(auch unter Ber√ºcksichtigung von Wochenenden und Feiertagen) k√∂nnen</em> wir das Problem l√∂sen. </p><br><p>  Wir tippen derzeit ungef√§hr 100 KB Zeitschriften pro Tag (3-4.000 Datens√§tze), aber allm√§hlich nimmt diese Zahl zu - die Detaillierung nimmt zu, neue Ereignisse werden hinzugef√ºgt.  Au√üerdem kommt es manchmal zu Bursts (einige Sensoren senden beispielsweise Spam-Mails mit False-Positives).  Wir werden zehntausend Datens√§tze von 100 Bytes - Megabytes pro Tag berechnen. </p><br><p>  Es werden insgesamt 5 MB saubere (gut komprimierbare) Daten ausgegeben.  Sie auch <em>(grobe Sch√§tzung) 1</em> MB Service-Daten. </p><br><p>  Das hei√üt, wir ben√∂tigen einen 8-MB-Mikrochip, wenn Sie keine Komprimierung verwenden, oder 4 MB, wenn Sie ihn verwenden.  Ganz reelle Zahlen f√ºr diesen Speichertyp. </p><br><p>  Was die Ressource betrifft: Wenn wir vorhaben, dass der gesamte Speicher nicht mehr als einmal alle 5 Tage neu geschrieben wird, erhalten wir in 10 Dienstjahren weniger als tausend √úberschreibzyklen. <br>  Ich erinnere mich, der Hersteller verspricht hunderttausend. </p><br><div class="spoiler">  <b class="spoiler_title">Ein bisschen √ºber NOR vs NAND</b> <div class="spoiler_text"><p>  Heute ist der NAND-Speicher nat√ºrlich viel beliebter, aber f√ºr dieses Projekt w√ºrde ich ihn nicht verwenden: NAND erfordert im Gegensatz zu NOR unbedingt die Verwendung von Fehlerkorrekturcodes, eine Tabelle mit fehlerhaften Bl√∂cken usw. und die Beine von NAND-Chips normalerweise viel mehr. </p><br><p>  Die Nachteile von NOR sind: </p><br><ul><li>  kleines Volumen (und dementsprechend hoher Preis pro Megabyte); </li><li>  niedriger Wechselkurs (haupts√§chlich aufgrund der Tatsache, dass eine serielle Schnittstelle verwendet wird, normalerweise SPI oder I2C); </li><li>  langsames L√∂schen (je nach Gr√∂√üe des Blocks dauert es Bruchteile von einer Sekunde bis zu mehreren Sekunden). </li></ul><br><p>  Es scheint nichts kritisches f√ºr uns zu sein, also mach weiter. </p></div></div><br><p>  Wenn die Details interessant sind, wurde der <a href="https://www.adestotech.com/wp-content/uploads/doc3686.pdf" rel="nofollow">at25df321a-</a> Chip ausgew√§hlt <em>(dies ist jedoch unerheblich, es gibt viele Analoga auf dem Markt, die mit der Steckerbelegung und dem Befehlssystem kompatibel sind; selbst wenn wir den Chip von einem anderen Hersteller und / oder einer anderen Lautst√§rke verwenden m√∂chten, funktioniert alles, ohne den Code zu √§ndern)</em> . </p><br><p>  Ich verwende den im Linux-Kernel integrierten Treiber unter Raspberry. Dank der Unterst√ºtzung f√ºr Ger√§tebaum-Overlays ist alles sehr einfach. Sie m√ºssen das kompilierte Overlay in / boot / oversays einf√ºgen und /boot/config.txt ein wenig √§ndern. </p><br><div class="spoiler">  <b class="spoiler_title">Beispiel dts Datei</b> <div class="spoiler_text"><p>  Ehrlich gesagt bin ich mir nicht sicher, was fehlerfrei geschrieben wurde, aber es funktioniert. </p><br><pre><code class="plaintext hljs">/* * Device tree overlay for at25 at spi0.1 */ /dts-v1/; /plugin/; / { compatible = "brcm,bcm2835", "brcm,bcm2836", "brcm,bcm2708", "brcm,bcm2709"; /* disable spi-dev for spi0.1 */ fragment@0 { target = &lt;&amp;spi0&gt;; __overlay__ { status = "okay"; spidev@1{ status = "disabled"; }; }; }; /* the spi config of the at25 */ fragment@1 { target = &lt;&amp;spi0&gt;; __overlay__ { #address-cells = &lt;1&gt;; #size-cells = &lt;0&gt;; flash: m25p80@1 { compatible = "atmel,at25df321a"; reg = &lt;1&gt;; spi-max-frequency = &lt;50000000&gt;; /* default to false: m25p,fast-read ; */ }; }; }; __overrides__ { spimaxfrequency = &lt;&amp;flash&gt;,"spi-max-frequency:0"; fastread = &lt;&amp;flash&gt;,"m25p,fast-read?"; }; };</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Und noch eine Zeile in config.txt</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dtoverlay=at25:spimaxfrequency=50000000</code> </pre> </div></div><br><p>  Ich werde die Beschreibung des Verbindens des Chips mit dem Himbeer-Pi weglassen.  Einerseits bin ich kein Experte f√ºr Elektronik, andererseits ist auch f√ºr mich alles trivial: Die Mikroschaltung hat nur 8 Beine, von denen wir Masse, Leistung, SPI (CS, SI, SO, SCK) ben√∂tigen;  Stufen stimmen mit denen von Raspberry Pi √ºberein, es ist keine zus√§tzliche Bindung erforderlich - schlie√üen Sie einfach die angegebenen 6 Kontakte an. </p><br><h2 id="postanovka-zadachi">  Erkl√§rung des Problems </h2><br><p>  Wie √ºblich durchl√§uft die Formulierung des Problems mehrere Iterationen, es scheint mir, dass die Zeit f√ºr die n√§chste gekommen ist.  Also h√∂ren wir auf, fassen zusammen, was bereits geschrieben wurde, und kl√§ren die im Schatten verbleibenden Details. </p><br><p>  Daher haben wir beschlossen, dass das Protokoll in SPI NOR Flash gespeichert wird. </p><br><div class="spoiler">  <b class="spoiler_title">Was ist NOR Flash f√ºr diejenigen, die es nicht wissen</b> <div class="spoiler_text"><p>  Dies ist ein nichtfl√ºchtiger Speicher, mit dem Sie drei Vorg√§nge ausf√ºhren k√∂nnen: </p><br><ol><li>  Lesen: <br>  Am h√§ufigsten wird gelesen: Wir √ºbergeben die Adresse und lesen so viele Bytes, wie wir ben√∂tigen. </li><li>  Rekord: <br>  Das Schreiben in NOR-Flash sieht wie ein gew√∂hnliches aus, hat jedoch eine Besonderheit: Sie k√∂nnen nur 1 in 0 √§ndern, nicht jedoch umgekehrt.  Wenn sich beispielsweise 0x55 in der Speicherzelle befindet, wird 0x05 nach dem Schreiben von 0x0f bereits dort gespeichert <em>(siehe nachstehende Tabelle)</em> . </li><li>  L√∂schen: <br>  Nat√ºrlich m√ºssen wir auch in der Lage sein, den umgekehrten Vorgang auszuf√ºhren - √§ndern Sie 0 zu 1, weshalb der L√∂schvorgang vorhanden ist.  Im Gegensatz zu den ersten beiden arbeitet es nicht in Bytes, sondern in Bl√∂cken (der minimale L√∂schblock in der ausgew√§hlten Mikroschaltung betr√§gt 4 kb).  L√∂schen zerst√∂rt den gesamten Block und dies ist die einzige M√∂glichkeit, 0 in 1 zu √§ndern. Wenn Sie mit Flash-Speichern arbeiten, m√ºssen Sie daher h√§ufig Datenstrukturen am Rand des L√∂schblocks ausrichten. <br>  In NOR Flash aufnehmen: </li></ol><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Bin√§re Daten </th></tr></thead><tbody><tr><td>  <strong>War</strong> </td><td> <code>01010101</code> </td> </tr><tr><td>  <strong>Aufgenommen</strong> </td><td> <code>00001111</code> </td> </tr><tr><td>  <strong>Ist geworden</strong> </td><td> <code>00000101</code> </td> </tr></tbody></table></div></div></div><br><p>  Das Journal selbst repr√§sentiert eine Folge von Datens√§tzen variabler L√§nge.  Eine typische Aufzeichnungsl√§nge betr√§gt ungef√§hr 30 Bytes (obwohl manchmal Aufzeichnungen mit einer L√§nge von mehreren Kilobytes vorkommen).  <em>In diesem Fall arbeiten wir mit ihnen wie mit einer Reihe von Bytes. Wenn Sie jedoch interessiert sind, wird CBOR in den Datens√§tzen verwendet.</em> </p><br><p>  Zus√§tzlich zum Journal m√ºssen einige aktualisierte ‚ÄûTuning‚Äú -Informationen gespeichert werden: eine bestimmte Ger√§te-ID, Sensorkalibrierung, das Flag ‚ÄûGer√§t ist vor√ºbergehend deaktiviert‚Äú usw. <br>  Bei diesen Informationen handelt es sich um eine Reihe von Schl√ºsselwertdatens√§tzen, die ebenfalls in CBOR gespeichert sind. Wir haben nicht viel von diesen Informationen (maximal einige Kilobyte), sie werden nur selten aktualisiert. <br>  In Zukunft werden wir es Kontext nennen. </p><br><p>  Wenn Sie sich erinnern, wo dieser Artikel begonnen hat, ist es sehr wichtig, die Zuverl√§ssigkeit der Datenspeicherung und, wenn m√∂glich, den Dauerbetrieb auch bei Hardwareausf√§llen / Datenkorruption sicherzustellen. </p><br><p>  Welche Problemquellen k√∂nnen ber√ºcksichtigt werden? </p><br><ul><li>  W√§hrend Schreib- / L√∂schvorg√§ngen ausschalten.  Dies ist aus der Kategorie "gegen Schrott kein Empfang". <br>  Informationen aus der <a href="https://electronics.stackexchange.com/questions/225956/what-would-happen-in-case-of-power-outage-during-nor-flash-erase-or-programming" rel="nofollow">Diskussion</a> zum Stack-Austausch: Wenn die Stromversorgung ausgeschaltet wird, w√§hrend mit Flash gearbeitet wird, f√ºhrt das L√∂schen (Einstellung auf 1) und Schreiben (Einstellung auf 0) zu undefiniertem Verhalten: Daten k√∂nnen geschrieben, teilweise geschrieben werden (dh wir haben 10 Byte / 80 Bit √ºbertragen) , und nur 45 Bits k√∂nnen aufgezeichnet werden), ist es auch m√∂glich, dass sich einige der Bits im "Zwischen" -Zustand befinden (Lesen kann entweder 0 oder 1 ergeben); </li><li>  Fehler im Flash-Speicher selbst. <br>  BER ist zwar sehr niedrig, kann aber nicht gleich Null sein. </li><li>  Busfehler <br>  Die √ºber SPI √ºbertragenen Daten sind in keiner Weise gesch√ºtzt, es kann durchaus zu Einzelbitfehlern oder Synchronisationsfehlern kommen - Verlust oder Einf√ºgung von Bits (was zu massiven Datenverzerrungen f√ºhrt); </li><li>  Sonstige Fehler / Ausf√§lle <br>  Fehler im Code, Himbeer "Pannen", Alien Intervention ... </li></ul><br><p>  Ich habe Anforderungen formuliert, deren Erf√ºllung meiner Meinung nach notwendig ist, um die Zuverl√§ssigkeit zu gew√§hrleisten: </p><br><ul><li>  Aufzeichnungen sollten sofort in den Flash-Speicher geschrieben werden, anstehende Aufzeichnungen werden nicht ber√ºcksichtigt. - Wenn ein Fehler auftritt, sollte er so schnell wie m√∂glich erkannt und verarbeitet werden. - Das System sollte nach M√∂glichkeit eine Fehlerbehebung durchf√ºhren. <br>  <em>(Ein Beispiel aus dem Leben "wie es nicht sein sollte", das sich meiner Meinung nach alle getroffen haben: Nach einem Notfall-Neustart ist das Dateisystem "kaputt" und das Betriebssystem bootet nicht.)</em> </li></ul><br><h2 id="idei-podhody-razmyshleniya">  Ideen, Ans√§tze, Gedanken </h2><br><p>  Als ich √ºber diese Aufgabe nachdachte, schoss mir ein paar Ideen durch den Kopf, zum Beispiel: </p><br><ul><li>  Verwenden Sie die Datenkomprimierung </li><li>  Verwenden Sie knifflige Datenstrukturen, und speichern Sie beispielsweise Datensatzheader getrennt von den Datens√§tzen, damit Sie den Rest problemlos lesen k√∂nnen, wenn in einem Datensatz ein Fehler auftritt. </li><li>  Verwenden Sie Bitfelder, um die Vollst√§ndigkeit der Aufzeichnung beim Ausschalten zu kontrollieren. </li><li>  Speichern Sie Pr√ºfsummen f√ºr alles und alles; </li><li>  Verwenden Sie eine Art fehlerkorrigierende Codierung. </li></ul><br><p>  Einige dieser Ideen wurden verwendet, andere abgelehnt.  Gehen wir in Ordnung. </p><br><h3 id="szhatie-dannyh">  Datenkomprimierung </h3><br><p>  Die Ereignisse, die wir im Tagebuch selbst aufzeichnen, sind ziemlich gleich und wiederholbar ("warf eine M√ºnze von 5 Rubel", "klickte auf die Schaltfl√§che" Zustellung √§ndern ", ...).  Daher sollte die Komprimierung sehr effektiv sein. </p><br><p>  Der Overhead f√ºr die Komprimierung ist unbedeutend (der Prozessor, den wir haben, ist ziemlich leistungsf√§hig, selbst auf dem ersten Pi gab es einen Kern mit einer Frequenz von 700 MHz, auf aktuellen Modellen gab es mehrere Kerne mit einer Frequenz von mehr als einem Gigahertz), die Geschwindigkeit des Austauschs mit dem Speicher ist gering (mehrere Megabyte pro Sekunde), die Aufzeichnungsgr√∂√üe ist gering.  Wenn sich die Komprimierung auf die Leistung auswirkt, ist dies im Allgemeinen nur positiv <em>(absolut unkritisch, nur mit Angabe)</em> .  Au√üerdem haben wir kein echtes eingebettetes, sondern gew√∂hnliches Linux - daher sollte die Implementierung keinen gro√üen Aufwand erfordern (verkn√ºpfen Sie einfach die Bibliothek und verwenden Sie mehrere Funktionen daraus). </p><br><p>  Ein St√ºck des Protokolls wurde aus dem Arbeitsger√§t entnommen (1,7 MB, 70.000 Datens√§tze) und zun√§chst mit den auf dem Computer verf√ºgbaren gzip, lz4, lzop, bzip2, xz, zstd auf Komprimierbarkeit √ºberpr√ºft. </p><br><ul><li>  gzip, xz, zstd zeigten √§hnliche Ergebnisse (40 KB). <br>  Ich war √ºberrascht, dass sich das modische xz hier auf der gzip- oder zstd-Ebene zeigte. </li><li>  lzip mit Standardeinstellungen ergab ein etwas schlechteres Ergebnis; </li><li>  lz4 und lzop zeigten keine sehr guten Ergebnisse (150Kb); </li><li>  bzip2 zeigte √ºberraschend gute Ergebnisse (18Kb). </li></ul><br><p>  Die Daten sind also sehr gut komprimiert. <br>  Wenn wir also keine schwerwiegenden Fehler finden, sollte es zu einer Komprimierung kommen!  Nur weil mehr Daten auf dasselbe Flash-Laufwerk passen. </p><br><p>  Denken wir √ºber die M√§ngel nach. </p><br><p>  Das erste Problem: Wir haben uns bereits darauf geeinigt, dass jede Aufnahme sofort aufblitzen soll.  Normalerweise sammelt der Archivierer Daten aus dem Eingabestream, bis er entscheidet, dass es Zeit ist, in die Ausgabe zu schreiben.  Wir m√ºssen sofort einen komprimierten Datenblock abrufen und nichtfl√ºchtig speichern. </p><br><p>  Ich sehe drei M√∂glichkeiten: </p><br><ol><li>  Komprimieren Sie jeden Eintrag mithilfe der W√∂rterbuchkomprimierung anstelle der oben beschriebenen Algorithmen. <br>  Es ist eine funktionierende Option, aber ich mag es nicht.  Um eine mehr oder weniger gute Komprimierung zu gew√§hrleisten, sollte das W√∂rterbuch f√ºr bestimmte Daten ‚Äûgesch√§rft‚Äú werden. Jede √Ñnderung f√ºhrt dazu, dass die Komprimierungsstufe katastrophal abf√§llt.  Ja, das Problem wird gel√∂st, indem eine neue Version des W√∂rterbuchs erstellt wird. Dies bereitet jedoch Kopfzerbrechen. Wir m√ºssen alle Versionen des W√∂rterbuchs speichern.  In jedem Eintrag m√ºssen wir angeben, mit welcher Version des W√∂rterbuchs es komprimiert wurde ... </li><li>  Komprimieren Sie jeden Eintrag mit "klassischen" Algorithmen, jedoch unabh√§ngig von den anderen. <br>  Die betrachteten Komprimierungsalgorithmen sind nicht f√ºr die Arbeit mit Datens√§tzen dieser Gr√∂√üe (zehn Bytes) ausgelegt. Der Komprimierungskoeffizient ist eindeutig kleiner als 1 (dh eine Erh√∂hung der Datenmenge anstelle der Komprimierung). </li><li>  FLUSH nach jeder Aufnahme. <br>  Viele Komprimierungsbibliotheken unterst√ºtzen FLUSH.  Dies ist ein Befehl (oder ein Parameter f√ºr die Komprimierungsprozedur), bei dessen Empfang der Archivierer einen komprimierten Stream generiert, sodass auf seiner Basis <strong>alle</strong> unkomprimierten Daten wiederhergestellt werden k√∂nnen, die bereits empfangen wurden.  Solch ein Analogon der <code>sync</code> in Dateisystemen oder Festschreibung in SQL. <br>  Was wichtig ist, nachfolgende Komprimierungsvorg√§nge k√∂nnen das akkumulierte W√∂rterbuch verwenden und das Komprimierungsverh√§ltnis wird nicht so stark leiden wie in der vorherigen Version. </li></ol><br><p>  Ich denke, es ist offensichtlich, dass ich die dritte Option gew√§hlt habe. Lassen Sie uns genauer darauf eingehen. </p><br><p>  Es gab einen <a href="https://www.bolet.org/~pornin/deflate-flush.html" rel="nofollow">gro√üartigen Artikel</a> √ºber FLUSH in zlib. </p><br><p>  Ich habe einen motivierten Test basierend auf dem Artikel durchgef√ºhrt und 70.000 Tagebucheintr√§ge von einem realen Ger√§t mit einer Seitengr√∂√üe von 60 KB entnommen <em>(wir kehren zur Seitengr√∂√üe zur√ºck)</em> : </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Ausgangsdaten </th><th>  Gzip -9 Komprimierung (ohne FLUSH) </th><th>  zlib mit Z_PARTIAL_FLUSH </th><th>  zlib mit Z_SYNC_FLUSH </th></tr></thead><tbody><tr><td>  <strong>Volumen, Kb</strong> </td><td>  1692 </td><td>  40 </td><td>  352 </td><td>  604 </td></tr></tbody></table></div><br><p>  Auf den ersten Blick ist der von FLUSH eingef√ºhrte Preis √ºberm√§√üig hoch, aber in Wirklichkeit haben wir eine schlechte Wahl - entweder √ºberhaupt nicht zu komprimieren oder mit FLUSH (und sehr effizient) zu komprimieren.  Vergessen Sie nicht, dass wir 70.000 Datens√§tze haben. Die durch Z_PARTIAL_FLUSH eingef√ºhrte Redundanz betr√§gt nur 4-5 Bytes pro Datensatz.  Und das Kompressionsverh√§ltnis betrug fast 5: 1, was mehr als ein hervorragendes Ergebnis ist. </p><br><div class="spoiler">  <b class="spoiler_title">Es mag unerwartet erscheinen, aber tats√§chlich ist Z_SYNC_FLUSH eine effizientere M√∂glichkeit, FLUSH auszuf√ºhren</b> <div class="spoiler_text"><p>  Bei Verwendung von Z_SYNC_FLUSH sind die letzten 4 Bytes jedes Datensatzes immer 0x00, 0x00, 0xff, 0xff.  Und wenn wir sie kennen, k√∂nnen wir sie nicht speichern, sodass die Gesamtgr√∂√üe nur 324 KB betr√§gt. </p><br><p>  Der Artikel, auf den ich mich beziehe, hat eine Erkl√§rung: </p><br><blockquote>  Ein neuer Block vom Typ 0 mit leerem Inhalt wird angeh√§ngt. <br><br>  Ein Block vom Typ 0 mit leerem Inhalt besteht aus: <br><ul><li>  der Drei-Bit-Block-Header; </li><li>  0 bis 7 Bits gleich Null, um eine Byte-Ausrichtung zu erreichen; </li><li>  die Vier-Byte-Sequenz 00 00 FF FF. </li></ul><br></blockquote><p>  Wie Sie sehen k√∂nnen, kommen im letzten Block vor diesen 4 Bytes 3 bis 10 Nullbits.  Die Praxis hat jedoch gezeigt, dass Null-Bits tats√§chlich mindestens 10 sind. </p><br><p>  Es stellt sich heraus, dass solche kurzen Datenbl√∂cke normalerweise (immer?) Mit einem Block vom Typ 1 (fester Block) codiert werden, der notwendigerweise mit 7 Nullbits endet, sodass wir 10-17 garantierte Nullbits erhalten (und der Rest wird mit einer Wahrscheinlichkeit von etwa 50% Null sein). </p><br><p>  Bei Testdaten gibt es in 100% der F√§lle vor 0x00, 0x00, 0xff, 0xff ein Null-Byte und mehr als im dritten Fall zwei Null-Bytes <em>(m√∂glicherweise ist dies die Tatsache, dass ich bin√§res CBOR verwende, und wenn ich Text-CBOR verwende JSON w√ºrde mit gr√∂√üerer Wahrscheinlichkeit Bl√∂cke vom Typ 2 erf√ºllen - dynamische Bl√∂cke bzw. Bl√∂cke w√ºrden ohne zus√§tzliche Null-Bytes vor 0x00, 0x00, 0xff, 0xff auftreten</em> . </p><br><p>  Insgesamt k√∂nnen die verf√ºgbaren Testdaten in weniger als 250 KB komprimierte Daten passen. </p><br><p>  Sie k√∂nnen etwas mehr sparen, indem Sie Bits jonglieren: Jetzt ignorieren wir das Vorhandensein mehrerer Null-Bits am Ende des Blocks, einige Bits am Anfang des Blocks √§ndern sich auch nicht ... <br>  Aber dann habe ich eine willensstarke Entscheidung getroffen, aufzuh√∂ren, sonst k√∂nnen Sie in einem solchen Tempo die Entwicklung Ihres Archivierers erreichen. </p></div></div><br><p>  Insgesamt habe ich 3-4 Bytes pro Datensatz aus meinen Testdaten erhalten, das Kompressionsverh√§ltnis betrug mehr als 6: 1.  Ehrlich gesagt habe ich nicht mit einem solchen Ergebnis gerechnet. Meiner Meinung nach ist alles, was besser als 2: 1 ist, bereits ein Ergebnis, das die Verwendung von Komprimierung rechtfertigt. </p><br><p>  Alles ist in Ordnung, aber zlib (deflate) ist immer noch <del>  archaisch </del>  wohlverdienter und etwas altmodischer Kompressionsalgorithmus.  Die blo√üe Tatsache, dass die letzten 32 KB aus dem unkomprimierten Datenstrom als W√∂rterbuch verwendet werden, sieht heute seltsam aus (dh, wenn ein Datenblock dem Datenstrom mit 40 KB sehr √§hnlich ist, wird er erneut archiviert, jedoch nicht siehe den letzten Eintrag).  In <del>  modisch </del>  Die Gr√∂√üe eines modernen Archivierungsw√∂rterbuchs wird h√§ufig eher in Megabyte als in Kilobyte gemessen. </p><br><p>  Also setzen wir unsere Mini-Studie der Archivare fort. </p><br><p>  Als n√§chstes wurde bzip2 getestet (erinnere dich, ohne FLUSH zeigte es ein fantastisches Kompressionsverh√§ltnis von fast 100: 1).  Leider zeigte sich bei FLUSH sehr schlecht, dass die Gr√∂√üe der komprimierten Daten gr√∂√üer war als die der unkomprimierten. </p><br><div class="spoiler">  <b class="spoiler_title">Meine Vermutungen √ºber die Gr√ºnde f√ºr das Scheitern</b> <div class="spoiler_text"><p>  Libbz2 bietet nur eine Flush-Option, die das W√∂rterbuch zu l√∂schen scheint (√§hnlich wie Z_FULL_FLUSH in zlib). Es gibt keinen Grund, von einer effizienten Komprimierung zu sprechen. </p></div></div><br><p>  Und zstd wurde als letztes getestet.  Abh√§ngig von den Parametern wird es entweder auf der Ebene von gzip komprimiert, aber viel schneller, oder gzip ist besser. </p><br><p>  Leider hat er sich mit FLUSH als "nicht sehr" erwiesen: Die Gr√∂√üe der komprimierten Daten betrug etwa 700 KB. </p><br><p>  Ich <a href="https://github.com/facebook/zstd/issues/900" rel="nofollow">habe eine Frage</a> auf der Projektseite in Github gestellt und eine Antwort erhalten, dass es sich lohnt, f√ºr jeden Block komprimierter Daten mit bis zu 10 Byte Servicedaten zu rechnen, was nahe an den Ergebnissen liegt. Das Abfangen von deflate funktioniert nicht. </p><br><p>  Ich habe mich dazu entschlossen, in Experimenten mit Archiven damit aufzuh√∂ren (ich erinnere Sie daran, dass sich xz, lzip, lzo, lz4 im Teststadium nicht ohne FLUSH zeigten, aber exotischere Kompressionsalgorithmen nicht in Betracht zogen). </p><br><p>  Wir kehren zu den Problemen der Archivierung zur√ºck. </p><br><p>  Das zweite (wie sie sagen, in der Reihenfolge, aber nicht im Wert) Problem - die komprimierten Daten sind ein einzelner Stream, in dem st√§ndig an vorherige Abschnitte gesendet wird.  Wenn also ein Abschnitt der komprimierten Daten besch√§digt wird, verlieren wir nicht nur den Block der nicht komprimierten Daten, sondern auch alle nachfolgenden. </p><br><p>  Es gibt einen L√∂sungsansatz f√ºr dieses Problem: </p><br><ol><li>  Verhindern Sie das Auftreten eines Problems - f√ºgen Sie den komprimierten Daten Redundanz hinzu, um Fehler zu identifizieren und zu korrigieren.  wir werden sp√§ter dar√ºber sprechen; </li><li>  Minimieren Sie die Konsequenzen im Falle eines Problems <br>  Wir haben bereits fr√ºher gesagt, dass es m√∂glich ist, jeden Datenblock einzeln zu komprimieren, und dass das Problem von selbst verschwindet (Datenkorruption eines Blocks f√ºhrt nur zum Verlust von Daten dieses Blocks).  Dies ist jedoch ein extremer Fall, in dem die Datenkomprimierung ineffizient ist.  Das gegenteilige Extrem: Verwenden Sie alle 4 MB unseres Mikrokreislaufs als ein einziges Archiv, wodurch wir eine hervorragende Komprimierung erzielen, aber katastrophale Folgen im Falle einer Datenkorruption haben. <br>  <em>Ja, ein Kompromiss hinsichtlich der Zuverl√§ssigkeit ist erforderlich.</em>  <em>Wir m√ºssen jedoch bedenken, dass wir ein Datenspeicherformat f√ºr nichtfl√ºchtigen Speicher mit einer extrem niedrigen BER und einer angegebenen Datenspeicherdauer von 20 Jahren entwickeln.</em> </li></ol><br><p>  Im Verlauf der Experimente stellte ich fest, dass bei komprimierten Datenbl√∂cken mit einer Gr√∂√üe von weniger als 10 KB mehr oder weniger sp√ºrbare Verluste im Komprimierungsgrad auftreten. <br>  Es wurde bereits erw√§hnt, dass der verwendete Speicher eine Seitenorganisation hat. Ich sehe keinen Grund, warum Sie die Korrespondenz "eine Seite - ein Block komprimierter Daten" nicht verwenden sollten. </p><br><p>  Das hei√üt, die minimale angemessene Seitengr√∂√üe betr√§gt 16 KB (mit einer Spanne f√ºr Serviceinformationen).  Eine so kleine Seitengr√∂√üe f√ºhrt jedoch zu erheblichen Einschr√§nkungen der maximalen Aufzeichnungsgr√∂√üe. </p><br><p>  Obwohl ich immer noch keine komprimierten Aufzeichnungen von mehr Kilobyte-Einheiten erwarte, habe ich mich f√ºr die Verwendung von 32 KB-Seiten (insgesamt 128 Seiten pro Chip) entschieden. </p><br><p>  <strong>Zusammenfassung:</strong> </p><br><ul><li>  Wir speichern Daten, die mit zlib (deflate) komprimiert wurden. </li><li>  Setzen Sie f√ºr jeden Datensatz Z_SYNC_FLUSH; </li><li>  F√ºr jeden komprimierten Datensatz werden die letzten Bytes <em>abgeschnitten (z. B. 0x00, 0x00, 0xff, 0xff)</em> .  Geben Sie im Header an, wie viele Bytes wir schneiden. </li><li>  Wir speichern Daten auf 32-KB-Seiten.  Innerhalb der Seite befindet sich ein einzelner Strom komprimierter Daten.  Auf jeder Seite wird die Komprimierung erneut gestartet. </li></ul><br><p>  Und bevor ich mit der Komprimierung fertig bin, m√∂chte ich darauf hinweisen, dass wir nur wenige Bytes an Schreibdaten erhalten. Daher ist es √§u√üerst wichtig, die Serviceinformationen nicht zu vergr√∂√üern, da jedes Byte gez√§hlt wird. </p><br><h3 id="hranenie-zagolovkov-dannyh">  Speichern von Datenk√∂pfen </h3><br><p>  Da wir Datens√§tze mit variabler L√§nge haben, m√ºssen wir irgendwie den Ort / die Grenzen der Datens√§tze bestimmen. </p><br><p>  Ich kenne drei Ans√§tze: </p><br><ol><li>  Alle Datens√§tze werden in einem fortlaufenden Stream gespeichert. Zuerst wird der Datensatzkopf mit der L√§nge und dann der Datensatz selbst angezeigt. <br>  In dieser Ausf√ºhrungsform k√∂nnen sowohl die Header als auch die Daten eine variable L√§nge haben. <br>  Tats√§chlich erhalten wir eine einfach verkn√ºpfte Liste, die st√§ndig verwendet wird. </li><li>  Header und Datens√§tze selbst werden in separaten Streams gespeichert. <br>  Mit Headern konstanter L√§nge stellen wir sicher, dass Sch√§den an einem Header den Rest nicht beeintr√§chtigen. <br>  Ein √§hnlicher Ansatz wird beispielsweise in vielen Dateisystemen verwendet. </li><li>  Datens√§tze werden in einem kontinuierlichen Datenstrom gespeichert, die Grenze des Datensatzes wird durch einen Marker (Symbol / Zeichenfolge, die in Datenbl√∂cken verboten ist / ist) festgelegt.  Wenn ein Marker im Datensatz gefunden wird, ersetzen wir ihn durch eine bestimmte Sequenz (Escape-Zeichen). <br>  Ein √§hnlicher Ansatz wird beispielsweise im PPP-Protokoll verwendet. </li></ol><br><p>  Ich werde es veranschaulichen. </p><br><p>  Variante 1: <br><img src="https://habrastorage.org/webt/b3/yu/q8/b3yuq8z6elbufkrice2g_vjtuhe.png" alt="Variante 1"><br>  Hier ist alles ganz einfach: Wenn wir die L√§nge des Datensatzes kennen, k√∂nnen wir die Adresse des n√§chsten Headers berechnen.  Also bewegen wir uns durch die Header, bis wir auf eine Region treffen, die mit 0xff (freie Region) oder dem Ende der Seite gef√ºllt ist. </p><br><p>  Option 2: <br><img src="https://habrastorage.org/webt/kf/qy/_7/kfqy_7qzi7pzmk-g5cqa4r6s75q.png" alt="Option 2"><br>  Aufgrund der variablen L√§nge des Datensatzes k√∂nnen wir nicht im Voraus sagen, wie viele Datens√§tze (und damit die √úberschriften) pro Seite wir ben√∂tigen.  Sie k√∂nnen die √úberschriften und die Daten selbst auf verschiedene Seiten verteilen, aber ich bevorzuge einen anderen Ansatz: Wir platzieren die √úberschriften und die Daten auf derselben Seite, die √úberschriften (mit konstanter Gr√∂√üe) befinden sich jedoch am Anfang der Seite und die Daten (mit variabler L√§nge) am Ende.  Sobald sie sich "treffen" (es ist nicht gen√ºgend Speicherplatz f√ºr einen neuen Datensatz vorhanden) - betrachten wir diese Seite als voll. </p><br><p>  Option 3: <br><img src="https://habrastorage.org/webt/-q/u1/qj/-qu1qjmqlcvfi570ovsdy_nzzny.png" alt="Option 3"><br>  Es ist nicht erforderlich, die L√§nge oder andere Informationen √ºber den Speicherort der Daten im Header zu speichern. Es gibt gen√ºgend Markierungen, die die Grenzen der Datens√§tze angeben.  Die Daten m√ºssen jedoch w√§hrend des Schreibens / Lesens verarbeitet werden. <br>  Als Markierung w√ºrde ich 0xff verwenden (welches die Seite nach dem L√∂schen f√ºllt), so dass der freie Bereich definitiv nicht als Daten behandelt wird. </p><br><p>  Vergleichstabelle: </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Variante 1 </th><th>  Option 2 </th><th>  Option 3 </th></tr></thead><tbody><tr><td>  <strong>Fehlertoleranz</strong> </td><td>  - </td><td>  + </td><td>  + </td></tr><tr><td>  <strong>Kompaktheit</strong> </td><td>  + </td><td>  - </td><td>  + </td></tr><tr><td>  <strong>Komplexit√§t der Implementierung</strong> </td><td>  * </td><td>  ** </td><td>  ** </td></tr></tbody></table></div><br><p>  Option 1 hat einen schwerwiegenden Fehler: Wenn einer der Header besch√§digt ist, wird unsere gesamte nachfolgende Kette zerst√∂rt.  Mit anderen Optionen k√∂nnen Sie einen Teil der Daten auch bei massivem Schaden wiederherstellen. <br>  Wir m√∂chten jedoch daran erinnern, dass wir uns entschlossen haben, die Daten in komprimierter Form zu speichern, und daher alle Daten auf der Seite nach dem "kaputten" Datensatz verlieren, sodass wir dies nicht ber√ºcksichtigen, obwohl die Tabelle negativ ist. </p><br><p>  Kompaktheit: </p><br><ul><li>  In der ersten Version m√ºssen wir nur die L√§nge im Header speichern. Wenn Ganzzahlen mit variabler L√§nge verwendet werden, k√∂nnen wir in den meisten F√§llen mit einem Byte arbeiten. </li><li>  In der zweiten Option m√ºssen wir die Startadresse und die Startl√§nge speichern.  Der Datensatz sollte eine konstante Gr√∂√üe haben. Ich sch√§tze 4 Bytes pro Datensatz (zwei Bytes pro Versatz und zwei Bytes pro L√§nge). </li><li>  Bei der dritten Option ist nur ein Zeichen ausreichend, um den Beginn der Aufzeichnung anzuzeigen, und die Aufzeichnung selbst w√§chst aufgrund der √úberpr√ºfung um 1 bis 2%.  Im Allgemeinen ungef√§hre Parit√§t mit der ersten Option. </li></ul><br><p>        (   ).      ,     . </p><br><p> <em>, -  -    . ,        ,      ‚Äî     ,  , ...</em> </p><br><p>     :          ,      ,      .. , , ,      ‚Äî     ,   . </p><br><p> <strong>:</strong>       "   ‚Äî   " -    . </p><br><h3 id="ispolzovanie-bitovyh-poley-dlya-kontrolya-uspeshnosti-operaciy-zapisi">         </h3><br><p>    ,    ,     : <br>         . <br> <em>   ,  erase    1,     1  0,   .</em>    "  "  1,  " " ‚Äî 0. </p><br><p>          flash: </p><br><ol><li>   ‚Äú  ‚Äù; </li><li>  ; </li><li>   ‚Äú  ‚Äù; </li><li>  ; </li><li>   ‚Äú ‚Äù. </li></ol><br><p>  ,     ‚Äú ‚Äù,  4  . </p><br><p>          ‚Äú1111‚Äù ‚Äî     ‚Äú1000‚Äù ‚Äî   ;         ,        . </p><br><p>  ,           , , , ,      (   )   . </p><br><p> <strong>:</strong>      . </p><br><h3 id="kontrolnye-summy">   </h3><br><p>       (  )     ,     . ,       ,   . </p><br><p>      ,     ,           <em>( , ,   ‚Äî       )</em> . </p><br><p>  ,    ,   ,   ‚Äî  . </p><br><p>         ‚Äî CRC.   ,     100%    ,   ‚Äî               <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mi>n</mi></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.659ex" height="2.298ex" viewBox="0 -883.9 1575.6 989.6" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mo>‚àí</mo><mi>n</mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1">2^{-n}</script>  .      ,      ,       :       ,      .  ‚Äî      . </p><br><p>   : <a href="http://amsoftware.narod.ru/algo.html" rel="nofollow"> 1</a> , <a href="http://amsoftware.narod.ru/algo2.html" rel="nofollow"> 2</a> <em>(  narod.ru, )</em> . </p><br><p>       , CRC ‚Äî     .    ,    . </p><br><p>        ,     . </p><br><p> : <br>         <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>10</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#x2212;</mo><mn>3</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.658ex" height="2.419ex" viewBox="0 -935.7 2005.4 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-30" x="500" y="0"></use><g transform="translate(1001,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2212" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-33" x="778" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mrow class="MJX-TeXAtom-ORD"><mo>‚àí</mo><mn>3</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2">10^{-3}</script>    ,       : </p><br><div class="scrollable-table"><table><thead><tr><th> ,  </th><th>  ,  </th><th>   </th><th>    </th><th>    </th></tr></thead><tbody><tr><td>  1 </td><td>  0 </td><td> 1000 </td><td>  0 </td><td> 1000 </td></tr><tr><td>  1 </td><td>  1 </td><td>  4 </td><td>  999 </td><td>  1003 </td></tr><tr><td>  1 </td><td>  2 </td><td> ‚âà0 </td><td>  1997 </td><td>  1997 </td></tr><tr><td>  1 </td><td>  4 </td><td> ‚âà0 </td><td> 3990 </td><td> 3990 </td></tr><tr><td>  10 </td><td>  0 </td><td>  9955 </td><td>  0 </td><td>  9955 </td></tr><tr><td>  10 </td><td>  1 </td><td>  39 </td><td>  990 </td><td>  1029 </td></tr><tr><td>  10 </td><td>  2 </td><td> ‚âà0 </td><td>  1979 </td><td>  1979 </td></tr><tr><td>  10 </td><td>  4 </td><td> ‚âà0 </td><td> 3954 </td><td> 3954 </td></tr><tr><td> 1000 </td><td>  0 </td><td> 632305 </td><td>  0 </td><td> 632305 </td></tr><tr><td> 1000 </td><td>  1 </td><td> 2470 </td><td> 368 </td><td>  2838 </td></tr><tr><td> 1000 </td><td>  2 </td><td>  10 </td><td>  735 </td><td>  745 </td></tr><tr><td> 1000 </td><td>  4 </td><td> ‚âà0 </td><td>  1469 </td><td>  1469 </td></tr></tbody></table></div><br><p>  ,   ‚Äî               ‚Äî    . </p><br><p> ,      : ,       ,           .     ,  <a href="https://habr.com/ru/post/428746/">   </a> . </p><br><p> ,        ,      32    <em>(   64     -)</em> . </p><br><p>   ,    ,      , -   32-   (16  ,    0.01%;  24 ,  ,     ). </p><br><p>    :          ,    4  ?           ?  ,   <em> </em> ,      . </p><br><p>       ,     CRC-32C. <br>    6      22  (,     c), 4      655  (    ), 2           . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p> <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" rel="nofollow"> </a>  CRC. </p><br><p> <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0x8f6e37a0_len.txt" rel="nofollow">  crc-32c</a>  <a href="http://users.ece.cmu.edu/~koopman/crc/notes.html" rel="nofollow"> </a> ‚Äî ,    CRC  . </p><br><p>  <a href="http://users.ece.cmu.edu/~koopman/networks/dsn02/dsn02_koopman.pdf" rel="nofollow"> </a>  <a href="https://users.ece.cmu.edu/~koopman/crc/c32/0xfa567d89_len.txt" rel="nofollow">   </a> ,          ,      ,    ,         . </p></div></div><br><p> ,      ,  :       ? </p><br><p>  ""     : </p><br><ul><li>          ‚Äî       (         /, ,     ..); </li><li>  deflate  zlib      <em> </em>   ""  ,  ,         ,      (        , zlib      ). </li></ul><br><p>  ""     : </p><br><ul><li> CRC ""     ,    - (          ,  ,  ,   "" ); </li><li>          , <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-72/product_id-1820/GNU-Zlib.html" rel="nofollow">  </a> ,   . </li></ul><br><p>              . </p><br><p> <strong>:</strong>  CRC-32C,        ,      flash ( ). </p><br><h3 id="izbytochnost">  </h3><br><p>     , ,   , ,    (   )     . </p><br><p>        ,   . <br>       ,  - ,           RAID-6         . <br>         ,   ,           ,     . </p><br><p>   ,       .        ? </p><br><ol><li>   ( -      ,  Raspberry, ...) <br> ,             ; </li><li>   ( -   flash-   ,  ) <br>      ,         ; </li><li>       ; </li><li>   <br>            . </li></ol><br><p>       (    )       . ,   -  . </p><br><p> <strong>:</strong>      , ,      ,      (     ,      ). </p><br><h3 id="prochee">  Andere </h3><br><p> ,          <em>(      )</em> ,      ,   . </p><br><ul><li>     "" <br>     -    ,    ..,    ,      . <br>     ,    ,    ; </li><li>     . <br>       ‚Äî ! <br>         Magic Number (),        <em>( ,       )</em> ; </li><li>    (  )   ,         1 ; </li><li>               . </li></ul><br><p>   <a href="https://planetcalc.com/2481/" rel="nofollow">-</a>  .          . </p><br><h1 id="anchorformatanchoropisanie-formata-hraneniya-dannyh"><a name="format"></a>     </h1><br><h2 id="byte-order"> Byte order </h2><br><p> ,    ,   big-endian  (network byte order),   0x1234   0x12, 0x34. </p><br><h2 id="delenie-na-stranicy">    </h2><br><p>  -     . </p><br><p>     32,   ,  1/4      (   4  128 ). </p><br><p>        (          ). </p><br><p>       (   ),    0 (     0,  ‚Äî  32,  ‚Äî  64  ..) </p><br><p>       (ring buffer),          0,    1, ...,     ,          . </p><br><h2 id="vnutri-stranicy">   </h2><br><p><img src="https://habrastorage.org/webt/7r/sr/fa/7rsrfafqrc263dsu8zd5ptceqga.png" alt="Seite"><br>     4-  ,     (CRC-32C),      ", ,  ". </p><br><p>   (  -)  : </p><br><ul><li>   Magic Number (  ‚Äî   ) <br>        <code>0xed00 ‚äï  </code> ; </li><li>   " " (   ). </li></ul><br><p>        (  deflate).          (  ),       .              (   ). </p><br><p>      Z_SYNC_FLUSH,        4  0x00, 0x00, 0xff, 0xff, , ,      . <br>   ( 4, 5  6 )      -. </p><br><p>      1, 2  3 , : </p><br><ul><li>   (T),   : 0 ‚Äî , 1 ‚Äî ; </li><li>    (S)  1  7 ,     "",       ; </li><li>   (L). </li></ul><br><p>   S: </p><br><div class="scrollable-table"><table><thead><tr><th>  S </th><th>  ,  </th><th>   ,  </th></tr></thead><tbody><tr><td> <code>0</code> </td> <td>  1 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>10</code> </td> <td>  1 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>110</code> </td> <td>  2 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1110</code> </td> <td>  2 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>11110</code> </td> <td>  2 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111100</code> </td> <td>  3 </td><td> 4 ( <code>00 00 ff ff</code> ) </td></tr><tr><td> <code>1111101</code> </td> <td>  3 </td><td> 5 ( <code>00 00 00 ff ff</code> ) </td></tr><tr><td> <code>1111110</code> </td> <td>  3 </td><td> 6 ( <code>00 00 00 00 ff ff</code> ) </td></tr></tbody></table></div><br><p>  ,  ,   : <br><img src="https://habrastorage.org/webt/iu/fu/bp/iufubpdgxnpv9czd45tomt-0vtc.png" alt="  "><br>     T,  ‚Äî  S,  L (    ),  ‚Äî  ,  ‚Äî    ,     -. </p><br><p>  ,      ( 63+5    )     . </p><br><p>       CRC-32C,       (init)      . </p><br><p> <em>CRC   "",  (-    )  :</em> <math> </math><em><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy=&quot;false&quot;>(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy=&quot;false&quot;>)</mo><mo>,</mo><mi>B</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="43.505ex" height="2.66ex" viewBox="0 -832 18731.1 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="760" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="1520" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="2280" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="2670" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="3015" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="3616" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-74" x="3961" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="4323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-41" x="4768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-7C" x="5518" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-7C" x="5797" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-42" x="6075" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="6835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-3D" x="7502" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="8558" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="9319" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="10078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="10839" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="11228" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-52" x="11989" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-43" x="12748" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-28" x="13509" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="13898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-6E" x="14244" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-69" x="14844" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-74" x="15190" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="15551" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-41" x="15996" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="16747" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-2C" x="17136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMATHI-42" x="17582" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/479044/&amp;xid=17259,15700022,15700186,15700191,15700259,15700271&amp;usg=ALkJrhgf7iBIx2S6PLJ0gbWHQT8AI45Jiw#MJMAIN-29" x="18341" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false">|</mo></mrow><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>C</mi><mi>R</mi><mi>C</mi><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>A</mi><mo stretchy="false">)</mo><mo>,</mo><mi>B</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3">CRC(init, A || B) = CRC(CRC(init, A), B)</script></em>   <em>.</em> <em><br>      CRC         .</em> </p><br><p>        . </p><br><p>    ,         0x00  0xff (       0xff,      ; 0x00    ). </p><br><h2 id="primernye-algoritmy">   </h2><br><h3 id="chtenie-iz-flesh-pamyati">   - </h3><br><p>       . <br>      ‚Äî       -  . </p><br><p> <em>(  , Linux     NOR Flash, )</em> </p><br><h3 id="zapis-v-flesh-pamyat">   - </h3><br><p>  . <br>  . </p><br><p>        ‚Äî       . </p><br><h3 id="podgotovka-novoy-mikroshemy-k-rabote">      </h3><br><p>     ( )      1. <br>         ( UUID    ). </p><br><p> , -   . </p><br><h3 id="zagruzka-avtomata">   </h3><br><p>     8    ( + CRC),    Magic Number   CRC . <br>  ""      ,    ,   . <br>   ,   CRC,   "".    ‚Äî    .   ‚Äî   ,    "" . <br>      , ,    "" . <br>   zlib (      ). </p><br><p> ,  ,  ,  . </p><br><h3 id="dobavlenie-zapisi-v-zhurnal">     </h3><br><p>     ,  Z_SYNC_FLUSH.,       . <br>    (     CRC) ‚Äî    (. ). <br>    CRC.    ‚Äî   . </p><br><h3 id="novaya-stranica">   </h3><br><p>       (              ).     ‚Äî       ,     . <br>    erase.    0xff.  -   ‚Äî    ,  .. <br>     ,     ,  ‚Äî    (  ). </p><br><h1 id="primenimost-formata">   </h1><br><p>   ,       -    ( , JSON, MessagePack, CBOR, , protobuf)  NOR Flash. </p><br><p> ,  ""  SLC NOR Flash. </p><br><p>         BER,  NAND  MLC NOR <em>(      ?        )</em> . </p><br><p>  ,      ,   FTL: USB flash, SD, MicroSD, etc <em>(          512 ,          ‚Äî   ""        )</em> . </p><br><p>             128 (16)  1 (128).         , , ,     <em>(      ,   NOR Flash    )</em> . </p><br><p>  -   ,         ‚Äî ,   ,      github. </p><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  ,      <em>  </em> . </p><br><p>        ,  :     - , ,         . ,  () -         . </p><br><p>    ,   ? , .   , ,      .   -        . </p><br><p>        ?  ,       ,   .    . </p><br><p>    ,       ,   " ". </p><br><p>        ,       <em>()</em>   , ,    ""  (, ,     ;      ).        <em>(    ‚Äî   )</em> . </p><br><p>          ,      . </p><br><h1 id="literatura">  Literatur </h1><br><p>        ,       . </p><br><p>      ,     ,        ,      : </p><br><ol><li>  <a href="https://github.com/madler/infgen/" rel="nofollow">infgen</a>   zlib.        deflate/zlib/gzip.         deflate ( gzip) ‚Äî  . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de479044/">https://habr.com/ru/post/de479044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de479034/index.html">Herstellen einer Verbindung zu einem Unternehmens-VPN unter Linux mithilfe von openconnect und vpn-slice</a></li>
<li><a href="../de479036/index.html">Intel kann die Nachfrage nach Prozessoren nicht befriedigen. HP und Dell leiden darunter</a></li>
<li><a href="../de479038/index.html">Digitale Transformation Leroy Merlin: Entwerfen einer Schnittstelle f√ºr die Arbeit mit Kundenanrufen</a></li>
<li><a href="../de479040/index.html">Visuelle Regressionstests. Starten Sie neu</a></li>
<li><a href="../de479042/index.html">Mit der Y-Methode k√∂nnen Sie ganz einfach einen Rubik's Cube erstellen</a></li>
<li><a href="../de479048/index.html">Node.js Streams f√ºr Dummies oder wie man mit Streams arbeitet</a></li>
<li><a href="../de479050/index.html">Patentrecherche in der IT. Der Kurs des jungen K√§mpfers. Teil II Informationsquellen f√ºr die Patentrecherche</a></li>
<li><a href="../de479052/index.html">[Supercomputing 2019]. Multi-Cloud-Speicher als Anwendung f√ºr neue Kingston DC1000M-Laufwerke</a></li>
<li><a href="../de479054/index.html">Mobile Umfrage am Freitag</a></li>
<li><a href="../de479056/index.html">√úber das Leben reden? DREAM Team bei der Alexa Prize Socialbot Challenge 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>