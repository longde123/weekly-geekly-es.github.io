<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•š ğŸ‘©â€ğŸ”§ ğŸ¥œ æˆ‘ä»¬å°†LDAPæˆæƒå›ºå®šåˆ°Kubernetes ğŸ•œ ğŸ‘©â€â¤ï¸â€ğŸ‘© ğŸ–ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ‰å…³å¦‚ä½•å°†Kubernetesä¸Keycloakç»“åˆä½¿ç”¨çš„ç®€çŸ­è¯´æ˜ï¼Œä»¥ç»‘å®šåˆ°LDAPæœåŠ¡å™¨å¹¶é…ç½®ç”¨æˆ·å’Œç»„å¯¼å…¥ã€‚ è¿™å°†å…è®¸æ‚¨ä¸ºç”¨æˆ·é…ç½®RBACï¼Œå¹¶ä½¿ç”¨auth-proxyä¿æŠ¤Kubernetesä»ªè¡¨æ¿å’Œå…¶ä»–æ— æ³•æˆæƒè‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚ 
 å®‰è£…Keycloak 


 å‡è®¾æ‚¨å·²ç»æœ‰ä¸€ä¸ªLDAPæœåŠ¡å™¨ã€‚ å®ƒ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬å°†LDAPæˆæƒå›ºå®šåˆ°Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441112/"><p><img src="https://habrastorage.org/webt/kj/60/vi/kj60vi6ugv7bunlqdts2nlr2vja.png"></p><br><p> æœ‰å…³å¦‚ä½•å°†Kubernetesä¸Keycloakç»“åˆä½¿ç”¨çš„ç®€çŸ­è¯´æ˜ï¼Œä»¥ç»‘å®šåˆ°LDAPæœåŠ¡å™¨å¹¶é…ç½®ç”¨æˆ·å’Œç»„å¯¼å…¥ã€‚ è¿™å°†å…è®¸æ‚¨ä¸ºç”¨æˆ·é…ç½®RBACï¼Œå¹¶ä½¿ç”¨auth-proxyä¿æŠ¤Kubernetesä»ªè¡¨æ¿å’Œå…¶ä»–æ— æ³•æˆæƒè‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚ </p><a name="habracut"></a><br><h2 id="ustanovka-keycloak"> å®‰è£…Keycloak </h2><br><p> å‡è®¾æ‚¨å·²ç»æœ‰ä¸€ä¸ªLDAPæœåŠ¡å™¨ã€‚ å®ƒå¯ä»¥æ˜¯Active Directoryï¼ŒFreeIPAï¼ŒOpenLDAPæˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚ å¦‚æœæ‚¨æ²¡æœ‰LDAPæœåŠ¡å™¨ï¼Œåˆ™åŸåˆ™ä¸Šå¯ä»¥ç›´æ¥åœ¨Keycloakç•Œé¢ä¸­åˆ›å»ºç”¨æˆ·ï¼Œæˆ–ä½¿ç”¨å…¬å…±oidcæä¾›ç¨‹åºï¼ˆGoogleï¼ŒGithubï¼ŒGitlabï¼‰ï¼Œç»“æœå°†å‡ ä¹ç›¸åŒã€‚ </p><br><p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å®‰è£…Keycloakæœ¬èº«ï¼Œå®‰è£…å¯ä»¥å•ç‹¬æ‰§è¡Œï¼Œç„¶åç«‹å³åœ¨Kubernetesé›†ç¾¤ä¸­è¿›è¡Œï¼Œé€šå¸¸ï¼Œå¦‚æœæ‚¨æœ‰å¤šä¸ªKubernetesé›†ç¾¤ï¼Œåˆ™åˆ†åˆ«å®‰è£…ä¼šæ›´å®¹æ˜“ã€‚ å¦ä¸€æ–¹é¢ï¼Œæ‚¨å§‹ç»ˆå¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®˜æ–¹å¤´ç›”å›¾</a>å¹¶å°†å…¶ç›´æ¥å®‰è£…åœ¨é›†ç¾¤ä¸­ã€‚ </p><br><p>è¦å­˜å‚¨Keycloakæ•°æ®ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªæ•°æ®åº“ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨<code>h2</code> ï¼ˆæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨æœ¬åœ°ï¼‰ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨<code>postgres</code> ï¼Œ <code>mysql</code>æˆ–<code>mariadb</code> ã€‚ <br> å¦‚æœæ‚¨ä»ç„¶å†³å®šå•ç‹¬å®‰è£…Keycloakï¼Œåˆ™å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®˜æ–¹æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æ›´è¯¦ç»†çš„è¯´æ˜ã€‚ </p><br><h2 id="nastroyka-federacii"> è”ç›Ÿè®¾ç½® </h2><br><p> é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„é¢†åŸŸã€‚ é¢†åŸŸæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ç©ºé—´ã€‚ æ¯ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥å…·æœ‰ä¸åŒçš„ç”¨æˆ·å’Œæˆæƒè®¾ç½®çš„è‡ªå·±çš„é¢†åŸŸã€‚ ä¸»åŸŸç”±Keycloakæœ¬èº«ä½¿ç”¨ï¼Œä¸é€‚åˆå°†å…¶ç”¨äºå…¶ä»–ä»»ä½•ç”¨é€”ã€‚ </p><br><p> å•å‡»<strong>æ·»åŠ é¢†åŸŸ</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>åç§°</strong> </td><td> <code>kubernetes</code> </td> </tr><tr><td>  <strong>æ˜¾ç¤ºåç§°</strong> </td><td> <code>Kubernetes</code> </td> </tr><tr><td>  <strong>HTMLæ˜¾ç¤ºåç§°</strong> </td><td> <code>&lt;img src="https://kubernetes.io/images/nav_logo.svg" width="400" \&gt;</code> </td> </tr></tbody></table><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç”µå­é‚®ä»¶ã€‚ ç”±äºæˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„LDAPæœåŠ¡å™¨ï¼Œå› æ­¤æ­¤æ£€æŸ¥å‡ ä¹æ€»æ˜¯è¿”å›<code>false</code> ã€‚ è®©æˆ‘ä»¬å…³é—­Kubernetesä¸­æ­¤å‚æ•°çš„è¡¨ç¤ºå½¢å¼ï¼š </p><br><p>  <strong>å®¢æˆ·èŒƒå›´</strong> -&gt; <strong>ç”µå­é‚®ä»¶</strong> -&gt; <strong>æ˜ å°„å™¨</strong> -&gt; <strong>å·²éªŒè¯ç”µå­é‚®ä»¶</strong> ï¼ˆåˆ é™¤ï¼‰ </p><br><p> ç°åœ¨é…ç½®è”ç›Ÿï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†è½¬åˆ°ï¼š </p><br><p>  <strong>ç”¨æˆ·è”ç›Ÿ</strong> -&gt; <strong>æ·»åŠ æä¾›ç¨‹åº...-</strong> &gt; <strong>ldap</strong> </p><br><p> è¿™æ˜¯FreeIPAçš„ç¤ºä¾‹è®¾ç½®ï¼š </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>æ§åˆ¶å°æ˜¾ç¤ºåç§°</strong> </td><td> <code>freeipa.example.org</code> </td> </tr><tr><td>  <strong>ä¾›åº”å•†</strong> </td><td> <code>Red Hat Directory Server</code> </td> </tr><tr><td>  <strong>UUID LDAPå±æ€§</strong> </td><td> <code>ipauniqueid</code> </td> </tr><tr><td>  <strong>è¿æ¥ç½‘å€</strong> </td><td> <code>ldaps://freeipa.example.org</code> </td> </tr><tr><td>  <strong>ç”¨æˆ·DN</strong> </td><td> <code>cn=users,cn=accounts,dc=example,dc=org</code> </td> </tr><tr><td>  <strong>ç»‘å®šdn</strong> </td><td> <code>uid=keycloak-svc,cn=users,cn=accounts,dc=example,dc=org</code> </td> </tr><tr><td>  <strong>ç»‘å®šå‡­è¯</strong> </td><td> <code>&lt;password&gt;</code> </td> </tr><tr><td>  <strong>å…è®¸Kerberosèº«ä»½éªŒè¯ï¼š</strong> </td><td> <code>on</code> </td> </tr><tr><td>  <strong>Kerberosé¢†åŸŸï¼š</strong> </td><td> <code>EXAMPLE.ORG</code> </td> </tr><tr><td>  <strong>æœåŠ¡å™¨ä¸»ä½“ï¼š</strong> </td><td> <code>HTTP/freeipa.example.org@EXAMPLE.ORG</code> </td> </tr><tr><td>  <strong>å…³é”®å­—æ ‡ç­¾ï¼š</strong> </td><td> <code>/etc/krb5.keytab</code> </td> </tr></tbody></table><br><p> å¿…é¡»åœ¨æˆ‘ä»¬çš„LDAPæœåŠ¡å™¨ä¸Šé¢„å…ˆåˆ›å»º<code>keycloak-svc</code>ç”¨æˆ·ã€‚ </p><br><p> å¯¹äºActive Directoryï¼Œåªéœ€é€‰æ‹©â€œ <strong>ä¾›åº”å•†ï¼šActive Directoryâ€ï¼Œ</strong>ç„¶åå°†å¿…è¦çš„è®¾ç½®è‡ªåŠ¨å¡«å……åˆ°è¡¨å•ä¸­ã€‚ </p><br><p> ç‚¹å‡»<strong>ä¿å­˜</strong> </p><br><p> ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­ï¼š </p><br><p>  <strong>ç”¨æˆ·è”ç›Ÿ</strong> -&gt; <strong>freeipa.example.org-</strong> &gt; <strong>æ˜ å°„å™¨</strong> -&gt; <strong>å</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>Ldapå±æ€§</strong> </td><td> <code>givenName</code> </td> </tr></tbody></table><br><p> ç°åœ¨å¯ç”¨ç»„æ˜ å°„ï¼š </p><br><p>  <strong>ç”¨æˆ·è”ç›Ÿ</strong> -&gt; <strong>freeipa.example.org-</strong> &gt; <strong>æ˜ å°„å™¨</strong> -&gt; <strong>åˆ›å»º</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>åç§°</strong> </td><td> <code>groups</code> </td> </tr><tr><td>  <strong>æ˜ å°„å™¨ç±»å‹</strong> </td><td> <code>group-ldap-mapper</code> </td> </tr><tr><td>  <strong>LDAPç»„DN</strong> </td><td> <code>cn=groups,cn=accounts,dc=example,dc=org</code> </td> </tr><tr><td>  <strong>ç”¨æˆ·ç»„æ£€ç´¢ç­–ç•¥</strong> </td><td> <code>GET_GROUPS_FROM_USER_MEMBEROF_ATTRIBUTE</code> </td> </tr></tbody></table><br><p> è¿™æ ·å°±å®Œæˆäº†è”ç›Ÿçš„é…ç½®ï¼Œè®©æˆ‘ä»¬ç»§ç»­è®¾ç½®å®¢æˆ·ç«¯ã€‚ </p><br><h2 id="nastroyka-klienta"> å®¢æˆ·ç«¯è®¾ç½® </h2><br><p> åˆ›å»ºä¸€ä¸ªæ–°å®¢æˆ·ç«¯ï¼ˆä¸€ä¸ªå°†ä»Keycloakæ¥æ”¶ç”¨æˆ·çš„åº”ç”¨ç¨‹åºï¼‰ã€‚ æˆ‘ä»¬é€šè¿‡ï¼š </p><br><p>  <strong>å®¢æˆ·</strong> -&gt; <strong>åˆ›å»º</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>å®¢æˆ·ç¼–å·</strong> </td><td> <code>kubernetes</code> </td> </tr><tr><td>  <strong>è®¿é—®ç±»å‹</strong> </td><td> <code>confidenrial</code> </td> </tr><tr><td>  <strong>æ ¹URL</strong> </td><td> <code>http://kubernetes.example.org/</code> </td> </tr><tr><td>  <strong>æœ‰æ•ˆçš„é‡å®šå‘URI</strong> </td><td> <code>http://kubernetes.example.org/*</code> </td> </tr><tr><td>  <strong>ç®¡ç†å‘˜ç½‘å€</strong> </td><td> <code>http://kubernetes.example.org/</code> </td> </tr></tbody></table><br><p> è¿˜ä¸ºç»„åˆ›å»ºèŒƒå›´ï¼š </p><br><p>  <strong>å®¢æˆ·èŒƒå›´</strong> -&gt; <strong>åˆ›å»º</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>èŒƒæœ¬</strong> </td><td> <code>No template</code> </td> </tr><tr><td>  <strong>åç§°</strong> </td><td> <code>groups</code> </td> </tr><tr><td>  <strong>å®Œæ•´çš„ç¾¤ç»„è·¯å¾„</strong> </td><td> <code>false</code> </td> </tr></tbody></table><br><p> å¹¶ä¸ºå…¶é…ç½®æ˜ å°„å™¨ï¼š </p><br><p>  <strong>å®¢æˆ·èŒƒå›´</strong> -&gt; <strong>ç»„</strong> -&gt; <strong>æ˜ å°„å™¨</strong> -&gt; <strong>åˆ›å»º</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>åç§°</strong> </td><td> <code>groups</code> </td> </tr><tr><td>  <strong>æ˜ å°„å™¨ç±»å‹</strong> </td><td> <code>Group membership</code> </td> </tr><tr><td>  <strong>ä»£å¸å£°æ˜åç§°</strong> </td><td> <code>groups</code> </td> </tr></tbody></table><br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·èŒƒå›´å†…å¯ç”¨æ˜ å°„ç»„ï¼š </p><br><p>  <strong>å®¢æˆ·ç«¯</strong> -&gt; <strong>kubernetes-</strong> &gt; <strong>å®¢æˆ·ç«¯ä½œç”¨åŸŸ</strong> -&gt; <strong>é»˜è®¤å®¢æˆ·ç«¯ä½œç”¨åŸŸ</strong> </p><br><p> åœ¨â€œ <strong>å¯ç”¨çš„å®¢æˆ·èŒƒå›´â€ä¸­</strong>é€‰æ‹©<strong>ç»„</strong> ï¼Œå•å‡»â€œ <strong>æ·»åŠ æ‰€é€‰å†…å®¹â€</strong> </p><br><p> ç°åœ¨é…ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„èº«ä»½éªŒè¯ï¼Œè¯·è½¬åˆ°ï¼š </p><br><p>  <strong>å®¢æˆ·</strong> -&gt; <strong>kubernetes</strong> </p><br><table><thead><tr><th> é€‰ä»¶ </th><th> ä»·å€¼ </th></tr></thead><tbody><tr><td>  <strong>æˆæƒå·²å¯ç”¨</strong> </td><td> <code>ON</code> </td> </tr></tbody></table><br><p> å•å‡»â€œ <strong>ä¿å­˜â€</strong> ï¼Œè¿™æ ·å°±å®Œæˆäº†å®¢æˆ·ç«¯è®¾ç½®ï¼Œç°åœ¨åœ¨é€‰é¡¹å¡ä¸Š </p><br><p>  <strong>å®¢æˆ·ç«¯</strong> -&gt; <strong>kubernetes-</strong> &gt; <strong>å‡­æ®</strong> </p><br><p> æ‚¨å¯ä»¥è·å–æˆ‘ä»¬å°†æ¥å°†ä½¿ç”¨çš„<strong>Secret</strong> ã€‚ </p><br><h2 id="nastroyka-kubernetes"> é…ç½®Kubernetes </h2><br><p> é…ç½®Kubernetesè¿›è¡ŒOIDCèº«ä»½éªŒè¯éå¸¸ç®€å•ï¼Œä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ã€‚ æ‚¨éœ€è¦åšçš„åªæ˜¯å°†OIDCæœåŠ¡å™¨çš„CAè¯ä¹¦æ”¾åœ¨<code>/etc/kubernetes/pki/oidc-ca.pem</code>å¹¶ä¸ºkube-apiserveræ·»åŠ å¿…è¦çš„é€‰é¡¹ã€‚ <br> ä¸ºæ­¤ï¼Œ <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>åœ¨æ‰€æœ‰å‘å¯¼ä¸Šæ›´æ–°<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ï¼š </p><br><pre> <code class="plaintext hljs">... spec: containers: - command: - kube-apiserver ... - --oidc-ca-file=/etc/kubernetes/pki/oidc-ca.pem - --oidc-client-id=kubernetes - --oidc-groups-claim=groups - --oidc-issuer-url=https://keycloak.example.org/auth/realms/kubernetes - --oidc-username-claim=email ...</code> </pre> <br><p> å¹¶ä¸”è¿˜è¦æ›´æ–°é›†ç¾¤ä¸­çš„kubeadmé…ç½®ï¼Œä»¥å…åœ¨æ›´æ–°æ—¶ä¸¢å¤±è¿™äº›è®¾ç½®ï¼š </p><br><pre> <code class="plaintext hljs">kubectl edit -n kube-system configmaps kubeadm-config</code> </pre> <br><pre> <code class="plaintext hljs">... data: ClusterConfiguration: | apiServer: extraArgs: oidc-ca-file: /etc/kubernetes/pki/oidc-ca.pem oidc-client-id: kubernetes oidc-groups-claim: groups oidc-issuer-url: https://keycloak.example.org/auth/realms/kubernetes oidc-username-claim: email ...</code> </pre> <br><p> è¿™æ ·å°±å®Œæˆäº†Kubernetesçš„è®¾ç½®ã€‚ æ‚¨å¯ä»¥åœ¨æ‰€æœ‰Kubernetesé›†ç¾¤ä¸­é‡å¤è¿™äº›æ­¥éª¤ã€‚ </p><br><h2 id="nachalnaya-avtorizaciya"> åˆæ­¥æˆæƒ </h2><br><p> å®Œæˆè¿™äº›æ­¥éª¤åï¼Œæ‚¨å°†å·²ç»å…·æœ‰é…ç½®äº†OIDCèº«ä»½éªŒè¯çš„Kubernetesé›†ç¾¤ã€‚ å”¯ä¸€çš„ä¸€ç‚¹æ˜¯æ‚¨çš„ç”¨æˆ·è¿˜æ²¡æœ‰é…ç½®å®¢æˆ·ç«¯ä»¥åŠä»–ä»¬è‡ªå·±çš„kubeconfigã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œéœ€è¦åœ¨æˆåŠŸæˆæƒåä¸ºç”¨æˆ·é…ç½®kubeconfigçš„è‡ªåŠ¨å‘å¸ƒã€‚ </p><br><p> ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„Webåº”ç”¨ç¨‹åºæ¥å…è®¸æ‚¨å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç„¶åä¸‹è½½å®Œæˆçš„kubeconfigã€‚ æœ€æ–¹ä¾¿çš„æ–¹æ³•ä¹‹ä¸€æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberos</a> ï¼Œå®ƒä½¿æ‚¨å¯ä»¥åœ¨ä¸€ä¸ªé…ç½®ä¸­æè¿°æ‰€æœ‰Kubernetesé›†ç¾¤ï¼Œå¹¶å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´è½»æ¾åˆ‡æ¢ã€‚ </p><br><p> è¦é…ç½®Kuberosï¼Œåªéœ€æè¿°kubeconfigçš„æ¨¡æ¿å¹¶ä½¿ç”¨ä»¥ä¸‹å‚æ•°è¿è¡Œï¼š </p><br><pre> <code class="plaintext hljs">kuberos https://keycloak.example.org/auth/realms/kubernetes kubernetes /cfg/secret /cfg/template</code> </pre> <br><p> æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§åœ¨Githubä¸Šçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”¨æ³•</a> ã€‚ </p><br><p> å¦‚æœæ‚¨æƒ³ç›´æ¥åœ¨ç”¨æˆ·è®¡ç®—æœºä¸Šè¿›è¡Œæˆæƒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubelogin</a> ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†åœ¨æœ¬åœ°ä¸»æœºä¸Šæ‰“å¼€å¸¦æœ‰æˆæƒè¡¨å•çš„æµè§ˆå™¨ã€‚ </p><br><p> å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">jwt.io</a>ä¸Šæ£€æŸ¥ç”Ÿæˆçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubeconfigã€‚</a> åªéœ€å°†<code>users[].user.auth-provider.config.id-token</code>çš„<code>users[].user.auth-provider.config.id-token</code>çš„å€¼å¤åˆ¶åˆ°ç«™ç‚¹ä¸Šçš„è¡¨å•ä¸­ï¼Œå³å¯ç«‹å³è·å¾—è§£å¯†ã€‚ </p><br><h2 id="nastroyka-rbac">  RBACè®¾ç½® </h2><br><p> è®¾ç½®RBACæ—¶ï¼Œå¯ä»¥åŒæ—¶å¼•ç”¨ç”¨æˆ·åï¼ˆjwtä»¤ç‰Œä¸­çš„<code>name</code>å­—æ®µï¼‰å’Œç”¨æˆ·ç»„ï¼ˆjwtä»¤ç‰Œä¸­çš„<code>groups</code>å­—æ®µï¼‰ã€‚ è¿™æ˜¯ä¸º<code>kubernetes-default-namespace-admins</code>ç»„è®¾ç½®æƒé™çš„ç¤ºä¾‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">kubernetes-é»˜è®¤åç§°ç©ºé—´-admins.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: default-admins namespace: default rules: - apiGroups: - '*' resources: - '*' verbs: - '*' --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: kubernetes-default-namespace-admins namespace: default roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: default-admins subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: kubernetes-default-namespace-admins</code> </pre> </div></div><br><p> å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberneteså®˜æ–¹æ–‡æ¡£ä¸­</a>æ‰¾åˆ°æœ‰å…³RBACçš„æ›´å¤šç¤ºä¾‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a> </p><br><h2 id="nastroyka-auth-proxy"> é…ç½®èº«ä»½éªŒè¯ä»£ç† </h2><br><p> æœ‰ä¸€ä¸ªå¾ˆæ£’çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">keycloak-gatekeeper</a>é¡¹ç›®ï¼Œå®ƒä½¿æ‚¨å¯ä»¥ä¿æŠ¤ä»»ä½•åº”ç”¨ç¨‹åºï¼Œå¹¶ä½¿ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡OIDCæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚ æˆ‘å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨Kubernetesä»ªè¡¨æ¿ä½œä¸ºç¤ºä¾‹è¿›è¡Œé…ç½®ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»ªè¡¨æ¿ä»£ç†</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: kubernetes-dashboard-proxy spec: replicas: 1 template: metadata: labels: app: kubernetes-dashboard-proxy spec: containers: - args: - --listen=0.0.0.0:80 - --discovery-url=https://keycloak.example.org/auth/realms/kubernetes - --client-id=kubernetes - --client-secret=&lt;your-client-secret-here&gt; - --redirection-url=https://kubernetes-dashboard.example.org - --enable-refresh-tokens=true - --encryption-key=ooTh6Chei1eefooyovai5ohwienuquoh - --upstream-url=https://kubernetes-dashboard.kube-system - --resources=uri=/* image: keycloak/keycloak-gatekeeper name: kubernetes-dashboard-proxy ports: - containerPort: 80 livenessProbe: httpGet: path: /oauth/health port: 80 initialDelaySeconds: 3 timeoutSeconds: 2 readinessProbe: httpGet: path: /oauth/health port: 80 initialDelaySeconds: 3 timeoutSeconds: 2 --- apiVersion: v1 kind: Service metadata: name: kubernetes-dashboard-proxy spec: ports: - port: 80 protocol: TCP targetPort: 80 selector: app: kubernetes-dashboard-proxy type: ClusterIP</code> </pre> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441112/">https://habr.com/ru/post/zh-CN441112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441096/index.html">æ¨¡æ‹Ÿå™¨é˜…è¯»æ–‡ç« </a></li>
<li><a href="../zh-CN441098/index.html">SIEMæ·±åº¦ï¼šç°æˆçš„ç›¸å…³æ€§ã€‚ ç¬¬4éƒ¨åˆ†ã€‚ç³»ç»Ÿæ¨¡å‹ä½œä¸ºå…³è”è§„åˆ™çš„ä¸Šä¸‹æ–‡</a></li>
<li><a href="../zh-CN441102/index.html">å¡å·´æ–¯åŸºæ‰‹æœºæŠ€æœ¯è®²åº§-é¢å‘é«˜çº§å¼€å‘äººå‘˜çš„ä¼šè®®</a></li>
<li><a href="../zh-CN441104/index.html">ä»TOP-10ï¼ˆä¹Œå…‹å…°ï¼‰è·å–ä¿¡æ¯å¹¶ç»•è¿‡é“¶è¡Œå¡çš„ä¸¤å› ç´ èº«ä»½éªŒè¯</a></li>
<li><a href="../zh-CN441108/index.html">å·²ç»ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼šä¸‰æ˜Ÿä»¥1980ç¾å…ƒçš„ä»·æ ¼æ¨å‡ºäº†Galaxy FoldæŠ˜å å¼æ‰‹æœº</a></li>
<li><a href="../zh-CN441114/index.html">å…³ç³»ç¼–ç¨‹ï¼šç—›è‹¦ï¼Œå…´è¶£å’Œå†æ¬¡ç—›è‹¦</a></li>
<li><a href="../zh-CN441116/index.html">KubeSailåŠå…¶é¢å‘å¼€å‘äººå‘˜çš„å…è´¹Kubernetesé›†ç¾¤</a></li>
<li><a href="../zh-CN441118/index.html">æ–°è¥¿å…°ä¸Šç­æ—æ¯å‘¨å·¥ä½œå››å¤©çš„å®éªŒç»“æœ</a></li>
<li><a href="../zh-CN441122/index.html">Magento 2 EAVï¼šæ•°æ®ç»“æ„æ¦‚è¿°</a></li>
<li><a href="../zh-CN441124/index.html">PVS-Studioä¸­çš„è¯¯æŠ¥ï¼šå…”å­æ´æœ‰å¤šæ·±</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>