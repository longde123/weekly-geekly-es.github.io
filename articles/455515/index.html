<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê® üåÇ ‚ôæ Invertir y piratear el HDD externo de autocifrado de Aigo. Parte 1: disecci√≥n en partes ü•° üêÅ üéôÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Invertir y piratear discos externos de autocifrado es mi antiguo pasatiempo. En el pasado, sol√≠a practicar con modelos como el Zalman VE-400, Zalman Z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Invertir y piratear el HDD externo de autocifrado de Aigo. Parte 1: disecci√≥n en partes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455515/"><p>  Invertir y piratear discos externos de autocifrado es mi antiguo pasatiempo.  En el pasado, sol√≠a practicar con modelos como el Zalman VE-400, Zalman ZM-SHE500, Zalman ZM-VE500.  M√°s recientemente, un colega me trajo otra exhibici√≥n: Patriot (Aigo) SK8671, que est√° construida de acuerdo con un dise√±o t√≠pico: un indicador LCD y un teclado para ingresar un c√≥digo PIN.  Esto es lo que sali√≥ de eso ... </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1. Introducci√≥n</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2. Arquitectura de hardware</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 2.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tablero principal</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 2.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tablero LCD</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 2.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tablero de teclado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 2.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nos fijamos en los cables</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3. La secuencia de pasos de ataque.</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 3.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Elimine el volcado de datos de la unidad flash SPI</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">- 3.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Olfatear la comunicaci√≥n</a> </p><br><p><img src="https://habrastorage.org/webt/wx/nm/gk/wxnmgkeurrmiurx87rujoynxrsq.jpeg"></p><a name="habracut"></a><br><a name="a1"></a><br><h1 id="1-vvedenie">  1. Introducci√≥n </h1><br><p><img src="https://habrastorage.org/webt/rb/oq/4n/rboq4nvybyfanowvledmkbcfyww.jpeg"><br>  <em>Vivienda</em> </p><br><p><img src="https://habrastorage.org/webt/n8/cu/bd/n8cubdbf1sr0ejoafvh9qktfdiy.jpeg"><br>  <em>Embalaje</em> </p><br><p>  El acceso a los datos almacenados en el disco, que supuestamente est√° cifrado, se realiza despu√©s de ingresar el c√≥digo PIN.  Algunas notas introductorias sobre este dispositivo: </p><br><ul><li>  Para cambiar el c√≥digo PIN, presione F1 antes de desbloquear; </li><li>  El c√≥digo PIN debe tener entre 6 y 9 d√≠gitos; </li><li>  Despu√©s de 15 intentos incorrectos, el disco se borra. </li></ul><br><a name="a2"></a><br><h1 id="2-apparatnaya-arhitektura">  2. Arquitectura de hardware </h1><br><p>  Primero, preparamos el dispositivo en partes para comprender en qu√© componentes est√° compuesto.  La tarea m√°s tediosa es abrir el estuche: muchos dientes microsc√≥picos y pl√°stico.  Una vez abierto el caso, vemos lo siguiente (preste atenci√≥n al conector de cinco pines soldado por m√≠): </p><br><p><img src="https://habrastorage.org/webt/wf/yy/6m/wfyy6mnjauhszmkgkukchy3q5yk.jpeg"></p><br><a name="a21"></a><br><h2 id="21-osnovnaya-plata">  2.1.  Tablero principal </h2><br><p>  El tablero principal es bastante simple: </p><br><p><img src="https://habrastorage.org/webt/69/n6/da/69n6dayylddfb1cbhpytgbl4y5y.jpeg"></p><br><p>  Sus partes m√°s notables (ver de arriba a abajo): </p><br><ul><li>  Conector LCD (CN1); </li><li>  tweeter (SP1); </li><li>  Unidad flash SPI Pm25LD010 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">especificaci√≥n</a> ) (U2); </li><li>  Controlador Jmicron JMS539 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">especificaci√≥n</a> ) para USB-SATA (U1); </li><li>  Conector USB 3 (J1). </li></ul><br><p>  La unidad flash SPI almacena el firmware para el JMS539 y algunas configuraciones. </p><br><a name="a22"></a><br><h2 id="22-plata-zhk-indikatora">  2.2.  Tablero LCD </h2><br><p>  No hay nada notable en la placa LCD. </p><br><p><img src="https://habrastorage.org/webt/jd/49/fl/jd49flekfpte0q31hl6nv3pfcbo.jpeg"><br><img src="https://habrastorage.org/webt/qs/j_/vc/qsj_vchcmyj0eigmolvy-10mrh0.jpeg"></p><br><p>  Solo: </p><br><ul><li>  Indicador LCD de origen desconocido (probablemente con un conjunto de fuentes chino);  con control secuencial; </li><li>  conector de cinta para tablero de teclado. </li></ul><br><a name="a23"></a><br><h2 id="23-klaviaturnaya-plata">  2.3.  Tablero de teclado </h2><br><p>  Cuando miras el tablero del teclado, las cosas adquieren un giro m√°s interesante. </p><br><p><img src="https://habrastorage.org/webt/qh/gr/df/qhgrdfppixqecphruejzkdtd0_g.jpeg"></p><br><p>  Aqu√≠, en la parte posterior, vemos el conector de cinta, as√≠ como el Cypress CY8C21434, el microcontrolador PSoC 1 (en lo sucesivo denominado simplemente PSoC) </p><br><p><img src="https://habrastorage.org/webt/bm/bs/ly/bmbslyrwh20yn47te073qtleiw0.jpeg"></p><br><p>  CY8C21434 utiliza el conjunto de instrucciones M8C (ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> ).  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la p√°gina del producto, se</a> indica que es compatible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con la</a> tecnolog√≠a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CapSense</a> (una soluci√≥n de Cypress para teclados capacitivos).  Aqu√≠ puedo ver el conector de cinco pines soldado por m√≠: este es un enfoque est√°ndar para conectar un programador externo a trav√©s de la interfaz ISSP. </p><br><a name="a24"></a><br><h2 id="24-smotrim-na-provoda">  2.4.  Nos fijamos en los cables </h2><br><p>  Veamos qu√© est√° relacionado con esto.  Para hacer esto, es suficiente hacer sonar los cables con un mult√≠metro: </p><br><p><img src="https://habrastorage.org/webt/wa/ox/uz/waoxuzmwczjnhtih625bqj6myga.png"></p><br><p>  Explicaciones para este diagrama dibujado a la rodilla: </p><br><ul><li>  PSoC se describe en la especificaci√≥n t√©cnica; </li><li>  el siguiente conector, el de la derecha, es una interfaz ISSP que, por voluntad del destino, corresponde a lo que se escribe sobre √©l en Internet; </li><li>  el conector de la derecha es un terminal para un conector de cinta con una placa de teclado; </li><li>  El rect√°ngulo negro es un dibujo del conector CN1, dise√±ado para conectar la placa principal a la placa LCD.  P11, P13 y P4: conectados a las patas PSoC 11, 13 y 4, en la placa LCD. </li></ul><br><a name="a3"></a><br><h1 id="3-posledovatelnost-shagov-ataki">  3. La secuencia de pasos de ataque. </h1><br><p>  Ahora que sabemos en qu√© componentes est√° compuesta esta unidad, necesitamos: 1) asegurarnos de que la funcionalidad b√°sica de cifrado est√© realmente presente;  2) averiguar c√≥mo se generan / almacenan las claves de cifrado;  3) encuentre d√≥nde se verifica exactamente el c√≥digo PIN. </p><br><p>  Para hacer esto, he realizado los siguientes pasos: </p><br><ul><li>  elimin√≥ un volcado de datos de una unidad flash SPI; </li><li>  Trat√© de eliminar el volcado de datos de la unidad flash PSoC; </li><li>  se asegur√≥ de que el intercambio de datos entre Cypress PSoC y JMS539 realmente contenga las teclas presionadas; </li><li>  se asegur√≥ de que al cambiar la contrase√±a, no se sobrescriba nada en la unidad flash SPI; </li><li>  era demasiado vago para revertir el firmware 8051 de JMS539. </li></ul><br><a name="a31"></a><br><h2 id="31-snimaem-damp-dannyh-spi-fleshki">  3.1.  Elimine el volcado de datos de la unidad flash SPI </h2><br><p>  Este procedimiento es muy simple: </p><br><ul><li>  conecte las sondas a las patas de la unidad flash: CLK, MOSI, MISO y (opcionalmente) EN; </li><li>  Comunicaciones ‚ÄúSniff‚Äù usando un sniffer usando un analizador l√≥gico (us√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Saleae Logic Pro 16</a> ); </li><li>  decodifica el protocolo SPI y exporta los resultados a CSV; </li><li>  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">decode_spi.rb</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">analizar</a> los resultados y obtener un volcado. </li></ul><br><p>  Tenga en cuenta que este enfoque en el caso del controlador JMS539 funciona especialmente bien, ya que este controlador carga todo el firmware desde la unidad flash USB durante la fase de inicializaci√≥n. </p><br><pre><code class="plaintext hljs">$ decode_spi.rb boot_spi1.csv dump 0.039776 : WRITE DISABLE 0.039777 : JEDEC READ ID 0.039784 : ID 0x7f 0x9d 0x21 --------------------- 0.039788 : READ @ 0x0 0x12,0x42,0x00,0xd3,0x22,0x00, [...] $ ls --size --block-size=1 dump 49152 dump $ sha1sum dump 3d9db0dde7b4aadd2b7705a46b5d04e1a1f3b125 dump</code> </pre> <br><p>  Despu√©s de eliminar el volcado de la unidad flash SPI, llegu√© a la conclusi√≥n de que su √∫nica tarea es almacenar el firmware para la unidad de control JMicron, que est√° integrada en el microcontrolador 8051.  Desafortunadamente, volcar la unidad flash SPI result√≥ in√∫til: </p><br><ul><li>  Al cambiar el c√≥digo PIN, el volcado de la unidad flash permanece igual; </li><li>  despu√©s de la etapa de inicializaci√≥n, el dispositivo no accede a la unidad flash SPI. </li></ul><br><a name="a32"></a><br><h2 id="32-obnyuhivaem-kommunikacii">  3.2.  Olfatear la comunicaci√≥n </h2><br><p>  Esta es una forma de encontrar qu√© chip es responsable de verificar las comunicaciones por el tiempo / contenido de inter√©s.  Como ya sabemos, el controlador USB-SATA est√° conectado a la pantalla LCD Cypress PSoC a trav√©s del conector CN1 y dos cintas.  Por lo tanto, conectamos las sondas a las tres patas correspondientes: </p><br><ul><li>  P4, entrada / salida general; </li><li>  P11, I2C SCL; </li><li>  P13, I2C SDA. </li></ul><br><p><img src="https://habrastorage.org/webt/dx/pf/gt/dxpfgtrawhj8ddziq_evoclmrs0.jpeg"></p><br><p>  Luego iniciamos el analizador l√≥gico Saleae e ingresamos en el teclado: "123456 ~".  Como resultado, vemos el siguiente diagrama. </p><br><p><img src="https://habrastorage.org/webt/ai/d9/dg/aid9dgvtwdzzsgkzgbnwgvlxnya.png"></p><br><p>  En √©l podemos ver tres canales de intercambio de datos: </p><br><ul><li>  el canal P4 tiene varias r√°fagas cortas; </li><li>  en P11 y P13: intercambio de datos casi continuo. </li></ul><br><p>  Al aumentar la primera r√°faga en el canal P4 (el rect√°ngulo azul de la figura anterior), vemos lo siguiente: </p><br><p><img src="https://habrastorage.org/webt/_v/iu/yi/_viuyiqhajm685cu9yc2rrwxoem.png"></p><br><p>  Aqu√≠ puede ver que en P4 hay casi 70 ms de una se√±al uniforme, que, como me pareci√≥ al principio, desempe√±a el papel de una se√±al de reloj.  Sin embargo, despu√©s de pasar alg√∫n tiempo tratando de verificar mi presentimiento, descubr√≠ que no se trata de una se√±al de reloj, sino de una transmisi√≥n de audio que se emite al chirrido cuando presiona las teclas.  Por lo tanto, esta secci√≥n de se√±al en s√≠ no contiene informaci√≥n √∫til para nosotros.  Sin embargo, se puede usar como un indicador para saber el momento en que el PSoC registra una pulsaci√≥n de tecla. </p><br><p>  Sin embargo, la √∫ltima transmisi√≥n de audio del canal P4 es ligeramente diferente de las dem√°s: ¬°este es el sonido para el "c√≥digo PIN incorrecto"! </p><br><p>  Volviendo al diagrama de pulsaciones de teclas, al aumentar el diagrama de la √∫ltima secuencia de audio (ver nuevamente el rect√°ngulo azul) obtenemos: </p><br><p><img src="https://habrastorage.org/webt/vs/e7/tl/vse7tleuvfbpoybhymvb5bsm-rw.png"></p><br><p>  Aqu√≠ vemos se√±ales mon√≥tonas en P11.  Entonces parece que este es el reloj.  Y P13 son datos.  Observe c√≥mo cambia el patr√≥n despu√©s del final del pitido.  Ser√≠a interesante ver lo que est√° sucediendo aqu√≠. </p><br><p>  Los protocolos que funcionan con dos cables suelen ser SPI o I2C, y la especificaci√≥n t√©cnica de Cypress dice que estos contactos corresponden a I2C, que, como vemos, es cierto para nuestro caso: </p><br><p><img src="https://habrastorage.org/webt/bc/pj/hy/bcpjhy-jy0c-tn6t5kuwkdgpjbi.png"></p><br><p>  El chipset USB-SATA sondea constantemente el PSoC para leer el estado clave, que por defecto es "0".  Luego, cuando presiona la tecla "1", cambia a "1".  La transmisi√≥n final, inmediatamente despu√©s de presionar "~", es diferente si se ingresa un c√≥digo PIN incorrecto.  Sin embargo, en este momento no verifiqu√© lo que realmente se transmiti√≥ all√≠.  Pero sospecho que esto no es una clave de cifrado.  De todos modos, consulte la siguiente secci√≥n para comprender c√≥mo elimin√© el volcado del firmware interno de PSoC. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/455515/">https://habr.com/ru/post/455515/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455505/index.html">Reaccionar la aceleraci√≥n de la aplicaci√≥n cuatro veces</a></li>
<li><a href="../455507/index.html">Descripci√≥n general del paquete Datatable Python</a></li>
<li><a href="../455509/index.html">La historia de por qu√© sigo usando jQuery</a></li>
<li><a href="../455511/index.html">El sue√±o es el principal recurso para el cerebro de un programador.</a></li>
<li><a href="../455513/index.html">La explosi√≥n y la conspiraci√≥n global: la historia de la creaci√≥n de bater√≠as de iones de litio</a></li>
<li><a href="../455517/index.html">Graduado del curso de Netolog√≠a ‚ÄúData Science‚Äù sobre su trabajo en el sector bancario.</a></li>
<li><a href="../455519/index.html">C√≥mo implementamos la incorporaci√≥n de nuevos desarrolladores</a></li>
<li><a href="../455523/index.html">Implementaci√≥n de la interfaz de usuario de OpenStack LBaaS</a></li>
<li><a href="../455525/index.html">Zimbra y Mail Bomb Defense</a></li>
<li><a href="../455527/index.html">¬øQu√© est√° escrito en esto? Detr√°s de escena de objetos JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>