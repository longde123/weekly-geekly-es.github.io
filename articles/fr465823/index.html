<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¶ üóº üìí Op√©rateur Tarantool Kubernetes üßú üèá ü§¥üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes devient la norme de facto pour l'ex√©cution d'applications sans √©tat. Principalement parce qu'il peut r√©duire consid√©rablement le d√©lai de m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Op√©rateur Tarantool Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/465823/"><img src="https://habrastorage.org/webt/pm/mm/lk/pmmmlkexzrcniami66ljv1ynirg.jpeg"><br><br>  Kubernetes devient la norme de facto pour l'ex√©cution d'applications sans √©tat.  Principalement parce qu'il peut r√©duire consid√©rablement le d√©lai de mise sur le march√© pour la livraison de nouvelles fonctionnalit√©s.  Le lancement d'applications avec √©tat - bases de donn√©es, microservices avec √©tat - est toujours une t√¢che difficile, mais la n√©cessit√© de r√©sister √† la concurrence et de maintenir un taux de livraison √©lev√© pousse les entreprises √† exp√©rimenter dans ce domaine et cr√©e une demande pour de telles solutions. <br><br>  Nous vous pr√©sentons notre solution pour le lancement de clusters avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tat Cartouche</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool Kubernetes Operator</a> , pour plus de d√©tails je demande sous cat. <br><a name="habracut"></a><br>  Table des mati√®res: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Au lieu de mille mots</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Que fait l'op√©rateur du tout</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un peu sur les nuances</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment fonctionne l'op√©rateur</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ce que l'op√©rateur √©tend</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©sum√©</a> </li></ol><br><br>  Tarantool est une base de donn√©es open source et un serveur d'applications dans un seul paquet.  En tant que base de donn√©es, elle pr√©sente un certain nombre de caract√©ristiques uniques: une efficacit√© √©lev√©e d'utilisation du fer, un sch√©ma de donn√©es flexible, la prise en charge du stockage en m√©moire et sur disque et la possibilit√© d'extension gr√¢ce √† l'utilisation du langage Lua.  En tant que serveur d'applications, il vous permet de d√©placer le code d'application aussi pr√®s que possible des donn√©es, tout en obtenant un temps de r√©ponse minimal et un d√©bit maximal.  De plus, Tarantool dispose d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un √©cosyst√®me √©tendu</a> , fournissant des modules pr√™ts √† l'emploi pour r√©soudre les probl√®mes d'application: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partitionnement</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">file d'attente</a> , modules pour faciliter le d√©veloppement ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cartouche</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">luatest</a> ), solutions de fonctionnement ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√©triques</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ansible</a> ) - ce ne sont que quelques exemples. <br><br>  Pour tous ses avantages, les capacit√©s d'une seule instance de Tarantool ne sont pas illimit√©es: pour stocker des t√©raoctets de donn√©es et traiter des millions de demandes, vous devez g√©n√©rer des dizaines et des centaines d'instances, et c'est un syst√®me distribu√©, avec tous ses probl√®mes inh√©rents.  Pour les r√©soudre, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tarantool Cartridge</a> , un framework dont la t√¢che principale est de cacher toutes sortes de difficult√©s dans l'√©criture d'applications distribu√©es et de permettre aux d√©veloppeurs de se concentrer sur la valeur commerciale de l'application.  La cartouche fournit un ensemble puissant de composants pour l'orchestration automatique des clusters, la distribution automatique des donn√©es, les outils Web de fonctionnement et de d√©veloppement. <br><br>  Tarantool n'est pas seulement une technologie, mais aussi une √©quipe d'ing√©nieurs qui sont engag√©s dans le d√©veloppement de syst√®mes d'entreprise cl√© en main, de solutions de bo√Ætiers et de support pour les composants open source. <br><br>  Globalement, nos t√¢ches peuvent √™tre divis√©es en deux domaines: le d√©veloppement de nouveaux syst√®mes et l'augmentation des solutions existantes.  Par exemple, il existe une grande base d'un fournisseur c√©l√®bre.  Pour le mettre √† l'√©chelle pour la lecture, ils ont mis un cache finalement coh√©rent sur Tarantool derri√®re lui.  Ou vice versa: afin de mettre √† l'√©chelle l'enregistrement, ils placent Tarantool dans la configuration chaud / froid, o√π au fur et √† mesure qu'ils ¬´refroidissent¬ª, les donn√©es sont transf√©r√©es vers le stockage froid et en parall√®le dans la file d'attente d'analyse.  Ou pour sauvegarder un syst√®me existant, une version all√©g√©e de ce syst√®me (r√©serve fonctionnelle) est √©crite, qui r√©serve le principal ¬´√† chaud¬ª avec la r√©plication des donn√©es du syst√®me principal.  Plus d'informations peuvent √™tre trouv√©es dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapports de T + 2019</a> . <br><br>  Tous ces syst√®mes ont une chose en commun: ils sont assez difficiles √† utiliser.  D√©ployez rapidement un cluster de plus de 100 instances avec redondance dans 3 centres de donn√©es, mettez √† jour l'application qui stocke les donn√©es sans interruption de service et sans maintenance, effectuez une restauration de sauvegarde en cas de catastrophe ou d'erreurs d'origine humaine, assurez le basculement discret des composants, organisez la gestion de la configuration ... En g√©n√©ral, une tonne int√©ressant. <br><br>  Et ce serait formidable que tout cela soit toujours aussi simple √† d√©velopper.  Kubernetes permet d'atteindre le r√©sultat souhait√©, mais l'utilisation d'un op√©rateur sp√©cialis√© rend la vie encore plus facile. <br><br><a name="1"></a><h2>  Au lieu de mille mots </h2><br>  Nous avons pr√©par√© un petit exemple bas√© sur la cartouche Tarantool, et nous travaillerons avec.  Une application simple comme ¬´stockage de valeur de cl√© distribu√© avec interface HTTP¬ª.  Apr√®s le lancement, nous obtenons cette image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c24/235/2c7/c242352c708a0e0dfa8fc0896bbb986d.png"><br><br>  O√π: <br><br><ul><li>  Routeurs - la partie du cluster qui est responsable de l'acceptation et du traitement des requ√™tes HTTP entrantes; <br></li><li>  Le stockage est la partie du cluster qui est responsable du stockage et du traitement des donn√©es, 3 √©clats sortent de la bo√Æte, dans chaque ma√Ætre et r√©plique. <br></li></ul><br>  Pour √©quilibrer le trafic HTTP entrant sur les routeurs, l'entr√©e Kubernetian est utilis√©e.  Les donn√©es sont distribu√©es en stockage au niveau de Tarantool lui-m√™me √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'</a> aide <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">du composant vshard</a> . <br><br>  Nous avons besoin de kubernetes 1.14+, minikube <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctionnera</a> .  De plus, la disponibilit√© de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kubectl</a> ne fera pas de mal.  Pour d√©marrer l'op√©rateur, vous devez cr√©er un ServiceAccount, Role et RoleBinding pour celui-ci: <br><br><pre><code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/service_account.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role_binding.yaml</code> </pre> <br>  Tarantool Operator √©tend l'API Kubernetes avec ses d√©finitions de ressources, nous allons les cr√©er: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_cluster_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_role_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_replicasettemplate_crd.yaml</code> </pre> <br>  Tout est pr√™t pour lancer l'op√©rateur, c'est parti: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/operator.yaml</code> </pre> <br>  Nous attendons le d√©marrage de l'op√©rateur, et nous pouvons proc√©der au lancement de l'application: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/examples/kv/deployment.yaml</code> </pre> <br>  Dans le fichier yaml avec l'exemple, Ingress est d√©clar√© sur l'interface utilisateur Web;  il est disponible sur <code>cluster_ip/admin/cluster</code> .  Lorsqu'au moins un pod d'Ingress est en place, vous pouvez vous y rendre et voir comment de nouvelles instances sont ajout√©es au cluster et comment sa topologie change. <br><br>  Nous attendons que le cluster soit utilis√©: <br><br><pre> <code class="bash hljs">$ kubectl describe clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  Nous pr√©voyons que dans l'√©tat du cluster, il y aura les √©l√©ments suivants: <br><br><pre> <code class="plaintext hljs">‚Ä¶ Status: State: Ready ‚Ä¶</code> </pre> <br>  Tout, l'application est pr√™te √† l'emploi! <br><br>  Besoin de plus d'espace de stockage?  Ajouter des fragments: <br><br><pre> <code class="bash hljs">$ kubectl scale roles.tarantool.io storage --replicas=3</code> </pre> <br>  Les √©clats ne peuvent pas faire face √† la charge?  Augmentez le nombre d'instances dans le fragment en modifiant le mod√®le de jeu de r√©plicas: <br><br><pre> <code class="bash hljs">$ kubectl edit replicasettemplates.tarantool.io storage-template</code> </pre> <br>  D√©finissez <code>.spec.replicas</code> , par exemple 2, pour augmenter le nombre d'instances dans chaque jeu de r√©plicas √† deux. <br><br>  Un cluster n'est plus n√©cessaire?  Nous le supprimons avec toutes les ressources: <br><br><pre> <code class="bash hljs">$ kubectl delete clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  Quelque chose a mal tourn√©?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Marquez le ticket</a> , nous allons rapidement le d√©monter.  :) <br><br><a name="2"></a><h2>  Que fait l'op√©rateur du tout </h2><br>  Le lancement et le fonctionnement du cluster Tarantool Cartridge est l'histoire de l'ex√©cution de certaines actions, dans un ordre sp√©cifique, √† un certain moment. <br><br>  Le cluster lui-m√™me est g√©r√© principalement via l'API d'administration: GraphQL sur HTTP.  Vous pouvez bien s√ªr descendre √† un niveau inf√©rieur et ex√©cuter des commandes directement dans la console, mais cela se produit rarement.  Par exemple, voici comment le cluster d√©marre: <br><br><ol><li>  Nous augmentons le nombre requis d'instances de Tarantool, par exemple, sous systemd. <br></li><li>  Fusionner des instances en appartenance: <br><br><pre> <code class="plaintext hljs">mutation { probe_instance: probe_server(uri: "storage:3301") }</code> </pre> <br></li><li>  Attribuez des r√¥les aux instances, prescrivez des identificateurs d'instance et de jeu de r√©plicas.  L'API GraphQL est √©galement utilis√©e pour cela: <br><br><pre> <code class="plaintext hljs">mutation { join_server( uri:"storage:3301", instance_uuid: "cccccccc-cccc-4000-b000-000000000001", replicaset_uuid: "cccccccc-0000-4000-b000-000000000000", roles: ["storage"], timeout: 5 ) }</code> </pre> <br></li><li>  Nous effectuons le bootstrap du composant responsable du sharding.  Aussi via l'API: <br><br><pre> <code class="plaintext hljs">mutation { bootstrap_vshard cluster { failover(enabled:true) } }</code> </pre> <br></li></ol><br>  Facile, non? <br><br>  Tout devient plus int√©ressant lorsqu'il s'agit d'√©tendre un cluster.  Le r√¥le des routeurs de l'exemple varie simplement: augmentez le nombre d'instances, connectez-les √† un cluster existant - vous avez termin√©!  Le r√¥le des stockages est quelque peu plus d√©licat.  Le stockage est fragment√©, donc lors de l'ajout / suppression d'instances, il est n√©cessaire de r√©√©quilibrer les donn√©es pour les d√©placer vers de nouvelles instances / pour passer des instances supprim√©es.  Si cela n'est pas fait, dans un cas, nous obtenons des instances sous-charg√©es, dans le second - nous perdons des donn√©es.  Et si ce n'est pas un, mais une douzaine de tels clusters avec des topologies diff√©rentes sont en fonctionnement? <br><br>  En g√©n√©ral, Tarantool Operator est occup√© par tout cela.  L'utilisateur d√©crit l'√©tat souhait√© du cluster de cartouches Tarantool, et l'op√©rateur le traduit en un ensemble d'actions sur les ressources k8s et en certains appels √† l'API d'administration du cluster Tarantool dans un ordre sp√©cifique, √† un certain moment, et essaie g√©n√©ralement de cacher toutes les nuances √† l'utilisateur. <br><br><a name="3"></a><h2>  Un peu sur les nuances </h2><br>  Lorsque vous travaillez avec l'API du cluster d'administration Tarantool Cartridge, √† la fois l'ordre des appels et leur provenance est important.  Pourquoi <br><br>  Tarantool Cartridge transporte son r√©f√©rentiel de topologie, son composant de d√©couverte de service et son composant de configuration.  Chaque instance du cluster stocke une copie de la topologie et de la configuration dans un fichier yaml. <br><br><pre> <code class="plaintext hljs">servers: d8a9ce19-a880-5757-9ae0-6a0959525842: uri: storage-2-0.examples-kv-cluster:3301 replicaset_uuid: 8cf044f2-cae0-519b-8d08-00a2f1173fcb 497762e2-02a1-583e-8f51-5610375ebae9: uri: storage-0-0.examples-kv-cluster:3301 replicaset_uuid: 05e42b64-fa81-59e6-beb2-95d84c22a435 ‚Ä¶ vshard: bucket_count: 30000 ...</code> </pre> <br>  La mise √† jour se produit de concert √† l'aide du m√©canisme de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">validation en deux phases</a> .  Une mise √† niveau r√©ussie n√©cessite un quorum de 100%: chaque instance doit r√©pondre, sinon annulation.  Qu'est-ce que cela signifie en termes de fonctionnement?  Toutes les demandes adress√©es √† l'API d'administration modifiant l'√©tat du cluster sont les plus fiables √† envoyer √† une instance, au leader, sinon nous courons le risque d'obtenir diff√©rentes configurations sur diff√©rentes instances.  Tarantool Cartridge ne sait pas comment faire une √©lection de leader (mais ne sait pas comment), mais Tarantool Operator peut - et vous ne pouvez le savoir que comme un fait amusant, car l'op√©rateur va tout g√¢cher. <br><br>  De plus, chaque instance doit avoir une identit√© fixe, c'est-√†-dire un ensemble d' <code>instance_uuid</code> et <code>replicaset_uuid</code> , ainsi que <code>advertise_uri</code> .  Si le stockage red√©marre soudainement et que l'un de ces param√®tres change, vous courez le risque de casser le quorum - l'op√©rateur le fait √©galement. <br><br><a name="4"></a><h2>  Comment fonctionne l'op√©rateur </h2><br>  La t√¢che de l'op√©rateur est d'amener le syst√®me dans l'√©tat d√©fini par l'utilisateur et de maintenir le syst√®me dans cet √©tat jusqu'√† ce que de nouvelles directions soient re√ßues.  Pour que l'op√©rateur puisse effectuer son travail, il a besoin: <br><br><ol><li>  Description de l'√©tat du syst√®me. <br></li><li>  Le code qui am√®ne le syst√®me √† cet √©tat. <br></li><li>  Un m√©canisme pour int√©grer ce code dans les k8 (par exemple, pour recevoir des notifications de changements d'√©tat). <br></li></ol><br>  Le cluster de cartouches Tarantool est d√©crit en termes de k8 √† travers une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©finition de ressource personnalis√©e (CRD)</a> ;  l'op√©rateur a besoin de 3 ressources personnalis√©es de ce type, r√©unies sous le groupe tarantool.io/v1alpha: <br><br><ul><li>  Le cluster est une ressource de niveau sup√©rieur qui correspond √† un cluster de cartouches Tarantool. <br></li><li>  R√¥le - en termes de cartouche Tarantool, il s'agit d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√¥le utilisateur</a> . <br></li><li>  ReplicasetTemplate - un mod√®le par lequel des StatefulSets seront cr√©√©s (pourquoi stateful - je vous le dirai un peu plus tard; √† ne pas confondre avec k8s ReplicaSet). <br></li></ul><br>  Toutes ces ressources refl√®tent directement le mod√®le de description du cluster de cartouches Tarantool.  Ayant un dictionnaire commun, il est plus facile pour un op√©rateur de communiquer avec les d√©veloppeurs et de comprendre ce qu'ils veulent voir dans le prod. <br><br>  Le code qui am√®ne le syst√®me √† l'√©tat donn√© - en termes de k8, c'est Controller.  Dans le cas de l'op√©rateur Tarantool, il existe plusieurs contr√¥leurs: <br><br><ul><li>  ClusterController - est responsable de l'interaction avec le cluster Tarantool Cartridge, connecte les instances au cluster, d√©connecte les instances du cluster. <br></li><li>  RoleController est un contr√¥leur de r√¥le utilisateur, il est responsable du d√©ploiement des StatefulSets √† partir d'un mod√®le et du maintien de leur num√©ro dans un num√©ro donn√©. <br></li></ul><br>  √Ä quoi ressemble un contr√¥leur?  Un ensemble de code qui ram√®ne progressivement le monde autour de vous.  ClusterController peut √™tre sch√©matiquement repr√©sent√© comme ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/132/1d2/317/1321d23173a37f65743fcc0ee4d48ad2.png"><br><br>  Un point d'entr√©e est une v√©rification pour voir si une ressource de cluster existe par rapport √† laquelle l'√©v√©nement s'est produit.  N'existe pas?  Nous partons.  Y a-t-il?  Nous passons au bloc suivant: saisir la propri√©t√© sur les r√¥les d'utilisateur.  Captur√© un - √† gauche, sur le deuxi√®me cercle, nous capturons le second.  Et ainsi de suite, jusqu'√† ce que nous capturions tout.  Tous les r√¥les sont-ils captur√©s?  Passez donc au bloc d'op√©rations suivant.  Et ainsi, jusqu'√† ce que nous arrivions au dernier;  on peut alors supposer que le syst√®me contr√¥l√© est dans un √©tat donn√©. <br><br>  En g√©n√©ral, tout est simple.  Il est important de d√©terminer les crit√®res de r√©ussite pour r√©ussir chaque √©tape.  Par exemple, nous consid√©rons comme r√©ussie l'op√©ration de rejoindre un cluster non pas quand il a renvoy√© conditionnel success = true, mais quand il a renvoy√© une erreur comme "d√©j√† joint". <br><br>  Et la derni√®re partie de ce m√©canisme est l'int√©gration du contr√¥leur avec les k8.  Vue a√©rienne, l'ensemble des k8 se compose d'un ensemble de contr√¥leurs qui g√©n√®rent des √©v√©nements et y r√©pondent.  Les √©v√©nements passent par des files d'attente auxquelles nous pouvons nous abonner.  Sch√©matiquement, cela peut √™tre repr√©sent√© comme suit: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/094/d57/3fb/094d573fbcf511ba2eea8e707a575423.jpg"><br><br>  L'utilisateur appelle <code>kubectl create -f tarantool_cluster.yaml</code> , la ressource de cluster correspondante est cr√©√©e.  ClusterController est inform√© de la cr√©ation d'une ressource de cluster.  Et la premi√®re chose qu'il essaie de faire est de trouver toutes les ressources de r√¥le qui devraient faire partie de ce cluster.  S'il le trouve, affecte alors le cluster comme propri√©taire du r√¥le et met √† jour la ressource de r√¥le.  Le RoleController re√ßoit une notification de mise √† jour de r√¥le, voit que la ressource a un propri√©taire et commence √† cr√©er des StatefulSets.  Et ainsi de suite en cercle: le premier strigger du second, le second strigger du troisi√®me - et ainsi de suite jusqu'√† ce que quelqu'un s'arr√™te.  Et vous pouvez √©galement d√©clencher √† temps, par exemple, toutes les 5 secondes, ce qui est parfois utile. <br><br>  C'est tout l'op√©rateur: cr√©er une ressource personnalis√©e et √©crire du code qui r√©pond aux √©v√©nements sur les ressources. <br><br><a name="5"></a><h2>  Ce que l'op√©rateur √©tend </h2><br>  Les actions des op√©rateurs conduisent finalement les k8 √† cr√©er des pods et des conteneurs.  Dans le cluster Tarantool Cartridge d√©ploy√© sur les k8, tous les pods sont fusionn√©s en StatefulSets. <br><br>  Pourquoi StatefulSet?  Comme je l'ai √©crit plus t√¥t, chaque instance de Tarantool Cluster conserve une copie de la topologie et de la configuration du cluster, et souvent sur le serveur d'applications, non, non, et ils utilisent une sorte d'espace, par exemple, √† leur tour ou des donn√©es de r√©f√©rence, et c'est d√©j√† un √©tat complet .  Et StatefulSet garantit √©galement la pr√©servation des pods d'identit√©, ce qui est important lors du clustering d'instances dans un cluster: l'identit√© des instances doit √™tre corrig√©e, sinon nous risquons de perdre le quorum lors du red√©marrage. <br><br>  Lorsque toutes les ressources de cluster sont cr√©√©es et port√©es √† l'√©tat souhait√©, elles forment la hi√©rarchie suivante: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e27/89f/f7e/e2789ff7e8bf174c20baf8cc077bdad2.png"><br><br>  Les fl√®ches indiquent la relation propri√©taire-d√©pendante entre les ressources.  Il est n√©cessaire que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Garbage Collector</a> nettoie apr√®s nous dans le cas, par exemple, de la suppression de Cluster. <br><br>  En plus des StatefulSets, l'op√©rateur Tarantool cr√©e le service sans t√™te, qui est n√©cessaire pour l'√©lection du chef, et √† travers lui, les instances communiquent entre elles. <br><br>  Sous le capot de l'op√©rateur Tarantool se trouve le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cadre op√©rateur</a> , le code op√©rateur lui-m√™me est en golang, rien d'extraordinaire ici. <br><br><a name="6"></a><h2>  R√©sum√© </h2><br>  C‚Äôest tout, en g√©n√©ral!  Nous attendons vos commentaires et billets - o√π sans eux, la version alpha est tout de m√™me.  Et ensuite?  Et puis, il y a beaucoup de travail √† faire pour que tout cela soit pr√©sent: <br><br><ul><li>  Unit√©, test E2E; <br></li><li>  Test du Chaos Monkey <br></li><li>  tests de r√©sistance; <br></li><li>  sauvegarde / restauration; <br></li><li>  fournisseur de topologie externe. <br></li></ul><br>  Chacun de ces sujets est vaste en soi et m√©rite un mat√©riel s√©par√©, attendez les mises √† jour! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465823/">https://habr.com/ru/post/fr465823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465811/index.html">14 conseils pour √©crire du code React propre. Partie 1</a></li>
<li><a href="../fr465813/index.html">14 conseils pour √©crire du code React propre. 2e partie</a></li>
<li><a href="../fr465815/index.html">Les scientifiques ont d√©velopp√© des grappes de cellules nerveuses et les ont envoy√©es √† l'ISS</a></li>
<li><a href="../fr465817/index.html">Comment l'inconfort nous aide √† am√©liorer le processus de d√©veloppement.</a></li>
<li><a href="../fr465819/index.html">LAN id√©al</a></li>
<li><a href="../fr465825/index.html">R√©pertoire t√©l√©phonique Asterisk FreePBX √† partir de tables SQL (r√©pertoire Web, t√©l√©chargement vers un fichier XML pour les t√©l√©phones Grandstream)</a></li>
<li><a href="../fr465829/index.html">[Tutoriel] Comment cr√©er votre premier jeu JavaScript IDLE incr√©mentiel</a></li>
<li><a href="../fr465833/index.html">TOKEN2 Molto-1, premier token mat√©riel multi-profil TOTP au monde</a></li>
<li><a href="../fr465835/index.html">Usine abstraite sur les doigts</a></li>
<li><a href="../fr465839/index.html">Tout ce que vous devez savoir sur la marge CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>