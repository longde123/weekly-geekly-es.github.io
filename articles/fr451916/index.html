<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø‚Äçü§ù‚Äçüßëüèº üë©üèø‚Äçüè≠ ü§† PHP asynchrone et l'histoire d'un v√©lo üçä üë®üèª‚Äçüéì üë®‚Äçüë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apr√®s la sortie de PHP7, il est devenu possible d'√©crire des applications √† longue dur√©e de vie √† un co√ªt relativement faible. Pour les programmeurs, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP asynchrone et l'histoire d'un v√©lo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451916/"><p> Apr√®s la sortie de PHP7, il est devenu possible d'√©crire des applications √† longue dur√©e de vie √† un co√ªt relativement faible.  Pour les programmeurs, des projets tels que <code>prooph</code> , <code>broadway</code> , <code>tactician</code> , <code>messenger</code> sont devenus disponibles, dont les auteurs prennent la solution aux probl√®mes les plus courants.  Mais que se passe-t-il si vous faites un petit pas en avant, en plongeant dans la question? </p><br><p>  Essayons de comprendre le sort d'un autre v√©lo, ce qui vous permet de mettre en ≈ìuvre l'application Publier / S'abonner. </p><a name="habracut"></a><br><p>  Pour commencer, nous allons essayer de passer bri√®vement en revue les tendances actuelles dans le monde de PHP, ainsi qu'un bref aper√ßu du fonctionnement asynchrone. </p><br><h3 id="php-sozdan-chtoby-umirat">  PHP cr√©√© pour mourir </h3><br><p>  Pendant longtemps, PHP a √©t√© principalement utilis√© dans le workflow de demande / r√©ponse.  Du point de vue des d√©veloppeurs, c'est assez pratique, car il n'y a pas besoin de s'inqui√©ter des fuites de m√©moire, des connexions de moniteur. </p><br><p>  Toutes les requ√™tes seront ex√©cut√©es isol√©ment les unes des autres, les ressources utilis√©es seront lib√©r√©es et les connexions, par exemple, √† la base de donn√©es seront ferm√©es lorsque le processus sera termin√©. </p><br><p>  √Ä titre d'exemple, vous pouvez prendre une application CRUD r√©guli√®re √©crite sur la base du framework Symfony.  Pour lire √† partir de la base de donn√©es et renvoyer JSON, il est n√©cessaire d'effectuer un certain nombre d'√©tapes (pour √©conomiser de l'espace et du temps, exclure les √©tapes de g√©n√©ration / ex√©cution des opcodes): </p><br><ul><li>  Analyse de la configuration; </li><li>  Compilation de conteneurs; </li><li>  Acheminement des demandes </li><li>  Accomplissement; </li><li>  Rendu du r√©sultat. </li></ul><br><p>  Comme dans le cas de PHP (utilisant des acc√©l√©rateurs), le framework utilise activement la mise en cache (certaines t√¢ches ne seront pas termin√©es √† la prochaine requ√™te), ainsi qu'une initialisation retard√©e.  √Ä partir de la version 7.4, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©charge</a> sera disponible, ce qui optimisera davantage l'initialisation de l'application. </p><br><p>  Cependant, il n'est pas possible de supprimer compl√®tement tous les frais g√©n√©raux pour l'initialisation. </p><br><h3 id="pomozhem-php-vyzhit">  Aidons PHP √† survivre </h3><br><p>  La solution au probl√®me semble assez simple: si vous ex√©cutez l'application √† chaque fois trop cher, vous devez l'initialiser une fois, puis lui transmettre des demandes, en contr√¥lant leur ex√©cution. </p><br><p>  Il existe des projets dans l'√©cosyst√®me PHP tels que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">php-pm</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RoadRunner</a> .  Conceptuellement, les deux font la m√™me chose: </p><br><ul><li>  Un processus parent est cr√©√© qui agit en tant que superviseur; </li><li>  Un pool de processus enfants est cr√©√©; </li><li>  Lorsqu'une demande est re√ßue, le ma√Ætre extrait le processus du pool et lui transmet la demande.  Le client est en attente √† ce moment; </li><li>  Une fois la t√¢che termin√©e, le ma√Ætre renvoie le r√©sultat au client et le processus enfant est renvoy√© au pool. </li></ul><br><p>  Si un processus enfant meurt, le superviseur le cr√©e √† nouveau et l'ajoute au pool.  Nous avons cr√©√© un d√©mon √† partir de notre application avec un seul objectif: supprimer la surcharge d'initialisation, augmentant consid√©rablement la vitesse de traitement des demandes.  C'est le moyen le plus indolore d'augmenter la productivit√©, mais pas le seul. </p><br><blockquote>  Remarque: <br>  de nombreux exemples de la s√©rie ¬´prenez ReactPHP et acc√©l√©rez Laravel N fois¬ª marchent sur le r√©seau.  Il est important de comprendre la diff√©rence entre diaboliser (et, par cons√©quent, gagner du temps lors du d√©marrage de l'application) et multit√¢che. <br>  Lorsque vous utilisez php-pm ou roadrunner, votre code ne devient pas non bloquant.  Vous gagnez simplement du temps lors de l'initialisation. <br>  La comparaison de php-pm, roadrunner et ReactPHP / Amp / Swoole est incorrecte par d√©finition. </blockquote><br><h5 id="php-i-io">  PHP et E / S </h5><br><p>  L'interaction avec les E / S en PHP est ex√©cut√©e par d√©faut en mode blocage.  Cela signifie que si nous ex√©cutons une demande de mise √† jour des informations dans la table, le flux d'ex√©cution s'arr√™tera en attendant une r√©ponse de la base de donn√©es.  Plus ces appels sont en cours de traitement de la demande, plus les ressources du serveur sont inactives.  En effet, dans le processus de traitement de la demande, nous devons aller plusieurs fois dans la base de donn√©es, √©crire quelque chose dans le journal et rendre le r√©sultat au client, au final - √©galement une op√©ration de blocage. </p><br><blockquote>  Imaginez que vous √™tes un op√©rateur de centre d'appels et que vous devez appeler 50 clients en une heure. <br>  Vous composez le premier num√©ro, et l√†, il est occup√© (l'abonn√© discute par t√©l√©phone de la derni√®re s√©rie de Game of Thrones et de la suite de la s√©rie). <br>  Et maintenant vous √™tes assis et essayez de l'atteindre avant la victoire.  Le temps passe, le d√©calage touche √† sa fin.  Apr√®s avoir perdu 40 minutes en essayant d'atteindre le premier abonn√©, vous avez rat√© l'occasion de contacter les autres et naturellement re√ßu du patron. <br>  Mais vous pouvez faire autrement: n'attendez pas que le premier abonn√© soit libre et d√®s que vous entendez un bip, raccrochez et commencez √† composer le num√©ro suivant.  Vous pouvez revenir au premier un peu plus tard. <br>  Avec cette approche, les chances de t√©l√©phoner au nombre maximum de personnes sont consid√©rablement augment√©es, et la vitesse de votre travail ne repose pas sur la t√¢che la plus lente. </blockquote><p>  Le code qui ne bloque pas le thread d'ex√©cution (n'utilise pas le blocage des appels d'E / S, ainsi que des fonctions comme <code>sleep()</code> ), est appel√© asynchrone. </p><br><p>  Revenons √† notre application Symfony CRUD.  Il est presque impossible de le faire fonctionner en mode asynchrone en raison de l'abondance de l'utilisation des fonctions de blocage: tous fonctionnent avec des configurations, des caches, une journalisation, un rendu de la r√©ponse, une interaction avec la base de donn√©es. </p><br><p>  Mais ce sont toutes des conventions, essayons de lancer Symfony et d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Amp</a> , qui fournit une impl√©mentation d'Event Loop (y compris un certain nombre de classeurs), Promises et Coroutines, comme une cerise sur le g√¢teau pour r√©soudre notre probl√®me. </p><br><p>  La promesse est une fa√ßon d'organiser le code asynchrone.  Par exemple, nous devons acc√©der √† une ressource http. </p><br><p>  Nous cr√©ons un objet de demande et le transmettons au transport, que Promise nous renvoie contenant l'√©tat actuel.  Il existe trois √©tats possibles: </p><br><ul><li>  Succ√®s: notre demande a √©t√© trait√©e avec succ√®s; </li><li>  Erreur: lors de l'ex√©cution de la demande, un probl√®me est survenu (par exemple, le serveur a renvoy√© une r√©ponse 500); </li><li>  En attente: le traitement de la demande n'a pas encore commenc√©. </li></ul><br><p>  Chaque Promise a une m√©thode (dans l'exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Promise est</a> analys√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">par Amp</a> ) - <code>onResolve()</code> , dans laquelle une fonction de rappel avec deux arguments est pass√©e </p><br><pre> <code class="php hljs">$promise-&gt;onResolve( <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(?/Throwable $throwable, $result)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== $throwable) { <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> } );</code> </pre> <br><p>  Apr√®s avoir re√ßu Promise, la question se pose: qui surveillera son statut et nous informera du changement de statut? </p><br><p>  Pour cela, Event Loop est utilis√©. </p><br><p>  En substance, une boucle d'√©v√©nement est un planificateur qui surveille l'ex√©cution.  D√®s que la t√¢che est termin√©e (peu importe comment), l'appelable que nous avons transmis √† Promise sera appel√©. </p><br><p>  En ce qui concerne les nuances, je recommanderais de lire un article de Nikita Popov: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Multit√¢che coop√©ratif utilisant des coroutines</a> .  Cela aidera √† clarifier ce qui se passe et o√π sont les g√©n√©rateurs. </p><br><p>  Arm√©s de nouvelles connaissances, essayons de revenir √† notre t√¢che de rendu JSON. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/amphp/">Un exemple de</a> traitement d'une requ√™te http entrante en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/amphp/">amphp / http-server</a> . <br>  D√®s que nous recevons la demande, une lecture asynchrone de la base de donn√©es est effectu√©e (nous obtenons une promesse) et √† la fin, l'utilisateur recevra le JSON convoit√©, form√© sur la base des donn√©es re√ßues. </p><br><blockquote>  Si nous devons √©couter un port de plusieurs processus, nous pouvons regarder vers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp / cluster</a> </blockquote><p>  La principale diff√©rence est qu'un m√™me processus peut servir plusieurs requ√™tes √† la fois car le thread d'ex√©cution n'est pas bloqu√©.  Le client recevra sa r√©ponse lorsque la lecture de la base de donn√©es sera termin√©e, et s'il n'y a pas de r√©ponse, vous pouvez commencer √† traiter la demande suivante. </p><br><h3 id="divnyy-mir-asinhronnogo-php">  Le monde merveilleux du PHP asynchrone </h3><br><blockquote>  Clause de non-responsabilit√© <br>  Le PHP asynchrone est consid√©r√© dans le contexte des esp√®ces exotiques et n'est pas consid√©r√© comme quelque chose de sain / normal.  Fondamentalement, ils attendront des rires dans le style de "prendre GO / Kotlin, un fou", etc.  Je ne dirais pas que ces gens ont tort, mais ... </blockquote><p>  Il existe un certain nombre de projets qui aident √† √©crire du code PHP non bloquant.  Dans le cadre de l'article, je n'analyserai pas compl√®tement tous les avantages et les inconv√©nients, mais j'essaierai simplement de les examiner superficiellement. </p><br><h5 id="swoolehttpswwwswoolecouk">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Swoole</a> </h5><br><p>  Un framework asynchrone √©crit contrairement aux autres en C et livr√© comme une extension de PHP.  Il poss√®de peut-√™tre les meilleurs indicateurs de performance pour le moment. </p><br><p>  Il y a une impl√©mentation de canaux, de corutine et d'autres choses savoureuses, mais il a un gros inconv√©nient - la documentation.  Bien qu'il soit en partie en anglais, √† mon avis, il n'est pas tr√®s d√©taill√© et l'api lui-m√™me n'est pas tr√®s √©vident. </p><br><p>  Quant √† la communaut√©, elle n'est pas non plus toute simple et sans ambigu√Øt√©.  Personnellement, je ne connais pas une seule personne vivante qui utilise Swoole au combat.  Je vais peut-√™tre surmonter mes peurs et migrer vers lui, mais cela ne se produira pas dans un avenir proche. </p><br><p>  Aux inconv√©nients, vous pouvez √©galement ajouter que contribuer au projet (en utilisant la demande de tirage) avec des modifications est √©galement difficile si vous ne connaissez pas C au niveau appropri√©. </p><br><h5 id="workermanhttpsgithubcomwalkorworkerman">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Workerman</a> </h5><br><p>  S'il perd de la vitesse par rapport √† son concurrent (en parlant de Swoole), alors il n'est pas tr√®s visible et la diff√©rence dans un certain nombre de sc√©narios peut √™tre n√©glig√©e. </p><br><p>  Il a une int√©gration avec ReactPHP, qui √† son tour augmente le nombre d'impl√©mentations de probl√®mes d'infrastructure.  Pour √©conomiser de l'espace, je d√©crirai les inconv√©nients avec ReactPHP. </p><br><h5 id="reactphphttpsreactphporg">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ReactPHP</a> </h5><br><p>  Les avantages comprennent une communaut√© assez importante et un grand nombre d'exemples.  Les inconv√©nients commencent √† appara√Ætre dans le processus d'utilisation - c'est le concept de promesse. <br>  Si vous devez effectuer plusieurs op√©rations asynchrones, le code se transforme alors en une corbeille sans fin d'appels (voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un exemple de connexion simple √† RabbiqMQ</a> sans cr√©er d'√©change / file d'attente et leurs liants). </p><br><p>  Avec un certain raffinement avec un fichier (consid√©r√© comme la norme), vous pouvez obtenir une impl√©mentation de corutine qui vous aidera √† vous d√©barrasser de l'enfer Promise. </p><br><p>  Sans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet recoilphp / recoil, l'</a> utilisation de ReactPHP, √† mon avis, n'est pas possible dans une application saine. </p><br><p>  De plus, outre tout le reste, on a l'impression que son d√©veloppement a beaucoup ralenti.  Pas assez, par exemple, un travail normal avec PostgreSQL. </p><br><h5 id="amphttpsamphporgamp">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ampli</a> </h5><br><p>  √Ä mon avis, la meilleure des options qui existent √† l'heure actuelle. <br>  En plus de la promesse habituelle, il existe une impl√©mentation de Coroutine, qui facilite grandement le processus de d√©veloppement et le code semble le plus familier aux programmeurs PHP. </p><br><p>  Les d√©veloppeurs compl√®tent et am√©liorent constamment le projet, avec des commentaires, il n'y a pas non plus de probl√®mes. </p><br><p>  Malheureusement, avec tous les avantages du framework, la communaut√© est relativement petite, mais en m√™me temps il existe des impl√©mentations, par exemple, travaillant avec PostgreSQL, ainsi que toutes les choses de base (syst√®me de fichiers, client http, DNS, etc.). </p><br><p>  Je ne comprends toujours pas tr√®s bien le sort du projet ext-async, mais les gars le suivent.  Ce qui en r√©sultera dans la 3√®me version, le temps nous le dira. </p><br><h3 id="pristupaem-k-realizacii">  Pour commencer </h3><br><p>  Donc, nous avons un peu r√©gl√© la partie th√©orique, il est temps de passer √† la pratique et de remplir les bosses. </p><br><p>  Tout d'abord, nous formalisons un peu les exigences: </p><br><ul><li>  Messagerie asynchrone (le concept de <code>message</code> lui-m√™me peut √™tre divis√© en 2 types) <br><ul><li>  <code>command</code> : indique la n√©cessit√© de terminer la t√¢che.  Ne renvoie pas de r√©sultat (au moins dans le cas d'une communication asynchrone); </li><li>  <code>event</code> : signale tout changement d'√©tat (par exemple, √† la suite d'une commande). </li></ul></li><li>  Format non bloquant pour travailler avec les E / S; </li><li>  La possibilit√© d'augmenter facilement le nombre de processeurs; </li><li>  Capacit√© √† √©crire des gestionnaires de messages dans n'importe quelle langue. </li></ul><br><blockquote>  Tout message est intrins√®quement une structure simple et partag√© uniquement par la s√©mantique.  La d√©nomination des messages est extr√™mement importante du point de vue de la compr√©hension du type et du but (bien que ce point soit ignor√© dans l'exemple). </blockquote><p>  Pour une liste d'exigences, une impl√©mentation simple du mod√®le de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publication / abonnement</a> est la mieux adapt√©e. <br>  Pour assurer une ex√©cution distribu√©e, nous utiliserons RabbitMQ comme courtier de messages. </p><br><p>  Le prototype a √©t√© √©crit en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ReactPHP</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bunny</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DoctrineDBAL</a> . <br>  Un lecteur attentif pourrait remarquer que Dbal utilise les appels de blocage pdo / mysqli en interne, mais au stade actuel, cela n'√©tait pas particuli√®rement important, car il fallait comprendre ce qui devait se passer √† la fin. </p><br><p>  L'un des probl√®mes √©tait le manque de biblioth√®ques pour travailler avec PostgreSQL.  Il existe quelques brouillons, mais cela ne suffit pas pour un travail √† part enti√®re (plus de d√©tails ci-dessous). </p><br><p>  Apr√®s une courte recherche, ReactPHP a √©t√© retir√© au profit d'Amp, car il est relativement simple et se d√©veloppe tr√®s activement. </p><br><h5 id="rabbitmq-transport">  Transport RabbitMQ </h5><br><p>  Mais avec tous les avantages d'Amp, il y avait 1 probl√®me: Amp n'a pas de pilote pour RabbitMQ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bunny</a> ne supporte que ReactPHP). </p><br><p>  En th√©orie, Amp vous permet d'utiliser Promise d'un concurrent.  Il semblerait que tout devrait √™tre simple, mais ReactPHP utilise Event Loop pour travailler avec les sockets de la biblioth√®que. <br>  √Ä un moment donn√©, √©videmment, deux boucles d'√©v√©nements diff√©rentes n'ont pas pu √™tre d√©marr√©es, donc je n'ai pas pu utiliser la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adapt ()</a> . </p><br><p>  Malheureusement, la qualit√© du code dans bunny laissait beaucoup √† d√©sirer et il n'√©tait pas possible de remplacer correctement une impl√©mentation par une autre.  Afin de ne pas arr√™ter le travail, il a √©t√© d√©cid√© de r√©√©crire un peu la biblioth√®que afin qu'elle fonctionne avec Amp et ne conduise pas √† bloquer le flux d'ex√©cution. </p><br><p>  Cette adaptation avait l'air tr√®s effrayante, tout le temps j'en avais extr√™mement honte, mais surtout, √ßa fonctionnait.  Eh bien, puisqu'il n'y a rien de plus permanent que temporaire, l'adaptateur est rest√© en pr√©vision d'une personne qui n'est pas trop paresseuse pour faire face √† la mise en ≈ìuvre du pilote. </p><br><p>  Et un tel homme a √©t√© trouv√©.  Le projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHPinnacle</a> , entre autres, fournit une impl√©mentation d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adaptateur</a> adapt√© pour Amp. </p><br><blockquote>  Le nom de l'auteur est Anton Shabovta, qui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parlera de php asynchrone</a> dans le cadre de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russie</a> et du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©veloppement de pilotes</a> pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP fwdays</a> . </blockquote><br><h5 id="postgresql">  PostgreSQL </h5><br><p>  La deuxi√®me caract√©ristique du travail est l'interaction avec la base de donn√©es.  Dans les conditions du PHP ¬´traditionnel¬ª, tout est simple: nous avons une connexion et toutes les requ√™tes sont ex√©cut√©es s√©quentiellement. </p><br><p>  Dans le cas d'une ex√©cution asynchrone, nous devons pouvoir ex√©cuter simultan√©ment plusieurs requ√™tes (par exemple, 3 transactions).  Pour ce faire, une impl√©mentation de pool de connexions est requise. </p><br><p>  Le m√©canisme de travail est assez simple: </p><br><ul><li>  nous ouvrons <em>N</em> connexions au d√©marrage (ou initialisation retard√©e, pas le point); </li><li>  si n√©cessaire, nous prenons la connexion de la piscine, en veillant √† ce que personne d'autre ne puisse l'utiliser; </li><li>  Nous ex√©cutons la demande et d√©truisons la connexion ou la renvoyons au pool (de pr√©f√©rence). </li></ul><br><p>  Premi√®rement, cela nous permet de d√©marrer plusieurs transactions en m√™me temps, et deuxi√®mement, cela acc√©l√®re le travail en raison de la pr√©sence de connexions d√©j√† ouvertes.  L'ampli a un composant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp / postgres</a> .  Il s'occupe des connexions: surveille leur nombre, leur dur√©e de vie, et tout cela sans bloquer le flux d'ex√©cution. </p><br><p>  Par ailleurs, lorsque vous utilisez, par exemple, ReactPHP, vous devrez l'impl√©menter vous-m√™me si vous souhaitez travailler avec une base de donn√©es. </p><br><h5 id="mutex">  Mutex </h5><br><p>  Pour un fonctionnement efficace et, surtout, correct de l'application, il est n√©cessaire de mettre en ≈ìuvre quelque chose de similaire aux mutex.  On peut distinguer 3 sc√©narios pour leur utilisation: </p><br><ul><li>  Dans le cadre d'un processus, un m√©canisme simple en m√©moire convient sans exc√©dent; </li><li>  Si nous voulons fournir le verrouillage dans plusieurs processus, nous pouvons utiliser le syst√®me de fichiers (bien s√ªr, en mode non bloquant); </li><li>  Si dans le contexte de plusieurs serveurs, vous devez d√©j√† penser √† quelque chose comme Zookeeper. </li></ul><br><p>  Des mutex sont n√©cessaires pour r√©soudre les probl√®mes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conditions de</a> concurrence.  Apr√®s tout, nous ne savons pas (et nous ne pouvons pas savoir) dans quel ordre nos t√¢ches seront ex√©cut√©es, mais nous devons n√©anmoins garantir l'int√©grit√© des donn√©es. </p><br><h5 id="logirovaniekonteksty">  Journalisation / Contextes </h5><br><p>  Pour la journalisation, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Monolog</a> est d√©j√† devenu standard, mais avec quelques mises en garde: nous ne pouvons pas utiliser les gestionnaires int√©gr√©s, car ils entra√Æneront des verrous. <br>  Pour √©crire dans stdOut, vous pouvez prendre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">amphp / log</a> , ou √©crire un simple message envoy√© √† un Graylog. </p><br><p>  √âtant donn√© qu'√† un moment donn√©, nous pouvons traiter de nombreuses t√¢ches et lorsque vous enregistrez des journaux, vous devez comprendre dans quel contexte les donn√©es sont √©crites.  Au cours des exp√©riences, il a √©t√© d√©cid√© de faire <code>trace_id</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tra√ßage distribu√©</a> ).  L'essentiel est que toute la cha√Æne d'appels doit √™tre accompagn√©e d'un identifiant d'intercommunication qui peut √™tre suivi.  De plus, au moment de la r√©ception du message, <code>package_id</code> g√©n√©r√©, ce qui indique exactement le message re√ßu. </p><br><p>  Ainsi, en utilisant les deux identifiants, nous pouvons facilement suivre √† quoi se r√©f√®re un enregistrement particulier.  Le fait est qu'en PHP traditionnel, tous les enregistrements que nous obtenons dans le journal sont principalement dans l'ordre dans lequel ils ont √©t√© √©crits.  Dans le cas d'une ex√©cution asynchrone, il n'y a pas de mod√®le dans l'ordre des entr√©es. </p><br><h5 id="terminating">  R√©siliation </h5><br><p>  Une autre des nuances du d√©veloppement asynchrone est le contr√¥le de l'arr√™t de notre d√©mon.  Si vous venez de tuer le processus, toutes les t√¢ches en cours ne seront pas termin√©es et les donn√©es seront perdues. Dans l'approche habituelle, il y a aussi un tel probl√®me, mais ce n'est pas si grave, car une seule t√¢che est effectu√©e √† la fois. </p><br><p>  Pour terminer correctement l'ex√©cution, nous avons besoin de: </p><br><ul><li>  Se d√©sinscrire de la file d'attente.  En d'autres termes, il est impossible de recevoir de nouveaux messages; </li><li>  Terminez toutes les t√¢ches restantes (attendez la r√©solution des promesses); </li><li>  Et seulement apr√®s cela, terminer le script. </li></ul><br><h5 id="utechki-otladka">  Fuites, d√©bogage </h5><br><p>  Contrairement √† la croyance populaire, en PHP moderne, il n'est pas si simple de faire face √† des situations dans lesquelles une fuite de m√©moire se produit.  Il faut faire quelque chose d'absolument mauvais. </p><br><p>  Cependant, une fois confront√© √† cela, mais √† cause de la n√©gligence banale.  Pendant l'impl√©mentation de Heartbeat, un nouveau temporisateur a √©t√© ajout√© toutes les 40 secondes pour interroger la connexion.  Il n'est pas difficile de deviner qu'apr√®s un certain temps, l'utilisation de la m√©moire a commenc√© √† remonter et assez rapidement. </p><br><p>  Entre autres choses, il a √©crit un simple observateur qui d√©marrera √©ventuellement toutes les 10 minutes et appellera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gc_collect_cycles ()</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gc_mem_caches ()</a> . <br>  Mais le d√©marrage forc√© du ramasse-miettes n'est pas quelque chose de n√©cessaire et de fondamental. </p><br><p>  Afin de voir constamment l'utilisation de la m√©moire, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MemoryUsageProcessor</a> standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">a</a> √©t√© ajout√© √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journalisation</a> . </p><br><p>  Si vous avez l'id√©e que Event Loop se bloque avec quelque chose, cela peut √©galement √™tre facilement v√©rifi√©: connectez simplement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LoopBlockWatcher</a> . </p><br><p>  Mais vous devez vous assurer que cet observateur ne d√©marre pas dans l'environnement de production.  Cette fonctionnalit√© est utilis√©e exclusivement pendant le d√©veloppement. </p><br><h3 id="rezultaty">  R√©sultats </h3><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">php-service-bus</a> ,    Message Based . </p><br><p>    ,         : </p><br><pre> <code class="plaintext hljs">composer create-project php-service-bus/skeleton pub-sub-example cd pub-sub-example docker-compose up --build -d</code> </pre> <br><p>   ,      ,   . </p><br><p>   <code>/bin/consumer</code>   ,    . <br>   <code>/src</code>  3 : <code>Ping</code>   ; <code>Pong</code> :    ; <code>PingService</code> : ,   . <br>     <code>PingService</code> ,      2 : </p><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@CommandHandler</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ping $command, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $context-&gt;delivery(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pong()); } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@EventListener</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">whenPong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pong $event, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context-&gt;logContextMessage(<span class="hljs-string"><span class="hljs-string">'Pong message received'</span></span>); }</code> </pre> <br><ul><li> <code>handle</code>    (        1 ).      <code>@CommandHandler</code> ; <br><ul><li>   Promise ,        RabbitMQ (   <code>delivery()</code> ).       ,   RabbitMQ    . </li></ul></li><li> <code>whenPong</code> ‚Äî   <code>Pong</code> .            .     <code>@EventListener</code> ; <br><blockquote>  ,     ‚Äî   . , , ,     .     php-service-bus  , ,            . <br></blockquote></li></ul><br><p>     2 : ,   (  )  .          ,     ,     (, ). </p><br><p>     <code>Ping</code> ,      <code>Pong</code> .     . </p><br><p>    ,       RabbitMQ: </p><br><pre> <code class="plaintext hljs">tools/ping</code> </pre> <br><p>    ,  php-service-bus     ,  Message based . </p><br><p> Ping\Pong,    ‚Äî ,  ,  <code>Hello, world</code>       . </p><br><p>     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . </p><br><p>     - ,    , , Saga pattern (Process manager)        . </p><br><h3 id="nu-i-kak-zhe-ne-pomeryatsya">       </h3><br><p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  symfony/messenger</a> . </p><br><p>    ,      ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451916/">https://habr.com/ru/post/fr451916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451902/index.html">Camp de d√©veloppeurs Microsoft Azure Russie</a></li>
<li><a href="../fr451904/index.html">Parfois, plus c'est moins. Quand une diminution de la charge entra√Æne une augmentation du retard</a></li>
<li><a href="../fr451906/index.html">Vuln√©rabilit√© dans Exchange: comment d√©tecter l'√©l√©vation de privil√®ges √† un administrateur de domaine</a></li>
<li><a href="../fr451908/index.html">L'histoire des ordinateurs: une nuit au Mus√©e Yandex</a></li>
<li><a href="../fr451912/index.html">Le r√©seau de neurones profonds MuseNet √©crit de la musique</a></li>
<li><a href="../fr451918/index.html">A la question de TI</a></li>
<li><a href="../fr451920/index.html">Optimiser le stockage du courrier dans Zimbra Collaboration Suite</a></li>
<li><a href="../fr451922/index.html">Arithm√©tique √† virgule fixe en C ++</a></li>
<li><a href="../fr451926/index.html">√Ä propos du code en direct apr√®s 130 flux</a></li>
<li><a href="../fr451928/index.html">Comment configurer l'analyse Web sur les pages AMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>