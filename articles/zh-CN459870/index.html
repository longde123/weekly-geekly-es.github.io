<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏹 🏙️ 👦 F＃中的示例模型-视图-更新体系结构 ™️ 👨‍🚀 🗜️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="有人不喜欢React中的Redux，因为它在JS上实现了吗？ 


 我不喜欢减速器笨拙的开关盒，有些语言具有更方便的模式匹配，并且可以键入更好的模型事件和模型。 例如，F＃。 
 本文是Elmish中消息传递设备的说明 。 


 我将给出一个用这种架构编写的控制台应用程序的示例，在其示例中将清楚...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>F＃中的示例模型-视图-更新体系结构</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459870/"><p> 有人不喜欢React中的Redux，因为它在JS上实现了吗？ </p><br><p> 我不喜欢减速器笨拙的开关盒，有些语言具有更方便的模式匹配，并且可以键入更好的模型事件和模型。 例如，F＃。 <br> 本文是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Elmish中</a>消息传递设备的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明</a> 。 </p><a name="habracut"></a><br><p> 我将给出一个用这种架构编写的控制台应用程序的示例，在其示例中将清楚如何使用这种方法，然后我们将理解Elmish架构。 </p><br><p> 我写了一个简单的控制台应用程序来阅读诗歌，种子中有几首诗歌，每位作者一首，显示在控制台上。 </p><br><p>该窗口仅包含4行文字，通过按下“上”和“下”按钮，您可以滚动浏览这首诗，数字按钮可更改文本的颜色，而左右按钮则可让您浏览动作的历史记录，例如，用户阅读普希金的诗，切换为耶塞宁的诗，颜色，然后以为颜色不是很好，叶塞宁不喜欢它，双击左箭头，回到他读完普希金的地方。 </p><br><p> 这个奇迹看起来像这样： </p><br><p><img src="https://habrastorage.org/webt/3h/2j/lh/3h2jlh-zewzgiozosfdxax-re4m.png"></p><br><p> 考虑实施。 </p><br><p> 如果您仔细考虑所有选项，那么很明显，用户可以做的就是按下按钮，通过按下按钮，您可以确定用户想要什么，并且他希望： </p><br><ol><li> 变更作者 </li><li> 改变颜色 </li><li> 滚动（上/下） </li><li> 转到上一个/下一个版本 </li></ol><br><p> 由于用户应该能够返回到版本，因此您需要修复其操作并<strong>记住模型</strong> ，结果，所有可能的消息如下所述： </p><br><pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Msg</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleEvent</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleKey</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeAuthor</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Author</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeColor</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleColor</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RememberModel</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WaitUserAction</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Exit</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Back</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Forward</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Up</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Down</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Author</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pushkin</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lermontov</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Blok</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Esenin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Poem</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Poem</span></span></span><span class="hljs-class"> of string</span></span></code> </pre> <br><p> 在模型中，您需要存储有关控制台中当前文本的信息，用户操作的历史记录以及用户回滚以知道需要显示哪种模型的操作数。 </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewTextInfo</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">countVersionBack</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">history</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">formatText</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">countLines</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">positionY</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">color</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleColor</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br><p>  Elmish体系结构-model-view-update，已经考虑了模型，让我们继续查看： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> <span class="hljs-type"><span class="hljs-type">SnowAndUserActionView</span></span> (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) (dispatch: <span class="hljs-type"><span class="hljs-type">Msg</span></span> -&gt; unit) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> { formatText = ft; color = clr } = model.viewTextInfo; clearConsoleAndPrintTextWithColor ft clr <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key = <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">ReadKey</span></span>().<span class="hljs-type"><span class="hljs-type">Key</span></span>; <span class="hljs-type"><span class="hljs-type">Msg</span></span>.<span class="hljs-type"><span class="hljs-type">ConsoleEvent</span></span> key |&gt; dispatch <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> clearConsoleAndPrintTextWithColor (text: string) (color: <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>) = <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">Clear</span></span>(); <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">WriteLine</span></span>() <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">ForegroundColor</span></span> &lt;- color <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">WriteLine</span></span>(text)</code> </pre> <br><p> 这是其中一种视图，它是基于<em>viewTextInfo</em>绘制的，等待用户的反应，然后将此消息发送给<em>update</em>函数。 <br> 稍后，我们将详细研究调用<em>dispatch</em>时究竟发生了什么以及它具有什么样的功能。 </p><br><p>  <em>更新</em> ： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> update (msg: <span class="hljs-type"><span class="hljs-type">Msg</span></span>) (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) = match msg with | <span class="hljs-type"><span class="hljs-type">ConsoleEvent</span></span> key -&gt; model, updateConsoleEvent key | <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> author -&gt; updateChangeAuthor model author | <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> color -&gt; updateChangeColor model color | <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> position -&gt; updateChangePosition model position | <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> version -&gt; updateChangeVersion model version | <span class="hljs-type"><span class="hljs-type">RememberModel</span></span> -&gt; updateAddEvent model | <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span> -&gt; model, []</code> </pre> <br><p> 根据<em>msg</em>的类型<em>，它</em>选择将处理消息的函数。 </p><br><p> 这是对用户操作的<em>更新</em> ，将按钮映射到消息，最后一种情况-返回<em>WaitUserAction</em>事件-忽略单击并等待其他用户操作。 </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateConsoleEvent (key: <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> msg = match key with | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D1</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Red</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D2</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Green</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D3</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Blue</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D4</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Black</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D5</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Cyan</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">LeftArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> <span class="hljs-type"><span class="hljs-type">Back</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">RightArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> <span class="hljs-type"><span class="hljs-type">Forward</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">P</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Pushkin</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">E</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Esenin</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Blok</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">L</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Lermontov</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">UpArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> <span class="hljs-type"><span class="hljs-type">Up</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">DownArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> <span class="hljs-type"><span class="hljs-type">Down</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">X</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Exit</span></span> | _ -&gt; <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span> msg |&gt; <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg</code> </pre> <br><p> 我们更改了作者，请注意<em>countVersionBack会</em>立即重置为0，这意味着如果用户回滚到他的故事然后想要更改颜色，则此操作将被视为新操作并将被添加到<em>历史记录中</em> 。 </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateChangeAuthor (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) (author: <span class="hljs-type"><span class="hljs-type">Author</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> updatedText) = seed.[author] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedFormatText = getlines updatedText <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedCountLines = (splitStr updatedText).<span class="hljs-type"><span class="hljs-type">Length</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedViewTextInfo = {model.viewTextInfo with text = updatedText; formatText = updatedFormatText; countLines = updatedCountLines } { model with viewTextInfo = updatedViewTextInfo; countVersionBack = <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg <span class="hljs-type"><span class="hljs-type">RememberModel</span></span></code> </pre><br><p> 我们还发送一个<em>RememberModel</em>消息，该消息的处理程序将更新<em>历史记录</em> ，并添加当前模型。 </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateModelHistory model = { model with history = model.history @ [ model.viewTextInfo ] }, <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span></code> </pre> <br><p> 其余的<em>更新</em>可以在<a href="">这里</a>看到，它们与所考虑的相似。 </p><br><p> 为了测试程序的性能，我将针对以下几种情况进行测试： </p><br><div class="spoiler">  <b class="spoiler_title">测验</b> <div class="spoiler_text"><p>  run <em>方法</em> <em>采用存储</em>消息<em>列表的结构，并在处理</em>消息<em>后返回模型。</em> </p><br><pre> <code class="haskell hljs">[&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true)&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``    `` (authors: <span class="hljs-type"><span class="hljs-type">Author</span></span> list) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram (authors |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span>) |&gt; run) match (authors |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast) with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> text) = seed.[s] state.viewTextInfo.text = text | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true [&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true)&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``    `` changeColorMsg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram (changeColorMsg|&gt;<span class="hljs-type"><span class="hljs-type">List</span></span>.map <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span>)|&gt; run) match (changeColorMsg |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast) with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; state.viewTextInfo.color = s | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true [&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true,<span class="hljs-type"><span class="hljs-type">Arbitrary</span></span>=[|typeof&lt;<span class="hljs-type"><span class="hljs-type">ChangeColorAuthorPosition</span></span>&gt;|])&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``        `` msgs = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> tryLastSomeList list = list |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.filter (<span class="hljs-type"><span class="hljs-type">Option</span></span>.isSome) |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (<span class="hljs-type"><span class="hljs-type">Option</span></span>.get) |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastAuthor = msgs |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun x -&gt; match x with | <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Some</span></span> a | _ -&gt; <span class="hljs-type"><span class="hljs-type">None</span></span>) |&gt; tryLastSomeList <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastColor = msgs |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun x -&gt; match x with | <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Some</span></span> a | _ -&gt; <span class="hljs-type"><span class="hljs-type">None</span></span>) |&gt; tryLastSomeList <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram msgs |&gt; run) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> colorTest = match lastColor with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; state.viewTextInfo.color = s | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> authorTest = match lastAuthor with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> t) = seed.[s]; state.viewTextInfo.text = t | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true authorTest &amp;&amp; colorTest</code> </pre></div></div><br><p> 为此，使用了FsCheck库，该库提供了生成数据的功能。 </p><br><p> 现在考虑程序的核心，Elmish中的代码是为所有场合编写的，我对其进行了简化（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">原始代码）</a> ： </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'msg&gt; = 'msg -&gt; unit </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sub</span></span></span><span class="hljs-class">&lt;'msg&gt; = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'msg&gt; -&gt; unit </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'msg&gt; = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sub</span></span></span><span class="hljs-class">&lt;'msg&gt; list </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'model, 'msg, 'view&gt; = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class"> -&gt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class"> -&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> -&gt; ('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt;) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setState</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> -&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class"> } let runWith&lt;'arg, 'model, 'msg, 'view&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">program</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">&gt;) = let (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initModel</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initCmd</span></span></span><span class="hljs-class">) = program.init() //1 let mutable state = initModel //2 let mutable reentered = false //3 let buffer = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RingBuffer</span></span></span><span class="hljs-class"> 10 //4 let rec dispatch msg = let mutable nextMsg = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> msg; //5 if reentered //6 then buffer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Push</span></span></span><span class="hljs-class"> msg //7 else while </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Option</span></span></span><span class="hljs-class">.isSome nextMsg do // 8 reentered &lt;- true // 9 let (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">) = program.update nextMsg.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> state // 9 program.setState model nextMsg.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> dispatch // 10 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">.exec dispatch cmd |&gt; ignore //11 state &lt;- model; // 12 nextMsg &lt;- buffer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pop</span></span></span><span class="hljs-class">() // 13 reentered &lt;- false; // 14 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">.exec dispatch initCmd |&gt; ignore // 15 state //16 let run program = runWith program</span></span></code> </pre> <br><p>  <em>Dispath &lt;'msg&gt;类型</em>正是<em>视图中</em>使用的调度，它接受<em>Message</em>并返回<em>单位</em> <br>  <em>Sub &lt;'msg&gt;</em> -订阅者函数，接受<em>调度</em>并返回<em>unit</em> ，我们在使用<em>ofMsg</em>时<em>生成</em> <em>Sub</em>列表： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> ofMsg&lt;'msg&gt; (msg: 'msg): <span class="hljs-type"><span class="hljs-type">Cmd</span></span>&lt;'msg&gt; = [ fun (dispatch: <span class="hljs-type"><span class="hljs-type">Dispatch</span></span>&lt;'msg&gt;) -&gt; dispatch msg ]</code> </pre> <br><p> 调用<em>ofMsg之后</em> （例如，在<em>updateChangeAuthor</em>方法末尾的<em>Cmd.ofMsg RememberModel）</em> ，一段时间后调用了订阅服务器，消息进入了<em>update</em>方法 <br>  <em>Cmd &lt;'msg&gt;</em> -表格<em>Sub &lt;'msg&gt;</em> </p><br><p> 让我们继续前进到<em>Program</em>类型，它是一个泛型类型，它接受模型，消息和<em>视图</em>的类型，在控制台应用程序中不需要从<em>视图中</em>返回某些内容，但是在Elmish.React视图中它返回DOM树的F＃结构。 </p><br><p> 在elmish的开头调用<em>init</em>字段，此函数返回初始模型和第一条消息，在我的情况下，我返回<em>Cmd.ofMsg RememberModel</em> <br>  <em>更新</em>是<em>update</em>的主要功能，您已经熟悉它。 </p><br><p>  <em>SetState-</em>在标准Elmish中，它仅接受模型并<em>调度</em>并调用<em>view</em> ，但是我需要根据消息传递msg来替换<em>视图</em> ，在考虑消息传递之后，我将展示其实现。 </p><br><p>  <em>runWith</em>函数接收配置，然后调用<em>init</em> ，返回模型和第一条消息，在第2,3行上声明了两个可变对象，第一个-将存储<em>状态</em> ，第二个是<em>分派</em>函数需要。 </p><br><p> 在第四行，声明了<em>缓冲区</em> -您可以将其作为队列，第一个进来-第一个进来（实际上， <em>RingBuffer</em>的实现非常有趣，我从库中获取了它，建议您在<a href="">github</a>上阅读它） </p><br><p> 接下来是递归<em>调度</em>函数本身，即在<em>view</em>中被调用的那个函数，在第一次调用时，我们绕过第6行的<em>if</em>行，立即进入循环，将<em>reented</em>设置为<em>true，</em>以便后续的递归调用不会返回此循环，而是添加<em>缓冲区中有</em>新消息。 </p><br><p> 在第9行，我们执行<em>update</em>方法，从中我们获取更改的模型和新消息（这是第一次是<em>RememberModel</em>消息） <br>  <em>第</em> 10行绘制模型， <em>SetState</em>方法如下所示： </p><br><p><img src="https://habrastorage.org/webt/3v/2c/3l/3v2c3li4ffe4paffy46f98nadle.png"></p><br><p> 如您所见，不同的帖子导致不同的<em>观点</em> <br> 这是一种不阻止流程的必要措施，因为调用<em>Console.ReadLine会</em>阻止程序流程，并且每次用户单击按钮时， <em>RememberModel，ChangeColor</em> （由程序内部触发，而不是由用户触发）之类的事件都会等待，尽管它们只是需要更改颜色。 </p><br><p> 第一次将调用<em>OnlyShowView</em>函数，该函数将简单地绘制模型。 <br> 如果<em>WaitUserAction</em>消息而不是RememberModel到达该方法，则将<em>调用ShowAndUserActionView</em>函数，该函数将<em>绘制</em>模型并阻塞流，等待按钮被按下，一旦按下按钮，将再次调用<em>dispatch</em>方法，并将消息发送到<em>缓冲区</em> （因为<em>reenvited</em> = <em>false</em> ）。 </p><br><p> 接下来，您需要处理所有来自<em>update</em>方法的消息，否则我们将丢失它们，仅当<em>reented</em>变为false时，递归调用才会进入循环。 第11行看起来很复杂，但是实际上这只是<em>缓冲区</em>中所有消息的推送： </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> exec&lt;'msg&gt; (dispatch: <span class="hljs-type"><span class="hljs-type">Dispatch</span></span>&lt;'msg&gt;) (cmd: <span class="hljs-type"><span class="hljs-type">Cmd</span></span>&lt;'msg&gt;) = cmd |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun sub -&gt; sub dispatch)</code> </pre> <br><p> 对于由<em>update</em>方法返回的所有订阅者，将调用<em>dispatch</em> ，从而将这些消息添加到<em>buffer</em> 。 </p><br><p> 在第12行，我们更新了模型，获得了一条新消息，并在<em>缓冲区</em>不为空时将其返回为false，这是没有必要的，但是如果没有剩余元素并且只能从<em>view</em>调用<em>dispatch</em> ，这是有道理的。 同样，在我们的情况下，当一切都同步时，这没有意义，因为我们希望在第10行进行同步调度调用，但是如果代码中存在异步调用，则可以从回调中调用<em>调度</em> ，并且您需要能够继续执行程序。 </p><br><p> 好了，这就是<em>调度</em>功能的全部描述，在第15行调用它，并在第16行返回<em>状态</em> 。 </p><br><p> 在控制台应用程序中，当<em>缓冲区为</em>空时退出。 在原始版本中， <em>runWith不返回</em>任何内容，但如果没有此功能，则无法进行测试。 </p><br><p> 用于测试的程序有所不同， <em>createProgram</em>函数接受用户将启动的消息列表，并在<em>SetState中</em>替换通常的单击： <br><img src="https://habrastorage.org/webt/jc/tz/4u/jctz4uefscbzhubowwwfa9zltr8.png"></p><br><p> 我更改后的版本与原始版本之间的另一个区别是，首先调用了update函数，然后仅调用了<em>setState函数</em> ，相反，在原始版本中，先呈现然后是消息处理，由于阻塞了对<em>Console.ReadKey的</em>调用，我不得不这样做（需要更改<em>查看</em> ） </p><br><p> 希望我能解释Elmish和类似系统的工作原理，但仍然有很多Elmish功能无法使用，如果您对此主题感兴趣，建议您访问他们的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网站</a> 。 </p><br><p> 感谢您的关注！ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN459870/">https://habr.com/ru/post/zh-CN459870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN459852/index.html">在银行的移动应用程序中使用彩票库的做法</a></li>
<li><a href="../zh-CN459858/index.html">探索适用于Android的现代恶意软件Cerberus</a></li>
<li><a href="../zh-CN459860/index.html">在gitlab-ci中配置ClickHouse进行集成测试</a></li>
<li><a href="../zh-CN459862/index.html">Berkeley DB STL接口</a></li>
<li><a href="../zh-CN459866/index.html">使用pwnable.kr 02解决问题-冲突。 哈希冲突</a></li>
<li><a href="../zh-CN459872/index.html">巴顿杰夫。 自定义故事。 敏捷软件开发的艺术</a></li>
<li><a href="../zh-CN459874/index.html">你有东西要藏</a></li>
<li><a href="../zh-CN459878/index.html">加快页面加载速度的7条CSS优化技巧</a></li>
<li><a href="../zh-CN459880/index.html">在Linux上配置Firefox</a></li>
<li><a href="../zh-CN459882/index.html">“默认情况下”音乐：可以在播放器和个人计算机上找到哪些曲目</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>