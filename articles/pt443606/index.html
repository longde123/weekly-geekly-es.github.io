<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèº üçÅ üë©üèª‚Äçüîß Constru√ß√£o do Jenkins para Android usando o docker üêë ü§±üèº üò∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 

 Eu trabalho como desenvolvedor Android, e h√° pouco tempo realizamos algumas tarefas rotineiras em nosso projeto que gostar√≠amos de aut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Constru√ß√£o do Jenkins para Android usando o docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443606/">  Ol√° pessoal! <br><br>  Eu trabalho como desenvolvedor Android, e h√° pouco tempo realizamos algumas tarefas rotineiras em nosso projeto que gostar√≠amos de automatizar.  Por exemplo, temos 5 sabores diferentes, para cada um dos quais precisamos fazer upload de nossa compila√ß√£o no tecido, √†s vezes para carrinhos diferentes v√°rias vezes ao dia.  Sim, essa tarefa pode ser realizada com a tarefa gradle, mas eu gostaria de n√£o executar esse processo na m√°quina do desenvolvedor, mas de alguma forma centralizada.  Ou, por exemplo, fa√ßa upload automaticamente da compila√ß√£o no google play para a vers√£o beta.  Bem, eu s√≥ queria escolher o sistema de CI.  O que saiu disso e como o configuramos, por que existe o Docker, mais adiante neste artigo. <br><br><img src="https://habrastorage.org/webt/at/pi/_v/atpi_veqcyb-lryxth_ia4m0uag.png"><br><a name="habracut"></a><br>  No meu entendimento, toda a tarefa foi dividida em aproximadamente duas etapas: <br><br><ol><li>  Instale e configure o pr√≥prio Jenkins com o SDK do Android </li><li>  Configurar tarefas j√° dentro do Jenkins </li></ol><br>  Neste artigo, quero abordar o primeiro ponto e, se isso for de interesse de algu√©m, no pr√≥ximo artigo, descreverei o processo de configura√ß√£o de tarefas de montagem no pr√≥prio Jenkins. <br><br><h2>  Portanto, o primeiro ponto √© a instala√ß√£o e configura√ß√£o do sistema Jenkins </h2><br>  <i>Habr√© j√° tem um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> maravilhoso sobre esse assunto, mas ela j√° tem alguns anos e algumas coisas est√£o um pouco desatualizadas (por exemplo, sdkmanager), embora ela tenha me ajudado muito a descobrir o que e como fazer nos est√°gios iniciais.</i> <br><br>  Se voc√™ olhar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> oficial para a instala√ß√£o do Jenkins, veremos tr√™s maneiras diferentes de fazer isso: iniciar uma imagem do docker pronta para download, baixar e executar um arquivo de guerra e tamb√©m instalar o jenkins no sistema √† moda antiga (por exemplo, <code>apt-get install jenkins</code> usando o ubuntu como exemplo).  A primeira op√ß√£o √© a mais correta, porque n√£o carrega configura√ß√µes e depend√™ncias desnecess√°rias para o sistema host e, a qualquer momento, mesmo que algo d√™ errado, √© f√°cil e simples excluir tudo e come√ßar de novo.  Mas a imagem padr√£o do docker para jenkins cont√©m alguns dados que n√£o precisamos (por exemplo, o plug-in blueocean) e n√£o cont√™m o que definitivamente precisaremos (por exemplo, android sdk).  Foi decidido criar nossa pr√≥pria imagem do docker que, dentro dele, far√° o download e executar√° o arquivo war, baixar√° e instalar√° o android sdk, al√©m de definir todas as outras configura√ß√µes necess√°rias.  Para iniciar mais tarde, precisamos de um sistema host com o docker instalado.  Sugiro aqui n√£o reinventar a roda e usar o DigitalOcean. <br><br><h4>  Crie e configure uma m√°quina virtual </h4><br>  Para come√ßar, se algu√©m n√£o estiver registrado l√°, sugiro que se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registre</a> (aqui, no momento da reda√ß√£o do artigo, havia um link de refer√™ncia, mas depois de ler as regras, joguei fora).  Ap√≥s o registro, voc√™ pode pesquisar no Google um ou outro c√≥digo promocional na Internet e obter cerca de 10 d√≥lares para come√ßar. <br><br>  Depois, precisamos obter uma nova gota.  Selecione o item Gotas e, em seguida, <b>Criar gota</b> . <br><br><img src="https://habrastorage.org/webt/gx/5m/th/gx5mthmcjzw-okm6ktxpfekimn8.png" alt="imagem"><br><br>  O sistema host √© o Ubuntu 18.04.  Voc√™ pode escolher uma imagem com o Docker j√° instalado e configurado, mas faremos tudo por conta pr√≥pria.  Como a montagem de compila√ß√µes do Android ainda exige muitos recursos, precisamos escolher uma configura√ß√£o de pelo menos 20 d√≥lares para que as compila√ß√µes sejam coletadas normalmente e relativamente rapidamente. <br><br><img src="https://habrastorage.org/webt/1e/y_/z1/1ey_z1uyjffbqocqz6i4ef8ium8.png" alt="imagem"><br><br>  Escolheremos um local mais pr√≥ximo (por exemplo, na Alemanha).  Depois, existem duas op√ß√µes de como nos conectaremos ao nosso servidor virtual.  Podemos adicionar uma chave ssh ou ficar sem ela.  Se neste local n√£o indicarmos qual chave usar, a senha do usu√°rio root ser√° enviada para o nosso correio. <br><br><img src="https://habrastorage.org/webt/eg/qd/hu/egqdhuamgiddwijvsfidcxu7ieq.png" alt="imagem"><br><br>  Aqui podemos alterar o nome do servidor e concluir a cria√ß√£o clicando no bot√£o <b>Criar</b> . <br><br><img src="https://habrastorage.org/webt/ad/mw/6w/admw6wwv2zyontaxpzx-fgp-rfg.png" alt="imagem"><br><br>  Agora vamos para o droplet criado e copiamos o endere√ßo IP para n√≥s, para mais conex√£o e configura√ß√£o. <br><br><img src="https://habrastorage.org/webt/q7/th/yv/q7thyvgm-hppvgrured6dogeqva.png" alt="imagem"><br><br>  Precisamos de um cliente ssh.  Se voc√™ trabalha com uma papoula, pode usar o terminal padr√£o; se, no Windows, podemos usar massa para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">trabalhar</a> ou usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o subsistema Linux</a> (somente para Windows 10).  Eu pessoalmente uso a √∫ltima op√ß√£o, e ela me conv√©m completamente. <br><br>  Conecte-se ao nosso servidor usando o seguinte comando <br><br><pre> <code class="bash hljs">ssh root@YOUR_IP_ADDRESS</code> </pre> <br>  O console oferecer√° que voc√™ salve a chave, concordamos com isso.  Ap√≥s a conex√£o, criaremos um novo usu√°rio para n√≥s mesmos, adicionaremos aos superusu√°rios (e daremos a ele a oportunidade de usar o sudo sem senha), copiaremos a chave de acesso via ssh e dizeremos que ele √© o propriet√°rio desses arquivos (caso contr√°rio, n√£o funcionar√°).  O <b>nome de usu√°rio √©</b> alterado para qualquer conveniente para voc√™. <br><br><pre> <code class="bash hljs">useradd -m -s /bin/bash username \ &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'username ALL=(ALL) NOPASSWD:ALL'</span></span> &gt;&gt; /etc/sudoers \ &amp;&amp; mkdir /home/username/.ssh \ &amp;&amp; cp /root/.ssh/authorized_keys /home/username/.ssh/authorized_keys \ &amp;&amp; chown username:username -R /home/username/.ssh</code> </pre><br>  Desconecte da raiz com o comando <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  E vamos reconectar j√° com a ajuda do novo usu√°rio criado <br><br><pre> <code class="bash hljs">ssh username@YOUR_IP_ADDRESS</code> </pre> <br>  Depois de atualizar o sistema e reiniciar o servidor (se durante o processo de atualiza√ß√£o o sistema solicitar algo, basta escolher sempre os valores padr√£o nesse caso). <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt full-upgrade -y &amp;&amp; sudo apt autoremove -y &amp;&amp; sudo reboot</code> </pre> <br>  A configura√ß√£o b√°sica est√° conclu√≠da.  Do ponto de vista do sistema de combate, ele n√£o √© muito seguro, mas dentro da estrutura deste artigo √© completamente adequado. <br><br><h4>  Instale o Docker. </h4><br>  Para instalar o Docker em nosso sistema, usaremos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> .  Como temos um sistema rec√©m-instalado, pularemos esse ponto e, se voc√™ tiver um sistema em que algo esteja em execu√ß√£o h√° muito tempo, por recomenda√ß√£o dos caras do Docker, exclua poss√≠veis vers√µes antigas <br><br><pre> <code class="bash hljs">sudo apt-get remove docker docker-engine docker.io containerd runc</code> </pre> <br>  N√£o se esque√ßa de primeiro conectar-se novamente via ssh ao nosso servidor.  A instala√ß√£o do Docker em si √© descrita em detalhes na documenta√ß√£o; darei comandos gerais para facilitar isso para voc√™.  O que eles fazem pode ser lido l√°.  Primeiro adicione o reposit√≥rio. <br><br><pre> <code class="bash hljs">sudo apt update \ &amp;&amp; sudo apt install -y apt-transport-https ca-certificates \ curl gnupg-agent software-properties-common \ &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \ &amp;&amp; sudo apt-key fingerprint 0EBFCD88 \ &amp;&amp; sudo add-apt-repository <span class="hljs-string"><span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(lsb_release -cs)</span></span></span><span class="hljs-string"> stable"</span></span></code> </pre> <br>  E instale o pr√≥prio Docker: <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt install -y docker-ce docker-ce-cli containerd.io</code> </pre> <br>  Para que, no futuro, possamos chamar comandos do docker sem o prefixo sudo, execute o seguinte comando (que tamb√©m √© cuidadosamente descrito nas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√µes</a> ). <br><br><pre> <code class="bash hljs">sudo usermod -aG docker username</code> </pre> <br>  Depois disso, √© necess√°rio efetuar login novamente (usando o comando exit e reconectando-se ao servidor) para que isso funcione. <br><br>  O Docker est√° instalado, o que podemos verificar com o comando <br><br><pre> <code class="bash hljs">docker run hello-world</code> </pre> <br>  Ela baixa a imagem de teste e a executa no cont√™iner.  O cont√™iner, ap√≥s iniciar, imprime uma mensagem informativa e sai. <br><br>  Parab√©ns, terminamos o est√°gio de prepara√ß√£o do servidor para o trabalho! <br><br><h4>  Criando sua imagem do Docker </h4><br>  Criaremos a imagem do Docker escrevendo nosso pr√≥prio Dockerfile.  Exemplos de como fazer isso corretamente na Internet: uma carro√ßa e um carrinho pequeno, mostrarei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">minha</a> vers√£o final e tentarei comentar o m√°ximo poss√≠vel.  H√° tamb√©m um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">manual</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√µes</a> do docker em si, com exemplos sobre a ortografia correta e can√¥nica do dockerfile. <br><br>  Crie e abra seu Dockerfile para edi√ß√£o <br><br><pre> <code class="bash hljs">touch Dockerfile &amp;&amp; nano Dockerfile</code> </pre> <br>  Nele, por exemplo, colocaremos o conte√∫do do meu Dockerfile <br><br><div class="spoiler">  <b class="spoiler_title">Meu dockerfile inteiro com coment√°rios</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    . FROM ubuntu:18.04 #      LABEL author="osipovaleks" LABEL maintainer="osipov.aleks.kr@gmail.com" LABEL version="1.0" LABEL description="Docker image for Jenkins with Android SDK" #  ,  Jenkins    ENV TZ=Europe/Kiev RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone # i386    ia32-libs RUN dpkg --add-architecture i386 #      RUN apt-get update &amp;&amp; apt-get install -y git \ wget \ unzip \ sudo \ tzdata \ locales\ openjdk-8-jdk \ libncurses5:i386 \ libstdc++6:i386 \ zlib1g:i386 #  ,       RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists /var/cache/apt #  RUN locale-gen en_US.UTF-8 ENV LANG en_US.UTF-8 ENV LANGUAGE en_US:en ENV LC_ALL en_US.UTF-8 #   Android Sdk     ARG android_home_dir=/var/lib/android-sdk/ ARG sdk_tools_zip_file=sdk-tools-linux-4333796.zip RUN mkdir $android_home_dir RUN wget https://dl.google.com/android/repository/$sdk_tools_zip_file -P $android_home_dir -nv RUN unzip $android_home_dir$sdk_tools_zip_file -d $android_home_dir RUN rm $android_home_dir$sdk_tools_zip_file &amp;&amp; chmod 777 -R $android_home_dir # environment    ENV ANDROID_HOME=$android_home_dir ENV PATH="${PATH}:$android_home_dir/tools/bin:$android_home_dir/platform-tools" ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/ #   Android SDK RUN yes | sdkmanager --licenses #    Jenkins ENV JENKINS_HOME=/var/lib/jenkins RUN mkdir $JENKINS_HOME &amp;&amp; chmod 777 $JENKINS_HOME #     jenkins,   ,         RUN useradd -m jenkins &amp;&amp; echo 'jenkins ALL=(ALL) NOPASSWD:ALL' &gt;&gt; /etc/sudoers USER jenkins WORKDIR /home/jenkins #   war     Jenkins RUN wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war -nv CMD java -jar jenkins.war #      EXPOSE 8080/tcp</span></span></code> </pre><br></div></div><br>  Alguns esclarecimentos: <br><br><ul><li>  No come√ßo, havia um desejo de usar um alpino mais leve em vez do ubuntu, mas ele n√£o possui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suporte a ia32-libs</a> , necess√°rio para criar projetos usando o Android SDK. </li><li>  Instalamos o openjdk-8-jdk, n√£o o openjdk-8-jdk-headless, mais leve, porque algumas fun√ß√µes do Jenkins precisam de um sistema completo (por exemplo, exibindo resultados de teste de unidade). </li><li>  √â necess√°rio instalar localidades, devido ao fato de que em alguns projetos, sem eles, o conjunto gradle falha sem erros e logs claros, e eu passei v√°rios dias para chegar ao fundo desse motivo (em um ubuntu normal que n√£o est√° no docker, todos os locais s√£o preenchidos por padr√£o) . </li><li>  Precisamos aceitar imediatamente todas as licen√ßas do Android SDK, para que, durante o processo de compila√ß√£o, o Jenkins possa instalar independentemente os componentes necess√°rios (por exemplo, os SDKs necess√°rios para diferentes vers√µes da API).  Se necess√°rio, posteriormente, dentro do cont√™iner do docker, ser√° poss√≠vel gerenciar o SDK usando o sdkmanager, por exemplo, o <code>sdkmanager --list</code> permite exibir todos os componentes dispon√≠veis e todos os componentes instalados e o <code>sdkmanager --install "platforms;android-26"</code> instalar√° o SDK para a vers√£o 26 da API. </li><li>  Em geral, era poss√≠vel n√£o iniciar o usu√°rio jenkins e ficar com o usu√°rio root, mas de alguma forma n√£o est√° certo, voc√™ tamb√©m n√£o podia conceder direitos de superusu√°rio, mas isso era feito em termos de conveni√™ncia, se algo precisasse ser instalado no est√°gio de instala√ß√£o e depura√ß√£o. </li><li>  O tamanho b√°sico da imagem acabou sendo bastante grande (quase 800 mb), mas no geral cheguei √† conclus√£o de que isso n√£o √© muito cr√≠tico para mim e √© mais f√°cil fazer o download deste formul√°rio do que gastar tempo pesquisando e removendo pacotes dos quais n√£o preciso. </li></ul><br>  Ap√≥s escrever o Dockerfile, precisamos transform√°-lo em uma imagem pronta para o Docker, com base em quais cont√™ineres ser√£o criados.  Isso √© feito simplesmente por uma equipe <br><br><pre> <code class="bash hljs">docker build -t jenkins-image</code> </pre> <br>  em que o par√¢metro <code>-t jenkins-image</code> √© respons√°vel pelo nome da sua imagem e o ponto no final do comando indica que voc√™ precisa procurar o Dockerfile para o assembly dentro deste diret√≥rio.  O processo de montagem em si leva algum tempo e, ap√≥s a montagem, deve haver algo assim no console. <br><blockquote>  9fd8f5545c27 constru√≠do com sucesso <br>  Marcado com sucesso jenkins-image: mais recente </blockquote>  O que nos diz que nossa imagem foi montada com sucesso e podemos prosseguir para a pr√≥xima etapa, a saber, o lan√ßamento de nosso cont√™iner. <br><br><h4>  Docker Hub e imagens prontas </h4><br>  Sim, √© claro, podemos usar nossa imagem pronta para iniciar o cont√™iner, mas se precisarmos fazer isso em mais de v√°rios dispositivos, criar um Dockerfile a cada vez e criar uma imagem pronta a partir dele n√£o ser√° muito conveniente.  E se tamb√©m atualizarmos o conte√∫do do nosso Dockerfile, implementar as altera√ß√µes em todos os n√≥s n√£o ser√° conveniente.  Para esses fins, h√° um reposit√≥rio p√∫blico de imagens do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker Hub</a> .  Ele permite que voc√™ n√£o colete uma imagem toda vez, em cada n√≥, mas simplesmente fa√ßa o download para si mesmo do reposit√≥rio p√∫blico e use-a igualmente em todas as m√°quinas.  Por exemplo, a imagem que serviu de exemplo para este artigo est√° dispon√≠vel no reposit√≥rio denominado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">osipovaleks / docker-jenkins-android</a> e, posteriormente, no artigo, trabalharemos com ela. <br><br>  Este artigo n√£o implica um estudo detalhado do Docker Hub, n√£o entenderemos como enviar nossas imagens para l√° (embora isso n√£o seja muito dif√≠cil) e o que pode ser feito com elas, n√£o entenderemos que ainda pode haver seus pr√≥prios reposit√≥rios p√∫blicos ou privados, Neste, tudo pode ser resolvido independentemente, se necess√°rio. <br><br><h4>  Lan√ßamento de cont√™iner </h4><br>  Existem duas maneiras de iniciar um cont√™iner. <br><br><ol><li>  A primeira maneira, simplesmente usando o <code>docker run</code> , permite fazer isso com facilidade e rapidez da seguinte maneira <br><br><pre> <code class="bash hljs">docker run --name jenkins -d -it -v jenkins-data:/var/lib/jenkins -v jenkins-home:/home/jenkins -p 8080:8080 --restart unless-stopped osipovaleks/docker-jenkins-android</code> </pre> <br>  onde o comando <code>run</code> possui os seguintes par√¢metros <br><br><ul><li>  <code>--name jenkins</code> - nome do futuro cont√™iner </li><li>  <code>-d</code> - inicia o cont√™iner em segundo plano </li><li>  <code>-it</code> - sinalizadores para trabalhar com STDIN e tty </li><li>  <code>-v jenkins-data:/var/lib/jenkins</code> e <code>-v jenkins-home:/home/jenkins</code> - create (se n√£o for criado) e mapeie arquivos de volume especiais para as se√ß√µes internas do cont√™iner que permitir√£o salvar nosso Jenkins personalizado mesmo ap√≥s a reconstru√ß√£o container </li><li>  <code>-p 8080:8080</code> - mapeie a porta do host para a porta do cont√™iner para que tenhamos acesso √† interface da web (sim, essa √© a porta que especificamos no Dockerfile) </li><li>  <code>--restart unless-stopped</code> - a op√ß√£o determina a pol√≠tica de execu√ß√£o autom√°tica do cont√™iner ap√≥s a reinicializa√ß√£o do host (nesse caso, inicie automaticamente se o cont√™iner n√£o tiver sido desativado manualmente) </li><li>  <code>osipovaleks/docker-jenkins-android</code> - imagem para implanta√ß√£o. </li></ul><br>  Na sa√≠da para o console do Docker, devemos obter o ID do cont√™iner criado e tamb√©m mostrar informa√ß√µes sobre como a imagem √© carregada no sistema (√© claro, se ainda n√£o estiver carregada), algo como isto <br><blockquote>  N√£o foi poss√≠vel encontrar a imagem 'osipovaleks / docker-jenkins-android: latest' localmente <br>  mais recente: Puxando de osipovaleks / docker-jenkins-android <br>  6cf436f81810: Puxar conclu√≠do <br>  987088a85b96: Puxar conclu√≠do <br>  b4624b3efe06: Puxar conclu√≠do <br>  d42beb8ded59: Puxar conclu√≠do <br>  b3896048bb8c: Puxar conclu√≠do <br>  8eeace4c3d64: extra√ß√£o conclu√≠da <br>  d9b74624442c: Puxar conclu√≠do <br>  36bb3b7da419: Puxar conclu√≠do <br>  31361bd508cb: tra√ß√£o conclu√≠da <br>  cee49ae4c825: puxar conclu√≠do <br>  868ddf54d4c1: Puxar conclu√≠do <br>  361bd7573dd0: Puxar conclu√≠do <br>  bb7b15e36ae8: Puxar conclu√≠do <br>  97f19daace79: Puxar conclu√≠do <br>  1f5eb3850f3e: Puxar conclu√≠do <br>  651e7bbedad2: Puxar conclu√≠do <br>  a52705a2ded7: Puxar conclu√≠do <br>  Digest: sha256: 321453e2f2142e433817cc9559443387e9f680bb091d6369bbcbc1e0201be1c5 <br>  Status: imagem mais recente baixada para osipovaleks / docker-jenkins-android: mais recente <br>  ef9e5512581da66d66103d9f6ea6ccd74e5bdb3776747441ce6a88a98a12b5a4 </blockquote></li><li>  A segunda maneira de come√ßar envolve a grava√ß√£o de um arquivo de composi√ß√£o especial, em que o comando executar √© simplesmente descrito usando a linguagem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YAML</a> e iniciado usando o Docker Compose. <br><br>  Para fazer isso, precisamos instal√°-lo: <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt install -y docker-compose</code> </pre> <br>  Em seguida, crie um diret√≥rio para o projeto (isso √© importante se voc√™ se importa como os volumes criados automaticamente para o cont√™iner ser√£o chamados) e v√° para ele <br><br><pre> <code class="bash hljs">mkdir jenkinsProject &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> jenkinsProject</code> </pre> <br>  e por dentro criamos o pr√≥prio arquivo de composi√ß√£o e entramos no modo de edi√ß√£o <br><br><pre> <code class="bash hljs">touch docker-compose.yml &amp;&amp; nano docker-compose.yml</code> </pre> <br>  e coloque o seguinte conte√∫do nele <br><br><pre> <code class="markdown hljs">version: '3' services: jenkins: container_name: jenkins image: osipovaleks/docker-jenkins-android ports: - "8080:8080" restart: unless-stopped volumes: - "jenkins-data:/var/lib/jenkins" - "jenkins-home:/home/jenkins" volumes: jenkins-data: jenkins-home:</code> </pre> <br>  Nela, talvez, apenas a primeira linha levante quest√µes ( <code>version: '3'</code> ) que indica a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o dos recursos do</a> arquivo de composi√ß√£o, bem como uma se√ß√£o com o bloco de <code>volumes</code> que lista as usadas neste cont√™iner <br><br>  Execute seu cont√™iner com o comando: <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  onde o sinalizador <code>-d</code> tamb√©m indica que o cont√™iner ser√° criado e lan√ßado em segundo plano.  Como resultado, o Docker deve mostrar algo como o seguinte: <br><blockquote>  Criando o volume "jenkinsproject_jenkins-data" com o driver padr√£o <br>  Criando o volume "jenkinsproject_jenkins-home" com o driver padr√£o <br>  Puxando jenkins (osipovaleks / docker-jenkins-android: mais recente) ... <br>  mais recente: Puxando de osipovaleks / docker-jenkins-android <br>  6cf436f81810: Puxar conclu√≠do <br>  987088a85b96: Puxar conclu√≠do <br>  b4624b3efe06: Puxar conclu√≠do <br>  d42beb8ded59: Puxar conclu√≠do <br>  b3896048bb8c: Puxar conclu√≠do <br>  8eeace4c3d64: extra√ß√£o conclu√≠da <br>  d9b74624442c: Puxar conclu√≠do <br>  36bb3b7da419: Puxar conclu√≠do <br>  31361bd508cb: tra√ß√£o conclu√≠da <br>  cee49ae4c825: puxar conclu√≠do <br>  868ddf54d4c1: Puxar conclu√≠do <br>  361bd7573dd0: Puxar conclu√≠do <br>  bb7b15e36ae8: Puxar conclu√≠do <br>  97f19daace79: Puxar conclu√≠do <br>  1f5eb3850f3e: Puxar conclu√≠do <br>  651e7bbedad2: Puxar conclu√≠do <br>  a52705a2ded7: Puxar conclu√≠do <br>  Digest: sha256: 321453e2f2142e433817cc9559443387e9f680bb091d6369bbcbc1e0201be1c5 <br>  Status: imagem mais recente baixada para osipovaleks / docker-jenkins-android: mais recente <br>  Criando jenkins ... <br>  Criando jenkins ... conclu√≠do </blockquote>  Lembre-se, eu disse que o nome dos volumes criados depender√° do nome do projeto?  Execute o comando: <br><br><pre> <code class="bash hljs">docker volume ls</code> </pre> <br>  e temos essa sa√≠da <br><blockquote>  NOME DO VOLUME DO CONDUTOR <br>  local jenkinsproject_jenkins-data <br>  local jenkinsproject_jenkins-home </blockquote>  onde veremos que, apesar do nome do volume ter sido escolhido por <code>jenkins-home</code> , na realidade, um prefixo do nome do projeto grudou nele e o volume do nome acabou sendo <code><b>jenkinsproject</b> _jenkins-home</code> </li></ol><br><br>  Qual op√ß√£o de inicializa√ß√£o usar?  Aqui voc√™ pode escolher por si mesmo, acredita-se que o Docker Compose seja mais uma ferramenta para iniciar v√°rios cont√™ineres de uma s√≥ vez, vinculados entre si, e se voc√™ precisar iniciar apenas um cont√™iner, poder√° usar o <code>docker run</code> . <br><br>  Agora, ap√≥s estas subpasso para iniciar e configurar o servidor, bem como iniciar o cont√™iner com Jenkins, podemos prosseguir para sua configura√ß√£o inicial <br><br><h4>  Configura√ß√£o inicial do Jenkins </h4><br>  Pegue o endere√ßo IP do nosso servidor, adicione a porta 8080 indicada por n√≥s e siga este link no navegador. <br><br> <code>http://YOUR_IP_ADDRESS:8080/</code> <br> <br>  Se antes disso tudo estava configurado e iniciado corretamente, ent√£o aqui veremos a figura a seguir <br><br><img src="https://habrastorage.org/webt/za/a5/bi/zaa5bi-5vkvscc-ww7gd2ouxjte.png"><br><br>  Para a primeira configura√ß√£o, precisamos digitar a senha que o sistema gerou durante a instala√ß√£o.  Para fazer isso, basta olhar para o conte√∫do do arquivo <code>/var/lib/jenkins/secrets/initialAdminPassword</code> .  Mas esse arquivo est√° dentro do cont√™iner em execu√ß√£o e, para l√™-lo, precisamos nos conectar ao cont√™iner usando o seguinte comando: <br><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it jenkins /bin/bash</code> </pre> <br>  onde a op√ß√£o <code>-it</code> √© semelhante √† execu√ß√£o do <code>docker run</code> , <code>jenkins</code> √© o nome do nosso cont√™iner e <code>/bin/bash</code> executar√° o <code>/bin/bash</code> para n√≥s no cont√™iner e dar√° acesso a ele.  Depois disso, podemos ver a senha inicial para Jenkins: <br><br><pre> <code class="bash hljs">cat /var/lib/jenkins/secrets/initialAdminPassword</code> </pre> <br>  o seguinte aparece no console <br><blockquote>  91092b18d6ca4492a2759b1903241d2a </blockquote>  Essa √© a senha. <br><br>  <i>O usu√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">ALexhha</a> sugeriu uma op√ß√£o mais simples de ler essa senha, sem conectar-se ao pr√≥prio cont√™iner.</i>  <i>O fato √© que, no momento do lan√ßamento do pr√≥prio Jenkins, essa senha √© mostrada nos logs.</i>  <i>Acontece que tudo o que precisamos √© ler os logs do cont√™iner.</i>  <i>No nosso caso, isso √© feito com o seguinte comando:</i> <br><br><pre> <code class="bash hljs">docker logs jenkins</code> </pre> <br><br>  <i>onde</i> <code>jenkins</code> <i>nome do nosso cont√™iner e, nos logs, voc√™ pode ver o seguinte:</i> <br><br><blockquote>  ******************************************************* *********** <br>  ******************************************************* *********** <br>  ******************************************************* *********** <br><br>  A configura√ß√£o inicial do Jenkins √© necess√°ria.  Um usu√°rio administrador foi criado e uma senha gerada. <br>  Por favor, use a seguinte senha para prosseguir para a instala√ß√£o: <br><br>  91092b18d6ca4492a2759b1903241d2a <br><br>  Isso tamb√©m pode ser encontrado em: / var / lib / jenkins / secrets / initialAdminPassword <br><br>  ******************************************************* *********** <br>  ******************************************************* *********** </blockquote><br>  ******************************************************* *********** <br><br>  <i>Esta op√ß√£o √© um pouco mais simples e r√°pida.</i> <br><br>  Copie-o, cole-o no campo <b>Senha</b> do <b>administrador</b> na interface da web e clique em <b>Continuar</b> .  Na pr√≥xima tela, selecione <b>Instalar plug</b> - <b>ins sugeridos</b> e instale um conjunto de plug-ins padr√£o. <br><br><img src="https://habrastorage.org/webt/bs/9d/xs/bs9dxsxd6-cddmut2bww9utxjw4.png"><br><br><img src="https://habrastorage.org/webt/r5/-m/u-/r5-mu-bgyaqswxcqnyrpds0qhic.png"><br><br>  Ap√≥s instalar os plugins, crie um usu√°rio para n√≥s mesmos e clique em <b>Salvar e Concluir</b> <br><br><img src="https://habrastorage.org/webt/iy/ap/jd/iyapjd__vdbys6jsjiinvzcp58q.png"><br><br>  Concordamos com a se√ß√£o Configura√ß√£o da inst√¢ncia, na qual √© solicitado que voc√™ preencha o URL no qual o Jenkins funcionar√° (no nosso caso, deixe tudo como est√°) <br><br><img src="https://habrastorage.org/webt/4v/w1/ie/4vw1ieq0o_tm5bkrgn4sb-m__kk.png"><br><br>  E na pr√≥xima tela, clique no bot√£o <b>Iniciar, usando</b> o querido <b>Jenkins.</b> <br><br><img src="https://habrastorage.org/webt/4a/iw/yq/4aiwyqwkzbxjdkjwyzowxyvsktc.png"><br><br>  Ent√£o, instalamos e lan√ßamos o Jenkins! <br><br><img src="https://habrastorage.org/webt/9a/4z/tu/9a4ztunwk1gxuc8rsho2ql9-tou.png"><br><br>  J√° √© poss√≠vel trabalhar com ele, mas para coletar nossas compila√ß√µes do Android, voc√™ precisar√° configurar mais alguns pontos.  A localiza√ß√£o do Jenkins est√° relacionada ao idioma selecionado do seu navegador e, √© claro, a tradu√ß√£o para o russo n√£o est√° completamente conclu√≠da, e temos uma mistura infernal de russo e ingl√™s.  Se voc√™ conseguiu exatamente da mesma maneira e isso o enfurece, voc√™ pode usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in</a> especial e definir o idioma da interface padr√£o.  Bem, ou mude seu navegador para a interface em ingl√™s. <br><br>  V√° para as configura√ß√µes do Jenkins e selecione <b>Configura√ß√£o do sistema.</b> <br><br><img src="https://habrastorage.org/webt/pk/xo/1d/pkxo1diloanswc7tciicxhaiidq.png"><br><br>  Verifique as <b>vari√°veis ‚Äã‚Äãde ambiente</b> e insira o nome <b>ANDROID_HOME</b> no campo e especifique <b>/ var / lib / android-sdk /</b> no campo (especificamos esses dados no Dockerfile como o diret√≥rio inicial do Android SDK). <br><br><img src="https://habrastorage.org/webt/on/af/4j/onaf4jfhel5_ys078k5ohrxwxuu.png"><br><br>  Clique no bot√£o <b>Salvar</b> , saia desta se√ß√£o de configura√ß√µes e v√° para a se√ß√£o <b>Configura√ß√£o Global de Ferramentas</b> . <br><br><img src="https://habrastorage.org/webt/b9/3i/zx/b93izxlndc-utyrnewgv5kluug0.png"><br><br>  Configure a parti√ß√£o <b>JDK</b> (onde a vari√°vel JAVA_HOME tamb√©m foi preenchida por n√≥s no Dockerfile e podemos usar seu valor <b>/ usr / lib / jvm / java-8-openjdk-amd64 / aqui</b> ). <br><br><img src="https://habrastorage.org/webt/0l/wn/2p/0lwn2prv62virmofscvskc5e6_8.png"><br><br>  Tamb√©m aqui ainda precisamos preencher a se√ß√£o <b>Gradle</b> .  Selecionamos e instalamos a vers√£o do Gradle usada nos projetos que voc√™ construir√° usando esse sistema de IC.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode ter v√°rias vers√µes. Voc√™ tamb√©m n√£o pode iniciar a vari√°vel Gradle se tiver gradlew no reposit√≥rio, por exemplo, e puder constru√≠-la com ela. </font></font><br><br><img src="https://habrastorage.org/webt/0q/fe/wj/0qfewj73fbwr3vzudpk8woyrsmy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com isso, podemos terminar nossa primeira etapa. O sistema Jenkins est√° totalmente operacional e podemos personalizar a tarefa de compila√ß√£o. Observe que o sistema foi ajustado √†s nossas necessidades e aqui pode n√£o fornecer o que voc√™ precisa - por exemplo, n√£o h√° emuladores Android para testes e NDK.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se este artigo interessar a algu√©m, continuarei na segunda parte com um exemplo de um ou dois aborrecimentos, descreverei a integra√ß√£o de Jenkins e Bitbucket (√© ele, n√£o o Github, porque √© mais f√°cil com reposit√≥rios particulares gratuitos e artigos na Internet sobre √© menor, mas talvez mais divertido), mostrarei como fazer amizade com a chave ssh do reposit√≥rio do cont√™iner, sobre notifica√ß√µes por email e v√°rios outros chips. </font><font style="vertical-align: inherit;">Em geral, sobre tudo o que configuramos. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pe√ßo-lhe para n√£o chutar muito, este √© o meu primeiro artigo sobre Habr. </font><font style="vertical-align: inherit;">Bom para todos!</font></font></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443606/">https://habr.com/ru/post/pt443606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443594/index.html">A encruzilhada de testes e arquitetura: uma entrevista com Neil Ford</a></li>
<li><a href="../pt443598/index.html">H√° uma revoga√ß√£o em massa de certificados TLS de muitas CAs, geradas por engano em um RNG de 63 bits em vez de em 64 bits</a></li>
<li><a href="../pt443600/index.html">As melhores e piores tend√™ncias do MWC 2019</a></li>
<li><a href="../pt443602/index.html">O que √© aliasing estrito e por que devemos nos importar? Parte 2</a></li>
<li><a href="../pt443604/index.html">M√ìVEL PRIMEIRO: Hackathon em OZON</a></li>
<li><a href="../pt443608/index.html">Smart Home / Atualiza√ß√µes na Lazurite</a></li>
<li><a href="../pt443612/index.html">Usamos HDDs ruins antigos</a></li>
<li><a href="../pt443614/index.html">YouTrack 2019.1: selecione placas √°geis, campos de cart√µes personaliz√°veis ‚Äã‚Äãem placas √°geis e muito mais</a></li>
<li><a href="../pt443616/index.html">Retorno de estoque de 35% em dados alternativos</a></li>
<li><a href="../pt443618/index.html">Emulador de computador dos anos 80 no navegador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>