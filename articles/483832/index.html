<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèµÔ∏è üï¥üèø üß° RxJava a Coroutines: migraci√≥n de caracter√≠sticas de extremo a extremo üï∑Ô∏è üññüèª üç∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(publicado originalmente en Medium ) 

 Las rutinas de Kotlin son mucho m√°s que simples hilos livianos: son un nuevo paradigma que ayuda a los desarro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava a Coroutines: migraci√≥n de caracter√≠sticas de extremo a extremo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483832/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/id/pq/jbidpqpivwqpagw9azop_fswram.png" alt="imagen"></div><br>  (publicado originalmente en <a href="https://link.medium.com/OJ7ed2RCd3" rel="nofollow">Medium</a> ) <br><br>  Las rutinas de Kotlin son mucho m√°s que simples hilos livianos: son un nuevo paradigma que ayuda a los desarrolladores a lidiar con la concurrencia de una manera <a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952" rel="nofollow">estructurada</a> e idiom√°tica. <br><br>  Al desarrollar una aplicaci√≥n de Android, se deben considerar muchas cosas diferentes: quitar operaciones de larga duraci√≥n del hilo de la interfaz de usuario, manejar eventos del ciclo de vida, cancelar suscripciones, volver al hilo de la interfaz de usuario para actualizar la interfaz de usuario.  En los √∫ltimos a√±os, RxJava se convirti√≥ en uno de los marcos m√°s utilizados para resolver este conjunto de problemas.  En este art√≠culo, lo guiar√© a trav√©s de la migraci√≥n de caracter√≠sticas de extremo a extremo de RxJava a las rutinas. <br><a name="habracut"></a><br><h4>  Caracter√≠stica </h4><br>  La funci√≥n que vamos a convertir en corutinas es bastante simple: cuando el usuario env√≠a un pa√≠s, hacemos una llamada API para verificar si el pa√≠s es elegible para una b√∫squeda de detalles comerciales a trav√©s de un proveedor como <a href="https://www.gov.uk/government/organisations/companies-house" rel="nofollow">Companies House</a> .  Si la llamada fue exitosa, mostramos la respuesta, si no, el mensaje de error. <br><br><h4>  Migraci√≥n </h4><br><img src="https://habrastorage.org/webt/j0/0h/kg/j00hkgwjgnuwnzz4lsgdf5ry_fa.png" align="left"><br>  Vamos a migrar nuestro c√≥digo en un enfoque ascendente comenzando con el servicio Retrofit, pasando a una capa de Repositorio, luego a una capa de Interactor y finalmente a un Modelo de Vista. <br><br>  Las funciones que actualmente devuelven Single deber√≠an convertirse en funciones de suspensi√≥n y las funciones que devuelven Observable deber√≠an devolver Flow.  En este ejemplo en particular, no vamos a hacer nada con Flows. <br><br><h4>  Servicio de modernizaci√≥n </h4><br>  Pasemos directamente al c√≥digo y refactoricemos el m√©todo businessLookupEligibility en BusinessLookupService a las rutinas.  As√≠ es como se ve ahora. <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: Single&lt;NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt;&gt; }</code> </pre> <br>  Pasos de refactorizaci√≥n: <br><br><ol><li>  A partir de la <a href="" rel="nofollow">versi√≥n 2.6.0,</a> Retrofit admite el modificador de suspensi√≥n.  Convirtamos el m√©todo businessLookupEligibility en una funci√≥n de suspensi√≥n. </li><li>  Retire el contenedor individual del tipo de retorno. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt; }</code> </pre><br>  NetworkResponse es una clase sellada que representa BusinessLookupEligibilityResponse o ErrorResponse.  NetworkResponse se construye en un adaptador de llamada Retrofit personalizado.  De esta forma, restringimos el flujo de datos a solo dos casos posibles: √©xito o error, de modo que los consumidores de BusinessLookupService no tengan que preocuparse por el manejo de excepciones. <br><br><h4>  Repositorio </h4><br>  Continuemos y veamos lo que tenemos en BusinessLookupRepository.  En el cuerpo del m√©todo businessLookupEligibility llamamos a businessLookupService.businessLookupEligibility (el que acabamos de refactorizar) y utilizamos el operador de mapa de RxJava para transformar NetworkResponse en un modelo de respuesta de resultado y mapa al modelo de dominio.  Result es otra clase sellada que representa Result.Success y contiene el objetoBusinessLookupEligibility en caso de que la llamada a la red haya sido exitosa.  Si hubo un error en la llamada de red, la excepci√≥n de deserializaci√≥n o algo m√°s sali√≥ mal, construimos Result.Failure con un mensaje de error significativo (ErrorMessage es <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">typealias</a> para String). <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> businessLookupService.businessLookupEligibility(countryCode) .map { response -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@map</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (response) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } }.subscribeOn(schedulerProvider.io()) } }</code> </pre><br>  Pasos de refactorizaci√≥n: <br><br><ol><li>  businessLookupEligibility se convierte en una funci√≥n de suspensi√≥n. </li><li>  Retire el contenedor individual del tipo de retorno. </li><li>  Los m√©todos en el repositorio generalmente realizan tareas de larga duraci√≥n, como llamadas de red o consultas db.  Es responsabilidad del repositorio especificar en qu√© hilo se debe realizar este trabajo.  Por subscribeOn (SchedulerProvider.io ()) le estamos diciendo a RxJava que el trabajo debe hacerse en el hilo io.  ¬øC√≥mo podr√≠a lograrse lo mismo con las corutinas?  Vamos a usar withContext con un despachador espec√≠fico para cambiar la ejecuci√≥n del bloque a los diferentes subprocesos y volver al despachador original cuando se complete la ejecuci√≥n.  Es una buena pr√°ctica asegurarse de que una funci√≥n sea segura para usar maincontext.  Los consumidores de BusinessLookupRepository no deber√≠an pensar qu√© hilo deber√≠an usar para ejecutar el m√©todo businessLookupEligibility, deber√≠a ser seguro llamarlo desde el hilo principal. </li><li>  Ya no necesitamos el operador de mapa, ya que podemos usar el resultado de businessLookupService.businessLookupEligibility en un cuerpo de una funci√≥n de suspensi√≥n. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dispatcherProvider: DispatcherProvider ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = withContext(dispatcherProvider.io) { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response = businessLookupService.businessLookupEligibility(countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } } }</code> </pre><br><h4>  Interactractor </h4><br>  En este ejemplo espec√≠fico, BusinessLookupEligibilityInteractor no contiene ninguna l√≥gica adicional y sirve como un proxy para BusinessLookupRepository.  Utilizamos la <a href="https://kotlinlang.org/docs/reference/operator-overloading.html" rel="nofollow">sobrecarga del operador de</a> invocaci√≥n para que se pueda invocar al interactor como una funci√≥n. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br>  Pasos de refactorizaci√≥n: <br><br><ol><li>  invocar diversi√≥n del operador se convierte en suspender invocaci√≥n divertida del operador. </li><li>  Retire el contenedor individual del tipo de retorno. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br><h4>  ViewModel </h4><br>  En BusinessProfileViewModel llamamos BusinessLookupEligibilityInteractor que devuelve Single.  Nos suscribimos a la secuencia y la observamos en el subproceso de la interfaz de usuario especificando el planificador de la interfaz de usuario.  En caso de √©xito, asignamos el valor de un modelo de dominio a un BusinessViewState LiveData.  En caso de falla, asignamos un mensaje de error. <br><br>  Agregamos todas las suscripciones a CompositeDisposable y las desechamos en el m√©todo onCleared () del ciclo de vida de ViewModel. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> disposables = CompositeDisposable() <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { disposables.add(businessLookupEligibilityInteractor(country.countryCode) .observeOn(schedulerProvider.ui()) .subscribe { state -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@subscribe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } }) } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void onCleared() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCleared(); disposables.clear(); } }</code> </pre><br>  Pasos de refactorizaci√≥n: <br><br><ol><li>  Al comienzo del art√≠culo, mencion√© una de las principales ventajas de las corutinas: la concurrencia estructurada.  Y aqu√≠ es donde entra en juego.  Cada corutina tiene un alcance.  El alcance tiene control sobre una corutina a trav√©s de su trabajo.  Si se cancela un trabajo, tambi√©n se cancelar√°n todas las rutinas en el √°mbito correspondiente.  Usted es libre de crear sus propios √°mbitos, pero en este caso vamos a aprovechar viewModel lifecycle-aware viewModelScope.  Comenzaremos una nueva rutina en viewModelScope usando viewModelScope.launch.  La rutina se lanzar√° en el hilo principal ya que viewModelScope tiene un despachador predeterminado: Dispatchers.Main.  Se inici√≥ una rutina en los Despachadores. Main no bloquear√° el hilo principal mientras est√© suspendido.  Como acabamos de lanzar una rutina, podemos invocar al operador de suspensi√≥n businessLookupEligibilityInteractor y obtener el resultado.  businessLookupEligibilityInteractor llama a BusinessLookupRepository.businessLookupEligibility lo que transfiere la ejecuci√≥n a Dispatchers.IO y nuevamente a Dispatchers.Main.  Como estamos en el hilo de la interfaz de usuario, podemos actualizar businessViewState LiveData asignando un valor. </li><li>  Podemos deshacernos de los elementos desechables ya que viewModelScope est√° vinculado a un ciclo de vida de ViewModel.  Cualquier rutina lanzada en este √°mbito se cancela autom√°ticamente si se borra el ViewModel. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { viewModelScope.launch { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = businessLookupEligibilityInteractor(country.countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } } } }</code> </pre><br><h4>  Para llevar clave </h4><br>  Leer y comprender el c√≥digo escrito con corutinas es bastante f√°cil, sin embargo, es un cambio de paradigma que requiere un poco de esfuerzo para aprender c√≥mo abordar la escritura de c√≥digo con corutinas. <br><br>  En este art√≠culo no cubr√≠ las pruebas.  Utilic√© la biblioteca <a href="https://mockk.io/" rel="nofollow">mockk</a> porque tuve problemas para probar las corutinas con Mockito. <br><br>  Todo lo que he escrito con Rx Java lo encontr√© bastante f√°cil de implementar con corutinas, <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" rel="nofollow">flujos</a> y <a href="https://kotlinlang.org/docs/reference/coroutines/channels.html" rel="nofollow">canales</a> .  Una de las ventajas de las corutinas es que son una caracter√≠stica del lenguaje Kotlin y est√°n evolucionando junto con el lenguaje. </div></div><p>Source: <a href="https://habr.com/ru/post/483832/">https://habr.com/ru/post/483832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483818/index.html">Motor, lenguaje de script y novela visual: en 45 horas</a></li>
<li><a href="../483820/index.html">Lo que afecta la emisi√≥n de cr√©dito. Descripci√≥n general de la competencia de riesgo de incumplimiento de cr√©dito de vivienda</a></li>
<li><a href="../483822/index.html">5 caracter√≠sticas de JavaScript sin las cuales no podr√≠a escribir c√≥digo</a></li>
<li><a href="../483826/index.html">Conexi√≥n de un sensor de CO2 Modelo MH-Z19B utilizando la salida anal√≥gica Vo</a></li>
<li><a href="../483830/index.html">Enrutamiento para iOS: navegaci√≥n universal sin reescribir la aplicaci√≥n</a></li>
<li><a href="../483834/index.html">Debian: simplemente convirtiendo i386 en amd64</a></li>
<li><a href="../483842/index.html">La historia de la creaci√≥n de una nube dom√©stica. Parte 5. Actualizaci√≥n 2019 - PHP 7.2, MariaDB 10.4 y Nextcloud 17</a></li>
<li><a href="../483844/index.html">An√°lisis de documentos reglamentarios sobre protecci√≥n de la informaci√≥n en el sector financiero y crediticio ruso</a></li>
<li><a href="../483846/index.html">Gesti√≥n alternativa de ventanas en Linux</a></li>
<li><a href="../483850/index.html">Ning√∫n dios quema ollas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>