<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìç üë®üèª‚Äçüíº üî© Como fazer uma atualiza√ß√£o autom√°tica de um cliente de jogo online üöõ ‚óæÔ∏è üíáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, falarei sobre como criei um sistema de atualiza√ß√£o autom√°tica para um jogo de cliente online. Link para a fonte (Delphi) no final do art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fazer uma atualiza√ß√£o autom√°tica de um cliente de jogo online</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423207/">  Neste artigo, falarei sobre como criei um sistema de atualiza√ß√£o autom√°tica para um jogo de cliente online.  Link para a fonte (Delphi) no final do artigo.  Na verdade, eu implementei esse recurso nos meus dois jogos, e se a primeira panqueca sair um pouco irregular (no jogo Spectromancer), a segunda implementa√ß√£o ser√° muito conveniente e eficaz.  Este √© o meu primeiro artigo sobre Habr√©, por isso n√£o bata muito, mas aponte as falhas nos coment√°rios :) <br><br><h2>  Algoritmo de atualiza√ß√£o do jogo </h2><br><ul><li>  Verificando a vers√£o para atualiza√ß√£o. </li><li>  Baixe a lista de arquivos da vers√£o atual. </li><li>  Download de arquivos novos ou alterados para uma pasta tempor√°ria. </li><li>  Instalando a atualiza√ß√£o - trazendo os arquivos do cliente instalado de acordo com a lista. </li><li>  Iniciando um cliente atualizado. </li></ul><a name="habracut"></a><br><h3>  Verifica√ß√£o de vers√£o </h3><br>  Antes de tudo, ao iniciar, o cliente solicita ao servidor o n√∫mero da vers√£o atual (X) e o n√∫mero do m√≠nimo permitido sem atualiza√ß√£o (Y).  Se a vers√£o do cliente n√£o for inferior a Y, n√£o ser√° necess√°ria uma atualiza√ß√£o; caso contr√°rio, o cliente iniciar√° o utilit√°rio de atualiza√ß√£o " <b>GetNewVersion.exe X</b> " e ser√° encerrado. <br><br>  Como voc√™ pode ver, o n√∫mero da vers√£o √© passado pelo par√¢metro - isso permite atualizar o jogo para qualquer vers√£o dispon√≠vel no servidor e reduzi-lo ainda mais.  Se o par√¢metro n√£o for passado, o pr√≥prio utilit√°rio solicitar√° o n√∫mero da vers√£o atual do servidor.  O n√∫mero da vers√£o √© apenas um n√∫mero inteiro, o esquema de numera√ß√£o pode ser qualquer, por exemplo, minha vers√£o 1.12 corresponde ao n√∫mero 1120. <br><br>  A resposta do servidor n√£o vem instantaneamente e, antes de receb√™-la, n√£o podemos criar a janela do jogo, porque voc√™ pode fech√°-la imediatamente, e as oscila√ß√µes incompreens√≠veis na tela n√£o s√£o de todo o que precisamos.  O tempo limite da resposta teria que levar algo, e o cliente est√° ocupado carregando / descompactando os JPEGs mais pesados.  Voc√™ tamb√©m n√£o pode esperar muito: o jogador lan√ßou o jogo - mas nada acontece na tela, uma bagun√ßa.  Portanto, se dentro de 1,0 s.  a resposta do servidor n√£o chegou - o carregamento do jogo continua da maneira usual.  Isso n√£o √© grande coisa: assim que o jogador tentar fazer login no servidor, ele receber√° uma mensagem sobre a necessidade de atualizar o cliente ou que o servidor est√° indispon√≠vel. <br><br><h3>  Baixar lista de arquivos </h3><br>  Sabendo o n√∫mero da vers√£o, o utilit√°rio de atualiza√ß√£o baixa a lista de arquivos em: <code>[base_ur]&gt;/[]/filelist</code> <br>  Esta √© apenas uma lista de arquivos CSV com soma de verifica√ß√£o, bem como tamanhos compactados e descompactados, cada linha se parece com isso: <br> <code>18*Priest.tga;1053151921D9;91719;107372</code> <br>  Aqui "18 *" significa que 18 caracteres no nome do arquivo s√£o iguais ao arquivo anterior.  Como os arquivos geralmente seguem em ordem alfab√©tica e os caminhos podem ser longos - isso economiza significativamente o tamanho do arquivo da lista.  Para um servidor Web no qual a compacta√ß√£o n√£o est√° ativada, isso significa que o arquivo ser√° baixado mais rapidamente e a atualiza√ß√£o ser√° iniciada mais cedo. <br><br><h3>  Baixar arquivos novos ou alterados </h3><br>  N√£o sabemos quantos anos o cliente do jogo tem, talvez alguns arquivos tenham sido alterados ou exclu√≠dos manualmente.  N√£o queremos fazer download demais, portanto, ap√≥s receber a lista de arquivos, o utilit√°rio come√ßa a verific√°-los para atualiza√ß√µes: se o arquivo estiver faltando na pasta do jogo ou se sua soma de verifica√ß√£o for diferente, o arquivo ser√° adicionado √† fila de download.  Ao mesmo tempo, n√£o √© poss√≠vel carregar mais de 2 arquivos - isso √© suficiente para que, por um lado, o download n√£o diminua a velocidade, mas, por outro lado, ocorre sequencialmente. <br><br><img src="https://habrastorage.org/webt/a1/ka/fw/a1kafw5r2dgdbsow7gd0pou5a5o.png"><br><br>  Um t√≥pico especial √© a exibi√ß√£o do progresso.  At√© a lista inteira ter sido processada, n√£o sabemos exatamente quantos arquivos baixar e qual o tamanho.  No entanto, assim que o primeiro arquivo √© carregado, j√° podemos exibir algumas informa√ß√µes.  De fato, o progresso exibe a fila de downloads: quanto baixar e quanto j√° foi baixado. <br><br>  Os arquivos baixados s√£o descompactados imediatamente e salvos em uma pasta tempor√°ria. Eu uso a biblioteca <code>zlib</code> para compacta√ß√£o. <br><br>  Quando a lista inteira de arquivos foi processada e todos os downloads foram conclu√≠dos, o utilit√°rio verifica a presen√ßa do arquivo <code>changes.txt</code> e, se existir, o exibe.  O usu√°rio √© solicitado a iniciar o procedimento de atualiza√ß√£o.  Antes de clicar no bot√£o "Atualizar", ainda n√£o foram feitas altera√ß√µes na pasta do jogo. Assim, voc√™ pode optar por sair sem problemas. <br><br>  A prop√≥sito, se o usu√°rio interromper o download ou se recusar a instalar, na pr√≥xima vez em que ele n√£o precisar baixar todos os arquivos novamente: antes de baixar o pr√≥ximo arquivo, o utilit√°rio verificar√° sua presen√ßa na pasta tempor√°ria e, se a soma de verifica√ß√£o corresponder, o download ser√° considerado bem-sucedido. <br><br><img src="https://habrastorage.org/webt/kj/e_/rf/kje_rfnc4gaxycjafbze_3zurli.png"><br><br>  Mas quando voc√™ clica em "Atualizar", o utilit√°rio inicia outro utilit√°rio - " <b>InstallUpdate.exe</b> " e √© encerrado. <br><br><h3>  Instalar atualiza√ß√£o </h3><br>  Por que preciso de outro utilit√°rio?  √â simples: para atualizar os arquivos do jogo, voc√™ precisa executar com direitos de administrador.  Mas baixar a atualiza√ß√£o, pelo contr√°rio, √© contra-indicada.  Porque, a menos que voc√™ seja um feliz propriet√°rio de um certificado de assinatura de c√≥digo EV, iniciar o processo com direitos de administrador exibir√° a janela UAC.  E se, ao iniciar o jogo, em vez da interface usual, o jogador v√™ o seguinte: <br><br><img src="https://habrastorage.org/webt/mo/gl/6p/mogl6p0zghhphcq9rlpivwskle0.png"><br><br>  ... ent√£o esse √©, pelo menos, um motivo para tomar cuidado, ou mesmo abandonar completamente o lan√ßamento.  Outra coisa, com o consentimento manual para instalar a atualiza√ß√£o - nesse contexto, a janela do UAC √© percebida normalmente.  Infelizmente, um processo no Windows n√£o pode elevar seus direitos em tempo de execu√ß√£o - essa propriedade permanece inalterada desde o lan√ßamento.  Portanto, eu uso dois arquivos separados.  De fato, <code>GetNewVersion.exe</code> e <code>InstallUpdate.exe</code> s√£o o mesmo utilit√°rio, os arquivos s√£o id√™nticos.  E a a√ß√£o √© determinada pelos par√¢metros transmitidos e pelo nome do arquivo execut√°vel. <br><br>  Portanto, ao ser iniciado, o InstallUpdate copia os arquivos do cliente do jogo da pasta tempor√°ria para a pasta do jogo e, em seguida, inicia o cliente atualizado e finaliza.  Nesse caso, o arquivo <code>GetNewVersion.exe</code> tamb√©m pode ser atualizado. <br><br>  Todas as a√ß√µes, bem como os erros que ocorrem, s√£o registrados em detalhes no log, o que √© muito √∫til para depura√ß√£o. <br><br><h2>  O processo de prepara√ß√£o de uma nova vers√£o </h2><br>  Examinamos o esquema de opera√ß√£o de atualiza√ß√£o do ponto de vista do cliente do jogo, mas como fazer tudo funcionar?  Para preparar novas compila√ß√µes, escrevi outro utilit√°rio - <b>CompressBuild</b> .  Ele verifica recursivamente uma pasta, compacta arquivos usando o m√©todo Deflate e grava informa√ß√µes sobre eles na lista de <code>filelist</code> - lista de <code>filelist</code> .  Ap√≥s a compacta√ß√£o, o s√≠mbolo "_" √© anexado ao nome do arquivo.  Os arquivos compactados n√£o s√£o compactados novamente; portanto, se necess√°rio, somente arquivos individuais podem ser atualizados na pasta de compila√ß√£o; o CompressBuild os atualizar√° apenas. <br><br>  Alguns arquivos no cliente do jogo mudam durante a opera√ß√£o, por exemplo, cont√™m configura√ß√µes.  Esses arquivos devem ser ignorados, o utilit√°rio pega os modelos apropriados no arquivo de exclus√£o.  Ou seja, esses arquivos simplesmente n√£o entram na lista de <code>filelist</code> e n√£o se deterioram no cliente durante a atualiza√ß√£o. <br><br>  Assim, para preparar uma nova compila√ß√£o, preciso: <br><br>  1. Copie a pasta <code>\master</code> para <code>\[_]</code> <br>  2. Execute o <b>CompressBuild</b> , que compactar√° os arquivos e far√° uma lista deles. <br>  3. Carregue tudo no site do jogo. <br>  4. Altere no servidor do jogo o n√∫mero da vers√£o atual para o n√∫mero que acabou de baixar.  Voila! <br><br>  A partir de agora, ao atualizar as pessoas, receber√° uma nova vers√£o. <br><br>  Bem, pastas com vers√µes antigas no servidor podem ser exclu√≠das para n√£o ocupar espa√ßo. <br><br><h2>  Conclus√£o </h2><br>  Obviamente, meu sistema de atualiza√ß√£o n√£o √© perfeito e n√£o apresenta falhas.  Por exemplo, se um arquivo foi exclu√≠do no cliente, ele permanecer√° com os players.  Se o arquivo tiver sido renomeado, ele ser√° baixado como novo e a inst√¢ncia antiga n√£o ser√° exclu√≠da.  Voc√™ pode, √© claro, refinar o utilit√°rio de atualiza√ß√£o adicionando comandos para excluir / renomear arquivos √† lista de arquivos, mas, em geral, esses problemas n√£o s√£o relevantes para o meu jogo, ent√£o n√£o me incomodei. <br><br>  Bem, voc√™ pode obter a fonte aqui: <a href="">astralheroes.com/files/UpdaterSrc.zip</a> <br>  (compilado no Delphi-2006 / Turbo Delphi, n√£o posso garantir outros compiladores). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423207/">https://habr.com/ru/post/pt423207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423193/index.html">Configurar notifica√ß√µes por push da Web usando pywebpush passo a passo</a></li>
<li><a href="../pt423195/index.html">O que h√° de novo no JPA 2.2</a></li>
<li><a href="../pt423197/index.html">LOLWUT: uma obra de arte em uma equipe de db</a></li>
<li><a href="../pt423203/index.html">L√≠der de equipe legal ser√° respons√°vel pelo servi√ßo</a></li>
<li><a href="../pt423205/index.html">Projeto de armazenamento no MS SQL Server, integra√ß√£o com 1C 7.7 e automa√ß√£o de desenvolvimento em SSDT</a></li>
<li><a href="../pt423209/index.html">Formul√°rio 2 do assassino? Vis√£o geral da impressora 3D dental MoonRay S100</a></li>
<li><a href="../pt423211/index.html">Comit√™ da Duma do Estado: gostos e republica√ß√µes permanecer√£o criminalmente respons√°veis</a></li>
<li><a href="../pt423213/index.html">Como no russo antigo, haver√° "este √© um teste"</a></li>
<li><a href="../pt423215/index.html">Onde est√° meu dinheiro, cara: sobre o que o Steam est√° calado</a></li>
<li><a href="../pt423217/index.html">De volta ao futuro: confirma√ß√£o pr√°tica da teoria de Tomonaga-Luttinger ap√≥s quase 56 anos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>