<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèª üîö ü•ì Postfix - amavisd-new sin localhost o servidor de correo de una nueva manera üèÇ ü§í üõçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hay muchas instrucciones sobre c√≥mo elevar el servidor de correo en un mont√≥n de postfix - amavisd-new - dovecot. Y la gran mayor√≠a de ellos se repite...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Postfix - amavisd-new sin localhost o servidor de correo de una nueva manera</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415597/">  Hay muchas instrucciones sobre c√≥mo elevar el servidor de correo en un mont√≥n de postfix - amavisd-new - dovecot.  Y la gran mayor√≠a de ellos se repiten casi al pie de la letra, incluidos errores e inexactitudes. <br><br>  Me parece aburrido presionar los botones sin pensarlo, as√≠ que decid√≠ optimizar la configuraci√≥n est√°ndar: ¬øqu√© pasa si construyo la interacci√≥n de postfix y amavisd-new no a trav√©s de localhost, sino en un socket unix? <br><br>  Al final result√≥ que, no todo es tan simple, ¬°pero lo hice!  Instrucci√≥n y parche debajo del corte. <br><a name="habracut"></a><br>  Honestamente, generalmente no me gusta la interacci√≥n a trav√©s de localhost dentro de la misma m√°quina.  Si desea organizar el intercambio de datos entre dos aplicaciones, entonces es mucho m√°s correcto, m√°s seguro y requiere menos recursos hacer esto a trav√©s de un socket Unix en el sistema de archivos.  Adem√°s, de esta manera puede organizar la protecci√≥n (por medio de derechos en el sistema de archivos) incluso cuando est√° ausente a nivel de aplicaci√≥n o protocolo. <br><br>  Entonces, la ruta de correo en el grupo discutido se ve as√≠: <br><br><img src="https://habrastorage.org/webt/2a/yj/lx/2ayjlxnatjoqpaofqg3trbsi9sc.png"><br><br>  Resulta que necesitamos organizar dos conexiones: cuando se transfiere al filtrado y cuando se regresa al MTA.  Dado que el socket es creado por el oyente, en el primer caso ser√° amavisado, y en el segundo, postfix. <br><br>  Comencemos con el segundo, porque es m√°s simple y est√° mejor descrito.  Para que postfix cree un socket de escucha, solo necesita especificar unix, no inet, en la segunda columna de master.cf (columna de tipo).  En este caso, la primera columna define la ruta y el nombre del archivo del socket. <br><br>  Dado que los procesos de postfix funcionan en chroot (esto puede deshabilitarse para un proceso espec√≠fico, pero no vale la pena), debe crear una carpeta dentro del directorio de inicio de postfix: / var / spool / postfix.  Tendr√° ambos enchufes: <br><br><pre><code class="bash hljs">mkdir /var/spool/postfix/amavis chown amavis:postfix /var/spool/postfix/amavis chmod 770 /var/spool/postfix/amavis</code> </pre> <br>  Configuraci√≥n de pozo y postfix: <br><br><pre> <code class="hljs powershell">amavis/postfix<span class="hljs-operator"><span class="hljs-operator">-in</span></span> unix y - y - - smtpd <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_client_restrictions=<span class="hljs-variable"><span class="hljs-variable">$local_clients_only</span></span> <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_helo_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_sender_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_recipient_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_milters=</code> </pre><br>  Las opciones espec√≠ficas dependen de su configuraci√≥n, esta es mi opci√≥n. <br><br>  Hay dos problemas: <br><br><ol><li>  La ruta ser√° relativa a / var / spool / postfix / private, que est√° sujeta a permisos muy estrictos. </li><li>  No estoy seguro de si esto es cierto en todas las distribuciones, pero en Ubuntu con seguridad.  Es mejor no tocar los derechos de la carpeta (los sockets de todos los servicios de postfix est√°n ah√≠), es mejor crear un enlace simb√≥lico. </li><li>  Adem√°s del socket, postfix tambi√©n crea un archivo pid para el proceso, cuyo nombre es generado autom√°ticamente por la m√°scara de $ type. $ Name.  Donde type ser√° igual a unix, y el nombre se toma de la primera columna de master.cf.  Resulta unux.amavis / postfix-in, es decir  archivo en una subcarpeta.  √âl mismo no lo crear√° y caer√° con un error. </li></ol><br>  Entonces, sustituimos las muletas: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/spool/postfix/private ln -s ../amavis . mkdir /var/spool/postfix/pid/unix.amavis</code> </pre><br>  No es muy agradable, pero no es destructivo para la estructura de carpetas normal del paquete. <br><br>  Reiniciamos postfix y nos aseguramos de que el archivo socket aparezca en la carpeta amavis y el archivo pid en pid / unix.amavis.  Desafortunadamente, los derechos del socket son 666, pero los derechos de la carpeta que cre√≥ anteriormente proteger√°n el archivo de ojos innecesarios. <br><br>  Puede verificar el trabajo con el comando: <br><br><pre> <code class="bash hljs">netcat -U /var/spool/postfix/amavis/postfix-in 220 mail.example.ru ESMTP Postfix</code> </pre><br>  Pues lo hicieron.  Ahora para amavisd. <br><br>  Primero, configure la ruta de retorno del correo a trav√©s del socket Unix propiedad de Postfix.  Esto funciona fuera de la caja: <br><br><pre> <code class="perl hljs">$forward_method = <span class="hljs-string"><span class="hljs-string">'smtp:/var/spool/postfix/amavis/postfix-in'</span></span>; $notify_method = \$forward_method;</code> </pre><br>  Bueno, ahora la parte m√°s dif√≠cil es configurar enchufes en amavisd.  La soluci√≥n se puede encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Internet</a> , pero all√≠ se propone utilizar un solo socket especificado por el par√°metro $ unix_socketname.  Tambi√©n quer√≠a mi propio protocolo amavisd-new (AM.PDP) y recepci√≥n de correo a trav√©s de sockets. <br><br>  El archivo de configuraci√≥n predeterminado contiene una referencia a la directiva @listen_sockets, pero no tiene una descripci√≥n.  ¬°Pero est√° en las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">notas de la versi√≥n</a> , incluso con ejemplos!  Es cierto, solo hay un z√≥calo, pero ¬øqu√© le impide intentarlo? <br><br>  OK, pero ¬øc√≥mo configurar el protocolo para el socket (que se especifica en el banco de pol√≠ticas)?  En todos los ejemplos, simplemente escriben SOCK.  Por analog√≠a con los z√≥calos de entrada (puede especificar el puerto host all√≠), le suger√≠ que necesitara especificar la ruta completa al archivo del z√≥calo.  Esto es lo que sucedi√≥: <br><br><pre> <code class="perl hljs">$unix_socketname = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_bind = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_port = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; @listen_sockets = (<span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span>); $unix_socket_mode = <span class="hljs-number"><span class="hljs-number">0660</span></span>; %interface_policy = ( <span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span> ); $policy_bank{<span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'LMTP'</span></span> }; $policy_bank{<span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'AM.PDP'</span></span>, <span class="hljs-string"><span class="hljs-string">auth_required_release =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment"># don't require secret-id for release };</span></span></code> </pre><br>  Reiniciar, verificar, de hecho, ¬°se han creado ambos enchufes!  Victoria  En realidad, no, cuando intentas conectarte al socket, no sucede nada y se escribe un error en el registro que indica que el protocolo no est√° definido para √©l.  Resulta que el banco de p√≥lizas no se aplica a ellos. <br><br>  ¬øC√≥mo es eso?  Tuve que ir al c√≥digo. <br><br>  Esta campa√±a trajo dos novedades: como siempre, buenas y malas.  Lo bueno es que la suposici√≥n con respecto a% interface_policy era correcta: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># load policy banks according to my socket (destination), # then check for allowed access from the peer (client/source) # sub access_is_allowed($;$$$$) { my($unix_socket_path, $src_addr, $src_port, $dst_addr, $dst_port) = @_; my(@bank_names); if (defined $unix_socket_path) { push(@bank_names, $interface_policy{"SOCK"}); push(@bank_names, $interface_policy{$unix_socket_path}); } elsif (defined $dst_addr &amp;&amp; defined $dst_port) { $dst_addr = '['.lc($dst_addr).']' if $dst_addr =~ /:[0-9a-f]*:/i; # IPv6? push(@bank_names, $interface_policy{$dst_port}); push(@bank_names, $interface_policy{"$dst_addr:$dst_port"}); } load_policy_bank($_) for @bank_names;</span></span></code> </pre><br>  Lo malo es que $ unix_socket_path entra en esta funci√≥n vac√≠a.  Se llena de la siguiente manera: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $is_ux = $sock &amp;&amp; $sock-&gt;UNIVERSAL::can(<span class="hljs-string"><span class="hljs-string">'NS_proto'</span></span>) &amp;&amp; $sock-&gt;NS_proto eq <span class="hljs-string"><span class="hljs-string">'UNIX'</span></span>;</code> </pre><br>  Y ambas propiedades est√°n vac√≠as all√≠. <br><br>  Un estudio de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> sugiri√≥ esta opci√≥n: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $unix_socket_path = $sock-&gt;hostpath();</code> </pre><br>  ¬°Y funcion√≥!  Listo .patch se puede decir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Ah√≠ est√° el toque final.  Dado que amavisd crea su propio socket con derechos solo para s√≠ mismo, y hemos denegado el acceso al resto (lo cual es cierto), necesitamos agregar postfix al grupo amavis para que pueda escribir en el socket: <br><br><pre> <code class="bash hljs">gpasswd -a postfix amavis</code> </pre><br>  Listo <br><br>  PD: envi√© el parche y la descripci√≥n del problema por Mark Martinec por correo ya que no encontr√© ninguna menci√≥n del rastreador de errores en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio</a> .  Todav√≠a no he recibido una respuesta, pero realmente no cuento con eso: el proyecto parece abandonado (el √∫ltimo lanzamiento hace m√°s de dos a√±os). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es415597/">https://habr.com/ru/post/es415597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es415587/index.html">StereoPi: nuestra pieza de hardware para estudiar visi√≥n artificial, drones y robots</a></li>
<li><a href="../es415589/index.html">"Un poco m√°s sobre DP": las compa√±√≠as de televisi√≥n estadounidenses dejar√°n de vender geodatos de clientes</a></li>
<li><a href="../es415591/index.html">Apple Engineers Trap Trampa para teclado MacBook Pro</a></li>
<li><a href="../es415593/index.html">6 a√±os despu√©s, una nueva versi√≥n de la legendaria distribuci√≥n de accidentes Hiren's BootCD</a></li>
<li><a href="../es415595/index.html">M√©todos para aumentar la retenci√≥n de jugadores usando juegos de SLOT como ejemplo: Parte 1</a></li>
<li><a href="../es415599/index.html">India tambi√©n quiere obtener helio-3</a></li>
<li><a href="../es415601/index.html">Kubernetes HA cl√∫ster con contenedor. ¬øO hay vida sin estibador?</a></li>
<li><a href="../es415605/index.html">C√≥mo ahorramos el procesamiento de la tarjeta con Exadata</a></li>
<li><a href="../es415611/index.html">PKI: bibliotecas GCrypt y KSBA como alternativa a OpenSSL con soporte para criptograf√≠a rusa. Continuaci√≥n</a></li>
<li><a href="../es415613/index.html">¬øPor qu√© no deber√≠as comprar l√°mparas LED?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>