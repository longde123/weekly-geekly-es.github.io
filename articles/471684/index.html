<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö† üë©üèº‚Äçü§ù‚Äçüë©üèª üíë ¬øPor qu√© necesita crear m√≥dulos para nginx? üè© üë©‚Äç‚ù§Ô∏è‚Äçüë© üë®üèø‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nginx es un servidor web que resuelve docenas de tareas comerciales, est√° configurado de forma flexible, escalado y funciona en casi todos los sistema...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øPor qu√© necesita crear m√≥dulos para nginx?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/471684/">  Nginx es un servidor web que resuelve docenas de tareas comerciales, est√° configurado de forma flexible, escalado y funciona en casi todos los sistemas operativos y plataformas.  En un peque√±o folleto se puede describir una lista de caracter√≠sticas, capacidades y problemas que se resolver√°n de inmediato.  Pero a veces, una serie de tareas comerciales se pueden resolver solo desarrollando sus propios m√≥dulos para nginx.  Estos son m√≥dulos que est√°n orientados a los negocios y contienen cierta l√≥gica comercial, y no solo una soluci√≥n de sistema generalizada. <br><br><img src="https://habrastorage.org/webt/_g/qx/cl/_gqxcl-ni0gc2f2rsr7thf4tici.jpeg"><br><br>  En general, todo en nginx son m√≥dulos que alguna vez fueron escritos por alguien.  Por lo tanto, escribir m√≥dulos bajo nginx no solo es posible, sino tambi√©n necesario.  Cuando sea necesario hacerlo y por qu√©, <strong>Vasily Soshnikov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">dedokOne</a> ) contar√° el ejemplo de varios casos. <br><br>  Hablemos de las razones que fomentan la escritura de m√≥dulos en C, la arquitectura y el n√∫cleo de nginx, la anatom√≠a de los m√≥dulos HTTP, los m√≥dulos C, NJS, Lua y nginx.conf.  Es importante saberlo no solo para aquellos que se desarrollan bajo nginx, sino tambi√©n para aquellos que usan nginx-configs, Lua u otro lenguaje dentro de nginx. <br><br>  <em>Nota: el art√≠culo se basa en un informe de Vasily Soshnikov.</em>  <em>El informe se actualiza y actualiza constantemente.</em>  <em>La informaci√≥n en el material es bastante t√©cnica y para aprovecharla al m√°ximo, los lectores deben tener experiencia trabajando con c√≥digo nginx a un nivel promedio y superior.</em> <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/82CyWPpjNNY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Brevemente sobre nginx </h2><br>  <strong>Todo lo que usa con nginx son m√≥dulos</strong> .  Cada directiva en la configuraci√≥n de nginx es un m√≥dulo separado, que fue cuidadosamente escrito por colegas de la comunidad nginx. <br><br>  <strong>Las directivas en nginx.conf tambi√©n son m√≥dulos</strong> que resuelven un problema espec√≠fico.  Por lo tanto, en nginx los m√≥dulos lo son todo.  add_header, proxy_pass, cualquier directiva: son m√≥dulos o combinaciones de m√≥dulos que funcionan de acuerdo con ciertas reglas. <br><br>  <strong>Nginx es un marco</strong> que tiene: red y E / S de archivos, memoria compartida, configuraci√≥n y secuencias de comandos.  Esta es una gran capa de bibliotecas de bajo nivel, en la que puede hacer cualquier cosa para trabajar con las unidades de red. <br><br>  <strong>Nginx es r√°pido y estable, pero complejo</strong> .  Deber√≠a escribir dicho c√≥digo para no perder estas cualidades de nginx.  Los nginx inestables en producci√≥n son clientes insatisfechos, y todo lo que sigue de esto. <br><br><h2>  ¬øPor qu√© crear sus propios m√≥dulos? </h2><br>  <strong>Convierta el protocolo HTTP a otro protocolo.</strong>  Esta es la raz√≥n principal que a menudo motiva la creaci√≥n de un m√≥dulo en particular. <br><br>  Por ejemplo, el m√≥dulo memcached_pass convierte HTTP a otro protocolo y puede trabajar con otros sistemas externos.  El m√≥dulo proxy_pass tambi√©n le permite convertir, aunque de HTTP (s) a HTTP (s).  Otro buen ejemplo es fastcgi_pass. <br><br>  Estas son todas las directivas de la forma: "vaya a tal y tal backend, donde no HTTP (sino en el caso de proxy_pass HTTP)". <br><br>  <strong>Inserci√≥n de contenido din√°mico: omisi√≥n de AdBlock, inserci√≥n de anuncios.</strong>  Por ejemplo, tenemos un back-end y es necesario modificar el contenido que proviene de √©l.  Por ejemplo, AdBlock, que analiza el c√≥digo de inserci√≥n de anuncios, y tenemos que lidiar con √©l para ajustarlo de una forma u otra. <br><br>  Otra cosa que a menudo tiene que hacer para incrustar contenido es el problema con el almacenamiento en cach√© de HLS.  Cuando los par√°metros se almacenan en cach√© dentro de HLS, entonces dos usuarios pueden obtener la misma sesi√≥n o los mismos par√°metros.  A partir de ah√≠, corta o agrega algunos par√°metros cuando necesita rastrear algo. <br><br>  <strong>Recopilaci√≥n de datos de Clickstream desde internet / medidores m√≥viles.</strong>  Un caso popular en mi pr√°ctica.  La mayor√≠a de las veces esto se hace en nginx, pero no en access.log, pero un poco m√°s inteligente. <br><br>  <strong>Convirtiendo todo tipo de contenido.</strong>  Por ejemplo, el m√≥dulo rtmp le permite trabajar no solo con rtmp, sino tambi√©n con HLS.  Este m√≥dulo puede hacer mucho con contenido de video. <br><br>  <strong>Punto de autorizaci√≥n gen√©rico: SEP o Api Gateway.</strong>  Este es el caso cuando nginx funciona como parte de la infraestructura: autoriza, recopila m√©tricas, env√≠a datos a monitoreo y ClickStream.  Nginx funciona aqu√≠ como un centro de infraestructura: un √∫nico punto de entrada para backends. <br><br>  <strong>Enriquecimiento de las solicitudes para su posterior seguimiento.</strong>  Los sistemas modernos son muy complejos, con varios tipos de backends que forman diferentes equipos.  Como regla, son dif√≠ciles de debutar, a veces incluso es dif√≠cil entender de d√≥nde vino la solicitud y hacia d√≥nde se fue.  Para simplificar la depuraci√≥n, algunas grandes empresas utilizan una t√©cnica complicada: agregan ciertos datos a las solicitudes.  El usuario no los ver√°, pero a partir de estos datos es f√°cil rastrear la ruta de solicitud dentro del sistema.  Esto se llama <strong>rastro</strong> . <br><br>  <strong>S3-proxy.</strong>  Este a√±o, a menudo veo personas trabajando con sus objetos a trav√©s de s3.  Pero no es necesario hacer esto en los m√≥dulos C, la infraestructura tambi√©n es suficiente en nginx.  Para resolver algunos de estos problemas, puede usar Lua, algo se est√° resolviendo en NJS.  Pero a veces es necesario escribir m√≥dulos en C. <br><br><h2>  ¬øCu√°ndo es el momento de crear m√≥dulos? </h2><br>  Hay dos criterios para entender que ha llegado el momento. <br><br>  <strong>Generalizaci√≥n de la funcionalidad.</strong>  Cuando comprende que alguien m√°s necesita su producto, est√° contribuyendo a Open Source, creando una funcionalidad generalizada, public√°ndola y permitiendo que se use. <br><br>  <strong>Resolviendo problemas de negocios.</strong>  Cuando una empresa establece requisitos que solo se pueden cumplir escribiendo su propio m√≥dulo para nginx.  Por ejemplo, la inserci√≥n / cambio din√°mico de contenido, la colecci√≥n ClickStream se puede hacer en Lua, pero lo m√°s probable es que no funcione normalmente. <br><br><h2>  Arquitectura Nginx </h2><br>  He estado escribiendo c√≥digo nginx durante mucho tiempo.  Nueve de mis m√≥dulos est√°n girando en producci√≥n, uno de ellos est√° en c√≥digo abierto y en producci√≥n para muchos.  Por lo tanto, tengo experiencia y comprensi√≥n. <br><blockquote>  Nginx es una mu√±eca de anidaci√≥n en la que todo est√° construido alrededor del n√∫cleo. </blockquote>  Entonces entiendo nginx. <br><blockquote>  Los n√∫cleos son envoltorios sobre epoll. </blockquote>  Epoll es un m√©todo que le permite trabajar de forma as√≠ncrona con cualquier archivo descriptor, no solo con sockets, porque un descriptor no es solo un socket. <br><br>  Por encima del n√∫cleo est√°n las cadenas ascendentes, HTTP y secuencias de comandos.  Por scripts, me refiero a nginx.conf, no a NJS.  Adem√°s de upstreams, HTTP y scripting, los m√≥dulos HTTP ya est√°n construidos, de lo que hablaremos. <br><br><img src="https://habrastorage.org/webt/d7/b6/ff/d7b6ffhplgm4ddkbvncbfh4umym.jpeg"><br><br>  Un ejemplo cl√°sico de upstreams y HTTP son servidores upstream: directivas dentro de la configuraci√≥n.  Un ejemplo de m√≥dulos para HTTP es add_header.  Un ejemplo de scripting es el archivo de configuraci√≥n en s√≠.  El archivo contiene los m√≥dulos en los que consta nginx; se interpreta de alguna manera y le permite hacer algo como administrador o como usuario. <br><br>  No consideraremos el n√∫cleo y nos detendremos brevemente en las aguas arriba, porque es un universo separado dentro de nginx.  La historia sobre ellos es digna de varios art√≠culos. <br><br><h2>  Anatom√≠a de los m√≥dulos HTTP </h2><br>  Incluso si no escribe c√≥digo C dentro de nginx, pero lo usa, recuerde la regla principal. <br><blockquote>  En nginx, todo obedece al patr√≥n de la Cadena de Responsabilidad - COR. </blockquote>  No s√© c√≥mo traducir esto al ruso, pero describir√© la l√≥gica.  Su solicitud pasa por una galaxia de m√≥dulos de cadena configurados, comenzando desde la ubicaci√≥n.  Cada uno de estos m√≥dulos devuelve un resultado.  Si el resultado es malo, la cadena se interrumpe. <br><br><img src="https://habrastorage.org/webt/ky/sf/zj/kysfzj-evntyaf8v8q53ygxgrr4.jpeg"><br><br>  Cuando desarrolle m√≥dulos o use alguna directiva en NJS y Lua, no olvide que su c√≥digo puede bloquear la ejecuci√≥n de esta cadena. <br><br>  La analog√≠a m√°s cercana a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cadena de responsabilidad</a> es una l√≠nea de c√≥digo Bash: <br><br><pre><code class="bash hljs">grep -RI pool nginx | awk -F<span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> | sort -u | wc -l</code> </pre> <br>  En el c√≥digo, todo es bastante simple: si AWK cay√≥ en el medio de la l√≠nea, entonces <code>sort</code> y los siguientes comandos fallar√°n.  El m√≥dulo nginx funciona de manera similar, pero la verdad est√° en nginx y puede solucionarlo: reinicie el c√≥digo.  Pero debe estar preparado para bloquearse y ejecutarse, al igual que los m√≥dulos que usa en la configuraci√≥n, pero no el hecho de que esto sea as√≠. <br><br><h3>  Tipos de m√≥dulos HTTP </h3><br><blockquote>  HTTP y nginx son un mont√≥n de PHASE diferentes. </blockquote><br><ul><li>  <strong>Manejo de fase: manejadores de FASE</strong> . </li><li>  <strong>Filtros: filtros de cuerpo / encabezados</strong> .  Este filtrado es encabezados o cuerpos de solicitud. </li><li>  <strong>Proxies</strong> .  Los m√≥dulos proxy t√≠picos son proxy_pass, fastcgi_pass, memcached_pass. </li><li>  <strong>M√≥dulos para balanceo de carga espec√≠fico - Balanceadores de carga</strong> .  Este es el tipo de m√≥dulos m√°s retorcido, no se est√°n desarrollando mucho.  Un ejemplo es el m√≥dulo Ketama CHash, que le permite realizar hashing coherente dentro de nginx para distribuir solicitudes a backends. </li></ul><br>  Le contar√© sobre cada uno de estos tipos y su prop√≥sito. <br><br><h3>  Manejadores de fase </h3><br>  Imagine que tenemos varias fases, comenzando desde la fase de acceso.  Hay varios m√≥dulos en cada fase.  Por ejemplo, la fase ACCESS se divide en una conexi√≥n, una solicitud a nginx, verificaci√≥n de la autorizaci√≥n del usuario.  Cada m√≥dulo es una celda en la cadena.  Puede haber un n√∫mero infinito de tales m√≥dulos en fase. <br><br><img src="https://habrastorage.org/webt/pn/6b/t9/pn6bt9m3khwxmsxgnqjvyzwfcb0.jpeg"><br><br>  El √∫ltimo controlador final es la fase de CONTENIDO en la que el contenido se entrega a pedido. <br><blockquote>  La forma es siempre esta: solicitud - una cadena de controladores - contenido de salida. </blockquote>  Fases disponibles para los desarrolladores de m√≥dulos de las <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_">fuentes NGINX</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { NGX_HTTP_POST_READ_PHASE = <span class="hljs-number"><span class="hljs-number">0</span></span>, NGX_HTTP_SERVER_REWRITE_PHASE, NGX_HTTP_FIND_CONFIG_PHASE, NGX_HTTP_REWRITE_PHASE, NGX_HTTP_POST_REWRITE_PHASE, NGX_HTTP_PREACCESS_PHASE, NGX_HTTP_ACESS_PHASE, NGX_HTTP_POST_ACESS_PHASE, NGX_HTTP_PRECONTENT_PHASE, NGX_HTTP_CONTENT_PHASE, NGX_HTTP_LOG_PHASE, } ngx_http_phases;</code> </pre> <br>  Las fases se pueden sobrescribir, agregue su propio controlador.  No todos son necesarios en la vida real, si no eres el desarrollador de nginx core.  Por lo tanto, no hablar√© sobre cada fase, sino solo sobre las principales que us√©. <br><br>  El principal es <strong>ACCESS_PHASE.</strong>  Es especialmente √∫til agregar su autorizaci√≥n a nginx, para verificar la ejecuci√≥n de la solicitud en t√©rminos de acceso. <br><br>  Las siguientes fases importantes que a menudo exploto son las fases de contenido previo y contenido.  <strong>PRECONTENT_PHASE le</strong> permite recopilar m√©tricas sobre el contenido que est√° a punto de enviarse como respuesta al cliente.  <strong>CONTENT_PHASE te</strong> permite generar tu propio contenido √∫nico basado en algo. <br><br>  La √∫ltima fase que uso a menudo es la fase de registro <strong>LOG_PHASE.</strong>  Por cierto, la directiva ACCESS_LOG funciona en ella.  La fase de inicio de sesi√≥n tiene las restricciones m√°s salvajes que me vuelven loco: no puede usar subrequest y generalmente no puede usar ninguna solicitud.  Ya ha dejado el contenido al usuario, y no se ejecutar√°n los manejadores, los manejadores posteriores ni ninguna subrequest. <br><br>  Explicar√© por qu√© es molesto.  Digamos cuando quiere cruzar nginx y Kafka en la fase de registro.  En esta fase, todo ya se ha completado: hay un tama√±o calculado del contenido, el estado, todos los datos, pero no puede hacerlo a continuaci√≥n.  No trabajan all√≠.  Debe escribir en sockets desnudos en la fase de registro para enviar datos a Kafka. <br><br><h3>  Filtros de cuerpo / encabezados </h3><br>  Hay dos tipos de filtros: filtros de cuerpo y filtros de encabezados. <br><br>  Un ejemplo de <strong>filtro Body</strong> es el m√≥dulo de filtro gzip.  ¬øPor qu√© se necesitan filtros corporales?  Imagine que tiene un cierto proxy_pass y desea de alguna manera transformar el contenido o analizarlo.  En este caso, debe usar el filtro Cuerpo. <br><br>  Funciona as√≠: muchos trozos vienen a ti, haces algo con ellos, miras el contenido, el agregado, etc.  Pero el filtro tambi√©n tiene limitaciones significativas.  Por ejemplo, si decide cambiar el cuerpo, para insertar o recortar el cuerpo de la respuesta, recuerde que los atributos HTTP, por ejemplo, una fuente de contenido, ser√°n reemplazados.  Esto puede provocar efectos extra√±os si no establece restricciones y se refleja correctamente en su c√≥digo. <br><br>  Un ejemplo de un <strong>filtro de encabezado</strong> es el add_header que todos han usado.  El algoritmo funciona como en el filtro Body.  Se prepara una respuesta para el cliente, y el filtro add_header le permite hacer algo all√≠: agregar encabezado, eliminar encabezado, reemplazar encabezado, enviar subrequest. <br><br>  Por cierto, en el filtro Cuerpo y en el filtro de Encabezado est√°n disponibles las subrequests, incluso puedes enviar identificaciones internas a una ubicaci√≥n adicional all√≠. <br><br><h3>  Proxy </h3><br>  Este es el tipo de m√≥dulos m√°s complejo y controvertido que le permite enviar solicitudes de proxy a sistemas externos, por ejemplo, <strong>convertir HTTP a otro protocolo</strong> .  Ejemplos: proxy_pass, redis_pass, tnt_pass. <br><br>  Proxy es una interfaz que los desarrolladores principales de nginx han propuesto para facilitar la escritura de m√≥dulos proxy.  Si esto se hace de la manera cl√°sica, entonces para dichos controladores proxy PHASES, filtros, se ejecutar√°n Balanceadores.  Sin embargo, si el protocolo al que desea convertir HTTP es de alguna manera diferente de los cl√°sicos, entonces comienzan los grandes problemas.  La API proxy que ofrece nginx simplemente no es adecuada: debe inventar este m√≥dulo proxy desde cero. <br><br>  Un buen ejemplo de dicho m√≥dulo es postgres_pass.  Permite que nginx se comunique con PostgreSQL.  El m√≥dulo no utiliza la interfaz que se desarroll√≥ en nginx, tiene su propia ruta. <br><blockquote>  Recuerde proxy, pero preferiblemente no escriba.  Para escribir proxy, tendr√° que aprender todos los nginx de memoria: es muy largo y dif√≠cil. </blockquote><br><h3>  Equilibradores de carga </h3><br>  La tarea de los equilibradores de carga es muy simple: trabajar en modo round-robin.  Imagine que tiene una secci√≥n ascendente, algunos servidores en ella, especifica pesos y m√©todos de equilibrio.  Este es un equilibrador de carga t√≠pico. <br><br>  Este modo no siempre es adecuado.  Por lo tanto, se desarroll√≥ el m√≥dulo Ketama CHash, donde es condicionalmente posible llegar a una solicitud de hash consistente para alg√∫n servidor.  A veces es conveniente.  Nginx Lua ofrece balancer_by_lua.  En Lua, puede escribir cualquier equilibrador en general. <br><br><h2>  M√≥dulos C </h2><br>  Lo siguiente ser√° mi opini√≥n absolutamente subjetiva sobre el desarrollo de m√≥dulos C.  Para empezar, mis reglas subjetivas. <br><br>  <strong>El m√≥dulo comienza con las directivas nginx.conf.</strong>  Incluso si est√° creando un m√≥dulo C que solo ser√° operado por su empresa, siempre piense en las directivas.  Comience a dise√±ar el m√≥dulo con ellos, porque esto es con lo que se comunicar√° el administrador del sistema.  Esto es importante: coordine todos los matices con √©l o con la persona que operar√° su m√≥dulo C.  NGINX es un producto bien conocido, sus directivas obedecen ciertas leyes que los administradores de sistemas conocen.  Por lo tanto, siempre piense en ello. <br><br>  <strong>Usa el estilo de c√≥digo nginx.</strong>  Imagine que su m√≥dulo ser√° apoyado por otra persona.  Si ya est√° familiarizado con nginx y su estilo de c√≥digo, ser√° mucho m√°s f√°cil para √©l leer y comprender su c√≥digo. <br><br>  Recientemente, un buen amigo de Alemania me pidi√≥ que lo ayudara a lidiar con un error dentro de su c√≥digo nginx.  No s√© para qu√© estilo de c√≥digo lo escribi√≥, pero ni siquiera pod√≠a leer el c√≥digo normalmente. <br><br>  <strong>Use el conjunto de memoria correcto.</strong>  Siempre tenga esto en cuenta, incluso si tiene mucha experiencia con nginx.  Un error t√≠pico de un desarrollador novato de m√≥dulos C para nginx es obtener el grupo incorrecto. <br><br>  Un poco de historia: nginx generalmente usa la ideolog√≠a de asignadores d√©biles.  Puede usar malloc all√≠, pero no se recomienda.  Tiene sus propias losas, su propio asignador de memoria, debe usarlo.  En consecuencia, cada objeto tiene un enlace a su grupo, y este grupo debe ser utilizado.  Un error t√≠pico de un novato es usar una conexi√≥n de grupo en el filtro de encabezado, no una solicitud de grupo.  Esto significa que si tenemos una conexi√≥n para mantener vivo, el grupo se hinchar√° hasta que se quede sin memoria u otros efectos secundarios.  Por eso es importante. <br><br>  Adem√°s, tales errores son extremadamente dif√≠ciles de debutar.  Valgrind ("syshniks" lo entender√°) no funciona con la asignaci√≥n de losas, mostrar√° una imagen extra√±a. <br><br>  <strong>No utilice el bloqueo de E / S.</strong>  Un error t√≠pico de aquellos que desean aplicar algo externo m√°s r√°pido es usar E / S de bloqueo y enchufes de bloqueo.  Nunca puede hacer esto en nginx: hay muchos procesos en √©l, pero cada proceso usa un hilo. <br><br>  Puede hacer subprocesos m√∫ltiples, pero, por regla general, esto solo lo empeora.  Si utiliza E / S de bloqueo en una arquitectura de este tipo, todos estar√°n esperando esta pieza de bloqueo. <br><br>  Descifrar√© lo que dije anteriormente. <br><br><h3>  El m√≥dulo comienza con las directivas nginx.conf </h3><blockquote>  Decida en qu√© matrices debe vivir su directiva: Principal, Servidor, HTTP, ubicaci√≥n, ubicaci√≥n si. </blockquote>  Intente evitar la ubicaci√≥n si, como regla, esto lleva a un uso muy extra√±o de la configuraci√≥n de nginx. <br><br>  Todas las directivas en nginx viven en diferentes contextos y en diferentes √°mbitos.  La directiva add_header puede funcionar en el nivel HTTP, en el nivel de ubicaci√≥n, en el nivel de ubicaci√≥n si.  Esto generalmente se describe en la documentaci√≥n. <br><blockquote>  Comprenda en qu√© niveles puede funcionar su directiva, d√≥nde se ejecuta la directiva: PHASE Handler, Body / Header filter. </blockquote>  Esto es importante porque en nginx la configuraci√≥n est√° congelada.  Por convenci√≥n, cuando escribe add_header en alg√∫n lugar arriba, este valor se suaviza en el add_header inferior, que ya tiene en la ubicaci√≥n.  En consecuencia, agregar√° dos encabezados.  Esto se aplica a cualquier directiva. <br><br>  Si especifica algo de puerto de host, entonces viceversa - grupo de sockets.  Esto debe indicarse una vez. <br><br>  En general, prohibir√≠a cualquier fusi√≥n, simplemente no la necesita.  Por lo tanto, siempre debe determinar claramente en qu√© matrices nginx de la configuraci√≥n vive su directiva o conjunto de directivas. <br><br>  Buen ejemplo: <br><br><pre> <code class="cpp hljs">location /my_location/ { add_header ‚ÄúMy-Header‚Äù ‚Äúmy value‚Äù; }</code> </pre> <br>  Aqu√≠ add_header simplemente se agrega a la ubicaci√≥n.  El mismo add_header podr√≠a estar en alg√∫n lugar arriba, y todo simplemente estar√≠a contorsionado.  Este es un comportamiento documentado y comprensible. <br><blockquote>  Piense en lo que podr√≠a dificultar la implementaci√≥n de la directiva. </blockquote>  Imagina que est√°s desarrollando un filtro Body.  Como dije anteriormente, nginx simplemente coloca su m√≥dulo en una cadena com√∫n, y no tiene garant√≠a de que el m√≥dulo gzip no haya entrado en la cadena frente a su filtro Body en el momento de la compilaci√≥n.  En este caso, si alguien enciende el m√≥dulo gzip, los datos se enviar√°n a su m√≥dulo para el gzip.  Esto amenaza con que simplemente no puede hacer nada con el contenido.  Puede volver a comprimirlo, por ejemplo, pero esto es una burla desde el punto de vista de la CPU. <br><br>  Las mismas reglas se aplican a todos los manejadores de fase: no hay garant√≠a de qui√©n ser√° llamado antes y qui√©n ser√° despu√©s.  Por lo tanto, respeta al que ser√° llamado despu√©s y recuerda que alg√∫n gzip u otra cosa puede volar inesperadamente hacia ti. <br><br><h3>  Estilo de c√≥digo Nginx </h3><br><blockquote>  Cuando creaste el producto, recuerda que alguien lo apoyar√°.  No te olvides del estilo de c√≥digo nginx. </blockquote>  Antes de escribir su m√≥dulo nginx, familiar√≠cese con la fuente: <a href="">una</a> y la <a href="">segunda</a> . <br><br>  Si en el futuro emprende el desarrollo de m√≥dulos nginx, entonces estar√° al tanto de las fuentes nginx.  Los amar√°s porque no <strong>hay documentaci√≥n</strong> .  Aprender√° bien la estructura de directorios de nginx, aprender√° a usar Grep, posiblemente Sed, cuando necesite transferir algunas piezas de nginx a sus m√≥dulos. <br><br><h3>  Grupo de memoria </h3><br>  Las piscinas deben usarse correctamente.  <strong>Por ejemplo, "r-&gt; conexi√≥n-&gt; pool! = R-&gt; pool".</strong>  En ning√∫n caso puede usar la configuraci√≥n de agrupaci√≥n de memoria al procesar solicitudes, se hinchar√° hasta que se reinicie nginx. <br><br>  Comprender la vida √∫til del objeto.  Supongamos que la repetici√≥n de solicitudes tiene exactamente esta vida √∫til de canalizaci√≥n.  En esta piscina puedes colocar muchas cosas y hacer espacio.  La conexi√≥n puede vivir te√≥ricamente indefinidamente: es mejor colocar algo realmente importante en ella. <br><br>  <strong>Intente no utilizar asignadores externos, por ejemplo, malloc / free</strong> .  Esto tiene un efecto negativo en la fragmentaci√≥n de la memoria.  Si opera con grandes vol√∫menes de datos y usa una gran cantidad de malloc, este nginx se ralentiza bastante bien. <br><br>  <strong>Para los fan√°ticos de Valgrind, existe un</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><strong>truco</strong></a> que les permite depurar nginx-pools usando Valgrind.  Esto es importante si tiene mucho c√≥digo C en nginx, porque incluso un desarrollador experimentado en trabajar con memoria puede cometer un error. <br><br><h3>  Bloqueo de E / S </h3><blockquote>  Aqu√≠ todo es simple: no use el bloqueo de E / S. </blockquote>  De lo contrario, al menos habr√° problemas con las conexiones de mantenimiento, pero como m√°ximo, todo funcionar√° durante mucho tiempo. <br><br>  S√© el caso cuando una persona us√≥ Quora dentro de nginx en modo de bloqueo (no pregunte por qu√©).  Esto llev√≥ al hecho de que las conexiones para mantener vivo abandonaron su actividad y expiraron todo el tiempo.  Es mejor no hacer esto: todo funcionar√° durante mucho tiempo, de manera ineficiente e inmediatamente tendr√° que cambiar un mill√≥n de tiempos de espera, porque nginx comenzar√° el tiempo de espera en muchas cosas. <br><br>  Pero hay una alternativa a los m√≥dulos C: NJS y Lua. <br><br><h2>  Cuando no necesita desarrollar m√≥dulos C </h2><br>  Este a√±o tuve mi primera experiencia trabajando en NJS, tuve una impresi√≥n subjetiva e incluso me di cuenta de lo que faltaba all√≠, de modo que todo estaba bien.  Tambi√©n me gustar√≠a hablar sobre mi experiencia trabajando en Lua con nginx y, adem√°s, compartir los problemas que est√°n presentes en Lua. <br><br><h3>  Lua / LuaJit Essentials </h3><br>  Nginx no usa Lua, sino LuaJit.  Pero esto no es Lua, porque Lua ya ha avanzado dos versiones, y LuaJit est√° atrapado en alg√∫n lugar del pasado.  <strong>El autor pr√°cticamente no desarrolla LuaJit, a menudo vive en tenedores.</strong>  La bifurcaci√≥n m√°s actual es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LuaJit2</a> .  Esto agrega situaciones extra√±as en el mismo OpenResty. <br><br>  <strong>El recolector de basura necesita atenci√≥n</strong> .  LuaJit no puede superar este problema, solo encuentre algunas soluciones.  Con una carga enorme, cuando una gran cantidad de Garbage Collector se mantendr√° vivo en el cliente con fallas en el gr√°fico y errores 500. Hay muchas maneras de lidiar con Garbage Collector en Lua, no me enfocar√© en ellos aqu√≠.  Hay mucha informaci√≥n sobre esto en Internet. <br><br>  <strong>La implementaci√≥n de cadenas conduce a problemas de rendimiento</strong> .  Esto es solo el mal de LuaJit, y en Lua fue reparado.  La implementaci√≥n de cadenas en LuaJit simplemente desaf√≠a cualquier l√≥gica.  Las l√≠neas se ralentizan de la manera m√°s salvaje, lo que est√° asociado con la implementaci√≥n interna. <br><br>  <strong>Incapacidad para usar muchas bibliotecas preparadas</strong> .  Lua est√° inicialmente bloqueando, por lo que la mayor√≠a de las bibliotecas en Lua y LuaJit usan E / S de bloqueo.  Debido al hecho de que nginx no est√° bloqueando, es imposible usar bibliotecas listas para usar dentro de nginx que usen alguna E / S de bloqueo.  Esto ralentizar√° nginx. <br><br>  Las razones para usar LuaJit son id√©nticas a las razones para usar m√≥dulos: <br><br><ul><li>  creaci√≥n de prototipos de m√≥dulos complejos; </li><li>  HMAC, SHA c√°lculos para autorizaciones; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">equilibradores</a> </li><li>  peque√±as aplicaciones: controladores de encabezado, reglas para redireccionamientos; </li><li>  variables inform√°ticas para nginx.conf. </li></ul><br>  ¬øD√≥nde es mejor no usar LuaJit? <br><blockquote>  La regla principal: no procese un gran cuerpo en Lua, esto no funciona. </blockquote>  <strong>Los manejadores de contenido en Lua tampoco funcionan</strong> .  Intenta minimizar la l√≥gica a unos pocos <code>if</code> .  Un simple equilibrador funcionar√°, pero una barra lateral en Lua funcionar√° muy mal. <br><br>  <strong>La memoria compartida o el recolector de basura vendr√°.</strong>  No use la memoria compartida con Lua: Garbage Collector r√°pidamente y con garant√≠a sacar√° todo el cerebro a producci√≥n. <br><br>  <strong>No use corutinas</strong> con muchos compuestos para mantener vivo.  Las rutinas generan a√∫n m√°s basura dentro del recolector de basura LuaJit, lo cual es malo. <br><br>  Si ya est√° utilizando LuaJit, recuerde: <br><br><ul><li>  sobre monitoreo de memoria; </li><li>  en monitorear y optimizar el trabajo de Garbage Collector; </li><li>  sobre c√≥mo funciona Garbage Collector, si escribiste una aplicaci√≥n complicada para LuaJit, porque tienes que agregar algo nuevo. </li></ul><br><h3>  Njs </h3><br>  Cuando estaba en NGINX Conf, me convencieron de que ser√≠a genial no escribir c√≥digo en C. Pens√© que ten√≠a que intentarlo, y eso es lo que obtuve. <br><br>  <strong>Autorizaci√≥n</strong>  Funciona, el c√≥digo es simple, no afecta la velocidad, todo es genial.  Mi peque√±o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">prototipo con el</a> que comenc√© es 10 l√≠neas de c√≥digo.  Pero estas 10 l√≠neas hacen autorizaci√≥n con s3. <br><br>  <strong>Variables de c√°lculo para nginx.conf.</strong>  Muchas variables se pueden calcular usando NJS.  Dentro de nginx, esto es genial.  Hay una funci√≥n de este tipo en Lua, pero hay un recolector de basura, por lo que no es tan genial. <br><br>  Sin embargo, no todo es tan bueno.  Para hacer cosas realmente geniales en NJS, echa de menos algunas cosas. <br><br>  <strong>Memoria compartida</strong>  Parche√© la memoria compartida, esta es mi propia bifurcaci√≥n, as√≠ que ahora es suficiente. <br><br>  <strong>Filtros que admiten m√°s fases</strong> .  En NJS, solo existe la fase de contenido y las variables, y el filtro de encabezado es muy deficiente.  Tienes que escribir muletas para agregar muchos encabezados.  No hay suficiente filtro corporal para l√≥gica compleja o trabajo con contenido. <br><br>  <strong>Informaci√≥n sobre c√≥mo monitorearlo y perfilarlo</strong> .  Ahora s√© c√≥mo, pero tuve que estudiar la fuente.  No hay suficiente informaci√≥n o herramientas sobre el perfil adecuado.  Si es as√≠, est√° oculto donde no se puede encontrar.  En el mismo punto, ¬øno hay suficiente informaci√≥n sobre <strong>d√≥nde puedo usar NJS</strong> y d√≥nde no? <br><br>  <strong>C-m√≥dulos</strong> .  Ten√≠a el deseo de expandir NJS. <br><br><h2>  Ep√≠logo </h2><br>  <strong>¬øPor qu√© crear sus propios m√≥dulos?</strong>  Para resolver problemas generales y empresariales. <br><br>  <strong>¬øCu√°ndo necesito implementar m√≥dulos en C?</strong>  Si no hay otras opciones.  Por ejemplo, una carga pesada, inserci√≥n de contenido o ahorros b√°sicos en hardware.  Entonces esto debe hacerse garantizado en C. En la mayor√≠a de los casos, Lua o NJS es adecuado.  Pero siempre debes pensar en el futuro. <br><br>  <strong>¬øY en Lua?</strong>  Cuando no puede escribir en C. Por ejemplo, no necesita convertir el cuerpo de la solicitud con un gran RPS.  Su n√∫mero de clientes est√° creciendo, en alg√∫n momento dejar√° de hacer frente, pi√©nselo. <br><br>  <strong>NJS?</strong>  Cuando LuaJit est√° completamente harto de su recolector de basura y cadenas.  Por ejemplo, la autorizaci√≥n gener√≥ muchos objetos basura en Lua, pero esto no fue cr√≠tico.  Sin embargo, esto se reflej√≥ en el seguimiento y la molestia.  Ahora ha dejado de aparecer en mi monitoreo, y todo se ha vuelto bueno. <br><br><blockquote>  En HighLoad ++ 2019, Vasily Soshnikov continuar√° con el tema de los m√≥dulos nginx y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hablar√°</a> m√°s sobre NJS, sin olvidar la comparaci√≥n con LuaJit y C. <br><br>  Vea la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lista</a> completa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de</a> informes en el sitio web, y nos vemos el 7 y 8 de noviembre en la conferencia m√°s grande para desarrolladores de sistemas altamente cargados.  Siga nuestras nuevas ideas en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bolet√≠n</a> y el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">canal de telegramas</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471684/">https://habr.com/ru/post/471684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471666/index.html">Experimente que iOS Developer se mude a Alemania con una visa de trabajo</a></li>
<li><a href="../471668/index.html">An√°lisis t√©cnico del exploit checkm8</a></li>
<li><a href="../471670/index.html">Tratando Jetpack Compose en la batalla?</a></li>
<li><a href="../471676/index.html">Estafadores telef√≥nicos. La segunda acci√≥n, en la que me descompongo y corro al cajero autom√°tico m√°s cercano</a></li>
<li><a href="../471678/index.html">Tenga servicios a pedido</a></li>
<li><a href="../471686/index.html">C√≥mo AWS elabora sus servicios resistentes. Escalado de servidor y base de datos</a></li>
<li><a href="../471688/index.html">C√≥mo AWS elabora sus servicios resistentes. Escala de red</a></li>
<li><a href="../471700/index.html">C√≥mo eleg√≠ una pila tecnol√≥gica con una base para el futuro</a></li>
<li><a href="../471702/index.html">Aplicaciones web mejoradas cibern√©ticamente</a></li>
<li><a href="../471704/index.html">El libro "Las mitocondrias ego√≠stas. C√≥mo mantener la salud y mover la vejez "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>