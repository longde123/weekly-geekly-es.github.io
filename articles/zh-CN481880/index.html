<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ” ğŸ‘©ğŸ»â€ğŸ’¼ ğŸ¤– ç§»åŠ¨PvPå°„å‡»æ¸¸æˆçš„ç‰©ç†åŸç†ä»¥åŠæˆ‘ä»¬å¦‚ä½•ä¸ECSäº¤æœ‹å‹ ğŸš° ğŸ‘©ğŸ»â€âœˆï¸ ğŸ’¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸ºå¤šäººå°„å‡»æ¸¸æˆçš„ç‰©ç†å¼•æ“å·¥ä½œçš„ä¸ªäººç»éªŒï¼Œå¹¶å°†ä¸»è¦å…³æ³¨ç‰©ç†ä¸ECSçš„äº¤äº’ä½œç”¨ï¼šæˆ‘ä»¬åœ¨å·¥ä½œä¸­æ¶‰è¶³äº†ä»€ä¹ˆè€™å­ï¼Œå­¦åˆ°äº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆé€‰æ‹©äº†ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆã€‚ 



 é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¼„æ¸…æ¥šä¸ºä»€ä¹ˆéœ€è¦ç‰©ç†å¼•æ“ã€‚ æ²¡æœ‰ä¸€ä¸ªæ™®éçš„ç­”æ¡ˆï¼šåœ¨æ¯æ¬¾æ¸¸æˆä¸­ï¼Œå®ƒéƒ½æœ‰å…¶ç›®çš„ã€‚ ä¸€äº›æ¸¸æˆä½¿ç”¨ç‰©ç†å¼•æ“æ¥æ­£...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç§»åŠ¨PvPå°„å‡»æ¸¸æˆçš„ç‰©ç†åŸç†ä»¥åŠæˆ‘ä»¬å¦‚ä½•ä¸ECSäº¤æœ‹å‹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/481880/"> å¤§å®¶å¥½ï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸ºå¤šäººå°„å‡»æ¸¸æˆçš„ç‰©ç†å¼•æ“å·¥ä½œçš„ä¸ªäººç»éªŒï¼Œå¹¶å°†ä¸»è¦å…³æ³¨ç‰©ç†ä¸<abbr title="ECSæ˜¯ä¸€ç§å°†æ•°æ®ä¸é€»è¾‘åˆ†ç¦»çš„é¢å‘æ•°æ®çš„æ–¹æ³•ã€‚æ•°æ®è¡¨ç¤ºä¸ºå±äºå®ä½“çš„å®ä½“å’Œç»„ä»¶ã€‚ç³»ç»Ÿä¸­å¯¹é€»è¾‘è¿›è¡Œäº†æè¿°ï¼Œè¯¥ç³»ç»Ÿé€šå¸¸ä¼šéå†å®ä½“çš„ç»„ä»¶å¹¶è¿›è¡Œæ›´æ”¹ï¼Œåˆ›å»ºæ–°çš„ç»„ä»¶å’Œå®ä½“ã€‚">ECS</abbr>çš„äº¤äº’ä½œç”¨ï¼šæˆ‘ä»¬åœ¨å·¥ä½œä¸­æ¶‰è¶³äº†ä»€ä¹ˆè€™å­ï¼Œå­¦åˆ°äº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆé€‰æ‹©äº†ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆã€‚ <br><br><img src="https://habrastorage.org/webt/gp/b_/2-/gpb_2-4ml1nwdsb443-f2pp6zyu.png"><br><a name="habracut"></a><br> é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¼„æ¸…æ¥šä¸ºä»€ä¹ˆéœ€è¦ç‰©ç†å¼•æ“ã€‚ æ²¡æœ‰ä¸€ä¸ªæ™®éçš„ç­”æ¡ˆï¼šåœ¨æ¯æ¬¾æ¸¸æˆä¸­ï¼Œå®ƒéƒ½æœ‰å…¶ç›®çš„ã€‚ ä¸€äº›æ¸¸æˆä½¿ç”¨ç‰©ç†å¼•æ“æ¥æ­£ç¡®æ¨¡æ‹Ÿä¸–ç•Œä¸­å¯¹è±¡çš„è¡Œä¸ºï¼Œä»¥è¾¾åˆ°æ²‰æµ¸ç©å®¶çš„æ•ˆæœã€‚ åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œç‰©ç†æ˜¯æ¸¸æˆç©æ³•çš„åŸºç¡€-ä¾‹å¦‚ï¼Œã€Šæ„¤æ€’çš„å°é¸Ÿã€‹å’Œã€Šçº¢è‰²æ´¾ç³»ã€‹ã€‚ è¿˜æœ‰ä¸€äº›â€œæ²™ç›’â€ï¼Œå…¶ç‰©ç†å®šå¾‹ä¸åŒäºé€šå¸¸çš„å®šå¾‹ï¼Œå› æ­¤ä½¿æ¸¸æˆç©æ³•æ›´åŠ æœ‰è¶£å’Œç‰¹åˆ«ï¼ˆé—¨æˆ·ï¼Œå…‰é€Ÿè¾ƒæ…¢ï¼‰ã€‚ <br><br> ä»ç¼–ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œç‰©ç†å¼•æ“å¯ä»¥ç®€åŒ–æ¨¡æ‹Ÿæ¸¸æˆä¸­å¯¹è±¡è¡Œä¸ºçš„è¿‡ç¨‹ã€‚ å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨å¯¹è±¡ç‰©ç†ç‰¹æ€§æè¿°çš„åº“ã€‚ åœ¨å­˜åœ¨ç‰©ç†å¼•æ“çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¼€å‘èº«ä½“ä¸æ¸¸æˆä¸–ç•Œå°†èµ–ä»¥ç”Ÿå­˜çš„æ™®éè§„å¾‹ä¹‹é—´çš„ç›¸äº’ä½œç”¨ç³»ç»Ÿã€‚ è¿™æ ·å¯ä»¥èŠ‚çœå¤§é‡æ—¶é—´å’Œå¼€å‘ç²¾åŠ›ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ef/938/61f/5ef93861ff7c4921e44bcf14902cab51.jpg" alt="å›¾ç‰‡"><br>  <i>ä¸Š<a href="https://habr.com/ru/company/pixonic/blog/413729/">å›¾</a>æè¿°äº†æ’­æ”¾å™¨çš„æœ¬è´¨ï¼Œå…¶ç»„ä»¶åŠå…¶æ•°æ®ï¼Œä»¥åŠä¸æ’­æ”¾å™¨åŠå…¶ç»„ä»¶ä¸€èµ·å·¥ä½œçš„ç³»ç»Ÿã€‚</i>  <i>å›¾ä¸­çš„å…³é”®å¯¹è±¡æ˜¯ç©å®¶ï¼šä»–å¯ä»¥åœ¨å¤ªç©ºä¸­ç§»åŠ¨-å˜æ¢å’Œç§»åŠ¨ç»„ä»¶MoveSystemï¼›</i>  <i>èº«ä½“å¥åº·ï¼Œå¹¶ä¸”å¯èƒ½æ­»äº¡-ç»„ä»¶å¥åº·ï¼ŒæŸå®³ï¼ŒæŸå®³ç³»ç»Ÿï¼›</i>  <i>æ­»äº¡å‡ºç°åœ¨é‡ç”Ÿç‚¹ä¹‹å-è¯¥ä½ç½®çš„Transformç»„ä»¶ï¼Œå³RespawnSystemï¼›</i>  <i>å¯èƒ½æ— æ•Œ-ç»„æˆæ— æ•Œã€‚</i> <br><br><h2> å°„å‡»æ¸¸æˆå®æ–½æ¸¸æˆç‰©ç†çš„ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ </h2><br> åœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œæ²¡æœ‰å¤æ‚çš„ç‰©ç†äº¤äº’ï¼Œä½†æ˜¯ä»æœ‰è®¸å¤šäº‹æƒ…éœ€è¦ç‰©ç†å¼•æ“ã€‚ æœ€åˆï¼Œæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨å®ƒæ ¹æ®é¢„å®šçš„æ³•å¾‹åœ¨ä¸–ç•Œä¸Šç§»åŠ¨è§’è‰²ã€‚ é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡ç»™ä¸»ä½“ä¸€å®šçš„å†²åŠ¨æˆ–æ’å®šé€Ÿåº¦æ¥å®Œæˆçš„ï¼Œç„¶åï¼Œä½¿ç”¨åº“çš„Simulate / Updateæ–¹æ³•ï¼Œå¯¹å…¶ä¸­æ³¨å†Œçš„æ‰€æœ‰ä¸»ä½“è¿›è¡Œç²¾ç¡®çš„æ¨¡æ‹Ÿï¼Œå‘å‰è¿ˆå‡ºäº†ä¸€æ­¥ã€‚ <br><br> åœ¨å°„å‡»æ¸¸æˆä¸­ï¼Œ3Dç‰©ç†ä¸ä»…ç»å¸¸ç”¨äºæ¨¡æ‹Ÿè§’è‰²ç§»åŠ¨ï¼Œè€Œä¸”è¿˜ç”¨äºæ­£ç¡®å¤„ç†å­å¼¹å’Œç«ç®­çš„å¼¹é“ï¼Œè·³è·ƒï¼Œè§’è‰²å½¼æ­¤ä¹‹é—´ä»¥åŠç¯å¢ƒä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚ å¦‚æœå°„å‡»è€…å£°ç§°è‡ªå·±æ˜¯ç°å®çš„å¹¶ä¸”è¯•å›¾ä¼ è¾¾å°„å‡»è¿‡ç¨‹çš„çœŸå®æ„Ÿå—ï¼Œé‚£ä¹ˆä»–åªéœ€è¦ä¸€ä¸ªç‰©ç†å¼•æ“ã€‚ å½“ç©å®¶å‘ç›®æ ‡å°„å‡»aå¼¹æªæ—¶ï¼Œä»–å¸Œæœ›è·å¾—çš„ç»éªŒå’Œç»“æœå°½å¯èƒ½ä¸ä»–ä»é•¿æœŸçš„å°„å‡»æ¸¸æˆä¸­å·²ç»çŸ¥é“çš„é‚£ç§ç»“æœç›¸ç±»ä¼¼-æŸç§å…¨æ–°çš„ä¸œè¥¿å¾ˆå¯èƒ½ä½¿ä»–æ„Ÿåˆ°æ„å¤–ã€‚ <br><br> ä½†å°±æˆ‘ä»¬çš„æ¸¸æˆè€Œè¨€ï¼Œæœ‰è®¸å¤šé™åˆ¶ã€‚ ç”±äºæˆ‘ä»¬çš„å°„æ‰‹æ˜¯å¯ç§»åŠ¨çš„ï¼Œå› æ­¤å®ƒå¹¶ä¸æ„å‘³ç€è§’è‰²ä¹‹é—´ä»¥åŠä¸å‘¨å›´ä¸–ç•Œä¹‹é—´çš„å¤æ‚äº’åŠ¨ï¼Œå› æ­¤å®ƒä¸éœ€è¦ç¾ä¸½çš„å¼¹é“ï¼Œå¯ç ´åæ€§ï¼Œåœ¨ä¸å¹³å¦çš„è¡¨é¢ä¸Šè·³è·ƒã€‚ ä½†æ˜¯å‡ºäºç›¸åŒçš„åŸå› ï¼ŒåŒæ—¶æœ‰éå¸¸ä¸¥æ ¼çš„æµé‡è¦æ±‚ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ3Dç‰©ç†å°†æ˜¯å¤šä½™çš„ï¼šå®ƒå°†ä»…ä½¿ç”¨å…¶è®¡ç®—èµ„æºçš„ä¸€å°éƒ¨åˆ†å¹¶ç”Ÿæˆä¸å¿…è¦çš„æ•°æ®ï¼Œè¿™åœ¨ç§»åŠ¨ç½‘ç»œä¸­ä»¥åŠå®¢æˆ·ç«¯é€šè¿‡UDPä¸æœåŠ¡å™¨çš„æŒç»­åŒæ­¥å°†å ç”¨å¤ªå¤šç©ºé—´ã€‚ è¿™é‡Œå€¼å¾—å›é¡¾çš„æ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„ç½‘ç»œæ¨¡å‹ä¸­ï¼Œä»ç„¶å­˜åœ¨è¯¸å¦‚<a href="https://habr.com/ru/company/pixonic/blog/415959/">é¢„æµ‹å’Œå¯¹å¸ä¹‹</a>ç±»çš„ä¸œè¥¿ï¼Œè¿™ä¹Ÿæ¶‰åŠåˆ°å®¢æˆ·çš„ç»“ç®—ã€‚ ç»“æœï¼Œæˆ‘ä»¬è®¤ä¸ºæˆ‘ä»¬çš„ç‰©ç†å­¦åº”å°½å¯èƒ½å¿«åœ°å·¥ä½œï¼Œä»¥ä¾¿æˆåŠŸå¯åŠ¨å¹¶åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå·¥ä½œï¼Œè€Œä¸ä¼šå¹²æ‰°æ¸²æŸ“å’Œå…¶ä»–å®¢æˆ·ç«¯å­ç³»ç»Ÿã€‚ <br><br> å› æ­¤ï¼Œ3Dç‰©ç†ä¸é€‚ç”¨äºæˆ‘ä»¬ã€‚ ä½†æ˜¯ï¼Œè¿™é‡Œå€¼å¾—è®°ä½çš„æ˜¯ï¼Œå³ä½¿æ¸¸æˆçœ‹èµ·æ¥åƒæ˜¯ä¸‰ç»´çš„ï¼Œä¹Ÿä¸æ˜¯äº‹å®ï¼Œå› ä¸ºå®ƒçš„ç‰©ç†åœºä¹Ÿæ˜¯ä¸‰ç»´çš„ï¼šä¸€åˆ‡éƒ½å†³å®šäº†ç‰©ä½“ä¹‹é—´ç›¸äº’ä½œç”¨çš„æœ¬è´¨ã€‚ é€šå¸¸2Dç‰©ç†æ— æ³•æ¶µç›–çš„æ•ˆæœè¦ä¹ˆæ˜¯è‡ªå®šä¹‰çš„ï¼ˆå³ç¼–å†™çš„é€»è¾‘çœ‹ä¸Šå»åƒä¸‰ç»´äº¤äº’ï¼‰ï¼Œè¦ä¹ˆåªæ˜¯è¢«ä¸å½±å“æ¸¸æˆç©æ³•çš„è§†è§‰æ•ˆæœæ‰€æ›¿ä»£ã€‚ åœ¨ã€Šé£æš´è‹±é›„ã€‹ï¼Œã€Šå¤ä»£é˜²å¾¡ã€‹ï¼Œã€Šè‹±é›„è”ç›Ÿã€‹ä¸­ï¼ŒäºŒç»´ç‰©ç†å­¦èƒ½å¤Ÿæä¾›æ¸¸æˆçš„æ‰€æœ‰æ¸¸æˆåŠŸèƒ½ï¼Œè€Œä¸ä¼šå½±å“ç”»é¢è´¨é‡æˆ–æ¸¸æˆè®¾è®¡å¸ˆå’Œä¸–ç•Œå„åœ°è‰ºæœ¯å®¶æ‰€åˆ›é€ çš„ä¿¡èª‰æ„Ÿã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œåœ¨è¿™äº›æ¸¸æˆä¸­æœ‰è·³è·ƒè§’è‰²ï¼Œä½†æ˜¯åœ¨è·³è·ƒé«˜åº¦ä¸Šæ²¡æœ‰ç‰©ç†æ„ä¹‰ï¼Œå› æ­¤å¯ä»¥å½’ç»“ä¸ºäºŒç»´æ¨¡æ‹Ÿå¹¶åœ¨è§’è‰²æ‚¬ç©ºæ—¶è®¾ç½®æŸç§æ ‡å¿—ï¼Œä¾‹å¦‚_isInTheAir-åœ¨è®¡ç®—é€»è¾‘æ—¶è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚ <br><br> å› æ­¤å†³å®šä½¿ç”¨2Dç‰©ç†å­¦ã€‚ æˆ‘ä»¬ç”¨Unityç¼–å†™æ¸¸æˆï¼Œä½†æ˜¯æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯Unityæ— æ³•ç†è§£çš„æ— Unityçš„.netã€‚ ç”±äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æµä¼ ç€å¤§éƒ¨åˆ†ä»¿çœŸä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å¼€å§‹å¯»æ‰¾è·¨å¹³å°çš„ä¸œè¥¿-å³ï¼Œç”¨çº¯Cï¼ƒç¼–å†™çš„ç‰©ç†åº“ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨æœ¬æœºä»£ç æ¥æ¶ˆé™¤å´©æºƒç§»åŠ¨å¹³å°çš„å±é™©ã€‚ æ­¤å¤–ï¼Œè€ƒè™‘åˆ°<a href="https://habr.com/ru/company/pixonic/blog/415959/">å°„æ‰‹çš„å·¥ä½œ</a>ç»†èŠ‚ï¼Œå°¤å…¶æ˜¯æœåŠ¡å™¨ä¸Šä¸æ–­å€’å¸¦ä»¥ç¡®å®šç©å®¶çš„å°„å‡»ä½ç½®ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œåº“å¯ä»¥ä¸å†å²ä¸€èµ·å·¥ä½œå¾ˆé‡è¦-ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å»‰ä»·åœ°åŠæ—¶æŸ¥çœ‹Nå¸§å°¸ä½“çš„ä½ç½®ã€‚ å¹¶ä¸”ï¼Œå½“ç„¶ï¼Œä¸åº”è¯¥æ”¾å¼ƒè¯¥é¡¹ç›®ï¼šä½œè€…çš„æ”¯æŒå’Œèƒ½å¤Ÿå¿«é€Ÿä¿®å¤é”™è¯¯ï¼ˆå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­å‘ç°ä»»ä½•é”™è¯¯ï¼‰éå¸¸é‡è¦ã€‚ <br><br> äº‹å®è¯æ˜ï¼Œå½“æ—¶å¾ˆå°‘æœ‰åº“å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚ å®é™…ä¸Šï¼Œåªæœ‰ä¸€ä¸ªé€‚åˆæˆ‘ä»¬<a href="https://github.com/ashoulson/VolatilePhysics">-VolatilePhysics</a> ã€‚ <br><br> è¯¥åº“å€¼å¾—æ³¨æ„ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¸Unityå’Œæ— Unityçš„è§£å†³æ–¹æ¡ˆä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”è¿˜å…è®¸æ‚¨å¼€ç®±å³ç”¨åœ°å¯¹å¯¹è±¡çš„è¿‡å»çŠ¶æ€è¿›è¡Œå¿«ç…§ã€‚ é€‚ç”¨äºå°„æ‰‹é€»è¾‘ã€‚ å¦å¤–ï¼Œè¯¥åº“çš„ä¾¿åˆ©ä¹‹å¤„åœ¨äºï¼Œç”¨äºæ§åˆ¶Simulateï¼ˆï¼‰æ¨¡æ‹Ÿå¼€å§‹çš„æœºåˆ¶ä½¿æ‚¨å¯ä»¥åœ¨å®¢æˆ·ç«¯éœ€è¦æ—¶éšæ—¶ç”Ÿæˆå®ƒã€‚ å¦ä¸€ä¸ªåŠŸèƒ½-èƒ½å¤Ÿå°†å…¶ä»–æ•°æ®å†™å…¥èº«ä½“çš„åŠŸèƒ½ã€‚ å½“æ ¹æ®reykastçš„ç»“æœå¯¹æ¨¡æ‹Ÿå¯¹è±¡è¿›è¡Œå¯»å€æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨-ä½†æ˜¯ï¼Œè¿™ä¼šå¤§å¤§é™ä½æ€§èƒ½ã€‚ <br><br> ç»è¿‡å‡ æ¬¡æµ‹è¯•ï¼Œå¹¶ç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸VolatilePhysicsäº¤äº’è‰¯å¥½ä¸”æ²¡æœ‰å´©æºƒï¼Œæˆ‘ä»¬é€‰æ‹©äº†å®ƒã€‚ <br><br><h2> æˆ‘ä»¬å¦‚ä½•è¿›å…¥å›¾ä¹¦é¦†ä»¥ä¸ECSæ­£å¸¸åˆä½œçš„æ–¹å¼åŠå…¶ç»“æœ </h2><br> ä¸VolatilePhysicsåˆä½œçš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºVoltWorldçš„ç‰©ç†ä¸–ç•Œã€‚ å®ƒæ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œä¸»è¦å·¥ä½œåœ¨è¯¥ç±»ä¸Šï¼šè°ƒæ•´ï¼Œæ¨¡æ‹Ÿæœ‰å…³å¯¹è±¡ï¼Œreykastç­‰çš„æ•°æ®ã€‚æˆ‘ä»¬å°†å…¶åŒ…è£…åœ¨ç‰¹æ®Šçš„å¤–è§‚ä¸­ï¼Œä»¥ä¾¿å°†æ¥æˆ‘ä»¬å¯ä»¥å°†åº“çš„å®ç°æ›´æ”¹ä¸ºå…¶ä»–å½¢å¼ã€‚ å¤–è§‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æŸ¥çœ‹ä»£ç </b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PhysicsWorld</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HistoryLength = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> VoltWorld _voltWorld; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>, VoltBody&gt; _cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>, VoltBody&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PhysicsWorld</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> deltaTime</span></span></span><span class="hljs-function">)</span></span> { _voltWorld = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VoltWorld(HistoryLength) { DeltaTime = deltaTime }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HasBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _cache.ContainsKey(tag); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> VoltBody </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { VoltBody body; _cache.TryGetValue(tag, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> body); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> body; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> VoltRayResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RayCast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, Vector2 direction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> distance, VoltBodyFilter filter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ticksBehind</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VoltRayCast(origin, direction.normalized, distance); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VoltRayResult(); _voltWorld.RayCast(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ray, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> result, filter, ticksBehind); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> VoltRayResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CircleCast</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, Vector2 direction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> distance, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radius, VoltBodyFilter filter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ticksBehind</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VoltRayCast(origin, direction.normalized, distance); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VoltRayResult(); _voltWorld.CircleCast(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> ray, radius, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> result, filter, ticksBehind); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _voltWorld.Update(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _cache[tag]; _voltWorld.Update(body, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag, Vector2 position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _cache[tag]; body.Set(position, angle); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateStaticCircle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radius, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shape = _voltWorld.CreateCircleWorldSpace(origin, radius, <span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-number"><span class="hljs-number">0f</span></span>, <span class="hljs-number"><span class="hljs-number">0f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _voltWorld.CreateStaticBody(origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, shape); body.UserData = tag; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDynamicCircle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> radius, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shape = _voltWorld.CreateCircleWorldSpace(origin, radius, <span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-number"><span class="hljs-number">0f</span></span>, <span class="hljs-number"><span class="hljs-number">0f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _voltWorld.CreateDynamicBody(origin, <span class="hljs-number"><span class="hljs-number">0</span></span>, shape); body.UserData = tag; body.CollisionFilter = StaticCollisionFilter; _cache.Add(tag, body); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateStaticSquare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotationAngle, Vector2 extents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shape = _voltWorld.CreatePolygonBodySpace(extents.GetRectFromExtents(), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _voltWorld.CreateStaticBody(origin, rotationAngle, shape); body.UserData = tag; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDynamicSquare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Vector2 origin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rotationAngle, Vector2 extents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tag</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shape = _voltWorld.CreatePolygonBodySpace(extents.GetRectFromExtents(), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _voltWorld.CreateDynamicBody(origin, rotationAngle, shape); body.UserData = tag; body.CollisionFilter = StaticCollisionFilter; _cache.Add(tag, body); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;VoltBody&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBodies</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _voltWorld.Bodies; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StaticCollisionFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VoltBody a, VoltBody b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b.IsStatic; } }</code> </pre> <br></div></div><br> åˆ›å»ºä¸–ç•Œæ—¶ï¼Œå°†æ˜¾ç¤ºå†å²çš„è§„æ¨¡-å›¾ä¹¦é¦†å°†å­˜å‚¨çš„ä¸–ç•ŒçŠ¶æ€æ•°ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒä»¬çš„æ•°é‡æ˜¯32ï¼šæ¯ç§’30å¸§ï¼Œå¦‚æœéœ€è¦æ›´æ–°é€»è¾‘ï¼Œæˆ‘ä»¬å°†éœ€è¦å®ƒï¼Œå¦‚æœè¶…å‡ºè°ƒè¯•è¿‡ç¨‹çš„é™åˆ¶ï¼Œåˆ™éœ€è¦å¦å¤–2ä¸ªã€‚ è¯¥ä»£ç è¿˜è€ƒè™‘äº†ç”Ÿæˆç‰©ç†ç‰©ä½“çš„å‘å¤–æŠ•å°„æ–¹æ³•ä»¥åŠå„ç§è±å…‹æ–¯ç‰¹ã€‚ <br><br> æ­£å¦‚æˆ‘ä»¬<a href="https://habr.com/ru/company/pixonic/blog/429312/">åœ¨å‰å‡ ç¯‡æ–‡ç« ä¸­</a>æ‰€å›é¡¾çš„<a href="https://habr.com/ru/company/pixonic/blog/429312/">é‚£æ ·</a> ï¼ŒECSä¸–ç•Œå®è´¨ä¸Šå›´ç»•ç€å…¶ä¸­åŒ…å«çš„æ‰€æœ‰ç³»ç»Ÿå¯¹Executeæ–¹æ³•çš„å¸¸è§„è°ƒç”¨ã€‚ åœ¨æ¯ä¸ªç³»ç»Ÿçš„æ­£ç¡®ä½ç½®ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯¹å¤–è§‚çš„è°ƒç”¨ã€‚ æœ€åˆï¼Œå°½ç®¡æœ‰è¿™æ ·çš„æƒ³æ³•ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰ç¼–å†™ä»»ä½•æ‰¹å¤„ç†æ¥æŒ‘æˆ˜ç‰©ç†å¼•æ“ã€‚ åœ¨ç«‹é¢å†…éƒ¨ï¼Œå‘ç”Ÿäº†å¯¹ç‰©ç†ä¸–ç•Œçš„Updateï¼ˆï¼‰çš„è°ƒç”¨ï¼Œå¹¶ä¸”åº“æ¨¡æ‹Ÿäº†æ¯å¸§å‘ç”Ÿçš„å¯¹è±¡çš„æ‰€æœ‰äº¤äº’ã€‚ <br><br> å› æ­¤ï¼Œä¸ç‰©ç†å­¦çš„å·¥ä½œå¯å½’ç»“ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸€å¸§ä¸­ç‰©ä½“åœ¨ç©ºé—´ä¸­çš„å‡åŒ€è¿åŠ¨ä»¥åŠæ‹æ‘„æ‰€éœ€çš„è®¸å¤šçŸ³ï¼Œæ•ˆæœçš„æ­£ç¡®æ“ä½œä»¥åŠè®¸å¤šå…¶ä»–äº‹æƒ…ã€‚  Reykaståœ¨èº«ä½“çŠ¶æ€çš„å†å²ä¸­å°¤å…¶é‡è¦ã€‚ <br><br> æ ¹æ®æˆ‘ä»¬çš„æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬å¾ˆå¿«æ„è¯†åˆ°è¯¥åº“åœ¨ä¸åŒçš„é€Ÿåº¦ä¸‹è¡¨ç°éå¸¸å·®ï¼Œå¹¶ä¸”ä»¥ä¸€å®šçš„é€Ÿåº¦ï¼Œç‰©ä½“å¾ˆå®¹æ˜“å¼€å§‹ç©¿è¿‡å¢™å£ã€‚ åœ¨æˆ‘ä»¬çš„å¼•æ“ä¸­ï¼Œæ²¡æœ‰ä¸è¿ç»­ç¢°æ’æ£€æµ‹å…³è”çš„è®¾ç½®å¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚ ä½†æ˜¯å½“æ—¶å¸‚åœºä¸Šæ²¡æœ‰å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸æå‡ºè‡ªå·±çš„ç‰ˆæœ¬ï¼Œåœ¨å…¨çƒèŒƒå›´å†…ç§»åŠ¨ç‰©ä½“å¹¶å°†ç‰©ç†æ•°æ®ä¸ECSåŒæ­¥ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„è¿åŠ¨ç³»ç»Ÿä»£ç å¦‚ä¸‹ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æŸ¥çœ‹ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; ... <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Volatile; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovePhysicsSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> PhysicsWorld _physicsWorld; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> CollisionFilter _moveFilter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> VoltBodyFilter _collisionFilterDelegate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MovePhysicsSystem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PhysicsWorld physicsWorld</span></span></span><span class="hljs-function">)</span></span> { _physicsWorld = physicsWorld; _moveFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CollisionFilter(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, CollisionLayer.ExplosiveBarrel); _collisionFilterDelegate = _moveFilter.Filter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { _moveFilter.State = gs; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Movement) { ExecuteMovement(gs, pair.Key, pair.Value); } _physicsWorld.Update(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.PhysicsDynamicBody) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pair.Value.IsAlive) { ExecutePhysicsDynamicBody(gs, pair.Key); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> avatarId</span></span></span><span class="hljs-function">)</span></span> { _moveFilter.State = gs; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movement = gs.WorldState.Movement[avatarId]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (movement != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ExecuteMovement(gs, avatarId, movement); _physicsWorld.Update(avatarId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> physicsDynamicBody = gs.WorldState.PhysicsDynamicBody[avatarId]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (physicsDynamicBody != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; physicsDynamicBody.IsAlive) ExecutePhysicsDynamicBody(gs, avatarId); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecutePhysicsDynamicBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entityId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _physicsWorld.GetBody(entityId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transform = gs.WorldState.Transform[entityId]; transform.Position = body.Position; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteMovement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entityId, Movement movement</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = _physicsWorld.GetBody(entityId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> raycastRadius; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CalculateRadius(gs, entityId, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> raycastRadius)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } body.AngularVelocity = <span class="hljs-number"><span class="hljs-number">0</span></span>; body.LinearVelocity = movement.Velocity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movPhysicInfo = gs.WorldState.MovementPhysicInfo[entityId]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> collisionDirection = CircleRayCastSpeedCorrection(body, GameState.TickDurationSec, raycastRadius); CheckMoveInWall(movement, movPhysicInfo, collisionDirection, gs.WorldState.Transform[entityId]); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CalculateRadius</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> raycastRadius</span></span></span><span class="hljs-function">)</span></span> { raycastRadius = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> circleShape = gs.WorldState.DynamicCircleCollider[id]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (circleShape != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { raycastRadius = circleShape.Radius; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> boxShape = gs.WorldState.DynamicBoxCollider[id]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (boxShape != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { raycastRadius = boxShape.RaycastRadius; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { gs.Log.Error(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Physics body {0} doesn't contains shape!"</span></span>, id)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckMoveInWall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Movement movement, MovementPhysicInfo movPhysicInfo, Vector2 collisionDirection, Transform transform</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 60 is the max angle when player move in wall and can shoot through the wall from weapon without target. const float maxAngleToWall = 60; if (movement.Velocity.IsEqual(Vector2.zero)) { if (movPhysicInfo.LastCollisionDirection.IsEqual(Vector2.zero)) { var angleToCollision = transform.Angle.GetDirection().CalculateAbsoluteAngleInDegrees(movPhysicInfo.LastCollisionDirection); movPhysicInfo.TurnOnWall = angleToCollision &lt;= maxAngleToWall; } return; } movPhysicInfo.LastCollisionDirection = collisionDirection * -1f; if (movPhysicInfo.LastCollisionDirection.IsEqual(Vector2.zero)) { movPhysicInfo.TurnOnWall = false; movPhysicInfo.LastCollisionDirection = collisionDirection; } else { var angleToCollision = transform.Angle.GetDirection().CalculateAbsoluteAngleInDegrees(movPhysicInfo.LastCollisionDirection); movPhysicInfo.TurnOnWall = angleToCollision &lt;= maxAngleToWall; } } // I can't believe we are using a physics engine and have to write such kludges private Vector2 CircleRayCastSpeedCorrection(VoltBody targetBody, float deltaSeconds, float rayCastRadius) { if (rayCastRadius &lt;= 0) { return Vector2.zero; } var speed = targetBody.LinearVelocity; var position = targetBody.Position; var direction = speed * deltaSeconds; var rayCastResult = _physicsWorld.CircleCast(position + direction.normalized * 0.1f, direction, direction.magnitude, rayCastRadius, _collisionFilterDelegate, 0); if (rayCastResult.Body == null) { return Vector2.zero; } var magSpeed = speed.magnitude; if (rayCastResult.Distance &gt; 0) { var penetratingDistance = magSpeed * deltaSeconds - rayCastResult.Distance; var sinVelocityEdge = Vector2.Dot(-speed.normalized, rayCastResult.Normal); var biasSpeed = penetratingDistance * sinVelocityEdge / deltaSeconds; var biasVector = rayCastResult.Normal * biasSpeed * 1.1f; var resultVelocity = speed + biasVector; if (magSpeed &lt;= 0) { resultVelocity = Vector2.zero; } targetBody.LinearVelocity = resultVelocity; return rayCastResult.Normal; } var destination = rayCastResult.Body.Position; direction = destination - position; var rayCastResultToBody = _physicsWorld.RayCast(position, direction, direction.magnitude, _collisionFilterDelegate, 0); if (rayCastResultToBody.IsValid) targetBody.LinearVelocity = rayCastResultToBody.Normal * magSpeed * deltaSeconds; return rayCastResultToBody.Normal; } }</span></span></code> </pre> <br></div></div><br> è¿™æ ·çš„æƒ³æ³•æ˜¯ï¼Œåœ¨æ¯ä¸ªè§’è‰²ç§»åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬<a href="https://docs.unity3d.com/ScriptReference/Physics2D.CircleCast.html">éƒ½è¦</a>æŒ‰ç…§å…¶ç§»åŠ¨æ–¹å‘åˆ¶ä½œä¸€ä¸ª<a href="https://docs.unity3d.com/ScriptReference/Physics2D.CircleCast.html">CircleCast</a> ï¼Œä»¥ç¡®å®šå…¶å‰æ–¹æ˜¯å¦æœ‰éšœç¢ç‰©ã€‚ ä¹‹æ‰€ä»¥éœ€è¦CircleCastï¼Œæ˜¯å› ä¸ºæ¸¸æˆä¸­è§’è‰²çš„æŠ•å°„ä»£è¡¨ä¸€ä¸ªåœ†åœˆï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒä»¬é™·å…¥ä¸åŒå‡ ä½•å½¢çŠ¶ä¹‹é—´çš„è§’è½ã€‚ ç„¶åï¼Œæˆ‘ä»¬è€ƒè™‘é€Ÿåº¦çš„å¢é‡ï¼Œå¹¶å°†æ­¤å€¼åˆ†é…ç»™ç‰©ç†ä¸–ç•Œçš„å¯¹è±¡ä½œä¸ºå…¶åœ¨ä¸€å¸§ä¸­çš„é€Ÿåº¦ã€‚ ä¸‹ä¸€æ­¥æ˜¯è°ƒç”¨ç‰©ç†å¼•æ“Updateï¼ˆï¼‰çš„æ¨¡æ‹Ÿæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ç§»åŠ¨æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰å¯¹è±¡ï¼ŒåŒæ—¶è®°å½•å†å²ä¸­çš„æ—§çŠ¶æ€ã€‚ å¼•æ“å†…éƒ¨çš„æ¨¡æ‹Ÿå®Œæˆåï¼Œæˆ‘ä»¬å°†è¯»å–æ­¤æ¨¡æ‹Ÿæ•°æ®ï¼Œå°†å…¶å¤åˆ¶åˆ°ECSçš„Transformç»„ä»¶ä¸­ï¼Œç„¶åç»§ç»­ä½¿ç”¨å®ƒï¼Œå°¤å…¶æ˜¯é€šè¿‡ç½‘ç»œå‘é€ã€‚ <br><br> äº‹å®è¯æ˜ï¼Œè¿™ç§ç”¨è§’è‰²çš„ç§»åŠ¨é€Ÿåº¦æ§åˆ¶çš„å°å—æ•°æ®æ›´æ–°ç‰©ç†çš„æ–¹æ³•ï¼Œå¯¹äºè§£å†³å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šç‰©ç†çš„å·®å¼‚éå¸¸æœ‰æ•ˆã€‚ è€Œä¸”ç”±äºæˆ‘ä»¬çš„ç‰©ç†å­¦ä¸æ˜¯ç¡®å®šæ€§çš„-ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ•°æ®ï¼Œæ¨¡æ‹Ÿç»“æœå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ-å·²ç»æœ‰å¾ˆå¤šè®¨è®ºï¼Œå…³äºæ˜¯å¦å€¼å¾—ä½¿ç”¨å®ƒï¼Œä»¥åŠè¡Œä¸šä¸­æ˜¯å¦æœ‰äººåšç±»ä¼¼çš„äº‹æƒ…ï¼Œæ‹¥æœ‰ç¡®å®šæ€§çš„ç‰©ç†å¼•æ“ã€‚ å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨æ¸¸æˆå¼€å‘è€…å¤§ä¼šä¸Šä»NetherRealm Studiosçš„å¼€å‘è€…é‚£é‡Œè·å¾—äº†ä¸€ä»½æœ‰å…³å…¶æ¸¸æˆç½‘ç»œç»„ä»¶çš„å‡ºè‰²æŠ¥å‘Šï¼Œå¹¶æ„è¯†åˆ°è¿™ç§æ–¹æ³•ç¡®å®åœ¨å‘ç”Ÿã€‚ å®Œå…¨ç»„è£…å¥½ç³»ç»Ÿå¹¶è¿›è¡Œå‡ æ¬¡æµ‹è¯•åï¼Œæˆ‘ä»¬å¾—åˆ°äº†å¤§çº¦5,000ä¸ªæ»´ç­”çš„50ä¸ªé”™è¯¯é¢„æµ‹ï¼Œå³åœ¨5åˆ†é’Ÿçš„æˆ˜æ–—ä¸­ã€‚ é€šè¿‡è°ƒèŠ‚æœºåˆ¶å’Œç©å®¶ä½ç½®çš„è§†è§‰æ’å€¼ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å¯¹å¦‚æ­¤å¤šçš„é”™è¿‡é¢„æµ‹è¿›è¡Œå¹³å‡†ã€‚ åœ¨ä½¿ç”¨æ‚¨è‡ªå·±çš„æ•°æ®é¢‘ç¹æ‰‹åŠ¨æ›´æ–°ç‰©ç†è¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯å¾®ä¸è¶³é“ï¼Œå› æ­¤ï¼Œè§†è§‰æ’å€¼å¯ä»¥ç›¸å½“è¿…é€Ÿåœ°è¿›è¡Œ-ä»…éœ€è¦è¿™æ ·åšï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨è§’è‰²æ¨¡å‹ä¸­å‘ç”Ÿè§†è§‰è·³è·ƒã€‚ <br><br> ä¸ºäº†æ£€æŸ¥å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çŠ¶æ€æ˜¯å¦åŒ¹é…ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä»¥ä¸‹å½¢å¼çš„è‡ªå†™ç±»ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æŸ¥çœ‹ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> PS.Logs.Unity; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Compares the same avatar in two states. Compares the values potentially </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> affected by prediction. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public sealed class GameStateComparer : IGameStateComparer { public bool IsSame(GameState s1, GameState s2, uint avatarId) { if (s1 == null &amp;&amp; s2 != null || s1 != null &amp;&amp; s2 == null) { return false; } if (s1 == null &amp;&amp; s2 == null) return false; var entity1 = s1.WorldState[avatarId]; var entity2 = s2.WorldState[avatarId]; if (entity1 == null &amp;&amp; entity2 == null) { return false; } if (entity1 == null || entity2 == null) { LogManager.Debug("entity is different"); return false; } if (s1.Time != s2.Time) { LogManager.Warning(string.Format("Trying to compare states with different time! Predicted time: {0} Server time: {1}", s1.Time, s2.Time)); return false; } if (s1.WorldState.Transform[avatarId] != s2.WorldState.Transform[avatarId]) { LogManager.Debug("Transform is different"); return false; } // ... some code ... return true; } }</span></span></code> </pre> <br></div></div><br> å¦‚æœ‰å¿…è¦ï¼Œå®ƒå¯ä»¥å®ç°è‡ªåŠ¨åŒ–ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰è¿™æ ·åšï¼Œå°½ç®¡æˆ‘ä»¬åœ¨ä»¥åè€ƒè™‘è¿‡ã€‚ <br><br> è½¬æ¢æ¯”è¾ƒä»£ç ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æŸ¥çœ‹ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> ==(Transform a, Transform b) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)a == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)b == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)a == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)b != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)a != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)b == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Math.Abs(a.Angle - b.Angle) &gt; <span class="hljs-number"><span class="hljs-number">0.01f</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Math.Abs(a.Position.x - b.Position.x) &gt; <span class="hljs-number"><span class="hljs-number">0.01f</span></span> || Math.Abs(a.Position.y - b.Position.y) &gt; <span class="hljs-number"><span class="hljs-number">0.01f</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br></div></div><br><br><h2> æœ€åˆçš„å›°éš¾ </h2><br> è¿åŠ¨ä»¿çœŸæ²¡æœ‰é—®é¢˜ï¼Œå°½ç®¡å¯ä»¥å°†å…¶æŠ•å½±åˆ°2Då¹³é¢ä¸Š-åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç‰©ç†æ•ˆæœå¾ˆå¥½ï¼Œä½†æ˜¯æ¸¸æˆè®¾è®¡å¸ˆæ›¾ä¸€åº¦è¯´ï¼šâ€œæˆ‘ä»¬æƒ³è¦æ‰‹æ¦´å¼¹ï¼â€è€Œä¸”æˆ‘ä»¬è®¤ä¸ºï¼Œä»€ä¹ˆéƒ½ä¸ä¼šæ”¹å˜å¾ˆå¤šï¼Œä¸ºä»€ä¹ˆä¸åªç”¨2Dæ•°æ®æ¨¡æ‹Ÿäººä½“çš„3Dé£è¡Œã€‚ <br><br> ä»–ä»¬ä»‹ç»äº†ä¸€äº›ç‰©ä½“çš„é«˜åº¦æ¦‚å¿µã€‚ <br><br> å¯¹äºä¸€ä¸ªåºŸå¼ƒçš„èº«ä½“æ¥è¯´ï¼Œé«˜åº¦å®šå¾‹éšæ—¶é—´çš„å˜åŒ–æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œå®ƒä»¬é€šè¿‡äº†å…«å¹´çº§çš„ç‰©ç†è¯¾ç¨‹ï¼Œå› æ­¤å¯¹å¼¹é“å­¦çš„å†³å®šå˜å¾—å¾®ä¸è¶³é“ã€‚ ä½†æ˜¯ï¼Œè§£å†³å†²çªçš„æ–¹æ³•ä¸å†é‚£ä¹ˆç®€å•ã€‚ è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹è¿™ç§æƒ…å†µï¼šé£è¡Œä¸­çš„æ‰‹æ¦´å¼¹åº”è¯¥ä¸å¢™å£ç¢°æ’ï¼Œæˆ–è€…æ ¹æ®å…¶å½“å‰é«˜åº¦å’Œå¢™å£é«˜åº¦é£è¿‡å¢™å£ã€‚ æˆ‘ä»¬å°†ä»…åœ¨äºŒç»´ä¸–ç•Œä¸­è§£å†³é—®é¢˜ï¼Œåœ¨äºŒç»´ä¸–ç•Œä¸­ï¼Œæ‰‹æ¦´å¼¹ç”±åœ†å½¢è¡¨ç¤ºï¼Œå¢™å£ç”±çŸ©å½¢è¡¨ç¤ºã€‚ <br><br><img src="https://habrastorage.org/webt/ej/yr/lk/ejyrlkwa0tu9hm-3j7nobxmazpo.png"><br>  <i>æŸ¥çœ‹å¯¹è±¡çš„å‡ ä½•å½¢çŠ¶ä»¥è§£å†³é—®é¢˜ã€‚</i> <br><br> é¦–å…ˆï¼Œæˆ‘ä»¬å…³é—­äº†æ‰‹æ¦´å¼¹çš„åŠ¨æ€ç‰©ä½“ä¸å…¶ä»–é™æ€å’ŒåŠ¨æ€ç‰©ä½“çš„äº¤äº’ä½œç”¨ã€‚ ä¸ºäº†ä¸“æ³¨äºç›®æ ‡ï¼Œè¿™æ˜¯å¿…è¦çš„ã€‚ åœ¨æˆ‘ä»¬çš„ä»»åŠ¡ä¸­ï¼Œå½“æ‰‹æ¦´å¼¹åœ¨äºŒç»´å¹³é¢ä¸Šçš„æŠ•å½±å½¼æ­¤ç›¸äº¤æ—¶ï¼Œæ‰‹æ¦´å¼¹åº”è¯¥èƒ½å¤Ÿç©¿è¿‡å…¶ä»–ç‰©ä½“å¹¶â€œé£è¿‡â€å¢™å£ã€‚ åœ¨æ­£å¸¸çš„äº¤äº’ä¸­ï¼Œä¸¤ä¸ªç‰©ä½“ä¸èƒ½å½¼æ­¤é€šè¿‡ï¼Œä½†æ˜¯åœ¨æ‰‹æ¦´å¼¹å…·æœ‰è‡ªå®šä¹‰è¿åŠ¨é€»è¾‘å’Œé«˜åº¦çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å…è®¸å®ƒåœ¨æŸäº›æ¡ä»¶ä¸‹æ‰§è¡Œæ­¤æ“ä½œã€‚ <br><br> æˆ‘ä»¬ä¸ºæ¦´å¼¹å¼•å…¥äº†GrenadeMovementçš„å•ç‹¬ç»„ä»¶ï¼Œå…¶ä¸­å¼•å…¥äº†é«˜åº¦çš„æ¦‚å¿µï¼š <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GrenadeMovement</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Height; [DontPack] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Velocity; [DontPack] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> VerticalVelocity; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GrenadeMovement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height, Vector2 velocity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> verticalVelocity</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre> <br> ç°åœ¨ï¼Œæ‰‹æ¦´å¼¹å…·æœ‰é«˜åº¦åæ ‡ï¼Œä½†æ˜¯æ­¤ä¿¡æ¯å¯¹ä¸–ç•Œå…¶ä»–åœ°æ–¹ä¸€æ— æ‰€è·ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šä½œå¼Šå¹¶å¢åŠ äº†ä»¥ä¸‹æ¡ä»¶ï¼šä¸€æšæ‰‹æ¦´å¼¹å¯ä»¥é£è¿‡å¢™å£ï¼Œä½†åªèƒ½é£åˆ°ä¸€å®šé«˜åº¦ã€‚ å› æ­¤ï¼Œç¢°æ’çš„æ•´ä¸ªå®šä¹‰å½’ç»“ä¸ºæ£€æŸ¥æŠ•å½±ç¢°æ’ï¼Œå¹¶å°†å¢™çš„é«˜åº¦ä¸GrenadeMovement.Heightå­—æ®µçš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœæ‰‹æ¦´å¼¹çš„é£è¡Œé«˜åº¦è¾ƒå°ï¼Œå®ƒå°±ä¼šä¸å¢™å£ç¢°æ’ï¼Œå¦åˆ™å®ƒå¯ä»¥å¹³é™åœ°ç»§ç»­æ²¿å…¶è·¯å¾„ç§»åŠ¨ï¼ŒåŒ…æ‹¬åœ¨2Dç©ºé—´ä¸­ã€‚ <br><br> åœ¨ç¬¬ä¸€ä¸ªè¿­ä»£ä¸­ï¼Œæ‰‹æ¦´å¼¹åœ¨æ‰¾åˆ°ç›¸äº¤ç‚¹æ—¶å°±æ‰äº†ä¸‹æ¥ï¼Œä½†æ˜¯éšåæˆ‘ä»¬æ·»åŠ äº†å¼¹æ€§ç¢°æ’ï¼Œå¹¶ä¸”å®ƒçš„è¡Œä¸ºä¸æˆ‘ä»¬åœ¨3Dä¸­å¾—åˆ°çš„ç»“æœå‡ ä¹æ²¡æœ‰åŒºåˆ«ã€‚ <br><br> ä¸‹é¢ç»™å‡ºäº†è®¡ç®—æ‰‹æ¦´å¼¹å’Œå¼¹æ€§ç¢°æ’è½¨è¿¹çš„å®Œæ•´ä»£ç ï¼š <br><br><div class="spoiler">  <b class="spoiler_title">æŸ¥çœ‹ä»£ç </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-comment"><span class="hljs-comment">// ... some code ... using Volatile; namespace Common.WorldState { public sealed class GrenadeMovementSystem : ExecutableSystem { private struct Projection { public float Min; public float Max; } private float _r; private readonly Vector2[] _vertices = new Vector2[4]; private readonly Vector2[] _verticesV = new Vector2[4]; private Vector2 _Vunit; private Vector2 _VTunit; private Projection _wallProj1; private Projection _wallProj2; private Projection _wallProj1V; private Projection _wallProj2V; private const float CollisionPrecision = 1e-3f; private static readonly float HalfSlope = Mathf.Cos(Mathf.PI / 4.0f); private readonly ContactPointList _contactPoints = new ContactPointList(3); public override void Execute(GameState gs) { var settings = gs.RuleBook.GrenadeConfig[1]; _r = settings.R; var floorDampeningPerTick = (float)Math.Pow(settings.FloorDampening, 1.0 / GameState.Hz); foreach (var grenade in gs.WorldState.GrenadeMovement) { // Gravity must take effect before collision // because contact with walls may and will adjust vertical velocity // and penetration will even move the ball up. grenade.Value.VerticalVelocity -= settings.Gravity * GameState.TickDurationSec; grenade.Value.Height += grenade.Value.VerticalVelocity * GameState.TickDurationSec; // prevent falling through floor if (grenade.Value.Height &lt;= _r) { // slow down horizontal movement by floor friction // actually, friciton is simplified to just dampening coefficient var spdH = grenade.Value.Velocity.sqrMagnitude; var spdV = grenade.Value.VerticalVelocity; var cos = spdH / Mathf.Sqrt(spdH * spdH + spdV * spdV); grenade.Value.Velocity *= floorDampeningPerTick * cos; // slow down vertical movement grenade.Value.VerticalVelocity = settings.FloorRestitution * Math.Abs(grenade.Value.VerticalVelocity); // move up to the floor level grenade.Value.Height = _r; } // A collision will stop the ball and change its velocity. // Otherwise it will be moved by velocity PerformCollisionAndMovement(gs, grenade.Key, grenade.Value); } } private void PerformCollisionAndMovement(GameState gs, uint id, GrenadeMovement grenade) { var settings = gs.RuleBook.GrenadeConfig[1]; var velocity = grenade.Velocity * GameState.TickDurationSec; var trans = gs.WorldState.Transform[id]; var position = trans.Position; _Vunit = velocity.normalized; _VTunit = new Vector2(-_Vunit.y, _Vunit.x); _vertices[0] = position + _VTunit * _r; _vertices[1] = position - _VTunit * _r; _vertices[2] = _vertices[1] + velocity; _vertices[3] = _vertices[0] + velocity; _contactPoints.Reset(); int collisions = 0; var grenProj1V = ProjectCapsule(_Vunit, _vertices, position, velocity); var grenProj2V = ProjectCapsule(_VTunit, _vertices, position, velocity); collisions += CollideWithStaticBoxes(gs, id, position, velocity, grenade, grenProj1V, grenProj2V); collisions += CollideWithCircles(gs, gs.RuleBook.StaticCircleCollider, gs.RuleBook.Transform, id, position, velocity, grenade, grenProj1V, grenProj2V, (CollisionLayer)~0); collisions += CollideWithCircles(gs, gs.WorldState.DynamicCircleCollider, gs.WorldState.Transform, id, position, velocity, grenade, grenProj1V, grenProj2V, ~CollisionLayer.Character); if (collisions == 0) { trans.Position += velocity; } else { var contactSuperposition = CalculateContactSuperposition(); trans.Position += velocity * contactSuperposition.TravelDistance; var reflectedVelocity = grenade.Velocity - 2.0f * Vector2.Dot(grenade.Velocity, contactSuperposition.Normal) * contactSuperposition.Normal; reflectedVelocity *= settings.WallRestitution; #if DEBUG_GRENADES gs.Log.Debug("contact" + "\n\ttravel " + contactSuperposition.TravelDistance + "\n\tcontactNormal " + contactSuperposition.Normal.x + ":" + contactSuperposition.Normal.y + "\n\treflected V " + reflectedVelocity.x + ":" + reflectedVelocity.y); #endif grenade.Velocity = reflectedVelocity; } } private int CollideWithStaticBoxes( GameState gs, uint id, Vector2 position, Vector2 velocity, GrenadeMovement grenade, Projection grenProj1V, Projection grenProj2V) { var settings = gs.RuleBook.GrenadeConfig[1]; var collisions = 0; // TODO spatial query foreach (var collider in gs.RuleBook.StaticBoxCollider) { var wall = collider.Value; var transform = gs.RuleBook.Transform[collider.Key]; var colliderData = gs.RuleBook.PrecomputedColliderData[collider.Key]; // test projection to V _wallProj1V = ProjectPolygon(_Vunit, colliderData.Vertices); if (!Overlap(_wallProj1V, grenProj1V)) continue; // test projection to VT _wallProj2V = ProjectPolygon(_VTunit, colliderData.Vertices); if (!Overlap(_wallProj2V, grenProj2V)) continue; // test projection to wall axis 1 _wallProj1 = ProjectPolygon(colliderData.Axis1, colliderData.Vertices); var grenProj1 = ProjectCapsule(colliderData.Axis1, _vertices, position, velocity); if (!Overlap(_wallProj1, grenProj1)) continue; // test projection to wall axis 2 _wallProj2 = ProjectPolygon(colliderData.Axis2, colliderData.Vertices); var grenProj2 = ProjectCapsule(colliderData.Axis2, _vertices, position, velocity); if (!Overlap(_wallProj2, grenProj2)) continue; var lowWall = wall.Height &lt; settings.TallWallHeight; if (lowWall) { // the wall is too far below, ignore it completely if (grenade.Height &gt; wall.Height + _r) continue; // if grenade if falling down, it can bounce off the top of the wall if (grenade.VerticalVelocity &lt; 0f) { if (grenade.Height &gt; wall.Height - _r) { var localPV = WorldToBoxLocal(transform.Position, colliderData, position + velocity); #if DEBUG_GRENADES gs.Log.Debug("fall on wall" + "\n\tP+V " + (Px + Vx) + ":" + (Py + Vy) + "\n\tlocal " + localPV.x + ":" + localPV.y + "\n\tH w " + wall.Height + " g " + grenade.Height ); #endif if (Math.Abs(localPV.x) &lt; wall.Size.x * 0.5f || Math.Abs(localPV.y) &lt; wall.Size.y * 0.5f) { grenade.Height = wall.Height + _r; grenade.VerticalVelocity = settings.WallRestitution * Math.Abs(grenade.VerticalVelocity); continue; } } } } // collision detected // try to find minimal V before collision var scaleV = CalcTranslationScaleBeforeCollision(CheckBoxCollision, colliderData, 0, position, velocity); var contactPoint = CalcBoxContactPoint(transform.Position, wall, colliderData, position); #if DEBUG_GRENADES gs.Log.Debug("collision grenade #" + id + " with static box #" + collider.Key + "\n\tP=" + Px + ":" + Py + "\n\tV=" + Vx + ":" + Vy + " scale=" + scaleV + "\n\tP+Vs=" + (Px + Vx * scaleV) + ":" + (Py + Vy * scaleV) + "\n\twall pos " + transform.Position.x + ":" + transform.Position.y + " sz " + wall.Size.x + ":" + wall.Size.y + " angle " + transform.Angle + "\n\tproj V w " + _wallProj1V.Min + ":" + _wallProj1V.Max + " g " + grenProj1V.Min + ":" + grenProj1V.Max + " overlap=" + Overlap(_wallProj1V, grenProj1V) + "\n\tproj VT w " + _wallProj2V.Min + ":" + _wallProj2V.Max + " g " + grenProj2V.Min + ":" + grenProj2V.Max + " overlap=" + Overlap(_wallProj2V, grenProj2V) + "\n\taxis1 " + colliderData.Axis1.x + ":" + colliderData.Axis1.y + "\n\tproj 1 w " + _wallProj1.Min + ":" + _wallProj1.Max + " g " + grenProj1.Min + ":" + grenProj1.Max + " overlap=" + Overlap(_wallProj1, grenProj1) + "\n\taxis2 " + colliderData.Axis2.x + ":" + colliderData.Axis2.y + "\n\tproj 2 w " + _wallProj2.Min + ":" + _wallProj2.Max + " g " + grenProj2.Min + ":" + grenProj2.Max + " overlap=" + Overlap(_wallProj2, grenProj2) + "\n\tpoint " + contactPoint.Point.x + ":" + contactPoint.Point.y + " dotV " + Vector2.Dot(P - contactPoint.Point, V) ); #endif // ignore colliders that are behind if (Vector2.Dot(position - contactPoint.Point, velocity) &gt;= 0.0f) continue; contactPoint.TravelDistance = velocity.magnitude * scaleV; _contactPoints.Add(ref contactPoint); collisions++; } return collisions; } private bool CheckBoxCollision(PrecomputedColliderData colliderData, int x, Vector2 position, Vector2 velocity) { _verticesV[0] = _vertices[0]; _verticesV[1] = _vertices[1]; _verticesV[2] = _vertices[1] + velocity; _verticesV[3] = _vertices[0] + velocity; // test projection to V var grenProj1V = ProjectCapsule(_Vunit, _verticesV, position, velocity); if (!Overlap(_wallProj1V, grenProj1V)) return false; // testing projection to VT would be redundant // test projection to wall axis 1 var grenProj1 = ProjectCapsule(colliderData.Axis1, _verticesV, position, velocity); if (!Overlap(_wallProj1, grenProj1)) return false; // test projection to wall axis 2 var grenProj2 = ProjectCapsule(colliderData.Axis2, _verticesV, position, velocity); if (!Overlap(_wallProj2, grenProj2)) return false; return true; } private int CollideWithCircles( GameState gs, Table&lt;CircleCollider&gt; colliderTable, Table&lt;Transform&gt; transformTable, uint id, Vector2 position, Vector2 velocity, GrenadeMovement grenade, Projection grenProj1V, Projection grenProj2V, CollisionLayer collisionLayers) { var settings = gs.RuleBook.GrenadeConfig[1]; var collisions = 0; foreach (var collider in colliderTable) { if ((int)collisionLayers != ~0) { var body = gs.WorldState.PhysicsDynamicBody[collider.Key]; if (body != null &amp;&amp; (body.CollisionLayer &amp; collisionLayers) == 0) continue; } var wall = collider.Value; var transform = transformTable[collider.Key]; // test projection to V _wallProj1V = ProjectCircle(_Vunit, transform.Position, wall.Radius); if (!Overlap(_wallProj1V, grenProj1V)) continue; // test projection to VT _wallProj2V = ProjectCircle(_VTunit, transform.Position, wall.Radius); if (!Overlap(_wallProj2V, grenProj2V)) continue; // test distance from the circle wall to semicircles on capsule ends var collisionDistance = (_r + wall.Radius) * (_r + wall.Radius); if ((position - transform.Position).sqrMagnitude &gt; collisionDistance) continue; var distSqr = (position + velocity - transform.Position).sqrMagnitude; if (distSqr &gt; collisionDistance) continue; var lowWall = wall.Height &lt; settings.TallWallHeight; if (lowWall) { // the wall is too far below, ignore it completely if (grenade.Height &gt; wall.Height + _r) continue; // if grenade if falling down, it can bounce off the top of the wall if (grenade.VerticalVelocity &lt; 0f) { if (grenade.Height &gt; wall.Height - _r) { #if DEBUG_GRENADES gs.Log.Debug("grenade #" + id + " falls on wall" + "\n\tP+V " + (Px + Vx) + ":" + (Py + Vy) + "\n\tdist " + Mathf.Sqrt(distSqr) + "\n\tH w " + wall.Height + " g " + grenade.Height ); #endif if (distSqr &lt; wall.Radius * wall.Radius) { grenade.Height = wall.Height + _r; grenade.VerticalVelocity = settings.WallRestitution * Math.Abs(grenade.VerticalVelocity); continue; } } } } // collision detected // try to find minimal V before collision var scaleV = CalcTranslationScaleBeforeCollision(CheckCircleCollision, transform.Position, wall, position, velocity); var contactPoint = CalcCircleContactPoint(transform.Position, wall, position); #if DEBUG_GRENADES gs.Log.Debug("collision grenade #" + id + " with circle #" + collider.Key + "\n\tP=" + Px + ":" + Py + "\n\tV=" + Vx + ":" + Vy + " scale=" + scaleV + "\n\tP+Vs=" + (Px + Vx * scaleV) + ":" + (Py + Vy * scaleV) + "\n\tcircle pos " + transform.Position.x + ":" + transform.Position.y + " r " + wall.Radius + "\n\tdist " + (transform.Position - (P + V * scaleV)).magnitude + "\n\tproj V w " + _wallProj1V.Min + ":" + _wallProj1V.Max + " g " + grenProj1V.Min + ":" + grenProj1V.Max + " overlap=" + Overlap(_wallProj1V, grenProj1V) + "\n\tproj VT w " + _wallProj2V.Min + ":" + _wallProj2V.Max + " g " + grenProj2V.Min + ":" + grenProj2V.Max + " overlap=" + Overlap(_wallProj2V, grenProj2V) + "\n\tpoint " + contactPoint.Point.x + ":" + contactPoint.Point.y + " dotV " + Vector2.Dot(P - contactPoint.Point, V) ); #endif // ignore colliders that are behind if (Vector2.Dot(position - contactPoint.Point, velocity) &gt;= 0.0f) continue; contactPoint.TravelDistance = velocity.magnitude * scaleV; _contactPoints.Add(ref contactPoint); collisions++; } return collisions; } private bool CheckCircleCollision(Vector2 wallCentre, CircleCollider wall, Vector2 position, Vector2 velocity) { _verticesV[0] = _vertices[0]; _verticesV[1] = _vertices[1]; _verticesV[2] = _vertices[1] + velocity; _verticesV[3] = _vertices[0] + velocity; // test projection to V var grenProj1V = ProjectCapsule(_Vunit, _verticesV, position, velocity); if (!Overlap(_wallProj1V, grenProj1V)) return false; // testing projection to VT would be redundant // test distance from the circle wall to the semicircle on the second capsule end var dSqr = (_r + wall.Radius) * (_r + wall.Radius); return (position + velocity - wallCentre).sqrMagnitude &lt; dSqr; } private static float CalcTranslationScaleBeforeCollision&lt;TData1, TData2&gt;( Func&lt;TData1, TData2, Vector2, Vector2, bool&gt; collision, TData1 colliderData1, TData2 colliderData2, Vector2 position, Vector2 vector) { var min = 0.0f; var max = 1.0f; while (true) { var d = (max - min) * 0.5f; if (d &lt; CollisionPrecision) break; var scale = min + d; if (collision(colliderData1, colliderData2, position, vector * scale)) { max = scale; } else { min = scale; } } return min; } private ContactPoint CalculateContactSuperposition() { ContactPoint contactSuperposition; _contactPoints.TryPopClosest(1000f, out contactSuperposition); ContactPoint contact; while (_contactPoints.TryPopClosest(contactSuperposition.TravelDistance, out contact)) { contactSuperposition.Normal += contact.Normal; } contactSuperposition.Normal = contactSuperposition.Normal.normalized; return contactSuperposition; } private static Projection ProjectPolygon(Vector2 axisNormalised, Vector2[] vertices) { Projection proj; var d = Vector2.Dot(axisNormalised, vertices[0]); proj.Min = d; proj.Max = d; for (var i = 1; i &lt; vertices.Length; i++) { d = Vector2.Dot(axisNormalised, vertices[i]); proj.Min = Mathf.Min(proj.Min, d); proj.Max = Mathf.Max(proj.Max, d); } return proj; } private Projection ProjectCapsule(Vector2 axisNormalised, Vector2[] vertices, Vector2 p, Vector2 v) { var proj = ProjectPolygon(axisNormalised, vertices); proj = AddCircleProjection(proj, axisNormalised, p, _r); proj = AddCircleProjection(proj, axisNormalised, p + v, _r); return proj; } private static Projection AddCircleProjection(Projection proj, Vector2 axisNormalised, Vector2 centre, float r) { var c = Vector2.Dot(axisNormalised, centre); proj.Min = Mathf.Min(proj.Min, c - r); proj.Max = Mathf.Max(proj.Max, c + r); return proj; } private static Projection ProjectCircle(Vector2 axisNormalised, Vector2 centre, float r) { Projection proj; var c = Vector2.Dot(axisNormalised, centre); proj.Min = c - r; proj.Max = c + r; return proj; } private static bool Overlap(Projection p1, Projection p2) { return p1.Min &lt; p2.Min ? p1.Max &gt; p2.Min : p2.Max &gt; p1.Min; } private static Vector2 WorldToBoxLocal(Vector2 wallCentre, PrecomputedColliderData colliderData, Vector2 position) { return new Vector2( Vector2.Dot(colliderData.Axis1, position) - Vector2.Dot(colliderData.Axis1, wallCentre), Vector2.Dot(colliderData.Axis2, position) - Vector2.Dot(colliderData.Axis2, wallCentre) ); } private static ContactPoint CalcBoxContactPoint(Vector2 wallCentre, BoxCollider wall, PrecomputedColliderData colliderData, Vector2 position) { var contactPoint = CaclBoxLocalContactPoint(wall.Size * 0.5f, WorldToBoxLocal(wallCentre, colliderData, position)); var worldAxisX = new Vector2(colliderData.Axis1.x, -colliderData.Axis1.y); var worldAxisY = new Vector2(colliderData.Axis1.y, colliderData.Axis1.x); contactPoint.Point = wallCentre + new Vector2(Vector2.Dot(worldAxisX, contactPoint.Point), Vector2.Dot(worldAxisY, contactPoint.Point)); contactPoint.Normal = new Vector2(Vector2.Dot(worldAxisX, contactPoint.Normal), Vector2.Dot(worldAxisY, contactPoint.Normal)); return contactPoint; } private static ContactPoint CaclBoxLocalContactPoint(Vector2 boxHalfSize, Vector2 localPosition) { ContactPoint localContactPoint = default(ContactPoint); // cases are numbered like numpad keys // 1, 2, 3 if (localPosition.y &lt; -boxHalfSize.y) { // 1 if (localPosition.x &lt; -boxHalfSize.x) { localContactPoint.Point = new Vector2(-boxHalfSize.x, -boxHalfSize.y); localContactPoint.Normal = new Vector2(-HalfSlope, -HalfSlope); } // 2, 3 else { // 3 if (localPosition.x &gt; boxHalfSize.x) { localContactPoint.Point = new Vector2(boxHalfSize.x, -boxHalfSize.y); localContactPoint.Normal = new Vector2(HalfSlope, -HalfSlope); } // 2 else { localContactPoint.Point = new Vector2(localPosition.x, -boxHalfSize.y); localContactPoint.Normal = new Vector2(0.0f, -1.0f); } } } // 4, 6, 7, 8, 9 else { // 7, 8, 9 if (localPosition.y &gt; boxHalfSize.y) { // 7 if (localPosition.x &lt; -boxHalfSize.x) { localContactPoint.Point = new Vector2(-boxHalfSize.x, boxHalfSize.y); localContactPoint.Normal = new Vector2(-HalfSlope, HalfSlope); } // 8, 9 else { // 9 if (localPosition.x &gt; boxHalfSize.x) { localContactPoint.Point = new Vector2(boxHalfSize.x, boxHalfSize.y); localContactPoint.Normal = new Vector2(HalfSlope, HalfSlope); } // 8 else { localContactPoint.Point = new Vector2(localPosition.x, boxHalfSize.y); localContactPoint.Normal = new Vector2(0.0f, 1.0f); } } } // 4, 6 else { // 4 if (localPosition.x &lt; -boxHalfSize.x) { localContactPoint.Point = new Vector2(-boxHalfSize.x, localPosition.y); localContactPoint.Normal = new Vector2(-1.0f, 0.0f); } // 6 else { localContactPoint.Point = new Vector2(boxHalfSize.x, localPosition.y); localContactPoint.Normal = new Vector2(1.0f, 0.0f); } } } return localContactPoint; } private static ContactPoint CalcCircleContactPoint(Vector2 wallCentre, CircleCollider wall, Vector2 position) { ContactPoint contactPoint = default(ContactPoint); contactPoint.Normal = (position - wallCentre).normalized; contactPoint.Point = wallCentre + wall.Radius * contactPoint.Normal; return contactPoint; } } }</span></span></code> </pre> <br></div></div><br><h2>  . æ¥ä¸‹æ¥æ˜¯ä»€ä¹ˆï¼Ÿ </h2><br>  , ,       -   ,        .         <a href="https://habr.com/ru/company/pixonic/blog/424267/"> ECS  </a> .    ,      ,     JSON,        ECS.    : <br><br><img src="https://habrastorage.org/webt/x6/wv/1w/x6wv1w0hkb13r4rflik9hvacnk0.png"><br><br> ,       Â«Â».      ECS,       ,      .   â€•  â€•   , ,     ECS,        ECS   . ,    API,       ,      ,  .        ,                            . <br><br> -       2D-:        ,       . ,   :      ,      opensource    ,   -    .        ECS,     ,       .  ,             ,      .   -       ,    ,        .   â€•    -  . <br><br>  -          ,   3D-,  ,                . <br><br>    , ,          ,      .     ,  ,      ECS      . <br><br><h4> æœ‰ç”¨çš„é“¾æ¥ </h4><br>      : <br><br><ul><li> <a href="https://habr.com/ru/company/pixonic/blog/429312/">      </a> </li><li> <a href="https://habr.com/ru/company/pixonic/blog/415959/">      PvP :    </a> </li><li> <a href="https://habr.com/ru/company/pixonic/blog/413729/">      ECS</a> </li><li> <a href="https://habr.com/ru/company/pixonic/blog/424267/">      ECS   </a> </li></ul><br>   : <br><br><ul><li> <a href="https://www.youtube.com/watch%3Fv%3D7jb0FOcImdg">8 Frames in 16ms: Rollback Networking in Mortal Kombat and Injustice 2</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481880/">https://habr.com/ru/post/zh-CN481880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481860/index.html">ITåœ¨2020å¹´åº”è¯¥åšä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="../zh-CN481862/index.html">Nvidia JetsonåµŒå…¥å¼æœºå™¨å­¦ä¹ ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN481866/index.html">DBAï¼šå½“VACUUMé€šè¿‡æ—¶-æˆ‘ä»¬æ‰‹åŠ¨æ¸…æ´æ¡Œå­</a></li>
<li><a href="../zh-CN481868/index.html">è¾¾åŠ æ–¯ï¼šæ–°èµ·ç‚¹</a></li>
<li><a href="../zh-CN481874/index.html">æŒ‡æ ‡-é¡¹ç›®è¿è¡ŒçŠ¶å†µæŒ‡æ ‡</a></li>
<li><a href="../zh-CN481882/index.html">4. Fortinetå…¥é—¨v6.0ã€‚ é˜²ç«å¢™æ”¿ç­–</a></li>
<li><a href="../zh-CN481884/index.html">è€å¹´äººçš„åå­—è·¯å£ï¼šä¸‹ä¸€æ­¥è¦å»å“ªé‡Œï¼Ÿ</a></li>
<li><a href="../zh-CN481886/index.html">å¦‚ä½•å¿«é€Ÿåˆ›å»ºè€ƒå‹¤æ—¥è®°</a></li>
<li><a href="../zh-CN481890/index.html">å‘ä¿„ç½—æ–¯è¿›å£å¾·å›½é“€å°¾çŸ¿ã€‚ ç¬¬äºŒéƒ¨åˆ†ã€‚æµ“ç¼©</a></li>
<li><a href="../zh-CN481892/index.html">ç”¨ä½ä»£æ›¿ä½ï¼šé‡å­è®¡ç®—æœºå¯¹æˆ‘ä»¬æœ‰ä»€ä¹ˆæœªæ¥ï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>