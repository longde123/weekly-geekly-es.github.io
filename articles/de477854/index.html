<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüç≥ üéØ üõë Was passiert beim Verbinden innerhalb und au√üerhalb eines VPN-Tunnels? üôãüèº üßóüèª üë®üèæ‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aus den Briefen an den technischen Support von Tucha gehen diese Artikel hervor. Vor kurzem hat uns ein Kunde mit der Bitte kontaktiert, zu kl√§ren, wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Was passiert beim Verbinden innerhalb und au√üerhalb eines VPN-Tunnels?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477854/"> Aus den Briefen an den technischen Support von Tucha gehen diese Artikel hervor.  Vor kurzem hat uns ein Kunde mit der Bitte kontaktiert, zu kl√§ren, was passiert, wenn eine Verbindung innerhalb eines VPN-Tunnels zwischen dem B√ºro des Benutzers und der Umgebung in der Cloud sowie eine Verbindung au√üerhalb des VPN-Tunnels hergestellt wird.  Daher ist der gesamte unten stehende Text ein echter Brief, den wir als Antwort auf seine Frage an einen der Kunden gesendet haben.  Nat√ºrlich haben wir die IP-Adressen ge√§ndert, um den Client nicht zu anonymisieren.  Aber der technische Support von Tucha ist wirklich ber√ºhmt f√ºr seine umfassenden Antworten und informativen Briefe.  :-) <br><br>  Nat√ºrlich verstehen wir, dass dieser Artikel f√ºr viele keine Offenbarung sein wird.  Da jedoch auf Habr von Zeit zu Zeit Artikel f√ºr Anf√§nger von Administratoren erscheinen und dieser Artikel auch aus einem echten Brief an einen echten Kunden stammt, werden wir diese Informationen hier weitergeben.  Es besteht eine hohe Wahrscheinlichkeit, dass es f√ºr jemanden n√ºtzlich ist. <br>  Daher erkl√§ren wir im Detail, was zwischen dem Server in der Cloud und dem B√ºro passiert, wenn diese √ºber ein Standort-zu-Standort-Netzwerk verbunden sind.  Beachten Sie, dass in diesem Fall ein Teil der Dienste nur √ºber das B√ºro und ein Teil √ºber das Internet verf√ºgbar ist. <br><br>  Wir werden sofort erkl√§ren, dass unser Kunde sich gew√ºnscht hat, von √ºberall √ºber RDP zum Server <b>192.168.A.1</b> zu <b>gelangen</b> und eine Verbindung zu <b>AAA2: 13389</b> und anderen Diensten <b>herzustellen</b> - nur von dem B√ºro <b>(192.168.B.0 / 24) aus</b> , das √ºber eine Verbindung hergestellt wurde VPN  Au√üerdem wurde der Client urspr√ºnglich so konfiguriert, dass auf den Computer <b>192.168.B.2</b> im B√ºro auch √ºber RDP von √ºberall aus zugegriffen werden kann, wobei eine Verbindung zu <b>BBB1: 11111 hergestellt wird</b> .  Wir halfen bei der Organisation von IPSec-Verbindungen zwischen der Cloud und dem B√ºro, und der IT-Spezialist des Kunden begann, Fragen zu stellen, was in diesem oder jenem Fall passieren w√ºrde.  Um all diese Fragen zu beantworten, haben wir ihm tats√§chlich alles geschrieben, was Sie unten lesen k√∂nnen. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/yi/h8/nm/yih8nmxyw3h1kvhvrv8grwlqt14.jpeg"><br><p>  Betrachten Sie diese Prozesse nun genauer. </p><br><h3>  Erste Position </h3><br>  Wenn etwas von <b>192.168.B.0 / 24</b> nach <b>192.168.A.0 / 24</b> oder von <b>192.168.A.0 / 24</b> nach <b>192.168.B.0 / 24</b> gesendet wird, <b>gelangt</b> es in das VPN.  Das hei√üt, dieses Paket wird zus√§tzlich zwischen <b>BBB1</b> und <b>AAA1</b> verschl√ºsselt und √ºbertragen, aber <b>192.168.A.1</b> <b>erkennt</b> das Paket von <b>192.168.B.1</b> genau.  Sie k√∂nnen √ºber beliebige Protokolle miteinander kommunizieren.  Die R√ºckantworten werden auf die gleiche Weise √ºber VPN √ºbertragen, das hei√üt, das Paket von <b>192.168.A.1</b> f√ºr <b>192.168.B.1</b> wird als ESP-Datagramm von <b>AAA1</b> an <b>BBB1 gesendet</b> . Der Router auf der anderen Seite nimmt das Paket heraus und sendet es an <b>192.168.B.1</b> als Paket von <b>192.168.A.1</b> . <br><br>  Konkretes Beispiel: <br><br>  1) <b>192.168.B.1</b> greift auf <b>192.168.A.1 zu</b> , m√∂chte eine TCP-Verbindung mit <b>192.168.A.1: 3389 herstellen</b> ; <br><br>  2) <b>192.168.B.1</b> sendet eine Anforderung zum Herstellen einer Verbindung von <b>192.168.B.1: 55555</b> (er w√§hlt den Port f√ºr die R√ºckmeldung aus. Im Folgenden wird die Nummer 55555 als Beispiel f√ºr die Portnummer verwendet, die das System beim Generieren von TCP- Verbindungen) zu <b>192.168.A.1: 3389</b> ; <br><br>  3) das Betriebssystem, das auf dem Computer mit der Adresse <b>192.168.B.1 ausgef√ºhrt wird,</b> beschlie√üt, dieses Paket an die Gateway-Adresse des Routers (in unserem Fall <b>192.168.B.254</b> ) zu √ºbertragen, da es f√ºr <b>192.168.A.1</b> andere, spezifischere Routen gibt, es leitet das Paket daher nicht entlang der Standardroute (0.0.0.0/0) weiter; <br><br>  4) Sie versucht dazu, die MAC-Adresse f√ºr die IP-Adresse <b>192.168.B.254</b> in der Cache-Tabelle des ARP-Protokolls zu finden.  Wird es nicht gefunden, sendet es von der Adresse <b>192.168.B.1 eine</b> Broadcast-Wer-hat-Anfrage an das Netzwerk <b>192.168.B.0 / 24</b> .  Wenn <b>192.168.B.254</b> seine MAC-Adresse an ihn <b>zur√ºcksendet,</b> sendet das System ein Ethernet-Paket f√ºr ihn und speichert diese Informationen in seiner Cache-Tabelle. <br><br>  5) Der Router empf√§ngt dieses Paket und entscheidet, wohin es gesendet werden soll. Er legt fest, dass alle Pakete zwischen <b>192.168.B.0 / 24</b> und <b>192.168.A.0 / 24</b> √ºber eine VPN-Verbindung zwischen <b>BBB1</b> und <b>AAA1 √ºbertragen werden sollen</b> . <br><br>  6) Der Router generiert ein ESP-Datagramm von <b>BBB1</b> bis <b>AAA1</b> . <br><br>  7) Der Router entscheidet, an wen er dieses Paket sendet. Er sendet es beispielsweise an <b>BBB254</b> (Gateway des Internetproviders), da er keine spezifischeren Routen zu <b>AAA1</b> als 0.0.0.0/0 hat. <br><br>  8) findet auf die gleiche Weise wie bereits erw√§hnt die MAC-Adresse f√ºr <b>BBB254</b> und sendet das Paket an das Gateway des Internetproviders; <br><br>  9) Internetprovider √ºbertragen √ºber ihre Netze das ESP-Datagramm von <b>BBB1</b> nach <b>AAA1</b> ; <br><br>  10) der virtuelle Router auf <b>AAA1</b> empf√§ngt dieses Datagramm, entschl√ºsselt es und empf√§ngt ein Paket von <b>192.168.B.1: 55555</b> f√ºr <b>192.168.A.1: 3389</b> ; <br><br>  11) der virtuelle Router pr√ºft, an wen er gesendet werden soll, findet das Netzwerk <b>192.168.A.0 / 24</b> in der Routing-Tabelle und sendet es direkt an <b>192.168.A.1</b> , da es eine Schnittstelle <b>192.168.A.254 / 24 hat</b> ; <br><br>  12) dazu findet der virtuelle Router die MAC-Adresse f√ºr <b>192.168.A.1</b> und leitet dieses Paket √ºber das virtuelle Ethernet-Netzwerk an ihn weiter; <br><br>  13) <b>192.168.A.1</b> empf√§ngt dieses Paket an Port 3389, stimmt dem Aufbau einer Verbindung zu und bildet ein Paket als Antwort von <b>192.168.A.1: 3389</b> auf <b>192.168.B.1: 55555</b> ; <br><br>  14) Sein System sendet dieses Paket an die Gateway-Adresse des virtuellen Routers (in unserem Fall <b>192.168.A.254</b> ), da es keine anderen, spezifischeren Routen f√ºr <b>192.168.B.1</b> hat. Daher muss es das Paket entlang der Route √ºbertragen Standard (0.0.0.0/0); <br><br>  15) Das System, das auf dem Server mit der Adresse <b>192.168.A.1 ausgef√ºhrt wird,</b> findet auf dieselbe Weise wie in den vorherigen F√§llen die MAC-Adresse <b>192.168.A.254</b> , da es sich mit seiner Schnittstelle <b>192.168.A.1 /</b> im selben Netzwerk befindet. <b>24</b> ; <br><br>  16) Der virtuelle Router empf√§ngt dieses Paket und entscheidet, wohin es gesendet werden soll. Er legt fest, dass alle Pakete zwischen <b>192.168.A.0 / 24</b> und <b>192.168.B.0 / 24</b> √ºber eine VPN-Verbindung zwischen <b>AAA1</b> und <b>BBB1 √ºbertragen werden sollen</b> ; <br><br>  17) der virtuelle Router erzeugt ein ESP-Datagramm von <b>AAA1</b> bis <b>BBB1</b> ; <br><br>  18) der virtuelle Router entscheidet, an wen dieses Paket gesendet werden soll, sendet es an <b>AAA254</b> (das Gateway des Internetproviders, in diesem Fall auch wir), da es keine spezifischeren Routen zu <b>BBB1</b> als 0.0.0.0/0 hat; <br><br>  19) Internetprovider √ºbertragen √ºber ihre Netze ein ESP-Datagramm von <b>AAA1</b> bis <b>BBB1</b> ; <br><br>  20) der Router auf <b>BBB1</b> empf√§ngt dieses Datagramm, entschl√ºsselt es und empf√§ngt ein Paket von <b>192.168.A.1: 3389</b> f√ºr <b>192.168.B.1: 55555</b> ; <br><br>  21) er versteht, dass es an <b>192.168.B.1</b> gesendet werden sollte, da er sich mit ihm in demselben Netzwerk befindet, hat er daher einen entsprechenden Eintrag in der Routing-Tabelle, der ihn zwingt, Pakete f√ºr die gesamte <b>192.168.B.0</b> zu senden. <b>24</b> direkt; <br><br>  22) der Router findet die MAC-Adresse f√ºr <b>192.168.B.1</b> und sendet ihm dieses Paket; <br><br>  23) Das Betriebssystem auf dem Computer mit der Adresse <b>192.168.B.1</b> empf√§ngt ein Paket von <b>192.168.A.1: 3389</b> f√ºr <b>192.168.B.1: 55555</b> und leitet die folgenden Schritte zum Herstellen einer TCP-Verbindung ein. <br><br>  Dieses Beispiel ist ziemlich kurz und simpel (und hier k√∂nnen Sie sich an eine Reihe von Details erinnern) und beschreibt, was auf den Ebenen 2 bis 4 passiert.  Stufen 1, 5-7 werden nicht ber√ºcksichtigt. <br><br><h3>  Zweite Position </h3><br>  Wenn etwas speziell an <b>AAA2</b> von <b>192.168.B.0 / 24</b> gesendet wird, geht es nicht an das VPN, sondern direkt.  Das hei√üt, wenn ein Benutzer von Adresse <b>192.168.B.1</b> auf <b>AAA2: 13389 zugreift</b> , wird dieses Paket von Adresse <b>BBB1</b> ausgefranst, an <b>AAA2 weitergeleitet</b> , und dort empf√§ngt der Router es und sendet es an <b>192.168.A.1</b> .  <b>192.168.A.1</b> wei√ü nichts √ºber <b>192.168.B.1</b> , er sieht ein Paket von <b>BBB1</b> , weil er es verstanden hat.  Daher geht die Antwort auf diese Anfrage entlang der allgemeinen Route, es geht genau die gleiche von der Adresse <b>AAA2</b> und geht zu <b>BBB1</b> , und dieser Router gibt diese Antwort an <b>192.168.B.1</b> , er sieht die Antwort von <b>AAA2</b> , an die er adressiert hat. <br><br>  Konkretes Beispiel: <br><br>  1) <b>192.168.B.1</b> adressiert <b>AAA2</b> , m√∂chte eine TCP-Verbindung mit <b>AAA2 herstellen: 13389</b> ; <br><br>  2) <b>192.168.B.1</b> sendet eine Anforderung zum Herstellen einer Verbindung von <b>192.168.B.1: 55555</b> (diese Nummer kann sich wie im vorherigen Beispiel unterscheiden) zu <b>AAA2: 13389</b> ; <br><br>  3) Das Betriebssystem, das auf dem Computer mit der Adresse <b>192.168.B.1 ausgef√ºhrt wird,</b> entscheidet sich f√ºr die √úbertragung dieses Pakets an die Gateway-Adresse des Routers (in unserem Fall <b>192.168.B.254</b> ), da es keine anderen, spezifischeren Routen f√ºr <b>AAA2</b> gibt. Dies bedeutet, dass das Paket auf der Standardroute (0.0.0.0/0) gesendet wird. <br><br>  4) Dazu versucht sie, wie im vorigen Beispiel erw√§hnt, die MAC-Adresse f√ºr die IP-Adresse <b>192.168.B.254</b> in der Cache-Tabelle des ARP-Protokolls zu finden.  Wird es nicht gefunden, sendet es von der Adresse <b>192.168.B.1 eine</b> Broadcast-Wer-hat-Anfrage an das Netzwerk <b>192.168.B.0 / 24</b> .  Wenn <b>192.168.B.254</b> seine MAC-Adresse an ihn <b>zur√ºcksendet,</b> sendet das System ein Ethernet-Paket f√ºr ihn und speichert diese Informationen in seiner Cache-Tabelle. <br><br>  5) Der Router empf√§ngt dieses Paket und entscheidet, wohin es gesendet werden soll. Er hat die Richtlinie, dass alle Pakete von <b>192.168.B.0 / 24</b> an andere Internetknoten weitergeleitet werden m√ºssen (wobei die R√ºcksendeadresse ersetzt wird). <br><br>  6) Da diese Richtlinie impliziert, dass die R√ºcksprungadresse mit der niedrigsten Adresse auf der Schnittstelle √ºbereinstimmen muss, √ºber die dieses Paket √ºbertragen wird, entscheidet der Router zuerst, an wen genau dieses Paket √ºbertragen werden soll, und er sollte es wie im vorherigen Beispiel senden <b>BBB254</b> (Internet Service Provider Gateway), da es keine spezifischeren Routen zu <b>AAA2</b> als 0.0.0.0/0 gibt; <br><br>  7) daher ersetzt der Router die R√ºcksendeadresse des Pakets, von nun an das Paket von <b>BBB1: 44444</b> (die Portnummer kann nat√ºrlich unterschiedlich sein) bis <b>AAA2: 13389</b> ; <br><br>  8) Der Router merkt sich, was er getan hat. Wenn eine <b>Antwort</b> von <b>AAA2: 13389</b> auf <b>BBB1: 44444 eingeht</b> , muss er die Adresse und den Port des Empf√§ngers in <b>192.168.B.1: 55555</b> √§ndern. <br><br>  9) Jetzt muss der Router ihn √ºber <b>BBB254</b> an das Netzwerk des Internetproviders √ºbertragen. Daher findet er, wie bereits erw√§hnt, die MAC-Adresse f√ºr <b>BBB254</b> und sendet das Paket an das Gateway des Internetproviders. <br><br>  10) Internetprovider √ºbertragen ein Paket von <b>BBB1</b> zu <b>AAA2</b> in ihren Netzen; <br><br>  11) der virtuelle Router an <b>AAA2</b> empf√§ngt dieses Paket an Port 13389; <br><br>  12) Auf dem virtuellen Router gibt es eine Regel, die festlegt, dass Pakete, die von einem Absender an diesen Port gesendet wurden, an <b>192.168.A.1: 3389</b> gesendet werden sollen. <br><br>  13) Der virtuelle Router findet das Netzwerk <b>192.168.A.0 / 24</b> in der Routing-Tabelle und sendet es direkt an <b>192.168.A.</b>  1, weil es eine Schnittstelle <b>192.168.A.254 / 24 hat</b> ; <br><br>  14) dazu findet der virtuelle Router die MAC-Adresse f√ºr <b>192.168.A.1</b> und leitet dieses Paket √ºber das virtuelle Ethernet-Netzwerk an ihn weiter; <br><br>  15) <b>192.168.A.1</b> empf√§ngt dieses Paket an Port 3389, stimmt dem Aufbau einer Verbindung zu und bildet ein Paket als Antwort von <b>192.168.A.1: 3389</b> auf <b>BBB1: 44444</b> ; <br><br>  16) sein System sendet dieses Paket an die Gateway-Adresse des virtuellen Routers ( <b>192.168.A.254</b> in unserem Fall), da es keine anderen, spezifischeren Routen f√ºr <b>BBB1 hat</b> , daher muss es das Paket entlang der Standardroute (0.0. 0,0 / 0); <br><br>  17) Das System, das auf dem Server mit der Adresse <b>192.168.A.1 ausgef√ºhrt wird,</b> findet auf dieselbe Weise wie in den vorherigen F√§llen die MAC-Adresse <b>192.168.A.254</b> , da es sich mit seiner Schnittstelle <b>192.168.A.1 in</b> demselben Netzwerk befindet <b>/ 24</b> ; <br><br>  18) Der virtuelle Router akzeptiert dieses Paket.  Es sollte beachtet werden, dass er sich daran erinnert, dass er ein Paket von <b>BBB1: 44444</b> auf <b>AAA2: 13389 erhalten</b> und die Empf√§ngeradresse und den Port auf <b>192.168.A.1: 3389</b> ge√§ndert hat. Daher √§ndert er das Paket von <b>192.168.A.1: 3389</b> auf <b>BBB1: 44444</b> Absenderadresse auf <b>AAA2: 13389</b> ; <br><br>  19) Der virtuelle Router entscheidet, an wen dieses Paket gesendet werden soll, und sendet es an <b>AAA254</b> (das Gateway des Internetproviders, in diesem Fall auch an uns), da er keine spezifischeren Routen zu <b>BBB1</b> als 0.0.0.0/0 hat. <br><br>  20) Internetprovider √ºbertragen ein Paket von <b>AAA2</b> zu <b>BBB1</b> in ihren Netzen; <br><br>  21) Der Router von <b>BBB1</b> empf√§ngt dieses Paket und erinnert sich, dass er beim Senden des Pakets von <b>192.168.B.1: 55555</b> an <b>AAA2: 13389</b> seine Adresse und seinen Absenderport in <b>BBB1: 44444 ge√§ndert hat</b> , was bedeutet, dass dies die Antwort ist, die gesendet werden muss am <b>192.168.B.1: 55555</b> (in der Tat gibt es mehrere weitere Schecks, aber wir gehen nicht darauf ein); <br><br>  22) er versteht, dass sie direkt an <b>192.168.B.1</b> gesendet werden sollten, da er sich mit ihm in demselben Netzwerk befindet, hat er daher einen entsprechenden Eintrag in der Routing-Tabelle, der ihn zwingt, Pakete f√ºr die gesamte <b>192.168.B.0 / 24</b> zu senden direkt; <br><br>  23) der Router findet die MAC-Adresse f√ºr <b>192.168.B.1</b> und sendet ihm dieses Paket; <br><br>  24) Das Betriebssystem auf dem Computer mit der Adresse <b>192.168.B.1</b> empf√§ngt ein Paket von <b>AAA2: 13389</b> f√ºr <b>192.168.B.1: 55555</b> und leitet die folgenden Schritte zum Herstellen einer TCP-Verbindung ein. <br><br>  Es ist zu beachten, dass in diesem Fall der Computer mit der Adresse <b>192.168.B.1</b> nichts √ºber den Server mit der Adresse <b>192.168.A.1</b> wei√ü, sondern nur mit <b>AAA2</b> kommuniziert.  Ebenso wei√ü der Server mit der Adresse <b>192.168.A.1</b> nichts √ºber den Computer mit der Adresse <b>192.168.B.1</b> .  Er glaubt, dass sie sich √ºber die Adresse <b>BBB1</b> mit ihm verbunden <b>haben</b> , und er wei√ü sozusagen nichts mehr. <br><br>  Wenn dieser Computer auf <b>AAA2: 1540</b> zugreift, wird die Verbindung nicht hergestellt, da die Verbindungsweiterleitung an Port 1540 auf dem virtuellen Router nicht konfiguriert ist, selbst wenn sich Server im virtuellen Netzwerk <b>192.168.A.0 befinden / 24</b> (z. B. auf einem Server mit der Adresse <b>192.168.A.1</b> ) und einige Dienste warten auf eine Verbindung an diesem Port.  Wenn der Benutzer des Computers mit der Adresse <b>192.168.B.1</b> unbedingt erforderlich ist, um eine Verbindung mit diesem Dienst herzustellen, muss er ein VPN verwenden, d. H.  wenden Sie sich direkt an <b>192.168.A.1: 1540</b> . <br><br>  Es sollte betont werden, dass alle Versuche, eine Verbindung mit <b>AAA1 herzustellen</b> (mit Ausnahme der IPSec-Verbindung von <b>BBB1)</b> , nicht erfolgreich sind. Alle Versuche, eine Verbindung mit <b>AAA2 herzustellen</b> , mit Ausnahme von Verbindungen zu Port 13389, schlagen ebenfalls fehl. <br>  Beachten Sie auch, dass, wenn eine andere Person <b>AAA2 anruft</b> (z. B. UDP), alles, was in den Abs√§tzen 10 bis 20 angegeben ist, auch f√ºr sie gilt.  Was davor und danach passiert, h√§ngt davon ab, was genau dahintersteckt. Wir besitzen solche Informationen nicht. Daher empfehlen wir Ihnen, die Site-Administratoren mit der Adresse der Adresse zu konsultieren. <br><br><h3>  Dritte Position </h3><br>  Und umgekehrt: Wenn etwas von <b>192.168.A.1</b> an einen Port gesendet wird, der so konfiguriert ist, dass es an BBB1 weitergeleitet wird (z. B. 11111), gelangt es auch nicht in das VPN, sondern <b>blockiert</b> nur <b>AAA1</b> und landet in <b>BBB1</b> und dieser √ºbertr√§gt es bereits irgendwo in, sagen wir, <b>192.168.B.2: 3389</b> .  Er sieht dieses Paket nicht von <b>192.168.A.1</b> , sondern von <b>AAA1</b> .  Wenn <b>192.168.B.2</b> antwortet, wechselt das Paket von <b>BBB1</b> zu <b>AAA1</b> und <b>gelangt</b> sp√§ter zum Verbindungsinitiator - <b>192.168.A.1</b> . <br><br>  Konkretes Beispiel: <br><br>  1) <b>192.168.A.1</b> adressiert <b>BBB1</b> , m√∂chte eine TCP-Verbindung mit <b>BBB1 herstellen: 11111</b> ; <br><br>  2) <b>192.168.A.1</b> sendet eine Anforderung zum Herstellen einer Verbindung von <b>192.168.A.1: 55555</b> (diese Nummer kann wie im vorherigen Beispiel unterschiedlich sein) an <b>BBB1: 11111</b> ; <br><br>  3) Das Betriebssystem, das auf dem Server mit der Adresse <b>192.168.A.1 ausgef√ºhrt wird,</b> entscheidet sich f√ºr die √úbertragung dieses Pakets an die Gateway-Adresse des Routers (in unserem Fall <b>192.168.A.254</b> ), da es keine anderen, spezifischeren Routen f√ºr <b>BBB1</b> gibt. Daher wird das Paket auf der Standardroute (0.0.0.0/0) gesendet. <br><br>  4) Dazu versucht sie, wie in den vorherigen Beispielen erw√§hnt, die MAC-Adresse f√ºr die IP-Adresse <b>192.168.A.254</b> in der Cache-Tabelle des ARP-Protokolls zu finden.  Wird es nicht gefunden, sendet es von der Adresse <b>192.168.A.1 eine</b> Broadcast-Wer-hat-Anfrage an das Netzwerk <b>192.168.A.0 / 24</b> .  Wenn <b>192.168.A.254</b> seine MAC-Adresse an ihn <b>zur√ºcksendet</b> , √ºbertr√§gt das System ein Ethernet-Paket f√ºr ihn und tr√§gt diese Informationen in seine Cache-Tabelle ein. <br><br>  5) Der virtuelle Router empf√§ngt dieses Paket und entscheidet, wohin es √ºbertragen werden soll. Er hat die Richtlinie, dass er alle Pakete von <b>192.168.A.0 / 24</b> an andere Internetknoten weiterleiten muss (wobei die R√ºcksprungadresse ersetzt wird). <br><br>  6) Da diese Richtlinie davon ausgeht, dass die R√ºcksprungadresse mit der niedrigsten Adresse auf der Schnittstelle √ºbereinstimmen muss, √ºber die dieses Paket √ºbertragen wird, entscheidet der virtuelle Router zuerst, an wen genau dieses Paket √ºbertragen werden soll, und er sollte es wie im vorherigen Beispiel senden auf <b>AAA254</b> (das Gateway des Internetproviders, in diesem Fall auch wir), weil es keine spezifischeren Routen zu <b>BBB1</b> als 0.0.0.0/0 gibt; <br><br>  7) es bedeutet, dass der virtuelle Router die R√ºcksendeadresse des Pakets ersetzt, von nun an handelt es sich um ein Paket von <b>AAA1: 44444</b> (die Portnummer kann nat√ºrlich unterschiedlich sein) bis <b>BBB1: 11111</b> ; <br><br>  8) Der virtuelle Router merkt sich, was er getan hat. Wenn eine <b>Antwort</b> von <b>BBB1: 11111</b> f√ºr <b>AAA1: 44444 eingeht</b> , wei√ü er, dass er die Adresse und den Port des Empf√§ngers in <b>192.168.A.1: 55555</b> √§ndern sollte. <br><br>  9) Jetzt muss der virtuelle Router ihn √ºber <b>AAA254</b> an das Netzwerk des Internetproviders <b>√ºbertragen</b> , <b>dh</b> er findet, wie bereits erw√§hnt, die MAC-Adresse f√ºr <b>AAA254</b> und sendet das Paket an das Gateway des Internetproviders. <br><br>  10) Internetprovider √ºbertragen in ihren Netzen ein Paket von <b>AAA1 zu BBB1</b> ; <br><br>  11) der Router an <b>BBB1</b> empf√§ngt dieses Paket an Port 11111; <br><br>  12) Auf dem virtuellen Router gibt es eine Regel, die festlegt, dass Pakete, die von einem Absender an diesen Port gesendet werden, an <b>192.168.B.2: 3389</b> gesendet werden sollen. <br><br>  13) Der Router findet das Netzwerk <b>192.168.B.0 / 24</b> in der Routing-Tabelle und sendet es direkt an <b>192.168.B.2</b> , da es eine Schnittstelle <b>192.168.B.254 / 24 hat</b> . <br><br>  14) dazu findet der virtuelle Router die MAC-Adresse f√ºr <b>192.168.B.2</b> und leitet dieses Paket √ºber das virtuelle Ethernet-Netzwerk an ihn weiter; <br><br>  15) <b>192.168.B.2</b> empf√§ngt dieses Paket an Port 3389, stimmt dem Aufbau einer Verbindung zu und bildet ein Paket als Antwort von <b>192.168.B.2: 3389</b> auf <b>AAA1: 44444</b> ; <br><br>  16) Sein System sendet dieses Paket an die Gateway-Adresse des Routers (in unserem Fall <b>192.168.B.254</b> ), da es keine anderen, spezifischeren Routen f√ºr <b>AAA1</b> hat. Daher muss es das Paket entlang der Standardroute (0.0.0.0) weiterleiten / 0); <br><br>  17) Das System, das auf dem Computer mit der Adresse <b>192.168.B.2 ausgef√ºhrt wird,</b> findet auf dieselbe Weise wie in den vorherigen F√§llen die MAC-Adresse <b>192.168.B.254</b> , da es sich mit seiner Schnittstelle <b>192.168.B.2 in</b> demselben Netzwerk befindet <b>/ 24</b> ; <br><br>  18) Der Router akzeptiert dieses Paket.  Es ist zu beachten, dass er sich daran erinnert, dass er ein Paket von <b>AAA1</b> auf <b>BBB1: 11111 erhalten</b> und die Empf√§ngeradresse und den Port in <b>192.168.B.2: 3389</b> ge√§ndert hat. Daher √§ndert er die Absenderadresse in ein Paket von <b>192.168.B.2: 3389</b> f√ºr <b>AAA1: 44444</b> auf <b>BBB1: 11111</b> ; <br><br>  19) Der Router entscheidet, an wen dieses Paket weitergeleitet wird.  Er sendet es beispielsweise an <b>BBB254</b> (das Gateway des Internetproviders, dessen genaue Adresse wir nicht kennen), da es keine spezifischeren Routen zu <b>AAA1</b> als 0.0.0.0/0 gibt. <br><br>  20) Internetprovider √ºbertragen ein Paket von <b>BBB1</b> zu <b>AAA1</b> in ihren Netzen; <br><br>  21) Der virtuelle Router auf <b>AAA1</b> empf√§ngt dieses Paket und erinnert sich, dass er beim Senden des Pakets von <b>192.168.A.1: 55555</b> auf <b>BBB1: 11111</b> seine Adresse und seinen Absenderport in <b>AAA1: 44444 ge√§ndert hat</b> .  Dies ist also die Antwort, die an <b>192.168.A.1: 55555</b> gesendet werden muss (tats√§chlich gibt es, wie wir im vorherigen Beispiel erw√§hnt haben, auch ein paar weitere √úberpr√ºfungen, aber diesmal gehen wir nicht darauf ein). <br><br> 22)  ,       <b>192.168.A.1</b> ,        , ,        ,        <b>192.168.A.0/24</b> ; <br><br> 23)   MAC-  <b>192.168.A.1</b>     ; <br><br> 24)       <b>192.168.A.1</b>    <b>BBB1:1111</b> 1  <b>192.168.A.1:55555</b>       TCP-. <br><br>   ,     ,       <b>192.168.A.1</b>        <b>192.168.B.1</b> ,     <b>BBB1</b> .    <b>192.168.B.1</b>         <b>192.168.A.1</b> .  ,       <b>AAA1</b> ,     . <br><br><h3>  Fazit </h3><br>        VPN-       ,      VPN-.              , <a href="https://tucha.ua/ru/contacts"> 247.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de477854/">https://habr.com/ru/post/de477854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de477842/index.html">Geschichten von Gennady Zelenko und Sergey Popov - Technologie-Popularisatoren in der UdSSR</a></li>
<li><a href="../de477844/index.html">5 Schritte von der Idee bis zur praktischen Anwendung des maschinellen Lernens mit SAP Data Intelligence</a></li>
<li><a href="../de477846/index.html">Die Zusammenfassung der Ereignisse f√ºr HR-Experten in der IT f√ºr Dezember 2019</a></li>
<li><a href="../de477848/index.html">Das kleine Geheimnis eines gro√üen Herzens: das erste Blauwal-Kardiogramm der Geschichte</a></li>
<li><a href="../de477852/index.html">Ungiftige Heuchelei</a></li>
<li><a href="../de477856/index.html">PCI-E-Flash-Beschleuniger von 800 GB bis 6,4 TB: von Anfang an ein normaler PC / Server</a></li>
<li><a href="../de477858/index.html">Off-Table-Arbeit: Welche Projekte kamen nach der Vorbeschleunigung wirklich zum Vorschein?</a></li>
<li><a href="../de477860/index.html">Wie werden verwaltete Datenbankdienste in Yandex Cloud angeordnet?</a></li>
<li><a href="../de477862/index.html">Und so war es m√∂glich? Wissenschaft und IT in einer Konferenz</a></li>
<li><a href="../de477866/index.html">Seminar: Hybride IT-L√∂sungen f√ºr Unternehmen. 5. Dezember, St. Petersburg</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>