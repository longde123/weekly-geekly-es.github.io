<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéß üò§ üë©üèø‚ÄçüöÄ An√°lisis de puerta trasera de Turla Cybergroup Outlook ü§üüèæ üëàüèº üôã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Turla (Snake, Uroboros) es un grupo de espionaje cibern√©tico que gan√≥ fama en 2008 despu√©s de piratear objetos protegidos, incluida la red del Comando...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lisis de puerta trasera de Turla Cybergroup Outlook</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421399/"><p>  Turla (Snake, Uroboros) es un grupo de espionaje cibern√©tico que gan√≥ fama en 2008 despu√©s de piratear objetos protegidos, incluida la red del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Comando Central de las Fuerzas Armadas de EE</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UU</a> .  Desde entonces, se especializa en ataques contra instalaciones militares y agencias diplom√°ticas en todo el mundo.  Las v√≠ctimas famosas incluyen el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ministerio de Asuntos Exteriores de Finlandia</a> en 2013, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">corporaci√≥n de defensa suiza RUAG</a> de 2014 a 2016.  y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el gobierno alem√°n</a> a fines de 2017 - principios de 2018. </p><br><p>  Despu√©s del √∫ltimo incidente, varios medios de comunicaci√≥n publicaron informaci√≥n sobre los m√©todos de los atacantes, utilizando archivos adjuntos de correo electr√≥nico para controlar el malware y transferir datos robados del sistema.  Sin embargo, no se proporcion√≥ informaci√≥n t√©cnica sobre la puerta trasera.  En este informe, publicamos el an√°lisis de la puerta trasera de Turla, que se administr√≥ utilizando archivos adjuntos PDF en el correo electr√≥nico. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l_/db/ws/l_dbws8skuoavwqn1vorwdhobgo.jpeg"></div><a name="habracut"></a><br><p>  Seg√∫n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">los informes de los medios</a> , varias computadoras del Ministerio de Relaciones Exteriores de Alemania estaban infectadas con una puerta trasera.  Aparentemente, el ataque comenz√≥ en 2016 y fue descubierto por los servicios de seguridad a fines de 2017. Inicialmente, los atacantes comprometieron a la Escuela Secundaria Federal de Administraci√≥n P√∫blica (Hochschule des Bundes), luego de lo cual se trasladaron dentro de su red hasta que obtuvieron acceso a la red del Ministerio de Relaciones Exteriores en marzo de 2017. .  Los operadores de Turla tuvieron acceso a algunos datos confidenciales (por ejemplo, el correo electr√≥nico de los empleados del Ministerio de Relaciones Exteriores alem√°n) durante aproximadamente un a√±o. </p><br><p>  Nuestra investigaci√≥n tambi√©n revela que este malware dirigido a Microsoft Outlook se us√≥ contra varios departamentos pol√≠ticos y militares.  Nos aseguramos de que los ministerios de asuntos exteriores de los otros dos pa√≠ses europeos y el principal contratista de defensa tambi√©n estuvieran comprometidos.  Nuestra investigaci√≥n nos permiti√≥ establecer docenas de direcciones de correo electr√≥nico registradas por los operadores de Turla para esta campa√±a y utilizadas para obtener datos de v√≠ctimas extra√≠das. </p><br><h2>  1. Puntos clave </h2><br><p>  La puerta trasera de Outlook de Turla Group tiene dos funciones. </p><br><p>  En primer lugar, es el robo de cartas salientes que se env√≠an al atacante.  Afecta principalmente a Microsoft Outlook, pero tambi√©n es relevante para The Bat !, popular en Europa del Este. </p><br><p>  En segundo lugar, el uso de letras como capa de transporte de su protocolo C&amp;C.  Los archivos solicitados a trav√©s del comando de puerta trasera se extraen en documentos PDF especialmente creados como un archivo adjunto a las letras.  Los comandos de puerta trasera tambi√©n se env√≠an en archivos PDF adjuntos.  Esto permite el secreto.  Es importante tener en cuenta que los atacantes no explotan ninguna vulnerabilidad en los lectores de PDF o Microsoft Outlook.  El software malicioso puede decodificar datos de documentos PDF e interpretarlos como comandos. </p><br><p>  Los objetivos de la campa√±a son t√≠picos de Turla.  Hemos identificado varias agencias gubernamentales europeas y compa√±√≠as de defensa comprometidas por esta puerta trasera.  Es probable que los atacantes lo usen para garantizar la persistencia en redes de acceso restringido, donde los firewalls bien configurados u otras herramientas de seguridad de red bloquean efectivamente las comunicaciones tradicionales con servidores C&amp;C a trav√©s de HTTP (S).  La figura a continuaci√≥n enumera las l√≠neas de c√≥digo de puerta trasera que mencionan algunos dominios de nivel superior del gobierno.  mfa es el dominio del Ministerio de Asuntos Exteriores, .gouv es un subdominio del gobierno franc√©s (.gouv.fr), ocse es la Organizaci√≥n para la Seguridad y la Cooperaci√≥n en Europa. </p><br><img src="https://habrastorage.org/webt/xt/ix/e9/xtixe9vxop-os9ktobaea5qqdbu.png"><br><p>  <i>Figura 1. Dominios asociados con los servicios p√∫blicos encontrados en el c√≥digo Malvari</i> </p><br><p>  Con base en el an√°lisis y los datos de telemetr√≠a, encontramos que esta puerta trasera se ha distribuido en la naturaleza desde al menos 2013.  Como siempre con Turla, no podemos centrarnos en las marcas de tiempo de compilaci√≥n, ya que generalmente son falsas.  Sin embargo, creemos que las primeras versiones se compilaron antes de 2013, ya que la versi√≥n de este a√±o ya estaba bastante avanzada.  Despu√©s de eso, encontramos una versi√≥n m√°s similar a la base, cuya compilaci√≥n fue fechada en 2009.  A√∫n no es posible determinar la fecha exacta de lanzamiento.  La l√≠nea de tiempo a continuaci√≥n se basa en nuestra telemetr√≠a y datos de fuentes abiertas: </p><br><p>  <b>2009</b> : Marca de tiempo de compilaci√≥n (puede ser falsa) de la versi√≥n base de la puerta trasera de Outlook.  Solo una instant√°nea del contenido del correo electr√≥nico. <br>  <b>2013</b> : Mejorado: la puerta trasera puede ejecutar comandos.  Se env√≠an por correo electr√≥nico en formato XML. <br>  <b>2013</b> : ¬°La √∫ltima versi√≥n conocida dirigida a The Bat! .. <br>  <b>2016</b> : Mejorado: los equipos se env√≠an como archivos adjuntos en documentos PDF especialmente creados. <br>  <b>2017</b> : Mejorado: una puerta trasera puede crear documentos PDF para extraer datos de un atacante. <br>  <b>Marzo de 2018</b> : informe de compromiso de la red del gobierno alem√°n. <br>  <b>Abril de 2018</b> : Mejorado: Backdoor puede ejecutar comandos de PowerShell usando Empire PSInject. </p><br><h2>  2. Arquitectura global </h2><br><p>  En versiones recientes, la puerta trasera es una DLL independiente, en la que hay c√≥digo para la autoinstalaci√≥n y la interacci√≥n con Outlook y The Bat !, clientes de correo electr√≥nico, incluso si solo se implementa la instalaci√≥n para Outlook.  Puede ser eliminado f√°cilmente por cualquier componente de Turla que le permita realizar procesos adicionales. </p><br><p>  En esta secci√≥n, nuestro an√°lisis se basa en una muestra publicada en el primer semestre de 2017.  Se puede incluir informaci√≥n sobre muestras m√°s antiguas o m√°s nuevas. </p><br><h3>  2.1.  Instalaci√≥n </h3><br><p>  Para establecer una puerta trasera, los atacantes exportan una DLL llamada Instalar o la registran con regsvr32.exe.  El argumento es el cliente de correo electr√≥nico de destino.  La siguiente figura muestra los posibles valores.  En las √∫ltimas versiones, solo se implementa la instalaci√≥n de Outlook. </p><br><img src="https://habrastorage.org/webt/9g/8r/qm/9g8rqm3z7keq_phkhvlztwzwtyo.png"><br><p>  <i>Figura 2. Posibles argumentos de instalaci√≥n</i> </p><br><p>  Como no hay una ruta codificada, el archivo DLL se puede ubicar en cualquier parte del disco. </p><br><h4>  2.1.1  Microsoft Outlook </h4><br><p>  Los desarrolladores de Turla conf√≠an en el secuestro de objetos COM para garantizar la persistencia del malware.  Este es un m√©todo bien conocido utilizado en la naturaleza durante muchos a√±os, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">incluido el grupo Turla</a> .  La esencia del m√©todo es redirigir el objeto COM utilizado por la aplicaci√≥n de destino modificando la entrada CLSID correspondiente en el registro de Windows. </p><br><p>  En nuestro caso, se han realizado los siguientes cambios en el registro de Windows: </p><br><pre><code class="hljs powershell">HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>} = Mail Plugin HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32 = [<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-type"><span class="hljs-type">to</span></span> <span class="hljs-type"><span class="hljs-type">the</span></span> <span class="hljs-type"><span class="hljs-type">backdoor</span></span> <span class="hljs-type"><span class="hljs-type">DLL</span></span>] HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}\InprocServer32\ThreadingModel = Apartment HKCU\Software\Classes\CLSID\{<span class="hljs-number"><span class="hljs-number">84</span></span>DA0A92<span class="hljs-literal"><span class="hljs-literal">-25E0</span></span><span class="hljs-literal"><span class="hljs-literal">-11D3</span></span><span class="hljs-literal"><span class="hljs-literal">-B9F7</span></span><span class="hljs-literal"><span class="hljs-literal">-00C04F4C8F5D</span></span>}\TreatAs = {<span class="hljs-number"><span class="hljs-number">49</span></span>CBB1C7<span class="hljs-literal"><span class="hljs-literal">-97D1</span></span><span class="hljs-literal"><span class="hljs-literal">-485A</span></span><span class="hljs-literal"><span class="hljs-literal">-9EC1</span></span><span class="hljs-literal"><span class="hljs-literal">-A26065633066</span></span>}</code> </pre> <br><p>  <code>{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D}</code> - CLSID capturado.  Corresponde al Administrador de protocolos de Outlook y, en teor√≠a, carga el archivo <code>OLMAPI32.DLL</code> leg√≠timo de Outlook.  <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> no <code>{49CBB1C7-97D1-485A-9EC1-A26065633066}</code> asociado con ning√∫n software conocido.  Este CLSID es arbitrario y se usa solo como marcador de posici√≥n para la redirecci√≥n COM. </p><br><p>  Cuando se completa la modificaci√≥n, la DLL de puerta trasera se cargar√° cada vez que Outlook cargue su objeto COM.  Seg√∫n nuestras observaciones, esto sucede durante el inicio de Outlook. </p><br><p>  La redirecci√≥n de COM no requiere derechos de administrador, ya que solo se aplica al usuario actual.  Existen medidas de protecci√≥n para evitar tales redireccionamientos maliciosos.  Seg√∫n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MSDN</a> : "Con Windows Vista y Windows Server 2008, si el nivel de integridad del proceso es superior al promedio, el tiempo de ejecuci√≥n COM ignora la configuraci√≥n COM del usuario y solo accede a la configuraci√≥n COM para cada m√°quina". </p><br><p>  El proceso de Outlook se ejecuta con una integridad media, como se muestra en la imagen a continuaci√≥n.  Por lo tanto, no est√° protegido del reenv√≠o de COM para cada usuario. </p><br><img src="https://habrastorage.org/webt/q4/uq/zt/q4uqzt_g3c6vgonoluf_7ttrqpw.png"><br><p>  <i>Figura 3. Nivel de integridad del proceso de Outlook</i> </p><br><p>  Finalmente, el uso de la captura de objetos COM permite que la puerta trasera evite la detecci√≥n, ya que la ruta a la puerta trasera ( <code>C:\Users\User\Documents\mapid.tlb</code> en nuestro ejemplo) no aparece en la lista de complementos, como se muestra en la siguiente figura. </p><br><img src="https://habrastorage.org/webt/4l/cj/s3/4lcjs3tai1gd5gopfekwd7skjra.png"><br><p>  <i>Figura 4. Lista de complementos de Outlook: mapid.tlb no aparece</i> </p><br><p>  Incluso si el programa malicioso no aparece en la lista de complementos, la API est√°ndar de Microsoft - MAPI (interfaz de programaci√≥n de aplicaciones de mensajer√≠a) se usa para interactuar con Outlook. </p><br><h4>  2.1.2.  El murci√©lago! </h4><br><p>  Como se especifica en la cronolog√≠a, las √∫ltimas versiones de la puerta trasera ya no incluyen el c√≥digo de registro para el complemento The Bat! .. Sin embargo, todav√≠a existe todo el c√≥digo para administrar los buzones y los mensajes.  Si es necesario, se puede configurar manualmente. </p><br><p>  Para registrarse como un complemento para The Bat!  el malware modific√≥ el <code>%appdata%\The Bat!\Mail\TBPlugin.INI</code> .  Esta es una forma leg√≠tima de registrar un complemento para The Bat !, algunos complementos (por ejemplo, antispam) tambi√©n lo usan. </p><br><p>  ¬°Despu√©s de registrarte cada vez que inicias The Bat!  Se llama a la DLL de puerta trasera.  La siguiente figura muestra c√≥mo la DLL implementa la exportaci√≥n requerida para los complementos. </p><br><img src="https://habrastorage.org/webt/xq/x7/zs/xqx7zsv5pwjjmhonegcsmpmnwx0.png"><br><p>  <i>Figura 5. Exportaci√≥n est√°ndar para el complemento Bat!</i> </p><br><h3>  2.2.  Interacci√≥n con el cliente de correo. </h3><br><p>  La interacci√≥n con el cliente de correo depende del objetivo. </p><br><h4>  2.2.1.  Microsoft Outlook </h4><br><p>  Microsoft admite la interfaz de programaci√≥n de aplicaciones de mensajer√≠a (MAPI), que permite que las aplicaciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">interact√∫en con Outlook</a> .  La puerta trasera de Turla usa esta API para acceder y administrar los buzones de un usuario / usuarios de un sistema comprometido. </p><br><p>  Primero, la puerta trasera se conecta al sistema de mensajer√≠a usando MAPILogonEx, como se muestra en la figura. </p><br><img src="https://habrastorage.org/webt/nf/fp/u1/nffpu1duhw9u7rmxytdm1chwpey.png"><br><p>  <i>Figura 6. Inicio de sesi√≥n MAPI</i> </p><br><p>  El segundo par√°metro (lpszProfileName) est√° vac√≠o, se establece el indicador <code>MAPI_USE_DEFAULT</code> .  De acuerdo con la documentaci√≥n: "El subsistema de mensajer√≠a debe anular el nombre de perfil predeterminado para el par√°metro lpszProfileName. El indicador <code>MAPI_EXPLICIT_PROFILE</code> ignora a menos que lpszProfileName est√© NULL o vac√≠o". </p><br><p>  Por el contrario, el indicador <code>MAPI_NEW_SESSION</code> no <code>MAPI_NEW_SESSION</code> establecido.  Seg√∫n la documentaci√≥n: "El par√°metro <code>lpszProfileName</code> ignora si hay una sesi√≥n anterior llamada MapiLogonEx con el indicador <code>MAPI_ALLOW_OTHERS</code> y si el indicador <code>MAPI_NEW_SESSION</code> no <code>MAPI_NEW_SESSION</code> establecido". </p><br><p>  En nuestra opini√≥n, Outlook abre una sesi√≥n predeterminada con el indicador <code>MAPI_ALLOW_OTHERS</code> .  Por lo tanto, la puerta trasera utilizar√° una sesi√≥n abierta previamente para obtener acceso al perfil predeterminado del buz√≥n.  Esto explica la falta de una solicitud de nombre de usuario y contrase√±a al inicializar el complemento de puerta trasera. </p><br><p>  Una vez hecho esto, la puerta trasera tendr√° acceso al buz√≥n y podr√° administrarlo f√°cilmente utilizando otras funciones MAPI.  Recorrer√° varios almacenes de mensajes, analizar√° letras y agregar√° devoluciones de llamada a los mensajes entrantes y salientes.  El archivo de registro muestra este proceso (nombre de usuario y direcci√≥n cambiados): </p><br><pre> <code class="hljs pgsql">&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; ========= Analyzing msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Service <span class="hljs-type"><span class="hljs-type">name</span></span>:MSUPST MS Pst <span class="hljs-type"><span class="hljs-type">path</span></span>:C:\Users\[username]\Documents\Outlook Files\[email address].pst Wait main <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> count = <span class="hljs-number"><span class="hljs-number">46</span></span> This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> message store PUSH store <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> list &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _____________ FOLDERS _____________ Setting sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> folders <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> stores. ========Process msg store ( <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">1</span></span> ) ========= Account: [email address] Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Outbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store. Successfull <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> Inbox folder <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> store.</code> </pre> <br><p>  <code>HrAllocAdviseSink</code> una devoluci√≥n de llamada en cada bandeja de entrada y <code>HrAllocAdviseSink</code> utilizando la funci√≥n <code>HrAllocAdviseSink</code> , como se muestra. </p><br><img src="https://habrastorage.org/webt/ud/df/js/uddfjs5ub7qj9n3gxlxslirppcq.png"><br><p>  <i>Figura 7. Registro de una devoluci√≥n de llamada en la Bandeja de salida</i> </p><br><p>  <b>2.2.1.1.</b>  <b>Bandeja de entrada de devoluci√≥n de llamada</b> </p><br><p>  La devoluci√≥n de llamada en la bandeja de entrada registra los metadatos del mensaje entrante, incluidas las direcciones de remitente y destinatario, el asunto y los nombres de los archivos adjuntos.  Ejemplo a continuaci√≥n (ortograf√≠a del desarrollador guardada): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">RECIVE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt;{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: sender@example.com To: receiver@example.net Cc: Bcc: Subj: Mail subject Att: an_attachment.pdf }</code> </pre> <br><p>  Luego analiza la carta y los archivos adjuntos sobre el tema de los equipos de los atacantes.  Esta funci√≥n se describe en la secci√≥n 2.3. </p><br><p>  Finalmente, intercepta los NDR al verificar los mensajes entrantes con la direcci√≥n de correo electr√≥nico del operador.  Cualquier carta que contenga la direcci√≥n del operador ser√° rechazada.  Esto puede causar problemas si la v√≠ctima sospecha que algo est√° mal y se pone en contacto con el servicio de soporte sin ver las respuestas. </p><br><p>  <b>2.2.1.2.</b>  <b>Devoluci√≥n de llamada en la bandeja de salida</b> </p><br><p>  Al igual que en la bandeja de entrada, la bandeja de salida registra los metadatos de todos los correos electr√≥nicos enviados.  Se genera el siguiente registro (se cambia la direcci√≥n del operador): </p><br><pre> <code class="hljs css">21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SEND</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">From</span></span>: To: recipient@example.com Cc: Bcc: Subj: My title Att: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-string"><span class="hljs-string">"last_presentation.pdf"</span></span> } 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sending</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ENTRYID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Message ENTRYID]</span></span> 21<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:56</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">was</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">send</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">To</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[redacted]</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">gmx</span></span>[.]<span class="hljs-keyword"><span class="hljs-keyword">com</span></span> From: Subj: My title <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Set last time. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> Spawned thread for cleaning up outgoing messages (id <span class="hljs-number"><span class="hljs-number">2848</span></span>) <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Ending work, client: Outlook <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of messages to remove: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Message ENTRYID: [Message ENTRYID] <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> DeleteMessages executed successfully. <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> Number of not removed messages: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Puede notar que reenv√≠a todos los mensajes salientes a la direcci√≥n de los atacantes, <code>[‚Ä¶]@gmx[.]com</code> .  GMX: un popular servicio de correo electr√≥nico gratuito;  los atacantes probablemente lo eligieron, porque las organizaciones generalmente no bloquean el dominio gmx.com. </p><br><p>  Esta direcci√≥n de correo electr√≥nico est√° codificada en la muestra que estudiamos, como se muestra en la imagen a continuaci√≥n.  Sin embargo, se puede actualizar utilizando una de las funciones de puerta trasera.  Los atacantes parecen estar registrando al menos una direcci√≥n de correo electr√≥nico para cada objetivo <br>  organizaciones que usan el formato <code>firstname.lastname@gmx[.]com</code> con el nombre del empleado real.  Esto evita la detecci√≥n, ya que a menudo es dif√≠cil distinguir dicha direcci√≥n del buz√≥n personal de un empleado real.  En el momento del an√°lisis de la muestra en junio de 2018, la direcci√≥n no estaba disponible. </p><br><img src="https://habrastorage.org/webt/9c/tr/-d/9ctr-dcusp0p35kcuhiqw4pypns.png"><br><p>  <i>Figura 8. Direcci√≥n codificada de los operadores</i> </p><br><p>  La puerta trasera env√≠a informes a la direcci√≥n de los operadores a ciertos intervalos.  El informe incluye identificadores √∫nicos, incluida la direcci√≥n MAC, el archivo de registro completo y los resultados del comando, si los hay.  Luego, encripta los datos usando MISTY1, como se describe m√°s adelante en la secci√≥n 2.3.2.2, y crea un archivo PDF v√°lido con contenido encriptado.  Antes de este blob de datos cifrados, el documento contiene una imagen blanca 1x1 en formato jpeg, codificada en un programa malicioso.  Esto le permite crear un PDF v√°lido que, cuando se abre, muestra solo una p√°gina en blanco. </p><br><p>  Finalmente, la puerta trasera adjunta el PDF y env√≠a un correo electr√≥nico a los atacantes.  La siguiente figura es un ejemplo de un archivo PDF creado por una puerta trasera. </p><br><img src="https://habrastorage.org/webt/d4/6f/yx/d46fyxd9n7e-ziu9jwjxdtedqke.png"><br><p>  <i>Figura 9. Comienzo de un documento PDF creado por una puerta trasera para filtrar datos</i> </p><br><p>  El informe se env√≠a utilizando la funci√≥n de devoluci√≥n de llamada en la bandeja de salida.  Esto significa que la carta se ir√° al mismo tiempo que env√≠a mensajes de usuario leg√≠timos.  La puerta trasera no puede enviar cartas con datos robados en un momento inusual para el usuario y, por lo tanto, evita la detecci√≥n.  Gracias al sigilo, este mecanismo de control y control es muy dif√≠cil de detectar en la naturaleza. </p><br><h4>  2.2.2.  Disfrazar el comportamiento malicioso del usuario </h4><br><p>  Dado que la puerta trasera act√∫a cuando el usuario trabaja con la computadora y Outlook, el malware intenta ocultar la actividad maliciosa, por ejemplo, los mensajes entrantes de los operadores. </p><br><p>  En primer lugar, una puerta trasera siempre elimina el correo enviado o recibido de los operadores.  Como se muestra en la figura siguiente, durante unos segundos puede ver que ha aparecido un nuevo mensaje que, sin embargo, no aparece en el buz√≥n. </p><br><img src="https://habrastorage.org/webt/o7/pc/wh/o7pcwhrtwemk2qfqrfdtgjb6p0o.png"><br><p>  <i>Figura 10. Mensaje no le√≠do</i> </p><br><p>  En segundo lugar, la puerta trasera intercepta la <code>CreateWindowsEx</code> , como se muestra en las siguientes figuras.  Esto evita la creaci√≥n de ventanas como NetUIHWND que Outlook usa para las notificaciones que aparecen en la esquina inferior derecha de la pantalla. </p><br><img src="https://habrastorage.org/webt/7y/wn/xq/7ywnxqshbevin9-ncsw8lhprkvo.png"><br><p>  <i>Figura 11. Configuraci√≥n de la captura de la funci√≥n CreateWindowsEx</i> </p><br><img src="https://habrastorage.org/webt/ki/1_/zr/ki1_zrks5vaspkm-bpz2j-z9asu.png"><br><p>  <i>Figura 12. Intercepci√≥n de CreateWindowsEx</i> </p><br><p>  La siguiente figura muestra un ejemplo de la ventana NetUIHWND, que generalmente se muestra en el escritorio cuando se recibe un nuevo mensaje.  Como resultado de la intercepci√≥n de <code>CreateWindowEx</code> , no se muestra una notificaci√≥n cuando los atacantes env√≠an una carta a la puerta trasera. </p><br><img src="https://habrastorage.org/webt/bd/5n/3b/bd5n3bq_pijmhlosvf6muvjcyjq.png"><br><p>  <i>Figura 13. Notificaci√≥n de mensaje nuevo</i> </p><br><h4>  2.2.3.  El murci√©lago! </h4><br><p>  A pesar de que la funci√≥n de registro del complemento para The Bat!  ya no existe, hay un c√≥digo heredado que realiza las mismas funciones que para Outlook usando la API The Bat! </p><br><p>  Como se muestra en la figura siguiente, la puerta trasera utiliza el canal de comunicaci√≥n con The Bat! Para recibir informaci√≥n del usuario, leer y enviar cartas.  Sin embargo, todas las dem√°s funciones, por ejemplo, utilizadas para registrar mensajes o ejecutar comandos, son id√©nticas a Outlook. </p><br><img src="https://habrastorage.org/webt/iy/qb/ub/iyqbubrelp4uwudy8n4gby7n6lq.png"><br><p>  <i>Figura 14. El canal Bat!</i> </p><br><h3>  2.3.  Puerta trasera </h3><br><p>  Como se muestra en la secci√≥n anterior, el malware puede procesar y filtrar mensajes.  Al mismo tiempo, es una puerta trasera completamente funcional impulsada por correo electr√≥nico que puede funcionar independientemente de cualquier otro componente de Turla.  La puerta trasera no necesita una conexi√≥n permanente a Internet y puede funcionar en cualquier computadora que env√≠e mensajes a direcciones externas.  Esto es √∫til en redes estrictamente controladas, por ejemplo, mediante el filtrado del tr√°fico de Internet.  Adem√°s, incluso si la direcci√≥n de correo electr√≥nico de los atacantes est√° inactiva, pueden recuperar el control enviando un comando desde una direcci√≥n diferente.  En este caso, la carta tambi√©n estar√° oculta para el usuario, ya que contendr√° comandos interpretados por la puerta trasera.  Por lo tanto, una puerta trasera es tan tolerante a fallas como un rootkit que verifica el tr√°fico de red entrante. </p><br><h4>  2.3.1.  Formato pdf </h4><br><p>  A principios de 2018, varios medios de comunicaci√≥n declararon que los operadores de Turla usan archivos adjuntos de correo electr√≥nico para administrar computadoras infectadas.  Los medios ten√≠an raz√≥n.  Un an√°lisis de la puerta trasera de Turla Outlook revel√≥ c√≥mo env√≠a e interpreta comandos. </p><br><p>  Los comandos se env√≠an por correo electr√≥nico utilizando archivos PDF especialmente creados.  No pudimos encontrar un PDF de muestra real con comandos, pero estos son probablemente documentos PDF v√°lidos, as√≠ como archivos PDF creados por la puerta trasera para exfiltraci√≥n. </p><br><p>  A partir de documentos PDF, una puerta trasera puede restaurar lo que los operadores llaman un contenedor en revistas.  Este es un blob con un formato especial que contiene comandos cifrados para la puerta trasera.  La siguiente figura muestra el procedimiento para extraer este contenedor.  T√©cnicamente, la aplicaci√≥n no tiene que ser un documento PDF v√°lido.  El √∫nico requisito es que incluya el contenedor en el formato correcto. </p><br><img src="https://habrastorage.org/webt/hb/r_/yf/hbr_yfy47qewou5f_tqbrpdn5ck.png"><br><p>  <i>Figura 15. Extracci√≥n del contenedor de comandos del PDF</i> </p><br><p>  El contenedor tiene una estructura compleja con muchos controles diferentes.  Podr√≠a dise√±arse para evitar errores de comunicaci√≥n, pero creemos que la estructura se cre√≥ principalmente para contrarrestar la ingenier√≠a inversa.  La estructura del contenedor se muestra en la figura a continuaci√≥n. </p><br><img src="https://habrastorage.org/webt/ud/aa/6w/udaa6wvubnjskhmfrgsoalfke70.png"><br><p>  <i>Figura 16. Estructura del contenedor de comandos</i> </p><br><p>  Inmediatamente antes del vector de inicializaci√≥n, hay una lista de descriptores de comandos.  Se presentan diferentes valores de ID en la tabla: </p><br><img src="https://habrastorage.org/webt/jy/sg/5o/jysg5opuoyhwir5hre-xi9quhxq.png"><br><p><br>  Los descriptores de ID 2 y 4 se utilizan para extraer las funciones de cifrado y descompresi√≥n, como se muestra en la siguiente figura.  Sin embargo, el programa malicioso implementa solo un algoritmo de cifrado y un algoritmo de compresi√≥n.  Por lo tanto, el √∫nico prop√≥sito de estos campos es complicar el an√°lisis de la puerta trasera. </p><br><img src="https://habrastorage.org/webt/h8/sh/gu/h8shgunmwafcbx6h1shccn9-ndo.png"><br><p>  <i>Figura 17. Funciones de descompresi√≥n y descifrado compensadas</i> </p><br><p>  Los equipos est√°n en la √∫ltima parte de la estructura.  Se cifran con MISTY1 y se comprimen con bzip2.  Puede haber muchos comandos diferentes en el mismo archivo PDF, y cada uno puede tener varios argumentos. </p><br><h4>  2.3.2.  Criptograf√≠a </h4><br><p>  Aqu√≠ describimos los algoritmos de cifrado utilizados. </p><br><p>  <b>2.3.2.1.</b>  <b>Cifrado XOR</b> </p><br><p>  Parte del contenedor (comenzando con el primer CRC32) se cifra con XOR con el flujo de bytes generado por la funci√≥n definida por el usuario.  Se necesita una semilla, que se pasa a <code>srand</code> para generar un segundo n√∫mero llamando a rand.  La segunda semilla se usa en la funci√≥n que se muestra a continuaci√≥n como argumento para los datos en XOR. </p><br><pre> <code class="hljs powershell">int __usercall F_bytestream_xor<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;eax&gt;(unsigned int len<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;edx&gt;, int ciphertext<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>&lt;ecx&gt;, unsigned int seed) { unsigned int v3; // ebx int v4; // esi unsigned int v5; // edi int result; // eax unsigned int v7; // ecx char *v8; // edx unsigned int v9; // esi byte key[<span class="hljs-number"><span class="hljs-number">512</span></span>]; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">204</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] char *v11; // [<span class="hljs-type"><span class="hljs-type">esp</span></span>+<span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-type"><span class="hljs-type">Ch</span></span>] [<span class="hljs-type"><span class="hljs-type">ebp</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-type"><span class="hljs-type">h</span></span>] v3 = len; v11 = (char *)ciphertext; srand(seed); v4 = <span class="hljs-number"><span class="hljs-number">0</span></span>; v5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { result = rand(); *(_DWORD *)&amp;key[<span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-type"><span class="hljs-type">v5</span></span>++] = result; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v5 &lt; <span class="hljs-number"><span class="hljs-number">128</span></span> ); v7 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !v3 ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; v8 = v11; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { v8[<span class="hljs-type"><span class="hljs-type">v7</span></span>] ^= key[<span class="hljs-type"><span class="hljs-type">v4</span></span>]; v9 = v4 + <span class="hljs-number"><span class="hljs-number">1</span></span>; result = -(v9 &lt; <span class="hljs-number"><span class="hljs-number">512</span></span>); v4 = result &amp; v9; ++v7; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( v7 &lt; v3 ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  <strong>2.3.2.2.</strong>  <strong>MISTY1</strong> </p><br><p>  Los desarrolladores de Turla prefieren usar algoritmos de cifrado menos comunes o modificados en sus puertas traseras: </p><br><ul><li>  en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carbono y serpiente</a> - CAST-128 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gazer</a> - implementaci√≥n personalizada de RSA </li><li>  en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mosquito</a> - Blum Blum Shub como generador de n√∫meros aleatorios para el flujo de bytes XOR </li><li>  en rootkit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Uroburos</a> - una versi√≥n modificada de ThreeFish </li></ul><br><p>  En la puerta trasera de Outlook, implementaron MISTY1, un algoritmo de cifrado sim√©trico desarrollado por los cript√≥grafos de Mitsubishi Electric en 1995.  Tiene las siguientes propiedades: </p><br><ul><li>  es sim√©trico </li><li>  tiene una clave de 128 bits </li><li>  utiliza dos tablas precalculadas: s7 (128 bytes) y s9 (2048 bytes) </li><li>  utiliza tres funciones: FL, FO, FI <br>  o FL realiza algunas operaciones XOR entre la escritura de bytes y la clave extendida <br>  o FO realiza operaciones XOR entre el registro y la clave extendida, y tambi√©n usa FI <br>  o FI realiza una expansi√≥n no lineal utilizando s7 y s9 </li><li>  opera con bloques de 64 bits </li><li>  realiza ocho ciclos (ciclo - llamar a la funci√≥n FO) </li><li>  utiliza el cifrado Feistel </li></ul><br><img src="https://habrastorage.org/webt/jf/d4/_i/jfd4_iplej2iexnsc2pkxkeracy.png"><br><p>  <em>Figura 18. MISTY1</em> </p><br><img src="https://habrastorage.org/webt/08/qc/_h/08qc_hxb2xju1yxbfsqmizuocwy.png"><br><p>  <em>Figura 19. Ocho ciclos para el cifrado en bloque</em> </p><br><p>  Los desarrolladores de Turla modificaron ligeramente el algoritmo: </p><br><ul><li>  agreg√≥ dos operaciones XOR a la funci√≥n FI como se muestra en la figura a continuaci√≥n </li><li>  Se genera una clave de 128 bits a partir de dos claves codificadas de 1024 bits m√°s un vector de inicializaci√≥n de 2048 bits </li><li>  cambiaron las tablas s7 y s9.  Esto interrumpe el funcionamiento de todas las herramientas que reconocen algoritmos criptogr√°ficos basados ‚Äã‚Äãen valores de tabla s.  Tanto las tablas S modificadas como las originales contienen los mismos valores, simplemente se barajan </li></ul><br><img src="https://habrastorage.org/webt/74/ge/qg/74geqg_tqugk_mgizdhn07hrcp0.png"><br><p>  <em>Figura 20. Comparaci√≥n de funciones FI (original a la izquierda, desarrollo de Turla a la derecha)</em> </p><br><h4 id="233-funkcii">  2.3.3.  Las funciones </h4><br><p>  La puerta trasera tiene muchas funciones, desde exfiltrar archivos hasta ejecutar comandos.  La descripci√≥n de varias funciones se encuentra en la tabla a continuaci√≥n. </p><br><img src="https://habrastorage.org/webt/zk/ij/od/zkijodwltfd9en0cxuya189_758.png"><br><p><br>  Para la funci√≥n 0x29, los desarrolladores de Turla copiaron el c√≥digo del proyecto Empire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PSInject</a> .  Esto le permite ejecutar c√≥digo de PowerShell en un archivo ejecutable especial llamado PowerShell Runner sin llamar a <code>powershell.exe</code> .  La principal ventaja es que el malware a√∫n puede ejecutar comandos de PowerShell incluso si el archivo <code>powershell.exe</code> est√° bloqueado en una computadora comprometida. </p><br><p>  Despu√©s de analizar la puerta trasera, pudimos crear un documento PDF que puede ser interpretado con √©xito por un programa malicioso.  La siguiente figura muestra la ejecuci√≥n de MessageBox y el lanzamiento de la calculadora ( <code>calc.exe</code> ) despu√©s de que Outlook haya recibido un correo electr√≥nico con este PDF.  Esto demuestra que la puerta trasera, probablemente destinada a recibir comandos en archivos adjuntos PDF, es funcional y puede ser controlada por cualquiera que comprenda este formato personalizado. </p><br><img src="https://habrastorage.org/webt/-t/xc/lr/-txclr3f050ahxdxykqgnimnr5g.png"><br><p>  <em>Figura 21. Ejecuci√≥n de los comandos especificados en el documento PDF</em> </p><br><h3 id="24-dopolnitelnye-funkcii">  2.4.  Funciones adicionales </h3><br><p>  Adem√°s de las capacidades de puerta trasera implementadas como un complemento para el cliente de correo electr√≥nico, el malware tiene otras funciones. </p><br><h4 id="241-virtualnaya-faylovaya-sistema">  2.4.1  Sistema de archivos virtual </h4><br><p>  El programa malicioso no utiliza ning√∫n archivo de configuraci√≥n, pero admite un peque√±o sistema de archivos virtual en la <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> registro de Windows <code>HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\</code> .  Otras puertas traseras de Turla, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gazer</a> , tambi√©n almacenan el sistema de archivos virtual en el registro de Windows.  Pudimos determinar algunos valores de registro, como se muestra en la siguiente tabla. </p><br><img src="https://habrastorage.org/webt/gi/g-/wt/gig-wt39jwfeznw0kpe7qjzvhpm.png"><br><h4 id="242-zhurnaly">  2.4.2  Revistas </h4><br><p>  Como se mencion√≥ anteriormente, el programa guarda un diario, que se env√≠a regularmente al operador por correo electr√≥nico en un documento PDF creado especialmente.  Se almacena en <code>%appdata%/Microsoft/Windows/scawrdot.db</code> y se cifra con una clave XOR de 512 bytes codificada.  El archivo de registro se borra despu√©s de cada exfiltraci√≥n a los operadores.  Por lo tanto, durante el examen forense ser√≠a imposible ver todas las acciones pasadas de la puerta trasera, solo la √∫ltima. </p><br><p>  Los registros son bastante informativos, permiten a los operadores de Turla rastrear acciones de puerta trasera.  La siguiente figura muestra un ejemplo de un registro descifrado. </p><br><img src="https://habrastorage.org/webt/yo/q_/z6/yoq_z6lfqy5b3ozw3f4lh6reqr4.png"><br><p>  <em>Figura 22. Archivo de registro descifrado</em> </p><br><h2 id="3-vyvody">  3. Conclusiones </h2><br><p>  El informe mostr√≥ que los desarrolladores de Turla tienen suficientes ideas cuando desarrollan puertas traseras.  Hasta donde sabemos, Turla es el √∫nico grupo de ciberespionaje que actualmente utiliza una puerta trasera que se gestiona completamente por correo electr√≥nico, o m√°s bien, archivos adjuntos en PDF. </p><br><p>  La puerta trasera de Turla no es la primera en utilizar el buz√≥n real de la v√≠ctima para recibir comandos y extraer datos.  Sin embargo, esta es la primera puerta trasera que se aprende utilizando la API est√°ndar (MAPI) para interactuar con Microsoft Outlook.  Esta es una mejora significativa en comparaci√≥n con la versi√≥n anterior que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudiamos</a> , que utilizaba Outlook Express.  Por el contrario, la nueva puerta trasera de Turla funciona incluso con las √∫ltimas versiones de Outlook. </p><br><p>   ,  ,     ,         ,  Turla   .      ,   Uroburos,      . </p><br><p>   ,         Turla,  ,    .     ,  ,     .  ,      -   ,        . </p><br><p>    ,     PDF-,     Turla,      ,     . </p><br><p>  ESET     Turla,        . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p><br><h2 id="4-indikatory-komprometacii"> 4.   </h2><br><h3 id="41-heshi">  4.1.  Hashes </h3><br><p> 8A7E2399A61EC025C15D06ECDD9B7B37D6245EC2 ‚Äî  Win32/Turla.N;   (GMT) 2013-06-28 14:15:54 <br> F992ABE8A67120667A01B88CD5BF11CA39D491A0 ‚Äî  Win32/Turla.AW; GMT 2014-12-03 20:50:08 <br> CF943895684C6FF8D1E922A76B71A188CFB371D7 ‚Äî  Win32/Turla.R; GMT 2014-12-03 20:44:27 <br> 851DFFA6CD611DC70C9A0D5B487FF00BC3853F30 ‚Äî  Win32/Turla.DA; GMT 2016-09-15 08:14:47 </p><br><h3 id="42-imena-faylov">  4.2.   </h3><br><p> %appdata%/Microsoft/Windows/scawrdot.db <br> %appdata%/Microsoft/Windows/flobcsnd.dat <br> mapid.tlb </p><br><h3 id="43-klyuchi-reestra"> 4.3.   </h3><br><p> HKCU\Software\Microsoft\Windows\CurrentVersion\Settings\ZonePolicy\ <br> HKCU\Software\Classes\CLSID{49CBB1C7-97D1-485A-9EC1-A26065633066} <br> HKCU\Software\Classes\CLSID{84DA0A92-25E0-11D3-B9F7-00C04F4C8F5D} </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421399/">https://habr.com/ru/post/es421399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421389/index.html">Separaci√≥n de poderes administrativos en Zimbra</a></li>
<li><a href="../es421391/index.html">HackThings: un gran hackathon en Internet de las cosas del 7 al 9 de septiembre en Skoltech</a></li>
<li><a href="../es421393/index.html">Abandoned Mailchimp Basket: A Guide for the Lazy</a></li>
<li><a href="../es421395/index.html">Informe del Club de Roma 2018, Cap√≠tulo 3.7: "Clima: buenas noticias, pero grandes problemas"</a></li>
<li><a href="../es421397/index.html">Lanza la Mini AI Cup # 3. Batalla de m√°quinas en espacios reducidos</a></li>
<li><a href="../es421401/index.html">Anatom√≠a de los sistemas de recomendaci√≥n. Parte dos</a></li>
<li><a href="../es421403/index.html">Semana de la seguridad 32: drama de Fortnite-Android</a></li>
<li><a href="../es421407/index.html">Reuni√≥n t√©cnica en San Petersburgo el 13 de septiembre: c√≥mo hacer grandes cambios en el backend</a></li>
<li><a href="../es421409/index.html">Espiar cosas: guardar un secreto</a></li>
<li><a href="../es421411/index.html">Introducci√≥n a los m√≥dulos Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>