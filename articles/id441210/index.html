<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ»â€ğŸ³ ğŸ“† ğŸ˜© Penyimpanan kluster Alat pacu jantung + DRBD (Dual primer) + samba ğŸ‘¦ğŸ¿ ğŸ‘¨ğŸ½â€ğŸ¤ ğŸ‘ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sebagai kelanjutan dari artikel â€œPacemaker Cluster Storage + DRBD (Dual primary) + ctdbâ€, saya menyajikan versi yang lengkap dan berfungsi dari bola f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Penyimpanan kluster Alat pacu jantung + DRBD (Dual primer) + samba</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441210/">  Sebagai kelanjutan dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel â€œPacemaker Cluster Storage + DRBD (Dual primary) + ctdbâ€, saya</a> menyajikan versi yang lengkap dan berfungsi dari bola file cluster HA untuk 2-4 node untuk centos 6 dan centos 7. Jika Anda ingin menerapkan ini, Anda bisa menjadi cabul atau Anda Mereka tidak memberikan pilihan, dan perlu untuk mengimplementasikannya entah bagaimana. <br><br>  Saya hanya akan menjelaskan kue puff yang akan kami kumpulkan: <br><br>  Pada perangkat blok, buat tabel gpt =&gt; satu partisi untuk seluruh ruang di bawah lvm =&gt; grup volume lvm untuk seluruh ruang yang tersedia =&gt; volume lvm untuk seluruh ruang yang tersedia =&gt; perangkat drbd =&gt; dlm =&gt; tandai sebagai volume fisik dari lvm untuk seluruh ruang yang tersedia =&gt; di atasnya sekelompok cluster volume lvm =&gt; volume lvm pada semua ruang yang tersedia =&gt; mark up fs gfs2 =&gt; terhubung ke titik pemasangan. <br>  Dan semua ini akan digerakkan oleh alat pacu jantung dengan alamat ip virtual. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ym/t7/zf/ymt7zf8sbzor8sp5keqoijl93q0.jpeg"></div><br>  Jika Anda masih ingin melanjutkan, baca terus di bawah potongan. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Dari sumbernya kita membutuhkan yang berikut ini:</b> <div class="spoiler_text">  Inti CPU 1 <br>  Minimum 1 GB memori akses acak <br>  Disk 15 GB + tempat Anda akan menyimpan data <br>  Disk dapat berupa angka apa saja, bahkan satu. <br><br>  Jika Anda memiliki satu drive, lebih baik untuk mempartisi sebagai berikut: <br>  Tabel partisi gpt =&gt; 200 MB partisi untuk efi (opsional) =&gt; 1 GB partisi untuk / boot =&gt; semua lainnya di bawah lvm. <br><br>  Pada volume lvm, Anda perlu membuat 2 grup volume.  Kelompok volume pertama di bawah OS adalah 10 GB + dua kali ukuran RAM, tetapi tidak lebih dari 4 GB. <br><br>  Siapa pun yang mengatakan itu, tetapi bertukar kadang-kadang banyak membantu, jadi pada grup lvm kita membuat partisi lvm untuk bertukar sama dengan dua kali ukuran RAM, tetapi tidak lebih dari 4 GB dan sisa ruang dialokasikan untuk root OS. <br><br>  Kelompok kedua lvm untuk penyimpanan data.  Buat bagian lvm untuk ruang yang tersisa. <br></div></div><br>  Di bawah persyaratan kami diberi 2 mesin virtual dan itu saja.  Lebih baik untuk menempatkan Ceph untuk operasi yang benar pada 6 node, setidaknya 4, ditambah itu akan menyenangkan untuk memiliki beberapa pengalaman dengannya, jika tidak akan bekerja seperti cloudmouse.  Gluster untuk ratusan ribu file kecil tidak akan berfungsi dalam kinerja, itu dilemahkan dalam luasnya HabrÃ© berkali-kali.  ipfs, luster dan sejenisnya memiliki persyaratan yang sama seperti ceph atau bahkan lebih. <br><br><h4>  Ayo mulai pertempuran!  Saya punya dua mesin virtual pada CentOS 7 dengan 2 disk. </h4><br>  1) Alat pacu jantung versi 1.1 tidak bekerja dengan ip dengan benar, jadi untuk keandalan kami menambahkan entri ke / etc / hosts: <br><br><pre><code class="bash hljs">192.168.0.1 node1 192.168.0.2 node2</code> </pre> <br>  2) Tidak ada DRBD dalam repositori standar, jadi Anda perlu menghubungkan yang pihak ketiga. <br><br><pre> <code class="bash hljs">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org yum localinstall -y http://ftp.nluug.nl/os/Linux/distr/elrepo/elrepo/el7/x86_64/RPMS/$(curl -s http://ftp.nluug.nl/os/Linux/distr/elrepo/elrepo/el7/x86_64/RPMS/ | grep -oP <span class="hljs-string"><span class="hljs-string">"&gt;elrepo-release.*rpm"</span></span> | cut -c 2-)</code> </pre> <br>  3) Instal drbd versi 8.4 <br><br><pre> <code class="bash hljs">yum install -y kmod-drbd84 drbd84-utils</code> </pre> <br>  4) Aktifkan dan aktifkan modul drbd kernel di startup <br><br><pre> <code class="bash hljs">modprobe drbd <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> drbd &gt; /etc/modules-load.d/drbd.conf</code> </pre><br>  5) Buat partisi disk dan konfigurasikan lvm <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"g\nn\n\n\n\nt\n8e\nw\n"</span></span> | fdisk /dev/sdb vgcreate drbd_vg /dev/sdb1 lvcreate -l +100%FREE --name r0 drbd_vg</code> </pre><br>  6) Buat file konfigurasi untuk resource drbd /etc/drbd.d/r0.res <br><br><pre> <code class="bash hljs">resource r0 { protocol C; device /dev/drbd1; meta-disk internal; disk /dev/mapper/drbd_vg-r0; net { allow-two-primaries; } disk { fencing resource-and-stonith; } handlers { fence-peer <span class="hljs-string"><span class="hljs-string">"/usr/lib/drbd/crm-fence-peer.sh"</span></span>; after-resync-target <span class="hljs-string"><span class="hljs-string">"/usr/lib/drbd/crm-unfence-peer.sh"</span></span>; } startup { become-primary-on both; } on node1 { address 192.168.0.1:7788; } on node2 { address 192.168.0.2:7788; }</code> </pre><br>  7) Kami menghapus layanan drbd dari autoload (alat pacu jantung nantinya akan bertanggung jawab untuk itu), membuat metadata untuk disk drbd, meningkatkan sumber daya <br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> drbd drbdadm create-md r0 drbdadm up r0</code> </pre><br>  8) Pada simpul pertama, buat sumber daya utama <br><br><pre> <code class="bash hljs">drbdadm primary --force r0</code> </pre> <br>  9) Pasang alat pacu jantung <br><br><pre> <code class="bash hljs">yum install -y pacemaker corosync pcs resource-agents fence-agents-all</code> </pre> <br>  10) Tetapkan kata sandi untuk hacluster pengguna untuk otorisasi pada node <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> CHANGEME | passwd --stdin hacluster</code> </pre> <br>  11) Jalankan pcsd di kedua node <br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> pcsd systemctl start pcsd</code> </pre><br>  12) Masuk ke cluster.  Dari tahap ini kami melakukan segalanya pada satu node <br><br><pre> <code class="bash hljs">pcs cluster auth node1 node2 -u hacluster -p CHANGEME --force</code> </pre> <br>  13) Buat sebuah cluster bernama samba_cluster <br><br><pre> <code class="bash hljs">pcs cluster setup --force --name samba_cluster node1 node2</code> </pre> <br>  14) mengaktifkan node dan menambahkan layanan ke startup dan memulainya <br><br><pre> <code class="bash hljs">pcs cluster <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> --all pcs cluster start --all systemctl start corosync pcsd pacemaker systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> corosync pcsd pacemaker</code> </pre><br>  15) Karena kami memiliki mesin virtual sebagai server, kami mematikan mekanisme STONITH, karena kami tidak memiliki mekanisme untuk mengelola mereka.  Kami juga hanya memiliki 2 mobil, jadi kami juga menonaktifkan kuorum, hanya bekerja dengan 3 mesin atau lebih. <br><br><pre> <code class="bash hljs">pcs property <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> stonith-enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> pcs property <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> no-quorum-policy=ignore</code> </pre><br>  16) Buat VIP <br><br><pre> <code class="bash hljs">pcs resource create virtual_ip ocf:heartbeat:IPaddr2 ip=192.168.0.10 cidr_netmask=32 nic=eth0 clusterip_hash=sourceip-sourceport op monitor interval=1s</code> </pre><br>  17) Buat sumber daya drbd <br><br><pre> <code class="bash hljs">pcs resource create DRBD1 ocf:linbit:drbd drbd_resource=r0 op monitor interval=60s master master-max=2 master-node-max=1 <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>-node-max=1 <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>-max=2 notify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> op start interval=0s timeout=240 promote interval=0s timeout=130 monitor interval=150s role=Master monitor interval=155s role=Slave</code> </pre><br>  18) Instal paket yang diperlukan untuk clvm dan siapkan clvm <br><br><pre> <code class="bash hljs">yum install -y lvm2-cluster gfs2-utils /sbin/lvmconf --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-cluster</code> </pre><br>  19) Tambahkan sumber dlm dan clvd ke alat pacu jantung <br><br><pre> <code class="bash hljs">pcs resource create dlm ocf:pacemaker:controld allow_stonith_disabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> meta interleave=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pcs resource create clvmd ocf:heartbeat:clvm <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> meta interleave=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br>  20) Kami melarang LVM dari menulis cache dan menghapusnya.  Di kedua node <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/write_cache_state = 1/write_cache_state = 0/'</span></span> /etc/lvm/lvm.conf rm /etc/lvm/cache/*</code> </pre><br><br>  21) Buat partisi CLVM.  Kami hanya membuat satu not <br><pre> <code class="bash hljs">vgcreate -A y -cy cl_vg /dev/drbd1 lvcreate -l 100%FREE -n r0 cl_vg</code> </pre><br>  22) Kami menandai bagian dalam gfs2, di sini penting bahwa tabel kunci memiliki nama yang sama dengan cluster kami di pembawa damai.  Kami hanya membuat satu not <br><br><pre> <code class="bash hljs">mkfs.gfs2 -j 2 -p lock_dlm -t samba_cluster:r0 /dev/cl_vg/r0</code> </pre> <br>  23) Selanjutnya, tambahkan mount bagian ini di alat pacu jantung dan katakan untuk boot setelah clvmd <br><br><pre> <code class="bash hljs">pcs resource create fs ocf:heartbeat:Filesystem device=<span class="hljs-string"><span class="hljs-string">"/dev/cl_vg/r0"</span></span> directory=<span class="hljs-string"><span class="hljs-string">"/mnt"</span></span> fstype=<span class="hljs-string"><span class="hljs-string">"gfs2"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> interleave=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br>  24) Sekarang giliran ctdb yang akan menjalankan samba <br><br><pre> <code class="bash hljs">yum install -y samba ctdb cifs-utils</code> </pre> <br>  25) Edit config /etc/ctdb/ctdbd.conf <br><br><pre> <code class="bash hljs">CTDB_RECOVERY_LOCK=<span class="hljs-string"><span class="hljs-string">"/mnt/ctdb/.ctdb.lock"</span></span> CTDB_NODES=/etc/ctdb/nodes CTDB_MANAGES_SAMBA=yes CTDB_LOGGING=file:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ctdb.log CTDB_DEBUGLEVEL=NOTICE</code> </pre><br>  26) Buat file dengan daftar node / etc / ctdb / nodes <br>  PERHATIAN!  Setelah setiap alamat dalam daftar harus ada umpan baris.  Jika tidak, simpul tidak akan hidup selama inisialisasi. <br><br><pre> <code class="bash hljs">192.168.0.1 192.168.0.2</code> </pre><br>  27) Akhirnya, buat sumber daya ctdb <br><br><pre> <code class="bash hljs">pcs resource create samba systemd:ctdb <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> meta interleave=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br>  28) Kami mengatur antrean beban dan dependensi sumber daya untuk dijalankan <br><br><pre> <code class="bash hljs">pcs constraint colocation add dlm-clone with DRBD1-master pcs constraint colocation add clvmd-clone with dlm-clone pcs constraint colocation add fs-clone with clvmd-clone pcs constraint colocation add samba-clone with fs-clone pcs constraint colocation add virtual_ip with samba-clone pcs constraint order promote DRBD1-master <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> dlm-clone pcs constraint order start dlm-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> clvmd-clone pcs constraint order start clvmd-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> fs-clone pcs constraint order start fs-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> samba-clone</code> </pre><br>  29) Kami mengatur antrian untuk menghentikan sumber daya, tanpa ini, mesin Anda dapat membeku pada saat shutdown <br><br><pre> <code class="bash hljs">pcs constraint order stop fs-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> stop clvmd-clone pcs constraint order stop clvmd-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> stop dlm-clone pcs constraint order stop dlm-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> stop DRBD1-master pcs constraint order stop samba-clone <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> stop fs-clone</code> </pre><br><h3>  PS </h3><br>  Bola itu sendiri bisa di nfs, dan di samba, tetapi menghubungkan ke mereka gagal-oleh IP, meskipun penyimpanan HA itu sendiri.  Jika Anda ingin HA penuh, maka alih-alih samba dan nfs Anda perlu menginstal iSCSI dan terhubung melalui multipath.  Selain itu, Anda bisa mendapatkan otak ganda jika salah satu node mati, dan ketika master naik, itu tidak akan terjadi.  Saya memeriksa bahwa jika OS dimatikan dengan benar, maka setelah menaikkan node ketika tidak ada master, ia masuk ke mode out-of-date dan tidak menjadi master untuk menghindari split brain.  Varian kuorum (DRBD dan / atau alat pacu jantung) dan setiap distorsi dari cascading konstruksi DRBD setelah konfigurasi Anda tidak dapat dipertahankan karena kompleksitasnya yang tinggi, admin lain akan membutuhkan waktu lama untuk mencari tahu.  Meskipun dengan apa yang saya tulis tidak lebih baik, jangan lakukan itu. <br><br>  Referensi: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ada instruksi serupa dengan sintaks untuk alat pacu jantung 1.0.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id441210/">https://habr.com/ru/post/id441210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id441198/index.html">Dinamika spiral Scrum dan Graves: bagaimana tidak lari ke terumbu</a></li>
<li><a href="../id441202/index.html">Apakah perusahaan jasa memimpikan produk mereka? Percakapan dengan Maxilect</a></li>
<li><a href="../id441204/index.html">Pendekatan canggih untuk mendeteksi batas menggunakan dinding kapal sebagai contoh</a></li>
<li><a href="../id441206/index.html">Wolfensteiny 3D - rekayasa balik 251 byte JavaScript</a></li>
<li><a href="../id441208/index.html">Bagaimana kami mengurangi penerbitan pinjaman menjadi 2 klik</a></li>
<li><a href="../id441212/index.html">Bekerja dengan perlindungan informasi kriptografis dan operator kunci perangkat keras di Linux</a></li>
<li><a href="../id441214/index.html">Panduan Pengguna Kibana. Visualisasi. Bagian 1</a></li>
<li><a href="../id441216/index.html">Cermin hitam atau iklan Picooc?</a></li>
<li><a href="../id441218/index.html">OpenAI Gym + ROS + Gazebo: melatih robot mandiri di rumah. Bagian 1</a></li>
<li><a href="../id441220/index.html">Analisis serangan massal terbaru dengan penangkapan DNS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>