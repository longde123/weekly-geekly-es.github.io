<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👏🏽 🛌🏾 🧒🏾 Cara mengetik memeriksa 4 juta baris kode Python. Bagian 2 👈🏼 🤘🏻 💎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari ini kami menerbitkan bagian kedua dari terjemahan materi tentang bagaimana Dropbox mengatur kontrol jenis beberapa juta baris kode Python. 

  

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara mengetik memeriksa 4 juta baris kode Python. Bagian 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/468235/">  Hari ini kami menerbitkan bagian kedua dari terjemahan materi tentang bagaimana Dropbox mengatur kontrol jenis beberapa juta baris kode Python. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/mr/qs/ta/mrqstagugecqucre5tni6rbec0e.jpeg"></a> <br><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Baca bagian pertama</a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Dukungan Tipe Formal (PEP 484)</font> </h2><br>  Kami melakukan percobaan serius pertama dengan mypy di Dropbox selama Hack Week 2014. Hack Week adalah acara yang diadakan oleh Dropbox selama satu minggu.  Saat ini, karyawan dapat mengerjakan apa saja!  Beberapa proyek teknologi paling terkenal Dropbox dimulai pada acara serupa.  Sebagai hasil dari percobaan ini, kami sampai pada kesimpulan bahwa mypy terlihat menjanjikan, meskipun proyek ini belum siap untuk digunakan secara luas. <br><br>  Pada saat itu, gagasan standardisasi sistem isyarat untuk tipe Python sedang mengemuka.  Seperti yang saya katakan, dimulai dengan Python 3.0, Anda bisa menggunakan anotasi jenis untuk fungsi, tetapi ini hanya ekspresi sewenang-wenang, tanpa sintaks dan semantik tertentu.  Selama pelaksanaan program, penjelasan ini, sebagian besar, hanya diabaikan.  Setelah Hack Week, kami mulai mengerjakan standardisasi semantik.  Pekerjaan ini menyebabkan munculnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PEP 484</a> (Guido van Rossum, Lukas Langa dan saya berkolaborasi dalam dokumen ini). <br><br>  Motif kami bisa dilihat dari dua sisi.  Pertama, kami berharap bahwa seluruh ekosistem Python dapat mengambil pendekatan umum untuk menggunakan petunjuk jenis (tip petunjuk adalah istilah yang digunakan dalam Python sebagai analog dari "anotasi tipe").  Ini, mengingat kemungkinan risikonya, akan lebih baik daripada menggunakan banyak pendekatan yang tidak kompatibel satu sama lain.  Kedua, kami ingin secara terbuka membahas mekanisme anotasi jenis dengan banyak anggota komunitas Python.  Sebagian, keinginan ini didikte oleh fakta bahwa kita tidak ingin terlihat seperti "murtad" dari ide-ide dasar bahasa di mata massa luas programmer Python.  Ini adalah bahasa yang diketik secara dinamis yang dikenal sebagai "mengetik bebek."  Di komunitas, pada awalnya, sikap yang agak mencurigakan terhadap gagasan mengetik statis tidak bisa tidak muncul.  Tapi sikap ini akhirnya melemah - setelah menjadi jelas bahwa pengetikan statis tidak direncanakan wajib (dan setelah orang menyadari bahwa itu benar-benar berguna). <br><br>  Sintaks yang dihasilkan untuk petunjuk jenis sangat mirip dengan yang mypy didukung pada waktu itu.  PEP 484 keluar dengan Python 3.5 pada 2015.  Python bukan lagi bahasa yang hanya mendukung pengetikan dinamis.  Saya suka menganggap acara ini sebagai tonggak penting dalam sejarah Python. <br><br><h2>  <font color="#3AC1EF">Mulai migrasi</font> </h2><br>  Pada akhir 2015, tim yang terdiri dari tiga orang dibuat di Dropbox untuk mengerjakan mypy.  Itu termasuk Guido van Rossum, Greg Price dan David Fisher.  Sejak saat itu situasinya mulai berkembang dengan sangat cepat.  Hambatan pertama untuk pertumbuhan mypy adalah kinerja.  Seperti yang sudah saya sebutkan di atas, pada periode awal pengembangan proyek, saya berpikir untuk menerjemahkan implementasi mypy ke dalam C, tetapi ide ini telah dihapus dari daftar sejauh ini.  Kami terjebak dengan fakta bahwa kami menggunakan juru bahasa CPython untuk memulai sistem, yang tidak cukup cepat untuk alat-alat seperti mypy.  (Proyek PyPy, implementasi alternatif Python dengan kompiler JIT, juga tidak membantu kami.) <br><br>  Untungnya, di sini beberapa perbaikan algoritmik membantu kami.  "Akselerator" kuat pertama adalah penerapan verifikasi tambahan.  Gagasan peningkatan ini sederhana: jika semua dependensi modul tidak berubah sejak peluncuran mypy sebelumnya, maka kita dapat menggunakan data yang di-cache selama sesi sebelumnya saat bekerja dengan dependensi.  Yang harus kami lakukan adalah mengetikkan centang pada file yang dimodifikasi dan pada file-file yang bergantung padanya.  Mypy bahkan melangkah lebih jauh: jika antarmuka eksternal modul tidak berubah - mypy berpikir bahwa modul lain yang mengimpor modul ini tidak boleh diperiksa lagi. <br><br>  Validasi tambahan telah sangat membantu kami dalam memberikan anotasi dalam volume besar kode yang ada.  Faktanya adalah bahwa proses ini biasanya melibatkan banyak iterasi berjalan mypy, karena penjelasan secara bertahap ditambahkan ke kode dan secara bertahap ditingkatkan.  Peluncuran pertama mypy masih sangat lambat, karena ketika Anda menjalankannya, Anda harus memeriksa banyak dependensi.  Kemudian, demi memperbaiki situasi, kami menerapkan mekanisme caching jarak jauh.  Jika mypy mendeteksi bahwa cache lokal mungkin kedaluwarsa, ia mengunduh snapshot cache saat ini untuk seluruh basis kode dari repositori terpusat.  Dia kemudian melakukan pemeriksaan tambahan menggunakan snapshot ini.  Ini adalah langkah besar lain yang telah menggerakkan kami menuju peningkatan produktivitas mypy. <br><br>  Ini adalah periode pengenalan sistem pemeriksaan jenis Dropbox yang cepat dan alami.  Pada akhir 2016, kami sudah memiliki sekitar 420.000 baris kode Python dengan anotasi jenis.  Banyak pengguna yang antusias memeriksa jenis.  Dropbox mypy telah digunakan oleh semakin banyak tim pengembangan. <br><br>  Segalanya tampak bagus saat itu, tetapi kami masih harus melakukan banyak hal.  Kami mulai melakukan survei pengguna internal berkala untuk mengidentifikasi area masalah proyek dan memahami masalah apa yang perlu diatasi terlebih dahulu (praktik ini digunakan di perusahaan saat ini).  Yang paling penting, seperti yang sudah jelas, adalah dua tugas.  Yang pertama - Anda membutuhkan lebih banyak cakupan kode dengan tipe, yang kedua - perlu bagi mypy untuk bekerja lebih cepat.  Sangat jelas bahwa pekerjaan kami dalam mempercepat mypy dan implementasinya dalam proyek-proyek perusahaan masih jauh dari selesai.  Kami, menyadari sepenuhnya pentingnya kedua tugas ini, mengambil solusi mereka. <br><br><h2>  <font color="#3AC1EF">Lebih banyak kinerja!</font> </h2><br>  Pemeriksaan tambahan mempercepat mypy, tetapi alat ini masih belum cukup cepat.  Banyak pemeriksaan tambahan berlangsung sekitar satu menit.  Alasan untuk ini adalah impor siklus.  Ini mungkin tidak akan mengejutkan siapa pun yang telah bekerja dengan basis kode besar yang ditulis dengan Python.  Kami memiliki ratusan set modul, yang masing-masing secara tidak langsung mengimpor semua modul lainnya.  Jika ada file dalam siklus impor yang diubah, mypy harus memproses semua file yang termasuk dalam siklus ini, dan seringkali juga setiap modul yang mengimpor modul dari siklus ini.  Salah satu siklus seperti itu adalah "kusut ketergantungan," yang menyebabkan banyak masalah di Dropbox.  Setelah struktur ini berisi beberapa ratus modul, sementara itu diimpor, secara langsung atau tidak langsung, banyak tes, itu juga digunakan dalam kode produksi. <br><br>  Kami mempertimbangkan kemungkinan dependensi siklik yang "terurai", tetapi kami tidak memiliki sumber daya untuk melakukan ini.  Terlalu banyak kode yang tidak kami kenal.  Sebagai hasilnya, kami mengambil pendekatan alternatif.  Kami memutuskan untuk membuat mypy bekerja cepat bahkan jika ada "bola ketergantungan".  Kami menyelesaikan ini dengan daemon mypy.  Daemon adalah proses server yang mengimplementasikan dua fitur menarik.  Pertama, ia menyimpan informasi memori tentang seluruh basis kode.  Ini berarti bahwa setiap kali Anda menjalankan mypy, Anda tidak perlu mengunduh data cache yang terkait dengan ribuan dependensi yang diimpor.  Kedua, ia dengan hati-hati, pada tingkat unit struktural kecil, menganalisis hubungan antara fungsi dan entitas lainnya.  Misalnya, jika fungsi <code>foo</code> memanggil <code>bar</code> fungsi, maka ada ketergantungan <code>foo</code> pada <code>bar</code> .  Ketika file diubah, daemon pertama, secara terpisah, hanya memproses file yang diubah.  Kemudian dia melihat perubahan pada file ini yang terlihat dari luar, seperti tanda tangan fungsi yang diubah.  Daemon menggunakan informasi impor terperinci hanya untuk memeriksa ulang fungsi-fungsi yang benar-benar menggunakan fungsi yang diubah.  Biasanya, dengan pendekatan ini, sangat sedikit fungsi yang harus diperiksa. <br><br>  Menerapkan semua ini tidaklah mudah, karena implementasi asli mypy sangat terfokus pada pemrosesan satu file pada satu waktu.  Kami harus berurusan dengan banyak situasi perbatasan, kejadian yang memerlukan pemeriksaan ulang dalam kasus-kasus ketika sesuatu berubah dalam kode.  Sebagai contoh, ini terjadi ketika kelas dasar baru ditugaskan ke kelas.  Setelah kami melakukan apa yang kami inginkan, kami dapat mengurangi waktu pelaksanaan sebagian besar pemeriksaan tambahan menjadi beberapa detik.  Bagi kami, itu merupakan kemenangan besar. <br><br><h2>  <font color="#3AC1EF">Lebih banyak kinerja!</font> </h2><br>  Bersama dengan caching jarak jauh, yang saya jelaskan di atas, daemon mypy hampir sepenuhnya menyelesaikan masalah yang muncul ketika programmer sering menjalankan pengecekan tipe, membuat perubahan pada sejumlah kecil file.  Namun, kinerja sistem dalam varian yang paling tidak menguntungkan penggunaannya masih jauh dari optimal.  Awal mypy yang bersih bisa memakan waktu lebih dari 15 menit.  Dan itu jauh lebih dari yang kita inginkan.  Setiap minggu, situasinya memburuk, karena programmer terus menulis kode baru dan menambahkan anotasi ke kode yang ada.  Pengguna kami masih merindukan kinerja yang lebih tinggi, tetapi kami senang siap untuk bertemu dengan mereka. <br><br>  Kami memutuskan untuk kembali ke salah satu ide awal saya tentang mypy.  Yakni, konversi kode Python ke kode C.  Percobaan dengan Cython (ini adalah sistem yang memungkinkan Anda untuk menerjemahkan kode Python ke dalam kode C) tidak memberi kami akselerasi yang terlihat, jadi kami memutuskan untuk menghidupkan kembali ide untuk menulis kompiler kami sendiri.  Karena basis kode mypy (ditulis dengan Python) sudah berisi semua jenis anotasi yang diperlukan, upaya untuk menggunakan anotasi ini untuk mempercepat sistem tampaknya bermanfaat.  Saya segera membuat prototipe untuk menguji ide ini.  Dia menunjukkan pada berbagai tolok ukur mikro peningkatan produktivitas lebih dari 10 kali lipat.  Gagasan kami adalah mengkompilasi modul Python menjadi modul-C menggunakan Cython, dan untuk mengubah anotasi tipe menjadi pemeriksaan tipe yang dilakukan pada saat run time (biasanya anotasi tipe diabaikan pada saat run time dan hanya digunakan oleh sistem pengecekan tipe )  Kami sebenarnya berencana untuk menerjemahkan implementasi mypy dari Python ke bahasa yang dibuat secara statis, yang akan terlihat (dan, sebagian besar, berfungsi) persis seperti Python.  (Migrasi lintas-bahasa semacam ini telah menjadi semacam tradisi proyek mypy. Implementasi awal mypy ditulis dalam bahasa Alore, kemudian ada hibrida sintaksis antara Jawa dan Python). <br><br>  Berfokus pada API ekstensi CPython adalah kunci untuk tidak kehilangan kemampuan manajemen proyek.  Kami tidak perlu menerapkan mesin virtual atau pustaka yang diperlukan mypy.  Selain itu, seluruh ekosistem Python masih akan tersedia untuk kita, semua alat (seperti pytest) akan tersedia.  Ini berarti bahwa kami dapat terus menggunakan kode Python yang ditafsirkan selama pengembangan, yang akan memungkinkan kami untuk terus bekerja menggunakan skema yang sangat cepat untuk membuat perubahan pada kode dan mengujinya, daripada menunggu kode dikompilasi.  Sepertinya kami sangat mampu, jadi untuk berbicara, duduk di dua kursi, dan kami menyukainya. <br><br>  Compiler, yang kami beri nama mypyc (karena menggunakan mypy sebagai frontend untuk analisis tipe), ternyata merupakan proyek yang sangat sukses.  Semua dalam semua, kami mencapai sekitar 4x percepatan lebih cepat dari sering berjalan mypy tanpa caching.  Pengembangan inti dari proyek mypyc memakan waktu sekitar 4 bulan kalender dari sebuah tim kecil yang mencakup Michael Sullivan, Ivan Levkivsky, Hugh Han dan saya.  Jumlah pekerjaan ini jauh lebih tidak ambisius daripada apa yang diperlukan untuk menulis ulang mypy, misalnya, dalam C ++ atau Go.  Dan kami harus membuat lebih sedikit perubahan pada proyek daripada yang harus kami lakukan ketika menulis ulang dalam bahasa lain.  Kami juga berharap bahwa kami dapat membawa mypyc ke tingkat yang dapat digunakan oleh programmer Dropbox lainnya untuk mengkompilasi dan mempercepat kode mereka. <br><br>  Untuk mencapai tingkat kinerja ini, kami harus menerapkan beberapa solusi rekayasa yang menarik.  Jadi, kompiler dapat mempercepat banyak operasi dengan menggunakan konstruksi tingkat rendah cepat C. Misalnya, panggilan ke fungsi yang dikompilasi diterjemahkan menjadi panggilan ke fungsi C.  Dan panggilan semacam itu dibuat jauh lebih cepat daripada memanggil fungsi yang ditafsirkan.  Beberapa operasi, seperti pencarian kamus, masih dirubah untuk menggunakan panggilan C-API biasa dari CPython, yang setelah kompilasi ternyata hanya sedikit lebih cepat.  Kami dapat menyingkirkan beban tambahan pada sistem yang dibuat oleh interpretasi, tetapi dalam hal ini hanya memberikan sedikit keuntungan dalam hal kinerja. <br><br>  Untuk mengidentifikasi operasi "lambat" yang paling umum, kami melakukan profiling kode.  Berbekal data, kami mencoba untuk men-tweak mypyc sehingga akan menghasilkan kode C lebih cepat untuk operasi seperti itu, atau menulis ulang kode Python yang sesuai menggunakan operasi yang lebih cepat (dan kadang-kadang kami tidak punya solusi yang cukup sederhana untuk itu atau masalah lain).  Menulis ulang kode Python sering terbukti menjadi solusi yang lebih mudah untuk masalah daripada mengimplementasikan transformasi yang sama secara otomatis di kompiler.  Dalam jangka panjang, kami ingin mengotomatiskan banyak dari transformasi ini, tetapi pada saat itu kami bertujuan untuk mempercepat mypy dengan upaya minimal.  Dan kami, bergerak menuju tujuan ini, memotong beberapa sudut. <br><br>  Dilanjutkan ... <br><br>  <b>Pembaca yang budiman!</b>  Apa kesan Anda tentang proyek mypy ketika Anda mengetahui tentang keberadaannya? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/it/t5/3p/itt53pns2iucwylb3bwn1fmmtnu.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id468235/">https://habr.com/ru/post/id468235/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id468225/index.html">Mengurangi ukuran bundel dengan Webpack Analyzer dan React Lazy / Suspense</a></li>
<li><a href="../id468227/index.html">Akselerasi instagram.com. Bagian 1</a></li>
<li><a href="../id468229/index.html">Catatan kosong pada JavaScript dan TypeScript</a></li>
<li><a href="../id468231/index.html">Apakah keamanan dalam AEM platform atau masalah implementasi?</a></li>
<li><a href="../id468233/index.html">Cara mengetik memeriksa 4 juta baris kode Python. Bagian 1</a></li>
<li><a href="../id468237/index.html">Cara mengetik memeriksa 4 juta baris kode Python. Bagian 3</a></li>
<li><a href="../id468239/index.html">Memilih struktur data yang tepat di Swift</a></li>
<li><a href="../id468245/index.html">Kami tidak perlu koreksi terjemahan: penerjemah kami lebih tahu bagaimana ini harus diterjemahkan</a></li>
<li><a href="../id468251/index.html">Tidak ada masa depan</a></li>
<li><a href="../id468253/index.html">Slider gambar sederhana dalam CSS dan Javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>