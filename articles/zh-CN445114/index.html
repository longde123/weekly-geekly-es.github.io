<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”´ â›½ï¸ ğŸ‘©ğŸ»â€ğŸ”§ æ”¹è¿›äº†groovyè„šæœ¬çš„æ²™ç®± ğŸ¤¾ğŸ¼ ğŸ™…ğŸ» ğŸŒ¨ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¯‘è€…çš„è¯ï¼šå¼€å‘CUBAå¹³å°æ—¶ï¼Œæˆ‘ä»¬åœ¨æ­¤æ¡†æ¶ä¸­å…·æœ‰æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬çš„èƒ½åŠ›ï¼Œä»¥ä¾¿æ›´çµæ´»åœ°é…ç½®åº”ç”¨ç¨‹åºä¸šåŠ¡é€»è¾‘ã€‚ è¿™ä¸ªæœºä¼šæ˜¯å¥½æ˜¯åï¼ˆæˆ‘ä»¬ä¸ä»…åœ¨è°ˆè®ºCUBAï¼‰å·²ç»äº‰è®ºäº†å¾ˆé•¿æ—¶é—´ï¼Œä½†æ˜¯å¿…é¡»æ§åˆ¶ç”¨æˆ·è„šæœ¬çš„æ‰§è¡Œè¿™ä¸€äº‹å®å¹¶æ²¡æœ‰å¼•èµ·ä»»ä½•ç–‘é—®ã€‚ CÃ©dricChampeauçš„æ­¤ç¿»è¯‘ä»‹ç»äº†Groovyç®¡ç†è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œçš„æœ‰...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æ”¹è¿›äº†groovyè„šæœ¬çš„æ²™ç®±</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/445114/"><p><img src="https://habrastorage.org/webt/l7/d9/cg/l7d9cgoh4tjgptdfr68phnooab4.jpeg"></p><br><p>  <em>è¯‘è€…çš„è¯ï¼šå¼€å‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CUBAå¹³å°æ—¶ï¼Œ</a>æˆ‘ä»¬åœ¨æ­¤æ¡†æ¶ä¸­å…·æœ‰æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬çš„èƒ½åŠ›ï¼Œä»¥ä¾¿æ›´çµæ´»åœ°é…ç½®åº”ç”¨ç¨‹åºä¸šåŠ¡é€»è¾‘ã€‚</em>  <em>è¿™ä¸ªæœºä¼šæ˜¯å¥½æ˜¯åï¼ˆæˆ‘ä»¬ä¸ä»…åœ¨è°ˆè®ºCUBAï¼‰å·²ç»äº‰è®ºäº†å¾ˆé•¿æ—¶é—´ï¼Œä½†æ˜¯å¿…é¡»æ§åˆ¶ç”¨æˆ·è„šæœ¬çš„æ‰§è¡Œè¿™ä¸€äº‹å®å¹¶æ²¡æœ‰å¼•èµ·ä»»ä½•ç–‘é—®ã€‚</em>  <em>CÃ©dricChampeauçš„æ­¤ç¿»è¯‘ä»‹ç»äº†Groovyç®¡ç†è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œçš„æœ‰ç”¨åŠŸèƒ½ä¹‹ä¸€ã€‚</em>  <em>å°½ç®¡äº‹å®ä¸Šä»–æœ€è¿‘ç¦»å¼€äº†Groovyå¼€å‘å›¢é˜Ÿï¼Œä½†ç¨‹åºå‘˜ç¤¾åŒºä¼¼ä¹åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ä¸€ç›´åœ¨åˆ©ç”¨ä»–çš„å·¥ä½œã€‚</em> </p><br><p> ä½¿ç”¨Groovyçš„æœ€å¸¸ç”¨æ–¹æ³•ä¹‹ä¸€æ˜¯é€šè¿‡è„šæœ¬ç¼–å†™ï¼Œå› ä¸ºGroovyä½¿å¾—åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ‰§è¡Œä»£ç å˜å¾—å®¹æ˜“ã€‚ å–å†³äºåº”ç”¨ç¨‹åºï¼Œè„šæœ¬å¯ä»¥ä½äºä¸åŒçš„ä½ç½®ï¼šæ–‡ä»¶ç³»ç»Ÿï¼Œæ•°æ®åº“ï¼Œè¿œç¨‹æœåŠ¡...ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œæ‰§è¡Œè„šæœ¬çš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ä¸ä¸€å®šè¦ç¼–å†™å®ƒä»¬ã€‚ æ­¤å¤–ï¼Œè„šæœ¬å¯ä»¥åœ¨æœ‰é™çš„ç¯å¢ƒï¼ˆå†…å­˜æœ‰é™ï¼Œæ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼Œè¿è¡Œæ—¶...ï¼‰ä¸­å·¥ä½œï¼Œæˆ–è€…æ‚¨å¯èƒ½å¸Œæœ›é˜»æ­¢ç”¨æˆ·ä½¿ç”¨è„šæœ¬ä¸­çš„æ‰€æœ‰è¯­è¨€åŠŸèƒ½ã€‚ </p><br><p>  <strong>è¿™ç¯‡æ–‡ç« ä¼šå‘Šè¯‰ä½ ã€‚</strong> </p><br><ul><li> ä¸ºä»€ä¹ˆgroovyé€‚åˆç¼–å†™å†…éƒ¨dsl </li><li> å°±æ‚¨çš„åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§è€Œè¨€ï¼Œå…¶åŠŸèƒ½æ˜¯ä»€ä¹ˆ </li><li> å¦‚ä½•é…ç½®ç¼–è¯‘ä»¥æ”¹å–„DSL </li><li>å…³äº<code>SecureASTCustomizer</code>çš„ä»·å€¼ </li><li> å…³äºç±»å‹æ§åˆ¶æ‰©å±• </li><li> å¦‚ä½•ä½¿ç”¨ç±»å‹æ§åˆ¶æ‰©å±•ä½¿æ²™ç›’æœ‰æ•ˆ </li></ul><a name="habracut"></a><br><p> ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹æ‚¨éœ€è¦åšä»€ä¹ˆï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥è®¡ç®—æ•°å­¦è¡¨è¾¾å¼ã€‚ ä¸€ç§å®ç°æ–¹å¼æ˜¯åµŒå…¥å†…éƒ¨DSLï¼Œåˆ›å»ºè§£æå™¨ï¼Œæœ€åæ˜¯è¿™äº›è¡¨è¾¾å¼çš„è§£é‡Šå™¨ã€‚ å½“ç„¶ï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±å¿…é¡»å·¥ä½œï¼Œä½†æ˜¯å¦‚æœéœ€è¦æé«˜ç”Ÿäº§ç‡ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡ä¸ºè¡¨è¾¾å¼ç”Ÿæˆå­—èŠ‚ç è€Œä¸æ˜¯åœ¨è§£é‡Šå™¨ä¸­è®¡ç®—å®ƒä»¬æˆ–ä½¿ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»çš„ç¼“å­˜ï¼Œé‚£ä¹ˆGroovyæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ä¸­</a>ä»‹ç»äº†è®¸å¤šé€‰é¡¹ï¼Œä½†æ˜¯æœ€ç®€å•çš„ç¤ºä¾‹åªæ˜¯ä½¿ç”¨<code>Eval</code>ç±»ï¼š </p><br><p> <code>Example.java</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = (Integer) Eval.me(<span class="hljs-string"><span class="hljs-string">"1+1"</span></span>);</code> </pre> <br><p>  Groovyåœ¨è¿è¡Œæ—¶å°†<code>1+1</code>ä»£ç è§£æï¼Œç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼ŒåŠ è½½å¹¶æ‰§è¡Œã€‚ å½“ç„¶ï¼Œæ­¤ç¤ºä¾‹ä¸­çš„ä»£ç éå¸¸ç®€å•ï¼Œæ‚¨å°†éœ€è¦æ·»åŠ å‚æ•°ï¼Œä½†æ˜¯æƒ³æ³•æ˜¯å¯æ‰§è¡Œä»£ç å¯ä»¥æ˜¯ä»»æ„çš„ã€‚ è€Œè¿™å¯èƒ½å¹¶ä¸æ˜¯æ‚¨çœŸæ­£éœ€è¦çš„ã€‚ åœ¨è®¡ç®—å™¨ä¸­ï¼Œæ‚¨éœ€è¦å…è®¸ä»¥ä¸‹å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs">1+1 x+y 1+(2*x)**y cos(alpha)*r v=1+x</code> </pre> <br><p> ä½†è‚¯å®šä¸æ˜¯ </p><br><pre> <code class="plaintext hljs">println 'Hello' (0..100).each { println 'Blah' } Pong p = new Pong() println(new File('/etc/passwd').text) System.exit(-1) Eval.me('System.exit(-1)') // a script within a script!</code> </pre> <br><p> å›°éš¾ä»è¿™é‡Œå¼€å§‹ï¼Œè€Œä¸”å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸€äº›é—®é¢˜ï¼š </p><br><ul><li> å°†è¯­è¨€çš„è¯­æ³•é™åˆ¶ä¸ºå…¶åŠŸèƒ½çš„å­é›† </li><li> é˜²æ­¢ç”¨æˆ·æ‰§è¡Œæœªæä¾›çš„ä»£ç  </li><li> é˜²æ­¢æ‰§è¡Œæ¶æ„ä»£ç  </li></ul><br><p> å¸¦æœ‰è®¡ç®—å™¨çš„ç¤ºä¾‹éå¸¸ç®€å•ï¼Œä½†æ˜¯å¯¹äºæ›´å¤æ‚çš„DSLï¼Œäººä»¬å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°ä»–ä»¬æ­£åœ¨ç¼–å†™æœ‰é—®é¢˜çš„ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨DSLå¦‚æ­¤ç®€å•ä»¥è‡³äº<em>å¼€å‘äººå‘˜</em>æ— æ³•ä½¿ç”¨<em>å®ƒçš„æƒ…å†µä¸‹</em> ã€‚ </p><br><p> å‡ å¹´å‰ï¼Œæˆ‘å¤„äºè¿™ç§æƒ…å†µã€‚ æˆ‘å¼€å‘äº†ä¸€ç§å¼•æ“ï¼Œè¯¥å¼•æ“è¿è¡Œç”±è¯­è¨€å­¦å®¶ç¼–å†™çš„Groovyâ€œè„šæœ¬â€ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªé—®é¢˜æ˜¯å®ƒä»¬å¯èƒ½ä¼šæ— æ„é—´é€ æˆæ— é™å¾ªç¯ã€‚ è¯¥ä»£ç åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å‡ºç°äº†å ç”¨100ï¼…CPUçš„çº¿ç¨‹ï¼Œæ­¤åæœ‰å¿…è¦é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºæœåŠ¡å™¨ã€‚ æˆ‘å¿…é¡»å¯»æ‰¾ä¸€ç§è§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œè€Œåˆä¸å½±å“DSLï¼Œå·¥å…·æˆ–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ </p><br><p> å®é™…ä¸Šï¼Œè®¸å¤šäººä¹Ÿæœ‰ç±»ä¼¼çš„éœ€æ±‚ã€‚ åœ¨è¿‡å»çš„4å¹´ä¸­ï¼Œæˆ‘ä¸€ç›´åœ¨ä¸å¾ˆå¤šæœ‰ç›¸åŒé—®é¢˜çš„äººäº¤è°ˆï¼š <em>å¦‚ä½•é˜²æ­¢ç”¨æˆ·åœ¨Groovyè„šæœ¬ä¸­èƒ¡è¯´å…«é“ï¼Ÿ</em> </p><br><h2 id="kastomayzery-kompilyacii"> å®šåˆ¶ç¼–è¯‘å™¨ </h2><br><p> é‚£æ—¶ï¼Œæˆ‘å·²ç»æœ‰äº†è‡ªå·±çš„å†³å®šï¼Œè€Œä¸”æˆ‘çŸ¥é“å…¶ä»–äººä¹Ÿå¼€å‘äº†ç±»ä¼¼çš„ä¸œè¥¿ã€‚ æœ€åï¼ŒGuillaume Laforgeå»ºè®®æˆ‘åœ¨Groovyå†…æ ¸ä¸­åˆ›å»ºä¸€ç§æœºåˆ¶æ¥å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ã€‚ å®ƒåœ¨Groovy 1.8.0ä¸­ä½œä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¼–è¯‘å®šåˆ¶å™¨å‡ºç°</a> ã€‚ </p><br><p> ç¼–è¯‘å®šåˆ¶å™¨æ˜¯ä¸€ç»„ç±»ï¼Œå¯ä¿®æ”¹Groovyè„šæœ¬çš„ç¼–è¯‘è¿‡ç¨‹ã€‚ æ‚¨å¯ä»¥ç¼–å†™è‡ªå·±çš„å®šåˆ¶ç¨‹åºï¼Œä½†æ˜¯Groovyæä¾›äº†ï¼š </p><br><ul><li> å¯¼å…¥è‡ªå®šä¹‰ç¨‹åºï¼Œå¯å°†å¯¼å…¥å†…å®¹éšå¼æ·»åŠ åˆ°è„šæœ¬ä¸­ï¼Œå› æ­¤ç”¨æˆ·æ— éœ€æ·»åŠ å¯¼å…¥è¯´æ˜ </li><li> å®šåˆ¶ç¨‹åºASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è½¬æ¢ï¼Œä½¿æ‚¨å¯ä»¥å°†ASTè½¬æ¢ç›´æ¥æ·»åŠ åˆ°è„šæœ¬ä¸­ </li><li> é™åˆ¶è¯­è¨€çš„è¯­æ³•å’Œè¯­æ³•æ„é€ çš„å®‰å…¨ASTå®šåˆ¶ç¨‹åº </li></ul><br><p>  ASTè½¬æ¢çš„å®šåˆ¶å™¨å¸®åŠ©æˆ‘è§£å†³äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>@ThreadInterrupt</code></a>è½¬æ¢å¸¦æ¥çš„æ— é™å¾ªç¯é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SecureASTCustomizer</a>å¯èƒ½æ˜¯æœ€å®¹æ˜“è¢«è¯¯è§£çš„ä¸œè¥¿ã€‚ </p><br><p> æˆ‘å¯¹æ­¤è¡¨ç¤ºæ­‰æ„ã€‚ ç„¶åæˆ‘æƒ³ä¸å‡ºä¸€ä¸ªæ›´å¥½çš„åå­—ã€‚ åç§°â€œ SecureASTCustomizerâ€ä¸­æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯<strong>AST</strong> ã€‚ è¯¥æœºåˆ¶çš„ç›®çš„æ˜¯é™åˆ¶å¯¹æŸäº›ASTåŠŸèƒ½çš„è®¿é—®ã€‚ æ ‡é¢˜ä¸­çš„â€œå®‰å…¨â€ä¸€è¯é€šå¸¸æ˜¯å¤šä½™çš„ï¼Œæˆ‘å°†è§£é‡ŠåŸå› ã€‚ ç”šè‡³è¿˜æœ‰è©¹é‡‘æ–¯ï¼ˆJenkinsï¼‰è‘—åçš„å·å£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æµ©</a>ä»‹ï¼ˆKosuke Kawaguchiï¼‰çš„åšå®¢æ–‡ç« ï¼Œæ ‡é¢˜ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œ Fatal Groovy SecureASTCustomizerâ€</a> ã€‚ é‚£é‡Œçš„æ‰€æœ‰å†…å®¹éƒ½å†™å¾—éå¸¸æ­£ç¡®ã€‚  SecureASTCustomizerä¸æ˜¯ä¸ºæ²™ç›’è®¾è®¡çš„ã€‚ åˆ›å»ºå®ƒæ˜¯ä¸ºäº†åœ¨ç¼–è¯‘æ—¶é™åˆ¶è¯­è¨€ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ—¶ã€‚ ç°åœ¨æˆ‘è®¤ä¸ºæœ€å¥½çš„åå­—åº”è¯¥æ˜¯<em>GrammarCustomizer</em> ã€‚ ä½†æ˜¯ï¼Œæ­£å¦‚æ‚¨è‚¯å®šçŸ¥é“çš„é‚£æ ·ï¼Œè®¡ç®—æœºç§‘å­¦ä¸­å­˜åœ¨ä¸‰ä¸ªå›°éš¾ï¼šç¼“å­˜å¤±æ•ˆï¼Œåˆ›å»ºåç§°å’Œæ¯å•ä½é”™è¯¯ã€‚ </p><br><p> ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æ­£åœ¨è€ƒè™‘ä½¿ç”¨å®‰å…¨çš„ASTå®šåˆ¶å™¨ä½œä¸ºç¡®ä¿è„šæœ¬å®‰å…¨æ€§çš„ä¸€ç§æ–¹æ³•ï¼Œè€Œæ‚¨çš„ä»»åŠ¡æ˜¯é˜²æ­¢ç”¨æˆ·ä»è„šæœ¬ä¸­<code>System.exit</code> ã€‚ è¯¥æ–‡æ¡£è¯´ï¼Œå¯ä»¥é€šè¿‡åˆ›å»ºé»‘åå•æˆ–ç™½åå•æ¥ç¦æ­¢ç‰¹æ®Šæ¥æ”¶å™¨ä¸­çš„å‘¼å«ã€‚ å¦‚æœéœ€è¦å®‰å…¨æ€§ï¼Œæˆ‘æ€»æ˜¯å»ºè®®ä¸¥æ ¼åˆ—å‡ºå…è®¸ä½¿ç”¨çš„ç™½åå•ï¼Œè€Œä¸å»ºè®®ç¦æ­¢ä½¿ç”¨ä»»ä½•ä¸œè¥¿çš„é»‘åå•ã€‚ å› ä¸ºé»‘å®¢æ€»æ˜¯æ€è€ƒæ‚¨å¯èƒ½æ²¡æœ‰è€ƒè™‘çš„å†…å®¹ã€‚ æˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ã€‚ </p><br><p> è¿™æ˜¯ä½¿ç”¨<code>SecureASTCustomizer</code>è®¾ç½®åŸå§‹æ²™ç®±è„šæœ¬å¼•æ“çš„æ–¹æ³•ã€‚ å°½ç®¡æˆ‘å¯ä»¥ç”¨Groovyç¼–å†™å®ƒä»¬ï¼Œä½†æˆ‘ç»™å‡ºäº†Javaé…ç½®ç¤ºä¾‹ä»¥ä½¿é›†æˆä»£ç å’Œè„šæœ¬ä¹‹é—´çš„åŒºåˆ«æ›´åŠ æ˜æ˜¾ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); SecureASTCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureASTCustomizer(); customizer.setReceiversBlackList(Arrays.asList(System.class.getName())); conf.addCompilationCustomizers(customizer); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(conf); Object v = shell.evaluate(<span class="hljs-string"><span class="hljs-string">"System.exit(-1)"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"Result = "</span></span> +v); } }</code> </pre> <br><ol><li> åˆ›å»ºç¼–è¯‘å™¨é…ç½® </li><li> åˆ›å»ºå®‰å…¨çš„ASTå®šåˆ¶å™¨ </li><li> å£°æ˜å°†<code>System</code>ç±»ä½œä¸ºæ–¹æ³•è°ƒç”¨çš„æ¥æ”¶è€…åˆ—å…¥é»‘åå• </li><li> å°†å®šåˆ¶ç¨‹åºæ·»åŠ åˆ°ç¼–è¯‘å™¨é…ç½® </li><li> å°†é…ç½®ä¸shellè„šæœ¬ç»‘å®šï¼Œå³å°è¯•åˆ›å»ºæ²™ç®± </li><li> è¿è¡Œâ€œåâ€è„šæœ¬ </li><li> æ˜¾ç¤ºè¿è¡Œè„šæœ¬çš„ç»“æœ </li></ol><br><p> å¦‚æœè¿è¡Œæ­¤ç±»ï¼Œåˆ™åœ¨è„šæœ¬æ‰§è¡ŒæœŸé—´å°†å‘ç”Ÿé”™è¯¯ï¼š </p><br><pre> <code class="plaintext hljs">General error during canonicalization: Method calls not allowed on [java.lang.System] java.lang.SecurityException: Method calls not allowed on [java.lang.System]</code> </pre> <br><p> è¯¥ç»“è®ºç”±å…·æœ‰å®‰å…¨ASTå®šåˆ¶å™¨çš„åº”ç”¨ç¨‹åºå‘å¸ƒï¼Œè¯¥åº”ç”¨ç¨‹åºä¸å…è®¸æ‰§è¡Œ<code>System</code>ç±»çš„æ–¹æ³•ã€‚ æˆåŠŸï¼ å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»ä¿æŠ¤äº†è„šæœ¬ï¼ ä½†æ˜¯ç­‰ä¸€ä¸‹... </p><br><h2 id="secureastcustomizer-vzloman">  SecureASTCustomizerè¢«é»‘äº†ï¼ </h2><br><p> ä¿æŠ¤ï¼Œè¯´ä»€ä¹ˆï¼Ÿ ä½†æ˜¯ï¼Œå¦‚æœæˆ‘è¿™æ ·åšï¼š </p><br><pre> <code class="java hljs">def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p> å¦‚æœå†æ¬¡è¿è¡Œè¯¥ç¨‹åºï¼Œæ‚¨å°†çœ‹åˆ°å®ƒå´©æºƒ<strong>è€Œæ²¡æœ‰</strong>é”™è¯¯ï¼Œå¹¶ä¸”<strong>æ²¡æœ‰</strong>åœ¨å±å¹•ä¸Šæ˜¾ç¤ºç»“æœã€‚ è¿›ç¨‹é€€å‡ºä»£ç ä¸º-1ï¼Œè¡¨ç¤ºç”¨æˆ·è„šæœ¬å·²è¿è¡Œï¼ å‘ç”Ÿä»€ä¹ˆäº‹äº† åœ¨ç¼–è¯‘æ—¶ï¼Œå®‰å…¨ASTå®šåˆ¶å™¨<code>c.exit</code>èƒ½è¯†åˆ«<code>c.exit</code>æ˜¯å¯¹<code>System</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œå› ä¸ºå®ƒåœ¨ASTçº§åˆ«ä¸Šèµ·ä½œç”¨ï¼ å®ƒåˆ†ææ–¹æ³•è°ƒç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–¹æ³•è°ƒç”¨ä¸º<code>c.exit(-1)</code> ï¼Œç„¶åç¡®å®šæ¥æ”¶æ–¹å¹¶æ£€æŸ¥å…¶æ˜¯å¦åœ¨ç™½åå•ï¼ˆæˆ–é»‘åå•ï¼‰ä¸­ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¥æ”¶æ–¹ä¸º<code>c</code> ï¼Œæ­¤å˜é‡<strong>é€šè¿‡defå£°æ˜</strong> ï¼Œè¿™ä¸å°†å…¶å£°æ˜ä¸º<code>Object</code> ï¼Œå¹¶ä¸”å®‰å…¨ASTå®šåˆ¶ç¨‹åºå°†è®¤ä¸ºå˜é‡<code>c</code>çš„ç±»å‹ä¸º<code>Object</code> ï¼Œè€Œä¸æ˜¯<code>System</code> ï¼ </p><br><p> é€šå¸¸ï¼Œæœ‰<strong>å¾ˆå¤š</strong>æ–¹æ³•å¯ä»¥è§£å†³åœ¨å®‰å…¨ASTå®šåˆ¶å™¨ä¸Šåˆ›å»ºçš„å„ç§é…ç½®ã€‚ è¿™é‡Œæœ‰ä¸€äº›å¾ˆé…·çš„ï¼š </p><br><pre> <code class="java hljs">((Object)System).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) Class.forName(<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span>).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span> as Class).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.lang.System.<span class="hljs-function"><span class="hljs-function">exit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p> è¿˜ä¼šæœ‰æ›´å¤šã€‚  Groovyçš„åŠ¨æ€ç‰¹æ€§æ’é™¤äº†åœ¨ç¼–è¯‘æ—¶ä¿®å¤è¿™äº›é—®é¢˜çš„èƒ½åŠ›ã€‚ ä½†æ˜¯ï¼Œç¡®å®å­˜åœ¨è§£å†³æ–¹æ¡ˆã€‚ ä¸€ç§é€‰æ‹©æ˜¯ä¾èµ–æ ‡å‡†çš„JVMå®‰å…¨ç®¡ç†å™¨ã€‚ ä½†æ˜¯ï¼Œè¿™å¯¹äºæ•´ä¸ªç³»ç»Ÿæ¥è¯´æ˜¯ä¸€ä¸ªåºå¤§è€Œåºå¤§çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ç­‰æ•ˆäºå‘éº»é›€å‘å°„å¤§ç‚®ã€‚ æ­¤å¤–ï¼Œå®ƒå¹¶éåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æœ‰æ•ˆï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨è¦ç¦æ­¢è¯»å–æ–‡ä»¶ï¼Œä½†ä¸å¸Œæœ›åˆ›å»ºæ–‡ä»¶ï¼Œåˆ™æ— æ³•æ‰§è¡Œ... </p><br><p> è¿™ç§å±€é™æ€§ï¼ˆå¯¹æˆ‘ä»¬è®¸å¤šäººè€Œè¨€æ˜¯ä¸€ç§çƒ¦æ¼ï¼‰å¯¼è‡´åŸºäº<strong>è¿è¡Œæ—¶æ£€æŸ¥</strong>çš„è§£å†³æ–¹æ¡ˆçš„åˆ›å»ºã€‚ è¿™ç§æ£€æŸ¥æ²¡æœ‰è¿™ç§é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå› ä¸ºåœ¨å¼€å§‹éªŒè¯æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼Œæ‚¨å°†çŸ¥é“æ¶ˆæ¯çš„å®é™…æ¥æ”¶è€…ç±»å‹ã€‚ ä»¥ä¸‹å®ç°æ˜¯ç‰¹åˆ«ä»¤äººæ„Ÿå…´è¶£çš„ï¼š </p><br><ul><li>  Jim White <a href="">æ’°å†™çš„SecureScript</a> </li><li> å·å£æµ©ä»‹çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Groovy Sandbox</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Groovy Sandbox</a> ï¼ŒSimon Templeæä¾› </li></ul><br><p> ä½†æ˜¯ï¼Œè¿™äº›å®ç°éƒ½ä¸æ˜¯å®Œå…¨å¯é å’Œå®‰å…¨çš„ã€‚ ä¾‹å¦‚ï¼ŒKosukeçš„ç‰ˆæœ¬åŸºäºå¯¹ç¼“å­˜è°ƒç”¨ç«™ç‚¹çš„å†…éƒ¨å®ç°çš„ç ´è§£ã€‚ é—®é¢˜åœ¨äºå®ƒä¸Groovyçš„invokedynamicç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå¹¶ä¸”è¿™äº›å†…éƒ¨ç±»å°†ä¸åœ¨Groovyçš„æœªæ¥ç‰ˆæœ¬ä¸­ã€‚ å¦ä¸€æ–¹é¢ï¼ŒSimonçš„ç‰ˆæœ¬åŸºäºASTè½¬æ¢ï¼Œä½†æ˜¯ç•™ä¸‹äº†è®¸å¤šæ½œåœ¨çš„æ¼æ´ã€‚ </p><br><p> ç»“æœï¼Œæˆ‘çš„æœ‹å‹Corinne Crischï¼ŒFabrice Matratå’ŒSebastian Blancï¼Œæˆ‘å†³å®šåœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ç§æ–°çš„æ²™ç®±æœºåˆ¶ï¼Œä¸ä¼šå‡ºç°è¿™äº›é¡¹ç›®è¿™æ ·çš„é—®é¢˜ã€‚ æˆ‘ä»¬å¼€å§‹åœ¨å°¼æ–¯çš„é»‘å®¢é©¬æ‹‰æ¾ä¸Šå®æ–½å®ƒï¼Œåœ¨å»å¹´çš„Greachä¼šè®®ä¸Šï¼Œæˆ‘ä»¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°±æ­¤åšäº†æŠ¥å‘Š</a> ã€‚ è¯¥æœºåˆ¶åŸºäºASTè½¬æ¢ï¼Œæœ¬è´¨ä¸Šæ˜¯é‡å†™ä»£ç ä»¥åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨ä¹‹å‰è¿›è¡Œæ£€æŸ¥ï¼Œå°è¯•è®¿é—®ç±»å­—æ®µï¼Œå¢åŠ å˜é‡ï¼ŒäºŒè¿›åˆ¶è¡¨è¾¾å¼ç­‰ã€‚æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®ç°</a>ä»æœªå‡†å¤‡å¥½ï¼Œè¿˜æ²¡æœ‰å®Œæˆå¾ˆå¤šå·¥ä½œï¼Œå› æ­¤å½“æˆ‘æ„è¯†åˆ°é€šè¿‡â€œéšå¼thisâ€è°ƒç”¨çš„æ–¹æ³•å’Œå‚æ•°çš„é—®é¢˜å°šæœªè§£å†³æ—¶ï¼Œä¾‹å¦‚åœ¨æ„å»ºå™¨ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">xml { cars { // cars is a method call on an implicit this: "this".cars(...) car(make:'Renault', model: 'Clio') } }</code> </pre> <br><p> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œç”±äºGroovyä¸­çš„å…ƒå¯¹è±¡åè®®çš„ä½“ç³»ç»“æ„ï¼Œæˆ‘ä»ç„¶æ²¡æœ‰æ‰¾åˆ°è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•ï¼Œè¯¥ä½“ç³»åŸºäºä»¥ä¸‹äº‹å®ï¼šæ¥æ”¶æ–¹åœ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ¥æ”¶æ–¹ä¹‹å‰æ— æ³•æ‰¾åˆ°è¯¥æ–¹æ³•æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ„å‘³ç€æ‚¨æ— æ³•åœ¨å®é™…æ–¹æ³•è°ƒç”¨ä¹‹å‰æ‰¾å‡ºæ¥æ”¶å™¨çš„ç±»å‹ã€‚ å¦‚æœé€šè¯å·²é€šè¿‡ï¼Œé‚£å°±å¤ªè¿Ÿäº†... </p><br><p> ç›´åˆ°æœ€è¿‘ï¼Œå¯¹äºå¯æ‰§è¡Œè„šæœ¬ä½¿ç”¨è¯­è¨€çš„åŠ¨æ€å±æ€§çš„æƒ…å†µï¼Œæˆ‘è¿˜æ²¡æœ‰é’ˆå¯¹æ­¤é—®é¢˜çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚ ä½†æ˜¯ç°åœ¨æ˜¯æ—¶å€™è§£é‡Šä¸€ä¸‹ï¼Œå¦‚æœæ‚¨å‡†å¤‡ç‰ºç‰²ä¸€ç‚¹è¯­è¨€çš„æ´»åŠ›ï¼Œé‚£ä¹ˆå¦‚ä½•å¯ä»¥å¤§å¤§æ”¹å–„è¿™ç§æƒ…å†µã€‚ </p><br><h2 id="proverka-tipov"> ç±»å‹æ£€æŸ¥ </h2><br><p> è®©æˆ‘ä»¬å›åˆ°SecureASTCustomizerçš„ä¸»è¦é—®é¢˜ï¼šå®ƒä¸æŠ½è±¡è¯­æ³•æ ‘ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰æœ‰å…³ç‰¹å®šæ¶ˆæ¯ç±»å‹å’Œæ¥æ”¶è€…çš„ä¿¡æ¯ã€‚ ä½†æ˜¯å¯¹äºGroovy 2ï¼ŒGroovyæ·»åŠ äº†ç¼–è¯‘ï¼Œåœ¨Groovy 2.1ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”¨äºç±»å‹æ£€æŸ¥çš„æ‰©å±•</a> ã€‚ </p><br><p> ç±»å‹æ£€æŸ¥çš„æ‰©å±•åŠŸèƒ½éå¸¸å¼ºå¤§ï¼šå®ƒä»¬ä½¿Groovy DSLå¼€å‘äººå‘˜å¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨è¿›è¡Œç±»å‹æ¨æ–­ï¼Œå¹¶ä¸”è¿˜å¯ä»¥åœ¨é€šå¸¸ä¸å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹ç”Ÿæˆç¼–è¯‘é”™è¯¯ã€‚ ä¾‹å¦‚ï¼Œåœ¨å®ç°traitsæˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ ‡è®°æ¨¡æ¿å¼•æ“</a>æ—¶ï¼ŒGroovyåœ¨å†…éƒ¨ä½¿ç”¨è¿™äº›æ‰©å±•æ¥æ”¯æŒé™æ€ç¼–è¯‘å™¨ã€‚ </p><br><p> å¦‚æœæˆ‘ä»¬å¯ä»¥ä¾é ç±»å‹æ£€æŸ¥æœºåˆ¶çš„ä¿¡æ¯æ¥ä»£æ›¿è§£æå™¨çš„ç»“æœï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ é‡‡å–æˆ‘ä»¬çš„é»‘å®¢è¯•å›¾ç¼–å†™çš„ä»£ç ï¼š </p><br><p> <code>((Object)System).exit(-1)</code> </p> <br><p> å¦‚æœæ¿€æ´»ç±»å‹æ£€æŸ¥ï¼Œåˆ™ä»£ç ä¸ä¼šç¼–è¯‘ï¼š </p><br><pre> <code class="plaintext hljs">1 compilation error: [Static type checking] - Cannot find matching method java.lang.Object#exit(java.lang.Integer). Please check if the declared type is right and if the method exists.</code> </pre> <br><p> å› æ­¤ï¼Œæ­¤ä»£ç ä¸å†ç¼–è¯‘ã€‚ å¦‚æœæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ä»£ç ï¼Œè¯¥æ€ä¹ˆåŠï¼š </p><br><pre> <code class="java hljs">def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œå®ƒé€šè¿‡ç±»å‹æ£€æŸ¥ï¼ŒåŒ…è£…åœ¨æ–¹æ³•ä¸­å¹¶ä½¿ç”¨<code>groovy</code>å‘½ä»¤æ‰§è¡Œï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@groovy</span></span>.transform.TypeChecked <span class="hljs-comment"><span class="hljs-comment">// or even @CompileStatic void foo() { def c = System c.exit(-1) } foo()</span></span></code> </pre> <br><p> ç±»å‹æ£€æŸ¥å™¨æ£€æµ‹åˆ°ä»<code>System</code>ç±»è°ƒç”¨äº†<code>exit</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•æ˜¯æœ‰æ•ˆçš„ã€‚ è¿™å¯¹æˆ‘ä»¬æ²¡æœ‰å¸®åŠ©ã€‚ ä½†æ˜¯æˆ‘ä»¬çŸ¥é“çš„æ˜¯ï¼Œå¦‚æœæ­¤ä»£ç é€šè¿‡ç±»å‹æ£€æŸ¥ï¼Œåˆ™æ„å‘³ç€ç¼–è¯‘å™¨å¯ä»¥è¯†åˆ«å¯¹ç±»å‹ä¸º<code>System</code>çš„æ¥æ”¶è€…çš„è°ƒç”¨ã€‚ é€šå¸¸ï¼Œè¯¥æƒ³æ³•æ˜¯ç¦æ­¢å¸¦æœ‰æ‰©å±•åçš„å‘¼å«è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ </p><br><h2 id="prostoe-rasshirenie-dlya-proverki-tipov"> ç”¨äºç±»å‹æ£€æŸ¥çš„ç®€å•æ‰©å±• </h2><br><p> åœ¨è¯¦ç»†ç ”ç©¶æ²™ç®±ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å°è¯•åœ¨æ ‡å‡†æ‰©å±•çš„å¸®åŠ©ä¸‹â€œä¿æŠ¤â€è„šæœ¬çš„ç±»å‹ï¼Œä»¥è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ æ³¨å†Œè¿™æ ·çš„æ‰©å±•å¾ˆå®¹æ˜“ï¼šåªéœ€ä¸º<code>@TypeChecked</code>æ³¨é‡Šè®¾ç½®<code>extensions</code>å‚æ•°ï¼ˆå¦‚æœä½¿ç”¨é™æ€ç¼–è¯‘ï¼Œåˆ™è®¾ç½®<code>@TypeChecked</code> ï¼‰ï¼š </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@TypeChecked</span></span>(extensions=[<span class="hljs-string"><span class="hljs-string">'SecureExtension1.groovy'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) } foo()</code> </pre> <br><p> æ‰©å±•æœç´¢å°†ä»¥æºä»£ç æ ¼å¼åœ¨ç±»è·¯å¾„ä¸­è¿›è¡Œï¼ˆæ‚¨å¯ä»¥è¿›è¡Œé¢„ç¼–è¯‘çš„æ‰©å±•ä»¥è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä½†åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬å°†ä¸è€ƒè™‘å®ƒä»¬ï¼‰ï¼š </p><br><p> <code>SecureExtension1.groovy</code> </p> <br><pre> <code class="java hljs">onMethodSelection { expr, methodNode -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode.declaringClass.name==<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span>) { addStaticTypeError(<span class="hljs-string"><span class="hljs-string">"Method call is not allowed!"</span></span>, expr) } }</code> </pre> <br><ol><li> å½“ç±»å‹æ£€æŸ¥å™¨é€‰æ‹©è¦è°ƒç”¨çš„æ–¹æ³•æ—¶ </li><li> å¦‚æœè¯¥æ–¹æ³•å±äº<code>System</code>ç±» </li><li> ç„¶åè®©ç±»å‹æ£€æŸ¥å™¨ç”Ÿæˆé”™è¯¯ </li></ol><br><p> è¿™å°±æ˜¯æ‚¨æ‰€éœ€è¦çš„ã€‚ ç°åœ¨å†æ¬¡è¿è¡Œä»£ç ï¼Œæ‚¨å°†çœ‹åˆ°ç¼–è¯‘é”™è¯¯ï¼ </p><br><pre> <code class="plaintext hljs">/home/cchampeau/tmp/securetest.groovy: 6: [Static type checking] - Method call is not allowed! @ line 6, column 3. c.exit(-1) ^ 1 error</code> </pre> <br><p> è¿™æ¬¡ï¼Œç”±äºç±»å‹æ£€æŸ¥å™¨çš„å¸®åŠ©ï¼Œ <code>c</code>è¯†åˆ«ä¸º<code>System</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¦æ­¢è¯¥è°ƒç”¨ã€‚ è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¤ºä¾‹ï¼Œå¹¶ä¸”åœ¨é…ç½®æ–¹é¢æ²¡æœ‰æ¼”ç¤ºå®‰å…¨ASTå®šåˆ¶ç¨‹åºå¯ä»¥å®Œæˆçš„æ‰€æœ‰æ“ä½œã€‚ åœ¨æˆ‘ä»¬<strong>ç¼–å†™</strong>çš„æ‰©å±•ä¸­ï¼Œæ£€æŸ¥æ˜¯<strong>ç¡¬ç¼–ç çš„</strong> ï¼Œä½†æ˜¯æœ€å¥½ä½¿å®ƒä»¬å¯å®šåˆ¶ã€‚ å› æ­¤ï¼Œè®©ç¤ºä¾‹å˜å¾—æ›´åŠ å¤æ‚ã€‚ </p><br><p> å‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºä¸ºæ–‡æ¡£è®¡ç®—æŸäº›æŒ‡æ ‡ï¼Œå¹¶å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å®ƒä»¬ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDSLï¼š </p><br><ul><li> å°†æ“ä½œï¼ˆè‡³å°‘ï¼‰ <code>score</code>å˜é‡ </li><li> å…è®¸ç”¨æˆ·æ‰§è¡Œæ•°å­¦è¿ç®—ï¼ˆåŒ…æ‹¬è°ƒç”¨<em>cos</em> ï¼Œ <em>abs</em> ï¼Œ...æ–¹æ³•ï¼‰ </li><li> å¿…é¡»ç¦æ­¢æ‰€æœ‰å…¶ä»–æ–¹æ³• </li></ul><br><p> æ ·æœ¬ç”¨æˆ·è„šæœ¬ï¼š </p><br><p> <code>abs(cos(1+score))</code> </p> <br><p> æ­¤DSLæ˜“äºé…ç½®ã€‚ è¿™æ˜¯æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„å˜ä½“ï¼š </p><br><p> <code>Sandbox.java</code> </p> <br><pre> <code class="java hljs">CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); ImportCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImportCustomizer(); customizer.addStaticStars(<span class="hljs-string"><span class="hljs-string">"java.lang.Math"</span></span>); conf.addCompilationCustomizers(customizer); Binding binding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(); binding.setVariable(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>d); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(binding,conf); Double userScore = (Double) shell.evaluate(<span class="hljs-string"><span class="hljs-string">"abs(cos(1+score))"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"userScore = "</span></span> + userScore);</code> </pre> <br><ol><li> æ·»åŠ å¯¼å…¥å®šåˆ¶ç¨‹åºï¼Œè¿™ä¼šå°†<code>import static java.lang.Math.*</code>æ·»åŠ åˆ°æ‰€æœ‰è„šæœ¬ </li><li> ä½¿<code>score</code>å˜é‡å¯ç”¨äºè„šæœ¬ </li><li> æ‰§è¡Œè„šæœ¬ </li></ol><br><p>  <em>æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥ç¼“å­˜è„šæœ¬ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½è§£æå’Œç¼–è¯‘è„šæœ¬ã€‚</em>  <em>æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§æ–‡æ¡£ã€‚</em> </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬çš„è„šæœ¬å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢é»‘å®¢å¯åŠ¨æ¶æ„ä»£ç ã€‚ ç”±äºæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ç±»å‹æ£€æŸ¥ï¼Œå› æ­¤æˆ‘å»ºè®®ä½¿ç”¨<code>@CompileStatic</code>è½¬æ¢ï¼š </p><br><ul><li> å®ƒä¼šæ¿€æ´»è„šæœ¬ä¸­çš„ç±»å‹æ£€æŸ¥ï¼Œç”±äºæ‰©å±•äº†ç±»å‹æ£€æŸ¥åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿæ‰§è¡Œå…¶ä»–æ£€æŸ¥ </li><li> æé«˜è„šæœ¬æ€§èƒ½ </li></ul><br><p> å°†<code>@CompileStatic</code>æ³¨é‡Šéšå¼æ·»åŠ åˆ°è„šæœ¬éå¸¸ç®€å•ã€‚ æ‚¨åªéœ€è¦æ›´æ–°ç¼–è¯‘å™¨é…ç½®ï¼š </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer(CompileStatic.class); conf.addCompilationCustomizers(astcz);</code> </pre> <br><p> ç°åœ¨ï¼Œå¦‚æœæ‚¨å°è¯•å†æ¬¡è¿è¡Œè¯¥è„šæœ¬ï¼Œå°†çœ‹åˆ°ç¼–è¯‘é”™è¯¯ï¼š </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - The variable [score] is undeclared. @ line 1, column 11. abs(cos(1+score)) ^ Script1.groovy: 1: [Static type checking] - Cannot find matching method int#plus(java.lang.Object). Please check if the declared type is right and if the method exists. @ line 1, column 9. abs(cos(1+score)) ^ 2 errors</code> </pre> <br><p> å‘ç”Ÿä»€ä¹ˆäº‹äº† å¦‚æœæ‚¨ä»ç¼–è¯‘å™¨çš„è§’åº¦é˜…è¯»è„šæœ¬ï¼Œé‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œä»–å¯¹å˜é‡â€œåˆ†æ•°â€ä¸€æ— æ‰€çŸ¥ã€‚ ä½†æ˜¯ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæ‚¨çŸ¥é“è¿™æ˜¯ä¸€ä¸ª<code>double</code>å˜é‡ï¼Œä½†æ˜¯ç¼–è¯‘å™¨æ— æ³•è¾“å‡ºå®ƒã€‚ ä¸ºæ­¤ï¼Œå°†åˆ›å»ºç”¨äºç±»å‹æ£€æŸ¥çš„æ‰©å±•ï¼šæ‚¨å¯ä»¥ä¸ºç¼–è¯‘å™¨æä¾›å…¶ä»–ä¿¡æ¯ï¼Œç„¶åç¼–è¯‘å°†æ­£å¸¸è¿›è¡Œã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å‡º<code>score</code>å˜é‡çš„ç±»å‹ä¸º<code>double</code> ã€‚ </p><br><p> å› æ­¤ï¼Œæ‚¨å¯ä»¥ç¨å¾®æ›´æ”¹<code>@CompileStatic</code>æ‰¹æ³¨çš„æ–¹å¼ï¼š </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension2.groovy"</span></span>)), CompileStatic.class);</code> </pre> <br><p> è¿™â€œæ¨¡æ‹Ÿâ€äº†<code>@CompileStatic(extensions=['SecureExtension2.groovy'])</code>æ³¨é‡Šçš„ä»£ç <code>@CompileStatic(extensions=['SecureExtension2.groovy'])</code> ã€‚ ç°åœ¨ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªæ‰©å±•ç¨‹åºæ¥è¯†åˆ«<code>score</code>å˜é‡ï¼š </p><br><p> <code>SecureExtension2.groovy</code> </p> <br><pre> <code class="java hljs">unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name==<span class="hljs-string"><span class="hljs-string">'score'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, double_TYPE) } }</code> </pre> <br><ol><li> å¦‚æœç±»å‹æ£€æŸ¥å™¨æ— æ³•ç¡®å®šå˜é‡ </li><li> å¦‚æœå˜é‡åç§°æ˜¯<code>score</code> </li><li> è®©ç¼–è¯‘å™¨ä½¿ç”¨<code>double</code>ç±»å‹åŠ¨æ€å®šä¹‰å˜é‡ </li></ol><br><p> å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ–‡æ¡£çš„æ­¤éƒ¨åˆ†ä¸­</a>æ‰¾åˆ°ç”¨äºç±»å‹æ£€æŸ¥çš„DSLæ‰©å±•çš„å®Œæ•´è¯´æ˜ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç»„åˆç¼–è¯‘æ¨¡å¼çš„ç¤ºä¾‹ï¼šç¼–è¯‘å™¨æ— æ³•å®šä¹‰<code>score</code>å˜é‡ã€‚ ä½œä¸ºDSLå¼€å‘äººå‘˜ï¼Œæ‚¨<strong>çŸ¥é“</strong>å˜é‡å®é™…ä¸Šæ˜¯å…¶ç±»å‹<code>makeDynamic</code> ï¼Œå› æ­¤å¯¹<code>makeDynamic</code>çš„è°ƒç”¨åœ¨è¿™é‡Œè¯´ï¼šâ€œå¥½å§ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘çŸ¥é“æˆ‘åœ¨åšä»€ä¹ˆï¼Œå¯ä»¥ä½¿ç”¨<code>double</code>ç±»å‹åŠ¨æ€å®šä¹‰æ­¤å˜é‡ã€‚ â€ ä»…æ­¤è€Œå·²ï¼ </p><br><h2 id="pervoe-zavershennoe-secure-rasshirenie"> é¦–æ¬¡å®Œæˆçš„â€œå®‰å…¨â€æ‰©å±• </h2><br><p> ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·ã€‚ æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç±»å‹æ£€æŸ¥æ‰©å±•ç¨‹åºï¼Œå®ƒä¸€æ–¹é¢é˜²æ­¢è°ƒç”¨<code>System</code>ç±»çš„æ–¹æ³•ï¼Œå¦ä¸€æ–¹é¢åˆå®šä¹‰äº†<code>score</code>å˜é‡ã€‚ å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†å®ƒä»¬è¿æ¥èµ·æ¥ï¼Œæˆ‘ä»¬å°†è·å¾—ç¬¬ä¸€ä¸ªå®Œæ•´çš„æ‰©å±•ä»¥è¿›è¡Œç±»å‹æ£€æŸ¥ï¼š </p><br><p> <code>SecureExtension3.groovy</code> </p> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// disallow calls on System onMethodSelection { expr, methodNode -&gt; if (methodNode.declaringClass.name=='java.lang.System') { addStaticTypeError("Method call is not allowed!", expr) } } // resolve the score variable unresolvedVariable { var -&gt; if (var.name=='score') { return makeDynamic(var, double_TYPE) } }</span></span></code> </pre> <br><p> è®°ä½è¦æ›´æ–°Javaç±»ä¸­çš„é…ç½®ï¼Œä»¥ä½¿ç”¨æ–°çš„æ‰©å±•åè¿›è¡Œç±»å‹æ£€æŸ¥ï¼š </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension3.groovy"</span></span>)), CompileStatic.class);</code> </pre> <br><p> å†æ¬¡è¿è¡Œä»£ç -å®ƒä»ç„¶æœ‰æ•ˆã€‚ ç°åœ¨å°è¯•è¿™ä¸ªï¼š </p><br><pre> <code class="plaintext hljs">abs(cos(1+score)) System.exit(-1)</code> </pre> <br><p> è„šæœ¬çš„ç¼–è¯‘å°†å› é”™è¯¯è€Œå´©æºƒï¼š </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - Method call is not allowed! @ line 1, column 19. abs(cos(1+score));System.exit(-1) ^ 1 error</code> </pre> <br><p> æ­å–œï¼Œæ‚¨åˆšåˆšç¼–å†™äº†ç¬¬ä¸€ä¸ªé˜²æ­¢æ¶æ„ä»£ç è¿è¡Œçš„ç±»å‹æ£€æŸ¥æ‰©å±•ç¨‹åºï¼ </p><br><h2 id="uluchshenie-konfiguracii-rasshireniya"> å¢å¼ºçš„æ‰©å±•é…ç½® </h2><br><p> å› æ­¤ï¼Œä¸€åˆ‡è¿›å±•é¡ºåˆ©ï¼Œæˆ‘ä»¬å¯ä»¥ç¦æ­¢è°ƒç”¨<code>System</code>ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼¼ä¹å¾ˆå¿«å°±ä¼šå‘ç°æ–°çš„æ¼æ´ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†éœ€è¦é˜²æ­¢å¯åŠ¨æ¶æ„ä»£ç ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†å°è¯•ä½¿æ‰©å±•åé€šç”¨ä¸”å¯å®šåˆ¶ï¼Œè€Œä¸æ˜¯å¯¹æ‰©å±•åä¸­çš„æ‰€æœ‰å†…å®¹è¿›è¡Œç¡¬ç¼–ç ã€‚ è¿™å¯èƒ½æ˜¯æœ€å›°éš¾çš„ï¼Œå› ä¸ºæ²¡æœ‰ç›´æ¥æ–¹æ³•å°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™æ‰©å±•è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ å› æ­¤ï¼Œè¯¥æ€æƒ³åŸºäºä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡ï¼ˆæ›²çº¿æ–¹æ³•ï¼Œæ˜¯ï¼‰å°†é…ç½®æ•°æ®ä¼ é€’ç»™ç±»å‹æ£€æŸ¥å™¨ã€‚ </p><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿å˜é‡åˆ—è¡¨å¯å®šåˆ¶ã€‚  Javaä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p> <code>Sandbox.java</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VAR_TYPES = <span class="hljs-string"><span class="hljs-string">"sandboxing.variable.types"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; COMPILE_OPTIONS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); ImportCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImportCustomizer(); customizer.addStaticStars(<span class="hljs-string"><span class="hljs-string">"java.lang.Math"</span></span>); ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension4.groovy"</span></span>)), CompileStatic.class); conf.addCompilationCustomizers(astcz); conf.addCompilationCustomizers(customizer); Binding binding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(); binding.setVariable(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>d); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Map&lt;String,ClassNode&gt; variableTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, ClassNode&gt;(); variableTypes.put(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, ClassHelper.double_TYPE); Map&lt;String,Object&gt; options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, Object&gt;(); options.put(VAR_TYPES, variableTypes); COMPILE_OPTIONS.set(options); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(binding, conf); Double userScore = (Double) shell.evaluate(<span class="hljs-string"><span class="hljs-string">"abs(cos(1+score));System.exit(-1)"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"userScore = "</span></span> + userScore); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { COMPILE_OPTIONS.remove(); } } }</code> </pre> <br><ol><li>  <code>ThreadLocal</code> ,          </li><li>    â€” <code>SecureExtension4.groovy</code> </li><li> <code>variableTypes</code> â€”   â€œ  â†’  â€ </li><li>      <code>score</code> </li><li> <code>options</code> â€”     </li><li>   "variable types"     VAR_TYPES </li><li>     thread local </li><li> ,    ,     thread local </li></ol><br><p>          : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) } }</code> </pre> <br><ol><li>        thread local </li><li>      ,      , </li><li>   type checker       </li></ol><br><p>         thread local,    ,  type checker  . ,      <code>unresolvedVariable</code> ,    ,  ,    type checker,   .  ,     .   ! </p><br><p>           .        ,       . </p><br><h2 id="konfiguraciya-belogo-spiska-metodov">     </h2><br><p>    .   ,       .      ,         ,     . ,  <code>System.exit</code> ,   : </p><br><pre> <code class="plaintext hljs">java.lang.System#exit(int)</code> </pre> <br><p> ,     Java,    : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String WHITELIST_PATTERNS = <span class="hljs-string"><span class="hljs-string">"sandboxing.whitelist.patterns"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... public static void main(String[] args) { // ... try { Map&lt;String,ClassNode&gt; variableTypes = new HashMap&lt;String, ClassNode&gt;(); variableTypes.put("score", ClassHelper.double_TYPE); Map&lt;String,Object&gt; options = new HashMap&lt;String, Object&gt;(); List&lt;String&gt; patterns = new ArrayList&lt;String&gt;(); patterns.add("java\\.lang\\.Math#"); options.put(VAR_TYPES, variableTypes); options.put(WHITELIST_PATTERNS, patterns); COMPILE_OPTIONS.set(options); GroovyShell shell = new GroovyShell(binding, conf); Double userScore = (Double) shell.evaluate("abs(cos(1+score));System.exit(-1)"); System.out.println("userScore = " + userScore); } finally { COMPILE_OPTIONS.remove(); } } }</span></span></code> </pre> <br><ol><li>    </li><li>    <code>java.lang.Math</code>   </li><li>        </li></ol><br><p>       : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.transform.CompileStatic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.MethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.Parameter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.ExtensionMethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prettyPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassNode node)</span></span></span><span class="hljs-function"> </span></span>{ node.isArray()?<span class="hljs-string"><span class="hljs-string">"${prettyPrint(node.componentType)}[]"</span></span>:node.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toMethodDescriptor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodNode node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ExtensionMethodNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toMethodDescriptor(node.extensionMethodNode) } def sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() sb.append(node.declaringClass.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">"#"</span></span>) sb.append(node.name) sb.append(<span class="hljs-string"><span class="hljs-string">'('</span></span>) sb.append(node.parameters.collect { Parameter it -&gt; prettyPrint(it.originType) }.join(<span class="hljs-string"><span class="hljs-string">','</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">')'</span></span>) sb } def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] def whiteList = COMPILE_OPTIONS.get()[WHITELIST_PATTERNS] onMethodSelection { expr, MethodNode methodNode -&gt; def descr = toMethodDescriptor(methodNode) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!whiteList.any { descr =~ it }) { addStaticTypeError(<span class="hljs-string"><span class="hljs-string">"You tried to call a method which is not allowed, what did you expect?: $descr"</span></span>, expr) } } unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) } }</code> </pre> <br><ol><li>       <code>MethodNode</code> </li><li>     thread local </li><li>       </li><li>        ,   </li></ol><br><p>      ,    : </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - You tried to call a method which is not allowed, what did you expect?: java.lang.System#exit(int) @ line 1, column 19. abs(cos(1+score));System.exit(-1) ^ 1 error</code> </pre> <br><p> ,  !        ,   <strong>  </strong> , <strong>  </strong>  .    ,      !     ,       ,       . ,   (  <code>foo.text</code> ,     <code>foo.getText()</code> ). </p><br><h2 id="sobiraem-vse-vmeste">    </h2><br><p>     ,    type checker'    "property selection", ,   .      ,         ,  .         ,     ,       â€”    .     . </p><br><p> <code>SandboxingTypeCheckingExtension.groovy</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.transform.CompileStatic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassCodeVisitorSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassHelper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.MethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.Parameter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.expr.PropertyExpression <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.control.SourceUnit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.sc.StaticCompilationMetadataKeys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.ExtensionMethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.GroovyTypeCheckingExtensionSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.StaticTypeCheckingSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SandboxingTypeCheckingExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroovyTypeCheckingExtensionSupport</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeCheckingDSL</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prettyPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassNode node)</span></span></span><span class="hljs-function"> </span></span>{ node.isArray()?<span class="hljs-string"><span class="hljs-string">"${prettyPrint(node.componentType)}[]"</span></span>:node.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toMethodDescriptor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodNode node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ExtensionMethodNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toMethodDescriptor(node.extensionMethodNode) } def sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() sb.append(node.declaringClass.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">"#"</span></span>) sb.append(node.name) sb.append(<span class="hljs-string"><span class="hljs-string">'('</span></span>) sb.append(node.parameters.collect { Parameter it -&gt; prettyPrint(it.originType) }.join(<span class="hljs-string"><span class="hljs-string">','</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">')'</span></span>) sb } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Fetch white list of regular expressions of authorized method calls def whiteList = COMPILE_OPTIONS.get()[WHITELIST_PATTERNS] def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] onMethodSelection { expr, MethodNode methodNode -&gt; def descr = toMethodDescriptor(methodNode) if (!whiteList.any { descr =~ it }) { addStaticTypeError("You tried to call a method which is not allowed, what did you expect?: $descr", expr) } } unresolvedVariable { var -&gt; if (isDynamic(var) &amp;&amp; typesOfVariables[var.name]) { storeType(var, typesOfVariables[var.name]) handled = true } } // handling properties (like foo.text) is harder because the type checking extension // does not provide a specific hook for this. Harder, but not impossible! afterVisitMethod { methodNode -&gt; def visitor = new PropertyExpressionChecker(context.source, whiteList) visitor.visitMethod(methodNode) } } private class PropertyExpressionChecker extends ClassCodeVisitorSupport { private final SourceUnit unit private final List&lt;String&gt; whiteList PropertyExpressionChecker(final SourceUnit unit, final List&lt;String&gt; whiteList) { this.unit = unit this.whiteList = whiteList } @Override protected SourceUnit getSourceUnit() { unit } @Override void visitPropertyExpression(final PropertyExpression expression) { super.visitPropertyExpression(expression) ClassNode owner = expression.objectExpression.getNodeMetaData(StaticCompilationMetadataKeys.PROPERTY_OWNER) if (owner) { if (expression.spreadSafe &amp;&amp; StaticTypeCheckingSupport.implementsInterfaceOrIsSubclassOf(owner, classNodeFor(Collection))) { owner = typeCheckingVisitor.inferComponentType(owner, ClassHelper.int_TYPE) } def descr = "${prettyPrint(owner)}#${expression.propertyAsString}" if (!whiteList.any { descr =~ it }) { addStaticTypeError("Property is not allowed: $descr", expression) } } } } }```     sandbox',     assert' ,  ,     : ``Sandbox.java`` ```java public class Sandbox { public static final String WHITELIST_PATTERNS = "sandboxing.whitelist.patterns"; public static final String VAR_TYPES = "sandboxing.variable.types"; public static final ThreadLocal&lt;Map&lt;String, Object&gt;&gt; COMPILE_OPTIONS = new ThreadLocal&lt;Map&lt;String, Object&gt;&gt;(); public static void main(String[] args) { CompilerConfiguration conf = new CompilerConfiguration(); ImportCustomizer customizer = new ImportCustomizer(); customizer.addStaticStars("java.lang.Math"); ASTTransformationCustomizer astcz = new ASTTransformationCustomizer( singletonMap("extensions", singletonList("SandboxingTypeCheckingExtension.groovy")), CompileStatic.class); conf.addCompilationCustomizers(astcz); conf.addCompilationCustomizers(customizer); Binding binding = new Binding(); binding.setVariable("score", 2.0d); try { Map&lt;String, ClassNode&gt; variableTypes = new HashMap&lt;String, ClassNode&gt;(); variableTypes.put("score", ClassHelper.double_TYPE); Map&lt;String, Object&gt; options = new HashMap&lt;String, Object&gt;(); List&lt;String&gt; patterns = new ArrayList&lt;String&gt;(); // allow method calls on Math patterns.add("java\\.lang\\.Math#"); // allow constructors calls on File patterns.add("File#&lt;init&gt;"); // because we let the user call each/times/... patterns.add("org\\.codehaus\\.groovy\\.runtime\\.DefaultGroovyMethods"); options.put(VAR_TYPES, variableTypes); options.put(WHITELIST_PATTERNS, patterns); COMPILE_OPTIONS.set(options); GroovyShell shell = new GroovyShell(binding, conf); Object result; try { result = shell.evaluate("Eval.me('1')"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("System.exit(-1)"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("((Object)Eval).me('1')"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("new File('/etc/passwd').getText()"); // getText is not allowed assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("new File('/etc/passwd').text"); // getText is not allowed assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } Double userScore = (Double) shell.evaluate("abs(cos(1+score))"); System.out.println("userScore = " + userScore); } finally { COMPILE_OPTIONS.remove(); } } }</span></span></code> </pre> <br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p>      Groovy       JVM.        ,      . ,    ,    ,      .  ,    Groovy,      sandboxing'          (,       ,   ). </p><br><p>  ,            ,          .      ,            .  ,      ,        . </p><br><p>    ,   sandboxing',   , â€”  <strong></strong>  <code>SecureASTCustomizer</code> .    <strong> ,  </strong> ,       : secure AST customizer    ,      (,       ),              (   ,   ). </p><br><p> ,    : ,   , .   Groovy   .          Groovy,   ,  -      pull request,      -  ! <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN445114/">https://habr.com/ru/post/zh-CN445114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN445104/index.html">KlipschéŸ³é¢‘å“ç‰Œçš„ç®€è¦å†å²</a></li>
<li><a href="../zh-CN445106/index.html">åœ†æ¡Œä¼šè®®ï¼šæ·»åŠ å‰‚æŠ€æœ¯æ›¿ä»£ä¼ ç»Ÿåˆ¶é€ </a></li>
<li><a href="../zh-CN445108/index.html">ä¸æ˜¯ä¸€ä¸ªçŒé¹°-æ ¹æœ¬ä¸åŒçš„å¯é‡ç”¨ESAå’ŒULAé¡¹ç›®</a></li>
<li><a href="../zh-CN445110/index.html">å…·æœ‰è¾å°„å‹ç»ˆç«¯é©±åŠ¨å™¨çš„è®¡ç®—æœº</a></li>
<li><a href="../zh-CN445112/index.html">æ­ç¤ºç½‘ç«™ä¸Šçš„å„ç§æ¼æ´</a></li>
<li><a href="../zh-CN445116/index.html">ç¾å›½ç©ºå†›æ­£åœ¨ç ”å‘ä¸€ç§åä¸ºSkyborgçš„AIæ— äººæœº</a></li>
<li><a href="../zh-CN445118/index.html">åœ¨ç§äººç”µæŠ¥èŠå¤©ä¸­ï¼Œæ‚¨å¯ä»¥åˆ é™¤ä»»ä½•æ¶ˆæ¯-ç”šè‡³æ˜¯é™Œç”Ÿäººï¼ˆå·²æ·»åŠ æŠ•ç¥¨ç»“æœï¼‰</a></li>
<li><a href="../zh-CN445120/index.html">å‰ç«¯æ¯å‘¨æ‘˜è¦ï¼ˆ2019å¹´3æœˆ18æ—¥è‡³24æ—¥ï¼‰</a></li>
<li><a href="../zh-CN445122/index.html">ä¸Šå‘¨ç¬¬357æœŸï¼ˆ2019å¹´3æœˆ18æ—¥è‡³24æ—¥ï¼‰æ¥è‡ªå‰ç«¯ä¸–ç•Œçš„æ–°é²œææ–™æ‘˜è¦</a></li>
<li><a href="../zh-CN445124/index.html">Firefoxçš„ä¸­ç­‰å¼ºåŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>