<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â˜ ï¸ ğŸ’Š ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦ åŠå…¬å¥—ä»¶LibreOfficeä¸­çš„GOST R 34.10ç”µå­ç­¾åçš„PDFæ–‡æ¡£ ğŸ›„ ğŸ›´ ğŸ•¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å°½ç®¡å‘ç”Ÿäº†å¤§ç« ï¼Œä½†ç°åœ¨æ˜¯å±¥è¡Œæˆ‘ä»¬çš„å…¬æ°‘ä¹‰åŠ¡çš„æ—¶å€™äº†-çº³ç¨ã€‚ æˆ‘ä»¬å°†é€šè¿‡å›½å®¶æœåŠ¡é—¨æˆ·ç½‘ç«™ç¼´ç¨ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ç”µå­ç­¾åï¼ˆState Servicesé—¨æˆ·çš„æœ¯è¯­ ï¼‰è¾“å…¥State Servicesé—¨æˆ·çš„ä¸ªäººå¸æˆ·ï¼Œå³ æ‹¥æœ‰åœ¨è®¤å¯çš„è®¤è¯ä¸­å¿ƒï¼ˆCAï¼‰è·å¾—çš„è¯ä¹¦å’Œç§é’¥ã€‚ æˆ‘å°†å®ƒä»¬éƒ½å­˜å‚¨åœ¨PKCSï¼ƒ11ä»¤ç‰Œä¸­ï¼Œå¹¶æ”¯...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åŠå…¬å¥—ä»¶LibreOfficeä¸­çš„GOST R 34.10ç”µå­ç­¾åçš„PDFæ–‡æ¡£</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428429/"><img src="https://habrastorage.org/webt/ds/ly/0g/dsly0gpk3xho5hfte1ksa3pmprg.png" align="left"> å°½ç®¡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‘ç”Ÿ</a>äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤§ç«</a> ï¼Œä½†ç°åœ¨æ˜¯å±¥è¡Œæˆ‘ä»¬çš„å…¬æ°‘ä¹‰åŠ¡çš„æ—¶å€™äº†-çº³ç¨ã€‚ æˆ‘ä»¬å°†é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å›½å®¶æœåŠ¡</a>é—¨æˆ·ç½‘ç«™ç¼´ç¨ã€‚ æˆ‘ä»¬å°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨</a>ç”µå­ç­¾åï¼ˆState Servicesé—¨æˆ·çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¯è¯­</a> ï¼‰è¾“å…¥State Servicesé—¨æˆ·çš„ä¸ªäººå¸æˆ·ï¼Œå³ æ‹¥æœ‰åœ¨è®¤å¯çš„è®¤è¯ä¸­å¿ƒï¼ˆCAï¼‰è·å¾—çš„è¯ä¹¦å’Œç§é’¥ã€‚ æˆ‘å°†å®ƒä»¬éƒ½å­˜å‚¨åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PKCSï¼ƒ11ä»¤ç‰Œä¸­ï¼Œ</a>å¹¶æ”¯æŒä¿„ç½—æ–¯å¯†ç ï¼š <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/kb/hc/so/kbhcsojl7sh1w4rnu9au8johwje.png"><br><br> å› æ­¤ï¼Œåœ¨å±¥è¡Œäº†æˆ‘çš„å…¬æ°‘èŒè´£ä¹‹åï¼Œæˆ‘å†³å®šå†æ¬¡æ£€æŸ¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.google.ru/url%3Fsa%3Dt%26rct%3Dj%26q%3D%26esrc%3Ds%26source%3Dweb%26cd%3D1%26cad%3Drja%26uact%3D8%26ved%3D2ahUKEwj4kPyNm7HeAhUE_SoKHU-iA7AQFjAAegQIAxAC%26url%3D">libreoffice</a>åŠå…¬å®¤å¥—ä»¶ä¸­ç”µå­ç­¾åçš„è¿è¡Œæƒ…å†µã€‚ <br><br> æˆ‘ä¸ºä»€ä¹ˆå†³å®šè¿™æ ·åšï¼Ÿ è¦è®¿é—®State Servicesé—¨æˆ·ï¼Œæˆ‘ä½¿ç”¨Linuxå’ŒRedfoxæµè§ˆå™¨ï¼Œè¯¥æµè§ˆå™¨æ˜¯Mozilla Firefoxæµè§ˆå™¨ï¼Œä½¿ç”¨ä¿„ç½—æ–¯åŠ å¯†æŠ€æœ¯è¿›è¡Œäº†ä¿®æ”¹ã€‚ å¦‚æ‚¨æ‰€çŸ¥ï¼ŒlibreofficeåŠå…¬å¥—ä»¶è¿˜ä½¿ç”¨NSSå­˜å‚¨ä½œä¸ºè¯ä¹¦å­˜å‚¨ã€‚ <br><br>  Redfox-52æµè§ˆå™¨å®‰è£…åœ¨/ usr / local / lib64 / firefox-52æ–‡ä»¶å¤¹ä¸­ã€‚ <br><br> è¦è¿æ¥æ”¯æŒGOSTç®—æ³•çš„NSSï¼ˆç½‘ç»œå®‰å…¨æœåŠ¡ï¼‰è½¯ä»¶åŒ…çš„åº“ï¼Œè¯·æŒ‰å¦‚ä¸‹æ‰€ç¤ºè®¾ç½®LD_LIBRARY_PATHå˜é‡çš„å€¼ï¼š <br><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$export</span></span> LD_LIBRARY_PATH=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib64/firefox-52:<span class="hljs-variable"><span class="hljs-variable">$LD_LIBRARY_PATH</span></span> $</code> </pre> <br> ä½œä¸ºè¯ä¹¦å­˜å‚¨ï¼Œlibreofficeé€šå¸¸ä½¿ç”¨Firefoxï¼ŒThunderbirdç”µå­é‚®ä»¶å®¢æˆ·ç«¯æˆ–é›†æˆçš„Seamonkeyè½¯ä»¶åŒ…ä¸­çš„è¯ä¹¦å­˜å‚¨ã€‚ æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢æ‚¨ä½¿ç”¨GoogleChrome / Cromiumæµè§ˆå™¨è¯ä¹¦å­˜å‚¨æˆ–åˆ›å»ºè‡ªå·±çš„ç‹¬ç«‹å­˜å‚¨ï¼ˆå·¥å…·-&gt;é€‰é¡¹-&gt;å®‰å…¨-&gt;è¯ä¹¦ï¼‰ï¼š <br><br><img src="https://habrastorage.org/webt/fu/we/8r/fuwe8rrzfjin4gzvntoag8itdfc.png"><br><br> é€‰æ‹©å­˜å‚¨åï¼Œå°†è¿æ¥åº“ï¼Œè¿è¡Œlibreofficeï¼Œåˆ›å»ºä¸€ä¸ªodtæ–‡ä»¶å¹¶å°è¯•å¯¹å…¶è¿›è¡Œç­¾åï¼ˆæ–‡ä»¶-&gt;æ•°å­—ç­¾å-&gt;æ•°å­—ç­¾åï¼‰ã€‚ <br><br>  Firefox / NSSå­˜å‚¨åº“ä¸­çš„è¯ä¹¦å·²æˆåŠŸæ˜¾ç¤ºå’ŒéªŒè¯ï¼š <br><br><img src="https://habrastorage.org/webt/se/ic/bn/seicbnhqivgte6wakn7kym63lck.png"><br><br> ä½†æ˜¯ï¼Œé€‰æ‹©è¯ä¹¦å¹¶æŒ‰â€œç¡®å®šâ€æŒ‰é’®åçš„ç­¾åæœªå½¢æˆï¼š <br><br><img src="https://habrastorage.org/webt/di/l0/id/dil0idhl4l_x4zetlzrdiguxkr8.png"><br><br> çœ‹æ¥libreofficeä¸æƒ³ç†è§£ä¿„ç½—æ–¯çš„åŠ å¯†ç®—æ³•ï¼Œå°½ç®¡äº‹å®æ˜¯Redfoxæµè§ˆå™¨ä½¿ç”¨äº†NSSï¼Œè¯¥æµè§ˆå™¨äº†è§£GOSTç®—æ³•ï¼Œå¹¶é€šè¿‡æˆåŠŸçš„è¯ä¹¦éªŒè¯å¾—åˆ°äº†è¯å®ã€‚ <br><br> æˆ‘ä»¬è¿›è¡Œç¬¬äºŒæ¬¡å°è¯•ï¼šè¿™æ¬¡æˆ‘ä»¬å°†å°è¯•å¯¹PDFæ–‡ä»¶ç­¾åã€‚ ä¸ºæ­¤ï¼Œä»¥PDFæ ¼å¼å¯¼å‡ºå‡†å¤‡çš„æ–‡æ¡£ã€‚ è¦ç­¾ç½²PDFæ–‡ä»¶ï¼Œæ‚¨è‡ªç„¶éœ€è¦ä¸‹è½½å®ƒï¼ˆæ–‡ä»¶-&gt;æ•°å­—ç­¾å-&gt;ç­¾ç½²PDFï¼‰ã€‚ ä¸‹è½½åï¼Œæˆ‘ä»¬å°è¯•å¯¹å…¶è¿›è¡Œç­¾åï¼ˆæ–‡ä»¶-&gt;æ•°å­—ç­¾å-&gt;æ•°å­—ç­¾åï¼‰ï¼ˆè¯·å‚è§ä¸Šæ–‡ï¼Œé€‰æ‹©è¯ä¹¦ï¼ŒæŒ‡å®šä¾‹å¦‚å¯¹æ–‡æ¡£è¿›è¡Œç­¾åçš„ç›®çš„ï¼‰ï¼š <br><br><img src="https://habrastorage.org/webt/s1/eg/wz/s1egwzum3-s8q8krjgljjl8xjo4.png"><br><br> ç­¾åå°±å½¢æˆäº†ï¼ï¼ï¼ æˆ‘ä»¬çœ‹åˆ°ç­¾åæ˜¯åœ¨è¯ä¹¦â€œ Test 12 512â€çš„åŸºç¡€ä¸Šä½¿ç”¨å¯†é’¥GOST R 34.10-2012 512ä½å½¢æˆçš„ã€‚ ç­¾åæ­£ç¡®ã€‚ <br><br> é€€å‡ºlibreofficeã€‚ å†æ¬¡è¿è¡Œlibreofficeï¼ŒåŠ è½½ç­¾åçš„pdfæ–‡ä»¶ï¼Œæ£€æŸ¥ç­¾åã€‚ ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚ æŸ¥çœ‹ç­¾åè€…è¯ä¹¦ã€‚ ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚ å¥‡è¿¹ï¼ ç­¾åPDFå³å¯ã€‚ æˆ‘ä»¬æ”¾ç½®äº†ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªç­¾å...ä¸€åˆ‡æ­£å¸¸ã€‚ ä½†æ˜¯æœ‰äº›äº‹æƒ…å›°æ‰°ç€äººä»¬ã€‚ æˆ‘ä»¬ä¼šè¿›è¡Œé¢å¤–çš„æ£€æŸ¥ã€‚ <br><br> æ‰“å¼€ç­¾åçš„PDFæ–‡ä»¶ï¼ˆæˆ‘ä½¿ç”¨mc-Midnight Commander-Linuxæ§åˆ¶å°æ–‡ä»¶ç®¡ç†å™¨çš„å†…ç½®ç¼–è¾‘å™¨ï¼‰ã€‚ æŸ¥æ‰¾ç”µå­ç­¾åï¼ˆ/ Type / Sig /ï¼‰ï¼š <br><br><img src="https://habrastorage.org/webt/q3/kh/ja/q3khjadn38etedwmwo7jdmiyrhk.png"><br><br> å¦‚æ‚¨æ‰€è§ï¼Œç­¾åä»¥ç¬¦å·åå…­è¿›åˆ¶å½¢å¼å­˜å‚¨ã€‚ æˆ‘ä»¬å°†å…¶å¤åˆ¶å¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚ è¦å°†æ–‡ä»¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼ˆDERç¼–ç ï¼‰ï¼Œæˆ‘ä»¬ä½¿ç”¨xxdå®ç”¨ç¨‹åºï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$xxd</span></span> â€“p â€“r &lt;    PDF&gt; &gt; &lt;&gt;.der $</code> </pre> <br> ç”Ÿæˆçš„æ–‡ä»¶åŒ…å«æ–­å¼€çš„DERç¼–ç çš„PKCSï¼ƒ7æ ¼å¼ç­¾åã€‚ ç°åœ¨ï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•asn1-è¯­å¥æŸ¥çœ‹æ­¤ç­¾åï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨opensslå®ç”¨ç¨‹åºã€‚ ä½†æ˜¯ç”±äºæˆ‘ä»¬æ­£åœ¨è°ˆè®ºNSSè½¯ä»¶åŒ…ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨derdump <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®ç”¨ç¨‹åº</a>æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ppå®ç”¨ç¨‹åº</a> ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$pp</span></span> â€“t p7 â€“u â€“i pkcs7_detach.p7 PKCS <span class="hljs-comment"><span class="hljs-comment">#7 Content Info: PKCS #7 Signed Data: Version: 1 (0x1) Digest Algorithm List: Digest Algorithm (1): SHA-256 Content Information: PKCS #7 Data: &lt;no content&gt; Certificate List: Certificate (1): Data: Version: 3 (0x2) Serial Number: 4107 (0x100b) Signature Algorithm: GOST R 34.10-2012 signature with GOST R 34.11-2012-512 Issuer: "E=ca_12_512@lissi.ru,OGRN=1234567890123,INN=1234 56789012,CN= 12_512,O= 12_512,L=GnuPG  -2012-512,ST= ,C=RU" Validity: Not Before: Sat Sep 08 07:17:56 2018 Not After : Tue Sep 12 07:17:56 2023 Subject: "C=RU,ST= ,CN=  ,SN=,givenName= ,E=xx@xx.ru,L= ,STREET=,INN=123456789012,SNILS=12345678901" Subject Public Key Info: Public Key Algorithm: GOST R 34.10-2012 512 Public Key: . . . Digest Encryption Algorithm: GOST R 34.10-2012 Key 512 Encrypted Digest: 34:9d:6f:37:e6:60:00:ed:fe:ef:f7:96:db:52:66:e1: 47:4c:5d:da:7f:9f:f3:20:50:ac:73:6c:97:db:f9:8d: 43:9b:8f:40:61:99:d3:4b:17:08:b8:34:e3:1e:92:76: b1:0c:dd:37:01:1e:2a:30:45:68:06:af:3d:33:5e:2f: 71:c8:17:b3:a9:8a:6b:2f:78:9e:e4:b2:00:59:6f:5a: a0:c5:9e:be:1e:4b:ca:d5:64:25:50:1a:6f:f9:55:b8: 3a:cf:37:a0:04:eb:89:b4:6c:39:77:27:92:de:61:c7: b1:d3:a5:2f:ef:66:9b:f5:71:42:77:0a:d2:10:7f:50 $</span></span></code> </pre> <br> ç„¶åå¾ˆæ˜æ˜¾ï¼Œå¹¶ä¸æ˜¯ä¸€åˆ‡éƒ½é‚£ä¹ˆå¥½ã€‚ æ˜¯çš„ï¼Œæ‘˜è¦åŠ å¯†ç®—æ³•ï¼šGOST R 34.10-2012å¯†é’¥512ç­¾åç®—æ³•ç¬¦åˆä¸ºç­¾åé€‰æ‹©çš„è¯ä¹¦ï¼Œä½†æ˜¯ç­¾åæ˜¯é€šè¿‡ä½¿ç”¨SHA-256ç®—æ³•è®¡ç®—å‡ºçš„å“ˆå¸Œå€¼ç”Ÿæˆçš„ï¼ˆæ‘˜è¦ç®—æ³•ï¼ˆ1ï¼‰ï¼šSHA-256ï¼‰ã€‚ è¿™ä¸€ç‚¹æ˜¯é”™è¯¯çš„ï¼šåº”æ ¹æ®GOST R 34.11-2012-512ç®—æ³•è€ƒè™‘GOST R 34.10-2012å¯†é’¥512çš„å“ˆå¸Œã€‚ <br><br> è®©æˆ‘ä»¬å¼€å§‹å¯¹libreofficeæºä»£ç çš„åˆ†æï¼šé­”é¬¼å¹¶æ²¡æœ‰è¢«æç»˜å¾—é‚£ä¹ˆå¯æ€•ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨NSSåŒ…æ¥ç”Ÿæˆç”µå­ç­¾åã€‚ å¦‚æœæœ‰äººå–œæ¬¢åœ¨MS Windowså¹³å°ä¸Šä½¿ç”¨CryptoAPIï¼ˆä»¥åŠç›¸åº”çš„GOST-CSPï¼‰ï¼Œå¯ä»¥ç±»ä¼¼äºæ­¤ææ–™ï¼Œè¿›è¡Œç›¸åº”çš„ä¿®è®¢ã€‚ <br><br> åˆ†æè¡¨æ˜ï¼Œåªéœ€åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­è¿›è¡Œæ›´æ”¹ï¼š <br>  <i>-ã€œ/ libreoffice-5.3.7.2 / vcl /æ¥æº/ gdi / pdfwriter_impl.cxx</i> <br>  <i>-ã€œ/ libreoffice-5.3.7.2 / xmlsecurity /æº/ pdfio / pdfdocument.cxx</i> <br><br> è¿™äº›æ›´æ”¹ä¸æ­£ç¡®é€‰æ‹©GOSTè¯ä¹¦çš„å“ˆå¸Œå‡½æ•°æœ‰å…³ã€‚ å“ˆå¸Œå‡½æ•°çš„é€‰æ‹©å°†å–å†³äºè¯ä¹¦å¯†é’¥çš„ç±»å‹ã€‚ ä¾‹å¦‚ï¼Œåœ¨PDFWriter :: Signï¼ˆæ–‡ä»¶pdfwriter_impl.cxxï¼‰ä¸­é€‰æ‹©å“ˆå¸Œç®—æ³•å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> PDFWriter::Sign(PDFSignContext&amp; rContext) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _WIN32 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* */</span></span></span><span class="hljs-meta"> SECKEYPublicKey *pubk = NULL; SECOidTag hashAlgTag; HASH_HashType hashType; int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); if (!cert) { SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } /*    */ pubk = CERT_ExtractPublicKey(cert); if (pubk == NULL) return NULL; /*   */ switch(pubk-&gt;keyType){ case gost3410Key: hashAlgTag = SEC_OID_GOSTHASH; hashType = HASH_AlgGOSTHASH; hashLen = SHA256_LENGTH; break; case gost3410Key_256: hashAlgTag = SEC_OID_GOST3411_2012_256; hashType = HASH_AlgGOSTHASH_12_256; hashLen = SHA256_LENGTH; break; case gost3410Key_512: hashAlgTag = SEC_OID_GOST3411_2012_512; hashLen = SHA256_LENGTH * 2; hashType = HASH_AlgGOSTHASH_12_512; break; default: hashAlgTag = SEC_OID_SHA256; hashType = HASH_AlgSHA256; hashLen = SHA256_LENGTH; break; } /* */ HashContextScope hc(HASH_Create(hashType)); . . . }</span></span></span></span></code> </pre> <br> é€»è¾‘ä¸Šçš„å…¶ä»–æ›´æ”¹ä¸æ­¤ç±»ä¼¼ã€‚ æ‰¾åˆ°ã€œ/ libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxxæ–‡ä»¶çš„è¡¥ä¸ <br><br><div class="spoiler">  <b class="spoiler_title">åœ¨è¿™é‡Œï¼š</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfwriter_impl_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfwriter_impl.cxx 2018-10-31 19:48:32.078482227 +0300 @@ -6698,6 +6698,9 @@ CERTCertificate *cert, SECItem *digest) { + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + NSSCMSMessage *result = NSS_CMSMessage_Create(nullptr); if (!result) { @@ -6732,8 +6735,31 @@ NSS_CMSMessage_Destroy(result); return nullptr; } - + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; +fprintf(stderr, "CreateCMSMessage: gost3410Key Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; +fprintf(stderr, "CreateCMSMessage: gost3410Key_256 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; +fprintf(stderr, "CreateCMSMessage: gost3410Key_512 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + default: + hashAlgTag = SEC_OID_SHA256; + break; + } +/* *cms_signer = NSS_CMSSignerInfo_Create(result, cert, SEC_OID_SHA256); +*/ + *cms_signer = NSS_CMSSignerInfo_Create(result, cert, hashAlgTag); + if (!*cms_signer) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignerInfo_Create failed"); @@ -6773,8 +6799,8 @@ NSS_CMSMessage_Destroy(result); return nullptr; } + if (NSS_CMSSignedData_SetDigestValue(*cms_sd, hashAlgTag, digest) != SECSuccess) - if (NSS_CMSSignedData_SetDigestValue(*cms_sd, SEC_OID_SHA256, digest) != SECSuccess) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignedData_SetDigestValue failed"); NSS_CMSSignedData_Destroy(*cms_sd); @@ -6982,6 +7008,10 @@ bool PDFWriter::Sign(PDFSignContext&amp; rContext) { #ifndef _WIN32 + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + HASH_HashType hashType; + int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); @@ -6990,8 +7020,33 @@ SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; + hashType = HASH_AlgGOSTHASH; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; + hashType = HASH_AlgGOSTHASH_12_256; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; + hashLen = SHA256_LENGTH * 2; + hashType = HASH_AlgGOSTHASH_12_512; + break; + default: + hashAlgTag = SEC_OID_SHA256; + hashType = HASH_AlgSHA256; + hashLen = SHA256_LENGTH; + break; + } + HashContextScope hc(HASH_Create(hashType)); - HashContextScope hc(HASH_Create(HASH_AlgSHA256)); if (!hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7005,15 +7060,18 @@ HASH_Update(hc.get(), static_cast&lt;const unsigned char*&gt;(rContext.m_pByteRange2), rContext.m_nByteRange2); SECItem digest; - unsigned char hash[SHA256_LENGTH]; + unsigned char hash[SHA256_LENGTH * 2]; + digest.data = hash; - HASH_End(hc.get(), digest.data, &amp;digest.len, SHA256_LENGTH); + HASH_End(hc.get(), digest.data, &amp;digest.len, hashLen); + hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.hash.data", "wb"); - fwrite(hash, SHA256_LENGTH, 1, out); + fwrite(hash, hashLen, 1, out); + fclose(out); } #endif @@ -7078,8 +7136,8 @@ fclose(out); } #endif + HashContextScope ts_hc(HASH_Create(hashType)); - HashContextScope ts_hc(HASH_Create(HASH_AlgSHA256)); if (!ts_hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7090,16 +7148,19 @@ HASH_Begin(ts_hc.get()); HASH_Update(ts_hc.get(), ts_cms_signer-&gt;encDigest.data, ts_cms_signer-&gt;encDigest.len); SECItem ts_digest; - unsigned char ts_hash[SHA256_LENGTH]; + unsigned char ts_hash[SHA256_LENGTH * 2]; + ts_digest.type = siBuffer; ts_digest.data = ts_hash; - HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, SHA256_LENGTH); + HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, hashLen); + ts_hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.ts_hash.data", "wb"); - fwrite(ts_hash, SHA256_LENGTH, 1, out); + fwrite(ts_hash, hashLen, 1, out); + fclose(out); } #endif @@ -7111,7 +7172,8 @@ src.messageImprint.hashAlgorithm.algorithm.data = nullptr; src.messageImprint.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, hashAlgTag, nullptr); + src.messageImprint.hashedMessage = ts_digest; src.reqPolicy.type = siBuffer; @@ -7340,11 +7402,13 @@ // Write ESSCertIDv2.hashAlgorithm. aCertID.hashAlgorithm.algorithm.data = nullptr; aCertID.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, hashAlgTag, nullptr); + // Write ESSCertIDv2.certHash. SECItem aCertHashItem; - unsigned char aCertHash[SHA256_LENGTH]; - HashContextScope aCertHashContext(HASH_Create(HASH_AlgSHA256)); + unsigned char aCertHash[SHA256_LENGTH*2]; + HashContextScope aCertHashContext(HASH_Create(hashType)); + if (!aCertHashContext.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create() failed"); @@ -7354,7 +7418,8 @@ HASH_Update(aCertHashContext.get(), reinterpret_cast&lt;const unsigned char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); aCertHashItem.type = siBuffer; aCertHashItem.data = aCertHash; - HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, SHA256_LENGTH); + HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, hashLen); + aCertID.certHash = aCertHashItem; // Write ESSCertIDv2.issuerSerial. IssuerSerial aSerial;</span></span></code> </pre> <br></div></div><br> æ–‡ä»¶ã€œ/ libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxxçš„è¡¥ä¸ä½äº <br><br><div class="spoiler">  <b class="spoiler_title">åœ¨è¿™é‡Œï¼š</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfdocument_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfdocument.cxx 2018-10-31 19:49:34.174485641 +0300 @@ -2400,6 +2400,19 @@ case SEC_OID_PKCS1_SHA512_WITH_RSA_ENCRYPTION: eOidTag = SEC_OID_SHA512; break; + case SEC_OID_GOST3410_SIGN_256: + case SEC_OID_GOST3411_2012_256: + eOidTag = SEC_OID_GOST3411_2012_256; + break; + case SEC_OID_GOST3410_SIGN_512: + case SEC_OID_GOST3411_2012_512: + eOidTag = SEC_OID_GOST3411_2012_512; + break; + case SEC_OID_GOST3410_SIGNATURE: + case SEC_OID_GOSTHASH: + eOidTag = SEC_OID_GOSTHASH; + break; + default: break; } @@ -2453,6 +2466,16 @@ case SEC_OID_SHA512: nMaxResultLen = msfilter::SHA512_HASH_LENGTH; break; + case SEC_OID_GOST3411_2012_256: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + case SEC_OID_GOST3411_2012_512: + nMaxResultLen = msfilter::SHA512_HASH_LENGTH; + break; + case SEC_OID_GOSTHASH: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + default: SAL_WARN("xmlsecurity.pdfio", "PDFDocument::ValidateSignature: unrecognized algorithm"); return false;</span></span></code> </pre> <br></div></div><br> è¿›è¡Œæ›´æ”¹åï¼Œæˆ‘ä»¬æ„å»ºlibreofficeè½¯ä»¶åŒ…ã€‚ æ‰€åšçš„æ›´æ”¹å½±å“äº†ä¸‰ä¸ªåº“ï¼ˆ/ usr / lib64 / libreoffice /ç¨‹åºï¼‰ï¼š <br><br><ul><li>  <i>libvcllo.so</i> ; </li><li>  <i>libxmlsecurity.so</i> ; </li><li>  <i>libxsec-xmlsec.so</i> </li></ul><br> åœ¨å·²å®‰è£…çš„libreofficeå‘è¡Œç‰ˆï¼ˆ/ usr / lib64 / libreoffice /ç¨‹åºï¼‰ä¸­æ›¿æ¢äº†è¿™ä¸‰ä¸ªåº“ã€‚ <br><br> ä¹‹åï¼ŒPDFæ–‡ä»¶ä¸­GOSTç­¾åçš„ç­¾åå’ŒéªŒè¯ä¾¿æ¯«ä¸è´¹åŠ›ã€‚ åœ¨å…¶ä¸­ä¸€ä¸ªç«™ç‚¹ä¸Šï¼Œè¿™æ ·çš„æ‘˜å½•å¼•äººæ³¨ç›®ï¼š <br><blockquote> è”é‚¦ç¨æ”¶æœåŠ¡å±€ï¼ˆFederal Tax Serviceï¼‰å¯ä»¥ä¸ºä»»ä½•æ³•äººæä¾›ä»ç»Ÿä¸€æ³•å¾‹å®ä½“è”åˆå·ç™»è®°ç°¿ä¸­æ‘˜å½•çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¼˜è´¨æœåŠ¡</a> ï¼Œè€Œä¸”ç»å¯¹å…è´¹ã€‚ å¯ä»¥é€šè¿‡ç”±åˆæ ¼çš„ç”µå­ç­¾åç­¾åçš„PDFæ–‡æ¡£çš„å½¢å¼è·å¾—æ‘˜å½•ã€‚ è¿™æ ·çš„æ‘˜å½•å¯ä»¥å‘é€åˆ°å•†ä¸šé“¶è¡Œï¼Œæ”¿åºœæœºæ„ï¼Œè€Œä¸ä¼šä»¥çº¸è´¨å½¢å¼è¦æ±‚æ‚¨ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œéå¸¸èˆ’é€‚ã€‚ </blockquote> æˆ‘ä»¬è®¢è´­ï¼Œæ¥æ”¶å’ŒéªŒè¯ï¼š <br><br><img src="https://habrastorage.org/webt/ye/rt/ul/yertuldamhhmiwc6wmveofj1a60.png"><br><br> å€¼å¾—å›é¡¾çš„æ˜¯ï¼Œæ‚¨ä¸åº”å¿˜è®°åœ¨å­˜å‚¨åº“ä¸­å®‰è£…ç­¾åè¯ä¹¦çš„å¯ä¿¡è¯ä¹¦é“¾ã€‚ ä½†è¿™æ˜¯è‡ªç„¶çš„ã€‚ <br><br> ä»…æ­¤è€Œå·²ï¼Œç°åœ¨å¯ä»¥åœ¨PDFæ–‡ä»¶ä¸­ä½¿ç”¨ç”µå­ç­¾åï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰ã€‚ åè°ƒæ–‡æ¡£å’Œå­˜å‚¨æ–‡æ¡£æ—¶éƒ½éå¸¸æ–¹ä¾¿ã€‚ <br><br> å¦‚æœæœ‰äººä¹ æƒ¯ä½¿ç”¨å·²è¿æ¥å’Œå·²æ–­å¼€è¿æ¥çš„PKCSï¼ƒ7æ ¼å¼çš„ç»å…¸ç”µå­ç­¾åï¼Œåˆ™å·²ç»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‡†å¤‡</a>äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GUINSSPY</a>å›¾å½¢åŒ…çš„æ›´æ–°ç‰ˆæœ¬ï¼ˆé€‚ç”¨äºLinuxå’ŒWindowså¹³å°ï¼‰ï¼š <br><br><img src="https://habrastorage.org/webt/qw/rz/h_/qwrzh_squqc7zzcd0qibmoakuyi.png"><br><br> å¼€å‘æ˜¯ä½¿ç”¨Python3è¿›è¡Œçš„ï¼Œå¦‚æœåœ¨Linuxå¹³å°ä¸Šæ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨MS Windowsä¸Šï¼Œæˆ‘ä¸å¾—ä¸åŠªåŠ›è¿›è¡Œç¼–ç ã€‚ å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªå•ç‹¬çš„å¼€å‘ï¼Œå› æ­¤éœ€è¦å•ç‹¬çš„æ–‡ç« ã€‚ æ‰€æœ‰è¿™äº›ç»†å¾®å·®åˆ«éƒ½å¯ä»¥åœ¨æºä»£ç ä¸­çœ‹åˆ°ã€‚ <br><br> ä½¿ç”¨æ­¤å®ç”¨ç¨‹åºï¼Œæ‚¨å¯ä»¥ä¸ºlibreofficeåˆ›å»ºè¯ä¹¦å­˜å‚¨ï¼Œç®¡ç†è¯ä¹¦ï¼Œç­¾åæ–‡ä»¶ç­‰ï¼š <br><br><img src="https://habrastorage.org/webt/3g/ge/zc/3ggezcie8_pq5mbnpnd_jtz9z14.png"><br><br> è¯¥å®ç”¨ç¨‹åºè¿˜å…è®¸æ‚¨é€šè¿‡ç”Ÿæˆå¯†é’¥å¯¹æ¥åˆ›å»ºè¯ä¹¦è¯·æ±‚ï¼Œç„¶åå¯ä»¥å°†å…¶ä¼ è¾“åˆ°è®¤è¯ä¸­å¿ƒï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„è¯ä¹¦å®‰è£…åœ¨å­˜å‚¨åº“ä¸­ï¼š <br><br><img src="https://habrastorage.org/webt/xh/st/fx/xhstfxznuqdaoqk_rhl2llwthdk.png"><br><br> è€Œä¸”ï¼Œå¦‚æœå®¶ç”¨Linuxåˆ†æ”¯çš„åˆ¶é€ å•†ä¿®æ”¹äº†å„ç§è½¯ä»¶åŒ…ï¼ˆä¾‹å¦‚NSSï¼ŒFirefoxï¼ŒThunderbiirdï¼ŒGnuPG / SMIMEï¼ŒSSHï¼ŒKMailï¼ŒKleopatraï¼ŒLibreOfficeï¼ŒOpenSSLç­‰ï¼‰æ¥ä½¿ç”¨ä¿„ç½—æ–¯åŠ å¯†æŠ€æœ¯ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥è¿™å°†ä¸å¯†ç å­¦é¢†åŸŸä¸­çš„è¿›å£æ›¿ä»£æœ‰å…³ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN428429/">https://habr.com/ru/post/zh-CN428429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN428415/index.html">TP-Link Omada OC200äº‘æ§åˆ¶å™¨æ¦‚è¿°</a></li>
<li><a href="../zh-CN428417/index.html">MatLab / Octaveä¸­çš„æœºå™¨å­¦ä¹ ï¼šå…¬å¼æ”¯æŒçš„ç®—æ³•ç¤ºä¾‹</a></li>
<li><a href="../zh-CN428419/index.html">åœ¨RecyclerViewä¸­æ‹–æ”¾ã€‚ ç¬¬2éƒ¨åˆ†ï¼šæ‹–æ”¾æ§åˆ¶å™¨ï¼Œç½‘æ ¼å’Œè‡ªå®šä¹‰åŠ¨ç”»</a></li>
<li><a href="../zh-CN428421/index.html">ä»¥LLVMæµ‹è¯•å¥—ä»¶ä¸ºä¾‹ï¼Œç”¨äºæµ‹è¯•å’Œæ”¶é›†ç¨‹åºæŒ‡æ ‡çš„çµæ´»ç³»ç»Ÿ</a></li>
<li><a href="../zh-CN428423/index.html">ä¸“å®¶å’Œåˆ†æå¸ˆï¼šIBMä¸çº¢å¸½ä¹‹é—´çš„340äº¿ç¾å…ƒäº¤æ˜“å°†å¦‚ä½•æ”¹å˜ITå¸‚åœº</a></li>
<li><a href="../zh-CN428431/index.html">ä¸åªæ˜¯åŒå¿ƒå±‚</a></li>
<li><a href="../zh-CN428433/index.html">ç§äººæµ‹è¯•å¾‹å¸ˆ</a></li>
<li><a href="../zh-CN428435/index.html">åœ¨PHPä¸­ç”¨ä¿„è¯­è¯»ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="../zh-CN428437/index.html">è‹¹æœé’±åŒ… è¿™æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•å°†æ‚¨çš„å¡é›†æˆåˆ°å…¶ä¸­</a></li>
<li><a href="../zh-CN428439/index.html">æ²¡æœ‰åˆå¥</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>