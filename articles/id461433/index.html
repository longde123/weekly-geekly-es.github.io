<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé§ üë©üèΩ‚Äçü§ù‚Äçüë®üèæ üë∂üèº Menggunakan Identity Server 4 di Net Core 3.0 üöÄ üñ≤Ô∏è ü§∂üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendahuluan 


 Salah satu proyek saya yang didukung baru-baru ini menghadapi tugas menganalisis kemungkinan migrasi dari .NET framework 4.5 ke .Net C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menggunakan Identity Server 4 di Net Core 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie">  Pendahuluan </h2><br><p>  Salah satu proyek saya yang didukung baru-baru ini menghadapi tugas menganalisis kemungkinan migrasi dari .NET framework 4.5 ke .Net Core jika perlu untuk melakukan refactoring dan mengumpulkan sejumlah besar hutang teknis yang terakumulasi.  Pilihan jatuh pada platform target .NET Core 3.0, karena, menurut pengembang Microsoft, dengan merilis versi 3.0, langkah-langkah yang diperlukan untuk memigrasi kode legacy akan berkurang beberapa kali.  Terutama kami tertarik padanya oleh rencana keluar untuk EntityFramework 6.3 untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">.Net Core</a> i.e.  sebagian besar kode berdasarkan EF 6.2 dapat dibiarkan "apa adanya" dalam proyek bermigrasi pada inti bersih. </p><br><p>  Dengan tingkat data, tampaknya, menjadi jelas, namun, bagian besar lain dari porting kode adalah tingkat keamanan, yang, sayangnya, setelah audit cepat, Anda harus membuangnya dan menulis ulang dari awal.  Untungnya, proyek sudah menggunakan bagian dari ASP NET Identity, dalam bentuk menyimpan pengguna dan "sepeda" lain yang melekat di samping. </p><br><p>  Ini menimbulkan pertanyaan logis: jika bagian keamanan harus membuat banyak perubahan, mengapa tidak segera menerapkan pendekatan yang direkomendasikan dalam bentuk standar industri, yaitu: membawa aplikasi untuk menggunakan koneksi Open Id dan OAuth melalui kerangka kerja <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">IdentityServer4</a> . </p><a name="habracut"></a><br><h2 id="problemy-i-puti-resheniya">  Masalah dan solusi </h2><br><p>  Jadi, kami telah diberi: ada aplikasi JavaScript dalam Angular (Klien dalam istilah IS4), ia menggunakan subset tertentu dari WebAPI (Sumber), ada juga database ASP NET Identity yang sudah usang dengan login pengguna yang harus digunakan kembali setelah pembaruan (agar tidak memulai yang lain) kali), plus dalam beberapa kasus perlu memberikan kesempatan untuk masuk ke sistem melalui otentikasi Windows di sisi IdentityServer4.  Yaitu  Ada kalanya pengguna bekerja melalui jaringan area lokal di domain ActiveDirectory. </p><br><p>  Solusi utama untuk memigrasi data pengguna adalah dengan menulis secara manual (atau menggunakan alat otomatis) skrip migrasi antara skema data lama dan baru.  Kami, pada gilirannya, menggunakan aplikasi perbandingan skema data otomatis dan menghasilkan skrip SQL, tergantung pada versi Identitas, skrip migrasi target akan berisi petunjuk pembaruan yang berbeda.  Hal utama di sini adalah jangan lupa untuk mengoordinasikan tabel EFMigrationsHistory, jika EF digunakan sebelumnya dan direncanakan di masa depan, misalnya, untuk memperluas entitas IdentityUser ke bidang tambahan. </p><br><p>  Tetapi sekarang bagaimana mengkonfigurasi dengan benar IdentityServer4 dan mengkonfigurasinya bersama dengan akun Windows akan dijelaskan di bawah ini. </p><br><h2 id="plan-realizacii">  Rencana implementasi </h2><br><p>  Untuk alasan NDA, saya tidak akan menjelaskan bagaimana kami berhasil menerapkan IS4 di proyek kami, namun, dalam artikel ini saya akan menunjukkan kepada Anda di situs ASP.NET Core sederhana yang dibuat dari awal langkah apa yang perlu Anda ambil untuk mendapatkan aplikasi yang sepenuhnya terkonfigurasi dan berfungsi. yang menggunakan IdentityServer4 untuk keperluan otorisasi dan otentikasi. <br>  Untuk mewujudkan perilaku yang diinginkan, kita harus mengambil langkah-langkah berikut: </p><br><ul><li>  Buat proyek ASP.Net Core kosong dan konfigurasikan untuk menggunakan IdentityServer4. </li><li>  Tambahkan klien sebagai aplikasi Angular. </li><li>  Masuk melalui google open-id-connect </li><li>  Tambahkan Opsi Otentikasi Windows </li></ul><br><p>  Untuk alasan singkatnya, ketiga komponen (IdentityServer, WebAPI, klien Angular) akan berada di proyek yang sama.  Jenis interaksi yang dipilih antara klien dan IdentityServer (GrantType) adalah aliran implisit, ketika access_token dilewatkan ke sisi aplikasi di browser, dan kemudian digunakan untuk berinteraksi dengan WebAPI.  <em>Lebih dekat dengan rilis, dilihat dari perubahan dalam repositori Core ASP.NET, aliran implisit akan digantikan oleh Kode Otorisasi + PKCE.)</em> </p><br><p>  Dalam proses membuat dan memodifikasi aplikasi, antarmuka baris perintah .NET Core akan banyak digunakan, itu harus diinstal pada sistem di tempat dengan versi terbaru dari pratinjau Core 3.0 (pada saat penulisan artikel 3.0.100-preview7-012821). </p><br><h2 id="sozdanie-i-konfigurirovanie-web-proekta">  Pembuatan dan konfigurasi proyek web </h2><br><p>  Rilis IdentityServer versi 4 ditandai dengan pemotongan lengkap UI dari kerangka ini.  Sekarang pengembang memiliki hak penuh untuk menentukan antarmuka utama dari server otorisasi itu sendiri.  Ada beberapa cara.  Salah satu yang populer adalah menggunakan UI dari paket QuickStart UI, yang dapat ditemukan di repositori resmi di <a href="">github</a> . </p><br><p>  Cara lain, yang tidak kalah nyaman, adalah integrasi dengan ASP NET Core Identity UI, dalam hal ini, pengembang perlu mengkonfigurasi middleware yang sesuai dalam proyek.  Metode ini akan dijelaskan nanti. </p><br><p>  Mari kita mulai dengan membuat proyek web sederhana Untuk melakukannya, jalankan instruksi berikut pada baris perintah: </p><br><pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code> </pre> <br><p>  Setelah eksekusi, output akan menjadi kerangka kerja aplikasi web, yang secara bertahap akan dibawa ke keadaan yang kita butuhkan.  Di sini Anda perlu membuat reservasi .Net Core 3.0 untuk Identity menggunakan RazorPages yang lebih ringan, tidak seperti MVC kelas berat. <br>  Sekarang Anda perlu menambahkan dukungan IdentityServer ke proyek kami.  Untuk melakukan ini, instal paket yang diperlukan: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6 dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code> </pre> <br><p>  Selain tautan ke paket server otorisasi, di sini kami telah menambahkan dukungan Kerangka Entitas untuk menyimpan informasi pengguna di ekosistem Identity.  Untuk mempermudah, kami akan menggunakan database SQLite. </p><br><p>  Untuk menginisialisasi basis data, buat model pengguna dan konteks basis data kami, untuk ini kami mendeklarasikan dua kelas ApplicationUser, yang diwarisi dari <em>IdentityUser</em> di folder Models dan <em>ApplicationDbContext</em> , diwarisi dari: <em>ApiAuthorizationDbContext di folder Data.</em> <br></p><p>  Selanjutnya, Anda perlu mengonfigurasi penggunaan konteks EntityFramework dan membuat database.  Untuk melakukan ini, kita menulis konteks ke dalam metode <em>ConfigureServices</em> dari kelas Startup: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddRazorPages(); }</code> </pre> <br><p>  Dan tambahkan string koneksi ke <em>appsettings.json</em> </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data Source=data.db"</span></span> },</code> </pre><br><p>  Sekarang Anda dapat membuat migrasi awal dan menginisialisasi skema database.  Perlu dicatat bahwa alat yang diinstal untuk ef core diperlukan (untuk pratinjau yang dimaksud, versi 3.0.0-preview7.19362.6 diperlukan). </p><br><pre> <code class="plaintext hljs">dotnet ef migrations add Init dotnet ef database update</code> </pre> <br><p>  Jika semua langkah sebelumnya selesai tanpa kesalahan, file data.dite SQLite data akan muncul di proyek Anda. </p><br><p>  Pada tahap ini, kita dapat sepenuhnya mengkonfigurasi dan menguji kemampuan penuh untuk menggunakan Asp.Net Core Identity.  Untuk melakukan ini, buat perubahan pada metode <em>Startup.</em>  <em>Konfigurasikan</em> dan <em>Mulai</em> . <em>Mengkonfigurasi Layanan</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddDefaultIdentity&lt;ApplicationUser&gt;() .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); //Startup. Configure: app.UseAuthentication(); app.UseAuthorization(); app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); });</span></span></code> </pre> <br><p>  Dengan baris-baris ini, kami menanamkan kemungkinan otentikasi dan otorisasi dalam pipa pemrosesan permintaan.  Dan juga menambahkan antarmuka pengguna default untuk Identity. <br>  Tetap hanya untuk memperbaiki UI, tambahkan ke Halaman \ Berbagi tampilan Razor baru dengan nama <em>_LoginPartial.cshtml</em> dan konten berikut: </p><br><pre> <code class="html hljs xml">@using IdentityServer4WebApp.Models @using Microsoft.AspNetCore.Identity @inject SignInManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> SignInManager @inject UserManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> UserManager <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (SignInManager.IsSignedIn(User)) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Manage/Index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Manage"</span></span></span><span class="hljs-tag">&gt;</span></span>Hello @User.Identity.Name!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Logout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-route-returnUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link btn btn-link text-dark"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } else { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Register"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Kode presentasi di atas harus menambahkan tautan ke area antarmuka Identity dengan kontrol pengguna bawaan di panel navigasi (login dan kata sandi, pendaftaran, dll.) </p><br><p>  Untuk mencapai rendering item menu baru, kami cukup <em>memodifikasi</em> file <em>_Layout.cshtml</em> dengan menambahkan rendering tampilan parsial ini. </p><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Index"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Privacy"</span></span></span><span class="hljs-tag">&gt;</span></span>Privacy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">partial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_LoginPartial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!‚Äì‚Äì‚Äì‚Äì</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Dan sekarang mari kita coba jalankan aplikasi kita dan klik tautan yang muncul di kepala <br>  menu, pengguna harus melihat halaman dengan sambutan dan permintaan <br>  masukkan login dan kata sandi.  Dalam hal ini, Anda dapat mendaftar dan masuk - semua <br>  harus bekerja. </p><br><p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br><p>  Pengembang IdentityServer4 telah melakukan pekerjaan yang sangat baik untuk meningkatkan integrasi ASP.NET Identity dan kerangka kerja server itu sendiri.  Untuk menambahkan kemampuan untuk menggunakan token OAuth2, Anda perlu melengkapi proyek kami dengan beberapa instruksi baru dalam kode. </p><br><p>  Di baris kedua dari metode <em>Startup.ConfigureServices,</em> tambahkan konfigurasi konvensi IS4 melalui ASP.NET Core Identity: </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code> </pre> <br><p>  Metode AddApiAuthorization memerintahkan kerangka kerja untuk menggunakan konfigurasi spesifik yang didukung, terutama melalui file appsettings.json.  Saat ini, kemampuan manajemen IS4 bawaan tidak begitu fleksibel dan harus dianggap sebagai titik awal untuk membangun aplikasi Anda.  Dalam kasus apa pun, Anda dapat menggunakan versi kelebihan metode ini dan mengonfigurasi parameter lebih detail melalui panggilan balik. </p><br><p>  Selanjutnya, kita memanggil metode helper, yang mengkonfigurasi aplikasi untuk memeriksa token JWT yang dikeluarkan oleh framework. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddIdentityServerJwt();</code> </pre> <br><p>  Akhirnya, dalam metode <em>Startup.Configure,</em> tambahkan middleware untuk <br>  Menyediakan Open ID Connect Endpoints </p><br><pre> <code class="cs hljs">app.UseAuthentication(); app.UseAuthorization(); app.UseIdentityServer();<span class="hljs-comment"><span class="hljs-comment">//&lt;-</span></span></code> </pre> <br><p>  Seperti disebutkan di atas, metode pembantu yang digunakan membaca konfigurasi di <br>  file pengaturan aplikasi <em>appsettings.json</em> , di mana kita harus menambahkan yang baru <br>  Bagian <em>IdentityServer</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Clients"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"TestIdentityAngular"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Profile"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServerSPA"</span></span> } } }</code> </pre> <br><p>  Di bagian ini, klien didefinisikan dengan nama TestIdentityAngular, yang akan kami tetapkan untuk klien browser masa depan dan profil konfigurasi tertentu. </p><br><p>  Profil Aplikasi adalah alat konfigurasi IdentityServer baru yang menyediakan beberapa konfigurasi standar dengan kemampuan untuk memperbaiki parameter tertentu.  Kami akan menggunakan profil <em>IdentityServerSPA</em> , yang dirancang untuk kasus-kasus ketika klien browser dan kerangka kerja berada di proyek yang sama dan memiliki parameter berikut: </p><br><ul><li>  Sumber daya redirect_uri diatur ke <em>/ otentikasi / login-panggilan balik</em> . </li><li>  Resource post_logout_redirect_uri, atur ke <em>/ otentikasi / logout-panggilan balik.</em> </li><li>  Seperangkat area termasuk openid, profil, untuk setiap sumber daya aplikasi API. </li><li>  Kumpulan tipe respons OIDC yang diizinkan - token id_token </li><li>  GrantType untuk klien - Tersirat </li></ul><br><p>  Kemungkinan profil lainnya adalah <em>SPA</em> (aplikasi tanpa IS4), <em>IdentityServerJwt</em> (API dibagikan dengan IS4), <em>API</em> (API terpisah). </p><br><p>  Selain itu, konfigurasi mendaftarkan sumber daya: </p><br><ul><li>  ApiResources: satu sumber daya API bernama &lt;&lt; appname &gt;&gt; API dengan properti untuk semua klien (*). </li><li>  IdentityServerResources: <em>IdentityResources.OpenId ()</em> dan <em>IdentityResources.Profile ()</em> </li></ul><br><p>  Seperti yang Anda ketahui, IdentityServer menggunakan sertifikat untuk menandatangani token, parameternya juga dapat diatur dalam file konfigurasi, jadi pada saat pengujian kami dapat menggunakan <br>  sertifikat uji x509, untuk ini Anda perlu menentukannya di bagian "Kunci" pada file <em>appsettings.Development.json</em> . </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }</code> </pre> <br><p>  Sekarang kita dapat mengatakan bahwa backend yang memungkinkan Anda untuk menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">IdentityServer sudah siap</a> dan Anda dapat mulai menerapkan aplikasi browser. </p><br><h2 id="realizaciya-klienta-na-angular">  Implementasi klien sudut </h2><br><p>  SPA berbasis browser kami akan ditulis pada platform Angular.  Aplikasi akan berisi dua halaman, satu untuk pengguna yang tidak sah dan yang lainnya untuk pengguna yang diautentikasi.  Contohnya menggunakan versi 8.1.2 </p><br><p>  Pertama, buat kerangka kerja masa depan: </p><br><pre> <code class="plaintext hljs">ng new ClientApp</code> </pre> <br><p>  Dalam proses pembuatan Anda perlu menjawab "ya" pada proposal untuk menggunakan perutean.  Dan sedikit menyesuaikan dgn mode halaman melalui pustaka bootstrap: </p><br><pre> <code class="plaintext hljs">cd ClientApp ng add bootstrap</code> </pre> <br><p>  Selanjutnya, Anda perlu menambahkan dukungan hosting SPA ke aplikasi utama kami.  Pertama, Anda perlu memperbaiki proyek csproj - tambahkan informasi tentang aplikasi browser kami. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span>Latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span>ClientApp\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Exclude</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)node_modules\**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DebugEnsureNodeEnv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node --version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContinueOnError</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExitCode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorCode"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ErrorCode)' != '0'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WorkingDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"npm install"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p>  Setelah itu, instal paket nuget khusus untuk mendukung aplikasi browser. </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Dan kami menggunakan metode bantu: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup. ConfigureServices: services.AddSpaStaticFiles(configuration =&gt; { configuration.RootPath = "ClientApp/dist"; }); //Startup. Configure: app.UseSpa(spa =&gt; { spa.Options.SourcePath = "ClientApp"; if (env.IsDevelopment()) { spa.UseAngularCliServer(npmScript: "start"); } });</span></span></code> </pre><br><p>  Selain memanggil metode baru, Anda harus menghapus halaman Razor <em>Index.chtml</em> dan <em>_ViewStart.chtml</em> sehingga layanan SPA sekarang menyediakan konten. </p><br><p>  Jika semuanya dilakukan sesuai dengan instruksi, ketika aplikasi dimulai, halaman default akan muncul di layar. </p><br><p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br><p>  Sekarang Anda perlu mengkonfigurasi routing, untuk ini kami tambahkan ke proyek 2 <br>  komponen: </p><br><pre> <code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true ng generate component Data -t=true -s=true --skipTests=true</code> </pre> <br><p>  Kami menulisnya di tabel routing: </p><br><pre> <code class="plaintext hljs">const routes: Routes = [ { path: '', component: HomeComponent, pathMatch: 'full' }, { path: 'data', component: DataComponent } ];</code> </pre> <br><p>  Dan kami memodifikasi file app.component.html untuk menampilkan item menu dengan benar. </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Client App<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ngClass</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{"show": isExpanded}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActiveOptions</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{ exact: true }'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/data"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Web api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align:center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"router-outlet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Pada langkah ini, Anda dapat menyelesaikan persiapan dasar kerangka kerja aplikasi untuk menerapkan interaksi melalui token yang dikeluarkan oleh IdentityServer. </p><br><p>  Tahap persiapan kerangka SPA saat ini dapat disebut selesai dan sekarang kita harus mulai mengimplementasikan modul yang bertanggung jawab untuk berinteraksi dengan bagian server menggunakan protokol OpenID Connect dan OAuth.  Untungnya, pengembang dari Microsoft telah menerapkan kode seperti itu, dan sekarang Anda dapat meminjam modul ini dari mereka.  Karena artikel saya ditulis berdasarkan ASP.NET Core 3.0 pra-rilis 7, kami akan mengambil semua kode menggunakan tag rilis "v3.0.0-preview7.19365.7" di <a href="">github</a> . </p><br><p>  Sebelum mengimpor kode, Anda harus menginstal <em>pustaka oidc-client</em> , yang <br>  menyediakan banyak antarmuka untuk aplikasi browser, dan juga <br>  mendukung manajemen sesi pengguna dan token akses.  Untuk <br>  Untuk mulai bekerja dengannya, Anda perlu menginstal paket yang sesuai. </p><br><pre> <code class="plaintext hljs">npm install oidc-client@1.8.0</code> </pre> <br><p>  Sekarang di SPA kami perlu untuk mengimplementasikan modul yang merangkum interaksi penuh sesuai dengan protokol yang diperlukan.  Untuk melakukan ini, Anda perlu mengambil seluruh modul ApiAuthorizationModule dari label repositori Core ASP.NET di atas dan menambahkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">semua file-nya</a> ke aplikasi. </p><br><p>  Selain itu, Anda harus mengimpornya ke modul utama aplikasi AppModule: </p><br><pre> <code class="plaintext hljs">@NgModule({ declarations: [ AppComponent, HomeComponent, DataComponent ], imports: [ BrowserModule, HttpClientModule, ApiAuthorizationModule,//&lt;- AppRoutingModule ], providers: [], bootstrap: [AppComponent] }) export class AppModule { }</code> </pre> <br><p>  Untuk menampilkan item menu baru dalam modul yang diimpor, ada komponen <em>menu aplikasi-masuk</em> , <br>  itu dapat sepenuhnya diubah sesuai dengan kebutuhan Anda dan menambahkan <br>  tautan ke sana di bagian navigasi <em>tampilan app.component.html</em> . </p><br><p>  Modul otorisasi API untuk mengonfigurasi koneksi OpenID dari klien SPA harus menggunakan titik akhir khusus di backend aplikasi, untuk implementasinya kami <br>  harus mengikuti langkah-langkah ini: </p><br><ol><li>  Perbaiki ID klien sesuai dengan apa yang kami atur di file konfigurasi appsettings.json di bagian IdentityServer: Klien, dalam kasus kami itu adalah TestIdentityAngular, ditulis di baris pertama api-authorization.constants.ts set konstan. </li><li>  Tambahkan pengontrol OidcConfigurationController yang secara langsung akan mengembalikan konfigurasi ke aplikasi browser </li></ol><br><p>  Kode controller yang dibuat disajikan di bawah ini: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OidcConfigurationController</span></span>: <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IClientRequestParametersProvider _clientRequestParametersProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OidcConfigurationController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span></span></span><span class="hljs-function">)</span></span> { _clientRequestParametersProvider = clientRequestParametersProvider; } [HttpGet(<span class="hljs-string"><span class="hljs-string">"_configuration/{clientId}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientRequestParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromRoute]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(parameters); } }</code> </pre> <br><p>  Anda juga perlu mengonfigurasi dukungan API titik untuk aplikasi backend. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddControllers();//&lt;-  services.AddRazorPages(); //Startup. Configure: app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); endpoints.MapControllers(); });</span></span></code> </pre><br><p>  Sekarang saatnya untuk meluncurkan aplikasi.  Dua item akan muncul di halaman utama di menu atas - <em>Masuk</em> dan <em>Daftar</em> .  Juga, pada saat startup, modul otorisasi yang diimpor akan meminta dari sisi server konfigurasi klien, yang selanjutnya akan diperhitungkan dalam protokol.  Contoh output konfigurasi ditunjukkan di bawah ini: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authority"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"TestIdentityAngular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"post_logout_redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"response_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_token token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span></span> }</code> </pre> <br><p>  Seperti yang Anda lihat, klien selama interaksi mengharapkan untuk menerima token id dan token akses, dan itu juga dikonfigurasi untuk area akses ke API kami. </p><br><p>  Sekarang, jika kita memilih item menu <em>Login</em> , kita harus diarahkan ke halaman IdentityServer4 kita dan di sini kita dapat memasukkan login dan kata sandi, dan jika mereka benar, kita akan segera ditransfer kembali ke aplikasi browser, yang pada gilirannya akan menerima <em>id_token</em> dan <em>access_token</em> .  Seperti yang Anda lihat di bawah ini, komponen menu-masuk-aplikasi itu sendiri menentukan bahwa otorisasi selesai dengan sukses dan menampilkan "ucapan", serta tombol untuk <em>Keluar</em> . </p><br><p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br><p>  Saat Anda membuka "alat pengembang" di browser, Anda dapat melihat di belakang panggung semua interaksi menggunakan protokol OIDC / OAuth.  Ini mendapatkan informasi server otorisasi <br>  melalui endpoint. <em>dikenal dengan baik / konfigurasi openid</em> dan aktivitas sesi penyatuan melalui titik akses koneksi / pemeriksaan.  Selain itu, modul otorisasi dikonfigurasi untuk mekanisme "pembaruan diam token", ketika ketika token akses berakhir, sistem secara independen melewati langkah-langkah otorisasi dalam iframe tersembunyi.  Anda dapat menonaktifkan token pembaruan otomatis dengan menetapkan nilai parameter <em>includeIdTokenInSilentRenew</em> menjadi ‚Äúfalse‚Äù di file <em>authorize.service.ts</em> . </p><br><p>  Sekarang Anda dapat berurusan dengan membatasi akses ke pengguna yang tidak sah dari komponen aplikasi SPA, serta beberapa pengontrol API di bagian belakang.  Untuk mendemonstrasikan beberapa API, kami akan membuat kelas <em>ExchangeRateItem</em> di folder Models <em>,</em> serta pengontrol di folder Controller yang mengembalikan beberapa data acak. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Controller: [ApiController] public class ExchangeRateController { private static readonly string[] Currencies = new[] { "EUR", "USD", "BGN", "AUD", "CNY", "TWD", "NZD", "TND", "UAH", "UYU", "MAD" }; [HttpGet("api/rates")] public IEnumerable&lt;ExchangeRateItem&gt; Get() { var rng = new Random(); return Enumerable.Range(1, 5).Select(index =&gt; new ExchangeRateItem { FromCurrency = "RUR", ToCurrency = Currencies[rng.Next(Currencies.Length)], Value = Math.Round(1.0+ 1.0/rng.Next(1, 100),2) }) .ToArray(); } } //Models: public class ExchangeRateItem { public string FromCurrency { get; set; } public string ToCurrency { get; set; } public double Value { get; set; } }</span></span></code> </pre><br><p>  Selanjutnya, di sisi front-end, buat komponen baru yang akan menerima <br>  dan menampilkan data pada nilai tukar dari pengontrol yang baru saja dibuat. </p><br><pre> <code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code> </pre> <br><p>  Konten komponen akan terlihat seperti ini: </p><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core'; import { HttpClient } from '@angular/common/http'; import { Observable, of, Subject } from 'rxjs'; import { catchError } from 'rxjs/operators'; @Component({ selector: 'app-exchange-rate', template: ` &lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt; {{msg}} &lt;/div&gt; &lt;table class='table table-striped'&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;From currency&lt;/th&gt; &lt;th&gt;To currency&lt;/th&gt; &lt;th&gt;Rate&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr *ngFor="let rate of rates | async"&gt; &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt; &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt; &lt;td&gt;{{ rate.value }}&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/table&gt; `, styles: [] }) export class ExchangeRateComponent implements OnInit { public rates: Observable&lt;ExchangeRateItem[]&gt;; public errorMessage: Subject&lt;string&gt;; @Input() public apiUrl: string; constructor(private http: HttpClient) { this.errorMessage = new Subject&lt;string&gt;(); } ngOnInit() { this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) ); } private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; { return (error) =&gt; { let message = ''; if (error.error instanceof ErrorEvent) { message = `Error: ${error.error.message}`; } else { message = `Error Code: ${error.status}\nMessage: ${error.message}`; } subject.next(message); let emptyResult: ExchangeRateItem[] = []; return of(emptyResult); } } } interface ExchangeRateItem { fromCurrency: string; toCurrency: string; value: number; }</code> </pre> </div></div><br><p>  Sekarang tinggal menggunakannya pada halaman aplikasi-data, cukup di template dengan menulis baris &lt;app-exchange-rate apiUrl = "rates"&gt; &lt;/app-exchange-rate&gt; dan Anda dapat memulai proyek lagi.  Saat kita menavigasi di sepanjang jalur target, kita akan melihat bahwa komponen menerima data dan menampilkannya dalam sebuah tabel. </p><br><p>  Selanjutnya, kami akan mencoba menambahkan permintaan untuk otorisasi akses ke API pengontrol. Untuk melakukan ini, tambahkan atribut <em>[Otorisasi]</em> untuk kelas <em>ExchangeRateController</em> dan jalankan SPA lagi, namun, setelah kami kembali ke komponen yang memanggil API kami, kami akan melihat kesalahan, menunjukkan tajuk otorisasi. </p><br><p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br><p>  Untuk menambahkan token otorisasi dengan benar ke permintaan keluar, Anda bisa <br>  Libatkan mekanisme pencegat Angular Interceptors.  Untungnya, modul yang diimpor sudah berisi jenis yang diperlukan, kita hanya perlu mendaftarkannya di modul dasar aplikasi. </p><br><pre> <code class="plaintext hljs">providers: [ { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true } ],</code> </pre> <br><p>  Setelah langkah-langkah ini, semuanya akan berjalan dengan benar.  Jika Anda melihat alat pengembang lagi, browser akan melihat header otorisasi akses_token Bearer yang baru.  Di backend, token ini akan divalidasi oleh IdentityServer dan juga akan memberikan izin untuk memanggil titik API yang aman. </p><br><p>  Pada akhir contoh integrasi dengan server otorisasi, Anda dapat menempatkan Penjaga Aktivasi pada rute dengan data nilai tukar di SPA, itu akan mencegah pengguna beralih ke halaman jika mereka saat ini tidak diotorisasi.  Pelindung ini juga disajikan dalam modul yang diimpor sebelumnya, Anda hanya perlu menggantungnya di rute target. </p><br><pre> <code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard] }</code> </pre> <br><p>  Sekarang, dalam kasus ketika pengguna belum masuk ke aplikasi dan memilih tautan ke komponen kami yang dilindungi, ia akan segera dialihkan ke halaman otorisasi dengan permintaan untuk memasukkan nama pengguna dan kata sandi.  Kode yang dihasilkan tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github</a> . </p><br><h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google">  Menghubungkan login eksternal melalui penyedia Google </h2><br><p>  Ada paket Microsoft.AspNetCore.Authentication.Google Nuget terpisah untuk menghubungkan login melalui akun Google untuk ASP.NET core 1.1 / 2.0 +, namun, karena perubahan kebijakan perusahaan itu sendiri, Microsoft memiliki rencana untuk ASP.NET Core 3.0+ mengenalinya sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">usang</a> .  Dan sekarang dianjurkan untuk terhubung melalui metode tambahan <em>OpenIdConnectExtensions</em> dan <em>AddOpenIdConnect</em> , yang akan kita gunakan dalam artikel ini. </p><br><p>  Instal ekstensi OpenIdConnect: </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code> </pre> <br><p>  Untuk memulai, kita perlu mendapatkan dua nilai utama dari Google - Klien Id dan Rahasia Klien, untuk ini diusulkan untuk melakukan langkah-langkah berikut: </p><br><ul><li>  Ikuti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> dan pilih tombol "CONFIGURE A PROJECT". </li><li>  Dalam dialog yang muncul, tentukan server Web. </li><li>     ¬´Authorized redirect URI¬ª           Google (..      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://localhost:44301/</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://localhost:44301/signin-google</a> ) </li><li>      ClientID  Client Secret. </li><li>         ,   ,   URL    . </li></ul><br><p>         <a href="">Secret Manager</a> .       ,    . </p><br><pre> <code class="plaintext hljs">dotnet user-secrets init dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID" dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code> </pre> <br><p>           Google. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddOpenIdConnect(<span class="hljs-string"><span class="hljs-string">"Google"</span></span>, <span class="hljs-string"><span class="hljs-string">"Google"</span></span>, o =&gt; { IConfigurationSection googleAuthNSection = Configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"Authentication:Google"</span></span>); o.ClientId = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientId"</span></span>]; o.ClientSecret = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientSecret"</span></span>]; o.Authority = <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com"</span></span>; o.ResponseType = OpenIdConnectResponseType.Code; o.CallbackPath = <span class="hljs-string"><span class="hljs-string">"/signin-google"</span></span>; }) .AddIdentityServerJwt();</code> </pre> <br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a>     ,    <br>      Google.     ,    ,       SPA          . </p><br><p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br><p>  ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> . </p><br><h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">      Windows </h2><br><p>   ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em> .  ,  IS4    ,        ,    <br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github</a> . ,             ASP.NET Core Identity 3.0. </p><br><p>          Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ): </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code> </pre> <br><p>    ,     Area   <em>Identity</em>    ,          . </p><br><p>         ,       .   ,  Identity      I <em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   : </p><br><pre> <code class="cs hljs">ExternalLogins = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList(); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt; &gt;&gt; ExternalLogins =(await _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != null ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</span></span></code> </pre> <br><p>         <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em> .    View         <em>Login.cshtml</em> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @provider.DisplayName account"</span></span></span><span class="hljs-tag">&gt;</span></span>@provider.DisplayName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;&lt; &gt;</span></span>&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span></span></span><span class="hljs-tag">&gt;</span></span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  ,  windows      <em>launchSettings.json</em> <br> (   IIS,       <em>web.config</em> ). </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:15479"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">44301</span></span> } },</code> </pre> <br><p>        ¬´Windows¬ª    . </p><br><p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br><p>     SPA      IdentityServer     .    ¬´¬ª    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em> ,     ,       WindowsIdentity. </p><br><p>    <em>ExternalLogin</em> ,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em> . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWindowsLoginAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnUrl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Principal <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WindowsPrincipal wp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redirectUrl = Url.Page(<span class="hljs-string"><span class="hljs-string">"./ExternalLogin"</span></span>, pageHandler: <span class="hljs-string"><span class="hljs-string">"Callback"</span></span>, values: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { returnUrl }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl); props.Items[<span class="hljs-string"><span class="hljs-string">"scheme"</span></span>] = IISDefaults.AuthenticationScheme; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(IISDefaults.AuthenticationScheme); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Name, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wi = wp.Identity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> WindowsIdentity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groups = wi.Groups.Translate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(NTAccount)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string"><span class="hljs-string">@"BUILTIN\Users"</span></span>, StringComparison.OrdinalIgnoreCase)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>, hasUsersGroup.ToString())); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsPrincipal(id), props); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect(props.RedirectUri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Challenge(IISDefaults.AuthenticationScheme); }</code> </pre> </div></div><br><p>       ,             . </p><br><p>    <em>ExternalLoginModel.OnPost</em>          : </p><br><pre> <code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider) { return await ProcessWindowsLoginAsync(returnUrl); }</code> </pre> <br><p>    Claim  Windows      Claim ¬´hasUsersGroup¬ª,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateClaims</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] claimTypes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claimTypes == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimTypesHash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(claimTypes); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.RemoveClaimsAsync(user, claims); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> claimTypes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.Principal.HasClaim(c =&gt; c.Type == claimType)) { claims = info.Principal.FindAll(claimType).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddClaimsAsync(user, claims); } } }</code> </pre> <br><p>       <em>OnPostConfirmationAsync</em> (    <br>     ). </p><br><pre> <code class="cs hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddLoginAsync(user, info); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"User created an account using {Name} provider."</span></span>, info.LoginProvider); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">// return LocalRedirect(returnUrl); }</span></span></code> </pre> <br><p>    <em>OnGetCallbackAsync</em> ,      . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, bypassTwoFactor : <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//</span></span></code> </pre> <br><p>  ,        WebAPI   <br>  ¬´hasUsersGroup¬ª.      ¬´ShouldHasUsersGroup¬ª </p><br><pre> <code class="cs hljs">services.AddAuthorization(options =&gt; { options.AddPolicy(<span class="hljs-string"><span class="hljs-string">"ShouldHasUsersGroup"</span></span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);}); });</code> </pre> <br><p>    <em>ExchangeRateController</em>       <br>     Policy. </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Authorize(Policy = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ShouldHasUsersGroup"</span></span></span><span class="hljs-meta">)</span></span>] [HttpGet(<span class="hljs-string"><span class="hljs-string">"api/internalrates"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;ExchangeRateItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalRates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number"><span class="hljs-number">-0.02</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;}); }</code> </pre> <br><p>   view    . </p><br><pre> <code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code> </pre> <br><p>    template          . </p><br><pre> <code class="html hljs xml">//internal-data.component.ts: template: `<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"internalrates"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag">&gt;</span></span> `, //app-routing.module.ts: { path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard] } //app.component.html: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/internaldata"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Internal api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>             <br> , ,    .   ,  accsee_token    <br>   claim   <em>hasUsersGroup</em> ,       <br>     ApiResources  .  ,    ,        <em>appsettings.json</em> ,           <em>Startup. ConfigureServices</em> . </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResource = options.ApiResources.First(); apiResource.UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }; });</code> </pre> <br><p> ,     ,    windows      ,         . </p><br><p>       ,   ‚Äì  Guard    claim   ¬´hasUsersGroup¬ª     ¬´  ¬ª.    Guard  : </p><br><pre> <code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code> </pre> <br><p>      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Injectable } from '@angular/core'; import { Observable } from 'rxjs'; import { map,tap} from 'rxjs/operators'; import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router'; import { AuthorizeService } from "./authorize.service"; import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants'; @Injectable({ providedIn: 'root' }) export class AuthorizeWindowsGroupGuardGuard implements CanActivate{ constructor(private authorize: AuthorizeService, private router: Router) {} canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree { return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));; } private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) { if (!isAuthenticated) { window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/"; } } }</code> </pre> </div></div><br><p> , ,         . </p><br><pre> <code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]</code> </pre> <br><p>     IdentityServer,      claims ( <em>sub</em> , <em>profile</em> ),     ¬´hasUsersGroup¬ª.      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identityResource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityResource { Name = <span class="hljs-string"><span class="hljs-string">"customprofile"</span></span>, DisplayName = <span class="hljs-string"><span class="hljs-string">"Custom profile"</span></span>, UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }, }; identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); options.IdentityResources.Add(identityResource);</code> </pre> <br><p> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a>   ,         windows    ¬´ ¬ª   SPA ‚Äì   ,     ,    Guard    . </p><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p> ,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github</a>   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id461433/">https://habr.com/ru/post/id461433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id461417/index.html">Bagaimana saya menolak db4o dalam sistem industri</a></li>
<li><a href="../id461421/index.html">Cara mengasuransikan diri Anda dari kemungkinan kerugian saat berinvestasi di bursa: produk struktural</a></li>
<li><a href="../id461423/index.html">11 tips: cara mempresentasikan UI / UX berfungsi untuk "non-desainer"</a></li>
<li><a href="../id461425/index.html">Bagaimana menjadi manajer produk dan berkembang lebih jauh</a></li>
<li><a href="../id461431/index.html">"Suka dan tidak suka": DNS over HTTPS</a></li>
<li><a href="../id461435/index.html">Pengenalan emosi menggunakan jaringan saraf convolutional</a></li>
<li><a href="../id461437/index.html">370 bola lampu</a></li>
<li><a href="../id461439/index.html">Memulai perpustakaan komponen React dan TypeScript</a></li>
<li><a href="../id461441/index.html">Laporan tentang kondisi penyimpanan menggunakan R. Komputasi paralel, grafik, xlsx, email dan semua ini</a></li>
<li><a href="../id461443/index.html">Pasca-analisis: apa yang diketahui tentang serangan terbaru pada jaringan server kunci SKS Keyserver crypto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>