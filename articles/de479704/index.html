<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèΩ üññüèº üê¨ Eskalation von Berechtigungen im EA Origin Windows-Client (CVE-2019-19247 und CVE-2019-19248) üèà üëõ üêÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gr√º√üe an alle, die sich entschlossen haben, meinen neuen Artikel zur Schwachstellenanalyse zu lesen. Letztes Mal habe ich in einer kurzen Serie von dr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eskalation von Berechtigungen im EA Origin Windows-Client (CVE-2019-19247 und CVE-2019-19248)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pm/blog/479704/">  Gr√º√üe an alle, die sich entschlossen haben, meinen neuen Artikel zur Schwachstellenanalyse zu lesen.  Letztes Mal habe ich in einer kurzen Serie von drei Artikeln √ºber Steam-Schwachstellen ( <a href="https://habr.com/ru/company/pm/blog/462479/">1</a> , <a href="https://habr.com/ru/company/pm/blog/464367/">2</a> und <a href="https://habr.com/ru/company/pm/blog/469507/">3</a> ) gesprochen.  In diesem Artikel werde ich auf die Schwachstellen eines √§hnlichen Produkts eingehen - Origin, das auch ein Launcher f√ºr Spiele ist.  Die entdeckten Sicherheitsanf√§lligkeiten wurden mit CVE-2019-19247 und CVE-2019-19248 nummeriert. <br><br><img src="https://habrastorage.org/webt/bi/b8/vt/bib8vt2hmgqzkyfv39xm5ri8wxk.jpeg"><br><br>  Dieses Mal wird es kein Spiel mit Banban Banana geben.  Die Geschichte der Kommunikation mit der Sicherheitsabteilung von Electronic Arts Inc verlief zun√§chst professionell.  Als ich kontaktiert wurde, gaben sie mir eine Registrierungsnummer, die Berichte wurden sorgf√§ltig gepr√ºft und best√§tigt.  Keine meiner E-Mails wurde ignoriert und f√ºr eine kleine Diskussion wurde ein Konfkall organisiert.  Die Pflege dieser Berichte war f√ºr mich sehr einfach. Vielen Dank an Adrian Stone, Elise Murphy und andere EA-Mitarbeiter, die mit meinen Berichten gearbeitet haben.  <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">Blogpost</a> und <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">Sicherheitshinweis</a> . <br><br>  Nun zu den Schwachstellen.  Ich habe im Windows Origin-Client zwei Sicherheitsl√ºcken gefunden, z. B. "Eskalation von Berechtigungen" (lpe - lokale Eskalation von Berechtigungen oder Eop - Eskalation von Berechtigungen).  Mit dieser Art von Sicherheitsanf√§lligkeit kann jeder Windows-Benutzer mehr Rechte erhalten, als urspr√ºnglich vom Administrator ausgestellt wurden.  In diesem Fall handelt es sich um zwei "typische" Verbesserungen - von jedem Benutzer auf NT AUTHORITY \ SYSTEM (ein Konto mit maximalen Berechtigungen im Betriebssystem).  Die erste Sicherheitsanf√§lligkeit ist ziemlich langweilig, daher werde ich sie im n√§chsten Abschnitt kurz beschreiben.  Aber der zweite war ziemlich interessant, in ihrem Abschnitt werde ich Ihnen genau sagen, wie ich nach ihr gesucht habe. <br><a name="habracut"></a><br><h2>  <font color="orange">CVE-2019-19248</font> </h2><br>  Diese Sicherheitsanf√§lligkeit besteht aus zwei Teilen: <br><br><ol><li> Erstellen eines Ordners unter einem beliebigen Pfad (mit allen Zugriffsrechten); </li><li>  Verwenden Sie Klausel 1, um NT AUTHORITY \ SYSTEM-Berechtigungen zu erhalten. </li></ol><br>  Nun zum ersten Punkt im Detail: <br><br><h3>  Umgebungsvorbereitung </h3><br>  Es ist erforderlich, den Origin-Client zu schlie√üen und den Origin-Client-Dienst zu beenden (theoretisch wird der Dienst selbst beendet, wenn Sie den Client schlie√üen, aber nur f√ºr den Fall). <br><br>  F√ºr den Ordner "C: \ ProgramData \ Origin" lauten die Rechte "All-Full Access", wodurch wir seinen Inhalt vollst√§ndig l√∂schen k√∂nnen. <br><br><h3>  Linkaufbau </h3><br>  Erstellen Sie jetzt ein paar Links.  Die erste Verkn√ºpfung ist vom Typ NTFS Reparse Point (NTFS Mount Point) - die Art der Verkn√ºpfungen, die von Ordner zu Ordner verweisen: "C: \ ProgramData \ Origin" &lt;-&gt; "\ RPC Control".  Zum Erstellen von Analysepunkten sind keine Administratorrechte erforderlich.  Es ist nur erforderlich, dass der Quellordner leer ist und der Benutzer √ºber Schreibrechte verf√ºgt (im letzten Schritt deaktiviert, Rechte dort √ºberpr√ºft).  "\ RPC Control" ist kein Ordner im Dateisystem, sondern eine spezielle Art von Ordner - ein Objektverzeichnis.  Sie k√∂nnen es mit einem normalen Explorer nicht sehen, aber Sie k√∂nnen dort einen Analysepunkt durchf√ºhren, anscheinend aufgrund der in den Windows-Eingeweiden verwendeten allgemeinen Abstraktionen. <br><br>  Jetzt erstellen wir den √ºblichen symbolischen Link "\ RPC Control \ CatalogCache" &lt;-&gt; "C: \ Path \ To \ Target \ Folder".  Im Dateisystem ist das Erstellen symbolischer Links ohne Administratorrechte nicht zul√§ssig, diese Regel gilt jedoch nicht f√ºr Objektverzeichnisse.  Daher wird unser Link erfolgreich erstellt.  Aufgrund einer Kombination dieser beiden Links werden Aufrufe von "C: \ ProgramData \ Origin \ CatalogCache" an "C: \ Path \ To \ Target \ Folder" umgeleitet. <br><br>  Lesen Sie hier mehr √ºber solche Links.  Im selben Repository k√∂nnen <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/releases">Sie</a> Dienstprogramme zum Arbeiten mit Links <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/releases">herunterladen</a> . <br><br><h3>  Starten Sie </h3><br>  F√ºhren Sie im letzten Schritt den Client aus.  Zu Beginn seiner Arbeit wird er den "Origin Client Service" starten und versuchen, einen Ordner zu erstellen, in dem sich kein Ordner "C: \ ProgramData \ Origin \ CatalogCache" befindet.  Durch das Navigieren durch Symlinks wird "C: \ Path \ To \ Target \ Folder" erstellt und diesem Ordner die Berechtigung "All-Full Access" erteilt. <br><br>  Was war erforderlich, um in der ersten Einsatzstelle zu erhalten.  Fahren wir mit der zweiten fort. <br><br><h3>  Der Vorgang zum Erstellen eines Ordners auf einem beliebigen Pfad </h3><br>  Hier kann man auf vielf√§ltige Weise arbeiten. <br><br>  Einfach und ziemlich zuverl√§ssig ist es, den Ordner "C: \ Windows \ system32 \ LogonUI.exe.local" zu erstellen.  "LogonUI.exe" (eine Anwendung, die unter NT AUTHORITY \ SYSTEM ausgef√ºhrt wird und f√ºr den Betrieb des Benutzerauswahlbildschirms und des Sperrbildschirms verantwortlich ist) l√§dt dank des Mechanismus der lokalen Umleitung ("dotlocal redirection") die Bibliothek von dort entlang des Pfads "C: \ Windows" \ system32 \ LogonUI.exe.local \ amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17134.648_none_fb45a0e93062a6d2 \ comctl32.dll. "  Im Allgemeinen ist der Mechanismus selbst ziemlich verbreitet, sodass er viele Ziele haben kann. <br><br>  Ein langer, aber interessanter Weg besteht darin, den Hash des Administratorkennworts durch Spezialbetrug zu subtrahieren.  Weitere Details <a href="https://googleprojectzero.blogspot.com/2017/08/windows-exploitation-tricks-arbitrary.html">hier</a> . <br><br><h3>  Total </h3><br>  Die Sicherheitsl√ºcke l√§sst sich recht einfach ausnutzen, Sie m√ºssen nur ein wenig am zweiten Punkt arbeiten - finden Sie das Ziel und schreiben Sie eine geeignete DLL.  Au√üerdem hat Matt Nelson diese Sicherheitsanf√§lligkeit gemeldet, und sein Schreiben finden Sie <a href="https://enigma0x3.net/2019/12/10/cve-2019-19248-local-privilege-escalation-in-eas-origin-client/">hier</a> . <br><br><h2>  <font color="orange">CVE-2019-19247</font> </h2><br>  Dies ist eine meiner bevorzugten Sicherheitsl√ºcken.  Es zeigt, wie sorgf√§ltig Sie mit der verwendeten Kryptografie umgehen m√ºssen. <br><br>  Alles begann damit, dass ich das Spiel √ºber Origin installiert habe.  Alles verlief irgendwie zu reibungslos - ein paar Klicks und nach ein paar Minuten Download kann das Spiel gestartet werden.  Nicht sofort, aber ich verstand, was los war: Das Spiel wurde unter dem Pfad "C: \ Programme \ GameName" installiert, stellte jedoch keine einzige Frage √ºber die Benutzerkontensteuerung.  Ich √ºberpr√ºfte schnell die Rechte, alles war Standard - ein gew√∂hnlicher Benutzer konnte nicht in "C: \ Programme" schreiben.  Ein bisschen mehr Forschung und ich fand heraus, dass das Spiel nicht vom Origin-Client selbst "vorgeschrieben" wird, sondern vom Origin-Client-Service. <br><br>  Ich fing an, Annahmen dar√ºber zu treffen, wie der Kunde Informationen an den Dienst √ºbertr√§gt, um zu pr√ºfen, ob etwas ausgenutzt werden kann. <br><br>  Die Methode der Informations√ºbertragung erwies sich als einfach - eine Named Pipe.  Dies erfuhr ich aus den Installationsprotokollen - im Klartext wurde angezeigt, dass die OriginClientService-Pipe Befehle zum Arbeiten mit Dateien und Ordnern akzeptierte. <br><br>  IDA ge√∂ffnet, Client dort hochgeladen. <br><br>  <b>* in IDA ausgef√ºhrte Arbeiten: 1 *</b> <br><br>  Ziemlich schnell stellte ich fest, dass Befehle im Allgemeinen in Textform an die Pipe gesendet wurden.  In der N√§he fand ich eine Befehlsliste und schickte ohne weiteres einen Befehl vom Typ "copy" C: \ test \ payload.dll "" C: \ Windows \ pwn.dll "an die Pipe.  In Erwartung eines schnellen Ergebnisses √ºberpr√ºfe ich den Ordner ‚ÄûC: \ Windows‚Äú und finde nichts Neues darin.  Aber es gibt etwas Neues in den Protokollen - einige Worte √ºber die Tatsache, dass der Client an der Pipe die Verifizierung der digitalen Signatur nicht bestanden hat. <br><br>  IDA ge√∂ffnet, Service dort hochgeladen. <br><br>  <b>* bei IDA durchgef√ºhrte Arbeiten: 2 *</b> <br><br>  Ich fand heraus, dass Teams sowieso von niemandem erwartet werden.  Beim Anschlie√üen an eine Rohrleitung pr√ºft der Dienst, wer mit ihr verbunden ist.  Die Prozess-PID wird aus der Verbindung extrahiert, der Pfad zur ausf√ºhrbaren Datei wird aus der PID extrahiert, die Signatur wird auf Richtigkeit √ºberpr√ºft und von EA ausgegeben. <br>  T√∂ne klingen, aber nicht genug.  Sie k√∂nnen die legale "Origin.exe" (Client-ausf√ºhrbare Datei) nehmen und sie irgendwo in Ihren Ordner kopieren.  Platzieren Sie eine DLL aus der Importliste "Origin.exe" in diesem Ordner.  Beispielsweise wurde version.dll gestartet.  Ich nannte diesen Ansatz "Reverse DLL Injection": In einer regul√§ren DLL-Injection kopieren wir die DLL in die EXE-Datei, aber jetzt haben wir das Gegenteil getan.  Ich schreibe schnell eine Proxy-DLL f√ºr version.dll, f√ºge Code hinzu, indem ich den Befehl an die Pipe sende.  Die Nutzlast wird noch nicht kopiert.  Wir lesen die Protokolle - "Was bedeutet es, der Befehl konnte nicht entschl√ºsselt werden!?".  Ich habe die Verschl√ºsselung √ºbersprungen. <br><br>  IDA ge√∂ffnet, Client dort hochgeladen. <br><br>  <b>* Arbeiten in IDA: 3, Signatur-Bypass: 1 *</b> <br><br>  Da der Client in seiner gewohnten Arbeit verschl√ºsselte Befehle sendet, kann ich das.  Dort habe ich gesucht, dann habe ich gesucht, das Ergebnis ist: AES-Verschl√ºsselung, Initialisierung eines konstanten Vektors, der Schl√ºssel wird aus der Datei gelesen.  Wir kopieren dieses St√ºck und IDA praktisch in den Code, kompilieren, √ºberpr√ºfen.  Wieder nichts.  Aber die Protokolle liefern wieder n√ºtzliche Informationen - Sie k√∂nnen keine Programmdateien als Zielpfad angeben. <br><br>  IDA ge√∂ffnet, Service dort hochgeladen. <br><br>  <b>* Arbeit in IDA: 4, Signatur-Bypass: 1, Verschl√ºsselungs-Bypass: 1 *</b> <br><br>  Es gibt also Pr√ºfungen, um einen Befehl zu erhalten, bei dem sich herausstellt, dass Dateien nicht √ºberall kopiert werden k√∂nnen.  Und Pfade mit "\ .. \" k√∂nnen nicht geschrieben werden.  Wir schauen, was andere Teams sind. <br>  Arbeiten mit der Registry - es gibt wieder viele Einschr√§nkungen.  Aber das Starten von Dateien sieht interessant aus.  Zumindest sind die Schecks nicht besonders sichtbar.  Bearbeiten Sie den Code und senden Sie den Befehl "ExecuteProcess" C: \ test \ payload.exe ".  Nun, du verstehst ... nichts. <br><br>  Protokolle sprechen wieder √ºber die Signatur.  Oh, wir haben es schon gewonnen.  Wir geben im Code an, dass wir unsere kopierte Origin.exe aufgerufen haben, um unsere Proxy-DLL erneut zu laden, jedoch mit Systemrechten.  F√ºgen Sie √úberpr√ºfungen hinzu und starten Sie die Konsole.  Wir starten und die Konsole mit den Rechten NT AUTHORITY \ SYSTEM erscheint - endlich hat alles geklappt. <br><br>  <b>* Arbeit in IDA: 4, Signatur-Bypass: 2, Verschl√ºsselungs-Bypass: 1 *</b> <br><br>  Sie m√ºssen also einen Neustart durchf√ºhren, einen letzten Lauf durchf√ºhren und die Konsole trotzdem mit den h√∂chsten Rechten bewundern.  Neustart, Kontrolle und ... nichts.  Wie so  Es hat einfach funktioniert. <br><br>  Die Diagnose zeigt, dass der Origin-Client-Dienst nicht gestartet wurde, daher starte ich ihn.  Aber es f√§ngt nicht an.  Genauer gesagt, es beginnt, schlie√üt aber sofort.  Ich starte den Origin-Client und der Dienst wird normal gestartet.  Danach funktioniert der Exploit wieder korrekt.  Es w√§re m√∂glich, dort anzuhalten, aber das ist nicht meine Art - ich m√∂chte, dass der Exploit vollst√§ndig funktioniert. <br><br>  IDA ge√∂ffnet, Service dort hochgeladen. <br><br>  <b>* Arbeit in IDA: 5, Bypass-Signatur: 2, Bypass-Verschl√ºsselung: 1 *</b> <br><br>  Es stellt sich heraus, dass beim Start √ºberpr√ºft wird, mit welchen Parametern der Dienst gestartet wurde.  Da ist nichts direkt Interessantes.  Base64 aus der verschl√ºsselten PID des Prozesses, dessen Datei durch die Signatur √ºberpr√ºft wird.  Es klingt kompliziert, aber wir haben Verschl√ºsselung und Signatur bereits umgangen.  Wir schreiben Code und ein vollst√§ndiger Exploit ist fertig. <br><br><h3>  Total </h3><br>  Der Exploit funktioniert.  Die Arbeit wurde in IDA durchgef√ºhrt: 5-mal, Bypass-Signatur: 3-mal, Verschl√ºsselungs-Bypass: 2-mal. <br><br><h2>  <font color="orange">Fazit</font> </h2><br>  Behobene Sicherheitsl√ºcken: Entwickler von EA haben einen speziellen eingeschr√§nkten Betriebsmodus f√ºr den Client eingef√ºhrt, der die Arbeit mit Origin-Ordnern und -Pipes erheblich einschr√§nkt. <br><br>  Timeline-Schwachstellen: <br><br>  <b>1. April 2019</b> : Meldung eines Schwachstellenberichts mit Pipe; <br><br>  <b>7. April 2019</b> : Senden eines Schwachstellenberichts mit einem beliebigen Ordner; <br><br>  ... SEHR VIELE BRIEFE (ich habe 40 gez√§hlt) ... <br><br>  <b>10. Dezember 2019</b> : Vereinbarte Offenlegung. <br><br>  Ich danke Ihnen allen f√ºr Ihre Aufmerksamkeit und w√ºnsche Ihnen die gleichen Sicherheitsagenten. <br><br>  <a href="https://amonitoring.ru/article/origin_lpe_disclosure/">Dieser Artikel in Englisch.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de479704/">https://habr.com/ru/post/de479704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de479690/index.html">Zork und Z-Machine: Wie Entwickler das Spiel von Gro√ürechnern auf 8-Bit-Heimcomputer √ºbertragen</a></li>
<li><a href="../de479692/index.html">Indizierung von Milliarden von Textvektoren</a></li>
<li><a href="../de479696/index.html">Ein paar Worte zu Alter Table oder wie man es nicht macht</a></li>
<li><a href="../de479700/index.html">CIMON-2: (un) Doomsday oder wie IBM Watson √ºber den Wolken kletterte</a></li>
<li><a href="../de479702/index.html">Toaster, My Circle und Freelansim werden Teil von Habr</a></li>
<li><a href="../de479708/index.html">Inoffizieller Beitrag zum Rebranding von Habr + Competition</a></li>
<li><a href="../de479712/index.html">Maschinelles Lernen als Smart Monitoring Assistant</a></li>
<li><a href="../de479714/index.html">Vereinheitlichung visueller Komponenten. Teil 1. Stile</a></li>
<li><a href="../de479716/index.html">Eine weitere "Weltneuheit" SuperApp</a></li>
<li><a href="../de479718/index.html">Erstellen einer Arduino-Umgebungsanwendung mit CI Github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>