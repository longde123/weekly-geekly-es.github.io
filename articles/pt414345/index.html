<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•¢ üíáüèø üë©üèº‚Äçüéì Desenvolvimento reverso do interruptor hor√°rio VL-76-S üêÉ üë®üèΩ‚ÄçüöÄ üëÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Era uma vez me deparei com o rel√≥gio digital eletr√¥nico VL-76-S, novo, em embalagem, mas em mau estado. N√£o foram encontrados defeitos nas placas de c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvimento reverso do interruptor hor√°rio VL-76-S</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414345/">  Era uma vez me deparei com o rel√≥gio digital eletr√¥nico VL-76-S, novo, em embalagem, mas em mau estado.  N√£o foram encontrados defeitos nas placas de circuito impresso no interior.  Portanto, casamento de f√°brica, firmware quebrado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cn/vj/2v/cnvj2vs2aonwmvjljydwos0ewqi.jpeg"></div><br>  <i>Vista geral do rel√©.</i> <br><a name="habracut"></a><br>  O que nos surpreendeu foi o uso do microcontrolador popular e simples ATTiny2313.  Externamente, esse projeto consiste em um mestre na forma de tr√™s d√©cadas de comutadores e um terminal ao qual a energia de 220V e os contatos de um rel√© EM est√£o conectados.  O intervalo da tarefa √© de 0,1 ... 99,9 minutos.  em incrementos de 0,1 min  (6 segundos).  N√£o h√° circuitos e firmware nesse design na Internet, o que n√£o √© surpreendente.  Sem pensar duas vezes, decidi desenhar o circuito a partir das placas de circuito impresso e, no futuro, escrever o programa no MK. <br><br>  O design consiste em tr√™s placas de circuito impresso interconectadas.  Na primeira placa, s√£o feitas uma fonte de alimenta√ß√£o e um rel√© de execu√ß√£o TRA3.  A fonte de alimenta√ß√£o √© feita de acordo com um circuito sem transformador: capacitores de resfriamento s√£o usados ‚Äã‚Äãpara reduzir a tens√£o.  Na segunda placa est√° o ATTiny2313 MK e outros elementos auxiliares.  Na terceira placa est√£o os interruptores (pontos de ajuste) e um LED de controle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/be/ew/4h/beew4hzen1salm0a6x7mlwhak2g.jpeg"></div><br>  <i>Foto da terceira prancha na parte de tr√°s.</i> <br><br>  Vou come√ßar a descri√ß√£o com o terceiro quadro.  Os interruptores s√£o interruptores de 10 posi√ß√µes.  N√£o h√° marca√ß√£o neles, cada um deles tem 5 contatos.  Portanto, dependendo da posi√ß√£o, determinados contatos s√£o fechados em v√°rias combina√ß√µes.  Ao ligar para os contatos, percebi imediatamente o padr√£o: uma sa√≠da fixa (geral) √© fechada com as outras quatro sa√≠das (informa√ß√µes) de acordo com a representa√ß√£o bin√°ria do n√∫mero correspondente ao n√∫mero da posi√ß√£o selecionada.  Por exemplo, se a posi√ß√£o "3" for selecionada, a sa√≠da geral (quinto em uma linha) ser√° fechada com a sa√≠da do terceiro e quarto, j√° que o n√∫mero "3" na representa√ß√£o bin√°ria √© "0011".  Aqui est√° uma mudan√ßa t√£o complicada.  E h√° tr√™s deles.  Eles s√£o conectados via conectores XP1 e XP2 √† segunda placa com o MK.  Um conector XP3 conecta um LED e outras porcarias n√£o soldadas desnecess√°rias, para as quais h√° um lugar na placa.  Provavelmente, esse √© um comutador DPDT comum de seis pinos (como o quadrado, PB22E06, por exemplo).  Talvez a placa seja universal, mas n√£o √© usada neste modelo em particular. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/tv/rq/lotvrq9ovoeetew2zmaa6sauury.jpeg"></div><br>  <i>Foto da segunda placa (principal).</i> <br><br>  Chamando os contatos dos comutadores, n√£o entendi imediatamente o princ√≠pio de sua conex√£o com as portas MK.  Na placa principal, 8 transistores SMD s√£o imediatamente evidentes.  Mais tarde, ele descobriu que esses transistores s√£o usados ‚Äã‚Äãcomo pares de diodos com um √¢nodo comum.  Suas bases v√£o para portas MK, e coletores e emissores v√£o para trocar contatos.  Ent√£o eles me explicaram que nesses casos existem pares de diodos, eles tocam como transistores, mas n√£o s√£o transistores.  No total, temos 16 condutores deixando os pares de diodos na terceira placa.  Tr√™s quartos deles (12 pe√ßas) chegam aos contatos de informa√ß√µes dos comutadores (tr√™s a quatro) e quatro permanecem livres.  √â f√°cil adivinhar que, teoricamente, eles s√£o fornecidos para o quarto comutador, o que n√£o est√° de alguma forma ausente, porque n√£o h√° espa√ßo para ele no quadro.  No entanto, para n√£o violar a l√≥gica do racioc√≠nio, mencionarei esse quarto interruptor imagin√°rio.  As extremidades comuns do segundo e terceiro, bem como o primeiro e o quarto comutadores (mas o quarto n√£o fornece a placa) s√£o conectados em pares por faixas na placa principal nos conectores XS1 e XS2.  Esses dois pares est√£o conectados √†s sa√≠das dos grupos de transistores.  Esses dois grupos id√™nticos s√£o feitos nos transistores BC857 e BC847 (estruturas diferentes).  Suas entradas est√£o conectadas ao MK.  Ao aplicar um "0" l√≥gico √† entrada deste grupo, a sa√≠da tamb√©m ser√° um "0" l√≥gico.  Al√©m disso, na placa h√° um conector XP2 para o firmware MK, conectado aos terminais SPI da interface MK, um conector XS3 para um LED e um conector XP1 conectado por um cabo √† primeira placa.  Deve-se lembrar que algumas das portas MK podem ser usadas tanto para SPI (para firmware) quanto para entrada / sa√≠da comum (trabalho no circuito). <br><br>  Tudo isso se reflete nos diagramas que desenhei primeiro no rascunho, depois no SPlan.  As classifica√ß√µes dos elementos de r√°dio que n√£o foram marcados (por exemplo, capacitores SMD) est√£o ausentes nos diagramas, n√£o s√£o t√£o importantes.  Primeiro, darei um diagrama da placa principal e da placa com os instaladores (assinaturas das figuras abaixo). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/r8/gr/4cr8gr6u5edycy869h9wuyprgs0.gif"></div><br>  <i>Esquema do prato principal.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pg/sx/uy/pgsxuy7cgafwqwabsx39prgwkgw.gif"></div><br><br>  <i>Esquema da terceira placa com levantadores</i> <br><br>  Considere como o interrogat√≥rio de cada levantador.  Os sinais das portas PB4 e PB5 MK, l√≥gica "0", abrem os transistores VT2 e VT1, seguidos de VT4 e VT3, conectando-se aos contatos comuns do barramento zero dos comutadores n¬∫ 1 e n¬∫ 2-n¬∫ 3, respectivamente.  Isso acontece por sua vez.  Primeiro, o "0" l√≥gico vem do PB4 (o PB5 at√© agora foi definido como "1"), conectando o segundo e o terceiro comutadores.  Nesse estado, os valores dos sinais s√£o gravados sucessivamente pelo controlador das portas de entrada PB3, PB2, PB1, PB0 atrav√©s dos grupos de diodos 2VD1 ... 2VD4 do segundo e do quarto comutador ausente.  Imediatamente, os valores dos sinais dos pinos PD6, PD5, PD4, PD3 MK s√£o fixos, aos quais os sinais do primeiro e terceiro comutadores passam pelos grupos de diodos 2VD5 ... 2VD8.  Por√©m, como apenas o segundo e o terceiro comutadores s√£o conectados por um contato comum, os sinais do segundo comutador chegar√£o √†s primeiras portas especificadas do MK e o quarto ser√° ignorado.  Da mesma forma, os sinais do terceiro comutador chegar√£o √† segunda metade do MK e o primeiro ser√° ignorado.  Nesse est√°gio, o controlador sabe em quais posi√ß√µes o segundo e o terceiro comutadores est√£o instalados.  Depois disso, o PB4 √© definido como "unidade", desligando o segundo e o terceiro comutador, e o PB5 √© definido como "zero".  Nesse caso, o primeiro e o quarto comutador que falta est√£o conectados por uma extremidade comum ao "caso".  O interrogat√≥rio ocorre exatamente da mesma forma que no caso anterior, mas agora os sinais daqueles switches que foram ignorados na √∫ltima vez ser√£o gravados.  Assim, o controlador conhece as informa√ß√µes de posi√ß√£o de todos os interruptores.  Esse processo √© semelhante ao polling de um teclado matricial, mas, neste caso, uma matriz de 4 camadas com dimens√µes de 2 por 2 com um elemento ausente. <br><br>  Resistores R8 ... R15 - pull-ups.  Embora fosse poss√≠vel "puxar" o pr√≥prio MK.  Frequ√™ncia precisa de rel√≥gio MK fornece quartzo a 10 MHz.  Circuito de redefini√ß√£o R1 e C4 - MK.  N√£o h√° nada mais interessante neste f√≥rum. <br><br><img src="https://habrastorage.org/webt/5u/u-/8s/5uu-8sh8ffhwe3qcxqs6gzppcqa.jpeg"><br>  <i>Foto da primeira placa (de for√ßa) na lateral dos elementos.</i> <br><br><img src="https://habrastorage.org/webt/oe/ln/3-/oeln3-vbwunn8pr0ku2gcwloywm.jpeg"><br>  <i>Foto da primeira placa (de energia) na parte de tr√°s.</i> <br><br>  Vamos seguir para o esquema da primeira placa (Fig. Acima).  O esquema parecia muito interessante e, em alguns lugares, incompreens√≠vel. <br><br><img src="https://habrastorage.org/webt/ku/br/ys/kubrysrquhsy3n1xfwmeuvnh8qw.gif"><br>  <i>Esquema da primeira placa (de pot√™ncia).</i> <br><br>  C1C2 - para reduzir a tens√£o.  R1 - para descarregar o acima.  Ap√≥s a ponte de diodos DB1 s√£o dois eletr√≥litos.  Para complicar o circuito (ou para a confiabilidade) - esquema de estabiliza√ß√£o em cascata VT3R6VD3 - VT7R12VD5.  O VD5 ‚Äã‚Äã√© semelhante a um transistor SMD de emissor n√£o utilizado.  Isso fornece uma tens√£o CC estabilizada de 12V.  Em seguida √© o regulador linear VR1 em 5V.  Ao mesmo tempo, a tens√£o √© removida da ponte de diodos DB1 atrav√©s do diodo VD2 para outro estabilizador de 24V VT1R3VD1.  Essa tens√£o √© fornecida √† bobina do rel√© EM Rel1 e ao R17.  O √∫ltimo n√£o est√° claro o porqu√™.  Na outra extremidade do R17, vem o sinal do grupo de transistores VT9VT10.  O circuito deste grupo √© semelhante ao circuito na placa principal.  Um sinal de uma porta MK PB6 separada chega √† entrada desse grupo de transistores atrav√©s do conector.  Por que √© necess√°rio?  Por que conectar um resistor R17 a 24V?  Provavelmente, havia uma id√©ia de que, em vez de um resistor, voc√™ pode colocar outra coisa, por exemplo, um LED de controle interno, programando a porta PB6 MK de uma certa maneira.  Ou um n√≥ de comuta√ß√£o adicional.  Mas, mesmo assim, isso √© um absurdo, como disseram meus engenheiros de r√°dio, depois de olhar para o quadro de projetos.  A segunda extremidade do rel√© EM Rel1 est√° conectada a um grupo de transistores semelhante VT2VT5 e √† porta MK PD0.  O sinal "0" desta porta liga o rel√© EM em execu√ß√£o.  O mais interessante √© que o LED externo est√° conectado n√£o paralelamente ao rel√© EM, mas ao gap de emissor do transistor VT2, al√©m disso, atrav√©s de dois conectores (passando pela placa principal).  No terminal, os pinos 1 e 2, a julgar pelo adesivo no rel√©, permanecem vazios.  Por√©m, no circuito, o contato n ¬∞ 2 √© conectado a um fio comum e o contato n ¬∞ 1 √© alimentado √† entrada do grupo de transistores VT6VT8.  A sa√≠da deste grupo √© enviada para a porta MK PD2.  Mais tarde, li na especifica√ß√£o deste modelo de rel√© que esses contatos s√£o usados ‚Äã‚Äãpara controlar outros modelos de rel√©s, montados no mesmo caso.  O modelo que estou considerando n√£o envolve controle, mas pode ser implementado ao escrever um programa no MK, pois o esquema oferece essa oportunidade.  Sob o controle pode significar um in√≠cio, redefini√ß√£o (tanto no modo "gatilho" quanto no normal) e tudo o que vem √† mente.  As especifica√ß√µes para outros rel√©s mostram diagramas de tempo que mostram o comportamento dos rel√©s, dependendo de um determinado sinal de controle.  Tamb√©m diz abaixo: a pedido do cliente, podemos implementar qualquer diagrama poss√≠vel.  E o √∫ltimo momento do esquema.  Esse sinal de controle do terminal n ¬∞ 1 tamb√©m chega ao transistor VT4 in√∫til, alimentado por uma tens√£o de 12V.  Isso, novamente, √© uma complica√ß√£o do esquema.  Ou talvez ainda exista alguma id√©ia?  Eu n√£o mergulhei profundamente.  Ficarei feliz em quaisquer coment√°rios. <br><br>  As marca√ß√µes dos terminais dos conectores s√£o assinadas atrav√©s do ponto ap√≥s o nome do pr√≥prio conector.  Os algarismos romanos ap√≥s o s√≠mbolo ‚Äú~‚Äù indicam conclus√µes in√∫teis e ausentes.  Estes √∫ltimos n√£o s√£o poucos no esquema, mas n√£o vou me debru√ßar sobre eles.  Abaixo, descrevo cada placa com as designa√ß√µes de conectores, conclus√µes e elementos b√°sicos. <br><br><img src="https://habrastorage.org/webt/9g/nt/94/9gnt940dbha1c-50htijfyd3erq.gif"><br>  <i>Esbo√ßos do quadro.</i> <br><br>  Considere a descri√ß√£o do c√≥digo fonte do programa MK.  O programa em si √© simples e foi escrito por mim no CVAVR por 20 minutos.  Vou discutir o algoritmo pelo qual o programa ser√° executado.  Esta informa√ß√£o pode parecer bastante banal para alguns, mas n√£o ser√° sup√©rflua para iniciantes.  Na minha vers√£o do algoritmo, os temporizadores no rel√© de tempo ser√£o interrogados n√£o uma vez, mas continuamente.  Al√©m disso, a pesquisa continuar√° mesmo ap√≥s o disparo do rel√©.  Isso permitir√° que voc√™ fa√ßa ajustes em qualquer lugar.  Talvez esse algoritmo n√£o coincida com o algoritmo original para a opera√ß√£o desse rel√©, mas n√£o estou familiarizado com o algoritmo original.  √â no exemplo do algoritmo mencionado acima que a descri√ß√£o do programa ser√° considerada. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo fonte do programa C com descri√ß√£o.</b> <div class="spoiler_text">  Conectamos a biblioteca para trabalhar com o ATTiny2313 MK, bem como a biblioteca de fun√ß√µes de atraso. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;tiny2313.h&gt; #include &lt;delay.h&gt;</span></span></span></span></code> </pre> <br>  A seguir, fazemos a substitui√ß√£o macro necess√°ria, de acordo com as atribui√ß√µes de circuito das portas MK.  Essas substitui√ß√µes s√£o convenientes porque no texto do programa, em vez de, por exemplo, PORTB.5, voc√™ pode escrever getAD, o que √© mais conveniente.  A compila√ß√£o getAD ser√° interpretada como PORTB.  Portanto, a primeira substitui√ß√£o s√£o as sa√≠das para conectar as primeiras (A) e quarta (D) chaves de ajuste.  O segundo √© para o segundo (B) e o terceiro (C).  A seguir est√° a substitui√ß√£o para ativar o rel√©.  E, finalmente, a substitui√ß√£o ‚ÄúCtrl‚Äù que n√£o √© usada no programa e no modelo em considera√ß√£o.  Voc√™ n√£o pode escrever. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> getAD PORTB.5 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> getBC PORTB.4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RL PORTD.0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Ctrl PIND.2</span></span></code> </pre><br>  As vari√°veis ‚Äã‚ÄãA, B, C s√£o usadas para armazenar o n√∫mero da posi√ß√£o dos tr√™s interruptores correspondentes e assumir valores de 0 a 9. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> A,B,C;</code> </pre><br>  Vari√°vel i - o valor atual do n√∫mero do d√©cimo de minuto (6 segundos), ou seja, o n√∫mero do ‚Äútick‚Äù m√≠nimo do rel√©.  A vari√°vel t √© o n√∫mero de d√©cimos de minuto (ticks) recebidos do mestre. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>,t;</code> </pre><br>  A principal fun√ß√£o do programa √© apresentada abaixo.  Nas primeiras 6 linhas eu n√£o entendi.  Eles s√£o formados usando o utilit√°rio auxiliar CodeWizadAVR e est√£o associados √† presen√ßa de quartzo externo a 10 MHz. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> optsize- CLKPR=0x80; CLKPR=0x00; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _OPTIMIZE_SIZE_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> optsize+ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br>  As duas linhas a seguir configuram a porta B do nosso MK.  De acordo com o esquema, colocamos os 4 bits mais baixos na entrada e os mais significativos na sa√≠da (PB7 n√£o √© usado e PB6 √© in√∫til, mas, em teoria, a sa√≠da).  Portanto, de acordo com os princ√≠pios da configura√ß√£o MK, que n√£o descreverei, escrevemos o n√∫mero 240 no registro DDRB (F0 em nota√ß√£o hexadecimal).  O n√≠vel de sa√≠da inicial √© "1", exceto o PB7 desnecess√°rio.  E, por precau√ß√£o, vamos conectar os ‚Äúresistores pull-up‚Äù do MK √†s entradas, mesmo que elas j√° estejam instaladas no circuito.  Para fazer isso, vamos definir o registro PORTB como 7F em nota√ß√£o hexadecimal. <br><br><pre> <code class="cpp hljs">PORTB=<span class="hljs-number"><span class="hljs-number">0x7F</span></span>; DDRB=<span class="hljs-number"><span class="hljs-number">0xF0</span></span>;</code> </pre><br>  A porta D. est√° configurada da mesma maneira: todos os pinos da entrada, exceto os dois inferiores.  Os "resistores pull-up" na entrada e o n√≠vel de sa√≠da inicial "1" na sa√≠da s√£o semelhantes. <br><br><pre> <code class="cpp hljs">PORTD=<span class="hljs-number"><span class="hljs-number">0x7D</span></span>; DDRD=<span class="hljs-number"><span class="hljs-number">0x03</span></span>;</code> </pre><br>  As cinco linhas a seguir est√£o relacionadas √† configura√ß√£o de um dos temporizadores MK.  Esse timer tem dezesseis d√≠gitos, ou seja, fornece uma pontua√ß√£o de at√© 2 ^ 16 = 65536.  A frequ√™ncia de contagem √© determinada pela freq√º√™ncia do rel√≥gio MK e pelo coeficiente de divis√£o (um dos cinco predefinidos).  No programa descrito, foi decidido manter uma conta por 6 segundos (a etapa m√≠nima da tarefa), depois aumentar a vari√°vel i em 1 e redefinir o timer para o in√≠cio da contagem.  Para garantir o que foi dito acima, voc√™ precisa levar a taxa de divis√£o m√°xima de 1024 e contar para 58594. A √∫ltima √© f√°cil de calcular.  Frequ√™ncia MK - 10.000.000 Hz.  Usando uma taxa de divis√£o de 1024, a frequ√™ncia do temporizador ser√° 10.000.000 / 1.024 = 9.765.625 Hz e o per√≠odo ser√° 1.024.000 / 10.000.000 = 0,0001024 s.  Dentro de 6 segundos, 6 / 0.0001024 = 58593.75 desses per√≠odos ser√£o empilhados.  Esse n√∫mero est√° dentro do cron√¥metro de 16 bits, mas n√£o √© um n√∫mero inteiro; portanto, voc√™ deve arredondar para 58594. Nesse caso, o erro do nosso rel√© de tempo ser√° insignificante: 58594-58593.75 = 0.25;  0,25 * 0,0001024 = 0,0000256;  0,0000256 * 999 = 0,0255744.  Ou seja, para o per√≠odo m√°ximo poss√≠vel de tempo (99,9 minutos), a imprecis√£o desse rel√© de tempo ser√° de aproximadamente 25,6 milissegundos, o que √© bastante aceit√°vel na pr√°tica.  A prop√≥sito, o fabricante tamb√©m estipula o erro do dispositivo, e nosso erro n√£o ser√° pior.  No registro de configura√ß√£o do timer TCCR1B, escreva o valor 5. Sem entrar em detalhes, isso significa que o timer inicia e o coeficiente de divis√£o √© 1024. No registro TCNT1, escrevemos o valor 0. Esse registro √© de 16 bits e √© dividido em duas metades de 8 bits: o mais novo (L ) e s√™nior (H).  O valor √© gravado nele, de onde o temporizador continuar√° contando.  Precisamos contar do zero.  O valor OCR1A registra antes do qual o timer ler√° e depois chamar√° a fun√ß√£o de interrup√ß√£o.  Nesse momento, a fun√ß√£o principal do programa √© interrompida e as a√ß√µes especificadas na fun√ß√£o dessa interrup√ß√£o s√£o executadas.  Ap√≥s praticar a interrup√ß√£o, a fun√ß√£o principal continuar√° sendo executada.  Este valor, como foi dito acima, √© igual a 58594 (E4E2 em nota√ß√£o hexadecimal).  Como o registro OCR1A tamb√©m √© dividido em duas metades, escrevemos o valor acima em partes. <br><br><pre> <code class="cpp hljs">TCCR1B=<span class="hljs-number"><span class="hljs-number">0x05</span></span>; TCNT1H=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; TCNT1L=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; OCR1AH=<span class="hljs-number"><span class="hljs-number">0xE4</span></span>; OCR1AL=<span class="hljs-number"><span class="hljs-number">0xE2</span></span>;</code> </pre><br>  As pr√≥ximas duas linhas configuram a resolu√ß√£o das interrup√ß√µes corretamente (n√£o entre em detalhes). <br><br><pre> <code class="cpp hljs">TIMSK=<span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-meta"><span class="hljs-meta">#asm(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sei"</span></span></span><span class="hljs-meta">)</span></span></code> </pre><br>  No ciclo principal, as chaves do setter s√£o pesquisadas constantemente (de acordo com o algoritmo na descri√ß√£o do circuito) usando atrasos de 30 ms para opera√ß√£o correta e est√°vel.  Ao definir o valor "0" em PORTB.5 (getAD = 0), preparamos o primeiro comutador.  Suas conclus√µes est√£o conectadas √† porta D do MK nos pinos 6, 5, 4, 3. A dire√ß√£o √© do mais novo ao mais antigo.  Ou seja, o bit de ordem inferior do comutador est√° conectado ao bit de ordem relativamente baixa (bit 3) da porta MK.  Portanto, para receber informa√ß√µes da porta D do MK na posi√ß√£o do primeiro comutador, √© necess√°rio fazer um deslocamento bit a bit para a direita em tr√™s posi√ß√µes (PIND &gt;&gt; 3), inverter os bits recebidos com a opera√ß√£o ‚Äú~‚Äù (j√° que as informa√ß√µes entrar√£o em ‚Äú0‚Äù, conforme o esquema) e redefina os quatro bits altos desnecess√°rios do valor de 8 bits recebido.  A √∫ltima opera√ß√£o √© realizada pela multiplica√ß√£o l√≥gica por bit do resultado pelo n√∫mero 15 (00001111 na representa√ß√£o bin√°ria).  Ap√≥s esta opera√ß√£o, a vari√°vel A receber√° o valor da posi√ß√£o do primeiro interruptor.  Em seguida, o primeiro interruptor √© desligado e o segundo e o terceiro s√£o preparados.  O valor do segundo comutador para a vari√°vel B √© obtido da porta B do MK da mesma forma, mas sem uma opera√ß√£o de turno, uma vez que os terminais deste comutador est√£o conectados aos pinos mais baixos da porta B do MK e tamb√©m de forma bidirecional.  As informa√ß√µes do terceiro comutador para a vari√°vel C s√£o removidas da mesma maneira que as do primeiro.  Depois disso, o segundo e o terceiro comutadores (getBC = 1) s√£o "fechados" e o valor definido (o n√∫mero de d√©cimos de minuto) dos tr√™s comutadores √© calculado na vari√°vel t. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>){ delay_ms(<span class="hljs-number"><span class="hljs-number">30</span></span>); getAD=<span class="hljs-number"><span class="hljs-number">0</span></span>; delay_ms(<span class="hljs-number"><span class="hljs-number">30</span></span>); A=(~(PIND&gt;&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">15</span></span>); delay_ms(<span class="hljs-number"><span class="hljs-number">30</span></span>); getAD=<span class="hljs-number"><span class="hljs-number">1</span></span>; getBC=<span class="hljs-number"><span class="hljs-number">0</span></span>; delay_ms(<span class="hljs-number"><span class="hljs-number">30</span></span>); B=(~PINB)&amp;<span class="hljs-number"><span class="hljs-number">15</span></span>; C=(~(PIND&gt;&gt;<span class="hljs-number"><span class="hljs-number">3</span></span>)&amp;<span class="hljs-number"><span class="hljs-number">15</span></span>); delay_ms(<span class="hljs-number"><span class="hljs-number">30</span></span>); getBC=<span class="hljs-number"><span class="hljs-number">1</span></span>; t=<span class="hljs-number"><span class="hljs-number">100</span></span>*A+<span class="hljs-number"><span class="hljs-number">10</span></span>*B+C; } }</code> </pre><br>  A compara√ß√£o dessa vari√°vel e uma vari√°vel em tempo real semelhante i ocorre na fun√ß√£o de interrup√ß√£o. <br><br><pre> <code class="cpp hljs">interrupt [TIM1_COMPA] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer1_compa_isr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ i+=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i&gt;=t){ RL=<span class="hljs-number"><span class="hljs-number">0</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ RL=<span class="hljs-number"><span class="hljs-number">1</span></span>; } TCNT1H=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; TCNT1L=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; }</code> </pre><br>  Se a √∫ltima vari√°vel exceder o valor definido, o "rel√© em execu√ß√£o" (RL = 0) ser√° ativado em "0".  Al√©m disso, ele ser√° desativado se, ao mesmo tempo, os comutadores estiverem configurados para um valor maior que o que foi executado na vari√°vel i.  Na mesma fun√ß√£o de interrup√ß√£o, a vari√°vel i √© aumentada em 1 e o timer √© redefinido para 0. <br><br>  Os bits do FUSE foram baixados do MK e mantidos inalterados.  Eu os analisei, est√° tudo bem l√°. <br><br><img src="https://habrastorage.org/webt/zv/dt/ll/zvdtllilqlufxumtsv98xelmwnc.png"><br><br><br></div></div><br>  Assim, n√£o apenas o diagrama do dispositivo foi copiado, mas tamb√©m foi desenvolvido um programa MK, que n√£o difere em funcionalidade do propriet√°rio.  Al√©m disso, tornou-se poss√≠vel, no n√≠vel do software, alterar de maneira bastante flex√≠vel (e, o mais importante, gratuita) os par√¢metros de tempo do dispositivo e usar a sa√≠da de controle (N¬∫ 1 no terminal) em v√°rias funcionalidades.  O programa √© t√£o simples que pode (ainda melhor) ser escrito em assembler, mas ainda n√£o o estou fazendo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414345/">https://habr.com/ru/post/pt414345/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414335/index.html">Background. Roskomnadzor, o que voc√™ √©?</a></li>
<li><a href="../pt414337/index.html">Estilo Ramda: Imutabilidade e Objetos</a></li>
<li><a href="../pt414339/index.html">Grande tour fotogr√°fico do novo site de Moscou coworking #tceh</a></li>
<li><a href="../pt414341/index.html">O resumo de materiais interessantes para o desenvolvedor de dispositivos m√≥veis n¬∫ 256 (de 3 a 12 de junho)</a></li>
<li><a href="../pt414343/index.html">Tradu√ß√£o autom√°tica neural do Google</a></li>
<li><a href="../pt414347/index.html">Agress√£o passiva: como destr√≥i nossa vida profissional e como lidar com ela</a></li>
<li><a href="../pt414349/index.html">Obter estat√≠sticas de custo da MCC: Tinkoff e Rocketbank</a></li>
<li><a href="../pt414351/index.html">Instrumentos musicais mais incomuns: Hammond Organ, Vako Orchestron e Synclavier</a></li>
<li><a href="../pt414353/index.html">Kivy. Da cria√ß√£o √† produ√ß√£o √© um passo. Parte 2</a></li>
<li><a href="../pt414355/index.html">Vida ap√≥s a explos√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>