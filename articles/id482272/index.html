<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🎤 👨🏿‍🏭 🖖🏽 Memilih gudang data untuk Prometheus: Thanos vs VictoriaMetrics 💵 🌆 🧚🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo semuanya. Di bawah ini adalah transkrip laporan dengan Pertemuan Besar Pengawasan 4 . 


 Prometheus adalah sistem pemantauan untuk berbagai sist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Memilih gudang data untuk Prometheus: Thanos vs VictoriaMetrics</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482272/"><p>  Halo semuanya.  Di bawah ini adalah transkrip <a href="https://www.youtube.com/watch%3Fv%3DHyOXAdQE0Pk" rel="nofollow">laporan dengan Pertemuan Besar Pengawasan 4</a> . </p><br><p>  <strong><a href="https://github.com/prometheus" rel="nofollow">Prometheus</a></strong> adalah sistem pemantauan untuk berbagai sistem dan layanan, di mana administrator sistem dapat mengumpulkan informasi tentang parameter sistem saat ini dan mengonfigurasi peringatan untuk menerima pemberitahuan penyimpangan dalam pengoperasian sistem. </p><br><p>  Laporan ini akan membandingkan <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> dan <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> , proyek untuk penyimpanan jangka panjang metrik Prometheus. </p><a name="habracut"></a><br><p><img src="https://habrastorage.org/webt/vm/ha/hd/vmhahdu2edj4dsc6o3lvzaf-noo.png"></p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HyOXAdQE0Pk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p><img src="https://habrastorage.org/webt/op/ni/ao/opniaodpqcis34bw3f4-twdnsic.png"></p><br><p>  Pertama, saya akan berbicara tentang Prometheus.  Ini adalah sistem pemantauan yang mengumpulkan metrik dari target yang diberikan dan menyimpannya di penyimpanan lokal.  Prometheus dapat menulis metrik ke repositori jarak jauh, dapat menghasilkan peringatan dan aturan perekaman. </p><br><p><img src="https://habrastorage.org/webt/dl/ji/yn/dljiynnywlw3fcjl7oc3m7lgstw.png"></p><br><h3 id="ogranicheniya-prometheus">  Keterbatasan Prometheus: </h3><br><ul><li>  Itu tidak memiliki tampilan permintaan global.  Ini terjadi ketika Anda memiliki beberapa contoh prometheus yang independen.  Mereka mengumpulkan metrik.  Dan Anda ingin mengajukan permintaan di atas semua metrik yang dikumpulkan dari berbagai contoh prometheus.  Prometheus tidak mengizinkan ini. </li><li>  Dengan prometheus, kinerja dibatasi hanya untuk satu server.  Prometheus tidak dapat secara otomatis mengukur ke beberapa server.  Anda hanya dapat membagi target secara manual di antara banyak Prometheus. </li><li>  Volume metrik di Prometheus terbatas hanya untuk satu server karena alasan yang sama sehingga tidak dapat secara otomatis skala ke beberapa server. </li><li>  Di Prometheus, tidak mudah mengatur keamanan data. </li></ul><br><p><img src="https://habrastorage.org/webt/t3/wi/lf/t3wilf2sbn7ndupjqbe1wgxqrzw.png"></p><br><h3 id="resheniya-etih-problemzadach">  Memecahkan masalah / tantangan ini? </h3><br><p>  Solusinya adalah: </p><br><ul><li>  <a href="https://github.com/thanos-io/thanos" rel="nofollow">Terima kasih</a> </li><li>  <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> </li><li>  <a href="https://github.com/m3db" rel="nofollow">Uber m3</a> </li><li>  <a href="https://github.com/cortexproject/cortex" rel="nofollow">Cortex</a> </li></ul><br><p>  Semua solusi penyimpanan jarak jauh ini dikumpulkan oleh Prometheus.  Mereka memecahkan masalah penyimpanan jarak jauh dari slide sebelumnya dengan berbagai cara.  Dalam presentasi ini, saya hanya akan berbicara tentang dua solusi pertama: <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> dan <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p>  Untuk pertama kalinya, informasi tentang <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> muncul di <a href="https://improbable.io/blog/thanos-prometheus-at-scale" rel="nofollow">tautan ini</a> .  Ini menggambarkan arsitektur <a href="https://github.com/thanos-io/thanos" rel="nofollow">Thanos</a> dan cara kerjanya. </p><br><p><img src="https://habrastorage.org/webt/wg/bq/-b/wgbq-b3pwr1emeewan-q5hszprs.png"></p><br><p>  Thanos mengambil data yang disimpan Prometheus ke disk lokal dan menyalinnya ke S3, ke <a href="https://cloud.google.com/storage/" rel="nofollow">GCS,</a> atau ke penyimpanan objek lain. </p><br><p><img src="https://habrastorage.org/webt/p7/4g/rj/p74grj159fi9xb58vq-hphcrqyi.png"></p><br><p>  Dengan cara ini, Thanos memberikan tampilan permintaan global.  Anda dapat meminta data yang disimpan dalam penyimpanan objek dari beberapa instance Prometheus. </p><br><p><img src="https://habrastorage.org/webt/aj/3u/wi/aj3uwi8dd4wgy-fyogditn--kek.png"></p><br><p>  Thanos mendukung PromQL dan <a href="https://prometheus.io/docs/prometheus/latest/querying/api/" rel="nofollow">API permintaan Prometheus</a> . </p><br><p><img src="https://habrastorage.org/webt/sr/t7/ql/srt7qlyoruhbxr5wglfuyhi9jp4.png"></p><br><p>  Thanos menggunakan kode Prometheus untuk menyimpan data. </p><br><p><img src="https://habrastorage.org/webt/3y/ws/ik/3ywsiklzziqimz1aig7uzieblqw.png"></p><br><p>  Thanos sedang dikembangkan oleh pengembang yang sama dengan Prometheus. </p><br><p>  Tentang <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> .  Inilah <a href="https://medium.com/faun/victoriametrics-creating-the-best-remote-storage-for-prometheus-5d92d66787ac" rel="nofollow">tautan</a> tempat kami pertama kali berbicara tentang <a href="https://github.com/VictoriaMetrics/VictoriaMetrics" rel="nofollow">VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/z9/q2/wv/z9q2wvhshsoqb1ron0jx47djiwc.png"></p><br><p>  VictoriaMetrics menerima data dari beberapa prometheus melalui protokol <a href="https://prometheus.io/docs/practices/remote_write/" rel="nofollow">API tulis jarak jauh</a> yang didukung oleh Prometheus. </p><br><p><img src="https://habrastorage.org/webt/pl/xl/ad/plxladg1rdvyudc0wzs5oc2ljsa.png"></p><br><p>  VictoriaMetrics menyediakan tampilan permintaan global, karena beberapa instance Prometheus dapat menulis data ke satu VictoriaMetrics.  Dengan demikian, Anda dapat membuat permintaan untuk semua data ini. </p><br><p><img src="https://habrastorage.org/webt/9l/cp/aw/9lcpawp68_pq2mrhzya9okprroy.png"></p><br><p>  VictoriaMetrics juga mendukung, seperti Thanos, PromQL, dan API kueri Prometheus. </p><br><p><img src="https://habrastorage.org/webt/d1/t1/ek/d1t1ek9rbq_ftlasl48scoriyq0.png"></p><br><p>  Tidak seperti Thanos, kode sumber VictoriaMetrics ditulis dari awal dan dioptimalkan untuk kecepatan dan sumber daya. </p><br><p><img src="https://habrastorage.org/webt/ps/t6/gu/pst6guuoseu2dicx9tra1bvjhry.png"></p><br><p>  VictoriaMetrics, tidak seperti Thanos, berskala secara vertikal dan horizontal.  Ada versi <a href="" rel="nofollow">Single-node</a> yang skala secara vertikal.  Anda dapat mulai dengan satu prosesor dan 1 GB memori dan secara bertahap tumbuh hingga ratusan prosesor dan 1TB memori.  VictoriaMetrics dapat menggunakan semua sumber daya ini.  Kinerjanya akan meningkat sekitar 100 kali dibandingkan dengan sistem single-core. </p><br><p><img src="https://habrastorage.org/webt/tb/s7/t4/tbs7t4unnruaytt7duwambgofne.png"></p><br><p>  Sejarah Thanos dimulai pada November 2017, ketika komit publik pertama kali muncul.  Sebelum ini, Thanos dikembangkan secara internal oleh <a href="https://improbable.io/" rel="nofollow">improbable.io</a> . </p><br><p><img src="https://habrastorage.org/webt/ik/g7/dg/ikg7dgnmbyiph40zo7v7kyhxrdy.png"></p><br><p>  Pada Juni 2019, ada rilis penting 0,5.0, di mana protokol <a href="https://en.wikipedia.org/wiki/Gossip_protocol" rel="nofollow">gosip</a> <a href="https://thanos.io/proposals/201809_gossip-removal.md/" rel="nofollow">dihapus</a> .  Dia dikeluarkan dari Thanos karena dia tidak melakukan yang terbaik.  Seringkali cluster Thanos tidak berfungsi dengan benar, node terhubung dengan tidak benar karena protokol gosip.  Karena itu, mereka memutuskan untuk menghapusnya dari sana.  Saya pikir ini adalah keputusan yang tepat. </p><br><p><img src="https://habrastorage.org/webt/5y/bu/cu/5ybucuovkh85tqwsrv3cjre-zmu.png"></p><br><p>  Juga pada Juni 2019, mereka mengirim nomor aplikasi <a href="https://github.com/cncf/toc/pull/256" rel="nofollow">256</a> ke <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> . </p><br><p><img src="https://habrastorage.org/webt/16/rz/x_/16rzx_bswddquoqw4cmw9txobxa.png"></p><br><p>  Dan setelah beberapa bulan, Thanos bergabung dengan <a href="https://www.cncf.io/" rel="nofollow">Cloud Native Computing Foundation</a> , yang meliputi Prometheus, Kubernetes, dan proyek populer lainnya. </p><br><p><img src="https://habrastorage.org/webt/9c/i2/ic/9ci2ictg_n0xtgdcxtklghw4n2w.png"></p><br><p>  Pada Januari 2018, pengembangan VictoriaMetrics dimulai. </p><br><p><img src="https://habrastorage.org/webt/wi/li/co/wiliconuw5mwhyzizzthqk8a2og.png"></p><br><p>  Pada bulan September 2018, saya pertama kali menyebutkan VictoriaMetrics di depan umum. </p><br><p><img src="https://habrastorage.org/webt/gd/th/ka/gdthkaxubi8jzg8gedilcotjdje.png"></p><br><p>  Pada bulan Desember 2018, versi Single-node diterbitkan. </p><br><p><img src="https://habrastorage.org/webt/ui/r7/23/uir723wmd-l1dwxds6katr8cfco.png"></p><br><p>  Pada Mei 2019 <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">,</a> sumber <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">-</a> sumber Single-node dan versi cluster <a href="https://blog.usejournal.com/open-sourcing-victoriametrics-f31e34485c2b" rel="nofollow">diterbitkan</a> . </p><br><p><img src="https://habrastorage.org/webt/a7/tk/ug/a7tkughz1ut9dmlfb6ued1irbh8.png"></p><br><p>  Pada Juni 2019, seperti halnya Thanos, kami mendaftar ke yayasan CNCF di nomor <a href="https://github.com/cncf/toc/pull/255" rel="nofollow">255</a> .  Kami melamar satu hari sebelum Thanos melamar. </p><br><p><img src="https://habrastorage.org/webt/pk/dm/zr/pkdmzr2xn880osldinx6sb10-ai.png"></p><br><p>  Namun, sayangnya, kami masih belum diterima di sana.  Butuh bantuan dari komunitas. </p><br><p><img src="https://habrastorage.org/webt/mw/2w/we/mw2wwenfu8tecrrkyrkx-8dhf-8.png"></p><br><p>  Pertimbangkan slide paling penting yang menunjukkan arsitektur Thanos dan VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/1w/by/96/1wby96ev7cqhx7-psbem1b-bf-i.png"></p><br><p>  Mari kita mulai dengan Thanos.  Komponen kuning adalah komponen Prometheus.  Yang lainnya adalah komponen Thanos.  Mari kita mulai dengan komponen yang paling penting.  Thanos Sidecar adalah komponen yang dipasang di sebelah setiap Prometheus.  Dia berkomitmen untuk memuat data Prometheus dari penyimpanan lokal ke S3 atau ke Penyimpanan Objek lain. </p><br><p>  Ada juga komponen seperti Thanos Store Gateway, yang dapat membaca data ini dari Object Storage atas permintaan masuk dari Thanos Query.  Kueri Thanos mengimplementasikan PromQL dan API Prometheus.  Artinya, dari luar terlihat seperti Prometheus.  Ia menerima permintaan PromQL, mengirimkannya ke Thanos Store Gateway, Thanos Store Gateway mengambil data yang diperlukan dari Object Storage, mengirimkannya kembali. </p><br><p>  Tetapi kami telah menyimpan data di Object Storage tanpa dua jam terakhir karena kekhasan implementasi Thanos Sidecar, yang tidak dapat mengunggah dua jam terakhir ke Object Storage S3, karena selama dua jam ini Prometheus belum membuat file di penyimpanan lokal. </p><br><p>  Bagaimana mereka memutuskan untuk mengatasi ini?  Thanos Query, di samping permintaan dari Thanos Store Gateway, mengirimkan permintaan paralel ke setiap Thanos Sidecar yang terletak di sebelah Prometheus. </p><br><p>  Dan Thanos Sidecar, pada gilirannya, proksi permintaan lebih lanjut di Prometheus, dan mendapatkan data selama dua jam terakhir. </p><br><p>  Selain komponen-komponen ini, ada juga komponen opsional yang tanpanya Thanos tidak akan merasa sehat.  Ini adalah Thanos Compact, yang menggabungkan file kecil di Object Storage menjadi file yang lebih besar yang telah diunggah di sini oleh Thanos Sidecar.  Thanos Sidecar mengunggah file data di sana dalam dua jam.  File-file ini, jika Anda tidak menggabungkannya menjadi file yang lebih besar, maka jumlahnya dapat tumbuh sangat signifikan.  Semakin banyak file seperti itu, semakin banyak memori yang diperlukan untuk Thanos Store Gateway, semakin banyak sumber daya yang diperlukan untuk mentransfer data melalui jaringan, metadata.  Gateway Thanos Store menjadi tidak efisien.  Oleh karena itu, Anda harus menjalankan Thanos Compact, yang menggabungkan file kecil menjadi yang lebih besar sehingga ada lebih sedikit file seperti itu dan untuk mengurangi overhead pada Thanos Store Gateway. </p><br><p>  Ada juga komponen seperti Thanos Ruler.  Ini mengikuti aturan peringatan Prometheus dan dapat menghitung aturan rekaman Prometheus untuk menulis data kembali ke Object Storage.  Tetapi komponen ini tidak direkomendasikan, karena  dia <a href="" rel="nofollow">cenderung mengembalikan data yang tidak lengkap</a> . </p><br><p>  Ini adalah skema sederhana untuk Thanos. </p><br><p><img src="https://habrastorage.org/webt/os/em/y4/osemy4ys_bkpy-ngxj7jg-gdmom.png"></p><br><p>  Sekarang bandingkan dengan skema VictoriaMetrics. </p><br><p>  VictoriaMetrics memiliki 2 versi: Single-node dan versi cluster.  Single-node berjalan di satu komputer.  Single-node tidak memiliki komponen-komponen ini, hanya satu biner.  Biner pada slide ini terlihat seperti kotak ini.  Semua yang ada di dalam kotak adalah konten dari file biner untuk versi Single-node.  Anda tidak perlu tahu tentang dia.  Mulai saja biner - dan semuanya bekerja untuk kita. </p><br><p>  Versi cluster lebih rumit.  Di dalamnya ada tiga komponen yang berbeda: vmselect, vminsert dan vmstorage.  Dari nama mereka harus jelas apa yang mereka lakukan.  Komponen Sisipan menerima data dalam format yang berbeda: dari API penulisan jarak jauh Prometheus, protokol garis Influx, protokol Graphite, dan protokol OpenTSDB.  Komponen Sisip menerima mereka, mem-parsing dan mendistribusikannya di antara komponen penyimpanan yang ada, di mana data sudah disimpan.  Komponen Select, pada gilirannya, menerima permintaan PromQL.  Ini mengimplementasikan <a href="https://medium.com/%40valyala/promql-tutorial-for-beginners-9ab455142085" rel="nofollow">PromQL</a> serta API kueri Prometheus, dan itu dapat digunakan sebagai pengganti Prometheus di Grafana atau klien API Prometheus lainnya.  Pilih menerima permintaan promql, mem-parsingnya, membaca data yang diperlukan untuk mengeksekusi permintaan ini dari node penyimpanan, memproses data ini dan mengembalikan respons. </p><br><p><img src="https://habrastorage.org/webt/sb/co/mx/sbcomx2usdrwzbyfgqjubvoichg.png"></p><br><p>  Bandingkan kesulitan memasang Thanos dan VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/hv/gw/r6/hvgwr6nk7yh4nog7rpjac4fn0se.png"></p><br><p>  Mari kita mulai dengan Thanos.  Sebelum Anda mulai bekerja dengan Thanos, Anda perlu membuat ember di Object Storage, seperti S3 atau GCS, sehingga Thanos Sidecar dapat menulis data di sana. </p><br><p><img src="https://habrastorage.org/webt/st/hk/5s/sthk5swss1mkaalb4p3oiebnesq.png"></p><br><p>  Kemudian untuk setiap Prometheus Anda perlu menginstal Thanos Sidecar.  Sebelum itu, Anda harus ingat untuk menonaktifkan pemadatan data di Prometheus.  Pemadatan data secara berkala mengompresi data dalam penyimpanan lokal Prometheus untuk mengurangi konsumsi sumber daya. </p><br><p>  Ketika Anda menginstal Thanos Sidecar ke Prometheus Anda, Anda harus menonaktifkan pemadatan data ini, karena Thanos Sidecar tidak dapat bekerja secara normal ketika pemadatan data diaktifkan.  Ini berarti bahwa Prometheus Anda mulai menyimpan data dalam blok dua jam dan berhenti menggabungkan blok ini menjadi yang lebih besar.  Dengan demikian, jika Anda membuat permintaan yang lebih lama dari dua jam terakhir, mereka tidak akan bekerja seefisien mungkin jika pemadatan data diaktifkan. </p><br><p><img src="https://habrastorage.org/webt/gd/as/pw/gdaspwys_r63cegoxqovl9bcmie.png"></p><br><p>  Oleh karena itu, Thanos merekomendasikan untuk mengurangi waktu penyimpanan data di penyimpanan lokal menjadi 6-8 jam untuk mengurangi overhead ini dari sejumlah besar blok kecil. </p><br><p>  Setelah Anda menginstal Thanos Sidecar, Anda harus menginstal dua komponen untuk setiap Bucket Penyimpanan Objek.  Ini adalah Thanos Compactor dan Thanos Store Gateway. </p><br><p><img src="https://habrastorage.org/webt/cw/4f/yk/cw4fyksvnkmp1tcn-clf-2gzx3q.png"></p><br><p>  Setelah itu, Anda perlu menginstal Thanos Query dan mengkonfigurasinya sehingga ia tahu cara menyambungkan ke semua Thanos Store Gateway yang Anda miliki, dan juga tahu cara menghubungkan ke semua Thanos Sidecar. </p><br><p>  Mungkin ada masalah kecil. </p><br><p><img src="https://habrastorage.org/webt/vf/sc/30/vfsc30z00pvcnupbdym2jztx09k.png"></p><br><p>  Anda perlu mengonfigurasi koneksi yang andal dan aman dari Thanos Query ke komponen ini.  Dan jika Prometheus Anda berada di pusat data yang berbeda, atau di VPC berbeda, maka koneksi eksternal ke mereka dilarang.  Tetapi agar Thanos Query berfungsi, Anda perlu mengkonfigurasi koneksi di sana, dan Anda harus menemukan cara. </p><br><p>  Jika Anda memiliki banyak pusat data seperti itu, maka, keandalan seluruh sistem menurun.  Karena Thanos Query harus terus terhubung ke semua Thanos Sidecar yang terletak di pusat data yang berbeda.  Dengan setiap permintaan yang masuk, ia akan meneruskan permintaan ke semua Thanos Sidecar.  Jika koneksi terputus, Anda akan menerima set data yang tidak lengkap, atau Anda akan mendapatkan jawaban "cluster tidak berfungsi." </p><br><p><img src="https://habrastorage.org/webt/rb/ka/aw/rbkaawevhardp1d85mhgdejylxg.png"></p><br><p>  Di VictoriaMetrics, segalanya sedikit lebih mudah.  Untuk versi Single-node, cukup menjalankan satu biner dan semuanya berfungsi. </p><br><p><img src="https://habrastorage.org/webt/co/ui/ll/couillafhtmobnbutejgs6qvszu.png"></p><br><p>  Dalam versi berkerumun, cukup menjalankan semua tiga jenis komponen di atas dalam jumlah apa pun yang Anda butuhkan, atau menggunakan <a href="https://github.com/VictoriaMetrics/helm-charts/" rel="nofollow">bagan kemudi</a> untuk mengotomatiskan peluncuran komponen di Kubernetes.  Kami masih berencana untuk membuat operator Kubernetes.  Helm chart tidak mencakup beberapa kasus, dan memungkinkan Anda untuk menembak kaki Anda.  Misalnya, ini memungkinkan Anda untuk mengurangi jumlah node penyimpanan, yang akan menyebabkan hilangnya data. </p><br><p><img src="https://habrastorage.org/webt/jb/ta/0t/jbta0t7qcko6jov_x1ximqkfni0.png"></p><br><p>  Setelah Anda meluncurkan satu versi biner atau cluster, Anda hanya perlu menambahkan <a href="" rel="nofollow">pengaturan untuk url tulis jarak jauh</a> ke konfigurasi Prometheus sehingga mulai menulis data secara paralel ke penyimpanan lokal dan penyimpanan jarak jauh.  Seperti yang Anda perhatikan, konfigurasi ini harus bekerja jauh lebih andal dibandingkan dengan konfigurasi Thanos.  Kami tidak perlu membuat VictoriaMetrics terhubung dengan semua Prometheus, karena Prometheus sendiri terhubung ke VictoriaMetrics dan mengirimkan data. </p><br><p><img src="https://habrastorage.org/webt/u3/3a/if/u33aifuu7myx3vvs0mkbeysfnei.png"></p><br><p>  Pertimbangkan pengawalan Thanos dan VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/fq/dt/d2/fqdtd27cjx-yktnyozgxoon2pte.png"></p><br><p>  Thanos perlu mengawasi Sidecar agar tidak berhenti memuat data ke dalam Object Storage.  Mereka dapat menghentikan pemuatan data ini karena kesalahan pemuatan, misalnya, koneksi jaringan Anda dengan Object Storage sementara waktu terputus, atau Object Storage sementara tidak tersedia.  Thanos Sidecar pada saat ini akan melihat ini, melaporkan kesalahan, mungkin jatuh dan kemudian berhenti bekerja.  Jika Anda tidak memantaunya, maka data Anda tidak akan lagi ditransfer ke Object Storage.  Jika waktu retensi berlalu (disarankan 6-8 jam), maka Anda akan kehilangan data yang tidak termasuk dalam Object Storage. </p><br><p><img src="https://habrastorage.org/webt/z7/bm/cx/z7bmcxgwyscnrnnehhtjvuqipho.png"></p><br><p>  Pemadat Thanos dapat berhenti bekerja karena <a href="https://github.com/thanos-io/thanos/issues/1919" rel="nofollow">balapan dengan Sidecar</a> .  Compactor mengambil data dari Object Storage dan menggabungkannya menjadi potongan data yang lebih besar.  Karena compactor tidak disinkronkan dengan Sidecar, ini mungkin terjadi: Sidecar belum selesai menulis blok, Compactor memutuskan bahwa blok ini sepenuhnya direkam.  Compactor mulai membacanya.  Itu tidak membaca blok secara keseluruhan dan berhenti bekerja.  Lihat detailnya di <a href="https://thanos.io/proposals/201901-read-write-operations-bucket.md/" rel="nofollow">sini</a> . </p><br><p><img src="https://habrastorage.org/webt/_u/c6/hb/_uc6hbgr_kl9l2an5yl0cs9hfba.png"></p><br><p>  Store Gateway dapat memberikan data yang tidak konsisten karena perlombaan antara Compactor dan Sidecar.  Ini adalah hal yang sama, karena Store Gateway sama sekali tidak sinkron dengan Compactor dan Sidecar.  Dengan demikian, kondisi balapan dapat terjadi ketika Store Gateway tidak melihat bagian dari data atau melihat kelebihan data. </p><br><p><img src="https://habrastorage.org/webt/-y/20/ur/-y20urze7qgwxkrklj8ave_ct3i.png"></p><br><p>  Komponen Query di Thanos default ke hasil parsial jika beberapa Sidecar atau Store Gateway saat ini tidak tersedia.  Anda akan menerima bagian dari data, dan bahkan tidak akan tahu bahwa tidak semua data diterima.  Itu berfungsi seperti ini secara default.  Dalam situasi yang serupa, VictoriaMetrics mengembalikan data yang ditandai sebagai parsial. </p><br><p><img src="https://habrastorage.org/webt/2g/op/wp/2gopwpbh41vviugdebarsjuql4w.png"></p><br><p>  Tidak seperti Thanos, VictoriaMetrics jarang kehilangan data.  Bahkan jika koneksi dari Prometheus ke VictoriaMetrics terputus, maka ini bukan masalah, karena Prometheus terus merekam data baru yang masuk dalam Write Ahead Log, yang berukuran 2 jam.  Jika Anda terhubung kembali ke VictoriaMetrics dalam dua jam, maka data tidak akan hilang.  Prometheus <a href="https://grafana.com/blog/2019/03/25/whats-new-in-prometheus-2.8-wal-based-remote-write/" rel="nofollow">dapat menambahkan data setelah tersambung kembali ke VictoriaMetrics</a> . </p><br><p><img src="https://habrastorage.org/webt/kg/nl/mv/kgnlmvkqxfagsjhodoybpwzl7am.png"></p><br><p>  Tidak seperti Thanos, yang hanya menulis data ke penyimpanan objek setelah dua jam, Prometheus secara otomatis mereplikasi data melalui protokol tulis jarak jauh ke penyimpanan jarak jauh, seperti VictoriaMetrics.  Anda tidak takut kehilangan penyimpanan lokal di Prometheus.  Jika dia tiba-tiba kehilangan penyimpanan lokal, maka dalam kasus terburuk Anda akan kehilangan detik-detik terakhir data yang tidak punya waktu untuk menulis ke penyimpanan jauh. </p><br><p><img src="https://habrastorage.org/webt/ba/xj/90/baxj90beqmojti9xkubodbkbvdw.png"></p><br><p>  Kubernetes secara otomatis mengelola cluster, tidak seperti Thanos.  Semua komponen Thanos sulit untuk dimasukkan ke dalam satu cluster Kubernetes, tidak seperti komponen cluster VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/gz/lb/6l/gzlb6lg2dkrabcovqcohvovd-mk.png"></p><br><p>  VictoriaMetrics memiliki peningkatan yang sangat sederhana ke versi baru.  Hentikan VictoriaMetrics, perbarui binari dan jalankan.  Ketika berhenti melalui sinyal SIGINT, semua binari VictoriaMetrics melakukan shutdown yang anggun.  Mereka dengan benar menyimpan data yang diperlukan, menutup koneksi masuk dengan benar agar tidak kehilangan apa pun.  Karena itu, Anda tidak akan kehilangan apa pun saat meningkatkan. </p><br><p><img src="https://habrastorage.org/webt/qz/yf/8c/qzyf8cvpqlimwabno0zx7v5_rxw.png"></p><br><p>  VictoriaMetrics memiliki cara yang sangat sederhana untuk memperluas cluster.  Cukup tambahkan komponen yang diperlukan dan terus bekerja. </p><br><p><img src="https://habrastorage.org/webt/hl/le/sj/hllesjwiv-f1wosgssd7wp6aclo.png"></p><br><p>  Tentang perangkap di Thanos dan Victoria Metrics. </p><br><p><img src="https://habrastorage.org/webt/xs/ec/b0/xsecb0yy15vimtsl9k9quqplyiw.png"></p><br><p>  Thanos memiliki perangkap berikut.  Prometheus harus menyimpan data selama dua jam terakhir.  Jika hilang, Anda akan benar-benar kehilangannya, karena mereka belum berhasil mendaftar di Object Storage, seperti S3. </p><br><p><img src="https://habrastorage.org/webt/fg/xo/yo/fgxoyo1q8mihcdy7m_yyio_pyum.png"></p><br><p>  Komponen Store Gateway dan komponen pemadat mungkin memerlukan banyak memori untuk bekerja dengan Penyimpanan Objek besar jika banyak file kecil disimpan di sana.  Semakin besar jumlah dan volume file, semakin banyak Store Gateway dan memori pemadat diperlukan untuk menyimpan informasi meta.  Thanos memiliki banyak masalah tentang <a href="https://github.com/thanos-io/thanos/issues/448" rel="nofollow">Store Gateway dan penurunan compactor dengan data rata-rata yang direkam</a> . </p><br><p><img src="https://habrastorage.org/webt/-n/k3/rg/-nk3rgph8ghszyegz1j8jx89bio.png"></p><br><p>  Thanos disebut-sebut dapat mengukur skala dengan jumlah Prometheus Anda tanpa batas.  Ini sebenarnya tidak benar.  Karena semua permintaan melalui komponen Query, yang harus secara bersamaan melakukan polling semua komponen Store Gateway dan semua komponen Sidecar, tarik data dari sana dan kemudian preprocess mereka.  Jelas, kecepatan kueri dibatasi oleh tautan lemah paling lambat, Gerbang Store paling lambat, atau Sidecar paling lambat. </p><br><p>  Komponen-komponen ini mungkin dimuat tidak merata.  Misalnya, Anda memiliki Prometheus yang mengumpulkan jutaan metrik per detik.  Dan ada Prometheus, yang mengumpulkan ribuan metrik per detik.  Prometheus, yang mengumpulkan jutaan metrik per detik, memuat server yang dijalankannya lebih banyak.  Dengan demikian, Sidecar lebih lambat di sana.  Secara umum, semuanya berjalan lambat di sana.  Dan komponen Query akan menarik data dengan sangat lambat dari sana.  Dengan demikian, kinerja seluruh cluster Anda akan dibatasi oleh Sidecar yang lambat ini. </p><br><p><img src="https://habrastorage.org/webt/mg/an/ra/mganracsmhkyz1_1aq014v_6cfc.png"></p><br><p>  Secara default, Thanos mengembalikan data sebagian jika beberapa Sidecar dan Store Gateway tidak tersedia.  Misalnya, jika Anda memiliki Sidecar yang tersebar di seluruh dunia di pusat data yang berbeda, maka kemungkinan pemutusan dan tidak tersedianya komponen meningkat sangat besar.  Karenanya, dalam kebanyakan kasus Anda akan menerima data sebagian tanpa menyadarinya. </p><br><p><img src="https://habrastorage.org/webt/1t/m2/j7/1tm2j75o5cpscbevahbz4m0wusk.png"></p><br><p>  VictoriaMetrics juga memiliki jebakan.  Jebakan pertama adalah opsi yang membatasi jumlah RAM yang digunakan untuk cache VictoriaMetrics.  Secara default, ini sama dengan 60% RAM pada mesin tempat VictoriaMetrics berjalan, atau 60% dari VictoriaMetrics pod RAM di Kubernetes. </p><br><p>  Jika Anda salah mengubah nilai ini, maka Anda dapat merusak kinerja VictoriaMetrics.  Misalnya, jika Anda menetapkan nilai terlalu rendah, data mungkin tidak lagi sesuai dengan cache VictoriaMetrics.  Karena itu, ia harus melakukan pekerjaan ekstra dan memuat prosesor dengan disk.  Jika Anda membuat opsi ini terlalu besar, itu meningkatkan, pertama, kemungkinan bahwa VictoriaMetrics akan crash karena kehabisan memori kesalahan, dan, kedua, ini akan menyebabkan sangat sedikit memori operasional yang tersisa di sistem operasi memori untuk cache file.  Dan VictoriaMetrics mengandalkan cache file untuk kinerja.  Jika itu tidak cukup, maka beban pada disk bisa sangat meningkat.  Karenanya, tip: jangan ubah parameter kecuali benar-benar diperlukan. </p><br><p><img src="https://habrastorage.org/webt/3q/eo/25/3qeo25x5juqpyquhllrhpt9eh34.png"></p><br><p>  Opsi kedua.  Ini adalah retentionPeriod - periode yang ditetapkan ke 1 bulan secara default.  Ini adalah waktu VictoriaMetrics menyimpan data.  Setelah periode ini, VictoriaMetrics menghapus data. </p><br><p>  Banyak yang menjalankan VictoriaMetrics tanpa parameter ini, mereka merekam data selama sebulan.  Dan kemudian mereka bertanya: mengapa data hilang untuk bulan sebelumnya?  Karena retentionPeriod adalah 1 bulan secara default.  Oleh karena itu, Anda perlu mengetahui dan mengatur retensiPeriode yang benar. </p><br><p><img src="https://habrastorage.org/webt/n1/5a/jm/n15ajmeqozq7zfzc0uv3imzfebw.png"></p><br><p>  Mari kita berjalan melalui peluang unik. </p><br><p><img src="https://habrastorage.org/webt/k8/b7/br/k8b7brhqxwy1fa1vdurx0yolgra.png"></p><br><p>  Thanos memiliki fitur seperti downsampling: interval 5 menit dan jam, yang sering <a href="https://github.com/thanos-io/thanos/issues%3Futf8%3D%25E2%259C%2593%26q%3Dis%253Aissue%2Bis%253Aopen%2Bdownsampling" rel="nofollow">tidak berfungsi dengan benar</a> .  Jika Anda Google dan melihat masalah mereka di github, ada banyak masalah yang terkait dengan downsampling ini, bahwa kadang-kadang tidak berfungsi dengan benar, atau tidak berfungsi seperti yang diharapkan pengguna. </p><br><p><img src="https://habrastorage.org/webt/iv/nq/4v/ivnq4vtxkkwf_1hs40ttkyhd1ie.png"></p><br><p>  Thanos memiliki deduplikasi data untuk pasangan HA Prometheus.  Ketika dua Prometheus'a mengumpulkan metrik yang sama dari target yang sama'dan Thanos menempatkan mereka di Object Storage. Thanos     ,    VictoriaMetrics. </p><br><p><img src="https://habrastorage.org/webt/wn/rv/jh/wnrvjhzqrcx6_o9hoojijeivb8o.png"></p><br><p>  Thanos  alert ,     Thanos.   <a href="" rel="nofollow">    production</a> . </p><br><p><img src="https://habrastorage.org/webt/ti/qp/ci/tiqpcidg_t_ahj9lornrey8_rda.png"></p><br><p>  Thanos ,    Thanos   Prometheus — . Thanos  Prometheus      .    Thanos  Prometheus   . </p><br><p><img src="https://habrastorage.org/webt/en/vo/o-/envoo-2amya3w4xo2c5lg-pa1bo.png"></p><br><p>  VictoriaMetrics    — MetricsQL.   VictoriaMetrics  PromQL,       big monitoring metup. </p><br><p><img src="https://habrastorage.org/webt/yk/xq/hi/ykxqhipgapygdv7ra2c6rmaitnk.png"></p><br><p> VictoriaMetrics       . VictoriaMetrics       Prometheus,     Influx, OpenTSDB  Graphite. </p><br><p><img src="https://habrastorage.org/webt/0k/zy/jp/0kzyjptb5sbscny1ffsdh2irqau.png"></p><br><p>  VictoriaMetrics         Thanos  Prometheus. </p><br><p>    ,     2-5          Prometheus  Thanos. </p><br><p><img src="https://habrastorage.org/webt/2y/xz/yg/2yxzygpbfnqt3ldibpggeo35rpw.png"></p><br><p>    VictoriaMetrics —    . </p><br><p><img src="https://habrastorage.org/webt/kk/jd/hy/kkjdhy-zae6bc_3uqu6yp3q1gwy.png"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/79/yz/yw/79yzywujo1uxm6zc5rti6ebjzpq.png"></p><br><p>    Thanos  ,      object storage,   . </p><br><p>     object storage,         ($10   ).      object storage,          ,       AWS —  .    ,    $10  $230  1.    ,        Thanos . </p><br><p><img src="https://habrastorage.org/webt/eg/--/mv/eg--mv_wpjcv4m-tojp8l9r60ea.png"></p><br><p>  Thanos      Compact, Store Gateway, Query ,    ,     . </p><br><p><img src="https://habrastorage.org/webt/pz/0v/np/pz0vnpflfebkxmaqi3sbbucktz0.png"></p><br><p>  VictoriaMetrics  .     GCE HDD ,   $40  1.  VictoriaMetrics   HDD ,    SSD,      . VictoriaMetrics   HDD. </p><br><p><img src="https://habrastorage.org/webt/dr/6q/lz/dr6qlzowqew8et2zpev1wkrq4cs.png"></p><br><p> VictoriaMetrics membutuhkan server untuk komponen: baik Single-nod atau untuk komponen cluster, yang, tidak seperti komponen Thanos, membutuhkan CPU yang lebih sedikit, RAM - itu akan lebih murah sesuai itu. </p><br><p><img src="https://habrastorage.org/webt/ja/72/cr/ja72crhogqpdixrt8jzj-komdcq.png"></p><br><p>  Contoh implementasi. </p><br><p><img src="https://habrastorage.org/webt/od/ji/fw/odjifwunkpjdwuqq-hbpwswu_cy.png"></p><br><p>  Contoh implementasi Thanos adalah Gitlab.  Gitlab sepenuhnya didukung oleh Thanos.  Tapi tidak begitu mulus.  Jika Anda melihat <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8647" rel="nofollow">masalah</a> mereka, Anda dapat melihat bahwa mereka terus-menerus memiliki semacam <a href="https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/8413" rel="nofollow">masalah operasional dengan Thanos</a> : tidak ada cukup memori untuk Store Gateway atau komponen Permintaan.  Mereka terus-menerus harus meningkatkan jumlah memori. </p><br><p>  Karena itu, biaya untuk menyelesaikan masalah ini meningkat. </p><br><p>  Implementasi kedua, yang mungkin lebih sukses, adalah perusahaan Improbable, yang memulai pengembangan Thanos.  Mereka menerbitkan sumber Thanos.  Improbable adalah perusahaan yang mengembangkan mesin game. </p><br><p><img src="https://habrastorage.org/webt/t4/yh/y4/t4yhy4gyfrimyzyfopgdwk1ixyc.png"></p><br><p>  Contoh implementasi publik VictoriaMetrics adalah: </p><br><ul><li>  pembuat situs wix.com </li><li>  Adidas memperkenalkan VictoriaMetrics dan bahkan membuat presentasi di PromCon 2019 terbaru </li><li>  TrafficStars - jaringan iklan </li><li>  Seznam.cz adalah mesin pencari populer di Ceko. </li></ul><br><p>  Dan kemudian pergi ke nama perusahaan, yang saya tidak dapat nama sekarang.  Mereka tidak setuju. </p><br><ul><li>  Salah satu pengembang game utama.  Lebih besar dari mereka Tidak mungkin. </li><li>  Pengembang perangkat lunak grafis utama. </li><li>  Bank besar Rusia. </li><li>  Pabrikan turbin angin Eropa yang telah berhasil menguji VictoriaMetrics.  Pabrikan ini mengimplementasikan VictoriaMetrics untuk memantau data dari turbin angin dengan kecepatan 50 sampel per detik per sensor.  Setiap turbin angin memiliki beberapa ratus sensor.  Mereka memiliki beberapa ratus turbin angin. </li><li>  Maskapai penerbangan Rusia yang ingin memperkenalkan VictoriaMetrics, tetapi masih belum bisa.  Kami berada pada tahap kontrak dengan mereka. </li></ul><br><p><img src="https://habrastorage.org/webt/lw/0f/r3/lw0fr3hdyce3yw6n0i3ywjnpxhs.png">  Kesimpulan </p><br><p>  VictoriaMetrics dan Thanos memecahkan masalah serupa, tetapi dengan cara yang berbeda: </p><br><ul><li>  Tampilan permintaan global </li><li>  skala horizontal </li><li>  retensi sewenang-wenang </li></ul><br><p><img src="https://habrastorage.org/webt/pv/-b/ob/pv-bobndxjkjrcukph5xm3sa-98.png"></p><br><p>  Terima kasih </p><br><p>  Kami menunggu Anda di <a href="https://t.me/VictoriaMetrics_ru1" rel="nofollow">saluran telegram</a> kami. </p><br><p><img src="https://habrastorage.org/webt/gu/0s/w5/gu0sw56ppge1icdy-ensv-wl3f4.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482272/">https://habr.com/ru/post/id482272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482258/index.html">Bagaimana jaringan saraf bekerja dan mengapa mereka mulai menghasilkan uang besar</a></li>
<li><a href="../id482262/index.html">Cara masuk ke Talend Open Studio</a></li>
<li><a href="../id482264/index.html">Brasil, ilmu hitam, Mortal Kombat, Mars dan 15.000 orang. Hasil tahun Ontiko</a></li>
<li><a href="../id482268/index.html">Struktur masa depan: bola Dyson, mesin bintang dan "bom lubang hitam"</a></li>
<li><a href="../id482270/index.html">Streaming WebRTC di dan sekitar realitas virtual</a></li>
<li><a href="../id482274/index.html">5 alasan mengapa Anda harus berhenti menggunakan System.Drawing di ASP.NET</a></li>
<li><a href="../id482276/index.html">GOST R 57580. Dari tren hingga otomatisasi yang efisien</a></li>
<li><a href="../id482280/index.html">Bagaimana cosplay dilakukan. Kostum Jas Lanjutan Isaac Clarke dari Dead Space 2</a></li>
<li><a href="../id482282/index.html">Akhir dari era ARMv7 atau sedikit tentang porting game</a></li>
<li><a href="../id482284/index.html">"50 warna coklat" atau "Bagaimana kita bisa sampai ke sini"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>