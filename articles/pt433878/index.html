<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüöí üë®üèº‚Äçüè≠ üñ≤Ô∏è KVM, passagem de PCI, espelho e tudo-tudo-tudo üëçüèæ üôÜ üë®‚Äçüë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ap√≥s uma transi√ß√£o bem-sucedida para os desenvolvedores de software Linux, chegou o momento em que um pouco de trabalho tamb√©m mudou o sistema operaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>KVM, passagem de PCI, espelho e tudo-tudo-tudo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433878/"> Ap√≥s uma transi√ß√£o bem-sucedida para os desenvolvedores de software Linux, chegou o momento em que um pouco de trabalho tamb√©m mudou o sistema operacional principal.  As preocupa√ß√µes foram causadas pelo software necro-plataforma para apoiar projetos existentes.  Parte do software trabalhava com vinho.  No entanto, alguns softwares se recusam a trabalhar com vinho.  Foi decidido executar o software na m√°quina virtual QEMU + KVM.  O software come√ßou a funcionar, mas trabalhar nele era bastante inconveniente.  As placas de v√≠deo virtuais de software n√£o diferem no desempenho, e o suporte a gr√°ficos 3D √© muito modesto.  Eu tive que descobrir o pandeiro e procurar uma sa√≠da. <br><a name="habracut"></a><br><h1>  Aloque uma placa de v√≠deo separada para o sistema convidado! </h1><br>  N√£o demorou muito tempo para encontrar uma sa√≠da, mas a id√©ia de acertar um pandeiro com um holofote acabou sendo muito estranha.  No t√≥pico de encaminhamento de placas de v√≠deo para uma m√°quina virtual, a Internet est√° repleta de instru√ß√µes diversas vezes e para v√°rios hardwares.  O que √© um grande artigo no site do Arch Linux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[0]</a> .  Darei uma vers√£o resumida das instru√ß√µes para encaminhar uma placa de v√≠deo. <br><br><h3>  0. Verifique se o hardware suporta IOMMU </h3><br>  Por exemplo, aqui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[1]</a> . <br><br><h3>  1. Inclu√≠mos suporte ao IOMMU em um kernel. </h3><br><div class="spoiler">  <b class="spoiler_title">cat / etc / default / grub</b> <div class="spoiler_text"><blockquote>  GRUB_CMDLINE_LINUX_DEFAULT = "respingo silencioso amd_iommu = ativado" <br>  ou <br>  GRUB_CMDLINE_LINUX_DEFAULT = "respingo silencioso intel_iommu = ativado" <br></blockquote><br></div></div><br>  N√£o se esque√ßa do <code>sudo update-grub</code> . <br><br><h3>  2. N√≥s selecionamos a placa de v√≠deo do driver </h3><br>  Pesquisamos os dispositivos necess√°rios e vemos quais drivers os utilizam. <br><br><div class="spoiler">  <b class="spoiler_title">lspci -nnk</b> <div class="spoiler_text"><blockquote>  <b>04: 00.0</b> Controlador compat√≠vel com VGA [0300]: NVIDIA Corporation GT218 [GeForce 210] [ <b>10de: 0a65</b> ] (rev a2) <br>  Driver de kernel em uso: <b>nouveau</b> <br>  M√≥dulos do kernel: nvidiafb, nouveau <br>  <b>04: 00.1</b> Dispositivo de √°udio [0403]: Controlador de √°udio de alta defini√ß√£o NVIDIA Corporation [ <b>10de: 0be3</b> ] (rev a1) <br>  Driver de kernel em uso: <b>snd_hda_intel</b> <br>  M√≥dulos do kernel: snd_hda_intel <br></blockquote><br></div></div><br>  Adicione m√≥dulos VFIO para que eles sejam carregados no momento da inicializa√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">cat / etc / modules |</b>  <b class="spoiler_title">grep vfio</b> <div class="spoiler_text"><blockquote>  vfio <br>  vfio_iommu_type1 <br>  vfio_pci <br>  vfio_virqfd <br></blockquote><br></div></div><br>  Configuramos o m√≥dulo VFIO para que ele intercepte dispositivos, impedindo o carregamento dos principais drivers.  Se necess√°rio, adicione √† lista negra o driver principal. <br><br><div class="spoiler">  <b class="spoiler_title">cat /etc/modprobe.d/vfio.conf</b> <div class="spoiler_text"><blockquote>  op√ß√µes vfio-pci ids = <b>10de: 0a65,10de: 0be3</b> <br>  lista negra nouveau <br></blockquote><br></div></div><br><h3>  3. Reinicialize e verifique se tudo deu certo </h3><br>  IOMMU ligado. <br><br><div class="spoiler">  <b class="spoiler_title">dmesg</b>  <b class="spoiler_title">grep -e DMAR -e IOMMU -e AMD-Vi</b> <div class="spoiler_text"><blockquote>  DMAR: Tecnologia de virtualiza√ß√£o Intel¬Æ para E / S direcionada <br>  ou <br>  AMD-Vi: IOMMU encontrado em 0000: 00: 00.2 cap 0x40 <br>  AMD-Vi: remapeamento de interrup√ß√£o ativado <br>  AMD-Vi: libera√ß√£o lenta de IO / TLB ativada <br></blockquote><br></div></div><br>  Dispositivos compostos ca√≠ram em um grupo. <br><br><div class="spoiler">  <b class="spoiler_title">para um em / sys / kernel / iommu_groups / *;</b>  <b class="spoiler_title">encontre $ a -type l;</b>  <b class="spoiler_title">feito |</b>  <b class="spoiler_title">sort --version-sort</b> <div class="spoiler_text"><blockquote>  <b>/sys/kernel/iommu_groups/15/devices/0000:01:00.0</b> <b><br></b>  <b>/sys/kernel/iommu_groups/15/devices/0000:01:00.1</b> <br>  /sys/kernel/iommu_groups/16/devices/0000:02:00.0 <br>  /sys/kernel/iommu_groups/17/devices/0000:03:00.0 <br>  <b>/sys/kernel/iommu_groups/18/devices/0000:04:00.0</b> <b><br></b>  <b>/sys/kernel/iommu_groups/18/devices/0000:04:00.1</b> <br></blockquote><br></div></div><br>  Drivers KVM e VFIO carregados. <br><br><div class="spoiler">  <b class="spoiler_title">lsmod |</b>  <b class="spoiler_title">grep -e kvm -e vfio</b> <div class="spoiler_text"><blockquote><pre> kvm_amd 94208 0
 ccp 90112 1 kvm_amd
 kvm 622592 1 kvm_amd
 vfio_pci 45056 0
 vfio_virqfd 16384 1 vfio_pci
 irqbypass 16384 2 vfio_pci, kvm
 vfio_iommu_type1 24576 0
 vfio 28672 2 vfio_iommu_type1, vfio_pci
</pre></blockquote><br></div></div><br>  Placa de v√≠deo para o sistema operacional convidado capturada pelo VFIO. <br><br><div class="spoiler">  <b class="spoiler_title">lspci -nnk</b> <div class="spoiler_text"><blockquote>  <b>04: 00.0</b> Controlador compat√≠vel com VGA [0300]: NVIDIA Corporation GT218 [GeForce 210] [ <b>10de: 0a65</b> ] (rev a2) <br>  Driver de kernel em uso: <b>vfio-pci</b> <br>  M√≥dulos do kernel: nvidiafb, nouveau <br>  <b>04: 00.1</b> Dispositivo de √°udio [0403]: Controlador de √°udio de alta defini√ß√£o NVIDIA Corporation [ <b>10de: 0be3</b> ] (rev a1) <br>  Driver de kernel em uso: <b>vfio-pci</b> <br>  M√≥dulos do kernel: snd_hda_intel <br></blockquote><br></div></div><br><h3>  4. Configure o QEMU e inicie o SO convidado </h3><br><div class="spoiler">  <b class="spoiler_title">Instalar, se ainda n√£o estiver instalado</b> <div class="spoiler_text"><blockquote>  sudo apt instala o qemu-kvm qemu-utils seabios ovmf virt-viewer <br></blockquote></div></div><br><div class="spoiler">  <b class="spoiler_title">Crie um disco em que o sistema operacional convidado ser√° instalado</b> <div class="spoiler_text"><blockquote>  qemu-img create -f raw -o pr√©-posicionamento = h√≥spede completo.img 50G <br>  ou <br>  fallocate -l 50G guest.img <br></blockquote></div></div><br>  Iniciamos a m√°quina virtual sem encaminhar a placa de v√≠deo para instalar o SO convidado.  Como existe uma vis√£o do Looking Glass, vale a pena escolher o Windows 10. Para o h√≥spede, o Windows 10. O Windows 8 / 8.1 de acordo com os dados mais recentes tamb√©m √© suportado. <br><br><div class="spoiler">  <b class="spoiler_title">vga_qxl.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  tempero de visualizador remoto: //127.0.0.1: 5900 &amp; <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'w10.iso', se = ide, formato = bruto, √≠ndice = 2, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga qxl \ <br>  -spice port = 5900, addr = 127.0.0.1, disable-ticketing \ <br>  -monitor stdio \ <br>  -netdev user, id = n1, ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br><h3>  5. Encaminhamos a placa de v√≠deo para o SO convidado </h3><br>  Para come√ßar, inicialize com duas placas de v√≠deo.  Observamos que a placa encaminhada apareceu no sistema, colocamos os drivers e garantimos que eles funcionem. <br><br><div class="spoiler">  <b class="spoiler_title">vga_qxl_pass.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  tempero de visualizador remoto: //127.0.0.1: 5900 &amp; <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga qxl \ <br>  -spice port = 5900, addr = 127.0.0.1, disable-ticketing \ <br>  <b>- dispositivo ioh3420, barramento = pcie.0, endere√ßo = 1c.0, multifuncional = ativado, porta = 1, chassi = 1, id = root \</b> <b><br></b>  <b>-device vfio-pci, host = 04: 00.0, barramento = raiz, endere√ßo = 00.0, multifuncional = ativado \</b> <b><br></b>  <b>-dispositivo vfio-pci, host = 04: 00.1, barramento = raiz, endere√ßo = 00.1 \</b> <br>  -monitor stdio \ <br>  -netdev user, id = n1, ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br>  Depois de como a placa de v√≠deo encaminhada funcionou, e no gerenciador de dispositivos escrever ‚ÄúO dispositivo est√° funcionando bem‚Äù, iniciamos a m√°quina virtual apenas com a placa de v√≠deo encaminhada. <br><br><div class="spoiler">  <b class="spoiler_title">vga_pass.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga <b>nenhum</b> \ <br>  - dispositivo ioh3420, barramento = pcie.0, endere√ßo = 1c.0, multifuncional = ativado, porta = 1, chassi = 1, id = root \ <br>  -device vfio-pci, host = 04: 00.0, barramento = raiz, endere√ßo = 00.0, multifuncional = ativado \ <br>  -dispositivo vfio-pci, host = 04: 00.1, barramento = raiz, endere√ßo = 00.1 \ <br>  -monitor stdio \ <br>  -netdev user, id = n1, ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br>  Conectamos um monitor a ele e admiramos a imagem da √°rea de trabalho do sistema operacional convidado. <br><br><h1>  O lugar onde as decis√µes simples terminam </h1><br>  E ent√£o a divers√£o come√ßa.  Algu√©m, est√° tudo bem, a imagem desapareceu e tudo √© simples.  Minha experi√™ncia trope√ßou duas vezes no est√°gio de aus√™ncia de imagem.  A primeira vez foi o encaminhamento da placa de v√≠deo integrada do processador Intel 6700T HD 530, as sa√≠das de v√≠deo estavam vazias e a falha foi atribu√≠da ao fato de os plug-ins n√£o funcionarem bem.  Na segunda vez que a Nvidia GF210 externa foi lan√ßada, que j√° havia sido comprada especialmente para experimentos.  O resultado foi ainda mais interessante.  No modo n√£o EFI, a placa de v√≠deo foi encaminhada com sucesso e at√© mostrou uma imagem, mas <abbr title="cerca de 50 a 50">desativou o</abbr> sistema operacional convidado. <br><br>  O encaminhamento subsequente pode simplesmente travar o host.  Algumas horas de f√°cil busca no Google levam ao fato de que o problema de congelar uma placa de v√≠deo √© bastante comum.  Isso leva ao desligamento incorreto da m√°quina virtual e, com alguma chance, at√© ao desligamento correto.  Como sa√≠da, √© recomend√°vel encaminhar no modo EFI.  Mas o VBIOS Nvidia GF210 n√£o suporta EFI ... <br><br><h3>  Costurar ou n√£o costurar, eis a quest√£o </h3><br>  N√£o costure.  O QEMU suporta falsifica√ß√£o VBIOS ao encaminhar uma placa de v√≠deo.  Mas o VBIOS ainda precisa ser ensinado a suportar o modo EFI.  Geralmente √© recomend√°vel verificar isso antes de come√ßar a encaminhar a placa de v√≠deo, por exemplo aqui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[2]</a> .  Mas √© preciso lidar com o que √© e n√£o queremos procurar uma nova placa de v√≠deo com suporte √† EFI.  Ent√£o voc√™ precisa corrigir o VBIOS.  <u>Todas as opera√ß√µes realizadas com o VBIOS s√£o feitas por sua conta e risco.</u>  Eu usei um pacote de software e instru√ß√µes para ele daqui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[3]</a> .  Depois de ler o VBIOS, obtemos o arquivo <code>gt210.rom</code> , patch e, na sa√≠da, temos <code>gt210_uefi.rom</code> .  √â aqui que voc√™ precisa deslizar a placa de v√≠deo ao carregar a m√°quina virtual. <br><br><div class="spoiler">  <b class="spoiler_title">vga_pass_rom.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga nenhum \ <br>  - dispositivo ioh3420, barramento = pcie.0, endere√ßo = 1c.0, multifuncional = ativado, porta = 1, chassi = 1, id = root \ <br>  -dispositivo vfio-pci, host = 04: 00.0, barramento = raiz, endere√ßo = 00.0, multifuncional = <b>ativado</b> , <b>romfile = gt210_uefi.rom</b> \ <br>  -dispositivo vfio-pci, host = 04: 00.1, barramento = raiz, endere√ßo = 00.1 \ <br>  -monitor stdio \ <br>  -netdev user, id = n1, ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br>  Come√ßamos a m√°quina virtual e olhamos. <br><br><h3>  Escurid√£o </h3><br>  As sa√≠das da placa de v√≠deo brilhavam no escuro.  Mais uma vez, a moralidade passou no teste do fracasso.  A primeira coisa que vem √† mente √© que o sistema operacional convidado trava na inicializa√ß√£o.  Logs, preciso dos logs dela.  Para fazer isso, execute <code>vga_qxl.sh</code> .  N√≥s olhamos para o lan√ßamento anterior.  E est√° tudo bem, exceto que a comida foi cortada com for√ßa.  Acontece que funciona, embora n√£o funcione.  A primeira id√©ia foi conectar via RDP e ver o que acontece l√°, mas ainda √© melhor usar o VNC, por exemplo, tightvnc <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[4]</a> .  Instalamos o VNC, configuramos a porta <code>5600</code> e encaminhamos essa porta para acesso do host. <br><br><div class="spoiler">  <b class="spoiler_title">vga_vnc_pass_rom.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga nenhum \ <br>  - dispositivo ioh3420, barramento = pcie.0, endere√ßo = 1c.0, multifuncional = ativado, porta = 1, chassi = 1, id = root \ <br>  -dispositivo vfio-pci, host = 04: 00.0, barramento = raiz, endere√ßo = 00.0, multifuncional = ativado, romfile = gt210_uefi.rom \ <br>  -dispositivo vfio-pci, host = 04: 00.1, barramento = raiz, endere√ßo = 00.1 \ <br>  -monitor stdio \ <br>  -netdev user, id = n1, <b>hostfwd = tcp: 127.0.0.1: 5600-: 5600,</b> ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br>  Conectamos e vemos a m√°quina em funcionamento, apenas o monitor possui um Monitor Gen√©rico N√£o-PnP estranho (o Universal Monitor n√£o √© PnP).  H√° uma imagem, para que voc√™ possa tentar executar o Looking Glass. <br><br><h3>  Espelho </h3><br>  Embora essa tecnologia use o OpenGL, n√£o √© necess√°rio espa√ßo ap√≥s o gl.  Mas voc√™ precisa ler as instru√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[5]</a> no site do projeto.  Para o sistema operacional convidado, fa√ßa o download da tela <b>-</b> capture o aplicativo <b>olhando-glass-host.exe</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[6]</a> , fa√ßa o download e instale o Microsoft Visual C ++ 2015 Redistributable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[7]</a> , fa√ßa o download do driver do dispositivo IVSHMEM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[8]</a> .  Adicionamos depend√™ncias para o host, baixamos e constru√≠mos o aplicativo cliente. <br><br><div class="spoiler">  <b class="spoiler_title">build_looking_glass_a12.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  sudo apt-get install cmake libsdl2-dev libsdl2-ttf-dev nettle-dev libspice-protocol-dev libfontconfig1-dev libx11-dev fontes-freefont-ttf libconfig-dev <br>  wget <a href="">github.com/gnif/LookingGlass/archive/a12.tar.gz</a> <br>  tar -xf a12.tar.gz <br>  cd LookingGlass-a12 <br>  cliente / compila√ß√£o mkdir <br>  cliente / constru√ß√£o de cd <br>  cmake ../ <br>  fazer <br></blockquote></div></div><br>  Iniciamos a m√°quina virtual com o dispositivo IVSHMEM.  O tamanho da mem√≥ria de 32 Mb √© selecionado para uma resolu√ß√£o de 1920x1080. <br><br><div class="spoiler">  <b class="spoiler_title">vga_vnc_lg_pass_rom.sh</b> <div class="spoiler_text"><blockquote>  #! / bin / bash <br>  <b>se [!</b>  <b>-f / dev / shm / espelho];</b>  <b>ent√£o</b> <b><br></b>  <b>toque / dev / shm / espelho</b> <b><br></b>  <b>chown `whoami`: kvm / dev / shm / espelho</b> <b><br></b>  <b>chmod 660 / dev / shm / espelho</b> <b><br></b>  <b>fi</b> <br>  sudo qemu-system-x86_64 \ <br>  -m√°quina q35, accel = kvm \ <br>  -enable-kvm \ <br>  -cpu host, kvm = desativado, marque \ <br>  -smp cpus = 2, soquetes = 1, n√∫cleos = 2, threads = 1 \ <br>  -m 6G \ <br>  -rtc base = hora local, rel√≥gio = host \ <br>  -dispositivo piix3-usb-uhci \ <br>  -dispositivo usb-tablet \ <br>  -drive if = pflash, formato = bruto, somente leitura, arquivo = / usr / share / OVMF / OVMF_CODE.fd \ <br>  -drive arquivo = 'virtio-win-0.1.141_st.iso', se = ide, formato = bruto, √≠ndice = 3, m√≠dia = cdrom, cache = nenhum \ <br>  -drive arquivo = 'guest.img', se = ide, formato = bruto, √≠ndice = 4, m√≠dia = disco, cache = write-back \ <br>  -vga nenhum \ <br>  - dispositivo ioh3420, barramento = pcie.0, endere√ßo = 1c.0, multifuncional = ativado, porta = 1, chassi = 1, id = root \ <br>  -dispositivo vfio-pci, host = 04: 00.0, barramento = raiz, endere√ßo = 00.0, multifuncional = ativado, romfile = gt210_uefi.rom \ <br>  -dispositivo vfio-pci, host = 04: 00.1, barramento = raiz, endere√ßo = 00.1 \ <br>  <b>-device ivshmem-plain, memdev = ivshmem, barramento = pcie.0 \</b> <b><br></b>  <b>-objeto de arquivo de back-end de mem√≥ria, id = ivshmem, compartilhamento = ativado, caminho de mem = / dev / shm / espelho, tamanho = 32M \</b> <br>  -monitor stdio \ <br>  -netdev user, id = n1, hostfwd = tcp: 127.0.0.1: 5600-: 5600, ipv6 = off, smb = "/ media / user / data" \ <br>  -dispositivo e1000, netdev = n1, mac = 67: 77: 78: 88: 89: 99 \ <br>  "$ @" <br></blockquote></div></div><br>  N√≥s nos conectamos via VNC, instalamos o driver no dispositivo IVSHMEM, talvez um driver padr√£o seja instalado nele, localizado em "Dispositivos do sistema".  Come√ßamos a <b>olhar-glass-host.exe</b> .  No host, execute <code>./LookingGlass-a12/client/build/looking-glass-client</code> . <br><br>  Com isso, um sistema com NVidia GF210 funcionou para mim e, em seguida, o Intel HD530 foi lan√ßado na mesma rota.  Houve um pequeno problema com a resolu√ß√£o da tela. Para mudar para uma resolu√ß√£o rara, por exemplo 2048x1152, tive que usar o Custom Resolution Utility <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[9]</a> . <br><br>  Outra nuance, ao adicionar o <b>aplicativo olhando-espelho-host.exe</b> ao carregamento autom√°tico, voc√™ precisa configurar o login autom√°tico do usu√°rio; por motivos de seguran√ßa, o sistema operacional convidado n√£o permite capturar a tela de login. <br><br><h1>  Posf√°cio </h1><br>  Se voc√™ n√£o definir uma tarefa, obtendo uma imagem em uma sa√≠da de v√≠deo f√≠sico, esse resultado ser√° suficiente para obter uma m√°quina virtual em funcionamento com uma placa de v√≠deo f√≠sica e controle responsivo.  O gerenciamento √© realizado a partir do host em uma janela separada ou em tela cheia.  No entanto, existem nuances. <br><br>  <b>Performance</b> .  Os recursos indiretos para virtualiza√ß√£o e n√£o o sistema operacional convidado mais eficiente n√£o permitir√£o que voc√™ trabalhe confortavelmente em hardware fraco e m√©dio-baixo.  Isso exigir√° um processador poderoso de pelo menos 6 a 8 n√∫cleos, uma boa placa gr√°fica para um sistema operacional convidado, 16 GB + RAM, pelo menos 8 GB para cada sistema operacional.  E dan√ßando com um pandeiro para aproveitar ao m√°ximo o ferro. <br>  <b>Paci√™ncia</b> .  Se n√£o funcionar imediatamente, voc√™ ter√° que gastar tempo e tempo decentemente.  Pesquise, leia, tente.  Mais uma vez, olhe, leia e tente novamente.  Deixarei mais alguns links que encontrei, talvez haja mais informa√ß√µes √∫teis.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[10]</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[11]</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[12]</a> <br><br>  <b>Refer√™ncias</b> <br><br>  Cuidado, os links s√£o abertos nesta janela. <br><br><a name="L0"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">0. https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF</a> <br><a name="L1"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. https://en.wikipedia.org/wiki/List_of_IOMMU-supporting_hardware</a> <br><a name="L2"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2. https://www.techpowerup.com/vgabios/</a> <br><a name="L3"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3. https://www.win-raid.com/t892f16-AMD-and-Nvidia-GOP-update-No-requests-DIY.html</a> <br><a name="L4"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">4. https://www.tightvnc.com/download.php</a> <br><a name="L5"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5. https://looking-glass.hostfission.com/quickstart</a> <br><a name="L6"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6. https://github.com/gnif/LookingGlass/releases</a> <br><a name="L7"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7. https://www.microsoft.com/en-us/download/details.aspx?id=48145</a> <br><a name="L8"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">8. https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/upstream-virtio/</a> <br><a name="L9"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">9. https://www.monitortests.com/forum/Thread-Custom-Resolution-Utility-CRU</a> <br><a name="L10"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">10. https://heiko-sieger.info/running-windows-10-on-linux-using-kvm-with-vga-passthrough</a> <br><a name="L11"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">11. https://ycnrg.org/vga-passthrough-with-ovmf-vfio/</a> <br><a name="L12"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">12. https://www.reddit.com/r/VFIO/comments/8h352p/guide_running_windows_via_qemukvm_and_intel_gvtg/</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433878/">https://habr.com/ru/post/pt433878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433868/index.html">Por que o medidor de glicose do Alphabet n√£o voou</a></li>
<li><a href="../pt433870/index.html">Por que √© t√£o dif√≠cil medir continuamente a glicose?</a></li>
<li><a href="../pt433872/index.html">Acesso m√≥vel - usando um smartphone em sistemas de controle de acesso</a></li>
<li><a href="../pt433874/index.html">Experi√™ncias de interface neural JavaScript</a></li>
<li><a href="../pt433876/index.html">Apresenta√ß√µes tridimensionais de produtos no Three.js para os menores</a></li>
<li><a href="../pt433880/index.html">Dicas de vida para desenvolvedores: usando o SQ (qualificador de origem) com efici√™ncia no Informatica Power Center</a></li>
<li><a href="../pt433884/index.html">Aspectos legais da vigil√¢ncia por v√≠deo: como evitar problemas com a lei</a></li>
<li><a href="../pt433886/index.html">Aprendizado de m√°quina Python com demonstra√ß√µes interativas do Jupyter</a></li>
<li><a href="../pt433888/index.html">O uso de baterias de √≠on de l√≠tio no no-break monof√°sico</a></li>
<li><a href="../pt433892/index.html">FSTEC vs NIST: prote√ß√£o contra vazamentos em russo e americano</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>