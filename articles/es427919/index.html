<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåßÔ∏è üë©üèø‚Äçüöí üé≥ Portar COM a Linux ü§ü üëÅ‚Äçüó® üåº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me gusta la tecnolog√≠a COM. Pero no hablaremos de tecnolog√≠a, elogios o deficiencias de COM, sino de la experiencia de portar e implementar en Linux. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Portar COM a Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427919/">  Me gusta la tecnolog√≠a COM.  Pero no hablaremos de tecnolog√≠a, elogios o deficiencias de COM, sino de la experiencia de portar e implementar en Linux.  Una bicicleta?  Expediencia? <a name="habracut"></a>  No nos centremos en esto. <br><br><div class="spoiler">  <b class="spoiler_title">Enlaces Wiki y MSDN</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Modelo de objeto componente</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Modelo de objetos componentes de MSDN (COM)</a> <br></div></div><br>  <b>Objeto COM <sup>(1)</sup></b> <br><br><p>  En t√©rminos generales, un objeto de una clase que implementa al menos una interfaz COM.  La implementaci√≥n del objeto se oculta principalmente en una biblioteca conectada din√°micamente llamada servidor COM <sup>(2)</sup> , las interfaces se publican y distribuyen para su uso. </p><br><p>  Interfaz COM, una clase abstracta que contiene solo funciones virtuales puras.  Se resalta una interfaz IUnknown especial, cualquier objeto COM debe implementar esta interfaz. </p><br><p>  Cada interfaz COM debe contener su propio identificador.  En COM, est√° determinado por la estructura del GUID y aqu√≠ enfrentaremos el primer inconveniente de COM.  El GUID es incomprensible y no se lee bien, y todo lo dem√°s descrito en el Wiki.  Lo necesitamos igual, pero de una manera m√°s legible y comprensible (llam√©moslo uiid). </p><br>  <u>I Desconocido y uiid</u> <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> define_uiid(name) \ inline static const std::string&amp; guid() { const static std::string idn(dom_guid_pre_name #name); return idn; } namespace Dom { using uiid = std::string; using clsuid= std::string; struct IUnknown { virtual long AddRef() = 0; virtual long Release() = 0; virtual bool QueryInterface(const uiid&amp;, void **ppv) = 0; define_uiid(Unknown) }; }</span></span></code> </pre> <br><p>  Adem√°s del identificador de interfaz, tambi√©n se asigna el identificador de clase (clsuid), que es necesario para crear el objeto.  En nuestro caso, porque  este es un identificador menos legible que puede determinar la esencia, puede olvidarse de su publicaci√≥n por ahora (tal vez esto no sea bueno). </p><br><p>  <u>Resumen</u> <br>  Un objeto COM que contiene un identificador de clase √∫nica.  Implementa al menos una interfaz COM: IUnknown (cualquier interfaz COM tiene un identificador de interfaz √∫nico).  Las diferentes implementaciones de un objeto COM pueden tener el mismo identificador de clase (ejemplo: versi√≥n de lanzamiento y depuraci√≥n). </p><br><br>  <b>Servidor COM <sup>(2)</sup></b> <br><br><p>  Una biblioteca vinculada din√°micamente (para Linux es un objeto compartido, por lo tanto) que implementa al menos un objeto COM.  El servidor debe exportar un conjunto espec√≠fico de funciones: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllCreateInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uiid&amp; iid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">** ppv)</span></span></span></span></code> </pre>  Crea un objeto de clase por clsuid, aumenta el n√∫mero de referencias a eso, cada vez que el objeto se crea con √©xito.  La llamada a IUnknown :: AddRef tambi√©n deber√≠a aumentar el recuento de referencias para eso, y IUnknown :: Release deber√≠a disminuir. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllCanUnloadNow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre> <br>  Si el n√∫mero de referencias a SO es 0, puede descargar la biblioteca. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllRegisterServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IUnknown* unknown)</span></span></span></span></code> </pre> <br>  Registra todos los servidores clsuid en el "registro".  Llamado una vez durante la instalaci√≥n del servidor COM. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllUnRegisterServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IUnknown* unknown)</span></span></span></span></code> </pre> <br>  Elimina de las entradas de "registro" sobre el servidor clsuid registrado.  Llamado una vez al desinstalar el servidor COM. <br><br>  <u>Ejemplo de SimpleHello, declare la interfaz IHello:</u> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IHello</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Dom::IUnknown { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; define_uiid(Hello) };</code> </pre><br>  <u>Implementaci√≥n de interfaz:</u> <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* COM- */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleHello</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dom::Implement&lt;SimpleHello, IHello&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: SimpleHello() { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, __PRETTY_FUNCTION__); } ~SimpleHello() { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, __PRETTY_FUNCTION__); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from %s\n"</span></span>,__PRETTY_FUNCTION__); } define_clsuid(SimpleHello) }; <span class="hljs-comment"><span class="hljs-comment">/* COM- */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Dom { <span class="hljs-function"><span class="hljs-function">DOM_SERVER_EXPORT_BEGIN </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EXPORT_CLASS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SimpleHello)</span></span></span><span class="hljs-function"> DOM_SERVER_EXPORT_END </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DOM_SERVER_INSTALL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IUnknown* unknown)</span></span></span><span class="hljs-function"> </span></span>{ Interface&lt;IRegistryServer&gt; registry; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unknown-&gt;QueryInterface(IRegistryServer::guid(), registry)) { <span class="hljs-comment"><span class="hljs-comment">//      } return true; } DOM_SERVER_UNINSTALL(IUnknown* unknown) { Interface&lt;IRegistryServer&gt; registry; if (unknown-&gt;QueryInterface(IRegistryServer::guid(), registry)) { //      } return true; } }</span></span></code> </pre><br><p>  Un conjunto de macros oculta implementaciones de funciones al proporcionar una declaraci√≥n y l√≥gica m√°s estructuradas. </p><br><p>  Dom :: Implementar &lt;SimpleHello, IHello&gt;: oculta la implementaci√≥n de los m√©todos de interfaz IUnknown, agrega "az√∫car" al declarar interfaces implementadas por un objeto (C ++ 11 y plantillas variadas): </p><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ... IFACES&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Implement</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IUnknown, <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IFACES‚Ä¶ { ... };</code> </pre><br><p>  Interfaz IRegistryServer: define un conjunto de m√©todos para trabajar con el "registro" de servidores COM. </p><br>  <b>"Registro" de servidores COM <sup>(3)</sup></b> <br><br><p>  La importancia del registro puede subestimarse, pero probablemente sea el pilar principal de COM.  Microsoft escribe en el registro, crea una estructura compleja para describir las interfaces y sus atributos (idl), fui un poco diferente. </p><br><p>  En la implementaci√≥n, el registro se basa en el sistema de archivos. <br>  ¬øQu√© tipo de bollos?  La comprensibilidad, la simplicidad, la posibilidad de recuperaci√≥n, un bollo especial al registrar un servidor, puede establecer alg√∫n tipo de espacio de nombres (un directorio relativo al registro base en el que se registrar√°n los objetos del servidor), por lo que puede implementar la integridad y el control de versiones de las aplicaciones utilizando la tecnolog√≠a. </p><br><p>  De las deficiencias, posibles problemas de seguridad, la sustituci√≥n de implementaciones de objetos. </p><br>  <b>C√≥mo usar, aplicaci√≥n de muestra <sup>(4)</sup></b> <br><br><p>  Para que todo funcione, necesitar√° una peque√±a "biblioteca" y un peque√±o "programa". </p><br><p>  <u>"Biblioteca"</u> no es m√°s que un contenedor que implementa y recopila todo en un solo conjunto, trabajando con el registro, cargando / descargando SO, creando objetos. <br>  Es el √∫nico que debe especificarse al compilar la aplicaci√≥n.  Todo lo dem√°s, "Quiero creer", lo har√° ella misma. </p><br><p>  <u>"</u> Programka <u>"</u> : regsrv es en realidad un an√°logo del programa RegSrv32 de Microsoft que realiza las mismas acciones (+ la capacidad de especificar un espacio de nombres, + la capacidad de obtener una lista de servidores clsuid y COM registrados). </p><br><br>  <u>muestra</u> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../include/dom.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../../skel/ihello.h"</span></span></span><span class="hljs-meta"> int main() { Dom::Interface</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Dom::IUnknown&gt; unkwn; Dom::Interface&lt;IHello&gt; hello; if (Dom::CreateInstance(Dom::clsid("SimpleHello"), unkwn)) { unkwn-&gt;QueryInterface(IHello::guid(), hello); hello-&gt;Print(); } else { printf("[WARNING] Class `SimpleHello` not register.\nFirst execute command\n\tregsrv &lt;fullpath&gt;/libskel.so\n... and try again."); } return 0; }</span></span></span></span></code> </pre><br>  <b>Dom <sup>(5)</sup></b> <br><br><p>  Dom (Modelo Din√°mico de Objetos), mi implementaci√≥n para Linux. <br><br>  <a href="">git clone</a> <br></p><br>  Gracias </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427919/">https://habr.com/ru/post/es427919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427909/index.html">Python: ¬øc√≥mo reducir el consumo de memoria a la mitad agregando solo una l√≠nea de c√≥digo?</a></li>
<li><a href="../es427911/index.html">Pasiones de oficina</a></li>
<li><a href="../es427913/index.html">Pr√≥logo entretenido # 2</a></li>
<li><a href="../es427915/index.html">Presunci√≥n de estupidez</a></li>
<li><a href="../es427917/index.html">Respuesta a la publicaci√≥n Presunci√≥n de la mente</a></li>
<li><a href="../es427921/index.html">4 videos sobre la dilaci√≥n</a></li>
<li><a href="../es427923/index.html">C√≥mo agregu√© un nuevo dispositivo al SmartThings Hub, parte 1</a></li>
<li><a href="../es427925/index.html">Migraci√≥n sin v√≠ctimas: lista de verificaci√≥n t√©cnica para mover un sitio a un nuevo dominio</a></li>
<li><a href="../es427927/index.html">B - Brutalidad. Sitio oficial de la Federaci√≥n de Tenis de Mesa de la Rep√∫blica de Bashkortost√°n (FTN RB)</a></li>
<li><a href="../es427929/index.html">Ministerio de Trabajo: la tarea de prueba es una relaci√≥n laboral</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>