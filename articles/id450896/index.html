<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🏭 👆 🐥 Lab: mengkonfigurasi lvm, raid di linux 🛋️ 🦄 👴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Penyimpangan kecil: ini sintetik. 


 Beberapa tugas yang dijelaskan di sini dapat dilakukan jauh lebih mudah, tetapi karena tugas l / r adalah berken...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Lab: mengkonfigurasi lvm, raid di linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450896/"><p>  Penyimpangan kecil: ini sintetik. </p><br><p>  Beberapa tugas yang dijelaskan di sini dapat dilakukan jauh lebih mudah, tetapi karena tugas l / r adalah berkenalan dengan serangan, fungsionalitas lvm, beberapa operasi secara artifisial rumit. </p><br><h2 id="trebovaniya-k-instrumentam-dlya-vypolneniya-lr">  Persyaratan untuk alat untuk melakukan l: </h2><br><ul><li>  Alat virtualisasi seperti Virtualbox </li><li>  Gambar instalasi Linux seperti <a href="">Debian9</a> </li><li>  Ketersediaan internet untuk mengunduh beberapa paket </li><li>  Koneksi via ssh ke VM yang diinstal (opsional) </li></ul><br><h2 id="vnimanie">  PERHATIAN </h2><br><p>  Pekerjaan laboratorium ini dikaitkan dengan masalah rumit seperti keamanan data - ini adalah area yang memungkinkan Anda kehilangan semua data Anda karena kesalahan terkecil - satu huruf atau angka tambahan. </p><br><p>  Karena Anda melakukan pekerjaan laboratorium, Anda tidak dalam bahaya, kecuali Anda harus mulai melakukannya lagi. </p><br><p>  Dalam kehidupan nyata, semuanya jauh lebih serius, jadi Anda harus hati-hati memasukkan nama disk, memahami apa yang sebenarnya Anda jalankan dengan perintah saat ini dan disk mana yang Anda gunakan. </p><a name="habracut"></a><br><p>  Poin penting kedua adalah penamaan disk dan partisi: tergantung pada situasinya, jumlah disk mungkin berbeda dari nilai-nilai yang disajikan dalam perintah di laboratorium. <br>  Jadi, misalnya, jika Anda menghapus drive sda ​​dari array, dan kemudian menambahkan drive baru, drive baru akan ditampilkan pada sistem dengan nama sda.  Jika Anda reboot sebelum menambahkan disk baru, disk baru akan dinamai sdb, dan yang lama akan dinamai sda </p><br><p>  Pekerjaan lab harus dilakukan di bawah superuser (root) karena sebagian besar perintah membutuhkan hak yang lebih tinggi dan tidak masuk akal untuk terus meningkatkan hak istimewa melalui sudo. </p><br><h2 id="materialy-dlya-izucheniya">  Bahan studi </h2><br><ul><li>  RAID </li><li>  LVM </li><li>  Penamaan Disk Linux </li><li>  Apa itu bagian </li><li>  Apa itu tabel partisi dan di mana disimpan? </li><li>  Apa itu grub? </li></ul><br><h2 id="ispolzuemye-utility">  Utilitas Digunakan </h2><br><ol><li>  Lihat informasi disk: <br><ul><li>  lsblk -o NAMA, UKURAN, FSTYPE, TYPE, MOUNTPOINT </li><li>  fdisk -l </li></ul></li><li>  Lihat informasi dan bekerja dengan LVM <br><ul><li>  pvs </li><li>  pvextend </li><li>  buat pvc </li><li>  pvresize </li><li>  ay </li><li>  vgreduce </li><li>  ls </li><li>  lvextend </li></ul></li><li>  Lihat informasi dan bekerja dengan RAID: <br><ul><li>  cat / proc / mdstat </li><li>  mdadm </li></ul></li><li>  Poin Gunung: <br><ul><li>  mount </li><li>  umount </li><li>  cat / etc / fstab </li><li>  cat / etc / mtab </li></ul></li><li>  Mempartisi ulang disk: <br><ul><li>  fdisk / dev / XXX </li></ul></li><li>  Menyalin bagian: <br><ul><li>  dd if = / dev / xxx = / dev / yyy </li></ul></li><li>  Bekerja dengan tabel partisi: <br><ul><li>  partx </li><li>  sfdisk </li><li>  mkfs.ext4 </li></ul></li><li>  Bekerja dengan bootloader: <br><ul><li>  grub-install / dev / XXX </li><li>  perbarui-grub </li></ul></li><li>  misc <br><ul><li>  lsof </li><li>  apt </li><li>  rsync </li></ul></li></ol><br><h2 id="laboratornaya-rabota-sostoit-iz-3-h-chastey">  Pekerjaan laboratorium terdiri dari 3 bagian: </h2><br><ul><li>  Mengkonfigurasi sistem yang sehat menggunakan lvm, raid. </li><li>  Persaingan kegagalan salah satu drive. </li><li>  Mengganti disk dengan cepat, dengan tambahan disk baru dan transfer partisi. </li></ul><br><h2 id="zadanie-1-ustanovka-os-i-nastroyka-lvm-raid">  Tugas 1 (Menginstal OS dan Mengkonfigurasi LVM, RAID) </h2><br><ol><li><p>  Buat mesin virtual baru dengan fitur berikut: </p><br><ul><li>  1 gb ram </li><li>  1 cpu </li><li>  2 hdd (beri nama ssd1, ssd2 dan tetapkan ukuran yang sama, centang kotak hot swap dan ssd) </li><li>  Pengontrol SATA yang dikonfigurasi pada 4 port: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18f/6f5/be6/18f6f5be6afbc13138abc3dfe960813b.png" alt="pilih ssd disk"></li></ul><br></li><li><p>  Mulai menginstal Linux dan pergi ke pilihan hard drive lakukan hal berikut: </p><br><ul><li>  Metode partisi: manual, setelah itu Anda akan melihat gambar berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77a/eb5/3a1/77aeb53a1de2bc7b91d1396dc9b4148e.png" alt="disk partisi"></li><li>  Menyiapkan partisi terpisah di bawah / boot: Pilih disk pertama dan buat tabel partisi baru di atasnya: <br><ul><li>  Ukuran partisi: 512M </li><li>  Mount point: / boot </li></ul></li><li>  Ulangi pengaturan untuk disk kedua, tetapi karena Anda tidak dapat memasang / mem-boot 2 kali secara bersamaan, pilih titik mount: tidak ada dan akhirnya mendapatkan yang berikut (gambar dengan kusen, ulangi kemalasan): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3db/2f0/e48/3db2f0e48423f182016bde06c39dfb8d.png" alt="disk partisi"></li><li>  Pengaturan RAID: </li><li>  Pilih ruang kosong pada disk pertama dan konfigurasikan volume fisik untuk RAID sebagai jenis partisi. </li><li>  Pilih "Selesai menyiapkan partisi" </li><li>  Ulangi pengaturan yang sama persis untuk disk kedua, menghasilkan yang berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93f/37c/ec3/93f37cec319d628a3267f94d138145e7.png" alt="disk partisi"></li><li>  Pilih "Konfigurasi perangkat lunak RAID" <br><ul><li>  Buat perangkat MD </li><li>  Jenis perangkat RAID perangkat lunak: Pilih array cermin </li><li>  Perangkat aktif untuk array XXXX RAID: Pilih kedua drive </li><li>  Perangkat cadangan: Biarkan 0 sebagai bawaan </li><li>  Perangkat aktif untuk array RAID XX: pilih partisi yang Anda buat di bawah serangan </li><li>  Selesai </li></ul></li><li>  Pada akhirnya, Anda harus mendapatkan gambar ini: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a7/9b0/3f5/7a79b03f556925d1fd53ccc4ca77b494.png" alt="disk partisi"></li><li>  LVM Setup: Pilih Configure the Logical Volume Manager </li><li>  Pertahankan tata letak partisi saat ini dan konfigurasikan LVM: Ya </li><li>  Buat grup volume </li><li>  Nama grup volume: sistem </li><li>  Perangkat untuk grup volume baru: Pilih RAID yang Anda buat </li><li>  Buat volume logis <br><ul><li>  nama volume logis: root </li><li>  ukuran volume logis: 2 \ 5 dari ukuran disk Anda </li></ul></li><li>  Buat volume logis <br><ul><li>  nama volume logis: var </li><li>  ukuran volume logis: 2 \ 5 dari ukuran disk Anda </li></ul></li><li>  Buat volume logis <br><ul><li>  nama volume logis: log </li><li>  ukuran volume logis: 1 \ 5 dari ukuran disk Anda </li></ul></li><li>  Memilih detail konfigurasi Display Anda harus mendapatkan gambar berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/8dd/11f/0b88dd11f9372dbf8e53a6727fc69b27.png" alt="disk partisi"></li><li>  Setelah menyelesaikan konfigurasi LVM, Anda akan melihat yang berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72b/9d4/00d/72b9d400d9b83392c759b7aeb3e9d573.png" alt="disk partisi"></li><li>  Mempartisi: pada gilirannya, pilih setiap volume yang dibuat dalam LVM dan partisi, misalnya, untuk root seperti ini: <br><ul><li>  Gunakan sebagai: ext4 </li><li>  mount point: / </li></ul></li><li>  Hasil dari menandai partisi root adalah sebagai berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/225/61e/0be/22561e0be2cd905e0948a63ae3460461.png" alt="disk partisi"></li><li>  Ulangi operasi markup untuk var dan log dengan memilih titik mount yang sesuai (/ var dan / var / log masukkan secara manual), dapatkan hasil berikut: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5da/58c/756/5da58c756fd8d205a93ebfd49acc396f.png" alt="disk partisi"></li><li>  Pilih Finish Partitioning </li><li>  Anda akan ditanya beberapa pertanyaan tentang fakta bahwa Anda masih memiliki partisi yang belum di-mount dan swap tidak dikonfigurasi.  Kedua pertanyaan harus dijawab secara negatif. </li><li>  Hasil akhir akan terlihat seperti ini: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/117/381/a61/117381a61b766df3c89d2646baa2b33d.png" alt="disk partisi"></li></ul><br></li><li><p>  Selesai instalasi OS dengan menginstal grub pada perangkat pertama (sda) dan boot sistem. </p><br></li><li><p>  Salin isi partisi / boot dari drive sda ​​(ssd1) ke drive sdb (ssd2) </p><br><pre><code class="plaintext hljs">dd if=/dev/sda1 of=/dev/sdb1</code> </pre> <br></li><li><p>  Instal grub di perangkat kedua: </p><br><ul><li><p>  Lihat drive di sistem: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li>  Buat daftar semua disk yang diberikan perintah sebelumnya kepada Anda dan jelaskan disk jenis apa itu. </li><li><p>  Temukan drive tempat grub tidak diinstal dan selesaikan instalasi ini: </p><br><pre> <code class="plaintext hljs">grub-install /dev/sdb</code> </pre> <br></li><li>  Lihat serangan saat ini dengan cat / proc / mdstat dan tuliskan apa yang Anda lihat. </li><li>  Lihatlah output dari perintah: pvs, vgs, lvs, mount dan tuliskan apa yang Anda lihat. </li></ul><br></li></ol><br><p>  Jelaskan dengan kata-kata Anda sendiri apa yang Anda lakukan dan hasil apa yang Anda dapatkan sebagai hasil dari tugas yang diselesaikan. </p><br><p>  Setelah menyelesaikan tugas ini, Anda disarankan untuk membuat cadangan folder dengan mesin virtual atau membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kotak gelandangan</a> . </p><br><p>  Hasil: Mesin virtual dengan ssd1, ssd2 disk. </p><br><h2 id="zadanie-2-emulyaciya-otkaza-odnogo-iz-diskov">  Tugas 2 (Meniru kegagalan salah satu drive) </h2><br><ol><li>  Jika Anda menandai kotak centang hot swap, maka Anda dapat menghapus disk saat itu juga: <br><ul><li>  Hapus drive ssd1 di properti mesin. </li><li>  Temukan direktori tempat file mesin virtual Anda disimpan dan hapus ssd1.vmdk. </li></ul></li><li>  Pastikan mesin virtual Anda masih berjalan. </li><li>  Nyalakan ulang mesin virtual dan pastikan masih berfungsi </li><li>  Periksa status array RAID: <code>cat /proc/mdstat</code> </li><li>  Tambahkan disk baru dengan ukuran yang sama di antarmuka VM dan beri nama ssd3. </li><li>  Lakukan operasi: <br><ul><li>  Lihatlah disk baru yang masuk ke sistem dengan <code>fdisk -l</code> </li><li>  Salin tabel partisi dari disk lama ke yang baru: <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> </li><li>  Lihat hasilnya dengan <code>fdisk -l</code> </li><li>  Tambahkan disk baru ke array raid: <code>mdadm --manage /dev/md0 --add /dev/YYY</code> </li><li>  Lihat hasilnya: <code>cat /proc/mdstat</code> .  Anda akan melihat bahwa sinkronisasi telah dimulai. </li></ul></li><li><p>  Sekarang Anda perlu menyinkronkan secara manual partisi yang bukan merupakan bagian dari RAID.  Untuk melakukan ini, kita akan menggunakan utilitas dd, menyalin dari disk "live" ke yang baru yang baru saja Anda instal: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li>  Setelah sinkronisasi selesai, instal grub pada disk baru. </li><li>  Nyalakan ulang VM untuk memastikan semuanya berfungsi. </li></ol><br><p>  Jelaskan dengan kata-kata Anda sendiri apa yang Anda lakukan dan hasil apa yang Anda dapatkan sebagai hasil dari tugas yang diselesaikan. </p><br><p>  <strong>Hasil:</strong> menghapus drive ssd1, menyimpan drive ssd2, menambahkan drive ssd3. </p><br><h2 id="zadanie-3-dobavlenie-novyh-diskov-i-perenos-razdela">  Tugas 3 (Menambahkan Disk dan Partisi Baru) </h2><br><p>  Ini adalah tugas yang paling sulit dan banyak dari semua yang disajikan.  Periksa dengan cermat apa yang Anda lakukan dan dengan disk dan partisi mana.  Disarankan agar Anda mengambil salinan sebelum menjalankannya.  Tugas ini, terlepas dari tugas nomor 2, dapat dilakukan setelah tugas nomor 1, disesuaikan untuk nama disk. </p><br><p>  Bagian kedua dari penugasan laboratorium ini harus mengarah ke kondisi yang sama persis seperti setelah menyelesaikan bagian pertama. </p><br><p>  Agar lebih mudah bagi Anda untuk bekerja, saya sarankan tidak secara fisik menghapus disk dari mesin host, tetapi hanya melepaskan mereka di properti mesin.  Dari sudut pandang OS di VM, ini akan terlihat persis sama, tetapi dalam hal ini Anda dapat menghubungkan drive kembali dan terus bekerja dengan memutar kembali beberapa poin jika Anda memiliki masalah.  Misalnya, Anda mungkin telah melakukan kesalahan atau lupa menyalin partisi / boot ke disk baru.  Saya hanya dapat menyarankan Anda untuk memeriksa ulang beberapa kali dengan disk dan partisi mana Anda bekerja, dan bahkan lebih baik, tulis korespondensi disk, partisi dan nomor disk "fisik" pada selembar kertas.  Perintah <code>lsblk</code> menggambar pohon yang indah dan mudah dimengerti, gunakan sesering mungkin untuk menganalisis apa yang telah Anda lakukan dan apa yang perlu dilakukan. </p><br><p>  Untuk cerita ... </p><br><p>  Bayangkan server Anda bekerja lama di 2 ssd disk, ketika tiba-tiba ... </p><br><ol><li><p>  Mensimulasikan kegagalan disk ssd2 dengan menghapus disk dari properti VM dan me-reboot. </p><br></li><li><p>  Lihat status disk dan RAID saat ini: </p><br><pre> <code class="plaintext hljs">cat /proc/mdstat fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Anda beruntung - otoritas diizinkan untuk membeli beberapa disc baru: </p><br><p>  2 SATA volume besar untuk tugas lama memindahkan bagian log ke disk terpisah.  2 SSD untuk menggantikan yang sudah mati, serta untuk mengganti yang masih berfungsi. </p><br><p>  Perlu diingat bahwa keranjang server hanya mendukung pemasangan 4 drive.  pada saat yang sama, sehingga Anda tidak dapat menambahkan semua disk sekaligus. </p><br><p>  Volume HDD yang dipilih 2 kali lebih banyak dari SSD. <br>  Volume SSD memilih 1,25 kali ukuran SSD sebelumnya. </p><br></li><li><p>  Tambahkan satu drive ssd baru, beri nama ssd4, dan setelah menambahkan periksa apa yang terjadi: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Pertama-tama, Anda harus menjaga keamanan data dari disk lama.  Kali ini kami akan mentransfer data menggunakan LVM: </p><br><ul><li><p>  Pertama-tama, Anda perlu menyalin tabel file dari disk lama ke yang baru: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br><p>  Ganti disk yang benar, bukan x, y dan cari tahu apa yang dilakukan perintah ini. </p><br></li><li>  Jalankan lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT dan bandingkan hasilnya dengan panggilan sebelumnya.  Apa yang berubah? </li><li><p>  Gunakan perintah dd untuk menyalin / mem-boot data ke disk baru: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Jika / boot tetap terpasang pada drive lama, itu harus dipasang pada live drive: </p><br><pre> <code class="bash hljs">mount | grep boot <span class="hljs-comment"><span class="hljs-comment">#     lsblk #           ,     umount /boot #  /boot mount -a #      /etc/fstab. #      /dev/sda,        </span></span></code> </pre> <br></li><li><p>  Instal bootloader pada drive SSD baru: </p><br><pre> <code class="plaintext hljs">grub-install /dev/YYY</code> </pre> <br><p>  Mengapa kita melakukan operasi ini? </p><br></li><li><p>  Buat array serangan baru dengan hanya satu drive SSD baru yang disertakan: </p><br><pre> <code class="plaintext hljs">mdadm --create --verbose /dev/md63 --level=1 --raid-devices=1 /dev/YYY</code> </pre> <br><p>  Perintah di atas tidak akan berfungsi tanpa menentukan kunci khusus. Baca bantuan dan tambahkan kunci ini ke perintah. </p><br></li><li>  Gunakan perintah cat / proc / mdstat untuk memverifikasi hasil operasi Anda.  Apa yang berubah? </li><li>  Jalankan lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT dan bandingkan hasilnya dengan panggilan sebelumnya.  Apa yang berubah? </li></ul><br></li><li><p>  Langkah selanjutnya adalah mengkonfigurasi LVM </p><br><ul><li>  Jalankan perintah pvs untuk melihat informasi tentang volume fisik saat ini. </li><li><p>  Buat volume fisik baru dengan memasukkan array RAID yang dibuat sebelumnya di dalamnya: </p><br><pre> <code class="plaintext hljs">pvcreate /dev/md63</code> </pre> <br></li><li>  Jalankan lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT dan bandingkan hasilnya dengan panggilan sebelumnya.  Apa yang berubah? </li><li>  Jalankan perintah pvs lagi.  Apa yang berubah? </li><li><p>  Tambah ukuran sistem Volume Group dengan perintah berikut: </p><br><pre> <code class="plaintext hljs">vgextend system /dev/md63</code> </pre> <br></li><li><p>  Jalankan perintah dan tulis apa yang Anda lihat dan apa yang berubah. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices</code> </pre> <br><p>  Apa disk fisik itu LV var, log, root sekarang? </p><br></li><li><p>  Pindahkan data dari drive lama ke yang baru dengan mengganti nama perangkat yang benar. </p><br><pre> <code class="plaintext hljs">pvmove -i 10 -n /dev/system/root /dev/md0 /dev/md63</code> </pre> <br><p>  Ulangi operasi untuk semua volume logis. </p><br></li><li><p>  Jalankan perintah dan tulis apa yang Anda lihat dan apa yang berubah. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Ubah VG kami dengan menghapus raid lama dari itu.  Ganti nama serangan yang benar. </p><br><pre> <code class="plaintext hljs">vgreduce system /dev/md0</code> </pre> <br></li><li><p>  Jalankan perintah dan tulis apa yang Anda lihat dan apa yang berubah. </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT pvs vgs</code> </pre> <br></li><li>  Untuk keindahan gambar, remount / boot ke drive SSD kedua (ssd4) dan jalankan lsblk.  Akibatnya, tidak ada yang harus dipasang pada disk SSD3.  Periksa dengan hati-hati bahwa partisi / boot tidak kosong!  <code>ls /boot</code> akan menampilkan beberapa file dan folder.  Periksa apa yang disimpan di bagian ini dan tuliskan file / direktori mana yang bertanggung jawab untuk apa. </li></ul><br></li><li><p>  Hapus disk ssd3 dan tambahkan ssd5, hdd1, hdd2 sesuai dengan TK di atas, akhirnya mendapatkan: </p><br><ul><li>  ssd4 - ssd baru pertama </li><li>  ssd5 - ssd baru kedua </li><li>  hdd1 - hdd baru pertama </li><li>  hdd2 - hdd baru kedua </li></ul><br></li><li><p>  Periksa apa yang terjadi setelah menambahkan disk: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Mari mengembalikan array serangan utama: </p><br><ul><li><p>  Salin tabel partisi, gantikan disk yang benar: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br></li><li><p>  Harap dicatat bahwa ketika kami menyalin tabel partisi dari disk lama, ternyata ukuran baru tidak menggunakan seluruh ruang hard disk.  Karena itu, segera kita perlu mengubah ukuran bagian ini dan memperluas serangan.  Lihat sendiri dengan memasukkan perintah: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Salin partisi / boot boot dari ssd4 ke ssd5: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Instal grub pada disk baru (ssd5). </p><br></li><li><p>  Ubah ukuran partisi kedua drive ssd5. </p><br><ul><li><p>  Jalankan utilitas untuk bekerja dengan tata letak disk: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Masukkan tombol d untuk menghapus partisi yang ada (pilih 2). </li><li>  Masukkan tombol n untuk membuat partisi baru. </li><li>  Masukkan kunci p untuk menunjukkan jenis partisi primer. </li><li>  Masukkan kunci 2 sehingga partisi baru memiliki nomor kedua. </li><li>  Sektor pertama: tekan enter untuk menerima ukuran awal bagian yang dihitung secara otomatis. </li><li>  Sektor terakhir: tekan enter untuk menerima ukuran bagian ujung yang dihitung secara otomatis. </li><li>  Masukkan kunci l untuk melihat daftar semua jenis partisi yang mungkin dan temukan Linux raid otomatis di dalamnya. </li><li>  Masukkan kunci t untuk mengubah jenis partisi yang dibuat (2) dan masukkan nomor yang ditemukan pada langkah sebelumnya. </li><li>  Masukkan kunci w untuk menulis perubahan ke disk. </li></ul><br></li><li><p>  Baca kembali tabel partisi dan periksa hasilnya: </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><ul><li><p>  Tambahkan disk baru ke array serangan saat ini (jangan lupa untuk mengganti disk yang benar): </p><br><pre> <code class="plaintext hljs">mdadm --manage /dev/md63 --add /dev/sda2</code> </pre> <br></li><li><p>  Kami memperluas jumlah disk dalam array kami menjadi 2 buah: </p><br><pre> <code class="plaintext hljs">mdadm --grow /dev/md63 --raid-devices=2</code> </pre> <br></li><li><p>  Lihatlah hasilnya: kami memiliki 2 array yang ditandai, tetapi kedua bagian yang termasuk dalam array ini memiliki ukuran yang berbeda: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Tambah ukuran partisi pada disk SSD4 </p><br><ul><li><p>  Jalankan utilitas untuk bekerja dengan tata letak disk: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Masukkan tombol d untuk menghapus partisi yang ada (pilih 2). </li><li>  Masukkan tombol n untuk membuat partisi baru. </li><li>  Masukkan kunci p untuk menunjukkan jenis partisi primer. </li><li>  Masukkan kunci 2 sehingga partisi baru memiliki nomor kedua. </li><li>  Sektor pertama: tekan enter untuk menerima ukuran awal bagian yang dihitung secara otomatis. </li><li>  Sektor terakhir: tekan enter untuk menerima ukuran bagian ujung yang dihitung secara otomatis. </li><li>  Di akhir markup, pilih Tidak untuk meninggalkan tanda tangan bahwa bagian itu milik array. </li><li>  Masukkan kunci w untuk menulis perubahan ke disk. </li></ul><br></li><li><p>  Kami membaca kembali tabel partisi dan memeriksa hasilnya. </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><p>  Harap dicatat bahwa sekarang sda2, partisi sdc2 lebih besar dari ukuran perangkat serangan. </p><br></li><li><p>  Pada titik ini, ukuran serangan sekarang dapat diperluas: </p><br><pre> <code class="bash hljs">mdadm --grow /dev/md63 --size=max lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT <span class="hljs-comment"><span class="hljs-comment"># check result</span></span></code> </pre> <br><p>  Jelajahi lsblk dan tulis apa yang telah berubah. </p><br></li><li><p>  Namun, meskipun kami mengubah ukuran serangan, ukuran vg root, var, log sendiri tidak berubah. </p><br><ul><li><p>  Lihatlah ukuran PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li><li><p>  Perpanjang ukuran PV kami: </p><br><pre> <code class="bash hljs">pvresize /dev/md63</code> </pre> <br></li><li><p>  Lihatlah ukuran PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li></ul><br></li><li><p>  Tambahkan tempat yang baru muncul VG var, root: </p><br><pre> <code class="bash hljs">lvs <span class="hljs-comment"><span class="hljs-comment">#     lvextend -l +50%FREE /dev/system/root lvextend -l +100%FREE /dev/system/var lvs #   </span></span></code> </pre> <br><p>  Pada titik ini, Anda telah menyelesaikan migrasi array utama ke disk baru.  bekerja dengan ssd1, ssd2 selesai. </p><br></li><li><p>  Tugas kita selanjutnya adalah memindahkan / var / log ke drive baru, untuk ini kita akan membuat array baru dan lvm pada drive hdd. </p><br><ul><li><p>  Mari kita lihat apa nama yang memiliki drive hdd baru: </p><br><pre> <code class="bash hljs">fdisk -l</code> </pre> <br></li><li><p>  Buat array serangan: </p><br><pre> <code class="bash hljs">mdadm --create /dev/md127 --level=1 --raid-devices=2 /dev/sdc /dev/sdd</code> </pre> <br></li><li><p>  Buat PV baru dalam serangan dari disk besar: </p><br><pre> <code class="bash hljs">pvcreate data /dev/md127</code> </pre> <br></li><li><p>  Dalam PV ini, buat grup yang disebut data: </p><br><pre> <code class="bash hljs">vgcreate data /dev/md127</code> </pre> <br></li><li><p>  Buat volume logis dengan ukuran semua ruang kosong dan sebutlah val_log: </p><br><pre> <code class="bash hljs">lvcreate -l 100%FREE -n var_log data <span class="hljs-comment"><span class="hljs-comment"># lvs #  </span></span></code> </pre> <br></li><li><p>  Format partisi yang dibuat di ext4: </p><br><pre> <code class="bash hljs">mkfs.ext4 /dev/mapper/data-var_log</code> </pre> <br></li><li><p>  Mari kita lihat hasilnya: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Transfer data log dari bagian lama ke yang baru </p><br><ul><li><p>  Kami akan memasang penyimpanan log baru sementara: </p><br><pre> <code class="plaintext hljs">mount /dev/mapper/data-var_log /mnt</code> </pre> <br></li><li><p>  Mari menyinkronkan bagian: </p><br><pre> <code class="bash hljs">apt install rsync rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Cari tahu proses mana yang berjalan dengan / var / log sekarang: </p><br><pre> <code class="bash hljs">apt install lsof lsof | grep <span class="hljs-string"><span class="hljs-string">'/var/log'</span></span></code> </pre> <br></li><li><p>  Kami menghentikan proses ini: </p><br><pre> <code class="bash hljs">systemctl stop rsyslog.service syslog.socket</code> </pre> <br></li><li><p>  Kami akan melakukan sinkronisasi akhir partisi (dari data yang bisa berubah sejak sinkronisasi terakhir): </p><br><pre> <code class="bash hljs">rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Tukar bagian: </p><br><pre> <code class="bash hljs">umount /mnt umount /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mount /dev/mapper/data-var_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br></li><li><p>  Periksa apa yang terjadi: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Edit / etc / fstab </p><br><p>  fstab - file di mana aturan ditulis sesuai dengan partisi yang akan dipasang saat boot.  Tugas kami adalah menemukan baris di mana / var / log dipasang dan memperbaiki perangkat <code>system-log</code> ke <code>data-var_log</code> . </p><br></li><li><p>  Yang paling penting pada tahap ini adalah ingat untuk mengubah tabel partisi (ext4, misalnya).  Karena tidak masalah bagaimana kita mengubah semua jenis serangan, lvm - sampai sistem file pada partisi diberi tahu bahwa ukuran partisi sekarang telah berubah, kita tidak akan dapat menggunakan ruang baru.  Gunakan perintah <code>resize2fs</code> untuk mengubah FS. </p><br></li><li><p>  Akord terakhir </p><br><ul><li>  Mari kita reboot.  Jika Anda melakukan semuanya dengan benar, Anda akan menemukan diri Anda lagi di OS Anda (ini diperlukan untuk memastikan semuanya bekerja. Langkah ini tidak memiliki arti kecuali untuk pengujian sendiri) </li><li><p>  Pastikan semua yang ingin kami lakukan benar-benar dilakukan: </p><br><pre> <code class="bash hljs">pvs lvs vgs lsblk cat /proc/mdstat</code> </pre> <br></li></ul><br></li><li><p>  [OPTIONAL] Ikuti langkah-langkahnya </p><br><ul><li>  Reboot dengan menekan F12 untuk menunjukkan disk yang berbeda saat boot, untuk memastikan bahwa Anda dapat boot dari salah satu disk SSD, sehingga kami tidak takut salah satu dari mereka gagal. </li><li><p>  Anda sekarang memiliki log LV yang tidak perlu dalam sistem VG.  Sebarkan spasi ini di antara root atau var, tetapi alih-alih menggunakan konstruksi GRATIS 100%, tentukan ukurannya dengan tangan Anda menggunakan sakelar -L: </p><br><pre> <code class="bash hljs">-L 500M</code> </pre> <br></li><li>  Perbaiki masalah dengan fakta bahwa / boot ada di dua partisi tanpa sinkronisasi, Anda tidak perlu melakukan ini dengan cara yang benar, ini ditambahkan sebagai contoh.  Jangan lupa menyalin isi / boot di suatu tempat. </li><li>  Buat serangan baru dan sertakan sda1, sda2 di dalamnya. </li><li>  Sertakan partisi ini dalam raid yang ada dan restore / boot pada dasarnya raid, tetapi tanpa memasangnya lagi. </li></ul><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id450896/">https://habr.com/ru/post/id450896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id450886/index.html">Latar belakang: bagaimana mobil hidrogen bekerja dan kapan mereka muncul di jalan</a></li>
<li><a href="../id450888/index.html">Swift: Saringan Eratosthenes</a></li>
<li><a href="../id450890/index.html">Google I / O News 2019: Pixel 3a, Android Q, Kotlin, dan lainnya</a></li>
<li><a href="../id450892/index.html">Apakah kecepatan penyimpanan cocok untuk etcd? Tanyakan fio</a></li>
<li><a href="../id450894/index.html">Tentang antena untuk yang terkecil</a></li>
<li><a href="../id450898/index.html">Pengembangan antarmuka pada banyak layar. Langkah menggunakan AI</a></li>
<li><a href="../id450902/index.html">Ingin karyawan yang loyal - mulailah dengan diri Anda sendiri</a></li>
<li><a href="../id450904/index.html">Praktis penggelaran aplikasi Inti ASP.NET berlabuh ke Heroku</a></li>
<li><a href="../id450906/index.html">Bagaimana memulai hidup dan menanam selada</a></li>
<li><a href="../id450908/index.html">Jaringan daftar hitam untuk Asterisk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>