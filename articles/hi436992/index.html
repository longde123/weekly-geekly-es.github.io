<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯТВЁЯП╝ ЁЯСитАНЁЯПл ЁЯСЦ HTTP рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕реА рдХрд╛ рдЪрдпрди рдХрд░рддреЗ рд╕рдордп рдкрд░реАрдХреНрд╖рдг рдФрд░ рддреНрд░реБрдЯрд┐ ЁЯжЕ ЁЯЩНЁЯП╗ ЁЯЧСя╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╕рднреА рдХреЛ рдирдорд╕реНрдХрд╛рд░! 

 рдЖрдЬ рд╣рдо рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдУрд╕реНрдЯреНрд░реЛрд╡реЛрдХреЙрд╡ рд╣реЛрдЯрд▓ рдЖрд░рдХреНрд╖рдг рд╕реЗрд╡рд╛ рдЯреАрдо рдиреЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡рд░ рд╡рд┐рдХрд╛рд╕ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рдХреИрд╕реЗ рд╣рд▓ рдХрд┐рдпрд╛, рдЬрд┐рд╕рдХрд╛ рдХрд╛рд░...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HTTP рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕реА рдХрд╛ рдЪрдпрди рдХрд░рддреЗ рд╕рдордп рдкрд░реАрдХреНрд╖рдг рдФрд░ рддреНрд░реБрдЯрд┐</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/436992/">  рд╕рднреА рдХреЛ рдирдорд╕реНрдХрд╛рд░! <br><br>  рдЖрдЬ рд╣рдо рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдУрд╕реНрдЯреНрд░реЛрд╡реЛрдХреЙрд╡</a> рд╣реЛрдЯрд▓ рдЖрд░рдХреНрд╖рдг рд╕реЗрд╡рд╛ рдЯреАрдо рдиреЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡рд░ рд╡рд┐рдХрд╛рд╕ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рдХреИрд╕реЗ рд╣рд▓ рдХрд┐рдпрд╛, рдЬрд┐рд╕рдХрд╛ рдХрд╛рд░реНрдп рд╣рдорд╛рд░реЗ рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕реВрдЪрдирд╛ рдХрд╛ рдЖрджрд╛рди-рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реИред  рдЕрдкрдиреЗ рдЕрдиреБрднрд╡ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" class="user_link">рдУрдбреНрд░реЛрд╡реЙрдХ</a> рдореЗрдВ рджреЗрд╡рдУрдкреНрд╕ рдЯреАрдо рд▓реАрдбред <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mb/qx/eh/mbqxehqjq4oabybefapvvbpqadg.png"></div><a name="habracut"></a><br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдорд╛рдЗрдХреНрд░реЛрд╕реИрд╕ рд╕рд░реНрд╡рд┐рд╕ рдЫреЛрдЯрд╛ рдерд╛ рдФрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдХрд░рддрд╛ рдерд╛: <br><br><ul><li>  рд╕реНрдерд╛рдиреАрдп рд╕реЗрд╡рд╛ рд╕реЗ рдЕрдиреБрд░реЛрдз рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ; </li><li>  рдПрдХ рд╕рд╛рдереА рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдВ; </li><li>  рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рдХрд░реЗрдВ; </li><li>  рдХреНрд╡реЗрд░реА рд╕реЗрд╡рд╛ рдкрд░ рдкрд░рд┐рдгрд╛рдо рд▓реМрдЯрд╛рдПрдВред </li></ul><br>  рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рдордп рдмреАрдд рдЧрдпрд╛, рд╕реЗрд╡рд╛ рднрд╛рдЧреАрджрд╛рд░реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдФрд░ рдЙрдирдХреЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдмрдврд╝рддреА рдЧрдИред <br><br>  рдЬреИрд╕реЗ-рдЬреИрд╕реЗ рд╕реЗрд╡рд╛ рдмрдврд╝реА, рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ рдЙрднрд░рдиреЗ рд▓рдЧреАрдВред  рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рджрд╛рддрд╛ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдирд┐рдпрдореЛрдВ рдХреЛ рдЖрдЧреЗ рд░рдЦрддреЗ рд╣реИрдВ: рдХреЛрдИ рдЕрдзрд┐рдХрддрдо рдХрдиреЗрдХреНрд╢рди рдХреА рд╕реАрдорд╛ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИ, рдХреЛрдИ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рд╕рдлреЗрдж рд╕реВрдЪреА рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред <br><cut></cut><br>  рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рдирд╛ рдкрдбрд╝рд╛: <br><br><ul><li>  рдХрдИ рдирд┐рд╢реНрдЪрд┐рдд рдмрд╛рд╣рд░реА рдЖрдИрдкреА рдкрддреЗ рд╣реЛрдирд╛ рд╡рд╛рдВрдЫрдиреАрдп рд╣реИ рддрд╛рдХрд┐ рдЖрдк рдЙрдиреНрд╣реЗрдВ рд╕рдлреЗрдж рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рднрд╛рдЧреАрджрд╛рд░реЛрдВ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХреЗрдВ, </li><li>  рд╕рднреА рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХрд╛ рдПрдХ рдПрдХрд▓ рдкреВрд▓ рд╣реИ рддрд╛рдХрд┐ рдЬрдм рд╣рдорд╛рд░реЗ рдорд╛рдЗрдХреНрд░реЛрд╕рд░реНрд╡рд┐рд╕ рдХреЛ рд╕реНрдХреЗрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдП рддреЛ рдХрдиреЗрдХреНрд╢рди рдХреА рд╕рдВрдЦреНрдпрд╛ рдХрдо рд╕реЗ рдХрдо рдмрдиреА рд░рд╣реЗ, </li><li>  SSL рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдПрдХ рд╕реНрдерд╛рди рдкрд░ рд░рдЦреЗрдВ, рдЬрд┐рд╕рд╕реЗ рднрд╛рдЧреАрджрд╛рд░реЛрдВ рдкрд░ рднрд╛рд░ рдХрдо рд╣реЛред </li></ul><br>  рдЙрдиреНрд╣реЛрдВрдиреЗ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдирд╣реАрдВ рд╕реЛрдЪрд╛ рдФрд░ рддреБрд░рдВрдд рд╕реЛрдЪрд╛ рдХрд┐ рдХреНрдпрд╛ рдЪреБрдирдирд╛ рд╣реИ: рдирдЧрдиреЗрдХреНрд╕ рдпрд╛ рд╣рд╛рдкреНрд░реЛрд╕реАред <br>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдкреЗрдВрдбреБрд▓рдо рдиреЗрдЧреНрдиреЗрдХреНрд╕ рдХреА рдУрд░ рдШреВрдо рдЧрдпрд╛, рдХреНрдпреЛрдВрдХрд┐ HTTP / HTTPS I рд╕реЗ рдЬреБрдбрд╝реА рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рдорд╕реНрдпрд╛рдПрдВ рдЗрд╕рдХреА рдорджрдж рд╕реЗ рд╣рд▓ рд╣реБрдИрдВ рдФрд░ рд╣рдореЗрд╢рд╛ рдкрд░рд┐рдгрд╛рдо рд╕реЗ рд╕рдВрддреБрд╖реНрдЯ рдереАрдВред <br><br>  рдпрд╣ рдпреЛрдЬрдирд╛ рд╕рд░рд▓ рдереА: Nginx рдкрд░ рд╣рдорд╛рд░реЗ рдирдП рдкреНрд░реЙрдХреНрд╕реА рд╕рд░реНрд╡рд░ рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдХрд┐ рдлреЙрд░реНрдо рдХреЗ рдПрдХ рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде <code>&lt;partner_tag&gt;.domain.local</code> , Nginx рдореЗрдВ рдПрдХ <code>map</code> рдерд╛ рдЬрд╣рд╛рдВ <code>&lt;partner_tag&gt;</code> рд╕рд╛рдЭреЗрджрд╛рд░ рдХреЗ рдкрддреЗ рдХреЗ рдЕрдиреБрд░реВрдк рдерд╛ред  рдПрдХ рдкрддрд╛ <code>map</code> рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ <code>proxy_pass</code> рдХреЛ рдЗрд╕ рдкрддреЗ рдкрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред <br><br>  рдпрд╣рд╛рдВ рдПрдХ рдЙрджрд╛рд╣рд░рдг <code>map</code> рдЧрдпрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╣рдо рдбреЛрдореЗрди рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕реВрдЪреА рд╕реЗ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХрд╛ рдЪрдпрди рдХрд░рддреЗ рд╣реИрдВ: <br><br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">###     : &lt;tag&gt;.domain.local map $http_host $upstream_prefix { default 0; "~^([^\.]+)\." $1; } ###      map $upstream_prefix $upstream_address { include snippet.d/upstreams_map; default http://127.0.0.1:8080; } ###   upstream_host    upstream_address map $upstream_address $upstream_host { default 0; "~^https?://([^:]+)" $1; }</span></span></code> </pre><br>  рдФрд░ рдпрд╣рд╛рдБ " <code>snippet.d/upstreams_map</code> " рдЬреИрд╕рд╛ рджрд┐рдЦрддрд╛ рд╣реИ: <br><pre> <code class="nginx hljs">тАЬoneтАЭ тАЬhttp://one.domain.netтАЭ; тАЬtwoтАЭ тАЬhttps://two.domain.orgтАЭ;</code> </pre><br>  рдпрд╣рд╛рдБ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <code>server{}</code> : <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$upstream_address</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$upstream_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Port <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-comment"><span class="hljs-comment"># service for error handling and logging server { listen 127.0.0.1:8080; location / { return 400; } location /ngx_status/ { stub_status; } }</span></span></code> </pre><br>  рд╕рдм рдХреБрдЫ рд╢рд╛рдВрдд рд╣реИ, рд╕рдм рдХреБрдЫ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред  рдЗрд╕ рд▓реЗрдЦ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдпрджрд┐ рдПрдХ рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВред <br><br>  рдкреНрд░реЙрдХреНрд╕реА_рдкрд╛рд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдЕрдиреБрд░реЛрдз рд╕реАрдзреЗ рдПрдХ рд╡рд╛рдВрдЫрд┐рдд рдкрддреЗ рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, рдПрдХ рдирд┐рдпрдо рдХреЗ рд░реВрдк рдореЗрдВ, HTTP / 1.0 рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдмрд┐рдирд╛ <code>keepalive</code> рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдмрдВрдж рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред  рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рдЕрдЧрд░ рд╣рдо <code>proxy_http_version 1.1</code> , рддреЛ рднреА рдЕрдкрд╕реНрдЯреНрд░реАрдо ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://nginx.org/ru/docs/http/ngx_http_proxy_module.html&amp;usg=ALkJrhiY7rhxzRAv7525TsR0ympilKSNAQ#proxy_">рдкреНрд░реЙрдХреНрд╕реА_http_version</a> ) рдХреЗ рдмрд┐рдирд╛ рдХреБрдЫ рднреА рдирд╣реАрдВ рдмрджрд▓реЗрдЧрд╛ред <br><br>  рдХреНрдпрд╛ рдХрд░реЗрдВ?  рдкрд╣рд▓рд╛ рд╡рд┐рдЪрд╛рд░ рд╕рднреА рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдореЗрдВ рд▓рд╛рдирд╛ рд╣реИ, рдЬрд╣рд╛рдВ рд╕рд░реНрд╡рд░ рдХреЛ рд╣рдорд╛рд░реЗ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рд╢реНрдпрдХ рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛ рдХрд╛ рдкрддрд╛ рд╣реЛрдЧрд╛, рдФрд░ <code>map</code> <code>"tag" "upstream_name"</code> ред <br><br>  рдпреЛрдЬрдирд╛ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдФрд░ <code>map</code> рдЬреЛрдбрд╝реЗрдВ: <br><br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">###     : &lt;tag&gt;.domain.local map $http_host $upstream_prefix { default 0; "~^([^\.]+)\." $1; } ###      map $upstream_prefix $upstream_address { include snippet.d/upstreams_map; default http://127.0.0.1:8080; } ###   upstream_host    upstream_address map $upstream_address $upstream_host { default 0; "~^https?://([^:]+)" $1; } ###   ,       https,    ,    -  http map $upstream_address $upstream_scheme { default "http://"; "~(https?://)" $1; }</span></span></code> </pre><br>  рдФрд░ рдЯреИрдЧ рдирд╛рдореЛрдВ рдХреЗ рд╕рд╛рде <code>upstreams</code> рдмрдирд╛рдПрдВ: <br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> one { <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> one.domain.com; } <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> two { <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> two.domain.net; }</code> </pre><br>  рд╕рд░реНрд╡рд░ рдХреЛ рдпреЛрдЬрдирд╛ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрдиреЗ рдФрд░ рдкрддреЗ рдХреЗ рдмрдЬрд╛рдп рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХреЗ рдирд╛рдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдереЛрдбрд╝рд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_http_version</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$upstream_scheme</span></span><span class="hljs-variable"><span class="hljs-variable">$upstream_prefix</span></span><span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$upstream_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Port <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Proto <span class="hljs-string"><span class="hljs-string">""</span></span>; } } <span class="hljs-comment"><span class="hljs-comment"># service for error handling and logging server { listen 127.0.0.1:8080; location / { return 400; } location /ngx_status/ { stub_status; } }</span></span></code> </pre><br>  рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛ред  рд╕рдорд╛рдзрд╛рди рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдореЗрдВ <code>proxy_http_version 1.1</code> рдбрд╛рдпрд░реЗрдХреНрдЯрд┐рд╡ рдХреЛ рдЬреЛрдбрд╝реЗрдВ, <code>proxy_http_version 1.1</code> рд╕реЗрдЯ рдХрд░реЗрдВ, - рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рдХрдиреЗрдХреНрд╢рди рдкреВрд▓ рд╣реИ, рдФрд░ рд╕рдм рдХреБрдЫ рдЙрд╕реА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ рдпрд╣ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br>  рдЗрд╕ рдмрд╛рд░, рдЖрдк рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рд▓реЗрдЦ рд╕рдорд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЪрд╛рдп рдкреА рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╛ рдирд╣реАрдВ? <br><br>  рджрд░рдЕрд╕рд▓, рдЬрдм рд╣рдо рдЪрд╛рдп рдкреА рд░рд╣реЗ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдХреЛрдИ рдПрдХ рд╣реА рдбреЛрдореЗрди (рд╣рд╛рдп, рдЕрдореЗрдЬрд╝реЕрди) рдХреЗ рддрд╣рдд рдЖрдИрдкреА рдкрддреЗ рдпрд╛ рдкрддреЗ рдХреЗ рд╕рдореВрд╣ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЖрдкреВрд░реНрддрд┐рдХрд░реНрддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣рдорд╛рд░реА рдЪрд╛рдп рдкрд╛рд░реНрдЯреА рдХреА рдКрдВрдЪрд╛рдИ рдкрд░ рдЧрд┐рд░ рд╕рдХрддрд╛ рд╣реИред <br><br>  рдЦреИрд░, рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИ?  рдиреЗрдЧреНрдиреЗрдХреНрд╕ рдореЗрдВ рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рдмрд╛рд░реАрдХрд┐рдпреЛрдВ рд╣реИ: рдкреБрдирдГ рд▓реЛрдб рдХреЗ рджреМрд░рд╛рди, рдпрд╣ рдКрдкрд░ рдХреЗ рд╕рд░реНрд╡рд░реЛрдВ рдХреЛ рдирдП рдкрддреЗ рддрдХ <code>upstream</code> рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрди рдкрд░ рдЯреНрд░реИрдлрд╝рд┐рдХ рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИред  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдПрдХ рд╕рдорд╛рдзрд╛рди рднреАред  рд╣рд░ 5 рдорд┐рдирдЯ рдореЗрдВ <code>cron reload nginx</code> рдореЗрдВ рдлреЗрдВрдХ рджреЗрдВ рдФрд░ рдЪрд╛рдп рдкреАрдирд╛ рдЬрд╛рд░реА рд░рдЦреЗрдВред <br><br>  рд▓реЗрдХрд┐рди рдлрд┐рд░ рднреА рдпрд╣ рдореБрдЭреЗ рдПрдХ рдмрд╣реБрдд рд╣реА рдирд┐рд░реНрдгрдп рд▓рдЧ рд░рд╣рд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рд╣рд╛рдкреНрд░реЛрд╕реА рдХреА рдУрд░ рдкреВрдЫрдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛ред <br><br>  рд╣рд╛рдкреНрд░реЛрд╕реА рдореЗрдВ <code>dns resolvers</code> рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдФрд░ <code>dns cache</code> рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рд╛рдкреНрд░реЛрд╕реА <code>dns cache</code> рдЕрдкрдбреЗрдЯ рдХрд░ рджреЗрдЧрд╛ рдпрджрд┐ рдЗрд╕рдореЗрдВ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдИ рд╣реИрдВ, рдФрд░ рдЕрдЧрд░ рд╡реЗ рдмрджрд▓ рдЧрдП рд╣реИрдВ рддреЛ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХреЗ рдкрддреЗ рдХреЛ рдмрджрд▓ рджреЗрдВред <br><br>  рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛!  рдЕрдм рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИред <br><br>  рдпрд╣рд╛рдБ Haproxy рдХреЗ рд▓рд┐рдП рдПрдХ рдЫреЛрдЯрд╛ рд╡рд┐рдиреНрдпрд╛рд╕ рдЙрджрд╛рд╣рд░рдг рд╣реИ: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">frontend</span></span> http bind *:<span class="hljs-number"><span class="hljs-number">80</span></span> http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len <span class="hljs-number"><span class="hljs-number">32</span></span> capture request header Referer len <span class="hljs-number"><span class="hljs-number">128</span></span> capture request header User-Agent len <span class="hljs-number"><span class="hljs-number">128</span></span> acl host_present hdr(host) -m len gt <span class="hljs-number"><span class="hljs-number">0</span></span> use_backend %[req.hdr(host),lower,field(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'.'</span></span>)] if host_present default_backend default resolvers dns hold valid <span class="hljs-number"><span class="hljs-number">1s</span></span> timeout retry <span class="hljs-number"><span class="hljs-number">100ms</span></span> nameserver dns1 <span class="hljs-number"><span class="hljs-number">1.1.1.1:53</span></span> backend one http-request set-header Host one.domain.com server one--one.domain.com one.domain.com:<span class="hljs-number"><span class="hljs-number">80</span></span> resolvers dns check backend two http-request set-header Host two.domain.net server two--two.domain.net two.domain.net:<span class="hljs-number"><span class="hljs-number">443</span></span> resolvers dns check ssl verify <span class="hljs-literal"><span class="hljs-literal">none</span></span> check-sni two.domain.net sni str(two.domain.net)</code> </pre><br>  рд╕рдм рдХреБрдЫ рдХрд╛рдо рдХрд░рдиреЗ рд▓рдЧрддрд╛ рд╣реИ рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕ рдмрд╛рд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред  рдХреЗрд╡рд▓ рдПрдХ рдЪреАрдЬ рдЬреЛ рдореБрдЭреЗ рд╣рд╛рдкреНрд░реЛрд╕реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрд╕рдВрдж рдирд╣реАрдВ рд╣реИ рд╡рд╣ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡рд┐рд╡рд░рдг рдХреА рдЬрдЯрд┐рд▓рддрд╛ рд╣реИред  рдПрдХ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЯреЗрдХреНрд╕реНрдЯ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ  рд▓реЗрдХрд┐рди рдЖрд▓рд╕реНрдп рдкреНрд░рдЧрддрд┐ рдХрд╛ рдЗрдВрдЬрди рд╣реИ: рдпрджрд┐ рдЖрдк рдПрдХ рд╣реА рдмрд╛рдд рд▓рд┐рдЦрдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдПрдХ рдЬрдирд░реЗрдЯрд░ рд▓рд┐рдЦреЗрдВред <br><br>  рдореЗрд░реЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдирдЧреНрдиреЗрдХреНрд╕ рд╕реЗ рдПрдХ рдкреНрд░рд╛рд░реВрдк рдерд╛ <code>"tag" "upstream"</code> рдкреНрд░рд╛рд░реВрдк рдХреЗ рд╕рд╛рде, рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдЗрд╕реЗ рдЖрдзрд╛рд░ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЗрдиреЗ, рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдФрд░ рдЗрди рдореВрд▓реНрдпреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╣рд╛рдЗрдкреНрд░реЛрдпреЛ рдмреИрдХрдПрдВрдб рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ред <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env bash haproxy_backend_map_file=./root/etc/haproxy/snippet.d/name_domain_map haproxy_backends_file=./root/etc/haproxy/99_backends.cfg nginx_map_file=./nginx_map while getopts 'n:b:m:' OPT;do case ${OPT} in n) nginx_map_file=${OPTARG} ;; b) haproxy_backends_file=${OPTARG} ;; m) haproxy_backend_map_file=${OPTARG} ;; *) echo 'Usage: ${0} -n [nginx_map_file] -b [haproxy_backends_file] -m [haproxy_backend_map_file]' exit esac done function write_backend(){ local tag=$1 local domain=$2 local port=$3 local server_options="resolvers dns check" [ -n "${4}" ] &amp;&amp; local ssl_options="ssl verify none check-sni ${domain} sni str(${domain})" [ -n "${4}" ] &amp;&amp; server_options+=" ${ssl_options}" cat &gt;&gt; ${haproxy_backends_file} &lt;&lt;EOF backend ${tag} http-request set-header Host ${domain} server ${tag}--${domain} ${domain}:${port} ${server_options} EOF } :&gt; ${haproxy_backends_file} :&gt; ${haproxy_backend_map_file} while read tag addr;do tag=${tag//\"/} [ -z "${tag:0}" ] &amp;&amp; continue [ "${tag:0:1}" == "#" ] &amp;&amp; continue IFS=":" read scheme domain port &lt;&lt;&lt;${addr//;} unset IFS domain=${domain//\/} case ${scheme} in http) port=${port:-80} write_backend ${tag} ${domain} ${port} ;; https) port=${port:-443} write_backend ${tag} ${domain} ${port} 1 esac done &lt; &lt;(sort -V ${nginx_map_file})</span></span></code> </pre><br>  рдЕрдм рд╣рдо рд╕рднреА рдХреЛ nginx_map рдореЗрдВ рдПрдХ рдирдпрд╛ рд╣реЛрд╕реНрдЯ рдЬреЛрдбрд╝рдирд╛ рд╣реИ, рдЬрдирд░реЗрдЯрд░ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рддреИрдпрд╛рд░ рд╣реИрдкреНрд░реЛрдХреНрд╕реА рдХреЙрдиреНрдлрд┐рдЧрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред <br><br>  рдЖрдЬ рдХреЗ рд▓рд┐рдП рдмрд╕ рдЗрддрдирд╛ рд╣реАред  рдпрд╣ рд▓реЗрдЦ рдЕрдзрд┐рдХ рдкрд░рд┐рдЪрдпрд╛рддреНрдордХ рд╣реИ рдФрд░ рдПрдХ рд╕рдорд╛рдзрд╛рди рдЪреБрдирдиреЗ рдФрд░ рд╡рд░реНрддрдорд╛рди рдкрд░рд┐рд╡реЗрд╢ рдореЗрдВ рдЗрд╕рдХреЗ рдПрдХреАрдХрд░рдг рдХреА рд╕рдорд╕реНрдпрд╛ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИред <br><br>  рдЕрдЧрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рд╣рд╛рдкреНрд░реЙрдХреНрд╕реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рд╣рдореЗрдВ рдХреНрдпрд╛ рдиреБрдХрд╕рд╛рди рд╣реБрдП, рдЬреЛ рдХрд┐ рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рд▓рд┐рдП рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдЙрдкрдпреЛрдЧреА рд╕рд╛рдмрд┐рдд рд╣реБрдП, рдФрд░ рд╕рд░реНрд╡рд░ рд╕реЗ рдЕрдзрд┐рдХрддрдо рдкреНрд░рджрд░реНрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреНрдпрд╛ рдЕрдиреБрдХреВрд▓рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br>  рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рд╕рднреА рдХрд╛ рдзрдиреНрдпрд╡рд╛рдж, рджреЗрдЦрд┐рдпреЗ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi436992/">https://habr.com/ru/post/hi436992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi436982/index.html">рд╕реБрд░рдХреНрд╖рд╛ рд╕рдкреНрддрд╛рд╣ 04: рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░рдирд╛ рд╣реИ</a></li>
<li><a href="../hi436984/index.html">Microsoft рд╡рд┐рдВрдбреЛрдЬ 10 рдореЛрдмрд╛рдЗрд▓ рдХреЛ рд╕рдкреЛрд░реНрдЯ рдХрд░рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ</a></li>
<li><a href="../hi436986/index.html">рд▓рд┐рдирдХреНрд╕ рдПрдкреАрдЖрдИ рдХрд░реНрдиреЗрд▓ рдлрд╝рд╛рдЗрд▓ I / O рдмрдлрд░рд┐рдВрдЧ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдирд╛</a></li>
<li><a href="../hi436988/index.html">рдХреИрдорд░рд╛, рдореЛрдЯрд░, рдмрд┐рдЧ рдбреЗрдЯрд╛: рдПрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдИ рдлрд┐рд▓реНрдореЛрдВ рдХреЗ рд▓рд┐рдП рдлрд┐рд▓реНрдо рд╕реНрдЯреВрдбрд┐рдпреЛ рдХреИрд╕реЗ рджрд┐рдЦрддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi436990/index.html">рдЬреЛрдХреНрдЯреНрд░рд╛ рдФрд░ рдЬрд╝рдХреНрд╕рдЯреНрд░реИрд╕ рд╕реБрдЗрдЯ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдПрдирдЯреАрд╕реА рдЖрдИрдЯреА рд░реЛрд╕рд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рд╛рде рд╕рдВрдЧрдд рд╣реИрдВ</a></li>
<li><a href="../hi436994/index.html">рд▓рд┐рдХрд┐рдмреЗрд╕ рдФрд░ рдорд╛рд╡реЗрди</a></li>
<li><a href="../hi436996/index.html">Mail.ru рдЧреНрд░реБрдк рдХреА рдУрд░ рд╕реЗ рдкрд╛рдпрдерди рд╕реНрдкреЗрд╢рд▓рд╛рдЗрдЬреЗрд╢рди рдлрд╛рдЗрдирд▓ рдХреЛрд░реНрд╕</a></li>
<li><a href="../hi436998/index.html">рд░рд┐рд╡рд░реНрд╕ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ рдФрд░ рдЕрдирдзрд┐рдХреГрдд рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рд╕реЗ рдорд╛рдЗрдХреНрд░реЛрдЪрд┐рдкреНрд╕ рдХрд╛ рд╕рдВрд░рдХреНрд╖рдг</a></li>
<li><a href="../hi437000/index.html">рдХреИрд╕реЗ рд▓реЛрдЧреЛрдВ рдХреЛ рдЧрд┐рдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП</a></li>
<li><a href="../hi437002/index.html">рдорд╛рдиреНрдп ASP.NET рдХреЛрд░</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>