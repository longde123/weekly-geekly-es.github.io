<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ« ğŸ‘©â€ğŸ‘©â€ğŸ‘¦â€ğŸ‘¦ â” Likbezå°†å¯åŠ¨Istio ğŸ‘¨ğŸ¿ ğŸ‘‹ ğŸ‘¨ğŸ¾â€ğŸ“</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IsstioæœåŠ¡ç½‘æ ¼ 


 ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨Istioä¸€å¹´äº†ã€‚ ç„¶åä»–å°±èµ°äº†ã€‚ æˆ‘ä»¬åœ¨Kubernetesé›†ç¾¤ä¸­çš„æ€§èƒ½å¤§å¹…ä¸‹é™ï¼Œæˆ‘ä»¬å¸Œæœ›è¿›è¡Œåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œå¹¶è®©Istioè¿è¡ŒJaegerå¹¶åŠ ä»¥è§£å†³ã€‚ æœåŠ¡ç½‘æ ¼éå¸¸é€‚åˆæˆ‘ä»¬çš„åŸºç¡€æ¶æ„ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šæŠ•èµ„æ­¤å·¥å…·ã€‚ 


 æˆ‘ä¸å¾—ä¸å—è‹¦ï¼Œä½†æˆ‘ä»¬å¯¹æ­¤è¿›è¡Œäº†...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Likbezå°†å¯åŠ¨Istio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/441616/"><p> <a href=""><img src="https://habrastorage.org/webt/sh/m2/ja/shm2jainigjyhqewoqvi4cxdlg0.jpeg"></a> <br>  <em>IsstioæœåŠ¡ç½‘æ ¼</em> </p><br><p> ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨Istioä¸€å¹´äº†ã€‚ ç„¶åä»–å°±èµ°äº†ã€‚ æˆ‘ä»¬åœ¨Kubernetesé›†ç¾¤ä¸­çš„æ€§èƒ½å¤§å¹…ä¸‹é™ï¼Œæˆ‘ä»¬å¸Œæœ›è¿›è¡Œåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œå¹¶è®©Istioè¿è¡ŒJaegerå¹¶åŠ ä»¥è§£å†³ã€‚ æœåŠ¡ç½‘æ ¼éå¸¸é€‚åˆæˆ‘ä»¬çš„åŸºç¡€æ¶æ„ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šæŠ•èµ„æ­¤å·¥å…·ã€‚ </p><br><p> æˆ‘ä¸å¾—ä¸å—è‹¦ï¼Œä½†æˆ‘ä»¬å¯¹æ­¤è¿›è¡Œäº†å¹¿æ³›çš„ç ”ç©¶ã€‚ è¿™æ˜¯ç³»åˆ—æ–‡ç« ä¸­çš„ç¬¬ä¸€ç¯‡ï¼Œæˆ‘å°†ä»‹ç»Istioå¦‚ä½•ä¸Kubernetesé›†æˆä»¥åŠæˆ‘ä»¬ä»ä¸­äº†è§£åˆ°çš„å·¥ä½œã€‚ æœ‰æ—¶ï¼Œæˆ‘ä»¬ä¼šæ¶‰è¶³æŠ€æœ¯é¢†åŸŸï¼Œä½†å¹¶ä¸é¥è¿œã€‚ è¿›ä¸€æ­¥ä¼šæœ‰æ›´å¤šçš„èŒä½ã€‚ </p><a name="habracut"></a><br><h3 id="chto-takoe-istio"> ä»€ä¹ˆæ˜¯Istioï¼Ÿ </h3><br><p>  Istioæ˜¯æœåŠ¡ç½‘æ ¼é…ç½®å·¥å…·ã€‚ å®ƒè¯»å–Kubernetesé›†ç¾¤çš„çŠ¶æ€å¹¶å‡çº§åˆ°L7ä»£ç†ï¼ˆHTTPå’ŒgRPCï¼‰ï¼Œè¿™äº›ä»£ç†åœ¨Kuberneteså®¹å™¨ä¸­ä½œä¸ºè¾…åŠ©å·¥å…·å®ç°ã€‚ è¿™äº›é™„å±å·¥å…·æ˜¯Envoyå®¹å™¨ï¼Œå¯ä»Istio Pilot APIï¼ˆå’ŒgRPCæœåŠ¡ï¼‰è¯»å–é…ç½®å¹¶é€šè¿‡å®ƒè·¯ç”±æµé‡ã€‚ å€ŸåŠ©å¼ºå¤§çš„L7ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ ‡ï¼Œè·Ÿè¸ªï¼Œé‡è¯•é€»è¾‘ï¼Œæ–­è·¯å™¨ï¼Œè´Ÿè½½å¹³è¡¡å’ŒCanaryéƒ¨ç½²ã€‚ </p><br><h3 id="nachnem-s-nachala-kubernetes"> è®©æˆ‘ä»¬ä»å¤´å¼€å§‹ï¼šKubernetes </h3><br><p>åœ¨Kubernetesä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨deployæˆ–StatefulSetåœ¨ä¸‹é¢åˆ›å»ºã€‚ æˆ–è€…ï¼Œå®ƒå¯ä»¥æ˜¯æ²¡æœ‰é«˜çº§æ§åˆ¶å™¨çš„â€œé¦™è‰â€ã€‚ ç„¶åï¼ŒKubernetesä¼šå°½åŠ›ç»´æŒæ‰€éœ€çš„çŠ¶æ€-å®ƒåœ¨èŠ‚ç‚¹ä¸Šçš„é›†ç¾¤ä¸­åˆ›å»ºpodï¼Œå¹¶ç¡®ä¿å®ƒä»¬å¯åŠ¨å’Œé‡å¯ã€‚ åˆ›å»ºåŸºç¡€æ—¶ï¼ŒKubernetesä¼šç»å†APIç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½æˆåŠŸï¼Œç„¶åæ‰åœ¨é›†ç¾¤ä¸Šæœ€ç»ˆåˆ›å»ºåŸºç¡€ã€‚ </p><br><p>  APIç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/dl/dc/t5/dldct5fzrxubc5c1z3zt2m7lchu.png"></a> <br>  <em>æ„Ÿè°¢Banzai Cloudçš„ç²¾å½©å›¾ç‰‡ã€‚</em> </p><br><p> æ­¥éª¤ä¹‹ä¸€æ˜¯ä¿®æ”¹å‡†å…¥ç½‘ç»œé’©å­ã€‚ è¿™æ˜¯Kubernetesç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸€ä¸ªå•ç‹¬éƒ¨åˆ†ï¼Œåœ¨Kubernetesä¸­ï¼Œåœ¨æäº¤åˆ°etcdå­˜å‚¨åº“ï¼ˆKubernetesé…ç½®çš„çœŸç›¸ï¼‰ä¹‹å‰ï¼Œå¯¹èµ„æºè¿›è¡Œäº†è‡ªå®šä¹‰ã€‚  Istioåœ¨è¿™é‡Œå‘æŒ¥ä»–çš„é­”åŠ›ã€‚ </p><br><h3 id="modificiruyuschie-vebhuki-dopuska"> ä¿®æ”¹å‡†å…¥ç½‘ç»œæŒ‚é’© </h3><br><p>å½“åˆ›å»ºä¸€ä¸ªå­é¡¹ï¼ˆé€šè¿‡<code>kubectl</code>æˆ–<code>Deployment</code> ï¼‰æ—¶ï¼Œå®ƒä¼šç»å†è¿™ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”é€šè¿‡ä¿®æ”¹è®¿é—®æƒé™çš„webhooksä¼šå¯¹å…¶è¿›è¡Œæ›´æ”¹ï¼Œç„¶åå†å°†å…¶å‘å¸ƒåˆ°å¤§ä¸–ç•Œã€‚ </p><br><p> åœ¨å®‰è£…Istioçš„è¿‡ç¨‹ä¸­ï¼Œistio-sidecar-injectorè¢«æ·»åŠ ä¸ºé…ç½®èµ„æºï¼Œç”¨äºä¿®æ”¹webhooksï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl get mutatingwebhookconfiguration NAME AGE istio-sidecar-injector 87d</code> </pre> <br><p> å¹¶é…ç½®ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: admissionregistration.k8s.io/v1beta1 kind: MutatingWebhookConfiguration metadata: labels: app: istio-sidecar-injector chart: sidecarInjectorWebhook-1.0.4 heritage: Tiller name: istio-sidecar-injector webhooks: - clientConfig: caBundle: redacted service: name: istio-sidecar-injector namespace: istio-system path: /inject failurePolicy: Fail name: sidecar-injector.istio.io namespaceSelector: matchLabels: istio-injection: enabled rules: - apiGroups: - "" apiVersions: - v1 operations: - CREATE resources: - pods</code> </pre> <br><p> å®ƒè¯´Kubernetesåº”è¯¥å°†æ‰€æœ‰ç‚‰åºŠåˆ›å»ºäº‹ä»¶å‘é€åˆ°<code>istio-system</code>å‘½åç©ºé—´ä¸­çš„<code>istio-sidecar-injector</code> ï¼Œå¦‚æœè¯¥å‘½åç©ºé—´å…·æœ‰<code>istio-injection=enabled</code> ã€‚ æ³¨å…¥ç¨‹åºåœ¨PodSpecä¸­è¿˜åŒ…æ‹¬ä¸¤ä¸ªå®¹å™¨ï¼šä¸€ä¸ªç”¨äºè®¾ç½®ä»£ç†è§„åˆ™çš„ä¸´æ—¶å®¹å™¨ï¼Œå¦ä¸€ä¸ªç”¨äºè‡ªèº«ä»£ç†çš„å®¹å™¨ã€‚ è¾¹è½¦æ³¨å…¥å™¨æ ¹æ®æ¥è‡ª<code>istio-sidecar-injector</code>é…ç½®å›¾çš„æ¨¡æ¿æ’å…¥è¿™äº›å®¹å™¨ã€‚ æ­¤è¿‡ç¨‹ä¹Ÿç§°ä¸ºâ€œç…§é¡¾â€ã€‚ </p><br><h3 id="sidecar-pody"> è¾¹è½¦èˆ± </h3><br><p>  Sidecaræ˜¯æˆ‘ä»¬é­”æœ¯å¸ˆIstioçš„theä¿©ã€‚  Istioå·§å¦™åœ°å¼¯æ›²äº†æ‰€æœ‰ä¸œè¥¿ï¼Œå¦‚æœæ‚¨ä¸äº†è§£ç»†èŠ‚ï¼Œé‚£ä¹ˆä»å¤–é¢çœ‹å°±è±¡é­”æœ¯ä¸€æ ·ã€‚ å¦‚æœæ‚¨çªç„¶éœ€è¦è°ƒè¯•ç½‘ç»œè¯·æ±‚ï¼Œäº†è§£ä»–ä»¬ä¼šå¾ˆæœ‰ç”¨ã€‚ </p><br><h3 id="init--i-proksi-konteynery"> åˆå§‹åŒ–å’Œä»£ç†å®¹å™¨ </h3><br><p>  Kubernetesæœ‰ä¸€ä¸ªä¸´æ—¶çš„ä¸€æ¬¡æ€§åˆå§‹åŒ–å®¹å™¨ï¼Œå¯ä»¥åœ¨ä¸»è¦å®¹å™¨ä¹‹å‰è¿è¡Œã€‚ ä»–ä»¬æ±‡é›†èµ„æºï¼Œè¿ç§»æ•°æ®åº“ï¼Œæˆ–è€…åƒIstioä¸€æ ·é…ç½®ç½‘ç»œè§„åˆ™ã€‚ </p><br><p>  Istioä½¿ç”¨Envoyå°†æ‰€æœ‰è¯·æ±‚ä»£ç†åˆ°æ‰€éœ€è·¯å¾„çš„æäº¤ä¸­ã€‚ ä¸ºæ­¤ï¼ŒIstioåˆ›å»º<code>iptables</code>è§„åˆ™ï¼Œå®ƒä»¬å°†ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ç›´æ¥å‘é€åˆ°Envoyï¼Œå¹¶å·§å¦™åœ°å°†æµé‡ä»£ç†åˆ°å…¶ç›®çš„åœ°ã€‚ æµé‡ä¼šç»•å¼€ä¸€å°æ­¥ï¼Œä½†æ‚¨å·²ç»è·å¾—äº†åˆ†å¸ƒå¼è·Ÿè¸ªï¼ŒæŸ¥è¯¢æŒ‡æ ‡å’Œç­–ç•¥å®æ–½ã€‚ åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œä»Istioå­˜å‚¨åº“ä¸­ï¼Œæ‚¨<a href="">å¯ä»¥çœ‹åˆ°</a> Istioå¦‚ä½•åˆ›å»ºiptablesè§„åˆ™ã€‚ </p><br><p>  <a href="">@jimmysongio</a>åœ¨iptablesè§„åˆ™å’ŒEnvoyä»£ç†ä¹‹é—´ç»˜åˆ¶äº†ä¸€ä¸ªæå¥½çš„è¿æ¥å›¾ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yl/3m/yc/yl3myca7qv4esodpj8a7iwsp6bc.jpeg"></a> <br>  <em>ç‰¹ä½¿-ç‰¹ä½¿äº¤é€š</em> </p><br><p>  Envoyæ¥æ”¶æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºçš„æµé‡ï¼Œå› æ­¤æ‰€æœ‰æµé‡é€šå¸¸éƒ½åœ¨Envoyå†…éƒ¨ç§»åŠ¨ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚  Istioä»£ç†æ˜¯å¦ä¸€ä¸ªå®¹å™¨ï¼Œå·²æ·»åŠ åˆ°ç”±Istioè¾¹è½¦æ³¨å…¥å™¨ä¿®æ”¹çš„æ‰€æœ‰åŠèˆ±ä¸­ã€‚ åœ¨æ­¤å®¹å™¨ä¸­ï¼ŒEnvoyè¿›ç¨‹å¼€å§‹ï¼Œè¯¥è¿›ç¨‹æ¥æ”¶æ¥è‡ªç‚‰åºŠçš„æ‰€æœ‰æµé‡ï¼ˆæŸäº›ä¾‹å¤–ï¼Œä¾‹å¦‚æ¥è‡ªKubernetesé›†ç¾¤çš„æµé‡ï¼‰ã€‚ </p><br><p>  Envoyè¿›ç¨‹é€šè¿‡å®ç°Istioçš„Envoy v2 APIå‘ç°æ‰€æœ‰è·¯ç”±ã€‚ </p><br><h3 id="envoy-i-pilot"> ç‰¹ä½¿å’Œé£è¡Œå‘˜ </h3><br><p>  Envoyæœ¬èº«æ²¡æœ‰é€»è¾‘æ¥æ£€æµ‹é›†ç¾¤ä¸­çš„Podå’ŒæœåŠ¡ã€‚ å®ƒæ˜¯æ•°æ®å¹³é¢ï¼Œéœ€è¦æ§åˆ¶å¹³é¢è¿›è¡Œå¼•å¯¼ã€‚  Envoyé…ç½®å‚æ•°è¯·æ±‚ä¸»æœºæˆ–æœåŠ¡ç«¯å£é€šè¿‡gRPC APIæ¥æ”¶æ­¤é…ç½®ã€‚  Istioé€šè¿‡å…¶PilotæœåŠ¡æ»¡è¶³äº†gRPC APIçš„è¦æ±‚ã€‚  Envoyæ ¹æ®é€šè¿‡ä¿®æ”¹çš„Webhookå®ç°çš„sidecaré…ç½®è¿æ¥åˆ°æ­¤APIã€‚ è¯¥APIå…·æœ‰Envoyéœ€è¦ä¸ºé›†ç¾¤å‘ç°å’Œè·¯ç”±çš„æ‰€æœ‰æµé‡è§„åˆ™ã€‚ è¿™æ˜¯æœåŠ¡ç½‘æ ¼ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/lr/kn/bz/lrknbzkkjqescnkyh6k1voy_nyk.png"></a> <br>  <em>æ•°æ®äº¤æ¢â€œåœ¨&lt;-&gt;é£è¡Œå‘˜ä¸‹â€</em> </p><br><p>  Pilotè¿æ¥åˆ°Kubernetesé›†ç¾¤ï¼Œè¯»å–é›†ç¾¤çŠ¶æ€å¹¶ç­‰å¾…æ›´æ–°ã€‚ å®ƒç›‘è§†Kubernetesé›†ç¾¤ä¸­çš„Podï¼ŒæœåŠ¡å’Œç«¯ç‚¹ï¼Œç„¶åä¸ºè¿æ¥åˆ°è¯¥Pilotçš„æ‰€æœ‰Envoyè¾¹è½¦æä¾›æ­£ç¡®çš„é…ç½®ã€‚ è¿™æ˜¯Kuberneteså’ŒEnvoyä¹‹é—´çš„æ¡¥æ¢ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fg/no/hj/fgnohjdngxbyn8kj5u_udcvl6x0.png"></a> <br>  <em>ä»é£è¡Œå‘˜åˆ°Kubernetes</em> </p><br><p> åœ¨Kubernetesä¸­åˆ›å»ºæˆ–æ›´æ–°Podï¼ŒæœåŠ¡æˆ–ç«¯ç‚¹æ—¶ï¼ŒPilotä¼šäº†è§£åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶å°†å¿…è¦çš„é…ç½®å‘é€åˆ°æ‰€æœ‰è¿æ¥çš„Envoyå®ä¾‹ã€‚ </p><br><h3 id="kakaya-konfiguraciya-otpravlyaetsya"> æ­£åœ¨å‘é€ä»€ä¹ˆé…ç½®ï¼Ÿ </h3><br><p>  Envoyä»Istio Pilotè·å¾—ä»€ä¹ˆé…ç½®ï¼Ÿ </p><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetesé€šè¿‡ç®¡ç†<code>endpoint</code>çš„<code>sevice</code> ï¼ˆæœåŠ¡ï¼‰è§£å†³æ‚¨çš„ç½‘ç»œé—®é¢˜ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“å¼€ç«¯ç‚¹åˆ—è¡¨ï¼š </p><br><pre> <code class="plaintext hljs">kubectl get endpoints</code> </pre> <br><p> è¿™æ˜¯ç¾¤é›†ä¸­æ‰€æœ‰IPå’Œç«¯å£åŠå…¶åœ°å€çš„åˆ—è¡¨ï¼ˆé€šå¸¸è¿™äº›æ˜¯ä»éƒ¨ç½²åˆ›å»ºçš„Podï¼‰ã€‚ ä¸ºäº†é…ç½®è·¯ç”±æ•°æ®å¹¶å°†å…¶å‘é€åˆ°Envoyï¼Œäº†è§£Istioéå¸¸é‡è¦ã€‚ </p><br><h3 id="servisy-proslushivateli-i-marshruty"> æœåŠ¡ï¼Œä¾¦å¬å™¨å’Œè·¯çº¿ </h3><br><p> å½“æ‚¨åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºæœåŠ¡æ—¶ï¼Œæ‚¨å°†åŒ…æ‹¬ä¸€äº›å¿«æ·æ–¹å¼ï¼Œé€šè¿‡è¿™äº›å¿«æ·æ–¹å¼å¯ä»¥é€‰æ‹©æ‰€æœ‰åˆé€‚çš„Podã€‚ å½“æ‚¨å°†æµé‡å‘é€åˆ°æœåŠ¡çš„IPæ—¶ï¼ŒKubernetesä¼šä¸ºæ­¤æµé‡é€‰æ‹©æµé‡ã€‚ ä¾‹å¦‚ï¼Œå‘½ä»¤ </p><br><pre> <code class="plaintext hljs">curl my-service.default.svc.cluster.local:3000</code> </pre> <br><p> é¦–å…ˆï¼Œå®ƒå°†åœ¨<code>default</code>åç§°ç©ºé—´ä¸­æ‰¾åˆ°åˆ†é…ç»™<code>my-service</code>çš„è™šæ‹ŸIPï¼Œå¹¶å°†è¯¥IPè½¬å‘æµé‡åˆ°ä¸æœåŠ¡æ ‡ç­¾åŒ¹é…çš„å­æœåŠ¡å™¨ã€‚ </p><br><p>  Istioå’ŒEnvoyç¨å¾®æ”¹å˜äº†è¿™ç§é€»è¾‘ã€‚  Istioæ ¹æ®Kubernetesé›†ç¾¤ä¸­çš„æœåŠ¡å’Œç«¯ç‚¹é…ç½®Envoyï¼Œå¹¶ä½¿ç”¨Envoyçš„æ™ºèƒ½è·¯ç”±å’Œè´Ÿè½½å¹³è¡¡åŠŸèƒ½ç»•è¿‡KubernetesæœåŠ¡ã€‚  Envoyæ— éœ€ä¸€æ¬¡ä»£ç†ä¸€ä¸ªIPï¼Œè€Œæ˜¯ç›´æ¥è¿æ¥åˆ°IPå£ç‚‰ã€‚  <strong>ä¸ºæ­¤ï¼ŒIstioå°†Kubernetesé…ç½®æ˜ å°„åˆ°Envoyé…ç½®</strong> ã€‚ </p><br><p>  Kubernetesï¼ŒIstioå’ŒEnvoyè¿™ä¸¤ä¸ªè¯ç•¥æœ‰ä¸åŒï¼Œç›®å‰å°šä¸æ¸…æ¥šä»–ä»¬åƒä»€ä¹ˆã€‚ </p><br><h3 id="servisy"> æœåŠ¡é¡¹ç›® </h3><br><p>  Kubernetesä¸­çš„æœåŠ¡æ˜ å°„åˆ°Envoyä¸­çš„<strong>é›†ç¾¤</strong> ã€‚  Envoyç¾¤é›†åŒ…å«ä¸€ä¸ª<strong>ç«¯ç‚¹</strong>åˆ—è¡¨ï¼Œå³ç”¨äºå¤„ç†è¯·æ±‚çš„å®ä¾‹çš„IPï¼ˆæˆ–ä¸»æœºåï¼‰ã€‚ è¦æŸ¥çœ‹åœ¨Istio sidecar-podä¸­é…ç½®çš„ç¾¤é›†åˆ—è¡¨ï¼Œè¯·è¿è¡Œ<code>istioctl proxy-config cluster &lt; &gt;</code> ã€‚ è¯¥å‘½ä»¤ä»¥ç‚‰è†›ä¸ºå•ä½æ˜¾ç¤ºå½“å‰çš„çŠ¶æ€ã€‚ ä»¥ä¸‹æ˜¯æˆ‘ä»¬å…¶ä¸­ä¸€ç§ç¯å¢ƒçš„ç¤ºä¾‹ï¼š </p><br><pre> <code class="plaintext hljs">$ istioctl proxy-config cluster taxparams-6777cf899c-wwhr7 -n applications SERVICE FQDN PORT SUBSET DIRECTION TYPE BlackHoleCluster - - - STATIC accounts-grpc-gw.applications.svc.cluster.local 80 - outbound EDS accounts-grpc-public.applications.svc.cluster.local 50051 - outbound EDS addressvalidator.applications.svc.cluster.local 50051 - outbound EDS</code> </pre> <br><p> æ‰€æœ‰ç›¸åŒçš„æœåŠ¡éƒ½åœ¨æ­¤å‘½åç©ºé—´ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) accounts-grpc-gw ClusterIP 10.3.0.91 &lt;none&gt; 80/TCP accounts-grpc-public ClusterIP 10.3.0.202 &lt;none&gt; 50051/TCP addressvalidator ClusterIP 10.3.0.56 &lt;none&gt; 50051/TCP</code> </pre> <br><p>  Istioå¦‚ä½•çŸ¥é“å“ªä¸ªåè®®ä½¿ç”¨è¯¥æœåŠ¡ï¼Ÿ é€šè¿‡ç«¯å£æ¡ç›®ä¸­çš„<code>name</code>å­—æ®µä¸ºæœåŠ¡æ¸…å•é…ç½®åè®®ã€‚ </p><br><pre> <code class="plaintext hljs">$ kubectl get service accounts-grpc-public -o yaml apiVersion: v1 kind: Service metadata: name: accounts-grpc-public spec: ports: - name: grpc port: 50051 protocol: TCP targetPort: 50051</code> </pre> <br><p> å¦‚æœå­˜åœ¨<code>grpc</code>æˆ–<code>grpc-</code>å‰ç¼€ï¼Œåˆ™Istioå°†ä¸ºè¯¥æœåŠ¡é…ç½®HTTP2åè®®ã€‚ æˆ‘ä»¬é€šè¿‡ç—›è‹¦çš„ç»éªŒä¸­å­¦åˆ°äº†å½“ä»£ç†é…ç½®å› ä¸ºæœªæŒ‡å®šhttpæˆ–grpcå‰ç¼€è€ŒæŸåæ—¶Istioå¦‚ä½•ä½¿ç”¨ç«¯å£å... </p><br><p> å¦‚æœåœ¨Envoyä¸­ä½¿ç”¨kubectlå’Œâ€œç®¡ç†ç«¯å£è½¬å‘â€é¡µé¢ï¼Œåˆ™å¯ä»¥çœ‹åˆ°Account-grpc-publicç«¯ç‚¹æ˜¯Pilotåœ¨Envoyä¸­é€šè¿‡HTTP2åè®®å®ç°çš„ç¾¤é›†ã€‚ è¿™è¯å®äº†æˆ‘ä»¬çš„å‡è®¾ï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl -n applications port-forward otherpod-dc56885ff-dqc6t 15000:15000 &amp; $ curl http://localhost:15000/config_dump | yq r - ... - cluster: circuit_breakers: thresholds: - {} connect_timeout: 1s eds_cluster_config: eds_config: ads: {} service_name: outbound|50051||accounts-grpc-public.applications.svc.cluster.local http2_protocol_options: max_concurrent_streams: 1073741824 name: outbound|50051||accounts-grpc-public.applications.svc.cluster.local type: EDS ...</code> </pre> <br><p> ç«¯å£15000æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Envoyçš„ç®¡ç†é¡µé¢</a> ï¼Œå¯åœ¨æ¯ä¸ªå°è½¦ä¸Šä½¿ç”¨ã€‚ </p><br><h3 id="proslushivateli"> å¬ä¼— </h3><br><p> ä¾¦å¬å™¨è¯†åˆ«Kubernetesç«¯ç‚¹ä»¥å°†æµé‡ä¼ é€’åˆ°ç‚‰è†›ã€‚ åœ°å€éªŒè¯æœåŠ¡åœ¨æ­¤å¤„å…·æœ‰ä¸€ä¸ªç«¯ç‚¹ï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl get ep addressvalidator -o yaml apiVersion: v1 kind: Endpoints metadata: name: addressvalidator subsets: - addresses: - ip: 10.2.26.243 nodeName: ip-10-205-35-230.ec2.internal targetRef: kind: Pod name: addressvalidator-64885ccb76-87l4d namespace: applications ports: - name: grpc port: 50051 protocol: TCP</code> </pre> <br><p> å› æ­¤ï¼Œåœ°å€éªŒè¯ç‚‰åºŠåœ¨ç«¯å£50051ä¸Šå…·æœ‰ä¸€ä¸ªä¾¦å¬å™¨ï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl -n applications port-forward addressvalidator-64885ccb76-87l4d 15000:15000 &amp; $ curl http://localhost:15000/config_dump | yq r - ... dynamic_active_listeners: - version_info: 2019-01-13T18:39:43Z/651 listener: name: 10.2.26.243_50051 address: socket_address: address: 10.2.26.243 port_value: 50051 filter_chains: - filter_chain_match: transport_protocol: raw_buffer ...</code> </pre> <br><h3 id="marshruty"> è·¯çº¿ </h3><br><p> åœ¨Istioä¸­ï¼Œä»£æ›¿äº†æ ‡å‡†çš„Kubernetes Ingresså¯¹è±¡ï¼Œè€Œæ˜¯é‡‡ç”¨äº†æ›´åŠ æŠ½è±¡å’Œé«˜æ•ˆçš„è‡ªå®šä¹‰èµ„æº-VirtualServiceã€‚  VirtualServiceé€šè¿‡å°†è·¯ç”±ç»‘å®šåˆ°ç½‘å…³å°†è·¯ç”±æ˜ å°„åˆ°ä¸Šæ¸¸ç¾¤é›†ã€‚ è¿™æ˜¯å¦‚ä½•å°†Kubernetes Ingressä¸Ingressæ§åˆ¶å™¨ä¸€èµ·ä½¿ç”¨ã€‚ </p><br><p> å³ï¼Œæˆ‘ä»¬å°†Istioå…¥å£ç½‘å…³ç”¨äºæ‰€æœ‰å†…éƒ¨GRPCæµé‡ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: grpc-gateway spec: selector: istio: ingressgateway servers: - hosts: - '*' port: name: http2 number: 80 protocol: HTTP2 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: grpc-gateway spec: gateways: - grpc-gateway hosts: - '*' http: - match: - uri: prefix: /namely.address_validator.AddressValidator retries: attempts: 3 perTryTimeout: 2s route: - destination: host: addressvalidator port: number: 50051</code> </pre> <br><p> ä¹çœ‹ä¹‹ä¸‹ï¼Œæ‚¨åœ¨ç¤ºä¾‹ä¸­å°†ä¸€æ— æ‰€çŸ¥ã€‚ åœ¨è¿™é‡Œçœ‹ä¸åˆ°å®ƒï¼Œä½†æ˜¯Istio-IngressGatewayéƒ¨ç½²åŸºäº<code>istio: ingressgateway</code>è®°å½•éœ€è¦å“ªäº›ç»ˆç»“ç‚¹ã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒIngressGatewayé€šè¿‡HTTP2é€šè¿‡ç«¯å£80ä¸ºæ‰€æœ‰åŸŸè·¯ç”±æµé‡ã€‚  VirtualServiceä¸ºæ­¤ç½‘å…³å®ç°è·¯ç”±ï¼ŒåŒ¹é…<code>/namely.address_validator.AddressValidator</code>å‰ç¼€ï¼Œå¹¶åœ¨ä¸¤ç§’é’Ÿå†…é€šè¿‡é‡è¯•è§„åˆ™å°†<code>addressvalidator</code>é€šè¿‡ç«¯å£50051ä¼ é€’åˆ°ä¸Šæ¸¸æœåŠ¡ã€‚ </p><br><p> å¦‚æœæˆ‘ä»¬é‡å®šå‘Istio-IngressGatewayçš„podç«¯å£å¹¶æŸ¥çœ‹Envoyçš„é…ç½®ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°VirtualServiceçš„ä½œç”¨ï¼š </p><br><pre> <code class="plaintext hljs">$ kubectl -n istio-system port-forward istio-ingressgateway-7477597868-rldb5 15000 ... - match: prefix: /namely.address_validator.AddressValidator route: cluster: outbound|50051||addressvalidator.applications.svc.cluster.local timeout: 0s retry_policy: retry_on: 5xx,connect-failure,refused-stream num_retries: 3 per_try_timeout: 2s max_grpc_timeout: 0s decorator: operation: addressvalidator.applications.svc.cluster.local:50051/namely.address_validator.AddressValidator* ...</code> </pre> <br><h3 id="chto-my-guglili-kopayas-v-istio"> åœ¨IstioæŒ–æ˜æ—¶æˆ‘ä»¬ç”¨Googleæœç´¢äº†ä»€ä¹ˆ </h3><br><p>  <strong>å‘ç”Ÿé”™è¯¯503æˆ–404</strong> </p><br><p> åŸå› ä¸åŒï¼Œä½†é€šå¸¸æ˜¯ï¼š </p><br><ul><li>  Sidecaråº”ç”¨ç¨‹åºæ— æ³•è”ç³»Pilotï¼ˆæ£€æŸ¥Pilotæ˜¯å¦æ­£åœ¨è¿è¡Œï¼‰ã€‚ </li><li>  KubernetesæœåŠ¡æ¸…å•çš„åè®®æ— æ•ˆã€‚ </li><li>  VirtualService / Envoyé…ç½®å°†è·¯ç”±å†™å…¥é”™è¯¯çš„ä¸Šæ¸¸ç¾¤é›†ã€‚ ä»è¾¹ç¼˜æœåŠ¡å¼€å§‹ï¼Œåœ¨è¯¥å¤„æ‚¨æœŸæœ›ä¼ å…¥æµé‡ï¼Œå¹¶æ£€æŸ¥Envoyæ—¥å¿—ã€‚ æˆ–ä½¿ç”¨Jaegerä¹‹ç±»çš„å·¥å…·æŸ¥æ‰¾é”™è¯¯ã€‚ </li></ul><br><p>  <strong>Istioä»£ç†æ—¥å¿—ä¸­çš„NR / UH / UFæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</strong> </p><br><ul><li>  NR-æ— è·¯çº¿ã€‚ </li><li>  UH-ä¸Šæ¸¸ä¸å¥åº·ï¼ˆä¸Šæ¸¸æ— æ³•æ“ä½œï¼‰ã€‚ </li><li>  UF-ä¸Šæ¸¸æ•…éšœï¼ˆä¸Šæ¸¸æ•…éšœï¼‰ã€‚ </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨Envoyç½‘ç«™ä¸Š</a>é˜…è¯»æ›´å¤š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å†…å®¹</a> ã€‚ </p><br><p>  <strong>å…³äºIstioçš„é«˜å¯ç”¨æ€§</strong> </p><br><ul><li> å°†NodeAffinityæ·»åŠ åˆ°Istioç»„ä»¶ï¼Œä»¥åœ¨ä¸åŒçš„è®¿é—®åŒºåŸŸä¸­å‡åŒ€åˆ†å¸ƒç‚‰åºŠï¼Œå¹¶å¢åŠ æœ€å°‘çš„å‰¯æœ¬æ•°ã€‚ </li><li> ä½¿ç”¨Horizoâ€‹â€‹ntal Pod AutoscalingåŠŸèƒ½å¯åŠ¨æ–°ç‰ˆæœ¬çš„Kubernetesã€‚ æœ€é‡è¦çš„ç‚‰åºŠå°†æ ¹æ®è´Ÿè½½è¿›è¡Œç¼©æ”¾ã€‚ </li></ul><br><p>  <strong>cronjobä¸ºä»€ä¹ˆä¸ç»“æŸï¼Ÿ</strong> </p><br><p> å®Œæˆä¸»è¦å·¥ä½œé‡åï¼Œä¾¿è½¦é›†è£…ç®±ç»§ç»­å·¥ä½œã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·åœ¨PodSpecä¸­æ·»åŠ æ³¨é‡Š<code>sidecar.istio.io/inject: â€œfalseâ€</code>ä»¥ç¦ç”¨cronjobsä¸­çš„sidecarã€‚ </p><br><p>  <strong>å¦‚ä½•å®‰è£…Istioï¼Ÿ</strong> </p><br><p> æˆ‘ä»¬ä½¿ç”¨Spinnakerè¿›è¡Œéƒ¨ç½²ï¼Œä½†é€šå¸¸ä¼šè·å–æœ€æ–°çš„Helmå›¾è¡¨ï¼Œå°†å…¶è”æƒ³èµ·æ¥ï¼Œä½¿ç”¨<code>helm template -f values.yml</code>å¹¶åœ¨Githubä¸Šæäº¤æ–‡ä»¶ä»¥æŸ¥çœ‹æ›´æ”¹ï¼Œç„¶åé€šè¿‡<code>kubectl apply -f -</code>åº”ç”¨å®ƒä»¬ã€‚ è¿™æ˜¯ä¸ºäº†é¿å…åœ¨ä¸åŒç‰ˆæœ¬ä¸­æ„å¤–æ›´æ”¹CRDæˆ–APIã€‚ </p><br><p> æ„Ÿè°¢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Bobby Tables</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Michael Hamrah</a>ååŠ©æ’°å†™äº†è¿™ç¯‡æ–‡ç« ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441616/">https://habr.com/ru/post/zh-CN441616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441602/index.html">ä¸ºä»€ä¹ˆç»å…¸çš„è‡ªåŠ¨è½¦æ˜¯ä¸å¯èƒ½çš„å¹¶ä¸”æ²¡æœ‰å•†ä¸šå‰æ™¯</a></li>
<li><a href="../zh-CN441604/index.html">ä¸­å›½çš„å›½å®¶ç›‘æµ‹ç³»ç»Ÿï¼šä¸ä»…æ˜¯æ•°æ®çš„æ¥æºï¼Œè€Œä¸”æ˜¯ç¨³å®šçš„æ”¶å…¥</a></li>
<li><a href="../zh-CN441606/index.html">å‡ ä¹å¯é çš„è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="../zh-CN441608/index.html">å¯¹å¶æ€§-Windowsä¸‹ç®€æ˜“å¿«é€Ÿçš„igrostroyå¼•æ“ï¼ˆæ‰©å±•ï¼‰</a></li>
<li><a href="../zh-CN441610/index.html">LEDæ‰€å æ¯”ä¾‹ç©ºå‰</a></li>
<li><a href="../zh-CN441626/index.html">å·¥ä¸š3Dæ‰“å°ç ”è®¨ä¼šï¼š3æœˆ1æ—¥åœ¨Calibre Technopark</a></li>
<li><a href="../zh-CN441628/index.html">2018å¹´åœ£å½¼å¾—å ¡å’Œè«æ–¯ç§‘ITé›‡ä¸»è¯„çº§ï¼šå¼€å‘äººå‘˜è°ƒæŸ¥çš„ç»“æœ</a></li>
<li><a href="../zh-CN441632/index.html">3æœˆ1æ—¥-Teamleaderèšä¼šï¼šå‘˜å·¥è¯„ä¼°å’Œæ¿€åŠ±</a></li>
<li><a href="../zh-CN441634/index.html">Windows 98ä¸‹æœ‰ç”Ÿå‘½ï¼Œç¬¬äºŒéƒ¨åˆ†-å…³äºè½¯ä»¶</a></li>
<li><a href="../zh-CN441636/index.html">Linux Foundationå®£å¸ƒç”¨äºå¼€å‘è‡ªåŠ¨åŒ–ç³»ç»Ÿçš„å¼€æºELISAå¹³å°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>