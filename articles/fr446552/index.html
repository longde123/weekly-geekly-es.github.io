<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍻 🚚 👨🏼‍⚖️ Utilisation des commandes APDU à l'aide de l'exemple EToken 🎣 ⏪ 👸🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""... Le chemin n'est pas si difficile à comprendre. Les forces de la nature, les inclinations naturelles, les événements ... 
 Une compréhension primi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation des commandes APDU à l'aide de l'exemple EToken</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446552/">  <i>"... Le chemin n'est pas si difficile à comprendre. Les forces de la nature, les inclinations naturelles, les événements ...</i> <i><br></i>  <i>Une compréhension primitive du monde ne remarque que quatre éléments et ne va pas plus loin.</i>  <i>C’est comme si l’univers se résume à quatre phénomènes compréhensibles et compréhensibles. "</i> <i><br></i>  <i>Stephen Erickson.</i> <i><br></i>  <i>"Marée de minuit."</i> <br><br><img src="https://habrastorage.org/webt/pn/ja/xv/pnjaxvu9xha1saqk36veq8bghhm.jpeg" alt="image"><br><br>  Bonjour, Habr! <br><br>  Le sujet de l'APDU a été soulevé à plusieurs reprises, mais concernait principalement les cartes à puce, pour lesquelles vous avez besoin d'un lecteur de carte et d'une carte qui n'est pas dommage, plus un logiciel, car travailler avec l'interface de la console OpenSC, au moins dans Window $, est légèrement inconfortable. <br>  Pour ce faire, j'ai écrit un petit programme avec une interface de fenêtre qui fonctionne via Winscard. <br>  Les sources et les binaires peuvent être téléchargés <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br>  Ceci compilé sous Visual studio 2008, vous devez ajouter le projet WinSCard.Lib à partir du SDK Microsoft Windows au projet. <br><a name="habracut"></a><br>  Très probablement, il y aura du poisson bleu EToken PRO Java 72 K avec des certificats EDS expirés il y a de nombreuses années (en utilisant une «bataille» avec un EDS existant, le jeton n'est pas recommandé pour les expériences!). <br>  JaCarta Pro convient également, qui ne diffèrent des etokens qu'en externe. <br>  Vous pouvez également essayer de travailler avec le Gemalto SafeNet eToken 5100, ils peuvent afficher le contenu des répertoires, mais ils ne pourront pas lire le fichier en raison du très petit délai (probablement plusieurs millisecondes) entre les commandes pour sélectionner et lire le fichier, à la suite de quoi la commande pour lire le fichier se réfère manuellement déjà sur une place vide (code d'erreur 69 85).  C'est peut-être l'une des raisons pour lesquelles sur certaines plates-formes sur ces jetons, ils ne voient plus les clés.  En ce qui concerne SafeNet eToken 5100 (avec une inscription honnête sur le côté «Made in China»), je note ce qui suit: «JaCarta Single Client» ne veut pas travailler avec et affiche un message indiquant que ce produit n'est pas pris en charge, le client PKI eToken PKI 5.1 64 bits d'Aladdin Il ne le voit pas, mais la version 32 pour Win XP fonctionne avec, bien que pour ce jeton, il est conseillé d'installer le client d'authentification SafeNet d'origine, bien sûr. <br><br>  D'autres jetons, y compris la famille JaCarta, ne fonctionneront pas, car les commandes APDU pour eux sont tous complètement différents et leur valeur numérique décrite dans la norme ISO7816 ne correspond pas. <br><br>  Des détails sur le format des commandes APDU peuvent être trouvés, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br>  Un lecteur avec un poisson bleu peut se familiariser avec le travail de l'APDU sans se lever du canapé. <br>  Il est nécessaire d'installer le pilote pour eToken eToken PKI Client 5.1 ou "JaCarta Single Client" et de connecter le token. <br><br>  Pour une vue détaillée du contenu du jeton sous une forme pratique et une réconciliation avec ce que donnent les commandes APDU, vous pouvez utiliser celui que j'ai écrit sur l'éditeur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Autoit JaCarta</a> . <br><br>  Lancez APDUExplorer, sélectionnez «Aladdin Token JC 0» ou «ARDS JaCarta 0» ou «SafeNet Token JC 0» dans la liste des lecteurs et vous pouvez entrer des commandes. <br>  Vous pouvez entrer à la fois par des deux-points et par des espaces ou tous ensemble. <br><br>  Tout d'abord, vous pouvez vérifier les performances en cliquant sur «Vérifier ATR» et obtenir une réponse symbolique. <br><br>  La première commande consiste à sélectionner l'applet par défaut et à aller dans le répertoire racine avec l'identifiant 3f00 (cet identifiant est peut-être la seule chose commune aux jetons de tous les fournisseurs). <br>  00: A4: 00: 04: 00 <br><br>  Ensuite, nous obtenons une liste de dossiers dans le répertoire racine <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD (la commande est la constante "Liste des dossiers de rapport"). <br>  Une réponse doit être reçue: <br>  0a 02 66 66 0b 01 00 90 00 <br><br>  Le deuxième octet de la réponse est la taille des données reçues - deux octets, c'est-à-dire un seul dossier (l'identificateur de fichier ou de dossier dans l'APDU prend toujours deux octets). <br>  Et nous ne voyons qu'un seul dossier avec l'identifiant 66 66, appelé répertoire Aladdin AID. <br><br>  Liste des fichiers de rapport (également constante) <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Doit être reçu <br>  0a 00 0b 01 00 90 00 <br>  La réponse à la position 01 est 00. <br><br>  Accédez au répertoire 66 66 <br>  00 A4 08 04 02 66 66 00 <br>  Il s'agit d'une commande SELECT FILE, son format: quatre octets, la commande 00 A4 08 04 elle-même, puis la taille du champ de données du chemin complet (dans l'exemple 02 octets), puis le chemin lui-même (dans l'exemple 66 66) et 00 doivent être complétés. <br><br>  Liste des rapports des répertoires 66 66 <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD <br>  Octets de résolution: <br>  0a 04 50 01 50 00 0b 01 00 90 00 <br>  Le champ de réponse 01 (taille de réponse) indique 04, c'est-à-dire  4 octets = deux dossiers 50 01 et 50 00, tandis que 50 01 est le dossier de service et 50 00 est le principal, appelé répertoire PKCS # 11, où toutes les données sont stockées <br><br>  Signaler l'annuaire 66 66 <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Octets de résolution: <br>  0a 00 0b 01 00 90 00 <br>  Aucun fichier ici. <br><br>  Des études ont montré qu'il n'y a pas de dossiers et fichiers visibles dans le répertoire 50 01, alors allez dans le répertoire principal 50 00 <br>  00 A4 08 04 04 66 66 50 00 00 <br>  Liste des dossiers de rapport <br>  80: 01: 01: 00: 04: 09: 02: 00: 00: CD <br>  La réponse dépendra de ce qui est stocké sur le jeton. <br>  Liste des fichiers de rapport <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Octets de résolution: <br>  0a 14 00 0f 00 02 00 03 00 04 00 05 00 06 00 07 00 08 00 09 00 0a 0b 01 00 90 00 <br>  Nous voyons 14 fichiers (champ de réponse 01), puis tous les 2 octets ce sont des noms de fichiers, puis il y a des informations de service. <br><br>  Chaque jeton des modèles étudiés contient toujours un répertoire système b000 et le fichier système 0002, essayez de le lire, et d'autres fichiers peuvent être lus selon le même principe. <br>  Accédez au répertoire b0 00 <br>  00 A4 08 04 06 66 66 50 00 B0 00 00 <br>  Obtenez une liste de fichiers <br>  80: 01: 02: 00: 04: 09: 02: 00: 00: CD <br>  Octets de résolution: <br>  0a 02 00 02 0b 01 00 90 00 <br>  Nous voyons le fichier 00 02 (l'octet dans le champ de réponse 01 est la taille du nom (chaque nom prend toujours deux octets, les champs suivants sont les noms de fichier, dans ce cas, il n'y a qu'un seul fichier, qui est déterminé par la valeur du champ 01). <br><br>  Sélectionnez le fichier 0002 de B000 pour le chemin complet <br>  00 A4 08 04 08 66 66 50 00 B0 00 00 02 00 <br>  Octets de résolution: <br>  01 01 02 02 02 00 02 03 02 00 10 04 08 00 ff 00 00 ff ff ff ff 05 00 90 00 <br>  Le format de réponse est le suivant: préambule - 2 octets, type de fichier - 1 octet (fichier 02, dossier 01), délimiteur - 2 octets, nom de fichier - 2 octets, délimiteur - 2 octets, taille du fichier - 2 octets, délimiteur - 2 octets, droits d'accès - 1 octet (00 - accessible à tous, 63 est protégé par un code PIN).  Viennent ensuite des informations supplémentaires, se terminant par le code pour une exécution réussie de la commande APDU - 90 00. <br><br>  Lisez ce fichier, les deux derniers octets de la commande sont la taille du tampon combien lire (dans ce cas, il est égal à la taille du fichier). <br>  80 18 00 00 04 0E 02 00 00 10 <br>  Octets de résolution: (la valeur dans chaque cas sera différente): <br>  00 06 63 61 72 64 63 66 00 00 00 00 00 00 00 00 90 00 <br><br>  Je ne considère pas l'authentification sur l'etoken ici, car elle consiste en une séquence de commandes questions-réponses et est cryptée (il existe un projet Antitoken où le problème d'autorisation sur ces produits a été fondamentalement résolu). <br>  Certains autres jetons, tels que JaCarta GOST-2, prennent en charge l'authentification en passant simplement un code PIN. <br><br>  Vous pouvez obtenir les valeurs APDU des commandes de toutes les cartes à puce et jetons en interceptant le trafic WinSCard.dll en exécutant un sniffer compilé à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partir d'ici</a> (des expériences ont montré que ce sniffer est installé et ne fonctionne que sous Win XP). <br><br>  Pour référence, résultats possibles de l'exécution des commandes APDU: <br>  90 00 - OK <br>  69 85 - Conditions d'utilisation non satisfaites <br>  63 00 - Échec de l'authentification du cryptogramme hôte (Ext auth) <br>  64 00 - Pas de diagnostic spécifique <br>  67 00 - Longueur incorrecte en Lc <br>  67 XX - Erreur, paramètre P3 incorrect (code ISO) <br>  68 81 - Le canal logique n'est pas pris en charge ou n'est pas actif <br>  69 82 - Statut de sécurité non satisfait <br>  69 83 - Code secret verrouillé <br>  69 85 - Aucun EF actuellement sélectionné, aucune commande à surveiller / aucun fichier Transaction Manager <br>  6A 80 - Les paramètres du champ de données sont incorrects <br>  6A 81 - La carte est bloquée ou la commande n'est pas prise en charge <br>  6A 82 - Fichier introuvable <br>  6A 85 - Lc incompatible avec la structure TLV <br>  6A 86 - P1 P2 incorrect <br>  6A 88 - Données référencées non trouvées (mise à jour init) <br>  6D 00 - Instruction invalide <br>  6E 00 - Classe invalide </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446552/">https://habr.com/ru/post/fr446552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446538/index.html">PhotoGuru est passé du «côté obscur» au «plus sage»</a></li>
<li><a href="../fr446544/index.html">Microsoft étend le programme Azure IP Advantage avec de nouveaux avantages IP pour les innovateurs et les startups Azure IoT</a></li>
<li><a href="../fr446546/index.html">Microsoft étend Azure IP Advantage avec de nouveaux avantages IP pour les innovateurs et les startups Azure IoT</a></li>
<li><a href="../fr446548/index.html">Analyse des statistiques sur les campagnes publicitaires - créer une nouvelle métrique dans le DataFrame (python)</a></li>
<li><a href="../fr446550/index.html">Problèmes de modèle de coordinateur et qu'est-ce que RouteComposer a à voir avec cela</a></li>
<li><a href="../fr446554/index.html">Programme résident Yandex, ou Comment un back-end expérimenté devient ingénieur ML</a></li>
<li><a href="../fr446558/index.html">Structures de données exotiques: Merkle modifiée Patricia Trie</a></li>
<li><a href="../fr446560/index.html">"Courtesy Exchange": l'essence du conflit entre les deux sociétés de streaming les plus célèbres</a></li>
<li><a href="../fr446562/index.html">Asynchronie dans la programmation</a></li>
<li><a href="../fr446566/index.html">Project Zero. Comment Amazon veut gérer les contrefaçons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>