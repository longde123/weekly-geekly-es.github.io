<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛓️ 👩🏻‍🔧 🤲🏻 Atlassian Confluence: extensible dengan python 🤺 💇🏽 👋🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di Alfastrakhovanie kami secara aktif menggunakan "Wiki", mesin yang adalah Atlassian Confluence. Pertama kali saya secara serius menemukannya (dalam ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Atlassian Confluence: extensible dengan python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfastrah/blog/460929/"><p>  Di Alfastrakhovanie kami secara aktif menggunakan "Wiki", mesin yang adalah Atlassian Confluence.  Pertama kali saya secara serius menemukannya (dalam upaya untuk membuat konten di dalamnya), saya tidak memiliki "dinamisme" di dalamnya - saya ingin secara terprogram dapat membentuk bagian halaman, berinteraksi dengan sistem lain, dll. </p><br><p>  Untuk beberapa waktu dia membenturkan kepalanya ke dinding yang berbeda, tetapi kemudian dia melihat bahwa "tidak ada satu dinding pun di rumah."  Saya ingin berbagi pengalaman - bagaimana saya bisa menambahkan speaker ke Confluence.  Saya harap ini akan bermanfaat bagi mereka yang menggunakannya.  Dan, seperti biasa, untuk semua orang yang ingin tahu. </p><a name="habracut"></a><br><h2 id="dinamichnyy-viki">  Wiki dinamis </h2><br><p>  Awalnya, Confluence menyarankan satu cara universal untuk memperluas fungsionalitasnya - plugin.  Mungkin, dia bagus, hanya ada satu kelemahan - ambang masuk yang tinggi (Anda harus banyak belajar). </p><br><p>  Setelah berpikir pendek (berdasarkan standar ruang), ada dua cara yang cukup sederhana untuk memperluas fungsinya: makro standar "HTML" dan "HTML Include", dalam artikel ini saya akan fokus pada yang terakhir secara lebih rinci. </p><br><p>  Ada satu prinsip operasi untuk metode ini - kode HTML tertanam di halaman Confluence, bisa statis (yang juga bisa menarik, misalnya, untuk format halaman non-standar), dan bisa dinamis (termasuk komponen server). </p><br><h2 id="primer-zapros-na-soglasovanie">  Contoh: permintaan rekonsiliasi </h2><br><p>  Mari kita lihat cara yang diusulkan untuk memperluas kemampuan Pertemuan dengan contoh sederhana - daftar persetujuan dokumen. </p><br><p>  Apa yang ingin kita lakukan: tambahkan daftar persetujuan ke halaman sehingga semua orang dapat melihat siapa yang harus menyetujui dokumen, apakah itu disetujui dan, jika demikian, kapan. </p><br><p>  Untuk kenyamanan, kami akan membuat daftar item tombol dan menulis di dalamnya nama koordinator.  Tombol akan aktif jika halaman dilihat oleh koordinator, dan tidak aktif dalam semua kasus lainnya. </p><br><p> Setelah disetujui, tombol "akan berhenti menjadi tombol" - alih-alih tombol setelah persetujuan, kami menggambar pada halaman fakta persetujuan dalam bentuk teks (nama penerima dan tanggal persetujuan).  Dalam sebagian besar versi konsep (tanpa desain) mungkin terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3cf/285/175/3cf2851757c85ff0c8994dde698ec5d7.png" alt="gambar"></p><br><h3 id="shema-vzaimodeystviya">  Skema interaksi </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/600/48b/a4c/60048ba4cdef1ccdd55a355cb8bf3c19.png" alt="gambar"></p><br><p>  Komentar - cara kerjanya: </p><br><ul><li>  halaman dalam Confluence berisi beberapa "html include" makro - sebenarnya permintaan HTTP GET dengan parameter (kami akan mempertimbangkan lebih detail di bawah) </li><li>  saat merender halaman, permintaan ini (skrip python) dieksekusi di server aplikasi, hasilnya (dihasilkan HTML) digambar di halaman </li><li>  dalam proses kerjanya, skrip, misalnya, menghubungi database dengan riwayat penandatanganan halaman, jika halaman tersebut belum "ditandatangani" oleh penandatangan - HTML akan berisi tombol (semuanya seperti dijelaskan di atas) </li><li>  ketika Anda mengklik tombol, kirimkan terjadi - skrip python lain disebut (skrip untuk memproses fakta rekonsiliasi) </li><li>  skrip ini menyimpan informasi tentang fakta masuk ke basis data dan mengarahkan pengguna kembali ke halaman asli (saat merender fakta penandatanganan mana yang akan diperhitungkan - mengklik tombol "masuk") </li></ul><br><p>  Sedikit rumit dalam kata-kata, mari kita coba memperjelas kodenya. </p><br><p>  Jadi kita perlu membuat dua skrip </p><br><ul><li>  skrip untuk pembentukan tombol "tanda" (Saya akan menyebutnya skrip "tombol") </li><li>  skrip untuk mengetahui fakta penandatanganan (reaksi terhadap klik tombol - saya akan memanggil skripnya "penangan") </li></ul><br><p>  Ayo buat mereka, mulai dengan tombol. </p><br><h4 id="skript-knopka">  Tombol Skrip </h4><br><p>  Secara skematis, cara kerja skrip tombol: </p><br><pre><code class="python hljs">date = getSignDate() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> date: <span class="hljs-comment"><span class="hljs-comment">#       . else: if user==signee: #    else: #  inactive </span></span></code> </pre> <br><p>  Script harus berupa dokumen HTML yang valid, isi yang dalam bentuk paling minimal adalah formulir </p><br><ul><li>  aksi formulir berisi URL script "penangan" </li><li>  tombol aktif dikirimkan </li><li>  bidang formulir tersembunyi berisi parameter tambahan untuk penangan (dalam kasus kami, nama halaman dan info masuk penandatangan) </li></ul><br><p>  Perkiraan tampilan skrip (untuk singkatnya, saya membuang semua yang tidak perlu - lihat kode kerja penuh pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github</a> ) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   (  ) actual = form["actual"].value #    id = form["id"].value #  ,    resHtml = """ &lt;!DOCTYPE HTML&gt; &lt;html&gt; &lt;head&gt;&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;&lt;/head&gt; &lt;body&gt; &lt;form name="input" action="http://172.16.108.216/misc/sign_proc.py" method="get"&gt; """ server, token = wikiLogin() #   Confluence userName = getUserName(token, signee) #        res = getSignDate(id, signee) #     if res: #    resHtml += "&lt;p&gt; ({0}, {1})&lt;/p&gt;".format(userName, res) #   else: #    if signee.lower() == actual.lower(): #      -   resHtml += '&lt;input type="hidden" name="id" value="{0}"&gt;'.format(id) resHtml += '&lt;input type="hidden" name="signee" value="{0}"&gt;'.format(signee) resHtml += "   &lt;input type=\"submit\" value=\"{0}\"&gt;".format(userName) else: #      -    resHtml += "   &lt;input disabled type=\"submit\" value=\"{0}\"&gt;".format(userName) resHtml += "&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;" #   HTML sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="skript-obrabotchik">  Script "handler" </h4><br><p>  Tugas pawang sangat sederhana - untuk memperbaiki fakta dengan menekan tombol "setuju".  Kemudian arahkan kembali ke halaman asal permintaan - saat merender halaman, fakta koordinasi sudah akan diperhitungkan (lihat uraian di atas). </p><br><p>  Contoh "disingkat" skrip "penangan" (versi lengkap - lihat github) </p><br><pre> <code class="python hljs">form = cgi.FieldStorage() signee = form[<span class="hljs-string"><span class="hljs-string">"signee"</span></span>].value <span class="hljs-comment"><span class="hljs-comment">#   id = form["id"].value #  ,    addSignDate(id, signee) #    resHtml = """ &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="refresh" content="5;url=http://wiki.alfastrah.ru/display/DIT/{0}"&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt; &lt;title&gt; &lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt;    &lt;b&gt;{0}&lt;/b&gt;  &lt;b&gt;{1}&lt;/b&gt; . &lt;br&gt;      ...&lt;/p&gt; &lt;/body&gt; &lt;/html&gt; """.format(id, signee) sys.stdout.buffer.write(b'Content-Type: text/html;charset=utf-8\n\n') sys.stdout.buffer.write(resHtml.encode("utf-8"))</span></span></code> </pre> <br><h4 id="stranica-v-confluence">  Halaman dalam Confluence </h4><br><p>  Halaman di Confluence berisi tiga HTML makro termasuk dengan parameter yang berbeda (lihat kode di bawah) dan dalam versi paling sederhana terlihat seperti ini: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7ba/788/498/7ba788498511262c7e13618503eae77e.png" alt="gambar"></p><br><p>  Kode halaman dalam format markup wiki - di sini Anda dapat melihat parameternya </p><br><pre> <code class="plaintext hljs">&lt;h1&gt; &lt;/h1&gt; &lt;p&gt; ,  &lt;/p&gt; &lt;h1&gt; &lt;/h1&gt; &lt;ul&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=boss&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=korolevmv&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;li&gt; &lt;ac:structured-macro ac:macro-id="..." ac:name="html-include" ac:schema-version="1"&gt; &lt;ac:parameter ac:name="url"&gt; &lt;ri:url ri:value="http://z14-0510-wiksap.vesta.ru/misc/sign_btn.py?signee=maxvar&amp;amp;actual=korolevmv&amp;amp;id=wikitools_sign"/&gt; &lt;/ac:parameter&gt; &lt;/ac:structured-macro&gt; &lt;/li&gt; &lt;/ul&gt;</code> </pre> <br><h3 id="nemnogo-o-nastroyke">  Sedikit tentang pengaturan </h3><br><p>  Agar skema yang dijelaskan bekerja, perlu untuk mempertimbangkan hal berikut </p><br><h4 id="nalichie-makrosa-html-include">  Ketersediaan HTML Sertakan makro </h4><br><p>  Kadang-kadang administrator "menyembunyikan" itu - ada banyak masalah tambahan untuk itu (sisi lain dari kemungkinan). </p><br><p>  Makro ini gratis dan merupakan bagian dari Confluence - jika Anda tidak memilikinya, hubungi administrator, biarkan mereka melihat ... </p><br><h4 id="belye-spiski-confluence">  Daftar Putih Confluence </h4><br><p>  Confluence tidak akan mengeksekusi skrip yang di-host pada sumber yang tidak diketahui, host di mana skrip di-host harus dalam apa yang disebut "daftar putih" (hubungi admin).  Ini hanya berlaku untuk skrip "tombol" - skrip pawang dipanggil sudah oleh tombol, pembatasan Confluence tidak berlaku untuk itu. </p><br><h4 id="vypolnimost-skriptov">  Eksekusi skrip </h4><br><p>  Script (tombol dan penangan) harus dapat dieksekusi - salin URL ke browser, itu harus bekerja dan menghasilkan HTML, jika ini tidak terjadi, debug itu. </p><br><h4 id="oshibki-v-skriptah">  Kesalahan skrip </h4><br><p>  Jika ada skrip yang mengalami kesalahan - Anda tidak akan melihat sesuatu yang bagus, debug dengan benar sebelum menerbitkan ke Confluence. </p><br><h2 id="parametry-skriptov">  Opsi skrip </h2><br><p>  Pikiran yang ingin tahu dapat memperhatikan parameter skrip - di satu sisi, mereka berlebihan (misalnya, nama halaman tempat tombol persetujuan ditempatkan - diketahui, mengapa diisi?).  Di sisi lain, mereka tidak aman ("penyerang" dalam contoh kita dapat mengubah nama penerima untuk miliknya sendiri atau menghapus tombol rekonsiliasi sama sekali). </p><br><p>  Redundansi dapat "diatasi" oleh makro pengguna (saya telah bertanya-tanya sejak lama - bagaimana mereka bisa berguna? Saya akan menulis secara singkat di artikel terpisah).  Keamanan dalam Confluence dijamin oleh riwayat halaman - semua "gerakan" dicatat, Anda dapat mengubah apa pun, dalam Confluence masih ada "jejak audit" yang luar biasa yang memungkinkan Anda untuk memahami secara terperinci siapa yang mengubah apa dan kapan. </p><br><h2 id="vzaimodeystvie-so-stranicey">  Interaksi Halaman </h2><br><p>  Dalam praktik kami, ada beberapa kasus ketika kami harus menguraikan kode halaman untuk mengumpulkan data (misalnya, ini adalah cara kami mengelola portofolio proyek).  Itu mungkin dan bahkan tidak terlalu sulit.  Secara evolusi, kita sampai pada kesimpulan bahwa jika beberapa informasi pada halaman diperlukan hanya untuk kode yang menginterpretasikan informasi ini, maka informasi ini lebih mudah untuk segera dirumuskan dalam kode itu sendiri (dalam bentuk JSON, misalnya): mengeditnya dalam mode pengeditan halaman cukup sederhana , itu ditarik oleh program, tetapi penghematan parsing dan peningkatan keandalan signifikan. </p><br><h2 id="esche-primery">  Lebih banyak contoh </h2><br><p>  Kenapa lagi kita menggunakan makro ini (sebagai ide - tiba-tiba sesuatu terbukti berguna), sangat singkat </p><br><p>  Desain <strong>halaman</strong> : jika Anda ingin merancang halaman dengan cara yang tidak standar - markup menggunakan CSS, yang terkandung dalam blok HTML </p><br><p>  <strong>Kalender liburan</strong> : kami menggunakan beberapa kalender JS sederhana, isi dengan data dari JSON, yang kami edit langsung dalam kode halaman, kami mendapatkan piring yang indah dengan liburan yang dikelompokkan (tahun, bulan, minggu). </p><br><p>  <strong>Mencetak kartu tugas untuk papan scrum</strong> : kami mengatur parameter (nomor tugas dalam Jira dan atribut tambahan) dalam formulir tepat di halaman wiki (di blok HTML), sisi server membentuk kartu dalam bentuk yang sesuai untuk dikirim ke printer. </p><br><p>  <strong>Manajemen portofolio proyek</strong> : kami punya ide seperti itu.  Peta diberi skor tepat di wiki (peta skor adalah halaman yang ditandai khusus), peta ini mengumpulkan rencana blok besar, yang digambar dengan indah dalam bentuk bagan gantt. </p><br><p>  <strong>Glosarium</strong> : kemampuan untuk memvisualisasikan istilah - penjelasan untuk setiap kata halaman - dari kamus umum dan menerbitkan entri kamus dalam bentuk "pop-up".  Kamus itu sendiri secara otomatis dikumpulkan di bagian bawah halaman. </p><br><p>  <strong>Bagan</strong> : jika Anda perlu menggambar semacam bagan sederhana, maka sangat mudah untuk melakukannya dengan menyematkan blok HTML dengan salah satu paket standar (Google Charts, HighCharts, dll) </p><br><p>  <strong>Tabel</strong> : di atas semua tabel di Confluence Anda dapat "menggantung" Datatable - kami mendapatkan tabel yang difilter dengan "pagination", sangat bagus dan nyaman. </p><br><p>  Daftar ini dapat dilanjutkan cukup lama, selama operasi, satu ketidaknyamanan yang signifikan telah diperhatikan: kesalahan dalam kode server tidak dapat ditangkap dengan baik - 500 kesalahan divisualisasikan dengan buruk dan secara praktis tidak mengandung informasi.  Kalau tidak, bereksperimen - itu cukup aman. </p><br><h2 id="chut-podytozhim">  Untuk meringkas </h2><br><p>  Cara sederhana yang dijelaskan di atas untuk meningkatkan dinamika Confluence memungkinkan Anda untuk menyelesaikan berbagai masalah.  Untuk menggunakannya tidak memerlukan alat dan keterampilan khusus.  Penggunaannya cukup aman.  Saya merekomendasikannya. </p><br><p>  Pada artikel selanjutnya saya akan berbicara tentang pengalaman menggunakan macro khusus di Confluence - yang, menurut saya, benar-benar dapat ditingkatkan dengan bantuan mereka. </p><br><p>  Segalanya mungkin dalam pemrograman - hanya masalah waktu dan motivasi saja. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id460929/">https://habr.com/ru/post/id460929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id460911/index.html">Berbuat Baik, Berbuat Buruk: Menulis Kode Jahat dengan Go, Bagian 2</a></li>
<li><a href="../id460913/index.html">Tur foto museum Institut Fisika dan Energi di Obninsk</a></li>
<li><a href="../id460915/index.html">Sistem manajemen basis data yang nyaman</a></li>
<li><a href="../id460923/index.html">Tugas uji Yandex</a></li>
<li><a href="../id460925/index.html">Game online dengan robot RC asli di Chernobyl. Bagian 2</a></li>
<li><a href="../id460931/index.html">Tentang dekorator dengan Python</a></li>
<li><a href="../id460933/index.html">Minggu Keamanan 30: privasi, teknologi dan masyarakat</a></li>
<li><a href="../id460935/index.html">Memulai dengan Analyzer Statis PVS-Studio untuk Visual C #</a></li>
<li><a href="../id460939/index.html">Berbaris panjang tentang sejarah pertambangan Rusia dan sikap regulator terhadapnya</a></li>
<li><a href="../id460941/index.html">Kompromi Email Bisnis: Tidak Ada Pertahanan Terhadap Serangan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>