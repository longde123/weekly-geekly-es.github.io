<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó£Ô∏è ‚ñ∂Ô∏è üóÑÔ∏è Nous sommes s√©lectionn√©s dans la jungle des tests: nous construisons √† courte distance des luminaires aux tests üöµ üôèüèª üëãüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je veux offrir une alternative au style de conception de test traditionnel en utilisant les concepts de programmation fonctionnelle ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous sommes s√©lectionn√©s dans la jungle des tests: nous construisons √† courte distance des luminaires aux tests</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/463623/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  Dans cet article, je veux offrir une alternative au style de conception de test traditionnel en utilisant les concepts de programmation fonctionnelle de Scala.  L'approche a √©t√© inspir√©e par les nombreux mois de douleur dus au soutien de dizaines et de centaines de tests de chute et par un d√©sir ardent de les rendre plus faciles et plus compr√©hensibles. </p><br><p>  Malgr√© le fait que le code soit √©crit en Scala, les id√©es propos√©es seront pertinentes pour les d√©veloppeurs et les testeurs dans tous les langages qui prennent en charge le paradigme de programmation fonctionnelle.  Vous pouvez trouver un lien vers Github avec une solution compl√®te et un exemple √† la fin de l'article. </p><a name="habracut"></a><br><h2 id="problema">  Le probl√®me </h2><br><p>  Si vous avez d√©j√† trait√© des tests (peu importe - tests unitaires, d'int√©gration ou fonctionnels), il est fort probable qu'ils aient √©t√© √©crits sous la forme d'un ensemble d'instructions s√©quentielles.  Par exemple: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//     .     //  ,      ,  //     . "   = 'customer'" - { import TestHelper._ "    &lt; 250    -  " in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "    &gt;= 250    -  10%" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "   = 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  C'est la m√©thode pr√©f√©r√©e pour la plupart, ne n√©cessitant pas de d√©veloppement, pour d√©crire les tests.  Notre projet comprend environ 1000 tests de diff√©rents niveaux (tests unitaires, tests d'int√©gration, de bout en bout) et tous, jusqu'√† r√©cemment, √©taient √©crits dans un style similaire.  Au fur et √† mesure que le projet progressait, nous avons commenc√© √† ressentir des probl√®mes importants et un ralentissement avec le soutien de tels tests: mettre les tests en ordre n'a pas pris moins de temps que d'√©crire du code pertinent pour l'entreprise. </p><br><p>  Lors de l'√©criture de nouveaux tests, il fallait toujours penser √† z√©ro comment pr√©parer les donn√©es.  Souvent, copiez-collez les √©tapes des tests voisins.  En cons√©quence, lorsque le mod√®le de donn√©es dans l'application a chang√©, le ch√¢teau de cartes s'est effondr√© et a d√ª √™tre collect√© d'une nouvelle mani√®re √† chaque test: au mieux, juste un changement dans les fonctions des assistants, au pire - une immersion profonde dans le test et la r√©√©criture. </p><br><p>  Lorsque le test s'est √©cras√© honn√™tement - c'est-√†-dire √† cause d'un bogue dans la logique m√©tier, et non √† cause de probl√®mes dans le test lui-m√™me - il √©tait impossible de comprendre o√π quelque chose s'est mal pass√© sans d√©bogage.  √âtant donn√© qu'il a fallu beaucoup de temps pour comprendre les tests, personne ne connaissait parfaitement les exigences - comment le syst√®me devrait se comporter dans certaines conditions. </p><br><p>  Toute cette douleur est le sympt√¥me de deux probl√®mes plus profonds de cette conception: </p><br><ol><li>  Le contenu du test est autoris√© sous une forme trop l√¢che.  Chaque test est unique, comme un flocon de neige.  La n√©cessit√© de lire les d√©tails du test prend beaucoup de temps et se d√©motive.  Les d√©tails non importants d√©tournent l'attention de l'essentiel - les exigences v√©rifi√©es par le test.  Le copier-coller devient le principal moyen d'√©crire de nouveaux cas de test. </li><li>  Les tests n'aident pas le d√©veloppeur √† localiser les bogues, mais signalent uniquement un probl√®me.  Pour comprendre l'√©tat dans lequel le test est effectu√©, vous devez le restaurer dans votre t√™te ou vous connecter avec un d√©bogueur. </li></ol><br><h2 id="modelirovanie">  Mod√©lisation </h2><br><p>  Pouvons-nous faire mieux?  (Spoiler: nous pouvons.) Voyons en quoi consiste ce test. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  Le code test√©, en r√®gle g√©n√©rale, attendra la saisie de certains param√®tres explicites - identificateurs, tailles, volumes, filtres, etc. De plus, il aura souvent besoin de donn√©es du monde r√©el - nous voyons que l'application fait r√©f√©rence aux menus et aux mod√®les de menus base de donn√©es.  Pour une ex√©cution de test fiable, nous avons besoin d'un <em>appareil</em> - l'√©tat dans lequel le syst√®me et / ou les fournisseurs de donn√©es doivent se trouver avant le d√©but du test et les param√®tres d'entr√©e, souvent li√©s √† l'√©tat. </p><br><p>  Nous allons pr√©parer les <em>d√©pendances avec</em> ce luminaire - remplir la base de donn√©es (file d'attente, service externe, etc.).  Avec la d√©pendance pr√©par√©e, nous initialisons la classe test√©e (services, modules, r√©f√©rentiels, etc.). </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  En ex√©cutant le code de test sur certains param√®tres d'entr√©e, nous obtenons un <em>r√©sultat</em> ( <em>sortie</em> ) significatif pour l'entreprise - √† la fois explicite (renvoy√© par la m√©thode) et implicite - un changement dans l'√©tat notoire: base de donn√©es, service externe, etc. </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Enfin, nous v√©rifions que les r√©sultats sont exactement ce qu'ils attendaient, en r√©sumant le test avec une ou plusieurs <em>affirmations</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  On peut conclure qu'en g√©n√©ral, le test comprend les m√™mes √©tapes: pr√©paration des param√®tres d'entr√©e, ex√©cution du code de test sur eux et comparaison des r√©sultats avec ceux attendus.  Nous pouvons utiliser ce fait pour nous d√©barrasser du <strong>premier probl√®me du test</strong> - forme trop l√¢che, divisant clairement le test en √©tapes.  Cette id√©e n'est pas nouvelle et a longtemps √©t√© utilis√©e dans les tests de type BDD ( <em>d√©veloppement ax√© sur le comportement</em> ). </p><br><p>  Et l'extensibilit√©?  Chacune des √©tapes du processus de test peut contenir autant d'√©tapes interm√©diaires que vous le souhaitez.  √Ä l'avenir, nous pourrions former un appareil, en cr√©ant d'abord une sorte de structure lisible par l'homme, puis en la convertissant en objets qui remplissent la base de donn√©es.  Le processus de test est extensible √† l'infini, mais, en fin de compte, il se r√©sume toujours aux √©tapes principales. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="zapusk-testov">  Ex√©cution de tests </h2><br><p>  Essayons de r√©aliser l'id√©e de diviser le test en √©tapes, mais nous d√©terminons d'abord comment nous aimerions voir le r√©sultat final. </p><br><p>  En g√©n√©ral, nous voulons faire de la r√©daction et des tests de support un processus moins laborieux et plus agr√©able.  Moins d'instructions non explicites (r√©p√©t√©es ailleurs) sont moins explicites dans le corps du test, moins il faudra apporter de modifications aux tests apr√®s avoir chang√© de contrat ou de refactorisation et moins de temps il faudra pour lire le test.  La conception du test devrait encourager la r√©utilisation des morceaux de code fr√©quemment utilis√©s et emp√™cher la copie irr√©fl√©chie.  Ce serait bien si les tests avaient un aspect uniforme.  La pr√©visibilit√© am√©liore la lisibilit√© et fait gagner du temps - imaginez combien de temps il faudrait aux √©tudiants en physique pour ma√Ætriser chaque nouvelle formule si elle √©tait d√©crite en mots libres plut√¥t qu'en langage math√©matique. </p><br><p>  Ainsi, notre objectif est de cacher tout ce qui est distrayant et superflu, ne laissant que les informations essentielles √† la compr√©hension de l'application: ce qui est test√©, ce qui est attendu en entr√©e et ce qui est attendu en sortie. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Revenons au mod√®le de l'appareil de test.  Techniquement, chaque point de ce graphique peut √™tre repr√©sent√© par un type de donn√©es et des transitions de l'une √† l'autre - des fonctions.  Vous pouvez passer du type de donn√©es initial au type final en appliquant la fonction suivante au r√©sultat de la pr√©c√©dente une par une.  En d'autres termes, utiliser une <em>composition de fonctions</em> : pr√©parer les donn√©es (appelons-les <code>prepare</code> ), ex√©cuter le code de test ( <code>execute</code> ) et v√©rifier le r√©sultat attendu ( <code>check</code> ).  Nous passerons le premier point du graphique, fixture, √† l'entr√©e de cette composition.  La <strong>fonction d'</strong> ordre sup√©rieur qui en r√©sulte est appel√©e <strong>fonction de cycle de vie de</strong> test. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction cycle de vie</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">//  Scala  ,   check(execute(prepare(fixture))) //        andThen: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  La question est: d'o√π viennent les fonctions internes?  Nous pr√©parerons les donn√©es d'un nombre limit√© de fa√ßons - pour remplir la base de donn√©es, se mouiller, etc. - par cons√©quent, les options pour la fonction de pr√©paration seront communes √† tous les tests.  En cons√©quence, il sera plus facile de cr√©er des fonctions de cycle de vie sp√©cialis√©es qui masquent la mise en ≈ìuvre sp√©cifique de la pr√©paration des donn√©es.  √âtant donn√© que les m√©thodes d'invocation du code en cours de v√©rification et de v√©rification sont relativement uniques pour chaque test, l' <code>execute</code> et la <code>check</code> seront fournies explicitement. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction cycle de vie adapt√©e aux tests d'int√©gration sur la base de donn√©es</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    ‚Äî     def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  En d√©l√©guant toutes les nuances administratives √† la fonction de cycle de vie, nous avons la possibilit√© d'√©tendre le processus de test sans entrer dans un test d√©j√† √©crit.  En raison de la composition, nous pouvons infiltrer n'importe o√π dans le processus, y extraire ou ajouter des donn√©es. </p><br><p>  Pour mieux illustrer les possibilit√©s de cette approche, nous allons r√©soudre le <strong>deuxi√®me probl√®me de</strong> notre test initial - le manque d'informations de support pour localiser les probl√®mes.  Ajoutez la journalisation lors de la r√©ception d'une r√©ponse de la m√©thode test√©e.  Notre journalisation ne changera pas le type de donn√©es, mais ne produira qu'un <em>effet secondaire</em> - l'affichage d'un message sur la console.  Par cons√©quent, apr√®s l'effet secondaire, nous le rendrons tel quel. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction de journalisation du cycle de vie</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//       Logged  T, //    ‚Äú‚Äù  that  log(). //    - . loggedT.log(that) //    : that.log() that //    } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = //  logged     -  execute (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Avec un mouvement aussi simple, nous avons ajout√© la journalisation du r√©sultat renvoy√© et l'√©tat de la base <strong>de</strong> donn√©es <strong>dans chaque test</strong> .  L'avantage de ces petites fonctions est qu'elles sont faciles √† comprendre, faciles √† composer pour une r√©utilisation et faciles √† √©liminer si elles ne sont plus n√©cessaires. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  En cons√©quence, notre test ressemblera √† ceci: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">//  -    def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected //    Database   testInDb "   = 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  Le corps du test est devenu concis, les appareils et les contr√¥les peuvent √™tre r√©utilis√©s dans d'autres tests, et nous ne pr√©parons manuellement la base de donn√©es nulle part ailleurs.  Un seul probl√®me subsiste ... </p><br><h2 id="podgotovka-fikstur">  Pr√©paration du luminaire </h2><br><p>  Dans le code ci-dessus, nous avons utilis√© l'hypoth√®se que le luminaire proviendra d'un endroit pr√™t √† l'emploi et qu'il ne doit √™tre transf√©r√© qu'√† la fonction de cycle de vie.  √âtant donn√© que les donn√©es sont un ingr√©dient cl√© des tests simples et pris en charge, nous ne pouvons que nous pencher sur la fa√ßon de les former. </p><br><p>  Supposons que notre magasin de tests poss√®de une base de donn√©es moyenne de taille moyenne (pour simplifier, un exemple avec 4 tables, mais en r√©alit√© il peut y en avoir des centaines).  Une partie contient des informations g√©n√©rales, une partie - directement commerciale, et toutes ensemble, elle peut √™tre connect√©e √† plusieurs entit√©s logiques √† part enti√®re.  Les tables sont interconnect√©es par des cl√©s (cl√©s <em>√©trang√®res</em> ) - pour cr√©er une entit√© <code>Bonus</code> , vous avez besoin de l'entit√© <code>Package</code> et, √† son tour, de l' <code>User</code> .  Et ainsi de suite. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  Les circonstances des limitations de circuits et toutes sortes de hacks conduisent √† des incoh√©rences et, par cons√©quent, √† tester l'instabilit√© et des heures de d√©bogage passionnant.  Pour cette raison, nous remplirons honn√™tement la base de donn√©es. </p><br><p>  Nous pourrions utiliser des m√©thodes militaires pour le remplissage, mais m√™me avec un examen superficiel de cette id√©e, de nombreuses questions difficiles se posent.  Qu'est-ce qui pr√©parera les donn√©es des tests pour ces m√©thodes elles-m√™mes?  Dois-je r√©√©crire les tests si le contrat change?  Que se passe-t-il si les donn√©es sont fournies par une application non test√©e (par exemple, import√©es par quelqu'un d'autre)?  Combien de requ√™tes diff√©rentes devront √™tre effectu√©es afin de cr√©er une entit√© d√©pendante de nombreuses autres? </p><br><div class="spoiler">  <b class="spoiler_title">Remplissage de la base lors du test initial</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Les m√©thodes auxiliaires dispers√©es, comme dans l'exemple d'origine, sont le m√™me probl√®me, mais avec une sauce diff√©rente.  Ils nous attribuent la responsabilit√© de la gestion des objets d√©pendants et de leurs relations, et nous aimerions √©viter cela. </p><br><p>  Id√©alement, j'aimerais avoir ce type de donn√©es, un seul coup d'≈ìil suffit pour comprendre en termes g√©n√©raux dans quel √©tat sera le syst√®me pendant le test.  L'un des bons candidats pour la visualisation de l'√©tat est une table (√† la fois des <em>ensembles</em> de <em>donn√©es</em> en PHP et Python), o√π il n'y a rien de superflu √† l'exception des champs critiques pour la logique m√©tier.  Si la logique m√©tier change dans une fonction, toute la prise en charge des tests sera r√©duite √† la mise √† jour des cellules de l'ensemble de donn√©es.  Par exemple: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  √Ä partir de notre table, nous g√©n√©rerons des relations <em>cl√©s</em> - entit√© par ID.  Dans ce cas, si l'entit√© d√©pend d'une autre, une cl√© sera form√©e pour la d√©pendance.  Il peut arriver que deux entit√©s diff√©rentes g√©n√®rent une d√©pendance avec le m√™me identifiant, ce qui peut entra√Æner une violation de la restriction sur la cl√© primaire de la base de donn√©es ( <em>cl√© primaire</em> ).  Mais √† ce stade, les donn√©es sont extr√™mement bon march√© √† d√©dupliquer - puisque les cl√©s ne contiennent que des identifiants, nous pouvons les placer dans une collection qui fournit la d√©duplication, par exemple, dans <code>Set</code> .  Si cela s'av√®re insuffisant, nous pouvons toujours effectuer une d√©duplication plus intelligente sous la forme d'une fonction suppl√©mentaire compil√©e en fonction de cycle de vie. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple cl√©</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  Nous d√©l√©guons la g√©n√©ration de faux contenu √† des champs (par exemple, des noms) √† une classe distincte.  Ensuite, en recourant √† l'aide de cette classe et aux r√®gles de conversion des cl√©s, nous obtenons des objets cha√Æne destin√©s directement √† l'insertion dans la base de donn√©es. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de ligne</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Les fausses donn√©es par d√©faut, en r√®gle g√©n√©rale, ne nous suffiront pas, nous devrons donc √™tre en mesure de red√©finir des champs sp√©cifiques.  Nous pouvons utiliser des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>lentilles</em></a> - parcourez toutes les lignes cr√©√©es et modifiez les champs de celles qui sont n√©cessaires.  Comme les lentilles sont finalement des fonctions ordinaires, elles peuvent √™tre composites, et c'est leur utilit√©. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple d'objectif</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Gr√¢ce √† la composition, dans l'ensemble du processus, nous pouvons appliquer diverses optimisations et am√©liorations - par exemple, grouper des lignes dans des tableaux afin qu'elles puissent √™tre ins√©r√©es avec une seule <code>insert</code> , r√©duire le temps de test ou s√©curiser l'√©tat final de la base de donn√©es pour simplifier les probl√®mes de capture. </p><br><div class="spoiler">  <b class="spoiler_title">Fonction de mise en forme du luminaire</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Tous ensemble nous donneront un appareil qui remplit la d√©pendance pour le test - la base de donn√©es.  Dans le test lui-m√™me, rien de superflu ne sera vu, √† l'exception de l'ensemble de donn√©es d'origine - tous les d√©tails seront cach√©s dans la composition des fonctions. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Notre suite de tests ressemblera maintenant √† ceci: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"   -"</span></span> - { <span class="hljs-string"><span class="hljs-string">"'customer'"</span></span> - { <span class="hljs-string"><span class="hljs-string">"   "</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250    -  "</span></span> - { <span class="hljs-string"><span class="hljs-string">"(:  )"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(:  )"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250   "</span></span> - { <span class="hljs-string"><span class="hljs-string">"   -  10%  "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"   -  10%     "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"'vip' -    20%      ,       "</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  Un code d'aide: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  L'ajout de nouveaux cas de test √† la table devient une t√¢che triviale, qui vous permet de vous concentrer sur la <strong>couverture du nombre maximum de conditions aux limites</strong> , plut√¥t que sur un passe-partout. </p><br><h2 id="pereispolzovanie-koda-podgotovki-fikstur-na-drugih-proektah">  R√©utilisation du code de pr√©paration des appareils sur d'autres projets </h2><br><p>  Eh bien, nous avons √©crit beaucoup de code pour pr√©parer des appareils dans un projet sp√©cifique, en y consacrant beaucoup de temps.  Et si nous avons plusieurs projets?  Sommes-nous condamn√©s √† r√©inventer la roue et √† copier-coller √† chaque fois? </p><br><p>  Nous pouvons faire abstraction de la pr√©paration des luminaires √† partir d'un mod√®le de domaine sp√©cifique.  Dans le monde de la FP, il y a le concept d'une <em>classe de types</em> .  En bref, les classes de types ne sont pas des classes de POO, mais quelque chose comme des interfaces, elles d√©finissent un comportement de groupe de types.  La diff√©rence fondamentale est que ce groupe de types n'est pas d√©termin√© par l'h√©ritage de classe, mais par l'instanciation, comme les variables ordinaires.  Comme pour l'h√©ritage, la r√©solution d'instances de classes de types (via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">implicits</a> ) se produit <em>statiquement</em> , au stade de la compilation.  Pour simplifier, pour nos besoins, les classes de types peuvent √™tre consid√©r√©es comme des <em>extensions</em> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kotlin</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C #</a> . </p><br><p>  Pour mettre en gage un objet, nous n'avons pas besoin de savoir ce que cet objet a √† l'int√©rieur, quels champs et m√©thodes il a.  Il est seulement important pour nous que le comportement du <code>log</code> avec une certaine signature lui soit d√©fini.  Il serait <code>Logged</code> d'impl√©menter une certaine interface <code>Logged</code> dans chaque classe, et ce n'est pas toujours possible - par exemple, dans une biblioth√®que ou des classes standard.  Dans le cas des classes de caract√®res, tout est beaucoup plus simple.  Nous pouvons cr√©er une instance de la <code>Logged</code> , par exemple, pour les appareils, et l'afficher sous une forme lisible.  Et pour tous les autres types, cr√©ez une instance pour le type <code>Any</code> et utilisez la m√©thode <code>toString</code> standard pour enregistrer gratuitement tous les objets dans leur repr√©sentation interne. </p><br><div class="spoiler">  <b class="spoiler_title">Un exemple de la classe Tagged et de ses instances</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">//   Future implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map  Future       ,   //  logger.info(t.toString()) t } } } // ,        implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  En plus de la journalisation, nous pouvons √©tendre cette approche √† l'ensemble du processus de pr√©paration des luminaires.  La solution de test proposera ses propres timeclasses et l'impl√©mentation abstraite de fonctions bas√©es sur celles-ci.  La responsabilit√© du projet qui l'utilise est d'√©crire sa propre instance de classes de types pour les types. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // ,   - (, )   trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...    trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...     trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } //      (.     ) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Lors de la conception du g√©n√©rateur de luminaires, je me suis concentr√© sur la mise en ≈ìuvre des principes de programmation et de conception SOLIDE comme indicateur de sa stabilit√© et de son adaptabilit√© √† diff√©rents syst√®mes: </p><br><ul><li>  <em>Le principe de responsabilit√© unique</em> : chaque classe de type d√©crit exactement un aspect du comportement de type. </li><li>  <em>Le principe ouvert et ferm√©</em> : nous ne modifions pas le type de combat existant pour les tests, nous l'√©tendons avec les instances des tyclasses. </li><li>  <em>Le principe de substitution de Liskov</em> n'a pas d'importance dans ce cas, car nous n'utilisons pas d'h√©ritage. </li><li>  <em>Le principe de s√©gr√©gation d'interface</em> : nous utilisons de nombreuses classes de temps sp√©cialis√©es au lieu d'une seule globale. </li><li>  <em>Le principe d'inversion de d√©pendance</em> : la mise en ≈ìuvre du g√©n√©rateur de fixture ne d√©pend pas de types de combat sp√©cifiques, mais de calendriers abstraits. </li></ul><br><p>  Apr√®s s'√™tre assur√© que tous les principes sont respect√©s, on peut affirmer que notre solution semble suffisamment soutenue et √©volutive pour √™tre utilis√©e dans diff√©rents projets. </p><br><p>  Apr√®s avoir √©crit les fonctions du cycle de vie, la g√©n√©ration d'appareils et la conversion d'ensembles de donn√©es en appareils, ainsi que l'abstraction d'un mod√®le de domaine sp√©cifique de l'application, nous sommes enfin pr√™ts √† adapter notre solution √† tous les tests. </p><br><h2 id="itogi">  R√©sum√© </h2><br><p>  Nous sommes pass√©s du style traditionnel (√©tape par √©tape) de la conception de test √† celui fonctionnel.  Un style √©tape par √©tape est bon dans les premiers stades et les petits projets, car il ne n√©cessite pas de travail suppl√©mentaire et ne limite pas le d√©veloppeur, mais commence √† perdre lorsqu'il y a beaucoup de tests sur le projet.  Le style fonctionnel n'est pas con√ßu pour r√©soudre tous les probl√®mes de test, mais il peut grandement faciliter la mise √† l'√©chelle et la prise en charge des tests dans les projets o√π leur nombre est de plusieurs centaines ou milliers.  Les tests de style fonctionnel sont plus compacts et se concentrent sur ce qui est vraiment important (donn√©es, code de test et r√©sultat attendu), et non sur des √©tapes interm√©diaires. </p><br><p>  De plus, nous avons examin√© un exemple vivant de la puissance des concepts de composition et de typeclasses dans la programmation fonctionnelle.  Avec leur aide, il est facile de concevoir des solutions, dont une partie int√©grante sont l'extensibilit√© et la r√©utilisabilit√©. </p><br><p>      ,         ,     ,    .    ,   ,     ,     -.    ,        .   ! </p><br><hr><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463623/">https://habr.com/ru/post/fr463623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463609/index.html">Syst√®me de recommandation pour Directum Club. Premi√®re partie, Collaborative</a></li>
<li><a href="../fr463611/index.html">Plugins fantastiques, vol. 2. Pratique</a></li>
<li><a href="../fr463613/index.html">Les images Docker peuvent √©galement √™tre construites dans werf en utilisant le Dockerfile habituel</a></li>
<li><a href="../fr463617/index.html">Caract√©ristiques du test du MMO mobile</a></li>
<li><a href="../fr463619/index.html">Travailler √† distance: notre exp√©rience</a></li>
<li><a href="../fr463625/index.html">Surveillance du r√©seau et d√©tection de l'activit√© r√©seau anormale √† l'aide des solutions Flowmon Networks</a></li>
<li><a href="../fr463627/index.html">Biblioth√®que de g√©n√©rateur de code assembleur pour microcontr√¥leurs AVR. Partie 4</a></li>
<li><a href="../fr463629/index.html">Configuration de NextCloud + ONLYOFFICE sur le m√™me serveur √† l'aide de Docker</a></li>
<li><a href="../fr463631/index.html">Dialogues sur les lettres</a></li>
<li><a href="../fr463637/index.html">Tester votre infrastructure en tant que code avec Pulumi. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>