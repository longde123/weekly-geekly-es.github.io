<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîî üë®üèæ‚Äçüç≥ üç° Compilaci√≥n cruzada en docker. Por que no üçº üññüèª üëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© es la compilaci√≥n cruzada? ¬øCu√°les son las herramientas para construir archivos binarios para Windows en Linux ? ¬øC√≥mo configurar el contenedor d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compilaci√≥n cruzada en docker. Por que no</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456916/"><p> ¬øQu√© es la compilaci√≥n cruzada?  ¬øCu√°les son las herramientas para construir archivos binarios para <strong>Windows</strong> en <strong>Linux</strong> ?  ¬øC√≥mo configurar el contenedor <strong>docker</strong> para todo esto?  Estos son solo algunos de los temas que se discutir√°n a continuaci√≥n. </p><a name="habracut"></a><br><h2 id="instrumenty">  Las herramientas </h2><br><p>  La compilaci√≥n cruzada le permite obtener c√≥digo ejecutable para una plataforma distinta de aquella en la que se ejecuta este proceso. </p><br><p>  En este art√≠culo, veremos la compilaci√≥n cruzada para la plataforma <strong>Windows</strong> en <strong>Linux</strong> . </p><br><p>  Un ejemplo de un compilador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cruzado</a> es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mingw-w64</a> .  De hecho, proporciona solo una herramienta para compilar la aplicaci√≥n, pero si necesita bibliotecas de terceros que no forman parte de la <strong>STL</strong> , tendr√° que recopilarlas y sus dependencias.  Tambi√©n puede usar archivos binarios ya preparados, como se describe en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art√≠culo</a> . </p><br><p>  El proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mxe</a> , que proporciona no solo herramientas, sino tambi√©n bibliotecas, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">simplifica la</a> configuraci√≥n del ensamblaje.  Su lista se puede encontrar en el sitio web oficial.  Al instalar bibliotecas, se usa el control de dependencia, es decir  Se instalar√° el paquete requerido y todo lo necesario para su funcionamiento.  Las herramientas se entregan en una configuraci√≥n preconfigurada, por ejemplo, para el ensamblaje est√°tico de aplicaciones de 64 bits.  Esto facilita enormemente el montaje. </p><br><p>  El entorno <strong>mxe se</strong> implementa en la carpeta local del usuario.  Para hacer esto, simplemente instale las dependencias a trav√©s del administrador de paquetes y clone el repositorio.  En la ra√≠z del repositorio hay un <strong>Makefile</strong> , que realiza la instalaci√≥n de bibliotecas establecidas para ese prop√≥sito, agrega herramientas para ensamblar, etc. </p><br><p>  Es importante tener en cuenta que el entorno de compilaci√≥n est√° localizado dentro de su carpeta, esto le permite configurar un entorno individual para cada aplicaci√≥n. </p><br><h2 id="konteyneriziruy-eto">  Contenerlo </h2><br><p>  Digamos que la compilaci√≥n de lanzamiento para <strong>Windows</strong> est√° configurada en la m√°quina local.  Las versiones salen con bastante frecuencia, en algunas versiones se agregan nuevas bibliotecas, y algunas, por ejemplo, se eliminan.  Un buen d√≠a, el jefe exige <em>deshacerse de</em> la versi√≥n de lanzamiento para un principiante.  ¬øC√≥mo configura su entorno de construcci√≥n?  ¬øQu√© bibliotecas deben tomarse del repositorio <strong>mxe</strong> y para qu√© compilaci√≥n desde el origen? </p><br><p>  En este caso, puede obtener un script <strong>bash</strong> que implementar√° todo el entorno en una carpeta determinada.  Y despu√©s de <em>tratar de</em> mantener este script actualizado.  Pero, al igual que la documentaci√≥n del proyecto, en un momento cr√≠tico, puede quedar desactualizado. </p><br><p>  Una buena soluci√≥n ser√≠a aislar nuestro entorno de construcci√≥n dentro del contenedor <strong>acoplable</strong> .  El archivo <strong>docker</strong> contendr√° un conjunto de instrucciones independientes para implementar el entorno, y la presencia de un contenedor ayudar√° a evitar el desorden del sistema dom√©stico con bibliotecas innecesarias. </p><br><h2 id="sobiraem-vse-vmeste">  Poniendo todo junto </h2><br><p>  Para una demostraci√≥n, tomemos un proyecto <strong>Qt</strong> simple: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SimpleQtProject</a> .  Este proyecto est√° construido por la utilidad <strong>qmake</strong> y consta de una sola forma.  Esto, por supuesto, se hace por simplicidad.  Tambi√©n en la carpeta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acoplable</a> hay un archivo para construir el contenedor. </p><br><p>  Considere un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivo de</a> proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">docker</a> .  De hecho, consta de varias partes principales: </p><br><ul><li>  instalar dependencias para el sistema de compilaci√≥n </li><li>  instalaci√≥n y configuraci√≥n del sistema de montaje </li><li>  compilar el proyecto y copiar artefactos al sistema host </li></ul><br><blockquote>  A continuaci√≥n, solo se consideran los comandos b√°sicos del archivo, para una familiarizaci√≥n completa se recomienda consultar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> . </blockquote><p>  Omitimos el primer punto y procedemos directamente a la instalaci√≥n de <strong>mxe</strong> . <br>  Clonar el repositorio: </p><br><pre><code class="plaintext hljs">RUN mkdir /cross \ &amp;&amp; cd /cross \ &amp;&amp; git clone https://github.com/mxe/mxe.git \ &amp;&amp; cd mxe \ &amp;&amp; git checkout build-2019-06-02</code> </pre> <br><p>  En el momento de escribir este art√≠culo, la √∫ltima versi√≥n fue <strong>build-2019-06-02</strong> .  La rama maestra no se usa aqu√≠ por una simple raz√≥n: se requiere la repetibilidad del ensamblaje.  De lo contrario, al agregar nuevas confirmaciones al maestro, el ensamblado puede romperse. </p><br><p>  A continuaci√≥n, configuramos el sistema de compilaci√≥n: </p><br><pre> <code class="plaintext hljs">RUN make MXE_TARGETS=x86_64-w64-mingw32.static qtbase -j4 JOBS=4</code> </pre> <br><p>  Este comando agregar√° herramientas (instancias de <strong>cmake</strong> y <strong>Mingw-w64</strong> , etc.) para el ensamblaje est√°tico del proyecto bajo la arquitectura de 64 bits, y luego ensamblar√° <strong>Qt</strong> us√°ndolas. </p><br><p>  El siguiente paso es agregar la ruta a los archivos ejecutables <strong>mxe</strong> en <strong>PATH</strong> : </p><br><pre> <code class="plaintext hljs">ENV PATH="/cross/mxe/usr/bin:${PATH}"</code> </pre> <br><p>  Despu√©s de configurar el entorno de compilaci√≥n, puede ir directamente al √∫ltimo elemento: </p><br><pre> <code class="plaintext hljs">ENTRYPOINT x86_64-w64-mingw32.static-qmake-qt5 /app/src/SimpleQtProject.pro \ &amp;&amp; make release \ &amp;&amp; cp release/SimpleQtProject.exe /app/res/</code> </pre> <br><p>  Aqu√≠ hay algunos puntos para aclarar.  Se supone que cuando se inicia el contenedor, la carpeta de origen que contiene el archivo <strong>* .pro</strong> se montar√° en la carpeta <strong>/ app / src /</strong> , y el lugar donde se deben agregar los resultados del ensamblaje se montar√° en el directorio <strong>/ app / res /</strong> . </p><br><p>  El siguiente es un ejemplo de un comando para crear <strong>docker-image</strong> , debe ejecutarse en la carpeta <strong>docker</strong> del proyecto en cuesti√≥n: </p><br><pre> <code class="plaintext hljs">docker build -t simple-qt-build --file windows.docker .</code> </pre> <br><p>  La asamblea comienza all√≠: </p><br><pre> <code class="plaintext hljs">docker run --mount type=bind,source=$(pwd)/result/,target=/app/res --mount type=bind,source=$(pwd)/../,target=/app/src simple-qt-build</code> </pre> <br><p>  Antes de ejecutar el comando, debe crear la carpeta de <strong>resultados</strong> en el directorio <strong>acoplable</strong> para copiar los resultados. </p><br><h2 id="kastomizaciya-sborki">  Personalizaci√≥n de ensamblaje </h2><br><p>  Por defecto, <strong>mxe</strong> proporciona <strong>MinGW</strong> versi√≥n <strong>5.5.0</strong> (al menos esto es cierto para build <strong>build-2019-06-02</strong> ). </p><br><p>  Si el proyecto usa nuevas caracter√≠sticas de <strong>C ++ 17</strong> , entonces esa versi√≥n del compilador no es satisfactoria.  Afortunadamente, el entorno de compilaci√≥n proporciona versiones m√°s nuevas como complementos separados.  Para resolver nuestro problema, necesitamos agregar instrucciones para usar el complemento apropiado al equipo de compilaci√≥n de la biblioteca: </p><br><pre> <code class="plaintext hljs">make MXE_TARGETS=x86_64-w64-mingw32.static MXE_PLUGIN_DIRS=plugins/gcc7 qtbase -j4 JOBS=4</code> </pre> <br><p>  Este comando crear√° un kit para el ensamblaje est√°tico de aplicaciones de 64 bits utilizando el compilador de la s√©ptima versi√≥n ( <strong>7.4.0</strong> ).  Si dicho kit <strong>ya existe</strong> , entonces <strong>no se</strong> cambiar√°. </p><br><p>  Puede encontrar una lista de todos los complementos disponibles en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">p√°gina</a> . </p><br><p>  El directorio <strong>mxe / src</strong> contiene archivos <strong>* .mk</strong> que describen los par√°metros de ensamblaje de un paquete en particular.  Si es necesario, puede hacer los ajustes necesarios a un paquete existente o agregar el suyo propio.  La estructura del archivo se describe aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/mxe/mxe/wiki/Add-a-New-Package:-Full-Version</a> . </p><br><p>  Para copiar dependencias, el proyecto mxe proporciona la utilidad <a href="">copydlldeps.sh</a> .  Pero esta no es la √∫nica herramienta √∫til, sus listas completas se pueden encontrar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">p√°gina</a> . </p><br><h2 id="cmake-i-staticheskaya-linkovka-qt">  CMake y enlace est√°tico Qt </h2><br><p>  Dio la casualidad de que en mi proyecto us√© <strong>Qt</strong> y el sistema de compilaci√≥n <strong>CMake</strong> .  Cuando se decidi√≥ crear un proyecto para <strong>Windows</strong> , una excelente soluci√≥n fue construir todo utilizando un enlace est√°tico para proporcionar a los usuarios un binario, sin ninguna dependencia. </p><br><p>  Analizando una monta√±a de errores de enlazador, fue posible descubrir que tal ensamblaje fuera de la caja no funciona, en ning√∫n otro lugar.  El hecho es que cuando se usa el enlace est√°tico, <strong>qmake</strong> genera un archivo <strong>* .cpp</strong> , que contiene instrucciones para importar complementos, sobre este tipo: </p><br><pre> <code class="plaintext hljs">// This file is autogenerated by qmake. It imports static plugin classes for // static plugins specified using QTPLUGIN and QT_PLUGIN_CLASS.&lt;plugin&gt; variables. #include &lt;QtPlugin&gt; Q_IMPORT_PLUGIN(QWindowsVistaStylePlugin) Q_IMPORT_PLUGIN(QWindowsIntegrationPlugin) Q_IMPORT_PLUGIN(QGifPlugin) Q_IMPORT_PLUGIN(QICOPlugin) Q_IMPORT_PLUGIN(QJpegPlugin)</code> </pre> <br><p>  Tambi√©n se agregan banderas y bibliotecas para la etapa de vinculaci√≥n en el <strong>Makefile</strong> . </p><br><p>  Puede intentar experimentar con este dise√±o en <strong>CMakeLists.txt</strong> : </p><br><pre> <code class="plaintext hljs">foreach(plugin ${Qt5Gui_PLUGINS}) get_target_property(_loc ${plugin} LOCATION) message("Plugin ${plugin} is at location ${_loc}") set(plugin_libs ${plugin_libs} ${_loc}) endforeach()</code> </pre> <br><p>  Y luego agregue el uso de <code>plugin_libs</code> .  Pero para m√≠, este enfoque no trajo ning√∫n resultado. </p><br><p>  Al final, tom√© la decisi√≥n de vincular din√°micamente (si es posible) todas las bibliotecas externas y copiar, junto con el archivo ejecutable, los <a href="">archivos DLL</a> necesarios usando <a href="">copydlldeps.sh</a> .  En m√°s detalle sobre la implementaci√≥n bajo <strong>Qt</strong> en <strong>Windows se</strong> describe en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> . </p><br><h2 id="v-zaklyuchenii">  En conclusi√≥n </h2><br><p>  Se mostr√≥ anteriormente c√≥mo, en unos pocos pasos simples, puede configurar el entorno para compilar un proyecto de forma cruzada.  Pero, desafortunadamente, en condiciones reales, no todo es tan color de rosa. </p><br><p>  Aunque el proyecto <strong>mxe</strong> proporciona una lista impresionante de bibliotecas, a√∫n puede no incluir las que necesita o incluir versiones demasiado nuevas.  S√≠, existe la oportunidad de crear un paquete usted mismo o, en el peor de los casos, crear una biblioteca desde la fuente.  Pero no todo se puede construir con un compilador cruzado, por lo que no podr√≠a hacerlo con el proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cpprestsdk</a> , porque necesita el <strong>vcpkg</strong> instalado. </p><br><p>  Muchos problemas que pueden surgir al construir un proyecto con un compilador cruzado son t√≠picos para el desarrollo multiplataforma en general.  Por ejemplo, tuve un error extra√±o debido a un elemento de enumeraci√≥n <code>ERROR</code> .  Result√≥ que en uno de los archivos de encabezado de <strong>Windows</strong> hay una macro con el mismo nombre.  Su sustituci√≥n rompi√≥ todo el c√≥digo. </p><br><p>  Es asunto de todos usar la compilaci√≥n cruzada o no.  Esto me trajo una buena ganancia.  Configur√© el ensamblaje para varias <strong>distribuciones de Linux</strong> y <strong>Windows</strong> en contenedores <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acoplados</a> separados para mi proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SecureDialogues</a> , agregu√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivo MAKE</a> para iniciar el proceso uno por uno para cada contenedor.  A continuaci√≥n, ejecute <strong>make</strong> y despu√©s de un tiempo obtengo los archivos binarios para el sistema operativo requerido en la carpeta local. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/456916/">https://habr.com/ru/post/456916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456902/index.html">Notificaciones push seguras: de la teor√≠a a la pr√°ctica</a></li>
<li><a href="../456904/index.html">Prueba de carga de un proyecto web: sin efectivo</a></li>
<li><a href="../456908/index.html">C√≥mo Telegram te fusiona con Rostelecom</a></li>
<li><a href="../456910/index.html">Internet project security.txt - conociendo otro archivo .well conocido</a></li>
<li><a href="../456912/index.html">C√≥mo hacer sitios en 2019</a></li>
<li><a href="../456920/index.html">Sony Xperia 1 en Rusia - bonificaciones de precio y pre-pedido</a></li>
<li><a href="../456922/index.html">C√≥mo se dise√±an y fabrican los procesadores: los fundamentos de la arquitectura inform√°tica</a></li>
<li><a href="../456926/index.html">¬øC√≥mo hacemos Sportmaster?</a></li>
<li><a href="../456928/index.html">JMeter - Cuchillo suizo de prueba (Parte 1)</a></li>
<li><a href="../456930/index.html">Trayendo IoT a las masas: resultados del primer hackathon IoT de GeekBrains y Rostelecom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>