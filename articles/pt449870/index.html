<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèº üòé üöã JSONDecoder gen√©rico ‚û°Ô∏è üôéüèª üíπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No momento, a grande maioria dos aplicativos m√≥veis √© cliente-servidor. Em todos os lugares h√° carregamento, sincroniza√ß√£o, envio de eventos e a princ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>JSONDecoder gen√©rico</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449870/"><p> No momento, a grande maioria dos aplicativos m√≥veis √© cliente-servidor.  Em todos os lugares h√° carregamento, sincroniza√ß√£o, envio de eventos e a principal maneira de interagir com o servidor √© trocar dados usando o formato json. </p><a name="habracut"></a><br><h3 id="key-decoding">  Decodifica√ß√£o de chave </h3><br><p> A Funda√ß√£o possui dois mecanismos para serializar dados mortos.  Antigo √© <code>NSJsonSerialization</code> e novo √© <code>Codable</code> .  O √∫ltimo da lista de vantagens tem uma coisa t√£o maravilhosa quanto a gera√ß√£o autom√°tica de chaves para dados json com base em uma estrutura (ou classe) que implementa <code>Codable</code> ( <code>Encodable</code> , <code>Decodable</code> ) e um inicializador para decodificar dados. </p><br><p>  E tudo parece estar bem, voc√™ pode usar e aproveitar, mas a realidade n√£o √© t√£o simples. <br>  Muitas vezes, no servidor, voc√™ pode ver o json do formul√°rio: </p><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"topLevelObject"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"underlyingObject"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Error"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ErrorCode"</span></span>: <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ErrorDescription"</span></span>: <span class="hljs-string"><span class="hljs-string">"SomeDescription"</span></span> } }</code> </pre> <br><p>  Este √© um exemplo quase real de um dos servidores de projeto. </p><br><p>  Para a classe <code>JsonDecoder</code> , <code>JsonDecoder</code> pode especificar o trabalho com as teclas snake_case, mas e se tivermos UpperCamelCase, dash-snake-case ou at√© uma mistura geral, mas n√£o quisermos escrever as chaves manualmente? </p><br><p>  Felizmente, a Apple forneceu a capacidade de configurar o mapeamento de chaves antes de <code>CodingKeys</code> lo com a estrutura <code>JSONDecoder.KeyDecodingStrategy</code> usando <code>JSONDecoder.KeyDecodingStrategy</code> .  Vamos tirar proveito disso. </p><br><p>  Primeiro, crie uma estrutura que implemente o protocolo <code>CodingKey</code> , porque n√£o h√° nenhuma na biblioteca padr√£o: </p><br><pre> <code class="swift hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyCodingKey</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CodingKey</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stringValue: <span class="hljs-type"><span class="hljs-type">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intValue: <span class="hljs-type"><span class="hljs-type">Int?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(<span class="hljs-number"><span class="hljs-number">_</span></span> base: <span class="hljs-type"><span class="hljs-type">CodingKey</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(stringValue: base.stringValue, intValue: base.intValue) } <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(stringValue: <span class="hljs-type"><span class="hljs-type">String</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.stringValue = stringValue } <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(intValue: <span class="hljs-type"><span class="hljs-type">Int</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.stringValue = <span class="hljs-string"><span class="hljs-string">"\(intValue)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.intValue = intValue } <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(stringValue: <span class="hljs-type"><span class="hljs-type">String</span></span>, intValue: <span class="hljs-type"><span class="hljs-type">Int?</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.stringValue = stringValue <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.intValue = intValue } }</code> </pre> <br><p>  Ent√£o √© necess√°rio processar separadamente cada caso de nossas chaves.  Os principais: <br>  snake_case, case-snake-case, lowerCamelCase e UpperCamelCase.  Verifique, corra, tudo funciona. </p><br><p>  Ent√£o, encontramos um problema bastante esperado: abrevia√ß√µes em camelCase'ah (lembre-se das numerosas <code>id</code> , <code>Id</code> , <code>ID</code> ).  Para faz√™-lo funcionar, voc√™ precisa convert√™-los corretamente e introduzir uma regra - as <em>abrevia√ß√µes s√£o convertidas em camelCase, mantendo apenas a primeira letra mai√∫scula e o myABBRKey se transformar√° em myAbbrKey</em> . </p><br><p>  Esta solu√ß√£o funciona muito bem para combina√ß√µes de v√°rios casos. </p><br><p>  <strong>Nota: A</strong> implementa√ß√£o ser√° fornecida em. Estrat√©gia de decodifica√ß√£o de chave <code>.custom</code> . </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertToProperLowerCamelCase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(keys: [CodingKey])</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CodingKey</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> last = keys.last <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">assertionFailure</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">AnyCodingKey</span></span>(stringValue: <span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fromUpper = convertFromUpperCamelCase(initial: last.stringValue) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">AnyCodingKey</span></span>(stringValue: fromUpper) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fromSnake = convertFromSnakeCase(initial: last.stringValue) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">AnyCodingKey</span></span>(stringValue: fromSnake) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">AnyCodingKey</span></span>(last) } }</code> </pre> <br><h3 id="date-decoding">  Decodifica√ß√£o de data </h3><br><p>  O pr√≥ximo problema de rotina √© a maneira como as datas s√£o passadas.  Existem muitos microsservi√ßos no servidor, h√° um pouco menos de equipes, mas tamb√©m uma quantidade decente e, no final, somos confrontados com v√°rios formatos de data como "Sim, eu uso o padr√£o".  Al√©m disso, algu√©m passa datas em uma sequ√™ncia, algu√©m no per√≠odo da √©poca.  Como resultado, novamente temos uma mistura de combina√ß√µes de string-n√∫mero-fuso hor√°rio-milissegundo-separador, e o <code>DateDecoder</code> no iOS reclama e exige um formato de data estrito.  A solu√ß√£o aqui √© simples: basta procurarmos sinais de um formato espec√≠fico e combin√°-los, obtendo o resultado necess√°rio.  Esses formatos cobriram com √™xito e completamente meus casos. </p><br><p>  <strong>Nota:</strong> Esse √© o inicializador personalizado do DateFormatter.  √â s√≥ definir o formato para o formatador criado. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> onlyDate = <span class="hljs-type"><span class="hljs-type">DateFormatter</span></span>(format: <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> full = <span class="hljs-type"><span class="hljs-type">DateFormatter</span></span>(format: <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ss.SSSx"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> noWMS = <span class="hljs-type"><span class="hljs-type">DateFormatter</span></span>(format: <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ssZ"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> noWTZ = <span class="hljs-type"><span class="hljs-type">DateFormatter</span></span>(format: <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ss.SSS"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> noWMSnoWTZ = <span class="hljs-type"><span class="hljs-type">DateFormatter</span></span>(format: <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ss"</span></span>)</code> </pre> <br><p>  <code>JSONDecoder.DateDecodingStrategy</code> isso ao nosso decodificador usando <code>JSONDecoder.DateDecodingStrategy</code> e obtemos um decodificador que processa quase tudo e o converte em um formato que pode ser digerido por n√≥s. </p><br><h3 id="testy-proizvoditelnosti">  Testes de desempenho </h3><br><p>  Os testes foram realizados para seq√º√™ncias json de tamanho 7944 bytes. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  estrat√©gia convertFromSnakeCase </th><th>  estrat√©gia anyCodingKey </th></tr></thead><tbody><tr><td>  Absoluto </td><td>  0,00170 </td><td>  0,00210 </td></tr><tr><td>  Parente </td><td>  81% </td><td>  100% </td></tr></tbody></table></div><br><p>  Como podemos ver, o <code>Decoder</code> personalizado <code>Decoder</code> 20% mais lento devido √† verifica√ß√£o obrigat√≥ria de cada chave no json para a necessidade de transforma√ß√£o.  No entanto, essa √© uma pequena taxa por n√£o ter que registrar explicitamente chaves para estruturas de dados implementando <code>Codable</code> .  O n√∫mero de placas da caldeira √© bastante reduzido no projeto com a adi√ß√£o deste decodificador.  Devo us√°-lo para economizar tempo do desenvolvedor, mas piorar o desempenho?  Depende de voc√™. </p><br><p>  C√≥digo de amostra completo na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca do github</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo em ingl√™s</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt449870/">https://habr.com/ru/post/pt449870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt449860/index.html">Bilheteria na nuvem, minha humilde experi√™ncia</a></li>
<li><a href="../pt449862/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 296 (de 22 a 26 de abril)</a></li>
<li><a href="../pt449864/index.html">ResNet50. Implementa√ß√£o pr√≥pria</a></li>
<li><a href="../pt449866/index.html">Ataques potenciais ao HTTPS e como se defender contra eles</a></li>
<li><a href="../pt449868/index.html">Mecanismo de controle de vers√£o do banco de dados GIT (gerenciamento de despejo do MySQL)</a></li>
<li><a href="../pt449872/index.html">No√ß√µes b√°sicas do RxVMS: RxCommand e GetIt</a></li>
<li><a href="../pt449876/index.html">Inova√ß√£o SSI-2001: a hist√≥ria de uma das placas de som mais raras para o PC IBM (e sua r√©plica)</a></li>
<li><a href="../pt449878/index.html">Pesquisa de patentes em TI. O curso do jovem lutador. Parte I. Como entender os requisitos do cliente e preparar um modelo de relat√≥rio</a></li>
<li><a href="../pt449880/index.html">Agile Lite: Especialmente Contra o Burnout</a></li>
<li><a href="../pt449884/index.html">Emula√ß√£o do microprocessador 8008 no ESP8266</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>