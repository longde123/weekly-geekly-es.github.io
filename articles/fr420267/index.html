<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎄 🔑 👩🏾‍🎨 Les auteurs du jeu 0 AD - bravo 👩🏻‍💼 🧘🏿 👩🏿‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0 AD est un jeu en trois dimensions dans le genre de la stratégie historique en temps réel, développé par la communauté des bénévoles. La taille de la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les auteurs du jeu 0 AD - bravo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/420267/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/b41/bfb/6c5b41bfb68b23ef10d61f6ecd1a6665.png" alt="PVS-Studio et 0 A.D."></div><br>  0 AD est un jeu en trois dimensions dans le genre de la stratégie historique en temps réel, développé par la communauté des bénévoles.  La taille de la base de code est petite et j'ai décidé de vérifier le jeu comme une rupture avec les grands projets tels que Android et le noyau XNU.  Donc, nous avons devant nous un projet contenant 165 000 lignes de code en C ++.  Voyons ce qui est intéressant en utilisant l'analyseur statique PVS-Studio. <br><a name="habracut"></a><br><h2>  0 AD </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0 AD</a> (0 A.D.) est un jeu gratuit en trois dimensions dans le genre de la stratégie historique en temps réel, développé par une communauté de bénévoles (les principaux développeurs sont réunis dans l'équipe de Wildfire Games).  Le jeu vous permet de contrôler les civilisations qui existaient dans la période 500 avant JC.  e.- 1 an avant JC.  e.  Depuis l'été 2018, le projet est en version alpha.  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Description</a> tirée de Wikipedia]. <br><br>  Pourquoi exactement 0 AD? <br><br>  J'ai demandé à un collègue d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Egor Bredikhin</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">EgorBredikhin</a> ) de choisir et de vérifier pour moi un petit projet ouvert avec lequel je pourrais travailler entre d'autres tâches.  Il m'a envoyé un journal pour le projet AD 0. À la question: "Pourquoi ce projet?"  - il y avait une réponse: "Oui, je viens de jouer à ce jeu, une bonne stratégie en temps réel."  Ok, alors ce sera 0 AD :). <br><br><h2>  Densité d'erreur </h2><br>  Je tiens à féliciter les auteurs de 0 AD pour la bonne qualité du code C ++.  Bravo, vous parvenez rarement à rencontrer une si faible densité d'erreurs.  Bien sûr, ce ne sont pas toutes des erreurs, mais celles qui peuvent être détectées à l'aide de PVS-Studio.  Comme je l'ai dit, bien que PVS-Studio ne trouve pas toutes les erreurs, nous pouvons néanmoins parler en toute sécurité de la relation entre la densité des erreurs et la qualité du code dans son ensemble. <br><br>  Quelques chiffres.  Le nombre total de lignes de code non vides est de 231270. De ce nombre, 28,7% sont des commentaires.  Au total, 165 000 lignes de code C ++ pur. <br><br>  Le nombre de messages émis par l'analyseur était petit, et après les avoir tous regardés, j'ai écrit 19 erreurs.  Je considérerai toutes ces erreurs plus loin dans l'article.  Peut-être que j'ai raté quelque chose, considérant l'erreur comme un code bâclé inoffensif.  Cependant, en général, cela ne change pas l'image. <br><br>  J'ai donc trouvé 19 erreurs sur 165 000 lignes de code.  Nous calculons la densité d'erreur: 19 * 1000/165000 = 0,115. <br><br>  Pour plus de simplicité, nous arrondissons et supposons que l'analyseur PVS-Studio détecte 0,1 erreur pour 1000 lignes de code dans le code du jeu. <br><br>  Excellent résultat!  À titre de comparaison, dans mon récent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article sur Android,</a> j'ai calculé que j'avais détecté au moins 0,25 erreur pour 1000 lignes de code.  En fait, la densité d'erreurs y est encore plus grande, je n'ai tout simplement pas trouvé la force d'analyser attentivement l'ensemble du rapport. <br><br>  Ou prenez l'exemple des bibliothèques EFL Core, que j'ai soigneusement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">étudiées</a> et calculé le nombre de défauts.  Dans ce document, PVS-Studio détecte 0,71 erreur pour 1 000 lignes de code. <br><br>  Ainsi, les auteurs de 0 AD sont bien faits, cependant, par souci d'équité, il convient de noter qu'ils sont aidés par la petite quantité de code écrit en C ++.  Malheureusement, plus le projet est grand, plus sa complexité augmente rapidement et la densité d'erreur augmente de façon non linéaire ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus</a> ). <br><br><h2>  Erreurs </h2><br>  Voyons maintenant les 19 erreurs que j'ai trouvées dans le jeu.  Pour analyser le projet, j'ai utilisé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio</a> version 6.24.  Je vous suggère d'essayer de télécharger la version de démonstration et de vérifier les projets sur lesquels vous travaillez. <br><br>  <b>Remarque</b>  Nous positionnons PVS-Studio comme une solution B2B.  Pour les petits projets et les développeurs individuels, nous avons une option de licence gratuite: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment utiliser PVS-Studio gratuitement</a> ." <br><br>  <b>Erreur N1</b> <br><br>  Commençons par regarder une erreur complexe.  En fait, ce n'est pas compliqué, mais vous devrez vous familiariser avec un morceau de code assez volumineux. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> WaterManager::CreateWaveMeshes() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = <span class="hljs-number"><span class="hljs-number">0</span></span>; p &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; ++p) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CoastalPointsSet.count(xx+around[p][<span class="hljs-number"><span class="hljs-number">0</span></span>] + (yy + around[p][<span class="hljs-number"><span class="hljs-number">1</span></span>])*SideSize)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbNeighb &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { CoastalPointsSet.erase(xx + yy*SideSize); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } ++nbNeighb; <span class="hljs-comment"><span class="hljs-comment">// We've found a new point around us. // Move there xx = xx + around[p][0]; yy = yy + around[p][1]; indexx = xx + yy*SideSize; if (i == 0) Chain.push_back(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); else Chain.push_front(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); CoastalPointsSet.erase(xx + yy*SideSize); found = true; break; } } if (!found) endedChain = true; .... }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avertissement</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V547</a> CWE-570 L'expression 'nbNeighb&gt; = 2' est toujours fausse.  WaterManager.cpp 581 <br><br>  À première vue, le message de l'analyseur semble étrange.  Pourquoi la condition <i>nbNeighb&gt; = 2 est-elle</i> toujours fausse?  En effet, dans le corps de la boucle il y a un incrément de la variable <i>nbNeighb</i> ! <br><br>  Regardez ci-dessous et vous verrez une instruction <i>break</i> qui interrompt l'exécution de la boucle.  Par conséquent, si la variable <i>nbNeighb</i> est augmentée, le cycle sera arrêté.  Ainsi, la valeur de la variable <i>nbNeighb</i> n'atteindra jamais une valeur supérieure à 1. <br><br>  Le code contient clairement une sorte d'erreur logique. <br><br>  <b>Erreur N2</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CmpRallyPointRenderer::MergeVisibilitySegments( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;SVisibilitySegment&gt;&amp; segments) { .... segments.erase(segments.end()); .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V783</a> CWE-119 Le déréférencement de l'itérateur non valide 'segments.end ()' peut avoir lieu.  CCmpRallyPointRenderer.cpp 1290 <br><br>  Code très, très étrange.  Peut-être que le programmeur voulait supprimer le dernier élément du conteneur.  Dans ce cas, le code devrait être comme ceci: <br><br><pre> <code class="cpp hljs">segments.erase(segments.end() - <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Bien, alors il serait plus facile d'écrire: <br><br><pre> <code class="cpp hljs">segments.pop_back();</code> </pre> <br>  Pour être honnête, je ne sais pas exactement ce qui aurait dû être écrit ici. <br><br>  <b>Erreur N3, N4</b> <br><br>  J'ai décidé de considérer deux erreurs ensemble, car elles sont liées à une fuite de ressources et nécessitent d'abord de montrer ce qu'est la macro <i>WARN_RETURN</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WARN_RETURN(status)\ do\ {\ DEBUG_WARN_ERR(status);\ return status;\ }\ while(0)</span></span></code> </pre> <br>  Ainsi, comme vous pouvez le voir, la macro <i>WARN_RETURN</i> provoque la sortie de la fonction du corps.  Examinons maintenant les façons inexactes d'utiliser cette macro. <br><br>  Le premier fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_generate_random_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(u8* buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/urandom"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f) WARN_RETURN(ERR::FAIL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> numread = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, count, f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numread == <span class="hljs-number"><span class="hljs-number">0</span></span>) WARN_RETURN(ERR::FAIL); buf += numread; count -= numread; } fclose(f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> CWE-401 La fonction a été fermée sans relâcher la poignée 'f'.  Une fuite de ressource est possible.  unix.cpp 332 <br><br>  Si la fonction <i>fread</i> ne peut pas lire les données, la fonction <i>sys_generate_random_bytes se</i> fermera sans libérer le descripteur de fichier.  En pratique, cela n'est guère possible.  Il est peu probable que vous ne puissiez pas lire les données de "/ dev / urandom".  Cependant, le code est bâclé. <br><br>  Le deuxième fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_cursor_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sys_cursor_impl* impl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> sys_cursor_impl; impl-&gt;image = image; impl-&gt;cursor = XcursorImageLoadCursor(wminfo.info.x11.display, image); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(impl-&gt;cursor == None) WARN_RETURN(ERR::FAIL); *cursor = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;sys_cursor&gt;(impl); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Avertissement PVS-Studio: V773 CWE-401 La fonction a été quittée sans relâcher le pointeur 'impl'.  Une fuite de mémoire est possible.  x.cpp 421 <br><br>  Si le curseur ne parvient pas à charger, une fuite de mémoire se produit. <br><br>  <b>Erreur N5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadHeightmapImageOs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]); .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V554</a> CWE-762 Utilisation incorrecte de shared_ptr.  La mémoire allouée avec «nouveau []» sera nettoyée à l'aide de «supprimer».  MapIO.cpp 54 <br><br>  L'option correcte: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8[]&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]);</code> </pre> <br>  <b>Erreur N6</b> <br><br><pre> <code class="cpp hljs">FUTrackedPtr(ObjectClass* _ptr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) : ptr(_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) FUTracker::TrackObject((FUTrackable*) ptr); ptr = ptr; }</code> </pre> <br>  PVS-Studio Warning: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V570</a> La variable 'ptr' est assignée à elle-même.  FUTracker.h 122 <br><br>  <b>Erreur N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring TraceEntry::EncodeAsText() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> action = (<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>)m_action; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> buf[<span class="hljs-number"><span class="hljs-number">1000</span></span>]; swprintf_s(buf, ARRAY_SIZE(buf), <span class="hljs-string"><span class="hljs-string">L"%#010f: %c \"%ls\" %lu\n"</span></span>, m_timestamp, action, m_pathname.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>().c_str(), (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m_size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf; }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V576</a> CWE-628 Format incorrect.  Pensez à vérifier le cinquième argument réel de la fonction 'swprintf_s'.  L'argument de type char est attendu.  trace.cpp 93 <br><br>  Nous rencontrons ici une histoire confuse et indistincte d'une implémentation alternative de la fonction <i>swprintf</i> dans Visual C ++.  Je ne vais pas le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">redire</a> , mais reportez-vous à la documentation des diagnostics du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V576</a> (voir la section "Lignes larges"). <br><br>  Dans ce cas, très probablement, ce code fonctionnera correctement lors de la compilation dans Visual C ++ pour Windows et incorrectement lors de la génération pour Linux ou macOS. <br><br>  Erreur similaire: V576 CWE-628 Format incorrect.  Pensez à vérifier le quatrième argument réel de la fonction 'swprintf_s'.  L'argument de type char est attendu.  vfs_tree.cpp 211 <br><br>  <b>Erreur N9, N10, N11</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Classique</a>  Au début, le pointeur est utilisé, et ensuite seulement vérifié. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEST_CAT2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dst, dst_val); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int ret = strcat_s(dst, max_dst_chars, src); TS_ASSERT_EQUALS(ret, expected_ret); if(dst != 0) // &lt;= TS_ASSERT(!strcmp(dst, expected_dst)); }</span></span></code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V595</a> CWE-476 Le pointeur 'dst' a été utilisé avant d'être vérifié par rapport à nullptr.  Vérifiez les lignes: 140, 143. test_secure_crt.h 140 <br><br>  Je pense que l'erreur ne nécessite pas d'explication.  Avertissements similaires: <br><br><ul><li>  V595 CWE-476 Le pointeur 'dst' a été utilisé avant d'être vérifié par rapport à nullptr.  Lignes de contrôle: 150, 153. test_secure_crt.h 150 </li><li>  V595 CWE-476 Le pointeur 'dst' a été utilisé avant d'être vérifié par rapport à nullptr.  Vérifiez les lignes: 314, 317. test_secure_crt.h 314 </li></ul><br>  <b>Erreur N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tbool; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MikkTSpace::setTSpace(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tbool bIsOrientationPreserving, ....) { .... m_NewVertices.push_back(bIsOrientationPreserving &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-number"><span class="hljs-number">1.0f</span></span> : (<span class="hljs-number"><span class="hljs-number">-1.0f</span></span>)); .... }</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V674</a> CWE-682 Le littéral "0,5" du type "double" est comparé à une valeur du type "int".  Pensez à inspecter l'expression «bIsOrientationPreserving&gt; 0,5».  MikktspaceWrap.cpp 137 <br><br>  Cela n'a aucun sens de comparer une variable de type <i>int</i> avec une constante de 0,5.  De plus, en termes de signification, il s'agit généralement d'une variable de type booléen, ce qui signifie que la comparer à 0,5 semble très étrange.  Supposons qu'au lieu de <i>bIsOrientationPreserving,</i> une autre variable doit être utilisée ici. <br><br>  <b>Erreur N13</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VfsPath&amp; pathname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;u8&gt;&amp; fileContents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ ScopedLock s; VfsDirectory* directory; VfsFile* file; Status st; st = vfs_Lookup(pathname, &amp;m_rootDirectory, directory, &amp;file, VFS_LOOKUP_ADD|VFS_LOOKUP_CREATE); <span class="hljs-comment"><span class="hljs-comment">// There is no such file, create it. if (st == ERR::VFS_FILE_NOT_FOUND) { s.~ScopedLock(); return CreateFile(pathname, fileContents, size); } .... }</span></span></code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V749</a> CWE-675 Le destructeur de l'objet 's' sera invoqué une deuxième fois après avoir quitté la portée de l'objet.  vfs.cpp 165 <br><br>  Avant de créer un fichier, il est nécessaire qu'un objet de type <i>ScopedLock</i> «déverrouille» un objet.  Pour cela, un destructeur est explicitement appelé.  Le problème est que le destructeur de l'objet <i>s</i> sera de nouveau appelé automatiquement à la fin de la fonction.  C'est-à-dire  le destructeur sera appelé deux fois.  Je n'ai pas étudié le périphérique de la classe <i>ScopedLock</i> , mais en tout cas, vous ne devriez pas le faire.  Souvent, un tel double appel au destructeur conduit à un comportement indéfini ou à d'autres erreurs désagréables.  Même si le code fonctionne bien maintenant, il est très facile de tout casser en modifiant l'implémentation de la classe <i>ScopedLock</i> . <br><br>  <b>Erreur N14, N15, N16, N17</b> <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { .... pEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CFsmEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V668</a> CWE-570 Il est inutile de tester le pointeur 'pEvent' par rapport à null, car la mémoire a été allouée à l'aide de l'opérateur 'new'.  L'exception sera générée en cas d'erreur d'allocation de mémoire.  fsm.cpp 259 <br><br>  Vérifier le pointeur n'a pas de sens, car en cas d'erreur d'allocation de mémoire, une exception <i>std :: bad_alloc</i> sera <i>levée</i> . <br><br>  Ainsi, le contrôle est superflu, mais l'erreur n'est pas grave.  Cependant, tout est bien pire quand une logique est exécutée dans le corps de l' <i>instruction if</i> .  Considérez le cas suivant: <br><br><pre> <code class="cpp hljs">CFsmTransition* CFsm::AddTransition(....) { .... CFsmEvent* pEvent = AddEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create new transition CFsmTransition* pNewTransition = new CFsmTransition( state ); if ( !pNewTransition ) { delete pEvent; return NULL; } .... }</span></span></code> </pre> <br>  Avertissement de l'analyseur: V668 CWE-570 Il est inutile de tester le pointeur 'pNewTransition' par rapport à null, car la mémoire a été allouée à l'aide de l'opérateur 'new'.  L'exception sera générée en cas d'erreur d'allocation de mémoire.  fsm.cpp 289 <br><br>  Une tentative est faite pour libérer de la mémoire dont l'adresse est stockée dans le pointeur <i>pEvent</i> .  Naturellement, cela ne se produira pas et une fuite de mémoire se produira. <br><br>  En fait, quand j'ai commencé à m'occuper de ce code, il s'est avéré que tout était plus compliqué et peut-être qu'il n'y avait pas une erreur, mais deux.  Je vais maintenant expliquer ce qui ne va pas avec ce code.  Pour ce faire, nous devons nous familiariser avec le <i>périphérique de</i> fonction <i>AddEvent</i> . <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { CFsmEvent* pEvent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup event by type EventMap::iterator it = m_Events.find( eventType ); if ( it != m_Events.end() ) { pEvent = it-&gt;second; } else { pEvent = new CFsmEvent( eventType ); if ( !pEvent ) return NULL; // Store new event into internal map m_Events[ eventType ] = pEvent; } return pEvent; }</span></span></code> </pre> <br>  Notez que la fonction ne renvoie pas toujours un pointeur sur un nouvel objet créé à l'aide du <i>nouvel</i> opérateur.  Parfois, il prend un objet existant du conteneur <i>m_Events</i> .  Et le pointeur vers l'objet nouvellement créé, soit dit en passant, sera également placé dans <i>m_Events</i> . <br><br>  Et ici, la question se pose: à qui appartient et qui doit détruire les objets dont les pointeurs sont stockés dans le conteneur <i>m_Events</i> ?  Je ne connais pas le projet, mais il y a très probablement quelque part un code qui détruit tous ces objets.  <i>Supprimer</i> ensuite un objet à l'intérieur de la fonction <i>CFsm :: AddTransition est</i> généralement superflu. <br><br>  J'ai l'impression que vous pouvez simplement supprimer le fragment de code suivant: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pNewTransition ) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pEvent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Autres erreurs: <br><br><ul><li>  V668 CWE-571 Il est inutile de tester le pointeur «ret» par rapport à null, car la mémoire a été allouée à l'aide de l'opérateur «new».  L'exception sera générée en cas d'erreur d'allocation de mémoire.  TerrainTextureEntry.cpp 120 </li><li>  V668 CWE-571 Il est inutile de tester le pointeur «réponse» par rapport à null, car la mémoire a été allouée à l'aide de l'opérateur «nouveau».  L'exception sera générée en cas d'erreur d'allocation de mémoire.  SoundManager.cpp 542 </li></ul><br>  <b>Erreur N18, N19</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dir_scan_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct de *de, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dsd</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || dsd-&gt;num_entries &gt;= dsd-&gt;arr_size) { dsd-&gt;arr_size *= <span class="hljs-number"><span class="hljs-number">2</span></span>; dsd-&gt;entries = (struct de *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dsd-&gt;entries, dsd-&gt;arr_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dsd-&gt;entries[<span class="hljs-number"><span class="hljs-number">0</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// TODO(lsm): propagate an error to the caller dsd-&gt;num_entries = 0; } else { dsd-&gt;entries[dsd-&gt;num_entries].file_name = mg_strdup(de-&gt;file_name); dsd-&gt;entries[dsd-&gt;num_entries].st = de-&gt;st; dsd-&gt;entries[dsd-&gt;num_entries].conn = de-&gt;conn; dsd-&gt;num_entries++; } }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avertissement</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V701</a> CWE-401 realloc () fuite possible: lorsque realloc () échoue dans l'allocation de mémoire, le pointeur d'origine 'dsd-&gt; entrées' est perdu.  Pensez à affecter realloc () à un pointeur temporaire.  mongoose.cpp 2462 <br><br>  Si la taille du tableau devient insuffisante, la mémoire est allouée à l'aide de la fonction <i>realloc</i> .  L'erreur est que la valeur du pointeur sur le bloc de mémoire d'origine est immédiatement remplacée par la nouvelle valeur renvoyée par la fonction <i>realloc</i> . <br><br>  Si l'allocation de mémoire échoue, la fonction <i>realloc</i> retournera NULL, et ce NULL sera écrit dans la variable d' <i>entrées dsd-&gt;</i> .  Après quoi, il sera impossible de libérer le bloc de mémoire dont l'adresse a été précédemment stockée dans les <i>entrées dsd-&gt;</i> .  Une fuite de mémoire se produira. <br><br>  Autre erreur: V701 CWE-401 realloc () fuite possible: lorsque realloc () échoue dans l'allocation de mémoire, le pointeur d'origine 'Buffer' est perdu.  Pensez à affecter realloc () à un pointeur temporaire.  Preprocessor.cpp 84 <br><br><h2>  Conclusion </h2><br>  Je ne peux pas dire que cette fois l’article s’est avéré fascinant, ou que j’ai réussi à montrer beaucoup d’erreurs terribles.  Que faire, une fois à la fois n'est pas nécessaire.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ce que je vois, j'écris</a> . <br><br>  Merci de votre attention.  Pour changer, je terminerai l'article par une invitation à me suivre sur Instagram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@pvs_studio_unicorn</a> et sur Twitter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Code_Analysis</a> . <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bon travail, auteurs du jeu 0 AD!</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420267/">https://habr.com/ru/post/fr420267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420257/index.html">Installez-vous toujours Windows 2008? Moi aussi, et c'est pourquoi</a></li>
<li><a href="../fr420259/index.html">Panneau de diagnostic du vieillissement à Singapour</a></li>
<li><a href="../fr420261/index.html">Que mesurerons-nous? Comment choisir les bonnes métriques ML pour les tâches métier</a></li>
<li><a href="../fr420263/index.html">Conférence ServiceNow "Knowledge18"</a></li>
<li><a href="../fr420265/index.html">Sept problèmes de mise en œuvre de Scrum que nous ne connaissions pas</a></li>
<li><a href="../fr420269/index.html">De l'argent dans les égouts: pourquoi votre antiphishing ne détecte-t-il pas les sites de phishing et comment la science des données le fait-elle fonctionner?</a></li>
<li><a href="../fr420271/index.html">Entraînement à l'empathie: stimulation des connexions neuronales cérébrales par le biais d'un jeu vidéo</a></li>
<li><a href="../fr420273/index.html">Comment est organisée une voiture de tourisme longue distance</a></li>
<li><a href="../fr420275/index.html">Grandes conférences sur l'Internet des objets en 2018-2019. La Russie et le monde</a></li>
<li><a href="../fr420277/index.html">Après la ruée vers l'or: perspectives technologiques de la blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>