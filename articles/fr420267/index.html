<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÑ üîë üë©üèæ‚Äçüé® Les auteurs du jeu 0 AD - bravo üë©üèª‚Äçüíº üßòüèø üë©üèø‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0 AD est un jeu en trois dimensions dans le genre de la strat√©gie historique en temps r√©el, d√©velopp√© par la communaut√© des b√©n√©voles. La taille de la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les auteurs du jeu 0 AD - bravo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/420267/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/b41/bfb/6c5b41bfb68b23ef10d61f6ecd1a6665.png" alt="PVS-Studio et 0 A.D."></div><br>  0 AD est un jeu en trois dimensions dans le genre de la strat√©gie historique en temps r√©el, d√©velopp√© par la communaut√© des b√©n√©voles.  La taille de la base de code est petite et j'ai d√©cid√© de v√©rifier le jeu comme une rupture avec les grands projets tels que Android et le noyau XNU.  Donc, nous avons devant nous un projet contenant 165 000 lignes de code en C ++.  Voyons ce qui est int√©ressant en utilisant l'analyseur statique PVS-Studio. <br><a name="habracut"></a><br><h2>  0 AD </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0 AD</a> (0 A.D.) est un jeu gratuit en trois dimensions dans le genre de la strat√©gie historique en temps r√©el, d√©velopp√© par une communaut√© de b√©n√©voles (les principaux d√©veloppeurs sont r√©unis dans l'√©quipe de Wildfire Games).  Le jeu vous permet de contr√¥ler les civilisations qui existaient dans la p√©riode 500 avant JC.  e.- 1 an avant JC.  e.  Depuis l'√©t√© 2018, le projet est en version alpha.  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Description</a> tir√©e de Wikipedia]. <br><br>  Pourquoi exactement 0 AD? <br><br>  J'ai demand√© √† un coll√®gue d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Egor Bredikhin</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">EgorBredikhin</a> ) de choisir et de v√©rifier pour moi un petit projet ouvert avec lequel je pourrais travailler entre d'autres t√¢ches.  Il m'a envoy√© un journal pour le projet AD 0. √Ä la question: "Pourquoi ce projet?"  - il y avait une r√©ponse: "Oui, je viens de jouer √† ce jeu, une bonne strat√©gie en temps r√©el."  Ok, alors ce sera 0 AD :). <br><br><h2>  Densit√© d'erreur </h2><br>  Je tiens √† f√©liciter les auteurs de 0 AD pour la bonne qualit√© du code C ++.  Bravo, vous parvenez rarement √† rencontrer une si faible densit√© d'erreurs.  Bien s√ªr, ce ne sont pas toutes des erreurs, mais celles qui peuvent √™tre d√©tect√©es √† l'aide de PVS-Studio.  Comme je l'ai dit, bien que PVS-Studio ne trouve pas toutes les erreurs, nous pouvons n√©anmoins parler en toute s√©curit√© de la relation entre la densit√© des erreurs et la qualit√© du code dans son ensemble. <br><br>  Quelques chiffres.  Le nombre total de lignes de code non vides est de 231270. De ce nombre, 28,7% sont des commentaires.  Au total, 165 000 lignes de code C ++ pur. <br><br>  Le nombre de messages √©mis par l'analyseur √©tait petit, et apr√®s les avoir tous regard√©s, j'ai √©crit 19 erreurs.  Je consid√©rerai toutes ces erreurs plus loin dans l'article.  Peut-√™tre que j'ai rat√© quelque chose, consid√©rant l'erreur comme un code b√¢cl√© inoffensif.  Cependant, en g√©n√©ral, cela ne change pas l'image. <br><br>  J'ai donc trouv√© 19 erreurs sur 165 000 lignes de code.  Nous calculons la densit√© d'erreur: 19 * 1000/165000 = 0,115. <br><br>  Pour plus de simplicit√©, nous arrondissons et supposons que l'analyseur PVS-Studio d√©tecte 0,1 erreur pour 1000 lignes de code dans le code du jeu. <br><br>  Excellent r√©sultat!  √Ä titre de comparaison, dans mon r√©cent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article sur Android,</a> j'ai calcul√© que j'avais d√©tect√© au moins 0,25 erreur pour 1000 lignes de code.  En fait, la densit√© d'erreurs y est encore plus grande, je n'ai tout simplement pas trouv√© la force d'analyser attentivement l'ensemble du rapport. <br><br>  Ou prenez l'exemple des biblioth√®ques EFL Core, que j'ai soigneusement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tudi√©es</a> et calcul√© le nombre de d√©fauts.  Dans ce document, PVS-Studio d√©tecte 0,71 erreur pour 1 000 lignes de code. <br><br>  Ainsi, les auteurs de 0 AD sont bien faits, cependant, par souci d'√©quit√©, il convient de noter qu'ils sont aid√©s par la petite quantit√© de code √©crit en C ++.  Malheureusement, plus le projet est grand, plus sa complexit√© augmente rapidement et la densit√© d'erreur augmente de fa√ßon non lin√©aire ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus</a> ). <br><br><h2>  Erreurs </h2><br>  Voyons maintenant les 19 erreurs que j'ai trouv√©es dans le jeu.  Pour analyser le projet, j'ai utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio</a> version 6.24.  Je vous sugg√®re d'essayer de t√©l√©charger la version de d√©monstration et de v√©rifier les projets sur lesquels vous travaillez. <br><br>  <b>Remarque</b>  Nous positionnons PVS-Studio comme une solution B2B.  Pour les petits projets et les d√©veloppeurs individuels, nous avons une option de licence gratuite: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment utiliser PVS-Studio gratuitement</a> ." <br><br>  <b>Erreur N1</b> <br><br>  Commen√ßons par regarder une erreur complexe.  En fait, ce n'est pas compliqu√©, mais vous devrez vous familiariser avec un morceau de code assez volumineux. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> WaterManager::CreateWaveMeshes() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = <span class="hljs-number"><span class="hljs-number">0</span></span>; p &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; ++p) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CoastalPointsSet.count(xx+around[p][<span class="hljs-number"><span class="hljs-number">0</span></span>] + (yy + around[p][<span class="hljs-number"><span class="hljs-number">1</span></span>])*SideSize)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbNeighb &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { CoastalPointsSet.erase(xx + yy*SideSize); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } ++nbNeighb; <span class="hljs-comment"><span class="hljs-comment">// We've found a new point around us. // Move there xx = xx + around[p][0]; yy = yy + around[p][1]; indexx = xx + yy*SideSize; if (i == 0) Chain.push_back(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); else Chain.push_front(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); CoastalPointsSet.erase(xx + yy*SideSize); found = true; break; } } if (!found) endedChain = true; .... }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avertissement</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V547</a> CWE-570 L'expression 'nbNeighb&gt; = 2' est toujours fausse.  WaterManager.cpp 581 <br><br>  √Ä premi√®re vue, le message de l'analyseur semble √©trange.  Pourquoi la condition <i>nbNeighb&gt; = 2 est-elle</i> toujours fausse?  En effet, dans le corps de la boucle il y a un incr√©ment de la variable <i>nbNeighb</i> ! <br><br>  Regardez ci-dessous et vous verrez une instruction <i>break</i> qui interrompt l'ex√©cution de la boucle.  Par cons√©quent, si la variable <i>nbNeighb</i> est augment√©e, le cycle sera arr√™t√©.  Ainsi, la valeur de la variable <i>nbNeighb</i> n'atteindra jamais une valeur sup√©rieure √† 1. <br><br>  Le code contient clairement une sorte d'erreur logique. <br><br>  <b>Erreur N2</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CmpRallyPointRenderer::MergeVisibilitySegments( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;SVisibilitySegment&gt;&amp; segments) { .... segments.erase(segments.end()); .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V783</a> CWE-119 Le d√©r√©f√©rencement de l'it√©rateur non valide 'segments.end ()' peut avoir lieu.  CCmpRallyPointRenderer.cpp 1290 <br><br>  Code tr√®s, tr√®s √©trange.  Peut-√™tre que le programmeur voulait supprimer le dernier √©l√©ment du conteneur.  Dans ce cas, le code devrait √™tre comme ceci: <br><br><pre> <code class="cpp hljs">segments.erase(segments.end() - <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Bien, alors il serait plus facile d'√©crire: <br><br><pre> <code class="cpp hljs">segments.pop_back();</code> </pre> <br>  Pour √™tre honn√™te, je ne sais pas exactement ce qui aurait d√ª √™tre √©crit ici. <br><br>  <b>Erreur N3, N4</b> <br><br>  J'ai d√©cid√© de consid√©rer deux erreurs ensemble, car elles sont li√©es √† une fuite de ressources et n√©cessitent d'abord de montrer ce qu'est la macro <i>WARN_RETURN</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WARN_RETURN(status)\ do\ {\ DEBUG_WARN_ERR(status);\ return status;\ }\ while(0)</span></span></code> </pre> <br>  Ainsi, comme vous pouvez le voir, la macro <i>WARN_RETURN</i> provoque la sortie de la fonction du corps.  Examinons maintenant les fa√ßons inexactes d'utiliser cette macro. <br><br>  Le premier fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_generate_random_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(u8* buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/urandom"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f) WARN_RETURN(ERR::FAIL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> numread = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, count, f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numread == <span class="hljs-number"><span class="hljs-number">0</span></span>) WARN_RETURN(ERR::FAIL); buf += numread; count -= numread; } fclose(f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> CWE-401 La fonction a √©t√© ferm√©e sans rel√¢cher la poign√©e 'f'.  Une fuite de ressource est possible.  unix.cpp 332 <br><br>  Si la fonction <i>fread</i> ne peut pas lire les donn√©es, la fonction <i>sys_generate_random_bytes se</i> fermera sans lib√©rer le descripteur de fichier.  En pratique, cela n'est gu√®re possible.  Il est peu probable que vous ne puissiez pas lire les donn√©es de "/ dev / urandom".  Cependant, le code est b√¢cl√©. <br><br>  Le deuxi√®me fragment. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_cursor_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sys_cursor_impl* impl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> sys_cursor_impl; impl-&gt;image = image; impl-&gt;cursor = XcursorImageLoadCursor(wminfo.info.x11.display, image); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(impl-&gt;cursor == None) WARN_RETURN(ERR::FAIL); *cursor = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;sys_cursor&gt;(impl); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Avertissement PVS-Studio: V773 CWE-401 La fonction a √©t√© quitt√©e sans rel√¢cher le pointeur 'impl'.  Une fuite de m√©moire est possible.  x.cpp 421 <br><br>  Si le curseur ne parvient pas √† charger, une fuite de m√©moire se produit. <br><br>  <b>Erreur N5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadHeightmapImageOs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]); .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V554</a> CWE-762 Utilisation incorrecte de shared_ptr.  La m√©moire allou√©e avec ¬´nouveau []¬ª sera nettoy√©e √† l'aide de ¬´supprimer¬ª.  MapIO.cpp 54 <br><br>  L'option correcte: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8[]&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]);</code> </pre> <br>  <b>Erreur N6</b> <br><br><pre> <code class="cpp hljs">FUTrackedPtr(ObjectClass* _ptr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) : ptr(_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) FUTracker::TrackObject((FUTrackable*) ptr); ptr = ptr; }</code> </pre> <br>  PVS-Studio Warning: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V570</a> La variable 'ptr' est assign√©e √† elle-m√™me.  FUTracker.h 122 <br><br>  <b>Erreur N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring TraceEntry::EncodeAsText() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> action = (<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>)m_action; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> buf[<span class="hljs-number"><span class="hljs-number">1000</span></span>]; swprintf_s(buf, ARRAY_SIZE(buf), <span class="hljs-string"><span class="hljs-string">L"%#010f: %c \"%ls\" %lu\n"</span></span>, m_timestamp, action, m_pathname.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>().c_str(), (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m_size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf; }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V576</a> CWE-628 Format incorrect.  Pensez √† v√©rifier le cinqui√®me argument r√©el de la fonction 'swprintf_s'.  L'argument de type char est attendu.  trace.cpp 93 <br><br>  Nous rencontrons ici une histoire confuse et indistincte d'une impl√©mentation alternative de la fonction <i>swprintf</i> dans Visual C ++.  Je ne vais pas le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">redire</a> , mais reportez-vous √† la documentation des diagnostics du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V576</a> (voir la section "Lignes larges"). <br><br>  Dans ce cas, tr√®s probablement, ce code fonctionnera correctement lors de la compilation dans Visual C ++ pour Windows et incorrectement lors de la g√©n√©ration pour Linux ou macOS. <br><br>  Erreur similaire: V576 CWE-628 Format incorrect.  Pensez √† v√©rifier le quatri√®me argument r√©el de la fonction 'swprintf_s'.  L'argument de type char est attendu.  vfs_tree.cpp 211 <br><br>  <b>Erreur N9, N10, N11</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Classique</a>  Au d√©but, le pointeur est utilis√©, et ensuite seulement v√©rifi√©. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEST_CAT2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dst, dst_val); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int ret = strcat_s(dst, max_dst_chars, src); TS_ASSERT_EQUALS(ret, expected_ret); if(dst != 0) // &lt;= TS_ASSERT(!strcmp(dst, expected_dst)); }</span></span></code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V595</a> CWE-476 Le pointeur 'dst' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 140, 143. test_secure_crt.h 140 <br><br>  Je pense que l'erreur ne n√©cessite pas d'explication.  Avertissements similaires: <br><br><ul><li>  V595 CWE-476 Le pointeur 'dst' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr.  Lignes de contr√¥le: 150, 153. test_secure_crt.h 150 </li><li>  V595 CWE-476 Le pointeur 'dst' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr.  V√©rifiez les lignes: 314, 317. test_secure_crt.h 314 </li></ul><br>  <b>Erreur N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tbool; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MikkTSpace::setTSpace(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tbool bIsOrientationPreserving, ....) { .... m_NewVertices.push_back(bIsOrientationPreserving &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-number"><span class="hljs-number">1.0f</span></span> : (<span class="hljs-number"><span class="hljs-number">-1.0f</span></span>)); .... }</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V674</a> CWE-682 Le litt√©ral "0,5" du type "double" est compar√© √† une valeur du type "int".  Pensez √† inspecter l'expression ¬´bIsOrientationPreserving&gt; 0,5¬ª.  MikktspaceWrap.cpp 137 <br><br>  Cela n'a aucun sens de comparer une variable de type <i>int</i> avec une constante de 0,5.  De plus, en termes de signification, il s'agit g√©n√©ralement d'une variable de type bool√©en, ce qui signifie que la comparer √† 0,5 semble tr√®s √©trange.  Supposons qu'au lieu de <i>bIsOrientationPreserving,</i> une autre variable doit √™tre utilis√©e ici. <br><br>  <b>Erreur N13</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VfsPath&amp; pathname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;u8&gt;&amp; fileContents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ ScopedLock s; VfsDirectory* directory; VfsFile* file; Status st; st = vfs_Lookup(pathname, &amp;m_rootDirectory, directory, &amp;file, VFS_LOOKUP_ADD|VFS_LOOKUP_CREATE); <span class="hljs-comment"><span class="hljs-comment">// There is no such file, create it. if (st == ERR::VFS_FILE_NOT_FOUND) { s.~ScopedLock(); return CreateFile(pathname, fileContents, size); } .... }</span></span></code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V749</a> CWE-675 Le destructeur de l'objet 's' sera invoqu√© une deuxi√®me fois apr√®s avoir quitt√© la port√©e de l'objet.  vfs.cpp 165 <br><br>  Avant de cr√©er un fichier, il est n√©cessaire qu'un objet de type <i>ScopedLock</i> ¬´d√©verrouille¬ª un objet.  Pour cela, un destructeur est explicitement appel√©.  Le probl√®me est que le destructeur de l'objet <i>s</i> sera de nouveau appel√© automatiquement √† la fin de la fonction.  C'est-√†-dire  le destructeur sera appel√© deux fois.  Je n'ai pas √©tudi√© le p√©riph√©rique de la classe <i>ScopedLock</i> , mais en tout cas, vous ne devriez pas le faire.  Souvent, un tel double appel au destructeur conduit √† un comportement ind√©fini ou √† d'autres erreurs d√©sagr√©ables.  M√™me si le code fonctionne bien maintenant, il est tr√®s facile de tout casser en modifiant l'impl√©mentation de la classe <i>ScopedLock</i> . <br><br>  <b>Erreur N14, N15, N16, N17</b> <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { .... pEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CFsmEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  Avertissement PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V668</a> CWE-570 Il est inutile de tester le pointeur 'pEvent' par rapport √† null, car la m√©moire a √©t√© allou√©e √† l'aide de l'op√©rateur 'new'.  L'exception sera g√©n√©r√©e en cas d'erreur d'allocation de m√©moire.  fsm.cpp 259 <br><br>  V√©rifier le pointeur n'a pas de sens, car en cas d'erreur d'allocation de m√©moire, une exception <i>std :: bad_alloc</i> sera <i>lev√©e</i> . <br><br>  Ainsi, le contr√¥le est superflu, mais l'erreur n'est pas grave.  Cependant, tout est bien pire quand une logique est ex√©cut√©e dans le corps de l' <i>instruction if</i> .  Consid√©rez le cas suivant: <br><br><pre> <code class="cpp hljs">CFsmTransition* CFsm::AddTransition(....) { .... CFsmEvent* pEvent = AddEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create new transition CFsmTransition* pNewTransition = new CFsmTransition( state ); if ( !pNewTransition ) { delete pEvent; return NULL; } .... }</span></span></code> </pre> <br>  Avertissement de l'analyseur: V668 CWE-570 Il est inutile de tester le pointeur 'pNewTransition' par rapport √† null, car la m√©moire a √©t√© allou√©e √† l'aide de l'op√©rateur 'new'.  L'exception sera g√©n√©r√©e en cas d'erreur d'allocation de m√©moire.  fsm.cpp 289 <br><br>  Une tentative est faite pour lib√©rer de la m√©moire dont l'adresse est stock√©e dans le pointeur <i>pEvent</i> .  Naturellement, cela ne se produira pas et une fuite de m√©moire se produira. <br><br>  En fait, quand j'ai commenc√© √† m'occuper de ce code, il s'est av√©r√© que tout √©tait plus compliqu√© et peut-√™tre qu'il n'y avait pas une erreur, mais deux.  Je vais maintenant expliquer ce qui ne va pas avec ce code.  Pour ce faire, nous devons nous familiariser avec le <i>p√©riph√©rique de</i> fonction <i>AddEvent</i> . <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { CFsmEvent* pEvent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup event by type EventMap::iterator it = m_Events.find( eventType ); if ( it != m_Events.end() ) { pEvent = it-&gt;second; } else { pEvent = new CFsmEvent( eventType ); if ( !pEvent ) return NULL; // Store new event into internal map m_Events[ eventType ] = pEvent; } return pEvent; }</span></span></code> </pre> <br>  Notez que la fonction ne renvoie pas toujours un pointeur sur un nouvel objet cr√©√© √† l'aide du <i>nouvel</i> op√©rateur.  Parfois, il prend un objet existant du conteneur <i>m_Events</i> .  Et le pointeur vers l'objet nouvellement cr√©√©, soit dit en passant, sera √©galement plac√© dans <i>m_Events</i> . <br><br>  Et ici, la question se pose: √† qui appartient et qui doit d√©truire les objets dont les pointeurs sont stock√©s dans le conteneur <i>m_Events</i> ?  Je ne connais pas le projet, mais il y a tr√®s probablement quelque part un code qui d√©truit tous ces objets.  <i>Supprimer</i> ensuite un objet √† l'int√©rieur de la fonction <i>CFsm :: AddTransition est</i> g√©n√©ralement superflu. <br><br>  J'ai l'impression que vous pouvez simplement supprimer le fragment de code suivant: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pNewTransition ) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pEvent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Autres erreurs: <br><br><ul><li>  V668 CWE-571 Il est inutile de tester le pointeur ¬´ret¬ª par rapport √† null, car la m√©moire a √©t√© allou√©e √† l'aide de l'op√©rateur ¬´new¬ª.  L'exception sera g√©n√©r√©e en cas d'erreur d'allocation de m√©moire.  TerrainTextureEntry.cpp 120 </li><li>  V668 CWE-571 Il est inutile de tester le pointeur ¬´r√©ponse¬ª par rapport √† null, car la m√©moire a √©t√© allou√©e √† l'aide de l'op√©rateur ¬´nouveau¬ª.  L'exception sera g√©n√©r√©e en cas d'erreur d'allocation de m√©moire.  SoundManager.cpp 542 </li></ul><br>  <b>Erreur N18, N19</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dir_scan_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct de *de, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dsd</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || dsd-&gt;num_entries &gt;= dsd-&gt;arr_size) { dsd-&gt;arr_size *= <span class="hljs-number"><span class="hljs-number">2</span></span>; dsd-&gt;entries = (struct de *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dsd-&gt;entries, dsd-&gt;arr_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dsd-&gt;entries[<span class="hljs-number"><span class="hljs-number">0</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// TODO(lsm): propagate an error to the caller dsd-&gt;num_entries = 0; } else { dsd-&gt;entries[dsd-&gt;num_entries].file_name = mg_strdup(de-&gt;file_name); dsd-&gt;entries[dsd-&gt;num_entries].st = de-&gt;st; dsd-&gt;entries[dsd-&gt;num_entries].conn = de-&gt;conn; dsd-&gt;num_entries++; } }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avertissement</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V701</a> CWE-401 realloc () fuite possible: lorsque realloc () √©choue dans l'allocation de m√©moire, le pointeur d'origine 'dsd-&gt; entr√©es' est perdu.  Pensez √† affecter realloc () √† un pointeur temporaire.  mongoose.cpp 2462 <br><br>  Si la taille du tableau devient insuffisante, la m√©moire est allou√©e √† l'aide de la fonction <i>realloc</i> .  L'erreur est que la valeur du pointeur sur le bloc de m√©moire d'origine est imm√©diatement remplac√©e par la nouvelle valeur renvoy√©e par la fonction <i>realloc</i> . <br><br>  Si l'allocation de m√©moire √©choue, la fonction <i>realloc</i> retournera NULL, et ce NULL sera √©crit dans la variable d' <i>entr√©es dsd-&gt;</i> .  Apr√®s quoi, il sera impossible de lib√©rer le bloc de m√©moire dont l'adresse a √©t√© pr√©c√©demment stock√©e dans les <i>entr√©es dsd-&gt;</i> .  Une fuite de m√©moire se produira. <br><br>  Autre erreur: V701 CWE-401 realloc () fuite possible: lorsque realloc () √©choue dans l'allocation de m√©moire, le pointeur d'origine 'Buffer' est perdu.  Pensez √† affecter realloc () √† un pointeur temporaire.  Preprocessor.cpp 84 <br><br><h2>  Conclusion </h2><br>  Je ne peux pas dire que cette fois l‚Äôarticle s‚Äôest av√©r√© fascinant, ou que j‚Äôai r√©ussi √† montrer beaucoup d‚Äôerreurs terribles.  Que faire, une fois √† la fois n'est pas n√©cessaire.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ce que je vois, j'√©cris</a> . <br><br>  Merci de votre attention.  Pour changer, je terminerai l'article par une invitation √† me suivre sur Instagram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@pvs_studio_unicorn</a> et sur Twitter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@Code_Analysis</a> . <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bon travail, auteurs du jeu 0 AD!</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420267/">https://habr.com/ru/post/fr420267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420257/index.html">Installez-vous toujours Windows 2008? Moi aussi, et c'est pourquoi</a></li>
<li><a href="../fr420259/index.html">Panneau de diagnostic du vieillissement √† Singapour</a></li>
<li><a href="../fr420261/index.html">Que mesurerons-nous? Comment choisir les bonnes m√©triques ML pour les t√¢ches m√©tier</a></li>
<li><a href="../fr420263/index.html">Conf√©rence ServiceNow "Knowledge18"</a></li>
<li><a href="../fr420265/index.html">Sept probl√®mes de mise en ≈ìuvre de Scrum que nous ne connaissions pas</a></li>
<li><a href="../fr420269/index.html">De l'argent dans les √©gouts: pourquoi votre antiphishing ne d√©tecte-t-il pas les sites de phishing et comment la science des donn√©es le fait-elle fonctionner?</a></li>
<li><a href="../fr420271/index.html">Entra√Ænement √† l'empathie: stimulation des connexions neuronales c√©r√©brales par le biais d'un jeu vid√©o</a></li>
<li><a href="../fr420273/index.html">Comment est organis√©e une voiture de tourisme longue distance</a></li>
<li><a href="../fr420275/index.html">Grandes conf√©rences sur l'Internet des objets en 2018-2019. La Russie et le monde</a></li>
<li><a href="../fr420277/index.html">Apr√®s la ru√©e vers l'or: perspectives technologiques de la blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>