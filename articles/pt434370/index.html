<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíπ ‚õ∏Ô∏è üé¨ Outro conquistador de sombras em Phaser, ou o uso de bicicletas üï∫üèΩ üè∏ üå¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dois anos atr√°s, eu j√° estava experimentando subst√¢ncias sombreadas no Phaser 2D. No √∫ltimo Ludum Dare, de repente decidimos fazer um horror, e que ho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Outro conquistador de sombras em Phaser, ou o uso de bicicletas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434370/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dois anos atr√°s,</a> eu j√° estava experimentando <s>subst√¢ncias</s> sombreadas no Phaser 2D.  No √∫ltimo Ludum Dare, de repente decidimos fazer um horror, e que horror sem sombras e luzes!  Eu quebrei meus dedos ... <br><br>  ... e nada a tempo para LD.  No jogo, √© claro, h√° um pouco de luz e sombra, mas essa √© uma apar√™ncia miser√°vel do que realmente deveria ser. <br><br>  Depois de voltar para casa depois de enviar o jogo para o concurso, decidi "fechar a gestalt" e terminar essas sombras infelizes.  O que aconteceu - voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sentir o jogo</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">jogar a demo</a> , olhar a foto e ler o artigo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m3/if/35/m3if351xwaowt3lxcayun-cuzak.png"></div><br><a name="habracut"></a>  Como sempre, nesses casos, n√£o faz sentido tentar escrever uma solu√ß√£o geral, voc√™ precisa se concentrar em uma situa√ß√£o espec√≠fica.  O mundo do jogo pode ser representado na forma de segmentos - pelo menos aquelas entidades que projetam sombras.  Paredes s√£o ret√¢ngulos, pessoas s√£o ret√¢ngulos, apenas giradas, o spoiler infernal √© um c√≠rculo, mas no modelo de corte pode ser simplificado para um comprimento de di√¢metro sempre perpendicular a um raio de luz. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dh/gq/id/dhgqidngehzo_pn9vgr9eirsgna.png"></div><br>  Existem v√°rias fontes de luz (20 a 30) e todas s√£o circulares (refletores) e est√£o localizadas condicionalmente abaixo dos objetos iluminados (para que as sombras possam ser infinitas). <br><br>  Vi na minha cabe√ßa as seguintes maneiras de resolver o problema: <br><br><ol><li>  Para cada fonte de luz, criamos uma textura do tamanho de uma tela (bem, ou 2-4 vezes menor).  Nesta textura, simplesmente desenhamos o trap√©zio BCC'D ', onde A √© a fonte de luz, BC √© o segmento de linha, B'C' √© a proje√ß√£o da linha na borda da textura.  Depois disso, essas texturas s√£o enviadas para o sombreador, onde s√£o misturadas em uma √∫nica imagem. <br><br>  O autor do jogo de plataformas Celeste fez algo parecido com isto, que est√° bem escrito em seu artigo no meio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">medium.com/@NoelFB/remaking-celestes-lighting-3478d6f10bf</a> <br><br>  Problemas: 20 a 30 texturas do tamanho da tela que precisam ser redesenhadas quase todos os quadros e carregadas na GPU.  Lembro que esse foi um processo muito, muito pouco r√°pido. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z2/ve/ya/z2veyaflrtcpobcfkkdecuqpkpa.png"></div><br></li><li>  O m√©todo descrito em uma postagem em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/post/272233</a> .  Para cada fonte de luz, constru√≠mos um "mapa de profundidade", ou seja,  essa textura, onde x = o √¢ngulo do ‚Äúfeixe‚Äù da fonte de luz, y = o n√∫mero da fonte de luz e cor == dist√¢ncia da fonte ao obst√°culo mais pr√≥ximo.  Se dermos um passo de 0,7 graus (360/512) e 32 fontes de luz, obteremos uma textura de 512 x 32, que n√£o foi atualizada por tanto tempo. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aq/ew/_x/aqew_xze8rbkwvhj-68t3d4glz4.png"></div>  <sup>(exemplo de textura para um passo de 45 graus)</sup> <br></li><li>  A maneira secreta que descreverei no final </li></ol><br>  No final, decidi pelo m√©todo 2. No entanto, o descrito no artigo n√£o me serviu at√© o fim.  L√°, a textura tamb√©m foi constru√≠da no shader usando um rakecast - o shader do ciclo passou da fonte de luz na dire√ß√£o do feixe e procurou um obst√°culo.  Nas minhas experi√™ncias anteriores, tamb√©m fiz rakecast no shader, e era muito caro, embora universal. <br><br>  ‚ÄúTemos apenas segmentos no modelo‚Äù, pensei, ‚Äúe 10 a 20 segmentos caem no raio de qualquer fonte de luz.  N√£o posso calcular rapidamente um mapa de dist√¢ncia com base nisso? ‚Äù <br><br>  Ent√£o eu decidi faz√™-lo. <br><br>  Para come√ßar, simplesmente mostrei na tela as paredes, o ‚Äúpersonagem principal‚Äù condicional e as fontes de luz.  Ao redor das fontes de luz, um c√≠rculo de pura luz clara cortou na escurid√£o.  Para obter isso: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yl/jh/y4/yljhy4kuzvmkdqscqjuzsbqfjms.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br><br>  Eu imediatamente comecei a fazer o shader para n√£o relaxar.  Era necess√°rio passar para cada fonte de luz suas coordenadas e raio de a√ß√£o (al√©m do qual a luz n√£o alcan√ßa), isso √© feito simplesmente atrav√©s de uma matriz uniforme.  E ent√£o no sombreador (que √© fragment√°rio, que √© realizado para cada pixel na tela), resta entender se o pixel atual est√° no c√≠rculo iluminado ou n√£o. <br><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleLightShader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phaser</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(game) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(game); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lightsArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(MAX_LIGHTS*<span class="hljs-number"><span class="hljs-number">4</span></span>); lightsArray.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, lightsArray.length); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'1i'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: lightsArray}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragmentSrc = <span class="hljs-string"><span class="hljs-string">` precision highp float; uniform int lightsCount; uniform vec4 lights[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">]; void main() { float lightness = 0.; for (int i = 0; i &lt; </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; lightness += step(length(light.xy - gl_FragCoord.xy), light.z); } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,0.5), vec4(0,0,0,0), lightness); } `</span></span>; } updateLights(lightSources) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount.value = lightSources.length; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights.value; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> light <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> lightSources) { array[i++] = light.x; array[i++] = game.world.height - light.y; array[i++] = light.radius; i++; } } }</code> </pre> <br>  Agora precisamos entender para cada fonte de luz quais segmentos projetar√£o uma sombra.  Em vez disso, quais partes dos segmentos - na figura abaixo, n√£o estamos interessados ‚Äã‚Äãnas partes "vermelhas" do segmento, porque  a luz ainda n√£o os alcan√ßa. <br><br>  <i>Nota: a defini√ß√£o de interse√ß√£o √© um tipo de otimiza√ß√£o preliminar.</i>  <i>√â necess√°rio para reduzir o tempo de processamento adicional, eliminando grandes peda√ßos de segmentos al√©m do raio da fonte de luz.</i>  <i>Isso faz sentido quando temos muitos segmentos cujo comprimento √© muito maior que o raio do "brilho".</i>  <i>Se n√£o for esse o caso, e tivermos muitos segmentos curtos, pode ser certo n√£o perder tempo determinando a interse√ß√£o e processando os segmentos inteiros, porque</i>  <i>economizar tempo ainda n√£o funciona.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/93/mb/cb93mbs6zzyyqwvfx633ppxbtzg.png"></div><br>  Para fazer isso, usei a f√≥rmula conhecida para encontrar a interse√ß√£o de uma linha reta e um c√≠rculo, que todos se lembram de cor de um curso escolar de geometria ... no mundo imagin√°rio de algu√©m.  Eu simplesmente n√£o me lembrava dela, ent√£o tive que pesquisar no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google</a> . <br><br>  Codificamos, olha o que aconteceu. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_0/up/go/_0upgoezkyggo7sfkntejosckg0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br>  Parece ser a norma.  Agora sabemos quais segmentos podem projetar uma sombra e executar o rakecast. <br><br>  Aqui tamb√©m temos op√ß√µes: <br><br><ol><li>  N√≥s apenas fazemos um c√≠rculo, lan√ßamos raios e procuramos cruzamentos.  A dist√¢ncia at√© o cruzamento mais pr√≥ximo √© o valor que precisamos </li><li>  Voc√™ s√≥ pode ir para os cantos que caem em segmentos.  Afinal, j√° sabemos os pontos, n√£o √© dif√≠cil calcular os √¢ngulos. </li><li>  Al√©m disso, se formos ao longo de um segmento, n√£o precisamos lan√ßar raios e calcular interse√ß√µes - podemos nos mover ao longo do segmento com a etapa desejada.  Veja como funciona: </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9w/db/yp/9wdbyph5wjrn9dolovyhf_5y6-w.png"></div><br>  Aqui <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> AB </script>  - segmento (parede), <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.766ex" height="2.057ex" viewBox="0 -780.1 760.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> C </script>  √â o centro da fonte de luz, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> Cd </script>  - perpendicular ao segmento. <br><br>  Vamos <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> x </script>  - o √¢ngulo do normal, para o qual voc√™ precisa descobrir a dist√¢ncia da fonte ao segmento, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.979ex" height="2.298ex" viewBox="0 -780.1 1282.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-31" x="1171" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-5"> X_1 </script>  - ponto no segmento <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-6"> AB </script>  onde o raio cai.  Tri√¢ngulo <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.669ex" height="2.298ex" viewBox="0 -780.1 2871.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-44" x="760" y="0"></use><g transform="translate(1589,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-7"> CDX_1 </script>  - retangular <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> Cd </script>  - uma perna, e o seu comprimento √© conhecido e constante para este segmento, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.298ex" viewBox="0 -780.1 2042.9 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-9"> CX_1 </script>  - comprimento desejado. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>C</mi><mi>D</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.042ex" height="2.66ex" viewBox="0 -832 9921 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-31" x="1171" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-3D" x="2320" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-66" x="3626" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-72" x="4177" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-61" x="4628" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-63" x="5158" y="0"></use><g transform="translate(5591,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-44" x="760" y="0"></use></g><g transform="translate(7180,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-63" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-6F" x="433" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-73" x="919" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-28" x="1388" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-78" x="1778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-29" x="2350" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>C</mi><mi>D</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-10"> CX_1 = \ frac {CD} {cos (x)} </script>  .  Se voc√™ conhece o passo com anteced√™ncia (e n√≥s o conhecemos), pode pr√©-calcular a tabela de cossenos inversos e procurar dist√¢ncias muito rapidamente. <br><br>  Vou dar um exemplo de c√≥digo para essa tabela.  Quase todo o trabalho com cantos √© substitu√≠do pelo trabalho com √≠ndices, ou seja,  n√∫meros inteiros de 0 a N, em que N = o n√∫mero de etapas no c√≠rculo (ou seja, √¢ngulo da etapa = <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>2</mn><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.923ex" height="2.419ex" viewBox="0 -780.1 4703 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMAIN-32" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-70" x="750" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-69" x="1254" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhicdMXV5aoM2ZPyUbYGmrrOCdRcNg#MJMATHI-4E" x="3814" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>2</mn><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>N</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-11"> \ frac {2 \ pi} {N} </script>  ) <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HypTable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(steps = 512, stepAngle = 2*Math.PI/steps) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.perAngleStep = [<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; steps/<span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { <span class="hljs-comment"><span class="hljs-comment">//   pi/2 let ang = i*stepAngle; this.perAngleStep[i] = 1/Math.cos(ang); } this.stepAngle = stepAngle; } /** * @param distancesMap -  ,    * @param angle1 -           * @param angle2 -           * @param normalFromLight - ,      */ fillDistancesForArc(distancesMap, angle1, angle2, normalFromLight) { const D = Math.hypot(normalFromLight.x, normalFromLight.y); const normalAngle = Phaser.Math.normalizeAngle(Math.atan2(normalFromLight.y, normalFromLight.x)); const normalAngleIndex = (normalAngle / this.stepAngle)|0; const index1 = (angle1 / this.stepAngle)|0; const index2 = (angle2 / this.stepAngle)|0; for (let angleIndex = index1; angleIndex &lt;= index2; angleIndex++) { let distanceForAngle = D * this.perAngleStep[normalize(angleIndex - normalAngleIndex)]; distancesMap.set(angleIndex, distanceForAngle); } } }</span></span></code> </pre><br>  Obviamente, esse m√©todo introduz um erro nos casos em que o √¢ngulo inicial ACD n√£o √© um m√∫ltiplo de uma etapa.  Mas, para 512 etapas, visualmente n√£o vejo diferen√ßa. <br><br>  Ent√£o, o que j√° sabemos como fazer: <br><ol><li>  Encontre segmentos dentro do alcance da fonte de luz que possa projetar uma sombra <br></li><li>  Para a etapa t, crie uma tabela de dist√¢ncia (√¢ngulo), passando por cada segmento e calculando as dist√¢ncias. </li></ol><br><br>  Aqui est√° a apar√™ncia dessa tabela se voc√™ a desenhar em raios. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kh/5m/17/kh5m17zbgdyq22dfeoys5borlbe.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br><br>  E aqui est√° como ele procura 10 fontes de luz, se escritas em uma textura. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/ex/3-/bgex3-jcfuohb9_egfv_4ul-x2e.png"></div><br>  Aqui, cada pixel horizontal corresponde a um √¢ngulo e a cor √† dist√¢ncia em pixels. <br>  Est√° escrito em js como este usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imageData</a> <br><pre> <code class="javascript hljs"> fillBitmap(data, index) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> total = index + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.steps*<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> d1, d2; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//data[index] = Red //data[index+1] = Green //data[index+2] = Blue //data[index+3] = Alpha for (; index &lt; total; index+=4, i++) { //  512,    R     2. d1 = (this.distances[i]/2)|0; data[index] = d1; d1 = this.distances[i] - d1*2; d2 = (d1*128)|0; //   G -     2. data[index+1] = d2; //  B  A  255,     . data[index+2] = 255; data[index+3] = 255; } }</span></span></code> </pre><br><br>  Agora passamos a textura para o nosso shader, que j√° possui as coordenadas e os raios das fontes de luz.  E processe-o assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      uniform sampler2D iChannel0; #define STRENGTH 0.3 #define MAX_DARK 0.7 #define M_PI 3.141592653589793 #define M_PI2 6.283185307179586 //       float decodeDist(vec4 color) { return color.r*255.*2. + color.g*2.; } float getShadow(int i, float angle, float distance) { //   x   ==  float u = angle/M_PI2; //   y   ==     float v = float(i)/${MAX_LIGHTS}.; float shadowAfterDistance = decodeDist(texture2D(iChannel0, vec2(u, v))); //  1   ,  0  . return step(shadowAfterDistance, distance); } void main() { float lightness = 0.; for (int i = 0; i &lt; ${MAX_LIGHTS}; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; //       vec2 light2point = gl_FragCoord.xy - light.xy; float radius = light.z; float distance = length(light2point); float inLight = step(distance, radius); //      ,       //  . //      , //    ,          //           //     ,    if (inLight == 0.) continue; float angle = mod(-atan(light2point.y, light2point.x), M_PI2); // 1     0   float thisLightness = (1. - getShadow(i, angle, distance)); //,   ‚Äú‚Äù  ,   ,  //    lightness += thisLightness*STRENGTH; } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,MAX_DARK), vec4(0,0,0,0), lightness); }</span></span></code> </pre> <br><br>  Resultado: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/0l/hj/f90lhj2yepescdli2qndmyx-xkq.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br>  Agora voc√™ pode trazer um pouco de beleza.  Deixe a luz desaparecer com a dist√¢ncia e as sombras ficar√£o tremidas. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1s/op/sg/1sopsggdgrpurmn0qsui8rcfhne.png"></div><br>  Para desfoque, olho para os cantos adjacentes, + - passo, assim: <br><br><pre> <code class="cpp hljs">thisLightness = (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle, distance)) * <span class="hljs-number"><span class="hljs-number">0.4</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span>;</code> </pre><br><br>  Se voc√™ juntar tudo e medir o FPS, ser√° assim: <br><br><ul><li>  Nas placas de v√≠deo embutidas - tudo est√° ruim (&lt;30-40), mesmo para exemplos simples <br></li><li>  Tudo o resto est√° bem, desde que as fontes de luz n√£o sejam muito fortes.  Ou seja, o n√∫mero de fontes de luz por pixel √© importante, n√£o o n√∫mero total. <br></li></ul><br><br>  Este resultado me serviu bastante.  Voc√™ ainda pode brincar com a cor da ilumina√ß√£o, mas eu n√£o.  Depois de torcer um pouco e adicionar alguns mapas normais, enviei uma vers√£o atualizada do NOPE.  Ela parecia assim agora: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/nw/4o/cqnw4opdblgnm6ebys-lgbtvnt4.gif"></div><br><br>  Ent√£o ele come√ßou a preparar um artigo.  Eu olhei para um gif e pensei. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ct/de/zr/ctdezrcsaztxtgxx9jyioatirds.gif"></div><br>  "Portanto, √© quase uma apar√™ncia pseudo-3D, como em Wolfenstein", exclamei (sim, tenho uma boa imagina√ß√£o).  E, de fato - se assumirmos que todas as paredes t√™m a mesma altura, os mapas de dist√¢ncia ser√£o suficientes para construirmos a cena.  Por que n√£o tentar? <br><br>  A cena deve ficar assim. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lg/5v/-s/lg5v-sk8cmojfurrj_pnrg3xw0k.png"></div><br><br>  Ent√£o nossa tarefa: <br><br><ol><li>  Em um ponto da tela, obtenha coordenadas mundiais para o caso quando n√£o houver paredes. <br><br>  Vamos considerar o seguinte: <br><ul><li>  Primeiro, normalizamos as coordenadas de um ponto na tela para que haja um ponto (0,0) no centro da tela e nos cantos (-1, -1) e (1,1), respectivamente <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l9/ki/fu/l9kifubvfwn50ust9lhtsik2f_k.png"></div></li><li>  A coordenada x se torna o √¢ngulo da dire√ß√£o da vis√£o, basta multiplic√°-la por A / 2, onde A √© o √¢ngulo de vis√£o <br></li><li>  A coordenada y determina a dist√¢ncia do observador ao ponto, no caso geral d ~ 1 / y.  Para um ponto na borda inferior da tela, dist√¢ncia = 1, para um ponto no centro da tela, dist√¢ncia = infinito. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8e/ua/4b/8eua4bycfatkegaiwbyu_eohxky.png"></div></li><li>  Portanto, se voc√™ n√£o levar em considera√ß√£o as paredes, para cada ponto vis√≠vel do mundo haver√° 2 pontos na tela - um acima do meio (no "teto") e o outro abaixo (no "piso") <br></li></ul></li><li>  Agora podemos olhar para a tabela de dist√¢ncias.  Se houver uma parede mais pr√≥xima do que pretendemos, voc√™ precisar√° desenhar uma parede.  Caso contr√°rio, significa piso ou teto <br></li></ol><br>  Recebemos como ordenado: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qp/gj/lu/qpgjluavcmsuba51v0iovqdccc0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br>  Adicione ilumina√ß√£o - da mesma maneira, itere sobre as fontes de luz e verifique as coordenadas do mundo.  E - o toque final - adicione texturas.  Para fazer isso, em uma textura com dist√¢ncias, voc√™ tamb√©m precisa escrever o deslocamento u para a textura da parede neste momento.  √â aqui que o canal b foi √∫til. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kn/ai/ay/knaiayi9epavp3cr8u6wcd4x2ss.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demo</a> )</sup> <br>  Perfeito. <br><br>  Brincadeira. <br><br>  Imperfeito, √© claro.  Mas, diabos, eu ainda li sobre como fazer meu Wolfenstein passar por rakecast h√° cerca de 15 anos, e eu queria fazer tudo, e aqui est√° uma oportunidade! <br><br><h4>  Em vez de uma conclus√£o </h4><br>  No come√ßo do artigo, mencionei outro m√©todo secreto.  Aqui est√°: <br><br><blockquote>  <b>Basta pegar o motor que j√° sabe como.</b> </blockquote><br>  De fato, se voc√™ precisar fazer um jogo, essa ser√° a maneira mais correta e r√°pida.  Por que voc√™ precisa cercar suas bicicletas e resolver problemas de longa data? <br><br>  Mas porque <br><br>  Na s√©rie 10, mudei para outra escola e tive problemas em matem√°tica.  N√£o me lembro do exemplo exato, mas era uma equa√ß√£o com graus, que em todos os aspectos precisava ser simplificada, mas simplesmente n√£o teve sucesso.  Desesperada, consultei minha irm√£ e ela disse: ‚Äúent√£o adicione x <sup>2</sup> em ambos os lados e tudo se decompor√°‚Äù.  E essa foi a solu√ß√£o: adicione o que n√£o estava l√°. <br><br>  Quando, mais tarde, ajudei meu amigo a construir minha casa, precisei colocar um bloco no limiar - para preencher um nicho.  E aqui estou eu, separando a guarni√ß√£o das barras.  Parece que algu√©m se encaixa, mas n√£o exatamente.  Outros s√£o muito menores.  Estou pensando em como coletar a palavra felicidade aqui, e um amigo diz: "ent√£o eles beberam as ranhuras em um local circular onde ela interfere".  E agora o grande bar j√° est√° parado. <br><br>  Essas hist√≥rias s√£o unidas por esse efeito, que chamarei de "efeito de invent√°rio".  Quando voc√™ tenta tomar uma decis√£o a partir de pe√ßas existentes, sem ver o material que pode ser processado e refinado nessas pe√ßas.  Os n√∫meros s√£o madeira, dinheiro ou c√≥digo. <br><br>  Muitas vezes eu observei o mesmo efeito com os colegas de programa√ß√£o.  N√£o se sentindo confiantes no material, √†s vezes cedem quando √© necess√°rio fazer, digamos, controles n√£o padronizados.  Ou adicione testes de unidade onde eles n√£o estavam.  Ou eles tentam fornecer tudo, tudo ao criar uma classe, e ent√£o obtemos um di√°logo como: <br>  - Isso n√£o √© necess√°rio agora <br>  - E se for necess√°rio? <br>  - Ent√£o vamos adicionar.  Deixe os pontos de expans√£o, s√≥ isso.  C√≥digo n√£o √© granito, √© plasticina. <br><br>  E para aprender a ver e sentir o material com o qual trabalhamos, tamb√©m precisamos de bicicletas. <br><br>  Este n√£o √© apenas um treino para a mente ou para o treinamento.  Essa √© uma maneira de atingir um n√≠vel qualitativamente diferente de trabalho com c√≥digo. <br><br>  Obrigado a todos pela leitura. <br><br>  Links, caso voc√™ tenha esquecido de clicar em algum lugar: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Todas as demos juntas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digo de demonstra√ß√£o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Na verdade jogo LD com sombras</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434370/">https://habr.com/ru/post/pt434370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434358/index.html">Substitui√ß√£o de importa√ß√£o de sistemas operacionais. Como vejo o SO dom√©stico</a></li>
<li><a href="../pt434360/index.html">Palestra explicada sobre programa√ß√£o ass√≠ncrona em Javascript</a></li>
<li><a href="../pt434362/index.html">N√ÉO previsto para 2019</a></li>
<li><a href="../pt434364/index.html">Suporte da fila do Hangfire</a></li>
<li><a href="../pt434368/index.html">Machine Learning para encontrar erros no c√≥digo: como eu estagiei na JetBrains Research</a></li>
<li><a href="../pt434374/index.html">Verificando o RBAC no Kubernetes</a></li>
<li><a href="../pt434380/index.html">No√ß√µes b√°sicas de inje√ß√£o de depend√™ncia</a></li>
<li><a href="../pt434382/index.html">Portando o Alpine Linux para o RISC-V</a></li>
<li><a href="../pt434384/index.html">Sobre a responsabilidade dos artistas</a></li>
<li><a href="../pt434386/index.html">Douglas Engelbart: "Aumentando o intelecto humano: uma estrutura conceitual"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>