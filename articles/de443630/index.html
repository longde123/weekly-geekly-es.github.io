<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌤️ 🌡️ 🚴🏾 So implementieren Sie eine Programmiersprache in JavaScript. Teil 1: Parser 👂🏿 👨🏾‍🎤 👩🏾‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! Ich präsentiere Ihnen eine Amateurübersetzung eines Leitfadens zur Implementierung Ihrer JavaScript-Programmiersprache - PL Tutorial . 
 Vom Üb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So implementieren Sie eine Programmiersprache in JavaScript. Teil 1: Parser</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443630/"><p>  Hallo!  Ich präsentiere Ihnen eine Amateurübersetzung eines Leitfadens zur Implementierung Ihrer JavaScript-Programmiersprache - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PL Tutorial</a> . </p><br><h1 id="ot-perevodchika">  Vom Übersetzer </h1><br><p>  Wir werden unsere eigene Programmiersprache erstellen - <strong>λ-Sprache</strong> (im Original - λanguage).  Während des Erstellungsprozesses werden wir viele interessante Techniken verwenden, wie z. B. rekursiven Abstieg, Kontrollübertragungsstil und grundlegende Optimierungstechniken.  Es werden zwei Versionen des Interpreters erstellt - der reguläre und der CPS-Interpreter, der Transcompiler in JavaScript. </p><br><p>  Der Autor des Originals ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mihai Bazon</a> , der Autor der berühmten UglifyJS-Bibliothek (ein Tool zum Minimieren und Formatieren von JS-Code). </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Inhalt</b> <div class="spoiler_text"><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">So implementieren Sie eine Programmiersprache in JavaScript.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1: Parser</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">So implementieren Sie eine Programmiersprache in JavaScript.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2: Dolmetscher</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">So implementieren Sie eine Programmiersprache in JavaScript.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3: CPS-Dolmetscher</a> </li><li>  So implementieren Sie eine Programmiersprache in JavaScript.  Teil 4: Trans-Kompilierung in JS </li></ol></div></div><br><h1 id="vstuplenie">  Eintrag </h1><br><p> Wenn Sie jemals Ihren Compiler oder Interpreter geschrieben haben, gibt es nichts Neues für Sie.  Wenn Sie jedoch reguläre Ausdrücke verwenden, <a href="">um</a> etwas zu <a href="">analysieren</a> , das wie eine Programmiersprache aussieht, lesen Sie den Abschnitt zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parsen</a> .  Schreiben wir Code mit weniger Fehlern! </p><br><p>  Der Artikel ist in der Reihenfolge „von einfach bis komplex“ in Teile unterteilt.  Ich empfehle nicht, Teile des Artikels zu überspringen, es sei denn, Sie verstehen das Thema gut.  Sie können jederzeit zurückgehen, wenn Sie etwas nicht verstehen. </p><br><p>  Was werden wir lernen: </p><br><ul><li>  Was ist ein Parser und wie schreibt man ihn? </li><li>  Wie schreibe ich einen Dolmetscher? </li><li>  Die Fortsetzung der Übertragung und warum es wichtig ist. </li><li>  Schreiben eines (Trans-) Compilers. </li><li>  Fortführungsübertragungsstil. </li><li>  Einige grundlegende Techniken zur Codeoptimierung. </li><li>  Beispiele dafür, was in unserer λ-Sprache im Vergleich zu JavaScript neu ist. </li></ul><br><p>  Zusammen mit diesem werde ich zeigen, warum Lisp eine großartige Programmiersprache ist.  <strong>Die Sprache, an der wir arbeiten, ist jedoch nicht Lisp.</strong>  Es hat eine reichhaltigere Syntax (eine klassische Infix-Notation, die jeder kennt), so etwas wie Scheme (außer Makros).  Gut oder nicht, aber Makros sind das Hauptmerkmal von Lisp - etwas, das andere Sprachen (außer Lisp-Dialekten) nicht so gut können wie sie.  (Ja, ich weiß über SweetJS Bescheid ... nah dran, aber nicht das.) </p><br><p>  Aber zuerst wollen wir unsere Programmiersprache vorstellen. </p><br><a name="Language"></a><br><h1 id="zyk">  λ Sprache </h1><br><p>  Bevor wir etwas tun, müssen wir ein klares Bild davon haben, was wir tun wollen.  Es wäre schön, eine Beschreibung der Grammatik der Sprache zu schreiben, aber ich werde es einfacher machen - schreibe ein Beispiel für ein einfaches Programm, also hier einige Beispiele für die λ-Sprache: </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   println("Hello World!"); println(2 + 3 * 4); #       `lambda`  `λ` fib = lambda (n) if n &lt; 2 then n else fib(n - 1) + fib(n - 2); println(fib(15)); print-range = λ(a, b) # `λ`     ,   `lambda` if a &lt;= b then { # `then`  ,      print(a); if a + 1 &lt;= b { print(", "); print-range(a + 1, b); } else println(""); #   }; print-range(1, 5);</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Hinweis zu Variablennamen</b> <div class="spoiler_text"><p>  Beachten Sie, dass Bezeichner ein Minuszeichen ( <code>print-range</code> ) enthalten können.  Das ist Geschmackssache.  Ich setze immer Leerzeichen um Operatoren.  Ich mag das camelRegister und den Armaturenbrett nicht besser als den unsichtbaren Raum ("_").  Wie cool, dass du machen kannst, was du willst, wenn du etwas selbst machst. </p></div></div><br><p>  Fazit: </p><br><pre> <code class="plaintext hljs">Hello World! 14 610 1, 2, 3, 4, 5</code> </pre> <br><p>  Die Sprache ähnelt JavaScript, ist es aber insgesamt nicht.  Erstens gibt es keine Aussagen, nur Ausdrücke.  Ein Ausdruck muss einen Wert zurückgeben und kann an einer beliebigen Stelle in einem anderen Ausdruck verwendet werden.  Semikolons werden benötigt, um Ausdrücke in einer "Folge" von Ausdrücken zu trennen.  Geschweifte Klammern <code>{</code> und <code>}</code> erstellen eine Sequenz, die selbst ein Ausdruck ist, und ihr Wert ist der letzte Wert aus der Sequenz.  Das folgende Programm ist korrekt: </p><br><pre> <code class="python hljs">a = { fib(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">#    ,      fib(15) #        }; print(a); #  610</span></span></code> </pre> <br><p>  Funktionen werden mit den Schlüsselwörtern <code>lambda</code> oder <code>λ</code> .  Danach steht in Klammern eine (möglicherweise leere) Liste von Argumentnamen, die durch Kommas getrennt sind.  Der Hauptteil einer Funktion ist ein Ausdruck, kann jedoch in eine Sequenz <code>{...}</code> .  Es ist auch erwähnenswert, dass es kein Schlüsselwort für die <code>return</code> .  Die Funktion gibt den Wert des letzten Ausdrucks zurück. </p><br><p>  Auch keine <code>var</code> .  Um eine Variable hinzuzufügen, können Sie das verwenden, was JavaScript-Programmierer <code>IIFE</code> nennen.  Verwenden Sie <code>lambda</code> und deklarieren Sie Variablen als Argumente.  Für Variablen ist der Gültigkeitsbereich eine Funktion, und Funktionen sind Verschlüsse, wie in JavaScript [ca.  Übersetzung: bis ES6.]. </p><br><p>  Auch <code>if</code> es ein Ausdruck ist.  JavaScript verwendet dazu den ternären Operator: </p><br><pre> <code class="python hljs">a = foo() ? bar() : baz(); // JavaScript a = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo() then bar() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> baz(); <span class="hljs-comment"><span class="hljs-comment"># λ</span></span></code> </pre> <br><p>  Das Schlüsselwort <code>then</code> ist optional, wenn der Zweig eine Sequenz ( <code>{...}</code> ) ist, wie Sie oben sehen können.  In einem anderen Fall ist es notwendig.  <code>else</code> verwendet, wenn ein alternativer Zweig vorhanden ist.  Und dann wieder und <code>then</code> nimm den Ausdruck als Körper, aber du kannst mehrere Ausdrücke mit <code>{...}</code> zu einem kombinieren.  Wenn <code>else</code> fehlt und die Bedingung <code>false</code> , ist das Ergebnis aller <code>if</code> <code>false</code> .  Es ist erwähnenswert, dass <code>false</code> ein Schlüsselwort ist, das einen Wert darstellt, der der einzige falsche Wert in einer λ-Sprache ist: </p><br><pre> <code class="plaintext hljs">if foo() then print("OK");</code> </pre> <br><p>  wird nur dann <code>OK</code> ausgegeben, wenn das Ergebnis von <code>foo()</code> <strong>nicht</strong> <code>false</code> .  Es gibt auch das Schlüsselwort <code>true</code> , aber absolut alles, was nicht <code>false</code> (in JavaScript der Operator <code>===</code> ), wird in den Zweigen als <code>true</code> betrachtet (einschließlich der Nummer <code>0</code> und der leeren Zeichenfolge <code>""</code> ). </p><br><p>  Beachten Sie, dass in <code>if</code> keine Klammern um den Ausdruck erforderlich <code>if</code> .  Wenn Sie sie hinzufügen, ist dies kein Fehler, denn <code>(</code> der Ausdruck beginnt, aber sie sind einfach überflüssig. </p><br><p>  Das gesamte Programm kann analysiert werden, auch wenn es von Klammern umgeben ist. Fügen Sie daher Folgendes hinzu <code>;</code>  nach jedem Ausdruck.  Der letzte Ausdruck ist eine Ausnahme. </p><br><p>  Großartig, das ist unsere kleine λ-Sprache.  Er ist nicht perfekt.  Die Syntax sieht gut aus, hat aber Mängel.  Es fehlen viele Funktionen wie Objekte und Arrays.  Wir achten nicht auf sie, da sie für unsere Programmiersprache nicht grundlegend sind. </p><br><p>  Als nächstes werden wir einen Parser für unsere Sprache schreiben. </p><br><a name="Parsing"></a><br><h1 id="prevraschenie-koda-v-ast">  Codekonvertierung in AST </h1><br><p>  Das Erstellen eines Parsers ist eine schwierige Aufgabe.  Im Wesentlichen sollte ein Teil des Codes in einen AST (Abstract Syntax Tree) umgewandelt werden.  AST ist eine strukturierte Darstellung eines Programms im Speicher, abstrakt, da es keine vollständigen Informationen über den Code enthält, sondern nur die Semantik.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschreibung AST</a> befindet sich in einem separaten Teil. </p><br><p>  Zum Beispiel haben wir den folgenden Code: </p><br><pre> <code class="python hljs">sum = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>(a, b) { a + b; }; print(sum(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>));</code> </pre> <br><p>  Unser Parser generiert einen Baum als JavaScript-Objekt: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">//  : { type: "assign", operator: "=", left: { type: "var", value: "sum" }, right: { type: "lambda", vars: [ "a", "b" ], body: { //     "prog",  ,  //     ,  //     . type: "binary", operator: "+", left: { type: "var", value: "a" }, right: { type: "var", value: "b" } } } }, //  : { type: "call", func: { type: "var", value: "print" }, args: [{ type: "call", func: { type: "var", value: "sum" }, args: [ { type: "num", value: 1 }, { type: "num", value: 2 } ] }] } ] }</span></span></code> </pre> <br><p>  Die Hauptschwierigkeit beim Erstellen eines Parsers ist die Schwierigkeit, den Code richtig zu organisieren.  Der Parser sollte auf einer höheren Ebene arbeiten als das Lesen von Zeichen aus einer Zeichenfolge.  Einige Richtlinien zur Reduzierung der Codekomplexität: </p><br><ul><li>  Schreiben Sie viele kleine Funktionen.  Machen Sie in jeder Funktion eine Sache und machen Sie es gut. </li><li>  Versuchen Sie nicht, reguläre Ausdrücke zum Parsen zu verwenden.  Sie funktionieren einfach nicht.  Sie können im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">lexikalischen Analysegerät</a> nützlich sein, werden jedoch der Einfachheit halber nicht verwendet. </li><li>  Versuchen Sie nicht zu raten.  Wenn Sie nicht sicher sind, wie Sie etwas analysieren sollen, lösen Sie eine Ausnahme aus, die den Ort des Fehlers enthält (Zeile und Spalte). </li></ul><br><p>  Um den Code einfacher zu halten, werden wir ihn in drei Teile unterteilen, die wiederum in viele kleine Funktionen unterteilt sind: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zeichenstrom</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Token Flow (Token)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parser</a> </li></ul><br><a name="InputStream"></a><br><h1 id="potok-simvolov">  Zeichenstrom </h1><br><p>  Dies ist der einfachste Teil.  Wir werden ein Stream-Objekt erstellen, das die Operationen zum sequentiellen Lesen von Zeichen aus einer Zeichenfolge darstellt.  Es enthält vier Funktionen: </p><br><ul><li>  <code>peek()</code> - gibt das nächste Zeichen zurück, ohne es aus dem Stream zu extrahieren. </li><li>  <code>next()</code> - gibt das nächste Zeichen zurück und extrahiert es aus dem Stream. </li><li>  <code>eof()</code> - gibt <code>true</code> zurück <code>true</code> wenn der Stream keine weiteren Zeichen enthält. </li><li>  <code>croak(msg)</code> - löst eine Ausnahme aus, die die Nachricht ( <code>msg</code> ) und die aktuelle Position im Stream enthält. </li></ul><br><p>  Die letzte Funktion wird benötigt, damit Sie einfach eine Ausnahme auslösen können, die den Ort des Fehlers enthält. </p><br><p>  Hier ist der gesamte Code für dieses Objekt (nennen wir es <code>InputStream</code> ).  Es ist klein genug, damit Sie keine Probleme damit haben sollten: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InputStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = <span class="hljs-number"><span class="hljs-number">0</span></span>, line = <span class="hljs-number"><span class="hljs-number">1</span></span>, col = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">next</span></span> : next, <span class="hljs-attr"><span class="hljs-attr">peek</span></span> : peek, <span class="hljs-attr"><span class="hljs-attr">eof</span></span> : eof, <span class="hljs-attr"><span class="hljs-attr">croak</span></span> : croak, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.charAt(pos++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"\n"</span></span>) line++, col = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> col++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ch; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peek</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> input.charAt(pos); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peek() == <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">croak</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(msg + <span class="hljs-string"><span class="hljs-string">" ("</span></span> + line + <span class="hljs-string"><span class="hljs-string">":"</span></span> + col + <span class="hljs-string"><span class="hljs-string">")"</span></span>); } }</code> </pre> <br><p>  Bitte beachten Sie, dass dies kein gewöhnliches Objekt ist (das über <code>new</code> ).  Um dieses Objekt zu erhalten, benötigen Sie: <code>var stream = InputStream(string)</code> . </p><br><p>  Als nächstes schreiben wir die folgende Abstraktionsebene: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Token Flow (Token)</a> . </p><br><a name="TokenStream"></a><br><h1 id="potok-tokenov-leksem">  Token Flow (Token) </h1><br><p>  Der Tokenizer (Lexer) verwendet einen Strom von Zeichen und gibt ein Objekt mit derselben Schnittstelle zurück, aber die Rückgabewerte der Funktionen <code>peek()</code> / <code>next()</code> sind Token.  Ein Token ist ein Typ mit zwei Eigenschaften: <code>type</code> , <code>value</code> .  Hier sind einige Beispiele für Token: </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"("</span></span> } <span class="hljs-comment"><span class="hljs-comment">// . : , ,     . . { type: "num", value: 5 } //  { type: "str", value: "Hello World!" } //  { type: "kw", value: "lambda" } //   { type: "var", value: "a" } //  { type: "op", value: "!=" } // </span></span></code> </pre> <br><p>  Leerzeichen (Leerzeichen, Tabulatoren, Zeilenumbrüche) und Kommentare werden einfach übersprungen. </p><br><p>  Um einen Tokenizer zu schreiben, müssen wir uns unsere Sprache genauer ansehen.  Die Idee ist zu beachten, dass wir abhängig vom aktuellen Zeichen ( <code>input.peek()</code> ) entscheiden können, welches Token gelesen werden soll: </p><br><ul><li>  Überspringen Sie zunächst Leerzeichen. </li><li>  Wenn <code>input.eof()</code> , geben Sie <code>null</code> . </li><li>  Wenn es sich um ein <code>#</code> -Zeichen handelt, überspringen Sie alle Zeichen bis zum Ende der Zeile (und geben Sie das nächste Token zurück). </li><li>  Wenn dies ein Anführungszeichen ist, lesen Sie die Zeichenfolge. </li><li>  Wenn dies eine Nummer ist, lesen Sie die Nummer. </li><li>  Wenn es sich um einen Buchstaben handelt, lesen wir das Wort und geben entweder den Bezeichner oder das Schlüsselwort zurück. </li><li>  Wenn dies eines der Sonderzeichen ist, geben Sie das entsprechende Token zurück. </li><li>  Wenn dies eines der Operatorsymbole ist, geben Sie das entsprechende Token zurück. </li><li>  Wenn keine der oben genannten <code>input.croak()</code> zutrifft, <code>input.croak()</code> mit <code>input.croak()</code> eine Ausnahme aus. </li></ul><br><p>  Wir werden die Funktion <code>read_next</code> , die Hauptfunktion des Tokenizers: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(is_whitespace); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input.eof()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"#"</span></span>) { skip_comment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_next(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_string(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_digit(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_number(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_id_start(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_ident(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next() }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op_char(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : read_while(is_op_char) }; input.croak(<span class="hljs-string"><span class="hljs-string">"Can't handle character: "</span></span> + ch); }</code> </pre> <br><p>  Hier sehen Sie viele zusätzliche Funktionen, die verschiedene Arten von Token zurückgeben, z. B. <code>read_string()</code> , <code>read_number()</code> usw. ... Sie sind in separaten Funktionen angeordnet, damit der Code einfacher und schöner aussieht. </p><br><p>  Interessant ist auch, dass wir nicht alle Symbole auf einmal entfernen: Jedes Mal, wenn der Parser nach dem nächsten Token fragt, lesen wir einen Token.  Wenn ein Fehler auftritt, lesen wir nicht einmal alle Zeichen. </p><br><p>  <code>read_ident()</code> liest alle Zeichen in einer Zeile, die Teil des Bezeichners sein können ( <code>is_id()</code> ).  Der Bezeichner muss mit dem Buchstaben <code>λ</code> oder <code>_</code> und darf dieselben Zeichen, Zahlen oder eines der folgenden Elemente enthalten: <code>?!-&lt;&gt;=</code> .  Daraus folgt, dass <code>foo-bar</code> nicht als drei Token gelesen wird, sondern als einer ( <code>var</code> Token).  Ist dies notwendig, um Funktionen mit Namen wie <code>is-pair?</code> definieren zu können <code>is-pair?</code>  oder <code>string&gt;=</code> (sorry, das ist Lisper in mir). </p><br><p>  Außerdem <code>read_ident()</code> , ob die Liste der bekannten Schlüsselwörter einen Bezeichner enthält, und wenn dieser vorhanden ist, wird ein <code>kw</code> Token anstelle eines <code>var</code> Tokens zurückgegeben. </p><br><p>  Ich denke, der Code spricht für sich selbst. Hier ist ein vorgefertigter Tokenizer für unsere Sprache: </p><br><div class="spoiler">  <b class="spoiler_title">Ganzer Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> current = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keywords = <span class="hljs-string"><span class="hljs-string">" if then else lambda λ true false "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">next</span></span> : next, <span class="hljs-attr"><span class="hljs-attr">peek</span></span> : peek, <span class="hljs-attr"><span class="hljs-attr">eof</span></span> : eof, <span class="hljs-attr"><span class="hljs-attr">croak</span></span> : input.croak }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_keyword</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keywords.indexOf(<span class="hljs-string"><span class="hljs-string">" "</span></span> + x + <span class="hljs-string"><span class="hljs-string">" "</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_digit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/[0-9]/i</span></span>.test(ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_id_start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/[a-zλ_]/i</span></span>.test(ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_id</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_id_start(ch) || <span class="hljs-string"><span class="hljs-string">"?!-&lt;&gt;=0123456789"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_op_char</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"+-*/%=&amp;|&lt;&gt;!"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">",;(){}[]"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_whitespace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" \t\n"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_while</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">predicate</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof() &amp;&amp; predicate(input.peek())) str += input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_number</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> has_dot = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> number = read_while(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"."</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (has_dot) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; has_dot = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_digit(ch); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(number) }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_ident</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = read_while(is_id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : is_keyword(id) ? <span class="hljs-string"><span class="hljs-string">"kw"</span></span> : <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : id }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_escaped</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">end</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> escaped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, str = <span class="hljs-string"><span class="hljs-string">""</span></span>; input.next(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (escaped) { str += ch; escaped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"\\"</span></span>) { escaped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == end) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { str += ch; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_string</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: read_escaped(<span class="hljs-string"><span class="hljs-string">'"'</span></span>) }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_comment</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ch != <span class="hljs-string"><span class="hljs-string">"\n"</span></span> }); input.next(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(is_whitespace); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input.eof()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"#"</span></span>) { skip_comment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_next(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_string(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_digit(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_number(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_id_start(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_ident(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next() }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op_char(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : read_while(is_op_char) }; input.croak(<span class="hljs-string"><span class="hljs-string">"Can't handle character: "</span></span> + ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peek</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current || (current = read_next()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = current; current = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok || read_next(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peek() == <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre> </div></div><br><ul><li>  Die <code>next()</code> -Funktion ruft nicht immer <code>read_next()</code> , da möglicherweise ein Token gelesen wurde, das zuvor gelesen wurde (mithilfe der <code>peek()</code> -Funktion).  Dazu haben wir eine <code>current</code> Variable, die das aktuelle Token enthält. </li><li>  In regulärer Notation werden nur Dezimalzahlen unterstützt (1E5, 0x usw. werden nicht unterstützt).  Aber wenn wir ihre Unterstützung hinzufügen wollten, würden wir nur <code>read_number()</code> ändern. </li><li>  Im Gegensatz zu JavaScript sind die einzigen Zeichen, die in einer Zeichenfolge nicht entfernt werden können, Anführungszeichen und Backslash.  Zeilen können Zeilenumbrüche, Tabulatoren und alles andere enthalten.  Wir interpretieren keine Standardkombinationen wie <code>\n</code> , <code>\t</code> usw. ... Es ist sehr einfach zu wiederholen ( <code>read_string()</code> ). </li></ul><br><p>  Jetzt haben wir leistungsstarke Tools zum einfachen Schreiben eines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parsers</a> , aber zuerst würde ich empfehlen, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">AST-Beschreibung zu lesen</a> . </p><br><a name="AST"></a><br><h1 id="opisanie-ast">  AST Beschreibung </h1><br><p>  Wie oben angegeben, erstellt der Parser eine Struktur, die die Semantik des Programms zeigt.  AST besteht aus Knoten.  Jeder Knoten ist ein reguläres JavaScript-Objekt mit einer <code>type</code> Eigenschaft, die den Typ des Knotens bestimmt, sowie zusätzlichen Informationen, die vom Typ abhängen. </p><br><table><thead><tr><th>  Typ </th><th>  Struktur </th></tr></thead><tbody><tr><td>  num </td><td> <code>{ type: "num", value: NUMBER }</code> </td> </tr><tr><td>  str </td><td> <code>{ type: "str", value: STRING }</code> </td> </tr><tr><td>  Bool </td><td> <code>{ type: "bool", value: true or false }</code> </td> </tr><tr><td>  var </td><td> <code>{ type: "var", value: NAME }</code> </td> </tr><tr><td>  Lambda </td><td> <code>{ type: "lambda", vars: [ NAME... ], body: AST }</code> </td> </tr><tr><td>  anrufen </td><td> <code>{ type: "call", func: AST, args: [ AST... ] }</code> </td> </tr><tr><td>  wenn </td><td> <code>{ type: "if", cond: AST, then: AST, else: AST }</code> </td> </tr><tr><td>  zuweisen </td><td> <code>{ type: "assign", operator: "=", left: AST, right: AST }</code> </td> </tr><tr><td>  binär </td><td> <code>{ type: "binary", operator: OPERATOR, left: AST, right: AST }</code> </td> </tr><tr><td>  prog </td><td> <code>{ type: "prog", prog: [ AST... ] }</code> </td> </tr><tr><td>  lass </td><td> <code>{ type: "let", vars: [ VARS... ], body: AST }</code> </td> </tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">Beispiele</b> <div class="spoiler_text"><h5 id="chisla-num">  Zahlen ( <code>num</code> ): </h5><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">123.5</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">123.5</span></span> }</code> </pre> <br><h5 id="stroki-str">  Linien ( <code>str</code> ): </h5><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"Hello World"</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span> }</code> </pre> <br><h5 id="true-i-false-bool">  <code>true</code> und <code>false</code> ( <code>bool</code> ): </h5><br><pre> <code class="python hljs">true false</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><h5 id="identifikatory-var">  Kennungen ( <code>var</code> ): </h5><br><pre> <code class="python hljs">foo</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }</code> </pre> <br><h5 id="funkcii-lambda">  Funktionen ( <code>lambda</code> ): </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> (x) <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">#  λ (x) 10</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: [ <span class="hljs-string"><span class="hljs-string">"x"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">body</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }</code> </pre> <br><p>  Später werden wir einen optionalen Parameternamen hinzufügen, um Funktionen mit einem Namen zu unterstützen, aber die erste Version des Parsers unterstützt sie nicht. </p><br><h5 id="vyzovy-funkciy-call">  Funktionsaufrufe ( <code>call</code> ): </h5><br><pre> <code class="python hljs">foo(a, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-string"><span class="hljs-string">"func"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"args"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }</code> </pre> <br><h5 id="vetvleniya-if">  Zweige ( <code>if</code> ): </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo then bar <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> baz</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-string"><span class="hljs-string">"cond"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"then"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"bar"</span></span> }, <span class="hljs-string"><span class="hljs-string">"else"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"baz"</span></span> } }</code> </pre> <br><h6 id="bez-else">  ohne <code>else</code> : </h6><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo then bar</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-string"><span class="hljs-string">"cond"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"then"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"bar"</span></span> } }</code> </pre> <br><h5 id="prisvaivanie-assign">  Aufgabe: </h5><br><pre> <code class="python hljs">a = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }</code> </pre> <br><h5 id="binarnye-operatory-binary">  <code>binary</code> ( <code>binary</code> ): </h5><br><pre> <code class="python hljs">x + y * z</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"x"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"y"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"z"</span></span> } } }</code> </pre> <br><h5 id="posledovtelnosti-prog">  Sequenzen ( <code>prog</code> ): </h5><br><pre> <code class="python hljs">{ a = <span class="hljs-number"><span class="hljs-number">5</span></span>; b = a * <span class="hljs-number"><span class="hljs-number">2</span></span>; a + b; }</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-string"><span class="hljs-string">"prog"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> } } }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> } } ] }</code> </pre> <br><h5 id="peremennye-zaklyuchennye-v-bloki-let">  In Blöcken eingeschlossene Variablen ( <code>let</code> ): </h5><br><pre> <code class="python hljs">let (a = <span class="hljs-number"><span class="hljs-number">10</span></span>, b = a * <span class="hljs-number"><span class="hljs-number">10</span></span>) { a + b; }</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"let"</span></span>, <span class="hljs-string"><span class="hljs-string">"vars"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"def"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span>, <span class="hljs-string"><span class="hljs-string">"def"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } } } ], <span class="hljs-string"><span class="hljs-string">"body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> } } }</code> </pre> <br><p>  Die erste Version des Parsers unterstützt diesen Knotentyp nicht, wir werden ihn später hinzufügen. </p></div></div><br><a name="Parser"></a><br><h1 id="parser">  Parser </h1><br><p>  Der Parser erstellt den oben beschriebenen Baum. </p><br><p>  Dank der Arbeit, die wir im Tokenizer geleistet haben, arbeitet der Parser mit einem Strom von Token anstelle eines Stroms von Zeichen.  Es gibt hier noch viele zusätzliche Funktionen, um die Struktur zu vereinfachen.  Wir werden über die wichtigsten sprechen.  Beginnen wir mit einer allgemeinen Parser-Funktion: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_varname), <span class="hljs-attr"><span class="hljs-attr">body</span></span>: parse_expression() }; }</code> </pre> <br><p>  Diese Funktion wird aufgerufen, wenn das <code>lambda</code> Schlüsselwort bereits aus dem Token-Stream übernommen wurde. Wir müssen also nur die Namen der Argumente übernehmen.  Da sie jedoch in Klammern stehen und durch Kommas getrennt sind, verwenden wir dazu die <code>delimited</code> Funktion, die die folgenden Argumente verwendet: <code>start</code> , <code>stop</code> , <code>separator</code> , die <code>parser</code> Funktion, die jedes Element separat analysiert.  In diesem Fall verwenden wir die Funktion <code>parse_varname</code> , die einen Fehler <code>parse_varname</code> , wenn etwas bemerkt wird, das nicht wie eine Variable aussieht.  Der Hauptteil der Funktion ist ein Ausdruck, daher erhalten wir ihn mit <code>parse_expression</code> . </p><br><p>  Die <code>delimited</code> Funktion ist niedriger: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimited</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">start, stop, separator, parser</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [], first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; skip_punc(start); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> skip_punc(separator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      a.push(parser()); } skip_punc(stop); return a; }</span></span></code> </pre> <br><p>  Wie Sie sehen können, werden noch mehr Funktionen verwendet: <code>is_punc</code> und <code>skip_punc</code> .  Der erste gibt <code>true</code> zurück <code>true</code> wenn das aktuelle Token ein bestimmtes Interpunktionszeichen ist (ohne es zu extrahieren), während <code>skip_punc</code> prüft, ob das aktuelle Token ein bestimmtes Interpunktionszeichen ist, und es extrahiert (oder eine Ausnahme auslöst). </p><br><p>  Die Funktion, die das gesamte Programm analysiert, scheint die einfachste zu sein: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_toplevel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { prog.push(parse_expression()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!input.eof()) skip_punc(<span class="hljs-string"><span class="hljs-string">";"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; }</code> </pre> <br><p>  Da wir nur Ausdrücke haben, rufen wir einfach <code>parse_expression()</code> und lesen die Ausdrücke, bis wir alles gelesen haben.  Mit <code>skip_punc(";")</code> tun wir dies <code>;</code>  obligatorisch nach jedem Ausdruck. </p><br><p>  Ein weiteres einfaches Beispiel ist <code>parse_if()</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ skip_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cond = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) skip_kw(<span class="hljs-string"><span class="hljs-string">"then"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> then = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ret = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cond</span></span>: cond, <span class="hljs-attr"><span class="hljs-attr">then</span></span>: then }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"else"</span></span>)) { input.next(); ret.else = parse_expression(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre> <br><p>  Sie überspringt das Schlüsselwort <code>if</code> (löst eine Ausnahme aus, wenn das aktuelle Token nicht das Schlüsselwort <code>if</code> ) und liest die Bedingung mit <code>parse_expression()</code> .  Wenn das Symbol <code>{</code> nicht weiter geht, ist das Schlüsselwort then erforderlich (die Syntax sieht ohne es nicht sehr gut aus).  Zweige sind nur Ausdrücke, daher verwenden wir für sie einfach wieder <code>parse_expression()</code> .  Der <code>else</code> Zweig ist optional, daher prüfen wir zunächst, ob das Schlüsselwort vorhanden ist, bevor wir es analysieren. </p><br><p>  Mit vielen kleinen Funktionen können wir den Code einfach machen.  Wir haben den Parser fast so geschrieben, als würden wir eine Hochsprache speziell für die Parsing-Syntax verwenden.  Alle diese Funktionen sind "gegenseitig rekursiv", <code>parse_atom()</code> wir haben <code>parse_atom()</code> , das abhängig vom aktuellen Token andere Funktionen aufruft.  Eines davon ist <code>parse_if()</code> (wird aufgerufen, wenn das aktuelle Token <code>if</code> ) und ruft wiederum <code>parse_expression()</code> .  Aber <code>parse_expression()</code> ruft <code>parse_atom()</code> .  Es gibt keine unendliche Rekursion, da eine der Funktionen immer mindestens ein Token extrahiert. </p><br><p>  Diese Art der Analysemethode wird als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">rekursive Abstiegsmethode</a> bezeichnet und ist in der Tat am einfachsten zu schreiben. </p><br><h3 id="bolee-nizkiy-uroven-parse_atom-i-parse_expression">  Untere Ebene: <code>parse_atom()</code> und <code>parse_expression()</code> </h3><br><p>  Die Funktion <code>parse_atom()</code> ruft abhängig vom aktuellen Token eine andere Funktion auf: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_atom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exp = parse_expression(); skip_punc(<span class="hljs-string"><span class="hljs-string">")"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_prog(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_if(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"true"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"false"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_bool(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"lambda"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"λ"</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_lambda(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok.type == <span class="hljs-string"><span class="hljs-string">"var"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"num"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"str"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok; unexpected(); }); }</code> </pre> <br><p>  Wenn sie die öffnende Klammer sieht, sollte der Klammerausdruck gehen. Daher überspringt die Funktion <code>parse_expression()</code> und erwartet, dass die schließende Klammer danach übersprungen wird.  Wenn sie ein Schlüsselwort sieht, ruft sie die entsprechende Funktion auf.  Wenn sie eine Konstante oder einen Bezeichner sieht, gibt sie diese unverändert zurück.  Und wenn nichts auftaucht, ruft es <code>unexpected()</code> , was eine Ausnahme auslöst. </p><br><p>  Wenn sie <code>{</code> sieht, ruft sie <code>parse_prog</code> auf, um die Reihenfolge der Ausdrücke zu analysieren.  Außerdem führt <code>parse_prog</code> eine einfache Optimierung durch: Wenn zwischen <code>{</code> und <code>}</code> keine Ausdrücke vorhanden sind, wird <code>false</code> . Wenn nur ein Ausdruck vorhanden ist, wird nur dieser zurückgegeben.  Andernfalls wird der <code>prog</code> Knoten mit einem Array von Ausdrücken zurückgegeben. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     FALSE   , //     . var FALSE = { type: "bool", value: false }; function parse_prog() { var prog = delimited("{", "}", ";", parse_expression); if (prog.length == 0) return FALSE; if (prog.length == 1) return prog[0]; return { type: "prog", prog: prog }; }</span></span></code> </pre> <br><p>  Und hier ist die Funktion <code>parse_expression()</code> .  Im Gegensatz zu <code>parse_atom()</code> werden mit <code>maybe_binary()</code> so viele Ausdrücke wie möglich <code>maybe_binary()</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_expression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary(parse_atom(), <span class="hljs-number"><span class="hljs-number">0</span></span>); }); }</code> </pre> <br><h3 id="funkcii-maybe_">  Funktionen <code>maybe_*</code> </h3><br><p>  Diese Funktionen prüfen, was nach dem Ausdruck kommt, und entscheiden, ob der Ausdruck in seinen Knoten eingeschlossen oder unverändert zurückgegeben werden soll. </p><br><p>  Die Funktion <code>maybe_call()</code> ist sehr einfach: Sie erhält eine Funktion, die den aktuellen Ausdruck analysiert, und wenn sie auf etwas trifft <code>(</code> nach dem Ausdruck, umschließt sie sich selbst in einen <code>call</code> . Beachten Sie, wie <code>delimited()</code> zum Parsen einer Liste von Argumenten geeignet ist: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ expr = expr(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>) ? parse_call(expr) : expr; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-attr"><span class="hljs-attr">func</span></span>: func, <span class="hljs-attr"><span class="hljs-attr">args</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_expression) }; }</code> </pre> <br><h3 id="prioritet-operatorov">  Bedienerpriorität </h3><br><p>  Die Funktion <code>maybe_binary(left, my_prec)</code> wird verwendet, um Ausdrücke wie <code>1 + 2 * 3</code> zu kombinieren.   , ,    ,     : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PRECEDENCE = { <span class="hljs-string"><span class="hljs-string">"="</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;&amp;"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"=="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"!="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"+"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"%"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, };</code> </pre> <br><p>   ,  <code>*</code> "",  <code>+</code> , ,  <code>1 + 2 * 3</code>    <code>(1 + (2 * 3))</code>  <code>((1 + 2) * 3)</code> . </p><br><p>   ,      ( <code>read_atom</code> )     <code>maybe_binary()</code> ( ),     ( <code>my_prec</code> ).  <code>maybe_binary</code>  ,   .     ,     ,     . </p><br><p>   ,    ,   ,         <code>binary</code> ,  ,       ,      (*): </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_binary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left, my_prec</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = is_op(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> his_prec = PRECEDENCE[tok.value]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (his_prec &gt; my_prec) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> right = maybe_binary(parse_atom(), his_prec) <span class="hljs-comment"><span class="hljs-comment">// (*); var binary = { type : tok.value == "=" ? "assign" : "binary", operator : tok.value, left : left, right : right }; return maybe_binary(binary, my_prec); } } return left; }</span></span></code> </pre> <br><p>  ,  ,     ,    <code>maybe_binary</code> ,    ( <code>my_prec</code> ),  ,      ,     .  - ,    (,        ),     . </p><br><p> ,   ,  <code>my_prec</code>   0,         <code>binary</code> ( <code>assign</code>   <code>=</code> ). </p><br><p>      ,    . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> FALSE = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PRECEDENCE = { <span class="hljs-string"><span class="hljs-string">"="</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;&amp;"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"=="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"!="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"+"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"%"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_toplevel(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"punc"</span></span> &amp;&amp; (!ch || tok.value == ch) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_kw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kw</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"kw"</span></span> &amp;&amp; (!kw || tok.value == kw) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_op</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">op</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"op"</span></span> &amp;&amp; (!op || tok.value == op) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting punctuation: \""</span></span> + ch + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_kw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kw</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(kw)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting keyword: \""</span></span> + kw + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_op</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">op</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op(op)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting operator: \""</span></span> + op + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unexpected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ input.croak(<span class="hljs-string"><span class="hljs-string">"Unexpected token: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(input.peek())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_binary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left, my_prec</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = is_op(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> his_prec = PRECEDENCE[tok.value]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (his_prec &gt; my_prec) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary({ <span class="hljs-attr"><span class="hljs-attr">type</span></span> : tok.value == <span class="hljs-string"><span class="hljs-string">"="</span></span> ? <span class="hljs-string"><span class="hljs-string">"assign"</span></span> : <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-attr"><span class="hljs-attr">operator</span></span> : tok.value, <span class="hljs-attr"><span class="hljs-attr">left</span></span> : left, <span class="hljs-attr"><span class="hljs-attr">right</span></span> : maybe_binary(parse_atom(), his_prec) }, my_prec); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> left; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimited</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">start, stop, separator, parser</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [], first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; skip_punc(start); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> skip_punc(separator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; a.push(parser()); } skip_punc(stop); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-attr"><span class="hljs-attr">func</span></span>: func, <span class="hljs-attr"><span class="hljs-attr">args</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_expression), }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_varname</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name.type != <span class="hljs-string"><span class="hljs-string">"var"</span></span>) input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting variable name"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ skip_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cond = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) skip_kw(<span class="hljs-string"><span class="hljs-string">"then"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> then = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ret = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cond</span></span>: cond, <span class="hljs-attr"><span class="hljs-attr">then</span></span>: then, }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"else"</span></span>)) { input.next(); ret.else = parse_expression(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_varname), <span class="hljs-attr"><span class="hljs-attr">body</span></span>: parse_expression() }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_bool</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next().value == <span class="hljs-string"><span class="hljs-string">"true"</span></span> }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ expr = expr(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>) ? parse_call(expr) : expr; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_atom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exp = parse_expression(); skip_punc(<span class="hljs-string"><span class="hljs-string">")"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_prog(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_if(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"true"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"false"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_bool(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"lambda"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"λ"</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_lambda(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok.type == <span class="hljs-string"><span class="hljs-string">"var"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"num"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"str"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok; unexpected(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_toplevel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { prog.push(parse_expression()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!input.eof()) skip_punc(<span class="hljs-string"><span class="hljs-string">";"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_prog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = delimited(<span class="hljs-string"><span class="hljs-string">"{"</span></span>, <span class="hljs-string"><span class="hljs-string">"}"</span></span>, <span class="hljs-string"><span class="hljs-string">";"</span></span>, parse_expression); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prog.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prog.length == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prog[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_expression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary(parse_atom(), <span class="hljs-number"><span class="hljs-number">0</span></span>); }); } }</code> </pre> </div></div><br><h2 id="blagodarnosti">  </h2><br><p>   Marijn Haverbeke,   parse-js (Common Lisp),    ,   . ,        ,  JS,      . </p><br><p>  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">     JavaScript.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2: Dolmetscher</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de443630/">https://habr.com/ru/post/de443630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de443618/index.html">80er Jahre Computer Emulator im Browser</a></li>
<li><a href="../de443620/index.html">Unser Problem mit Abhängigkeiten</a></li>
<li><a href="../de443624/index.html">Digital Works und VMware: VDI ist tot, es lebe VDI</a></li>
<li><a href="../de443626/index.html">Willkommen zur Top 3D Expo 2019</a></li>
<li><a href="../de443628/index.html">Bessel-Funktionen im SymPy Symbolic Math Program</a></li>
<li><a href="../de443636/index.html">Morse Key und Klopfer</a></li>
<li><a href="../de443638/index.html">Wie Protonmail vom FSB in Russland zensiert wird</a></li>
<li><a href="../de443640/index.html">Wasser schärft einen Stein</a></li>
<li><a href="../de443642/index.html">Der NASA-Administrator hält es für möglich, Orion auf der ersten Mondreise mit einer kommerziellen Rakete zu schicken</a></li>
<li><a href="../de443648/index.html">Benutzerdokumentation: Was macht es schlecht und wie kann es behoben werden?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>