<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∫ üêΩ üèë Conhe√ßa a estrutura de microsservi√ßo Moleculer üëÇ ‚≠ïÔ∏è ü§õüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°% habrauser%! 

 Hoje, quero falar sobre um excelente, na minha opini√£o, estrutura de microsservi√ßo Moleculer . 



 Inicialmente, essa estrutura f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conhe√ßa a estrutura de microsservi√ßo Moleculer</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439810/"> Ol√°% habrauser%! <br><br>  Hoje, quero falar sobre um excelente, na minha opini√£o, estrutura de microsservi√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moleculer</a> . <br><br><img src="https://habrastorage.org/webt/n1/8a/ew/n18aewfs_oj6ndbonuakkyjfwte.png"><br><br>  Inicialmente, essa estrutura foi escrita em Node.js, mas posteriormente apareceu em portas em outras linguagens como Java, Go, Python e .NET e, provavelmente, outras implementa√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aparecer√£o</a> em um futuro pr√≥ximo.  N√≥s o usamos na produ√ß√£o de v√°rios produtos h√° cerca de um ano e √© dif√≠cil descrever com palavras como ele nos pareceu aben√ßoado depois de usar o Seneca e nossas motos.  Temos tudo o que precisamos imediatamente: coletando m√©tricas, armazenamento em cache, balanceamento, toler√¢ncia a falhas, transportes selecionados, valida√ß√£o de par√¢metros, registro em log, declara√ß√µes concisas de m√©todos, v√°rias formas de intera√ß√£o entre servi√ßos, mixins e muito mais.  E agora em ordem. <br><a name="habracut"></a><br><h2>  1. Introdu√ß√£o </h2><br>  A estrutura, de fato, consiste em tr√™s componentes (na verdade, n√£o, mas voc√™ aprender√° mais sobre isso abaixo). <br><br><h4>  Transportador </h4><br>  Respons√°vel pela descoberta de servi√ßos e comunica√ß√£o entre eles.  Essa √© uma interface que voc√™ pode implementar por conta pr√≥pria, se desejar, ou pode usar implementa√ß√µes prontas que fazem parte da pr√≥pria estrutura.  7 transportes est√£o dispon√≠veis na caixa: TCP, Redis, AMQP, MQTT, NATS, NATS Streaming, Kafka.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ pode ver mais.  Usamos o transporte Redis, mas planejamos mudar para o TCP com sua sa√≠da do estado experimental. <br><br>  Na pr√°tica, ao escrever c√≥digo, n√£o interagimos com esse componente.  Voc√™ s√≥ precisa saber o que ele √©.  O transporte usado √© especificado na configura√ß√£o.  Assim, para mudar de um transporte para outro, basta alterar a configura√ß√£o.  S√≥ isso.  Algo assim: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ./moleculer.config.js module.exports = { transporter: 'redis://:pa$$w0rd@127.0.0.1:6379', // ...   }</span></span></code> </pre> <br>  Os dados, por padr√£o, s√£o fornecidos no formato JSON.  Mas voc√™ pode usar qualquer coisa: Avro, MsgPack, Notepack, ProtoBuf, Thrift, etc. <br><br><h4>  Servi√ßo </h4><br>  A classe que herdamos ao escrever nossos microsservi√ßos. <br><br>  Aqui est√° o servi√ßo mais simples sem m√©todos, que, no entanto, ser√° detectado por outros servi√ßos: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ./services/telemetry/telemetry.service.js const { Service } = require('moleculer'); module.exports = class TelemetryService extends Service { constructor(broker) { super(broker); this.parseServiceSchema({ name: 'telemetry', }); } };</span></span></code> </pre><br><br><h4>  Corretor de servi√ßos </h4><br>  O n√∫cleo da estrutura. <br><br><img src="https://habrastorage.org/webt/t7/wp/qo/t7wpqorpz4zhmczcvir_fs9cems.png"><br><br>  Exagerando, podemos dizer que essa √© uma camada entre transporte e servi√ßo.  Quando um servi√ßo deseja interagir com outro servi√ßo de alguma forma, ele o faz atrav√©s de um broker (exemplos ser√£o fornecidos abaixo).  O broker est√° envolvido no balanceamento de carga (suporta v√°rias estrat√©gias, incluindo as personalizadas, por padr√£o - round-robin), levando em considera√ß√£o os servi√ßos ao vivo, os m√©todos dispon√≠veis nesses servi√ßos, etc.  Para isso, o ServiceBroker usa outro componente sob o cap√¥ - o Registro, mas eu n√£o vou me debru√ßar sobre ele, n√£o precisamos dele para conhecimento. <br><br>  Ter um corretor nos d√° uma coisa extremamente conveniente.  Agora vou tentar explicar, mas vou ter que me afastar um pouco.  No contexto da estrutura, existe um n√≥.  Em termos simples, um n√≥ √© um processo no sistema operacional (ou seja, o que acontece quando inserimos ‚Äúnode index.js‚Äù no console, por exemplo).  Cada n√≥ √© um ServiceBroker com um conjunto de um ou mais microsservi√ßos.  Sim, voc√™ ouviu direito.  Podemos construir nossa pilha de servi√ßos como nosso cora√ß√£o desejar.  Por que isso √© conveniente?  Para o desenvolvimento, iniciamos um n√≥ no qual todos os microsservi√ßos s√£o iniciados ao mesmo tempo (1 cada), apenas um processo no sistema com a capacidade de conectar muito facilmente o hotreload, por exemplo.  Em produ√ß√£o - um n√≥ separado para cada inst√¢ncia do servi√ßo.  Bem, ou uma mistura, quando parte dos servi√ßos em um n√≥, parte em outro e assim por diante (embora eu n√£o saiba por que fazer isso, apenas para entender que voc√™ tamb√©m pode fazer isso). <br><br><div class="spoiler">  <b class="spoiler_title">√â assim que nosso index.js se parece</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { resolve } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { ServiceBroker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moleculer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./moleculer.config.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { SERVICES, NODE_ENV, } = process.env; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> broker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceBroker(config); broker.loadServices( resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'services'</span></span>), SERVICES ? <span class="hljs-string"><span class="hljs-string">`*/@(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${SERVICES.split(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">','</span></span></span></span><span class="hljs-string"><span class="hljs-subst">).map(i =&gt; i.trim()).join(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'|'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">).service.js`</span></span> : <span class="hljs-string"><span class="hljs-string">'*/*.service.js'</span></span>, ); broker.start().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NODE_ENV === <span class="hljs-string"><span class="hljs-string">'development'</span></span>) { broker.repl(); } });</code> </pre><br></div></div><br>  Se n√£o houver vari√°vel de ambiente, todos os servi√ßos do diret√≥rio ser√£o carregados, caso contr√°rio, por m√°scara.  A prop√≥sito, broker.repl () √© outro recurso conveniente da estrutura.  Ao iniciar no modo de desenvolvimento, ali mesmo, no console, temos uma interface para chamar m√©todos (o que voc√™ faria, por exemplo, atrav√©s de carteiro em seu microsservi√ßo que se comunica via http), s√≥ que aqui √© muito mais conveniente: a interface est√° no mesmo console onde eles come√ßaram a npm. <br><br><h2>  Intera√ß√£o entre servi√ßos </h2><br>  √â realizado de tr√™s maneiras: <br><br><h4>  ligar </h4><br>  Mais comumente usado.  Fez uma solicita√ß√£o, recebeu uma resposta (ou erro). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   "report",     "csv". async getCsvReport({ jobId }) { const rows = []; // ... return this.broker.call('csv.stringify', { rows }); }</span></span></code> </pre><br>  Como mencionado acima, as chamadas s√£o automaticamente equilibradas.  Apenas aumentamos o n√∫mero necess√°rio de inst√¢ncias de servi√ßo, e a pr√≥pria estrutura far√° o balanceamento. <br><br><img src="https://habrastorage.org/webt/jl/nj/r4/jlnjr4zxz943pfzpc9epoxpbgw8.gif"><br><br><h4>  emitir </h4><br>  Usada quando queremos apenas notificar outros servi√ßos sobre um evento, mas n√£o precisamos do resultado. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   "user"    . async registerUser({ email, password }) { // ... this.broker.emit('user_registered', { email }); return true; }</span></span></code> </pre><br>  Outros servi√ßos podem se inscrever neste evento e responder de acordo.  Opcionalmente, o terceiro argumento, voc√™ pode definir explicitamente os servi√ßos que est√£o dispon√≠veis para receber esse evento. <br><br>  O ponto importante √© que o evento receber√° apenas uma inst√¢ncia de cada tipo de servi√ßo, ou seja,  se tivermos 10 servi√ßos de "correio" e 5 de "assinatura" inscritos nesse evento, na verdade, apenas duas c√≥pias o receber√£o - um "correio" e uma "assinatura".  Esquematicamente aparece assim: <br><br><img src="https://habrastorage.org/webt/yf/fg/oj/yffgoj5ce8pzhcfdl_rdian6hpg.gif"><br><br><h4>  transmiss√£o </h4><br>  O mesmo que emitir, mas sem restri√ß√µes.  Todos os 10 servi√ßos de correio e 5 de assinatura participar√£o deste evento. <br><br><h2>  Valida√ß√£o de par√¢metros </h2><br>  Por padr√£o, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">validador mais r√°pido √©</a> usado para validar os par√¢metros, parece ser muito r√°pido.  Mas nada impede o uso de outra, por exemplo, a mesma joi, se voc√™ precisar de uma valida√ß√£o mais avan√ßada. <br><br>  Quando escrevemos um servi√ßo, herdamos da classe base Service, declaramos m√©todos com l√≥gica de neg√≥cios, mas esses m√©todos s√£o "privados", n√£o podem ser chamados de fora (de outro servi√ßo) at√© que desejemos explicitamente, declarando-os em se√ß√£o de a√ß√µes especiais durante a inicializa√ß√£o do servi√ßo (m√©todos p√∫blicos de servi√ßos no contexto da estrutura s√£o chamados de a√ß√µes). <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de uma declara√ß√£o de m√©todo com valida√ß√£o</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JobService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'job'</span></span>, <span class="hljs-attr"><span class="hljs-attr">actions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">update</span></span>: { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">convert</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-attr"><span class="hljs-attr">empty</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">optional</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'object'</span></span>, <span class="hljs-attr"><span class="hljs-attr">optional</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update(ctx.params); }, }, }, }); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> update({ id, name, data }) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br></div></div><br><h2>  Mixins </h2><br>  Usado, por exemplo, para inicializar uma conex√£o com o banco de dados.  Evite a duplica√ß√£o de c√≥digo de servi√ßo para servi√ßo. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de mixin para inicializar uma conex√£o com Redis</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Redis = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ioredis'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ key = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'redis'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, options } = {}</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">settings</span></span>: { [key]: options, }, created() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Redis(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.settings[key]); }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> started() { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key].connect(); }, stopped() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[key].disconnect(); }, });</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Usando mixin no servi√ßo</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Service, Errors } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'moleculer'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> redis = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../mixins/redis'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../mixins/server'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> router = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./router'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, } = process.env; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> redisOpts = { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: REDIS_HOST, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: REDIS_PORT, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: REDIS_PASSWORD, <span class="hljs-attr"><span class="hljs-attr">lazyConnect</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'auth'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mixins</span></span>: [redis({ <span class="hljs-attr"><span class="hljs-attr">options</span></span>: redisOpts }), server({ router })], }); } }</code> </pre> <br></div></div><br><h2>  Armazenamento em cache </h2><br>  As chamadas de m√©todo (a√ß√µes) podem ser armazenadas em cache de v√°rias maneiras: LRU, Mem√≥ria, Redis.  Opcionalmente, voc√™ pode especificar por quais chamadas de chave ser√£o armazenadas em cache (por padr√£o, o hash do objeto √© usado como uma chave de cache) e com o qual TTL. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de declara√ß√£o de m√©todo em cache</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InventoryService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(broker) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(broker); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parseServiceSchema({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'inventory'</span></span>, <span class="hljs-attr"><span class="hljs-attr">actions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">getInventory</span></span>: { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">steamId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'string'</span></span>, <span class="hljs-attr"><span class="hljs-attr">pattern</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^76\d{15}$/</span></span> }, <span class="hljs-attr"><span class="hljs-attr">appId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">integer</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-attr"><span class="hljs-attr">contextId</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'number'</span></span>, <span class="hljs-attr"><span class="hljs-attr">integer</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, }, <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: { <span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [<span class="hljs-string"><span class="hljs-string">'steamId'</span></span>, <span class="hljs-string"><span class="hljs-string">'appId'</span></span>, <span class="hljs-string"><span class="hljs-string">'contextId'</span></span>], <span class="hljs-attr"><span class="hljs-attr">ttl</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, }, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }, }, }, }); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br></div></div><br>  O m√©todo de armazenamento em cache √© definido atrav√©s da configura√ß√£o do ServiceBroker. <br><br><h2>  Registo </h2><br>  Aqui, no entanto, tudo tamb√©m √© bastante simples.  H√° um bom logger interno que grava no console; √© poss√≠vel especificar a formata√ß√£o personalizada.  Nada impede o roubo de qualquer outro registrador popular, seja winston ou bunyan.  Um manual detalhado est√° na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> .  Pessoalmente, usamos o criador de logs incorporado, o formatador personalizado para algumas linhas de c√≥digo que o spam no console JSON √© simplesmente dividido no produto, ap√≥s o qual eles entram no graylog usando o driver de log do docker. <br><br><h2>  M√©tricas </h2><br>  Se desejar, voc√™ pode coletar m√©tricas para cada m√©todo e rastrear tudo em algum zipkin.  Aqui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° a</a> lista completa de exportadores dispon√≠veis.  Atualmente, existem cinco deles: Zipkin, Jaeger, Prometheus, Elastic, Console.  Ele √© configurado, como o cache, ao declarar um m√©todo (a√ß√£o). <br><br>  Exemplos de visualiza√ß√£o do pacote elasticsearch + kibana usando o m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">elastic-apm-node</a> podem ser visualizados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste link</a> no Github. <br><br>  A maneira mais f√°cil, √© claro, √© usar a op√ß√£o de console.  √â assim: <br><br><img src="https://habrastorage.org/webt/eu/dq/20/eudq20mgo7wtbqmstlp_aiidicy.png"><br><br><h2>  Toler√¢ncia a falhas </h2><br>  A estrutura possui um disjuntor interno, controlado pelas configura√ß√µes do ServiceBroker.  Se algum servi√ßo falhar e o n√∫mero dessas falhas exceder um determinado limite, ele ser√° marcado como n√£o √≠ntegro, as solicita√ß√µes para ele ser√£o severamente limitadas at√© que parem de cometer erros. <br><br>  Como b√¥nus, tamb√©m existe um fallback ajust√°vel individualmente para cada m√©todo (a√ß√£o), caso presumamos que o m√©todo falhe e, por exemplo, envie dados em cache ou um stub. <br><br><h2>  Conclus√£o </h2><br>  A introdu√ß√£o dessa estrutura para mim tornou-se uma lufada de ar fresco, o que economizou uma enorme quantidade de estacas (exceto pelo fato de a arquitetura de microsservi√ßos ser um grande problema) e o ciclismo, tornando a escrita do pr√≥ximo microsservi√ßo simples e transparente.  N√£o h√° nada de sup√©rfluo, √© simples e muito flex√≠vel, e voc√™ pode escrever o primeiro servi√ßo dentro de uma ou duas horas depois de ler a documenta√ß√£o.  Ficarei feliz se este material for √∫til para voc√™ e em seu pr√≥ximo projeto, voc√™ desejar√° experimentar esse milagre, como fizemos (e nunca o lamentamos ainda).  Bom para todos! <br><br>  Al√©m disso, se voc√™ estiver interessado nessa estrutura, participe do bate-papo no Telegram - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@moleculerchat</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439810/">https://habr.com/ru/post/pt439810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439794/index.html">Dor nas costas - compreens√£o da perspectiva da medicina moderna</a></li>
<li><a href="../pt439796/index.html">Spring Boot 2: o que eles n√£o escrevem nas notas de vers√£o</a></li>
<li><a href="../pt439804/index.html">Zen de Teste de Unidade</a></li>
<li><a href="../pt439806/index.html">Nomes de dom√≠nio SSL v√°lidos para cont√™ineres do Docker local</a></li>
<li><a href="../pt439808/index.html">Os maiores telesc√≥pios. De notebooks e olhos a c√¢meras de 340 megapixels e data centers. Parte 1</a></li>
<li><a href="../pt439812/index.html">Abordagens Kaggle para CV em prod: voc√™ n√£o pode implementar para cortar</a></li>
<li><a href="../pt439818/index.html">Caracter√≠sticas das abordagens de design no setor de fabrica√ß√£o real</a></li>
<li><a href="../pt439822/index.html">Criando uma tela alternativa para o sintetizador / amostrador Ensoniq EPS16 + e ASR10</a></li>
<li><a href="../pt439824/index.html">Quando as estruturas JavaScript desaparecer√£o?</a></li>
<li><a href="../pt439826/index.html">Desativando o anal√≥gico. O que acontecer√° com a televis√£o?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>