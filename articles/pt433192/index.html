<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèº üë®‚Äçüë®‚Äçüë¶ üò© Kubernetes: uma solu√ß√£o de projeto pessoal incrivelmente acess√≠vel ‚õ≥Ô∏è üåΩ üë©üèæ‚Äçü§ù‚Äçüë®üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° colegas! 

 Em janeiro, finalmente temos o t√£o esperado livro sobre Kubernetes. Discurso sobre a ‚ÄúMastering Kubernetes 2nd edition‚Äù de Gigi Saifan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes: uma solu√ß√£o de projeto pessoal incrivelmente acess√≠vel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/433192/">  Ol√° colegas! <br><br>  Em janeiro, finalmente temos o t√£o esperado livro sobre Kubernetes.  Discurso sobre a ‚ÄúMastering Kubernetes 2nd edition‚Äù de Gigi Saifan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mp/6r/pc/mp6rpcu9hby7scugehhegmzmtrs.jpeg"></div><br>  N√£o ousamos publicar um livro no Kubernetes h√° cerca de um ano, j√° que naquela √©poca a tecnologia definitivamente parecia um dreadnought para as super corpora√ß√µes.  No entanto, a situa√ß√£o est√° mudando, em apoio ao qual sugerimos a leitura de um grande artigo de Caleb Doxsey, que, ali√°s, escreveu um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">livro</a> sobre a linguagem Go.  Os argumentos do Sr. Doxy s√£o muito interessantes e esperamos que, depois de l√™-los, voc√™ realmente queira experimentar o Kubernetes na pr√°tica. <br><a name="habracut"></a><br>  Passei alguns meses no in√≠cio deste ano em um estudo aprofundado do Kubernetes: eu precisava dele para um projeto de trabalho.  O Kubernetes √© uma tecnologia abrangente para gerenciamento de infraestrutura, que "inclui tudo, at√© baterias".  O Kubernetes resolve v√°rios problemas que voc√™ est√° fadado a encontrar ao desenvolver para grandes empresas.  No entanto, a cren√ßa de que o Kubernetes √© uma tecnologia excessivamente sofisticada e relevante apenas para gerenciar um grande cluster de m√°quinas √© replicada.  Alegadamente, a carga operacional ao trabalhar com o Kubernetes √© t√£o grande que seu uso em pequenas infra-estruturas, onde a m√°quina n√£o sai por dezenas, √© um canh√£o disparando contra pardais. <br>  Eu me permito discordar disso.  O Kubernetes tamb√©m √© bom para pequenos projetos, e hoje voc√™ j√° pode comprar seu pr√≥prio cluster Kubernetes por menos de <b>US $ 5</b> por m√™s. <br><br>  <b>Uma palavra em defesa de Kubernetes</b> <br><br>  Abaixo, mostrarei como configurar seu pr√≥prio cluster Kubernetes, mas primeiro tente explicar por que o Kubernetes deve ser usado em pequenos projetos: <br><br>  <i>Kubernetes √© completo</i> <br><br>  Sim, √† primeira vista, o Kubernetes parece uma solu√ß√£o um pouco redundante.  Parece ser mais f√°cil obter e obter uma m√°quina virtual e n√£o configurar seu pr√≥prio aplicativo como servi√ßo, por que n√£o?  Escolhendo esse caminho, voc√™ ter√° que decidir sobre algumas solu√ß√µes, em particular: <br><br><ol><li>  Como implantar o aplicativo?  Apenas rsync-lo para o servidor? </li><li>  E as depend√™ncias?  Se voc√™ trabalha com Python ou Ruby, precisar√° instal√°-los no servidor.  Voc√™ vai apenas executar os comandos manualmente? </li><li>  Como voc√™ vai iniciar o aplicativo?  Basta executar o bin√°rio em segundo plano e depois nohup?  Provavelmente isso n√£o √© muito bom; portanto, se voc√™ organizar o aplicativo como um servi√ßo, precisar√° aprender o systemd? </li><li>  Como voc√™ lida com a opera√ß√£o de muitos aplicativos quando todos eles t√™m nomes de dom√≠nio ou caminhos http diferentes?  (voc√™ provavelmente precisar√° configurar haproxy ou nginx para isso) </li><li>  Suponha que voc√™ atualizou seu aplicativo.  Como ent√£o voc√™ lan√ßar√° as mudan√ßas?  Pare o servi√ßo, implante o c√≥digo, reinicie o servi√ßo?  Como evitar o tempo de inatividade? </li><li>  E se voc√™ bloquear a implanta√ß√£o?  Existem oportunidades para reverter?  (Diret√≥rio Symlink ...? Esse script simples n√£o parece mais particularmente simples) </li><li>  Seu aplicativo usa outros servi√ßos, por exemplo, redis?  Como configurar todos esses servi√ßos? </li></ol><br>  Kubernetes resolve todos esses problemas.  Naturalmente, todos eles s√£o resolvidos de outras maneiras, entre as quais existem melhores op√ß√µes para o Kubernetes;  no entanto, qu√£o melhor √© n√£o pensar nisso tudo e se concentrar no desenvolvimento de aplicativos. <br><br>  <i>Kubernetes √© confi√°vel</i> <br><br>  Um √∫nico servidor sempre trava.  Sim, isso √© raro, talvez uma vez por ano, mas ap√≥s esse evento uma verdadeira dor de cabe√ßa come√ßa: como retornar tudo √† condi√ß√£o de trabalho.  Isso √© especialmente verdadeiro se voc√™ tiver configurado manualmente toda a configura√ß√£o.  Lembra de todas as equipes que rodaram da √∫ltima vez?  Voc√™ se lembra do que funcionou no servidor?  Lembro-me de uma cita√ß√£o de bashorg: <br><blockquote>  erno: Hmm.  Perdi o computador ... s√©rio, perdi.  Ele responde, funciona bem, eu simplesmente n√£o sei para onde ele foi no apartamento. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bash.org/?5273</a> </blockquote>  Exatamente a mesma coisa aconteceu comigo recentemente em meu pr√≥prio blog.  Eu s√≥ precisava atualizar o link, mas esqueci completamente como implantar o blog.  De repente, uma corre√ß√£o de dez minutos se transformou em um trabalho durante um fim de semana inteiro. <br><br>  O Kubernetes usa um formato <b>descritivo</b> , para que voc√™ sempre saiba quais coisas, quando e onde deveria correr;  Al√©m disso, todos os componentes do seu sistema implantado s√£o muito mais claramente vis√≠veis.  Al√©m disso, no plano de controle, a falha do n√≥ √© tratada com cuidado e as lareiras s√£o redistribu√≠das automaticamente.  Ao trabalhar com um servi√ßo que n√£o preserva o estado, por exemplo, com um aplicativo Web, voc√™ provavelmente pode esquecer completamente as falhas. <br><br>  <i>Aprender Kubernetes n√£o √© mais dif√≠cil do que alternativas</i> <br><br>  O Kubernetes n√£o segue o modelo Unix.  N√£o se encaixa no ecossistema de ferramentas.  Ele n√£o √© uma daquelas decis√µes que "fazem apenas uma coisa e fazem bem".  O Kubernetes √© uma solu√ß√£o abrangente para muitos problemas, pois pode substituir uma variedade de truques e ferramentas √†s quais os desenvolvedores j√° se acostumaram. <br><br>  O Kubernetes tem sua pr√≥pria terminologia, suas pr√≥prias ferramentas, seu pr√≥prio paradigma de manipula√ß√£o de servidor, que difere significativamente da abordagem tradicional do unix.  Quando voc√™ navega nesses sistemas, muitos dos recursos do Kubernetes podem parecer aleat√≥rios e complicados demais, talvez at√© cru√©is.  Suponho que existem boas raz√µes para essa complexidade ter surgido, mas aqui n√£o afirmo que o Kubernetes seja simples e elementar de entender;  Estou dizendo que o conhecimento do Kubernetes √© suficiente para criar e dar suporte a qualquer infraestrutura. <br><br>  Isso n√£o quer dizer que qualquer administrador de sistema tenha um hist√≥rico suficiente no unix.  Por exemplo, depois de me formar na faculdade, trabalhei por 5 anos no ecossistema do Windows.  Posso dizer que meu primeiro trabalho em uma startup em que eu precisava lidar com o Linux exigiu uma transforma√ß√£o dif√≠cil.  Eu n√£o conhecia os comandos de mem√≥ria; n√£o estou acostumado a usar a linha de comando em quase todas as ocasi√µes.  Demorei um pouco para aprender a trabalhar com a nova plataforma (embora, naquela √©poca, eu j√° tivesse alguma experi√™ncia em programa√ß√£o), mas lembro claramente o quanto sofri. <br><br>  Com o Kubernetes, voc√™ pode come√ßar todo o trabalho do zero.  No Kubernetes, voc√™ pode provisionar servi√ßos facilmente, mesmo sem uma conex√£o SSH com o servidor.  Voc√™ n√£o precisa aprender o systemd;  n√£o √© necess√°rio entender os n√≠veis de execu√ß√£o ou saber qual comando foi usado: <code>groupadd</code> ou <code>addgroup</code> ;  Voc√™ n√£o precisa aprender a lidar com <code>ps</code> ou, Deus n√£o permita, vim.  Todo esse material √© √∫til e importante, nada disso desaparece em lugar algum.  Eu tenho um grande respeito pelos administradores de sistemas que s√£o capazes de trabalhar em qualquer ambiente unix.  Mas como seria legal se os desenvolvedores pudessem adquirir produtivamente todos esses recursos sem se aprofundar nessas sutilezas de administra√ß√£o? <br><br>  √â realmente isso: <br><br><pre> <code class="plaintext hljs">[Unit] Description=The NGINX HTTP and reverse proxy server After=syslog.target network.target remote-fs.target nss-lookup.target [Service] Type=forking PIDFile=/run/nginx.pid ExecStartPre=/usr/sbin/nginx -t ExecStart=/usr/sbin/nginx ExecReload=/usr/sbin/nginx -s reload ExecStop=/bin/kill -s QUIT $MAINPID PrivateTmp=true [Install] WantedBy=multi-user.target</code> </pre> <br>  Muito mais dif√≠cil que isso? <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 1 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80</code> </pre> <br>  E este ainda √© um caso relativamente bom.  Se voc√™ gerenciar a infraestrutura 100% remotamente, n√£o poder√° fornecer suporte manual ao servidor.  Para fazer isso, voc√™ precisar√° de algum tipo de ferramenta: ansible, sal, chef, fantoche, etc.  Naturalmente, para dominar o Kubernetes e trabalhar efetivamente com ele, voc√™ precisa aprender muito, mas isso n√£o √© mais dif√≠cil do que lidar com alternativas. <br><br>  <b>C√≥digo aberto Kubernetes</b> <br><br>  Na era da enorme popularidade das tecnologias sem servidor, a Kubernetes √© not√°vel por sua independ√™ncia em rela√ß√£o a fornecedores espec√≠ficos.  Existem pelo menos tr√™s fornecedores populares e f√°ceis de gerenciar do Kubernetes (Google, Amazon, Microsoft) que n√£o desaparecer√£o no futuro pr√≥ximo.  Tamb√©m existem muitas empresas que gerenciam com √™xito seus pr√≥prios clusters Kubernetes e todos os dias o n√∫mero dessas empresas se multiplica.  Hoje, trabalhar com o Kubernetes desde o primeiro dia √© uma solu√ß√£o √≥bvia para a maioria das startups. <br>  O Kubernetes, sendo um projeto de c√≥digo aberto, √© bem documentado, est√°vel e popular, e qualquer problema pode ser tratado o m√°ximo poss√≠vel no fluxo de pilha.  √â claro que o Kubernetes tem seus pr√≥prios bugs e desafios t√©cnicos, mas garanto: existem caras no mundo que aprimoram o Kubernetes com uma habilidade incr√≠vel.  O trabalho deles √© o seu dividendo;  nos pr√≥ximos anos, essa tecnologia s√≥ ser√° aprimorada. <br><br>  <b>Escalas de Kubernetes</b> <br><br>  Um dos desafios associados ao suporte √† infraestrutura √© o seguinte: as t√©cnicas que s√£o √∫teis ao implantar pequenos sistemas raramente s√£o bem-sucedidas na reprodu√ß√£o em sistemas maiores.  Definitivamente, √© conveniente ligar um arquivo bin√°rio ao servidor, matar o processo e reinici√°-lo se voc√™ tiver apenas um servidor.  Por√©m, quando voc√™ precisa oferecer suporte a v√°rios servidores e monitor√°-los simultaneamente, essa tarefa pode se tornar incrivelmente dif√≠cil.  √â por isso que voc√™ n√£o pode prescindir de ferramentas como chef ou fantoche ao gerenciar essa infraestrutura. <br><br>  No entanto, se voc√™ escolher a ferramenta errada, com o tempo ela poder√° encurral√°-lo.  De repente, verifica-se que o principal chef-servidor n√£o consegue lidar com a carga de 1000 servidores, a implanta√ß√£o azul esverdeado n√£o se encaixa no seu modelo e leva horas para concluir as tarefas do capistrano.  Quando a infraestrutura atingir um determinado tamanho, voc√™ ser√° for√ßado a derrubar tudo o que j√° foi feito e come√ßar de novo.  Qu√£o grande seria se voc√™ pudesse sair dessa roda eterna de esquilos com infraestrutura e mudar para a tecnologia que ser√° dimensionada de acordo com suas necessidades? <br><br>  O Kubernetes √© muito parecido com um banco de dados SQL.  O SQL √© o produto de muitos anos de li√ß√µes dif√≠ceis sobre armazenamento de dados e consultas eficientes.  Provavelmente, voc√™ nunca precisar√° de um d√©cimo desses recursos fornecidos em um banco de dados SQL v√°lido.  Voc√™ pode at√© criar um sistema mais eficiente, contando com seu pr√≥prio banco de dados.  Mas na grande maioria das situa√ß√µes, o banco de dados SQL n√£o apenas satisfaz todas as suas necessidades, mas tamb√©m aumenta drasticamente sua capacidade de emitir rapidamente solu√ß√µes prontas.  Os esquemas e a indexa√ß√£o SQL s√£o muito mais f√°ceis de usar do que as estruturas de dados baseadas em arquivos nativos, j√° que as estruturas de dados nativas quase certamente se tornar√£o obsoletas √† medida que o produto cresce e se desenvolve ao longo do tempo.  Mas o banco de dados SQL provavelmente sobreviver√° a qualquer refatora√ß√£o inevit√°vel. <br><br>  Kubernetes tamb√©m sobreviver√°.  Talvez seu projeto paralelo nunca chegue a uma escala em que seus problemas s√≥ possam ser resolvidos com o Kubernetes, mas o Kubernetes possui absolutamente todas as ferramentas para quaisquer problemas, e as habilidades que voc√™ obter√° ao lidar com este kit de ferramentas podem se tornar inestim√°vel em projetos futuros. <br><br>  <b>Crie seu pr√≥prio cluster Kubernetes</b> <br><br>  Portanto, acredito que √© aconselh√°vel usar o Kubernetes em pequenos projetos, mas somente se a configura√ß√£o de um cluster for simples e barata.  Acontece que ambos s√£o vi√°veis.  Existem provedores gerenciados pelo Kubernetes que lidam com toda a bagun√ßa sozinhos, dando suporte ao plano de controle do host Kubernetes.  E as recentes guerras de dumping no ambiente de infraestrutura em nuvem levaram a uma redu√ß√£o impressionante no custo de tais servi√ßos. <br>  Analisaremos o caso a seguir usando o mecanismo Kubernetes do Google (GKE) como exemplo; no entanto, voc√™ tamb√©m pode consultar ofertas da Amazon (EKS) ou Microsoft (AKS) se o Google n√£o lhe agradar.  Para criar seu pr√≥prio cluster Kubernetes, precisamos: <br><br><ul><li>  Nome de dom√≠nio (~ 10 $ / ano, dependendo do dom√≠nio) </li><li>  Hospedagem DNS Cloudflare (gr√°tis) </li><li>  Cluster de tr√™s n√≥s do GKE Kubernetes (~ US $ 5 / m√™s) </li><li>  Aplicativo da Web carregado como um cont√™iner de encaixe no Google Container Registry (GCR) (gratuito) </li><li>  V√°rios arquivos yaml para configura√ß√£o do Kubernetes </li></ul><br>  Para economias adicionais, tentaremos ficar sem um controlador de entrada do Google.  Em vez disso, usaremos o Nginx em cada n√≥ como um daemon e criaremos nosso pr√≥prio operador que sincronizar√° os endere√ßos IP externos do n√≥ de trabalho com o Cloudflare. <br><br>  <b>Configura√ß√£o do Google</b> <br><br>  Primeiro, acesse console.cloud.google.com e crie um projeto, se voc√™ ainda n√£o o fez.  Voc√™ tamb√©m precisar√° criar uma conta de cobran√ßa.  Em seguida, no menu hamb√∫rguer, v√° para a p√°gina Kubernetes e crie um novo cluster.  Aqui est√° o que voc√™ precisa fazer a seguir: <br><br><ul><li>  Selecione Zonal para o tipo de local. </li><li>  Indiquei minha localiza√ß√£o como us-central1-a </li><li>  Escolha sua vers√£o do kubernetes </li><li>  Crie um pool de 3 n√≥s usando o tipo de inst√¢ncia mais barato (f1-micro). </li><li>  Para esse conjunto de n√≥s, na tela "avan√ßada", defina o tamanho do disco de inicializa√ß√£o para 10 GB, ative os n√≥s extrudados (s√£o mais baratos), ative a atualiza√ß√£o autom√°tica e o tratamento autom√°tico. </li><li>  Sob o conjunto de n√≥s, voc√™ encontrar√° v√°rias op√ß√µes adicionais.  Queremos desativar o balanceamento de carga HTTP (o balanceamento de carga no GCP √© caro) e tamb√©m desativar toda a economia associada ao StackDriver (tamb√©m pode ser caro e, na minha experi√™ncia, n√£o muito confi√°vel).  Desligue tamb√©m o painel indicador do kubernetes. </li></ul><br>  Depois de colocar todas essas op√ß√µes, voc√™ pode prosseguir para a pr√≥xima etapa: criar um cluster.  Veja como economizar nele: <br><br><ul><li>  Plano de controle Kubernetes: gr√°tis, porque o Google n√£o cobra n√≥s de host </li><li>  N√≥s de trabalho do Kubernetes: US $ 5,04 / m√™s, como regra, tr√™s micron√≥s custam US $ 11,65 / m√™s e, depois de eliminados, reduziremos essa taxa para US $ 7,67 / m√™s e, sempre gr√°tis - para US $ 5,04. </li><li>  Custos de armazenamento: gr√°tis.  Recebemos gratuitamente 30 GB de espa√ßo em disco permanente; portanto, escolhemos o tamanho de 10 GB. </li><li>  Custos do balanceamento de carga: de gra√ßa, desativamos o balanceamento de carga HTTP, pois apenas isso levaria US $ 18 / m√™s.  Em vez disso, execute nossos pr√≥prios proxies HTTP em cada n√≥ e direcione o DNS para o IP p√∫blico. </li><li>  Despesas de rede: gr√°tis, a fun√ß√£o de sa√≠da permanece gratuita at√© voc√™ selecionar 1 GB por m√™s.  (Em seguida, cada pr√≥ximo gigabyte custa 8 centavos) </li></ul><br>  Por isso, montamos um cluster Kubernetes de 3 n√≥s, que nos custou o mesmo pre√ßo que a √∫nica m√°quina Digital Ocean. <br><br>  Al√©m de configurar o GKE, voc√™ tamb√©m precisa configurar algumas regras de firewall para poder acessar as portas HTTP de nossos hosts do mundo exterior.  Localize a entrada Rede VPC no menu hamb√∫rguer, v√° para Regras de firewall e adicione as regras para as portas TCP 80 e 443, com o intervalo de endere√ßos IP 0.0.0.0/0. <br><br><img src="https://habrastorage.org/webt/if/ag/gz/ifaggzw5xpzfosqf_lxon8bqsdo.jpeg"><br><br>  Regras de firewall <br><br>  <b>Configura√ß√£o local</b> <br><br>  Ent√£o, criamos e iniciamos o cluster, e agora vamos configur√°-lo.  Instale a ferramenta <code>gcloud</code> seguindo as instru√ß√µes em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cloud.google.com/sdk/docs</a> .  Ap√≥s a instala√ß√£o, voc√™ pode prosseguir para a configura√ß√£o fazendo o seguinte: <br><br><pre> <code class="plaintext hljs">gcloud auth login</code> </pre> <br>  Obviamente, voc√™ ainda precisa instalar a janela de encaixe e vincul√°-la ao GCR, para poder enviar cont√™ineres: <br><br><pre> <code class="plaintext hljs">gcloud auth configure-docker</code> </pre> <br>  Voc√™ tamb√©m pode instalar e configurar o <code>kubectl</code> seguindo as instru√ß√µes descritas aqui. <br><br>  Simplificado: <br><br><pre> <code class="plaintext hljs">gcloud components install kubectl gcloud config set project PROJECT_ID gcloud config set compute/zone COMPUTE_ZONE gcloud container clusters get-credentials CLUSTER_NAME</code> </pre> <br>  A prop√≥sito, √© apenas um conto de fadas que todo esse kit de ferramentas funciona no Windows, OSX ou Linux.  Como uma pessoa que √†s vezes fez essas coisas no Windows, admito que √© uma surpresa agrad√°vel. <br><br>  <b>Compila√ß√£o de aplicativos da Web</b> <br><br>  Um aplicativo da web pode ser escrito em qualquer linguagem de programa√ß√£o.  O cont√™iner permite abstrair o particular.  N√≥s devemos criar um aplicativo HTTP escutando na porta.  Eu prefiro o Go para esses prop√≥sitos, mas, para variar, tentaremos o cristal.  Crie o arquivo <code>main.cr</code> : <br><br><pre> <code class="plaintext hljs"># crystal-www-example/main.cr require "http/server" Signal::INT.trap do exit end server = HTTP::Server.new do |context| context.response.content_type = "text/plain" context.response.print "Hello world from crystal-www-example! The time is #{Time.now}" end server.bind_tcp("0.0.0.0", 8080) puts "Listening on http://0.0.0.0:8080" server.listen</code> </pre> <br>  Tamb√©m precisamos de um Dockerfile: <br><br><pre> <code class="plaintext hljs"># crystal-www-example/Dockerfile FROM crystallang/crystal:0.26.1 as builder COPY main.cr main.cr RUN crystal build -o /bin/crystal-www-example main.cr --release ENTRYPOINT [ "/bin/crystal-www-example" ]</code> </pre> <br>  Para criar e testar nosso aplicativo, execute: <br><br><pre> <code class="plaintext hljs">docker build -t gcr.io/PROJECT_ID/crystal-www-example:latest . docker run -p 8080:8080 gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  E, em seguida, v√° para o navegador em localhost: 8080.  Ap√≥s estabelecer esse mecanismo, podemos enviar nosso aplicativo ao GCR executando: <br><br><pre> <code class="plaintext hljs">docker push gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  <b>Configurar o Kubernetes</b> <br><br>  Minha configura√ß√£o do Kubernetes est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Neste exemplo, teremos que criar v√°rios arquivos yaml onde nossos v√°rios servi√ßos ser√£o apresentados e, em seguida, execute o kubectl apply para configur√°-los no cluster.  A configura√ß√£o do Kubernetes √© descritiva e todos esses arquivos yaml informam ao Kubernetes qual o estado que queremos obter.  Em um sentido amplo, √© isso que vamos fazer: <br><br><ul><li>  Crie Implanta√ß√£o e Servi√ßo para nosso aplicativo Web crystal-www-example </li><li>  Criar conjunto de daemon (conjunto de servi√ßos) e mapa de configura√ß√£o (mapa de configura√ß√£o) para nginx </li><li>  Lan√ßamos nosso pr√≥prio aplicativo para sincronizar n√≥s IP com o Cloudflare for DNS </li></ul><br>  <b>Configura√ß√£o de aplicativo da Web</b> <br><br>  Primeiro, vamos configurar nosso aplicativo da Web: (certifique-se de substituir <code>PROJECT_ID</code> pelo ID do seu projeto) <br><br><pre> <code class="plaintext hljs"># kubernetes-config/crystal-www-example.yaml apiVersion: apps/v1 kind: Deployment metadata: name: crystal-www-example labels: app: crystal-www-example spec: replicas: 1 selector: matchLabels: app: crystal-www-example template: metadata: labels: app: crystal-www-example spec: containers: - name: crystal-www-example image: gcr.io/PROJECT_ID/crystal-www-example:latest ports: - containerPort: 8080 --- kind: Service apiVersion: v1 metadata: name: crystal-www-example spec: selector: app: crystal-www-example ports: - protocol: TCP port: 8080 targetPort: 8080</code> </pre> <br>  Isso cria uma implanta√ß√£o (configura√ß√£o expandida), segundo a qual o Kubernetes deve criar um √∫nico cont√™iner (nosso cont√™iner de docker funcionar√° l√°) e um servi√ßo que usaremos para encontrar servi√ßos em nosso cluster.  Para aplicar esta configura√ß√£o, execute (no diret√≥rio <code>kubernetes-config</code> ): <br><br><pre> <code class="plaintext hljs">kubectl apply -f</code> </pre> <br>  Voc√™ pode test√°-lo assim: <br><br><pre> <code class="plaintext hljs">kubectl get pod #     : # crystal-www-example-698bbb44c5-l9hj9 1/1 Running 0 5m</code> </pre> <br><br>  Tamb√©m podemos criar uma API proxy para acesso: <br><br><pre> <code class="plaintext hljs">kubectl proxy</code> </pre> <br>  E ent√£o v√°: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">localhost</a> : 8001 / api / v1 / namespaces / padr√£o / services / crystal-www-example / proxy / <br><br>  <b>Configura√ß√£o NGINX</b> <br><br>  Normalmente, ao trabalhar com servi√ßos HTTP, o Kubernetes usa um controlador de entrada.  Infelizmente, o balanceador de carga HTTP do Google √© muito caro, por isso n√£o o usamos, mas usamos nosso pr√≥prio proxy HTTP e o configuramos manualmente (parece assustador, mas na realidade √© muito simples). <br><br>  Para fazer isso, use o Conjunto de Daemon e o Mapa de Configura√ß√£o.  Daemon Set √© um aplicativo que √© executado em todos os n√≥s.  O mapa de configura√ß√£o √©, em princ√≠pio, um pequeno arquivo que podemos montar em um cont√™iner;  esse arquivo armazenar√° a configura√ß√£o nginx. <br>  O arquivo yaml se parece com isso: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: DaemonSet metadata: name: nginx labels: app: nginx spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - image: nginx:1.15.3-alpine name: nginx ports: - name: http containerPort: 80 hostPort: 80 volumeMounts: - name: "config" mountPath: "/etc/nginx" volumes: - name: config configMap: name: nginx-conf --- apiVersion: v1 kind: ConfigMap metadata: name: nginx-conf data: nginx.conf: | worker_processes 1; error_log /dev/stdout info; events { worker_connections 10; } http { access_log /dev/stdout; server { listen 80; location / { proxy_pass http://crystal-www-example.default.svc.cluster.local:8080; } } }</code> </pre> <br>  √â assim que montamos o arquivo nginx.conf da placa de configura√ß√£o no cont√™iner nginx.  Tamb√©m definimos valores para mais dois campos: <code>hostNetwork: true</code> , para que voc√™ possa vincular a porta do host e alcan√ßar o nginx de fora e <code>dnsPolicy: ClusterFirstWithHostNet</code> para poder acessar servi√ßos dentro do cluster.  Se isso n√£o for feito, obteremos uma configura√ß√£o completamente padr√£o. <br><br>  Aplique essas express√µes e voc√™ poder√° acessar o nginx atrav√©s do ip p√∫blico de seus n√≥s. <br><br>  Veja como voc√™ pode verificar isso: <br><br><pre> <code class="plaintext hljs">kubectl get node -o yaml # look for: # - address: ... # type: ExternalIP</code> </pre><br>  Portanto, agora nosso aplicativo da Web est√° acess√≠vel na Internet.  Resta criar um nome bonito para o aplicativo. <br><br>  <b>Conex√£o DNS</b> <br><br>  √â necess√°rio definir 3 registros DNS A para os n√≥s do cluster: <br><br><img src="https://habrastorage.org/webt/1l/0t/xx/1l0txxf6dye-lyuxpbndghsw_ta.png"><br><br>  Entradas na interface do usu√°rio Cloudflare <br><br>  Em seguida, adicione um registro CNAME para apontar para esses registros A.  (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.example.com</a> CNAME para kubernetes.example.com).  Isso pode ser feito manualmente, mas melhor - automaticamente, para que, se precisarmos escalar ou substituir n√≥s nos registros DNS, essas informa√ß√µes tamb√©m sejam atualizadas automaticamente. <br><br>  Acho que este exemplo tamb√©m ilustra bem como voc√™ pode delegar parte do seu trabalho ao Kubernetes, e n√£o tentar super√°-lo.  O Kubernetes entende scripts e possui uma API poderosa, e voc√™ pode preencher os espa√ßos existentes com seus pr√≥prios componentes, que n√£o s√£o t√£o dif√≠ceis de escrever.  Para fazer isso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">criei</a> um pequeno aplicativo no Go, dispon√≠vel neste endere√ßo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kubernetes-cloudflare-sync</a> . <br><br>  Para come√ßar, criei um informante: <br><br><pre> <code class="go hljs">factory := informers.NewSharedInformerFactory(client, time.Minute) lister := factory.Core().V1().Nodes().Lister() informer := factory.Core().V1().Nodes().Informer() informer.AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, UpdateFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldObj, newObj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, DeleteFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, }) informer.Run(stop)</code> </pre> <br>  Ele chamar√° minha fun√ß√£o de ressincroniza√ß√£o sempre que um n√≥ for alterado.  Ent√£o, sincronizo a API usando a biblioteca da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Cloudflare</a> , algo como isto: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ips []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, node := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> nodes { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, addr := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> node.Status.Addresses { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> addr.Type == core_v1.NodeExternalIP { ips = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(ips, addr.Address) } } } sort.Strings(ips) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, ip := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ips { api.CreateDNSRecord(zoneID, cloudflare.DNSRecord{ Type: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, Name: options.DNSName, Content: ip, TTL: <span class="hljs-number"><span class="hljs-number">120</span></span>, Proxied: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }) }</code> </pre> <br>  Em seguida, como em nosso aplicativo Web, lan√ßamos esse aplicativo no Kubernetes como uma implanta√ß√£o: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: kubernetes-cloudflare-sync labels: app: kubernetes-cloudflare-sync spec: replicas: 1 selector: matchLabels: app: kubernetes-cloudflare-sync template: metadata: labels: app: kubernetes-cloudflare-sync spec: serviceAccountName: kubernetes-cloudflare-sync containers: - name: kubernetes-cloudflare-sync image: gcr.io/PROJECT_ID/kubernetes-cloudflare-sync args: - --dns-name=kubernetes.example.com env: - name: CF_API_KEY valueFrom: secretKeyRef: name: cloudflare key: api-key - name: CF_API_EMAIL valueFrom: secretKeyRef: name: cloudflare key: email</code> </pre> <br>  Precisamos criar um segredo do <code>cloudflare api</code> especificando a chave da <code>cloudflare api</code> do <code>cloudflare api</code> e o endere√ßo para correspond√™ncia: <br><br><pre> <code class="plaintext hljs">kubectl create secret generic cloudflare --from-literal=email='EMAIL' --from-literal=api-key='API_KEY'</code> </pre> <br>  Tamb√©m precisaremos criar uma conta de servi√ßo (fornecendo acesso √† Deployment √† API Kubernetes para recuperar n√≥s).  Primeira execu√ß√£o (especialmente para GKE): <br><br><pre> <code class="plaintext hljs">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user YOUR_EMAIL_ADDRESS_HERE</code> </pre> <br><br>  E depois aplique: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ServiceAccount metadata: name: kubernetes-cloudflare-sync --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: kubernetes-cloudflare-sync rules: - apiGroups: [""] resources: ["nodes"] verbs: ["list", "watch"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kubernetes-cloudflare-sync-viewer roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kubernetes-cloudflare-sync subjects: - kind: ServiceAccount name: kubernetes-cloudflare-sync namespace: default</code> </pre> <br>  Trabalhar com o RBAC √© um pouco entediante, mas espero que tudo esteja claro aqui.  Quando a configura√ß√£o estiver pronta e nosso aplicativo funcionar com o Cloudflare, esse aplicativo poder√° ser atualizado com qualquer altera√ß√£o em qualquer um dos n√≥s. <br><br>  <b>Conclus√£o</b> <br><br>  O Kubernetes est√° destinado a se tornar a principal tecnologia para gerenciar grandes sistemas. ,   Kubernetes     ,    Kubernetes    ,    Kubernetes   ,      Kubernetes   . <br><br>    ,  Kubernetes       :      ,  .       ‚Äì   ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433192/">https://habr.com/ru/post/pt433192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433180/index.html">Resolvendo problemas de tipo de dados no Ruby ou Torne os dados confi√°veis ‚Äã‚Äãnovamente</a></li>
<li><a href="../pt433182/index.html">√â poss√≠vel treinar um agente para negociar no mercado de a√ß√µes com refor√ßos? Implementa√ß√£o da linguagem R</a></li>
<li><a href="../pt433184/index.html">Lan√ßamento do ASP.NET Core 2.2. Novidades (2 de 3)</a></li>
<li><a href="../pt433186/index.html">N√£o basta contar pol√≠gonos para otimizar modelos 3D</a></li>
<li><a href="../pt433188/index.html">Um projeto de lei sobre o trabalho aut√¥nomo de Runet foi enviado √† Duma do Estado</a></li>
<li><a href="../pt433194/index.html">Luz noturna agendada</a></li>
<li><a href="../pt433196/index.html">Guia de presentes de ano novo</a></li>
<li><a href="../pt433198/index.html">10 d√≥lares para hospedagem: h√° 20 anos e hoje</a></li>
<li><a href="../pt433202/index.html">Escolhendo a arquitetura de uma solu√ß√£o para um mercado de servi√ßos de frete</a></li>
<li><a href="../pt433204/index.html">Como aprender o desenvolvimento Java? A experi√™ncia da estudante da GeekUniversity Nikita Chernetsov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>