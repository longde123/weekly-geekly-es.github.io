<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Ö üö£üèø üêî Cliente API Badoo Jira: magia en Jira en PHP üñïüèø üë©üèæ‚ÄçüöÄ üë∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si ingresa ‚ÄúJira Badoo‚Äù en la cadena de b√∫squeda en Habr√©, los resultados ocupar√°n m√°s de una p√°gina: lo mencionamos en casi todas partes, porque jueg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cliente API Badoo Jira: magia en Jira en PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/475840/"> Si ingresa ‚ÄúJira Badoo‚Äù en la cadena de b√∫squeda en Habr√©, los resultados ocupar√°n m√°s de una p√°gina: lo mencionamos en casi todas partes, porque juega un papel importante en nuestros procesos.  Y cada uno de nosotros quiere un poco diferente de ella. <br><br><img src="https://habrastorage.org/webt/xy/8u/z0/xy8uz0gbqfd5idb0tokgpsxvdqs.jpeg"><br><br>  El desarrollador, que recibi√≥ la tarea para la revisi√≥n, espera que se indique una rama en la tarea, hay enlaces a diff y el registro de cambios.  El desarrollador que escribi√≥ el c√≥digo espera ver comentarios en Jira despu√©s de la revisi√≥n.  El probador, que recibe la tarea despu√©s de ellos, quiere ver los resultados de la prueba y poder ejecutar los ensamblajes necesarios sin tener que ir a otras interfaces.  Los gerentes de producto generalmente desean crear diez tareas de desarrollo al mismo tiempo presionando un solo bot√≥n. <br><br>  Y todo esto est√° disponible hoy y sucede autom√°ticamente.  Implementamos la mayor parte de la magia en PHP usando la API Jira en constante evoluci√≥n y usando su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">webhook</a> .  Y hoy queremos compartir con la comunidad nuestra versi√≥n del cliente para esta API. <br><br>  Al principio, solo quer√≠amos hablar sobre las ideas y el enfoque que usamos, y luego decidimos que definitivamente no hab√≠a suficiente c√≥digo para un art√≠culo de ese tipo para mayor claridad.  As√≠ que hab√≠a una versi√≥n de c√≥digo abierto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Badoo Jira PHP Client</a> .  Muchas gracias a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ShaggyRatte</a> por ayudar con su descripci√≥n.  Y bienvenido a kat! <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">M√°s detalles y contexto.</b> <div class="spoiler_text">  Si necesita m√°s detalles sobre lo que hacemos con Jira, puede encontrarlos en nuestros otros art√≠culos: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/en/company/badoo/blog/169417</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/en/company/badoo/blog/433540</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/en/company/badoo/blog/424655</a> <br></div></div><br><h2>  Que puede hacer el? </h2><br>  De hecho, Badoo Jira PHP Client es un conjunto de clases de contenedor listas para responder a las API de Jira, la mayor√≠a de las cuales pueden comportarse como ActiveRecord: saben c√≥mo obtener datos sobre s√≠ mismos y c√≥mo actualizarlos en el servidor, admiten la inicializaci√≥n diferida y el almacenamiento en cach√© de datos a nivel c√≥digo  Todas las entidades de Jira con las que tiene que trabajar constantemente est√°n envueltas: <b>Problema, Estado, Prioridad, Registro de cambios, Usuario, Versi√≥n, Componente</b> , etc. (casi todo lo que ve en la interfaz). <br><br>  Adem√°s, Badoo Jira PHP Client proporciona una jerarqu√≠a de clase √∫nica para todos los campos personalizados de Jira y puede generar definiciones de clase para cada campo personalizado que necesite. <br><br><pre><code class="php hljs">$Issue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>); $Issue-&gt;addComment(<span class="hljs-string"><span class="hljs-string">'Sample comment text'</span></span>); $Issue-&gt;attachFile(<span class="hljs-string"><span class="hljs-string">'kitten.jpeg'</span></span>, <span class="hljs-string"><span class="hljs-string">'pretty!'</span></span>, <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Issue-&gt;getStatus()-&gt;getName() === <span class="hljs-string"><span class="hljs-string">'Open'</span></span>) { $Issue-&gt;step(<span class="hljs-string"><span class="hljs-string">'In Progress'</span></span>); }</code> </pre> <br><pre> <code class="php hljs">$DeveloperField = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Example\CustomFields\Developer($Issue); $DeveloperField-&gt;setValue(<span class="hljs-string"><span class="hljs-string">'username'</span></span>)-&gt;save();</code> </pre><br><pre> <code class="php hljs">$User = \Badoo\Jira\User::get(<span class="hljs-string"><span class="hljs-string">'username'</span></span>); $User-&gt;watchIssue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>); $User-&gt;assign(<span class="hljs-string"><span class="hljs-string">'SMPL-2'</span></span>);</code> </pre><br>  Gracias a esto, la interacci√≥n con la API de PHP se vuelve m√°s simple y m√°s conveniente, y la documentaci√≥n de su Jira se mueve directamente al c√≥digo, lo que le permite utilizar la autocompletaci√≥n en el IDE para muchas acciones est√°ndar. <br><br>  Pero lo primero es lo primero. <br><br><h2>  Caracter√≠sticas de la API que encontramos </h2><br>  Cuando comenzamos a usar activamente la API de Jira, solo estaba disponible a trav√©s del protocolo SOAP.  Su versi√≥n REST apareci√≥ m√°s tarde, y est√°bamos entre sus primeros usuarios.  En ese momento, hab√≠a muy pocos clientes REST disponibles p√∫blicamente escritos en PHP.  Fue a√∫n m√°s dif√≠cil encontrar algo que pudiera integrarse f√°cilmente en nuestra base de c√≥digo, pasando gradualmente de SOAP a REST.  As√≠ que no ten√≠amos otra opci√≥n: decidimos continuar desarrollando nuestro propio cliente. <br><br>  As√≠ que vivimos arrastrando y soltando todo tipo de hacks y muletas del cliente SOAP y adquiriendo otros nuevos debido a las peculiaridades de REST.  Como resultado, hemos desarrollado algunas clases muy audaces con un mont√≥n de c√≥digo duplicado, y existe la necesidad de limpiar este desastre. <br><br>  Los campos personalizados siempre han sido el lugar m√°s doloroso para nosotros: tenemos m√°s de 300 de ellos (al momento de escribir este art√≠culo - 338), y este n√∫mero est√° creciendo lentamente. <br><br><h3>  Extra√±os mensajes de error </h3><br>  A lo largo de la larga historia de interacci√≥n con la API, hemos visto muchas cosas diferentes.  La mayor√≠a de los mensajes de error son adecuados, pero hay aquellos para los que tienes que esforzarte mucho. <br><br>  Por ejemplo, si Jira reconoce de repente un robot en su usuario, comenzar√° a mostrarle un captcha.  En este caso, al acceder a la API, ignora descaradamente el encabezado <i>Accept-Encoding: application / json</i> y le proporciona HTML.  Naturalmente, el cliente que est√° esperando a JSON puede no estar listo para este "hola". <br><br>  Y aqu√≠ hay un ejemplo de trabajo con un campo personalizado: <br><br><img width="600" src="https://habrastorage.org/webt/sc/xt/xe/scxtxekex33vyguynhxr9hjpp_m.png"><br><br>  Cuando escribe c√≥digo y "prueba en este momento" lo est√° probando, es muy f√°cil entender que customfield_12664 es <b>Desarrolladores</b> .  Y si tal error se produce en alg√∫n lugar de la producci√≥n (por ejemplo, porque alguien cambi√≥ la configuraci√≥n y cambi√≥ la lista de valores aceptables para el campo Seleccionar), a menudo la √∫nica forma de identificar el campo es ingresar a Jira y encontrar el nombre desde all√≠.  Adem√°s, en su interfaz, los ID no se muestran, solo los nombres. <br><br>  Resulta que cuando desea averiguar el nombre del campo que condujo al error y corregir su configuraci√≥n, puede hacerlo a trav√©s de una solicitud a la API, o utilizando otros m√©todos no obvios: hurgando en el c√≥digo fuente de la p√°gina, abriendo la configuraci√≥n de un campo arbitrario y corrigiendo la URL en la barra de direcciones, etc. Este proceso no puede llamarse conveniente, y cada vez que lleva demasiado tiempo realizar una tarea tan simple. <br><br>  Pero los nombres de campo oscuros no se limitan a los problemas.  As√≠ es como se ve la interacci√≥n con la API si comete un error en la estructura de datos para actualizar el campo: <br><br><img width="600" src="https://habrastorage.org/webt/v_/ab/jo/v_abjobegilkmh8tjdoh2sigius.png"><br><img width="600" src="https://habrastorage.org/webt/pr/nr/fg/prnrfg7hbhxtge1pwejzmuvrgsq.png"><br><br><h3>  Muchos formatos de datos diferentes </h3><br>  Y no olvide que actualizar campos de diferentes tipos requiere diferentes estructuras de datos. <br><br><pre> <code class="php hljs">$Jira-&gt;issue()-&gt;edit( <span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'customfield_10200'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'denkoren'</span></span>], <span class="hljs-string"><span class="hljs-string">'customfield_10300'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'PHP'</span></span>], <span class="hljs-string"><span class="hljs-string">'customfield_10400'</span></span> =&gt; [[<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Android'</span></span>], [<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'iOS'</span></span>]], <span class="hljs-string"><span class="hljs-string">'security'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">100500</span></span>], <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Just text'</span></span>, ], );</code> </pre><br>  Las respuestas API para ellos son, por supuesto, tambi√©n diferentes. <br><br>  Es posible tener esto en cuenta solo si trabaja constantemente con la API de Jira y no se distrae durante mucho tiempo resolviendo otros problemas.  De lo contrario, estas caracter√≠sticas se quedan sin memoria en un par de semanas.  Adem√°s, debe recordar el tipo de campo que necesita para "alimentarlo" con la estructura correcta.  Cuando tiene cientos de campos personalizados, a menudo tiene que buscar en el c√≥digo d√≥nde todav√≠a se usaba o subir al panel de administraci√≥n de Jira. <br><br>  Antes de escribir a nuestro cliente, Stack Overflow y Atlassian Community eran mis mejores amigos con respecto a la actualizaci√≥n de campos personalizados.  Ahora, esta informaci√≥n se busca en Google f√°cil y r√°pidamente, pero cambiamos a la API REST cuando a√∫n era bastante nueva y estaba desarrollada activamente: tard√≥ diez minutos en encontrar una solicitud de cURL adecuada en Google, y luego tuvo que analizar este grupo de corchetes con los ojos y convertir en la estructura correcta para PHP, que a menudo no funcionaba en el primer intento. <br><br>  En general, la interacci√≥n con los campos personalizados es el proceso cuya reorganizaci√≥n se requiri√≥ en primer lugar. <br><br><h2>  ¬øEn qu√© consiste el cliente? </h2><br><h3>  Clases para trabajar con campos personalizados. </h3><br>  En primer lugar, quer√≠amos deshacernos de recordar las estructuras de datos para interactuar con la API y obtener nombres de campo legibles cuando ocurr√≠an errores. <br><br>  Como resultado, creamos una jerarqu√≠a de clase √∫nica para todos los campos personalizados.  Result√≥ tres capas: <br><br><ol><li>  Un padre abstracto com√∫n para todos: <b>\ Badoo \ Jira \ CustomFields \ CustomField</b> . </li><li>  Por una clase abstracta para cada tipo de campo: <b>SelectField, UserField, TextField</b> , etc. </li><li>  Por clase para cada campo espec√≠fico: por ejemplo, <b>Desarrollador</b> o <b>Revisor</b> . </li></ol><br>  Estas clases se pueden escribir de forma independiente o se pueden crear autom√°ticamente utilizando un generador de scripts especial (volveremos a ello). <br><img src="https://habrastorage.org/webt/1p/zz/eu/1pzzeucvu78qctdq-12elpstlkm.png"><br><br>  Debido a esta estructura, para ense√±arle al c√≥digo a actualizar el valor de su campo personalizado de tipo <b>Seleccionar lista (opci√≥n m√∫ltiple)</b> , es suficiente crear una clase PHP heredada de <b>SelectField</b> .  De hecho, cada campo Jira personalizado se convierte en un ActiveRecord regular en c√≥digo PHP. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> \<span class="hljs-title"><span class="hljs-title">Example</span></span>\<span class="hljs-title"><span class="hljs-title">CustomFields</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Developer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFields</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleUserField</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ID = <span class="hljs-string"><span class="hljs-string">'customfield_10200'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NAME = <span class="hljs-string"><span class="hljs-string">'Developer'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ,  ,  !</span></span></code> </pre><br><br>  En la misma clase, almacenamos informaci√≥n sobre el campo: de forma predeterminada, esta es una ID, el nombre del campo y una lista de valores disponibles, si es limitada (por ejemplo, para <b>Casilla</b> de <b>verificaci√≥n</b> y <b>Seleccionar</b> ). <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplos de campos en la interfaz de Jira y su clase correspondiente.</b> <div class="spoiler_text"><img width="500" src="https://habrastorage.org/webt/ea/dd/bf/eaddbfm0cphjpqionp16hqstxg0.png"><br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IssueFor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFields</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleSelectField</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ID = <span class="hljs-string"><span class="hljs-string">'customfield_10662'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NAME = <span class="hljs-string"><span class="hljs-string">'Issue for'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Available field values. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_BI = <span class="hljs-string"><span class="hljs-string">'BI'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_C_C = <span class="hljs-string"><span class="hljs-string">'C\C++'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_HTML_CSS = <span class="hljs-string"><span class="hljs-string">'HTML\CSS'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_JS = <span class="hljs-string"><span class="hljs-string">'JS'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_OTHER = <span class="hljs-string"><span class="hljs-string">'Other'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_PHP = <span class="hljs-string"><span class="hljs-string">'PHP'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_TRANSLATION = <span class="hljs-string"><span class="hljs-string">'Translation'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUES = [ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_BI, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_C_C, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_HTML_CSS, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_JS, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_OTHER, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_PHP, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_TRANSLATION, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemsList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::VALUES; } }</code> </pre><br></div></div><br>  Resulta que ese tipo de documentaci√≥n es para su Jira, ubicado directamente en el c√≥digo PHP.  Cuando est√° tan cerca, es muy conveniente y acelera significativamente el desarrollo, al tiempo que reduce la cantidad de errores. <br><br>  Adem√°s, los mensajes de error se vuelven m√°s claros: en lugar de no decir nada, <b>'customfield_12664'</b> falla, por ejemplo, algo como esto: <br><br><pre> <code class="plaintext hljs">Uncaught Badoo\Jira\Exception\CustomField: User 'asdkljfh' not found in Jira. Can't change 'Developer' field value.</code> </pre><br><h3>  Clases para trabajar con objetos del sistema. </h3><br>  Jira tiene muchos datos con una estructura compleja: por ejemplo, los campos <b>del</b> sistema de <b>estado</b> y <b>seguridad</b> , enlaces entre tareas, usuarios, versiones, archivos adjuntos (archivos). <br><br>  Tambi√©n los envolvimos en clases: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $Status = $Issue-&gt;getStatus(); $Status-&gt;getName(); $Status-&gt;getId();</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// changelog  $History = \Badoo\Jira\Issue\History::forIssue('SMPL-1'); $seconds_in_status = $History-&gt;getTimeInStatus('Open');</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  Jira $User = new \Badoo\Jira\User('sampleuser'); $User-&gt;assign('SMPL-1');</span></span></code> </pre><br>  Tales envoltorios le dan a su IDE la capacidad de decir qu√© datos est√°n disponibles y le permiten formalizar estrictamente las interfaces de funci√≥n en su c√≥digo.  Utilizamos activamente declaraciones de tipo, casi siempre nos permite ver un error incluso mientras escribimos c√≥digo gracias al resaltado del IDE.  Y si a√∫n se perdi√≥ el error, saldr√° exactamente en el lugar donde apareci√≥ por primera vez, y no donde finalmente dej√≥ caer su c√≥digo. <br><br>  Todav√≠a hay m√©todos est√°ticos que le permiten obtener r√°pidamente un objeto por alg√∫n criterio: <br><br><pre> <code class="php hljs">$users = \Badoo\Jira\User::search(<span class="hljs-string"><span class="hljs-string">'&lt;pattern&gt;'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    login, email  display name $Version = \Badoo\Jira\Version::byName('&lt;project&gt;', '&lt;version name&gt;'); //        $components = \Badoo\Jira\Component::forProject('&lt;project&gt;'); //     </span></span></code> </pre><br>  Estos m√©todos obedecen las reglas generales para que sean f√°ciles de encontrar: <br><ul><li>  <i>:: search ()</i> , si necesita buscar objetos por varios campos: \ Badoo \ Jira \ Issue :: search () busca tareas utilizando JQL, donde puede especificar muchos criterios de b√∫squeda, y \ Badoo \ Jira \ User :: search () busca al usuario al mismo tiempo por <i>'nombre'</i> (inicio de sesi√≥n), <i>'correo electr√≥nico'</i> y <i>'displayName'</i> (el nombre que se representa en la web); </li><li>  <i>:: by * ()</i> , si necesita obtener el objeto no por ID, sino por alg√∫n otro criterio: \ Badoo \ Jira \ User :: byEmail () est√° buscando un usuario por su direcci√≥n de correo electr√≥nico; </li><li>  <i>:: for * ()</i> busca todos los objetos asociados con algo: \ Badoo \ Jira \ Version :: forProject <br>  da todas las versiones de un proyecto espec√≠fico; </li><li>  <i>:: fromStdClass ()</i> crear√° un objeto a partir de datos en bruto que tenga una estructura adecuada, pero no recibida de la API, pero, por ejemplo, del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">webhook</a> : en el cuerpo de la solicitud POST, Jira env√≠a a JSON con informaci√≥n diferente sobre el evento, incluido el cuerpo de la tarea incluyendo todos los campos  Seg√∫n estos datos, puede crear el objeto \ Badoo \ Jira \ Issue y usarlo como de costumbre. </li></ul><br><h3>  Clase \ Badoo \ Jira \ Issue </h3><br>  Me parece que la siguiente captura de pantalla de PhpStorm es bastante elocuente en s√≠ misma: <br><br><img width="600" src="https://habrastorage.org/webt/ox/_m/jz/ox_mjzztnjrjtzexiudykocfkwc.png"><br><br>  En esencia, el objeto <b>\ Badoo \ Jira \ Issue</b> une todo lo descrito anteriormente en un solo sistema.  Almacena toda la informaci√≥n sobre la tarea, tiene m√©todos para acceder r√°pidamente a los datos m√°s utilizados, transferir tareas entre estados, etc. <br><br>  Para crear un objeto en el caso m√°s simple, es suficiente conocer solo la clave de la tarea. <br><br><div class="spoiler">  <b class="spoiler_title">Crea un objeto con solo una tecla de tarea en tu bolsillo</b> <div class="spoiler_text"><pre> <code class="php hljs">$Issue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>);</code> </pre><br></div></div><br>  Tambi√©n puede usar cualquier conjunto de datos fragmentado.  Por ejemplo, la informaci√≥n de enlace entre las tareas que llegan de la API contiene solo unos pocos campos: id, resumen, estado, prioridad y tipo de problema.  <b>\ Badoo \ Jira \ Issue le</b> permite recopilar un objeto de estos datos para que pueda devolverse inmediatamente y, por lo dem√°s, acceder a la API. <br><br><div class="spoiler">  <b class="spoiler_title">Crear un objeto, almacenando en cach√© valores para algunos campos</b> <div class="spoiler_text"><pre> <code class="php hljs"> $IssueFromLink = \Badoo\Jira\Issue::fromStdClass( $LinkInfo, [ <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'summary'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'priority'</span></span>, <span class="hljs-string"><span class="hljs-string">'issuetype'</span></span>, ] );</code> </pre><br></div></div><br>  Esto se logra mediante la inicializaci√≥n diferida y el almacenamiento en cach√© de datos en el c√≥digo.  Este enfoque es especialmente conveniente porque solo puede intercambiar objetos <b>\ Badoo \ Jira \ Issue</b> en su c√≥digo, independientemente del conjunto de campos con los que se crearon. <br><br><div class="spoiler">  <b class="spoiler_title">Obtenga los datos de tareas que faltan</b> <div class="spoiler_text"><pre> <code class="php hljs">$IssueFromLink-&gt;getSummary(); <span class="hljs-comment"><span class="hljs-comment">//    API,    $IssueFromLink-&gt;getDescription(); //  API    description</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">C√≥mo vamos a la API</b> <div class="spoiler_text">  En la API de Jira, es posible obtener no todos los campos para una tarea, sino solo los campos que se necesitan actualmente: por ejemplo, solo clave y resumen.  Sin embargo, intencionalmente no vamos a Jira por un solo campo en el captador.  En el ejemplo anterior, getDescription () actualizar√° la informaci√≥n sobre todos los campos a la vez.  Como <b>\ Badoo \ Jira \ Issue</b> no tiene la menor idea de qu√© m√°s necesita a continuaci√≥n, es m√°s rentable obtener todo de la API de inmediato, ya que fuimos all√≠ de todos modos.  S√≠, la consulta "obtener solo una descripci√≥n" y la consulta "obtener todos los campos de forma predeterminada" durante un par de cientos de tickets toma diferentes tiempos, pero para uno esta diferencia no es tan notable. <br><br><pre> <code class="plaintext hljs">//Time for single field: 0.40271635055542 (second) //Time for all default fields: 0.84159119129181 (second)</code> </pre><br>  Seg√∫n las cifras, est√° claro que cuando se reciben solo tres campos (uno en la solicitud), es m√°s rentable obtener todo de una vez, en lugar de ir a la API para cada uno.  El resultado de esta medici√≥n, de hecho, depende de la configuraci√≥n de Jira y del servidor en el que se ejecuta.  De tarea en tarea y de medici√≥n en medici√≥n, los n√∫meros cambian y el <b>tiempo para todos los campos predeterminados</b> resulta ser establemente menor que tres <b>veces para un solo campo</b> y, a menudo, incluso menos de dos. <br><br>  Sin embargo, cuando se trabaja con una gran cantidad de tareas, la diferencia se puede medir en segundos.  Por lo tanto, cuando sabe que solo necesita clave y descripci√≥n para 500 tickets, la capacidad de obtenerlos con una consulta efectiva permanece en los <b>m√©todos</b> <b>\ Badoo \ Jira \ Issue :: search ()</b> y <b>\ Badoo \ Jira \ Issue :: byKeys ()</b> . <br><br></div></div><br>  <b>\ Badoo \ Jira \ Issue</b> - generalmente sobre tareas en algunos Jira abstractos.  Pero su (como la nuestra) Jira no es abstracta: tiene un conjunto muy espec√≠fico de campos personalizados y su propio flujo de trabajo.  Usas algunos de los campos y transiciones a menudo, as√≠ que no es muy conveniente ir tras ellos en todos los sentidos.  Por lo tanto, <b>\ Badoo \ Jira \ Issue</b> se puede ampliar f√°cilmente con sus propios m√©todos espec√≠ficos para una configuraci√≥n espec√≠fica de Jira. <br><br><div class="spoiler">  <b class="spoiler_title">Un ejemplo de extensi√≥n de clase mediante un m√©todo para obtener r√°pidamente un campo personalizado</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> \<span class="hljs-title"><span class="hljs-title">Deploy</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Issue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Issue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ /** * Get 'Developer' custom field as object */ function getDeveloperField() : \Deploy\CustomFields\Developer { return $this-&gt;getCustomField(\Deploy\CustomFields\Developer::class); } // ... }</span></span></code> </pre><br></div></div><br><br><h3>  Emitir solicitud de creaci√≥n </h3><br>  Crear una tarea en Jira es un procedimiento bastante complicado.  Cuando hace esto a trav√©s de la interfaz web, se le muestra una pantalla especial (Crear pantalla) con un conjunto de campos.  Algunos de ellos los puede completar simplemente porque lo desee, y otros est√°n marcados como obligatorios.  Al mismo tiempo, Crear pantalla puede ser √∫nico para cada proyecto e incluso para diferentes tipos de tareas en un proyecto.  Por lo tanto, hay todo tipo de restricciones en los valores de campo y en la posibilidad misma de establecer el valor de campo en el proceso de creaci√≥n de la tarea. <br><br>  Lo m√°s desagradable para los desarrolladores en esta situaci√≥n es que estas restricciones se aplican a la API.  Este √∫ltimo tiene una solicitud especial ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">create-meta ha estado</a> disponible en la API REST desde la versi√≥n 5.0), con la que puede obtener una lista de configuraciones de campo disponibles al crear una tarea.  Sin embargo, un desarrollador que necesita "hacer algo simple en este momento" probablemente no se molestar√° con esto. <br><br>  Como resultado, sucedi√≥ as√≠: dado que la solicitud para crear una tarea puede ser bastante grande, a menudo le agregamos datos gradualmente y recibimos un error cuando intentamos enviar todo a Jira.  Despu√©s de eso, tuve que buscar en el c√≥digo todos los lugares donde algo cambi√≥ en la solicitud, y durante un largo y tedioso intento de comprender qu√© sali√≥ mal exactamente. <br><br>  Por lo tanto, hicimos <b>\ Badoo \ Jira \ Issue \ CreateRequest</b> .  Le permite ver el error antes, justo en el lugar donde est√° tratando de hacer algo mal: dele al campo alg√∫n tipo de valor curvo o cambie el campo que no est√° disponible.  Por ejemplo, si intenta especificar un componente que no existe en el proyecto, la excepci√≥n se bloquear√° en el lugar donde lo hizo y no donde finalmente envi√≥ la solicitud a la API. <br><br><div class="spoiler">  <b class="spoiler_title">El flujo de trabajo con CreateRequest se parece a esto</b> <div class="spoiler_text"><pre> <code class="php hljs">$Request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue\CreateRequest(<span class="hljs-string"><span class="hljs-string">'DD'</span></span>, <span class="hljs-string"><span class="hljs-string">'Task'</span></span>, $Client); $Request -&gt;setSummary(<span class="hljs-string"><span class="hljs-string">'summary'</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'description'</span></span>) -&gt;setFieldValue(<span class="hljs-string"><span class="hljs-string">'For QA'</span></span>, <span class="hljs-string"><span class="hljs-string">'custom field with some comments for QA who will check the issue'</span></span>); $Request-&gt;send();</code> </pre><br></div></div><br><h3>  Trabaja con API directamente </h3><br>  El conjunto de clases descrito anteriormente cubre la mayor√≠a de las necesidades.  Sin embargo, somos conscientes de que la mayor√≠a est√° lejos de todo.  Por lo tanto, tambi√©n tenemos un peque√±o cliente para trabajar directamente con la API: <b>\ Badoo \ Jira \ REST \ Client</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Caso de uso del cliente</b> <div class="spoiler_text"><pre> <code class="php hljs">$Jira = \Badoo\Jira\REST\Client::instance(); $Jira-&gt;setJiraUrl(<span class="hljs-string"><span class="hljs-string">'https://jira.example.com/'</span></span>); $Jira-&gt;setAuth(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) $IssueInfo = $Jira-&gt;issue()-&gt;get(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>);</code> </pre><br></div></div><br><h2>  Generador de clases para campos personalizados. </h2><br>  Para facilitar el trabajo con campos personalizados, cada campo debe tener su propia clase en el c√≥digo.  Los creamos nosotros mismos manualmente seg√∫n sea necesario, pero antes de publicar el cliente decidimos que este enfoque podr√≠a no ser muy conveniente para los nuevos usuarios.  Por lo tanto, creamos un generador especial que puede ir a la API de Jira para obtener una lista de campos personalizados y crear clases de plantillas para los tipos de campo conocidos. <br><br>  Creemos que para la mayor√≠a de las tareas es suficiente usar el script <b>bin / generate</b> CLI de nuestro repositorio.  Puede pedirle que cuente sobre s√≠ mismo a trav√©s de la opci√≥n <b>--help / -h</b> : <br><br><pre> <code class="bash hljs">./bin/generate --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre><br>  En el caso m√°s simple, para la generaci√≥n es suficiente especificar la URL de su Jira, el usuario, su contrase√±a, el espacio de nombres para las clases y el directorio donde colocar el c√≥digo: <br><br><pre> <code class="bash hljs">./bin/generate -u user -p password --jira-url https://jira.mlan --target-dir custom-fields --namespace CustomFields</code> </pre><br>  Tambi√©n implementamos la capacidad de agregar nuestras propias plantillas y generar clases para campos individuales.  Esto se puede encontrar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> . <br><br><h2>  Conclusi√≥n </h2><br>  Nos gusta lo que tenemos.  Con este concepto, nuestras propias clases para campos personalizados, envoltorios para estados, versiones, usuarios, etc., hemos estado viviendo durante m√°s de un a√±o y nos sentimos muy bien.  Antes de publicar el c√≥digo, incluso ampliamos la funcionalidad y agregamos cosas maravillosas que no llegaron a sus manos durante mucho tiempo para usar el cliente, fue a√∫n m√°s conveniente: por ejemplo, agregamos la capacidad de actualizar varios campos en Issue en una solicitud y escribimos un generador de clases para campos personalizados. <br><br>  En nuestra opini√≥n, result√≥ ser algo bueno, que definitivamente debe entenderse si se adapta a sus tareas y requisitos.  Debajo de la nuestra, simplemente en forma. <br><br>  Enlace de nuevo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/badoo/jira-client</a> . <br><br>  Gracias por leer hasta el final.  Esperamos que este c√≥digo ahora se beneficie y ahorre tiempo no solo para nosotros. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475840/">https://habr.com/ru/post/475840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475830/index.html">Consola retro port√°til de bricolaje</a></li>
<li><a href="../475832/index.html">Las expresiones de medios CSS son m√°s que ancho m√°ximo</a></li>
<li><a href="../475834/index.html">Scrum no te ayudar√°. Entendemos por qu√©</a></li>
<li><a href="../475836/index.html">Entrevista con Arthur Khachuyan: ¬øc√≥mo calcular un multimillonario en las redes sociales?</a></li>
<li><a href="../475838/index.html">CAMBIO de personas. O ... cambiar a las personas. Sobre c√≥mo "despegar" el proyecto de transformaci√≥n</a></li>
<li><a href="../475842/index.html">¬øReemplazar URL de acci√≥n y URI en tel√©fonos SIP o administrar a trav√©s de websockets?</a></li>
<li><a href="../475848/index.html">C√≥mo funciona la b√∫squeda Yandex.Market y qu√© suceder√° si uno de los servidores falla</a></li>
<li><a href="../475850/index.html">C√≥mo comenzar a desarrollar una carrera en TI, si a√∫n no tiene experiencia</a></li>
<li><a href="../475854/index.html">Grupos JDBC y manejo eficiente de archivos: Java mitap 3 de diciembre en San Petersburgo</a></li>
<li><a href="../475856/index.html">Google App Script, Mikrotik, Telegram y VPNBook comenzaron a tocar un cuarteto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>