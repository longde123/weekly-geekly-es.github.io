<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⭕️ 🕝 👢 DIY KVM IP 3.0 👐🏽 🌳 ☪️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es la tercera variación del tema IP KVM, esta vez el concepto ha sido completamente revisado, comencemos a construir algo nuevo. Habrá muchas cos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY KVM IP 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/406059/"> Esta es la tercera variación del tema IP KVM, esta vez el concepto ha sido completamente revisado, comencemos a construir algo nuevo.  Habrá muchas cosas interesantes, no salgas de la pantalla.  Aparecerá otro dispositivo inusual, descartaremos casi todos los componentes antiguos, volveremos a nuestro arduino nativo y haremos de hacker. <br><br>  Para aquellos que se acaban de unir, un resumen de episodios anteriores: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Primer articulo</a> <br>  Recolectó IP KVM en Arduino y Raspberry Pi, resultó costoso y con baja calidad de video. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Segundo articulo</a> <br>  OrangePI y Atmega16u2, aprendieron a bajo precio, pero la calidad de imagen sigue siendo desagradable. </li></ul><br>  Y finalmente, en este artículo, se solucionarán todas las desventajas de las anteriores.  Se hará especial hincapié en la reducción máxima en el costo de los componentes. <br><a name="habracut"></a><br>  <b>Por tradición, consideramos los componentes del dispositivo ensamblado:</b> <br><br>  <b>1.</b> Nuestro viejo amigo Atmega16u2: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d38/32f/4a0/d3832f4a098f4cf8abe96103b11496a3.jpg"></div><br>  Este es el único componente que se moverá de los artículos anteriores. <br><br>  <b>2. El</b> notorio ESP8266, en este caso ESP8266-12e: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/d3/d9/59d3d9e494103245224131.jpeg"></div><br>  Puede usar otra versión del ESP8266, solo debe tener en cuenta el número y la ubicación de los puertos. <br><br>  <b>3.</b> Y, de hecho, el héroe de la ocasión LKV373A <br><br><img src="https://habrastorage.org/webt/59/d3/da/59d3da94466d8417530057.jpeg"><br><br>  Gracias a este dispositivo, fue posible transmitir video a través de una red local con alta <br>  resolución hasta full-HD. <br><br><h3>  El plan de acción es el siguiente: </h3><br><ol><li>  Ocultar y buscar: Estamos buscando LKV373A donde se escondió en la red bajo qué dirección IP </li><li>  Juego de hackers: complete el firmware, restablezca las contraseñas y configure LKV373A </li><li>  Hacer nuevos amigos: ESP8266, Arduino IDE y fotos divertidas </li><li>  El final de la celebración.  Conectamos todos los componentes y transmitimos pulsaciones de teclas a través de telnet </li></ol><br><h3>  Fondo LKV373A </h3><br>  ¡Entonces comencemos!  Dispositivo extensor LKV373A o HDMI para capturar imágenes directamente desde el puerto hdmi y transmitir a la red local, estos dispositivos también se denominan extensores hdmi.  Según lo planeado por los fabricantes, un conjunto de tales dispositivos debe consistir en un transmisor (transmisor) y un receptor (receptor), designación TX y RX, respectivamente.  Deben usarse, probablemente, para brindarle al fabricante más ganancias, solo en pares.  Pero había un hombre, bajo el apodo de Danman, aquí hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> a su blog, que estaba interesado en cómo funciona.  Abrió Wireshark, olfateó el tráfico transmitido por el dispositivo TX, ¿qué resultó ser? <br><br>  La transmisión de video se transmite sin cifrado, y con VLC Player, puede verla sin demasiado esfuerzo.  Pero no se detuvo allí, "sintió": sacó la interfaz web, TTL, telnet e incluso sacó el firmware con el programador.  Él habló sobre esto en detalle en su blog.  El firmware que nos interesa en primer lugar también se cargó allí: IPTV_TX_PKG_v4_0_0_0_20160427.PKG.  En este firmware, la interfaz web con configuraciones avanzadas, y no como la estándar, solo tiene el botón de actualización.  Además, este firmware tiene un telnet con muchos comandos para configurar.  Es con este firmware que reconfiguramos el extensor HDMI para nuestras tareas.  Publiqué el firmware y todo lo que necesitaba en github, aquí está el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> , lo necesitaremos más tarde, pero por ahora terminamos con la teoría.  Pasemos a practicar. <br><br><h2>  Transmisor </h2><br><h3>  Estamos buscando LKV373A en la red </h3><br>  Caí en manos del mismo extensor que Danman (y).  ¡Todo lo que se describirá a continuación es adecuado específicamente para el extensor HDMI LKV373A versión V3.0! <br><br>  Conectamos el LKV373A a la red local, enciende la alimentación.  Ahora intentemos asegurarnos de que el dispositivo sea visible en la red <code>ping 192.168.1.238</code> . <br><br>  192.168.1.238 es la dirección IP predeterminada.  Si el extensor no cambia la dirección del firmware anterior, independientemente de si hay un servidor DHCP en la red o no.  Las versiones de firmware más nuevas usan IP de manera predeterminada solo si el dispositivo no pudo obtener una dirección de DHCP.  Si recibió una respuesta al ping, continúe.  De lo contrario, no se desespere, intente conectar el extensor directamente al puerto LAN de la computadora y use el sniffer. <br><br><h3>  Intermitente </h3><br>  HDMI Extender encontrado, pasar al firmware.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vayamos</a> al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> y descarguemos todo lo que se presenta allí.  Ahora abra la interfaz web del extensor a través de un navegador y vea la siguiente imagen: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d91fbcc37298629734.png"><br><br>  Haga clic en "Examinar ...", seleccione el firmware, un archivo llamado IPTV_TX_PKG_v4_0_0_0_20160427.PKG, y haga clic en "Actualizar".  Tadam!  El firmware está completo, ahora conéctese al LKV373A por telnet para restablecer la contraseña. <br><br>  El comando para conectarse se parecerá a Telnet 192.168.1.238 9999, donde 9999 es el puerto para conectarse.  CEP advierte: la dirección obtenida de DHCP se puede encontrar utilizando un escáner de red. <br><br><h3>  Conectarse a través de telnet </h3><br>  Al conectarse, debería aparecer el siguiente mensaje: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;</code> </pre><br>  Escribimos <code>list</code> .  En respuesta, obtenemos una lista de comandos: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;list set_group_id get_group_id set_dhcp get_dhcp set_uart_baudrate get_uart_baudrate set_static_ip get_static_ip set_mac_address get_mac_address get_lan_status get_hdcp get_video_lock get_ip_config set_session_key set_device_name get_device_name set_video_bitrate get_video_bitrate set_downscale_mode get_downscale_mode set_video_out_mode get_video_out_mode set_streaming_mode get_streaming_mode get_fw_version get_company_id factory_reset reboot list <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Para restablecer todas las configuraciones y contraseñas, use el comando <code>factory_reset</code> .  Escribimos un comando, presionamos enter y obtenemos esta imagen: <br><br><pre> <code class="bash hljs">input&gt;factory_reset Processing factory reset! System will reboot after few seconds! Connection closed by foreign host.</code> </pre><br><h3>  Interfaz web </h3><br>  Ahora podemos configurar el dispositivo como lo necesitemos.  Vayamos a la interfaz web.  Utilizamos el inicio de sesión estándar: contraseña de administrador: 123456 y aquí está, la interfaz web "codiciada" con configuraciones adicionales: <br><br><img src="https://habrastorage.org/webt/59/d4/e7/59d4e71a2b694981418223.png"><br><br>  Aunque las oportunidades en la interfaz web han aumentado, aún no son suficientes para nuestros propósitos.  Particularmente faltan configuraciones más libres en términos de transmisión, está codificado, lejos de ser el más conveniente, una lista de direcciones IP a las que puede transmitir.  Por supuesto, hay una multidifusión, pero es mejor dejarla para televisión.  Se pueden eludir las limitaciones, más sobre eso más adelante. <br><br>  Entonces, encontraron el dispositivo en la red, lo enrollaron y restablecieron las contraseñas.  El transmisor está casi listo para pasar al receptor. <br><br><h2>  Receptor </h2><br>  Decidamos el dispositivo bajo el control de qué sistema operativo transmitiremos la transmisión.  No creo que experimentes el tormento de elección, solo hay dos opciones: <br><br><h4>  Ventanas </h4><br>  Para Windows, probé varios jugadores, pero los resultados fueron más o menos.  Al capturar y luego reproducir una transmisión de video, aparece un retraso, que depende principalmente del reproductor que reproduce la transmisión.  En varios jugadores, el retraso varió de un segundo a cinco o más.  Lo mejor de todo, en Windows, VLC Player demostró ser. <br><br>  Vayamos a los negocios.  Inicie VLC Player, desde la parte superior en el menú desplegable "Medios", seleccione "Abrir URL ..." en el campo de dirección de red, escriba <code>udp://@:5004</code> , ponga un toque en la casilla de verificación "Mostrar configuración avanzada" y coloque su valor en el campo "Almacenamiento en caché", Este parámetro se determina individualmente.  Cuanto menor sea el valor en este campo, menor será el retraso, pero un valor demasiado pequeño puede conducir a "artefactos" y caídas de trama, todo dependerá de la infraestructura de red local.  Los mejores resultados que pude lograr fueron un retraso de aproximadamente un segundo.  En Linux, los resultados fueron mucho mejores alrededor de 200-300 milisegundos. <br><br><h4>  Linux </h4><br>  Como muestra la práctica, los mejores resultados se obtienen utilizando una combinación de programas socat y mplayer.  Ubuntu está instalado en mi computadora, por lo que el comando para instalar socat se verá así: <br><br><pre> <code class="bash hljs">sudo apt-get install socat</code> </pre> <br>  Mplayer se instala de manera similar: <br><br><pre> <code class="bash hljs">sudo apt-get install mplayer</code> </pre> <br>  Bueno, y sigue el consejo de Danman: <br><br><pre> <code class="bash hljs">sudo iptables -t raw -A PREROUTING -p udp -m length --length 28 -j DROP</code> </pre> <br>  Este comando es necesario para eliminar los llamados "paquetes UDP de longitud cero" de la secuencia: paquetes de tamaño cero que "obstruyen" la secuencia. <br><br><h2>  Ir a vivir! </h2><br>  El receptor está listo, ¡puedes comenzar la transmisión!  Tecleamos la consola de la computadora receptora <code>ifconfig</code> o <code>ipconfig</code> , dependiendo del sistema operativo, recordamos la dirección IP del receptor y regresamos a la interfaz web del transmisor.  Abriremos la interfaz web, si ya la cerramos, ingrese el nombre de usuario, la contraseña y escriba directamente en la barra de direcciones del navegador: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">///dev/info.cgi?action=streaminfo&amp;udp=n&amp;rtp=y&amp;multicast=n&amp;unicast=y&amp;mcastaddr=&amp;port=5004</span></span></code> </pre> <br>  Sustituya sus direcciones IP y presione enter.  Esta línea configurará el extensor HDMI para transmitir el video capturado a la dirección IP elegida y apagará la multidifusión. <br><br>  Iniciamos VLC en Windows.  O en el terminal de Linux escribimos: <br><br><pre> <code class="bash hljs">socat UDP-RECV:5004 - | mplayer –</code> </pre> <br>  Abra Cadabra!  Y aquí está nuestro escritorio en vivo, o no el nuestro. <br><br><img src="https://habrastorage.org/webt/59/d3/f3/59d3f3c6a0c3b976110026.png"><br><br>  Entonces, con algunos métodos de hackers, forzamos al dispositivo a hacer lo que necesitábamos. <br><br>  Con la transferencia de video resuelta, vaya al control remoto. <br><br><h2>  Transferencia de control </h2><br><h3>  Selección de componentes </h3><br>  Porque  El costo de HDMI Extender es bajo, alrededor de 1800 rublos, y también debido a los comentarios que, dicen, un poco caros, presenté el eslogan: "¡Dale IP KVM por 2000 rublos!".  El tipo de cambio del rublo afectará en gran medida la fidelidad de esta declaración, pero no hablemos de cosas tristes, quiero creer en un futuro brillante.  Para lograr el objetivo necesitaremos elementos muy baratos, mi elección recayó en el ESP8266 como controlador, y de todos modos Atmega (16/8/32) u2 como actuador. <br><br>  Por supuesto, puede considerar a otros candidatos para el papel de un dispositivo ejecutivo (teclado).  El firmware que emula el teclado está escrito en la biblioteca LUFA (más o menos).  Esta biblioteca se puede utilizar para toda la familia AVR con conectividad USB.  De ello se deduce que, como un emulador de teclado, puede recoger, posiblemente más barato, microcontrolador.  Esta es información para consideración, pero ahora continuamos. <br><br>  Puede comprar el ESP8266 por aproximadamente 90 rublos, Atmega (16/8/32) u2 por aproximadamente 100 rublos, e incluso más barato si toma pequeños lotes de 5 o más piezas.  Por supuesto, se necesitarán consumibles para flejar microcontroladores, pero su costo es extremadamente pequeño, por lo que no los consideraré. <br><br><h2>  ESP8266 </h2><br>  Este milagro de la industria china no necesita presentación, por lo tanto, solo diré que en este proyecto utilicé la versión de ESP8266-12e.  Por supuesto, puede usar otras versiones, solo necesita considerar la ubicación de los puertos, porque  en esta versión, uno de los puertos ESP8266 se usa para encender el Atmega (8/16/32) u2, se indicará en el siguiente diagrama. <br><br><h3>  Firmware </h3><br>  El firmware para ESP8266 está escrito en el entorno ArduinoIDE, así que descarguemos la última versión <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">del sitio del desarrollador</a> .  A continuación, agregue soporte para ESP8266: la forma más fácil se puede encontrar en este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> .  En la misma página, puede encontrar mucha información útil, como la conexión de alimentación y TTL.  Para aquellos que no están actualizados, ¡el ESP8266 usa <b>estrictamente 3.3 voltios!</b>  Si no confía en sus propias habilidades, es mejor usar una opción de placa adaptada para USB, como NodeMCU: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d92043a87951368720.jpeg"><br><br>  Si todo está listo, abra ArduinoIDE y copie mi boceto: <br><br><div class="spoiler">  <b class="spoiler_title">Bosquejo</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;ESP8266WiFi.h&gt; #include &lt;WiFiClient.h&gt; #include &lt;ESP8266WebServer.h&gt; #include &lt;ESP8266mDNS.h&gt; #include &lt;SoftwareSerial.h&gt; #include &lt;HIDKeyboard.h&gt; #define MAX_SRV_CLIENTS <span class="hljs-number"><span class="hljs-number">3</span></span> HIDKeyboard keyboard; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* host = <span class="hljs-string"><span class="hljs-string">"esp8266"</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">""</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* pass = <span class="hljs-string"><span class="hljs-string">""</span></span>; int rebootdev = <span class="hljs-number"><span class="hljs-number">0</span></span>; int modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>; // ,    ESP8266    #define Port1 <span class="hljs-number"><span class="hljs-number">15</span></span> #define Port2 <span class="hljs-number"><span class="hljs-number">14</span></span> #define Port3 <span class="hljs-number"><span class="hljs-number">12</span></span> #define Port4 <span class="hljs-number"><span class="hljs-number">4</span></span> #define Port5 <span class="hljs-number"><span class="hljs-number">5</span></span> //  String ColorB1; String ColorB2; String ColorB3; String ColorB4; String ColorB5; ESP8266WebServer server(<span class="hljs-number"><span class="hljs-number">80</span></span>); WiFiClient serverClients[MAX_SRV_CLIENTS]; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* serverIndex = <span class="hljs-string"><span class="hljs-string">"&lt;form method='POST' action='/update' enctype='multipart/form-data'&gt;&lt;input type='file' name='update'&gt;&lt;input type='submit' value='Update'&gt;&lt;/form&gt;&lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>;//Update //    void handleRedirect(){ String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv='refresh' content='0;/'&gt;&lt;head&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } //  WI-FI void handleLogin(){ String msg = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasArg(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) &amp;&amp; server.hasArg(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) != NULL) &amp;&amp; (server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>) != NULL)){ String header = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 301 OK\r\r\nLocation: /\r\nCache-Control: no-cache\r\n\r\n"</span></span>; server.sendContent(header); String web_ssid = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>); String web_pass = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>); ssid = web_ssid.c_str();//       C pass = web_pass.c_str(); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID "</span></span>); Serial.println(ssid); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Pass "</span></span>); Serial.println(pass); WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); ESP.reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } msg = <span class="hljs-string"><span class="hljs-string">"Wrong ssid/password! try again."</span></span>; Serial.println(<span class="hljs-string"><span class="hljs-string">"Login Failed"</span></span>); } String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;form action='/' method='POST'&gt;Enter the access point name and password &lt;br&gt;"</span></span>;//  SSID   content += <span class="hljs-string"><span class="hljs-string">"Name AP:&lt;input type='text' name='SSID' placeholder='SSID'&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Password:&lt;input type='password' name='PASSAP' placeholder='password'&gt;&lt;br&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"&lt;input type='submit' name='SUBMIT' value='Connect to WI-FI'&gt;&lt;/form&gt;&lt;b&gt;&lt;font color='red'&gt;"</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"&lt;/font&gt;&lt;/b&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Firmware update &lt;a href='/upload'&gt;UPDATE&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } void handleNotFound(){ String message = <span class="hljs-string"><span class="hljs-string">"File Not Found\n\n"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"URI: "</span></span>; message += server.uri(); message += <span class="hljs-string"><span class="hljs-string">"\nMethod: "</span></span>; message += (server.method() == HTTP_GET)?<span class="hljs-string"><span class="hljs-string">"GET"</span></span>:<span class="hljs-string"><span class="hljs-string">"POST"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"\nArguments: "</span></span>; message += server.args(); message += <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;server.args(); i++){ message += <span class="hljs-string"><span class="hljs-string">" "</span></span> + server.argName(i) + <span class="hljs-string"><span class="hljs-string">": "</span></span> + server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(i) + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message); } //  int controlPin(int UsePin){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UsePin &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ int StPort; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(UsePin) == <span class="hljs-number"><span class="hljs-number">1</span></span>) {//      digitalWrite(UsePin, LOW); StPort = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(UsePin, HIGH); StPort = <span class="hljs-number"><span class="hljs-number">1</span></span>; } digitalWrite(LED_BUILTIN, HIGH);//    Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Port "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(UsePin); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"="</span></span>); Serial.println(StPort); delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); digitalWrite(LED_BUILTIN, LOW); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(StPort); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } //  int clientConnect(int Seconds){ Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"connection "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= Seconds; i++){ WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); digitalWrite(LED_BUILTIN, HIGH); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); Serial.println(); } void setup(void){ Serial.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); pinMode(LED_BUILTIN, OUTPUT); digitalWrite(LED_BUILTIN, HIGH); //uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">0</span></span>) WiFi.mode(WIFI_STA);//  modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>     Serial.println(); Serial.println(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) modeswitch = <span class="hljs-number"><span class="hljs-number">1</span></span>;//            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ Serial.println(<span class="hljs-string"><span class="hljs-string">""</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"WiFi switch AP mode"</span></span>); //WiFi.mode(WIFI_AP_STA);    +  .     WiFi.mode(WIFI_AP); WiFi.softAP(<span class="hljs-string"><span class="hljs-string">"TD"</span></span>, <span class="hljs-string"><span class="hljs-string">"testtest"</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"AP mode ip adress "</span></span>); Serial.println(WiFi.softAPIP()); digitalWrite(LED_BUILTIN, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client mod ip address: "</span></span>); Serial.println(WiFi.localIP()); digitalWrite(LED_BUILTIN, LOW); } MDNS.begin(host); pinMode(Port1, OUTPUT); pinMode(Port2, OUTPUT); pinMode(Port3, OUTPUT); pinMode(Port4, OUTPUT); pinMode(Port5, OUTPUT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ //     server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleLogin);//  (SSID)   //  server.on(<span class="hljs-string"><span class="hljs-string">"/upload"</span></span>, HTTP_GET, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, serverIndex); }); server.on(<span class="hljs-string"><span class="hljs-string">"/update"</span></span>, HTTP_POST, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); int uperror = Update.hasError(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"UPERR %u\nRebooting...\n"</span></span>,Update.hasError()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uperror == <span class="hljs-number"><span class="hljs-number">0</span></span>) server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Firmware update successfully &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Update error &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); ESP.restart(); },[](){ HTTPUpload&amp; upload = server.upload(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_START){ Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); WiFiUDP::stopAll(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update: %s\n"</span></span>, upload.filename.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (upload.filename == NULL) { Serial.printf(<span class="hljs-string"><span class="hljs-string">"ERROR: zero file size"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;html&gt; zero file size &lt;a href='/upload'&gt;BACK&lt;/a&gt;&lt;/html&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } uint32_t maxSketchSpace = (ESP.getFreeSketchSpace() - <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFF000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Update.begin(maxSketchSpace)){//start with <span class="hljs-built_in"><span class="hljs-built_in">max</span></span> available size Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_WRITE){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(upload.buf, upload.currentSize) != upload.currentSize){ Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_END){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)){ //<span class="hljs-literal"><span class="hljs-literal">true</span></span> to set the size to the current progress Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update Success: %u\nRebooting...\n"</span></span>, upload.totalSize); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Update.printError(Serial); } Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span>(); }); //  server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt1"</span></span>, [] { controlPin(Port1); handleRedirect();//    }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt2"</span></span>, [] { controlPin(Port2); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt3"</span></span>, [] { controlPin(Port3); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt4"</span></span>, [] { controlPin(Port4); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt5"</span></span>, [] { controlPin(Port5); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/reboot"</span></span>, [] { rebootdev = <span class="hljs-number"><span class="hljs-number">1</span></span>;//      handleRedirect(); }); server.onNotFound(handleNotFound);//    //server.begin(); MDNS.addService(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>); Serial.println(); Serial.println(<span class="hljs-string"><span class="hljs-string">"HTTP server started"</span></span>); } server.begin(); } void loop(void){ uint8_t i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>) server.handleClient(); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() != WL_CONNECTED) clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, HIGH);//  ATMEGA16U2 digitalWrite(LED_BUILTIN, LOW); } } WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); server.setNoDelay(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); server.begin(); keyboard.begin(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasClient()){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ //<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> free/disconnected spot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serverClients[i] || !serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i]) serverClients[i].stop(); serverClients[i] = server.available(); Serial.println(<span class="hljs-string"><span class="hljs-string">"New client: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(i); continue; } } //no free/disconnected spot so reject WiFiClient serverClient = server.available(); serverClient.stop(); } //check clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i].available()){ //get data from the telnet client <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> push it to the UART String bufkey; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(serverClients[i].available()) bufkey += (serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>());//     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bufkey != <span class="hljs-number"><span class="hljs-number">0</span></span>) { bufkey = bufkey.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);//  int key = bufkey.toInt();//   switch (key){ case <span class="hljs-number"><span class="hljs-number">277980</span></span>: keyboard.pressSpecialKey(F1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277981</span></span>: keyboard.pressSpecialKey(F2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277982</span></span>: keyboard.pressSpecialKey(F3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277983</span></span>: keyboard.pressSpecialKey(F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914953</span></span>: keyboard.pressSpecialKey(F5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914955</span></span>: keyboard.pressSpecialKey(F6); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914956</span></span>: keyboard.pressSpecialKey(F7); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914957</span></span>: keyboard.pressSpecialKey(F8); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915048</span></span>: keyboard.pressSpecialKey(F9); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915049</span></span>: keyboard.pressSpecialKey(F10); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915051</span></span>: keyboard.pressSpecialKey(F11); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915052</span></span>: keyboard.pressSpecialKey(F12); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">1310</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">130</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27</span></span>: keyboard.pressSpecialKey(ESCAPE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">8</span></span>: keyboard.pressSpecialKey(BACKSPACE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">9</span></span>: keyboard.pressSpecialKey(TAB); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">32</span></span>: keyboard.pressSpecialKey(SPACEBAR); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915012</span></span>: keyboard.pressSpecialKey(INSERT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914912</span></span>: keyboard.pressSpecialKey(HOME); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915312</span></span>: keyboard.pressSpecialKey(PAGEUP); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915212</span></span>: keyboard.pressSpecialKey(END); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915412</span></span>: keyboard.pressSpecialKey(PAGEDOWN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279167</span></span>: keyboard.pressSpecialKey(RIGHTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279168</span></span>: keyboard.pressSpecialKey(LEFTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279166</span></span>: keyboard.pressSpecialKey(DOWNARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279165</span></span>: keyboard.pressSpecialKey(UPARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">127</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915112</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">4</span></span>: keyboard.pressSpecialKey((LCTRL | ALT), DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //CTRL+ALT+DELETE  Ctrl + d case <span class="hljs-number"><span class="hljs-number">6</span></span>: keyboard.pressSpecialKey(ALT, F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //alt+f4  Ctrl + f case <span class="hljs-number"><span class="hljs-number">19</span></span>: keyboard.pressSpecialKey(ALT | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+s case <span class="hljs-number"><span class="hljs-number">2</span></span>: keyboard.pressSpecialKey(LCTRL | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+b //    case <span class="hljs-number"><span class="hljs-number">17</span></span>: controlPin(Port1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+q case <span class="hljs-number"><span class="hljs-number">23</span></span>: controlPin(Port2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+w case <span class="hljs-number"><span class="hljs-number">5</span></span>: controlPin(Port3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+e case <span class="hljs-number"><span class="hljs-number">18</span></span>: controlPin(Port4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+r case <span class="hljs-number"><span class="hljs-number">20</span></span>: controlPin(Port5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+t default: keyboard.pressKey(key); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//  } keyboard.releaseKey();//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" string: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(key);//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" KEY: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(bufkey.toInt()); bufkey = <span class="hljs-string"><span class="hljs-string">'0'</span></span>;//    } } } } //check UART <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Serial.available()){ size_t <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = Serial.available(); uint8_t sbuf[<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>]; Serial.readBytes(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); //push UART data to all connected telnet clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } } } }</code> </pre><br></div></div><br>  Conecte la biblioteca deseada: <br><br>  Seleccione la pestaña "Boceto" → "Conectar biblioteca" → "Agregar biblioteca .ZIP". Seleccione la biblioteca llamada "UNO-HIDKeyboard-Library-master (mod) .zip", que se descargó del github.  Compilamos y completamos el firmware.  Para descargar el firmware, conecte el ESP8266 TTL, configure el puerto deseado en ArduinoIDE.  La configuración debería verse así: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920b385c613386705.png"><br><br>  Para descargar el firmware, debe cortocircuitar el puerto GPIO0 a tierra y reiniciar el microcontrolador haciendo un cortocircuito en el puerto de restablecimiento a tierra también.  No pintaré en detalle, para no inflar el artículo, Google lo ayudará. <br><br>  La lógica del ESP8266 es la siguiente: cuando se aplica energía, el microcontrolador intenta conectarse a un punto de acceso Wi-Fi durante unos treinta segundos: <br><br>  <b>Si la conexión se realiza correctamente</b> : abre el puerto 23, al que puede conectarse mediante telnet y transmitir pulsaciones de teclas.  Además de las teclas, puede transferir combinaciones basadas en "Ctrl + tecla" que presionarán ciertas combinaciones.  Por ejemplo, si pasa "Ctrl + d", la combinación CTRL + ALT + SUPR se presionará en la computadora administrada. <br><br>  También hay combinaciones para controlar los puertos ESP8266, por ejemplo, puede conectar un relé y usar la combinación "Ctrl + q" para encender y apagar el relé, y así encender y apagar de forma remota la computadora administrada.  Puede ver estas y otras combinaciones en la fuente. <br><br>  <b>Si falla</b> : ESP8266 cambia al modo de punto de acceso con el nombre "TD", Contraseña "testtest" y abre una pequeña interfaz web, accesible en 192.168.4.1, donde puede configurar los ajustes para conectarse a través de WI-FI. <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920802fd033414007.png"><br><br>  Por lo tanto, el dispositivo se puede conectar fácilmente a otro punto de acceso.  Sí, aquí se esconde una mosca en la pomada, para el funcionamiento de nuestro IP KVM, necesitaremos un cable LAN y Wi-Fi.  Tal será el costo de la baratura del dispositivo. <br><br>  Tratamos con ESP8266, con Atmega16u2 todo está como en los artículos anteriores, flasheamos el programa Flip, el firmware está en el archivo descargado del github. <br><br><h2>  Conexión de componentes </h2><br>  Para la correcta conexión de los componentes, adjunto el circuito.  Solo tenga en cuenta que este es un esquema condicional, sirve para mayor claridad y no pretende ser ideal.  Todos son libres de "amueblarla" como quiera. <br><br><img src="https://habrastorage.org/webt/59/d6/52/59d6521903f44207012758.jpeg"><br><br>  Permítanme explicar algunos puntos: el transistor en el diagrama es necesario para encender Atmega16u2 después de cargar el ESP8266, porque cuando enciende el ESP8266, la información de depuración se transmite a todos los puertos TX, y si Atmega16u2 está encendido y conectado a la computadora, se transmite un flujo de datos con el volumen del cual El conductor no puede hacer frente.  No se sabe con certeza qué sucede en este momento, el búfer del controlador se desborda presumiblemente, el efecto es extremadamente desagradable: se presionan cientos de teclas, si se abre un editor de texto, se derrama un montón de galimatías, y todas las teclas de servicio se atascan y, como resultado, el trabajo con el teclado se vuelve imposible .  Para evitar esto, el Atmega16u2 necesita ser encendido después de cargar el ESP8266.  En el firmware se tiene en cuenta este momento. <br><br>  Existe, por supuesto, una alternativa al esquema, pero esta es una opción para los ricos o los perezosos.  Y, por cierto, esta opción no cancela lo anterior: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920e7d2e067456748.jpeg"><br><br>  En la imagen, el Arduino UNO sin el chip Atmega328p está conectado a la contraparte china de NodeMCU.  La línea de 3.3 voltios está conectada a la línea del mismo nivel de voltaje en el Arduino, así como la tierra y el pin GPIO2 (ESP8266) están conectados al pin TX en el Arduino. <br><br><h2>  Control final </h2><br>  Nos conectamos por telnet al puerto 23 y verificamos el rendimiento.  Puede hacer esto: en Windows con el comando <code>telnet [ip- ESP8266]</code> . <br><br>  En Linux será un poco más complicado: <br><br>  El comando <code>telnet [ip- ESP8266]</code> luego debe presionar el carácter de control, el valor predeterminado es "Ctrl +]", el telnet debe pasar al modo de comando, luego presione "l" y "Enter".  Con estas acciones, cambiaremos el telnet al modo de símbolo. <br><br><pre> <code class="bash hljs">$ telnet 192.168.***.*** Trying 192.168.***.***... Connected to 192.168.***.***. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. ^] telnet&gt; l</code> </pre><br>  Todo está listo, podemos verificar el funcionamiento del dispositivo que creamos.  Permítame recordarle las posibles combinaciones para presionar "Alt + Tab", "Ctrl + Alt + Supr" y etc.  Se puede ver en el boceto.  Eso es todo, la tercera encarnación KVM DIY IP está lista. <br><br><h2>  Para resumir </h2><br><h3>  Pros: </h3><br><ul><li>  Probablemente la ventaja más importante es el precio, que resultó en 2000 rublos </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No debería haber ninguna queja sobre la calidad del video, puede transmitir hasta Full HD sin problemas </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La capacidad de ampliar la funcionalidad al agregar hasta cuatro relés u otros actuadores. </font></font></li></ul><br><h3>  Contras: </h3><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Necesita conectarse a través de Wi-Fi y cable LAN </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cuando se usa con VGA, se requiere un adaptador, lo que naturalmente afectará el costo </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, el dispositivo resultó ser digno de atención, por supuesto, no es un competidor para serializar KVM IP con todas sus "ventajas", pero gana mucho en precio. </font><font style="vertical-align: inherit;">Y para uso doméstico, y tal vez no solo, es bastante adecuado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Me gustaría aprovechar esta oportunidad para agradecer al usuario </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DaylightIsBurning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Este amable hombre sugirió la dirección correcta para excavar.</font></font><br><br>  Gracias por su atencion<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hasta pronto! </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es406059/">https://habr.com/ru/post/es406059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es406047/index.html">Uberización de grúas</a></li>
<li><a href="../es406049/index.html">Mostrar gráficos 3D en PSP</a></li>
<li><a href="../es406051/index.html">De camino a las estrellas: el peligro de los viajes espaciales</a></li>
<li><a href="../es406055/index.html">Una persona que recibió una actualización del sistema inmunitario para combatir el cáncer.</a></li>
<li><a href="../es406057/index.html">Los equipos del concurso Google Lunar X PRIZE obtendrán tiempo extra</a></li>
<li><a href="../es406061/index.html">Especialista en seguridad de la información pirateó la protección criptográfica del enclave seguro de Apple</a></li>
<li><a href="../es406063/index.html">¿Qué sucederá exactamente cuando la bifurcación bitcoin segwit2x se active en noviembre?</a></li>
<li><a href="../es406065/index.html">Especialistas en seguridad de la información: "Un automóvil inteligente está lejos de ser siempre un automóvil seguro"</a></li>
<li><a href="../es406067/index.html">Contratos inteligentes. Parte 1. Cuando el periódico sabe lo que le dijiste y lo hace</a></li>
<li><a href="../es406069/index.html">Contratos inteligentes. Parte 2. Del bombo a la realidad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>