<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìª üåø ü§ûüèΩ Python Dependency Management: Ein Vergleich der Ans√§tze üôÖ üå§Ô∏è üìí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich schreibe seit f√ºnf Jahren in Python, von denen die letzten drei Jahre mein eigenes Projekt entwickelt haben. Meistens hilft mir mein Team dabei. U...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python Dependency Management: Ein Vergleich der Ans√§tze</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461511/"><img src="http://ftcdn.pw/cd64d5e9-af9a-46cc-868b-c8873c98adb6.png" alt="Bild"><br><br>  Ich schreibe seit f√ºnf Jahren in Python, von denen die letzten drei Jahre mein eigenes Projekt entwickelt haben.  Meistens hilft mir mein Team dabei.  Und mit jeder Version und mit jeder neuen Funktion versuchen wir zunehmend sicherzustellen, dass das Projekt nicht durch nicht unterst√ºtzten Code zu einem Chaos wird.  Wir k√§mpfen mit zyklischen Importen, gegenseitigen Abh√§ngigkeiten, weisen wiederverwendbare Module zu und bauen die Struktur neu auf. <br><br>  Leider gibt es in der Python-Community kein universelles Konzept f√ºr ‚Äûgute Architektur‚Äú, sondern nur das Konzept f√ºr ‚ÄûPythonalit√§t‚Äú. Daher m√ºssen wir uns die Architektur selbst einfallen lassen.  Unter dem Strich ist Longrid mit √úberlegungen zur Architektur und vor allem zum Abh√§ngigkeitsmanagement auf Python anwendbar. <br><a name="habracut"></a><br><h1>  django.setup () </h1><br>  Ich beginne mit einer Frage an die Dzhangisten.  Schreiben Sie oft diese beiden Zeilen? <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django django.setup()</code> </pre> <br>  Sie m√ºssen die Datei von hier aus starten, wenn Sie mit Django-Objekten arbeiten m√∂chten, ohne den Django-Webserver selbst zu starten.  Dies gilt f√ºr Modelle und Tools zum Arbeiten mit Zeit ( <code><b>django.utils.timezone</b></code> ), <code><b>django.urls.reverse</b></code> ( <code><b>django.urls.reverse</b></code> ) und vieles mehr.  Wenn dies nicht getan wird, erhalten Sie eine Fehlermeldung: <br><br><pre> <code class="plaintext hljs">django.core.exceptions.AppRegistryNotReady: Apps aren't loaded yet.</code> </pre><br>  Ich schreibe st√§ndig diese beiden Zeilen.  Ich bin ein gro√üer Fan von Auswurfcode.  Ich mag es, eine separate <code><b>.py</b></code> Datei zu erstellen, Dinge darin zu drehen, herauszufinden - und sie dann in das Projekt einzubetten. <br><br>  Und diese Konstante <code><b>django.setup()</b></code> nervt mich sehr.  Erstens werden Sie es leid, es √ºberall zu wiederholen;  und zweitens dauert die Django-Initialisierung einige Sekunden (wir haben einen gro√üen Monolithen), und wenn Sie dieselbe Datei 10, 20, 100 Mal neu starten, verlangsamt dies nur die Entwicklung. <br><br>  Wie werde ich <code><b>django.setup()</b></code> los?  Sie m√ºssen Code schreiben, der minimal von Django abh√§ngt. <br><br>  Wenn wir beispielsweise einen Client einer externen API schreiben, k√∂nnen wir ihn von django abh√§ngig machen: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.api_key = settings.SOME_API_KEY <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient()</span></span></code> </pre><br>  oder es kann unabh√§ngig von Django sein: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient(api_key='abc')</span></span></code> </pre><br>  Im zweiten Fall ist der Konstruktor umst√§ndlicher, aber alle Manipulationen mit dieser Klasse k√∂nnen durchgef√ºhrt werden, ohne die gesamte dzhangovskoy-Maschinerie zu laden. <br><br>  Tests werden auch einfacher.  Wie <code><b>django.conf.settings</b></code> eine Komponente, die von <code><b>django.conf.settings</b></code> Einstellungen von <code><b>django.conf.settings</b></code> abh√§ngt?  Sperren Sie sie einfach mit dem Dekorateur <code><b>@override_settings</b></code> .  Und wenn die Komponente von nichts abh√§ngt, gibt es nichts, was nass werden k√∂nnte: Sie hat die Parameter an den Konstruktor √ºbergeben - und sie gesteuert. <br><br><h1>  Abh√§ngigkeitsmanagement </h1><br>  Die <code><b>django</b></code> Abh√§ngigkeitsgeschichte ist das auff√§lligste Beispiel f√ºr ein Problem, auf das ich jeden Tag <code><b>django</b></code> : Probleme mit dem Abh√§ngigkeitsmanagement in Python - und die Gesamtarchitektur von Python-Anwendungen. <br><br>  Die Beziehung zum Abh√§ngigkeitsmanagement in der Python-Community ist gemischt.  Drei Hauptlager k√∂nnen unterschieden werden: <br><br><ul><li>  Python ist eine flexible Sprache.  Wir schreiben wie wir wollen, je nachdem was wir wollen.  Wir scheuen keine zyklischen Abh√§ngigkeiten, Attributsubstitution f√ºr Klassen zur Laufzeit usw. <br><br></li><li>  Python ist eine spezielle Sprache.  Es gibt idiomatische M√∂glichkeiten, Architektur und Abh√§ngigkeiten zu erstellen.  Die Daten√ºbertragung auf und ab des Aufrufstapels wird von Iteratoren, Coroutinen und Kontextmanagern durchgef√ºhrt. <br><br><div class="spoiler">  <b class="spoiler_title">Klassenbericht zu diesem Thema und Beispiel</b> <div class="spoiler_text">  Brandon Rhodes, Dropbox: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Heben Sie Ihr IO hoch</a> . <br><br>  Beispiel aus dem Bericht: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"/etc/hosts"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parse_hosts(file): print(line) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lines)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    -   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line.startswith(<span class="hljs-string"><span class="hljs-string">"#"</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> line</code> </pre><br></div></div><br></li><li>  Pythons Flexibilit√§t ist eine zus√§tzliche M√∂glichkeit, sich in den Fu√ü zu schie√üen.  Sie ben√∂tigen strenge Regeln f√ºr die Verwaltung von Abh√§ngigkeiten.  Ein gutes Beispiel sind die russischen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dry-Python-</a> Typen.  Es gibt immer noch einen weniger hardcore Ansatz - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Django-Struktur f√ºr Skalierbarkeit und Langlebigkeit</a> , aber die Idee ist die gleiche. <br></li></ul><br>  Es gibt mehrere Artikel zum Abh√§ngigkeitsmanagement in Python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiel 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiel 2</a> ), die jedoch alle darauf abzielen, die Dependency Injection-Frameworks einer Person zu bewerben.  Dieser Artikel ist ein neuer Eintrag zum gleichen Thema, aber diesmal ist es ein reines Gedankenexperiment ohne Werbung.  Dies ist ein Versuch, ein Gleichgewicht zwischen den drei oben genannten Ans√§tzen zu finden, auf einen zus√§tzlichen Rahmen zu verzichten und ihn ‚Äûpythonisch‚Äú zu machen. <br><br>  Ich habe k√ºrzlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Clean Architecture</a> gelesen - und ich scheine zu verstehen, welchen Wert die Abh√§ngigkeitsinjektion in Python hat und wie sie implementiert werden kann.  Ich habe das am Beispiel meines eigenen Projekts gesehen.  Kurz gesagt, dies <b>sch√ºtzt den Code vor dem Brechen, wenn sich ein anderer Code √§ndert</b> . <br><br><h1>  Ausgangsdaten </h1><br>  Es gibt einen API-Client, der HTTP-Anforderungen f√ºr den Service Shortener ausf√ºhrt: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py import requests class ShortenerClient: def __init__(self, api_key): self.api_key = api_key def shorten_link(self, url): response = requests.post( url='https://fstrk.cc/short', headers={'Authorization': self.api_key}, json={'url': url} ) return response.json()['url']</span></span></code> </pre><br>  Und es gibt ein Modul, das alle Links im Text verk√ºrzt.  Dazu verwendet er den Shortener-API-Client: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from shortener_client import ShortenerClient class TextProcessor: def __init__(self, text): self.text = text def process(self): changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) api_client = ShortenerClient('abc') for link in links: shortened = api_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  Die Logik der Codeausf√ºhrung befindet sich in einer separaten Steuerdatei (nennen wir es einen Controller): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py from text_processor import TextProcessor processor = TextProcessor("""  1: https://ya.ru  2: https://google.com """) print(processor.process())</span></span></code> </pre><br>  Alles arbeitet.  Der Prozessor analysiert den Text, verk√ºrzt die Links mit einem Shortener und gibt das Ergebnis zur√ºck.  Die Abh√§ngigkeiten sehen folgenderma√üen aus: <br><br><img src="http://ftcdn.pw/58d8aa1d-0024-42c6-918e-05b2d41f126d.png" alt="Bild"><br><br><h1>  Das Problem </h1><br>  Hier ist das Problem: Die <code><b>TextProcessor</b></code> Klasse h√§ngt von der <code><b>TextProcessor</b></code> Klasse ab - und <b>bricht ab, wenn sich die</b> <code><b>ShortenerClient</b></code> <b>Schnittstelle √§ndert</b> . <br><br>  Wie kann das passieren? <br><br>  Angenommen, wir haben in unserem Projekt beschlossen, <code><b>shorten_link</b></code> zu verfolgen, und der <code><b>shorten_link</b></code> Methode das Argument <code><b>callback_url</b></code> hinzugef√ºgt.  Dieses Argument bezeichnet die Adresse, an die Benachrichtigungen gesendet werden sollen, wenn Sie auf einen Link klicken. <br><br>  Die <code><b>ShortenerClient.shorten_link</b></code> Methode sah folgenderma√üen aus: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, callback_url)</span></span></span><span class="hljs-function">:</span></span> response = requests.post( url=<span class="hljs-string"><span class="hljs-string">'https://fstrk.cc/short'</span></span>, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: self.api_key}, json={<span class="hljs-string"><span class="hljs-string">'url'</span></span>: url, <span class="hljs-string"><span class="hljs-string">'callback_on_click'</span></span>: callback_url} ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.json()[<span class="hljs-string"><span class="hljs-string">'url'</span></span>]</code> </pre><br>  Und was passiert?  Und es stellt sich heraus, dass wir beim Start eine Fehlermeldung erhalten: <br><br><pre> <code class="python hljs">TypeError: shorten_link() missing <span class="hljs-number"><span class="hljs-number">1</span></span> required positional argument: <span class="hljs-string"><span class="hljs-string">'callback_url'</span></span></code> </pre><br>  Das hei√üt, wir haben den Shortener gewechselt, aber nicht er hat gebrochen, sondern sein Kunde: <br><br><img src="http://ftcdn.pw/13e9dcd5-7866-4c82-b1d0-e56134650b62.png" alt="Bild"><br><br>  Also was?  Nun, die aufrufende Datei ist kaputt gegangen, wir haben sie repariert.  Was ist das Problem? <br><br>  Wenn dies in einer Minute gel√∂st ist - sie gingen und korrigierten -, dann ist dies nat√ºrlich √ºberhaupt kein Problem.  Wenn die Klassen wenig Code enthalten und Sie sie selbst unterst√ºtzen (dies ist Ihr Nebenprojekt, dies sind zwei kleine Klassen desselben Subsystems usw.), k√∂nnen Sie dort anhalten. <br><br>  Probleme beginnen, wenn: <br><br><ul><li>  Die aufrufenden und aufgerufenen Module haben viel Code. </li><li>  Verschiedene Module werden von verschiedenen Personen / Teams unterst√ºtzt. </li></ul><br>  Wenn Sie die <code><b>ShortenerClient</b></code> Klasse schreiben und Ihr Kollege <code><b>TextProcessor</b></code> schreibt, <code><b>TextProcessor</b></code> eine beleidigende Situation auf: <b>Sie haben den Code ge√§ndert, aber er ist</b> <code><b>TextProcessor</b></code> <b>.</b>  Und es brach an einem Ort, den Sie im Leben noch nicht gesehen haben, und jetzt m√ºssen Sie sich hinsetzen und den Code eines anderen verstehen. <br><br>  Noch interessanter ist es, wenn Ihr Modul an mehreren Orten und nicht an einem verwendet wird.  und Ihre Bearbeitung wird den Code auf dem Haufen von Dateien brechen. <br><br>  Daher kann das Problem wie folgt formuliert werden: Wie kann der Code so organisiert werden, dass beim <code><b>ShortenerClient</b></code> der <code><b>ShortenerClient</b></code> Schnittstelle <code><b>ShortenerClient</b></code> <b>selbst <code><b>ShortenerClient</b></code> und nicht seine Verbraucher</b> (von denen es viele geben kann)? <br><br>  Die L√∂sung hier ist: <br><br><ul><li>  Klassenkonsumenten und die Klasse selbst m√ºssen sich auf eine gemeinsame Schnittstelle einigen.  Diese Schnittstelle sollte zum Gesetz werden. </li><li>  Wenn die Klasse nicht mehr ihrer Schnittstelle entspricht, sind dies ihre Probleme und keine Verbraucherprobleme. </li></ul><br><img src="http://ftcdn.pw/dbb4d320-2683-4f2e-821e-dea621b54b53.png" alt="Bild"><br><br><h1>  Frieren Sie die Schnittstelle ein </h1><br>  Wie sieht das Reparieren einer Schnittstelle in Python aus?  Dies ist eine abstrakte Klasse: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABC, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABC)</span></span></span><span class="hljs-class">:</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, link)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Wenn wir jetzt von dieser Klasse erben und vergessen, eine Methode zu implementieren, erhalten wir eine Fehlermeldung: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShortenerClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AbstractClient)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__ini__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key client = ShortenerClient(<span class="hljs-string"><span class="hljs-string">'123'</span></span>) &gt;&gt;&gt; TypeError: Can<span class="hljs-string"><span class="hljs-string">'t instantiate abstract class ShortenerClient with abstract methods __init__, shorten_link</span></span></code> </pre><br>  Das reicht aber nicht.  Eine abstrakte Klasse erfasst nur die Namen von Methoden, nicht jedoch deren Signatur. <br><br>  <code><b>mypy</b></code> Sie ein zweites Tool zur √úberpr√ºfung der Signatur <code><b>mypy</b></code> Dieses zweite Tool ist <code><b>mypy</b></code> .  Es hilft dabei, die Signaturen geerbter Methoden zu √ºberpr√ºfen.  Dazu m√ºssen wir der Schnittstelle Anmerkungen hinzuf√ºgen: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class ShortenerClient(AbstractClient): def __init__(self, api_key: str) -&gt; None: self.api_key = api_key def shorten_link(self, link: str, callback_url: str) -&gt; str: return 'xxx'</span></span></code> </pre><br>  Wenn wir diesen Code jetzt mit <code><b>mypy</b></code> , erhalten wir aufgrund des zus√§tzlichen Arguments <code><b>callback_url</b></code> eine Fehlermeldung: <br><br><pre> <code class="plaintext hljs">mypy shortener_client.py &gt;&gt;&gt; error: Signature of "shorten_link" incompatible with supertype "AbstractClient"</code> </pre><br>  Jetzt haben wir eine zuverl√§ssige M√∂glichkeit, die Klassenschnittstelle festzuschreiben. <br><br><h1>  Abh√§ngigkeitsinversion </h1><br>  Nachdem wir die Schnittstelle getestet haben, m√ºssen wir sie an einen anderen Ort verschieben, um die Abh√§ngigkeit des Verbrauchers von der Datei shortener_client.py vollst√§ndig zu beseitigen.  Sie k√∂nnen die Benutzeroberfl√§che beispielsweise direkt auf den Consumer ziehen - in eine Datei mit dem <code><b>TextProcessor</b></code> Prozessor: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class TextProcessor: def __init__(self, text, shortener_client: AbstractClient) -&gt; None: self.text = text self.shortener_client = shortener_client def process(self) -&gt; str: changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) for link in links: shortened = self.shortener_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  Und das wird die Richtung der Sucht √§ndern!  Jetzt besitzt der <code><b>TextProcessor</b></code> die Interaktionsschnittstelle, <code><b>TextProcessor</b></code> davon abh√§ngt und nicht umgekehrt. <br><br><img src="http://ftcdn.pw/33f3c619-63bf-420d-99d0-67bed0dfa628.png" alt="Bild"><br><br>  Mit einfachen Worten k√∂nnen wir das Wesen unserer Transformation wie folgt beschreiben: <br><br><ul><li>  <code><b>TextProcessor</b></code> sagt: Ich bin ein Prozessor und an der Textkonvertierung beteiligt.  Ich m√∂chte nichts √ºber den Verk√ºrzungsmechanismus wissen: Das geht mich nichts an.  Ich m√∂chte die <code><b>shorten_link</b></code> Methode ziehen, damit sie alles f√ºr mich <code><b>shorten_link</b></code> .  Geben Sie mir bitte ein Objekt, das nach meinen Regeln spielt.  Entscheidungen dar√ºber, wie ich interagiere, werden von mir getroffen, nicht von ihm. </li><li>  <code><b>ShortenerClient</b></code> sagt: Es scheint, dass ich nicht in einem Vakuum existieren kann und sie erfordern ein bestimmtes Verhalten von mir.  Ich werde <code><b>TextProcessor</b></code> fragen, was ich <code><b>TextProcessor</b></code> muss, um nicht zu brechen. </li></ul><br><h1>  Mehrere Verbraucher </h1><br>  Wenn mehrere Module Verk√ºrzungslinks verwenden, sollte die Schnittstelle nicht in einer von ihnen, sondern in einer separaten Datei platziert werden, die sich √ºber den anderen Dateien befindet und eine h√∂here Hierarchie aufweist: <br><br><img src="http://ftcdn.pw/a81ef19a-45aa-4b23-b93a-e9a6b9094670.png" alt="Bild"><br><br><h1>  Steuerkomponente </h1><br>  Wenn Verbraucher ShortenerClient nicht importieren, wer importiert es dann und erstellt ein Klassenobjekt?  Es sollte eine Steuerungskomponente sein - in unserem Fall ist es <code><b>controller.py</b></code> . <br><br>  Der einfachste Ansatz ist eine einfache Abh√§ngigkeitsinjektion, die Abh√§ngigkeitsinjektion ‚Äûin die Stirn‚Äú.  Wir erstellen Objekte im aufrufenden Code, √ºbertragen ein Objekt auf ein anderes.  Gewinn <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient processor = TextProcessor( text=' 1: https://ya.ru  2: https://google.com', shortener_client=ShortenerClient(api_key='123') ) print(processor.process())</span></span></code> </pre><br><h1>  Python-Ansatz </h1><br>  Es wird angenommen, dass ein eher ‚Äûpythonischer‚Äú Ansatz die Abh√§ngigkeitsinjektion durch Vererbung ist. <br><br><div class="spoiler">  <b class="spoiler_title">Raymond Hettinger spricht in seinem Super-Super-Bericht ausf√ºhrlich dar√ºber.</b> <div class="spoiler_text"><div class="oembed">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.youtube.com/watch?v=EiOglTERPEo</a> </div><br></div></div><br>  Um den Code an diesen Stil anzupassen, m√ºssen Sie den <code><b>TextProcessor</b></code> leicht √§ndern, damit er vererbbar wird: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py class TextProcessor: def __init__(self, text: str) -&gt; None: self.text = text self.shortener_client: AbstractClient = self.get_shortener_client() def get_shortener_client(self) -&gt; AbstractClient: """      """ raise NotImplementedError</span></span></code> </pre><br>  Und dann erben Sie es im aufrufenden Code: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient class ProcessorWithClient(TextProcessor): """   ,    """ def get_shortener_client(self) -&gt; ShortenerClient: return ShortenerClient(api_key='abc') processor = ProcessorWithClient( text=' 1: https://ya.ru  2: https://google.com' ) print(processor.process())</span></span></code> </pre><br>  Das zweite Beispiel ist in popul√§ren Frameworks allgegenw√§rtig: <br><br><ul><li>  Bei Django werden wir st√§ndig geerbt.  Wir definieren Methoden der klassenbasierten Ansicht, Modelle, Formen neu.  Mit anderen Worten, f√ºgen Sie unsere Abh√§ngigkeiten in die bereits debuggte Arbeit des Frameworks ein. </li><li>  In DRF das Gleiche.  Wir erweitern Ansichten, Serializer und Berechtigungen. </li><li>  Usw.  Es gibt viele Beispiele. </li></ul><br>  Das zweite Beispiel sieht h√ºbscher und vertrauter aus, nicht wahr?  Lassen Sie es uns entwickeln und sehen, ob diese Sch√∂nheit erhalten bleibt. <br><br><h1>  Python-Entwicklung </h1><br>  In der Gesch√§ftslogik gibt es normalerweise mehr als zwei Komponenten.  Angenommen, unser <code><b>TextProcessor</b></code> ist keine unabh√§ngige Klasse, sondern nur eines der <code><b>TextPipeline</b></code> Elemente, die den Text verarbeiten und an die E-Mail <code><b>TextPipeline</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TextPipeline</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, email)</span></span></span><span class="hljs-function">:</span></span> self.text_processor = TextProcessor(text) self.mailer = Mailer(email) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_and_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</code> </pre><br>  Wenn wir die <code><b>TextPipeline</b></code> von den verwendeten Klassen isolieren <code><b>TextPipeline</b></code> , m√ºssen wir das gleiche Verfahren wie zuvor <code><b>TextPipeline</b></code> : <br><br><ul><li>  Die <code><b>TextPipeline</b></code> Klasse deklariert Schnittstellen f√ºr die verwendeten Komponenten. </li><li>  gebrauchte Komponenten m√ºssen sich an diese Schnittstellen anpassen; </li><li>  Ein externer Code f√ºgt alles zusammen und wird ausgef√ºhrt. </li></ul><br>  Das Abh√§ngigkeitsdiagramm sieht folgenderma√üen aus: <br><br><img src="http://ftcdn.pw/35f207fa-3ad7-4779-92c3-ae8f63401b8e.png" alt="Bild"><br><br>  Aber wie sieht der Assembler-Code dieser Abh√§ngigkeiten jetzt aus? <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessorWithClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextProcessor)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_shortener_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; ShortenerClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'123'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PipelineWithDependencies</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextPipeline)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text_processor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text: str)</span></span></span><span class="hljs-function"> -&gt; ProcessorWithClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProcessorWithClient(text) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, email: str)</span></span></span><span class="hljs-function"> -&gt; Mailer:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mailer(email) pipeline = PipelineWithDependencies( email=<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>, text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span> ) pipeline.process_and_mail()</code> </pre><br>  Hast du es bemerkt?  Wir erben zuerst die <code><b>TextProcessor</b></code> Klasse, um den <code><b>TextPipeline</b></code> darin einzuf√ºgen, und erben dann die <code><b>TextPipeline</b></code> , um unseren neu definierten <code><b>TextProcessor</b></code> (sowie <code><b>Mailer</b></code> ) darin einzuf√ºgen.  Wir haben mehrere Ebenen der sequentiellen Neudefinition.  Schon kompliziert. <br><br>  Warum sind alle Frameworks so organisiert?  <b>Ja, weil es nur f√ºr Frameworks geeignet ist.</b> <br><br><ul><li>  Alle Ebenen des Frameworks sind klar definiert und ihre Anzahl ist begrenzt.  In Django k√∂nnen Sie beispielsweise <code><b>FormField</b></code> √ºberschreiben, um es in eine √úberschreibung eines <code><b>Form</b></code> einzuf√ºgen, um ein Formular in eine √úberschreibung von <code><b>View</b></code> einzuf√ºgen.  Das ist alles.  Drei Ebenen. </li><li>  Jedes Framework dient einem Zweck.  Diese Aufgabe ist klar definiert. </li><li>  Jedes Framework verf√ºgt √ºber eine detaillierte Dokumentation, in der beschrieben wird, wie und was geerbt werden soll.  was und mit was zu kombinieren. </li></ul><br>  K√∂nnen Sie Ihre Gesch√§ftslogik klar und eindeutig identifizieren und dokumentieren?  Besonders die Architektur der Ebenen, auf denen es funktioniert?  Ich nicht.  Leider l√§sst sich der Ansatz von Raymond Hettinger nicht auf die Gesch√§ftslogik √ºbertragen. <br><br><h1>  Zur√ºck zum Stirnansatz </h1><br>  Bei mehreren Schwierigkeitsgraden gewinnt ein einfacher Ansatz.  Es sieht einfacher aus - und ist einfacher zu √§ndern, wenn sich die Logik √§ndert. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline pipeline = TextPipeline( text_processor=TextProcessor( text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span>, shortener_client=ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'abc'</span></span>) ), mailer=Mailer(<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>) ) pipeline.process_and_mail()</code> </pre><br>  Wenn jedoch die Anzahl der Logikebenen zunimmt, wird selbst ein solcher Ansatz unpraktisch.  Wir m√ºssen unbedingt eine Reihe von Klassen initiieren und sie ineinander √ºbergehen.  Ich m√∂chte viele Verschachtelungsebenen vermeiden. <br><br>  Versuchen wir noch einen Anruf. <br><br><h1>  Globaler Instanzspeicher </h1><br>  Versuchen wir, ein globales W√∂rterbuch zu erstellen, in dem die Instanzen der ben√∂tigten Komponenten liegen.  Und lassen Sie diese Komponenten sich gegenseitig durch Zugriff auf dieses W√∂rterbuch erreichen. <br><br>  Nennen wir es <code><b>INSTANCE_DICT</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import INSTANCE_DICT class TextProcessor(AbstractTextProcessor): def __init__(self, text) -&gt; None: self.text = text def process(self) -&gt; str: shortener_client: AbstractClient = INSTANCE_DICT['Shortener'] # ...  </span></span></code> </pre><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_pipeline.py import INSTANCE_DICT class TextPipeline: def __init__(self) -&gt; None: self.text_processor: AbstractTextProcessor = INSTANCE_DICT[ 'TextProcessor'] self.mailer: AbstractMailer = INSTANCE_DICT['Mailer'] def process_and_mail(self) -&gt; None: processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</span></span></code> </pre><br>  Der Trick besteht darin <b>, unsere Objekte in dieses W√∂rterbuch aufzunehmen, bevor auf sie zugegriffen wird</b> .  Dies werden wir in <code><b>controller.py</b></code> tun: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import INSTANCE_DICT import TextProcessor import ShortenerClient import Mailer import TextPipeline INSTANCE_DICT['Shortener'] = ShortenerClient('123') INSTANCE_DICT['Mailer'] = Mailer('abc@def.com') INSTANCE_DICT['TextProcessor'] = TextProcessor(text=' : https://ya.ru') pipeline = TextPipeline() pipeline.process_and_mail()</span></span></code> </pre><br>  Vorteile der Arbeit mit einem globalen W√∂rterbuch: <br><br><ul><li>  keine Motorhaubenmagie und zus√§tzliche DI-Rahmen; </li><li>  eine flache Liste von Abh√§ngigkeiten, in denen Sie die Verschachtelung nicht verwalten m√ºssen; </li><li>  Alle DI-Boni: einfaches Testen, Unabh√§ngigkeit, Schutz der Komponenten vor Ausf√§llen, wenn andere Komponenten ge√§ndert werden. </li></ul><br>  Anstatt <code><b>INSTANCE_DICT</b></code> , k√∂nnen Sie nat√ºrlich eine Art DI-Framework verwenden.  aber das Wesen davon wird sich nicht √§ndern.  Das Framework bietet eine flexiblere Verwaltung von Instanzen.  Er erlaubt Ihnen, sie in Form von Singletones oder B√ºndeln wie eine Fabrik zu erstellen.  aber die Idee wird gleich bleiben. <br><br>  Vielleicht reicht mir das irgendwann nicht mehr und ich w√§hle immer noch einen Rahmen. <br><br>  Und vielleicht ist all dies unn√∂tig und es ist einfacher, darauf zu verzichten: Schreiben Sie direkte Importe und erstellen Sie keine unn√∂tigen abstrakten Schnittstellen. <br><br>  Welche Erfahrungen haben Sie mit dem Abh√§ngigkeitsmanagement in Python gemacht?  Und im Allgemeinen - ist es notwendig oder erfinde ich ein Problem aus der Luft? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461511/">https://habr.com/ru/post/de461511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461501/index.html">Warum untersuchen sie in den USA die Arbeit gro√üer IT-Unternehmen?</a></li>
<li><a href="../de461503/index.html">Bereitstellung der Datenbank f√ºr die Remoteverbindung</a></li>
<li><a href="../de461505/index.html">8 Fehler von unerfahrenen JavaScript-Entwicklern, die Sie daran hindern, professionell zu werden</a></li>
<li><a href="../de461507/index.html">Warum haben wir uns entschieden, den Unternehmensbeschleuniger StartupDrive von Gazprom Neft zu starten, und wer hat ihn bereits bestanden?</a></li>
<li><a href="../de461509/index.html">Reiseassistenten: Eine Auswahl an Ger√§ten und Zubeh√∂r</a></li>
<li><a href="../de461517/index.html">Beste Copy-Paste-Algorithmen f√ºr C und C ++. Haiku OS Kochbuch</a></li>
<li><a href="../de461519/index.html">Beste Copy-Paste-Algorithmen f√ºr C und C ++. Haiku OS Rezeptsammlung</a></li>
<li><a href="../de461523/index.html">WAL in PostgreSQL: 4. Protokoll einrichten</a></li>
<li><a href="../de461525/index.html">Wie ich einen wirklich adaptiven Slider (Karussell) gemacht habe</a></li>
<li><a href="../de461527/index.html">DIY akustische Levitation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>