<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ»â€ğŸ³ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ¼ ğŸ¦ Kubernetesé›†ç¾¤æ¯æœˆ20ç¾å…ƒ ğŸ© ğŸ¤šğŸ¾ ğŸ¤°ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL åšå£« 


 æˆ‘ä»¬æé«˜äº†é›†ç¾¤ï¼Œä»¥ä½¿ç”¨ingress ï¼Œ letsencryptæœåŠ¡æ— çŠ¶æ€ Webåº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€ä½¿ç”¨kubesprayï¼Œkubeadmç­‰è‡ªåŠ¨åŒ–å·¥å…·ã€‚ 
 é˜…è¯»æ—¶é—´ï¼šã€œ45-60åˆ†é’Ÿï¼Œæ’­æ”¾æ—¶é—´ï¼š3å°æ—¶èµ·ã€‚ 
 å‰è¨€ 


 æˆ‘éœ€è¦è‡ªå·±çš„Kubernetesé›†ç¾¤è¿›è¡Œå®éªŒï¼Œæç¤ºæˆ‘å†™ä¸€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetesé›†ç¾¤æ¯æœˆ20ç¾å…ƒ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/435228/"><h1 id="tl-dr">  TL åšå£« </h1><br><p> æˆ‘ä»¬æé«˜äº†é›†ç¾¤ï¼Œä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ingress</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">letsencrypt</a>æœåŠ¡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ— çŠ¶æ€</a> Webåº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€ä½¿ç”¨kubesprayï¼Œkubeadmç­‰è‡ªåŠ¨åŒ–å·¥å…·ã€‚ <br> é˜…è¯»æ—¶é—´ï¼šã€œ45-60åˆ†é’Ÿï¼Œæ’­æ”¾æ—¶é—´ï¼š3å°æ—¶èµ·ã€‚ </p><br><h1 id="preambula"> å‰è¨€ </h1><br><p> æˆ‘éœ€è¦è‡ªå·±çš„Kubernetesé›†ç¾¤è¿›è¡Œå®éªŒï¼Œæç¤ºæˆ‘å†™ä¸€ç¯‡æ–‡ç« ã€‚ åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œå¼€æºè‡ªåŠ¨å®‰è£…å’Œé…ç½®è§£å†³æ–¹æ¡ˆä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨äº†éä¸»æµLinuxå‘è¡Œç‰ˆã€‚ åœ¨IPONWEBä¸­ä¸kubernetesè¿›è¡Œæ·±å…¥çš„åˆä½œä¼šé¼“åŠ±æ‚¨æ‹¥æœ‰è¿™æ ·ä¸€ä¸ªå¹³å°ï¼Œä»¥èˆ’é€‚çš„æ–¹å¼è§£å†³æ‚¨çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬ç”¨äºå®¶åº­é¡¹ç›®ã€‚ </p><br><h1 id="komponenty"> ç»„æˆéƒ¨åˆ† </h1><br><p> ä»¥ä¸‹ç»„ä»¶å°†å‡ºç°åœ¨æ–‡ç« ä¸­ï¼š </p><br><p>  - <em>æ‚¨æœ€å–œæ¬¢çš„</em> Linux-æˆ‘ä½¿ç”¨äº†Gentooï¼ˆnode-1ï¼šsystemd / node-2ï¼šopenrcï¼‰ï¼ŒUbuntu 18.04.1ã€‚ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-KubernetesæœåŠ¡å™¨</a> -kube-apiserverï¼Œkube-controller-managerï¼Œkube-schedulerï¼Œkubeletï¼Œkube-proxy <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®¹å™¨</a> + <a href="">CNIæ’ä»¶ï¼ˆ0.7.4ï¼‰</a> -ä¸ºäº†è¿›è¡Œå®¹å™¨åŒ–ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®¹å™¨+ CNIä»£æ›¿dockerï¼ˆå°½ç®¡æœ€åˆæ•´ä¸ªé…ç½®<a href="">éƒ½å·²</a>ä¸Šä¼ åˆ°dockerï¼Œæ‰€ä»¥åœ¨å¿…è¦æ—¶ä¸ä¼šé˜»æ­¢ä»»ä½•ä½¿ç”¨ï¼‰ã€‚ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-CoreDNS-</a>ç”¨äºç»„ç»‡åœ¨kubernetesé›†ç¾¤ä¸­å·¥ä½œçš„ç»„ä»¶çš„æœåŠ¡å‘ç°ã€‚ æ¨èä½¿ç”¨ä¸ä½äº1.2.5çš„ç‰ˆæœ¬ï¼Œå› ä¸ºæ­¤ç‰ˆæœ¬å¯¹corednsèµ·åˆ°äº†å¥å…¨çš„æ”¯æŒï¼Œä½¿å…¶å¯ä»¥åœ¨é›†ç¾¤å¤–éƒ¨è¿è¡Œã€‚ <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ³•å…°ç»’</a> -ç”¨äºç»„ç»‡ç½‘ç»œå †æ ˆï¼Œåœ¨å½¼æ­¤ä¹‹é—´é€šä¿¡ç‚‰åºŠå’Œå®¹å™¨ã€‚ <br>  - <em>æ‚¨æœ€å–œæ¬¢çš„</em>æ•°æ®åº“ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/423/a71/5fc/423a715fc68fed1101c86d3335b0a8a8.jpg" alt="å¯¹äºæ‰€æœ‰"></p><a name="habracut"></a><br><h1 id="ogranicheniya-i-dopuscheniya"> å±€é™æ€§å’Œå‡è®¾ </h1><br><ul><li> æœ¬æ–‡ä¸è®¨è®ºå¸‚åœºä¸Švps / vdsè§£å†³æ–¹æ¡ˆçš„æˆæœ¬ï¼Œä¹Ÿä¸è€ƒè™‘åœ¨è¿™äº›æœåŠ¡ä¸Šéƒ¨ç½²è®¡ç®—æœºçš„å¯èƒ½æ€§ã€‚ å‡å®šæ‚¨å·²ç»è¿›è¡Œäº†æ‰©å±•ï¼Œæˆ–è€…æ‚¨å¯ä»¥è‡ªå·±è¿›è¡Œæ‰©å±•ã€‚ æ­¤å¤–ï¼Œå¦‚æœéœ€è¦ï¼Œè¿˜ä¸ä¼šæ¶µç›–æ‚¨å–œæ¬¢çš„æ•°æ®åº“å’Œç§æœ‰Dockerå­˜å‚¨åº“çš„å®‰è£…/é…ç½®ã€‚ </li><li> æˆ‘ä»¬å¯ä»¥åŒæ—¶ä½¿ç”¨å®¹å™¨+ cniæ’ä»¶å’Œdockerã€‚ æœ¬æ–‡ä¸è€ƒè™‘å°†Dockerç”¨ä½œå®¹å™¨åŒ–å·¥å…·ã€‚ å¦‚æœè¦ä½¿ç”¨dockerï¼Œæ‚¨è‡ªå·±å¯ä»¥ç›¸åº”åœ°é…ç½®<a href="">æ³•å…°ç»’</a> ï¼Œæ­¤å¤–ï¼Œæ‚¨è¿˜éœ€è¦é…ç½®kubeletï¼Œå³åˆ é™¤ä¸containerdç›¸å…³çš„æ‰€æœ‰é€‰é¡¹ã€‚ å¦‚æˆ‘çš„å®éªŒæ‰€ç¤ºï¼Œå°†dockerå’Œcontaineræ”¾ç½®åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºå®¹å™¨å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ </li><li>æˆ‘ä»¬æ— æ³•å°†<code>host-gw</code>åç«¯ç”¨äºæ³•å…°ç»’ï¼Œè¯·é˜…è¯»â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ³•å…°ç»’é…ç½®â€</a>éƒ¨åˆ†ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ </li><li> æˆ‘ä»¬å°†ä¸ä¼šä½¿ç”¨ä»»ä½•ä¸œè¥¿æ¥ç›‘è§†ï¼Œå¤‡ä»½ï¼Œä¿å­˜ç”¨æˆ·æ–‡ä»¶ï¼ˆçŠ¶æ€ï¼‰ï¼Œå­˜å‚¨é…ç½®æ–‡ä»¶å’Œåº”ç”¨ç¨‹åºä»£ç ï¼ˆgit / hg / svn /ç­‰ï¼‰ </li></ul><br><h1 id="vvedenie"> å¼•è¨€ </h1><br><p> åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†å¤§é‡èµ„æºï¼Œä½†æˆ‘æƒ³åˆ†åˆ«æåŠä¸€ä¸ªç›¸å½“è¯¦å°½çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberneteså›°éš¾æ–¹æ³•</a>æŒ‡å—ï¼Œè¯¥æŒ‡å—æ¶µç›–äº†å…¶é›†ç¾¤åŸºæœ¬é…ç½®çš„90ï¼…ã€‚ å¦‚æœæ‚¨å·²ç»é˜…è¯»äº†æœ¬æ‰‹å†Œï¼Œåˆ™å¯ä»¥å®‰å…¨åœ°ç›´æ¥è¿›å…¥â€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Flannel Configurationâ€</a>éƒ¨åˆ†ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">åç§°</b> <div class="spoiler_text"><h2 id="spisok-terminov--glossariy"> æœ¯è¯­/è¯æ±‡è¡¨ </h2><br><ul><li>  api-server-ç‰©ç†æˆ–è™šæ‹Ÿæœºï¼Œç”¨äºè¿è¡Œå’Œæ­£ç¡®è¿è¡Œkubernetes kube-apiserverçš„ä¸€ç»„åº”ç”¨ç¨‹åºä½äºå…¶ä¸­ã€‚ å‡ºäºæœ¬æ–‡çš„ç›®çš„ï¼Œå®ƒæ˜¯etcdï¼Œkube-apiserverï¼Œkube-controller-managerï¼Œkube-schedulerã€‚ </li><li>  master-ä¸“ç”¨å·¥ä½œç«™æˆ–VPSå®‰è£…ï¼Œæ˜¯api-serverçš„åŒä¹‰è¯ã€‚ </li><li>  node-X-ä¸“ç”¨å·¥ä½œç«™æˆ–VPSå®‰è£…ï¼Œ <code>X</code>è¡¨ç¤ºå·¥ä½œç«™çš„åºåˆ—å·ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæ‰€æœ‰æ•°å­—éƒ½æ˜¯å”¯ä¸€çš„ï¼Œæ˜¯ç†è§£çš„å…³é”®ï¼š <br><ul><li> èŠ‚ç‚¹1-æœºå™¨ç¼–å·1 </li><li> èŠ‚ç‚¹2-æœºå™¨ç¼–å·2 </li></ul></li><li>  vCPU-è™šæ‹ŸCPUï¼Œå¤„ç†å™¨æ ¸å¿ƒã€‚ è¯¥æ•°ç›®ä¸å†…æ ¸æ•°ç›¸å¯¹åº”ï¼š1vCPU-ä¸€ä¸ªå†…æ ¸ï¼Œ2vCPU-ä¸¤ä¸ªï¼Œä¾æ­¤ç±»æ¨ã€‚ </li><li> ç”¨æˆ·-ç”¨æˆ·æˆ–ç”¨æˆ·ç©ºé—´ã€‚ åœ¨å‘½ä»¤è¡ŒæŒ‡ä»¤ä¸­ä½¿ç”¨<code>user$</code>æ—¶ï¼Œè¯¥æœ¯è¯­æŒ‡çš„æ˜¯ä»»ä½•å®¢æˆ·ç«¯è®¡ç®—æœºã€‚ </li><li>  worker-å°†åœ¨å…¶ä¸Šæ‰§è¡Œç›´æ¥è®¡ç®—çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¸<code>node-X</code> </li><li> èµ„æºæ˜¯Kubernetesé›†ç¾¤æ‰€åŸºäºçš„å®ä½“ã€‚  Kubernetesèµ„æºåŒ…æ‹¬å¤§é‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç›¸å…³å®ä½“</a> ã€‚ </li></ul></div></div><br><h1 id="setevaya-arhitektura-resheniya"> ç½‘ç»œæ¶æ„è§£å†³æ–¹æ¡ˆ </h1><br><p> åœ¨æé«˜é›†ç¾¤çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ²¡æœ‰å°†ä¼˜åŒ–é“èµ„æºçš„ä»»åŠ¡è®¾ç½®ä¸ºé€‚åˆæ¯æœˆ20ç¾å…ƒçš„é¢„ç®—ã€‚ åªéœ€è¦ç»„è£…ä¸€ä¸ªè‡³å°‘åŒ…å«ä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹ï¼‰çš„å·¥ä½œé›†ç¾¤ã€‚ å› æ­¤ï¼Œç¾¤é›†æœ€åˆçœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><ul><li> å…·æœ‰2ä¸ªvCPU / 4G RAMçš„è®¡ç®—æœºï¼šapiæœåŠ¡å™¨+èŠ‚ç‚¹1 [20 $] </li><li> å¸¦2ä¸ªvCPU / 4G RAMçš„è®¡ç®—æœºï¼šnode-2 [$ 20] </li></ul><br><p> åœ¨é›†ç¾¤çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬å·¥ä½œä¹‹åï¼Œæˆ‘å†³å®šå¯¹å…¶è¿›è¡Œé‡å»ºï¼Œä»¥ä¾¿åŒºåˆ†è´Ÿè´£åœ¨é›†ç¾¤ä¸­è¿è¡Œåº”ç”¨ç¨‹åºçš„èŠ‚ç‚¹ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼Œå®ƒä»¬ä¹Ÿæ˜¯å·¥ä½œèŠ‚ç‚¹ï¼‰å’Œä¸»æœåŠ¡å™¨çš„APIã€‚ </p><br><p> ç»“æœï¼Œæˆ‘å¾—åˆ°äº†ä»¥ä¸‹é—®é¢˜çš„ç­”æ¡ˆï¼šâ€œå¦‚æœæˆ‘ä¸æƒ³åœ¨å…¶ä¸­æ”¾ç½®æœ€åšçš„åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆå¦‚ä½•è·å¾—ä¸€ä¸ªæˆ–å¤šæˆ–å°‘ä¾¿å®œä½†è¿è¡Œè‰¯å¥½çš„ç¾¤é›†ã€‚â€ </p><br><div class="spoiler">  <b class="spoiler_title">$ 20å†³å®š</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/216/89c/a88/21689ca889156d11108e5f5327c606cc.png" alt="è®¾è®¡æ–¹æ¡ˆ"><br>  ï¼ˆè®¡åˆ’æ˜¯è¿™æ ·ï¼‰ </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Kubernetes Architectureä¸€èˆ¬ä¿¡æ¯</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/820/462/882/820462882e7cc92479190c067ac4a4f8.jpg" alt="è®¾è®¡æ–¹æ¡ˆ"><br>  ï¼ˆå¦‚æœæŸäººçªç„¶ä»ç„¶ä¸çŸ¥é“æˆ–æ²¡æœ‰çœ‹åˆ°ï¼Œåˆ™ä»äº’è”ç½‘ä¸Šçªƒå–ï¼‰ </p></div></div><br><h2 id="komponenty-i-ih-proizvoditelnost"> ç»„ä»¶åŠå…¶æ€§èƒ½ </h2><br><p> ç¬¬ä¸€æ­¥æ˜¯äº†è§£æˆ‘éœ€è¦å¤šå°‘èµ„æºæ‰èƒ½è¿è¡Œä¸ç¾¤é›†ç›´æ¥ç›¸å…³çš„è½¯ä»¶åŒ…ã€‚ æœç´¢â€œç¡¬ä»¶éœ€æ±‚â€å¹¶æ²¡æœ‰ç»™å‡ºå…·ä½“ç»“æœï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸ä»å®é™…çš„è§’åº¦æ¥è§£å†³è¿™ä¸ªä»»åŠ¡ã€‚ ä½œä¸ºå¯¹MEMå’ŒCPUçš„åº¦é‡ï¼Œæˆ‘ä»systemdé‚£é‡Œè·å¾—äº†ç»Ÿè®¡æ•°æ®-æˆ‘ä»¬å¯ä»¥å‡è®¾æµ‹é‡æ˜¯ä»¥éå¸¸ä¸šä½™çš„æ–¹å¼è¿›è¡Œçš„ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è·å¾—å‡†ç¡®å€¼çš„ä»»åŠ¡ï¼Œå› ä¸ºæˆ‘ä»ç„¶æ‰¾ä¸åˆ°æ¯å®ä¾‹5ç¾å…ƒä»¥ä¸‹çš„æ›´ä¾¿å®œçš„é€‰æ‹©ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä¸ºä»€ä¹ˆè¦5ç¾å…ƒå‘¢ï¼Ÿ</b> <div class="spoiler_text"><p> åœ¨ä¿„ç½—æ–¯æˆ–ç‹¬è”ä½“å›½å®¶/åœ°åŒºæ‰˜ç®¡æœåŠ¡å™¨æ—¶ï¼Œå¯èƒ½ä¼šå‘ç°VPS / VDSä¾¿å®œï¼Œä½†ä¸ILVåŠå…¶è¡ŒåŠ¨æœ‰å…³çš„æ‚²æƒ¨æ•…äº‹å¸¦æ¥äº†ä¸€å®šçš„é£é™©ï¼Œå¹¶è‡ªç„¶è€Œç„¶åœ°å¸Œæœ›é¿å…è¿™ç§æƒ…å†µã€‚ </p></div></div><br><p> å› æ­¤ï¼š </p><br><ul><li> ä¸»æœåŠ¡å™¨/æœåŠ¡å™¨é…ç½®ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ï¼š <br><ul><li>  etcdï¼ˆ3.2.17ï¼‰ï¼š80-100Mï¼ŒæŒ‡æ ‡æ˜¯åœ¨éšæœºé€‰æ‹©çš„æ—¶é—´è·å¾—çš„ã€‚  Etcdå¹³å‡å†…å­˜æ¶ˆè€—ä¸è¶…è¿‡300Mï¼› </li><li>  kube-apiserverï¼ˆ1.12.x-1.13.0ï¼‰ï¼š237.6Mã€œ300M; </li><li>  kube-controller-managerï¼ˆ1.12.x-1.13.0ï¼‰ï¼šå¤§çº¦9000ä¸‡ï¼Œæ²¡æœ‰è¶…è¿‡100Mï¼› </li><li>  kube-schedulerï¼ˆ1.12.x-1.13.0ï¼‰ï¼šå¤§çº¦20Mï¼Œè¶…è¿‡30-50Mçš„æ¶ˆè€—é‡æ˜¯å›ºå®šçš„ã€‚ </li></ul></li><li> å·¥ä½œæœåŠ¡å™¨é…ç½®ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰ï¼š <br><ul><li>  kubeletï¼ˆ1.12.3-1.13.1ï¼‰ï¼šå¤§çº¦35 Mbï¼Œ50Mä»¥ä¸Šçš„æ¶ˆè€—é‡ä¸æ˜¯å›ºå®šçš„ï¼› </li><li>  kube-proxyï¼ˆ1.12.3-1.13.1ï¼‰ï¼šå¤§çº¦7.5-10Mï¼› </li><li> æ³•å…°ç»’ï¼ˆ0.10.0ï¼‰ï¼šå¤§çº¦15-20Mï¼› </li><li>  corednsï¼ˆ1.3.0ï¼‰ï¼šçº¦2500ä¸‡ï¼› </li><li>  containerdï¼ˆ1.2.1ï¼‰ï¼šå®¹å™¨ä½¿ç”¨ç‡å¾ˆä½ï¼Œä½†ç»Ÿè®¡æ•°æ®è¿˜æ˜¾ç¤ºå®ˆæŠ¤ç¨‹åºå¯åŠ¨çš„å®¹å™¨è¿›ç¨‹ã€‚ </li></ul></li></ul><br><div class="spoiler">  <b class="spoiler_title">ä¸»èŠ‚ç‚¹ä¸Šæ˜¯å¦éœ€è¦å®¹å™¨/æ³Šåçª—ï¼Ÿ</b> <div class="spoiler_text"><p>  <strong>ä¸ï¼Œä¸éœ€è¦</strong> ã€‚ ä¸»èŠ‚ç‚¹ä¸éœ€è¦dockeræˆ–å®¹å™¨æœ¬èº«ï¼Œå°½ç®¡Internetä¸Šæœ‰å¤§é‡æ‰‹å†Œå‡ºäºæŸäº›ç›®çš„æˆ–å…¶ä»–ç›®çš„åŒ…æ‹¬ä½¿ç”¨ç¯å¢ƒè¿›è¡Œå®¹å™¨åŒ–ã€‚ åœ¨æœ‰é—®é¢˜çš„é…ç½®ä¸­ï¼Œæœ‰æ„ä»ä¾èµ–é¡¹åˆ—è¡¨ä¸­å…³é—­äº†containerdï¼Œä½†æ˜¯ï¼Œæˆ‘æ²¡æœ‰å¼ºè°ƒè¿™ç§æ–¹æ³•çš„ä»»ä½•æ˜æ˜¾ä¼˜åŠ¿ã€‚ </p><br><p> ä¸Šé¢æä¾›çš„é…ç½®å¾ˆå°ï¼Œè¶³ä»¥å¯åŠ¨é›†ç¾¤ã€‚ é™¤éæ‚¨è¦æ·»åŠ ä»»ä½•å†…å®¹ï¼Œå¦åˆ™ä¸éœ€è¦å…¶ä»–æ“ä½œ/ç»„ä»¶ã€‚ </p></div></div><br><p> è¦æ„å»ºç”¨äºå®¶åº­é¡¹ç›®çš„æµ‹è¯•ç¾¤é›†æˆ–ç¾¤é›†ï¼Œä¸»èŠ‚ç‚¹å¯ä»¥æ­£å¸¸è¿è¡Œ1vCPU / 1G RAMã€‚ å½“ç„¶ï¼Œä¸»èŠ‚ç‚¹ä¸Šçš„è´Ÿè½½å°†æ ¹æ®æ‰€æ¶‰åŠçš„å·¥ä½œç¨‹åºæ•°é‡ä»¥åŠå‘apiæœåŠ¡å™¨å‘é€çš„ç¬¬ä¸‰æ–¹è¯·æ±‚çš„å¯ç”¨æ€§å’Œæ•°é‡è€Œæœ‰æ‰€ä¸åŒã€‚ </p><br><p> æˆ‘æŒ‰å¦‚ä¸‹æ‰€ç¤ºåˆ†è§£äº†ä¸»é…ç½®å’Œå·¥ä½œé…ç½®ï¼š </p><br><ul><li>  1ä¸ªå…·æœ‰å·²å®‰è£…ç»„ä»¶çš„Masterï¼šetcdï¼Œkube-apiserverï¼Œkube-controller-managerï¼Œkube-scheduler </li><li>  2xå…·æœ‰å·²å®‰è£…ç»„ä»¶çš„å·¥ä½œè€…ï¼šå®¹å™¨ï¼Œcorednsï¼Œæ³•å…°ç»’ï¼Œkubeletï¼Œkube-proxy </li></ul><br><h1 id="konfiguraciya"> æ„å‹ </h1><br><p> è¦é…ç½®å‘å¯¼ï¼Œéœ€è¦ä»¥ä¸‹ç»„ä»¶ï¼š </p><br><ul><li><p>  etcd-ç”¨äºå­˜å‚¨apiæœåŠ¡å™¨ä»¥åŠæ³•å…°ç»’çš„æ•°æ®ï¼› </p><br></li><li><p>  kube-apiserver-å®é™…ä¸Šæ˜¯api-server; </p><br></li><li><p>  kube-controller-manager-ç”¨äºç”Ÿæˆå’Œå¤„ç†äº‹ä»¶ï¼› </p><br></li><li><p>  kube-scheduler-ç”¨äºåˆ†é…é€šè¿‡apiæœåŠ¡å™¨æ³¨å†Œçš„èµ„æº-ä¾‹å¦‚ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">hearth</a> ã€‚ <br> å¯¹äºä¸»åŠ›é…ç½®ï¼Œéœ€è¦ä»¥ä¸‹ç»„ä»¶ï¼š </p><br></li><li><p>  kubelet-è¿è¡Œç‚‰è†›ï¼Œé…ç½®ç½‘ç»œè®¾ç½®ï¼› </p><br></li><li><p>  kube-proxy-ç”¨äºç»„ç»‡kubernetes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœåŠ¡çš„</a>è·¯ç”±/å¹³è¡¡; </p><br></li><li><p>  coredns-ç”¨äºåœ¨æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­å‘ç°æœåŠ¡ï¼› </p><br></li><li><p> æ³•å…°ç»’-ç”¨äºç»„ç»‡åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨çš„ç½‘ç»œè®¿é—®ï¼Œä»¥åŠç”¨äºåœ¨ç¾¤é›†èŠ‚ç‚¹ï¼ˆkubernetesèŠ‚ç‚¹ï¼‰ä¹‹é—´åŠ¨æ€åˆ†é…ç½‘ç»œã€‚ </p><br></li></ul><br><div class="spoiler">  <b class="spoiler_title">æ ¸å¿ƒåŸŸå</b> <div class="spoiler_text"><p> è¿™é‡Œåº”è¯¥åšä¸ªå°é¢˜å¤–è¯ï¼šcorednsä¹Ÿå¯ä»¥åœ¨ä¸»æœåŠ¡å™¨ä¸Šå¯åŠ¨ã€‚ é™¤äº†coredns.serviceé…ç½®çš„ç»†å¾®å·®åˆ«å¤–ï¼Œæ²¡æœ‰å…¶ä»–é™åˆ¶ä¼šè¿«ä½¿corednsåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¯¥é…ç½®ç»†å¾®å·®åˆ«æ˜¯ç”±äºä¸systemd-resolvedæœåŠ¡å†²çªè€Œæ ¹æœ¬æ— æ³•åœ¨æ ‡å‡†/æœªä¿®æ”¹çš„UbuntuæœåŠ¡å™¨ä¸Šå¯åŠ¨ã€‚ æˆ‘æ²¡æœ‰å°è¯•è§£å†³æ­¤é—®é¢˜ï¼Œå› ä¸ºä½äºå·¥ä½œèŠ‚ç‚¹ä¸Šçš„2 nsæœåŠ¡å™¨å¯¹æˆ‘å¾ˆæ»¡æ„ã€‚ </p></div></div><br><p> ä¸ºäº†ä¸æµªè´¹æ—¶é—´ç°åœ¨ç†Ÿæ‚‰ç»„ä»¶é…ç½®è¿‡ç¨‹çš„æ‰€æœ‰ç»†èŠ‚ï¼Œæˆ‘å»ºè®®æ‚¨åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberneteså›°éš¾æ–¹æ³•</a>æŒ‡å—ä¸­ç†Ÿæ‚‰å®ƒä»¬ã€‚ æˆ‘å°†é‡ç‚¹ä»‹ç»é…ç½®é€‰é¡¹çš„ç‹¬ç‰¹åŠŸèƒ½ã€‚ </p><br><h2 id="fayly"> æ¡£æ¡ˆ </h2><br><p> ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ‰€æœ‰ç”¨äºå‘å¯¼å’Œå·¥ä½œèŠ‚ç‚¹çš„é›†ç¾¤ç»„ä»¶è¿è¡Œçš„æ–‡ä»¶éƒ½æ”¾åœ¨<strong>/ var / lib / kubernetes /</strong>ä¸­ã€‚ å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥ç”¨å…¶ä»–æ–¹å¼æ”¾ç½®å®ƒä»¬ã€‚ </p><br><h2 id="sertifikaty"> èµ„è´¨è®¤è¯ </h2><br><p> ç”Ÿæˆè¯ä¹¦çš„åŸºç¡€ä»ç„¶æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesçš„è‰°è¾›æ–¹å¼</a> ï¼Œå®é™…ä¸Šæ²¡æœ‰æ˜æ˜¾å·®å¼‚ã€‚ ä¸ºäº†é‡æ–°ç”Ÿæˆä»å±è¯ä¹¦ï¼Œå›´ç»•<a href="">cfssl</a>åº”ç”¨ç¨‹åºç¼–å†™äº†ç®€å•çš„bashè„šæœ¬-è¿™åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨ã€‚ </p><br><p> æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesçš„ç¡¬æ–¹æ³•</a>æˆ–å…¶ä»–åˆé€‚çš„å·¥å…·æ¥ç”Ÿæˆæ»¡è¶³æ‚¨éœ€æ±‚çš„è¯ä¹¦ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä½¿ç”¨bashè„šæœ¬ç”Ÿæˆè¯ä¹¦</b> <div class="spoiler_text"><p> æ‚¨å¯ä»¥åœ¨æ­¤å¤„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è·å–</a>è„šæœ¬ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubernetes bootstrap</a> ã€‚ å¼€å§‹ä¹‹å‰ï¼Œç¼–è¾‘æ–‡ä»¶<a href="">certs / env.sh</a> ï¼ŒæŒ‡å®šè®¾ç½®ã€‚ ä¸€ä¸ªä¾‹å­ï¼š </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> certs <span class="hljs-comment"><span class="hljs-comment">#:   certs$ ./generate-keys.sh # ... certificate generate output #:  kubeconfig     certs$ ./generate-configkube.sh</span></span></code> </pre> <br><p> å¦‚æœæ‚¨ä½¿ç”¨<code>env.sh</code>å¹¶æ­£ç¡®æŒ‡å®šäº†æ‰€æœ‰å‚æ•°ï¼Œåˆ™æ— éœ€è§¦æ‘¸ç”Ÿæˆçš„è¯ä¹¦ã€‚ å¦‚æœæ‚¨åœ¨æŸä¸ªæ—¶å€™çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆå¯ä»¥åˆ†éƒ¨åˆ†åœ°é‡æ–°ç”Ÿæˆè¯ä¹¦ã€‚ ä¸Šé¢çš„bashè„šæœ¬å¾ˆç®€å•ï¼Œå°†å®ƒä»¬æ•´ç†å‡ºæ¥å¹¶ä¸å›°éš¾ã€‚ </p><br><p> é‡è¦è¯´æ˜-æ‚¨ä¸åº”è¯¥ç»å¸¸é‡æ–°åˆ›å»º<code>ca.pem</code>å’Œ<code>ca-key.pem</code>è¯ä¹¦ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æ‰€æœ‰åç»­è¯ä¹¦çš„æ ¹è¯ä¹¦ï¼Œæ¢å¥è¯è¯´ï¼Œæ‚¨å°†å¿…é¡»é‡æ–°åˆ›å»ºæ‰€æœ‰é™„å¸¦çš„è¯ä¹¦ï¼Œå¹¶å°†å®ƒä»¬äº¤ä»˜ç»™æ‰€æœ‰è®¡ç®—æœºå’Œæ‰€æœ‰å¿…è¦çš„ç›®å½•ã€‚ </p></div></div><br><h3 id="master"> å¤§å¸ˆ </h3><br><p> åœ¨ä¸»èŠ‚ç‚¹ä¸Šå¯åŠ¨æœåŠ¡æ‰€éœ€çš„è¯ä¹¦åº”æ”¾åœ¨<code>/var/lib/kubernetes/</code> ï¼š </p><br><ul><li>  ca.pem-è¯¥è¯ä¹¦åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ï¼Œåªèƒ½ç”Ÿæˆä¸€æ¬¡ï¼Œç„¶åä½¿ç”¨ä¸”æ— éœ€æ›´æ”¹ï¼Œå› æ­¤è¯·å½“å¿ƒã€‚ é‡æ–°ç”Ÿæˆå®ƒæ—¶ï¼Œæ‚¨å°†éœ€è¦å°†å…¶å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨å®ƒæ›´æ–°kubeconfigæ–‡ä»¶ï¼ˆä¹Ÿåœ¨æ‰€æœ‰è®¡ç®—æœºä¸Šï¼‰ã€‚ </li><li>  ca-key.pemä¸åœ¨èŠ‚ç‚¹ä¸Šå¤åˆ¶ç›¸åŒã€‚ </li><li>  kube-controller-manager.pem-ä»…ç”¨äºkube-controller-managerã€‚ </li><li>  kube-controller-manager-key.pem-ä»…ç”¨äºkube-controller-managerã€‚ </li><li><p>  kubernetes.pem-ç»’æ¯›ï¼Œè¿æ¥åˆ°etcdçš„corednsï¼Œkube-apiserveræ—¶å¿…éœ€ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç†è®ºæ’¤é€€</b> <div class="spoiler_text"><p> è¯¥åŠŸèƒ½åŸºäº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesçš„ç¡¬æ–¹å¼</a>é…ç½®é€»è¾‘ã€‚ <br> åŸºäºæ­¤ï¼Œåœ¨å‘å¯¼å’Œå·¥ä½œèŠ‚ç‚¹ä¸Šçš„ä»»ä½•åœ°æ–¹éƒ½å°†éœ€è¦æ­¤æ–‡ä»¶ã€‚ æˆ‘æ²¡æœ‰æ›´æ”¹åŸå§‹æ‰‹å†Œæä¾›çš„æ–¹æ³•ï¼Œå› ä¸ºæœ‰äº†å®ƒçš„å¸®åŠ©ï¼Œå¯ä»¥æ›´å¿«ï¼Œæ›´æ¸…æ™°åœ°ç»„ç»‡é›†ç¾¤æ“ä½œå¹¶ç†è§£æ•´ä¸ªä¾èµ–å…³ç³»ã€‚ </p><br><p> æˆ‘ä¸ªäººçš„è§‚ç‚¹æ˜¯ï¼Œå¯¹äºetcdï¼Œæ‚¨éœ€è¦å•ç‹¬çš„è¯ä¹¦ï¼Œè¯¥è¯ä¹¦ä¸èƒ½ä¸ç”¨äºkubernetesçš„è¯ä¹¦é‡å ã€‚ </p><br></div></div><br></li></ul><br><ul><li>  kubernetes-key.pem-ä¿ç•™åœ¨ä¸»æœåŠ¡å™¨ä¸Šã€‚ </li><li>  service-account.pem-ä»…kube-controller-managerå®ˆæŠ¤ç¨‹åºéœ€è¦ã€‚ </li><li>  service-account-key.pem-ç±»ä¼¼ã€‚ </li></ul><br><h3 id="rabochie-uzly"> å·¥ä½œå•ä½ </h3><br><ul><li>  ca.pem-å·¥ä½œèŠ‚ç‚¹ä¸Šæ¶‰åŠçš„æ‰€æœ‰æœåŠ¡ï¼ˆkubeletï¼Œkube-proxyï¼‰ä»¥åŠæ³•å…°ç»’ï¼Œcorednsæ‰€éœ€çš„ã€‚ å…¶ä¸­ï¼Œä½¿ç”¨kubectlç”Ÿæˆæ—¶ï¼Œå…¶å†…å®¹åŒ…å«åœ¨kubeconfigæ–‡ä»¶ä¸­ã€‚ </li><li>  kubernetes-key.pem-ä»…ç”¨äºæ³•å…°ç»’å’Œcorednsè¿æ¥åˆ°ä½äºapiä¸»èŠ‚ç‚¹ä¸Šçš„etcdã€‚ </li><li>  kubernetes.pem-ä¸å‰ä¸€ä¸ªç±»ä¼¼ï¼Œä»…æ³•å…°ç»’å’Œcorednsæ‰éœ€è¦ã€‚ </li><li>  kubelet / node-1.pem-æˆæƒèŠ‚ç‚¹1çš„å¯†é’¥ã€‚ </li><li>  kubelet / node-1-key.pem-æˆæƒèŠ‚ç‚¹1çš„å¯†é’¥ã€‚ </li></ul><br><p>  <strong>é‡è¦ï¼</strong> å¦‚æœæ‚¨æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹å°†åœ¨kubeletä¸­åŒ…å«<code>node-X-key.pem</code> ï¼Œ <code>node-X.pem</code>å’Œ<code>node-X.kubeconfig</code>æ–‡ä»¶ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">è¯ä¹¦è°ƒè¯•</b> <div class="spoiler_text"><h4 id="otladka-sertifikatov"> è¯ä¹¦è°ƒè¯• </h4><br><p> æœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦æŸ¥çœ‹è¯ä¹¦çš„é…ç½®æ–¹å¼ï¼Œä»¥æ‰¾å‡ºç”¨äºç”Ÿæˆè¯ä¹¦çš„IP / DNSä¸»æœºã€‚  <code>cfssl-certinfo -cert &lt;cert&gt;</code>å‘½ä»¤å°†å¸®åŠ©æˆ‘ä»¬è§£å†³æ­¤é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬äº†è§£æœ‰å…³<code>node-1.pem</code> ï¼š </p><br><pre> <code class="bash hljs">$ cfssl-certinfo -cert node-1.pem</code> </pre> <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"subject"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"system:node:node-1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"country"</span></span>: <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"organization"</span></span>: <span class="hljs-string"><span class="hljs-string">"system:nodes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"organizational_unit"</span></span>: <span class="hljs-string"><span class="hljs-string">"Infrastructure Unit"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"locality"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"province"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-string"><span class="hljs-string">"system:nodes"</span></span>, <span class="hljs-string"><span class="hljs-string">"Infrastructure Unit"</span></span>, <span class="hljs-string"><span class="hljs-string">"system:node:node-1"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"issuer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kubernetes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"country"</span></span>: <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"organization"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kubernetes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"organizational_unit"</span></span>: <span class="hljs-string"><span class="hljs-string">"Infrastructure"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"locality"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"province"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-string"><span class="hljs-string">"Moscow"</span></span>, <span class="hljs-string"><span class="hljs-string">"Kubernetes"</span></span>, <span class="hljs-string"><span class="hljs-string">"Infrastructure"</span></span>, <span class="hljs-string"><span class="hljs-string">"Kubernetes"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"serial_number"</span></span>: <span class="hljs-string"><span class="hljs-string">"161113741562559533299282037709313751074033027073"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sans"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"w40k.net"</span></span>, <span class="hljs-string"><span class="hljs-string">"node-1"</span></span>, <span class="hljs-string"><span class="hljs-string">"178.79.168.130"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.164.230"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"not_before"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-01-04T14:24:00Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"not_after"</span></span>: <span class="hljs-string"><span class="hljs-string">"2029-01-01T14:24:00Z"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sigalg"</span></span>: <span class="hljs-string"><span class="hljs-string">"SHA256WithRSA"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"authority_key_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"6:C8:94:67:59:55:19:82:AD:ED:6D:50:F1:89:B:8D:46:78:FD:9A"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"subject_key_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"A1:5E:B3:3C:45:14:3D:C6:C:A:97:82:1:D5:2B:75:1A:A6:9D:B0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pem"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;pem content&gt;"</span></span> }</code> </pre> </div></div><br><p>  kubeletå’Œkube-proxyçš„æ‰€æœ‰å…¶ä»–è¯ä¹¦ç›´æ¥åµŒå…¥åˆ°ç›¸åº”çš„kubeconfigä¸­ã€‚ </p><br><h2 id="kubeconfig">  kubeconfig </h2><br><p> æ‰€æœ‰å¿…éœ€çš„kubeconfigéƒ½å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesè‰°éš¾åœ°å®Œæˆ</a> ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œæœ‰äº›åŒºåˆ«å¼€å§‹äº†ã€‚ è¯¥æ‰‹å†Œä½¿ç”¨<code>kubedns</code>å’Œ<code>cni bridge</code>é…ç½®ï¼Œè¿˜æ¶µç›–äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">coredns</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ³•å…°ç»’</a> ã€‚ è¿™ä¸¤ä¸ªæœåŠ¡ä¾æ¬¡ä½¿ç”¨<code>kubeconfig</code>åˆ°é›†ç¾¤ã€‚ </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> certs <span class="hljs-comment"><span class="hljs-comment">#:  kubeconfig     certs$ ./generate-configkube.sh</span></span></code> </pre> <br><h3 id="master-1"> å¤§å¸ˆ </h3><br><p> å¯¹äºè¯¥å‘å¯¼ï¼Œéœ€è¦ä»¥ä¸‹kubeconfigæ–‡ä»¶ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼Œç”Ÿæˆåå¯ä»¥åœ¨<code>certs/kubeconfig</code> ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">master /var/lib/kubernetes/$ tree -L 2 . +-- kube-controller-manager.kubeconfig L-- kube-scheduler  L-- kube-scheduler.kubeconfig</code> </pre> <br><p> è¿™äº›æ–‡ä»¶æ˜¯è¿è¡Œæ¯ä¸ªæœåŠ¡ç»„ä»¶æ‰€å¿…éœ€çš„ã€‚ </p><br><h3 id="rabochie-uzly-1"> å·¥ä½œå•ä½ </h3><br><p> å¯¹äºå·¥ä½œèŠ‚ç‚¹ï¼Œéœ€è¦ä»¥ä¸‹kubeconfigæ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">node-1 /var/lib/kubernetes/$ tree -L 2 . +-- coredns Â¦  L-- coredns.kubeconfig +-- flanneld Â¦  L-- flanneld.kubeconfig +-- kubelet Â¦  L-- node-1.kubeconfig L-- kube-proxy  L-- kube-proxy.kubeconfig</code> </pre> <br><h2 id="zapusk-servisov"> æœåŠ¡å¯åŠ¨ </h2><br><div class="spoiler">  <b class="spoiler_title">æœåŠ¡é¡¹ç›®</b> <div class="spoiler_text"><p> å°½ç®¡æˆ‘çš„å·¥ä½œèŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„åˆå§‹åŒ–ç³»ç»Ÿï¼Œä½†æ˜¯ç¤ºä¾‹å’Œå­˜å‚¨åº“ä½¿ç”¨systemdæä¾›äº†é€‰é¡¹ã€‚ åœ¨ä»–ä»¬çš„å¸®åŠ©ä¸‹ï¼Œæœ€å®¹æ˜“ç†è§£æ‚¨éœ€è¦å¯åŠ¨å“ªä¸ªè¿‡ç¨‹å’Œå“ªä¸ªå‚æ•°ï¼Œæ­¤å¤–ï¼Œåœ¨ç ”ç©¶å¸¦æœ‰ç›®æ ‡æ ‡å¿—çš„æœåŠ¡æ—¶ï¼Œå®ƒä»¬ä¸ä¼šå¼•èµ·å¤§é—®é¢˜ã€‚ </p></div></div><br><p> è¦å¯åŠ¨æœåŠ¡ï¼Œæ‚¨éœ€è¦å°†<code>service-name.service</code>å¤åˆ¶åˆ°<code>/lib/systemd/system/</code>æˆ–systemdæœåŠ¡æ‰€åœ¨çš„ä»»ä½•å…¶ä»–ç›®å½•ï¼Œç„¶åæ‰“å¼€å¹¶å¯åŠ¨è¯¥æœåŠ¡ã€‚  kube-apiserverçš„ç¤ºä¾‹ï¼š </p><br><pre> <code class="bash hljs">$ systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> kube-apiserver.service $ systemctl start kube-apiserver.service</code> </pre> <br><p> å½“ç„¶ï¼Œæ‰€æœ‰æœåŠ¡éƒ½å¿…é¡»æ˜¯<em>ç»¿è‰²çš„</em> ï¼ˆå³è¿è¡Œå’Œè¿è¡Œä¸­ï¼‰ã€‚ å¦‚æœé‡åˆ°é”™è¯¯ï¼Œ <code>journalct -xe</code>æˆ–<code>journal -f -t kube-apiserver</code>å°†å¸®åŠ©æ‚¨äº†è§£åˆ°åº•å‡ºäº†ä»€ä¹ˆé—®é¢˜ã€‚ </p><br><p> ä¸è¦æ€¥äºç«‹å³å¯åŠ¨æ‰€æœ‰æœåŠ¡å™¨ï¼Œå› ä¸ºå¯åŠ¨è¶³ä»¥å¯ç”¨etcdå’Œkube-apiserverã€‚ å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå¹¶ä¸”æ‚¨ç«‹å³è·å¾—äº†è¯¥å‘å¯¼çš„æ‰€æœ‰å››é¡¹æœåŠ¡ï¼Œåˆ™å¯ä»¥å°†å‘å¯¼å¯åŠ¨è§†ä¸ºæˆåŠŸã€‚ </p><br><h3 id="master-2"> å¤§å¸ˆ </h3><br><p> æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">systemd</a>è®¾ç½®æˆ–ä¸ºæ­£åœ¨ä½¿ç”¨çš„é…ç½®ç”Ÿæˆåˆå§‹åŒ–è„šæœ¬ã€‚ å¦‚å‰æ‰€è¿°ï¼Œå¯¹äºæ¯ç‰ˆï¼Œæ‚¨éœ€è¦ï¼š </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / etcd</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / kube-apiserver</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / kube-controller-manager</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / kube-scheduler</a> </p><br><h3 id="rabochie-uzly-2"> å·¥ä½œå•ä½ </h3><br><p>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç³»ç»ŸåŒ–/å®¹å™¨åŒ–</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / kubelet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / kube-proxy</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-systemd / coredns</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç³»ç»Ÿ/æ³•å…°ç»’</a> </p><br><h3 id="klient"> é¡¾å®¢ </h3><br><p> ä¸ºäº†ä½¿å®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œï¼Œåªéœ€åœ¨<code>${HOME}/.kube/config</code> <code>certs/kubeconfig/admin.kubeconfig</code>å¤åˆ¶<code>certs/kubeconfig/admin.kubeconfig</code> ï¼ˆåœ¨ç”Ÿæˆæˆ–è‡ªå·±ç¼–å†™åï¼‰ <code>${HOME}/.kube/config</code> </p><br><p> ä¸‹è½½<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubectl</a>å¹¶æ£€æŸ¥kube-apiserverçš„æ“ä½œã€‚ è®©æˆ‘å†æ¬¡æé†’æ‚¨ï¼Œåœ¨æ­¤é˜¶æ®µï¼Œä¸ºäº†ä½¿kube-apiserveræ­£å¸¸å·¥ä½œï¼Œåªæœ‰etcdåº”è¯¥èµ·ä½œç”¨ã€‚ ç¨åï¼Œç¾¤é›†çš„å…¨éƒ¨æ“ä½œå°†éœ€è¦å…¶ä½™ç»„ä»¶ã€‚ </p><br><p> æ£€æŸ¥kube-apiserverå’Œkubectlæ˜¯å¦å·¥ä½œï¼š </p><br><pre> <code class="bash hljs">$ kubectl version Client Version: version.Info{Major:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, Minor:<span class="hljs-string"><span class="hljs-string">"13"</span></span>, GitVersion:<span class="hljs-string"><span class="hljs-string">"v1.13.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"extra info"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>} Server Version: version.Info{Major:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, Minor:<span class="hljs-string"><span class="hljs-string">"13"</span></span>, GitVersion:<span class="hljs-string"><span class="hljs-string">"v1.13.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"extra info"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>}</code> </pre> <br><h1 id="konfiguraciya-flannel"> ç»’å¸ƒé…ç½® </h1><br><p> ä½œä¸ºæ³•å…°ç»’é…ç½®ï¼Œæˆ‘é€‰æ‹©äº†<code>vxlan</code>åç«¯ã€‚  <a href="">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³åç«¯çš„æ›´å¤šä¿¡æ¯ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">host-gwï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒä¸èµ·ä½œç”¨</b> <div class="spoiler_text"><p> æˆ‘å¿…é¡»é©¬ä¸Šè¯´ï¼Œåœ¨VPSä¸Šè¿è¡Œkubernetesé›†ç¾¤å¯èƒ½ä¼šé™åˆ¶æ‚¨ä½¿ç”¨<code>host-gw</code>åç«¯ã€‚ ç”±äºä¸æ˜¯ç»éªŒä¸°å¯Œçš„ç½‘ç»œå·¥ç¨‹å¸ˆï¼Œæˆ‘èŠ±äº†å¤§çº¦ä¸¤å¤©çš„æ—¶é—´è¿›è¡Œè°ƒè¯•ï¼Œä»¥äº†è§£åœ¨æµè¡Œçš„VDS / VPSæä¾›å•†ä¸Šä½¿ç”¨å®ƒæ—¶å‡ºç°çš„é—®é¢˜ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linode.com</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">digitalocean</a>å·²ç»è¿‡æµ‹è¯•ã€‚ é—®é¢˜çš„å®è´¨æ˜¯æä¾›å•†æ²¡æœ‰ä¸ºä¸“ç”¨ç½‘ç»œæä¾›è¯šå®çš„L2ã€‚ åè¿‡æ¥ï¼Œè¿™ä½¿å¾—åœ¨è¿™ç§é…ç½®ä¸‹æ— æ³•åœ¨èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨ç½‘ç»œæµé‡ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e0c/c7e/add/e0cc7eadd6253cf4921df17ca6fe5d47.png" alt="äº¤é€šé‡"></p><br><p> ä¸ºäº†ä½¿ç½‘ç»œæµé‡èƒ½å¤Ÿåœ¨èŠ‚ç‚¹ä¹‹é—´å·¥ä½œï¼Œæ­£å¸¸çš„è·¯ç”±å°±è¶³å¤Ÿäº†ã€‚ ä¸è¦å¿˜è®°å°†net.ipv4.ip_forwardè®¾ç½®ä¸º1ï¼Œå¹¶ä¸”è¿‡æ»¤å™¨è¡¨ä¸­çš„FORWARDé“¾ä¸åº”åŒ…å«èŠ‚ç‚¹çš„ç¦æ­¢è§„åˆ™ã€‚ </p><br><pre> <code class="bash hljs">node1$ ip route add 10.200.12.0/24 via 192.168.1.2 node2$ ip route add 10.200.8.0/24 via 192.168.1.1</code> </pre> <br><pre> <code class="plaintext hljs">[10.200.80.23 container-1]-&gt;[192.168.1.1 node-1]-&gt;[192.168.1.2 node-2]-&gt;[10.200.12.5 container-2]</code> </pre> <br><p> è¿™æ°æ°å¯¹æŒ‡ç¤ºçš„VPS / VDSï¼ˆå¹¶ä¸”å¾ˆå¯èƒ½é€šå¸¸å¯¹æ‰€æœ‰VDS / VDSï¼‰ä¸èµ·ä½œç”¨ã€‚ </p><br><p> å› æ­¤ï¼Œå¦‚æœåœ¨èŠ‚ç‚¹ä¹‹é—´é…ç½®å…·æœ‰è¾ƒé«˜ç½‘ç»œæ€§èƒ½çš„è§£å†³æ–¹æ¡ˆ<strong>å¯¹</strong>æ‚¨<strong>æ¥è¯´å¾ˆé‡è¦ï¼Œ</strong>é‚£ä¹ˆæ‚¨ä»ç„¶å¿…é¡»èŠ±è´¹20å¤šç¾å…ƒæ¥ç»„ç»‡é›†ç¾¤ã€‚ </p></div></div><br><p> æ‚¨å¯ä»¥ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">etc / flannel</a>ä½¿ç”¨<code>set-flannel-config.sh</code>æ¥è®¾ç½®æ‰€éœ€çš„ç»’å¸ƒé…ç½®ã€‚  <strong>é‡è¦çš„æ˜¯è¦è®°ä½</strong> ï¼šå¦‚æœå†³å®šæ›´æ”¹åç«¯ï¼Œåˆ™éœ€è¦åˆ é™¤etcdä¸­çš„é…ç½®å¹¶é‡æ–°å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰æ³•å…°ç»’å®ˆæŠ¤ç¨‹åºï¼Œå› æ­¤è¯·æ˜æ™ºåœ°é€‰æ‹©å®ƒã€‚ é»˜è®¤å€¼ä¸ºvxlanã€‚ </p><br><pre> <code class="bash hljs">master$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ETCDCTL_CA_FILE=<span class="hljs-string"><span class="hljs-string">'/var/lib/kubernetes/ca.pem'</span></span> master$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ETCDCTL_CERT_FILE=<span class="hljs-string"><span class="hljs-string">'/var/lib/kubernetes/kubernetes.pem'</span></span> master$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ETCDCTL_KEY_FILE=<span class="hljs-string"><span class="hljs-string">'/var/lib/kubernetes/kubernetes-key.pem'</span></span> master$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ETCDCTL_ENDPOINTS=<span class="hljs-string"><span class="hljs-string">'https://127.0.0.1:2379'</span></span> master$ etcdctl ls /coreos.com/network/subnets/ /coreos.com/network/subnets/10.200.8.0-24 /coreos.com/network/subnets/10.200.12.0-24 master$ etcdctl get /coreos.com/network/subnets/10.200.8.0-24 {<span class="hljs-string"><span class="hljs-string">"PublicIP"</span></span>:<span class="hljs-string"><span class="hljs-string">"178.79.168.130"</span></span>,<span class="hljs-string"><span class="hljs-string">"BackendType"</span></span>:<span class="hljs-string"><span class="hljs-string">"vxlan"</span></span>,<span class="hljs-string"><span class="hljs-string">"BackendData"</span></span>:{<span class="hljs-string"><span class="hljs-string">"VtepMAC"</span></span>:<span class="hljs-string"><span class="hljs-string">"22:ca:ac:15:71:59"</span></span>}}</code> </pre> <br><p> åœ¨etcdä¸­æ³¨å†Œæ‰€éœ€çš„é…ç½®åï¼Œæ‚¨éœ€è¦é…ç½®æœåŠ¡ä»¥åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œå®ƒã€‚ </p><br><h2 id="flannelservice"> æ³•å…°ç»’æœåŠ¡ </h2><br><p> å¯ä»¥åœ¨æ­¤å¤„ä½¿ç”¨è¯¥æœåŠ¡çš„ç¤ºä¾‹ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">systemd / flannel</a> </p><br><div class="spoiler">  <b class="spoiler_title">æ³•å…°ç»’æœåŠ¡</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[Unit] Description=Flanneld overlay address etcd agent After=network.target [Service] Type=notify #: current host ip. don't change if ip have not changed Environment=PUBLIC_IP=178.79.168.130 Environment=FLANNEL_ETCD=https://192.168.153.60:2379 ExecStart=/usr/bin/flanneld \ -etcd-endpoints=${FLANNEL_ETCD} -etcd-prefix=${FLANNEL_ETCD_KEY} \ -etcd-cafile=/var/lib/kubernetes/ca.pem \ -etcd-certfile=/var/lib/kubernetes/kubernetes.pem \ -etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \ -etcd-prefix=/coreos.com/network \ -healthz-ip=127.0.0.1 \ -subnet-file=/run/flannel/subnet.env \ -public-ip=${PUBLIC_IP} \ -kubeconfig-file=/var/lib/kubernetes/config/kubeconfig/flanneld.kubeconfig \ $FLANNEL_OPTIONS ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker Restart=on-failure RestartSec=5 [Install] RequiredBy=docker.service</code> </pre> </div></div><br><h2 id="nastroyka"> å®¢åˆ¶åŒ– </h2><br><p> å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦ca.pemï¼Œkubernetes.pemå’Œkubernetes-key.pemæ–‡ä»¶åœ¨etcdä¸­è¿›è¡Œæˆæƒã€‚ æ‰€æœ‰å…¶ä»–å‚æ•°ä¸å…·æœ‰ä»»ä½•ç¥åœ£å«ä¹‰ã€‚ çœŸæ­£é‡è¦çš„å”¯ä¸€äº‹æƒ…æ˜¯é…ç½®å…¨å±€IPåœ°å€ï¼Œç½‘ç»œæ•°æ®åŒ…å°†é€šè¿‡è¯¥IPåœ°å€åœ¨ç½‘ç»œä¹‹é—´ä¼ é€’ï¼š </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/037/e54/803/037e5480319cedd1e662c925bce23b3e.png" alt="æ³•å…°ç»’ç½‘ç»œ"><br>  ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¸¦æ³•å…°ç»’çš„å¤šä¸»æœºç½‘ç»œè¦†ç›–</a> ï¼‰ </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#:   node-1$ systemctl enable flanneld.service #:  node-1$ systemctl start flanneld</span></span></code> </pre> <br><p> æˆåŠŸå¯åŠ¨æ³•å…°ç»’åï¼Œæ‚¨åº”è¯¥åœ¨ç³»ç»Ÿä¸Šæ‰¾åˆ°flannel.Nç½‘ç»œæ¥å£ï¼š </p><br><pre> <code class="plaintext hljs">node-1$ ifconfig flannel.100: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1450 inet 10.200.8.0 netmask 255.255.255.255 broadcast 0.0.0.0 inet6 fe80::20ca:acff:fe15:7159 prefixlen 64 scopeid 0x20&lt;link&gt; ether 22:ca:ac:15:71:59 txqueuelen 0 (Ethernet) RX packets 18853 bytes 1077085 (1.0 MiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 11856 bytes 264331154 (252.0 MiB) TX errors 0 dropped 47 overruns 0 carrier 0 collisions 0</code> </pre> <br><p> æ£€æŸ¥æ‚¨çš„æ¥å£åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ˜¯å¦æ­£å¸¸å·¥ä½œéå¸¸ç®€å•ã€‚ åœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹1å’ŒèŠ‚ç‚¹2åˆ†åˆ«å…·æœ‰10.200.8.0/24å’Œ10.200.12.0/24ç½‘ç»œï¼Œå› æ­¤å¯¹äºå¸¸è§„icmpè¯·æ±‚ï¼Œæˆ‘ä»¬æ£€æŸ¥å…¶å¯ç”¨æ€§ï¼š </p><br><pre> <code class="plaintext hljs">#:  node-2  node-1 node-1 $ ping -c 1 10.200.12.0 PING 10.200.12.0 (10.200.12.0) 56(84) bytes of data. 64 bytes from 10.200.12.0: icmp_seq=1 ttl=64 time=4.58 ms #:  node-1  node-2 node-2 $ ping -c 1 10.200.8.0 PING 10.200.8.0 (10.200.8.0) 56(84) bytes of data. 64 bytes from 10.200.8.0: icmp_seq=1 ttl=64 time=1.44 ms</code> </pre> <br><p> å¦‚æœå‡ºç°ä»»ä½•é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥ä¸»æœºä¹‹é—´åŸºäºUDPçš„iptablesä¸­æ˜¯å¦å­˜åœ¨ä»»ä½•å‰ªåˆ‡è§„åˆ™ã€‚ </p><br><h1 id="konfiguraciya-containerd"> å®¹å™¨é…ç½® </h1><br><p> å°†<a href="">etc / containerded / config.toml</a>æ”¾åœ¨<code>/etc/containerd/config.toml</code>æˆ–æ‚¨æ–¹ä¾¿çš„ä»»ä½•åœ°æ–¹ï¼Œä¸»è¦è¦è®°ä½è¦æ›´æ”¹æœåŠ¡ä¸­é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼ˆcontainerd.serviceï¼Œå¦‚ä¸‹æ‰€è¿°ï¼‰ã€‚ </p><br><p> å¯¹æ ‡å‡†è¿›è¡Œä¸€äº›ä¿®æ”¹çš„é…ç½®ã€‚ å¦‚æœæ‚¨ä¸äº†è§£æ‰§è¡Œæ­¤æ“ä½œçš„åŸå› ï¼Œè¯·ä¸è¦<strong>å°†</strong> <code>enable_tls_streaming = true</code> <strong>è®¾ç½®ä¸ºé‡è¦</strong> ã€‚ å¦åˆ™ï¼Œ <code>kubectl exec</code>å°†åœæ­¢å·¥ä½œï¼Œå¹¶ç»™å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œè¡¨æ˜è¯¥è¯ä¹¦æ˜¯ç”±æœªçŸ¥æ–¹ç­¾åçš„ã€‚ </p><br><h2 id="containerdservice"> containerd.service </h2><br><div class="spoiler"> <b class="spoiler_title">containerd.service</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target [Service] ; uncomment this if your overlay module are built as module ; ExecStartPre=/sbin/modprobe overlay ExecStart=/usr/bin/containerd \ -c /etc/containerd/config.toml Restart=always RestartSec=5 Delegate=yes KillMode=process OOMScoreAdjust=-999 LimitNOFILE=1048576 LimitNPROC=infinity LimitCORE=infinity [Install] WantedBy=multi-user.target</code> </pre> </div></div><br><h2 id="nastroyka-1"> å®¢åˆ¶åŒ– </h2><br><p>  ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">cri-tools</a> . <br>  <a href="">etc/crictl.yaml</a>  <code>/etc/crictl.yaml</code> .      : </p><br><pre> <code class="bash hljs">node-1$ CONTAINERD_NAMESPACE=k8s.io crictl ps CONTAINER ID IMAGE CREATED STATE NAME ATTEMPT POD ID</code> </pre> <br><p>  ,    -    kubernetes , crictl       , ,    . </p><br><h1 id="konfiguraciya-cni-plugins">  CNI Plugins </h1><br><p>  CNI    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>   ,    ,   . </p><br><h1 id="nastroyka-2"> å®¢åˆ¶åŒ– </h1><br><p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">cni plugins</a>        <code>/opt/cni/bin/</code> </p><br><p>  <a href="">/etc/cni/net.d</a>      : </p><br><div class="spoiler"> <b class="spoiler_title">/etc/cni/net.d/10-flannel.conflist</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">{ "cniVersion": "0.3.0", "name": "cbr0", "plugins": [ { "type": "flannel", "name": "kubenet", "delegate": { "hairpinMode": true, "isDefaultGateway": true } }, { "type": "portmap", "capabilities": { "portMappings": true }, "externalSetMarkChain": "KUBE-MARK-MASQ" } ] }</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/etc/cni/net.d/99-loopback.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">{ "cniVersion": "0.3.0", "type": "loopback" }</code> </pre> </div></div><br><p>       ,    .  ,       ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Red Hat  Docker  Podman</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Intro to Podman</a> </p><br><h1 id="konfiguraciya-kubelet">  Kubelet </h1><br><p>     kubelet  (     cni) â€”    .   kubelet    hostname.         ,      ""   <code>kubectl logs</code> , <code>kubectl exec</code> , <code>kubectl port-forward</code> . </p><br><div class="spoiler"> <b class="spoiler_title"> kubelet-config.yaml</b> <div class="spoiler_text"><p>  ,   <a href="">etc/kubelet-config.yaml</a>   ,        ,     .     : </p><br><pre> <code class="plaintext hljs">systemReserved: cpu: 200m memory: 600Mi</code> </pre> <br><p>  ,        GO  kubernetes,  ,       .        .           0.2 vCPU  600 MB     . </p><br><p>   ,  , kubelet, kube-proxy, coredns, flannel    . ,               â€”     2 vCPU / 4G ram,           ,     kubernetes + postgresql . </p><br><p>    - (micro nodes)        . </p></div></div><br><h2 id="kubeletservice"> kubelet.service </h2><br><p>  service    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">systemd/kubelet</a> </p><br><div class="spoiler"> <b class="spoiler_title">kubelet.service</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes Requires=containerd.service [Service] #Environment=NODE_IP=192.168.164.230 Environment=NODE_IP=178.79.168.130 #: node name given by env Environment=NODE_NAME=w40k.net ExecStart=kubelet \ --allow-privileged \ --root-dir=/var/lib/kubernetes/kubelet \ --config=/var/lib/kubernetes/kubelet/kubelet-config.yaml \ --kubeconfig=/var/lib/kubernetes/kubelet/node-1.kubeconfig \ --cni-bin-dir=/opt/cni/bin \ --cni-conf-dir=/etc/cni/net.d/ \ --network-plugin=cni \ --container-runtime=remote \ --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \ --image-pull-progress-deadline=10m \ --node-ip=${NODE_IP} \ --hostname-override=${NODE_NAME} \ --v=1 Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target</code> </pre> </div></div><br><h2 id="nastroyka-3"> å®¢åˆ¶åŒ– </h2><br><p>      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RBAC</a> ,                kubelet. </p><br><p>  <a href="">etc/kubelet-default-rbac.yaml</a>  ,  kubelet        : </p><br><pre> <code class="bash hljs">user$ kubectl apply -f etc/kubelet-default-rbac.yaml</code> </pre> <br><p>  ,    ,        . </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#:   node-1$ systemctl enable kubelet.service #:  node-1$ systemctl start kubelet</span></span></code> </pre> <br><p>    ,           api : </p><br><pre> <code class="plaintext hljs">$ kubectl get nodes -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME w40k.net Ready &lt;none&gt; 5m v1.13.1 178.79.168.130 &lt;none&gt; Gentoo/Linux 4.18.16-x86_64-linode118 containerd://1.2.1</code> </pre> <br><h1 id="konfiguraciya-kube-proxy">  Kube Proxy </h1><br><p> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">systemd/kubelet</a> .   ,   , <code>kube-proxy-config.yaml</code>     : <a href="">etc/kube-proxy</a> </p><br><h2 id="kube-proxyservice"> kube-proxy.service </h2><br><div class="spoiler"> <b class="spoiler_title">kube-proxy.service</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[Unit] Description=Kubernetes Proxy Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=kube-proxy \ --config=/var/lib/kubernetes/kube-proxy/kube-proxy-config.yaml Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target</code> </pre> </div></div><br><h2 id="nastroyka-4"> å®¢åˆ¶åŒ– </h2><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#:   node-1$ systemctl enable kube-proxy.service #:  node-1$ systemctl start kube-proxy</span></span></code> </pre> <br><p>   kube-proxy   ""   iptables,         ,   -   kubernetes  (- ).   . </p><br><h1 id="konfiguraciya-coredns">  CoreDNS </h1><br><p> Corefile   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">etc/coredns/Corefile</a> ,    : </p><br><div class="spoiler"> <b class="spoiler_title">/etc/coredns/Corefile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">.:53 { errors log stdout health :8081 kubernetes cluster.local 10.200.0.0/16 { endpoint https://178.79.148.185:6443 tls /var/lib/kubernetes/kubernetes.pem /var/lib/kubernetes/kubernetes-key.pem /var/lib/kubernetes/ca.pem pods verified upstream /etc/resolv.conf kubeconfig /var/lib/kubernetes/config/kubeconfig/coredns.kubeconfig default } proxy . /etc/resolv.conf cache 30 }</code> </pre> </div></div><br><p>     coredns.kubeconfig  pem- (    )   worker . , coredns      systemd-resolved. ,         Ubuntu ,  ,  ,  ,  .        . </p><br><h2 id="corednsservice"> coredns.service </h2><br><div class="spoiler"> <b class="spoiler_title">coredns.service</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[Unit] Description=CoreDNS Documentation=https://coredns.io/ After=network.target [Service] ExecStart=/usr/bin/coredns -conf /etc/coredns/Corefile Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target</code> </pre> </div></div><br><h2 id="nastroyka-5"> å®¢åˆ¶åŒ– </h2><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#:   node-1$ systemctl enable coredns.service #:  node-1$ systemctl start coredns</span></span></code> </pre> <br><p> ,   ,   : </p><br><pre> <code class="plaintext hljs">node-1$ dig kubernetes.default.svc.cluster.local @127.0.0.1 #:    ;kubernetes.default.svc.cluster.local. IN A ;; ANSWER SECTION: kubernetes.default.svc.cluster.local. 5 IN A 10.32.0.1</code> </pre> <br><p>   , coredns   ip   kubernetes . <br> <strong></strong> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubernetes.default </a>   <strong></strong> kube-controller-manager,      : </p><br><pre> <code class="plaintext hljs">$ kubectl get svc -n default NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.32.0.1 &lt;none&gt; 443/TCP 26h</code> </pre> <br><h1 id="nginx-ingress--cert-manager"> nginx-ingress &amp; cert-manager </h1><br><p>   ,    .        nginx-ingress  cert-manager. </p><br><p> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nginx kubernetes ingress</a> (master),  : </p><br><pre> <code class="bash hljs"> user$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/nginxinc/kubernetes-ingress.git user$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> kubernetes-ingress/deployments user$ kubectl apply -f common/ns-and-sa.yaml user$ kubectl apply -f common/nginx-config.yaml user$ kubectl apply -f common/default-server-secret.yaml user$ kubectl apply -f daemon-set/nginx-ingress.yaml user$ kubectl apply -f rbac/rbac.yaml</code> </pre> <br><p> â€” <a href="">cert manager</a> (v0.5.2) </p><br><pre> <code class="bash hljs"> user$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/jetstack/cert-manager.git user$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cert-manager &amp;&amp; git co v0.5.2 user$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> contrib/manifests/cert-manager user$ kubectl apply -f with-rbac.yaml</code> </pre> <br><p>  ,    ,  ,    : </p><br><pre> <code class="plaintext hljs">NAMESPACE NAME READY STATUS RESTARTS AGE cert-manager cert-manager-554c76fbb7-t9762 1/1 Running 0 3h38m nginx-ingress nginx-ingress-sdztf 1/1 Running 0 10h nginx-ingress nginx-ingress-vrf85 1/1 Running 0 10h</code> </pre> <br><p>  cert-manager  nginx-ingress    running state,   ,    .          ,         <code>Running</code> .            . </p><br><h1 id="zapuskaem-prilozhenie">   </h1><br><p>   ,     .      ,   kubernetes resource : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">app/k8s</a> </p><br><pre> <code class="bash hljs">user$ kube apply -f ns-and-sa.yaml user$ kube apply -f configmap.yaml <span class="hljs-comment"><span class="hljs-comment">#:  secret-example.yaml       #: secret.yaml user$ kube apply -f secret.yaml user$ kube apply -f tls-production.yaml user$ kube apply -f deployment.yaml user$ kube apply -f service.yaml user$ kube apply -f ingress-production.yaml</span></span></code> </pre> <br><p>   ,     - .  ,    (      kubernetes-example.w40k.net),     ,    ,  cert-manager    nginx-ingress              .   ,    ingress  tls/ssl. </p><br><p>      : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://no-">http://no-https.kubernetes-example.w40k.net/</a> â€”  ssl;  ,  -   ,     . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://kubernetes-example.w40k.net/</a> â€”   (,   ,   ),  ,     ,       kubernetes     . </li></ul><br><p>       ,      -   .    -       ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> ,        . </p><br><h1 id="ssylki"> å‚è€ƒæ–‡çŒ® </h1><br><p> ,     ,   : </p><br><p> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes the hard way</a> <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Multi-Host Networking Overlay with Flannel</a> <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Intro to Podman</a> <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Stateless Applications</a> <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">What is ingress</a> </p><br><p>   : </p><br><p> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes Networking: Behind the scenes</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ) <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">A Guide to the Kubernetes Networking Model</a> <br> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Understanding kubernetes networking: services</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ) </p><br><h1 id="qa"> Q&amp;A </h1><br><p> &lt;tbd&gt;,           . </p><br><h1 id="otladochnaya-informaciya">   </h1><br><p>     , ,     .    ,       ,  -  ,    ,  . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><h2 id="api-server"> Api Server </h2><br><p>   <code>kube-apiserver.service</code>    ,       api-server'   curl    http .            - . <br>     admin.kubeconfig  ${HOME}/.kube/config,   kubectl      api-server (kube-apiserver). </p><br><p>    (   )  HTTP 200 OK + ,  api-server  : </p><br><pre> <code class="plaintext hljs">curl -H "Authorization: Bearer e5qXNAtwwCHUUwyLilZmAoFPozrQwUpw" -k -L https://&lt;api-server-address&gt;:6443/api/v1/</code> </pre> <br><h2 id="kube-controller-manager"> Kube Controller Manager </h2><br><p>  ,  controller manager   api    ,      .        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">service account'</a> : </p><br><pre> <code class="plaintext hljs">$ kubectl get sa NAME SECRETS AGE default 1 19h</code> </pre> <br><p>    ,   ,  kube-controller-manager  . </p><br><h2 id="kube-scheduler"> Kube Scheduler </h2><br><p>       .  ,    ,    <a href="">debug/job.yaml</a>        <code>kubectl describe &lt;type/resource&gt;</code> . <br>    <strong> </strong>  ,  kube controller manager . </p><br><pre> <code class="plaintext hljs">#:   job user$ kubectl apply -f debug/job.yaml job.batch/app created #:  ,   job user$ kubectl get pods -l job-name=app NAME READY STATUS RESTARTS AGE app-9kr9z 0/1 Completed 0 54s #: ,        #:   user$ kubectl describe pods app-9kr9z # ...   ... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 12s default-scheduler Successfully assigned example/app-9kr9z to w40k.net</code> </pre> <br><p>   , default-scheduler   pod   w40k.net.    -  ,            â€”    . </p><br><p>              . , ,   , â€”      "".       systemd        . </p><br><p>   kube scheduler  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> </p><br><h2 id="kubelet"> Kubelet </h2><br><p> Kubelet    kubernetes     .  kubelet       .     kubernetes event ( <code>kubectl get events -o wide</code> )         . </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> (  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ) </p><br><h2 id="kube-proxy-i-servisy"> Kube Proxy   </h2><br><p>     kube-proxy    : </p><br><ul><li>      (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> Flannel</a> ,      ); </li><li>  iptables,   filter  nat . </li></ul><br><p> <strong></strong> , 10.32.0.0/24   "".  ,        .     iptables,     ,   ,     -    +.  <strong> </strong>  icmp    ,      ping'  .        ,     . </p><br><p>  ,     kube-proxy,               : </p><br><pre> <code class="plaintext hljs">#:    user$ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE backend ClusterIP 10.32.0.195 &lt;none&gt; 80/TCP 5m #:     user$ kubectl get pods -o wide #:     ' NAME READY STATUS RESTARTS AGE IP NODE backend-896584448-4r94s 1/1 Running 0 11h 10.200.8.105 w40k.net backend-896584448-np992 1/1 Running 0 11h 10.200.12.68 docker.grart.net #:  10   /status/ endpoint ,       #:       node-1$ for i in `seq 10`; do curl -L http://10.32.0.195/status/; done okokokokokokokokokok node-1$ conntrack -L -d 10.32.0.195 tcp 6 62 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62158 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62158 [ASSURED] mark=0 use=1 tcp 6 60 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62144 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62144 [ASSURED] mark=0 use=1 tcp 6 58 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62122 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62122 [ASSURED] mark=0 use=1 tcp 6 59 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62142 dport=80 src=10.200.8.105 dst=10.200.8.1 sport=8000 dport=62142 [ASSURED] mark=0 use=1 tcp 6 58 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62130 dport=80 src=10.200.8.105 dst=10.200.8.1 sport=8000 dport=62130 [ASSURED] mark=0 use=1 tcp 6 61 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62150 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62150 [ASSURED] mark=0 use=1 tcp 6 56 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62116 dport=80 src=10.200.8.105 dst=10.200.8.1 sport=8000 dport=62116 [ASSURED] mark=0 use=1 tcp 6 57 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62118 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62118 [ASSURED] mark=0 use=1 tcp 6 59 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62132 dport=80 src=10.200.12.68 dst=10.200.8.0 sport=8000 dport=62132 [ASSURED] mark=0 use=1 tcp 6 56 TIME_WAIT src=178.79.168.130 dst=10.32.0.195 sport=62114 dport=80 src=10.200.8.105 dst=10.200.8.1 sport=8000 dport=62114 [ASSURED] mark=0 use=1</code> </pre> <br><p>      src/dst (9  10 ).   ,  src      : </p><br><ul><li> 10.200.8.105 </li><li> 10.200.12.68 </li></ul><br><p>  ,    .      ,  -  ( ,    )  .         . </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#: node-1   10.200.8.105, node-2 10.200.12.68, #:      8000  #:  node-1 node-1$ curl -L http://10.200.8.105:8000/status/ ok node-1$ curl -L http://10.200.12.68:8000/status/ ok #:  node-2 node-2$ curl -L http://10.200.8.105:8000/status/ ok node-2$ curl -L http://10.200.12.68:8000/status/ ok</span></span></code> </pre> <br><p>    ,    ,    conntrack        ,  ,      kube-proxy.   ,       nat : </p><br><p> <code>node-1$ iptables -t nat -vnL</code> </p> <br><p>          . </p><br><p>                  .  ,    ,      .   ,       .  -       , ,   . </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435228/">https://habr.com/ru/post/zh-CN435228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435214/index.html">Linux 4.20å‘å¸ƒ-æ–°å†…æ ¸ç‰ˆæœ¬ä¸­çš„æ›´æ”¹</a></li>
<li><a href="../zh-CN435216/index.html">å¦‚ä½•ä»ä¸¤è¡Œä»£ç ä¸­è·å¾—200ï¼Œä»¥åŠä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åš</a></li>
<li><a href="../zh-CN435220/index.html">Kotlin Nativeï¼šè·Ÿè¸ªæ–‡ä»¶</a></li>
<li><a href="../zh-CN435224/index.html">å¦‚ä½•åœ¨è‹±è¯­åŠå…¬å®¤æ²Ÿé€šï¼š14ä¸ªæœ‰ç”¨çš„ä¹ è¯­</a></li>
<li><a href="../zh-CN435226/index.html">ä»å¤´å¼€å§‹è¿˜åŸæ•°æ®</a></li>
<li><a href="../zh-CN435234/index.html">æ›´æ™ºèƒ½ï¼Œæ›´ç²¾ç¡®ï¼Œæ›´ç²¾ç¡®ï¼šäººå·¥æ™ºèƒ½å¦‚ä½•æ”¹å˜å¤ªç©ºé£è¡Œ</a></li>
<li><a href="../zh-CN435236/index.html">ç¾æ´²å°ç¬¬å®‰äººå ¡å’çš„å­—èŠ‚æœºï¼ˆä¸ä»…å¦‚æ­¤ï¼‰ï¼ˆç¬¬3éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN435240/index.html">è™šå¹»å¼•æ“4-åå¤„ç†æ‰«ææ•ˆæœ</a></li>
<li><a href="../zh-CN435242/index.html">æˆ‘ä¸ºä»€ä¹ˆå®³æ€•æˆä¸ºä¸€ä¸ªâ€œæ³µäººâ€</a></li>
<li><a href="../zh-CN435244/index.html">2018å¹´ITERé¡¹ç›®</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>