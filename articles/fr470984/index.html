<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüöí üêä üõµ Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio üõ¨ üë©üèº‚Äçüåæ ü¶ã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä partir de la version 7.04, l'analyseur PVS-Studio pour les langages C et C ++ sur Linux et macOS a une capacit√© de test pour v√©rifier la liste des f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470984/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Image 11"></div><br>  √Ä partir de la version 7.04, l'analyseur PVS-Studio pour les langages C et C ++ sur Linux et macOS a une capacit√© de test pour v√©rifier la liste des fichiers sp√©cifi√©s.  En utilisant le nouveau mode, vous pouvez configurer l'analyseur pour v√©rifier les validations et les demandes d'extraction.  Cet article vous montrera comment configurer la v√©rification de la liste des fichiers de projet GitHub modifi√©s dans des syst√®mes CI (int√©gration continue) populaires tels que Travis CI, Buddy et AppVeyor. <br><a name="habracut"></a><br><h2>  Mode de v√©rification de la liste des fichiers </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio</a> est un outil pour d√©tecter les erreurs et les vuln√©rabilit√©s potentielles dans le code source des programmes √©crits en C, C ++, C # et Java.  Il fonctionne sur les syst√®mes 64 bits sous Windows, Linux et macOS. <br><br>  Dans PVS-Studio version 7.04 pour Linux et macOS, le mode de v√©rification de la liste des fichiers source est apparu.  Cela fonctionne pour les projets dont le syst√®me de construction permet de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">g√©n√©rer le</a> fichier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compile_commands.json</a> .  Il est n√©cessaire pour que l'analyseur puisse extraire des informations sur la compilation des fichiers sp√©cifi√©s.  Si votre syst√®me de g√©n√©ration ne prend pas en charge la g√©n√©ration du fichier compile_commands.json, vous pouvez essayer de g√©n√©rer un tel fichier √† l'aide de l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bear</a> . <br><br>  En outre, le mode de v√©rification de la liste des fichiers peut √™tre utilis√© avec le journal de suivi de strace des d√©marrages du compilateur (trace pvs-studio-analyzer).  Pour ce faire, vous devez d'abord effectuer un assemblage complet du projet et le suivre afin que l'analyseur collecte des informations compl√®tes sur les param√®tres de compilation de tous les fichiers test√©s. <br><br>  Cependant, cette option pr√©sente un inconv√©nient important - vous devrez soit faire une trace compl√®te de l'ensemble du projet √† chaque d√©marrage, ce qui en soi contredit l'id√©e d'une v√©rification rapide de la validation.  Ou, si le r√©sultat de la trace lui-m√™me est mis en cache, les d√©marrages d'analyseurs suivants peuvent ne pas √™tre termin√©s si la structure de d√©pendance des fichiers source change apr√®s la trace (par exemple, un nouveau #include est ajout√© √† l'un des fichiers source). <br><br>  Par cons√©quent, nous ne recommandons pas d'utiliser le mode de v√©rification de la liste des fichiers avec le journal de suivi pour v√©rifier les validations ou les demandes d'extraction.  Si vous pouvez effectuer un assemblage incr√©mentiel lors de la v√©rification d'une validation, envisagez d'utiliser le mode d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse incr√©mentielle</a> . <br><br>  La liste des fichiers source pour l'analyse est enregistr√©e dans un fichier texte et transf√©r√©e √† l'analyseur √† l'aide du param√®tre <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  Dans ce fichier, les chemins d'acc√®s relatifs ou absolus aux fichiers sont indiqu√©s, et chaque nouveau fichier doit √™tre sur une nouvelle ligne.  Il est permis de sp√©cifier non seulement les noms des fichiers √† analyser, mais aussi divers textes.  L'analyseur verra qu'il ne s'agit pas d'un fichier et ignorera la ligne.  Cela peut √™tre utile pour commenter si les fichiers sont sp√©cifi√©s manuellement.  Cependant, une liste de fichiers est souvent g√©n√©r√©e lors de l'analyse dans CI, par exemple, il peut s'agir de fichiers provenant d'une demande de validation ou d'extraction. <br><br>  Maintenant, en utilisant ce mode, vous pouvez rapidement v√©rifier le nouveau code avant qu'il n'entre dans la branche principale de d√©veloppement.  Pour que le syst√®me de v√©rification r√©ponde aux avertissements de l'analyseur, l' <i>indicateur --indicate-warnings</i> a √©t√© ajout√© √† l' <i>utilitaire de conversion de plog</i> : <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Avec cet indicateur, le convertisseur retournera un code diff√©rent de z√©ro s'il y a des avertissements dans le rapport de l'analyseur.  En utilisant le code de retour, vous pouvez bloquer le crochet de pr√©-validation, la demande de validation ou d'extraction et afficher le rapport d'analyseur g√©n√©r√© √† l'√©cran, le partager ou l'envoyer par courrier. <br><br>  <i>Remarque</i>  <i>La premi√®re fois que vous ex√©cutez l'analyse de la liste des fichiers, l'ensemble du projet sera analys√©, car</i>  <i>l'analyseur doit g√©n√©rer un fichier de d√©pendances des fichiers source du projet √† partir des fichiers d'en-t√™te.</i>  <i>Il s'agit d'une caract√©ristique de l'analyse des fichiers C et C ++.</i>  <i>√Ä l'avenir, le fichier de d√©pendance peut √™tre mis en cache et il sera mis √† jour automatiquement par l'analyseur.</i>  <i>L'avantage de la v√©rification des validations lors de l'utilisation du mode de v√©rification de la liste des fichiers par rapport au mode d'analyse incr√©mentielle est que vous n'avez besoin que de mettre en cache ce fichier, pas les fichiers objets.</i> <br><br><h2>  Principes g√©n√©raux de l'analyse des demandes de tirage </h2><br>  L'analyse de l'ensemble du projet prend beaucoup de temps, il est donc logique de n'en v√©rifier qu'une certaine partie.  Le probl√®me est que vous devez s√©parer les nouveaux fichiers du reste des fichiers de projet. <br><br>  Prenons un exemple d'arbre de validation avec deux branches: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Image 5"></div><br><br>  Imaginons que la validation <i>A1</i> contienne une quantit√© assez importante de code qui a d√©j√† √©t√© test√©e.  Un peu plus t√¥t, nous avons cr√©√© une branche √† partir de la validation <i>A1</i> et modifi√© certains fichiers. <br><br>  Bien s√ªr, vous avez remarqu√© qu'apr√®s <i>A1,</i> il y avait deux autres validations, mais il s'agissait √©galement de fusions d'autres branches, car nous ne nous engageons pas en <i>master</i> .  Et maintenant, le moment est venu o√π le <i>correctif est</i> pr√™t.  Par cons√©quent, une demande de retrait pour la fusion de <i>B3</i> et <i>A3 est apparue</i> . <br><br>  Bien s√ªr, on pourrait v√©rifier l'ensemble du r√©sultat de leur fusion, mais cela serait trop long et injustifi√©, car seuls quelques fichiers ont √©t√© modifi√©s.  Par cons√©quent, il est plus efficace d'analyser uniquement les modifications. <br><br>  Pour ce faire, nous obtenons la diff√©rence entre les branches, √©tant dans la branche HEAD, √† partir de laquelle nous voulons fusionner en ma√Ætre: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  <i>$ MERGE_BASE,</i> nous examinerons plus en d√©tail plus tard.  Le fait est que tous les services CI ne fournissent pas les informations n√©cessaires sur la base de la fusion, donc chaque fois que vous devez trouver de nouvelles fa√ßons d'obtenir ces donn√©es.  Ceci sera d√©taill√© ci-dessous dans chacun des services Web d√©crits. <br><br>  Ainsi, nous avons obtenu la diff√©rence entre les branches, ou plut√¥t, une liste de noms de fichiers qui ont √©t√© modifi√©s.  Maintenant, nous devons donner le <i>fichier .pvs-pr.list</i> (nous y avons redirig√© la sortie ci-dessus) √† l'analyseur: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Apr√®s l'analyse, nous devons convertir le fichier journal (PVS-Studio.log) dans un format facile √† lire: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Cette commande r√©pertorie les erreurs dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">stderr</a> (flux de sortie de message d'erreur standard). <br><br>  Ce n'est que maintenant que nous devons non seulement afficher les erreurs, mais √©galement informer notre service pour l'assemblage et le test des probl√®mes.  Pour ce faire, l'indicateur <i>-W</i> ( <i>--indicate-warnings</i> ) a √©t√© ajout√© au convertisseur.  S'il y a au moins un avertissement d'analyseur, le code de retour de l'utilitaire de <i>conversion de plog</i> passera √† 2, ce qui informera le service CI de la pr√©sence d'erreurs potentielles dans les fichiers de demande d'extraction. <br><br><h2>  Travis ci </h2><br>  La configuration est effectu√©e sous la forme d'un fichier <i>.travis.yml</i> .  Pour plus de commodit√©, je vous conseille de tout mettre dans un script bash s√©par√© avec des fonctions qui seront appel√©es depuis le fichier <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ). <br><br>  Nous ajouterons le code n√©cessaire au script <i>bash</i> , afin d'obtenir plus de fonctionnalit√©s.  Dans la section d' <i>installation</i> , √©crivez ce qui suit: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Si vous aviez des instructions, vous pouvez les transf√©rer dans le script en supprimant les tirets. <br><br>  Ouvrez le fichier <i>.travis.sh</i> et ajoutez l'installation de l'analyseur √† la fonction <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Ajoutez maintenant l'analyse √† la section <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  Et dans le script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Ce code doit √™tre ex√©cut√© apr√®s la construction du projet, par exemple, si vous aviez une build sur CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Cela se passera comme ceci: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Vous avez probablement d√©j√† remarqu√© les variables d'environnement sp√©cifi√©es <i>$ TRAVIS_PULL_REQUEST</i> et <i>$ TRAVIS_BRANCH</i> .  Travis CI les annonce de son propre chef: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> stocke le num√©ro de <i>demande d'</i> extraction ou <i>false</i> s'il s'agit d'une branche r√©guli√®re; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> stocke le nom du r√©f√©rentiel de projet. </li></ul><br>  L'algorithme de cette fonction: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9e2/d21/1c5/9e2d211c559a48b4bf144bdd606e4bc7.png" alt="Image 7"></div><br>  Travis CI r√©pond aux codes de retour, donc la pr√©sence d'avertissements indiquera au service de marquer le commit comme contenant des erreurs. <br><br>  Maintenant, regardons de plus pr√®s cette ligne de code: <br><br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  Le fait est que Travis CI fusionne automatiquement les branches lors de l'analyse des demandes de pull: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Image 8"></div><br>  Par cons√©quent, nous analysons <i>A4</i> , pas <i>B3-&gt; A3</i> .  En raison de cette fonctionnalit√©, nous devons calculer la diff√©rence avec <i>A3</i> , qui est pr√©cis√©ment le sommet de la branche d' <i>origine</i> . <br><br>  Un d√©tail important restait - la mise en cache des d√©pendances des fichiers d'en-t√™te sur les unit√©s de traduction compil√©es (* .c, * .cc, * .cpp, etc.).  L'analyseur calcule ces d√©pendances au premier d√©marrage dans le mode de v√©rification de la liste de fichiers, puis l'enregistre dans le r√©pertoire .PVS-Studio.  Travis CI vous permet de mettre en cache des dossiers, nous allons donc enregistrer les donn√©es du <i>r√©pertoire .PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Ce code doit √™tre ajout√© au fichier <i>.travis.yml</i> .  Ce r√©pertoire stocke diverses donn√©es collect√©es apr√®s l'analyse, ce qui acc√©l√©rera consid√©rablement les lancements ult√©rieurs de l'analyse de la liste des fichiers ou de l'analyse incr√©mentielle.  Si cela n'est pas fait, l'analyseur analysera en fait tous les fichiers √† chaque fois. <br><br><h2>  Copain </h2><br>  Comme Travis CI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Buddy</a> offre la possibilit√© de cr√©er et de tester automatiquement des projets stock√©s sur GitHub.  Contrairement √† Travis CI, il est configur√© dans l'interface Web (le support bash est disponible), il n'est donc pas n√©cessaire de stocker les fichiers de configuration dans le projet. <br><br>  Tout d'abord, nous devons ajouter une nouvelle action √† la cha√Æne de montage: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Image 1"></div><br>  Nous indiquons le compilateur qui a √©t√© utilis√© pour construire le projet.  Faites attention au conteneur Docker install√© dans cette action.  Par exemple, il existe un conteneur sp√©cial pour GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Image 6"></div><br>  Installez maintenant PVS-Studio et les utilitaires n√©cessaires: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Image 2"></div><br>  Ajoutez les lignes suivantes √† l'√©diteur: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Acc√©dez maintenant √† l'onglet Ex√©cuter (premi√®re ic√¥ne) et ajoutez le code suivant au champ appropri√© de l'√©diteur: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Si vous lisez la section sur Travs-CI, alors ce code vous est d√©j√† familier, cependant, maintenant une nouvelle √©tape est apparue: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/615/40f/ec9/61540fec9bc7edf2032a84bdaf5a28fe.png" alt="Image 9"></div><br>  Le fait est que nous analysons maintenant non pas le r√©sultat de la fusion, mais la branche HEAD √† partir de laquelle la demande d'extraction est effectu√©e: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Image 10"></div><br>  Par cons√©quent, nous sommes dans le commit conditionnel <i>B3</i> et nous devons faire la diff√©rence avec <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Pour d√©terminer <i>A3,</i> utilisez l'API GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Nous avons utilis√© les variables suivantes fournies par Buddy: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - num√©ro de <i>demande d'</i> extraction; </li><li>  <i>$ BUDDY_REPO_SLUG</i> - combinaison du nom d'utilisateur et du r√©f√©rentiel (par exemple max / test). </li></ul><br>  Maintenant, enregistrez les modifications √† l'aide du bouton ci-dessous et activez l'analyse des demandes d'extraction: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Image 3"></div><br>  Contrairement √† Travis CI, nous n'avons pas besoin de sp√©cifier <i>.pvs-studio</i> pour la mise en cache, car Buddy met automatiquement en cache tous les fichiers pour les lancements ult√©rieurs.  Par cons√©quent, la derni√®re chose qui reste est d'enregistrer le login et le mot de passe pour PVS-Studio dans Buddy.  Apr√®s avoir enregistr√© les modifications, nous reviendrons sur Pipeline.  Nous devons passer √† la configuration des variables et ajouter le login et la cl√© pour PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Image 4"></div><br>  Apr√®s cela, l'apparition d'une nouvelle demande de pull ou commit d√©clenchera une v√©rification.  Si le commit contient des erreurs, Buddy l'indiquera sur la page de demande de pull. <br><br><h2>  Appveyor </h2><br>  La configuration d'AppVeyor est similaire √† Buddy, car tout se passe dans l'interface Web et il n'est pas n√©cessaire d'ajouter un fichier * .yml au r√©f√©rentiel du projet. <br><br>  Acc√©dez √† l'onglet Param√®tres dans l'aper√ßu du projet: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Image 12"></div><br>  Faites d√©filer cette page vers le bas et activez l'enregistrement du cache pour cr√©er des demandes d'extraction: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Image 18"></div><br>  Maintenant, allez dans l'onglet Environnement, o√π nous sp√©cifions l'image pour l'assemblage et les variables d'environnement n√©cessaires: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Image 19"></div><br>  Si vous lisez les sections pr√©c√©dentes, vous connaissez bien ces deux variables - <i>PVS_KEY</i> et <i>PVS_USERNAME</i> .  Sinon, je vous rappelle qu'ils sont n√©cessaires pour v√©rifier la licence de l'analyseur PVS-Studio.  √Ä l'avenir, nous les retrouverons dans des scripts Bash. <br><br>  Sur la m√™me page ci-dessous, nous indiquons le dossier pour la mise en cache: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Image 15"></div><br>  Si nous ne le faisons pas, nous analyserons l'ensemble du projet au lieu d'une paire de fichiers, mais nous obtiendrons la sortie des fichiers sp√©cifi√©s.  Par cons√©quent, il est important de saisir le nom de r√©pertoire correct. <br><br>  Il est maintenant temps pour le script de v√©rifier.  Ouvrez l'onglet Tests et s√©lectionnez Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Image 20"></div><br>  Ins√©rez le code suivant dans ce formulaire: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Faites attention √† la partie suivante du code: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  L'affectation plut√¥t sp√©cifique de la valeur de la commande pwd √† la variable qui devrait stocker cette valeur par d√©faut semble √©trange √† premi√®re vue, cependant, je vais tout expliquer maintenant. <br><br>  Lors de la configuration de l'analyseur dans AppVeyor, j'ai rencontr√© un comportement d'analyseur extr√™mement √©trange.  D'une part, tout fonctionnait correctement, mais l'analyse n'a pas commenc√©.  J'ai pass√© beaucoup de temps √† remarquer que nous sommes dans le r√©pertoire / home / appveyor / projects / testcalc /, et l'analyseur est s√ªr que nous sommes dans / opt / appveyor / build-agent /.  Ensuite, j'ai r√©alis√© que la variable $ PWD ment un peu.  Pour cette raison, j'ai mis √† jour manuellement sa valeur avant de d√©marrer l'analyse. <br><br>  Et puis tout, comme avant: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/4b9/a33/0aa4b9a3398ce2f52cc8e1df0833f459.png" alt="Image 17"></div><br>  Consid√©rez maintenant l'extrait de code suivant: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  Dans ce document, nous obtenons la diff√©rence entre les branches sur lesquelles la demande de tirage est d√©clar√©e.  Pour ce faire, nous avons besoin des variables d'environnement suivantes: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - nombre de demandes de tirage; </li><li>  $ APPVEYOR_REPO_NAME - nom d'utilisateur et r√©f√©rentiel du projet. </li></ul><br><h2>  Conclusion </h2><br>  Bien s√ªr, nous n'avons pas consid√©r√© tous les services possibles d'int√©gration continue, cependant, ils ont tous des caract√©ristiques de travail tr√®s similaires.  √Ä l'exception de la mise en cache, chaque service cr√©e son propre ¬´v√©lo¬ª, donc tout est toujours diff√©rent. <br><br>  Quelque part, comme dans Travis-CI, quelques lignes de code et la mise en cache fonctionnent parfaitement;  quelque part, comme dans AppVeyor, il vous suffit de sp√©cifier le dossier dans les param√®tres;  mais quelque part, vous devez cr√©er des cl√©s uniques et essayer de convaincre le syst√®me de vous donner la possibilit√© d'√©craser le fragment mis en cache.  Par cons√©quent, si vous souhaitez configurer l'analyse des demandes d'extraction sur le service d'int√©gration continue, qui n'a pas √©t√© abord√©e ci-dessus, assurez-vous d'abord que vous n'aurez pas de probl√®mes de mise en cache. <br><br>  Merci de votre attention.  Si quelque chose ne fonctionne pas, n'h√©sitez pas √† nous √©crire pour vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aider</a> .  Nous vous inviterons et vous aiderons. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Maxim Zvyagintsev.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470984/">https://habr.com/ru/post/fr470984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470974/index.html">DNS passif entre les mains de l'analyste</a></li>
<li><a href="../fr470976/index.html">Song of Ice (Bloody Enterprise) et Flames (DevOps et IaC)</a></li>
<li><a href="../fr470978/index.html">√âtude de march√© des analystes: o√π √©tudient-ils, quels outils utilisent-ils et combien gagnent-ils</a></li>
<li><a href="../fr470980/index.html">Les t√¢ches que les robots logiciels (RPA) r√©solvent dans le secteur bancaire</a></li>
<li><a href="../fr470982/index.html">Analyse des validations et des demandes d'extraction dans Travis CI, Buddy et AppVeyor √† l'aide de PVS-Studio</a></li>
<li><a href="../fr470988/index.html">L'inscription est ouverte pour Slerm DevOps √† Moscou</a></li>
<li><a href="../fr470990/index.html">Bo√Æte √† outils de marketing en ligne: 3 applications pour booster la communication visuelle</a></li>
<li><a href="../fr470994/index.html">H√©ritage JavaScript du point de vue d'un nerd ennuy√©: Constructors Factory</a></li>
<li><a href="../fr470996/index.html">Comment une simple balise <img> peut-elle devenir un risque √©lev√© pour une entreprise?</a></li>
<li><a href="../fr470998/index.html">Jouets en bois, dixi√®me partie - 1996</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>