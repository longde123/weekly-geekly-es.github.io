<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêü ‚≠êÔ∏è üö≥ Sobre a quest√£o da velocidade e medi√ß√£o no Arduino üíÉüèª ‚ôàÔ∏è üéæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esse problema surgiu no estudo do desempenho do Arduino ao executar v√°rios comandos (mais sobre isso em um post separado). No decorrer do estudo, surg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sobre a quest√£o da velocidade e medi√ß√£o no Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426941/"><img src="https://habrastorage.org/webt/kx/oe/cl/kxoecl7ngezzej1ftzcleeswzde.jpeg"><br><br>  Esse problema surgiu no estudo do desempenho do Arduino ao executar v√°rios comandos (mais sobre isso em um post separado).  No decorrer do estudo, surgiram d√∫vidas sobre a const√¢ncia do tempo de opera√ß√£o de comandos individuais ao alterar o valor dos operandos (como se viu posteriormente, n√£o razo√°vel) e foi tomada uma decis√£o para tentar estimar o tempo de execu√ß√£o de um comando individual.  Para isso, foi elaborado um pequeno programa (que dizia que o desenho deveria sair da classe), o qual, √† primeira vista, confirmou a hip√≥tese.  Na conclus√£o, voc√™ pode observar os valores 16 e 20, mas √†s vezes 28 e at√© 32 microssegundos s√£o encontrados.  Se multiplicarmos os dados recebidos por 16 (freq√º√™ncia do rel√≥gio MK), obteremos o tempo de execu√ß√£o em ciclos MK (de 256 a 512).  Infelizmente, uma execu√ß√£o repetida do ciclo principal do programa (com os mesmos dados iniciais), mantendo a imagem geral, j√° fornece uma distribui√ß√£o diferente do tempo de execu√ß√£o; portanto, as varia√ß√µes reais de tempo n√£o est√£o relacionadas aos dados iniciais.  A hip√≥tese original √© refutada, mas se torna interessante e o que exatamente est√° associado a uma dispers√£o t√£o significativa. <br><a name="habracut"></a><br>  Nota necess√°ria - Eu entendo muito bem que programas mais sofisticados devem ser usados ‚Äã‚Äãpara medir o tempo de execu√ß√£o dos comandos, mas para uma estimativa aproximada, um que ser√° demonstrado mais tarde √© suficiente. <br><br>  Ent√£o, o tempo muda e, de maneira muito significativa, estamos procurando as causas desse fen√¥meno.  Antes de tudo, prestamos aten√ß√£o √† multiplicidade dos valores obtidos, observamos a descri√ß√£o da biblioteca de trabalhos ao longo do tempo e observamos que 4¬µseg √© um quantum de medida, ent√£o √© melhor ir ao quanta e entender que obtemos 4 ou 5 (com muita frequ√™ncia) e 6 ou 7 ou 8 (muito raras) unidades.  Com a primeira metade, tudo √© f√°cil - se o valor medido estiver entre 4 e 5 unidades, a dispers√£o se tornar√° inevit√°vel.  Al√©m disso, considerando que as amostras s√£o independentes, podemos aumentar a precis√£o da medi√ß√£o por m√©todos estat√≠sticos, que √© o que fazemos, obtendo resultados aceit√°veis. <br><br>  Mas com a segunda metade (6,7,8) as coisas s√£o piores.  Descobrimos que a dispers√£o n√£o se correlaciona com os dados de origem, o que significa que essa √© uma manifesta√ß√£o de outros processos que afetam o tempo de execu√ß√£o dos comandos.  Note-se que as emiss√µes s√£o bastante raras e n√£o mostram um efeito significativo no valor m√©dio calculado.  Seria poss√≠vel negligenci√°-los, mas esse n√£o √© o nosso estilo.  Em geral, ao longo dos anos de trabalho em engenharia, percebi que voc√™ n√£o pode deixar mal-entendidos, por mais insignificantes que pare√ßam, pois eles t√™m uma capacidade repugnante de bater nas costas (bem, ou onde mais eles alcan√ßam) no momento mais inoportuno. <br><br>  Come√ßamos a apresentar a <b>hip√≥tese 1</b> - a mais conveniente (por conveni√™ncia e versatilidade, perdendo apenas para a interven√ß√£o direta do Criador) - falhas de software, √© claro, n√£o as minhas, meus programas nunca falham, mas as bibliotecas conectadas (compilador, sistema operacional, navegador etc.) - substitua o necess√°rio).  Al√©m disso, como eu executo o programa no emulador em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.tinkercad.com</a> , voc√™ ainda pode consultar os erros do emulador e fechar o t√≥pico, porque as fontes n√£o est√£o dispon√≠veis para n√≥s.  Contras desta hip√≥tese: <br><br><ol><li>  De ciclo para ciclo, a localiza√ß√£o dos desvios muda, o que sugere. </li><li>  Este site ainda suporta o AutoDesk, embora o argumento seja bastante fraco. </li><li>  "Aceitamos o postulado de que o que est√° acontecendo n√£o √© uma alucina√ß√£o; caso contr√°rio, seria simplesmente desinteressante". </li></ol><br>  A pr√≥xima suposi√ß√£o √© a influ√™ncia de alguns processos em segundo plano no resultado da medi√ß√£o.  Parece que n√£o estamos fazendo nada al√©m de acreditar ... estamos produzindo os resultados em s√©rie.  <b>A hip√≥tese 2</b> surge - o tempo de sa√≠da √†s vezes (por mais estranho que isso ... mas acontece) √© adicionado ao tempo de execu√ß√£o do comando.  Embora seja duvidoso quanto essa sa√≠da existe, de qualquer maneira - adicionar Flush n√£o ajudou, adicionar um atraso para terminar a sa√≠da e n√£o ajudou, geralmente movendo a sa√≠da para fora do loop - de qualquer forma, o tempo aumenta - isso definitivamente n√£o √© serial. <br><br>  Bem, o que resta √© a organiza√ß√£o do pr√≥prio ciclo (do qual √© assustador mudar sua dura√ß√£o, n√£o est√° claro) e isso √© tudo ... apesar de micros () permanecerem.  Eu quis dizer que o tempo de execu√ß√£o da primeira chamada desta fun√ß√£o e da segunda √© o mesmo e, ao subtrair esses dois valores, eu recebo zero, mas se essa suposi√ß√£o estiver errada? <br><br>  Hip√≥tese 3 - √†s vezes a segunda chamada da contagem do tempo demora mais que a primeira, ou as a√ß√µes associadas √† contagem do tempo √†s vezes afetam o resultado.  Examinamos o c√≥digo fonte da fun√ß√£o de trabalhar com o tempo (arduino-1.8.4 \ hardware \ arduino \ avr \ n√∫cleos \ arduino \ fia√ß√£o.c - expressei repetidamente minha atitude em rela√ß√£o a essas coisas, n√£o vou me repetir) e vemos que 1 em cada 256 ciclos de aumento de hardware da parte mais jovem do contador s√£o interrompidos para incrementar a parte mais antiga do contador. <br><br>  Nosso tempo de execu√ß√£o do ciclo √© de 4 a 5, portanto, podemos esperar 170 * (4..5) / 256 = de tr√™s a quatro valores an√¥malos em um segmento de 170 medi√ß√µes.  N√≥s olhamos - parece muito semelhante, existem realmente quatro deles.  Para separar a primeira e a segunda raz√µes, fazemos c√°lculos pela se√ß√£o cr√≠tica com interrup√ß√µes proibidas.  O resultado n√£o muda muito, as emiss√µes ainda t√™m um lugar para se estar, o que significa que o tempo extra √© gerado por micros ().  Aqui n√£o podemos fazer nada, embora o c√≥digo fonte esteja dispon√≠vel, n√£o podemos alter√°-lo - as bibliotecas est√£o inclu√≠das nos bin√°rios.  Obviamente, podemos escrever nossas pr√≥prias fun√ß√µes de trabalhar com o tempo e observar seu comportamento, mas existe uma maneira mais simples. <br><br>  Como uma poss√≠vel raz√£o para o aumento da dura√ß√£o √© o processamento de interrup√ß√£o ‚Äúlongo‚Äù, exclu√≠mos a possibilidade de sua ocorr√™ncia durante o processo de medi√ß√£o.  Para fazer isso, aguarde sua manifesta√ß√£o e s√≥ ent√£o realizamos um ciclo de medi√ß√£o.  Como a interrup√ß√£o ocorre com muito menos frequ√™ncia do que o nosso ciclo de medi√ß√£o, podemos garantir sua aus√™ncia.  Escrevemos o fragmento correspondente do programa (usando <s>hacks sujos com</s> informa√ß√µes extra√≠das do c√≥digo-fonte) e, ‚Äúisso √© m√°gica de rua‚Äù, tudo se torna normal - medimos o tempo de execu√ß√£o de 4 e 5 quanta com um valor m√©dio do tempo de execu√ß√£o da opera√ß√£o de adi√ß√£o com PT de 166 ciclos de rel√≥gio, o que corresponde ao valor medido anteriormente.  A hip√≥tese pode ser considerada confirmada. <br><br>  Resta mais uma pergunta - e o que leva tanto tempo em interrup√ß√µes, o que √© preciso <br>  (7.8) - (5) ~ 2 quanta = * 4 = 8mseg * 16 = 128 ciclos do processador?  Voltamos ao c√≥digo fonte (ou seja, ao c√≥digo assembler gerado pelo compilador em godbolt.com) e vemos que a pr√≥pria interrup√ß√£o √© executada em aproximadamente 70 ciclos, 60 deles constantemente, e ao ler, existem custos adicionais de 10 ciclos, total de 70 quando atingidos. interrup√ß√£o - menos do que recebido, mas perto o suficiente.  Atribu√≠mos a diferen√ßa √† diferen√ßa entre compiladores ou modos de uso. <br><br>  Bem, agora podemos medir o tempo de execu√ß√£o real do comando de adi√ß√£o PT com v√°rios argumentos e garantir que ele realmente mude muito quando os argumentos mudam: de 136 mede para 0,0 a 190 para 0,63 (n√∫mero m√°gico), e isso √© apenas 162 para 10,63.  Com uma probabilidade de 99,9%, isso se deve √† necessidade de alinhamento e aos recursos de sua implementa√ß√£o nessa biblioteca espec√≠fica, mas este estudo claramente vai al√©m do escopo do problema em considera√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Ap√™ndice - texto do programa:</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> setup() { <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> t; //   <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { <span class="hljs-type"><span class="hljs-type">int</span></span> d[<span class="hljs-number"><span class="hljs-number">170</span></span>]; unsigned long <span class="hljs-type"><span class="hljs-type">time</span></span>,time1; <span class="hljs-type"><span class="hljs-type">float</span></span> dt=<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">170.</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { { //       time1=micros(); long time2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { time2=micros(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((time2 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>) == (time1 &amp; ~<span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }; <span class="hljs-comment"><span class="hljs-comment">/**/</span></span> time1=micros(); //   <span class="hljs-comment"><span class="hljs-comment">/* cli(); //       -   */</span></span> t=<span class="hljs-number"><span class="hljs-number">10.63</span></span>; //     t=t+dt; //   <span class="hljs-comment"><span class="hljs-comment">/* sei(); //    */</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> = micros(); //   time1=<span class="hljs-type"><span class="hljs-type">time</span></span>-time1; d[i]=time1/<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Serial.print(time1); //      Serial.flush(); //     Delay(20); //    */</span></span> }; //   ,     <span class="hljs-type"><span class="hljs-type">float</span></span> sum=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">170</span></span>; ++i) { sum+=d[i]; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(d[i]); }; <span class="hljs-type"><span class="hljs-type">Serial</span></span>.println((sum/<span class="hljs-number"><span class="hljs-number">170</span></span><span class="hljs-number"><span class="hljs-number">-2.11</span></span>)*<span class="hljs-number"><span class="hljs-number">4</span></span>*<span class="hljs-number"><span class="hljs-number">16</span></span>); //<span class="hljs-number"><span class="hljs-number">2.11</span></span> ‚Äì     <span class="hljs-type"><span class="hljs-type">Serial</span></span>.flush(); //    ,     }</code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426941/">https://habr.com/ru/post/pt426941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426931/index.html">Como sair para trabalhar na Cote d'Azur e obter um passaporte franc√™s em 3 anos</a></li>
<li><a href="../pt426933/index.html">Design de front-end</a></li>
<li><a href="../pt426935/index.html">+10 regras de c√≥digo limpo do desenvolvedor Angular</a></li>
<li><a href="../pt426937/index.html">Membros bi√¥nicos aprendem a abrir cerveja</a></li>
<li><a href="../pt426939/index.html">Estudante de p√≥s-gradua√ß√£o resolveu o problema de confirmar a computa√ß√£o qu√¢ntica</a></li>
<li><a href="../pt426943/index.html">A tradu√ß√£o mais abrangente para o russo do Harvard Programming CS50 2015, gr√°tis no YouTube</a></li>
<li><a href="../pt426945/index.html">O que eu gostei sobre Paul Allen</a></li>
<li><a href="../pt426947/index.html">"O diabo me puxou para ir trabalhar no escrit√≥rio" - 10 perguntas para o programador, 9¬™ edi√ß√£o</a></li>
<li><a href="../pt426949/index.html">Recriando o THX Deep Note Sound</a></li>
<li><a href="../pt426951/index.html">Altium Designer: o que fazer se um projeto se tornar complicado?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>