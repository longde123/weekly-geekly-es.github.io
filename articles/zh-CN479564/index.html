<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♎️ 🗳️ 💌 ClickHouse + Graphite：如何大幅减少磁盘空间消耗 🕌 ☑️ 👨🏾‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="问候哈伯。 


如果有人运行石墨网系统并遇到低语的存储性能问题（IO，磁盘空间消耗），则将ClickHouse替换为替代产品的机会应该针对一个。 该语句表示第三方实现（例如carbonwriter或go-carbon）已用作守护程序的接收指标。 


 ClickHouse很好地解决了上述问题。 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ClickHouse + Graphite：如何大幅减少磁盘空间消耗</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479564/"><p><img src="https://habrastorage.org/webt/qq/sw/qe/qqswqech4q2d--d55t5rujx9hrm.png"></p><br><p> 问候哈伯。 </p><br><p>如果有人<a href="https://github.com/graphite-project/graphite-web" rel="nofollow">运行石墨网系统</a>并遇到<a href="https://github.com/graphite-project/whisper" rel="nofollow">低语的</a>存储性能问题（IO，磁盘空间消耗），则将ClickHouse替换为替代产品的机会应该针对一个。 该语句表示第三方实现（例如<a href="https://github.com/grobian/carbonwriter" rel="nofollow">carbonwriter</a>或<a href="https://github.com/go-graphite/go-carbon" rel="nofollow">go-carbon）</a>已用作守护程序的接收指标。 </p><br><p>  ClickHouse很好地解决了上述问题。 例如，从耳语中传输2TiB数据后，它们就适合300GiB。 我不会详细介绍比较；有关该主题的文章足够多。 此外，直到最近，我们的ClickHouse储存装置还算完美。 </p><a name="habracut"></a><br><h3 id="problemy-s-potreblyaemym-mestom"> 消费问题 </h3><br><p>乍一看，一切都应该运作良好。 根据<a href="https://clickhouse.yandex/docs/ru/operations/table_engines/graphitemergetree/" rel="nofollow">文档</a> ，我们为度量标准存储方案创建一个配置（以下简称为<a href="https://github.com/lomik/carbon-clickhouse" rel="nofollow">``reservation''</a> ），然后根据所选的石墨网后端建议创建表： <a href="https://github.com/lomik/carbon-clickhouse" rel="nofollow">carbon-clickhouse</a> + <a href="https://github.com/lomik/graphite-clickhouse" rel="nofollow">石墨-clickhouse</a>或<a href="https://github.com/ClickHouse/graphouse" rel="nofollow">graphouse</a> ，具体取决于所使用的堆栈。 而且...定时炸弹来了。 </p><br><p> 为了了解哪一个，您需要知道* <em>MergeTree</em> ClickHouse引擎系列的表中数据的插入方式和进一步的生命周期（图表摘自Alexei Zatelepin的<a href="https://youtu.be/PLMSA_gDdyM" rel="nofollow">演示文稿</a> ）： </p><br><ul><li> 插入一个数据<code></code> 。 就我们而言，指标已经到来。 <br><img src="https://habrastorage.org/webt/sg/w-/j-/sgw-j-iqinterrfern_vltigkzk.png"></li><li> 根据创建表时指定的<code>ORDER BY</code>键对写入磁盘之前的每个此类块进行排序。 </li><li> 排序后，将<code></code>数据写入磁盘。 <br><img src="https://habrastorage.org/webt/pw/jn/i2/pwjni2dacybsmesxpbhsjzcbsnu.png"></li><li> 服务器在后台监视此类碎片不多，并开始后台<code></code> （ <code>merge</code> ，以下称为merge）。 <br><img src="https://habrastorage.org/webt/bl/jx/ge/bljxge8pm7mw1dknwvqptruwqcu.png"><br><img src="https://habrastorage.org/webt/le/nx/bk/lenxbkzrtkajgoat-tqdfuqnzkk.png"></li><li> 一旦数据不再主动<code></code> <code>partition</code> ，服务器将立即停止运行合并，但是您可以使用<code>OPTIMIZE</code>命令手动启动该过程。 </li><li> 如果分区中仅剩一块，则无法使用通常的命令启动合并，必须使用<code>OPTIMIZE ... FINAL</code> </li></ul><br><p> 因此，第一个指标到来了。 而且它们占据了一定的空间。 随后的事件可能会因许多因素而略有不同： </p><br><ul><li> 分区密钥可以很小（一天）也可以很大（几个月）。 </li><li> 保留配置可以在活动分区（度量记录所在的位置）内容纳几个重要的数据聚合阈值，也可以不容纳。 </li><li> 如果有大量数据，则最早的碎片（由于背景合并而已）可能已经非常庞大（当选择次优分区键时），将无法摆弄新鲜的小碎片。 </li></ul><br><p> 一切总是一样的。 只有在以下情况下，ClickHouse中的指标所占的位置才会增加： </p><br><ul><li> 不要手动应用<code>OPTIMIZE ... FINAL</code>或 </li><li> 请勿将数据持续不断地插入所有分区中，以免迟早启动后台合并 </li></ul><br><p> 第二种方法似乎最容易实现 <del> 因此，他错了 </del> 并先经过测试。 <br> 我编写了一个相当简单的python脚本，该脚本在过去4年中每天发送虚拟指标，然后每小时运行一次。 <br> 由于ClickHouse DBMS的所有工作都基于这样一个事实，即该系统迟早会完成所有后台工作，但是尚不知道何时，我迫不及待要等到那些庞大的旧文件开始与新的小型文件合并。 很明显，我们必须寻找一种自动化强制优化的方法。 </p><br><img src="https://habrastorage.org/webt/ph/p0/1q/php01q8tw0cn8r5hxyr44dvc6hk.png" width="300"><br><h3 id="informaciya-v-sistemnyh-tablicah-clickhouse">  ClickHouse系统表中的信息 </h3><br><p> 看一下<a href="https://clickhouse.yandex/docs/ru/operations/system_tables/" rel="nofollow">system.parts</a>表的结构。 这是有关ClickHouse服务器上所有表的每个部分的全面信息。 除其他外，它包含以下各列： </p><br><ul><li> 数据库名称（ <code>database</code> ）； </li><li> 表名（ <code>table</code> ）； </li><li> 分区名称和ID（ <code>partition</code> ＆ <code>partition_id</code> ）; </li><li> 作品创建的时间（ <code>modification_time</code> ）； </li><li> 一块中的最小和最大日期（按天划分）（ <code>min_date</code>和<code>max_date</code> ）； </li></ul><br><p> 还有一个<a href="https://clickhouse.yandex/docs/ru/operations/system_tables/" rel="nofollow">system.graphite_retentions</a>表，其中包含以下有趣的字段： </p><br><ul><li> 数据库名称（ <code>Tables.database</code> ）; </li><li> 表名（ <code>Tables.table</code> ）; </li><li> 应当应用下一个汇总（ <code>age</code> ）的度量标准的<code>age</code> ； </li></ul><br><p> 因此： </p><br><ol><li> 我们有一个表和一个汇总规则表。 </li><li> 合并它们的交集并获得所有* GraphiteMergeTree表。 </li><li> 我们正在寻找以下所有分区： <br><ul><li> 一件以上 </li><li> 或应用以下聚合规则的时间到了，而且<code>modification_time</code>早于该时刻。 </li></ul></li></ol><br><h3 id="realizaciya"> 实作 </h3><br><div class="spoiler">  <b class="spoiler_title">这个要求</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">concat</span></span>(p.database, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, p.table) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>, p.partition_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> partition_id, p.partition <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span>, <span class="hljs-comment"><span class="hljs-comment">--  "" ,      -- ,    ,  (*) max(g.age) AS age, --     countDistinct(p.name) AS parts, --        00:00:00   toDateTime(max(p.max_date + 1)) AS max_time, --      max_time + age AS rollup_time, --         min(p.modification_time) AS modified_at FROM system.parts AS p INNER JOIN ( --      *GraphiteMergeTree SELECT Tables.database AS database, Tables.table AS table, age FROM system.graphite_retentions ARRAY JOIN Tables GROUP BY database, table, age ) AS g ON (p.table = g.table) AND (p.database = g.database) WHERE --    p.active -- (*)   ,        AND ((toDateTime(p.max_date + 1) + g.age) &lt; now()) GROUP BY table, partition HAVING --  ,     (modified_at &lt; rollup_time) --     OR (parts &gt; 1) ORDER BY table ASC, partition ASC, age ASC</span></span></code> </pre> </div></div><br><p> 返回* GraphiteMergeTree表的每个分区，这些分区的合并应释放磁盘空间。 剩下的就是小事情：用<code>OPTIMIZE ... FINAL</code>请求对它们进行遍历。 最终实现还考虑了无需触摸具有活动记录的分区的那一刻。 </p><br><p> 这正是<a href="https://github.com/innogames/graphite-ch-optimizer" rel="nofollow">石墨通道优化器</a>项目所做的。  Yandex.Market的前同事在产品中对其进行了测试，其工作结果如下所示。 </p><br><p><img src="https://habrastorage.org/webt/23/wv/mw/23wvmwkqw9ckohfvfqfshwhbqmu.jpeg" alt="结果"></p><br><p> 如果您使用ClickHouse在服务器上运行该程序，则它将仅在守护程序模式下开始工作。 一个小时执行一次请求，检查是否有超过三天的新分区可以优化。 </p><br><p> 在不久的将来-至少提供deb软件包，并在可能的情况下-rpm。 </p><br><p>  <strong>UPD：</strong>软件包可<a href="https://github.com/innogames/graphite-ch-optimizer/releases" rel="nofollow">在github版本上找到</a> ，工作映像可在innogames /石墨-ch-optimizer存储库中的docker-hub上找到。 </p><br><h3 id="vmesto-zaklyucheniya"> 而不是结论 </h3><br><p> 在过去的9个月里，我在<a href="https://www.innogames.com/ru/" rel="nofollow">InnoGames</a>公司的ClickHouse和石墨网交界处度过了很多时间。 这是一个很好的体验，它使从耳语快速转换为ClickHouse作为指标存储区成为可能。 我希望本文就像一个周期的开始一样，内容是关于我们对堆栈的各个部分进行了哪些改进以及将来将要进行的改进。 </p><br><p> 我与<a href="https://habr.com/ru/users/v0devil/" class="user_link">v0devil</a>一起花了几公升啤酒和管理天来进行请求开发，对此我要表示感谢。 并且也用于阅读本文。 </p><br><p>  <a href="https://github.com/innogames/graphite-ch-optimizer" rel="nofollow">github上的项目页面</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479564/">https://habr.com/ru/post/zh-CN479564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479548/index.html">从实习到HighLoad 2019表演的道路</a></li>
<li><a href="../zh-CN479550/index.html">带有可脚本编写对象的Unity中的MVC。 第三部分</a></li>
<li><a href="../zh-CN479552/index.html">DevOps工程师不存在。 然后谁存在，怎么办？</a></li>
<li><a href="../zh-CN479554/index.html">针对所有人：应用内语音助手</a></li>
<li><a href="../zh-CN479562/index.html">创建一个简单的多平台机器人的结构</a></li>
<li><a href="../zh-CN479566/index.html">矩阵潜在或反向工程抑制系统+同步时间证明</a></li>
<li><a href="../zh-CN479568/index.html">我在一家公司担任程序员，但我想以不同的方式来满足我的50年</a></li>
<li><a href="../zh-CN479570/index.html">Python入口点</a></li>
<li><a href="../zh-CN479572/index.html">Netflix Microservices如何处理发布-订阅数据</a></li>
<li><a href="../zh-CN479574/index.html">ITIL服务管理的4个方面</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>