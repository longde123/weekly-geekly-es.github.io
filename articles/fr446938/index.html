<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😕 ↔️ ✌🏽 Système de particules dans Core Animation. Histoire de Noël 👨‍❤️‍👨 👼 🐱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous! 

 Noël est révolu depuis longtemps, mais après cela, nous avons une histoire intéressante sur la façon d'utiliser la fonction Core An...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Système de particules dans Core Animation. Histoire de Noël</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/446938/"><img src="https://habrastorage.org/webt/9s/eo/zq/9seozqwk1lhhha-t9kjesviqs14.jpeg"><br><br>  Bonjour à tous! <br><br>  Noël est révolu depuis longtemps, mais après cela, nous avons une histoire intéressante sur la façon d'utiliser la fonction Core Animation rarement utilisée pour créer une ambiance festive pour les utilisateurs.  Je partage la traduction d'un article de mon collègue londonien Alexis. <br><br>  Noël a toujours été l'un de mes jours préférés de l'année pour moi.  Il apporte beaucoup d'amour, de rire, de bonheur et de magie à nos vies. <br><br>  Je suis né et j'ai grandi en Espagne, à Tenerife - une île ensoleillée au milieu de l'océan Atlantique au large des côtes africaines.  Et, croyez-moi, Noël à Tenerife est très différent de Noël à Londres, où je l'ai rencontré ces deux dernières années (depuis que j'ai commencé à travailler chez Badoo). <br><br>  L'un des avantages de vivre à Londres pour moi était de contempler les flocons de neige.  Ici, je les ai vus pour la première fois de ma vie, c'était tout simplement incroyable! <br><br>  En me souvenant de cela, j'ai décidé de partager avec vous une histoire intéressante qui m'est arrivée au bureau peu de temps avant Noël, avant de me rendre à Tenerife pour célébrer les vacances avec ma famille. <br><br>  Il se trouve que l'on m'a assigné une tâche inhabituelle avec la description suivante: <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/lt/df/wd/ltdfwdnu7xreylndpr6of3vkbt8.png"><br><br>  Hmm, assez drôle.  Nous voulions ajouter une animation de Noël avec des flocons de neige à notre application iOS, et j'ai eu la chance de la créer.  Mais je ne savais pas par où commencer. <br><br>  Comme d'habitude, un fichier Sketch a été attaché à la tâche avec la conception nécessaire, qui ressemblait à ceci: <br><br><img src="https://habrastorage.org/webt/_d/q9/tl/_dq9tlxzvrca0jhk0lxjx3rnmhu.png"><br><br>  Au moins, j'ai vu ce dont nous avions besoin, mais je ne savais pas vraiment comment ces flocons de neige devaient se comporter.  Pour clarifier tous les détails, je suis allé parler avec les designers. <br><br>  Comme je le soupçonnais, ils avaient déjà une excellente animation dessinée dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">After Effects</a> . <br><br>  Les concepteurs m'ont expliqué qu'ils voulaient ajouter des flocons de neige tombant d'en haut dans l'animation déjà existante du lancement de l'application (ainsi que le bonnet de noel sur notre logo, mais c'était une simple substitution de l'image, indigne de mention dans cet article). <br><br>  Je savais que l'animation du lancement d'une application sur iOS avait été réalisée à l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lottie</a> , car elle avait été ajoutée après mon entrée dans l'entreprise (détails dans l'article de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Radek Cieciwa</a> ).  Cependant, j'ai dit aux concepteurs que j'essaierais de trouver des solutions plus simples pour afficher les flocons de neige (sans avoir besoin d'utiliser Lottie) - et j'ai commencé à explorer différentes approches. <br><br>  Voici une animation que mon collègue Radek a réalisée pour Badoo.  Impeccable! <br><br><img src="https://habrastorage.org/webt/8e/cg/jj/8ecgjj7a9ywk34vr-_idw4ckb-a.gif"><br><br>  Et j'ai donc ajouté des flocons de neige tombant.  Vous voulez savoir comment je l'ai fait?  Vous trouverez la réponse ci-dessous. <br><br><img src="https://habrastorage.org/webt/rq/yd/gh/rqydgh5ar15k2f42kwxusdr3iq4.gif"><br><br><h1>  Systèmes de particules </h1><br>  En lisant diverses documentations sur les animations, je me suis souvenu que dans les jeux et les films, les systèmes de particules sont souvent utilisés pour résoudre de tels problèmes. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Wikipedia</a> décrit ce concept de façon assez précise: <br><br><blockquote>  «Le système de particules est une méthode utilisée en infographie pour représenter des objets qui n'ont pas de frontières géométriques claires (divers nuages, nébuleuses, explosions, jets de vapeur, trains de missiles, fumée, neige, pluie, etc.).  Les systèmes de particules peuvent être mis en œuvre dans des graphiques à deux et à trois dimensions. " </blockquote><br><div class="spoiler">  <b class="spoiler_title">Cette technique a été utilisée pour la première fois en 1982 dans Star Trek 2: The Wrath of Khan, pour créer un «effet de genèse».</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/zXFNypyMJCc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Un système de particules se compose d'une ou de plusieurs primitives graphiques, telles que des points, des lignes ou des images, appelées particules.  Ces particules sont créées et émises par un émetteur qui fait partie d'un système de particules. <br><br>  Chaque particule possède un ensemble de paramètres qui affectent directement ou indirectement son comportement et déterminent comment elle sera dessinée.  Les particules peuvent se déplacer simultanément en grand nombre et dans différentes directions, par exemple, pour créer l'effet d'un liquide. <br><br>  L'animation prend effet lorsque des particules sont émises par le système.  Le système émet des particules à des endroits aléatoires dans la zone spécifiée du système de particules.  Il peut prendre différentes formes: cercle, rectangle, sphère, boîte, ligne, point, etc. <br><br>  Le système détermine également les propriétés des particules qui affectent leur géométrie, leur vitesse et d'autres paramètres.  Différentes API d'émetteur ont des noms différents pour des propriétés similaires. <br><br>  Lorsque des particules sont émises par le système en même temps, elles créent de superbes animations qui peuvent ressembler à de la pluie, du feu ou de la neige. <br><br><img src="https://habrastorage.org/webt/m1/rj/jo/m1rjjoaqdn9cnn5gqkzjnu1o2iw.gif"><img src="https://habrastorage.org/webt/ti/zj/yi/tizjyikmqt6nvvztyycatujepgs.gif"><img src="https://habrastorage.org/webt/3e/vq/4d/3evq4dymfm0o-qaoy8qqs0jhkti.gif"><br><br><h1>  De la théorie à la pratique </h1><br>  Je pensais qu'Apple avait très probablement un support de système de particules intégré dans l'un de ses cadres.  Et les résultats de mes recherches ont montré que j'avais raison. <br><br>  Le système de particules fait partie du framework Core Animation et est bien décrit dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">classes</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CAEmitterLayer</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CAEmitterCell</a> . <br><br>  Après avoir étudié toutes les informations nécessaires sur le système de particules et les API prises en charge sur iOS, j'ai procédé à ma partie préférée - la mise en œuvre de notre idée. <br><br>  Malheureusement, Noël n'est pas éternel, nous avions donc besoin de pouvoir désactiver les flocons de neige à distance après le 25 décembre. <br><br>  Comme je l'ai mentionné ci-dessus, l'animation de lancement de l'application a été implémentée à l'aide de Lottie.  Autrement dit, je devais trouver un moyen d'ajouter des flocons de neige de telle manière que cela n'affecte pas l'animation existante et son code, car ma solution devait être supprimée immédiatement après la sortie. <br><br>  J'ai trouvé un moyen très simple de le faire - j'ai ajouté une nouvelle UIView transparente pour montrer les flocons de neige devant l'animation et l'arrière-plan existants, puis j'ai contrôlé à distance son apparence à l'aide d'un drapeau. <br><br><img src="https://habrastorage.org/webt/rm/_l/zk/rm_lzk5j94unwv3h5lqj9mqv65a.png"><br><br>  L'image ci-dessus montre l'UIView qui a été utilisé dans la solution finale: <br><br><ol><li>  <b>UIView</b> avec un système de particules qui a émis des flocons de neige. <br></li><li>  <b>UIViews</b> utilisées dans les animations de lancement d'applications pilotées par Lottie. <br></li></ol><br><br>  Une fois ce problème résolu, j'ai dû créer un composant contenant la logique d'émission de particules pour générer des flocons de neige animés. <br><br>  Pour commencer, j'avais besoin d'images de flocons de neige que je pouvais utiliser comme contenu pour l'émetteur.  Ils devraient être assez simples, non? <br><br>  Chaque flocon de neige était un cercle blanc ordinaire ou flou.  Je les ai créés moi-même dans Sketch. <br><br><img src="https://habrastorage.org/webt/9p/va/zd/9pvazdqkilhjtvjtidqvl1nwsh4.png" width="500"><br><br><h1>  Quelques détails d'implémentation </h1><br>  CAEmitterLayer est un CALayer spécial qui crée, anime et rend un système de particules.  Il vous permet de contrôler votre géométrie, position, mode de dessin et bien plus encore. <br><br>  J'ai commencé à développer l'animation en créant un calque: <br><br><pre><code class="swift hljs">snowEmitterLayer.emitterShape = <span class="hljs-type"><span class="hljs-type">CAEmitterLayerEmitterShape</span></span>.line snowEmitterLayer.beginTime = <span class="hljs-type"><span class="hljs-type">CACurrentMediaTime</span></span>() snowEmitterLayer.timeOffset = <span class="hljs-number"><span class="hljs-number">10.0</span></span></code> </pre> <br>  Je n'avais besoin de changer que trois propriétés: <br><br><ul><li>  <b>emitterShape</b> : définit la forme du calque.  J'ai utilisé une ligne qui permettait aux flocons de neige d'apparaître sur tout l'écran; <br></li><li>  <b>beginTime</b> : fait partie du protocole CAMediaTiming et représente l'heure de début de l'animation de couche par rapport aux animations de couche parent; <br></li><li>  <b>timeOffset</b> : fait également partie du protocole CAMediaTiming et, en substance, est une animation d'avance rapide pour un temps donné par rapport à son début.  J'ai spécifié une valeur de 10 secondes, ce qui a conduit au fait qu'au moment où l'animation a commencé, les flocons de neige couvraient déjà tout l'écran, et c'est exactement ce que nous voulions (si j'avais défini la valeur à 0 seconde, les flocons de neige commenceraient à apparaître en haut et couvriraient l'écran). entièrement qu'après un certain temps). <br></li></ul><br>  Ayant une couche finie, j'ai créé deux émetteurs différents: plus lourd pour les flocons de neige et plus facile pour les flocons de neige. <br><br>  Pour les flocons de neige lourds, j'ai configuré l'émetteur comme suit: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> flakeEmitterCell = <span class="hljs-type"><span class="hljs-type">CAEmitterCell</span></span>() flakeEmitterCell.contents = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(named: <span class="hljs-string"><span class="hljs-string">"snowflake_dot"</span></span>)!.cgImage flakeEmitterCell.emissionRange = .pi flakeEmitterCell.lifetime = <span class="hljs-number"><span class="hljs-number">20.0</span></span> flakeEmitterCell.birthRate = <span class="hljs-number"><span class="hljs-number">30</span></span> flakeEmitterCell.scale = <span class="hljs-number"><span class="hljs-number">0.15</span></span> flakeEmitterCell.scaleRange = <span class="hljs-number"><span class="hljs-number">0.6</span></span> flakeEmitterCell.velocity = <span class="hljs-number"><span class="hljs-number">30.0</span></span> flakeEmitterCell.velocityRange = <span class="hljs-number"><span class="hljs-number">20</span></span> flakeEmitterCell.spin = -<span class="hljs-number"><span class="hljs-number">0.5</span></span> flakeEmitterCell.spinRange = <span class="hljs-number"><span class="hljs-number">1.0</span></span> flakeEmitterCell.yAcceleration = <span class="hljs-number"><span class="hljs-number">30.0</span></span> flakeEmitterCell.xAcceleration = <span class="hljs-number"><span class="hljs-number">5.0</span></span></code> </pre> <br>  Comme vous pouvez le voir, j'ai dû modifier un nombre important de propriétés, dont chacune est très importante pour obtenir l'effet souhaité: <br><br><ul><li>  <b>contenu</b> : CGImage utilisé pour afficher un flocon de neige (comme vous vous en souvenez, c'est l'une de ces images que j'ai créées moi-même); <br></li><li>  <b>emissionRange</b> : angle en radians définissant le cône à l'intérieur duquel les particules apparaîtront (j'ai choisi l'angle PI pour que les particules soient visibles sur tout l'écran); <br></li><li>  <b>durée de vie</b> : détermine la durée de vie d'une particule; <br></li><li>  <b>birthRate</b> : détermine le nombre de particules émises chaque seconde; <br></li><li>  <b>scale</b> et <b>scaleRange</b> : affecte la taille des particules, où une valeur de 1,0 est la taille maximale;  l'intervalle détermine les écarts de taille entre les particules créées, ce qui permet d'émettre des particules de tailles aléatoires; <br></li><li>  <b>velocity</b> et <b>velocityRange</b> : affecte la vitesse d'apparition des particules;  s'écarte au hasard de la valeur spécifiée dans velocityRange; <br></li><li>  <b>spin</b> et <b>spinRange</b> : affectent la vitesse de rotation, mesurée en radians par seconde, et l'écart aléatoire dans la valeur spécifiée dans spinRange; <br></li><li>  <b>yAcceleration</b> et <b>xAcceleration</b> : ce sont deux composantes du vecteur d'accélération appliqué à l'émetteur. <br></li></ul><br>  J'avais également besoin d'un deuxième émetteur pour créer des flocons de neige légers.  Toutes les propriétés sont restées inchangées, à l'exception de deux: <br><br><ul><li>  <b>contenu</b> : ici j'ai utilisé des images avec un cercle flou; <br></li><li>  <b>vitesse</b> : et ici j'ai dû réduire la vitesse de chute pour éclairer les flocons de neige. <br></li></ul><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> blurryFlakeEmitterCell = <span class="hljs-type"><span class="hljs-type">CAEmitterCell</span></span>() blurryFlakeEmitterCell.contents = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(named: <span class="hljs-string"><span class="hljs-string">"snowflake_blurry_dot"</span></span>)?.cgImage blurryFlakeEmitterCell.velocity = <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-comment"><span class="hljs-comment">//     </span></span></code> </pre> <br>  Je n'ai pu connecter que le calque et les émetteurs, ce qui s'est avéré très simple: <br><br><pre> <code class="swift hljs">snowEmitterLayer.emitterCells = [flakeEmitterCell, blurryFlakeEmitterCell] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layer.addSublayer(snowEmitterLayer)</code> </pre><br><h1>  Conclusion </h1><br>  J'ai rapidement créé une version de travail avec des flocons de neige tombants, qui avait l'air très bien.  Il était assez simple à implémenter et ne modifiait pas le code existant.  Je l'ai montré aux designers et ils ont vraiment aimé. <br><br>  Les animations du système de particules peuvent être assez impressionnantes et relativement faciles à implémenter si vous avez les bons outils. <br><br>  Vous trouverez plus d'informations sur les systèmes de particules dans les sources suivantes: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Wikipédia</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ray wenderlich</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unité</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Allen Martin sur les systèmes de particules</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446938/">https://habr.com/ru/post/fr446938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446920/index.html">Rétro-ingénierie du poisson d'avril de Google</a></li>
<li><a href="../fr446922/index.html">Le chat sous le capot. 2e partie</a></li>
<li><a href="../fr446924/index.html">Représentation de polynômes arbitraires sous forme de différences finies avec un pas arbitraire</a></li>
<li><a href="../fr446926/index.html">«J'ai donc réalisé que maintenant je suis ingénieur de datation, et d'une manière différente, vous pouvez vous positionner sur le marché»</a></li>
<li><a href="../fr446932/index.html">Fairway TDMS et BIM</a></li>
<li><a href="../fr446940/index.html">QA sur prod. Pourquoi c'est cool</a></li>
<li><a href="../fr446942/index.html">Serveur, vous m'entendez? Attaque BROP sur l'exemple de la tâche NeoQUEST-2019</a></li>
<li><a href="../fr446944/index.html">Pourquoi investir dans des entreprises non rentables?</a></li>
<li><a href="../fr446948/index.html">Comment le cheval de Troie Android Gustuff supprime la crème (fiat et crypto) de vos comptes</a></li>
<li><a href="../fr446950/index.html">76% des fabricants n'ont aucune expérience de la mise en œuvre d'additifs - pourquoi est-ce bon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>