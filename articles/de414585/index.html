<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèº ü§î üëô Wie meine String.getBytes (UTF_8) kaputt gingen und was ich damit gemacht habe üèæ üë®üèæ‚Äçüî¨ üë©üèæ‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(Spoiler) entkr√§ftet, zerlegt und kam zu dem Schluss, dass das Problem in SSE-Anweisungen liegt 

 Hallo Habr! 

 Alles begann damit, dass ich einen L...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie meine String.getBytes (UTF_8) kaputt gingen und was ich damit gemacht habe</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414585/">  <i>(Spoiler) entkr√§ftet, zerlegt und kam zu dem Schluss, dass das Problem in SSE-Anweisungen liegt</i> <br><br>  Hallo Habr! <br><br>  Alles begann damit, dass ich einen Lasttest in Java f√ºr die interne Komponente des Systems geschrieben habe, an dem ich arbeite.  Der Test hat mehrere Threads erstellt und sehr oft versucht, etwas auszuf√ºhren.  W√§hrend der Ausf√ºhrung treten <i>manchmal</i> <i>java.lang.ArrayIndexOutOfBoundsException: 0</i> Fehler in einer Zeile auf, die dieser sehr √§hnlich ist: <br><br><pre><code class="java hljs"><span class="hljs-string"><span class="hljs-string">"test"</span></span>.getBytes(StandardCharsets.UTF_8)</code> </pre> <a name="habracut"></a><br>  Die Linie war nat√ºrlich anders, aber nach einer kleinen Studie gelang es mir, das Problem darin zu finden.  Als Ergebnis wurde der JMH-Benchmark geschrieben: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] originalTest() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"test"</span></span>.getBytes(StandardCharsets.UTF_8); }</code> </pre><br>  Was nach ein paar Sekunden Betrieb mit der folgenden Ausnahme abst√ºrzte: <br><br><pre> <code class="java hljs">java.lang.ArrayIndexOutOfBoundsException: <span class="hljs-number"><span class="hljs-number">0</span></span> at sun.nio.cs.UTF_8$Encoder.encode(UTF_8.java:<span class="hljs-number"><span class="hljs-number">716</span></span>) at java.lang.StringCoding.encode(StringCoding.java:<span class="hljs-number"><span class="hljs-number">364</span></span>) at java.lang.String.getBytes(String.java:<span class="hljs-number"><span class="hljs-number">941</span></span>) at org.sample.MyBenchmark.originalTest(MyBenchmark.java:<span class="hljs-number"><span class="hljs-number">41</span></span>) at org.sample.generated.MyBenchmark_originalTest.originalTest_thrpt_jmhLoop(MyBenchmark_originalTest.java:<span class="hljs-number"><span class="hljs-number">103</span></span>) at org.sample.generated.MyBenchmark_originalTest.originalTest_Throughput(MyBenchmark_originalTest.java:<span class="hljs-number"><span class="hljs-number">72</span></span>) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="hljs-number"><span class="hljs-number">62</span></span>) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="hljs-number"><span class="hljs-number">43</span></span>) at java.lang.reflect.Method.invoke(Method.java:<span class="hljs-number"><span class="hljs-number">498</span></span>) at org.openjdk.jmh.runner.LoopBenchmarkHandler$BenchmarkTask.call(LoopBenchmarkHandler.java:<span class="hljs-number"><span class="hljs-number">210</span></span>) at org.openjdk.jmh.runner.LoopBenchmarkHandler$BenchmarkTask.call(LoopBenchmarkHandler.java:<span class="hljs-number"><span class="hljs-number">192</span></span>) at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="hljs-number"><span class="hljs-number">266</span></span>) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="hljs-number"><span class="hljs-number">1149</span></span>) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="hljs-number"><span class="hljs-number">624</span></span>) at java.lang.Thread.run(Thread.java:<span class="hljs-number"><span class="hljs-number">748</span></span>)</code> </pre><br>  Ich habe dies noch nie zuvor erlebt, daher habe ich triviale L√∂sungen wie das Aktualisieren der JVM und das Neustarten des Computers ausprobiert, aber dies hat nat√ºrlich nicht geholfen.  Das Problem trat bei meinem MacBook Pro (13 Zoll, 2017) mit 3,5 GHz Intel Core i7 auf und wiederholte sich nicht auf den Computern der Kollegen.  Da ich keine anderen Faktoren fand, beschloss ich, den Code weiter zu studieren. <br><br>  Das Problem trat in der JVM der StringCoding-Klasse in der encode () -Methode auf: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expansionFactor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// We need to perform double, not float, arithmetic; otherwise // we lose low order bits when len is larger than 2**24. return (int)(len * (double)expansionFactor); } static byte[] encode(Charset cs, char[] ca, int off, int len) { CharsetEncoder ce = cs.newEncoder(); int en = scale(len, ce.maxBytesPerChar()); byte[] ba = new byte[en]; if (len == 0) return ba; ... }</span></span></code> </pre><br>  Das ba-Array wurde in seltenen F√§llen mit einer L√§nge von 0 Elementen erstellt, was in Zukunft zu einem Fehler f√ºhrte. <br><br>  Ich habe versucht, die Abh√§ngigkeit von UTF_8 zu entfernen, aber es hat nicht funktioniert.  Die Abh√§ngigkeit musste verlassen werden, sonst reproduzierte sich das Problem nicht, aber es stellte sich heraus, dass viele unn√∂tige entfernt wurden: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ((<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) StandardCharsets.UTF_8.newEncoder().maxBytesPerChar()); }</code> </pre><br>  maxBytesPerChar gibt eine Konstante aus dem letzten Feld zur√ºck, die gleich 3,0 ist, aber die Methode selbst hat in seltenen F√§llen (1 pro 1000000000) 0 zur√ºckgegeben. Es war doppelt seltsam, dass das Entfernen des Cast in der doppelten Methode in allen F√§llen so funktionierte, wie es sollte. <br><br>  Ich habe die JIT-Compileroptionen -XX: -TieredCompilation und -client hinzugef√ºgt, aber es hat nichts beeinflusst.  Am Ende habe ich hsdis-amd64.dylib f√ºr Mac kompiliert, die Optionen -XX: PrintAssemblyOptions = intel, -XX: CompileCommand = print, * MyBenchmark.encode und -XX: CompileCommand = dontinline, * MyBenchmark.encode hinzugef√ºgt und mit dem Vergleich der generierten JIT begonnen. om Assembler f√ºr eine Methode mit benutzerdefinierten in double und ohne: <br><br><pre> <code class="hljs go">    : <span class="hljs-number"><span class="hljs-number">0x000000010a44e3ca</span></span>: mov rbp,rax ;*synchronization entry ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">-1</span></span> (line <span class="hljs-number"><span class="hljs-number">558</span></span>) ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">2</span></span> (line <span class="hljs-number"><span class="hljs-number">554</span></span>) ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010a44e3cd</span></span>: movabs rdx,<span class="hljs-number"><span class="hljs-number">0x76ab16350</span></span> ; {oop(a <span class="hljs-string"><span class="hljs-string">'sun/nio/cs/UTF_8'</span></span>)} <span class="hljs-number"><span class="hljs-number">0x000000010a44e3d</span></span>7: vmovss xmm0,DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0xffffffffffffff</span></span>61] # <span class="hljs-number"><span class="hljs-number">0x000000010a44e340</span></span> ; {section_word} <span class="hljs-number"><span class="hljs-number">0x000000010a44e3df</span></span>: vmovss xmm1,DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0xffffffffffffff5d</span></span>] # <span class="hljs-number"><span class="hljs-number">0x000000010a44e344</span></span> ; {section_word} <span class="hljs-number"><span class="hljs-number">0x000000010a44e3e7</span></span>: mov rsi,rbp <span class="hljs-number"><span class="hljs-number">0x000000010a44e3ea</span></span>: nop <span class="hljs-number"><span class="hljs-number">0x000000010a44e3eb</span></span>: call <span class="hljs-number"><span class="hljs-number">0x000000010a3f</span></span>40a0 ; OopMap{rbp=Oop off=<span class="hljs-number"><span class="hljs-number">144</span></span>} ;*invokespecial &lt;init&gt; ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">558</span></span>) ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">2</span></span> (line <span class="hljs-number"><span class="hljs-number">554</span></span>) ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) ; {optimized virtual_call} <span class="hljs-number"><span class="hljs-number">0x000000010a44e3f</span></span>0: mov BYTE PTR [rbp+<span class="hljs-number"><span class="hljs-number">0x2c</span></span>],<span class="hljs-number"><span class="hljs-number">0x3f</span></span> ;*<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">0</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010a44e3f</span></span>4: vcvtss2sd xmm0,xmm0,DWORD PTR [rbp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] <span class="hljs-number"><span class="hljs-number">0x000000010a44e3f</span></span>9: vcvttsd2si eax,xmm0 <span class="hljs-number"><span class="hljs-number">0x000000010a44e3fd</span></span>: cmp eax,<span class="hljs-number"><span class="hljs-number">0x80000000</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010a44e403</span></span>: jne <span class="hljs-number"><span class="hljs-number">0x000000010a44e414</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010a44e405</span></span>: sub rsp,<span class="hljs-number"><span class="hljs-number">0x8</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010a44e409</span></span>: vmovsd QWORD PTR [rsp],xmm0 <span class="hljs-number"><span class="hljs-number">0x000000010a44e40e</span></span>: call Stub::d2i_fixup ; {runtime_call} <span class="hljs-number"><span class="hljs-number">0x000000010a44e413</span></span>: pop rax ;*d2i ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">10</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010a44e414</span></span>: add rsp,<span class="hljs-number"><span class="hljs-number">0x20</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010a44e418</span></span>: pop rbp    : <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e04a: mov rbp,rax ;*synchronization entry ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">-1</span></span> (line <span class="hljs-number"><span class="hljs-number">558</span></span>) ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">2</span></span> (line <span class="hljs-number"><span class="hljs-number">554</span></span>) ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010ef7e04d</span></span>: movabs rdx,<span class="hljs-number"><span class="hljs-number">0x76ab16350</span></span> ; {oop(a <span class="hljs-string"><span class="hljs-string">'sun/nio/cs/UTF_8'</span></span>)} <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e057: vmovss xmm0,DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0xffffffffffffff</span></span>61] # <span class="hljs-number"><span class="hljs-number">0x000000010ef7df</span></span>c0 ; {section_word} <span class="hljs-number"><span class="hljs-number">0x000000010ef7e05f</span></span>: vmovss xmm1,DWORD PTR [rip+<span class="hljs-number"><span class="hljs-number">0xffffffffffffff5d</span></span>] # <span class="hljs-number"><span class="hljs-number">0x000000010ef7df</span></span>c4 ; {section_word} <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e067: mov rsi,rbp <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e06a: nop <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e06b: call <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>270a0 ; OopMap{rbp=Oop off=<span class="hljs-number"><span class="hljs-number">144</span></span>} ;*invokespecial &lt;init&gt; ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">558</span></span>) ; - sun.nio.cs.UTF_8$Encoder::&lt;init&gt;@<span class="hljs-number"><span class="hljs-number">2</span></span> (line <span class="hljs-number"><span class="hljs-number">554</span></span>) ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">6</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) ; {optimized virtual_call} <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e070: mov BYTE PTR [rbp+<span class="hljs-number"><span class="hljs-number">0x2c</span></span>],<span class="hljs-number"><span class="hljs-number">0x3f</span></span> ;*<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ; - sun.nio.cs.UTF_8::newEncoder@<span class="hljs-number"><span class="hljs-number">0</span></span> (line <span class="hljs-number"><span class="hljs-number">72</span></span>) ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">3</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e074: vmovss xmm1,DWORD PTR [rbp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e079: vcvttss2si eax,xmm1 <span class="hljs-number"><span class="hljs-number">0x000000010ef7e07d</span></span>: cmp eax,<span class="hljs-number"><span class="hljs-number">0x80000000</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e083: jne <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e094 <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e085: sub rsp,<span class="hljs-number"><span class="hljs-number">0x8</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e089: vmovss DWORD PTR [rsp],xmm1 <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e08e: call Stub::f2i_fixup ; {runtime_call} <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e093: pop rax ;*f2i ; - org.sample.MyBenchmark::encode@<span class="hljs-number"><span class="hljs-number">9</span></span> (line <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e094: add rsp,<span class="hljs-number"><span class="hljs-number">0x20</span></span> <span class="hljs-number"><span class="hljs-number">0x000000010ef</span></span>7e098: pop rbp</code> </pre><br>  Einer der Unterschiede war die Verf√ºgbarkeit der Anweisungen vcvtss2sd und vcvttsd2si.  Ich wechselte zu C ++ und entschied mich, die Sequenz in Inline-ASM abzuspielen, aber beim Debuggen stellte sich heraus, dass der Clang-Compiler mit der Option -O0 beim Vergleich von float! = 1.0 die Anweisung cvtss2sd verwendet.  Am Ende kam es auf die Vergleichsfunktion an: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * sse 0x105ea2f30 &lt;+0&gt;: pushq %rbp 0x105ea2f31 &lt;+1&gt;: movq %rsp, %rbp 0x105ea2f34 &lt;+4&gt;: movsd 0x6c(%rip), %xmm0 ; xmm0 = mem[0],zero 0x105ea2f3c &lt;+12&gt;: movss 0x6c(%rip), %xmm1 ; xmm1 = mem[0],zero,zero,zero 0x105ea2f44 &lt;+20&gt;: movss %xmm1, -0x4(%rbp) -&gt; 0x105ea2f49 &lt;+25&gt;: cvtss2sd -0x4(%rbp), %xmm1 0x105ea2f4e &lt;+30&gt;: ucomisd %xmm0, %xmm1 0x105ea2f52 &lt;+34&gt;: setne %al 0x105ea2f55 &lt;+37&gt;: setp %cl 0x105ea2f58 &lt;+40&gt;: orb %cl, %al 0x105ea2f5a &lt;+42&gt;: andb $0x1, %al 0x105ea2f5c &lt;+44&gt;: movzbl %al, %eax 0x105ea2f5f &lt;+47&gt;: popq %rbp 0x105ea2f60 &lt;+48&gt;: retq 0x105ea2f61 &lt;+49&gt;: nopw %cs:(%rax,%rax) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val != <span class="hljs-number"><span class="hljs-number">1.0</span></span>; }</code> </pre><br>  Und diese Funktion hat in seltenen F√§llen false zur√ºckgegeben.  Ich habe einen kleinen Wrapper geschrieben, um den Prozentsatz fehlerhafter Ausf√ºhrungen zu berechnen: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> error = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> secondCompareError = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; INT_MAX; i++) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> result = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-number"><span class="hljs-number">1.0</span></span>) { error++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-number"><span class="hljs-number">1.0</span></span>) { secondCompareError++; } } } <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Iterations: "</span></span> &lt;&lt; INT_MAX &lt;&lt; <span class="hljs-string"><span class="hljs-string">", errors: "</span></span> &lt;&lt; error &lt;&lt;<span class="hljs-string"><span class="hljs-string">", second compare errors: "</span></span> &lt;&lt; secondCompareError &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Das Ergebnis war das Folgende: Iterationen: 2147483647, Fehler: 111, zweite Vergleichsfehler: 0. Interessanterweise hat die zweite Pr√ºfung nie einen Fehler ausgel√∂st. <br><br>  Ich habe die SSE-Unterst√ºtzung von clang deaktiviert. Die Vergleichsfunktion sah folgenderma√üen aus: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * no sse 0x102745f50 &lt;+0&gt;: pushq %rbp 0x102745f51 &lt;+1&gt;: movq %rsp, %rbp 0x102745f54 &lt;+4&gt;: movl $0x3f800000, -0x4(%rbp) ; imm = 0x3F800000 -&gt; 0x102745f5b &lt;+11&gt;: flds -0x4(%rbp) 0x102745f5e &lt;+14&gt;: fld1 0x102745f60 &lt;+16&gt;: fxch %st(1) 0x102745f62 &lt;+18&gt;: fucompi %st(1) 0x102745f64 &lt;+20&gt;: fstp %st(0) 0x102745f66 &lt;+22&gt;: setp %al 0x102745f69 &lt;+25&gt;: setne %cl 0x102745f6c &lt;+28&gt;: orb %al, %cl 0x102745f6e &lt;+30&gt;: andb $0x1, %cl 0x102745f71 &lt;+33&gt;: movzbl %cl, %eax 0x102745f74 &lt;+36&gt;: popq %rbp 0x102745f75 &lt;+37&gt;: retq 0x102745f76 &lt;+38&gt;: nopw %cs:(%rax,%rax) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val != <span class="hljs-number"><span class="hljs-number">1.0</span></span>; }</code> </pre><br>  Und das Problem reproduzierte sich nicht mehr.  Daraus kann ich schlie√üen, dass der SSE-Befehlssatz auf meinem System <i>nicht sehr gut</i> funktioniert. <br><br>  Ich arbeite seit mehr als 7 Jahren als Programmierer, und ich programmiere seit mehr als 16 Jahren. W√§hrend dieser Zeit bin ich es gewohnt, primitiven Operationen zu vertrauen.  Es funktioniert immer und das Ergebnis ist immer das gleiche.  Zu erkennen, dass ein Vergleich eines Schwimmers irgendwann brechen kann, ist nat√ºrlich ein Schock.  Und was damit getan werden kann, au√üer den Mac zu ersetzen, ist nicht klar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de414585/">https://habr.com/ru/post/de414585/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de414573/index.html">IP DoorBell - Interaktive T√ºrklingel</a></li>
<li><a href="../de414577/index.html">Devilution: Diablo Reverse Engineering Projekt</a></li>
<li><a href="../de414579/index.html">Google AI hat gelernt, vorherzusagen, wann ein Patient sterben wird (aber nicht alles ist so d√ºster)</a></li>
<li><a href="../de414581/index.html">Wo ist sein Knopf ?! Wie kann eine einfache Person Daten aus Kibana und Elasticsearch entladen und die Entwickler nicht belasten?</a></li>
<li><a href="../de414583/index.html">RIT ++, Tech RaDarts und alles in allem</a></li>
<li><a href="../de414587/index.html">DIY Standalone-Drohne mit Kontrolle √ºber das Internet. Teil 2 √ºber Software</a></li>
<li><a href="../de414589/index.html">Sberbank Collaborative Robotics: Was f√ºr einen Roboter k√∂nnen wir mit Ihnen machen?</a></li>
<li><a href="../de414593/index.html">Vergleich von C # und JavaScript. Die Grundlagen</a></li>
<li><a href="../de414597/index.html">Fragen Sie Ethan: Wie nahe k√∂nnen au√üerirdische Zivilisationen zusammenkommen?</a></li>
<li><a href="../de414605/index.html">Mini-Imperien</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>