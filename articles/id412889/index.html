<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèª üò∂ üçû Pengembangan perangkat pintar menggunakan contoh pengontrol lantai yang dipanaskan pada ESP8266 üî• üíáüèª üóëÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya ingin berbagi pengalaman dalam mengembangkan perangkat pintar. Dalam publikasi ini, saya akan menjelaskan perangkat keras (singkat) dan perangkat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pengembangan perangkat pintar menggunakan contoh pengontrol lantai yang dipanaskan pada ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412889/">  Saya ingin berbagi pengalaman dalam mengembangkan perangkat pintar.  Dalam publikasi ini, saya akan menjelaskan perangkat keras (singkat) dan perangkat lunak (lebih terinci) perangkat lunak. <br><br>  Pengontrol dirancang untuk menganalisis pembacaan sensor (kabel dan nirkabel) dan mempertahankan suhu yang diatur (termasuk jadwal, termasuk hari-hari dalam seminggu) di setiap zona individu dengan menghidupkan / mematikan boiler dan mengendalikan loop pemanas lantai air menggunakan kepala termal pada kolektor. <br><a name="habracut"></a><br><h2>  Perangkat keras </h2><br>  Sebagai pengontrol, ESP8266 (WeMos D1 mini) dipilih, sebagai  memiliki wifi di kapal.  Alih-alih ESP8266, pengontrol atau mikrokomputer lain dapat digunakan - ide umum akan tetap tidak berubah, hal utama adalah bahwa server WEB dengan dukungan untuk soket WEB dapat digunakan pada sistem yang dipilih.  Berikut ini juga digunakan dalam proyek: <br><br><ul><li>  RTC: DS3231 - perlu untuk menentukan hari dalam seminggu dan waktu saat ini.  Proyek ini disusun sebagai perangkat yang berdiri sendiri yang dapat bekerja tanpa internet, sehingga NTP tidak cocok. </li><li>  Sensor suhu nirkabel: NoName, 433MHz, dari stasiun cuaca China - solusi turnkey, mereka bekerja pada baterai.  Apa lagi yang kamu butuhkan?  Tetapi perlu bahwa periode transfer data tidak tetap.  Masalahnya adalah bahwa periode transmisi adalah 35 detik dan tidak banyak berenang.  Dan ada situasi ketika sinyal dua sensor tumpang tindih.  Dalam hal ini, satu atau dua sensor keluar dari sistem untuk sementara waktu.  Masalahnya dapat diselesaikan dengan menggunakan sensor yang sama, di mana perpindahan saluran juga mengubah periode transmisi data. </li><li>  Penerima 433MHz: Rxb6 - Ulasan internet dan pengalaman pribadi bukanlah penerima yang buruk. </li><li>  Sensor suhu kabel: DS18B20 - sangat praktis karena Anda tidak perlu tahu jumlah sensor sebelumnya. </li><li>  1Wire bus master: DS2482-100 - 1Wire protocol sangat sensitif terhadap pengaturan waktu, oleh karena itu semua implementasi penundaan penggunaan master bus program, yang tidak terlalu baik untuk multitasking.  Dengan menggunakan chip ini, Anda dapat memanfaatkan bus 1Wire dan menyingkirkan kekurangannya dengan menyiarkan 1Wire &lt;-&gt; i2c.  Protokol i2c memiliki jalur sinkronisasi, karena itu tidak penting untuk pengaturan waktu dan sering diimplementasikan dalam perangkat keras dalam pengontrol. </li><li>  Timer Watchdog: TPL5000DGST - uptime terus-menerus tidak begitu penting untuk proyek ini, namun aksesibilitas sangat penting.  ESP8266 memiliki pengawas waktu built-in.  Tetapi seperti yang ditunjukkan oleh praktik, kadang-kadang masih ada situasi di mana ia tidak dapat mengatasi dan sistem membeku.  Timer pengawas perangkat keras eksternal dirancang untuk menangani situasi darurat.  Dikonfigurasi untuk penundaan selama 64 detik.  Terlampir pada leg TX - selama operasi, sistem terus-menerus menulis informasi debug ke Serial dan kurangnya aktivitas selama lebih dari satu menit menunjukkan hang sistem. </li><li>  Port expander: 74HC595 - penggunaan expander ini memerlukan 4 kaki pengontrol - tiga untuk mentransmisikan status dan satu agar relay tidak berbunyi klik saat daya diterapkan.  Lain kali saya akan menggunakan PCF8574 - bus i2c masih digunakan, mis.  tidak diperlukan kaki MCU tambahan dan output 1 ditetapkan saat daya diterapkan. </li><li>  Modul relai: NoName, 8-channel, 5V - tidak ada yang bisa dikatakan, kecuali bahwa relai dihidupkan pada tingkat rendah pada input modul.  Relai keadaan padat tidak diizinkan dalam proyek ini, karena  Kontak boiler harus diaktifkan oleh kontak kering - secara umum, saya tidak tahu tegangan dan arus bolak-balik pada kontak. </li></ul><br><h2>  Sistem operasi </h2><br>  Sistem operasi adalah semua perangkat lunak yang memastikan operabilitas program aplikasi.  Sistem operasi juga merupakan lapisan antara perangkat keras dan program aplikasi, menyediakan antarmuka tingkat tinggi untuk mengakses sumber daya perangkat keras.  Dalam kasus ESP, komponen sistem operasi dapat dipertimbangkan: <br><br><h3>  Sistem file </h3><br>  Proyek ini menggunakan SPIFFS, semuanya tampak jelas di sini, ini adalah cara termudah.  Untuk akses mudah ke file di perangkat dari luar, saya menggunakan perpustakaan nailbuster / esp8266FTPSver. <br><br><h3>  Sistem alokasi waktu CPU </h3><br>  Ini adalah salah satu fungsi utama sistem operasi dan ESP tidak akan menjadi pengecualian.  Untuk eksekusi paralel dari berbagai aliran algoritma, Timers objek global (singleton) bertanggung jawab.  Kelasnya cukup sederhana dan menyediakan fungsionalitas berikut: <br><br><ul><li>  Eksekusi fungsi secara berkala, dengan interval yang ditentukan.  Inisialisasi pengatur waktu contoh: <br><br><pre><code class="cpp hljs">Timers.add(doLoop, <span class="hljs-number"><span class="hljs-number">6000</span></span>, F(<span class="hljs-string"><span class="hljs-string">"OneWireSensorsClass::doLoop"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//   ‚Äì  </span></span></code> </pre> </li><li>  Eksekusi tunggal fungsi setelah periode waktu tertentu.  Misalnya, pemindaian jaringan WiFi yang tertunda dilakukan dengan cara ini: <br><br><pre> <code class="cpp hljs">Timers.once([]() { WiFi.scanNetworks(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);}, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> </li></ul><br>  Dengan demikian, fungsi loop terlihat seperti ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ESP.wdtFeed(); Timers.doLoop(); CPULoadInfo.doLoop(); }</code> </pre><br>  Dalam praktiknya, fungsi loop berisi beberapa baris lagi, yang akan dijelaskan di bawah ini. <br>  Daftar kelas Timers terlampir. <br><br><h3>  Akuntansi waktu CPU </h3><br>  Fungsi layanan yang tidak memiliki aplikasi praktis.  Namun demikian, dia.  Diimplementasikan oleh CPULoadInfo tunggal.  Ketika objek diinisialisasi, jumlah iterasi dari loop kosong diukur untuk periode waktu yang singkat: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::init() { <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); <span class="hljs-comment"><span class="hljs-comment">//      1 while ((millis() - currTime) &lt; 10) { delay(0); MaxLoopsInSecond++; } MaxLoopsInSecond *= 100; }</span></span></code> </pre> <br>  Kemudian, kami menghitung jumlah panggilan prosedur loop per detik, kami menghitung beban prosesor dalam persen dan menyimpan data ke buffer: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPULoadInfoClass::doLoop() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> prevTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currTime = millis(); LoopsInSecond++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((currTime - prevTime) &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { memmove(CPULoadPercentHistory, &amp;CPULoadPercentHistory[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> load = ((MaxLoopsInSecond - LoopsInSecond) * <span class="hljs-number"><span class="hljs-number">100</span></span>) / MaxLoopsInSecond; CPULoadPercentHistory[<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(CPULoadPercentHistory) - <span class="hljs-number"><span class="hljs-number">1</span></span>] = load; prevTime = currTime; LoopsInSecond = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  Menggunakan pendekatan ini memungkinkan Anda untuk mendapatkan penggunaan prosesor yang sama oleh masing-masing utas individu (jika Anda menghubungkan subsistem ini dengan kelas Timers), tetapi seperti yang saya katakan - saya tidak melihat aplikasi praktis untuk ini. <br><br><h3>  Sistem input-output </h3><br>  Untuk berkomunikasi dengan pengguna, antarmuka UART-USB dan WEB digunakan.  Saya berpikir tentang UART. Saya tidak perlu berbicara secara rinci.  Satu-satunya hal yang patut diperhatikan adalah untuk kenyamanan dan kompatibilitas dengan non-ESP fungsi serialEvent () diimplementasikan: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ if (Serial.available()) serialEvent(); // ‚Ä¶ }</span></span></code> </pre><br>  Dengan antarmuka WEB, semuanya jauh lebih menarik.  Kami mencurahkan bagian terpisah untuk itu. <br><br><h3>  Antarmuka WEB </h3><br>  Dalam hal perangkat pintar, menurut saya, antarmuka WEB adalah solusi yang paling ramah pengguna. <br><br>  Saya menganggap penggunaan layar yang terhubung ke perangkat sebagai praktik yang sudah ketinggalan zaman - tidak mungkin untuk membuat antarmuka yang sederhana, nyaman, dan indah saat menggunakan layar kecil dan serangkaian tombol yang terbatas. <br><br>  Penggunaan program khusus untuk mengontrol perangkat membebankan pembatasan pada pengguna, menambah kebutuhan untuk mengembangkan dan mendukung program-program ini, dan juga mengharuskan pengembang untuk mengurus pengiriman program-program ini ke perangkat terminal pengguna.  Dalam cara yang baik, aplikasi harus dipublikasikan di Google, Apple, toko aplikasi Windows, dan juga tersedia di repositori Linux dalam bentuk paket deb dan rpm - jika tidak, akses ke antarmuka perangkat mungkin sulit untuk sebagian audiens. <br><br>  Akses ke antarmuka WEB perangkat tersedia dari sistem operasi apa pun - Linux, Windows, Android, MacOS, pada desktop, laptop, tablet, smartphone - hanya untuk memiliki browser.  Tentu saja, pengembang antarmuka WEB perlu mempertimbangkan fitur berbagai perangkat, tetapi ini terutama menyangkut ukuran dan resolusi.  Akses ke antarmuka WEB dari perangkat pintar di rumah / apartemen / pondok mudah disediakan dari luar melalui Internet - sekarang sulit membayangkan rumah / apartemen di mana ada perangkat pintar dan tidak ada router dan Internet, dan di router akses ini dikonfigurasi dalam beberapa klik (bagi mereka yang benar-benar keluar dari topik, kata kunci akan membantu - "port forwarding" dan "DNS dinamis").  Dalam hal tempat tinggal musim panas, akses dapat diberikan menggunakan router 3G. <br><br>  Untuk mengimplementasikan antarmuka WEB, diperlukan server WEB.  Saya menggunakan perpustakaan me-no-dev / ESPAsyncWebServer.  Perpustakaan ini menyediakan fungsionalitas berikut: <br><br><ul><li>  Pengembalian konten statis, termasuk  dengan dukungan kompresi gzip.  Direktori virtual didukung, dengan kemampuan untuk menentukan file utama (yang biasanya index.htm) untuk setiap direktori. </li><li>  Menetapkan fungsi panggilan balik ke berbagai URL berdasarkan jenis permintaan (GET, POST, ...) </li><li>  Dukungan untuk soket WEB pada port yang sama (itu penting ketika port forwarding). </li><li>  Otorisasi DASAR.  Selain itu, otorisasi ditetapkan secara individual untuk setiap URL.  Ini penting karena  misalnya, Google Chrome, saat membuat pintasan halaman di layar utama, meminta ikon dan file manifes dan tidak mentransfer data otorisasi.  Oleh karena itu, beberapa file ditempatkan di direktori virtual dan otorisasi dinonaktifkan untuk direktori ini. </li></ul><br><h3>  Sistem operasi layanan HTTP </h3><br>  Dalam proyek saat ini, semua pengaturan sistem operasi dilakukan menggunakan layanan HTTP.  Layanan HTTP adalah fungsi pengambilan / modifikasi data independen kecil yang tersedia melalui HTTP.  Selanjutnya, pertimbangkan daftar layanan ini. <br><br><h4>  Bantuan </h4><br>  Implementasi dari daftar perintah, saya pikir itu benar untuk memulai dengan implementasi tim BANTUAN.  Di bawah ini adalah blok inisialisasi server WEB: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> HTTPserverClass::init() { <span class="hljs-comment"><span class="hljs-comment">//SERVER INIT help_info.concat(F("/'doc_hame.ext': load file from server. Allow methods: HTTP_GET\n")); AsyncStaticWebHandler&amp; handler = server.serveStatic("na/", SPIFFS, "na/"); serveStaticHandlerNA = &amp;handler; //       server.serveStatic("/", SPIFFS, "/"); //    //info //       help_info.concat(F("/info: get system info. Allow methods: HTTP_GET\n")); server.on("/info", HTTP_GET, handleInfo); ‚Ä¶ server.on("/help", HTTP_GET, [](AsyncWebServerRequest *request) { request-&gt;send(200, ContentTypesStrings[ContentTypes::text_plain], help_info.c_str()); }); //    setAuthentication(ConfigStore.getAdminName(), ConfigStore.getAdminPassword()); DefaultHeaders::Instance().addHeader("Access-Control-Allow-Origin", "*"); //  -  //   server.begin(); //       DEBUG_PRINT(F("HTTP server started")); }</span></span></code> </pre><br>  Mengapa saya membutuhkan sistem bantuan, saya pikir itu tidak layak diceritakan.  Beberapa pengembang menunda implementasi sistem bantuan untuk nanti, tetapi ini "nanti" biasanya tidak terjadi.  Jauh lebih mudah untuk mengimplementasikannya di awal proyek dan menambahnya selama pengembangan proyek. <br>  Dalam proyek saya, daftar layanan yang mungkin juga ditampilkan dengan kesalahan 404 - halaman tidak ditemukan.  Saat ini menerapkan layanan berikut: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://tc-demo.vehs.ru/help</a> <br><br><pre> <code class="hljs sql">/'doc_hame.ext': <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> server. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /info: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> info. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">20140527</span></span>T123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /uptime: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> uptime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> (eg: <span class="hljs-number"><span class="hljs-number">123</span></span>D123456). <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /rtc: <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> RTC time. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ? [dir=...] &amp; [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /edit: edit files. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_PUT, HTTP_DELETE, HTTP_POST /wifi: edit wifi settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /wifi-<span class="hljs-keyword"><span class="hljs-keyword">scan</span></span> ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /wifi-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wifi info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /ap: edit soft ap settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: edit <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> settings. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-info ? [<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">json</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> json. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> flash. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /restart: restart system. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET, HTTP_POST /ws: web socket url. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET /<span class="hljs-keyword"><span class="hljs-keyword">help</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">allow</span></span> URLs. <span class="hljs-keyword"><span class="hljs-keyword">Allow</span></span> methods: HTTP_GET</code> </pre><br>  Seperti yang Anda lihat, dalam daftar layanan tidak ada layanan aplikasi.  Semua layanan HTTP terkait dengan sistem operasi.  Setiap layanan melakukan satu tugas kecil.  Selain itu, jika layanan memerlukan input data apa pun, maka, atas permintaan, GET mengembalikan formulir input minimalis: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> USE_RTC_CLOCK help_info.concat(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc: set RTC time. Allow methods: HTTP_GET, HTTP_POST\n"</span></span></span><span class="hljs-meta">)); const char* urlNTP = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">; server.on(urlNTP, HTTP_GET, [](AsyncWebServerRequest *request) { DEBUG_PRINT(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/rtc"</span></span></span><span class="hljs-meta">)); request-&gt;send(200, ContentTypesStrings[ContentTypes::text_html], String(F(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"&lt;head&gt;&lt;title&gt;RTC time&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form method=\"post\" action=\"rtc\"&gt;&lt;input name=\"newtime\" length=\"15\" placeholder=\"yyyyMMddThhmmss\"&gt;&lt;button type=\"submit\"&gt;set&lt;/button&gt;&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;"</span></span></span><span class="hljs-meta">))); }); server.on(urlNTP, HTTP_POST, handleSetRTC_time); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// USE_RTC_CLOCK</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/cr/-6/na/cr-6napgtebfgiquecvuezhxqia.png"><br><br>  Kemudian layanan ini digunakan dalam antarmuka yang lebih cantik: <br><br><img src="https://habrastorage.org/webt/tt/mn/-o/ttmn-oyhy9v3lygwrk0jk2wzp2o.png"><br><br><h2>  Perangkat lunak aplikasi </h2><br>  Akhirnya kami sampai pada titik di mana sistem itu dibuat.  Yaitu - untuk pelaksanaan tugas yang diterapkan. <br><br>  Aplikasi apa pun harus menerima data sumber, memprosesnya, dan menghasilkan hasilnya.  Mungkin juga bahwa sistem harus melaporkan keadaan saat ini. <br><br>  Sumber data untuk pengontrol pemanas di bawah lantai adalah: <br><br><ul><li>  Data sensor - sistem tidak terikat dengan sensor tertentu.  Identifier unik dihasilkan untuk setiap sensor.  Untuk sensor radio, pengenal mereka diisi dengan nol hingga 16 bit, untuk sensor 1Wire, CRC16 dihitung berdasarkan pengenal internal dan digunakan sebagai pengidentifikasi sensor.  Dengan demikian, semua sensor memiliki pengidentifikasi dengan panjang 2 byte. </li><li>  Data tentang zona pemanasan - jumlah zona tidak tetap, jumlah maksimum dibatasi oleh modul relai yang digunakan.  Dengan batasan ini, antarmuka WEB juga dikembangkan. </li><li>  Suhu dan jadwal target - Saya mencoba membuat pengaturan paling fleksibel, Anda dapat membuat beberapa skema pemanas, dan Anda bahkan dapat menetapkan skema pengaturan Anda sendiri untuk setiap zona. </li></ul><br>  Dengan demikian, ada sejumlah pengaturan yang perlu diatur entah bagaimana, dan ada sejumlah parameter yang dilaporkan sistem sebagai keadaan saat ini. <br>  Untuk komunikasi antara pengontrol dan dunia luar, saya menerapkan juru bahasa perintah yang memungkinkan saya untuk mengimplementasikan kontrol kedua pengontrol dan menerima data status.  Perintah ditransmisikan ke controller dalam bentuk yang dapat dibaca manusia, dan dapat dikirim melalui soket UART atau WEB (jika diinginkan, Anda dapat mengimplementasikan dukungan untuk protokol lain, misalnya telnet). <br>  Baris perintah dimulai dengan karakter '#' dan diakhiri dengan karakter nol atau karakter baris baru.  Semua perintah terdiri dari nama perintah dan operan, dipisahkan oleh tanda titik dua.  Untuk beberapa perintah, operan bersifat opsional, dalam hal ini, titik dua dan operan tidak ditentukan.  Perintah dalam garis dipisahkan oleh koma.  Sebagai contoh: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#ZonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">SensorsInfo</span></span></code> </pre> <br>  Dan tentu saja, daftar perintah dimulai dengan perintah Bantuan, yang menampilkan daftar semua perintah yang valid (untuk kenyamanan, perintah yang dikirimkan dimulai dengan '&gt;' bukan '#'): <br><br><pre> <code class="hljs dos">&gt;<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Help</span></span> SetZonesCount Zone SetName SetSensor ... LoadCfg SaveCfg #<span class="hljs-built_in"><span class="hljs-built_in">Cmd</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">Help</span></span>,CmdRes:Ok</code> </pre> <br>  Fitur implementasi interpreter perintah adalah bahwa informasi tentang hasil eksekusi perintah juga dikeluarkan dalam bentuk perintah atau seperangkat perintah: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">help</span></span> ‚Ä¶ <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Help</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Value</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:123</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Error</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Zone</span></span> 123 <span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">range</span></span> 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span> &gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">SchemasInfo</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#SchemasCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DOWs</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0b0000000</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:SchemasInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  Di sisi klien WEB, sebuah shell juga diimplementasikan yang menerima perintah-perintah ini dan mengubahnya menjadi tampilan grafis.  Sebagai contoh: <br><br><pre> <code class="hljs css">&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">zonesInfo</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5680</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Schema</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">DeltaT</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:-20</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#Cmd</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ZonesInfo</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CmdRes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre> <br>  Antarmuka WEB mengirim permintaan ke pengontrol tentang zona nomor 3, dan sebagai tanggapan menerima nama zona, pengidentifikasi sensor yang terkait dengan zona, pengidentifikasi sirkuit yang ditugaskan ke zona dan koreksi suhu untuk zona.  Shell tidak memahami bilangan pecahan, sehingga suhunya ditransmisikan dalam sepersepuluh derajat, yaitu.  12,3 derajat adalah 123 persepuluh. <br><br>  Fitur kuncinya adalah pengontrol merespons semua klien sekaligus untuk perintah apa pun, apa pun metode memasukkan perintah.  Ini memungkinkan Anda untuk segera menampilkan perubahan status di semua sesi antarmuka WEB.  Karena  Transportasi pertukaran utama antara pengontrol dan antarmuka WEB adalah soket WEB, kemudian pengontrol dapat mengirimkan data tanpa permintaan, misalnya, ketika data baru berasal dari sensor: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#sensor</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0x5A20</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:w433th</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">battery</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">button_tx</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">channel</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">temperature</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">humidity</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:34</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">uptime_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:130308243</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">time_label</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20180521T235126</span></span></code> </pre> <br>  Atau, misalnya, bahwa zona ini perlu diperbarui: <br><br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#Zone</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">TargetTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:220</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentTemp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:228</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">Error</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ok</span></span></code> </pre><br>  Antarmuka WEB pengendali didasarkan pada penggunaan perintah teks.  Di salah satu tab antarmuka ada terminal tempat Anda dapat memasukkan perintah dalam bentuk teks.  Juga, tab ini, untuk keperluan debugging, memungkinkan Anda untuk mengetahui perintah apa yang dikirim dan diterima antarmuka WEB dengan berbagai tindakan pengguna. <br><br>  Interpreter perintah memudahkan untuk mengubah dan meningkatkan fungsionalitas perangkat dengan mengubah perintah yang ada dan menambahkan yang baru.  Pada saat yang sama, debugging dari sistem seperti itu sangat disederhanakan, karena  komunikasi dengan pengontrol dilakukan secara eksklusif dalam bahasa yang dapat dibaca manusia. <br><br><h2>  Kesimpulan </h2><br>  Menggunakan pendekatan serupa, yaitu: <br><br><ul><li>  Pemisahan perangkat lunak ke dalam sistem operasi dan program aplikasi </li><li>  Menerapkan pengaturan sistem operasi dalam bentuk layanan HTTP minimalis </li><li>  Memisahkan logika sistem dari penyajian data </li><li>  Menggunakan protokol komunikasi yang dapat dibaca manusia </li></ul><br>  memungkinkan Anda untuk membuat solusi yang dapat dimengerti oleh pengguna dan pengembang.  Solusi semacam itu mudah dimodifikasi.  Berdasarkan solusi tersebut, mudah untuk membangun perangkat baru dengan logika yang sama sekali berbeda, tetapi akan bekerja dengan prinsip yang sama.  Anda dapat membuat garis perangkat dengan jenis antarmuka yang sama: <br><br><img src="https://habrastorage.org/webt/5b/mg/mh/5bmgmh1jpuzsrdjpreb6jw_yopy.png"><br><br>  Seperti yang Anda lihat, dalam proyek ini hanya tiga halaman pertama dari antarmuka yang terkait langsung dengan aplikasi, dan sisanya hampir bersifat universal. <br><br>  Dalam publikasi ini, saya hanya menjelaskan pendapat saya tentang pembangunan perangkat pintar, dan dalam kasus apa pun saya tidak mengklaim sebagai kebenaran tertinggi. <br><br>  Kepada siapa topik ini menarik - tulis, mungkin saya salah tentang sesuatu, tetapi mungkin beberapa detail masuk akal untuk dijelaskan secara lebih rinci. <br><br>  Apa yang terjadi pada akhirnya: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Fiasco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kisah satu IoT buatan sendiri</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id412889/">https://habr.com/ru/post/id412889/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id412877/index.html">Ruthenium (Ru) - elemen keempat dengan sifat feromagnetik pada suhu kamar</a></li>
<li><a href="../id412879/index.html">Edisi # 24: Pelatihan TI - masalah saat ini dan tantangan dari perusahaan terkemuka</a></li>
<li><a href="../id412881/index.html">Bj√∂rn Straustrup: Masalah dengan pemrograman</a></li>
<li><a href="../id412885/index.html">Ilmu patologis</a></li>
<li><a href="../id412887/index.html">Juni Acara IT Digest</a></li>
<li><a href="../id412891/index.html">Citrix XenServer 7.0 I / O tidak dioptimalkan Agen Manajemen tidak diinstal</a></li>
<li><a href="../id412893/index.html">Untuk mencapai programmer senior dalam empat tahun: metode "Sekolah 21"</a></li>
<li><a href="../id412895/index.html">Vesta Matveeva: perang melawan kejahatan dunia maya adalah pilihan moral</a></li>
<li><a href="../id412897/index.html">Memantau Produk Atlassian dengan Prometheus</a></li>
<li><a href="../id412899/index.html">Weekend Reading: 30 materi tentang suara, sejarah merek audio dan industri film</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>