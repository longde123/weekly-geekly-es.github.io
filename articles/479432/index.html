<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143967986-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-143967986-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßíüèª üë®üèª‚Äçüöí üë∂üèø Yandex.Maps: I went to the card controller - I immediately got the user's position (okay, now seriously) üöê üõÅ üí™üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings again! 

 Most recently, I published an article literally saturated with love for Yandex.Maps. The poem. Ode. Here, in fact, she habr.com/en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yandex.Maps: I went to the card controller - I immediately got the user's position (okay, now seriously)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479432/"> Greetings again! <br><br>  Most recently, I published an article literally saturated with love for Yandex.Maps.  The poem.  Ode.  Here, in fact, she <a href="https://habr.com/ru/post/479102/">habr.com/en/post/479102</a> <br><br>  Having made sure that among programmers there are few lovers of poetry, I nevertheless decided to illuminate the situation in a more ‚ÄúHABRovsky‚Äù way.  Catch a bunch of code, thoughts and screenshots.  Go. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c36/cfb/219/c36cfb21967c60f0ee4a932e7e60dc43.jpg" alt="image"><br><a name="habracut"></a><br>  Start over. <br><br>  The task is trivial: <b>when you enter the controller with the cards, you need to immediately ‚Äúzoom out‚Äù to the user's point (bonus: you would also need to get the address in a readable form along with all available atibutes).</b> <br><br>  <u>We cut the analyst: "Divide and conquer."</u> <br><br>  To achieve this goal, it is necessary to solve a number of technical and business problems, namely: <br><br>  0. Go to the controller with a potential module for working with geo-positioning (MRSG), callbacks, etc. <br><br>  1. IWG <br>  1.1 Implement the IWG <br>  1.2 Launch IWG <br>  1.2.1 Get user coordinates <br>  1.2.2 Take a look at him <br>  2 *.  Get the position address in a readable format. <br><br>  Switching to the controller (VIPER + Configurator) <br><br><pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddPresenter</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddPresentationLogic</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... func openMap(_ delegate: YandexMapSetPointViewControllerProtocol?) { router.routeTo(target: .addPlace(delegate)) } // ... }</span></span></code> </pre> <br>  The delegate has only one function so that when you specify the desired point, you can return it via protocol to the controller that calls the controller with the card: <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YandexMapSetPointViewControllerProtocol</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">didSelectPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> place: Place)</span></span></span></span> }</code> </pre> <br>  To the delegate, we send the control part of the calling code.  Everything seems to be clear here. <br><br>  This is how unpretentious we go to the controller ... <br><br><img src="https://habrastorage.org/webt/zx/7v/yu/zx7vyupurluv41qjgddrpsseehk.png" alt="image"><br><br>  The crosshair in the center is located exactly in the center of the controller and in the center of the UIView maps.  The assumption that zooming inside maps will work by default in the center of the window.  And so it turned out. <br><br>  To the left and just below the crosshairs - UILabel.  It is planned to display a readable address there.  Right button with UIActivityIndicator.  The point is that until the user‚Äôs coordinates have arrived, he ‚Äúrotates‚Äù and the button is darkened and disabled.  By clicking on the button with the received coordinates of the user, we return the crosshair to him.  <b>This is an indication of the position, starting from the user's position.</b> <br><br>  At the bottom is the "Select Point" button.  By clicking, the magic of business logic occurs: <br><br><pre> <code class="swift hljs"><span class="hljs-meta"><span class="hljs-meta">@IBAction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selectButtonWasPressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> place = <span class="hljs-type"><span class="hljs-type">Place</span></span>() place.name = <span class="hljs-string"><span class="hljs-string">" "</span></span> place.point.latitude = <span class="hljs-string"><span class="hljs-string">"\(String(describing: selectedPoint!.latitude))"</span></span> place.point.longitude = <span class="hljs-string"><span class="hljs-string">"\(String(describing: selectedPoint!.longitude))"</span></span> place.addressText = selectedPointGeocoderedAddress delegate?.didSelectPoint(place) navigationController?.popViewController(animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) }</code> </pre><br>  <u>Hurrah!</u>  <u>We discussed the preparatory phase!</u> <br><br>  We proceed to the MRSG. <br><br>  Below is a table-formatted text that <b>personally</b> reflects <b>my assessments</b> (with fuzzy elements) of the most famous (at that time I did not know about <u><i><a href="http://www.openstreetmap.org/">www.openstreetmap.org</a></i></u> , thanks, <a href="https://habr.com/ru/users/daglob/" class="user_link">daglob</a> ) built-in map modules. <br><br><img src="https://habrastorage.org/webt/qx/sa/mv/qxsamvrveuo9d9cnrk_0cc9x73e.png"><br><br>  ‚ÄúSince the task is simple, I use Yandex.Maps.  They are beautiful, nimble ... "- I thought. <br><br>  If you are interested in how to configure this, write a mini-project, but if you are too lazy - <a href="https://tech.yandex.ru/maps/mapkit/%3Ffrom%3Dmapsapi">tech.yandex.ru/maps/mapkit/?from=mapsapi</a> , get on the track of my path.  Getting started is easy. <br><br>  The fact is that the documentation is presented in this form: <br><br><img src="https://habrastorage.org/webt/7s/zu/aa/7szuaaqboitjjfwfa7rib56wcfg.png"><br><br>  Pay attention to the meager description and the huge list of objects on the left.  Damn your leg. <br>  ‚ÄúProbably the test project will answer my questions.‚Äù  Oh well. <br><br>  Here is this beast.  <a href="https://github.com/yandex/mapkit-ios-demo">github.com/yandex/mapkit-ios-demo</a> <br>  I did not see solutions for my trivial task there. <br>  - Okay, - I think - I have enough experience, if I‚Äôm not a developer. <br><br><img src="https://habrastorage.org/webt/dl/-h/7t/dl-h7tjvei8fgovgu0ztbcx6eyy.gif"><br><br>  I assembled a test project and looked at the feature of customizing the user's marker for a long time. <br><br>  Key points: <br>  There is an object: <br><br><pre> <code class="swift hljs"><span class="hljs-meta"><span class="hljs-meta">@IBOutlet</span></span> <span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mapView: <span class="hljs-type"><span class="hljs-type">YMKMapView!</span></span> <span class="hljs-comment"><span class="hljs-comment">//  YMKUserLocationObjectListener - ,  </span></span></code> </pre> <br>  ‚ÄúEverything seems to be logical,‚Äù you say.  But no.  Alternative methods: <br><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onObjectAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with view: YMKUserLocationView)</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onObjectRemoved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with view: YMKUserLocationView)</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onObjectUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(with view: YMKUserLocationView, event: YMKObjectEvent)</span></span></span></span> {}</code> </pre> <br>  we get the opportunity to get to point.lat and point.long in extremely difficult ways. <br>  For example, like this: <br><br><pre> <code class="swift hljs">userLocation = <span class="hljs-type"><span class="hljs-type">YMKPoint</span></span>(latitude: view.pin.geometry.latitude, longitude: view.pin.geometry.longitude)</code> </pre> <br>  The waiting time for loading coordinates varies with this approach from 2 to 50 seconds. <br><br>  ‚ÄúYou're wrong, there must be a focused LocationManager,‚Äù I told myself.  As it turned out later - indeed, such a ‚Äúfriend‚Äù is in the documentation ... BUT WHERE IS AN EXAMPLE WITH HIM?!? <br>  In the sample project, there is no example of the application of such a manager: <br><br><img src="https://habrastorage.org/webt/pw/ok/fi/pwokfiikcpwl70dbvsixdmnedxi.png"><br><br>  - Well, documentation, only you and I are left. <br>  - Yes, there are no problems, "innovator", enjoy: <br><br><img src="https://habrastorage.org/webt/6f/ze/hl/6fzehl2usa1mxgciyziz6h3rl1u.png"><br><br>  We subscribe the UIViewController to the protocol (I hope there is no need to further explain anything here, well, really, guys): <br><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// MARK: - // Params var userLocation: YMKPoint? { didSet { guard userLocation != nil &amp;&amp; userLocation?.latitude != 0 &amp;&amp; userLocation?.longitude != 0 else { return } if isItFirstSelection { isItFirstSelection = false selectedPoint = userLocation mapView.mapWindow.map.move( with: YMKCameraPosition.init(target: userLocation!, zoom: 16, azimuth: 0, tilt: 0), animationType: YMKAnimation(type: YMKAnimationType.smooth, duration: 1), cameraCallback: nil) } activityIndicator.stopAnimating() } } // MARK: - // Some like didLoad setupLocationManager() // MARK: - // Setup private func setupLocationManager() { locationManager = YMKMapKit.sharedInstance()!.createLocationManager() locationManager.subscribeForLocationUpdates(withDesiredAccuracy: 0, minTime: 10, minDistance: 0, allowUseInBackground: true, filteringMode: .on, locationListener: self) } // MARK: - // MARK: YMKLocationDelegate extension YandexMapSetPointViewController: YMKLocationDelegate { func onLocationUpdated(with location: YMKLocation) { userLocation = YMKPoint(latitude: location.position.latitude, longitude: location.position.longitude) } func onLocationStatusUpdated(with status: YMKLocationStatus) {} }</span></span></code> </pre><br>  AND‚Ä¶ <br><br><img src="https://habrastorage.org/webt/vy/se/rx/vyserx968bbz28plbyag_jc-mmk.jpeg"><br><br>  1-15 seconds, CARL!  fifteen!  Sometimes it works out the previous option faster!  How is that?? <br>  Yandex, what a joke?  So much time to spend to try it all, and to get such a result - well, it's generally sad. <br><br>  I thought, thought ... Well, not really the same.  Give a person a controller with cards and put him into a stupor when switching to it for more than 4 seconds - this is suicide for the application.  No one will wait more than 5 seconds with full confidence that this is comfortable (if you do not believe me, listen to Vitaliy Fridman's reports on UI / UX). <br><br>  I thought more ... and the following emotion was this: <br><br><img src="https://habrastorage.org/webt/-8/f_/wb/-8f_wbwxosvigxvw_qu905rrpla.gif"><br>  <i>Who wants with sound - <a href="https://www.youtube.com/watch%3Fv%3DpTZaNHZGsQo">www.youtube.com/watch?v=pTZaNHZGsQo</a></i> <br><br>  The recipe for success was this: <br>  Take a <s>kilo ...</s> CLLocationManager and YMKLocationManager and ... make them work together. <br><br><img src="https://habrastorage.org/webt/zu/qt/b9/zuqtb90bcok18z_qs7pw1zxd88g.jpeg"><br><br>  This joint ... "work" looks something like this: <br><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// Params private var locationManager: YMKLocationManager! private var nativeLocationManager = CLLocationManager() // MARK: - // Some like didLoad setupNativeLocationManager() // MARK: - // Setup private func setupNativeLocationManager() { if CLLocationManager.locationServicesEnabled() { nativeLocationManager.delegate = self nativeLocationManager.desiredAccuracy = kCLLocationAccuracyNearestTenMeters nativeLocationManager.startUpdatingLocation() } } // MARK: - // CLLocationManagerDelegate extension YandexMapSetPointViewController: CLLocationManagerDelegate { func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) { userLocation = YMKPoint(latitude: locations.last!.coordinate.latitude, longitude: locations.last!.coordinate.longitude) } }</span></span></code> </pre><br><br>  <s>... and the pilaf is ready</s> <br><br>  The result of the speed of getting the user's point: a little more than 0 seconds. <br><br>  The very case when (in my opinion) when solving a trivial problem, the opposition of the native and embedded parts looked like this: <br><br><img src="https://habrastorage.org/webt/lk/we/ub/lkweublnp6onabh3cdpfigc5z-m.gif"><br><br><div class="spoiler">  <b class="spoiler_title">Geocoder *</b> <div class="spoiler_text">  As a bonus, I‚Äôll show the implementation of the geocoder. <br>  Used Yandex <a href="https://tech.yandex.ru/maps/geocoder/">Geocoder tech.yandex.ru/maps/geocoder</a> <br><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// Params private let geocoderManager = GeocoderManager.shared //      .     import Foundation import Alamofire import Alamofire_SwiftyJSON import SwiftyJSON import PromiseKit import UIKit // MARK: - // MARK: GeocoderManager class GeocoderManager { static let shared = GeocoderManager() private init() {} func getAddressBy(latitude: String, longitude: String, completion: @escaping (Bool, String?, Error?)-&gt;()) { GeocoderAPI().request(latitude: latitude, longitude: longitude).done { (response) in completion(true, response.getAddress(), nil) print("success") }.catch { (error) in completion(false, nil, error) } } } // import Foundation import Alamofire import PromiseKit // MARK: - // MARK: Request enum GeocoderRequest { case addressRequest(String, String) } // MARK: - // MARK: GeocoderRequest extension GeocoderRequest: DefaultRequest { var path: String { switch self { case .addressRequest: return "1.x/" } } var method: HTTPMethod { switch self { case .addressRequest: return .get } } var headers: HTTPHeaders { return [:] } var parameters: [String: Any]? { switch self { case .addressRequest(let latitude, let longitude): return [ "apikey" : Consts.APIKeys.yandexGeocoderKey, "format" : "json", "results" : 1, "spn" : "3.552069,2.400552", "geocode" : "\(longitude),\(latitude)" ] } } func asURLRequest() throws -&gt; URLRequest { let url = try GlobalConsts.Links.geocoderBaseURL.asURL()// not good, need new idea for this var urlRequest = URLRequest(url: url.appendingPathComponent(path)) urlRequest.httpMethod = method.rawValue urlRequest.allHTTPHeaderFields = headers switch method { case .get: urlRequest = try URLEncoding.default.encode(urlRequest, with: parameters) case .post: urlRequest = try JSONEncoding.default.encode(urlRequest, with: parameters) case .put: urlRequest = try JSONEncoding.default.encode(urlRequest, with: parameters) case .patch: urlRequest = try JSONEncoding.default.encode(urlRequest, with: parameters) case .delete: urlRequest = try JSONEncoding.default.encode(urlRequest, with: parameters) default: break } return urlRequest } }</span></span></code> </pre><br>  This resource helps a lot to convert the response from the server to the model: <a href="https://app.quicktype.io/">app.quicktype.io</a> </div></div><br>  The result of the work visually is as follows: <br><br><img src="https://habrastorage.org/webt/co/19/u7/co19u7hvhmnhdr8r_bh2ek_nl9k.jpeg"><br><br>  Summarizing the above: <br>  colleagues, the article is written so that when solving such a problem you do not spend as much time as I spent and either choose a different path or walk it quickly. <br><br>  I would like to see constructive criticism and / or alternative <b>correct</b> solutions. <br><br>  If the article turned out to be useful to you, correct me with a Lois rating and, preferably, check out the <a href="https://habr.com/ru/post/479102/">original version of this story</a> in a new way. <br><br>  All creative success and positive mood! </div></div><p>Source: <a href="https://habr.com/ru/post/479432/">https://habr.com/ru/post/479432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479420/index.html">Open microphone: backend. Guest Registration</a></li>
<li><a href="../479422/index.html">[Video animation] Wired world: how in 35 years a network of submarine cables enveloped the globe</a></li>
<li><a href="../479426/index.html">Security Week 50: Man-in-the-middle attacks in Confluence and Linux</a></li>
<li><a href="../479428/index.html">Digital events in Moscow from December 9 to 15</a></li>
<li><a href="../479430/index.html">Digital events in St. Petersburg from December 9 to 15</a></li>
<li><a href="../479438/index.html">Postgres-Tuesday # 5: ‚ÄúPostgreSQL and Kubernetes. CI / CD. Test Automation ¬ª</a></li>
<li><a href="../479442/index.html">Alexey Savvateev: Game-theoretic model of social schism (+ nginx survey)</a></li>
<li><a href="../479446/index.html">Cars are already ahead of people in reading tests; but do they understand what they read?</a></li>
<li><a href="../479450/index.html">AppCode 2019.3: works faster, understands Swift better, knows about Mac Catalyst, conveniently displays assembly messages</a></li>
<li><a href="../479452/index.html">How the Domain Name System Developed: The ARPANET Era</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter54458986 = new Ya.Metrika({
                  id:54458986,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/54458986" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-143967986-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=IU0EG0jaqnehka2lu5TyzAcchrZXI4Yb1QXKQvJxpqE&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>