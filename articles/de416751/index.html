<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏üèø üïê üßùüèΩ Sammlung von Kontextinformationen f√ºr die Protokollierung üò± üôãüèø ‚òùüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oft m√ºssen Sie zus√§tzliche Informationen in die Protokolle schreiben, um die Situation zu kl√§ren und das Debuggen der Anwendung weiter zu vereinfachen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sammlung von Kontextinformationen f√ºr die Protokollierung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416751/"><p>  Oft m√ºssen Sie zus√§tzliche Informationen in die Protokolle schreiben, um die Situation zu kl√§ren und das Debuggen der Anwendung weiter zu vereinfachen.  Wenn beispielsweise Fehlerinformationen protokolliert werden, ist es hilfreich, die Eingabedaten auch in irgendeiner Form zu speichern, damit das Problem leichter reproduziert werden kann.  Hier m√∂chte ich einen Ansatz beschreiben, mit dem Sie diese zus√§tzlichen Informationen sammeln k√∂nnen. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Erkl√§rung des Problems </h2><br><p>  Angenommen, wir haben einen ASP.NET MVC We-Service.  Es akzeptiert POST-Anforderungen, die eine Beschreibung dessen enthalten, was im JSON-Format zu tun ist.  Nach der Analyse einer solchen Beschreibung erstellt der Dienst mehrere SQL-Abfragen und f√ºhrt sie in der Datenbank aus.  Anschlie√üend kombiniert er die Ergebnisse und sendet sie an den Kunden. </p><br><p> Es muss gesagt werden, dass dieser Dienst Asynchronit√§t und Multithreading durch <em>Async / Awarit</em> und <code>Task</code> gro√üem Umfang nutzt. </p><br><p>  Nachdem wir verstanden haben, womit wir es zu tun haben, gehen wir zu den Problemen √ºber. </p><br><h2 id="sbor-kontekstnoy-informacii-ob-oshibkah">  Sammeln von Kontextfehlerinformationen </h2><br><p>  Manchmal gibt unser Service Fehler.  Die Gr√ºnde k√∂nnen unterschiedlich sein: falsche Eingabe-JSON, Fehler im Code, Probleme mit der Datenbank ... In diesem Fall sollten wir Fehlerinformationen in das Protokoll schreiben. </p><br><p>  Es gibt kein Problem, die Ausnahme selbst zu protokollieren.  Wir k√∂nnen es in der Aktionsmethode unseres Controllers abfangen: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServiceController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"api/service"</span></span>)] [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Logger.LogError(ex); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } }</code> </pre> <br><p>  Oder wir k√∂nnen ein spezielles Attribut daf√ºr erstellen: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogErrorAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (actionExecutedContext.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Logger.LogError(actionExecutedContext.Exception); } } }</code> </pre> <br><p>  und verwenden Sie es f√ºr die Aktionsmethode: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/service"</span></span></span><span class="hljs-meta">)</span></span>] [HttpPost] [LogError] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br><p>  Aber wir brauchen mehr.  F√ºr jeden Fehler m√∂chten wir zus√§tzliche Informationen speichern: </p><br><ul><li>  Der Text des JSON-Textes der Anforderung. </li><li>  Der Text aller generierten SQL-Abfragen. </li></ul><br><p>  Es gibt noch eine Anforderung.  Diese zus√§tzlichen Informationen sollten nur dann im Protokoll aufgezeichnet werden, wenn ein Fehler auftritt.  Andernfalls ben√∂tigen wir es nicht in den Protokollen. </p><br><p>  Dies f√ºr den Anfragetext zu tun ist nicht schwierig: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServiceController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"api/service"</span></span>)] [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestText = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Request.Content.ReadAsStringAsync(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Logger.LogError(ex); Logger.LogError(<span class="hljs-string"><span class="hljs-string">$"Request test is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{requestText}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } }</code> </pre> <br><p>  Bei SQL-Abfragen ist jedoch nicht alles so einfach.  Tatsache ist, dass diese Anforderungen nicht von der Aktionsmethode generiert werden.  Sie werden nicht einmal in der Steuerung generiert.  Zwischen der Aktionsmethode und der SQL-Generierungsmethode werden viele Methoden anderer Klassen aufgerufen.  Wie extrahieren wir die Texte dieser Anfragen, wenn wir sie brauchen? </p><br><p>  Eine M√∂glichkeit besteht darin, eine Liste von Nachrichten zu verwenden (z. B. <code>List&lt;string&gt;</code> ).  Wir erstellen es in unserer Aktionsmethode ( <code>ServiceAction</code> ) und √ºbergeben es an die Methode, die SQL generiert.  Dort werden wir die SQL-Abfragetexte zu dieser Liste hinzuf√ºgen.  Im Falle eines Fehlers enth√§lt die Aktionsmethode eine Liste der Nachrichten, die im Protokoll abgelegt werden m√ºssen. </p><br><p>  Diese Methode hat meiner Meinung nach einen sehr bedeutenden Nachteil.  Wir m√ºssen unsere Liste der Nachrichten entlang der gesamten Kette von Methodenaufrufen √ºbergeben, bis wir die Methode erreichen, die SQL generiert.  Dies bedeutet, dass diese Liste von Nachrichten vielerorts nur zur Weitergabe ben√∂tigt wird.  Dies kompliziert den Code und ich w√ºrde versuchen, ihn zu vermeiden. </p><br><p>  Wenn Sie einen DI-Container verwenden und Ihre Klassen daraus erstellen k√∂nnen, k√∂nnen Sie versuchen, die Liste der Nachrichten mit einer Lebensdauer pro Anforderung in den Container einzuf√ºgen.  Die SQL-Generierungsklasse akzeptiert diese Nachrichtenliste als Konstruktorparameter.  Dann k√∂nnen sowohl eine Instanz dieser Klasse als auch eine Instanz des Controllers auf dieselbe Instanz der Nachrichtenliste zugreifen. </p><br><p>  Es gibt jedoch eine bequemere M√∂glichkeit, Kontextinformationen zu erfassen, selbst wenn Sie keinen DI-Container verwenden.  Es w√§re sch√∂n, wenn wir √ºber eine statische Eigenschaft auf die Nachrichtenliste zugreifen k√∂nnten: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;SqlDataReader&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunReaderAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SqlCommand cmd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-string"><span class="hljs-string">$"SQL Server query is: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cmd.CommandText}</span></span></span><span class="hljs-string">"</span></span>; ErrorContext.Current.AttachMessage(message); ... }</code> </pre> <br><p>  Hier liegt ein ernstes Problem vor.  Unser Service kann gleichzeitig mehrere Anfragen bedienen.  Und jede solche Anfrage sollte eine eigene Liste von Nachrichten haben.  Dar√ºber hinaus kann unser Code bei der Verarbeitung einer einzelnen Anforderung mehrere Threads erzeugen (z. B. mit <em>async / await</em> ).  Alle diese Threads m√ºssen Zugriff auf dieselbe Nachrichtenliste haben.  Wie kann dies umgesetzt werden? </p><br><p>  Die <code>AsyncLocal&lt;T&gt;</code> -Klasse <code>AsyncLocal&lt;T&gt;</code> uns dabei.  Es garantiert, dass Sie, wenn Sie einen Wert in eine Instanz dieser Klasse in einem Thread einf√ºgen, diesen Wert in diesem Thread sowie in allen von diesem Thread aus gestarteten Threads ab sofort erhalten k√∂nnen.  Gleichzeitig haben alle anderen Threads keinen Zugriff auf diesen Wert. </p><br><p>  Schauen wir uns die Implementierung der <code>ErrorContext</code> Klasse an: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ErrorContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Lock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;ErrorContext&gt; CurrentErrorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;ErrorContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; _attachedMessages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ErrorContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ErrorContext Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorContext = CurrentErrorContext.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorContext == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentErrorContext.Value = errorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorContext(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errorContext; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ErrorContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateNewErrorContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorContext(); CurrentErrorContext.Value = errorContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errorContext; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(message)) { _attachedMessages.Value.Add(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMessages</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _attachedMessages.Value.ToArray(); } }</code> </pre> <br><p>  Die <code>CreateNewErrorContext</code> Methode erstellt sofort eine neue Nachrichtenliste und speichert sie im Feld <code>CurrentErrorContext</code> , das vom Typ <code>AsyncLocal</code> .  Mit der statischen Eigenschaft <code>Current</code> k√∂nnen Sie an einer beliebigen Stelle im Code auf die aktuelle Liste zugreifen.  Die <code>AttachMessage</code> Methode f√ºgt der Liste eine neue Nachricht hinzu.  Es speichert Nachrichten in einer Instanz von <code>ConcurrentBag</code> , da diese Methode von mehreren Threads gleichzeitig aufgerufen werden kann.  Die <code>GetMessages</code> Methode gibt alle gespeicherten Nachrichten zur√ºck, damit sie in das Protokoll geschrieben werden k√∂nnen. </p><br><p>  Jetzt k√∂nnen Sie <code>ErrorContext</code> in <code>LogErrorAttribute</code> initialisieren und verwenden: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogErrorAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionContext actionContext</span></span></span><span class="hljs-function">)</span></span> { ErrorContext.CreateNewErrorContext(); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuting(actionContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (actionExecutedContext.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ErrorContext.Current.GetMessages()) { Logger.LogError(message); } Logger.LogError(actionExecutedContext.Exception); } } }</code> </pre> <br><p>  √úberall in Ihrem Code k√∂nnen Sie Ihre Nachricht wie folgt zum aktuellen Fehlerkontext hinzuf√ºgen: </p><br><pre> <code class="cs hljs">ErrorContext.Current.AttachMessage(message);</code> </pre> <br><h2 id="logirovanie-problem-s-proizvoditelnostyu">  Leistungsprotokollierung </h2><br><p>  Manchmal ist mein Service langsam.  Nicht f√ºr alle Abfragen, aber f√ºr einige dauert es zu lange, bis sie abgeschlossen sind.  Ich m√∂chte Informationen √ºber solche Anfragen behalten, um sie sp√§ter zu analysieren.  Wie kann dies umgesetzt werden und welche Informationen ben√∂tigen wir? </p><br><p>  Zun√§chst brauche ich eine Laufzeitschwelle.  Wenn die Bearbeitung der Anfrage weniger Zeit in Anspruch nimmt, ist alles in Ordnung.  Ich werde in diesem Fall nichts in das Protokoll schreiben.  Wenn es jedoch l√§nger dauert, muss ich dem Protokoll einige Informationen hinzuf√ºgen. </p><br><p>  Welche Informationen brauche ich?  Sie m√ºssen auf jeden Fall wissen, wie lange die Bearbeitung der Anfrage gedauert hat.  Das reicht aber nicht.  Mein Dienst erledigt viele Dinge: Abfrageparameter √ºberpr√ºfen, Daten von anderen Diensten abrufen, SQL-Abfragen erstellen und ausf√ºhren ... Ich muss wissen, wie viel Zeit jeder dieser Teile ben√∂tigt hat, um zu verstehen, wo das Problem verborgen ist. </p><br><p>  Au√üerdem ben√∂tige ich die gleichen Informationen wie f√ºr die Fehler.  Ich ben√∂tige einen Anfragetext, um das Problem reproduzieren zu k√∂nnen.  Ich ben√∂tige die Texte von SQL-Abfragen, falls sie am l√§ngsten dauern. </p><br><p>  Wie kann dies erreicht werden?  Verwenden Sie erneut die <code>AsyncLocal</code> Klasse: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Timer</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Lock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;Timer&gt; CurrentTimer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;Timer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Stopwatch _stopwatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentQueue&lt;Timer&gt;&gt; _attachedTimers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentQueue&lt;Timer&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;Timer&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Lazy&lt;ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; _attachedMessages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _description; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TimeSpan? _threshold; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Timer _previousCurrent; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _isDisposed; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _suspendLogging; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Timer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Timer previousCurrent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, TimeSpan? threshold = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { _previousCurrent = previousCurrent; _description = description; _threshold = threshold; _stopwatch.Start(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Timer Current { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timer = CurrentTimer.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timer == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentTimer.Value = timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Timer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCurrentTimer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, TimeSpan? threshold = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTimer = CurrentTimer.Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Timer(currentTimer, description, threshold); CurrentTimer.Value = timer; currentTimer?._attachedTimers.Value.Enqueue(timer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(message)) { _attachedMessages.Value.Enqueue(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_isDisposed) { _isDisposed = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _stopwatch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedTimers.IsValueCreated) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attachedTimer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _attachedTimers.Value) { attachedTimer.Dispose(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_suspendLogging &amp;&amp; _threshold.HasValue &amp;&amp; _stopwatch.Elapsed &gt; _threshold.Value) { Log(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_previousCurrent != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { CurrentTimer.Value = _previousCurrent; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> JObject Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">$"It took </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_stopwatch.ElapsedMilliseconds}</span></span></span><span class="hljs-string"> ms to execute </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_description}</span></span></span><span class="hljs-string">."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_threshold.HasValue) { message.Append(<span class="hljs-string"><span class="hljs-string">$" Duration threshold is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_threshold.Value.TotalMilliseconds}</span></span></span><span class="hljs-string"> ms."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JObject { [<span class="hljs-string"><span class="hljs-string">"message"</span></span>] = message.ToString(), }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedTimers.IsValueCreated &amp;&amp; _attachedTimers.Value.Any()) { messageObj[<span class="hljs-string"><span class="hljs-string">"attachedTimers"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JArray(_attachedTimers.Value.Select(t =&gt; t.Message)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_attachedMessages.IsValueCreated &amp;&amp; _attachedMessages.Value.Any()) { messageObj[<span class="hljs-string"><span class="hljs-string">"attachedMessages"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JArray(_attachedMessages.Value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageObj; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _suspendLogging = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_stopwatch.Elapsed &lt; _threshold) { Logger.LogDebug(Message.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Logger.LogWarning(Message.ToString()); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _suspendLogging = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } }</code> </pre> <br><p>  Mal sehen, wie es funktioniert.  Die <code>SetCurrentTimer</code> Methode erstellt einen neuen Timer.  Hier k√∂nnen Sie die Beschreibung und einen optionalen Laufzeitschwellenwert angeben. </p><br><p>  Warum ist dieser Schwellenwert optional?  Manchmal muss ein Teil meines Codes nicht l√§nger als eine bestimmte Zeit ausgef√ºhrt werden.  Ich kann mir also w√ºnschen, dass die gesamte Serviceanfrage in 3 Sekunden bearbeitet wird.  In anderen F√§llen m√∂chte ich die Laufzeit nicht einschr√§nken.  Zum Beispiel spielt es f√ºr mich keine Rolle, wie lange es dauert, meine SQL-Abfragen auszuf√ºhren, bis die gesamte Serviceanforderung in weniger als 3 Sekunden verarbeitet ist.  Aus diesem Grund muss f√ºr einige Timer ein Laufzeitschwellenwert festgelegt werden, f√ºr andere nicht. </p><br><p>  Innerhalb der <code>SetCurrentTimer</code> Methode wird ein neuer Timer erstellt und in die <code>CurrentTimer</code> Variable vom Typ <code>AsyncLocal</code> .  Das ist aber noch nicht alles.  Zu diesem Zeitpunkt ist m√∂glicherweise bereits ein anderer aktiver Timer vorhanden.  In diesem Fall wird der gerade erstellte neue Timer mit dem vorhandenen verbunden.  Auf diese Weise k√∂nnen Sie verschachtelte Timer erstellen, um die Ausf√ºhrungszeit des gesamten Codeblocks und seiner Teile zu messen: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"The whole block"</span></span>)) { ... <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"Part 1"</span></span>)) { ... } ... <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Timer.SetCurrentTimer(<span class="hljs-string"><span class="hljs-string">"Part 2"</span></span>)) { ... } ... }</code> </pre> <br><p>  Die <code>Current</code> Eigenschaft erm√∂glicht den Zugriff auf den aktuellen Timer.  Dies ist n√ºtzlich, wenn Sie einige Nachrichten hinzuf√ºgen m√∂chten: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-string"><span class="hljs-string">$"SQL Server query is: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{cmd.CommandText}</span></span></span><span class="hljs-string">"</span></span>; Timer.Current.AttachMessage(message);</code> </pre> <br><p>  Hier werden die angeh√§ngten Nachrichten und verschachtelten Timer in Instanzen von <code>ConcurrentQueue</code> gespeichert, da ihre Reihenfolge wichtig sein kann. </p><br><p>  Die <code>Message</code> Eigenschaft gibt Nachrichten zur√ºck, die in einer einzelnen Einheit vom aktuellen und allen darin gestapelten Timern gesammelt wurden.  Hier verwende ich die JSON-Klassen aus der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JSON.NET-</a> Bibliothek, um alle Nachrichten zu strukturieren.  Aber eigentlich ist es nicht so wichtig.  Sie k√∂nnen ein beliebiges Format verwenden. </p><br><p>  Die <code>Log</code> schreibt im Timer gespeicherte Informationen in das Protokoll, unabh√§ngig davon, ob der Laufzeitschwellenwert festgelegt wurde oder nicht.  Gleichzeitig schreibt die <code>Dispose</code> Methode nur dann Informationen in das Protokoll, wenn der festgelegte Laufzeitschwellenwert √ºberschritten wurde. </p><br><p>  Jetzt k√∂nnen wir ein weiteres Attribut f√ºr die Methoden unserer Controller erstellen: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TimerContextAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _timerDescription; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _durationThresholdMs; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;Timer&gt; _timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;Timer&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimerContextAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timerDescription, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> durationThresholdMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(timerDescription)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(timerDescription)); _timerDescription = timerDescription; _durationThresholdMs = durationThresholdMs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionContext actionContext</span></span></span><span class="hljs-function">)</span></span> { _timer.Value = Timer.SetCurrentTimer(_timerDescription, TimeSpan.FromMilliseconds(_durationThresholdMs)); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuting(actionContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpActionExecutedContext actionExecutedContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuted(actionExecutedContext); _timer.Value?.Dispose(); } }</code> </pre> <br><p>  und verwenden Sie es f√ºr Aktionsmethoden wie diese: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/service"</span></span></span><span class="hljs-meta">)</span></span>] [HttpPost] [TimerContext(<span class="hljs-string"><span class="hljs-string">"For ServiceAction method"</span></span>, <span class="hljs-number"><span class="hljs-number">3000</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;HttpResponseMessage&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ServiceAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> [FromBody] RequestModel requestModel </span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  In diesem Artikel habe ich beschrieben, wie einfach es ist, Informationen an vielen Stellen im Code zu sammeln und sp√§ter darauf zuzugreifen.  Solche Funktionen k√∂nnen mithilfe statischer Eigenschaften und Methoden implementiert werden, mit denen Instanzen der <code>AsyncLocal</code> Klasse <code>AsyncLocal</code> . </p><br><p>  Ich hoffe, der Artikel wird n√ºtzlich sein, um das Protokollierungssystem in Ihren Anwendungen zu verbessern. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416751/">https://habr.com/ru/post/de416751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416737/index.html">A * Pfadfindungsalgorithmus in einem Voxel 3d Unity-Spiel</a></li>
<li><a href="../de416739/index.html">Neues ASUS auf der Computex 2018</a></li>
<li><a href="../de416741/index.html">Angreifer verwendeten gestohlene D-Link-Zertifikate in ihrer Software f√ºr Passwortdiebstahl</a></li>
<li><a href="../de416743/index.html">Bot f√ºr Starcraft in Rust, C und jeder anderen Sprache</a></li>
<li><a href="../de416745/index.html">Neuer ASUS ROG auf der Computex 2018</a></li>
<li><a href="../de416753/index.html">Beliebtes Hola VPN Plugin kompromittiert</a></li>
<li><a href="../de416755/index.html">Extreme Likes - Untersuchungsausschuss gegen</a></li>
<li><a href="../de416757/index.html">Flockige Tests</a></li>
<li><a href="../de416759/index.html">Warum k√ºnstliche Intelligenz nicht alle Probleme l√∂st</a></li>
<li><a href="../de416761/index.html">Kosmische Sprache, Teil 1: Ist universelle Grammatik universell?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>