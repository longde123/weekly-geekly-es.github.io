<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèø üë®‚Äçüë¶ üõï Perfiles de memoria en STM32 y otros microcontroladores: an√°lisis de tama√±o de pila est√°tica üïë üëåüèΩ üë≤üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 

 En el √∫ltimo art√≠culo , lo mencion√© yo mismo y pregunt√© en los comentarios: ok, bueno, usando el m√©todo de empuje cient√≠fico, selecciona...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Perfiles de memoria en STM32 y otros microcontroladores: an√°lisis de tama√±o de pila est√°tica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443544/">  Hola Habr! <br><br>  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltimo art√≠culo</a> , lo mencion√© yo mismo y pregunt√© en los comentarios: ok, bueno, usando el m√©todo de empuje cient√≠fico, seleccionamos el tama√±o de la pila, parece que nada est√° cayendo, pero ¬øpodemos evaluar de alguna manera m√°s confiable a qu√© es igual y qui√©n comi√≥ tanto? <br><br>  Respondemos brevemente: s√≠, pero no. <br><br>  No, utilizando los m√©todos de an√°lisis est√°tico es imposible medir con precisi√≥n el tama√±o de la pila requerida por el programa, pero, sin embargo, estos m√©todos pueden ser √∫tiles. <br><br>  La respuesta es un poco m√°s larga, debajo del corte. <br><a name="habracut"></a><br>  Como es ampliamente conocido por un c√≠rculo estrecho de personas, el lugar en la pila se asigna, de hecho, a las variables locales que utiliza la funci√≥n que ejecuta actualmente, con la excepci√≥n de las variables con el modificador est√°tico, que se almacenan en la memoria asignada est√°ticamente, en el √°rea bss, porque deben guardar sus significados entre llamadas a funciones. <br><br>  Cuando se ejecuta la funci√≥n, el compilador agrega espacio en la pila para las variables que necesita, y al finalizar, libera este espacio.  Parece que todo es simple, pero, y esto es muy audaz, <b>pero</b> tenemos varios problemas: <br><br><ol><li>  las funciones llaman dentro de otras funciones que tambi√©n necesitan una pila </li><li> a veces las funciones llaman a otras funciones no por su referencia directa, sino por un puntero a una funci√≥n </li><li>  en principio, es posible, aunque debe evitarse por todos los medios, una llamada de funci√≥n recursiva cuando A llama a B, B llama a C y C dentro de s√≠ mismo vuelve a llamar a A </li><li>  en cualquier momento puede ocurrir una interrupci√≥n, cuyo manejador es la misma funci√≥n que quiere su propia parte de la pila </li><li>  Si tiene una jerarqu√≠a de interrupciones, puede ocurrir otra interrupci√≥n dentro de la interrupci√≥n. </li></ol><br>  Sin ambig√ºedades, las llamadas a funciones recursivas deben eliminarse de esta lista, porque su presencia es una ocasi√≥n para no considerar el tama√±o de la pila, sino para expresar su opini√≥n al autor del c√≥digo.  Todo lo dem√°s, por desgracia, no se puede tachar en el caso general (aunque en particular puede haber matices: por ejemplo, todas las interrupciones para usted pueden tener la misma prioridad por dise√±o, por ejemplo, como en RIOT OS, y no habr√° interrupciones anidadas). <br><br>  Ahora imagine una pintura al √≥leo: <br><br><ul><li>  la funci√≥n A, que come 100 bytes en la pila, llama a la funci√≥n B, que necesita 50 bytes </li><li>  en el momento de la ejecuci√≥n de B, A, obviamente, a√∫n no ha terminado, por lo que sus 100 bytes no est√°n liberados, por lo que ya tenemos 150 bytes en la pila </li><li>  la funci√≥n B llama a la funci√≥n C, y lo hace mediante un puntero que, seg√∫n la l√≥gica del programa, puede apuntar a media docena de funciones diferentes que consumen de 5 a 50 bytes de pila </li><li>  en tiempo de ejecuci√≥n C, se produce una interrupci√≥n con un controlador pesado que se ejecuta relativamente largo y consume 20 bytes de pila </li><li>  durante el procesamiento de interrupci√≥n, se produce otra interrupci√≥n de mayor prioridad, cuyo controlador quiere 10 bytes de pila </li></ul><br>  En este hermoso dise√±o, con una coincidencia particularmente exitosa de todas las circunstancias, tendr√° <i>al menos cinco funciones activas simult√°neamente</i> : A, B, C y dos controladores de interrupci√≥n.  Adem√°s, uno de ellos no tiene una constante de consumo de pila, ya que puede ser una funci√≥n diferente en diferentes pases, y para comprender la posibilidad o imposibilidad de interrumpirse entre s√≠, al menos debe saber si tiene interrupciones con diferentes prioridades. y, como m√°ximo, para comprender si pueden superponerse entre s√≠. <br><br>  Obviamente, para cualquier analizador autom√°tico de c√≥digo est√°tico, esta tarea es extremadamente abrumadora, y solo se puede realizar en una aproximaci√≥n aproximada de la estimaci√≥n superior: <br><br><ul><li>  suma las pilas de todos los manejadores de interrupciones </li><li>  resumir pilas de funciones que se ejecutan en la misma rama de c√≥digo </li><li>  intente encontrar todos los punteros a las funciones y sus llamadas, y tome el tama√±o m√°ximo de la pila entre las funciones a las que apuntan estos punteros como el tama√±o de la pila </li></ul><br>  En la mayor√≠a de los casos, obtendr√°, por un lado, una estimaci√≥n muy alta y, por otro, la oportunidad de omitir algunas llamadas de funciones particularmente dif√≠ciles a trav√©s de punteros. <br><br>  Por lo tanto, en el caso general, simplemente podemos decir: <b>esta tarea no se resuelve autom√°ticamente</b> .  Una soluci√≥n manual, una persona que conoce la l√≥gica de este programa, requiere excavar bastantes n√∫meros. <br><br>  Sin embargo, una estimaci√≥n est√°tica del tama√±o de la pila puede ser muy √∫til para optimizar el software, al menos con el simple prop√≥sito de comprender qui√©n est√° comiendo cu√°nto y no demasiado. <br><br>  Hay dos herramientas extremadamente √∫tiles para esto en la cadena de herramientas GNU / gcc: <br><br><ul><li>  flag -fstack-use </li><li>  utilidad cflow </li></ul><br>  Si agrega -fstack-use a los indicadores gcc (por ejemplo, al Makefile en la l√≠nea con CFLAGS), entonces para <i>cada</i> archivo compilado% filename% .c, el compilador crear√° el archivo% filename% .su, dentro del cual habr√° texto simple y claro. <br><br>  Tomemos, por ejemplo, target.su para <a href="">este gigantesco calzado</a> : <br><br><pre><code class="plaintext hljs">target.c:159:13:save_settings 8 static target.c:172:13:disable_power 8 static target.c:291:13:adc_measure_vdda 32 static target.c:255:13:adc_measure_current 24 static target.c:76:6:cpu_setup 0 static target.c:81:6:clock_setup 8 static target.c:404:6:dma1_channel1_isr 24 static target.c:434:6:adc_comp_isr 40 static target.c:767:6:systick_activity 56 static target.c:1045:6:user_activity 104 static target.c:1215:6:gpio_setup 24 static target.c:1323:6:target_console_init 8 static target.c:1332:6:led_bit 8 static target.c:1362:6:led_num 8 static</code> </pre> <br>  Aqu√≠ vemos el consumo real de la pila para cada funci√≥n que aparece en ella, de lo que podemos sacar algunas conclusiones por nosotros mismos, bueno, por ejemplo, lo que vale la pena intentar optimizar en primer lugar, si nos encontramos con una falta de RAM. <br><br>  Al mismo tiempo, atenci√≥n, ¬° <b>este archivo en realidad no proporciona informaci√≥n precisa sobre el consumo real de la pila para funciones desde las cuales se llaman otras funciones</b> ! <br><br>  Para comprender el consumo total, necesitamos construir un √°rbol de llamadas y resumir las pilas de todas las funciones incluidas en cada una de sus ramas.  Esto se puede hacer, por ejemplo, con la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GNU cflow</a> configur√°ndolo en uno o m√°s archivos. <br><br>  El escape aqu√≠ obtenemos un orden de magnitud m√°s pesado, solo dar√© una parte para el mismo objetivo. C: <br><br><pre> <code class="bash hljs">olegart@oleg-npc /mnt/c/Users/oleg/Documents/Git/dap42 (umdk-emb) $ cflow src/stm32f042/umdk-emb/target.c adc_comp_isr() &lt;void adc_comp_isr (void) at src/stm32f042/umdk-emb/target.c:434&gt;: TIM_CR1() ADC_DR() ADC_ISR() DMA_CCR() GPIO_BSRR() GPIO_BRR() ADC_TR1() ADC_TR1_HT_VAL() ADC_TR1_LT_VAL() TIM_CNT() DMA_CNDTR() DIV_ROUND_CLOSEST() NVIC_ICPR() clock_setup() &lt;void clock_setup (void) at src/stm32f042/umdk-emb/target.c:81&gt;: rcc_clock_setup_in_hsi48_out_48mhz() crs_autotrim_usb_enable() rcc_set_usbclk_source() dma1_channel1_isr() &lt;void dma1_channel1_isr (void) at src/stm32f042/umdk-emb/target.c:404&gt;: DIV_ROUND_CLOSEST() gpio_setup() &lt;void gpio_setup (void) at src/stm32f042/umdk-emb/target.c:1215&gt;: rcc_periph_clock_enable() button_setup() &lt;void button_setup (void) at src/stm32f042/umdk-emb/target.c:1208&gt;: gpio_mode_setup() gpio_set_output_options() gpio_mode_setup() gpio_set() gpio_clear() rcc_peripheral_enable_clock() tim2_setup() &lt;void tim2_setup (void) at src/stm32f042/umdk-emb/target.c:1194&gt;: rcc_periph_clock_enable() rcc_periph_reset_pulse() timer_set_mode() timer_set_period() timer_set_prescaler() timer_set_clock_division() timer_set_master_mode() adc_setup_common() &lt;void adc_setup_common (void) at src/stm32f042/umdk-emb/target.c:198&gt;: rcc_periph_clock_enable() gpio_mode_setup() adc_set_clk_source() adc_calibrate() adc_set_operation_mode() adc_disable_discontinuous_mode() adc_enable_external_trigger_regular() ADC_CFGR1_EXTSEL_VAL() adc_set_right_aligned() adc_disable_temperature_sensor() adc_disable_dma() adc_set_resolution() adc_disable_eoc_interrupt() nvic_set_priority() nvic_enable_irq() dma_channel_reset() dma_set_priority() dma_set_memory_size() dma_set_peripheral_size() dma_enable_memory_increment_mode() dma_disable_peripheral_increment_mode() dma_enable_transfer_complete_interrupt() dma_enable_half_transfer_interrupt() dma_set_read_from_peripheral() dma_set_peripheral_address() dma_set_memory_address() dma_enable_circular_mode() ADC_CFGR1() memcpy() console_reconfigure() tic33m_init() strlen() tic33m_display_string()</code> </pre> <br>  Y eso ni siquiera es la mitad del √°rbol. <br><br>  Para comprender el consumo real de la pila, necesitamos tomar el consumo para <i>cada una</i> de las funciones mencionadas en √©l y sumar estos valores para cada una de las ramas. <br><br>  Y aunque todav√≠a no tenemos en cuenta las llamadas de funci√≥n por punteros e interrupciones, incl.  anidados (y espec√≠ficamente en este c√≥digo, pueden anidarse). <br><br>  Como puede suponer, hacer esto cada vez que cambia el c√≥digo es, por decirlo suavemente, dif√≠cil, es por eso que generalmente nadie lo hace. <br><br>  Sin embargo, es necesario comprender los principios del llenado de la pila: esto puede conducir a ciertas restricciones en el c√≥digo del proyecto, lo que aumenta su confiabilidad desde el punto de vista de evitar el desbordamiento de la pila (por ejemplo, la prohibici√≥n de interrupciones anidadas o llamadas a funciones por punteros), y espec√≠ficamente el uso de stacks ayuda con la optimizaci√≥n del c√≥digo en sistemas con falta de RAM. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/443544/">https://habr.com/ru/post/443544/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443528/index.html">Amazon lanz√≥ Open Distro para Elasticsearch</a></li>
<li><a href="../443530/index.html">Evoluci√≥n de la infraestructura de la base de datos: de la base de datos y la aplicaci√≥n en un servidor a la replicaci√≥n de transmisi√≥n</a></li>
<li><a href="../443532/index.html">5 caracter√≠sticas de los polvos met√°licos para impresi√≥n 3D</a></li>
<li><a href="../443534/index.html">Compute Express Link - Interconexi√≥n para Big Data</a></li>
<li><a href="../443542/index.html">Punto de verificaci√≥n gratuito Introducci√≥n R80.20 Curso gratuito</a></li>
<li><a href="../443546/index.html">Toyota y JAXA planean tener un rover tripulado en la luna en 2029</a></li>
<li><a href="../443548/index.html">Psicolog√≠a del consumidor moderno o qu√© nos ayuda a tomar una decisi√≥n de compra.</a></li>
<li><a href="../443556/index.html">Fecha l√≠mite ardiente: c√≥mo el gerente de proyecto no puede perderse</a></li>
<li><a href="../443566/index.html">Firefox Send: un servicio gratuito para compartir archivos cifrados</a></li>
<li><a href="../443568/index.html">Biograf√≠a de Terry Davis, "el mejor programador que jam√°s haya existido"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>