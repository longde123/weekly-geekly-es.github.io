<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤒 🎈 ◾️ 关于RTOS的全部真相。 第21条。 邮箱：简介和基本服务 👩🏼‍🤝‍👨🏾 👝 👨🏾‍🤝‍👨🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="以前的一篇文章（第5章）中提到了邮箱。 它们是Nucleus SE支持的第二种最简单的信号间任务通信方法，并提供了一种低成本且灵活的方式来在任务之间传输简单消息。 

 该系列中的先前文章： 
 第20条 信号量：辅助服务和数据结构 
 第十九条 信号灯：简介和基本服务 
 第十八条 事件标志组：助...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>关于RTOS的全部真相。 第21条。 邮箱：简介和基本服务</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430856/"><img src="https://habrastorage.org/webt/pj/yd/r0/pjydr0sj2zrtqop5hhxum0q2vki.jpeg"><br><br> 以前的一篇文章（第5章）中提到了邮箱。 它们是Nucleus SE支持的第二种最简单的信号间任务通信方法，并提供了一种低成本且灵活的方式来在任务之间传输简单消息。 <br><a name="habracut"></a><br> 该系列中的先前文章： <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第20条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信号量：辅助服务和数据结构</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十九条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信号灯：简介和基本服务</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十八条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">事件标志组：助手服务和数据结构</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十七条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">事件标志组：简介和基本服务</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十六条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">讯号</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十五条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内存分区：服务和数据结构</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十四条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">内存部分：简介和基本服务</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十三条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务数据结构和不受支持的API调用</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第十二条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务处理服务</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第11条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务：API的配置和介绍</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第10条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">计划程序：高级功能和上下文保留</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第9条。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">调度程序：实施</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第8条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nucleus SE：内部设计和部署</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第7条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nucleus SE：简介</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第6条。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">其他RTOS服务</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第5条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务交互和同步</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第4条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务，上下文切换和中断</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">任务与计划</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2条。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RTOS：结构和实时模式</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><br></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1条</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RTOS：简介。</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><br></a> <br><h2> 使用邮箱 </h2><br> 在Nucleus SE中，邮箱是在构建阶段定义的。 一个应用程序最多可以有16个邮箱。 如果应用程序没有邮箱，则与邮箱关联的服务呼叫代码和数据结构将不包括在应用程序中。 <br><br> 邮箱只是一个存储数据的地方，其大小足以存储<b>ADDR</b>类型的变量，并以几种任务可以使用它的方式来控制对其的安全访问。 任务可以将数据发送到邮箱。 结果，邮箱将变满，并且在任何任务执行读取邮箱的操作或邮箱为空之前，没有任务将无法向其发送数据。 尝试将数据发送到完整邮箱或尝试读取空邮箱将导致错误或任务暂停，具体取决于所选的API调用设置和Nucleus SE配置。 <br><br><h2> 邮箱和队列 </h2><br> 在OS的某些实现中，没有实现邮箱，但是作为替代方案，建议使用队列。 这听起来合乎逻辑，因为这样的队列将提供与邮箱相同的功能。 但是，队列是一个更复杂的数据结构，并承载更多的辅助数据，代码，并具有更长的服务时间。 <br><br> 在Nucleus SE中，就像在Nucleus RTOS中一样，您可以选择任何这些类型的对象。 <br> 如果您的应用程序有多个队列和一个邮箱，则考虑用队列替换邮箱是有意义的。 这将稍微增加开销，但是将摆脱与邮箱关联的所有API代码。 或者，您可以使用这两种方法配置应用程序，并比较数据量和性能。 <br><br> 队列将在以后的文章中讨论。 <br><br><h2> 配置邮箱 </h2><br><h3> 邮箱数 </h3><br> 与大多数Nucleus SE对象一样，邮箱配置主要由<b>nuse_config.h</b>文件中的<b>#define</b>指令指定。 主要参数是<b>NUSE_MAILBOX_NUMBER</b> ，它确定应用程序中的邮箱数。 默认值为零（即没有邮箱），最多可以接受16个值。不正确的值将导致编译期间出错，这将通过检入<b>nuse_config_check.h</b>生成（它包含在文件<b>nuse_config.c中</b>并随其<b>一起</b>编译） ），这将触发<b>#error</b>指令。 <br><br> 选择非零值是邮箱的主要激活器。 定义数据结构时使用此参数，其大小取决于其值（在下一篇文章中将对此进行更多说明）。 此外，非零值会激活API设置。 <br><br><h3> 激活API调用 </h3><br>  Nucleus SE中的每个API函数（实用程序调用） <b>都由nuse_config.h</b>文件中的<b>#define</b>指令激活。 对于邮箱，这些指令是： <br><br><pre><code class="plaintext hljs">NUSE_MAILBOX_SEND NUSE_MAILBOX_RECEIVE NUSE_MAILBOX_RESET NUSE_MAILBOX_INFORMATION NUSE_MAILBOX_COUNT</code> </pre> <br> 默认情况下，它们设置为<b>FALSE</b> ，从而禁用所有服务调用并阻止包含实现它们的代码。 要在应用程序中配置邮箱，您需要选择必要的API调用并将其设置为<b>TRUE</b> 。 <br><br> 以下是<b>nuse_config.h</b>文件中的代码部分。 <br><br><pre> <code class="plaintext hljs">/* Number of mailboxes in the system - 0-16 */ #define NUSE_MAILBOX_NUMBER 0 /* Service call enablers: */ #define NUSE_MAILBOX_SEND FALSE #define NUSE_MAILBOX_RECEIVE FALSE #define NUSE_MAILBOX_RESET FALSE #define NUSE_MAILBOX_INFORMATION FALSE #define NUSE_MAILBOX_COUNT FALSE</code> </pre><br> 如果邮箱API功能已激活，并且应用程序中没有邮箱（始终启用<b>NUSE_Mailbox_Count（）</b>除外），则会发生编译错误。 如果您的代码使用尚未激活的API调用，则会发生布局错误，因为实现代码未包含在应用程序中。 <br><br><h2> 邮箱服务电话 </h2><br>  Nucleus RTOS支持与邮箱关联的九个服务调用，并提供以下功能： <br><br><ul><li> 将消息发送到邮箱。  Nucleus SE在<b>NUSE_Mailbox_Send（）</b>函数中实现。 </li><li> 从邮箱中读取邮件。  Nucleus SE实现了<b>NUSE_Mailbox_Receive（）</b>函数。 </li><li> 通过释放所有挂起的任务（重置）将邮箱还原到未使用状态。 在Nucleus SE中，在<b>NUSE_Mailbox_Reset（）中实现</b> 。 </li><li> 提供有关特定邮箱的信息。  Nucleus SE在<b>NUSE_Mailbox_Information（）中实现</b> 。 </li><li> 返回当前在应用程序中配置的邮箱数。 在Nucleus SE中，在<b>NUSE_Mailbox_Count（）中实现</b> 。 </li><li> 添加一个新邮箱（创建）。 未实施Nucleus SE。 </li><li> 删除邮箱。 未实施Nucleus SE。 </li><li> 返回指向应用程序中所有邮箱的指针。 未实施Nucleus SE。 </li><li> 向邮箱中暂停的所有任务发送消息（广播）。 未实施Nucleus SE。 </li></ul><br> 详细考虑每个服务调用的实现。 <br><br><h2> 邮箱读写服务呼叫 </h2><br> 邮箱上可以执行的基本操作是写入和读取数据（发送和接收）。  Nucleus RTOS和Nucleus SE为这些操作提供了两个基本的API调用，下面将对其进行介绍。 <br><br><h3> 写信箱 </h3><br> 调用Nucleus RTOS API来写入邮箱非常灵活，如果您无法立即完成操作（例如，当您尝试写入完整的邮箱时），则可以隐式或超时地暂停任务。  Nucleus SE提供了类似的服务调用，仅任务暂停是可选的，并且未实现超时。 <br><br>  Nucleus RTOS还提供了将数据广播到邮箱的服务调用； Nucleus SE不支持此调用，将在下一篇文章的“未实现的API调用”部分中进行描述。 <br><br>  <b><i>调用以写入Nucleus RTOS中的邮箱</i></b> <br> 服务电话原型： <br>  <b>状态NU_Send_To_Mailbox（NU_MAILBOX *邮箱，VOID *消息，未签名挂起）;</b> <br><br> 参数： <br>  <b>邮箱</b> -指向<b>邮箱的</b>指针; <br>  <b>message-</b>指向要发送的消息的指针，由四个<b>unsigned</b>类型的元素组成； <br>  <b>暂停</b> -任务<b>暂停</b>的规范，可以采用值<b>NU_NO_SUSPEND</b> ， <b>NU_SUSPEND</b>或超时值。 <br><br> 返回值： <br>  <b>NU_SUCCESS-</b>调用成功完成； <br>  <b>NU_INVALID_MAILBOX-</b>无效的邮箱指针； <br>  <b>NU_INVALID_POINTER-</b>消息的空指针（ <b>NULL</b> ）； <br>  <b>NU_INVALID_SUSPEND-</b>尝试从与任务无关的线程挂起； <br>  <b>NU_MAILBOX_FULL-</b>邮箱已满，但未指定挂起类型； <br>  <b>NU_TIMEOUT-</b>邮箱仍然满，即使在指定时间段内挂起也是如此； <br>  <b>NU_MAILBOX_DELETED-</b>任务挂起时邮箱已删除； <br>  <b>NU_MAILBOX_WAS_RESET-</b>挂起任务时重置邮箱。 <br><br>  <b><i>调用以写入Nucleus SE中的邮箱</i></b> <br> 该API调用支持Nucleus RTOS API的核心功能。 <br><br> 服务电话原型： <br>  <b>状态NUSE_Mailbox_Send（NUSE_MAILBOX邮箱，ADDR *消息，U8挂起）；</b> <br><br> 参数： <br>  <b>邮箱</b> - <b>邮箱</b>索引（ID）; <br>  <b>message-</b>指向要发送的消息的指针；它是<b>ADDR</b>类型的一个变量； <br>  <b>挂起</b> -任务<b>挂起的</b>规范，可以采用值<b>NUSE_NO_SUSPEND</b>或<b>NUSE_SUSPEND</b> 。 <br><br> 返回值： <br>  <b>NUSE_SUCCESS-</b>呼叫已成功完成； <br>  <b>NUSE_INVALID_MAILBOX-</b>无效的邮箱索引； <br>  <b>NUSE_INVALID_POINTER-</b>消息的空指针（ <b>NULL</b> ）; <br>  <b>NUSE_INVALID_SUSPEND-</b>尝试从不相关的线程挂起或停用API调用阻止功能； <br>  <b>NUSE_MAILBOX_FULL-</b>邮箱已满，但未指定挂起类型； <br>  <b>NUSE_MAILBOX_WAS_RESET-</b>在挂起任务时重置了邮箱。 <br><br>  <b><i>在Nucleus SE中实现邮箱条目</i></b> <br> 使用条件编译选择API函数代码<b>NUSE_Mailbox_Send（）的版本</b> （检查参数之后），具体取决于是否激活了对API调用的支持以阻止（暂停任务）。 考虑这两种选择。 <br><br> 如果禁用了任务锁定，则此API调用的逻辑非常简单，并且代码无需任何解释： <br><br><pre> <code class="plaintext hljs">if (NUSE_Mailbox_Status[mailbox]) /* mailbox full */ { return_value = NUSE_MAILBOX_FULL; } else /* mailbox empty */ { NUSE_Mailbox_Data[mailbox] = *message; NUSE_Mailbox_Status[mailbox] = TRUE; return_value = NUSE_SUCCESS; }</code> </pre><br> 该消息存储在相应的元素<b>NUSE_Mailbox_Data []中</b> ，并且该邮箱被标记为已使用。 <br><br> 如果激活了任务锁定，则代码将变得更加复杂： <br><br><pre> <code class="plaintext hljs">do { if (!NUSE_Mailbox_Status[mailbox]) /* mailbox empty */ { NUSE_Mailbox_Data[mailbox] = *message; NUSE_Mailbox_Status[mailbox] = TRUE; if (NUSE_Mailbox_Blocking_Count[mailbox] != 0) { U8 index; /* check whether a task is blocked */ /* on this mailbox */ NUSE_Mailbox_Blocking_Count[mailbox]--; for (index=0; index&lt;NUSE_TASK_NUMBER; index++) { if ((LONIB(NUSE_Task_Status[index]) == NUSE_MAILBOX_SUSPEND) &amp;&amp; (HINIB(NUSE_Task_Status[index]) == mailbox)) { NUSE_Task_Blocking_Return[index] = NUSE_SUCCESS; NUSE_Wake_Task(index); break; } } } return_value = NUSE_SUCCESS; suspend = NUSE_NO_SUSPEND; } else /* mailbox full */ { if (suspend == NUSE_NO_SUSPEND) { return_value = NUSE_MAILBOX_FULL; } else { /* block task */ NUSE_Mailbox_Blocking_Count[mailbox]++; NUSE_Suspend_Task(NUSE_Task_Active, (mailbox &lt;&lt; 4) | NUSE_MAILBOX_SUSPEND); return_value = NUSE_Task_Blocking_Return[NUSE_Task_Active]; if (return_value != NUSE_SUCCESS) { suspend = NUSE_NO_SUSPEND; } } } } while (suspend == NUSE_SUSPEND);</code> </pre><br> 一些解释可能会有所帮助。 <br><br> 该代码包含在<b>do ... while循环中</b> ，该<b>循环</b>在<b>suspend</b>参数为<b>NUSE_SUSPEND时运行</b> 。 <br><br> 如果邮箱为空，则会记录该消息，并且邮箱的状态将更改为指示已满。 检查此邮箱上是否有暂停的任务（正在等待读取）。 如果存在此类任务，则将恢复第一个任务。 暂<b>挂</b>变量设置为<b>NUSE_NO_SUSPEND</b> ，API调用终止并返回<b>NUSE_SUCCESS</b> 。 <br><br> 如果邮箱已满，并且挂起是<b>NUSE_NO_SUSPEND</b> ，则API调用将返回<b>NUSE_MAILBOX_FULL</b> 。 如果暂停为<b>NUSE_SUSPEND</b> ，则任务暂停。 函数完成后（例如，当任务恢复时），如果返回值为<b>NUSE_SUCCESS</b> （表示由于已读取消息而恢复了任务，而不是邮箱已重置），则循环从头开始。 <br><br><h3> 阅读邮箱 </h3><br> 用于读取邮箱的Nucleus RTOS API实用程序调用非常灵活，如果无法立即完成操作（例如，从空邮箱中读取），则可以隐式或超时地暂停任务。  Nucleus SE提供了类似的服务，仅任务挂起是可选的，并且未实现超时。 <br><br>  <b><i>调用以在Nucleus RTOS中读取邮箱</i></b> <br> 服务电话原型： <br>  <b>状态NU_Receive_From_Mailbox（NU_MAILBOX *邮箱，VOID *消息，未签名挂起）;</b> <br><br> 参数： <br>  <b>邮箱</b> -指向用户提供的邮箱控制单元的指针； <br>  <b>message-</b>指向接收到的消息的存储器的指针，其大小等于四个<b>unsigned</b>类型的变量； <br>  <b>挂起</b> -任务挂起规范，可以采用值<b>NUSE_NO_SUSPEND</b> ， <b>NUSE_SUSPEND</b>或超时值。 <br><br> 返回值： <br>  <b>NU_SUCCESS-</b>调用成功完成； <br>  <b>NU_INVALID_MAILBOX-</b>无效的邮箱指针； <br>  <b>NU_INVALID_POINTER-</b>消息的空指针（ <b>NULL</b> ）； <br>  <b>NU_INVALID_SUSPEND-</b>尝试从不正确的流中挂起（与该流的任务无关）； <br>  <b>NU_MAILBOX_EMPTY-</b>邮箱为空，未指定挂起类型； <br>  <b>NU_TIMEOUT-</b>邮箱仍然为空，即使在任务暂停了指定的超时值之后也是如此； <br>  <b>NU_MAILBOX_DELETED-</b>任务挂起时邮箱已删除； <br>  <b>NU_MAILBOX_WAS_RESET-</b>挂起任务时重置邮箱。 <br><br>  <b><i>致电阅读Nucleus SE中的邮箱</i></b> <br> 该API调用支持Nucleus RTOS API的核心功能。 <br><br> 服务电话原型： <br>  <b>状态NUSE_Mailbox_Receive（NUSE_MAILBOX邮箱，ADDR *消息，U8挂起）；</b> <br><br> 参数： <br>  <b>邮箱</b> - <b>邮箱</b>索引（ID）; <br>  <b>message-</b>指向存储收到的消息的指针，是<b>ADDR</b>类型的一个变量； <br>  <b>挂起</b> -任务<b>挂起的</b>规范，可以采用值<b>NUSE_NO_SUSPEND</b>或<b>NUSE_SUSPEND</b> 。 <br><br> 返回值： <br>  <b>NUSE_SUCCESS-</b>呼叫已成功完成； <br>  <b>NUSE_INVALID_MAILBOX-</b>无效的邮箱索引； <br>  <b>NUSE_INDALID_POINTER-</b>消息的空指针（ <b>NULL</b> ）; <br>  <b>NUSE_INVALID_SUSPEND-</b>尝试从不正确的流中挂起，或者在禁用API调用以阻止任务时挂起； <br>  <b>NUSE_MAILBOX_EMPTY-</b>邮箱为空，并且未指定任务挂起的类型； <br>  <b>NUSE_MAILBOX_WAS_RESET-</b>在挂起任务时重置了邮箱。 <br><br>  <b><i>在Nucleus SE中实现邮箱阅读器</i></b> <br> 使用条件编译来选择API功能代码<b>NUSE_Mailbox_Receive（）的版本</b> （检查参数之后），具体取决于是否激活了API调用以进行阻塞（挂起任务）。 我们将考虑这两种选择。 <br><br> 如果禁用了任务锁定，则此API调用的逻辑非常简单，并且代码无需任何解释： <br><br><pre> <code class="plaintext hljs">if (!NUSE_Mailbox_Status[mailbox]) /* mailbox empty */ { return_value = NUSE_MAILBOX_EMPTY; } else { /* mailbox full */ *message = NUSE_Mailbox_Data[mailbox]; NUSE_Mailbox_Status[mailbox] = FALSE; return_value = NUSE_SUCCESS; }</code> </pre><br> 从相应的<b>NUSE_Mailbox_Data []</b>元素读取该消息，并且该邮箱被标记为空。 <br><br> 如果激活了任务锁定，则代码将变得更加复杂： <br><br><pre> <code class="plaintext hljs">do { if (NUSE_Mailbox_Status[mailbox]) /* mailbox full */ { *message = NUSE_Mailbox_Data[mailbox]; NUSE_Mailbox_Status[mailbox] = FALSE; if (NUSE_Mailbox_Blocking_Count[mailbox] != 0) { U8 index; /* check whether a task is blocked */ /* on this mailbox */ NUSE_Mailbox_Blocking_Count[mailbox]--; for (index=0; index&lt;NUSE_TASK_NUMBER; index++) { if ((LONIB(NUSE_Task_Status[index]) == NUSE_MAILBOX_SUSPEND) &amp;&amp; (HINIB(NUSE_Task_Status[index]) == mailbox)) { NUSE_Task_Blocking_Return[index] = NUSE_SUCCESS; NUSE_Wake_Task(index); break; } } } return_value = NUSE_SUCCESS; suspend = NUSE_NO_SUSPEND; } else /* mailbox empty */ { if (suspend == NUSE_NO_SUSPEND) { return_value = NUSE_MAILBOX_EMPTY; } else { /* block task */ NUSE_Mailbox_Blocking_Count[mailbox]++; NUSE_Suspend_Task(NUSE_Task_Active, (mailbox &lt;&lt; 4) | NUSE_MAILBOX_SUSPEND); return_value = NUSE_Task_Blocking_Return[NUSE_Task_Active]; if (return_value != NUSE_SUCCESS) { suspend = NUSE_NO_SUSPEND; } } } } while (suspend == NUSE_SUSPEND);</code> </pre><br> 一些澄清可能会有所帮助。 <br><br> 该代码包含在<b>do ... while循环中</b> ，该<b>循环</b>在<b>suspend</b>参数为<b>NUSE_SUSPEND时运行</b> 。 <br><br> 如果邮箱已满，则将返回存储的消息，并且邮箱的状态将更改为指示它为空。 检查此邮箱上是否有暂停的任务（正在等待记录）。 如果存在此类任务，则将恢复第一个任务。 暂<b>挂</b>变量设置为<b>NUSE_NO_SUSPEND</b> ，API调用终止并返回<b>NUSE_SUCCESS</b> 。 <br><br> 如果邮箱为空，并且<b>suspend</b>参数为<b>NUSE_NO_SUSPEND</b> ，则API调用将返回<b>NUSE_MAILBOX_EMPTY</b> 。 如果暂停为<b>NUSE_SUSPEND</b> ，则任务暂停。 如果在调用结束时返回值为<b>NUSE_SUCCESS</b> ，这表明由于已发送消息而恢复了任务（而不是邮箱已重置），则循环从头开始。 <br><br> 下面的文章将查看与邮箱关联的其他API调用以及相应的数据结构。 <br><br>  <b>关于作者：</b> Colin Walls在电子行业工作了30多年，大部分时间用于固件。 他现在是Mentor Embedded（Mentor Graphics的一个部门）的固件工程师。  Colin Walls经常在会议和研讨会上发表演讲，他撰写了许多技术文章并撰写了两本有关固件的书。 居住在英国。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Colin的</a>专业<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">博客</a> ，电子邮件：colin_walls@mentor.com。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN430856/">https://habr.com/ru/post/zh-CN430856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN430844/index.html">如何为UPS选择电池</a></li>
<li><a href="../zh-CN430846/index.html">新增功能：有关新Zen 2架构实施的详细信息已广为人知</a></li>
<li><a href="../zh-CN430850/index.html">MAPS.ME上的Apple Metal</a></li>
<li><a href="../zh-CN430852/index.html">分布式存储系统中的一致性和ACID保证</a></li>
<li><a href="../zh-CN430854/index.html">“ JS越来越成熟”：HolyJS 2018莫斯科计划委员会专访</a></li>
<li><a href="../zh-CN430860/index.html">在Swift中下载，保存和查看PDF</a></li>
<li><a href="../zh-CN430862/index.html">“游戏中的怪物-如何让玩家讨厌你”</a></li>
<li><a href="../zh-CN430864/index.html">火柴不是玩具吗？</a></li>
<li><a href="../zh-CN430866/index.html">北京将在2020年为居民引入社会评级</a></li>
<li><a href="../zh-CN430868/index.html">购买NGFW时要记住什么？ 检查清单</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>