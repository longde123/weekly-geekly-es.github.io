<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüé® üëàüèø ü•ë Load Balancer f√ºr Orchestrierungssysteme ‚öúÔ∏è üÜé ü•¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Load Balancer in Orchestrierungssystemen (Kubernetes, Nomad und andere) stellen mehr Anforderungen als nur den Load Balancing. Erstens sollte der Load...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Load Balancer f√ºr Orchestrierungssysteme</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441534/"> Load Balancer in Orchestrierungssystemen (Kubernetes, Nomad und andere) stellen mehr Anforderungen als nur den Load Balancing.  Erstens sollte der Load Balancer in der Lage sein, ein Verzeichnis mit einer Liste von Diensten zu lesen, zu denen der Datenverkehr umgeleitet werden soll (oder optional die Registrierung von Diensten zu erm√∂glichen, um sie in den Datenverkehr aufzunehmen).  Zweitens machen Sie es dynamisch, weil  Orchestrierungssysteme k√∂nnen die Anzahl der Dienstreplikate jederzeit erh√∂hen oder verringern oder an andere Adressen im Netzwerk verschieben.  Und drittens, ohne den Verkehr zu stoppen. <br><br>  Im heutigen Beitrag werde ich die Arbeit mit zwei Load Balancern beschreiben - Traefik und HAProxy.  Diese Load Balancer k√∂nnen mit einer beeindruckenden Liste von Orchestrierungswerkzeugen arbeiten.  In den Beispielen wird beschrieben, wie Sie mit dem Nomad-Orchestrierungssystem arbeiten. <br><a name="habracut"></a><br>  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">letzten Beitrag habe</a> ich bereits ein Beispiel f√ºr Load Balancers gegeben - Fabio.  Seine Einschr√§nkungen: Funktioniert nur mit http / https-Protokollen und nur mit Consul.  Im Gegensatz zu Fabio arbeitet Load Balancers Traefik mit einer beeindruckenden Anzahl verschiedener Systeme.  Hier ist eine unvollst√§ndige Liste von der Entwicklerseite: Docker, Schwarmmodus, Kubernetes, Marathon, Konsul, usw., Rancher, Amazon ECS, ... <br><br>  Ich werde das Beispiel aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Beitrag fortsetzen</a> , in dem mehrere Replikate des Django-Dienstes erstellt wurden. <br><br>  Traefik kann von der Entwicklerseite als ausf√ºhrbare Datei f√ºr die g√§ngigsten Betriebssysteme heruntergeladen werden.  Um sich in Nomad (tats√§chlich in Consul) zu integrieren, m√ºssen Sie eine Konfigurationsdatei erstellen: <br><br><pre><code class="plaintext hljs">[entryPoints] [entryPoints.http] address = ":5001" [web] address = ":8080" [consulCatalog] endpoint = "127.0.0.1:8500" domain = "consul.localhost" exposedByDefault = false prefix = "traefik"</code> </pre> <br>  F√ºhren Sie dann den Befehl mit der angegebenen Konfigurationsdatei aus: <br><br><pre> <code class="plaintext hljs">traefik -c nomad/traefik.toml</code> </pre> <br>  Danach wird UI Traefik auf Port 8080 verf√ºgbar sein, der noch keine Dienste ver√∂ffentlicht hat.  Es gibt verschiedene M√∂glichkeiten, Dienste zu ver√∂ffentlichen, die letztendlich dasselbe tun: Sie laden Schl√ºssel- / Wertdaten in das Traefik-System.  Wir werden die Gelegenheit nutzen, Schl√ºssel / Wert-Paare √ºber Service-Tags festzulegen.  Erweitern wir die Konfigurationsdatei des Django-Dienstes mit dem Parameter tags: <br><br><pre> <code class="plaintext hljs">job "django-job" { datacenters = ["dc1"] type = "service" group "django-group" { count = 3 restart { attempts = 2 interval = "30m" delay = "15s" mode = "fail" } ephemeral_disk { size = 300 } task "django-job" { driver = "docker" config { image = "apapacy/tut-django:1.0.1" port_map { lb = 8000 } } resources { network { mbits = 10 port "lb" {} } } service { name = "django" tags = [ "traefik.enable=true", "traefik.frontend.entryPoints=http", "traefik.frontend.rule=Host:localhost;PathStrip:/test", "traefik.tags=exposed" ] port = "lb" check { name = "alive" type = "http" path = "/" interval = "10s" timeout = "2s" } } } } }</code> </pre><br>  In diesem Beispiel wird der Dienst auf dem localhost-Host ver√∂ffentlicht und auf der / test-Route bereitgestellt.  Traefik hat ein flexibles und vollst√§ndiges Regelsystem f√ºr die Konfiguration von Routen entwickelt, einschlie√ülich der Arbeit mit regul√§ren Ausdr√ºcken.  Die Liste der Parameter f√ºr die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Regeln</a> in der Entwicklerdokumentation. <br><br>  Nach dem Ausf√ºhren des <code>nomad job run nomad/django.conf</code> Regeln angewendet und der Datenverkehr vom Load Balancer wird an den Dienst geleitet.  Dementsprechend k√∂nnen Sie diese Parameter √§ndern, eine neue <code>nomad job run nomad/django.conf</code> , und alle √Ñnderungen werden ohne st√∂renden Verkehrsstopp angewendet. <br><br>  Der Nachteil von Traefik ist, dass es mit den Protokollen der http / https-Familie funktioniert (nur f√ºr den Fall, dass diese Familie auch Web-Sockets enth√§lt).  Dennoch besteht die M√∂glichkeit, dass mit anderen Protokollen gearbeitet werden muss.  Fahren wir also mit der n√§chsten umfassenderen L√∂sung fort, die auf HAProxy basiert.  Vor einiger Zeit hatte HAProxy Probleme mit dem Softloading, was die Verwendung mit Orchestrierungssystemen erschwerte (w√§hrend des Neustarts musste die Bewegung von Paketen auf Netzwerkebene gestoppt werden).  Das ist jetzt kein Problem mehr. <br><br>  Zuerst m√ºssen Sie Haproxy auf Ihrem Computer installieren.  Hier funktioniert die Option zur Installation im Container nicht.  In Haproxy war es erst k√ºrzlich m√∂glich, den Prozess im "Soft" -Modus neu zu starten, aber der Docker-Container stoppt immer noch, da der zweite Prozess tats√§chlich mit Haproxy beginnt. Er √§ndert sich nur im Standby-Modus - was mit dem Docker und seinem Prinzip "Eins" nicht funktioniert -container ist ein Prozess. " <br><br>  Damit Haproxy funktioniert, m√ºssen Sie √ºber eine Konfigurationsdatei verf√ºgen, die die erforderlichen Regeln enth√§lt.  Nomad (tats√§chlich in Consul) verwendet ein Vorlagensystem, das Konfigurationen generieren kann: <br><br><pre> <code class="plaintext hljs">global debug defaults log global mode http option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend http_front bind *:5001 stats uri /haproxy?stats default_backend http_back backend http_back balance roundrobin{{range service "django"}} server {{.Node}} {{.Address}}:{{.Port}} check{{end}}</code> </pre><br>  Das Schl√ºsselwort <code>range</code> in diesem Fall als Iterator.  F√ºr die drei "Django" -Dienste wird die folgende Konfigurationsdatei generiert: <br><br><pre> <code class="plaintext hljs">global debug defaults log global mode http option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend http_front bind *:5001 stats uri /haproxy?stats default_backend http_back backend http_back balance roundrobin server 228.195.86.224 127.0.0.1:21469 check server 228.195.86.224 127.0.0.1:25872 check server 228.195.86.224 127.0.0.1:25865 check</code> </pre><br>  Die Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/hashicorp/consul-template</a> wird verwendet, um den Generierungsprozess gem√§√ü der Vorlage im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">laufenden Betrieb</a> zu starten.  Aus der Ressource des Entwicklers k√∂nnen Sie die ausf√ºhrbare Datei f√ºr alle g√§ngigen Betriebssysteme herunterladen und den Vorgang im Auftrag eines nicht autorisierten Benutzers mit dem folgenden Befehl starten: <br><br><pre> <code class="plaintext hljs">consul-template -template="haproxy/haproxy.cfg.tmpl:haproxy/haproxy.cfg:./haproxy/haproxy.reload.sh"</code> </pre><br>  Der Parameter <code>-template</code> enth√§lt durch Doppelpunkte getrennte Parameter 1) den Namen der Vorlage, 2) den Namen der resultierenden Konfigurationsdatei 3) den Befehl, der ausgef√ºhrt wird, nachdem die Datei generiert wurde.  Die Datei wird automatisch generiert, wenn die in der Vorlage enthaltenen Variablen ge√§ndert werden (z. B. wird die Anzahl der Replikate des Django-Dienstes ge√§ndert). <br><br>  Nach dem Starten der Template-Engine, die die erste Konfiguration generiert, k√∂nnen Sie haproxy ausf√ºhren: <br><br><pre> <code class="plaintext hljs">haproxy -D -f haproxy/haproxy.cfg -p `pwd`/haproxy.pid</code> </pre><br>  Wir geben die PID-Datei explizit an, um ein Signal an die "weiche" Haproxy-√úberladung senden zu k√∂nnen: <br><br><pre> <code class="plaintext hljs">haproxy -D -f ./haproxy/haproxy.cfg -p `pwd`/haproxy.pid -sf $(cat `pwd`/haproxy.pid)</code> </pre><br>  In diesem Beispiel wird der Dienst auf Port 5001 ver√∂ffentlicht. Auf demselben Port k√∂nnen Sie die Statistiken von Haproxy selbst unter der Adresse <code>/haproxy?stats</code> . <br><br>  AKTUALISIERT 24.02.2019 22:43 Uhr <br><br>  Laut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem</a> Kommentar von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@ usego</a> wurde der Betrieb von Haproxy im Docker-Container zus√§tzlich verfeinert, insbesondere gem√§√ü dem Fragment aus der Dokumentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/neo4j/docker-library-docs/tree/master/haproxy#reloading-config</a> <br><br><blockquote>  Konfiguration neu laden <br><br>  Wenn Sie einen Bind-Mount f√ºr die Konfiguration verwendet und Ihre Datei haproxy.cfg bearbeitet haben, k√∂nnen Sie die ordnungsgem√§√üe Neuladefunktion von HAProxy verwenden, indem Sie ein SIGHUP an den Container senden: <br><br>  $ docker kill -s HUP my-running-haproxy <br><br>  Das Entrypoint-Skript im Image pr√ºft, ob der Befehl haproxy ausgef√ºhrt wird, und ersetzt ihn durch den haproxy-systemd-wrapper von HAProxy upstream, der sich um die Signalverarbeitung k√ºmmert, um das ordnungsgem√§√üe Neuladen durchzuf√ºhren.  Unter der Haube wird die Option -sf von Haproxy verwendet, sodass "zwei kleine Fenster mit einer L√§nge von jeweils einigen Millisekunden vorhanden sind, in denen bei hohen Lasten m√∂glicherweise einige Verbindungsfehler auftreten" (siehe Stoppen und Neustarten von HAProxy). <br></blockquote><br><br>  Bei diesem Ansatz wird die Konfiguration wirklich neu geladen, jedoch aufgrund einer Unterbrechung des aktuellen Prozesses.  Und dies bedeutet, dass die Dienste zwar sehr unbedeutend sind, aber dennoch eine Zeit der Unzug√§nglichkeit aufweisen und einige Kunden m√∂glicherweise eine Fehlermeldung beobachten.  Manchmal ist dies jedoch nicht das Hauptauswahlkriterium.  Daher werde ich zus√§tzlich die Konfiguration docker-compose.yml zum Starten von Haproxy in Docker angeben: <br><br><pre> <code class="plaintext hljs">version: '3' services: haproxy_lb: image: haproxy volumes: - ./haproxy:/usr/local/etc/haproxy network_mode: host</code> </pre><br><br>  Der Befehl, der die Haproxy-Konfiguration √ºberlastet, √§ndert sich ebenfalls: <br><br><pre> <code class="plaintext hljs">consul-template -template="haproxy/haproxy.cfg.tmpl:haproxy/haproxy.cfg:docker kill -s HUP $(docker-compose ps -q haproxy_lb)"</code> </pre><br><br>  Zu den Vorteilen dieser Implementierung geh√∂rt die M√∂glichkeit, ohne die Installation von Haproxy zu arbeiten. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispielcode ist im Repository verf√ºgbar.</a> <br><br>  N√ºtzliche Links: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">1. www.haproxy.com/blog/haproxy-and-consul-with-dns-for-service-discovery</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2.m.mattmclaugh.com/traefik-and-consul-catalog-example-2c33fc1480c0</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3. www.hashicorp.com/blog/load-balancing-strategies-for-consul</a> <br><br>  apapacy@gmail.com <br>  24. Februar 2019 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de441534/">https://habr.com/ru/post/de441534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de441524/index.html">Neue Studienergebnisse: Knochenmarktransplantation kann das Altern verlangsamen</a></li>
<li><a href="../de441526/index.html">Faktoren des Bitcoin-Wertes</a></li>
<li><a href="../de441528/index.html">Wie aus meinem Leben ein Kafka-Buch wurde</a></li>
<li><a href="../de441530/index.html">SDN wird ins All gebracht: Warum wird das ben√∂tigt?</a></li>
<li><a href="../de441532/index.html">Fledermausfisch Einf√ºhrung</a></li>
<li><a href="../de441536/index.html">Sorten von SIMD</a></li>
<li><a href="../de441538/index.html">Data Warehouse-Architektur: Traditionell und Cloud</a></li>
<li><a href="../de441540/index.html">Vue-Mixins auf explizite Weise (anhand eines Beispiels f√ºr ein BEM-Modifikator-Plugin)</a></li>
<li><a href="../de441546/index.html">Hayabusa-2 "ber√ºhrte zuerst den Asteroiden</a></li>
<li><a href="../de441550/index.html">Das Leben eines einfachen Programmierers ist hart und klar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>