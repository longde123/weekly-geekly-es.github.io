<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèº üë©‚Äçüöí ü§ù Configuration d'un serveur pour d√©ployer une application Rails √† l'aide d'Ansible ‚õëÔ∏è üêº üôÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il n'y a pas si longtemps, j'avais besoin d'√©crire des playbooks ansibles pour pr√©parer le serveur au d√©ploiement de l'application rails. Et, √©tonnamm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configuration d'un serveur pour d√©ployer une application Rails √† l'aide d'Ansible</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460769/"><p>  Il n'y a pas si longtemps, j'avais besoin d'√©crire des playbooks ansibles pour pr√©parer le serveur au d√©ploiement de l'application rails.  Et, √©tonnamment, je n'ai pas trouv√© de manuel pas √† pas simple.  Je ne voulais pas copier le livre de jeu de quelqu'un d'autre sans comprendre ce qui se passait et, par cons√©quent, j'ai d√ª lire la documentation, rassemblant tout moi-m√™me.  Peut-√™tre que quelqu'un que je peux aider √† acc√©l√©rer ce processus avec cet article. </p><br><p>  La premi√®re chose √† comprendre est qu'ansible vous fournit une interface pratique pour effectuer une liste pr√©d√©finie d'actions sur le ou les serveurs distants via SSH.  Il n'y a pas de magie ici, vous ne pouvez pas installer le plugin et sortir de la bo√Æte z√©ro temps d'arr√™t un d√©ploiement de votre application avec docker, surveillance et autres goodies.  Pour √©crire un livre de jeu, vous devez savoir exactement ce que vous voulez faire et comment le faire.  Par cons√©quent, je n'aime pas les playbooks pr√™ts √† l'emploi du github, ni les articles comme: "Copiez et ex√©cutez, cela fonctionnera." </p><a name="habracut"></a><br><h2 id="chto-nam-nuzhno">  De quoi avons-nous besoin? </h2><br><p>  Comme je l'ai dit, pour √©crire un livre de jeu, vous devez savoir ce que vous voulez faire et comment le faire.  D√©cidons ce dont nous avons besoin.  Pour une application Rails, nous aurons besoin de plusieurs packages syst√®me: nginx, postgresql (redis, etc.).  En plus de cela, nous avons besoin de rubis d'une certaine version.  Il est pr√©f√©rable de l'installer via rbenv (rvm, asdf ...).  Ex√©cuter tout cela √† partir de la racine de l'utilisateur est toujours une mauvaise id√©e, vous devez donc cr√©er un utilisateur distinct et configurer les droits pour lui.  Apr√®s cela, vous devez t√©l√©charger notre code sur le serveur, copier les configurations pour nginx, postgres, etc. et ex√©cuter tous ces services. </p><br><p>  <strong>En cons√©quence, la s√©quence d'actions est la suivante:</strong> </p><br><ol><li>  Connectez-vous en tant que root </li><li>  installer des packages syst√®me </li><li>  cr√©er un nouvel utilisateur, configurer les droits, cl√© ssh </li><li>  configurer les packages syst√®me (nginx, etc.) et les ex√©cuter </li><li>  Cr√©er un utilisateur dans la base de donn√©es (vous pouvez imm√©diatement cr√©er une base de donn√©es) </li><li>  Connectez-vous en tant que nouvel utilisateur </li><li>  Installer rbenv et ruby </li><li>  Installer le bundler </li><li>  Remplissez le code d'application </li><li>  Nous d√©marrons le serveur Puma </li></ol><br><p>  De plus, les derni√®res √©tapes peuvent √™tre effectu√©es √† l'aide de capistrano, au moins elle peut copier le code dans les r√©pertoires de version √† partir de la bo√Æte, basculer la version avec un lien symbolique sur un d√©ploiement r√©ussi, copier les configurations depuis le r√©pertoire partag√©, red√©marrer puma, etc.  Tout cela peut √™tre fait avec Ansible, mais pourquoi? </p><br><h2 id="faylovaya-struktura">  Structure des fichiers </h2><br><p>  Ansible a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">structure de fichiers</a> stricte pour tous ses fichiers, il est donc pr√©f√©rable de tout conserver dans un r√©pertoire s√©par√©.  Et ce n'est pas si important que ce soit dans l'application de rails elle-m√™me, ou s√©par√©ment.  Vous pouvez stocker des fichiers dans un r√©f√©rentiel git s√©par√©.  Personnellement, il √©tait plus pratique pour moi de cr√©er le r√©pertoire ansible dans / config du r√©pertoire rails de l'application et de tout stocker dans un r√©f√©rentiel. </p><br><h3 id="simple-playbook">  Playbook simple </h3><br><p>  Playbook est un fichier yml qui d√©crit ce que et comment ansible doit faire en utilisant une syntaxe sp√©ciale.  Cr√©ons le premier playbook qui ne fait rien: </p><br><pre><code class="plaintext hljs">--- - name: Simple playbook hosts: all</code> </pre> <br><p>  Ici, nous disons simplement que notre playbook s'appelle <code>Simple Playbook</code> et que son contenu devrait fonctionner pour tous les h√¥tes.  Nous pouvons l'enregistrer dans le r√©pertoire / ansible avec le nom <code>playbook.yml</code> et essayer d'ex√©cuter: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml PLAY [Simple Playbook] ************************************************************************************************************************************ skipping: no hosts matched</code> </pre> <br><p>  Ansible dit qu'il ne conna√Æt pas les h√¥tes qui correspondent √† la liste de tous.  Ils doivent √™tre r√©pertori√©s dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier d'inventaire</a> sp√©cial. </p><br><p>  Cr√©ons-le dans le m√™me r√©pertoire ansible: </p><br><pre> <code class="plaintext hljs">123.123.123.123</code> </pre> <br><p>  Il vous suffit donc de sp√©cifier l'h√¥te (id√©alement, l'h√¥te de votre VPS pour les tests, ou vous pouvez enregistrer localhost) et l'enregistrer sous l' <code>inventory</code> noms. <br>  Vous pouvez essayer d'ex√©cuter ansible avec un fichier d'inversion: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml -i inventory PLAY [Simple Playbook] ************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ PLAY RECAP ************************************************************************************************************************************</code> </pre> <br><p>  Si vous avez acc√®s ssh √† l'h√¥te sp√©cifi√©, ansible se connectera et collectera des informations sur le syst√®me distant.  (t√¢che par d√©faut [Gathering Facts]), apr√®s quoi il fera un bref rapport d'√©tape (PLAY RECAP). </p><br><p>  Par d√©faut, le nom d'utilisateur sous lequel vous √™tes connect√© au syst√®me est utilis√© pour la connexion.  Il ne sera probablement pas sur l'h√¥te.  Dans le fichier playbook, vous pouvez sp√©cifier l'utilisateur √† utiliser pour se connecter √† l'aide de la directive remote_user.  De plus, les informations sur un syst√®me distant peuvent souvent √™tre inutiles pour vous et vous ne devriez pas perdre de temps √† les collecter.  Vous pouvez √©galement d√©sactiver cette t√¢che: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no</code> </pre> <br><p>  Essayez de relancer le playbook et assurez-vous que la connexion fonctionne.  (Si vous avez sp√©cifi√© la racine de l'utilisateur, vous devez √©galement sp√©cifier la directive devient: vrai pour obtenir des droits √©lev√©s. Comme le dit la documentation: <code>become set to 'true'/'yes' to activate privilege escalation.</code> Bien qu'il ne soit pas clair pourquoi) . </p><br><p>  Peut-√™tre que vous obtenez une erreur caus√©e par l'ansible que l'interpr√©teur python ne peut pas d√©terminer, vous pouvez alors la sp√©cifier manuellement: </p><br><pre> <code class="plaintext hljs">ansible_python_interpreter: /usr/bin/python3</code> </pre> <br><p>  o√π vous avez python peut √™tre trouv√© avec la commande <code>whereis python</code> . </p><br><h3 id="ustanovka-sistemnyh-paketov">  Installer des packages syst√®me </h3><br><p>  Ansible est livr√© avec de nombreux modules pour travailler avec divers packages syst√®me, nous n'avons donc pas √† √©crire de scripts bash pour une raison quelconque.  Maintenant, nous avons besoin de l'un de ces modules pour mettre √† jour le syst√®me et installer les packages syst√®me.  J'ai Ubuntu Linux sur VPS, respectivement, pour installer des paquets, j'utilise <code>apt-get</code> et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module pour cela</a> .  Si vous utilisez un syst√®me d'exploitation diff√©rent, vous aurez peut-√™tre besoin d'un module diff√©rent (rappelez-vous, j'ai dit au d√©but que nous devons savoir √† l'avance quoi et comment nous allons faire).  Cependant, la syntaxe est probablement similaire. </p><br><p>  Nous compl√©tons notre playbook avec les premi√®res t√¢ches: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present</code> </pre> <br><p>  La t√¢che est juste la t√¢che qu'ansible effectuera sur des serveurs distants.  Nous donnons un nom √† la t√¢che pour suivre sa progression dans le journal.  Et nous d√©crivons, en utilisant la syntaxe d'un module sp√©cifique, ce qu'il doit faire.  Dans ce cas, <code>apt: update_cache=yes</code> - indique mettre √† jour les packages syst√®me √† l'aide du module apt.  La deuxi√®me √©quipe est un peu plus compliqu√©e.  Nous passons la liste des packages au module apt, et disons que leur <code>state</code> devrait devenir <code>present</code> , c'est-√†-dire que nous disons d'installer ces packages.  De m√™me, nous pouvons leur dire d'√™tre supprim√©s ou mis √† jour, simplement en changeant d' <code>state</code> .  Veuillez noter que pour que les rails fonctionnent avec postgresql, nous avons besoin du package postgresql-contrib que nous installons actuellement.  Cela doit encore une fois √™tre connu et fait, ansible en soi ne le fera pas. </p><br><p>  Essayez de r√©ex√©cuter le playbook et v√©rifiez que les packages sont install√©s. </p><br><h3 id="sozdanie-novyh-polzovateley">  Cr√©ation de nouveaux utilisateurs. </h3><br><p>  Pour travailler avec les utilisateurs, Ansible dispose √©galement d'un module - utilisateur.  Ajoutez une autre t√¢che (j'ai cach√© les parties d√©j√† connues du playbook derri√®re les commentaires, afin de ne pas le copier enti√®rement √† chaque fois): </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: my_user shell: /bin/bash password: "{{ 123qweasd | password_hash('sha512') }}"</code> </pre> <br><p>  Nous cr√©ons un nouvel utilisateur, lui d√©finissons un schell et un mot de passe.  Et puis nous sommes confront√©s √† plusieurs probl√®mes.  Que faire si les noms d'utilisateur doivent √™tre diff√©rents pour diff√©rents h√¥tes?  Oui, et garder le mot de passe ouvert dans le playbook est une tr√®s mauvaise id√©e.  Pour commencer, nous allons mettre le nom d'utilisateur et le mot de passe dans des variables, et vers la fin de l'article, je montrerai comment crypter le mot de passe. </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}"</code> </pre> <br><p>  Les variables sont d√©finies √† l'aide de crochets doubles dans les livres de lecture. </p><br><p>  Nous indiquerons les valeurs des variables dans le fichier d'inventaire: </p><br><pre> <code class="plaintext hljs">123.123.123.123 [all:vars] user=my_user user_password=123qweasd</code> </pre> <br><p>  Faites attention √† la directive <code>[all:vars]</code> - elle dit que le prochain bloc de texte est des variables (vars) et elles sont applicables √† tous les h√¥tes (tous). </p><br><p>  La construction de <code>"{{ user_password | password_hash('sha512') }}"</code> √©galement int√©ressante.  Le fait est qu'ansible ne d√©finit pas l'utilisateur via <code>user_add</code> comme vous le feriez manuellement.  Et il enregistre toutes les donn√©es directement, c'est pourquoi nous devons √©galement convertir le mot de passe en hachage √† l'avance, ce que fait cette commande. </p><br><p>  Ajoutons notre utilisateur au groupe sudo.  Cependant, avant cela, vous devez vous assurer qu'un tel groupe existe, car personne ne le fera pour nous: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo"</code> </pre> <br><p>  C'est assez simple, nous avons √©galement un module de groupe pour cr√©er des groupes, avec une syntaxe tr√®s similaire √† apt.  Il suffit ensuite d'enregistrer ce groupe aupr√®s de l'utilisateur ( <code>groups: "sudo"</code> ). <br>  Il est √©galement utile d'ajouter une cl√© ssh √† cet utilisateur afin que nous puissions nous connecter sans mot de passe: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  Dans ce cas, la construction <code>"{{ lookup('file', '~/.ssh/id_rsa.pub') }}"</code> est int√©ressante - elle copie le contenu du fichier id_rsa.pub (votre nom peut diff√©rer), c'est-√†-dire la partie publique de la cl√© ssh et le t√©l√©charge dans la liste des cl√©s autoris√©es pour l'utilisateur sur le serveur. </p><br><h3 id="roli">  R√¥les </h3><br><p>  Les trois t√¢ches de cr√©ation peuvent √™tre facilement utilis√©es comme un seul groupe de t√¢ches, et il serait bien de garder ce groupe s√©par√© du livre de jeu principal afin qu'il ne se d√©veloppe pas trop.  Il y a des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√¥les</a> pour cela dans ansible. <br>  Selon la structure de fichiers indiqu√©e au tout d√©but, les r√¥les doivent √™tre plac√©s dans un r√©pertoire de r√¥les s√©par√©, pour chaque r√¥le - un r√©pertoire s√©par√© avec le m√™me nom, √† l'int√©rieur du r√©pertoire des t√¢ches, fichiers, mod√®les, etc. <br>  Cr√©ons la structure du fichier: <code>./ansible/roles/user/tasks/main.yml</code> (main est le fichier principal qui sera charg√© et ex√©cut√© lorsque le r√¥le sera connect√© au playbook, d'autres fichiers de r√¥le pourront y √™tre connect√©s).  Vous pouvez maintenant transf√©rer dans ce fichier toutes les t√¢ches li√©es √† l'utilisateur: </p><br><pre> <code class="plaintext hljs"># Create user and add him to groups - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  Dans le playbook principal, vous devez sp√©cifier d'utiliser le r√¥le d'utilisateur: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present roles: - user</code> </pre> <br><p>  En outre, il peut √™tre judicieux d'effectuer une mise √† jour du syst√®me avant toutes les autres t√¢ches, pour cela, vous pouvez renommer le bloc de <code>tasks</code> dans lequel elles sont d√©finies dans les <code>pre_tasks</code> . </p><br><h3 id="nastroyka-nginx">  Configuration de Nginx </h3><br><p>  Nginx devrait d√©j√† √™tre install√© avec nous, vous devez le configurer et l'ex√©cuter.  Faisons-le tout de suite dans le r√¥le.  Cr√©ez une structure de fichiers: </p><br><pre> <code class="plaintext hljs">- ansible - roles - nginx - files - tasks - main.yml - templates</code> </pre> <br><p>  Maintenant, nous avons besoin de fichiers et de mod√®les.  La diff√©rence entre les deux est que les fichiers ansible sont copi√©s directement tels quels.  Et les mod√®les devraient avoir l'extension j2 et ils peuvent utiliser les valeurs des variables en utilisant les m√™mes crochets doubles. </p><br><p>  <code>main.yml</code> nginx dans le fichier <code>main.yml</code> .  Pour cela, nous avons un module systemd: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes</code> </pre> <br><p>  Ici, nous disons non seulement que nginx doit √™tre d√©marr√© (c'est-√†-dire l'ex√©cuter), mais nous disons imm√©diatement qu'il doit √™tre activ√©. <br>  Copiez maintenant les fichiers de configuration: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644'</code> </pre> <br><p>  Nous cr√©ons le fichier de configuration principal de nginx (vous pouvez le prendre directement depuis le serveur, ou l'√©crire vous-m√™me).  Et aussi le fichier de configuration de notre application dans le r√©pertoire sites_available (ce n'est pas n√©cessaire mais utile).  Dans le premier cas, nous utilisons le module de copie pour copier des fichiers (le fichier doit √™tre dans <code>/ansible/roles/nginx/files/nginx.conf</code> ).  Dans le second - copiez le mod√®le, en rempla√ßant les valeurs des variables.  Le mod√®le doit √™tre dans <code>/ansible/roles/nginx/templates/my_app.j2</code> ).  Et cela peut ressembler √† ceci: </p><br><pre> <code class="plaintext hljs">upstream {{ app_name }} { server unix:{{ app_path }}/shared/tmp/sockets/puma.sock; } server { listen 80; server_name {{ server_name }} {{ inventory_hostname }}; root {{ app_path }}/current/public; try_files $uri/index.html $uri.html $uri @{{ app_name }}; .... }</code> </pre> <br><p>  Faites attention aux insertions <code>{{ app_name }}</code> , <code>{{ app_path }}</code> , <code>{{ server_name }}</code> , <code>{{ inventory_hostname }}</code> - ce sont toutes des variables dont les valeurs ansible se substitueront dans le mod√®le avant de copier.  Ceci est utile si vous utilisez Playbook pour diff√©rents groupes d'h√¥tes.  Par exemple, nous pouvons compl√©ter notre fichier d'inventaire: </p><br><pre> <code class="plaintext hljs">[production] 123.123.123.123 [staging] 231.231.231.231 [all:vars] user=my_user user_password=123qweasd [production:vars] server_name=production app_path=/home/www/my_app app_name=my_app [staging:vars] server_name=staging app_path=/home/www/my_stage app_name=my_stage_app</code> </pre> <br><p>  Si nous ex√©cutons notre playbook maintenant, il effectuera les t√¢ches sp√©cifi√©es pour les deux h√¥tes.  Mais en m√™me temps, pour l'h√¥te interm√©diaire, les variables diff√©reront de la production, et pas seulement dans les r√¥les et les playbooks, mais aussi dans les configurations nginx.  <code>{{ inventory_hostname }}</code> n'a pas besoin d'√™tre sp√©cifi√© dans le fichier d'inventaire - il s'agit d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">variable sp√©ciale ansible</a> et l'h√¥te pour lequel le playbook est en cours d'ex√©cution y est stock√©. <br>  Si vous souhaitez avoir un fichier d'inventaire pour plusieurs h√¥tes et ne l'ex√©cuter que pour un seul groupe, cela peut √™tre fait avec la commande suivante: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging"</code> </pre> <br><p>  une autre option consiste √† avoir des fichiers d'inventaire distincts pour diff√©rents groupes.  Ou vous pouvez combiner deux approches si vous avez de nombreux h√¥tes diff√©rents. </p><br><p>  Revenons √† la configuration de nginx.  Apr√®s avoir copi√© les fichiers de configuration, nous devons cr√©er un lien symbolique dans sitest_enabled sur my_app.conf √† partir de sites_available.  Et red√©marrez nginx. </p><br><pre> <code class="plaintext hljs">... # old code in mail.yml - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted</code> </pre> <br><p>  Tout est simple ici - encore une fois, des modules ansibles avec une syntaxe assez standard.  Mais il y a un point.  Red√©marrer nginx √† chaque fois n'a pas de sens.  Vous avez remarqu√© que nous n'√©crivons pas de commandes du formulaire: "faites ceci comme ceci", la syntaxe ressemble plus √† "ceci devrait avoir cet √©tat".  Et le plus souvent, c'est ainsi que fonctionne ansible.  Si le groupe existe d√©j√† ou que le package syst√®me est d√©j√† install√©, alors ansible le v√©rifiera et ignorera la t√¢che.  De plus, les fichiers ne seront pas copi√©s s'ils co√Øncident compl√®tement avec ce qui se trouve d√©j√† sur le serveur.  Nous pouvons en profiter et red√©marrer nginx uniquement si les fichiers de configuration ont √©t√© modifi√©s.  Il existe une directive d'enregistrement pour cela: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes register: restart_nginx - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644' register: restart_nginx - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted when: restart_nginx.changed</code> </pre> <br><p>  Si l'un des fichiers de configuration change, la copie sera effectu√©e et la variable <code>restart_nginx</code> sera enregistr√©e.  Et seulement si cette variable a √©t√© enregistr√©e, le service red√©marrera. </p><br><p>  Bien s√ªr, vous devez ajouter le r√¥le nginx au playbook principal. </p><br><h3 id="nastroyka-postgresql">  Configuration de PostgreSQL </h3><br><p>  Nous devons activer postgresql avec systemd comme nous l'avons fait avec nginx, et √©galement cr√©er un utilisateur que nous utiliserons pour acc√©der √† la base de donn√©es et √† la base de donn√©es elle-m√™me. <br>  Cr√©ez le r√¥le <code>/ansible/roles/postgresql/tasks/main.yml</code> : </p><br><pre> <code class="plaintext hljs"># Create user in postgresql - name: enable postgresql and start systemd: name: postgresql state: started enabled: yes - name: Create database user become_user: postgres postgresql_user: name: "{{ db_user }}" password: "{{ db_password }}" role_attr_flags: SUPERUSER - name: Create database become_user: postgres postgresql_db: name: "{{ db_name }}" encoding: UTF-8 owner: "{{ db_user }}"</code> </pre> <br><p>  Je ne d√©crirai pas comment ajouter des variables √† l'inventaire, cela a d√©j√† √©t√© fait plusieurs fois, ainsi que la syntaxe des modules postgresql_db et postgresql_user.  Plus de donn√©es peuvent √™tre trouv√©es dans la documentation.  La directive <code>become_user: postgres</code> plus int√©ressante <code>become_user: postgres</code> .  Le fait est que, par d√©faut, seul l'utilisateur postgres a acc√®s √† la base de donn√©es postgresql et uniquement localement.  Cette directive nous permet d'ex√©cuter des commandes au nom de cet utilisateur (√† moins bien s√ªr que nous ayons acc√®s). <br>  De plus, vous devrez peut-√™tre ajouter une ligne √† pg_hba.conf pour ouvrir l'acc√®s √† la base de donn√©es √† un nouvel utilisateur.  Cela peut √™tre fait de la m√™me mani√®re que nous avons chang√© la configuration de nginx. </p><br><p>  Et bien s√ªr, vous devez ajouter le r√¥le de postgresql au playbook principal. </p><br><h3 id="ustanovka-ruby-cherez-rbenv">  Installer ruby ‚Äã‚Äãvia rbenv </h3><br><p>  Ansible n'a pas de modules pour travailler avec rbenv, mais il est install√© en clonant un r√©f√©rentiel git.  Par cons√©quent, cette t√¢che devient la plus non standard.  Cr√©ons pour elle le r√¥le <code>/ansible/roles/ruby_rbenv/main.yml</code> et commen√ßons √† le remplir: </p><br><pre> <code class="plaintext hljs"># Install rbenv and ruby - name: Install rbenv become_user: "{{ user }}" git: repo=https://github.com/rbenv/rbenv.git dest=~/.rbenv</code> </pre> <br><p>  Nous utilisons √† nouveau la directive devient_utilisateur pour travailler sous l'utilisateur que nous avons cr√©√© √† ces fins.  Depuis rbenv est install√© dans son r√©pertoire personnel, pas dans le monde.  Et nous utilisons √©galement le module git pour cloner le r√©f√©rentiel en sp√©cifiant repo et dest. </p><br><p>  Ensuite, nous devons enregistrer rbenv init dans bashrc et ajouter rbenv √† PATH au m√™me endroit.  Pour cela, nous avons le module lineinfile: </p><br><pre> <code class="plaintext hljs">- name: Add rbenv to PATH become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'export PATH="${HOME}/.rbenv/bin:${PATH}"' - name: Add rbenv init to bashrc become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'eval "$(rbenv init -)"'</code> </pre> <br><p>  Ensuite, installez ruby_build: </p><br><pre> <code class="plaintext hljs">- name: Install ruby-build become_user: "{{ user }}" git: repo=https://github.com/rbenv/ruby-build.git dest=~/.rbenv/plugins/ruby-build</code> </pre> <br><p>  Et enfin installer ruby.  Cela se fait via rbenv, c'est-√†-dire juste une commande bash: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" rbenv install {{ ruby_version }} args: executable: /bin/bash</code> </pre> <br><p>  Nous disons quelle √©quipe ex√©cuter et comment.  Cependant, nous rencontrons ici le fait qu'ansible n'ex√©cute pas le code contenu dans bashrc avant d'ex√©cuter les commandes.  Donc, rbenv devra √™tre d√©fini directement dans le m√™me script. </p><br><p>  Le probl√®me suivant est que la commande shell n'a pas d'√©tat en termes de ansible.  Autrement dit, une v√©rification automatique si cette version de ruby ‚Äã‚Äãest install√©e ou non ne le sera pas.  Nous pouvons le faire nous-m√™mes: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" if ! rbenv versions | grep -q {{ ruby_version }} then rbenv install {{ ruby_version }} &amp;&amp; rbenv global {{ ruby_version }} fi args: executable: /bin/bash</code> </pre> <br><p>  Et il reste √† installer bundler: </p><br><pre> <code class="plaintext hljs">- name: Install bundler become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" gem install bundler</code> </pre> <br><p>  Et encore une fois, ajoutez notre r√¥le ruby_rbenv au playbook principal. </p><br><h3 id="shared-files">  Fichiers partag√©s. </h3><br><p>  En g√©n√©ral, ce param√®tre peut √™tre effectu√©.  Ensuite, il reste √† ex√©cuter capistrano et il copiera le code lui-m√™me, cr√©era les r√©pertoires n√©cessaires et lancera l'application (si tout est correctement configur√©).  Cependant, capistrano a souvent besoin de fichiers de configuration suppl√©mentaires, tels que <code>database.yml</code> ou <code>.env</code> pouvez les copier comme des fichiers et des mod√®les pour nginx.  Il n'y a qu'une subtilit√©.  Avant de copier des fichiers, vous devez cr√©er une structure de r√©pertoires pour eux, quelque chose comme ceci: </p><br><pre> <code class="plaintext hljs"># Copy shared files for deploy - name: Ensure shared dir become_user: "{{ user }}" file: path: "{{ app_path }}/shared/config" state: directory</code> </pre> <br><p>  nous sp√©cifions un seul r√©pertoire et ansible cr√©era automatiquement le parent, si n√©cessaire. </p><br><h2 id="ansible-vault">  Vo√ªte Ansible </h2><br><p>  Nous sommes d√©j√† tomb√©s sur le fait que des donn√©es secr√®tes telles que le mot de passe utilisateur peuvent appara√Ætre dans des variables.  Si vous avez cr√©√© un fichier <code>.env</code> pour l'application et <code>database.yml</code> il devrait y avoir encore plus de telles donn√©es critiques.  Ce serait bien de les cacher des regards indiscrets.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un coffre-fort Ansible est</a> utilis√© pour cela. </p><br><p>  Cr√©ons un fichier pour les variables <code>/ansible/vars/all.yml</code> (ici vous pouvez cr√©er des fichiers diff√©rents pour diff√©rents groupes d'h√¥tes, tout comme dans le fichier d'inventaire: production.yml, staging.yml, etc.). <br>  Dans ce fichier, vous devez transf√©rer toutes les variables qui doivent √™tre chiffr√©es √† l'aide de la syntaxe yml standard: </p><br><pre> <code class="plaintext hljs"># System vars user_password: 123qweasd db_password: 123qweasd # ENV vars aws_access_key_id: xxxxx aws_secret_access_key: xxxxxx aws_bucket: bucket_name rails_secret_key_base: very_secret_key_base</code> </pre> <br><p>  Ensuite, ce fichier peut √™tre crypt√© avec la commande: </p><br><pre> <code class="plaintext hljs">ansible-vault encrypt ./vars/all.yml</code> </pre> <br><p>  Naturellement, lors du cryptage, il sera n√©cessaire de d√©finir un mot de passe pour le d√©cryptage.  Vous pouvez voir ce qui appara√Æt dans le fichier apr√®s avoir appel√© cette commande. </p><br><p>  √Ä l'aide de <code>ansible-vault decrypt</code> fichier peut √™tre d√©chiffr√©, modifi√©, puis √† nouveau chiffr√©. </p><br><p>  Pour fonctionner, d√©chiffrer le fichier n'est pas n√©cessaire.  Vous le stockez sous forme crypt√©e et ex√©cutez le playbook avec l'argument <code>--ask-vault-pass</code> .  Ansible vous demandera un mot de passe, r√©cup√©rera les variables et terminera les t√¢ches.  Toutes les donn√©es resteront crypt√©es. </p><br><p>  Une commande compl√®te pour plusieurs groupes d'h√¥tes et coffre-fort ansible ressemblerait √† ceci: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging" --ask-vault-pass</code> </pre> <br><p>  Et je ne vous donnerai pas le texte int√©gral des manuels et des r√¥les, √©crivez pour vous-m√™me.  Parce que la chose ansible est la suivante - si vous ne comprenez pas ce qui doit √™tre fait, alors il ne le fera pas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460769/">https://habr.com/ru/post/fr460769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460743/index.html">Guide du d√©butant Flutter</a></li>
<li><a href="../fr460745/index.html">Exp√©rience dans l'utilisation d'un module GSM en domotique</a></li>
<li><a href="../fr460747/index.html">Rechercher des profits ou resserrer les noix: Spotify a cess√© de travailler directement avec les auteurs - qu'est-ce que cela signifie</a></li>
<li><a href="../fr460751/index.html">Comment nous avons lanc√© des robots dans le petit Tchernobyl. Partie 1</a></li>
<li><a href="../fr460755/index.html">Robot Trolley ROS - Partie 1: Fer</a></li>
<li><a href="../fr460773/index.html">Impl√©mentation de la correspondance de mod√®les en Java</a></li>
<li><a href="../fr460777/index.html">C'est le tour: pourquoi Apple a chang√© les exigences pour les d√©veloppeurs d'applications</a></li>
<li><a href="../fr460779/index.html">D√©bogage avanc√©</a></li>
<li><a href="../fr460783/index.html">Consensus sur la r√©putation du n≈ìud. Est-ce n√©cessaire?</a></li>
<li><a href="../fr460785/index.html">Applications pour les livres √©lectroniques sur le syst√®me d'exploitation Android. Partie 1. Introduction et applications bureautiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>