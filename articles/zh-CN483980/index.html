<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🚒 🌖 🎄 创建容错IT基础架构。 第1部分-准备部署oVirt 4.3集群 🧜🏿 🤶🏽 👆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="邀请读者熟悉在一个数据中心内构建小型企业的容错基础架构的原理，将在简短的系列文章中对其进行详细研究。 
 引言 


 在DPC （数据处理中心）下可以理解： 


- 在企业区域内的“服务器机房”中拥有自己的机架，该机架满足提供电源和冷却设备以及通过两个独立提供商进行Internet访问的最低要求...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>创建容错IT基础架构。 第1部分-准备部署oVirt 4.3集群</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lenvendo/blog/483980/"><p> 邀请读者熟悉在一个数据中心内构建小型企业的容错基础架构的原理，将在简短的系列文章中对其进行详细研究。 </p><a name="habracut"></a><br><h2 id="vvodnaya-chast"> 引言 </h2><br><p> 在<strong>DPC</strong> （数据处理中心）下可以理解： </p><br><ul><li> 在企业区域内的“服务器机房”中拥有自己的机架，该机架满足提供电源和冷却设备以及通过两个独立提供商进行Internet访问的最低要求； </li><li> 在此数据中心中拥有自己设备的租用机架-所谓的 符合Tier III或IV标准的配置，可确保可靠的电源，冷却并提供容错的Internet访问； </li><li> 在Tier III或IV数据中心中完全租用的设备。 </li></ul><br><p> 选择哪种住宿选择-在每种情况下，一切都是个别的，通常取决于几个主要因素： </p><br><ul><li> 企业为何拥有自己的IT基础架构； </li><li> 企业从IT基础架构中到底需要什么（可靠性，可伸缩性，可管理性等）； </li><li> 对IT基础架构的初始投资金额，以及它的成本类型-资本（这意味着购买设备）或运营（通常是租用设备）； </li><li> 企业本身的计划范围。 </li></ul><br><p> 关于影响企业决定创建和使用其IT基础结构的决定的​​因素很多，但我们的目标是在实践中展示如何创建这种基础结构，以便既容错又可以节省金钱。 -减少获取商业软件的成本，甚至避免使用它们。 </p><br><p> 长期的实践表明，不值得在硬件上节省成本，因为杂费支付了两倍甚至更多。 但是再说一遍-好的硬件，这只是一个建议，最终要买的是什么，以及购买多少取决于企业的能力及其管理的“贪婪”。 此外，“贪婪”一词应该有一个很好的理解，因为在初期阶段最好投资于铁，这样以后在进一步的支持和扩展方面就不会出现严重的问题，因为最初错误的计划和过多的储蓄会导致未来的发展。比开始项目时要贵。 </p><br><p> 因此，该项目的初始数据： </p><br><ul><li> 有一家企业决定创建自己的Web门户并将其活动放到Internet上。 </li><li> 该公司决定租用机架，以将其设备放置在经过Tier III标准认证的良好数据中心中； </li><li> 该公司决定不节省太多硬件成本，因此购买了以下具有长期保证和支持的设备： </li></ul><br><div class="spoiler">  <b class="spoiler_title">设备清单</b> <div class="spoiler_text"><blockquote><ul><li> 两台物理Dell PowerEdge R640服务器，如下所示： </li><li>  <em>两个Intel Xeon Gold 5120处理器</em> </li><li>  <em>512 Gb内存</em> </li><li>  <em>RAID1中的两个SAS磁盘，用于操作系统安装</em> </li><li>  <em>内置4端口1G网卡</em> </li><li>  <em>两个2端口10G网卡</em> </li><li>  <em>1个2端口FC HBA 16G。</em> </li><li>  2控制器存储系统Dell MD3820f，通过FC 16G直接连接到Dell主机； </li><li> 第二级的两个交换机-Cisco WS-C2960RX-48FPS-L堆叠； </li><li>两个三层交换机-Cisco WS-C3850-24T-E，堆叠； </li><li> 机架，UPS，PDU，控制台服务器-由数据中心提供。 </li></ul><br></blockquote></div></div><br><p> 如我们所见，如果该公司可以与Internet上具有类似配置文件的其他公司竞争，并且可以开始赚取可用于扩展资源以进一步竞争和增长的利润，则现有设备在水平和垂直扩展方面都具有良好的前景。 </p><br><p> 如果企业决定提高计算集群的性能，我们可以添加哪些设备： </p><br><ul><li> 我们为2960X交换机上的端口数量预留了大量空间，这意味着您可以添加更多的硬件服务器； </li><li> 购买两个光纤通道交换机以将存储系统和其他服务器连接到它们； </li><li> 可以升级现有服务器-添加内存，用更高效的服务器替换处理器，将现有网络适配器连接到10G网络； </li><li> 您可以根据计划的负载，使用必要的磁盘类型（SAS，SATA或SSD）将其他磁盘架添加到存储中。 </li><li> 添加FC交换机后，您可以购买另一个存储系统以增加更多的磁盘容量，如果购买了特殊的远程复制选件，则可以在同一数据中心内和数据中心之间配置存储系统之间的数据复制（但是，这已经超出了范围）文章的范围）； </li><li> 还有三级交换机-Cisco 3850，可以用作网络的容错核心，以在内部网络之间进行高速路由。 随着内部基础设施的发展，这将在将来极大地帮助您。  3850还具有10G端口，可在以后将网络设备升级到10G时激活。 </li></ul><br><p> 既然现在没有虚拟化的地方，那么我们当然会处于趋势之中，而且这是降低购买某些基础架构元素（Web服务器，数据库等）的昂贵服务器的成本的好方法，而这并非总是最佳的在低负载的情况下使用，这恰好是项目启动之初的样子。 </p><br><p> 此外，虚拟化还有许多其他优势，对我们可能非常有用：虚拟机对硬件服务器故障的容错能力，集群硬件节点之间的实时迁移以进行维护，集群节点之间的手动或自动负载平衡等。 </p><br><p> 对于企业所购置的硬件，高度可访问的VMware vSphere集群的部署可以说明问题，但是由于VMware的任何软件都以其高昂的价格而闻名，因此，我们将使用绝对免费的虚拟化管理软件<a href="https://ru.wikipedia.org/wiki/OVirt"><strong>-oVirt</strong></a> ，在此基础上众所周知的已经商业化的产品<a href="https://ru.bmstu.wiki/RHEV_(Red_Hat_Enterprise_Virtualization)"><strong>-RHEV</strong></a> 。 </p><br><p>  <strong>oVirt</strong>软件是将所有基础架构元素组合在一起所必需的，以便能够方便地与高度可访问的虚拟机一起使用-这些虚拟机是数据库，Web应用程序，代理，平衡器，用于收集日志和分析的服务器等。 n。即我们企业的Web门户由什么组成。 </p><br><p> 总结此介绍，以下文章等待着我们，这些文章实际上将显示如何部署企业的整个硬件和软件基础结构： </p><br><div class="spoiler">  <b class="spoiler_title">文章清单</b> <div class="spoiler_text"><ul><li>  <strong>第1部分。</strong>准备部署oVirt群集4.3。 </li><li>  <strong>第2部分。</strong>安装和配置oVirt群集4.3。 </li><li>  <strong>第3部分。</strong>在VyOS虚拟路由器上组织容错路由。 </li><li>  <strong>第4部分。</strong>配置Cisco 3850堆栈，组织内部网路由。 </li></ul></div></div><br><h2 id="chast-1-podgotovka-k-razvyortyvaniyu-klastera-ovirt-43"> 第1部分。准备部署oVirt 4.3集群 </h2><br><h3 id="bazovaya-nastroyka-hostov"> 基本主机配置 </h3><br><p> 安装和配置操作系统是最简单的步骤。 关于如何正确安装和配置操作系统的文章很多，因此尝试给出一些排他的内容是没有意义的。 </p><br><p> 因此，我们有两台Dell PowerEdge R640主机，您需要在它们上安装操作系统并执行预配置，以将它们用作管理程序来在oVirt 4.3群集中运行虚拟机。 </p><br><p> 由于我们计划使用免费的非商业软件oVirt， <strong>因此</strong>选择<strong>CentOS 7.7</strong>来部署主机，尽管也可以在oVirt的主机上安装其他操作系统： </p><br><ul><li> 基于RHEL的特殊构建，即所谓的  <a href="https://www.ovirt.org/documentation/admin-guide/chap-Hosts.html"><strong>oVirt节点</strong></a> ; </li><li>  OS Oracle Linux将于2019年夏季<a href="https://blogs.oracle.com/virtualization/announcing-oracle-linux-virtualization-manager">宣布</a>支持oVirt的运行。 </li></ul><br><p> 在安装操作系统之前，建议： </p><br><ul><li> 在两台主机上配置iDRAC网络接口 </li><li> 将BIOS和iDRAC的固件更新到最新版本； </li><li> 最好将系统配置文件服务器配置为性能模式； </li><li> 从本地磁盘配置RAID（建议使用RAID1）以在服务器上安装OS。 </li></ul><br><p> 然后，我们将操作系统安装在通过iDRAC先前创建的磁盘上-安装过程是正常的，其中没有特殊的时刻。 也可以通过iDRAC访问服务器控制台以开始安装操作系统，尽管没有什么阻止您将显示器，键盘和鼠标直接连接到服务器以及从闪存驱动器安装操作系统。 </p><br><p> 安装操作系统后，执行其初始设置： </p><br><pre><code class="plaintext hljs">systemctl enable network.service systemctl start network.service systemctl status network.service</code> </pre> <br><pre> <code class="plaintext hljs">systemctl stop NetworkManager systemctl disable NetworkManager systemctl status NetworkManager</code> </pre> <br><pre> <code class="plaintext hljs">yum install -y ntp systemctl enable ntpd.service systemctl start ntpd.service</code> </pre> <br><pre> <code class="plaintext hljs">cat /etc/sysconfig/selinux SELINUX=disabled SELINUXTYPE=targeted</code> </pre> <br><pre> <code class="plaintext hljs">cat /etc/security/limits.conf * soft nofile 65536 * hard nofile 65536</code> </pre> <br><pre> <code class="plaintext hljs">cat /etc/sysctl.conf vm.max_map_count = 262144 vm.swappiness = 1</code> </pre> <br><p>  <u>安装基本软件</u> </p><br><p> 对于初始操作系统设置，您需要在服务器上配置任何网络接口，以便可以访问Internet，更新操作系统并安装必要的软件包。 这既可以在安装OS期间也可以在安装OS之后进行。 </p><br><pre> <code class="plaintext hljs">yum -y install epel-release yum update yum -y install bind-utils yum-utils net-tools git htop iotop nmon pciutils sysfsutils sysstat mc nc rsync wget traceroute gzip unzip telnet</code> </pre> <br><p> 以上所有设置和一套软件都是个人喜好的问题，这套软件仅供参考。 </p><br><p> 由于我们的主机将扮演虚拟机监控程序的角色，因此我们将启用所需的性能配置文件： </p><br><pre> <code class="plaintext hljs">systemctl enable tuned systemctl start tuned systemctl status tuned</code> </pre> <br><pre> <code class="plaintext hljs">tuned-adm profile tuned-adm profile virtual-host</code> </pre> <br><p> 您可以在此处阅读有关性能概要文件的更多信息：“ <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_tuning_and_optimization_guide/chap-virtualization_tuning_optimization_guide-tuned">第4章。tuned and tuned-adm</a> ”。 </p><br><p> 安装完操作系统后，我们继续进行下一部分-在主机和Cisco 2960X交换机堆栈上配置网络接口。 </p><br><h3 id="nastroyka-steka-kommutatorov-cisco-2960x"> 配置Cisco 2960X交换机堆栈 </h3><br><p> 我们的项目将使用以下数量的VLAN-或彼此隔离的广播域，以分离不同类型的流量： </p><br><p>  <strong>VLAN 10-</strong>互联网 <br>  <strong>VLAN 17-</strong>管理（iDRAC，存储，交换机管理） <br>  <strong>VLAN 32</strong> -VM生产网络 <br>  <strong>VLAN 33-</strong>互连网络（到外部承包商） <br>  <strong>VLAN 34-</strong>虚拟机测试网络 <br>  <strong>VLAN 35</strong> -VM开发人员网络 <br>  <strong>VLAN 40-</strong>监控网络 </p><br><p> 在开始工作之前，我们在L2级别上提供一个图表，我们最终应该得出以下图表： </p><br><p><img src="https://habrastorage.org/webt/in/ak/8a/inak8aoyty8yujo2zagwdehdytg.jpeg"></p><br><p> 为了oVirt主机和虚拟机之间的网络交互以及管理我们的存储，您需要配置Cisco 2960X交换机堆栈。 </p><br><p>  Dell主机具有内置的4端口网卡，因此，建议使用容错网络连接来组织它们与Cisco 2960X的连接，并使用将物理网络端口分组为逻辑接口和LACP协议（802.3ad）： </p><br><ul><li> 主机上的前两个端口被配置为绑定模式并连接到2960X交换机-在此逻辑接口上，将配置一个具有用于管理主机，监视，与oVirt集群中其他主机进行通信的地址的<strong><em>网桥</em></strong> ，还将用于虚拟机的实时迁移; </li><li> 主机上的后两个端口也配置为绑定模式，并连接到2960X-使用oVirt在此逻辑接口上，将在以后的网桥中（在相应的VLAN中）创建将虚拟机连接到的网桥。 </li><li> 同一逻辑接口内的两个网络端口都将处于活动状态，即 它们之间的流量可以以平衡模式同时传输。 </li><li> 群集节点上的网络设置必须完全相同，但IP地址除外。 </li></ul><br><p>  <u><strong>2960X</strong>交换机<strong>堆栈</strong>及其端口的基本配置</u> </p><br><p> 以前，我们的开关应为： </p><br><ul><li> 安装在机架中； </li><li> 通过两条所需长度的特殊电缆连接，例如CAB-STK-E-1M； </li><li> 连接电源； </li><li> 通过控制台端口连接到管理员的工作站，以进行初始配置。 </li></ul><br><p> 有关此问题的必要指南，请参见制造商的<a href="https://www.cisco.com/c/en/us/support/switches/catalyst-2960-x-series-switches/products-installation-guides-list.html">官方页面</a> 。 </p><br><p> 完成上述步骤后，配置交换机。 <br> 每个团队的含义都不应在本文的框架内解密；如有必要，可以独立找到所有信息。 <br> 我们的目标是尽快配置交换机堆栈，并将主机和存储管理接口连接到该堆栈。 </p><br><p>  1）连接到主交换机，进入特权模式，然后进入配置模式并进行基本设置。 </p><br><div class="spoiler">  <b class="spoiler_title">基本开关配置：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> enable configure terminal hostname 2960X no service pad service timestamps debug datetime msec service timestamps log datetime localtime show-timezone msec no service password-encryption service sequence-numbers switch 1 priority 15 switch 2 priority 14 stack-mac persistent timer 0 clock timezone MSK 3 vtp mode transparent ip subnet-zero vlan 17 name Management vlan 32 name PROD vlan 33 name Interconnect vlan 34 name Test vlan 35 name Dev vlan 40 name Monitoring spanning-tree mode rapid-pvst spanning-tree etherchannel guard misconfig spanning-tree portfast bpduguard default spanning-tree extend system-id spanning-tree vlan 1-40 root primary spanning-tree loopguard default vlan internal allocation policy ascending port-channel load-balance src-dst-ip errdisable recovery cause loopback errdisable recovery cause bpduguard errdisable recovery interval 60 line con 0 session-timeout 60 exec-timeout 60 0 logging synchronous line vty 5 15 session-timeout 60 exec-timeout 60 0 logging synchronous ip http server ip http secure-server no vstack interface Vlan1 no ip address shutdown exit</code> </pre></div></div><br><p> 我们使用<strong>wr mem</strong>命令保存配置，并使用主交换机1上的<strong>reload</strong>命令重新加载交换机堆栈。 </p><br><p>  2）在VLAN 17中以访问模式配置交换机的网络端口，以连接存储和iDRAC服务器的管理接口。 </p><br><div class="spoiler">  <b class="spoiler_title">管理端口设置：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">interface GigabitEthernet1/0/5 description iDRAC - host1 switchport access vlan 17 switchport mode access spanning-tree portfast edge interface GigabitEthernet1/0/6 description Storage1 - Cntr0/Eth0 switchport access vlan 17 switchport mode access spanning-tree portfast edge interface GigabitEthernet2/0/5 description iDRAC - host2 switchport access vlan 17 switchport mode access spanning-tree portfast edge interface GigabitEthernet2/0/6 description Storage1 – Cntr1/Eth0 switchport access vlan 17 switchport mode access spanning-tree portfast edge exit</code> </pre> </div></div><br><p>  3）重新启动堆栈后，检查其是否正常运行： </p><br><div class="spoiler">  <b class="spoiler_title">检查堆栈操作：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2960X#show switch stack-ring speed Stack Ring Speed : 20G Stack Ring Configuration: Full Stack Ring Protocol : FlexStack 2960X#show switch stack-ports Switch # Port 1 Port 2 -------- ------ ------ 1 Ok Ok 2 Ok Ok 2960X#show switch neighbors Switch # Port 1 Port 2 -------- ------ ------ 1 2 2 2 1 1 2960X#show switch detail Switch/Stack Mac Address : 0cd0.f8e4. Mac persistency wait time: Indefinite H/W Current Switch# Role Mac Address Priority Version State ---------------------------------------------------------- *1 Master 0cd0.f8e4. 15 4 Ready 2 Member 0029.c251. 14 4 Ready Stack Port Status Neighbors Switch# Port 1 Port 2 Port 1 Port 2 -------------------------------------------------------- 1 Ok Ok 2 2 2 Ok Ok 1 1</code> </pre> </div></div><br><p>  4）配置对2960X堆栈的SSH访问 </p><br><p> 对于通过SSH进行的远程堆栈管理，我们将使用在SVI（交换机虚拟接口） <strong>VLAN17</strong>上配置的IP 172.20.1.10。 </p><br><p> 尽管出于管理目的，建议在交换机上使用特殊的专用端口，但这是个人喜好和机会的问题。 </p><br><div class="spoiler">  <b class="spoiler_title">配置对交换机堆栈的SSH访问：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">ip default-gateway 172.20.1.2 interface vlan 17 ip address 172.20.1.10 255.255.255.0 hostname 2960X ip domain-name hw.home-lab.ru no ip domain-lookup clock set 12:47:04 06 Dec 2019 crypto key generate rsa ip ssh version 2 ip ssh time-out 90 line vty 0 4 session-timeout 60 exec-timeout 60 0 privilege level 15 logging synchronous transport input ssh line vty 5 15 session-timeout 60 exec-timeout 60 0 privilege level 15 logging synchronous transport input ssh aaa new-model aaa authentication login default local username cisco privilege 15 secret my_ssh_password</code> </pre> </div></div><br><p> 配置密码以进入特权模式： </p><br><pre> <code class="plaintext hljs">enable secret *myenablepassword* service password-encryption</code> </pre> <br><p> 配置NTP： </p><br><pre> <code class="plaintext hljs">ntp server 85.21.78.8 prefer ntp server 89.221.207.113 ntp server 185.22.60.71 ntp server 192.36.143.130 ntp server 185.209.85.222 show ntp status show ntp associations show clock detail</code> </pre> <br><p>  5）配置以太通道逻辑接口和连接到主机的物理端口。 为了简化配置，所有逻辑接口上都将允许所有可用的VLAN，但是通常建议仅配置所需的VLAN： </p><br><div class="spoiler">  <b class="spoiler_title">配置以太通道接口：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">interface Port-channel1 description EtherChannel with Host1-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk spanning-tree portfast edge trunk interface Port-channel2 description EtherChannel with Host2-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk spanning-tree portfast edge trunk interface Port-channel3 description EtherChannel with Host1-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk spanning-tree portfast edge trunk interface Port-channel4 description EtherChannel with Host2-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk spanning-tree portfast edge trunk interface GigabitEthernet1/0/1 description Host1-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 1 mode active interface GigabitEthernet1/0/2 description Host2-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 2 mode active interface GigabitEthernet1/0/3 description Host1-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 3 mode active interface GigabitEthernet1/0/4 description Host2-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 4 mode active interface GigabitEthernet2/0/1 description Host1-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 1 mode active interface GigabitEthernet2/0/2 description Host2-management switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 2 mode active interface GigabitEthernet2/0/3 description Host1-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 3 mode active interface GigabitEthernet2/0/4 description Host2-VM switchport trunk allowed vlan 10,17,30-40 switchport mode trunk channel-protocol lacp channel-group 4 mode active</code> </pre> </div></div><br><p>  <u>主机1和<strong>主机2</strong>上虚拟机的网络接口的初始配置</u> </p><br><p> 我们检查系统中用于绑定的必要模块的可用性，安装用于管理网桥的模块： </p><br><pre> <code class="plaintext hljs">modinfo bonding modinfo 8021q yum install bridge-utils</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">为主机上的虚拟机及其物理接口配置BOND1逻辑接口：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">cat /etc/sysconfig/network-scripts/ifcfg-bond1 #DESCRIPTION - management DEVICE=bond1 NAME=bond1 TYPE=Bond IPV6INIT=no ONBOOT=yes USERCTL=no NM_CONTROLLED=no BOOTPROTO=none BONDING_OPTS='mode=4 lacp_rate=1 xmit_hash_policy=2' cat /etc/sysconfig/network-scripts/ifcfg-em2 #DESCRIPTION - management DEVICE=em2 TYPE=Ethernet BOOTPROTO=none ONBOOT=yes MASTER=bond1 SLAVE=yes USERCTL=no NM_CONTROLLED=no cat /etc/sysconfig/network-scripts/ifcfg-em3 #DESCRIPTION - management DEVICE=em3 TYPE=Ethernet BOOTPROTO=none ONBOOT=yes MASTER=bond1 SLAVE=yes USERCTL=no NM_CONTROLLED=no</code> </pre> </div></div><br><p> 在<strong>2960X</strong>堆栈和主机上完成设置之后，我们在主机上重新启动网络并检查逻辑接口。 </p><br><ul><li> 在主机上： </li></ul><br><pre> <code class="plaintext hljs">systemctl restart network cat /proc/net/bonding/bond1 Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011) Bonding Mode: IEEE 802.3ad Dynamic link aggregation Transmit Hash Policy: layer2+3 (2) MII Status: up MII Polling Interval (ms): 100 Up Delay (ms): 0 Down Delay (ms): 0 ... 802.3ad info LACP rate: fast Min links: 0 Aggregator selection policy (ad_select): stable System priority: 65535 ... Slave Interface: em2 MII Status: up Speed: 1000 Mbps Duplex: full ... Slave Interface: em3 MII Status: up Speed: 1000 Mbps Duplex: full</code> </pre> <br><ul><li> 在<strong>2960X</strong>交换机<strong>堆栈上</strong> ： </li></ul><br><pre> <code class="plaintext hljs">2960X#show lacp internal Flags: S - Device is requesting Slow LACPDUs F - Device is requesting Fast LACPDUs A - Device is in Active mode P - Device is in Passive mode Channel group 1 LACP port Admin Oper Port Port Port Flags State Priority Key Key Number State Gi1/0/1 SA bndl 32768 0x1 0x1 0x102 0x3D Gi2/0/1 SA bndl 32768 0x1 0x1 0x202 0x3D 2960X#sh etherchannel summary Flags: D - down P - bundled in port-channel I - stand-alone s - suspended H - Hot-standby (LACP only) R - Layer3 S - Layer2 U - in use N - not in use, no aggregation f - failed to allocate aggregator M - not in use, minimum links not met m - not in use, port not aggregated due to minimum links not met u - unsuitable for bundling w - waiting to be aggregated d - default port A - formed by Auto LAG Number of channel-groups in use: 11 Number of aggregators: 11 Group Port-channel Protocol Ports ------+-------------+-----------+----------------------------------------------- 1 Po1(SU) LACP Gi1/0/1(P) Gi2/0/1(P)</code> </pre> <br><p> 用于管理<strong>Host1</strong>和<strong>Host2</strong>上的群集资源的网络接口的初始配置 </p><br><div class="spoiler">  <b class="spoiler_title">在主机上配置用于管理的BOND1逻辑接口及其物理接口：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">cat /etc/sysconfig/network-scripts/ifcfg-bond0 #DESCRIPTION - management DEVICE=bond0 NAME=bond0 TYPE=Bond BONDING_MASTER=yes IPV6INIT=no ONBOOT=yes USERCTL=no NM_CONTROLLED=no BOOTPROTO=none BONDING_OPTS='mode=4 lacp_rate=1 xmit_hash_policy=2' cat /etc/sysconfig/network-scripts/ifcfg-em0 #DESCRIPTION - management DEVICE=em0 TYPE=Ethernet BOOTPROTO=none ONBOOT=yes MASTER=bond0 SLAVE=yes USERCTL=no NM_CONTROLLED=no cat /etc/sysconfig/network-scripts/ifcfg-em1 #DESCRIPTION - management DEVICE=em1 TYPE=Ethernet BOOTPROTO=none ONBOOT=yes MASTER=bond0 SLAVE=yes USERCTL=no NM_CONTROLLED=no</code> </pre> </div></div><br><p> 在<strong>2960X</strong>堆栈和主机上完成设置之后，我们在主机上重新启动网络并检查逻辑接口。 </p><br><pre> <code class="plaintext hljs">systemctl restart network cat /proc/net/bonding/bond1 2960X#show lacp internal 2960X#sh etherchannel summary</code> </pre> <br><p> 我们在<strong>VLAN 17中的</strong>每个主机上配置控制网络接口，并将其绑定到逻辑接口BOND1： </p><br><div class="spoiler">  <b class="spoiler_title">在Host1上配置VLAN17：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">cat /etc/sysconfig/network-scripts/ifcfg-bond1.17 DEVICE=bond1.17 NAME=bond1-vlan17 BOOTPROTO=none ONBOOT=yes USERCTL=no NM_CONTROLLED=no VLAN=yes MTU=1500 IPV4_FAILURE_FATAL=yes IPV6INIT=no IPADDR=172.20.1.163 NETMASK=255.255.255.0 GATEWAY=172.20.1.2 DEFROUTE=yes DNS1=172.20.1.8 DNS2=172.20.1.9 ZONE=public</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">在Host2上配置VLAN17：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">cat /etc/sysconfig/network-scripts/ifcfg-bond1.17 DEVICE=bond1.17 NAME=bond1-vlan17 BOOTPROTO=none ONBOOT=yes USERCTL=no NM_CONTROLLED=no VLAN=yes MTU=1500 IPV4_FAILURE_FATAL=yes IPV6INIT=no IPADDR=172.20.1.164 NETMASK=255.255.255.0 GATEWAY=172.20.1.2 DEFROUTE=yes DNS1=172.20.1.8 DNS2=172.20.1.9 ZONE=public</code> </pre> </div></div><br><p> 我们在主机上重新启动网络，并检查它们之间的可见性。 </p><br><p> 这样就完成了Cisco 2960X交换机堆栈的设置，如果一切都正确完成，现在我们可以在L2级别将所有基础架构元素相互连接起来。 </p><br><h3 id="nastroyka-shd-dell-md3820f"> 配置Dell MD3820f存储 </h3><br><p> 在开始设置存储系统之前，它应该已经通过管理接口连接到Cisco <strong>2960X</strong>交换机堆栈，并且<strong>已经</strong>通过FC连接到<strong>Host1</strong>和<strong>Host2主机</strong> 。 </p><br><p> 上一章中给出了如何将存储连接到交换机堆栈的一般方案。 </p><br><p> 将FC上的存储连接到主机的方案应如下所示： </p><br><p><img src="https://habrastorage.org/webt/el/k8/5a/elk85aqc6ilmxeiowmh6acrkwri.jpeg"></p><br><p> 在连接期间，必须记录连接到存储系统上FC端口的FC HBA主机的WWPN地址-这对于后续配置主机到存储系统上LUN的绑定将是必需的。 </p><br><p> 在管理员的工作站上，下载并安装Dell MD3820f存储管理实用程序-PowerVault <strong>模块化磁盘存储管理器</strong> （ <strong>MDSM</strong> ）。 <br> 我们通过其默认IP地址连接到它，然后配置<strong>VLAN17中</strong>的地址以通过TCP / IP控制控制器： </p><br><p>  <strong>存储1</strong> ： </p><br><pre> <code class="plaintext hljs">ControllerA IP - 172.20.1.13, MASK - 255.255.255.0, Gateway - 172.20.1.2 ControllerB IP - 172.20.1.14, MASK - 255.255.255.0, Gateway - 172.20.1.2</code> </pre> <br><p> 设置地址后，进入存储管理界面并设置密码，设置时间，如有必要，更新控制器和磁盘的固件等。 <br> 存储<a href="https://www.dell.com/support/manuals/ru/ru/rubsdc/powervault-md3820f/mdseriesagpub/introduction%3Fguid%3Dguid-51208376-0df9-48a8-be66-63c1b06512ae%26lang%3Den-us">管理指南中</a>介绍了如何完成此操作。 </p><br><p> 完成上述设置后，我们将只需要执行一些操作： </p><br><ol><li> 配置<strong>主机</strong> FC <strong>标识符</strong> 。 </li><li> 创建一个主机组- <strong>主机组，</strong>然后将我们的两个Dell主机添加到其中。 </li><li> 创建一个磁盘组和其中的虚拟磁盘（或LUN），这些磁盘组将显示给主机。 </li><li> 为主机配置虚拟磁盘（或LUN）的表示。 </li></ol><br><p> 通过菜单- <strong>主机映射</strong> -&gt; <strong>定义</strong> -&gt; <strong>主机...</strong>向其添加新主机和主机FC端口的绑定标识符<strong>。</strong> <br> 例如，可以在iDRAC服务器中找到FC HBA主机的WWPN地址。 </p><br><p> 结果，我们应该得到这样的东西： </p><br><p><img src="https://habrastorage.org/webt/p_/uk/u4/p_uku4o-ewgqpyi0xudxqjesfjc.png"></p><br><p> 通过菜单- <strong>主机映射</strong> -&gt; <strong>定义</strong> -&gt; <strong>主机组...</strong>添加新的主机组并将主机绑定到<strong>主机。</strong> <br> 对于主机，选择OS- <strong><em>Linux（DM-MP）的类型</em></strong> 。 </p><br><p> 创建主机组后，通过“ <strong>存储和复制服务”</strong>选项卡，创建一个磁盘组<strong>-Disk Group</strong> ，其类型取决于容错要求（例如RAID10），并且在其中具有正确大小的虚拟磁盘： </p><br><p><img src="https://habrastorage.org/webt/ue/g2/kn/ueg2kn0m3usv1kb4tygvx2vajz0.png"></p><br><p> 最后，最后一步是为主机提供虚拟磁盘（或LUN）。 <br> 为此，通过菜单- <strong>主机映射</strong> -&gt; <strong>Lun映射</strong> -&gt; <strong>添加...，</strong>我们将虚拟磁盘绑定到主机，并为其分配编号。 </p><br><p> 一切应如下图所示： </p><br><p><img src="https://habrastorage.org/webt/db/a-/xq/dba-xqbacgrjxrutupvhvmua7ro.png"></p><br><p> 我们已经完成了存储系统的配置，如果一切都正确完成，则主机应该可以通过其FC HBA看到提供给它们的LUN。 <br> 使系统更新有关映射驱动器的信息： </p><br><pre> <code class="plaintext hljs">ls -la /sys/class/scsi_host/ echo "- - -" &gt; /sys/class/scsi_host/host[0-9]/scan</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">让我们看看哪些设备在我们的服务器上可见：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">cat /proc/scsi/scsi Attached devices: Host: scsi0 Channel: 02 Id: 00 Lun: 00 Vendor: DELL Model: PERC H330 Mini Rev: 4.29 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi15 Channel: 00 Id: 00 Lun: 00 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi15 Channel: 00 Id: 00 Lun: 01 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi15 Channel: 00 Id: 00 Lun: 04 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi15 Channel: 00 Id: 00 Lun: 11 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi15 Channel: 00 Id: 00 Lun: 31 Vendor: DELL Model: Universal Xport Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi18 Channel: 00 Id: 00 Lun: 00 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi18 Channel: 00 Id: 00 Lun: 01 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi18 Channel: 00 Id: 00 Lun: 04 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi18 Channel: 00 Id: 00 Lun: 11 Vendor: DELL Model: MD38xxf Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 Host: scsi18 Channel: 00 Id: 00 Lun: 31 Vendor: DELL Model: Universal Xport Rev: 0825 Type: Direct-Access ANSI SCSI revision: 05 lsscsi [0:2:0:0] disk DELL PERC H330 Mini 4.29 /dev/sda [15:0:0:0] disk DELL MD38xxf 0825 - [15:0:0:1] disk DELL MD38xxf 0825 /dev/sdb [15:0:0:4] disk DELL MD38xxf 0825 /dev/sdc [15:0:0:11] disk DELL MD38xxf 0825 /dev/sdd [15:0:0:31] disk DELL Universal Xport 0825 - [18:0:0:0] disk DELL MD38xxf 0825 - [18:0:0:1] disk DELL MD38xxf 0825 /dev/sdi [18:0:0:4] disk DELL MD38xxf 0825 /dev/sdj [18:0:0:11] disk DELL MD38xxf 0825 /dev/sdk [18:0:0:31] disk DELL Universal Xport 0825 -</code> </pre> </div></div><br><p> 您还可以在主机上配置<strong>多路径</strong> ，尽管安装oVirt时他可以自己进行，但是最好事先自己检查MP。 </p><br><p>  <u>安装和配置DM Multipath</u> </p><br><pre> <code class="plaintext hljs">yum install device-mapper-multipath mpathconf --enable --user_friendly_names y cat /etc/multipath.conf | egrep -v "^\s*(#|$)" defaults { user_friendly_names yes find_multipaths yes } blacklist { wwid 26353900f02796769 devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*" devnode "^hd[az]" }</code> </pre> <br><p> 以自动启动方式安装MP服务并运行它： </p><br><pre> <code class="plaintext hljs">systemctl enable multipathd &amp;&amp; systemctl restart multipathd</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">检查有关用于MP操作的已加载模块的信息：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">lsmod | grep dm_multipath dm_multipath 27792 6 dm_service_time dm_mod 124407 139 dm_multipath,dm_log,dm_mirror modinfo dm_multipath filename: /lib/modules/3.10.0-957.12.2.el7.x86_64/kernel/drivers/md/dm-multipath.ko.xz license: GPL author: Sistina Software &lt;dm-devel@redhat.com&gt; description: device-mapper multipath target retpoline: Y rhelversion: 7.6 srcversion: 985A03DCAF053D4910E53EE depends: dm-mod intree: Y vermagic: 3.10.0-957.12.2.el7.x86_64 SMP mod_unload modversions signer: CentOS Linux kernel signing key sig_key: A3:2D:39:46:F2:D3:58:EA:52:30:1F:63:37:8A:37:A5:54:03:00:45 sig_hashalgo: sha256</code> </pre> </div></div><br><p> 请参阅现有多路径配置摘要： </p><br><pre> <code class="plaintext hljs">mpathconf multipath is enabled find_multipaths is disabled user_friendly_names is disabled dm_multipath module is loaded multipathd is running</code> </pre> <br><p> 将新的LUN添加到存储并将其呈现给主机后，有必要对其连接到HBA主机的磁盘进行扫描。 </p><br><pre> <code class="plaintext hljs">systemctl reload multipathd multipath -v2</code> </pre> <br><p> 最后，我们检查是否所有LUN都出现在主机的存储中，以及是否都有两条路径。 </p><br><div class="spoiler">  <b class="spoiler_title">检查MP操作：</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">multipath -ll 3600a098000e4b4b3000003175cec1840 dm-2 DELL ,MD38xxf size=2.0T features='3 queue_if_no_path pg_init_retries 50' hwhandler='1 rdac' wp=rw |-+- policy='service-time 0' prio=14 status=active | `- 15:0:0:1 sdb 8:16 active ready running `-+- policy='service-time 0' prio=9 status=enabled `- 18:0:0:1 sdi 8:128 active ready running 3600a098000e4b48f000002ab5cec1921 dm-6 DELL ,MD38xxf size=10T features='3 queue_if_no_path pg_init_retries 50' hwhandler='1 rdac' wp=rw |-+- policy='service-time 0' prio=14 status=active | `- 18:0:0:11 sdk 8:160 active ready running `-+- policy='service-time 0' prio=9 status=enabled `- 15:0:0:11 sdd 8:48 active ready running 3600a098000e4b4b3000003c95d171065 dm-3 DELL ,MD38xxf size=150G features='3 queue_if_no_path pg_init_retries 50' hwhandler='1 rdac' wp=rw |-+- policy='service-time 0' prio=14 status=active | `- 15:0:0:4 sdc 8:32 active ready running `-+- policy='service-time 0' prio=9 status=enabled `- 18:0:0:4 sdj 8:144 active ready running</code> </pre> </div></div><br><p> 如您所见，存储系统上的所有三个虚拟磁盘都以两种方式可见。 至此，所有准备工作已经完成，这意味着我们可以继续进行主要部分-设置oVirt集群，将在下一篇文章中进行讨论。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483980/">https://habr.com/ru/post/zh-CN483980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483964/index.html">不要担心JSON或您的第一个API应用程序</a></li>
<li><a href="../zh-CN483972/index.html">如何使用Quora促进您的业务</a></li>
<li><a href="../zh-CN483974/index.html">通过iSCSI进行的Ceph-或站在吊床上滑雪</a></li>
<li><a href="../zh-CN483976/index.html">2020年的网络安全和威胁：假期过后我们等待着什么</a></li>
<li><a href="../zh-CN483978/index.html">了解2020年现代Web App开发的概念</a></li>
<li><a href="../zh-CN483986/index.html">用Emotiv Insight来控制机器人的思想</a></li>
<li><a href="../zh-CN483988/index.html">MicroSPA或如何发明方形齿轮</a></li>
<li><a href="../zh-CN483992/index.html">为什么有些行星会吞噬天空</a></li>
<li><a href="../zh-CN483994/index.html">游艇上的IT迁移。 从瑞典到西班牙</a></li>
<li><a href="../zh-CN484004/index.html">@Pythonetc 2019年12月</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>