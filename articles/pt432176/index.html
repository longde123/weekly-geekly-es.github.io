<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùì üåæ üôãüèΩ Como dobramos a velocidade de trabalhar com o Float em Mono ‚úçüèº üßñüèª üéÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meu amigo Aras escreveu recentemente o mesmo ray tracer em diferentes idiomas, incluindo C ++, C # e o compilador Unity Burst. Obviamente, √© natural e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como dobramos a velocidade de trabalhar com o Float em Mono</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432176/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/49a/c69/c73/49ac69c73ac3a6c124f04b468dfb90d5.png"></div><br>  Meu amigo Aras <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreveu recentemente</a> o mesmo ray tracer em diferentes idiomas, incluindo C ++, C # e o compilador Unity Burst.  Obviamente, √© natural esperar que o C # seja mais lento que o C ++, mas me pareceu interessante que o Mono seja mais lento que o .NET Core. <br><br>  Seus <a href="">indicadores</a> publicados eram ruins: <br><br><ul><li>  C # (.NET Core): Mac 17.5 Mray / s, </li><li>  C # (Unity, Mono): Mac 4.6 Mray / s, </li><li>  C # (Unity, IL2CPP): Mac 17.1 Mray / s </li></ul><br>  Decidi ver o que estava acontecendo e documentar lugares que poderiam ser melhorados. <br><br>  Como resultado desse benchmark e do estudo desse problema, encontramos tr√™s √°reas nas quais a melhoria √© poss√≠vel: <br><br><ul><li>  Primeiro, voc√™ precisa melhorar as configura√ß√µes Mono padr√£o, porque os usu√°rios geralmente n√£o definem suas configura√ß√µes </li><li>  Em segundo lugar, precisamos apresentar ativamente o mundo ao back-end da otimiza√ß√£o de c√≥digo LLVM em Mono </li><li>  Em terceiro lugar, melhoramos o ajuste de alguns par√¢metros Mono. </li></ul><br>  O ponto de refer√™ncia deste teste foram os resultados do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tra√ßador de raios</a> executado na minha m√°quina e, como tenho hardware diferente, n√£o podemos comparar os n√∫meros. <br><br>  Os resultados no meu iMac em casa para Mono e .NET Core foram os seguintes: <br><br><table><thead><tr><th>  Ambiente de trabalho </th><th>  Resultados, MRay / s </th></tr></thead><tbody><tr><td> .NET Core 2.1.4, <code>dotnet run</code> debug build </td><td>  3.6. </td></tr><tr><td>  <code>dotnet run -c Release</code> .NET Core 2.1.4 build <code>dotnet run -c Release</code> </td><td>  21,7 </td></tr><tr><td>  Mono de baunilha, <code>mono Maths.exe</code> </td><td>  6.6 </td></tr><tr><td>  Baunilha Mono com LLVM e float32 </td><td>  15,5 </td></tr></tbody></table><a name="habracut"></a><br>  No processo de estudo desse problema, encontramos alguns problemas, depois de corrigir quais os seguintes resultados foram obtidos: <br><br><table><thead><tr><th>  Ambiente de trabalho </th><th>  Resultados, MRay / s </th></tr></thead><tbody><tr><td>  Mono com LLVM e float32 </td><td>  15,5 </td></tr><tr><td>  Mono avan√ßado com LLVM, float32 e inline fixo </td><td>  29,6 </td></tr></tbody></table><br>  O quadro geral: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/407/ecf/385/407ecf385de6261087b4395928076e02.png"></div><br>  Apenas aplicando LLVM e float32, voc√™ pode aumentar o desempenho do c√≥digo de ponto flutuante em quase 2,3 vezes.  E ap√≥s o ajuste, que adicionamos ao Mono como resultado dessas experi√™ncias, voc√™ pode aumentar a produtividade em 4,4 vezes em compara√ß√£o com o Mono padr√£o - esses par√¢metros nas vers√µes futuras do Mono se tornar√£o os par√¢metros padr√£o. <br><br>  Neste artigo, explicarei nossas descobertas. <br><br><h2>  Flutua√ß√£o de 32 e 64 bits </h2><br>  Aras usa n√∫meros de ponto flutuante de 32 bits para a parte principal dos c√°lculos (digite <code>float</code> em C # ou <code>System.Single</code> em .NET).  Em Mono, cometemos um erro h√° muito tempo - todos os c√°lculos de ponto flutuante de 32 bits foram executados como 64 bits e os dados ainda estavam armazenados em √°reas de 32 bits. <br><br>  Hoje, minha mem√≥ria n√£o est√° t√£o n√≠tida quanto antes e n√£o me lembro exatamente por que tomamos essa decis√£o. <br><br>  S√≥ posso supor que foi influenciado pelas tend√™ncias e id√©ias da √©poca. <br><br>  Em seguida, uma aura positiva pairava em torno da computa√ß√£o flutuante com maior precis√£o.  Por exemplo, os processadores Intel x87 usavam precis√£o de 80 bits para c√°lculos de ponto flutuante, mesmo quando os operandos eram duplos, o que fornecia aos usu√°rios resultados mais precisos. <br><br>  Naquela √©poca, tamb√©m era relevante a id√©ia de que em um dos meus projetos anteriores - planilhas Gnumeric - as fun√ß√µes estat√≠sticas fossem implementadas com mais efici√™ncia do que no Excel.  Portanto, muitas comunidades est√£o bem cientes da ideia de que resultados mais precisos com maior precis√£o podem ser usados. <br><br>  Nos est√°gios iniciais do desenvolvimento Mono, a maioria das opera√ß√µes matem√°ticas executadas em todas as plataformas podia receber apenas o dobro na entrada.  As vers√µes de 32 bits foram adicionadas ao C99, Posix e ISO, mas naquela √©poca elas n√£o estavam amplamente dispon√≠veis para toda a ind√∫stria (por exemplo, <code>sinf</code> √© a vers√£o flutuante do <code>sin</code> , <code>fabsf</code> √© a vers√£o do <code>fabs</code> e assim por diante). <br><br>  Em suma, o in√≠cio dos anos 2000 foi um per√≠odo de otimismo. <br><br>  Os aplicativos pagavam um pre√ßo muito alto pelo aumento do tempo de computa√ß√£o, mas o Mono era usado principalmente para aplicativos Linux de desktop que serviam p√°ginas HTTP e alguns processos de servidor; portanto, a velocidade do ponto flutuante n√£o era o problema que encontramos diariamente.  Tornou-se vis√≠vel apenas em alguns benchmarks cient√≠ficos e, em 2003, eles raramente foram desenvolvidos no .NET. <br><br>  Atualmente, jogos, aplicativos 3D, processamento de imagem, VR, AR e aprendizado de m√°quina tornaram as opera√ß√µes de ponto flutuante um tipo mais comum de dados.  O problema n√£o vem sozinho e n√£o h√° exce√ß√µes.  Float n√£o era mais o tipo de dados amig√°vel usado no c√≥digo em apenas alguns lugares.  Eles se transformaram em uma avalanche, da qual n√£o h√° onde se esconder.  Existem muitos deles e sua propaga√ß√£o n√£o pode ser interrompida. <br><br><h2>  Sinalizador de espa√ßo de trabalho float32 </h2><br>  Portanto, h√° alguns anos, decidimos adicionar suporte para executar opera√ß√µes de flutua√ß√£o de 32 bits usando opera√ß√µes de 32 bits, como em todos os outros casos.  Chamamos esse recurso de espa√ßo de trabalho de "float32".  No Mono, √© ativado adicionando a op√ß√£o <code>--O=float32</code> no ambiente de trabalho, e nos aplicativos Xamarin esse par√¢metro √© alterado nas configura√ß√µes do projeto. <br><br>  Essa nova bandeira foi bem recebida por nossos usu√°rios de dispositivos m√≥veis, porque basicamente os dispositivos m√≥veis ainda n√£o s√£o muito poderosos e s√£o prefer√≠veis processar dados mais rapidamente do que aumentar a precis√£o.  Recomendamos que os usu√°rios m√≥veis ativem o compilador de otimiza√ß√£o LLVM e o sinalizador float32 ao mesmo tempo. <br><br>  Embora esse sinalizador tenha sido implementado por v√°rios anos, n√£o o tornamos o padr√£o para evitar surpresas desagrad√°veis ‚Äã‚Äãpara os usu√°rios.  No entanto, come√ßamos a encontrar casos em que surgem surpresas devido ao comportamento padr√£o de 64 bits. Consulte este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio de bug enviado pelo usu√°rio do Unity</a> . <br><br>  Agora usaremos o Mono <code>float32</code> . O progresso pode ser rastreado aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/mono/mono/issues/6985</a> . <br><br>  Enquanto isso, voltei ao projeto de meu amigo Aras.  Ele usou as novas APIs que foram adicionadas ao .NET Core.  Embora o .NET Core sempre tenha executado opera√ß√µes de flutua√ß√£o de 32 bits como flutuadores de 32 bits, a API <code>System.Math</code> ainda realiza convers√µes de <code>float</code> para <code>double</code> no processo.  Por exemplo, se voc√™ precisar calcular a fun√ß√£o seno para um valor flutuante, a √∫nica op√ß√£o √© chamar <code>Math.Sin (double)</code> , e voc√™ ter√° que converter de float para double. <br><br>  Para corrigir isso, um novo tipo de <code>System.MathF</code> foi adicionado ao .NET Core que cont√©m opera√ß√µes matem√°ticas com ponto flutuante de precis√£o √∫nica e agora acabamos de mover esse <code>[System.MathF]</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para Mono</a> . <br><br>  A transi√ß√£o da flutua√ß√£o de 64 bits para 32 bits melhora significativamente o desempenho, o que pode ser visto nesta tabela: <br><br><table><thead><tr><th>  <strong>Ambiente de trabalho e op√ß√µes</strong> </th><th>  Mrays / segundo </th></tr></thead><tbody><tr><td>  Mono com System.Math </td><td>  6.6 </td></tr><tr><td>  Mono com System.Math e <code>-O=float32</code> </td><td>  8.1 </td></tr><tr><td>  Mono com System.MathF </td><td>  6.5 </td></tr><tr><td>  Mono com System.MathF e <code>-O=float32</code> </td><td>  8.2 </td></tr></tbody></table><br>  Ou seja, o uso de <code>float32</code> nesse teste realmente melhora o desempenho e o MathF tem pouco efeito. <br><br><h1>  Configura√ß√£o do LLVM </h1><br>  No processo desta pesquisa, descobrimos que, embora o compilador Fast JIT Mono tenha suporte <code>float32</code> , n√£o adicionamos esse suporte ao back-end do LLVM.  Isso significava que o Mono com LLVM ainda estava realizando convers√µes dispendiosas de float para double. <br><br>  Portanto, Zoltan adicionou suporte <code>float32</code> ao mecanismo de gera√ß√£o de c√≥digo LLVM. <br><br>  Ent√£o, ele notou que nosso inliner usa as mesmas heur√≠sticas para o Fast JIT que aquelas usadas para o LLVM.  Ao trabalhar com o Fast JIT, √© necess√°rio encontrar um equil√≠brio entre a velocidade do JIT e a velocidade de execu√ß√£o; portanto, limitamos a quantidade de c√≥digo incorporado para reduzir a quantidade de trabalho do mecanismo JIT. <br><br>  Mas se voc√™ decidir usar o LLVM no Mono, esfor√ßar-se-√° pelo c√≥digo o mais r√°pido poss√≠vel, por isso alteramos as configura√ß√µes de acordo.  Hoje, esse par√¢metro pode ser alterado usando a <code>MONO_INLINELIMIT</code> ambiente <code>MONO_INLINELIMIT</code> , mas na verdade ele precisa ser gravado nos valores padr√£o. <br><br>  Aqui est√£o os resultados com as configura√ß√µes LLVM modificadas: <br><br><table><thead><tr><th>  Ambiente de trabalho e op√ß√µes </th><th>  Mrays / segundos </th></tr></thead><tbody><tr><td>  Mono com System.Math <code>--llvm -O=float32</code> </td><td>  16,0 </td></tr><tr><td>  Mono com System.Math <code>--llvm -O=float32</code> , heur√≠sticas constantes </td><td>  29,1 </td></tr><tr><td>  Mono com System.MathF <code>--llvm -O=float32</code> , heur√≠sticas constantes </td><td>  29,6 </td></tr></tbody></table><br><h1>  Pr√≥ximas etapas </h1><br>  Pouco esfor√ßo foi necess√°rio para fazer todas essas melhorias.  Essas mudan√ßas foram lideradas por discuss√µes peri√≥dicas no Slack.  At√© consegui fazer algumas horas uma noite para portar <code>System.MathF</code> para Mono. <br><br>  O c√≥digo do rastreador de raios Aras tornou-se um assunto ideal para estudo porque era auto-suficiente, era uma aplica√ß√£o real e n√£o uma refer√™ncia sint√©tica.  Queremos encontrar outro software semelhante que possa ser usado para estudar o c√≥digo bin√°rio que geramos e garantir que passemos ao LLVM os melhores dados para a execu√ß√£o ideal de seu trabalho. <br><br>  Tamb√©m estamos considerando atualizar nosso LLVM e usar as novas otimiza√ß√µes adicionadas. <br><br><h1>  Nota separada </h1><br>  Precis√£o extra tem bons efeitos colaterais.  Por exemplo, lendo as solicita√ß√µes de pool do mecanismo Godot, vi que h√° uma discuss√£o ativa sobre se a precis√£o das opera√ß√µes de ponto flutuante pode ser personalizada em tempo de compila√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/godotengine/godot/pull/17134</a> ). <br><br>  Perguntei a Juan por que isso pode ser necess√°rio para algu√©m, porque acreditava que opera√ß√µes de ponto flutuante de 32 bits s√£o suficientes para jogos. <br><br>  Juan explicou que, no caso geral, os carros aleg√≥ricos funcionam muito bem, mas se voc√™ "se afastar" do centro, digamos, se move 100 quil√¥metros do centro do jogo, um erro de c√°lculo come√ßa a se acumular, o que pode levar a falhas gr√°ficas interessantes.  Voc√™ pode usar estrat√©gias diferentes para reduzir o impacto desse problema, e uma delas √© trabalhar com maior precis√£o, pela qual voc√™ deve pagar pelo desempenho. <br><br>  Logo ap√≥s nossa conversa, no meu feed do Twitter, vi uma postagem demonstrando esse problema: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://pharr.org/matt/blog/2018/03/02/rendering-in-camera-space.html</a> <br><br>  <em>O problema √© mostrado nas imagens abaixo.</em>  <em>Aqui vemos um modelo de carro esportivo do</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>pacote pbrt-v3-scenes</em></a> ** <em>.</em>  <em>A c√¢mera e a cena est√£o pr√≥ximas da origem e tudo parece √≥timo.</em> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f1/702/725/4f1702725634faa3ba94aa930230fb6d.png"></div><br>  ** <em>(Autor de</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>Yasutoshi Mori</em></a> <em>.)</em> <br><br>  Em seguida, movemos a c√¢mera e a cena 200.000 unidades em xx, yy e zz a partir da origem.  Pode-se ver que o modelo da m√°quina se tornou bastante fragmentado;  isso se deve unicamente √† falta de precis√£o nos n√∫meros de ponto flutuante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/842/4b0/658/8424b065878f52bcd83b5d2de19321e5.png"></div><br>  <em>Se avan√ßarmos ainda mais 5 √ó 5 √ó 5 vezes, 1 milh√£o de unidades a partir da origem, o modelo come√ßar√° a se desintegrar;</em>  <em>a m√°quina se transforma em uma aproxima√ß√£o voxel extremamente grosseira de si mesma, interessante e aterrorizante.</em>  <em>(Keanu fez a pergunta: O Minecraft √© t√£o c√∫bico simplesmente porque tudo √© renderizado muito longe da origem?)</em> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/49a/c69/c73/49ac69c73ac3a6c124f04b468dfb90d5.png"></div><br>  ** <em>(Pe√ßo desculpas a</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>Yasutoshi Mori</em></a> <em>pelo que fizemos com sua bela modelo.)</em> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432176/">https://habr.com/ru/post/pt432176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt432166/index.html">Apache NiFi: o que √© e uma breve vis√£o geral dos recursos</a></li>
<li><a href="../pt432168/index.html">Autoridades chinesas coletam informa√ß√µes de ve√≠culos el√©tricos de cidad√£os do pa√≠s</a></li>
<li><a href="../pt432170/index.html">Transporte um data center em 14.400 segundos</a></li>
<li><a href="../pt432172/index.html">Convite perigoso ou Como funciona a carga de combate de um email de phishing</a></li>
<li><a href="../pt432174/index.html">Como desenvolver um produto de software com compet√™ncia e efic√°cia</a></li>
<li><a href="../pt432178/index.html">... e uma garantia para os projetores - aumentar</a></li>
<li><a href="../pt432180/index.html">Como impulsionar sua carreira atrav√©s do GitHub</a></li>
<li><a href="../pt432182/index.html">Recolhemos correio sem sms e registo</a></li>
<li><a href="../pt432184/index.html">Identidades de problemas entre testadores</a></li>
<li><a href="../pt432186/index.html">Usando STP para criar canais p2p</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>