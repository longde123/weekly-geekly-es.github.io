<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèë üè∞ üëÜüèº Comprima a lista de endere√ßos IP da melhor maneira üÜó üôéüèæ üî´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma vez, li no Habr um artigo sobre a configura√ß√£o do BGP em um roteador. As instru√ß√µes de l√° podem ser usadas para configurar o roteador dom√©stico, p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comprima a lista de endere√ßos IP da melhor maneira</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/438242/"><img src="https://habrastorage.org/webt/xb/cm/03/xbcm03j6a2yijqkxhzatkxq6xbw.jpeg"><br><br>  Uma vez, li no Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo</a> sobre a configura√ß√£o do BGP em um roteador.  As instru√ß√µes de l√° podem ser usadas para configurar o roteador dom√©stico, para que o tr√°fego para endere√ßos IP espec√≠ficos passe por outro canal.  No entanto, h√° um problema: a lista de endere√ßos IP pode ser muito grande. <br><br>  Al√©m das redes da lista, as maiores sub-redes comuns de redes vizinhas s√£o adicionadas a este gr√°fico.  Leia sobre por que isso √© necess√°rio. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fh/pf/er/fhpfer-kqivtgto-agnozn9wpos.png"><br>  <i>Parecia uma √°rvore de rede de Roskomnadzor em maio de 2018.</i> <br><br>  Primeiro, tentei adicionar a lista inteira via / ip route add ao meu MikroTik hAP ac lite - o roteador ficou sem espa√ßo em disco.  Depois carreguei todos os endere√ßos na mem√≥ria atrav√©s do BGP - o roteador funcionou um pouco e travou.  Tornou-se √≥bvio que a lista precisava ser cortada. <br><br>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> menciona o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utilit√°rio</a> network-list-parser de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Unsacrificed</a> .  Ela faz o que eu preciso, mas eu a vi depois que comecei a inventar minha bicicleta.  Ent√£o terminei por desinteresse, porque o que fiz funciona melhor, embora muito mais devagar. <br><br>  Portanto, a declara√ß√£o do problema: voc√™ precisa escrever um script que use uma lista de endere√ßos IP e redes como entrada e encurte-o para o tamanho especificado.  Nesse caso, a nova lista deve abranger todos os endere√ßos da antiga e o n√∫mero de novos endere√ßos for√ßados a serem adicionados a ela deve ser m√≠nimo. <br><br>  Vamos come√ßar criando um gr√°fico de todas as redes de origem (o que est√° na figura acima).  O n√≥ raiz ser√° a rede 0.0.0.0/0.  Ao adicionar uma nova sub-rede A, encontramos a sub-rede B na √°rvore, para que A e B estejam na sub-rede C e o tamanho da sub-rede C seja m√≠nimo (m√°scara m√°xima).  Em outras palavras, o n√∫mero de bits comuns das sub-redes A e B deve ser m√°ximo.  Adicionamos essa sub-rede comum √† √°rvore e, por dentro, transferimos as sub-redes A e B. Talvez isso possa ser chamado de √°rvore bin√°ria. <br><br>  Por exemplo, crie uma √°rvore de duas sub-redes (192.168.0.1/32 e 192.168.33.0/24): <br><br><img src="https://habrastorage.org/webt/5d/ts/tx/5dtstx3shvofo6npuytk5n0kcto.png"><br><br>  Pegue a √°rvore: <br><br><img src="https://habrastorage.org/webt/la/5b/ej/la5bejewneridokbs_-fkahmz1y.png"><br><br>  Se adicionarmos, digamos, a rede 192.168.150.150/32, a √°rvore ficar√° assim: <br><br><img src="https://habrastorage.org/webt/-r/yp/om/-rypomiatbn-l5hlfq86wzcgal8.png"><br><br>  Laranja indica sub-redes comuns adicionadas durante a constru√ß√£o da √°rvore.  S√£o essas sub-redes comuns que "recolheremos" para reduzir o tamanho da lista.  Por exemplo, se voc√™ recolher o n√≥ 192.168.0.0/16, reduziremos o tamanho da lista de redes em 2 (havia 3 redes da lista original, ela se tornou 1), mas, ao mesmo tempo, cobrimos adicionalmente 65536-1-1-256 = 65278 endere√ßos IP, que n√£o inclu√≠do em nossa lista original. <br><br>  √â conveniente que cada n√≥ calcule o "coeficiente de lucro do colapso", mostrando o n√∫mero de endere√ßos IP que ser√£o adicionados adicionalmente a cada uma das entradas exclu√≠das da lista: <br><br><pre><code class="plaintext hljs">weight_reversed = net_extra_ip_volume / (in_list_records_count - 1)</code> </pre> <br>  Usaremos weight = 1 / weight_reversed, como  √© mais conveniente.  √â curioso que o peso possa ser igual ao infinito se, por exemplo, houver duas / 32 redes na lista, que juntas formam uma rede / 31 grande. <br><br>  Assim, quanto maior o peso, mais lucrativo √© o colapso dessa rede. <br><br>  Agora voc√™ pode calcular o peso para todos os n√≥s da rede, classificar os n√≥s por peso e recolher as sub-redes at√© obtermos o tamanho da lista de que precisamos.  No entanto, existe uma dificuldade: no momento em que colapsamos uma rede, os pesos de todas as redes pai mudam. <br><br>  Por exemplo, temos uma √°rvore com pesos calculados: <br><br><img src="https://habrastorage.org/webt/mn/wd/60/mnwd60e30yeamoqjg3veobslqcc.png"><br><br>  Vamos recolher a sub-rede 192.168.0.0/30: <br><br><img src="https://habrastorage.org/webt/3q/zf/tm/3qzftmtvi-ctpw9_ebniki7cvkm.png"><br><br>  O peso do n√≥ pai diminuiu.  Se houver n√≥s na √°rvore com um peso maior que 0,166, o seguinte dever√° ser recolhido. <br><br>  Como resultado, a lista deve ser compactada recursivamente.  O algoritmo √© algo como isto: <br><br><ol><li>  Calculamos os pesos para todos os n√≥s. </li><li>  Para cada n√≥, armazene o peso m√°ximo do n√≥ filho (Wmax). </li><li>  Acontece que Wmax do n√≥ raiz √© o peso m√°ximo do n√≥ em toda a √°rvore (pode haver v√°rios n√≥s com um peso igual a Wmax). </li><li>  Comprima recursivamente todas as redes com um peso igual a Wmax do n√≥ raiz.  Nesse caso, recalculamos o peso.  Retornamos ao n√≥ raiz. </li><li>  O Wmax do n√≥ raiz diminuiu - realizamos a etapa 4 at√© obter o tamanho desejado da lista de redes. </li></ol><br>  O mais interessante √© observar o algoritmo em movimento.  Aqui est√° um exemplo para uma lista de redes: <br><br> <code>192.168.0.1 <br> 192.168.0.2 <br> 192.168.0.8/29 <br> 192.168.150.1 <br> 192.168.150.2 <br> 192.168.150.8/29 <br> 192.168.20.1 <br> 192.168.20.2 <br> 192.168.20.3 <br> 192.168.20.4 <br> 192.168.20.5 <br> 192.168.20.6 <br> 192.168.20.7</code> <br> <br>  Aqui, as sub-redes 192.168.0.0/24 e 192.168.150.0/24 s√£o id√™nticas na estrutura - √© melhor ver como o algoritmo salta de um ramo para outro durante a compacta√ß√£o.  Ele adicionou a sub-rede 192.168.20.0/24 para mostrar que √†s vezes √© mais lucrativo compactar a rede pai do que a rede filha.  Preste aten√ß√£o √† sub-rede 192.168.20.0/30: ap√≥s o preenchimento da √°rvore, seu peso √© menor que o da sub-rede pai. <br><br>  Enchimento de √°rvore: <br><br><img src="https://habrastorage.org/webt/db/7y/od/db7yodt6w5mvgq_rvxxoe5k4lq8.gif"><br><br>  Aqui, a fonte preta √© a rede real da lista original.  Redes adicionadas em amarelo.  Azul √© o peso do n√≥.  Vermelho √© a rede atual.  Rosa √© uma rede colapsada. <br><br>  Compress√£o <br><br><img src="https://habrastorage.org/webt/wp/wr/0j/wpwr0j57ms67jp4xdpmhzjkpnpy.gif"><br><br>  Havia uma id√©ia para acelerar o algoritmo de colapso da rede: para isso, n√£o √© necess√°rio recolher apenas redes com peso m√°ximo a cada itera√ß√£o.  Voc√™ pode pr√©-selecionar o valor do peso, o que fornecer√° uma lista do tamanho desejado.  Voc√™ pode selecionar por pesquisa bin√°ria, ou seja,  comprima com um certo peso e veja qual tamanho da lista √© obtido na sa√≠da.  √â verdade que, para isso, voc√™ precisa do dobro da mem√≥ria e reescreve o c√≥digo - eu simplesmente n√£o consegui colocar minhas m√£os nele. <br><br>  Agora resta comparar com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">analisador</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista de rede</a> do artigo sobre BGP. <br><br>  Pr√≥s do meu script: <br><br><ol><li>  Configura√ß√£o mais conveniente: basta especificar o tamanho necess√°rio da lista de redes e a sa√≠da ser√° uma lista exatamente desse tamanho.  O analisador de lista de rede possui muitos identificadores, e voc√™ precisa encontrar uma combina√ß√£o deles. </li><li>  A taxa de compacta√ß√£o se adapta √† lista original.  Se removermos algumas redes da lista, obteremos menos endere√ßos adicionais, se adicionarmos mais.  Nesse caso, o tamanho da lista resultante ser√° constante.  Voc√™ pode escolher o tamanho m√°ximo que o roteador pode suportar e n√£o se preocupar com o aumento da lista em algum momento. </li><li>  A lista resultante cont√©m o n√∫mero m√≠nimo poss√≠vel de redes adicionais.  Na lista de testes do GitHub, meu algoritmo forneceu 718479 endere√ßos IP adicionais e analisador de lista de rede - 798761. <b>A diferen√ßa √© de apenas 10%</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Como eu calculei isso?</b>  <b class="spoiler_title">Assistindo</b> <div class="spoiler_text">  1. Lan√ßamento <br><br><pre> <code class="plaintext hljs"> ./network-list-parser-darwin-386-1.2.bin -src-file real_net_list_example.txt -dst-file parsed.txt -aggregation-max-fake-ips 0 -intensive-aggregation-min-prefix 31 2&gt;&amp;1</code> </pre> <br>  e temos uma lista limpa sem lixo e parcialmente reduzida.  Vou comparar a qualidade da compacta√ß√£o do parsed.txt.  (sem esta etapa, houve problemas ao avaliar quantos IPs falsos adiciona o analisador de lista de rede). <br><br>  2. Lan√ßamento <br><br><pre> <code class="plaintext hljs">./network-list-parser-darwin-386-1.2.bin -src-file parsed.txt -dst-file parsed1.txt 2&gt;&amp;1</code> </pre> <br>  e temos uma lista compactada, observe a sa√≠da, existe a linha "Adicione 7,3% de cobertura de IPs (798761)". <br><br>  O arquivo parsed1.txt possui 16649 entradas. <br><br>  3. Lan√ßamento <br><br>  python3 minimize_net_list.py parsed.txt 16649. <br>  Vemos a linha ### ips n√£o reais: 718479. <br></div></div><br></li></ol><br>  Eu vejo apenas uma desvantagem do script resultante: ele funciona por um longo tempo e requer muita mem√≥ria.  No meu MacBook, a lista √© pressionada por 5 segundos.  Em framboesa - <b>um minuto e meio</b> .  Com o RyPy3 no Mac, √© mais r√°pido, n√£o consegui colocar o PyPy3 no Raspberry.  O analisador de lista de rede voa para l√° e para l√°. <br><br>  Em geral, faz sentido usar esse esquema apenas para perfeccionistas, uma vez que  √© improv√°vel que todos os outros gastem tantos recursos de computa√ß√£o em benef√≠cio de 10% das redes salvas.  Bem, um pouco mais conveniente, sim. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para o projeto no GitHub</a> <br><br>  Execute assim: <br><br><pre> <code class="plaintext hljs">python3 minimize_net_list.py real_net_list_example.txt 30000 | grep -v ### &gt; result.txt</code> </pre> <br>  Isso, de fato, √© tudo. <br><br>  <b>UPD</b> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Pochemuk</a> nos coment√°rios indicou um erro no c√°lculo do peso, eu o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">corrigi</a> e agora, ao compactar a mesma lista do exemplo com as mesmas configura√ß√µes, s√£o adicionados 624925 endere√ßos IP que n√£o est√£o na lista original.  Isso j√° √© <b>22% melhor do</b> que ao processar o analisador de lista de rede <br>  Novo c√≥digo no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/phoenix-mstu/net_list_minimizer/tree/untested</a> branch </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438242/">https://habr.com/ru/post/pt438242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438230/index.html">Tradu√ß√£o "Prepare seus aplicativos para requisitos de 64 bits"</a></li>
<li><a href="../pt438234/index.html">Fevereiro IT Events Digest</a></li>
<li><a href="../pt438236/index.html">Conflu√™ncia para uma base de conhecimento p√∫blica: altere o design e configure a separa√ß√£o de idiomas</a></li>
<li><a href="../pt438238/index.html">Como designer, eu me recuso a chamar as pessoas de "usu√°rios"</a></li>
<li><a href="../pt438240/index.html">Teste de carga de CPU e SSD de hosts da nuvem: compare Selectel, Servers, MCS e I. Cloud</a></li>
<li><a href="../pt438244/index.html">Lidamos com os regulamentos criptogr√°ficos russos ... usando o exemplo da pris√£o de um traficante</a></li>
<li><a href="../pt438248/index.html">Vida de A√ß√£o do GitHub</a></li>
<li><a href="../pt438250/index.html">A ignor√¢ncia dos princ√≠pios de seguran√ßa da informa√ß√£o n√£o isenta</a></li>
<li><a href="../pt438252/index.html">Por que n√£o decolou do portal imobili√°rio. Parte 1</a></li>
<li><a href="../pt438254/index.html">Eclipse lan√ßa o GlassFish 5.1 para Java EE 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>