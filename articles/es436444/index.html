<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåø üë®üèΩ‚Äçüç≥ üíí Despliegue invisible de una aplicaci√≥n monol√≠tica en producci√≥n en AWS. Experiencia personal ‚öñÔ∏è üöû üíì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Soy ingeniero jefe de DevOps en Miro (ex-RealtimeBoard). Compartir√© c√≥mo nuestro equipo de DevOps resolvi√≥ el problema de las versiones diarias del se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Despliegue invisible de una aplicaci√≥n monol√≠tica en producci√≥n en AWS. Experiencia personal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/436444/">  Soy ingeniero jefe de DevOps en Miro (ex-RealtimeBoard).  Compartir√© c√≥mo nuestro equipo de DevOps resolvi√≥ el problema de las versiones diarias del servidor de una aplicaci√≥n con estado monol√≠tico y las hizo autom√°ticas, invisibles para los usuarios y convenientes para sus propios desarrolladores. <br><br><h2>  Nuestra infraestructura </h2><br>  Nuestro equipo de desarrollo est√° compuesto por 60 personas que se dividen en equipos Scrum, entre los cuales tambi√©n est√° el equipo DevOps.  La mayor√≠a de los comandos Scrum admiten la funcionalidad actual del producto y presentan nuevas caracter√≠sticas.  La tarea de DevOps es crear y mantener una infraestructura que ayude a la aplicaci√≥n a trabajar de manera r√°pida y confiable y permita a los equipos ofrecer r√°pidamente nuevas funcionalidades a los usuarios. <br><img src="https://habrastorage.org/webt/sh/f-/qy/shf-qy6dzbfvuzonf4h5yf5iupk.png"><br><a name="habracut"></a><br><br>  Nuestra aplicaci√≥n es un tablero en l√≠nea sin fin.  Consta de tres capas: un sitio, un cliente y un servidor en Java, que es una aplicaci√≥n monol√≠tica con estado.  La aplicaci√≥n mantiene una conexi√≥n de socket web constante con los clientes, y cada servidor mantiene en memoria un cach√© de placas abiertas. <br><br>  Toda la infraestructura, m√°s de 70 servidores, se encuentra en Amazon: m√°s de 30 servidores con nuestra aplicaci√≥n Java, servidores web, servidores de bases de datos, corredores y mucho m√°s.  Con el crecimiento de la funcionalidad, todo esto debe actualizarse regularmente, sin interrumpir el trabajo de los usuarios. <br>  Actualizar el sitio y el cliente es simple: reemplazamos la versi√≥n anterior por una nueva, y la pr√≥xima vez que el usuario acceda a un nuevo sitio y a un nuevo cliente.  Pero si hacemos esto cuando se lanza el servidor, tenemos tiempo de inactividad.  Para nosotros, esto es inaceptable, porque el valor principal de nuestro producto es el trabajo conjunto de los usuarios en tiempo real. <br><br><h2>  C√≥mo se ve nuestro proceso de CI / CD </h2><br>  El proceso de CI / CD con nosotros es git commit, git push, luego ensamblaje autom√°tico, pruebas autom√°ticas, implementaci√≥n, lanzamiento y monitoreo. <br><br><img src="https://habrastorage.org/webt/ok/se/rv/okservy5e1ai7rboli8mvgvrvh4.png"><br><br>  Para una integraci√≥n continua, utilizamos Bamboo y Bitbucket.  Para pruebas autom√°ticas (Java y Python y Allure) para mostrar los resultados de las pruebas autom√°ticas.  Para entrega continua: Packer, Ansible y Python.  Todo el monitoreo se realiza utilizando ELK Stack, Prometheus y Sentry. <br><br>  Los desarrolladores escriben c√≥digo, lo agregan al repositorio, despu√©s de lo cual se inician el ensamblaje autom√°tico y las pruebas autom√°ticas.  Al mismo tiempo, dentro del equipo re√∫ne a otros desarrolladores y lleva a cabo la Revisi√≥n del C√≥digo.  Cuando todos los procesos requeridos, incluidas las pruebas autom√°ticas, se completan, el equipo mantiene la compilaci√≥n en la rama principal, y la construcci√≥n de la rama principal comienza y se env√≠a para pruebas autom√°ticas.  Todo el proceso es depurado y realizado por el equipo por s√≠ solo. <br><br><h2>  Imagen AMI </h2><br>  En paralelo con la compilaci√≥n de compilaci√≥n y las pruebas, se inicia la compilaci√≥n de la imagen AMI para Amazon.  Para hacer esto, utilizamos Packer de HashiCorp, una gran herramienta de c√≥digo abierto que le permite crear una imagen de una m√°quina virtual.  Todos los par√°metros se pasan a JSON con un conjunto de claves de configuraci√≥n.  El par√°metro principal es constructores, que indica para qu√© proveedor estamos creando la imagen (en nuestro caso, para Amazon). <br><br><pre><code class="plaintext hljs">"builders": [{ "type": "amazon-ebs", "access_key": "{{user `aws_access_key`}}", "secret_key": "{{user `aws_secret_key`}}", "region": "{{user `aws_region`}}", "vpc_id": "{{user `aws_vpc`}}", "subnet_id": "{{user `aws_subnet`}}", "tags": { "releaseVersion": "{{user `release_version`}}" }, "instance_type": "t2.micro", "ssh_username": "ubuntu", "ami_name": "packer-board-ami_{{isotime \"2006-01-02_15-04\"}}" }],</code> </pre> <br>  Es importante que no solo creemos una imagen de una m√°quina virtual, sino que la configuremos de antemano usando Ansible: instale los paquetes necesarios y realice los ajustes de configuraci√≥n para iniciar una aplicaci√≥n Java. <br><br><pre> <code class="plaintext hljs"> "provisioners": [{ "type": "ansible", "playbook_file": "./playbook.yml", "user": "ubuntu", "host_alias": "default", "extra_arguments": ["--extra_vars=vars"], "ansible_env_vars": ["ANSIBLE_HOST_KEY_CHECKING=False", "ANSIBLE_NOCOLOR=True"] }]</code> </pre><br><h2>  Ansible-roles </h2><br>  Sol√≠amos usar el libro de jugadas Ansible habitual, pero esto condujo a una gran cantidad de c√≥digo repetitivo, que se hizo dif√≠cil de mantener actualizado.  Cambiamos algo en un libro de jugadas, olvidamos hacerlo en otro y, como resultado, tuvimos problemas.  Entonces empezamos a usar Ansible-roles.  Los hicimos lo m√°s vers√°tiles posible para poder reutilizarlos en diferentes partes del proyecto y no sobrecargar el c√≥digo en grandes piezas repetidas.  Por ejemplo, utilizamos la funci√≥n de supervisi√≥n para todos los tipos de servidores. <br><br><pre> <code class="plaintext hljs">- name: Install all board dependencies hosts: all user: ubuntu become: yes roles: - java - nginx - board-application - ssl-certificates - monitoring</code> </pre><br>  Desde el lado de los equipos Scrum, este proceso parece lo m√°s simple posible: el equipo recibe notificaciones en Slack de que la construcci√≥n y la imagen AMI est√°n ensambladas. <br><br><h2>  Pre-lanzamientos </h2><br>  Introdujimos versiones preliminares para entregar cambios de productos a los usuarios lo m√°s r√°pido posible.  De hecho, se trata de versiones canarias que le permiten probar de forma segura nuevas funciones en un peque√±o porcentaje de usuarios. <br><br>  ¬øPor qu√© los lanzamientos se llaman canarios?  Anteriormente, los mineros, cuando descend√≠an a la mina, se llevaban un canario con ellos.  Si hab√≠a gas en la mina, el canario muri√≥ y los mineros salieron r√°pidamente a la superficie.  As√≠ sucede con nosotros: si algo sale mal con el servidor, entonces el lanzamiento no est√° listo y podemos retroceder r√°pidamente y la mayor√≠a de los usuarios no notar√°n nada. <br><br>  <strong>C√≥mo comienza la liberaci√≥n canaria:</strong> <br><ol><li>  El equipo de desarrollo de Bamboo hace clic en un bot√≥n -&gt; se llama una aplicaci√≥n Python que inicia el prelanzamiento. </li><li>  Crea una nueva instancia en Amazon a partir de una imagen AMI preparada con una nueva versi√≥n de la aplicaci√≥n. </li><li>  La instancia se agrega a los grupos objetivo y equilibradores de carga necesarios. </li><li>  Con Ansible, se configura una configuraci√≥n individual para cada instancia. </li><li>  Los usuarios est√°n trabajando con la nueva versi√≥n de la aplicaci√≥n Java. </li></ol><br>  En el lado de los comandos de Scrum, el proceso de lanzamiento previo al lanzamiento nuevamente parece lo m√°s simple posible: el equipo recibe notificaciones en Slack de que el proceso ha comenzado, y despu√©s de 7 minutos el nuevo servidor ya est√° en funcionamiento.  Adem√°s, la aplicaci√≥n env√≠a a Slack todo el registro de cambios de la versi√≥n. <br><br>  Para que esta barrera de verificaci√≥n de protecci√≥n y confiabilidad funcione, los equipos de Scrum monitorean nuevos errores en Sentry.  Esta es una aplicaci√≥n de seguimiento de errores de c√≥digo abierto en tiempo real.  Sentry se integra a la perfecci√≥n con Java y tiene conectores con logback y log2j.  Cuando se inicia la aplicaci√≥n, transferimos a Sentry la versi√≥n en la que se est√° ejecutando, y cuando se produce un error, vemos en qu√© versi√≥n de la aplicaci√≥n se produjo.  Esto ayuda a los equipos de Scrum a responder r√°pidamente a los errores y corregirlos r√°pidamente. <br><br>  El prelanzamiento deber√≠a funcionar durante al menos 4 horas.  Durante este tiempo, el equipo monitorea su trabajo y decide si lanzar√° la versi√≥n a todos los usuarios. <br><br>  <strong>Varios equipos pueden lanzar simult√°neamente sus lanzamientos</strong> .  Para hacer esto, acuerdan entre ellos qu√© entra en el prelanzamiento y qui√©n es responsable del lanzamiento final.  Despu√©s de eso, los equipos combinan todos los cambios en un prelanzamiento o lanzan varios lanzamientos previos al mismo tiempo.  Si todas las versiones preliminares son correctas, se lanzar√°n como una versi√≥n al d√≠a siguiente. <br><br><h2>  Lanzamientos </h2><br>  Hacemos un lanzamiento diario: <br><br><ol><li>  Introducimos nuevos servidores para trabajar. </li><li>  Monitoreamos la actividad del usuario en nuevos servidores usando Prometheus. </li><li>  Acceso cercano para nuevos usuarios a servidores antiguos. </li><li>  Transferimos usuarios de servidores antiguos a nuevos. </li><li>  Apaga el antiguo servidor. </li></ol><br>  Todo est√° construido con las aplicaciones Bamboo y Python.  La aplicaci√≥n verifica la cantidad de servidores en ejecuci√≥n y se prepara para lanzar la misma cantidad de servidores nuevos.  Si no hay suficientes servidores, se crean a partir de la imagen AMI.  Se implementa una nueva versi√≥n en ellos, se inicia una aplicaci√≥n Java y los servidores se ponen en funcionamiento. <br><br>  Al monitorear, la aplicaci√≥n Python que usa la API Prometheus verifica el n√∫mero de placas abiertas en los nuevos servidores.  Cuando comprende que todo funciona correctamente, cierra el acceso a los servidores antiguos y transfiere usuarios a los nuevos. <br><br><pre> <code class="plaintext hljs">import requests PROMETHEUS_URL = 'https://prometheus' def get_spaces_count(): boards = {} try: params = { 'query': 'rtb_spaces_count{instance=~"board.*"}' } response = requests.get(PROMETHEUS_URL, params=params) for metric in response.json()['data']['result']: boards[metric['metric']['instance']] = metric['value'][1] except requests.exceptions.RequestException as e: print('requests.exceptions.RequestException: {}'.format(e)) finally: return boards</code> </pre><br>  El proceso de transferencia de usuarios entre servidores se muestra en Grafana.  En la mitad izquierda del gr√°fico, los servidores que se ejecutan en la versi√≥n anterior se muestran, a la derecha, en la nueva.  La intersecci√≥n de gr√°ficos es el momento de la transferencia de usuarios. <br><br><img src="https://habrastorage.org/webt/zt/8l/df/zt8ldf8hmk39a7tzho9a_dt0gnq.png"><br><br>  El equipo supervisa el lanzamiento de Slack.  Despu√©s del lanzamiento, todo el registro de cambios se publica en un canal separado en Slack, y en Jira todas las tareas asociadas con este lanzamiento se cierran autom√°ticamente. <br><br><h3>  ¬øQu√© es la migraci√≥n de usuarios? </h3><br>  Almacenamos el estado de la pizarra en la que trabajan los usuarios, en la memoria de la aplicaci√≥n y guardamos constantemente todos los cambios en la base de datos.  Para transferir la placa en el nivel de interacci√≥n del cl√∫ster, la cargamos en la memoria del nuevo servidor y le enviamos al cliente un comando para que se vuelva a conectar.  En este punto, el cliente se desconecta del servidor anterior y se conecta al nuevo.  Despu√©s de un par de segundos, los usuarios ven la inscripci√≥n: se restableci√≥ la conexi√≥n.  Sin embargo, contin√∫an trabajando y no notan ning√∫n inconveniente. <br><br><img src="https://habrastorage.org/webt/8m/ie/ae/8mieaew94xjibv9emwf0gkrq1l8.png"><br><br><h2>  Lo que aprendimos al hacer invisible la implementaci√≥n </h2><br>  ¬øA qu√© hemos llegado despu√©s de una docena de iteraciones? <br><br><ul><li>  El equipo scrum verifica su c√≥digo por s√≠ mismo. </li><li>  El equipo de scrum decide cu√°ndo lanzar el prelanzamiento y llevar algunos de los cambios a los nuevos usuarios. </li><li>  Scrum-team decide si su lanzamiento est√° listo para todos los usuarios. </li><li>  Los usuarios contin√∫an trabajando y no notan nada. </li></ul><br>  Esto no fue posible de inmediato, pisamos el mismo rastrillo muchas veces y llenamos muchos conos.  Quiero compartir las lecciones que hemos recibido. <br><br>  <strong>Primero, el proceso manual, y solo luego su automatizaci√≥n.</strong>  Los primeros pasos no necesitan profundizar en la automatizaci√≥n, porque puede automatizar lo que al final no es √∫til. <br><br>  <strong>Ansible es bueno, pero los roles de Ansible son mejores.</strong>  Hicimos que nuestras funciones fueran lo m√°s universales posibles: nos deshicimos del c√≥digo repetitivo, por lo que solo tienen la funcionalidad que deber√≠an tener.  Esto le permite ahorrar significativamente tiempo reutilizando roles, que ya tenemos m√°s de 50. <br><br>  <strong>Reutilice el c√≥digo en Python y div√≠dalo en bibliotecas y m√≥dulos separados.</strong>  Esto lo ayuda a navegar proyectos complejos y sumergir r√°pidamente a nuevas personas en ellos. <br><br><h2>  Pr√≥ximos pasos </h2><br>  El proceso de implementaci√≥n invisible a√∫n no ha terminado.  Estos son algunos de los siguientes pasos: <br><br><ol><li>  Permitir que los equipos completen no solo prelanzamientos, sino todos los lanzamientos. </li><li>  Hacer retrocesos autom√°ticos en caso de errores.  Por ejemplo, una versi√≥n preliminar deber√≠a revertirse autom√°ticamente si se detectan errores cr√≠ticos en Sentry. </li><li>  Automatice completamente el lanzamiento en ausencia de errores.  Si no hubo errores en el prelanzamiento, significa que puede implementarse autom√°ticamente. </li><li>  Agregue escaneo autom√°tico de c√≥digo para detectar posibles errores de seguridad. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es436444/">https://habr.com/ru/post/es436444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436434/index.html">PVS-Studio para Java</a></li>
<li><a href="../es436436/index.html">El CERN planea construir un nuevo acelerador con una longitud de t√∫nel de 100 km.</a></li>
<li><a href="../es436438/index.html">Roscosmos llam√≥ a las posibles razones de la p√©rdida de comunicaci√≥n con el observatorio orbital Spektr-R</a></li>
<li><a href="../es436440/index.html">Gotta Go Fast: Building for Speed ‚Äã‚Äãen iOS. Parte 2</a></li>
<li><a href="../es436442/index.html">Una cabeza es buena y dos son mejores, o empareje la programaci√≥n en acci√≥n</a></li>
<li><a href="../es436448/index.html">Revise el monitor IPS de 27 "Acer HA270bid: para la superaci√≥n personal</a></li>
<li><a href="../es436450/index.html">Telecontrol y control, libertad y gobierno. Conversaci√≥n con Staply</a></li>
<li><a href="../es436452/index.html">7 √°reas de desarrollo de Linux en 2019</a></li>
<li><a href="../es436454/index.html">Preguntas y respuestas de JavaScript</a></li>
<li><a href="../es436456/index.html">Crea un efecto de distribuci√≥n de color en Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>