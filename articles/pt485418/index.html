<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÖ üßõüèø üë∂üèΩ PHPUnit. "Como fa√ßo para testar meu maldito controlador" ou testar se h√° d√∫vidas üë©üèø‚Äçüåæ üëü üïß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr. 



 Sim, este √© outro post sobre o t√≥pico de teste. Parece que aqui j√° √© poss√≠vel discutir? Todos que precisam - escrevem testes, que n√£o pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHPUnit. "Como fa√ßo para testar meu maldito controlador" ou testar se h√° d√∫vidas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485418/">  Oi Habr. <br><br><img src="https://habrastorage.org/webt/do/li/as/doliasx6rmfzgqhvfc-7jdazq-w.jpeg" alt="imagem"><br><br>  Sim, este √© outro post sobre o t√≥pico de teste.  Parece que aqui j√° √© poss√≠vel discutir?  Todos que precisam - escrevem testes, que n√£o precisam - eles n√£o escrevem, todos est√£o felizes!  O fato √© que a maioria dos posts sobre testes de unidade tem ... como ofender ningu√©m ... exemplos idiotas!  S√©rio, n√£o!  Hoje vou tentar consertar.  Eu pe√ßo gato. <br><a name="habracut"></a><br>  Assim, a pesquisa r√°pida no t√≥pico de testes encontra apenas muitos artigos, que em sua maioria s√£o divididos em duas categorias: <br><br>  1) A felicidade de um redator.  Primeiro, vemos uma longa introdu√ß√£o, depois a hist√≥ria dos testes de unidade na R√∫ssia antiga, depois dez hacks de vida com testes e, no final, um exemplo.  Com testes de c√≥digo como este: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Calculator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $a + $b; } }</code> </pre> <br>  E eu n√£o estou brincando agora.  Eu realmente vi artigos com uma "calculadora" como um guia de estudo.  Sim, sim, entendo que, para come√ßar, √© necess√°rio simplificar tudo, abstra√ß√µes, e para tr√°s ... Mas √© aqui que tudo acaba!  E ent√£o termine a coruja, como eles dizem <br><br>  2) Exemplos excessivamente sofisticados.  Vamos escrever um teste e coloc√°-lo no CI do Gitlab. Em seguida, corrigiremos automaticamente se o teste for aprovado e aplicaremos a infec√ß√£o pelo PHP aos testes, mas conectaremos tudo ao Hudson.  E assim por diante nesse estilo.  Parece ser √∫til, mas parece que n√£o √© exatamente o que voc√™ est√° procurando.  Mas voc√™ s√≥ quer aumentar um pouco a estabilidade do seu projeto.  E todas essas continuidades - bem, ent√£o, n√£o de uma s√≥ vez. <br><br>  Como resultado, as pessoas duvidam: "Mas eu preciso disso".  Por sua vez, quero tentar explicar mais claramente os testes.  E fa√ßa uma reserva imediatamente - sou desenvolvedor, n√£o sou testador.  Tenho certeza de que eu mesmo n√£o sei muito, e minha primeira palavra na minha vida n√£o foi a palavra "mok".  Eu nunca trabalhei em TDD!  Mas tenho certeza de que mesmo meu n√≠vel atual de habilidades me permitiu cobrir v√°rios projetos com testes, e esses mesmos testes j√° detectaram uma d√∫zia de bugs.  E se isso me ajudasse, poderia ajudar outra pessoa.  Alguns erros detectados seriam dif√≠ceis de detectar manualmente. <br><br>  Para come√ßar, um pequeno programa educacional no formato de perguntas e respostas: <br><br>  P: Preciso usar algum tipo de estrutura?  E se eu tiver o Yii?  E se Kohana?  E se% one_more_framework_name%? <br>  R: N√£o, o PHPUnit √© uma estrutura de teste independente, voc√™ pode at√© parafus√°-la no c√≥digo legado em uma estrutura criada por voc√™. <br><br>  P: E agora estou rapidamente navegando pelo site com minhas m√£os, e isso √© normal.  Por que eu preciso disso? <br>  R: A execu√ß√£o de v√°rias dezenas de testes dura v√°rios segundos.  O teste autom√°tico √© sempre mais r√°pido que o manual e, com testes de alta qualidade, tamb√©m √© mais confi√°vel, pois abrange todos os cen√°rios. <br><br>  P: Eu tenho um c√≥digo legado com fun√ß√µes de 2000 linhas.  Posso testar isso? <br>  A: Sim e n√£o.  Em teoria, sim, qualquer c√≥digo pode ser coberto com um teste.  Na pr√°tica, o c√≥digo deve ser escrito com uma base para testes futuros.  Uma fun√ß√£o de linha 2000 ter√° muitas depend√™ncias, ramifica√ß√µes, casos de borda.  Pode acabar cobrindo tudo no final, mas provavelmente levar√° um tempo inaceitavelmente longo.  Quanto melhor o c√≥digo, mais f√°cil √© test√°-lo.  Quanto melhor a responsabilidade √∫nica for respeitada, mais f√°ceis ser√£o os testes.  Para testar projetos antigos com mais freq√º√™ncia, primeiro √© necess√°rio refator√°-los com frieza. <br><br><img src="https://habrastorage.org/webt/c5/oa/ze/c5oaze8gmau8ticskgu44o5wyza.jpeg" alt="imagem"><br><br>  P: Eu tenho m√©todos muito simples (fun√ß√µes), o que h√° para testar?  Tudo √© confi√°vel l√°, n√£o h√° espa√ßo para erro! <br>  R: Deve-se entender que voc√™ n√£o testa a implementa√ß√£o correta da fun√ß√£o (se voc√™ n√£o possui TDD), simplesmente "corrige" seu estado atual de trabalho.  No futuro, quando precisar alter√°-lo, voc√™ poder√° determinar rapidamente se quebrou o comportamento usando o teste.  Exemplo: existe uma fun√ß√£o que valida o email.  Ela faz isso regularmente. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($email)</span></span></span><span class="hljs-function"> </span></span>{ $regex = <span class="hljs-string"><span class="hljs-string">"very_complex_regex_here"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($email)) { $result = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($email <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $item) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preg_match($regex, $item) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $result = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $result = preg_match($regex, $emai) ==! <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; }</code> </pre><br>  Todo o seu c√≥digo espera que, se voc√™ passar um email v√°lido para essa fun√ß√£o, ele retornar√° verdadeiro.  Uma matriz de e-mails v√°lidos tamb√©m √© verdadeira.  Uma matriz com pelo menos um endere√ßo de email inv√°lido √© falsa.  Bem e assim por diante, o c√≥digo √© claro.  Mas chegou o dia e voc√™ decidiu substituir a monstruosa temporada regular por uma API externa.  Mas como garantir que a fun√ß√£o reescrita n√£o mudou o princ√≠pio de opera√ß√£o?  De repente, ele n√£o lida bem com a matriz?  Ou retornar√° n√£o booleano?  E os testes podem manter isso sob controle.  Um teste bem escrito indicar√° imediatamente um comportamento de fun√ß√£o diferente do esperado. <br><br>  P: Quando come√ßarei a perceber algum sentido nos testes? <br>  R: Em primeiro lugar, assim que voc√™ cobrir uma parte significativa do c√≥digo.  Quanto mais pr√≥xima a cobertura estiver de 100%, mais confi√°vel ser√° o teste.  Em segundo lugar, assim que voc√™ precisar fazer altera√ß√µes globais ou altera√ß√µes na parte complexa do c√≥digo.  Os testes podem detectar problemas facilmente perdidos manualmente (casos lim√≠trofes).  Em terceiro lugar, ao escrever os pr√≥prios testes!  Muitas vezes, h√° uma situa√ß√£o ao escrever um teste, que revela falhas de c√≥digo que n√£o s√£o vis√≠veis √† primeira vista. <br><br>  P: Bem, eu tenho um site no laravel.  O site n√£o √© uma fun√ß√£o, o site √© uma montanha de c√≥digo de merda.  Como testar aqui? <br>  A: Isto √© o que ser√° discutido mais adiante.  Em resumo: testamos separadamente os m√©todos dos controladores, separadamente o middleware, separadamente os servi√ßos, etc. <br><br>  Uma das id√©ias do teste de unidade √© isolar a se√ß√£o de c√≥digo testada.  Quanto menos c√≥digo voc√™ testar com um teste, melhor.  Vejamos um exemplo o mais pr√≥ximo poss√≠vel da vida real: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userService, $emailService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userService = $userService; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emailService = $emailService; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($request-&gt;login) || <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($request-&gt;password)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Auth error"</span></span>; } $password = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userService-&gt;getPasswordFor($request-&gt;login); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($password)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Auth error - no password"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($password !== $request-&gt;password) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Incorrect password"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emailService-&gt;sendEmail($request-&gt;login); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Success"</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">// .... /* somewhere in project core */ $controller = new Controller($userService, $emailService); $controller-&gt;login($request);</span></span></code> </pre> <br>  Esse √© um m√©todo muito t√≠pico de efetuar login no sistema em pequenos projetos.  Tudo o que esperamos s√£o as mensagens de erro corretas e o email enviado no caso de um login bem-sucedido.  Como testar esse m√©todo?  Primeiro, voc√™ precisa identificar depend√™ncias externas.  No nosso caso, existem dois deles - $ userService e $ emailService.  Eles s√£o passados ‚Äã‚Äãpelo construtor de classe, o que facilita muito nossa tarefa.  Mas, como mencionado anteriormente, quanto menos c√≥digo testamos em uma passagem, melhor. <br><br>  Emula√ß√£o, substitui√ß√£o de objetos √© chamada mokanem (do ingl√™s. Mock objeto, literalmente: "par√≥dia de objeto").  Ningu√©m se preocupa em escrever esses objetos manualmente, mas tudo j√° foi inventado diante de n√≥s, de modo que uma biblioteca maravilhosa como <a href="https://github.com/mockery/mockery" rel="nofollow">Mockery</a> vem em socorro.  Vamos criar mokas para servi√ßos. <br><br><pre> <code class="php hljs">$userService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'user_service'</span></span>); $emailService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'email_service'</span></span>);</code> </pre> <br>  Agora crie o objeto $ request.  Para come√ßar, testaremos a l√≥gica de verificar os campos de login e senha.  Queremos ter certeza de que, se n√£o houver, nosso m√©todo manipular√° corretamente esse caso e retornar√° a mensagem (!) Desejada. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEmptyLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $userService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'user_service'</span></span>); $emailService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'email_service'</span></span>); $controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Controller($userService, $emailService); $request = (object) []; $result = $controller-&gt;login($request); }</code> </pre><br>  Nada complicado, certo?  Criamos stubs para os par√¢metros de classe necess√°rios, criamos uma inst√¢ncia da classe desejada e "extra√≠mos" o m√©todo desejado, passando uma solicita√ß√£o deliberadamente errada.  Tenho uma resposta.  Mas como verificar agora?  Esta √© a parte mais importante do teste - a chamada afirma√ß√£o.  O PHPUnit possui dezenas de <a href="https://phpunit.readthedocs.io/ru/latest/assertions.html" rel="nofollow">asser√ß√µes</a> prontas.  Basta usar um deles. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEmptyLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $userService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'user_service'</span></span>); $emailService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'email_service'</span></span>); $controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Controller($userService, $emailService); $request = (object) []; $result = $controller-&gt;login($request); <span class="hljs-comment"><span class="hljs-comment">// vv assertion here! vv $this-&gt;assertEquals("Auth error", $result); }</span></span></code> </pre><br>  Este teste garante o seguinte - se o argumento de login chegar ao objeto de m√©todo que n√£o possui o campo de login ou senha, o m√©todo retornar√° a string "Erro de autentica√ß√£o".  Isso, em geral, √© tudo.  T√£o simples - mas t√£o √∫til, porque agora podemos editar o m√©todo de login sem medo de quebrar algo.  Nosso front-end pode ter certeza de que, se algo acontecer - ele receber√° esse erro.  E se algu√©m quebrar esse comportamento (por exemplo, decidir alterar o texto do erro), o teste imediatamente sinalizar√° isso!  Adicionamos as verifica√ß√µes restantes para cobrir o maior n√∫mero poss√≠vel de cen√°rios. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEmptyPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $userService = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'user_service'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// $userService-&gt;getPasswordFor(__any__arg__); // '' $userService-&gt;shouldReceive('getPasswordFor')-&gt;andReturn(''); $emailService = Mockery::mock('email_service'); $request = (object) [ 'login' =&gt; 'john', 'pass' =&gt; '1234' ]; $result = (new Controller($userService, $emailService))-&gt;login($request); $this-&gt;assertEquals("Auth error - no password", $result); } function testUncorrectPassword() { $userService = Mockery::mock('user_service'); // $userService-&gt;getPasswordFor(__any__arg__); // '4321' $userService-&gt;shouldReceive('getPasswordFor')-&gt;andReturn('4321'); $emailService = Mockery::mock('email_service'); $request = (object) [ 'login' =&gt; 'john', 'pass' =&gt; '1234' ]; $result = (new Controller($userService, $emailService))-&gt;login($request); $this-&gt;assertEquals("Incorrect password", $result); } function testSuccessfullLogin() { $userService = Mockery::mock('user_service'); // $userService-&gt;getPasswordFor(__any__arg__); // '1234' $userService-&gt;shouldReceive('getPasswordFor')-&gt;andReturn('1234'); $emailService = Mockery::mock('email_service'); $request = (object) [ 'login' =&gt; 'john', 'pass' =&gt; '1234' ]; $result = (new Controller($userService, $emailService))-&gt;login($request); $this-&gt;assertEquals("Success", $result); }</span></span></code> </pre><br>  Observe os m√©todos shouldReceive e andReturn?  Eles nos permitem criar m√©todos em stubs que retornam apenas o que precisamos.  Precisa testar o erro de senha errado?  N√≥s escrevemos um stub $ userService que sempre retorna a senha errada.  E √© isso. <br><br>  E quanto √†s depend√™ncias, voc√™ pergunta.  N√≥s ent√£o os "afogamos", e se eles quebrarem?  Mas √© exatamente para isso que serve a cobertura m√°xima de c√≥digo nos testes.  N√£o verificaremos a opera√ß√£o desses servi√ßos no contexto do logon - testaremos o logon na esperan√ßa da opera√ß√£o correta dos servi√ßos.  E ent√£o escrevemos os mesmos testes isolados para esses servi√ßos.  E depois testa suas depend√™ncias.  E assim por diante  Como resultado, cada teste individual garante <b>apenas a</b> opera√ß√£o correta de um pequeno peda√ßo de c√≥digo, desde que todas as suas depend√™ncias funcionem corretamente.  E como todas as depend√™ncias tamb√©m s√£o cobertas por testes, sua opera√ß√£o correta tamb√©m √© garantida.  Como resultado, qualquer altera√ß√£o no sistema que interrompa a l√≥gica do trabalho, mesmo o menor peda√ßo de c√≥digo, aparecer√° imediatamente em um teste espec√≠fico.  Como especificamente executar o teste - n√£o vou contar, a documenta√ß√£o no PHPUnit √© muito boa.  E no Laravel, por exemplo, basta executar vendor / bin / phpunit a partir da raiz do projeto para ver uma mensagem como esta <br><br><img src="https://habrastorage.org/webt/va/bc/co/vabccob2dpo9xiqk7ek9syxinmo.jpeg" alt="imagem">  - Todos os testes foram bem sucedidos.  Ou algo assim <br><br><img src="https://habrastorage.org/webt/bh/mc/pu/bhmcpuar0iluxa8nxxmwrkdgvqs.jpeg" alt="imagem">  Uma das sete afirma√ß√µes falhou. <br><br>  "Isso, √© claro, √© legal, mas em que n√£o consigo colocar minhas m√£os?", Voc√™ pergunta.  E vamos imaginar o seguinte c√≥digo para este <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($infoApi, $userName)</span></span></span><span class="hljs-function"> </span></span>{ $response = $infoApi-&gt;getInfo($userName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($response-&gt;status === <span class="hljs-string"><span class="hljs-string">"API Error"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response-&gt;result; } <span class="hljs-comment"><span class="hljs-comment">// ... somewhere in system $api = new ExternalApi(); $info = getInfo($api, 'John'); if ($info === null) { die('Api is down'); } echo $info;</span></span></code> </pre><br>  Vemos um modelo simplificado de trabalho com uma API externa.  A fun√ß√£o usa alguma classe para trabalhar com a API e, em caso de erro, retorna nulo.  Se, ao usar esta fun√ß√£o, ficarmos nulos, devemos "aumentar o p√¢nico" (enviar uma mensagem para a folga, enviar um e-mail ao desenvolvedor ou lan√ßar um erro no kibana. Sim, v√°rias op√ß√µes).  Tudo parece ser simples, certo?  Mas imagine que depois de algum tempo outro desenvolvedor decidiu "consertar" essa fun√ß√£o.  Ele decidiu que retornar nulo √© o s√©culo passado, e ele deveria lan√ßar uma exce√ß√£o. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($infoApi, $userName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $response = $infoApi-&gt;getInfo($userName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($response-&gt;status === <span class="hljs-string"><span class="hljs-string">"API Error"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiException($response); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response-&gt;result; }</code> </pre><br>  E ele at√© reescreveu todas as se√ß√µes do c√≥digo em que essa fun√ß√£o foi chamada!  Todos menos um.  Ele sentia falta dele.  Distra√≠do, cansado, errado - mas voc√™ nunca sabe.  O fato √© que um peda√ßo de c√≥digo ainda est√° aguardando o antigo comportamento da fun√ß√£o.  E o PHP n√£o √© Java para n√≥s - n√£o receberemos um erro de compila√ß√£o com o argumento de que a fun√ß√£o jog√°vel n√£o est√° envolvida no try-catch.  Como resultado, em um dos 100 cen√°rios de uso do site, no caso de uma queda da API, n√£o receberemos uma mensagem do sistema.  Al√©m disso, com o teste manual, provavelmente n√£o capturaremos esta vers√£o do evento.  A API √© externa, n√£o depende de n√≥s, funciona bem - e, provavelmente, n√£o colocaremos nossas m√£os em caso de falha da API e tratamento incorreto de exce√ß√µes.  Por√©m, se tivermos testes, eles entender√£o muito bem esse caso, porque a classe ExternalApi √© "abafada" em v√°rios testes e emula o comportamento normal e a falha.  E o pr√≥ximo teste vai cair <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testApiFail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $api = Mockery::mock(<span class="hljs-string"><span class="hljs-string">'api'</span></span>); $api-&gt;shouldReceive(<span class="hljs-string"><span class="hljs-string">'getInfo'</span></span>)-&gt;andReturn((object) [ <span class="hljs-string"><span class="hljs-string">'status'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'API Error'</span></span> ]); $result = getInfo($api, <span class="hljs-string"><span class="hljs-string">'name'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertNull($result); }</code> </pre><br>  Esta informa√ß√£o √© realmente suficiente.  Se voc√™ n√£o tiver macarr√£o herdado, depois de 20 a 30 minutos, poder√° escrever seu primeiro teste.  E algumas semanas depois - para aprender algo novo, legal, retorne aos coment√°rios neste post e escreva qual autor o govnokoder n√£o conhece sobre% framework_name% e escreve testes ruins, mas voc√™ precisa fazer% this_way%.  E ficarei muito feliz nesse caso.  Isso significa que meu objetivo foi alcan√ßado: algu√©m descobriu o teste por si mesmo e aumentou um pouco o n√≠vel geral de profissionalismo em nosso campo! <br><br>  Cr√≠ticas fundamentadas s√£o bem-vindas. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485418/">https://habr.com/ru/post/pt485418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485394/index.html">Como nasceu a infraestrutura da Internet</a></li>
<li><a href="../pt485396/index.html">Verifica√ß√£o de integridade do esquadr√£o: medindo a sa√∫de da equipe</a></li>
<li><a href="../pt485398/index.html">Antipatterns do PostgreSQL: acerte o dicion√°rio pesado JOIN</a></li>
<li><a href="../pt485404/index.html">Percebemos o efeito visual do filme "The Matrix"</a></li>
<li><a href="../pt485416/index.html">Maneiras pr√°ticas de mapear dados no Kotlin</a></li>
<li><a href="../pt485424/index.html">Como eu ensino crian√ßas Python</a></li>
<li><a href="../pt485426/index.html">Carros na Holanda: estat√≠sticas e informa√ß√µes para 2019</a></li>
<li><a href="../pt485428/index.html">O misterioso programa LyX. Parte 5</a></li>
<li><a href="../pt485430/index.html">Editor de texto multiusu√°rio simples com criptografia de ponta a ponta</a></li>
<li><a href="../pt485438/index.html">Testando componentes da interface do usu√°rio do React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>