<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈁 💕 💫 Corretor JavaScript offline 📄 🧝🏻 🏛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No meu projeto, eu precisava de uma funcionalidade que me permitisse não perder os dados inseridos no caso de uma falha na conexão com a Internet e cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Corretor JavaScript offline</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428980/">  No meu projeto, eu precisava de uma funcionalidade que me permitisse não perder os dados inseridos no caso de uma falha na conexão com a Internet e criei um "Broker" muito simples que me permitiria não perder dados quando a conexão foi perdida, mas enviá-los quando a conexão for restaurada novamente.  Talvez "Broker" não seja um bom nome para ele, mas não julgue rigorosamente.  Eu quero compartilhar, talvez alguém seja útil. <br><a name="habracut"></a><br><h2>  Sobre o projeto </h2><br>  Meu projeto foi projetado para contabilizar despesas e receitas ou como uma versão simples da contabilidade doméstica.  Foi criado como um aplicativo da web progressivo, para que seja conveniente usá-lo em dispositivos móveis, bem como para abrir os recursos de notificações push, acesso à câmera para leitura de códigos de barras e similares.  Existe um aplicativo móvel semelhante chamado ZenMoney, mas eu queria algo próprio e do meu jeito. <br><br><h2>  O surgimento de idéias </h2><br>  Tento manter um registro claro de despesas e receitas, mas como muitas vezes esquecemos de acrescentar as posições necessárias, principalmente em relação ao caixa, tenho que fazer isso quase imediatamente quando a "transação" ocorreu.  Às vezes, eu inseria dados no transporte público, como o metrô, onde as perdas de conexão ocorrem com frequência, apesar da ampla rede Wi-Fi.  Foi uma pena que tudo congele e nada aconteça, e então os dados foram simplesmente perdidos. <br><br>  A ideia surgiu do uso de um broker de filas como o RabbitMQ.  É claro que tenho uma solução mais simples e não tão funcional, mas há algo semelhante aos seus princípios.  Pensei que você pudesse salvar tudo, por exemplo, no Cache ou LocalStorage como um objeto com uma fila de solicitações "insatisfeitas" e, quando uma conexão aparecer, você poderá executá-las com segurança.  Obviamente, eles não são executados em ordem de prioridade, o que, graças ao processamento assíncrono de solicitações na linguagem JS, é ainda melhor, pois você tem apenas um "assinante".  Eu tive algumas dificuldades, talvez até a implementação de tudo isso pareça um pouco torta, mas essa é uma solução funcional.  Obviamente, isso pode ser melhorado, mas por enquanto vou descrever a opção "bruta", mas funcional, existente. <br><br><h2>  Introdução </h2><br>  A primeira coisa que pensei foi onde armazenar dados na ausência de uma conexão ?!  O woker de serviço imposto a mim pelo PWA funciona bem com o cache, mas é aconselhável usá-lo ?!  Uma pergunta difícil, não vou entrar nela.  Em geral, decidi que o LocalStorage é melhor para mim.  Como LocalStorage armazena valores do tipo key: value, o objeto teve que ser adicionado como uma sequência Json.  No meu projeto para desenvolvimento externo, adicionei um diretório chamado QueueBroker à pasta da classe <br><br><div class="spoiler">  <b class="spoiler_title">Estrutura de arquivo</b> <div class="spoiler_text"><code>/**----**/ <br> ├── app.js <br> ├── bootstrap.js <br> ├── classes <br> │  └── QueueBroker <br> │  ├── index.js <br> │  └── Library <br> │  ├── Broker.js <br> │  └── Storage.js <br> ├── components <br> /**----**/ <br></code> <br></div></div><br>  Meu projeto é feito na pilha Laravel + VueJs, portanto, é necessária uma certa dependência da estrutura do arquivo.  Não sei como, nesses casos, é correto chamar seus próprios diretórios para classes, então o fiz. <br><br>  O arquivo de índice foi criado para simplesmente conectar módulos da Biblioteca aninhada.  Pode não ser uma solução muito elegante, mas eu queria fazê-lo para que, se de repente eu mude de idéia sobre o uso do LocalStorage, escreva outra classe para Storage com os mesmos métodos, passe-a para o construtor do broker e use o outro armazenamento sem alterar nada. <br><br><div class="spoiler">  <b class="spoiler_title">index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Broker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Broker'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./Library/Storage'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Broker = Broker; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.Storage = Storage;</code> </pre><br></div></div><br>  Este método permite conectar apenas as bibliotecas que eu preciso nos meus scripts, por exemplo, se eu precisar de ambas: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Storage, Broker} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../../classes/QueueBroker/index'</span></span>;</code> </pre><br>  Para facilitar a alteração da classe de armazenamento, criei um tipo de construtor para a classe Broker, na qual o objeto Storage pode ser passado como argumento, o principal é que ele possui as funções necessárias.  Eu sei que no ES6 eu poderia escrever classe e construtor, mas decidi fazê-lo da maneira antiga - protótipo.  Escreverei comentários diretamente por código: <br><br><div class="spoiler">  <b class="spoiler_title">Broker.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> axios = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'axios'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  axios /*     .    ,            front-end  */ function Broker(storage, prefix='storageKey') { this.storage = storage; this.prefix = prefix; /*     ,      .   storage   add     json */ if(this.storage.get('broker') === null) { this.broker = {}; this.storage.add('broker', this.broker) } else { //  , Storage    Json            this.broker = this.storage.getObject('broker'); } }; // ,           Broker.prototype.queueCount = function () { return Object.keys(this.broker).length; }; //  ""    Storage,    Broker.prototype.saveToStorage = function (method, url, data) { let key = this.prefix + '_' + (Object.keys(this.broker).length + 1); this.broker[key] = {method, url, data}; //            broker,        this.storage.add('broker', this.broker); }; // ,    ,    Broker.prototype.run = function () { for (let key in this.broker) { this.sendToServer(this.broker[key], key) } } /*    .        ,     method, url  data,        ,    ,    */ Broker.prototype.sendToServer = function (object, brokerKey) { axios({ method: object.method, url: object.url, data: object.data, }) .then(response =&gt; { if(response.data.status == 200) { //   ,    delete this.broker[brokerKey]; //  this.storage.add('broker', this.broker); } else { //   ;-) console.log(response.data) } }) .catch(error =&gt; { /*           ,       */ }); }; //   export module.exports = Broker;</span></span></code> </pre><br></div></div><br>  Em seguida, você precisa do próprio objeto Storage, que salvará e recuperará com êxito tudo do armazenamento <br><br><div class="spoiler">  <b class="spoiler_title">Storage.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  debug-   function Storage(debug) { if(debug === true) { this.debugMode = true; } this.storage = window.localStorage; }; // ,     Json      Storage.prototype.addObjectToStorage = function (key, object) { this.storage.setItem(key, JSON.stringify(object)); }; //    (,   ) Storage.prototype.addStringToStorage = function (key, value) { this.storage.setItem(key, value); }; //    Storage.prototype.get = function (key) { return this.storage.getItem(key); }; //    Json ,       Storage.prototype.getObject = function (key) { try { return JSON.parse(this.storage.getItem(key)); } catch (e) { this._debug(e); this._debug(key + ' = ' + this.storage.getItem(key)); return false; } }; /* ,     ,  ,        ,   Json      */ Storage.prototype.add = function (key, value) { try { if(typeof value === 'object') { this.addObjectToStorage(key, value); } else if (typeof value === 'string' || typeof value === 'number') { this.addStringToStorage(key, value); } else { //    this._debug('2 parameter does not belong to a known type') } return this.storage; } catch (e) { //    ,    ,    if (e === QUOTA_EXCEEDED_ERR) { this._debug('LocalStorage is exceeded the free space limit') } else { this._debug(e) } } }; //  Storage.prototype.clear = function () { try { this.storage.clear(); return true; } catch (e) { this._debug(e) return false; } }; //    Storage.prototype.delete = function(key) { try { this.storage.removeItem(key); return true; } catch (e) { this._debug(e) return false; } }; // ,      Storage.prototype._debug = function(error) { if(this.debugMode) { console.error(error); } return null; }; //   module.exports = Storage;</span></span></code> </pre><br></div></div><br>  Quando todas as opções acima estiverem prontas, isso pode ser usado a seu critério, eu uso assim: <br><br><div class="spoiler">  <b class="spoiler_title">Use em Salvar</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue (methods) /*----*/ //      Storage   sendBroker(method, url, data) { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); broker.saveToStorage(method, url, data); }, //     fundsSave() { let url = '/pa/funds'; let method = ''; if(this.fundsFormType === 'create') { method = 'post'; } else if(this.fundsFormType === 'update') { method = 'put'; } else if(this.fundsFormType === 'delete') { method = 'delete'; } this.$store.commit('setPreloader', true); axios({ method: method, url: url, data: this.fundsFormData, }) .then(response=&gt; { if(response.data.status == 200) { this.fundsFormShow = false; this.getFunds(); this.$store.commit('setPreloader', false); } else { this.$store.commit('AlertError', '    '); } }) //        .catch(error =&gt; { this.$store.commit('setAlert', { type: 'warning', status: true, message: '   . ,        ,   ' } ); this.fundsFormShow = false; this.$store.commit('setPreloader', false); //   ""  this.sendBroker(method, url, this.fundsFormData); console.error(error); }); },</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Use ao reconectar</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Vue /*--*/ methods: { /*----*/ /*   ,    ,   ,      ,      */ brokerSendRun() { let storage = new Storage(true); let broker = new Broker(storage, 'fundsControl'); //,   -   if(broker.queueCount() &gt; 0) { // ,    broker.run(); //   ,   this.$store.commit('setAlert', {type: 'info', status: true, message: '      -  , ,      '}); } } } /*---*/ /*     , ,   ,          ,     ,        */ mounted() { this.brokerSendRun(); } /*---*/</span></span></code> </pre><br></div></div><br><h3>  PS </h3><br>  É difícil falar sobre o código, então tentei fornecer o código nos exemplos o mais detalhado possível com comentários detalhados.  Se você tiver idéias para melhorar esta solução ou melhorar este artigo, ficarei feliz em vê-las nos comentários.  Peguei exemplos de meu próprio projeto no Vue, explico isso para deixar claro por que meus métodos são assim chamados e por que eu os acesso através <b>disso</b> .  Não o faço neste artigo especificamente no Vue; portanto, não forneço outro código de componente, deixo-o para compreensão. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt428980/">https://habr.com/ru/post/pt428980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt428962/index.html">Deslocalização na Luxoft: como está a vida</a></li>
<li><a href="../pt428964/index.html">Vulnerabilidades de SSD criptografadas por hardware permitem que os invasores ignorem facilmente as medidas de proteção</a></li>
<li><a href="../pt428972/index.html">Integração contínua no Yandex</a></li>
<li><a href="../pt428974/index.html">Interessante na Interlight 2018</a></li>
<li><a href="../pt428976/index.html">Formigueiro ou fortaleza? Estou construindo uma casa pelo preço de um apartamento. Parte 2: Aquecimento</a></li>
<li><a href="../pt428982/index.html">Como escrever D no ARM</a></li>
<li><a href="../pt428984/index.html">Julia e retratos de fase de sistemas dinâmicos</a></li>
<li><a href="../pt428986/index.html">Conferência ThinkJava # 8 em Kharkov</a></li>
<li><a href="../pt428988/index.html">Dicas da Natureza - Nublado Night Light</a></li>
<li><a href="../pt428990/index.html">Exemplos de configuração de UIViewControllers usando RouteComposer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>