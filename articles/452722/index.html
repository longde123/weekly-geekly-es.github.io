<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèΩ üÜò üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Hacer amigos CI, pruebas unitarias y base de datos üò∂ üßôüèª ü§ù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo trata sobre probar la interacci√≥n con la base de datos en CI. Vi varias soluciones usando docker y testcontainers, pero tengo la m√≠a y qui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacer amigos CI, pruebas unitarias y base de datos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452722/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/p9/2f/hw/p92fhwlfahzagt8w9wzxpfclgzw.png" alt="imagen"></div><br>  El art√≠culo trata sobre probar la interacci√≥n con la base de datos en CI.  Vi varias soluciones usando docker y testcontainers, pero tengo la m√≠a y quiero compartirla. <br><a name="habracut"></a><br>  Mi proyecto anterior de Java estaba estrechamente vinculado a una base de datos.  Procesamiento largo con reintentos, subprocesos m√∫ltiples y bloqueos de bloqueo.  Para la tarea se requer√≠a corregir un par de consultas SQL dif√≠ciles.  De alguna manera estaba acostumbrado a cubrir mi c√≥digo con pruebas, pero antes de eso, todo el SQL se reduc√≠a a consultas primitivas y pod√≠a ejecutarse en una base H2 en la memoria.  Y aqu√≠ en hardcore. <br><br>  Podr√≠a probar SQL simple con mis manos y un martillo cobarde en las autocomprobaciones, justific√°ndome "No soy una especie de bagodel, cometer√© errores en un c√≥digo simple".  En realidad, los errores aparecen con menos frecuencia debido a la disponibilidad de pruebas.  Era posible trasladar la responsabilidad a los evaluadores: si comet√≠a un error en alg√∫n lado, lo encontrar√≠an. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ro/nh/jsronhgbydvhziosboj6velwb5w.png" alt="imagen"></div><br>  De acuerdo con la ideolog√≠a de las pruebas unitarias, las pruebas son necesarias solo para probar m√≥dulos individuales, y si el m√≥dulo usa algo del exterior, entonces esto debe reemplazarse con un trozo.  En la pr√°ctica, cuando se vuelve demasiado dif√≠cil implementar un c√≥digo auxiliar, simplemente se ignora el m√≥dulo.  La velocidad y la modularidad son importantes, pero es m√°s importante no dejar el c√≥digo sin probar, incluso si no aparece en las m√©tricas de cobertura.  Por lo tanto, el m√≥dulo ya no se considera una clase separada, sino un grupo conectado, junto con la configuraci√≥n.  Lo principal con tales declaraciones es no llegar al concepto de unidad que se extiende al nivel de cl√∫ster. <br><br>  Para las pruebas locales, cada desarrollador tiene su propio esquema, pero las pruebas se ejecutan en Jenkins y todav√≠a no hay conexi√≥n a la base de datos.  CI necesita un circuito separado, parece ser obvio.  Pero en un diagrama vac√≠o, no es muy correcto ejecutar pruebas; crear una estructura de base de datos en cada prueba lleva mucho tiempo y est√° lleno de discrepancias entre la estructura en la prueba y en la batalla.  Ejecutar en una base preparada previamente: tengo muchos problemas con las ramas.  Puede preparar la base de datos antes de ejecutar todas las pruebas con liquibase, primero borrar todo a cero y luego actualizar a la √∫ltima versi√≥n. <br><br>  A menudo, se olvida el retroceso para finalizar y debe limpiar las bases con sus manos en entornos de prueba.  Pru√©balo y √©l!  El algoritmo es el siguiente: <br><br><ol><li>  eliminar todo debajo de la ra√≠z (para la pureza del experimento) </li><li>  actualizar a la √∫ltima versi√≥n </li><li>  realizar reversi√≥n 1-2 versiones atr√°s </li><li>  actualizar a la √∫ltima versi√≥n (las pruebas deben realizarse en la nueva estructura de la base de datos, adem√°s de comprobar que la reversi√≥n no se olvid√≥ de eliminar nada, lo que evitar√° que la actualizaci√≥n vuelva a funcionar) </li></ol><br>  Los dem√°s desarrolladores no desean ejecutar pruebas de reversi√≥n al comenzar cada prueba.  Nosotros hacemos el cambio. <br><br><pre><code class="kotlin hljs">project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre> <br>  Si bien hay entrenamiento en gatos, todo est√° bien.  Pero un proyecto en desarrollo din√°mico realiza sus propios ajustes: 2 misiones de extracci√≥n, ensamblaje simult√°neo.  Una instancia est√° probando algo, y la segunda est√° golpeando la base debajo de sus pies.  Se resuelve con una simple prohibici√≥n de ensamblajes paralelos. <br><br><img src="https://habrastorage.org/webt/my/64/hm/my64hmqfabt8qg0jcuz-xwiddvi.png" alt="imagen"><br><br>  Y nuevamente una ca√≠da: decid√≠ ejecutar pruebas usando la cuenta de Jenkins, porque  todo est√° bien en lo personal, y el conjunto de solicitudes cae por razones poco claras.  Recordamos la ferviente charla de que DevOps es una cultura y el uso de cuentas t√©cnicas para fines personales es inaceptable. <br><br><img src="https://habrastorage.org/webt/fr/lb/xf/frlbxfbj6ck-8pdbhff0v5kpeta.png" alt="imagen"><br><br>  Acumulado 10 grupo de solicitudes.  Todo reunido, redistribuido, puede fusionar.  El primero fue, la rama principal cambi√≥: el resto juntos hacen cola para la reconstrucci√≥n.  Puede fusionarse a medida que avanza, pero hay prioridades.  Solicitudes de extracci√≥n m√°s urgentes, menos urgentes, tambi√©n est√°n colgando debido a errores en el c√≥digo.  En general, paralelizar hacia atr√°s. <br><br>  La asamblea deber√≠a ser simple, consistir en pasos simples y ser comprensible incluso para el estudiante de ayer.  En el 99% no hay problema en que el ensamblaje del conjunto de solicitud y liberaci√≥n sea secuencial y no paralelo.  Si la revisi√≥n no acumula m√°s de 1-2 PR, entonces la prohibici√≥n de ensambles simult√°neos es suficiente. <br><br>  Y para el lanzamiento paralelo necesitamos bases o esquemas a los que cada prueba lanzada tendr√° acceso exclusivo. <br><br>  La opci√≥n uno es asignar din√°micamente.  Crear un esquema en la base de datos es r√°pido.  Al tener una nube con una API, puede asignar una base de datos all√≠. <br><br>  Si no resuelve la eliminaci√≥n de bases de datos antiguas, puede finalizar r√°pidamente el espacio en disco cuando caen las pruebas y "olvidar" para liberar recursos.  Es "cu√°ndo", no "si". <br><br>  Opci√≥n dos: un grupo de base de datos / esquema con un servicio de administraci√≥n separado.  Fuera de la API sobresale, entregue la Base por el tiempo, recupere la Base libre antes del plazo.  Lo que devolver√°: un servidor dedicado con una base de datos o simplemente un peque√±o esquema, no importa.  Lo principal es que el recurso no se perder√° para siempre. <br><br>  Opci√≥n tres: un conjunto de bases / esquemas para la autorregulaci√≥n.  Se necesita un recurso para el intercambio de informaci√≥n sobre bloqueos y el grupo de bases de datos en s√≠. <br><br>  Me decid√≠ por la √∫ltima opci√≥n, ya que es m√°s f√°cil para m√≠ sujetarla y no es particularmente necesario para apoyarla.  La l√≥gica es la siguiente: se crean varios (10 por ejemplo) circuitos y toda la informaci√≥n necesaria para conectarse a ellos se agrega al recurso compartido, cada instancia de prueba antes del inicio hace una marca de inicio, despu√©s del final, la elimina.  Si la prueba falla antes de finalizar, el circuito se considerar√° libre al final del tiempo de espera. <br><br>  Configuraciones de lectura: <br><br><pre> <code class="kotlin hljs"> project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader())</code> </pre><br>  Trabajar con sql desde scripts gradle requiere la carga del controlador: <br><pre> <code class="kotlin hljs"> configurations { driver } dependencies { driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } }</code> </pre><br>  Conexi√≥n: <br><br><pre> <code class="kotlin hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) }</code> </pre><br>  El intercambio de informaci√≥n puede llevarse a cabo a trav√©s de la tabla de la base de datos.  Inicializaci√≥n de la tabla de referencia (deber√≠a funcionar una vez, luego la tabla vive hasta el final de los tiempos): <br><br><pre> <code class="kotlin hljs"> task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } }</code> </pre><br>  Los desarrolladores tienen sus propios esquemas para la depuraci√≥n y el ensamblaje, por lo que el uso del grupo debe estar desactivado: <br><br><pre> <code class="kotlin hljs"> project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) }</code> </pre><br>  Toma y base libre: <br><br><pre> <code class="kotlin hljs"> task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } }</span></span></code> </pre><br>  Si completa el ensamblaje 2 veces seguidas, se pueden seleccionar diferentes esquemas y permanecer√°n diferentes valores al ensamblar los archivos de propiedades.  Para lanzamientos locales, la configuraci√≥n es est√°tica. <br><br><pre> <code class="kotlin hljs"> configure([processResources, processTestResources]) { Task t -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.ext.isCiBuild()) { t.outputs.upToDateWhen { <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } t.filesMatching(<span class="hljs-string"><span class="hljs-string">'**/*.properties'</span></span>) { filter(ReplaceTokens, tokens: localConfig, beginToken: <span class="hljs-string"><span class="hljs-string">'${'</span></span>, endToken: <span class="hljs-string"><span class="hljs-string">'}'</span></span>) } }</code> </pre><br>  Tareas para probar la reversi√≥n: <br><br><pre> <code class="kotlin hljs"> task restoreAfterRollbackTest(type: LiquibaseTask) { command = <span class="hljs-string"><span class="hljs-string">'update'</span></span> } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = <span class="hljs-string"><span class="hljs-string">'rollback'</span></span> requiresValue = <span class="hljs-literal"><span class="hljs-literal">true</span></span> doFirst { project.ext.liquibaseCommandValue = localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.tag'</span></span>] } doLast { project.ext.liquibaseCommandValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre><br>  Y configure la orden de ejecuci√≥n: <br><br><pre> <code class="kotlin hljs"> configure([project]) { tasks.withType(LiquibaseTask.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { LiquibaseTask t -&gt; logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), configLiquibase.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn configLiquibase <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isCiBuild()) { logger.info(<span class="hljs-string"><span class="hljs-string">"Liquibase task {} must run after {}"</span></span>, t.getName(), lockDb.getName()) (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).dependsOn lockDb (t <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Task).finalizedBy unlockDb } } <span class="hljs-comment"><span class="hljs-comment">//   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br>  La asignaci√≥n de base de datos y las pruebas de reversi√≥n se pueden colocar dentro de las pruebas.  Formas de ejecutar c√≥digo antes y despu√©s de completar todas las pruebas: en Junit5, esto es BeforeAllCallback, en TestNG BeforeSuite. <br><br>  A la pregunta "¬øpor qu√© sql deber√≠a ser probado por el programador de Java?", La respuesta es que cualquier c√≥digo debe ser probado.  Hay excepciones y algunos c√≥digos son irracionales para probar en un momento dado. <br><br>  Me gustar√≠a saber c√≥mo otros programadores resuelven el problema de probar la interacci√≥n con la base de datos.  ¬øHan llegado contenedores a todos los hogares, o las pruebas de integraci√≥n pasan a los hombros de los evaluadores? <br><br><div class="spoiler">  <b class="spoiler_title">Listado completo</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonOutput <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.json.JsonSlurper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.sql.Sql <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.tools.ant.filters.ReplaceTokens <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.liquibase.gradle.LiquibaseTask plugins { id <span class="hljs-string"><span class="hljs-string">'java'</span></span> id <span class="hljs-string"><span class="hljs-string">'org.liquibase.gradle'</span></span> version <span class="hljs-string"><span class="hljs-string">'2.0.1'</span></span> } configurations { driver } repositories { jcenter() mavenCentral() maven { url = <span class="hljs-string"><span class="hljs-string">"http://www.datanucleus.org/downloads/maven2/"</span></span> } } dependencies { implementation <span class="hljs-string"><span class="hljs-string">'com.google.guava:guava:27.0.1-jre'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-core:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-context:5.1.7.RELEASE'</span></span> implementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-jdbc:5.1.7.RELEASE'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'junit:junit:4.12'</span></span> testImplementation <span class="hljs-string"><span class="hljs-string">'org.springframework:spring-test:5.1.7.RELEASE'</span></span> testRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.liquibase:liquibase-core:3.6.1'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'oracle:ojdbc6:11.+'</span></span> liquibaseRuntime <span class="hljs-string"><span class="hljs-string">'org.yaml:snakeyaml:1.24'</span></span> driver group: <span class="hljs-string"><span class="hljs-string">"oracle"</span></span>, name: <span class="hljs-string"><span class="hljs-string">"ojdbc6"</span></span>, version: <span class="hljs-string"><span class="hljs-string">"11.+"</span></span> } project.ext.localConfig = new Properties() localConfig.load(file(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rootDir}</span></span></span><span class="hljs-string">/local.properties"</span></span>).newReader()) project.ext.isCiBuild = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'pool.db.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } project.ext.doRollbackTest = { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>.parseBoolean(localConfig[<span class="hljs-string"><span class="hljs-string">'test.rollback.enabled'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) } task configLiquibase { doLast { liquibase { activities { testdb { changeLogFile <span class="hljs-string"><span class="hljs-string">'changelog.yaml'</span></span> url localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.url'</span></span>] driver localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.driverClass'</span></span>] username localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.username'</span></span>] password localConfig[<span class="hljs-string"><span class="hljs-string">'app.db.password'</span></span>] logLevel <span class="hljs-string"><span class="hljs-string">'debug'</span></span> classpath <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${project.projectDir}</span></span></span><span class="hljs-string">/db"</span></span> contexts <span class="hljs-string"><span class="hljs-string">'main'</span></span> } runList = <span class="hljs-string"><span class="hljs-string">'testdb'</span></span> } } } } task initDriver { doLast { ClassLoader loader = GroovyObject.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.classLoader configurations.driver.each { File file -&gt; loader.addURL(file.toURL()) } } } project.ext.createSqlInstance = { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Sql.newInstance( url: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], user: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.username"</span></span>], password: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.password"</span></span>], driver: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>]) } task initDbPool { dependsOn initDriver doLast { Integer poolSize = <span class="hljs-number"><span class="hljs-number">10</span></span> Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] String baseName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.baseName"</span></span>] String basePass = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.basePass"</span></span>] String token = <span class="hljs-string"><span class="hljs-string">"{id}"</span></span> List tableExists = sql.rows(<span class="hljs-string"><span class="hljs-string">"select table_name from all_tables where table_name=?"</span></span>, [tableName]) assert tableExists.isEmpty() sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE TABLE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> ( ID NUMBER(2) NOT NULL PRIMARY KEY, METADATA VARCHAR2(200) NOT NULL, PROCESSED TIMESTAMP NULL, GUID VARCHAR2(36) NULL) """</span></span>, []) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; poolSize ; i++) { String username = baseName.replace(token, i.toString()) String password = basePass.replace(token, i.toString()) sql.execute(<span class="hljs-string"><span class="hljs-string">""" CREATE USER </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string"> IDENTIFIED BY "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${password}</span></span></span><span class="hljs-string">" DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP PROFILE DEFAULT QUOTA UNLIMITED ON USERS """</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant connect to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create sequence to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create session to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) sql.execute(<span class="hljs-string"><span class="hljs-string">"grant create table to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">"</span></span>, []) String metadata = JsonOutput.toJson([ <span class="hljs-string"><span class="hljs-string">"app.db.driverClass"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.driverClass"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.url"</span></span>: localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.url"</span></span>], <span class="hljs-string"><span class="hljs-string">"app.db.username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"app.db.password"</span></span>: password ]) sql.execute(<span class="hljs-string"><span class="hljs-string">""" INSERT INTO </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> (id, metadata) values (?, ?) """</span></span>, [i, metadata]) } } } task lockDb { dependsOn initDriver onlyIf isCiBuild doLast { project.ext.lockUid = UUID.randomUUID().toString() String tableName = localConfig[<span class="hljs-string"><span class="hljs-string">"pool.db.referenceTable"</span></span>] Sql sql = createSqlInstance() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sql sql.executeUpdate(<span class="hljs-string"><span class="hljs-string">"""UPDATE </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> SET GUID = ?, PROCESSED = SYSDATE WHERE ID IN ( SELECT ID FROM ( SELECT ID, ROW_NUMBER() OVER (ORDER BY PROCESSED) AS RN FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID IS NULL OR PROCESSED &lt; (SYSDATE - NUMTODSINTERVAL(?, 'MINUTE')) ) WHERE RN = 1 ) """</span></span>, [lockUid, <span class="hljs-number"><span class="hljs-number">15</span></span>]) def meta = sql.firstRow(<span class="hljs-string"><span class="hljs-string">"SELECT METADATA FROM </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tableName}</span></span></span><span class="hljs-string"> WHERE GUID = ?"</span></span>, [lockUid]) assert meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"No free databases in pool"</span></span> def slurper = new JsonSlurper() Map metadata = slurper.parseText(meta[<span class="hljs-string"><span class="hljs-string">"METADATA"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> String) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Map localConfig.putAll(metadata) logger.info(<span class="hljs-string"><span class="hljs-string">"Database locked, {}"</span></span>, metadata) } } task unlockDb { dependsOn lockDb <span class="hljs-comment"><span class="hljs-comment">// init lockUid onlyIf isCiBuild doLast { try { String tableName = localConfig["pool.db.referenceTable"] Sql sql = createSqlInstance() as Sql sql.executeUpdate("UPDATE ${tableName} SET GUID = NULL WHERE GUID = ?", [lockUid]) logger.info("Database unlocked") } catch (ignored) { logger.error(ignored) } } } configure([processResources, processTestResources]) { Task t -&gt; if (project.ext.isCiBuild()) { t.outputs.upToDateWhen { false } } t.filesMatching('**/*.properties') { filter(ReplaceTokens, tokens: localConfig, beginToken: '${', endToken: '}') } } task restoreAfterRollbackTest(type: LiquibaseTask) { command = 'update' } task rollbackTest(type: LiquibaseTask) { dependsOn lockDb command = 'rollback' requiresValue = true doFirst { project.ext.liquibaseCommandValue = localConfig['test.rollback.tag'] } doLast { project.ext.liquibaseCommandValue = null } } configure([project]) { tasks.withType(LiquibaseTask.class) { LiquibaseTask t -&gt; logger.info("Liquibase task {} must run after {}", t.getName(), configLiquibase.getName()) (t as Task).dependsOn configLiquibase if (isCiBuild()) { logger.info("Liquibase task {} must run after {}", t.getName(), lockDb.getName()) (t as Task).dependsOn lockDb (t as Task).finalizedBy unlockDb } } //   CI: // 1.    0 (dropAll) // 2.     rollback (update) // 3. ,       (rollback tag) // 4.      (update) // 5.     if (doRollbackTest()) { def setTaskOrdering = { List&lt;Task&gt; lst -&gt; for (int i = 0; i &lt; lst.size() - 1; i++) { logger.info("Task {} must run after {}", lst[i + 1].getName(), lst[i].getName()) lst[i + 1].dependsOn lst[i] } } setTaskOrdering([ lockDb, configLiquibase, dropAll, update, rollbackTest, restoreAfterRollbackTest, processTestResources, test, ]) lockDb.finalizedBy unlockDb test.finalizedBy unlockDb } }</span></span></code> </pre><br><pre> <code class="bash hljs">pool.db.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> test.rollback.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> pool.db.driverClass=oracle.jdbc.driver.OracleDriver pool.db.url=jdbc:oracle:thin:@localhost:1527:ORCLCDB pool.db.username=SYSTEM pool.db.password=Oradoc_db1 pool.db.referenceTable=c<span class="hljs-comment"><span class="hljs-comment">##test_user1.REF_TABLE pool.db.baseName=C##CI_SCHEMA_{id} pool.db.basePass=CI_SCHEMA_{id}_PASS app.db.driverClass= app.db.url= app.db.username= app.db.password= test.rollback.tag=version_1</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452722/">https://habr.com/ru/post/452722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452706/index.html">En 1983, esta computadora de Bella Labs se convirti√≥ en el primer gran maestro.</a></li>
<li><a href="../452712/index.html">C√≥mo tratamos de trabajar en equipo y qu√© surgi√≥</a></li>
<li><a href="../452714/index.html">Preste atenci√≥n # 5: Resumen de art√≠culos sobre pensamiento de productos, psicolog√≠a conductual y productividad</a></li>
<li><a href="../452716/index.html">En busca de un punto √≥ptimo de aplicaci√≥n de recursos humanos</a></li>
<li><a href="../452718/index.html">PsyGuide: D√©ficit de atenci√≥n. # 0001/1001</a></li>
<li><a href="../452724/index.html">Phoenix LiveView: cuando el c√≥digo javascript es divertido *</a></li>
<li><a href="../452726/index.html">Cute bones 3D: material √≥seo hiperel√°stico para defectos pl√°sticos del cr√°neo</a></li>
<li><a href="../452730/index.html">Certificaci√≥n de sistemas de informaci√≥n sobre el principio de segmentos est√°ndar. Mitos y realidad</a></li>
<li><a href="../452734/index.html">Migre autom√°ticamente aplicaciones de iOS (ARM) a macOS (x86) usando Bitcode</a></li>
<li><a href="../452736/index.html">Cifrado de mensajes en SecureDialogues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>