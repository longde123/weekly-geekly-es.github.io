<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñãÔ∏è ‚è≤Ô∏è üéÆ Metadados S3 no PostgreSQL. Palestra Yandex üèûÔ∏è üê´ üí´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta √© a segunda palestra com J. Subbotnik sobre bancos de dados - a primeira que publicamos algumas semanas atr√°s. 

 O chefe do grupo de DBMS de uso...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Metadados S3 no PostgreSQL. Palestra Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/417241/"> Esta √© a segunda palestra com J. Subbotnik sobre bancos de dados - a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira</a> que publicamos algumas semanas atr√°s. <br><br>  O chefe do grupo de DBMS de uso geral Dmitry Sarafannikov falou sobre a evolu√ß√£o do data warehouse no Yandex: como decidimos criar uma interface compat√≠vel com S3, por que escolhemos o PostgreSQL, que tipo de rake adotamos e como lidar com eles. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HqPYXZDt3VA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - Ol√° pessoal!  Meu nome √© Dima, no Yandex eu fa√ßo bancos de dados. <a name="habracut"></a>  Vou contar como fizemos o S3, como fizemos exatamente o S3 e que tipo de armazenamento era antes.  O primeiro deles √© o Elliptics, publicado em c√≥digo aberto, dispon√≠vel no GitHub.  Muitos podem ter se deparado com isso. <br><img src="https://habrastorage.org/webt/ji/kg/05/jikg05jprfdg32gcrus0iunyha4.jpeg"><br>  Essa √© essencialmente uma tabela de hash distribu√≠da com uma chave de 512 bits, o resultado do SHA-512.  Forma um chaveiro dividido aleatoriamente entre m√°quinas.  Se voc√™ deseja adicionar m√°quinas l√°, as chaves s√£o redistribu√≠das, ocorre o reequil√≠brio.  Este reposit√≥rio tem seus pr√≥prios problemas associados, em particular, ao reequil√≠brio.  Se voc√™ tem um n√∫mero suficientemente grande de chaves, ent√£o, com volumes constantemente crescentes, √© necess√°rio despejar carros constantemente, e em um n√∫mero muito grande de chaves, o reequil√≠brio pode simplesmente n√£o convergir.  Este foi um problema grande o suficiente. <br><br>  Mas, ao mesmo tempo, esse armazenamento √© excelente para dados mais ou menos est√°ticos, quando voc√™ carrega uma grande quantidade de uma s√≥ vez e, em seguida, gera uma carga somente leitura.  Para tais decis√µes, ele se encaixa perfeitamente. <br><br>  N√≥s estamos indo al√©m.  Os problemas com o reequil√≠brio eram bastante s√©rios, portanto o pr√≥ximo armazenamento apareceu. <br><img src="https://habrastorage.org/webt/s6/p-/0q/s6p-0qu2vq5zqtguekkjpyvljf4.jpeg"><br>  Qual √© a sua ess√™ncia?  Isso n√£o √© armazenamento de valor-chave, √© armazenamento de valor.  Quando voc√™ carrega algum objeto ou arquivo l√°, ele responde com uma chave, pela qual voc√™ pode pegar esse arquivo.  O que isso d√°?  Teoricamente, cem por cento de acesso de grava√ß√£o, se voc√™ tiver espa√ßo livre no armazenamento.  Se voc√™ tem uma m√°quina de escrever, simplesmente escreve para outras pessoas que n√£o est√£o deitadas, onde h√° espa√ßo livre, obt√©m outras chaves e coleta seus dados com calma. <br><br>  Esse armazenamento √© muito f√°cil de dimensionar, voc√™ pode jog√°-lo com ferro, ele funcionar√°.  √â muito simples, confi√°vel.  Sua √∫nica desvantagem: o cliente n√£o gerencia a chave e todos os clientes devem armazenar as chaves em algum lugar, armazenar o mapeamento de suas chaves.  Isso √© inconveniente para todos.  De fato, essa √© uma tarefa muito semelhante para todos os clientes, e cada uma a resolve √† sua maneira em suas metabases, etc. Isso √© inconveniente.  Mas, ao mesmo tempo, n√£o quero perder a confiabilidade e a simplicidade desse armazenamento, na verdade ele funciona com a velocidade da rede. <br><br>  Ent√£o come√ßamos a olhar para o S3.  Este √© o armazenamento de valor-chave, o cliente gerencia a chave e todo o armazenamento √© dividido nos chamados buckets.  Em cada bloco, o espa√ßo da chave √© de menos infinito a mais infinito.  A chave √© algum tipo de sequ√™ncia de texto.  E nos decidimos por essa op√ß√£o.  Por que S3? <br><br>  Tudo √© bem simples.  Nesse momento, muitos clientes prontos para v√°rias linguagens de programa√ß√£o j√° foram gravados, muitas ferramentas prontas para armazenar algo no S3, por exemplo, backups de bancos de dados, j√° foram gravadas.  Andrew <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falou</a> sobre um dos exemplos.  J√° existe uma API razoavelmente bem pensada que circula nos clientes h√° anos e voc√™ n√£o precisa inventar nada l√°.  A API possui muitos recursos convenientes, como listagens, uploads com v√°rias partes e assim por diante.  Portanto, decidimos permanecer nele. <br><br>  Como fazer o S3 do nosso armazenamento?  O que vem √† mente?  Como os pr√≥prios clientes armazenam o mapeamento de chaves, simplesmente pegamos, colocamos o banco de dados ao lado deles e armazenamos o mapeamento dessas chaves nele.  Ao ler, apenas encontraremos as chaves e o armazenamento em nosso banco de dados e forneceremos ao cliente o que ele deseja.  Se voc√™ esbo√ßar isso esquematicamente, como acontece o preenchimento? <br><img src="https://habrastorage.org/webt/99/kr/9t/99kr9tmubs8skxzhbl-yrxmq4iq.jpeg"><br>  Existe uma certa entidade, aqui √© chamada Proxy, o chamado back-end.  Ele aceita o arquivo, carrega-o no armazenamento, pega a chave de l√° e salva no banco de dados.Tudo √© bem simples. <br><img src="https://habrastorage.org/webt/jx/m3/q8/jxm3q8hbv-qzn7qohrpaqw8cgv8.jpeg"><br>  Como est√° o recibo?  O proxy encontra a chave necess√°ria no banco de dados, acompanha a chave para armazenamento, baixa o objeto a partir da√≠ e entrega ao cliente.  Tudo √© simples tamb√©m. <br><img src="https://habrastorage.org/webt/tb/w3/hw/tbw3hwknk1vjapsvw9af7pvquig.jpeg"><br>  Como √© a remo√ß√£o?  Ao excluir diretamente do armazenamento, o proxy n√£o funciona, porque √© dif√≠cil coordenar o banco de dados e o armazenamento; portanto, ele apenas vai para o banco de dados, informa que esse objeto foi exclu√≠do, o objeto √© movido para a fila de exclus√£o e, em segundo plano, um profissional especialmente treinado o rob√¥ pega essas chaves e as exclui do armazenamento e do banco de dados.  Tudo aqui tamb√©m √© bastante simples. <br><br>  Escolhemos o PostgreSQL como banco de dados para essa metabase. <br><br>  Voc√™ j√° sabe que n√≥s o amamos muito.  Com a transfer√™ncia do Yandex.Mail, adquirimos experi√™ncia suficiente no PostgreSQL e, quando diferentes servi√ßos de correio foram movidos, desenvolvemos v√°rios padr√µes de sharding.  Um deles caiu bem no S3 com pequenas modifica√ß√µes, mas correu bem l√°. <br><br>  Quais s√£o as op√ß√µes de sharding?  Este √© um reposit√≥rio grande.Em uma escala Yandex, voc√™ deve pensar imediatamente que haver√° muitos objetos, pensar imediatamente em como dividir tudo.  Voc√™ pode fragmentar por hash em nome do objeto, √© a maneira mais confi√°vel, mas n√£o funcionar√° aqui, porque o S3 tem, por exemplo, listagens que devem mostrar a lista de chaves na ordem classificada, quando voc√™ armazena em cache, todas as classifica√ß√µes desaparecem, √© necess√°rio remover todos os objetos para que a sa√≠da esteja em conformidade com a especifica√ß√£o da API. <br><br>  A pr√≥xima op√ß√£o, voc√™ pode compartilhar por hash em nome ou ID do bucket.  Um bucket pode viver dentro de um shard de banco de dados. <br><br>  Outra op√ß√£o √© dividir os intervalos de teclas.  Dentro do balde, h√° espa√ßo de menos infinito a mais infinito, podemos dividi-lo em qualquer n√∫mero de intervalos, chamamos esse intervalo de peda√ßo, ele pode viver em apenas um fragmento. <br><img src="https://habrastorage.org/webt/yw/d3/vh/ywd3vh23mont7zoqjcw6xmcmrbi.jpeg"><br>  Escolhemos a terceira op√ß√£o, cortando por peda√ßos, porque, teoricamente, pode haver um n√∫mero infinito de objetos em um balde, e estupidamente n√£o cabe em um peda√ßo de ferro.  Haver√° grandes problemas, por isso vamos cortar e organizar os cacos como quisermos.  S√≥ isso. <br><img src="https://habrastorage.org/webt/yu/l-/cu/yul-cuz5u4eb5w1hrtzfguio9ro.jpeg"><br>  O que aconteceu?  Todo o banco de dados consiste em tr√™s componentes.  S3 Proxy - um grupo de hosts, tamb√©m h√° um banco de dados.  O PL / Proxy est√° sob o balanceador, as solicita√ß√µes desse back-end voam para l√°.  Al√©m disso, o S3Meta, um grupo de baixo, que armazena informa√ß√µes sobre baldes e peda√ßos.  E o S3DB, shards onde os objetos s√£o armazenados, uma fila de exclus√£o.  Se representado esquematicamente, fica assim. <br><img src="https://habrastorage.org/webt/3y/0n/y9/3y0ny9npaewsndqfusttbvlqczk.jpeg"><br>  Uma solicita√ß√£o √© enviada ao S3Proxy, √© encaminhada ao S3Meta e S3DB e emite informa√ß√µes para o topo. <br><img src="https://habrastorage.org/webt/uw/1s/j1/uw1sj1zph_sjghozg404mmdzhnw.jpeg"><br>  Vamos considerar em mais detalhes.  S3Proxy, fun√ß√µes dentro dele s√£o criadas na linguagem processual PLProxy, √© uma linguagem que permite executar procedimentos ou solicita√ß√µes armazenadas remotamente.  √â assim que o c√≥digo da fun√ß√£o ObjectInfo se parece, em ess√™ncia, com uma solicita√ß√£o Get. <br><br>  O cluster LProxy possui o operador Cluster, neste caso db_ro.  O que isso significa? <br><img src="https://habrastorage.org/webt/59/f8/sp/59f8spslkiczmbu6arwngghstoq.jpeg"><br>  Se uma configura√ß√£o t√≠pica de fragmento de banco de dados, h√° um mestre e duas r√©plicas.  O mestre entra no cluster db_rw, todos os tr√™s hosts inserem db-ro; √© aqui que voc√™ pode enviar apenas uma solicita√ß√£o de leitura e uma solicita√ß√£o de grava√ß√£o √© enviada para db_rw.  O cluster db_rw inclui todos os mestres de todos os shards. <br><br>  A pr√≥xima instru√ß√£o RUN ON, aceita o valor all, o que significa executar em todos os shards uma matriz ou algum tipo de shard.  Nesse caso, ele recebe o resultado da fun√ß√£o get_object_shard como uma entrada; esse √© o n√∫mero do shard no qual o objeto especificado est√°. <br><br>  E target - que fun√ß√£o chama o shard remoto.  Ele chamar√° essa fun√ß√£o e substituir√° os argumentos que voaram para essa fun√ß√£o. <br><img src="https://habrastorage.org/webt/kw/y3/ib/kwy3ib0cemkqipnlkceiaf_vny8.jpeg"><br>  A fun√ß√£o get_object_shard tamb√©m √© gravada em PLProxy, j√° um cluster meta_ro, a solicita√ß√£o ser√° direcionada para o shard S3Meta, que retornar√° essa fun√ß√£o get_bucket_meta_shard. <br><br>  O S3Meta tamb√©m pode ser fragmentado, n√≥s tamb√©m o definimos, enquanto isso √© irrelevante, mas h√° uma oportunidade.  E chamar√° a fun√ß√£o get_object_shard no S3Meta. <br><img src="https://habrastorage.org/webt/cx/t2/am/cxt2amhwudlblfjx2l8vrrzsxce.jpeg"><br>  get_bucket_meta_shard √© apenas um hash de texto em nome de um bucket, embaralhamos o S3Meta apenas por um hash em nome de um bucket. <br><img src="https://habrastorage.org/webt/sd/r9/1x/sdr91x352qh8xpccft-yay_ozqq.jpeg"><br>  Considere o S3Meta o que est√° acontecendo nele.  A informa√ß√£o mais importante que existe √© uma tabela com peda√ßos.  Recortei um pouco algumas informa√ß√µes desnecess√°rias, a coisa mais importante que resta √© bucket_id, a chave de in√≠cio, a chave de t√©rmino e o fragmento em que esta parte est√°. <br><img src="https://habrastorage.org/webt/-n/74/zv/-n74zv7ncle8hcvuj7-_utprjta.jpeg"><br>  Como seria uma consulta em uma tabela desse tipo, que retornaria para n√≥s a parte em que, por exemplo, est√° o objeto de teste?  Assim.  Menos o infinito na forma de texto, n√≥s o apresentamos como um valor nulo; existem pontos sutis que voc√™ precisa verificar nas teclas start_key e end_key √© Null. <br><img src="https://habrastorage.org/webt/ay/1f/cl/ay1fclvy9w-_0xillystohcq8v4.jpeg"><br>  A solicita√ß√£o n√£o parece muito boa e o plano parece ainda pior.  Como uma das op√ß√µes para um plano para essa solicita√ß√£o, BitmapOr.  E 6.000 ossos valem esse plano. <br><img src="https://habrastorage.org/webt/qn/m6/ze/qnm6zelrf6qh2q1gpf4-eaxgzle.jpeg"><br>  Como pode ser diferente?  Existe uma coisa t√£o maravilhosa no PostgreSQL como o √≠ndice gist, que pode indexar o tipo de intervalo, o intervalo √© essencialmente o que precisamos.  N√≥s criamos esse tipo, a fun√ß√£o s3.to_keyrange retorna para n√≥s, de fato, o intervalo.  Podemos verificar com o operador contains, encontrar o peda√ßo em que nossa chave est√°.  E, para isso, a restri√ß√£o de exclus√£o √© criada aqui, o que garante a n√£o interse√ß√£o desses blocos.  Precisamos permitir, de prefer√™ncia no n√≠vel do banco de dados, algumas restri√ß√µes para garantir que os peda√ßos n√£o possam se cruzar entre si, para que apenas uma linha seja retornada em resposta √† solicita√ß√£o.  Caso contr√°rio, n√£o ser√° o que quer√≠amos.  √â assim que o plano para essa solicita√ß√£o √© exibido, o index_scan usual.  Essa condi√ß√£o se encaixa completamente na condi√ß√£o do √≠ndice, e esse plano tem apenas 700 ossos, 10 vezes menos. <br><img src="https://habrastorage.org/webt/fz/ii/el/fziielc9cnipflupcktsoowvmle.jpeg"><br>  O que √© a restri√ß√£o de exclus√£o? <br><img src="https://habrastorage.org/webt/f8/zc/ai/f8zcaicub3p9ob_7n2fkcefww3k.jpeg"><br>  Vamos criar uma tabela de teste com duas colunas e adicionar duas restri√ß√µes, uma √∫nica que todos conhecem e uma restri√ß√£o de exclus√£o, que tem par√¢metros iguais para esses operadores.  Vamos configur√°-lo com dois operadores iguais, essa placa foi constru√≠da. <br><img src="https://habrastorage.org/webt/2o/gb/jx/2ogbjxuanf1sfqxvsaz2nm81a9o.jpeg"><br>  Ent√£o tentamos inserir duas linhas id√™nticas, obtemos o erro de viola√ß√£o da exclusividade da chave na primeira restri√ß√£o.  Se a abandonarmos, j√° violamos a restri√ß√£o de exclus√£o.  Este √© um caso comum de uma restri√ß√£o exclusiva. <br><img src="https://habrastorage.org/webt/rf/jo/5c/rfjo5cabxypgt7ox6nfrptpccgc.jpeg"><br>  De fato, uma restri√ß√£o exclusiva √© a mesma restri√ß√£o de exclus√£o, com os operadores iguais, mas no caso de restri√ß√£o de exclus√£o, √© poss√≠vel criar alguns casos mais gerais. <br><img src="https://habrastorage.org/webt/t4/r5/pw/t4r5pw1rosp_z4hdf72djmkddfy.jpeg"><br>  N√≥s temos esses √≠ndices.  Se voc√™ olhar atentamente, ver√° que ambos s√£o √≠ndices essenciais e, em geral, s√£o os mesmos.  Voc√™ provavelmente pergunta por que duplicar esse neg√≥cio.  Eu vou te contar. <br><img src="https://habrastorage.org/webt/lj/rr/tp/ljrrtplgolj6ipalh4quhrpbqq8.jpeg"><br>  Os √≠ndices s√£o uma coisa, especialmente o √≠ndice essencial, que a tabela vive sua pr√≥pria vida, as atualiza√ß√µes ocorrem, s√£o divididas e assim por diante, o √≠ndice fica ruim por a√≠, deixa de ser ideal.  E existe essa pr√°tica, em particular a extens√£o pg repack, os √≠ndices s√£o reconstru√≠dos periodicamente, de vez em quando s√£o reconstru√≠dos. <br><br>  Como recriar um √≠ndice com uma restri√ß√£o exclusiva?  Crie criar √≠ndice atualmente, crie o mesmo √≠ndice calmamente pr√≥ximo a ele sem bloquear e, em seguida, a express√£o alterar tabela da restri√ß√£o user_index √© tal e tal.  E tudo, tudo √© claro e bom aqui, funciona. <br><br>  No caso de restri√ß√£o de exclus√£o, voc√™ pode reconstru√≠-lo apenas atrav√©s do bloqueio da reindexa√ß√£o, mais precisamente, seu √≠ndice ser√° bloqueado exclusivamente e, na verdade, voc√™ ter√° todas as consultas restantes.  Isso √© inaceit√°vel, o √≠ndice de ess√™ncia pode ser constru√≠do por tempo suficiente.  Portanto, mantemos o pr√≥ximo √≠ndice, que √© menor em volume, ocupa menos espa√ßo, o planador o utiliza e podemos reconstruir esse √≠ndice competitivamente sem bloquear. <br><img src="https://habrastorage.org/webt/4t/5i/j_/4t5ij__ami8qcaik9hwlvyku4sk.jpeg"><br>  Aqui est√° um gr√°fico do consumo do processador.  A linha verde √© o consumo do processador no espa√ßo do usu√°rio, que salta de 50% para 60%.  Neste ponto, o consumo cai acentuadamente, √© o momento em que o √≠ndice √© reconstru√≠do.  N√≥s reconstru√≠mos o √≠ndice, exclu√≠mos o antigo, nosso consumo de processadores caiu acentuadamente.  Este √© um problema do √≠ndice de ess√™ncia e √© um bom exemplo de como isso pode ser. <br><br>  Quando fizemos tudo isso, come√ßamos na vers√£o 9.5 S3DB, de acordo com o plano, planejamos empilhar 10 bilh√µes de objetos em cada shard.  Como voc√™ sabe, mais de um bilh√£o e at√© mesmo problemas anteriores come√ßam quando uma tabela tem muitas linhas, tudo fica muito pior.  Existe uma pr√°tica de separa√ß√£o.  Naquela √©poca, havia duas op√ß√µes, padr√£o por heran√ßa, mas isso n√£o funciona muito bem, pois existe uma velocidade de sele√ß√£o de parti√ß√£o linear.  E, a julgar pelo n√∫mero de objetos, precisamos de muitas parti√ß√µes.  Os caras do Postgres Pro ent√£o cortaram ativamente a extens√£o pg_pathman. <br><img src="https://habrastorage.org/webt/hs/vp/ex/hsvpexzv7ox6fs7ajmyctotqlcw.jpeg"><br>  Escolhemos pg_pathman, n√£o tivemos outra escolha.  Mesmo vers√£o 1.4.  E como voc√™ pode ver, usamos 256 parti√ß√µes.  Dividimos a tabela inteira de objetos em 256 parti√ß√µes. <br><br>  O que faz o pg_pathman?  Usando esta express√£o, voc√™ pode criar 256 parti√ß√µes particionadas por hash na coluna de lances. <br><img src="https://habrastorage.org/webt/5k/5h/x7/5k5hx738e1mzf4f2jcimr7snb9g.jpeg"><br>  Como o pg_pathman funciona? <br><img src="https://habrastorage.org/webt/e7/_b/c2/e7_bc24xsopwt5pvme1xw27lhj4.jpeg"><br>  Ele registra seus ganchos no planador e, posteriormente, sob pedidos, substitui, em ess√™ncia, o plano.  Vimos que ele n√£o pesquisou 256 parti√ß√µes para uma consulta de pesquisa regular para um objeto com o teste de nome, mas imediatamente determinou que era necess√°rio subir na tabela objects_54, mas tudo n√£o estava indo bem aqui, pg_pathman tem seus pr√≥prios problemas.  Em primeiro lugar, havia alguns bugs no in√≠cio, enquanto ele estava serrando, mas gra√ßas aos caras do Postgres Pro, eles rapidamente os consertaram e os consertaram. <br><br>  O primeiro problema √© a dificuldade de atualiz√°-lo.  O segundo problema s√£o declara√ß√µes preparadas. <br><br>  Vamos considerar em mais detalhes.  Em particular, a atualiza√ß√£o.  Em que consiste o pg_pathman? <br><img src="https://habrastorage.org/webt/zj/fp/on/zjfpond4kxp6jbx23zuuls_xxmc.jpeg"><br>  Consiste essencialmente em c√≥digo C, que √© empacotado em uma biblioteca.  E consiste em uma parte SQL, todos os tipos de fun√ß√µes para criar parti√ß√µes, e assim por diante.  Al√©m disso, interfaces para as fun√ß√µes que est√£o na biblioteca.  Essas duas partes n√£o podem ser atualizadas ao mesmo tempo. <br><br>  A partir daqui, surgem dificuldades, algo como este algoritmo para atualizar a vers√£o do pg_pathman, primeiro lan√ßamos um novo pacote com uma nova vers√£o, mas o PostgreSQL tem vers√µes antigas carregadas na mem√≥ria, ele o utiliza.  Isso √© imediatamente em qualquer caso, a base deve ser reiniciada. <br><br>  Em seguida, chamamos a fun√ß√£o set_enable_parent, ela ativa a fun√ß√£o na tabela pai, que √© desativada por padr√£o.  Em seguida, desative o pathman, reinicie o banco de dados, diga ALTER EXTENSION UPDATE, neste momento, tudo cai na tabela pai. <br><br>  Em seguida, ative o pathman e execute a fun√ß√£o, que est√° na extens√£o, que transfere objetos da tabela pai que os atacou nesse curto per√≠odo de tempo, os transfere de volta para as tabelas em que deveriam estar.  E, em seguida, desative o uso da tabela pai, pesquise nela. <br><img src="https://habrastorage.org/webt/i0/vi/wp/i0viwpliiv3stsq2vhn2xoid9su.jpeg"><br>  O pr√≥ximo problema s√£o as declara√ß√µes preparadas. <br><img src="https://habrastorage.org/webt/7a/kn/3v/7akn3vmg3-owux9ywqyqocpn1e0.jpeg"><br>  Se bloquearmos a mesma solicita√ß√£o comum, pesquise por lance e chave, tente execut√°-la.  Execute cinco vezes - tudo est√° bem.  Realizamos o sexto - vemos esse plano.  E a esse respeito, vemos todas as 256 parti√ß√µes.  Se voc√™ observar atentamente essas condi√ß√µes, veremos o d√≥lar 1, o d√≥lar 2, este √© o chamado plano gen√©rico, o plano geral.  As cinco primeiras consultas foram constru√≠das individualmente, os planos individuais foram usados ‚Äã‚Äãpara esses par√¢metros, pg_pathman pode determinar imediatamente, porque o par√¢metro √© conhecido antecipadamente, pode determinar imediatamente a tabela para onde ir.  Nesse caso, ele n√£o pode fazer isso.  Assim, o plano deve ter todas as 256 parti√ß√µes e, quando o executor faz isso, ele executa um bloqueio compartilhado para todas as 256 parti√ß√µes, e o desempenho dessa solu√ß√£o n√£o √© imediato.  Ele simplesmente perde todas as suas vantagens e qualquer solicita√ß√£o √© realizada de maneira insanamente longa. <br><img src="https://habrastorage.org/webt/pg/ny/vr/pgnyvrsmxkaizxhi1ifdazcith8.jpeg"><br>  Como sa√≠mos dessa situa√ß√£o?  Eu tive que agrupar tudo dentro dos procedimentos armazenados em execute, no SQL din√¢mico, para que as instru√ß√µes preparadas n√£o fossem usadas e o plano fosse constru√≠do a cada vez.  √â assim que funciona. <br><br>  A desvantagem √© que voc√™ precisa inserir todo o c√≥digo em estruturas que tocam nessas tabelas.  Isso √© mais dif√≠cil de ler aqui. <br><img src="https://habrastorage.org/webt/rh/6i/p9/rh6ip927nxvaryx5lq7uw80kc_w.jpeg"><br>  Como √© a distribui√ß√£o dos objetos?  Em cada fragmento S3DB, os contadores de fragmentos s√£o armazenados, tamb√©m h√° informa√ß√µes sobre quais fragmentos est√£o nesse fragmento e os contadores s√£o armazenados para eles.  Para cada opera√ß√£o de muta√ß√£o em um objeto - adicionando, excluindo, alterando, reescrevendo - esses contadores para a altera√ß√£o de bloco.  Para n√£o atualizar a mesma linha quando houver vazamento ativo nesse bloco, usamos uma t√©cnica bastante padr√£o quando inserimos um contador delta em uma tabela separada e, a cada minuto, um rob√¥ especial passa e agrega tudo isso, atualiza os contadores no bloco . <br><img src="https://habrastorage.org/webt/xe/rn/hv/xernhvrnmssloj0y6mngbtwi9zg.jpeg"><br>  Al√©m disso, esses contadores s√£o entregues ao S3Meta com algum atraso, j√° existe uma imagem completa de quantos contadores est√£o em qual bloco, ent√£o voc√™ pode ver a distribui√ß√£o por shards, quantos objetos est√£o em que shard e, com base nisso, √© tomada uma decis√£o sobre a queda do novo bloco.  Quando voc√™ cria um bucket, por padr√£o, um √∫nico peda√ßo √© criado de menos infinito a mais infinito, dependendo da distribui√ß√£o atual de objetos que o S3Meta conhece, ele cai em algum tipo de fragmento. <br><br>  Quando voc√™ coloca dados nesse bucket, todos esses dados s√£o inseridos nesse peda√ßo. Quando um determinado tamanho √© atingido, um rob√¥ especial chega e compartilha esse peda√ßo. <br><img src="https://habrastorage.org/webt/6g/9x/jx/6g9xjxmouaqfyz9-lt-d-qnl-fy.jpeg"><br>  Tornamos esses peda√ßos pequenos.  Fazemos isso para que, nesse caso, esse pequeno peda√ßo possa ser arrastado para outro fragmento.  Como acontece uma divis√£o de partes?  Aqui est√° um rob√¥ comum, ele divide e divide esse peda√ßo no S3DB com confirma√ß√£o em duas fases e atualiza as informa√ß√µes no S3Meta. <br><img src="https://habrastorage.org/webt/9p/ec/pg/9pecpg4ivr6x4fbtp4dwgv6rhie.jpeg"><br>  A transfer√™ncia de chunk √© uma opera√ß√£o um pouco mais complicada; √© um commit de duas fases em tr√™s bases, o S3Meta e dois shards, S3DB, arrastados de um para o outro. <br><img src="https://habrastorage.org/webt/re/1o/so/re1osogppbljsj7camywvynnjg4.jpeg"><br>  O S3 tem esse recurso como listagens, isso √© a coisa mais dif√≠cil e tamb√©m houve problemas.  De fato, listagens, voc√™ diz S3 - mostre-me os objetos que tenho.  O par√¢metro destacado em vermelho agora √© Nulo.  Este par√¢metro, delimitador, separador, voc√™ pode especificar as listagens com qual separador deseja. <br><img src="https://habrastorage.org/webt/ws/pg/ld/wspgldab_p7mtvwl1p-2rahx48s.jpeg"><br>  O que isso significa?  Se o del√≠metro n√£o estiver definido, vemos que simplesmente recebemos uma lista de arquivos.  Se definirmos o del√≠metro, em ess√™ncia, o S3 deve nos mostrar as pastas.  Devo entender que existem essas pastas e, de fato, mostra todas as pastas e arquivos na pasta atual.  A pasta atual √© prefixada, este par√¢metro √© Nulo.  Vemos que existem 10 pastas. <br><br>  Todas as chaves n√£o s√£o armazenadas em algum tipo de estrutura hier√°rquica em √°rvore, como no sistema de arquivos.  Cada objeto √© armazenado como uma sequ√™ncia e eles t√™m um prefixo comum simples.  O pr√≥prio S3 deve entender que isso √© um idiota. <br><img src="https://habrastorage.org/webt/pi/3p/dq/pi3pdqgonztctekxsrwxg_go5ra.jpeg"><br>        SQL,      .      ,     PL/pgSQL.       ,   repeatable read.      ,      . ,  -     - ,    . <br><br>        Recursive CTE,       ,   -  ,       execute  PL/pgSQL.   ,      .  , ,  ,    list objects. ,     . <br><img src="https://habrastorage.org/webt/bn/ng/t5/bnngt5vw2so41bmailmlzscffom.jpeg"><br>   ,    . <br><br>      .       ,         . <br><img src="https://habrastorage.org/webt/df/am/2x/dfam2xo8k6ohr6gkv9mo1d5pmsa.jpeg"><br>     Docker,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Behave</a>   Behave   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  .  ,   , ,    . <br><br>      .   ,    ,   CPU  S3Meta. Gist index    CPU,         , . CPU  S3Meta   .   ,      .       PLProxy  ,        S3Meta  S3DB.  ,      .          S3Meta   .  ,    . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na replica√ß√£o l√≥gica, h√° uma s√©rie de problemas que iremos resolver, tentaremos empurr√°-lo para cima. </font><font style="vertical-align: inherit;">A segunda op√ß√£o - voc√™ pode recusar o histograma, tente colocar esse intervalo de texto em btree. </font><font style="vertical-align: inherit;">Este n√£o √© um tipo unidimensional e btree funciona apenas com tipos unidimensionais. </font><font style="vertical-align: inherit;">Mas a condi√ß√£o de que os peda√ßos n√£o se sobreponham conosco nos permitir√° colocar nosso caso em btree. </font><font style="vertical-align: inherit;">Ontem fizemos um prot√≥tipo que funciona. </font><font style="vertical-align: inherit;">√â implementado nas fun√ß√µes PL / pgSQL. </font><font style="vertical-align: inherit;">Temos uma acelera√ß√£o percept√≠vel, vamos otimizar nessa dire√ß√£o.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt417241/">https://habr.com/ru/post/pt417241/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt417231/index.html">Mercadoria corporativa com interface do usu√°rio humana</a></li>
<li><a href="../pt417233/index.html">C√≥digo do Google em 2017</a></li>
<li><a href="../pt417235/index.html">Como as lojas online perdem dinheiro devido a um endere√ßo de formul√°rio de pedido</a></li>
<li><a href="../pt417237/index.html">O que os desenvolvedores ouvem: dos cl√°ssicos √†s trilhas sonoras de jogos - discutimos as mais interessantes</a></li>
<li><a href="../pt417239/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel # 261 (9 a 15 de julho)</a></li>
<li><a href="../pt417243/index.html">Instale o 3CX SBC Session Edge Controller no Windows, Raspberry Pi ou Debian 9</a></li>
<li><a href="../pt417245/index.html">Erlang para IoT</a></li>
<li><a href="../pt417247/index.html">VSCE # 1: Podcast de empreendedores de m√≠dia</a></li>
<li><a href="../pt417249/index.html">C√¢mara de Auditoria dos EUA alerta: SpaceX e Boeing est√£o aguardando novos atrasos, √© poss√≠vel a interrup√ß√£o dos EUA nos v√¥os para a ISS</a></li>
<li><a href="../pt417251/index.html">Usando o olho de peixe no Raspberry Pi 3 com ROS - Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>