<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ωüèø üë®üèΩ‚Äçü§ù‚Äçüë®üèª üèúÔ∏è Wie BGP funktioniert ‚ú¥Ô∏è üèÖ üë°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heute schauen wir uns das BGP-Protokoll an. Wir werden nicht lange dar√ºber sprechen, warum es so ist und warum es als einziges Protokoll verwendet wir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie BGP funktioniert</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450814/">  Heute schauen wir uns das BGP-Protokoll an.  Wir werden nicht lange dar√ºber sprechen, warum es so ist und warum es als einziges Protokoll verwendet wird.  Zu diesem Thema gibt es zum Beispiel sehr viele Informationen. <br><br>  Was ist BGP?  BGP ist ein dynamisches Routing-Protokoll, das das einzige EGP-Protokoll (External Gateway Protocol) ist.  Dieses Protokoll wird zum Erstellen von Routing im Internet verwendet.  √úberlegen Sie, wie die Nachbarschaft zwischen zwei BGP-Routern aufgebaut ist. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" alt="Mein Bild"></a> <br>  Betrachten Sie die Nachbarschaft zwischen Router1 und Router3.  Wir werden sie mit den folgenden Befehlen konfigurieren: <a name="habracut"></a><br><pre><code class="plaintext hljs">router bgp 10 network 192.168.12.0 network 192.168.13.0 neighbor 192.168.13.3 remote-as 10 router bgp 10 network 192.168.13.0 network 192.168.24.0 neighbor 192.168.13.1 remote-as 10</code> </pre> <br>  Die Nachbarschaft innerhalb eines autonomen Systems ist AS 10. Nach Eingabe von Daten auf einem Router, beispielsweise auf Router1, versucht dieser Router, eine Nachbarschaftsbeziehung mit Router3 aufzubauen.  Der Ausgangszustand, in dem nichts passiert, hei√üt <b>Leerlauf</b> .  Sobald bgp auf Router1 konfiguriert ist, h√∂rt es auf den TCP-Port 179 - es wechselt in den Verbindungsstatus und wenn es versucht, eine Sitzung mit Router3 zu √∂ffnen, wechselt es in den <b>aktiven</b> Status. <br><br>  Nachdem die Sitzung zwischen Router1 und Router3 eingerichtet wurde, findet ein offener Nachrichtenaustausch statt.  Wenn diese Nachricht von Router1 gesendet wird, wird dieser Status als " <b>Offen gesendet" bezeichnet</b> .  Wenn eine offene Nachricht von Router3 empfangen wird, wechselt sie in den Status " <b>Offen best√§tigen"</b> .  Betrachten Sie den offenen Beitrag genauer: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" alt="Mein Bild"></a> <br>  Diese Nachricht enth√§lt Informationen zum vom Router verwendeten BGP-Protokoll.  Durch den Austausch offener Nachrichten kommunizieren Router1 und Router3 Informationen √ºber ihre Einstellungen miteinander.  Folgende Parameter werden √ºbergeben: <br><blockquote><ul><li>  <b>Version</b> : Dies schlie√üt die BGP-Version ein, die der Router verwendet.  Die aktuelle Version von BGP ist Version 4, die in RFC 4271 beschrieben ist. Zwei BGP-Router versuchen, eine kompatible Version auszuhandeln. Wenn eine Nicht√ºbereinstimmung vorliegt, findet keine BGP-Sitzung statt. </li><li>  <b>Mein AS</b> : Dies beinhaltet die AS-Nummer des BGP-Routers, die Router m√ºssen sich auf die AS-Nummer (n) einigen und es wird auch definiert, ob sie iBGP oder eBGP ausf√ºhren. </li><li>  <b>Haltezeit</b> : Wenn BGP f√ºr die Dauer der Haltezeit keine Keepalive- oder Aktualisierungsnachrichten von der anderen Seite empf√§ngt, wird die andere Seite f√ºr "tot" erkl√§rt und die BGP-Sitzung abgebrochen.  Standardm√§√üig ist die Haltezeit auf Cisco IOS-Routern auf 180 Sekunden eingestellt. Die Keepalive-Nachricht wird alle 60 Sekunden gesendet.  Beide Router m√ºssen sich auf die Haltezeit einigen, sonst findet keine BGP-Sitzung statt. </li><li>  <b>BGP-Kennung</b> : Dies ist die lokale BGP-Router-ID, die genau wie OSPF gew√§hlt wird: <br><ul><li>  Verwenden Sie die Router-ID, die manuell mit dem Befehl bgp router-id konfiguriert wurde. </li><li>  Verwenden Sie die h√∂chste IP-Adresse auf einer Loopback-Schnittstelle. </li><li>  Verwenden Sie die h√∂chste IP-Adresse auf einer physischen Schnittstelle. </li></ul></li><li>  <b>Optionale Parameter</b> : Hier finden Sie einige optionale Funktionen des BGP-Routers.  Dieses Feld wurde hinzugef√ºgt, damit BGP neue Funktionen hinzugef√ºgt werden k√∂nnen, ohne dass eine neue Version erstellt werden muss. Folgende Dinge finden Sie m√∂glicherweise: <br><br><ul><li>  Unterst√ºtzung f√ºr MP-BGP (Multi Protocol BGP). </li><li>  Unterst√ºtzung f√ºr Route Refresh. </li><li>  Unterst√ºtzung f√ºr 4-Oktett-AS-Nummern. </li></ul></li></ul></blockquote>  Um eine Nachbarschaft zu gr√ºnden, m√ºssen folgende Bedingungen erf√ºllt sein: <br><br><ul><li>  Versionsnummer.  Aktuelle Version 4. </li><li>  Die AS-Nummer muss mit der Nummer √ºbereinstimmen, die Sie als <b>Nachbar 192.168.13.3 remote-as 10</b> konfiguriert haben. </li><li>  Die Router-ID muss sich vom Nachbarn unterscheiden. </li></ul><br>  Wenn einer der Parameter diese Bedingungen nicht erf√ºllt, sendet der Router eine <b>Benachrichtigungsnachricht</b> , in der ein Fehler angezeigt wird.  Nach dem Senden und Empfangen von offenen Nachrichten wechselt die Nachbarschaftsbeziehung in den <b>Status ESTABLISHED</b> .  Danach k√∂nnen Router Informationen √ºber Routen austauschen und dies mithilfe von <b>Aktualisierungsnachrichten</b> tun.  Hier ist eine Update-Nachricht, die Router1 an Router3 sendet: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mein Bild"></a> <br><br>  Geben Sie hier die Netzwerke an, die von den Attributen Router1 und Path gemeldet werden und die den Metriken entsprechen.  Wir werden detaillierter auf Pfadattribute eingehen.  Au√üerdem werden Keepalive-Nachrichten innerhalb der TCP-Sitzung √ºbertragen.  Sie werden standardm√§√üig alle 60 Sekunden √ºbertragen.  Dies ist ein Keepalive-Timer.  Wenn die Keepalive-Nachricht w√§hrend des Hold-Timers nicht empfangen wird, bedeutet dies einen Kommunikationsverlust mit dem Nachbarn.  Standardm√§√üig betr√§gt sie - 180 Sekunden. <br><br>  N√ºtzlicher Teller: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mein Bild"></a> <br><br>  Es scheint herausgefunden zu haben, wie die Router Informationen untereinander √ºbertragen. Versuchen wir nun, die Logik des BGP-Protokolls herauszufinden. <br><br>  Um eine Route zur BGP-Tabelle anzuk√ºndigen, wird wie in den IGP-Protokollen der Netzwerkbefehl verwendet, die Betriebslogik ist jedoch unterschiedlich.  Wenn IGP in IGP nach Angabe einer Route im Netzwerkbefehl pr√ºft, welche Schnittstellen zu diesem Subnetz geh√∂ren, und diese in seine Tabelle aufnimmt, sucht der Netzwerkbefehl in BGP in der Routing-Tabelle nach einer <b>genauen</b> √úbereinstimmung mit der Route im Netzwerkbefehl.  Wenn diese gefunden werden, fallen diese Routen in die BGP-Tabelle. <br><blockquote>  Suchen Sie in der aktuellen IP-Routing-Tabelle des Routers nach einer Route, die genau den Parametern des Netzwerkbefehls entspricht.  Wenn die IP-Route vorhanden ist, f√ºgen Sie den entsprechenden NLRI in die lokale BGP-Tabelle ein. </blockquote>  Jetzt erh√∂hen wir den BGP auf alle verbleibenden und sehen, wie die Route innerhalb eines AS ausgew√§hlt wird.  Nachdem der BGP-Router Routen vom Nachbarn empfangen hat, beginnt die Auswahl der optimalen Route.  Hier m√ºssen Sie verstehen, welche Art von Nachbarn sein k√∂nnen - intern und extern.  Versteht der Konfigurationsrouter, ob der konfigurierte Nachbar intern oder extern ist?  Wenn in einem Team: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.13.3 remote-as 10</code> </pre> <br>  Als Remote-as-Parameter wird der AS angegeben, der auf dem Router selbst mit dem Befehl router bgp 10 konfiguriert wird. Routen, die vom internen AS stammen, werden als intern und Routen vom externen AS als extern betrachtet.  Und in Bezug auf jedes funktioniert eine andere Logik des Empfangens und Sendens.  Betrachten Sie die folgende Topologie: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" alt="Mein Bild"></a> <br><br>  Jeder Router verf√ºgt √ºber eine Loopback-Schnittstelle, die mit ip konfiguriert ist: xxxx 255.255.255.0 - wobei x die Nummer des Routers ist.  Auf Router9 haben wir eine Loopback-Schnittstelle mit der Adresse - 9.9.9.9 255.255.255.0.  Wir werden es auf BGP bekannt geben und sehen, wie es verteilt wird.  Diese Route wird an Router8 und Router12 √ºbertragen.  Bei Router8 wird diese Route zu Router6 geleitet, bei Router5 jedoch nicht in der Routing-Tabelle.  Auf Router12 wird diese Route ebenfalls in die Tabelle aufgenommen, auf Router11 jedoch auch nicht.  Versuchen wir es herauszufinden.  √úberlegen Sie, welche Daten und Parameter von Router9 an seine Nachbarn √ºbertragen werden, und melden Sie diese Route.  Das folgende Paket wird von Router9 an Router8 gesendet. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" alt="Mein Bild"></a> <br>  Routeninformationen bestehen aus Pfadattributen. <br><br>  Pfadattribute sind in 4 Kategorien unterteilt: <br><br><ol><li>  <b>Bekannt obligatorisch</b> - Alle BGP-Router m√ºssen diese Attribute erkennen.  Muss in allen Updates vorhanden sein. </li><li>  <b>Bekannter Ermessensspielraum</b> - Alle BGP-Router m√ºssen diese Attribute erkennen.  Sie k√∂nnen in Updates vorhanden sein, ihre Anwesenheit ist jedoch nicht erforderlich. </li><li>  <b>Optionales Transitiv</b> - wird m√∂glicherweise nicht von allen BGP-Implementierungen erkannt.  Wenn der Router das Attribut nicht erkennt, markiert er die Aktualisierung als teilweise und sendet sie weiter an die Nachbarn, wobei das nicht erkannte Attribut beibehalten wird. </li><li>  <b>Optional nicht transitiv</b> - wird m√∂glicherweise nicht von allen BGP-Implementierungen erkannt.  Wenn der Router das Attribut nicht erkennt, wird das Attribut ignoriert und bei der √úbertragung an Nachbarn verworfen. </li></ol><br>  Beispiele f√ºr BGP-Attribute: <br><br><ul><li>  <b>Bekannte Pflicht</b> : <br><ul><li>  Autonomer Systempfad </li><li>  N√§chster Sprung </li><li>  Herkunft </li></ul><br></li><li>  <b>Bekannter Ermessensspielraum</b> : <br><ul><li>  Lokale Pr√§ferenz </li><li>  Atomaggregat </li></ul></li><li>  <b>Optionaler Transitiv</b> : <br><ul><li>  Aggregator </li><li>  Gemeinschaften </li></ul></li><li>  <b>Optional nicht transitiv</b> : <br><ul><li>  Multi-Exit-Diskriminator (MED) </li><li>  Absender-ID </li><li>  Clusterliste </li></ul></li></ul><br>  In diesem Fall interessieren wir uns f√ºr Origin, Next-Hop, AS Path.  Da die Route zwischen Router8 und Router9 verl√§uft, dh innerhalb desselben AS, wird sie als intern betrachtet und wir werden auf Origin achten. <br><br>  Ursprungsattribut - Gibt an, wie die Route beim Update empfangen wurde.  M√∂gliche Attributwerte: <br><br><ul><li>  0 - IGP: NLRI, das innerhalb des urspr√ºnglichen autonomen Systems erhalten wurde; </li><li>  1 - EGP: NLRI, gelernt vom Exterior Gateway Protocol (EGP).  BGP-Vorg√§nger, nicht verwendet </li><li>  2 - Unvollst√§ndig: NLRI wurde auf andere Weise gelernt </li></ul><br>  In unserem Fall ist es, wie aus dem Paket ersichtlich ist, 0. Wenn diese Route an Router12 √ºbertragen wird, hat dieser Code den Code - 1. <br><br>  Als n√§chstes Next-Hop.  Next-Hop-Attribut <br><br><ul><li>  Dies ist die IP-Adresse des eBGP-Routers, √ºber den der Pfad zum Zielnetzwerk verl√§uft. </li><li>  Das Attribut √§ndert sich, wenn das Pr√§fix an einen anderen AS √ºbergeben wird. </li></ul><br>  Im Fall von iBGP, dh innerhalb eines AS, wird Next-Hop als derjenige angezeigt, der von dieser Route erfahren oder erz√§hlt hat.  In unserem Fall ist es 192.168.89.9.  Wenn diese Route jedoch von Router8 auf Router6 √ºbertragen wird, √§ndert Router8 sie und ersetzt sie durch eine eigene.  Der n√§chste Sprung wird - 192.168.68.8 sein.  Dies f√ºhrt uns zu zwei Regeln: <br><br><ol><li>  Wenn der Router die Route an seinen internen Nachbarn weiterleitet, √§ndert er den Next-Hop-Parameter nicht. </li><li>  Wenn der Router die Route an seinen externen Nachbarn sendet, √§ndert er den Next-Hop in die IP der Schnittstelle, von der dieser Router sendet. </li></ol><br>  Dies f√ºhrt uns zum Verst√§ndnis des ersten Problems - Warum es in der Routing-Tabelle auf Router5 und Router11 keine Route gibt.  Lassen Sie uns genauer betrachten.  Daher hat Router6 die Routeninformationen 9.9.9.0/24 empfangen und sicher zur Routing-Tabelle hinzugef√ºgt: <br><br><pre> <code class="plaintext hljs">Router6#show ip route bgp Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 E1 - OSPF external type 1, E2 - OSPF external type 2 i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 ia - IS-IS inter area, * - candidate default, U - per-user static route o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP a - application route + - replicated route, % - next hop override, p - overrides from PfR Gateway of last resort is not set 9.0.0.0/24 is subnetted, 1 subnets B 9.9.9.0 [20/0] via 192.168.68.8, 00:38:25</code> </pre> <br>  Jetzt hat Router6 die Route Router5 √ºbergeben und die erste Next-Hop-Regel nicht ge√§ndert.  Das hei√üt, Router5 sollte <b>9.9.9.0 [20/0] √ºber 192.168.68.8</b> hinzuf√ºgen, hat jedoch keine Route zu 192.168.68.8 und daher wird diese Route nicht hinzugef√ºgt, obwohl Informationen zu dieser Route in der BGP-Tabelle gespeichert werden: <br><br><pre> <code class="plaintext hljs">&lt;b&gt;Router5#show ip bgp BGP table version is 1, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * i 9.9.9.0/24 192.168.68.8 0 100 0 45 i&lt;/b&gt;</code> </pre> <br>  Die gleiche Situation tritt zwischen Router11 und Router12 auf.  Um eine solche Situation zu vermeiden, muss konfiguriert werden, dass Router6 oder Router12, die die Route an ihre internen Nachbarn weitergeben, ihre IP-Adresse als Next-Hop ersetzen.  Dies geschieht mit dem folgenden Befehl: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.56.5 next-hop-self</code> </pre> <br>  Nach diesem Befehl sendet Router6 eine Aktualisierungsnachricht, in der f√ºr die Routen als Next-Hop die IP der Gi0 / 0-Schnittstelle von Router6 angezeigt wird - 192.168.56.6. Danach befindet sich diese Route bereits in der Routing-Tabelle. <br><br>  Lassen Sie uns sehen, ob diese Route auf Router7 und Router10 angezeigt wird.  Es wird nicht in der Routing-Tabelle angezeigt und wir denken m√∂glicherweise, dass das Problem wie im ersten mit dem Next-Hop-Parameter ist. Wenn wir uns jedoch die Ausgabe des Befehls show ip bgp ansehen, werden wir feststellen, dass die Route dort auch mit dem falschen Next-Hop nicht empfangen wurde bedeutet, dass die Route nicht einmal √ºbertragen wurde.  Und dies wird uns zur Existenz einer anderen Regel f√ºhren: <br><blockquote>  Von internen Nachbarn empfangene Routen werden nicht an andere interne Nachbarn √ºbertragen. </blockquote>  Da Router5 die Route von Router6 empfangen hat, wird sie nicht an seinen anderen internen Nachbarn √ºbertragen.  Damit die √úbertragung stattfinden kann, m√ºssen Sie die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Route Reflector-</a> Funktion konfigurieren oder vollst√§ndig verbundene Nachbarschaftsbeziehungen (Full Mesh) konfigurieren, dh Router5-7 ist jeweils ein Nachbar.  In diesem Fall verwenden wir den Routenreflektor.  Auf Router5 m√ºssen Sie diesen Befehl verwenden: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.57.7 route-reflector-client</code> </pre> <br>  Route-Reflector √§ndert das Verhalten von BGP beim √úbertragen einer Route an einen internen Nachbarn.  Wenn der interne Nachbar als <b>Route-Reflector-Client angegeben ist</b> , werden diesen Clients interne Routen angek√ºndigt. <br><br>  Wurde die Route nicht auf Router7 angezeigt?  Vergessen Sie auch nicht Next-Hop.  Nach diesen Manipulationen sollte die Route auch auf Router7 erfolgen, dies geschieht jedoch nicht.  Dies bringt uns zu einer anderen Regel: <br><blockquote>  Die Next-Hop-Regel funktioniert nur f√ºr externe Routen.  Bei internen Routen wird das Next-Hop-Attribut nicht ersetzt. </blockquote><br>  Und wir bekommen eine Situation, in der Sie eine Umgebung mit statischem Routing oder IGP erstellen m√ºssen, um Router √ºber alle Routen innerhalb des AS zu informieren.  Wir werden die statischen Routen auf Router6 und Router7 registrieren und danach die gew√ºnschte Route in der Tabelle des Routers erhalten.  In AS 678 werden wir etwas anders vorgehen - wir werden die statischen Routen f√ºr 192.168.112.0/24 auf Router10 und 192.168.110.0/24 auf Router12 schreiben.  Als n√§chstes stellen wir die Nachbarschaftsbeziehung zwischen Router10 und Router12 her.  Wir konfigurieren Router12 auch so, dass sein n√§chster Hop f√ºr Router10 gesendet wird: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.110.10 next-hop-self</code> </pre> <br>  Das Ergebnis ist, dass Router10 die Route 9.9.9.0/24 empf√§ngt, die sowohl von Router7 als auch von Router12 empfangen wird.  Mal sehen, welche Wahl Router10 trifft: <br><br><pre> <code class="plaintext hljs">Router10#show ip bgp BGP table version is 3, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.112.12 0 100 0 45 i 192.168.107.7 0 123 45 i</code> </pre> <br>  Wie wir sehen k√∂nnen, bedeuten zwei Routen und ein Pfeil (&gt;), dass die Route durch 192.168.112.12 ausgew√§hlt ist. <br>  Mal sehen, wie der Routenauswahlprozess abl√§uft: <br><br><ol><li>  Zun√§chst wird nach Erhalt der Route die Verf√ºgbarkeit des n√§chsten Hops √ºberpr√ºft.  Aus diesem Grund wurde diese Route nicht weiter zur Verarbeitung √ºbermittelt, als wir eine Route auf Router5 ohne Einstellung von Next-Hop-Self erhalten haben. </li><li>  Als n√§chstes kommt der Weight-Parameter.  Dieser Parameter ist kein Pfadattribut (PA) und wird nicht in BGP-Nachrichten √ºbertragen.  Es wird lokal auf jedem Router konfiguriert und nur zur Manipulation der Routenauswahl auf dem Router selbst verwendet.  Betrachten Sie ein Beispiel.  Es ist oben gezeigt, dass Router10 die Route f√ºr 9.9.9.0/24 √ºber Router12 (192.168.112.12) gew√§hlt hat.  Um den Wieght-Parameter zu √§ndern, k√∂nnen Sie mithilfe der Routenkarte bestimmte Routen festlegen oder dem Nachbarn mit dem folgenden Befehl Gewicht zuweisen: <br><br><pre> <code class="plaintext hljs"> neighbor 192.168.107.7 weight 200</code> </pre> <br>  Jetzt haben alle Routen von diesem Nachbarn ein solches Gewicht.  Mal sehen, wie sich die Routenwahl nach dieser Manipulation √§ndert: <br><br><pre> <code class="plaintext hljs">Router10#show bgp *Mar 2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 192.168.107.7 200 123 45 i * i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Wie Sie sehen k√∂nnen, ist jetzt die Route durch Router7 ausgew√§hlt, dies hat jedoch keine Auswirkungen auf die anderen Router. </li><li>  An dritter Stelle haben wir - Lokale Pr√§ferenz.  Dieser Parameter ist ein bekanntes diskretion√§res Attribut, was bedeutet, dass sein Vorhandensein optional ist.  Dieser Parameter ist nur innerhalb eines AS g√ºltig und wirkt sich nur f√ºr interne Nachbarn auf die Pfadwahl aus.  Aus diesem Grund wird es nur in Aktualisierungsnachrichten √ºbertragen, die f√ºr den internen Nachbarn bestimmt sind.  In Update-Nachrichten f√ºr externe Nachbarn fehlt es.  Daher wurde er dem bekannten Ermessensspielraum zugewiesen.  Versuchen wir es auf Router5 anzuwenden.  Auf Router5 sollten wir zwei Routen f√ºr 9.9.9.0/24 haben - eine √ºber Router6 und die zweite √ºber Router7. <br><br>  Wir schauen: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 2, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i</code> </pre> <br>  Aber wie Sie eine Route durch Router6 sehen k√∂nnen.  Und wo ist die Route durch Router7?  Vielleicht existiert es nicht einmal auf Router7?  Wir schauen: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 10, local router ID is 7.7.7.7 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i 192.168.107.10 0 678 45 i</code> </pre> <br>  Seltsam, alles scheint in Ordnung zu sein.  Warum wird es nicht an Router5 √ºbertragen?  Die Sache ist, dass BGP eine Regel hat: <br><blockquote>  Der Router √ºbertr√§gt nur die Routen, die er selbst verwendet. </blockquote><br>  Router7 verwendet die Route durch Router5, sodass die Route durch Router10 nicht √ºbertragen wird.  Zur√ºck zur lokalen Pr√§ferenz.  Lassen Sie uns die lokalen Einstellungen f√ºr Router7 festlegen und sehen, wie Router5 darauf reagiert: <br><br><pre> <code class="plaintext hljs">route-map BGP permit 10 match ip address 10 set local-preference 250 access-list 10 permit any router bgp 123 neighbor 192.168.107.10 route-map BGP in&lt;/b&gt;</code> </pre> <br>  Also haben wir eine Routenkarte erstellt, in die alle Routen fallen, und Router7 angewiesen, den Parameter Local Preference beim Empfang auf 250 zu √§ndern. Standardm√§√üig ist es 100. Wir sehen uns an, was auf Router5 passiert ist: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 8, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.57.7 0 250 0 678 45 i</code> </pre> <br>  Wie wir jetzt sehen, bevorzugt Router5 die Route durch Router7.  Das gleiche Bild wird auf Router6 zu sehen sein, obwohl es f√ºr ihn rentabler ist, eine Route √ºber Router8 zu w√§hlen.  Wir f√ºgen hinzu, dass eine √Ñnderung dieses Parameters einen Neustart der Nachbarschaft erfordert, damit die √Ñnderung wirksam wird.  Lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Mit lokalen Einstellungen aussortiert.  Gehen Sie zum n√§chsten Parameter. </li><li>  Routenpr√§ferenz mit Next-Hop-Parameter 0.0.0.0, d. H. Lokale oder aggregierte Routen.  Nach Eingabe des Netzwerkbefehls wird diesen Routen automatisch der Parameter Weight zugewiesen, der dem Maximum entspricht - 32678: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 2, local router ID is 9.9.9.9 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 0.0.0.0 0 32768 i</code> </pre> </li><li>  Der k√ºrzeste Weg durch AS.  Der k√ºrzeste Parameter AS_Path ist ausgew√§hlt.  Je weniger AS die Route durchquert, desto besser ist sie.  Betrachten Sie die Route zu 9.9.9.0/24 auf Router10: <br><br><pre> <code class="plaintext hljs">Router10#show bgp BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * 9.9.9.0/24 192.168.107.7 0 123 45 i *&gt;i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Wie Sie sehen k√∂nnen, hat Router10 die Route bis 192.168.112.12 ausgew√§hlt, da der Parameter AS_Path nur 45 f√ºr diese Route und 123 und 45 im anderen Fall enth√§lt. Intuitiv. </li><li>  Der n√§chste Parameter ist Origin.  IGP (Route erhalten mit BGP) ist besser als EGP (Route erhalten mit BGP-Vorg√§nger, wird jetzt nicht verwendet), und EGP ist besser als unvollst√§ndig?  (auf andere Weise erhalten, zum Beispiel durch Umverteilung). </li><li>  Der n√§chste Parameter ist MED.  Wir hatten Wieght, das nur lokal am Router funktionierte.  Es gab eine lokale Pr√§ferenz, die nur innerhalb eines autonomen Systems funktionierte.  Wie Sie sich vorstellen k√∂nnen, ist MED ein Parameter, der zwischen autonomen Systemen √ºbertragen wird.  Sehr guter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> zu dieser Option. </li></ol><br>  Weitere Attribute werden nicht verwendet. Wenn jedoch die beiden Routen dieselben Attribute haben, werden die folgenden Regeln verwendet: <br><br><ol><li>  W√§hlen Sie einen Pfad durch den n√§chsten IGP-Nachbarn. </li><li>  W√§hlen Sie die √§lteste Route f√ºr den eBGP-Pfad. </li><li>  W√§hlen Sie einen Pfad durch den Nachbarn mit der niedrigsten BGP-Router-ID. </li><li>  W√§hlen Sie einen Pfad durch den Nachbarn mit der niedrigsten IP-Adresse. </li></ol><br>  <b>Betrachten Sie nun das Problem der BGP-Konvergenz.</b> <br><br>  Mal sehen, was passiert, wenn beispielsweise Router6 die Route 9.9.9.0/24 durch Router9 verliert.  Schalten Sie die Gi0 / 1 Router6-Schnittstelle aus, die sofort erkennt, dass die BGP-Sitzung mit Router8 getrennt und der Nachbar weg ist, was bedeutet, dass die von ihr empfangene Route ung√ºltig ist.  Router6 sendet sofort Aktualisierungsnachrichten, in denen das Netzwerk 9.9.9.0/24 im Feld Zur√ºckgezogene Routen angezeigt wird.  Sobald Router5 eine √§hnliche Nachricht empf√§ngt, senden Sie diese an Router7.  Da Router7 jedoch eine Route √ºber Router10 hat, sendet er sofort ein Update mit einer neuen Route als Antwort.  Wenn der Sturz des Nachbarn vom Status der Schnittstelle nicht erkannt werden kann, m√ºssen Sie warten, bis der Hold-Timer ausgel√∂st wird. <br><br>  <b>Konf√∂deration.</b> <br><br>  Wenn Sie sich erinnern, haben wir dar√ºber gesprochen, dass Sie h√§ufig eine vollst√§ndig verbundene Topologie verwenden m√ºssen.  Bei einer gro√üen Anzahl von Routern in einem AS kann dies zu gro√üen Problemen f√ºhren. Um dies zu vermeiden, m√ºssen Konf√∂derationen verwendet werden.  Ein AS ist in mehrere Unter-AS unterteilt, sodass er ohne die Notwendigkeit einer vollst√§ndig verbundenen Topologie arbeiten kann. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" alt="Mein Bild"></a> <br><br>  Hier ist ein Link zu diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Labor</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier ist die</a> Konfiguration f√ºr GNS3. <br><br> ,           AS 2345  ,   Confederation,             .    .      AS 2345,  <b>laForge</b>    <b>Picard</b>     <b>Data</b>  <b>Worf</b> ,         <b>Crusher</b> .  ,     <b>laForge</b> ,     <b>Crusher</b>  <b>Worf</b> -,  <b>Data</b> . <br><br>    Route-Reflector    .   AS 2345  4 sub-AS ( 2,3,4,5)   ,       .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . <br><br>  Quellen: <br><br><ol><li> CCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">xgu.ru</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GNS3Vault</a> . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de450814/">https://habr.com/ru/post/de450814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de450802/index.html">Legacy-Ausfall</a></li>
<li><a href="../de450804/index.html">3D-Metalldruck in der Automobilindustrie: klein anfangen</a></li>
<li><a href="../de450806/index.html">Wenn eine Umgebungsvariable den Prozess um das 40-fache beschleunigt</a></li>
<li><a href="../de450810/index.html">Top 7 M√∂glichkeiten, um die Kompetenzen von IT-Spezialisten vor dem Interview schnell zu √ºberpr√ºfen</a></li>
<li><a href="../de450812/index.html">PSR-14 - das Hauptereignis in PHP</a></li>
<li><a href="../de450816/index.html">HTTP-Header f√ºr den verantwortlichen Entwickler</a></li>
<li><a href="../de450818/index.html">Von der hohen Ceph-Latenz zum Kernel-Patch mit eBPF / BCC</a></li>
<li><a href="../de450820/index.html">FrontendConf-Programmkomitee: Rahmenbedingungen, Horizonte, Welterfahrung und Mission der Konferenz</a></li>
<li><a href="../de450822/index.html">Verschwindende Rahmenbedingungen</a></li>
<li><a href="../de450824/index.html">Der Zustand von CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>