<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèø ü§∞üèª ü§∂üèª Biblioteca de gerador de c√≥digo Assembler para microcontroladores AVR. Parte 3 ü§í üßóüèª ‚ûñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üê Parte 2. Introdu√ß√£o 
 Parte 4. Programa√ß√£o de dispositivos perif√©ricos e manipula√ß√£o de interrup√ß√µes ‚Üí 
 Biblioteca do gerador de c√≥digo do assemble...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Biblioteca de gerador de c√≥digo Assembler para microcontroladores AVR. Parte 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463123/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üê Parte 2. Introdu√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 4. Programa√ß√£o de dispositivos perif√©ricos e manipula√ß√£o de interrup√ß√µes ‚Üí</a> </p><br><h2 id="biblioteka-generatora-assemblernogo-koda-dlya-mikrokontrollerov-avr">  Biblioteca do gerador de c√≥digo do assembler para microcontroladores AVR </h2><br><h3 id="chast-3-kosvennaya-adresaciya-i-upravlenie-potokom-ispolneniya">  Parte 3. Endere√ßamento indireto e controle de fluxo </h3><br><p>  Na parte anterior, detalhamos bastante o trabalho com vari√°veis ‚Äã‚Äãde registro de 8 bits.  Se voc√™ perdeu o post anterior, aconselho a l√™-lo.  Nele, voc√™ pode encontrar um link para a biblioteca para experimentar os exemplos no artigo.  Para quem baixou a biblioteca anteriormente, recomendo baixar a vers√£o mais recente, pois a biblioteca √© atualizada constantemente e alguns exemplos podem n√£o funcionar na vers√£o antiga da biblioteca. </p><a name="habracut"></a><br><p>  Infelizmente, as profundidades de bits das vari√°veis ‚Äã‚Äãde registro consideradas anteriormente claramente n√£o s√£o suficientes para serem usadas como ponteiros de mem√≥ria.  Portanto, antes de prosseguir diretamente para a discuss√£o de ponteiros, consideramos outra classe de descri√ß√£o de dados.  A maioria dos comandos na arquitetura AVR Mega √© projetada para funcionar apenas com operandos de registro, ou seja, ambos os operandos e o resultado t√™m tamanho de 8 bits.  No entanto, existem v√°rias opera√ß√µes em que dois registros RON localizados consecutivamente s√£o considerados como um √∫nico registro de 16 bits.  Existem poucas opera√ß√µes desse tipo, e elas est√£o focadas principalmente no trabalho com ponteiros. </p><br><p>  Do ponto de vista da sintaxe da biblioteca, trabalhar com um par de registradores √© quase o mesmo que trabalhar com uma vari√°vel de registrador.  Considere um pequeno exemplo em que tentamos trabalhar com um par de registradores.  Para economizar espa√ßo aqui e abaixo, forneceremos o resultado da execu√ß√£o somente onde for necess√°rio explicar certos recursos da gera√ß√£o de c√≥digo. </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr1 = m.DREG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr2 = m.DREG(); dr1.Load(<span class="hljs-number"><span class="hljs-number">0xAA55</span></span>); dr2.Load(<span class="hljs-number"><span class="hljs-number">0x55AA</span></span>); dr1++; dr1--; dr1 += <span class="hljs-number"><span class="hljs-number">0x100</span></span>; dr1 += dr2; dr2 *= dr1; dr2 /= dr1; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Neste exemplo, declaramos duas vari√°veis ‚Äã‚Äãde 2 bytes localizadas em pares de registradores usando o comando DREG ().  Com os seguintes comandos, atribu√≠mos a eles o valor inicial e executamos uma s√©rie de opera√ß√µes aritm√©ticas.  Como voc√™ pode ver no exemplo, a sintaxe para trabalhar com um par de registradores √© basicamente a mesma que trabalhar com um registrador regular.  Um par de registradores tamb√©m pode ser considerado como uma vari√°vel composta por dois registradores independentes.  O registro √© acessado como um conjunto de dois registros de 8 bits atrav√©s da propriedade <em>High</em> para acessar os 8 bits superiores como um registro de 8 bits, e a propriedade <em>Low</em> para acessar os 8 bits inferiores.  O c√≥digo ficar√° assim </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dr1 = m.DREG(); dr1.Load(<span class="hljs-number"><span class="hljs-number">0xAA55</span></span>); dr1.Low--; dr1.High += dr1.Low; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Como voc√™ pode ver no exemplo, podemos trabalhar com <em>High</em> e <em>Low</em> como vari√°veis ‚Äã‚Äãde registro independentes, incluindo a execu√ß√£o de v√°rias opera√ß√µes aritm√©ticas e l√≥gicas entre elas. </p><br><p>  Agora que descobrimos vari√°veis ‚Äã‚Äãde tamanho duplo, podemos come√ßar a descrever como trabalhar com vari√°veis ‚Äã‚Äãna mem√≥ria.  A biblioteca permite que voc√™ trabalhe com vari√°veis ‚Äã‚Äãde 8, 16 bits e matrizes de bytes de comprimento arbitr√°rio.  Considere um exemplo de aloca√ß√£o de espa√ßo para vari√°veis ‚Äã‚Äãna RAM. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt = m.BYTE(); <span class="hljs-comment"><span class="hljs-comment">//8-    var wd = m.WORD(); //16-    var arr = m.ARRAY(16); //  16  var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Vamos ver o que aconteceu. </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0001</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0000</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 1</span></span></code> </pre> <br><p>  Na se√ß√£o de defini√ß√£o de dados, temos uma aloca√ß√£o de mem√≥ria.  Observe que a ordem de aloca√ß√£o √© diferente da declara√ß√£o de vari√°veis.  Isso n√£o √© coincid√™ncia.  A aloca√ß√£o de mem√≥ria para vari√°veis ‚Äã‚Äãocorre ap√≥s a classifica√ß√£o em ordem decrescente, de acordo com os seguintes crit√©rios (em ordem decrescente de import√¢ncia) O m√∫ltiplo m√°ximo de divisor de grau 2 ‚Üí O tamanho da mem√≥ria alocada.  Isso significa que, se quisermos alocar 4 matrizes de tamanho de 64, 48,40 e 16 bytes, a ordem de aloca√ß√£o, independentemente da ordem da declara√ß√£o, ter√° a seguinte apar√™ncia: </p><br><p>  Comprimento 64 - M√∫ltiplos divisores m√°ximos de grau 2 = 64 <br>  Comprimento 48 - M√∫ltiplos divisores m√°ximos de grau 2 = 16 <br>  Comprimento 16 - M√∫ltiplo m√°ximo de divisor de grau 2 = 16 <br>  Comprimento 40 - M√∫ltiplos divisores m√°ximos de grau 2 = 8 <br>  Isso √© feito para simplificar o controle dos limites da matriz. <br>  e reduza o tamanho do c√≥digo nas opera√ß√µes com ponteiros.  N√£o podemos executar diretamente nenhuma opera√ß√£o com vari√°veis ‚Äã‚Äãna mem√≥ria; portanto, tudo o que est√° dispon√≠vel para n√≥s √© a leitura / grava√ß√£o para registrar vari√°veis.  A maneira mais simples de trabalhar com vari√°veis ‚Äã‚Äãna mem√≥ria √© o endere√ßamento direto. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt = m.BYTE(); <span class="hljs-comment"><span class="hljs-comment">// 8-    var rr = m.REG(); //    rr.Load(0xAA); //  rr   0xAA rr.Mstore(bt); //     rr.Clear(); //  rr.Mload(bt); //    var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Neste exemplo, declaramos uma vari√°vel na mem√≥ria e uma vari√°vel de registro.  Depois disso, atribu√≠mos √† vari√°vel o valor 0x55 e escrevemos na vari√°vel na mem√≥ria.  Depois apagado e restaurado de volta. </p><br><p>  Para trabalhar com elementos de matriz, usamos a seguinte sintaxe </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">10</span></span>); rr.MLoad(arr[<span class="hljs-number"><span class="hljs-number">5</span></span>]);</code> </pre> <br><p>  A numera√ß√£o dos elementos na matriz come√ßa com 0. Portanto, no exemplo acima, o valor 6 do elemento da matriz √© gravado na c√©lula rr. </p><br><p>  Agora voc√™ pode ir para o endere√ßamento indireto.  A biblioteca possui seu pr√≥prio tipo de dados para um ponteiro para o espa√ßo de mem√≥ria RAM - <em>MEMPtr</em> .  Vamos ver como podemos us√°-lo.  Modificamos nosso exemplo anterior para que o trabalho com a vari√°vel na mem√≥ria seja realizado atrav√©s do ponteiro. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt1 = m.BYTE(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt2 = m.BYTE(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); <span class="hljs-comment"><span class="hljs-comment">//  ptr ptr.Load(bt1); //ptr   bt1 rr.Load(0xAA); // rr - 0xAA ptr.MStore(rr); //  bt1 0xAA rr.Load(0x55); // rr - 0x55 ptr.Load(bt2); //ptr   bt2 ptr.MStore(rr); //  bt2 0x55 ptr.Load(bt1); //ptr   bt1 ptr.MLoad(rr); //  rr  0xAA var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Pode ser visto no texto que declaramos primeiro o <em>ponteiro ptr</em> e, em seguida, executamos opera√ß√µes de grava√ß√£o e leitura com ele.  Al√©m da capacidade de alterar o endere√ßo de leitura / grava√ß√£o no comando durante a execu√ß√£o, o uso do ponteiro simplifica o trabalho com matrizes, combinando a opera√ß√£o de leitura / grava√ß√£o com o incremento / decremento do ponteiro.  Vejamos um programa que pode preencher uma matriz com um valor espec√≠fico. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bt1 = m.ARRAY(<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   4  var rr = m.REG(); var ptr = m.MEMPTR(); ptr.Load(bt1.Label); //ptr   bt1 rr.Load(0xAA); // rr - 0xAA ptr.MStoreInc(rr); //  bt1 0xAA ptr.MStoreInc(rr); //  bt1+1 0xAA ptr.MStoreInc(rr); //  bt1+2 0xAA ptr.MStoreInc(rr); //  bt1+3 0xAA rr.Clear(); rr.MLoad(bt1[2]); //  rr 3-   var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Neste exemplo, aproveitamos a capacidade de incrementar um ponteiro ao gravar na mem√≥ria. <br>  Em seguida, passamos √† capacidade da biblioteca de controlar o fluxo de comandos.  Se for mais f√°cil, como programar saltos e loops condicionais e incondicionais usando a biblioteca.  A maneira mais f√°cil de gerenciar isso √© usar comandos de navega√ß√£o de etiqueta.  Os r√≥tulos de um programa s√£o declarados de duas maneiras diferentes.  A primeira √© que, com a equipe <em>AVRASM.Label</em> , criamos um r√≥tulo para uso futuro, mas n√£o o inserimos no c√≥digo do programa.  Este m√©todo √© usado para criar saltos para frente, ou seja, nos casos em que o comando de salto deve preceder o r√≥tulo.  Para definir o r√≥tulo no local necess√°rio do c√≥digo do assembler, voc√™ deve executar o comando <em>AVRASM.newLabel ([vari√°vel do r√≥tulo criado anteriormente])</em> .  Para voltar, voc√™ pode usar uma sintaxe mais simples, definindo um r√≥tulo e atribuindo seu valor a uma vari√°vel com um comando <em>AVRASM.newLabel ()</em> sem par√¢metros. </p><br><p>  O tipo mais simples de transi√ß√£o √© uma transi√ß√£o incondicional.  Para cham√°-lo, usamos o <em>comando GO ([jump_mark]]</em> .  Vamos ver como fica com um exemplo. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = m.REG(); <span class="hljs-comment"><span class="hljs-comment">//  var lbl1 = AVRASM.Label;//        m.GO(lbl1); r++; //    r++; AVRASM.NewLabel(lbl1);//  //  var lbl2 = AVRASM.NewLabel();//    r--; //    r--; m.GO(lbl2); var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Transi√ß√µes condicionais t√™m mais controle sobre o fluxo de execu√ß√£o.  Seu comportamento depende do estado dos sinalizadores de opera√ß√£o e isso possibilita o controle do fluxo de opera√ß√µes, dependendo do resultado de sua execu√ß√£o.  A biblioteca usa a fun√ß√£o <em>SE</em> para descrever um bloco de comandos que devem ser executados somente sob determinadas condi√ß√µes.  Vejamos um exemplo. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr2.Load(<span class="hljs-number"><span class="hljs-number">0x33</span></span>); m.IF(rr1 == rr2, () =&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,  "</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Como a sintaxe do comando <em>IF</em> n√£o √© muito familiar, considere-a em mais detalhes.  O primeiro argumento aqui √© a condi√ß√£o de transi√ß√£o.  A seguir est√° o m√©todo no qual o bloco de c√≥digo √© colocado, que deve ser executado se a condi√ß√£o for atendida.  Uma variante da fun√ß√£o √© a capacidade de descrever uma ramifica√ß√£o alternativa, ou seja, um bloco de c√≥digo que deve ser executado se a condi√ß√£o n√£o for atendida.  Al√©m disso, voc√™ pode prestar aten√ß√£o √† fun√ß√£o <em>AVRASM.Comment ()</em> , com a qual podemos adicionar coment√°rios ao assembler de sa√≠da. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr2.Load(<span class="hljs-number"><span class="hljs-number">0x33</span></span>); m.IF(rr1 == rr2, () =&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,  "</span></span>); },()=&gt; { AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" - ,   "</span></span>); }); AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  O resultado neste caso ter√° a seguinte apar√™ncia </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r20</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r21</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,34 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function">,51 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">brne</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function"> ;---  - ,   --- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xjmp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: ;---  - ,    --- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function">: ;---   --- .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span></span></code> </pre> <br><p>  Os exemplos anteriores mostram uma op√ß√£o de ramifica√ß√£o condicional na qual um comando de compara√ß√£o √© usado para determinar as condi√ß√µes de ramifica√ß√£o.  Em alguns casos, isso n√£o √© necess√°rio, pois as condi√ß√µes de transi√ß√£o devem ser determinadas pelo estado dos sinalizadores ap√≥s a √∫ltima opera√ß√£o executada.  A sintaxe a seguir √© fornecida para esses casos. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); rr1.Load(<span class="hljs-number"><span class="hljs-number">0x22</span></span>); rr1--; m.IFEMPTY(() =&gt;AVRASM.Comment(<span class="hljs-string"><span class="hljs-string">",    0"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = AVRASM.Text(m);</code> </pre> <br><p>  Neste exemplo, a fun√ß√£o <em>IFEMPTY</em> verifica o status do sinalizador Z ap√≥s um incremento e executa o c√≥digo do bloco condicional quando atinge 0. <br>  A mais flex√≠vel em termos de uso pode ser considerada a fun√ß√£o <em>LOOP</em> .  Destina-se a uma descri√ß√£o conveniente dos ciclos do programa.  Considere a assinatura dela </p><br><pre> <code class="cs hljs">LOOP(Register iter, Action&lt;Register, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Condition, Action&lt;Register, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; body)</code> </pre> <br><p>  O par√¢metro <em>iter</em> atribui uma vari√°vel de registro que pode ser usada como um iterador em um loop.  O segundo par√¢metro cont√©m um bloco de c√≥digo que descreve as condi√ß√µes para sair do loop.  O iterador atribu√≠do e o r√≥tulo inicial do loop a serem retornados s√£o passados ‚Äã‚Äãpara este bloco de c√≥digo.  O √∫ltimo par√¢metro √© usado para descrever o bloco de c√≥digo do corpo principal do loop.  O exemplo mais simples de uso da fun√ß√£o <em>LOOP</em> √© um loop de stub, ou seja, um loop infinito para pular para a mesma linha.  A sintaxe nesse caso ser√° a seguinte </p><br><pre> <code class="cs hljs">m.LOOP(m.TempL, (r, l) =&gt; m.GO(l), (r,l) =&gt; { });</code> </pre> <br><p>  O resultado da compila√ß√£o √© dado abaixo. </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">L0002: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xjmp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span></span></code> </pre> <br><p>  Vamos voltar ao nosso exemplo de preenchimento de uma matriz com um determinado valor e alter√°-lo para que o preenchimento seja realizado em um loop </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr1 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rr2 = m.REG(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); ptr.Load(arr[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//     rr2.Load(16); //    rr1.Load(0xAA); //   m.LOOP(rr2, (r, l) =&gt; //rr2     . { r--; //   m.IFNOTEMPTY(l); // ,   }, (r,l) =&gt; ptr.MStoreInc(rr1)); //   var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  O c√≥digo de sa√≠da, neste caso, ter√° a seguinte apar√™ncia </p><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">RESET: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">high</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPH</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">low</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RAMEND</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">out</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPL</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r16</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r20</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DEF</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">r21</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YL</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LOW</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">+0) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YH</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HIGH</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">+0) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function">,16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ldi</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function">,170 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0003</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">st</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Y</span></span></span><span class="hljs-function">+,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0000</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dec</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">R0001</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">brne</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0003</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0004</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DSEG</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L0002</span></span></span><span class="hljs-function">: .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BYTE</span></span></span><span class="hljs-function"> 16</span></span></code> </pre> <br><p>  Outra maneira de organizar transi√ß√µes √© atrav√©s de transi√ß√µes endere√ßadas indiretamente.  O anal√≥gico mais pr√≥ximo em idiomas de alto n√≠vel para eles √© um ponteiro para uma fun√ß√£o.  O ponteiro nesse caso n√£o apontar√° para o espa√ßo da RAM, mas para o c√≥digo do programa.  Como o AVR possui uma arquitetura de Harvard e usa seu pr√≥prio conjunto espec√≠fico de instru√ß√µes para acessar a mem√≥ria do programa, o ROMPtr, em vez do MEMPtr descrito acima, √© usado como ponteiro.  O caso de uso para transi√ß√µes endere√ßadas indiretamente pode ser ilustrado pelo exemplo a seguir. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block1 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block2 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block3 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.ROMPTR(); ptr.Load(block1); <span class="hljs-comment"><span class="hljs-comment">//     var loop = AVRASM.NewLabel(); AVRASM.Comment("   "); m.GOIndirect(ptr); //   ,     AVRASM.NewLabel(block1); AVRASM.Comment("  1"); ptr.Load(block2); m.GO(loop); AVRASM.NewLabel(block2); AVRASM.Comment("  2"); ptr.Load(block3); m.GO(loop); AVRASM.NewLabel(block3); AVRASM.Comment("  3"); ptr.Load(block1); m.GO(loop); var t = AVRASM.Text(m);</span></span></code> </pre> <br><p>  Neste exemplo, temos 3 blocos de comandos.  Ap√≥s a conclus√£o de cada bloco, o controle √© transferido de volta ao comando de filial endere√ßado indiretamente.  Como no final do bloco de comando, definimos o vetor de transi√ß√£o para um novo bloco a cada vez, a execu√ß√£o ser√° semelhante ao Bloco1 ‚Üí Bloco2 ‚Üí Bloco3 ‚Üí Bloco1 ... e assim por diante em um c√≠rculo.  Esse comando, junto com os comandos de ramifica√ß√£o condicional, permite meios simples e convenientes da linguagem para descrever algoritmos t√£o complexos como uma m√°quina de estado. </p><br><p>  Uma vers√£o mais sofisticada de uma ramifica√ß√£o endere√ßada indiretamente √© o comando <em>SWITCH</em> .  Ele n√£o usa um ponteiro para um r√≥tulo de transi√ß√£o para a transi√ß√£o, mas um ponteiro para uma vari√°vel na mem√≥ria na qual o endere√ßo do r√≥tulo de transi√ß√£o est√° armazenado. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block1 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block2 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> block3 = AVRASM.Label; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = m.ARRAY(<span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = m.MEMPTR(); <span class="hljs-comment"><span class="hljs-comment">//    m.Temp.Load(block1); m.Temp.Store(arr[0]); m.Temp.Load(block2); m.Temp.Store(arr[2]); m.Temp.Load(block3); m.Temp.Store(arr[4]); ptr.Load(arr[0]); //     var loop = AVRASM.NewLabel(); m.SWITCH(ptr); //   ,     AVRASM.NewLabel(block1); AVRASM.Comment("  1"); ptr.Load(arr[2]); //       m.GO(loop); AVRASM.NewLabel(block2); AVRASM.Comment("  2"); m.Temp.Load(block3); ptr.MStore(m.Temp); //       m.GO(loop); AVRASM.NewLabel(block3); AVRASM.Comment("  3"); ptr.Load(arr[0]); //       m.GO(loop);</span></span></code> </pre> <br><p>  Neste exemplo, a sequ√™ncia de transi√ß√£o ser√° a seguinte: Bloco1 ‚Üí Bloco2 ‚Üí Bloco3 ‚Üí Bloco1 ‚Üí Bloco3 ‚Üí Bloco1 ‚Üí Bloco3 ‚Üí Bloco1 ... Conseguimos implementar um algoritmo no qual os comandos do Bloco2 s√£o executados apenas no primeiro ciclo. </p><br><p>  Na pr√≥xima parte da postagem, consideraremos trabalhar com dispositivos perif√©ricos, implementar interrup√ß√µes, rotinas e muito mais. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt463123/">https://habr.com/ru/post/pt463123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt463107/index.html">ShIoTiny: pequena automa√ß√£o, a Internet das coisas ou "seis meses antes das f√©rias"</a></li>
<li><a href="../pt463113/index.html">Controle de vers√£o de dados e modelos no encontro do Computer Vision</a></li>
<li><a href="../pt463115/index.html">A quest√£o das portas no design dos atiradores</a></li>
<li><a href="../pt463117/index.html">Pr√©-carregando no PHP 7.4</a></li>
<li><a href="../pt463121/index.html">N√≥s comemos o elefante em partes. Exemplo de estrat√©gia de monitoramento de integridade de aplicativos</a></li>
<li><a href="../pt463125/index.html">OOP em imagens</a></li>
<li><a href="../pt463127/index.html">Monitoramento de UPS. Parte dois - Automatize o Analytics</a></li>
<li><a href="../pt463135/index.html">Em quais pa√≠ses √© rent√°vel registrar empresas de TI em 2019?</a></li>
<li><a href="../pt463137/index.html">Mesmo se voc√™ quer ser um designer de jogos, ningu√©m vai te ensinar como</a></li>
<li><a href="../pt463141/index.html">Habr Weekly # 13 / Sob amea√ßa de 1,5 milh√£o de usu√°rios de um servi√ßo de encontros, investiga√ß√£o Medusa, decano dos russos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>