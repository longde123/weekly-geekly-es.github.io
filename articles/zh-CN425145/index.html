<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§‘ğŸ¾â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ•ºğŸ» ğŸ‘©ğŸ¾â€ğŸ“ å¦‚æ­¤å‡ºè‰² ğŸ›· ğŸ§šğŸ¾ ğŸ”›</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go 2ä¸­æ–°çš„é”™è¯¯å¤„ç†è®¾è®¡è‰æ¡ˆå·²äºæœ€è¿‘å‘å¸ƒï¼Œä»¤äººæ¬£å–œçš„æ˜¯ï¼Œè¯¥è¯­è¨€å¹¶æ²¡æœ‰ç«™åœ¨ä¸€èµ·-å®ƒä¸æ–­å‘å±•ï¼Œå¹¶ä¸”æ¯å¹´éƒ½æœ‰çªé£çŒ›è¿›çš„å‘å±•ã€‚ 


 åªæœ‰åœ¨è¿™é‡Œï¼Œç›´åˆ°åªæœ‰2èµ°çš„æ˜¯çœ‹åˆ°åœ¨åœ°å¹³çº¿ä¸Šï¼Œå¹¶ç­‰å¾…å®ƒæ˜¯éå¸¸ç—›è‹¦å’Œä¼¤å¿ƒã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†äº‹æƒ…æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ã€‚ ä¸€ç‚¹ç‚¹çš„ä»£ç ç”Ÿæˆï¼Œä¸€ç‚¹ç‚¹çš„astå·¥ä½œï¼Œéšç€æ‰‹éƒ¨ææ…Œçš„è½»å¾®ç§»åŠ¨ï¼Œæ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚æ­¤å‡ºè‰²</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425145/"><p>  Go 2ä¸­æ–°çš„é”™è¯¯å¤„ç†è®¾è®¡è‰æ¡ˆå·²äºæœ€è¿‘å‘å¸ƒï¼Œä»¤äººæ¬£å–œçš„æ˜¯ï¼Œè¯¥è¯­è¨€å¹¶æ²¡æœ‰ç«™åœ¨ä¸€èµ·-å®ƒä¸æ–­å‘å±•ï¼Œå¹¶ä¸”æ¯å¹´éƒ½æœ‰çªé£çŒ›è¿›çš„å‘å±•ã€‚ </p><br><p> åªæœ‰åœ¨è¿™é‡Œï¼Œç›´åˆ°åªæœ‰2èµ°çš„æ˜¯çœ‹åˆ°åœ¨åœ°å¹³çº¿ä¸Šï¼Œå¹¶ç­‰å¾…å®ƒæ˜¯éå¸¸ç—›è‹¦å’Œä¼¤å¿ƒã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†äº‹æƒ…æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ã€‚ ä¸€ç‚¹ç‚¹çš„ä»£ç ç”Ÿæˆï¼Œä¸€ç‚¹ç‚¹çš„astå·¥ä½œï¼Œéšç€æ‰‹éƒ¨ææ…Œçš„è½»å¾®ç§»åŠ¨ï¼Œææ…Œå°±å˜æˆäº†ä¼˜é›…çš„å¼‚å¸¸ï¼ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0u/sd/fx/0usdfxkuqp9qtfe9biignfxdzxo.jpeg"></div><a name="habracut"></a><br><blockquote> æˆ‘æƒ³ç«‹å³å‘è¡¨ä¸€ä¸ªéå¸¸é‡è¦ä¸”ç»å¯¹è®¤çœŸçš„å£°æ˜ã€‚ <br> è¯¥å†³å®šæœ¬è´¨ä¸Šæ˜¯å¨±ä¹æ€§å’Œæ•™å­¦æ€§çš„ã€‚ <br> æˆ‘çš„æ„æ€æ˜¯åªæœ‰4ä¸ªä¹è¶£ã€‚ å®é™…ä¸Šï¼Œè¿™é€šå¸¸æ˜¯æ¦‚å¿µè¯æ˜ã€‚ æˆ‘è­¦å‘Šè¿‡ï¼šï¼‰ </blockquote><br><h2 id="tak-chto-zhe-vyshlo"> é‚£ä¹ˆå‘ç”Ÿäº†ä»€ä¹ˆ </h2><br><p> ç»“æœæ˜¯ä¸€ä¸ªå¾ˆå°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åº“ä»£ç ç”Ÿæˆå™¨</a> ã€‚ ä¼—æ‰€å‘¨çŸ¥ï¼Œä»£ç ç”Ÿæˆå™¨å†…éƒ¨åŒ…å«å–„è‰¯å’Œä¼˜é›…ã€‚ å®é™…ä¸Šä¸æ˜¯ï¼Œä½†æ˜¯åœ¨Goä¸–ç•Œä¸­ï¼Œå®ƒä»¬éå¸¸å—æ¬¢è¿ã€‚ </p><br><p>æˆ‘ä»¬åœ¨åŸå§‹ç¯å¢ƒä¸­è®¾ç½®äº†è¿™æ ·çš„ä»£ç ç”Ÿæˆå™¨ã€‚ ä»–åœ¨æ ‡å‡†<code>go/ast</code>æ¨¡å—çš„å¸®åŠ©ä¸‹è¿›è¡Œäº†è§£æï¼Œåšäº†ä¸€äº› <del> ä¸ </del> ç‹¡çŒ¾çš„è½¬æ¢ï¼Œç»“æœå†™åœ¨æ–‡ä»¶æ—è¾¹ï¼Œå¹¶æ·»åŠ åç¼€<code>_jex.go</code> ã€‚ ç”Ÿæˆçš„æ–‡ä»¶éœ€è¦ä¸€ä¸ªå¾ˆå°çš„è¿è¡Œæ—¶ã€‚ </p><br><p> é€šè¿‡è¿™ç§ç®€å•çš„æ–¹å¼ï¼Œæˆ‘ä»¬å‘Goæ·»åŠ äº†å¼‚å¸¸ã€‚ </p><br><h2 id="polzuem"> æˆ‘ä»¬ç”¨ </h2><br><p> æˆ‘ä»¬å°†ç”Ÿæˆå™¨è¿æ¥åˆ°æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶å¤´ï¼ˆåœ¨<code>package</code>ä¹‹å‰ï¼‰ä¸­ç¼–å†™ </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//+build jex //go:generate jex</span></span></code> </pre> <br><p> å¦‚æœç°åœ¨è¿è¡Œå‘½ä»¤<code>go generate -tags jex</code> ï¼Œåˆ™å°†æ‰§è¡Œ<code>jex</code>å®ç”¨ç¨‹åºã€‚ å¥¹ä»<code>os.Getenv("GOFILE")</code>è·å–æ–‡ä»¶åï¼Œå°†å…¶åƒæ‰ï¼Œæ¶ˆåŒ–å¹¶å†™å…¥<code>{file}_jex.go</code> ã€‚ æ–°ç”Ÿæ–‡ä»¶çš„å¤´ä¸­å·²ç»æœ‰<code>//+build !jex</code> ï¼ˆæ ‡è®°æ˜¯åå‘çš„ï¼‰ï¼Œå› æ­¤<code>go build</code> ï¼Œå¹¶åœ¨å…¶éš”å®¤ä¸­ä½¿ç”¨å…¶ä»–å‘½ä»¤ï¼ˆä¾‹å¦‚<code>go test</code>æˆ–<code>go install</code>ä»…è€ƒè™‘<em>æ–°çš„</em>æ­£ç¡®æ–‡ä»¶ã€‚  Lepota ... </p><br><p> ç°åœ¨ç‚¹å¯¼å…¥<code>github.com/anjensan/jex</code> ã€‚ <br> æ˜¯çš„ï¼Œè™½ç„¶å¿…é¡»é€šè¿‡ç‚¹å¯¼å…¥ã€‚ å°†æ¥è®¡åˆ’ä¿æŒä¸å˜ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> . <span class="hljs-string"><span class="hljs-string">"github.com/anjensan/jex"</span></span></code> </pre> <br><p> å¤ªå¥½äº†ï¼Œç°åœ¨æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­æ’å…¥å¯¹å­˜æ ¹å‡½æ•°<code>TRY</code> ï¼Œ <code>THROW</code> ï¼Œ <code>EX</code>è°ƒç”¨ã€‚ å‡ºäºæ‰€æœ‰è¿™äº›åŸå› ï¼Œè¯¥ä»£ç åœ¨è¯­æ³•ä¸Šä»ç„¶æœ‰æ•ˆï¼Œç”šè‡³å¯ä»¥æœªç»å¤„ç†çš„å½¢å¼è¿›è¡Œç¼–è¯‘ï¼ˆè¿™æ ¹æœ¬è¡Œä¸é€šï¼‰ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨è‡ªåŠ¨è¡¥å…¨<em>åŠŸèƒ½ï¼Œ</em>è€Œlint <em>ä¹Ÿä¸ä¼šçœŸæ­£</em>å‘èª“ã€‚ å¦‚æœè¿™äº›åŠŸèƒ½åªæœ‰ä¸€ä¸ªï¼Œç¼–è¾‘è€…è¿˜å°†æ˜¾ç¤ºè¿™äº›åŠŸèƒ½çš„æ–‡æ¡£ã€‚ </p><br><p> å¼•å‘å¼‚å¸¸ </p><br><pre> <code class="go hljs">THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"error name"</span></span>))</code> </pre> <br><p> æ•æ‰å¼‚å¸¸ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { <span class="hljs-comment"><span class="hljs-comment">//   } else { fmt.Println(EX()) }</span></span></code> </pre> <br><p> åœ¨åå°ç”Ÿæˆä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚ å¹¶ä¸”<code>defer</code> ã€‚ å®ƒè¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½ã€‚ å¹¶ä¸”åœ¨<code>recover</code> ...å¥½å§ï¼Œä»ç„¶æœ‰ä¸€äº›ä¸å¯æ€è®®çš„äº‹æƒ…æ¥å¤„ç†<code>return</code>å’Œ<code>defer</code> ã€‚ </p><br><p> æ˜¯çš„ï¼Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå®ƒä»¬å¾—åˆ°äº†æ”¯æŒï¼ </p><br><p> æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å®å˜é‡<code>ERR</code> ã€‚ å¦‚æœæ‚¨ä¸ºå…¶åˆ†é…é”™è¯¯ï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸ã€‚ è°ƒç”¨ä»æ—§è¿”å›<code>error</code>å‡½æ•°ä¼šæ›´å®¹æ˜“ </p><br><pre> <code class="go hljs">file, ERR := os.Open(filename)</code> </pre> <br><p> æ­¤å¤–ï¼Œæœ‰ä¸¤ä¸ª<code>ex</code>å’Œ<code>must</code>çš„å°å·¥å…·è¢‹ï¼Œä½†æ²¡ä»€ä¹ˆå¯è°ˆçš„ã€‚ </p><br><h2 id="primery"> ä¾‹å­ </h2><br><p> è¿™æ˜¯æ­£ç¡®çš„ï¼Œæƒ¯ç”¨çš„Goä»£ç çš„ç¤ºä¾‹ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(src, dst </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { r, err := os.Open(src) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> r.Close() w, err := os.Create(dst) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err := io.Copy(w, r); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { w.Close() os.Remove(dst) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := w.Close(); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { os.Remove(dst) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"copy %s %s: %v"</span></span>, src, dst, err) } }</code> </pre> <br><p> è¿™æ®µä»£ç ä¸æ˜¯é‚£ä¹ˆä¼˜é›…ã€‚ é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ä¸ä»…æ˜¯æˆ‘çš„æ„è§ï¼ <br> ä½†æ˜¯<code>jex</code>å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›å®ƒã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFile_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(src, dst </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> ex.Logf(<span class="hljs-string"><span class="hljs-string">"copy %s %s"</span></span>, src, dst) r, ERR := os.Open(src) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> r.Close() w, ERR := os.Create(dst) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { ERR := io.Copy(w, r) ERR := w.Close() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { w.Close() os.Remove(dst) THROW() } }</code> </pre> <br><p> ä½†æ˜¯ä¾‹å¦‚ä¸‹é¢çš„ç¨‹åº </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { hex, err := ioutil.ReadAll(os.Stdin) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } data, err := parseHexdump(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(hex)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } os.Stdout.Write(data) }</code> </pre> <br><p> å¯ä»¥æ”¹å†™æˆ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { hex, ERR := ioutil.ReadAll(os.Stdin) data, ERR := parseHexdump(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(hex)) os.Stdout.Write(data) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { log.Fatal(EX()) } }</code> </pre> <br><p> è¿™æ˜¯å¦ä¸€ä¸ªç¤ºä¾‹ï¼Œç›®çš„æ˜¯æ›´å¥½åœ°ç†è§£æ‰€æå‡ºçš„æƒ³æ³•ã€‚ åŸå§‹ç  </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { x, err := strconv.Atoi(a) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } y, err := strconv.Atoi(b) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, x + y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p> å¯ä»¥æ”¹å†™æˆ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { x, ERR := strconv.Atoi(a) y, ERR := strconv.Atoi(b) fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, x + y) }</code> </pre> <br><p> ç”šè‡³é‚£ä¸ª </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printSum_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>, must.Int_(strconv.Atoi(a)) + must.Int_(strconv.Atoi(b))) }</code> </pre> <br><h2 id="isklyuchenie"> ä¾‹å¤–æƒ…å†µ </h2><br><p> åº•çº¿æ˜¯<code>error</code>å®ä¾‹ä¸Šçš„ç®€å•åŒ…è£…å™¨ç»“æ„ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> exception <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,   err error //  ^W , ,    log []interface{} //      ,    suppress []*exception }</span></span></code> </pre> <br><p> é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œæ™®é€šçš„ç´§æ€¥æ”»å‡»ä¸ä¼šè¢«è§†ä¸ºä¾‹å¤–ã€‚ å› æ­¤ï¼Œæ‰€æœ‰æ ‡å‡†é”™è¯¯ï¼ˆä¾‹å¦‚<code>runtime.TypeAssertionError</code>ä¹Ÿä¸ä¾‹å¤–ã€‚ è¿™ç¬¦åˆGoä¸­å…¬è®¤çš„æœ€ä½³å®è·µ-å¦‚æœæˆ‘ä»¬æœ‰nil-dereferenceï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šä¹äºä¹æ„æ”¾å¼ƒæ•´ä¸ªè¿‡ç¨‹ã€‚ å¯é ä¸”å¯é¢„æµ‹ã€‚ å°½ç®¡æˆ‘ä¸ç¡®å®šï¼Œä½†ä¹Ÿè®¸å€¼å¾—å›é¡¾ä¸€ä¸‹å¹¶æ‰¾å‡ºæ­¤ç±»é”™è¯¯ã€‚ ä¹Ÿè®¸æ˜¯å¯é€‰çš„ï¼Ÿ </p><br><p> è¿™æ˜¯ä¸€ä¸ªå¼‚å¸¸é“¾çš„ä¾‹å­ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">one_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"one"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">two_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"two"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">three</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { one_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { two_() } }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å†·é™åœ°å¤„ç†å¼‚å¸¸<code>one</code> ï¼Œå› ä¸ºçªç„¶åäº†â€¦â€¦å¹¶æŠ›å‡ºäº†å¼‚å¸¸<code>two</code> ã€‚ å› æ­¤ï¼Œæº<code>one</code>åœ¨<code>suppress</code>å­—æ®µä¸­<code>suppress</code>é™„åŠ åˆ°å®ƒã€‚ ä»€ä¹ˆéƒ½ä¸ä¼šä¸¢å¤±ï¼Œä¸€åˆ‡éƒ½ä¼šè¿›å…¥æ—¥å¿—ã€‚ å› æ­¤ï¼Œä¸éœ€è¦ç‰¹åˆ«ä½¿ç”¨éå¸¸æµè¡Œçš„<code>fmt.Errorf("blabla: %v", err)</code>æ¨¡å¼<code>fmt.Errorf("blabla: %v", err)</code>å°†æ•´ä¸ªé”™è¯¯é“¾ç›´æ¥æ¨å…¥æ¶ˆæ¯æ–‡æœ¬ä¸­ã€‚ å½“ç„¶ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œå½“ç„¶ä¹Ÿæ²¡æœ‰äººç¦æ­¢åœ¨è¿™é‡Œä½¿ç”¨å®ƒã€‚ </p><br><h2 id="kogda-zabyli-otlovit"> ä»€ä¹ˆæ—¶å€™å¿˜äº† </h2><br><p> å•Šï¼Œå¦ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸€ç‚¹ã€‚ ä¸ºäº†æé«˜å¯è¯»æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„æ£€æŸ¥ï¼šå¦‚æœä¸€ä¸ªå‡½æ•°å¯ä»¥å¼•å‘å¼‚å¸¸ï¼Œåˆ™å…¶åç§°å¿…é¡»ä»¥<code>_</code>ç»“å°¾ã€‚ ä¸€ä¸ªæ•…æ„æ­ªæ›²çš„åå­—ä¼šå‘Šè¯‰ç¨‹åºå‘˜â€œå°Šæ•¬çš„å…ˆç”Ÿï¼Œåœ¨æ‚¨çš„ç¨‹åºä¸­è¿™å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œè¯·å°å¿ƒè°¨æ…ï¼â€ </p><br><p> è‡ªåŠ¨æ£€æŸ¥å·²è½¬æ¢çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>jex-check</code>å‘½ä»¤åœ¨é¡¹ç›®ä¸­æ‰‹åŠ¨å¯åŠ¨<code>jex-check</code> ã€‚ å°†å®ƒä¸å…¶ä»–linterä¸€èµ·ä½œä¸ºæ„å»ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†æ¥è¿è¡Œä¹Ÿè®¸æ˜¯æœ‰æ„ä¹‰çš„ã€‚ </p><br><p>  <code>//jex:nocheck</code>è¯„è®ºè¢«<code>//jex:nocheck</code> ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè¿™æ˜¯ä»åŒ¿åå‡½æ•°å¼•å‘å¼‚å¸¸çš„å”¯ä¸€æ–¹æ³•ã€‚ </p><br><p> å½“ç„¶ï¼Œè¿™å¹¶ä¸æ˜¯è§£å†³æ‰€æœ‰é—®é¢˜çš„çµä¸¹å¦™è¯ã€‚  Checkerä¼šé”™è¿‡è¿™ä¸ª </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bad_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"ups"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { f := bad_ f() }</code> </pre> <br><p> å¦ä¸€æ–¹é¢ï¼Œå®ƒå¹¶ä¸æ¯”<code>err declared and not used</code>çš„æ ‡å‡†æ£€æŸ¥å·®å¾ˆå¤šï¼Œè¿™å¾ˆå®¹æ˜“è§„é¿ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">worse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { a, err := foo() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } b, err := bar() <span class="hljs-comment"><span class="hljs-comment">//  ,    ok... go vet, ? }</span></span></code> </pre> <br><p> æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å¾ˆå“²å­¦çš„ï¼Œå½“æ‚¨å¿˜è®°å¤„ç†é”™è¯¯æ—¶æœ€å¥½åšä»€ä¹ˆ-å®‰é™åœ°å¿½ç•¥å®ƒï¼Œæˆ–è€…å¼•å‘ææ…Œ...é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¯ä»¥é€šè¿‡åœ¨ç¼–è¯‘å™¨ä¸­å®ç°å¼‚å¸¸æ”¯æŒæ¥è¾¾åˆ°æµ‹è¯•çš„æœ€ä½³ç»“æœï¼Œä½†è¿™è¿œè¿œè¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚ ã€‚ </p><br><p> æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œå°½ç®¡è¿™æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å®ƒä¸å†æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œå› ä¸ºç°åœ¨ä¾‹å¤–æ„å‘³ç€éå¸¸å…·ä½“çš„å®ç°ã€‚ å¥½å§ï¼Œé‚£é‡Œæ˜¯å› ä¸ºå †æ ˆè·Ÿè¸ªæ²¡æœ‰é™„åŠ åˆ°å¼‚å¸¸ï¼Œæˆ–è€…æœ‰ä¸€ä¸ªå•ç‹¬çš„linterç”¨äºæ£€æŸ¥å‡½æ•°åç§°ï¼Œæˆ–è€…è¯¥å‡½æ•°å¯ä»¥ä»¥<code>_</code>ç»“å°¾ä½†ä¸å¼•å‘å¼‚å¸¸ï¼Œæˆ–è€…åœ¨è¯­æ³•ä¸Šæ²¡æœ‰ç›´æ¥æ”¯æŒï¼Œæˆ–è€…ç¡®å®å¾ˆæ…Œå¼ ï¼Œå¹¶ä¸”ææ…Œä¸€ç‚¹ä¹Ÿä¸ä¾‹å¤–ï¼Œå› ä¸ºå”è’²â€¦â€¦å­¢å­å¯èƒ½åƒæ¯«æ— ä»·å€¼çš„æ¯«æ— æ„ä¹‰çš„ä¸€æ ·çƒ­ã€‚ å› æ­¤ï¼Œæˆ‘å°†æŠŠå®ƒä»¬ç•™åœ¨æœ¬æ–‡çš„æ¡†æ¶ä¹‹å¤–ï¼Œå¹¶ä¸”æˆ‘å°†ç»§ç»­å°†æ‰€æè¿°çš„è§£å†³æ–¹æ¡ˆç§°ä¸ºâ€œä¾‹å¤–â€ã€‚ </p><br><h2 id="po-povodu-stektreysov"> å…³äºStackrace </h2><br><p> é€šå¸¸ï¼Œä¸ºäº†ç®€åŒ–è°ƒè¯•ï¼Œå¼€å‘äººå‘˜ä¼šå°†å †æ ˆè·Ÿè¸ªç²˜è´´åˆ°è‡ªå®šä¹‰<code>error</code>å®ç°ä¸Šã€‚ ç”šè‡³æœ‰å‡ ä¸ªæµè¡Œçš„åº“ã€‚ ä½†æ˜¯ï¼Œå¹¸è¿çš„æ˜¯ï¼Œç”±äºGoçš„ä¸€é¡¹æœ‰è¶£åŠŸèƒ½ï¼Œé™¤ä¾‹å¤–æƒ…å†µå¤–ï¼Œæ­¤æ“ä½œä¸éœ€è¦ä»»ä½•å…¶ä»–æ“ä½œ-åœ¨å‡ºç°ç´§æ€¥æƒ…å†µæ—¶ï¼Œåœ¨å¼•å‘ç´§æ€¥æƒ…å†µçš„ä»£ç çš„å †æ ˆä¸Šä¸‹æ–‡<code>defer</code>æ‰§è¡Œ<code>defer</code>å—ã€‚ å› æ­¤åœ¨è¿™é‡Œ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"ups"</span></span>)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { foo_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { debug.PrintStack() } }</code> </pre> <br><p> å°†æ˜¾ç¤ºå®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼Œå°½ç®¡æœ‰äº›å†—é•¿ï¼ˆæˆ‘å‰ªåˆ‡äº†æ–‡ä»¶åï¼‰ </p><br><pre> <code class="go hljs"> runtime/debug.Stack runtime/debug.PrintStack main.bar.func2 github.com/anjensan/jex/runtime.TryCatch.func1 <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span> main.foo_ main.bar.func1 github.com/anjensan/jex/runtime.TryCatch main.bar main.main</code> </pre> <br><p> è€ƒè™‘åˆ°ä»£ç†åŠŸèƒ½å¹¶éšè—å®ƒä»¬ä»¥æé«˜å¯è¯»æ€§ï¼Œä½¿æ‚¨è‡ªå·±çš„å¸®åŠ©ç¨‹åºæ ¼å¼åŒ–/æ‰“å°å †æ ˆè·Ÿè¸ªè®°å½•ä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ã€‚ æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸ªå¥½ä¸»æ„ã€‚ </p><br><p> æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>ex.Log()</code>æŠ“ä½å †æ ˆå¹¶å°†å…¶é™„åŠ åˆ°å¼‚å¸¸ã€‚ ç„¶åï¼Œå°†è¿™æ ·çš„å¼‚å¸¸è½¬ç§»åˆ°å¦ä¸€ä¸ªhoroutinä¸­-strextraceä¸ä¸¢å¤±ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foobar_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { e := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> error, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> <span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(e) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { checkZero_() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { EX().Log(debug.Stack()) <span class="hljs-comment"><span class="hljs-comment">//   e &lt;- EX().Wrap() //     } }() ex.Must_(&lt;-e) //  ,  ,  }</span></span></code> </pre> <br><h2 id="k-sozhaleniyu"> ä¸å¹¸çš„æ˜¯ </h2><br><p> å—¯...å½“ç„¶ï¼Œè¿™æ ·çš„ä¸œè¥¿çœ‹èµ·æ¥ä¼šå¥½å¾—å¤š </p><br><pre> <code class="go hljs"> try { throw io.EOF, <span class="hljs-string"><span class="hljs-string">"some comment"</span></span> } catch e { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"exception: %v"</span></span>, e) }</code> </pre> <br><p> ä½†æ˜¯ï¼Œï¼ŒGoçš„è¯­æ³•ä¸å¯æ‰©å±•ã€‚ <br>  [æ·±æ€ç†Ÿè™‘]å°½ç®¡å¯èƒ½ä¼šå˜å¾—æ›´å¥½... </p><br><p> æ— è®ºå¦‚ä½•ï¼Œä½ éƒ½å¿…é¡»å˜æ€ã€‚ å¦ä¸€ç§æƒ³æ³•æ˜¯ä½¿ </p><br><pre> <code class="go hljs"> TRY; { THROW(io.EOF, <span class="hljs-string"><span class="hljs-string">"some comment"</span></span>) }; CATCH; { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"exception: %v"</span></span>, EX) }</code> </pre> <br><p> ä½†æ˜¯åœ¨<code>go fmt</code>ä¹‹åï¼Œè¿™æ ·çš„ä»£ç æ˜¾å¾—æœ‰äº›æ„šè ¢ã€‚ å¹¶ä¸”å½“ç¼–è¯‘å™¨åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½çœ‹åˆ°<code>return</code>æ—¶å‘èª“ã€‚  <code>if-TRY</code>æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ã€‚ </p><br><p> ç”¨<code>MUST</code>å‡½æ•°æ›¿æ¢<code>ERR</code>å®æ˜¯å¾ˆé…·çš„ï¼ˆä¸æ­¢äºæ­¤ï¼‰ã€‚ ä¸ºäº†å†™ </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MUST(strconv.Atoi(a)) + MUST(strconv.Atoi(b))</code> </pre> <br><p> åŸåˆ™ä¸Šï¼Œè¿™ä»ç„¶å¯è¡Œï¼Œå½“åˆ†æasâ€‹â€‹tæ—¶ï¼Œæ‚¨å¯ä»¥æ´¾ç”Ÿè¡¨è¾¾å¼çš„ç±»å‹ï¼Œå› ä¸ºæ‰€æœ‰ç±»å‹çš„ç±»å‹éƒ½ä¼šç”Ÿæˆä¸€ä¸ªç®€å•çš„åŒ…è£…å‡½æ•°ï¼Œä¾‹å¦‚<code>must</code>åŒ…ä¸­å£°æ˜çš„é‚£äº›åŒ…è£…å‡½æ•°ï¼Œç„¶åå°†<code>MUST</code>æ›¿æ¢ä¸ºç›¸åº”çš„æ›¿ä»£å‡½æ•°çš„åç§°ã€‚ è¿™ä¸æ˜¯å®Œå…¨æ— å…³ç´§è¦çš„ï¼Œè€Œæ˜¯å®Œå…¨å¯èƒ½çš„ã€‚åªæœ‰ç¼–è¾‘å™¨/ ideæ— æ³•ç†è§£è¿™æ ·çš„ä»£ç ã€‚ æ¯•ç«Ÿï¼Œ <code>MUST</code>å­˜æ ¹å‡½æ•°çš„ç­¾åæ— æ³•åœ¨Goç±»å‹ç³»ç»Ÿä¸­è¡¨è¾¾ã€‚ å› æ­¤æ²¡æœ‰è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ã€‚ </p><br><h2 id="pod-kapotom"> å¼•æ“ç›–ä¸‹ </h2><br><p> æ–°å¯¼å…¥å°†æ·»åŠ åˆ°æ‰€æœ‰å¤„ç†çš„æ–‡ä»¶ä¸­ã€‚ </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _jex <span class="hljs-string"><span class="hljs-string">"github.com/anjensan/jex/runtime"</span></span></code> </pre> <br><p>  <code>panic(_jex.NewException(...))</code>è°ƒç”¨<code>THROW</code>æ›¿æ¢ä¸º<code>panic(_jex.NewException(...))</code> ã€‚  <code>EX()</code>ä¹Ÿå°†æ›¿æ¢ä¸ºåŒ…å«æ•è·çš„å¼‚å¸¸çš„å±€éƒ¨å˜é‡çš„åç§°ã€‚ </p><br><p> ä½†æ˜¯ï¼Œ <code>if TRY() {..} else {..}</code>å¤„ç†è¦å¤æ‚ä¸€äº›ã€‚ é¦–å…ˆï¼Œå¯¹æ‰€æœ‰<code>return</code>å’Œ<code>defer</code>è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ ç„¶åå°†å¤„ç†åçš„ifåˆ†æ”¯æ”¾ç½®åœ¨åŒ¿åå‡½æ•°ä¸­ã€‚ ç„¶åå°†è¿™äº›å‡½æ•°ä¼ é€’ç»™<code>_jex.TryCatch(..)</code> ã€‚ è¿™æ˜¯ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a == <span class="hljs-number"><span class="hljs-number">0</span></span> { THROW(errors.New(<span class="hljs-string"><span class="hljs-string">"a == 0"</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> fmt.Printf(<span class="hljs-string"><span class="hljs-string">"a = %d\n"</span></span>, a) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"fail"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"hmm"</span></span> }</code> </pre> <br><p> å˜æˆè¿™æ ·ï¼ˆæˆ‘åˆ é™¤äº†<code>//line</code>æ³¨é‡Šï¼‰ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_jex_r0 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, _jex_r1 </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _jex_ret <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fmt.Println(<span class="hljs-string"><span class="hljs-string">"before"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _jex_md2502 _jex.MultiDefer <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> _jex_md2502.Run() _jex.TryCatch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> a == <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(_jex.NewException(errors.New(<span class="hljs-string"><span class="hljs-string">"a == 0"</span></span>))) } { _f, _p0, _p1 := fmt.Printf, <span class="hljs-string"><span class="hljs-string">"a = %d\n"</span></span>, a _jex_md2502.Defer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { _f(_p0, _p1) }) } _jex_ret, _jex_r0, _jex_r1 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, a+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ok"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_jex_ex _jex.Exception)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> _jex.Suppress(_jex_ex) fmt.Println(<span class="hljs-string"><span class="hljs-string">"fail"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _jex_ret { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"hmm"</span></span> }</code> </pre><br><p> å¾ˆå¤šï¼Œä¸æ˜¯å¾ˆæ¼‚äº®ï¼Œä½†æ˜¯å¾ˆæœ‰æ•ˆã€‚ å¥½å§ï¼Œä¸æ˜¯å…¨éƒ¨ï¼Œè€Œä¸”å¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚ ä¾‹å¦‚ï¼Œæ‚¨ä¸èƒ½åœ¨TRYå†…è¿›è¡Œ<code>defer-recover</code> ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨ä¼šå˜æˆä¸€ä¸ªé¢å¤–çš„lambdaã€‚ </p><br><p> å¦å¤–ï¼Œåœ¨æ˜¾ç¤ºastæ ‘æ—¶ï¼Œå°†æ˜¾ç¤ºé€‰é¡¹â€œä¿å­˜æ³¨é‡Šâ€ã€‚ å› æ­¤ï¼Œä»ç†è®ºä¸Šè®²ï¼Œ <code>go/printer</code>åº”è¯¥æ‰“å°å®ƒä»¬ã€‚...è€å®è¯´ï¼Œäº‹å®æ˜¯éå¸¸éå¸¸æ­ªæ›²=ï¼‰æˆ‘ä¸ä¼šä¸¾ä»»ä½•ä¾‹å­ï¼Œåªæ˜¯æ­ªæ›²ã€‚ åŸåˆ™ä¸Šï¼Œå¦‚æœæ‚¨ä»”ç»†æŒ‡å®šæ‰€æœ‰astèŠ‚ç‚¹çš„ä½ç½®ï¼ˆç°åœ¨å®ƒä»¬ä¸ºç©ºï¼‰ï¼Œåˆ™å¯ä»¥å®Œå…¨è§£å†³æ­¤é—®é¢˜ï¼Œä½†è¿™ç»å¯¹ä¸åŒ…æ‹¬åœ¨åŸå‹å¿…éœ€çš„æ¸…å•ä¸­ã€‚ </p><br><h2 id="probuem"> è¯•ä¸€ä¸‹ </h2><br><p> å‡ºäºå¥½å¥‡ï¼Œæˆ‘å†™äº†ä¸€ä¸ªå°<a href="">åŸºå‡†</a> ã€‚ </p><br><p> æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ¨åˆ¶çš„qsortå®ç°ï¼Œå¯ä»¥æ£€æŸ¥è´Ÿè½½ä¸­çš„é‡å¤é¡¹ã€‚ å‘ç°-ä¸€ä¸ªé”™è¯¯ã€‚ ä¸€ä¸ªç‰ˆæœ¬åªæ˜¯é€šè¿‡<code>return err</code>æŠ›å‡ºå®ƒï¼Œå¦ä¸€ä¸ªç‰ˆæœ¬é€šè¿‡è°ƒç”¨<code>fmt.Errorf</code>æ¾„æ¸…é”™è¯¯ã€‚ è¿˜æœ‰ä¸€ä¸ªä½¿ç”¨å¼‚å¸¸ã€‚ æˆ‘ä»¬å¯¹ä¸åŒå¤§å°çš„åˆ‡ç‰‡è¿›è¡Œæ’åºï¼Œè¦ä¹ˆæ ¹æœ¬æ²¡æœ‰é‡å¤ï¼ˆæ²¡æœ‰é”™è¯¯ï¼Œåˆ‡ç‰‡è¢«å®Œå…¨æ’åºï¼‰ï¼Œè¦ä¹ˆè¿›è¡Œä¸€æ¬¡é‡å¤ï¼ˆæ’åºä¸­æ–­å¤§çº¦ä¸€åŠï¼Œå¯ä»¥é€šè¿‡è®¡æ—¶çœ‹åˆ°ï¼‰ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç»“æœ</b> <div class="spoiler_text"><pre> <code class="hljs powershell">~ &gt; cat /proc/cpuinfo | grep <span class="hljs-string"><span class="hljs-string">'model name'</span></span> | head <span class="hljs-literal"><span class="hljs-literal">-1</span></span> model name : Intel(R) Core(TM) i7<span class="hljs-literal"><span class="hljs-literal">-6700K</span></span> CPU <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> <span class="hljs-number"><span class="hljs-number">4.00</span></span>GHz ~ &gt; go version go version go1.<span class="hljs-number"><span class="hljs-number">11</span></span> linux/amd64 ~ &gt; go test <span class="hljs-literal"><span class="hljs-literal">-bench</span></span>=. github.com/anjensan/jex/demo goos: linux goarch: amd64 pkg: github.com/anjensan/jex/demo BenchmarkNoErrors/_____10/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">10000000</span></span> <span class="hljs-number"><span class="hljs-number">236</span></span> ns/op BenchmarkNoErrors/_____10/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">255</span></span> ns/op BenchmarkNoErrors/_____10/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">287</span></span> ns/op BenchmarkNoErrors/____100/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3119</span></span> ns/op BenchmarkNoErrors/____100/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3194</span></span> ns/op BenchmarkNoErrors/____100/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3533</span></span> ns/op BenchmarkNoErrors/___1000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">42356</span></span> ns/op BenchmarkNoErrors/___1000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">42204</span></span> ns/op BenchmarkNoErrors/___1000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-number"><span class="hljs-number">44465</span></span> ns/op BenchmarkNoErrors/__10000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">525864</span></span> ns/op BenchmarkNoErrors/__10000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">524781</span></span> ns/op BenchmarkNoErrors/__10000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-number"><span class="hljs-number">561256</span></span> ns/op BenchmarkNoErrors/_100000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6309181</span></span> ns/op BenchmarkNoErrors/_100000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6335135</span></span> ns/op BenchmarkNoErrors/_100000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">6687197</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">76274341</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">77806506</span></span> ns/op BenchmarkNoErrors/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">78019041</span></span> ns/op BenchmarkOneError/_____10/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2000000</span></span> <span class="hljs-number"><span class="hljs-number">712</span></span> ns/op BenchmarkOneError/_____10/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000000</span></span> <span class="hljs-number"><span class="hljs-number">268</span></span> ns/op BenchmarkOneError/_____10/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2000000</span></span> <span class="hljs-number"><span class="hljs-number">799</span></span> ns/op BenchmarkOneError/____100/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">2296</span></span> ns/op BenchmarkOneError/____100/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-number"><span class="hljs-number">1809</span></span> ns/op BenchmarkOneError/____100/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500000</span></span> <span class="hljs-number"><span class="hljs-number">3529</span></span> ns/op BenchmarkOneError/___1000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-number"><span class="hljs-number">21168</span></span> ns/op BenchmarkOneError/___1000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">100000</span></span> <span class="hljs-number"><span class="hljs-number">20747</span></span> ns/op BenchmarkOneError/___1000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-number"><span class="hljs-number">24560</span></span> ns/op BenchmarkOneError/__10000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-number"><span class="hljs-number">242077</span></span> ns/op BenchmarkOneError/__10000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-number"><span class="hljs-number">242376</span></span> ns/op BenchmarkOneError/__10000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-number"><span class="hljs-number">251043</span></span> ns/op BenchmarkOneError/_100000/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2753692</span></span> ns/op BenchmarkOneError/_100000/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2824116</span></span> ns/op BenchmarkOneError/_100000/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">2845701</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/exception<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33452819</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/return_err<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33374000</span></span> ns/op BenchmarkOneError/<span class="hljs-number"><span class="hljs-number">1000000</span></span>/fmt.errorf<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">33705994</span></span> ns/op PASS ok github.com/anjensan/jex/demo <span class="hljs-number"><span class="hljs-number">64.008</span></span>s</code> </pre> </div></div><br><p> å¦‚æœå°šæœªå¼•å‘é”™è¯¯ï¼ˆä»£ç ç¨³å®šä¸”ç»è¿‡å…·ä½“å¤„ç†ï¼‰ï¼Œåˆ™å¸¦æœ‰å¼‚å¸¸å¼•å‘çš„ä¿è¯ä¸<code>return err</code>å’Œ<code>fmt.Errorf</code>å¤§è‡´ç›¸å½“ã€‚ æœ‰æ—¶ä¼šå¿«ä¸€ç‚¹ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå¼•å‘äº†é”™è¯¯ï¼Œåˆ™å¼‚å¸¸å°†æ’åœ¨ç¬¬äºŒä½ã€‚ ä½†è¿™å…¨éƒ½å–å†³äºâ€œæœ‰ç”¨çš„å·¥ä½œ/é”™è¯¯â€çš„æ¯”ç‡å’Œå †æ ˆçš„æ·±åº¦ã€‚ å¯¹äºå°ç‰‡ï¼Œ <code>return err</code>é¢†å…ˆäºå·®è·ï¼›å¯¹äºå¤§ç‰‡å’Œå¤§ç‰‡ï¼Œå¼‚å¸¸å·²ç»ç­‰åŒäºæ‰‹åŠ¨è½¬å‘ã€‚ </p><br><p> ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœé”™è¯¯æå°‘å‘ç”Ÿï¼Œåˆ™å¼‚å¸¸ç”šè‡³å¯ä»¥ç¨å¾®åŠ å¿«ä»£ç çš„é€Ÿåº¦ã€‚ å¦‚æœåƒå…¶ä»–æ‰€æœ‰äººä¸€æ ·ï¼Œé‚£å°†æ˜¯ç±»ä¼¼çš„äº‹æƒ…ã€‚ ä½†æ˜¯ï¼Œå¦‚æœç»å¸¸å‡ºç°â€¦â€¦åˆ™ç¼“æ…¢çš„ä¾‹å¤–è¿œéæœ€é‡è¦çš„é—®é¢˜ï¼Œè¿™å€¼å¾—æ‹…å¿ƒã€‚ </p><br><p> ä½œä¸ºæµ‹è¯•ï¼Œæˆ‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿ç§»äº†ä¸€ä¸ª</a>çœŸæ­£çš„gosh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åº“</a>æ¥æ’é™¤å¼‚å¸¸ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ä»¤æˆ‘æ·±æ„Ÿé—æ†¾çš„æ˜¯ï¼Œé‡å†™1åˆ1æ— æ•ˆ</b> <div class="spoiler_text"><p> æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒæœ¬æ¥å¯ä»¥è¯æ˜ï¼Œä½†æ˜¯å¿…é¡»æ‰“æ‰°ã€‚ </p><br><p> å› æ­¤ï¼Œä¾‹å¦‚ï¼Œ <a href=""><code>rpc2XML</code></a>å‡½æ•°ä¼¼ä¹è¿”å›<code>error</code> â€¦â€¦æ˜¯çš„ï¼Œå®ƒæ°¸è¿œä¸ä¼šè¿”å›é”™è¯¯ã€‚ å¦‚æœæ‚¨å°è¯•åºåˆ—åŒ–ä¸æ”¯æŒçš„æ•°æ®ç±»å‹-æ²¡æœ‰é”™è¯¯ï¼Œåˆ™è¾“å‡ºä¸ºç©ºã€‚ ä¹Ÿè®¸è¿™å°±æ˜¯åŸæ„å—ï¼Ÿ..ä¸ï¼Œè‰¯å¿ƒä¸å…è®¸è¿™æ ·ã€‚ æ·»åŠ è€… </p><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: THROW(fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"unsupported type %T"</span></span>, value))</code> </pre> <br><p> ä½†æ˜¯äº‹å®è¯æ˜ï¼Œæ­¤åŠŸèƒ½æ˜¯ä»¥ç‰¹æ®Šæ–¹å¼ä½¿ç”¨çš„ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rpcParams2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rpc </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> err error buffer := <span class="hljs-string"><span class="hljs-string">"&lt;params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; reflect.ValueOf(rpc).Elem().NumField(); i++ { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xml <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> buffer += <span class="hljs-string"><span class="hljs-string">"&lt;param&gt;"</span></span> xml, err = rpc2XML(reflect.ValueOf(rpc).Elem().Field(i).Interface()) buffer += xml buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/param&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer, err }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éå†å‚æ•°åˆ—è¡¨ï¼Œå°†å®ƒä»¬å…¨éƒ¨åºåˆ—åŒ–ï¼Œä½†<em>ä»…</em>é’ˆå¯¹åè€…è¿”å›é”™è¯¯ã€‚ å…¶ä½™é”™è¯¯å°†è¢«å¿½ç•¥ã€‚ å¥‡æ€ªçš„è¡Œä¸ºå˜å¾—æ›´å®¹æ˜“ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rpcParams2XML_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rpc </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; reflect.ValueOf(rpc).Elem().NumField(); i++ { buffer += <span class="hljs-string"><span class="hljs-string">"&lt;param&gt;"</span></span> buffer += rpc2XML_(reflect.ValueOf(rpc).Elem().Field(i).Interface()) buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/param&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/params&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> <br><p> å¦‚æœè‡³å°‘ä¸€ä¸ªå­—æ®µæ— æ³•åºåˆ—åŒ–-è¿™æ˜¯ä¸€ä¸ªé”™è¯¯ã€‚ å¥½å§ï¼Œé‚£æ›´å¥½ã€‚ ä½†æ˜¯äº‹å®è¯æ˜ï¼Œæ­¤åŠŸèƒ½ä¹Ÿä»¥<a href="">ç‰¹æ®Š</a>æ–¹å¼ä½¿ç”¨ã€‚ </p><br><pre> <code class="go hljs">xmlstr, _ = rpcResponse2XML(response)</code> </pre> <br><p> åŒæ ·ï¼Œå¯¹äºæºä»£ç æ¥è¯´ï¼Œå®ƒå¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå› ä¸ºä¼šå¿½ç•¥é”™è¯¯ã€‚ æˆ‘å¼€å§‹çŒœæµ‹ä¸ºä»€ä¹ˆæœ‰äº›ç¨‹åºå‘˜<em>å¦‚æ­¤</em>å–œæ¬¢é€šè¿‡<code>if err != nil</code>è¿›è¡Œæ˜¾å¼é”™è¯¯å¤„ç†â€¦â€¦ä½†æ˜¯é™¤äº†ä¾‹å¤–ï¼Œè½¬å‘æˆ–å¤„ç†éƒ½æ¯”å¿½ç•¥èµ·æ¥æ›´å®¹æ˜“ </p><br><pre> <code class="go hljs">xmlstr = rpcResponse2XML_(response)</code> </pre> <br><p> è€Œä¸”æˆ‘è¿˜æ²¡æœ‰å¼€å§‹åˆ é™¤â€œé”™è¯¯é“¾â€ã€‚ è¿™æ˜¯åŸå§‹ä»£ç  </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeClientResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader, reply </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { rawxml, err := ioutil.ReadAll(r) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FaultSystemError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xml2RPC(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(rawxml), reply) }</code> </pre> <br><p> è¿™æ˜¯æ”¹å†™çš„ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeClientResponse_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader, reply </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawxml []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { rawxml, ERR = ioutil.ReadAll(r) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { THROW(FaultSystemError) } xml2RPC_(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(rawxml), reply) }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼ŒåŸå§‹é”™è¯¯ï¼ˆ <code>ioutil.ReadAll</code>è¿”å›çš„é”™è¯¯ï¼‰å°†ä¸ä¼šä¸¢å¤±ï¼Œå®ƒå°†é™„åŠ åˆ°<code>suppress</code>å­—æ®µä¸­çš„å¼‚å¸¸ä¸­ã€‚ åŒæ ·ï¼Œå®ƒå¯ä»¥åƒåŸå§‹ç‰ˆæœ¬ä¸€æ ·è¿›è¡Œï¼Œä½†æ˜¯å¿…é¡»ç‰¹åˆ«æ··æ·†... </p><br><p> æˆ‘é‡å†™äº†æµ‹è¯•ï¼Œå°†<code>if err != nil { log.Error(..) }</code>æ›¿æ¢ä¸ºç®€å•çš„å¼‚å¸¸æŠ›å‡ºã€‚ ä¸åˆ©çš„ä¸€é¢æ˜¯-æµ‹è¯•è½åœ¨äº†ç¬¬ä¸€ä¸ªé”™è¯¯ä¸Šï¼Œâ€œè‡³å°‘åœ¨æŸç§ç¨‹åº¦ä¸Šâ€æ²¡æœ‰ç»§ç»­èµ·ä½œç”¨ã€‚ æ ¹æ®æ€æƒ³ï¼Œæœ‰å¿…è¦å°†å®ƒä»¬åˆ’åˆ†ä¸ºå­æµ‹è¯•...æ€»çš„æ¥è¯´ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å€¼å¾—åšã€‚ ä½†æ˜¯ï¼Œè·å¾—æ­£ç¡®çš„å †æ ˆç«ä»·éå¸¸å®¹æ˜“ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorReporter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.TB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e error)</span></span></span></span> { t.Log(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(debug.Stack())) t.Fatal(e) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestRPC2XMLConverter_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> ex.Catch(errorReporter(t)) <span class="hljs-comment"><span class="hljs-comment">// ... xml := rpcRequest2XML_("Some.Method", req) }</span></span></code> </pre> <br><p> é€šå¸¸ï¼Œé”™è¯¯å¾ˆå®¹æ˜“å¿½ç•¥ã€‚ åœ¨åŸå§‹ä»£ç ä¸­ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fault2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fault Fault)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;methodResponse&gt;&lt;fault&gt;"</span></span> xml, _ := rpc2XML(fault) buffer += xml buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/fault&gt;&lt;/methodResponse&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæ¥è‡ª<code>rpc2XML</code>çš„é”™è¯¯å†æ¬¡è¢«<code>rpc2XML</code>å¿½ç•¥ã€‚ å˜æˆäº†è¿™æ · </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fault2XML</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fault Fault)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { buffer := <span class="hljs-string"><span class="hljs-string">"&lt;methodResponse&gt;&lt;fault&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TRY() { buffer += rpc2XML_(fault) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"ERR: %v"</span></span>, EX()) buffer += <span class="hljs-string"><span class="hljs-string">"&lt;nil/&gt;"</span></span> } buffer += <span class="hljs-string"><span class="hljs-string">"&lt;/fault&gt;&lt;/methodResponse&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buffer }</code> </pre> </div></div><br><p> æ ¹æ®æˆ‘ä¸ªäººçš„æ„Ÿè§‰ï¼Œè¿”å›å¸¦æœ‰é”™è¯¯çš„â€œåŠæˆå“â€ç»“æœä¼šæ›´å®¹æ˜“ã€‚ <br> ä¾‹å¦‚ï¼ŒåŠæ„å»ºçš„å“åº”ã€‚ å¼‚å¸¸æ›´ä¸ºå¤æ‚ï¼Œå› ä¸ºè¯¥å‡½æ•°è¦ä¹ˆè¿”å›æˆåŠŸçš„ç»“æœï¼Œè¦ä¹ˆä»€ä¹ˆéƒ½ä¸è¿”å›ã€‚ ä¸€ç§åŸå­æ€§ã€‚ å¦ä¸€æ–¹é¢ï¼Œå¼‚å¸¸æ›´éš¾å¿½ç•¥æˆ–ä¸¢å¤±å¼‚å¸¸é“¾ä¸­çš„æ ¹æœ¬åŸå› ã€‚ æ¯•ç«Ÿï¼Œæ‚¨ä»ç„¶å¿…é¡»ä¸“é—¨å°è¯•æ‰§è¡Œæ­¤æ“ä½œã€‚ å‡ºç°é”™è¯¯æ—¶ï¼Œè¿™å¾ˆå®¹æ˜“è‡ªç„¶å‘ç”Ÿã€‚ </p><br><h2 id="vmesto-zaklyucheniya"> è€Œä¸æ˜¯ç»“è®º </h2><br><p> åœ¨<em>æ’°å†™</em>æœ¬æ–‡æ—¶ï¼Œæ²¡æœ‰åœ°é¼ å—ä¼¤ã€‚ </p><br><p> æ„Ÿè°¢æ‚¨æä¾›çš„å»å¤«é…’çš„ç…§ç‰‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://migranov.ru</a> </p><br><p> æˆ‘æ— æ³•åœ¨â€œç¼–ç¨‹â€å’Œâ€œå¼‚å¸¸ç¼–ç¨‹â€ä¸­å¿ƒä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ <br> ä¸¤è€…éƒ½å¢åŠ äº†ä¸€ä¸ªéå¸¸å›°éš¾çš„é€‰æ‹©ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425145/">https://habr.com/ru/post/zh-CN425145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425135/index.html">ä¸ºä»€ä¹ˆVoIPåœ¨ç¾å›½è¢«å…¬è®¤ä¸ºä¿¡æ¯æœåŠ¡ï¼Œè¿™å¯¹ç”µä¿¡è¡Œä¸šå’Œç”¨æˆ·æ„å‘³ç€ä»€ä¹ˆ</a></li>
<li><a href="../zh-CN425137/index.html">æˆ‘ä»¬åœ¨æ§åˆ¶å°ä¸­å¿«é€Ÿé«˜æ•ˆåœ°å·¥ä½œ</a></li>
<li><a href="../zh-CN425139/index.html">äººå·¥æ™ºèƒ½é•œå¤´ä¸‹çš„æµè¡Œæ­Œæ˜Ÿ</a></li>
<li><a href="../zh-CN425141/index.html">â€œé¢å¯¹Guidoæ‚¨æ‰€è¯´çš„è¯â€æˆ–ä¸Bobukçš„Pythonå¯¹è¯</a></li>
<li><a href="../zh-CN425143/index.html">ç»æµé«˜ç­‰å­¦æ ¡æ‹’ç»ä¸¾åŠæœ‰åˆ©äºåœ¨çº¿è¯¾ç¨‹çš„è®²åº§</a></li>
<li><a href="../zh-CN425149/index.html">åœ¨å¤©åœ°ä¹‹é—´</a></li>
<li><a href="../zh-CN425151/index.html">ä½¿ç”¨æ‚¨çš„å®¢æˆ·ç«¯çªƒå¬ç”µæŠ¥èŠå¤©</a></li>
<li><a href="../zh-CN425153/index.html">æƒ…æ„Ÿè®¡ç®—ä¸­ä¸‰ç§æœ€æµè¡Œçš„æƒ…æ„Ÿè¯¯è§£</a></li>
<li><a href="../zh-CN425155/index.html">è¿·äººçš„å¯†ç å­¦æˆ–PHPä¸­å¯é€†åŠ å¯†çš„ç ”ç©¶</a></li>
<li><a href="../zh-CN425157/index.html">åœ¨çº¿ä¸CLRiumï¼ƒ4 +ä¸Šçš„.Netç¤¾åŒºä¼šé¢ã€‚ CoreCLRå’ŒCï¼ƒçš„å»å‘ã€‚ é‚€è¯·æ‰€æœ‰äºº</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>