<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòè üç∞ üçÆ A engenharia reversa da renderiza√ß√£o de The Witcher 3 üìõ üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üë¥üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, comecei a lidar com a renderiza√ß√£o de The Witcher 3. Este jogo tem incr√≠veis t√©cnicas de renderiza√ß√£o. Al√©m disso, ela √© magn√≠fica em te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A engenharia reversa da renderiza√ß√£o de The Witcher 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/422573/">  Recentemente, comecei a lidar com a renderiza√ß√£o de The Witcher 3.  Este jogo tem incr√≠veis t√©cnicas de renderiza√ß√£o.  Al√©m disso, ela √© magn√≠fica em termos de enredo / m√∫sica / jogabilidade. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5b/54e/95e/e5b54e95e53d14c22be446c3de24f8c3.jpg"></div><br><br>  Neste artigo, falarei sobre as solu√ß√µes usadas para renderizar The Witcher 3. N√£o ser√° t√£o abrangente quanto a an√°lise dos gr√°ficos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GTA V</a> de Adrian Correger, pelo menos por enquanto. <br><br>  Come√ßaremos com a engenharia reversa da corre√ß√£o de tom. <br><a name="habracut"></a><br><h2>  Parte 1: corre√ß√£o de tom </h2><br>  Na maioria dos jogos AAA modernos, uma das etapas de renderiza√ß√£o √© necessariamente a corre√ß√£o de tom. <br><br>  Deixe-me lembr√°-lo de que na vida real existe uma gama bastante ampla de brilho, enquanto nas telas de computador √© muito limitado (8 bits por pixel, o que nos d√° de 0 a 255).  √â aqui que o mapeamento de tons √© essencial, permitindo que voc√™ ajuste uma faixa mais ampla em um intervalo de ilumina√ß√£o limitado.  Normalmente, existem duas fontes de dados nesse processo: uma imagem HDR com ponto flutuante, cujos valores de cor excedem 1,0 e a ilumina√ß√£o m√©dia da cena (a √∫ltima pode ser calculada de v√°rias maneiras, mesmo levando em considera√ß√£o a adapta√ß√£o do olho para simular o comportamento dos olhos humanos, mas isso n√£o importa aqui). <br><br>  O pr√≥ximo (e √∫ltimo) passo √© obter a velocidade do obturador, calcular a cor com a velocidade do obturador e process√°-la usando a curva de corre√ß√£o de tom.  E aqui tudo se torna bastante confuso, porque novos conceitos aparecem, como o "ponto branco" (ponto branco) e o "meio cinza" (meio cinza).  Existem pelo menos algumas curvas populares, e algumas delas s√£o abordadas em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um olhar mais atento ao mapeamento de tons de</a> Matt Pettineo. <br><br>  Honestamente, sempre tive problemas com a implementa√ß√£o correta da corre√ß√£o de tom no meu pr√≥prio c√≥digo.  Existem pelo menos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">alguns</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplos</a> online <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diferentes</a> que me foram √∫teis ... at√© certo ponto.  Alguns deles levam em considera√ß√£o o brilho do HDR / ponto branco / cinza m√©dio, outros n√£o - portanto, eles realmente n√£o ajudam.  Eu queria encontrar uma implementa√ß√£o "testada em batalha". <br><br>  Trabalharemos no RenderDoc com a captura desse quadro de uma das principais miss√µes do Novigrad.  Todas as configura√ß√µes est√£o no m√°ximo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  Depois de pesquisar um pouco, encontrei uma chamada para corre√ß√£o de tom!  Como mencionei acima, h√° um buffer de cores HDR (n√∫mero de textura 0, resolu√ß√£o total) e o brilho m√©dio da cena (n√∫mero de textura 1, 1x1, ponto flutuante, calculado anteriormente pelo shader de computa√ß√£o). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9fe/836/3bd/9fe8363bdeda3b9e7336f0f67fc41dc3.jpg"></div><br>  Vamos dar uma olhada no c√≥digo do assembler para o pixel shader: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wxyz</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  H√° v√°rios pontos dignos de nota.  Em primeiro lugar, o brilho carregado n√£o precisa ser igual ao usado, pois √© limitado (chamadas m√°x / min) dentro dos valores escolhidos pelos artistas (no buffer constante).  Isso √© conveniente porque permite evitar uma velocidade do obturador muito alta ou baixa.  Esse movimento parece bastante comum, mas nunca o fiz antes.  Em segundo lugar, algu√©m familiarizado com as curvas de corre√ß√£o de tons reconhecer√° instantaneamente esse valor "11,2", porque, na verdade, esse √© o valor do ponto branco da curva de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corre√ß√£o de tons Uncharted2</a> de John Hable. <br><br>  Os par√¢metros AF s√£o carregados no cbuffer. <br><br>  Portanto, temos mais tr√™s par√¢metros: cb3_v16.x, cb3_v16.y, cb3_v16.z.  Podemos examinar seus significados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a52/975/78b/a5297578b0069fdded06bd3e82f2fadf.jpg"></div><br>  Meu palpite: <br><br>  Acredito que ‚Äúx‚Äù √© um tipo de ‚Äúescala de branco‚Äù ou cinza m√©dio, porque √© multiplicado por 11.2 (linha 4) e, depois disso, √© usado como numerador no c√°lculo da velocidade do obturador (linha 10). <br><br>  "Y" - chamei de "fator numerador u2" e logo voc√™ ver√° o porqu√™. <br><br>  "Z" √© o "par√¢metro de exponencia√ß√£o", porque √© usado no log triplo / mul / exp (de fato, na exponencia√ß√£o). <br><br>  Mas trate esses nomes de vari√°veis ‚Äã‚Äãcom um certo ceticismo! <br><br>  Tamb√©m: <br><br>  cb3_v4.yz - valores m√≠nimo / m√°ximo de brilho admiss√≠vel, <br>  cb3_v7.xyz - par√¢metros CA da curva Uncharted2, <br>  cb3_v8.xyz - par√¢metros DF da curva Uncharted2. <br><br>  Agora vamos √† parte dif√≠cil - escreveremos um shader HLSL que nos fornecer√° exatamente o mesmo c√≥digo do assembler. <br><br>  Isso pode ser muito dif√≠cil, e quanto maior o sombreador, mais dif√≠cil a tarefa.  Felizmente, h√° algum tempo, escrevi uma ferramenta para navegar rapidamente pelo hlsl-&gt; asm. <br><br>  Senhoras e senhores, sejam bem-vindos ao D3DShaderDisassembler! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/394/463/6ec/3944636ec3737e5e1ff5463e7b89d49f.jpg"></div><br>  Tendo experimentado o c√≥digo, obtive a <b><i>corre√ß√£o de tons</i></b> HLSL pronta para uso <b><i>The Witcher 3</i></b> : <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); avgLuminance = clamp( avgLuminance, cb3_v4.y, cb3_v4.z ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = cb3_v16.x * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, cb3_v16.z ); luma = luma * scaledWhitePoint; luma = cb3_v16.x / luma; float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, luma*HDRColor, cb3_v16.y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(color, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Uma captura de tela do meu utilit√°rio para confirmar isso: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9c/1e9/70a/f9c1e970a743cac54c9129261514c3e1.jpg"></div><br>  Voila! <br><br>  Acredito que esta seja uma implementa√ß√£o bastante precisa da corre√ß√£o de tons TW3, pelo menos em termos de c√≥digo assembler.  Eu j√° o apliquei no meu framework e funciona muito bem! <br><br>  Eu disse ‚Äúbasta‚Äù porque n√£o <i>tenho id√©ia do</i> porqu√™ o denominador em ToneMapU2Func se torna m√°ximo em zero.  Ao dividir por 0, voc√™ deve ficar indefinido? <br><br>  Isso pode ser conclu√≠do, mas quase por acidente encontrei neste quadro outra vers√£o do sombreador TW3, usada para um belo p√¥r do sol (√© interessante que seja usado com configura√ß√µes gr√°ficas m√≠nimas!) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/25b/bea/29225bbeae55c97c5a83e3461f7f24a7.jpg"></div><br>  Vamos conferir.  Primeiro, o c√≥digo do assembler para o shader: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 5 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[13]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  A princ√≠pio, o c√≥digo pode parecer intimidador, mas, na verdade, nem tudo √© t√£o ruim.  Ap√≥s uma breve an√°lise, voc√™ notar√° que h√° duas chamadas para a fun√ß√£o Uncharted2 com diferentes conjuntos de dados de entrada (AF, brilho m√≠nimo / m√°ximo ...).  Eu nunca vi essa decis√£o antes. <br><br>  E HLSL: <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; <span class="hljs-type"><span class="hljs-type">float</span></span> getExposure(<span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> minLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> maxLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> middleGray, <span class="hljs-type"><span class="hljs-type">float</span></span> powParam) { avgLuminance = clamp( avgLuminance, minLuminance, maxLuminance ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = middleGray * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, powParam); luma = luma * scaledWhitePoint; <span class="hljs-type"><span class="hljs-type">float</span></span> exposure = middleGray / luma; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exposure; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure1 = getExposure( avgLuminance, cb3_v9.y, cb3_v9.z, cb3_v17.x, cb3_v17.z); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure2 = getExposure( avgLuminance, cb3_v4.y, cb3_v4.z, cb3_v16.x, cb3_v16.z); float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color1 = ToneMapU2Func( cb3_v11.x, cb3_v11.y, cb3_v11.z, cb3_v12.x, cb3_v12.y, cb3_v12.z, exposure1*HDRColor, cb3_v17.y); float3 color2 = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, exposure2*HDRColor, cb3_v16.y); float3 finalColor = lerp( color2, color1, cb3_v13.x ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(finalColor, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Ou seja, de fato, temos dois conjuntos de par√¢metros de controle, calculamos duas cores com corre√ß√£o de tom e, no final, as interpolamos.  Decis√£o inteligente! <br><br><h2>  Parte 2: adapta√ß√£o ocular </h2><br>  A segunda parte ser√° muito mais simples. <br><br>  Na primeira parte, mostrei como a corre√ß√£o tonal √© realizada no TW3.  Explicando a fundamenta√ß√£o te√≥rica, mencionei brevemente a adapta√ß√£o do olho.  E voc√™ sabe o que?  Nesta parte, falarei sobre como essa adapta√ß√£o do olho √© realizada. <br><br>  Mas espere, o que √© adapta√ß√£o ocular e por que precisamos dela?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A Wikipedia</a> sabe tudo sobre isso, mas vou explicar: imagine que voc√™ est√° em um quarto escuro (lembre-se de que Life is Strange) ou em uma caverna e saia para fora onde est√° claro.  Por exemplo, a principal fonte de ilumina√ß√£o pode ser o sol. <br><br>  No escuro, nossas pupilas s√£o dilatadas para que mais luz entre na retina atrav√©s delas.  Quando fica claro, nossas pupilas diminuem e √†s vezes fechamos os olhos porque "d√≥i". <br><br>  Essa altera√ß√£o n√£o ocorre instantaneamente.  O olho deve se adaptar √†s mudan√ßas no brilho.  √â por isso que realizamos a adapta√ß√£o dos olhos na renderiza√ß√£o em tempo real. <br><br>  Um bom exemplo de quando √© notada uma falta de adapta√ß√£o ocular √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HDRToneMappingCS11</a> do DirectX SDK.  Mudan√ßas n√≠tidas de brilho m√©dio s√£o bastante desagrad√°veis ‚Äã‚Äãe n√£o naturais. <br><br>  Vamos come√ßar!  Por uma quest√£o de consist√™ncia, analisaremos o mesmo quadro do Novigrad. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  Agora vamos nos aprofundar no programa de captura de quadros RenderDoc.  A adapta√ß√£o do olho geralmente √© realizada logo antes da corre√ß√£o tonal, e The Witcher 3 n√£o √© exce√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ed/fde/eec/8edfdeeec29fef781801b94948c90e6f.png"></div><br>  Vejamos o estado do pixel shader: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e68/2fd/2f4/e682fd2f410f32eb8661c2476c8a2294.jpg"></div><br>  Temos duas fontes de entrada - 2 texturas, R32_FLOAT, 1x1 (um pixel).  texture0 cont√©m o brilho m√©dio da cena do quadro anterior.  texture1 cont√©m o brilho m√©dio da cena do quadro atual (calculado imediatamente antes desse shader de computa√ß√£o - marquei isso em azul). <br><br>  Espera-se que exista uma sa√≠da - R32_FLOAT, 1x1.  Vamos olhar para o pixel shader. <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 1 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yxzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ge</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">movc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Uau, que simples!  Apenas 7 linhas de c√≥digo assembler.  O que est√° acontecendo aqui?  Vou explicar cada linha: <br><br>  0) Obtenha o brilho m√©dio do quadro atual. <br>  1) Obtenha o brilho m√©dio do quadro anterior. <br>  2) Realize uma verifica√ß√£o: o brilho atual √© menor ou igual ao brilho do quadro anterior? <br>  Se sim, o brilho diminui; caso contr√°rio, o brilho aumenta. <br>  3) Calcule a diferen√ßa: <i>diferen√ßa = currentLum - previousLum.</i> <br>  4) Essa transfer√™ncia condicional (movc) atribui um fator de velocidade a partir do buffer constante.  Dois valores diferentes podem ser atribu√≠dos a partir da linha 2, dependendo do resultado da verifica√ß√£o.  √â uma jogada inteligente, pois dessa maneira voc√™ pode obter diferentes velocidades de adapta√ß√£o para diminuir e aumentar o brilho.  Mas no quadro estudado, os dois valores s√£o os mesmos e variam de 0,11 a 0,3. <br>  5) O c√°lculo final do brilho adaptado : <i>umina√ß√£o</i> adaptada <i>= velocidadeFator * diferen√ßa + lumin√¢ncia anterior.</i> <br>  6) O fim do shader <br><br>  Isso √© implementado no HLSL simplesmente: <br><br><pre> <code class="hljs pgsql"> // The Witcher <span class="hljs-number"><span class="hljs-number">3</span></span> eye adaptation shader cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; SamplerState samplerPointClamp : register (s0); SamplerState samplerPointClamp2 : register (s1); Texture2D TexPreviousAvgLuminance : register (t0); Texture2D TexCurrentAvgLuminance : register (t1); <span class="hljs-type"><span class="hljs-type">float4</span></span> TW3_EyeAdaptationPS(VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_TARGET { // <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> currentAvgLuminance = TexCurrentAvgLuminance.SampleLevel( samplerPointClamp2, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> previousAvgLuminance = TexPreviousAvgLuminance.SampleLevel( samplerPointClamp, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); // Difference <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> difference = currentAvgLuminance - previousAvgLuminance; // Scale factor. Can be different <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> falling down <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rising up <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> luminance. // It affects speed <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> adaptation. // Small conditional test <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> performed here, so different speed can be <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> differently <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> these cases. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptationSpeedFactor = (currentAvgLuminance &lt;= previousAvgLuminance) ? cb3_v0.x : cb3_v0.y; // Calculate adapted luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptedLuminance = adaptationSpeedFactor * difference + previousAvgLuminance; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adaptedLuminance; }</code> </pre> <br>  Essas linhas nos d√£o o mesmo c√≥digo assembler.  Eu sugeriria apenas substituir o tipo de sa√≠da por <i>float4</i> por <i>float</i> .  N√£o h√° necessidade de desperd√≠cio de largura de banda.  √â assim que o Witcher 3 implementa a adapta√ß√£o ocular.  Muito simples, certo? <br><br>  PS.  Muito obrigado a Baldur Karlsson (Twitter: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@baldurk</a> ) pelo RenderDoc.  O programa √© √≥timo. <br><br><h2>  Parte 3: aberra√ß√£o crom√°tica </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A aberra√ß√£o crom√°tica</a> √© um efeito encontrado principalmente em lentes baratas.  Isso ocorre porque as lentes t√™m diferentes √≠ndices de refra√ß√£o para diferentes comprimentos de luz vis√≠vel.  Como resultado, uma distor√ß√£o vis√≠vel aparece.  No entanto, nem todo mundo gosta.  Felizmente, em Witcher 3, esse efeito √© muito sutil e, portanto, n√£o √© irritante na jogabilidade (pelo menos eu).  Mas voc√™ pode deslig√°-lo, se desejar. <br><br>  Vamos dar uma olhada em um exemplo de cena com aberra√ß√£o crom√°tica e sem ela: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a5e/078/853/a5e0788530c688f849013ff3ed64134f.png"></div><br>  <i>Aberra√ß√£o crom√°tica inclu√≠da</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8d/20f/ee7/d8d20fee7a901301b9f2e5f67a2f56be.png"></div><br>  <i>Aberra√ß√£o crom√°tica desativada</i> <br><br>  Voc√™ percebe alguma diferen√ßa perto das bordas?  Eu tamb√©m n√£o.  Vamos tentar outra cena: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cff/9a3/b41/cff9a3b41c135e4c43cd3065328dc235.png"></div><br>  <i>A aberra√ß√£o crom√°tica est√° inclu√≠da.</i>  <i>Observe a leve distor√ß√£o ‚Äúvermelha‚Äù na √°rea indicada.</i> <br><br>  Sim, muito melhor!  Aqui o contraste entre as √°reas escuras e claras √© mais forte e, no canto, vemos uma leve distor√ß√£o.  Como voc√™ pode ver, esse efeito √© muito fraco.  No entanto, eu queria saber como √© implementado.  Vamos para a parte mais curiosa: o c√≥digo! <br><br>  <b>Implementa√ß√£o</b> <br><br>  A primeira coisa a fazer √© encontrar a chamada correta com um sombreador de pixels.  De fato, a aberra√ß√£o crom√°tica √© parte do grande sombreador de pixel "p√≥s-processamento", que consiste em aberra√ß√£o crom√°tica, vinheta e corre√ß√£o de gama.  Tudo isso est√° dentro de um √∫nico pixel shader.  Vamos dar uma olhada no c√≥digo do assembler para o pixel shader: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">linear</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">lt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">if_nz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">endif</span></span> ...</code> </pre> <br>  E para os valores do cbuffer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7d9/e1d/6b6/7d9e1d6b60039074712ea0e60dba2ae0.jpg"></div><br>  Ent√£o, vamos tentar entender o que est√° acontecendo aqui.  De fato, cb3_v17.xy √© o centro da aberra√ß√£o crom√°tica, de modo que as primeiras linhas calculam o vetor 2d das coordenadas texel (cb3_v17.zw = o inverso do tamanho da janela de exibi√ß√£o) para o ‚Äúcentro da aberra√ß√£o crom√°tica‚Äù e seu comprimento, depois executam outros c√°lculos, verifica√ß√µes e ramifica√ß√µes .  Ao aplicar a aberra√ß√£o crom√°tica, calculamos os deslocamentos usando certos valores do buffer constante e distorcemos os canais R e G. Em geral, quanto mais pr√≥ximos das bordas da tela, maior o efeito.  A linha 10 √© bastante interessante porque faz com que os pixels "se aproximem", especialmente quando exageramos a aberra√ß√£o.  Terei prazer em compartilhar com voc√™ minha percep√ß√£o do efeito.  Como sempre, use nomes de vari√°veis ‚Äã‚Äãcom uma cota (s√≥lida) de ceticismo.  E observe que o efeito √© aplicado <i>antes da</i> corre√ß√£o gama. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">void</span></span> ChromaticAberration( float2 uv, <span class="hljs-keyword"><span class="hljs-keyword">inout</span></span> float3 color ) { // <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-defined params float2 chromaticAberrationCenter = float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationCenterAvoidanceDistance = <span class="hljs-number"><span class="hljs-number">0.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fA = <span class="hljs-number"><span class="hljs-number">1.25</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAbberationIntensity = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAberrationDistortionSize = <span class="hljs-number"><span class="hljs-number">0.75</span></span>; // Calculate vector float2 chromaticAberrationOffset = uv - chromaticAberrationCenter; chromaticAberrationOffset = chromaticAberrationOffset / chromaticAberrationCenter; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLength = length(chromaticAberrationOffset); // <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> avoid applying chromatic aberration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> center, subtract small <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> // just calculated length. <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLengthFixed = chromaticAberrationOffsetLength - chromaticAberrationCenterAvoidanceDistance; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationTexel = saturate(chromaticAberrationOffsetLengthFixed * fA); <span class="hljs-type"><span class="hljs-type">float</span></span> fApplyChromaticAberration = (<span class="hljs-number"><span class="hljs-number">0.0</span></span> &lt; chromaticAberrationTexel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fApplyChromaticAberration) { chromaticAberrationTexel *= chromaticAberrationTexel; chromaticAberrationTexel *= fChromaticAberrationDistortionSize; chromaticAberrationOffsetLength = max(chromaticAberrationOffsetLength, <span class="hljs-number"><span class="hljs-number">1e-4</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> fMultiplier = chromaticAberrationTexel / chromaticAberrationOffsetLength; chromaticAberrationOffset *= fMultiplier; chromaticAberrationOffset *= g_Viewport.zw; chromaticAberrationOffset *= fChromaticAbberationIntensity; float2 offsetUV = -chromaticAberrationOffset * <span class="hljs-number"><span class="hljs-number">2</span></span> + uv; color.r = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).r; offsetUV = uv - chromaticAberrationOffset; color.g = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).g; } }</code> </pre> <br>  Eu adicionei ‚ÄúfChromaticAberrationIntensity‚Äù para aumentar o tamanho do deslocamento e, portanto, a for√ßa do efeito, como o nome sugere (TW3 = 1.0).  Intensidade = 40: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/864/69e/aea/86469eaea28862b558fa90784b8c4585.png"></div><br>  Isso √© tudo!  Espero que voc√™ tenha gostado desta parte. <br><br><h2>  Parte 4: vinhetas </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A vinheta</a> √© um dos efeitos de p√≥s-processamento mais comuns usados ‚Äã‚Äãnos jogos.  Ele tamb√©m √© popular na fotografia.  Cantos ligeiramente sombreados podem criar um efeito bonito.  Existem v√°rios tipos de vinhetas.  Por exemplo, o <a href="">Unreal Engine 4</a> usa natural.  Mas voltando ao The Witcher 3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Clique aqui</a> para ver uma compara√ß√£o interativa de quadros com e sem vinheta.  A compara√ß√£o √© feita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no guia de desempenho da NVIDIA para The Witcher 3</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b27/b52/986/b27b52986e845f39a32710276adc9fa8.png"></div><br>  <i>Captura de tela de "The Witcher 3" com vinhetas ativadas.</i> <br><br>  Observe que o canto superior esquerdo (c√©u) n√£o est√° t√£o sombreado quanto as outras partes da imagem.  Mais tarde retornaremos a isso. <br><br>  <b>Detalhes da implementa√ß√£o</b> <br><br>  Em primeiro lugar, h√° uma pequena diferen√ßa entre as vinhetas usadas na vers√£o original de The Witcher 3 (lan√ßado em 19 de maio de 2015) e em The Witcher 3: Blood and Wine.  No primeiro, o "gradiente inverso" √© calculado dentro do pixel shader e, no segundo, √© pr√©-calculado em uma textura 2D de 256x256: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/455/0b4/c1d/4550b4c1d1a0ae80923cd75cd63c3e7f.jpg"></div><br>  Textura 256x256, usada como "gradiente reverso" no complemento "Sangue e vinho". <br><br>  Vou usar o shader de "Blood and Wine" (um √≥timo jogo, por sinal).  Como na maioria dos outros jogos, a vinheta de Witcher 3 √© calculada no pixel shader do p√≥s-processamento final.  D√™ uma olhada no c√≥digo do assembler: <br><br><pre> <code class="hljs css"> ... 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s2</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> ...</code> </pre> <br>  Interessante!  Parece que os espa√ßos gama (linha 46) e lineares (linha 51) s√£o usados ‚Äã‚Äãpara calcular as vinhetas.  Na linha 48, amostramos a textura do "gradiente inverso".  cb3 [9] .xyz n√£o est√° relacionado √† vinheta.  Em cada quadro verificado, √© atribu√≠do o valor float3 (1.0, 1.0, 1.0), ou seja, √© provavelmente o filtro final usado nos efeitos de desvanecimento / desvanecimento.  Existem tr√™s par√¢metros principais para vinhetas no TW3: <br><br><ul><li>  Opacidade (cb3 [6] .w) - afeta a for√ßa da vinheta.  0 - sem vinheta, 1 - vinheta m√°xima.  De acordo com minhas observa√ß√µes, na base The Witcher 3 √© de aproximadamente 1,0, enquanto em Blood and Wine flutua em torno de 0,15. </li><li>  Cor (cb3 [7] .xyz) - um excelente recurso da vinheta TW3 √© a capacidade de alterar sua cor.  N√£o precisa ser preto, mas na pr√°tica ... Geralmente, possui os valores float3 (3.0 / 255.0, 4.0 / 255.0, 5.0 / 255.0) e assim por diante - no caso geral, s√£o m√∫ltiplos de 0,00392156 = 1,0 / 255,0 </li><li>  Pesos (cb3 [6] .xyz) √© um par√¢metro muito interessante.  Eu sempre vi vinhetas "planas", por exemplo: </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a25/9e8/7f9/a259e87f9e5bbfc3edf6b4ff30aea90d.png"></div><br>  <i>M√°scara t√≠pica de vinheta</i> <br><br>  Mas usando pesos (linha 52), voc√™ pode obter resultados muito interessantes: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/c88/6c0/6c0c886c0175635ba609ef61e61b3ea3.png"></div><br>  <i>M√°scara de vinheta TW3 calculada usando pesos</i> <br><br>  Os pesos est√£o pr√≥ximos de 1,0.  Observe os dados constantes do buffer de um quadro de Blood and Wine (um mundo m√°gico com um arco-√≠ris): √© por isso que as vinhetas n√£o afetaram os pixels brilhantes do c√©u acima. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68a/2a9/9e5/68a2a99e54b0c8cf9e71561001315a34.png"></div><br>  <b>C√≥digo</b> <br><br>  Aqui est√° minha implementa√ß√£o da vinheta TW3 no HLSL. <br><br>  GammaToLinear = prisioneiro de guerra (cor, 2.2) <br><br><pre> <code class="hljs pgsql"> <span class="hljs-comment"><span class="hljs-comment">/* // The Witcher 3 vignette. // // Input color is in gamma space // Output color is in gamma space as well. */</span></span> float3 Vignette_TW3( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 gammaColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteWeights, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteOpacity, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Texture2D texVignette, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 texUV ) { // <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> coloring vignette float3 vignetteColorGammaSpace = -gammaColor + vignetteColor; // Calculate vignette amount based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> color <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> *LINEAR* color space <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> vignette weights. <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteWeight = dot( GammaToLinear( gammaColor ), vignetteWeights ); // We need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> keep vignette weight <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>] range vignetteWeight = saturate( <span class="hljs-number"><span class="hljs-number">1.0</span></span> - vignetteWeight ); // Multiply <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> opacity vignetteWeight *= vignetteOpacity; // Obtain vignette mask (here <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> texture; you can <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> calculate your custom mask here) <span class="hljs-type"><span class="hljs-type">float</span></span> sampledVignetteMask = texVignette.Sample( samplerLinearClamp, texUV ).x; // Final (inversed) vignette mask <span class="hljs-type"><span class="hljs-type">float</span></span> finalInvVignetteMask = saturate( vignetteWeight * sampledVignetteMask ); // final composite <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gamma space float3 Color = vignetteColorGammaSpace * finalInvVignetteMask + gammaColor.rgb; // * uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> vignette mask: // <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> - finalInvVignetteMask; // <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> final color <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Color; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espero que tenham gostado. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode experimentar o meu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que me ajudou muito a entender o c√≥digo do montador HLSL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como antes, tome os nomes das vari√°veis ‚Äã‚Äãcom um certo ceticismo - os shaders TW3 s√£o processados ‚Äã‚Äãpelo D3DStripShader; portanto, na verdade eu n√£o sei quase nada sobre eles, s√≥ posso adivinhar. </font><font style="vertical-align: inherit;">Al√©m disso, n√£o me responsabilizo pelos danos causados ‚Äã‚Äãao seu equipamento por este shader;) </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√¥nus: calculando o gradiente</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No The Witcher 3, lan√ßado em 2015, o gradiente inverso foi calculado no pixel shader, em vez de amostrar uma textura pr√©-calculada. </font><font style="vertical-align: inherit;">D√™ uma olhada no c√≥digo do assembler:</font></font><br><br><pre> <code class="hljs css"> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.550000</span></span>) 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.219512</span></span>) 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.105000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.120000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.090000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.940000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Felizmente para n√≥s, √© bastante simples. </font><font style="vertical-align: inherit;">No HLSL, ser√° algo parecido com isto:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> TheWitcher3_2015_Mask( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 uv ) { <span class="hljs-type"><span class="hljs-type">float</span></span> distanceFromCenter = length( uv - float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> x = distanceFromCenter * <span class="hljs-number"><span class="hljs-number">2.0</span></span> - <span class="hljs-number"><span class="hljs-number">0.55</span></span>; x = saturate( x * <span class="hljs-number"><span class="hljs-number">1.219512</span></span> ); // <span class="hljs-number"><span class="hljs-number">1.219512</span></span> = <span class="hljs-number"><span class="hljs-number">100</span></span>/<span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> x2 = x * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x3 = x2 * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x4 = x2 * x2; <span class="hljs-type"><span class="hljs-type">float</span></span> outX = dot( <span class="hljs-type"><span class="hljs-type">float4</span></span>(x4, x3, x2, x), <span class="hljs-type"><span class="hljs-type">float4</span></span>(<span class="hljs-number"><span class="hljs-number">-0.10</span></span>, <span class="hljs-number"><span class="hljs-number">-0.105</span></span>, <span class="hljs-number"><span class="hljs-number">1.12</span></span>, <span class="hljs-number"><span class="hljs-number">0.09</span></span>) ); outX = min( outX, <span class="hljs-number"><span class="hljs-number">0.94</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> outX; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou seja, simplesmente calculamos a dist√¢ncia do centro ao t√™xtil, fazemos um pouco de m√°gica (multiplica√ß√£o, saturam ...) e depois ... calculamos o polin√¥mio! </font><font style="vertical-align: inherit;">Awesome.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25d/79c/e67/25d79ce679f05a53946b475c6c152cc4.png"></div><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 5: o efeito da intoxica√ß√£o </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos ver como o jogo "The Witcher 3: Wild Hunt" implementa o efeito da intoxica√ß√£o. </font><font style="vertical-align: inherit;">Se voc√™ ainda n√£o o reproduziu, </font></font><strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">largue tudo, compre e reproduza,</font></font></strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assista a um v√≠deo </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Gy_B2V0QaqA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Noite: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/CXu3e7LWkjE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, vemos uma imagem dupla e turbilh√£o, surgindo frequentemente quando voc√™ bebe na vida real. </font><font style="vertical-align: inherit;">Quanto mais um pixel estiver do centro da imagem, mais forte ser√° o efeito de rota√ß√£o. </font><font style="vertical-align: inherit;">Eu intencionalmente postei o segundo v√≠deo com a noite, porque voc√™ pode ver claramente essa rota√ß√£o nas estrelas (veja 8 pontos separados?) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda parte do efeito da intoxica√ß√£o, que pode n√£o ser imediatamente percept√≠vel, √© uma pequena altera√ß√£o no zoom. </font><font style="vertical-align: inherit;">√â percept√≠vel perto do centro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente, √© √≥bvio que esse efeito √© um p√≥s-processamento t√≠pico (pixel shader). </font><font style="vertical-align: inherit;">No entanto, sua localiza√ß√£o no pipeline de renderiza√ß√£o pode n√£o ser t√£o √≥bvia. </font><font style="vertical-align: inherit;">Acontece que o efeito da intoxica√ß√£o √© aplicado imediatamente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ap√≥s a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corre√ß√£o tonal e logo antes do desfoque de movimento (a imagem "b√™bada" √© a entrada para o desfoque de movimento).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos come√ßar os jogos com c√≥digo assembler: </font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[3]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 8 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(10<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(5<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(8<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.020000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 67: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 68: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 69: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dois buffers constantes separados s√£o usados ‚Äã‚Äãaqui. Vamos verificar seus valores:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d7e/ce2/eb8/d7ece2eb8b0acf421cffd93222dd6821.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/832/ef8/941/832ef8941e9b4b6a38ad24b0c2e84cfa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estamos interessados ‚Äã‚Äãem alguns deles: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v0.x -&gt; tempo decorrido (em segundos) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v1.xyzw - tamanho da viewport e o inverso do tamanho da viewport (tamb√©m conhecido como "tamanho do pixel") </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v0.x - rota√ß√£o em torno de um pixel, sempre com um valor de 1,0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v0.y - a magnitude do efeito da intoxica√ß√£o. Depois de ligado, ele n√£o funciona com for√ßa total, mas aumenta gradualmente de 0,0 para 1,0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cv3_v1.xy - deslocamentos de pixel (mais sobre isso abaixo). Este √© um par sin / cos, para que voc√™ possa usar sincos (tempo) no shader, se desejar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v2.xy √© o centro do efeito, geralmente float2 (0,5, 0,5). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui, queremos nos concentrar em entender o que est√° acontecendo, e n√£o apenas reescrever cegamente o sombreador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßaremos com as primeiras linhas:</font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu chamo a linha 0 de "propor√ß√£o de zoom" e voc√™ logo ver√° o porqu√™. </font><font style="vertical-align: inherit;">Imediatamente ap√≥s (linha 1), calculamos o "deslocamento da rota√ß√£o". </font><font style="vertical-align: inherit;">Este √© apenas um par de dados sin / cos de entrada multiplicado por 0,05. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linhas 2-4: Primeiro, calculamos o vetor do centro do efeito para as coordenadas UV da textura. </font><font style="vertical-align: inherit;">Ent√£o calculamos o quadrado da dist√¢ncia (3) e a dist√¢ncia simples (4) (do centro ao texel)</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Coordenadas de textura de zoom </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vejamos o seguinte c√≥digo do assembler: </font></font><br><br><pre> <code class="hljs css"> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como eles s√£o compactados dessa maneira, podemos analisar apenas um par de flutuador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para iniciantes, r0.yz s√£o "deslocamentos de rota√ß√£o", r1.z √© a dist√¢ncia do centro ao texel, r1.xy √© o vetor do centro ao texel, r0.x √© o "fator de zoom". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para entender isso, vamos supor, por enquanto, que zoomFactor = 1.0, ou seja, voc√™ pode escrever o seguinte:</font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-number"><span class="hljs-number">8</span></span>: mul r2.xyzw, r0.yzyz, r1.zzzz <span class="hljs-number"><span class="hljs-number">9</span></span>: mad r2.xyzw, r1.xyxy, r0.xxxx, <span class="hljs-literal"><span class="hljs-literal">-r2</span></span>.xyzw <span class="hljs-number"><span class="hljs-number">13</span></span>: add r2.xyzw, r2.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r2.xy = (texel - center) * zoomFactor - rotationOffsets * distanceFromCenter + center;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mas zoomFactor = 1.0: </font></font><br><br><pre> <code class="hljs markdown"> r2.xy = texel - center - rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter + center; r2.xy = texel - rotationOffsets *</span></span> distanceFromCenter;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Da mesma forma para r3.xy: </font></font><br><br><pre> <code class="hljs cs"> <span class="hljs-number"><span class="hljs-number">10</span></span>: mul r3.xy, r0.xxxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">11</span></span>: mad r3.xyzw, r0.yzyz, r1.zzzz, r3.xyxy <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r3.xyzw, r3.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r3.xy = rotationOffsets * distanceFromCenter + zoomFactor * (texel - center) + center</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas zoomFactor = 1.0: </font><font style="vertical-align: inherit;">√ìtimo. </font><font style="vertical-align: inherit;">Ou seja, no momento, temos essencialmente o deslocamento atual TextureUV (texel) ¬± rota√ß√£o, mas e o zoomFactor? </font><font style="vertical-align: inherit;">Veja a linha 0. De fato, zoomFactor = 1.0 - 0.1 * drunkAmount. </font><font style="vertical-align: inherit;">Para o m√°ximo drunkAmount, o valor de zoomFactor deve ser 0,9 e as coordenadas da textura com zoom agora s√£o calculadas da seguinte forma:</font></font><br><br> <code>r3.xy = rotationOffsets * distanceFromCenter + texel - <strike>center</strike> + <strike>center</strike> r3.xy = texel + rotationOffsets * distanceFromCenter</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="hljs markdown"> baseTexcoordsA = 0.9 <span class="hljs-bullet"><span class="hljs-bullet">* texel + 0.1 *</span></span> center + rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter baseTexcoordsB = 0.9 *</span></span> texel + 0.1 <span class="hljs-bullet"><span class="hljs-bullet">* center - rotationOffsets *</span></span> distanceFromCenter</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez tal explica√ß√£o seja mais intuitiva: √© simplesmente interpola√ß√£o linear por algum fator entre as coordenadas normalizadas da textura e o centro. </font><font style="vertical-align: inherit;">Esta √© uma imagem de "zoom-in". </font><font style="vertical-align: inherit;">Para entender isso, √© melhor experimentar os valores. </font><font style="vertical-align: inherit;">Aqui est√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para Shadertoy, onde voc√™ pode ver o efeito em a√ß√£o.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deslocamento de textura </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Todo o fragmento no c√≥digo do assembler: </font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-number"><span class="hljs-number">2</span></span>: mad r1.xy, v1.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>].zwzz, <span class="hljs-literal"><span class="hljs-literal">-cb3</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">3</span></span>: dp2 r0.w, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">5</span></span>: mul r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">10.000000</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>: min r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: mul r0.w, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y <span class="hljs-number"><span class="hljs-number">14</span></span>: mul r0.x, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].x <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">5.000000</span></span>) // texcoords offset intensity <span class="hljs-number"><span class="hljs-number">16</span></span>: mul r4.xyzw, r0.xxxx, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].zwzw // texcoords offset</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cria um certo gradiente, vamos cham√°-lo de "m√°scara de intensidade de deslocamento". </font><font style="vertical-align: inherit;">De fato, ele d√° dois significados. </font><font style="vertical-align: inherit;">O primeiro est√° em r0.w (vamos us√°-lo mais tarde) e o segundo √© 5 vezes mais forte em r0.x (linha 15). </font><font style="vertical-align: inherit;">Este √∫ltimo realmente serve como um fator para o tamanho do texel, por isso afeta a for√ßa de polariza√ß√£o. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amostragem relacionada √† rota√ß√£o</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Em seguida, √© realizada uma s√©rie de amostragens de textura. </font><font style="vertical-align: inherit;">De fato, s√£o utilizadas 2 s√©ries de 8 amostras, uma para cada "lado". </font><font style="vertical-align: inherit;">No HLSL, voc√™ pode escrever isso da seguinte maneira:</font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> const float2 pointsAroundPixel<span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-number"><span class="hljs-function"><span class="hljs-number">8</span></span></span><span class="hljs-function">] = { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">float2</span></span></span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>, <span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-literal"><span class="hljs-literal">-1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>) }; float4 colorA = <span class="hljs-number"><span class="hljs-number">0</span></span>; float4 colorB = <span class="hljs-number"><span class="hljs-number">0</span></span>; int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">unroll</span></span></span><span class="hljs-function">] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { colorA += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsA + texcoordsOffset * pointsAroundPixel<span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">i</span></span></span><span class="hljs-function">] ); } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">colorA</span></span></span></span> /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">unroll</span></span></span><span class="hljs-function">] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { colorB += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsB + texcoordsOffset * pointsAroundPixel[<span class="hljs-type"><span class="hljs-type">i</span></span>] ); } colorB /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; float4 rotationPart = colorA + colorB;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O truque √© adicionar √† baseTexcoordsA / B um deslocamento adicional em um c√≠rculo unit√°rio, multiplicado pela ‚Äúintensidade de deslocamento da coordenada de textura‚Äù mencionada anteriormente. </font><font style="vertical-align: inherit;">Quanto mais longe o centro do pixel, maior o raio do c√≠rculo ao redor do pixel - n√≥s o amostramos 8 vezes, o que √© claramente vis√≠vel nas estrelas. </font><font style="vertical-align: inherit;">Valores PointsAroundPixel (m√∫ltiplos de 45 graus):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0cb/5d0/5b4/0cb5d05b44fd9d2969af0416684d4b77.jpg"></div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≠rculo √∫nico </font></font></a> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amostragem relacionada ao zoom</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A segunda parte do efeito de embriaguez no The Witcher 3 √© o zoom com mais e menos zoom. </font><font style="vertical-align: inherit;">Vamos dar uma olhada no c√≥digo do assembler que executa esta tarefa:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">56</span></span>: mad r2.xyzw, r3.xyzw, l(<span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>), r2.xyzw // the rotation part <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r2 register <span class="hljs-number"><span class="hljs-number">57</span></span>: mul r0.x, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">8.000000</span></span>) <span class="hljs-number"><span class="hljs-number">58</span></span>: mul r0.xy, r0.xxxx, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].zwzz <span class="hljs-number"><span class="hljs-number">59</span></span>: mad r0.z, cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">0.020000</span></span>), l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">60</span></span>: mul r1.zw, r0.zzzz, r1.xxxy <span class="hljs-number"><span class="hljs-number">61</span></span>: mad r1.xy, r1.xyxx, r0.zzzz, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">62</span></span>: mad r3.xy, r1.zwzz, r0.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">63</span></span>: mul r0.xy, r0.xyxx, r1.zwzz <span class="hljs-number"><span class="hljs-number">64</span></span>: mad r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r1.xyxx <span class="hljs-number"><span class="hljs-number">65</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r1.xyzw, r1.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">66</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r4.xyzw, r0.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">67</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r3.xyzw, r3.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">68</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r1.xyzw, r3.xyzw <span class="hljs-number"><span class="hljs-number">69</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r4.xyzw, r1.xyzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vemos que h√° tr√™s chamadas de textura separadas, ou seja, tr√™s coordenadas de textura diferentes. </font><font style="vertical-align: inherit;">Vamos analisar como as coordenadas de textura s√£o calculadas a partir delas. </font><font style="vertical-align: inherit;">Mas primeiro, mostramos a entrada para esta parte:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutScalePixels = drunkEffectAmount * <span class="hljs-number"><span class="hljs-number">8.0</span></span>; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span> float2 zoomInOutScaleNormalizedScreenCoordinates = zoomInOutScalePixels * texelSize.xy; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutAmplitude = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + <span class="hljs-number"><span class="hljs-number">0.02</span></span>*cos(<span class="hljs-type"><span class="hljs-type">time</span></span>); // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> float2 zoomInOutfromCenterToTexel = zoomInOutAmplitude * fromCenterToTexel; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas palavras sobre a entrada. </font><font style="vertical-align: inherit;">Calculamos o deslocamento em texels (por exemplo, 8,0 * tamanho texel), que √© ent√£o adicionado √†s coordenadas uv de base. </font><font style="vertical-align: inherit;">A amplitude simplesmente varia entre 0,98 e 1,02 para dar uma sensa√ß√£o de zoom, assim como o zoomFactor na parte que executa a rota√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos come√ßar com o primeiro par - r1.xy (linha 61)</font></font><br><br><pre> <code class="hljs markdown"> r1.xy = fromCenterToTexel <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + center r1.xy = (TextureUV - Center) *</span></span> amplitude + Center // you can insert here zoomInOutfromCenterToTexel r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude - Center *</span></span> amplitude + Center r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + Center *</span></span> 1.0 - Center <span class="hljs-bullet"><span class="hljs-bullet">* amplitude r1.xy = TextureUV *</span></span> amplitude + Center * (1.0 - amplitude) r1.xy = lerp( TextureUV, Center, amplitude);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Isto √©: </font></font><br><br><pre> <code class="hljs lisp">float2 zoomInOutBaseTextureUV = lerp(<span class="hljs-name"><span class="hljs-name">TextureUV</span></span>, Center, amplitude)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos verificar o segundo par - r3.xy (linha 62) </font></font><br><br><pre> <code class="hljs markdown"> r3.xy = (amplitude <span class="hljs-bullet"><span class="hljs-bullet">* fromCenterToTexel) *</span></span> zoomInOutScaleNormalizedScreenCoordinates + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Isto √©: </font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> zoomInOutAddTextureUV0 = zoomInOutBaseTextureUV + zoomInOutfromCenterToTexel*zoomInOutScaleNormalizedScreenCoordinates;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos verificar o terceiro par - r0.xy (linhas 63-64) </font></font><br><br><pre> <code class="hljs markdown"> r0.xy = zoomInOutScaleNormalizedScreenCoordinates <span class="hljs-bullet"><span class="hljs-bullet">* (amplitude *</span></span> fromCenterToTexel) * 2.0 + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Isto √©: </font></font><br><br><pre> <code class="hljs markdown"> float2 zoomInOutAddTextureUV1 = zoomInOutBaseTextureUV + 2.0<span class="hljs-emphasis"><span class="hljs-emphasis">*zoomInOutfromCenterToTexel*</span></span>zoomInOutScaleNormalizedScreenCoordinates</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todas as tr√™s consultas de textura s√£o adicionadas e o resultado √© armazenado no registro r1. </font><font style="vertical-align: inherit;">Vale a pena notar que este pixel shader usa um amostrador de endere√ßamento limitado. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juntando tudo</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ent√£o, no momento, temos o resultado da rota√ß√£o no registro r2 e tr√™s solicita√ß√µes de zoom dobrado no registro r1. </font><font style="vertical-align: inherit;">Vejamos as √∫ltimas linhas do c√≥digo do assembler:</font></font><br><br><pre> <code class="hljs css"> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre informa√ß√µes adicionais: r0.w √© obtido da linha 7, esta √© a nossa m√°scara de intensidade e cb3 [0] .y √© a magnitude do efeito de intoxica√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos ver como isso funciona. </font><font style="vertical-align: inherit;">Minha primeira abordagem foi a for√ßa bruta:</font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float4</span></span> finalColor = intensityMask * (rotationPart - zoomingPart); <span class="hljs-attribute"><span class="hljs-attribute">finalColor</span></span> = drunkIntensity * finalColor + zoomingPart; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> finalColor;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que diabos, ningu√©m escreve shaders assim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Peguei um l√°pis com papel e escrevi esta f√≥rmula:</font></font><br><br><pre> <code class="hljs powershell"> finalColor = effectAmount * [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span><span class="hljs-type"><span class="hljs-type">ensityMask</span></span> * (<span class="hljs-type"><span class="hljs-type">rotationPart</span></span> - <span class="hljs-type"><span class="hljs-type">zoomPart</span></span>)] + zoomPart finalColor = effectAmount * intensityMask * rotationPart - effectAmount * intensityMask * zoomPart + zooomPart</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onde t = effectAmount * intensidadeMask </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, obtemos:</font></font><br><br><pre> <code class="hljs lisp"> finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart + zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + zoomPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + (<span class="hljs-number"><span class="hljs-number">1.0</span></span> - <span class="hljs-literal"><span class="hljs-literal">t</span></span>) * zoomPart finalColor = lerp( <span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, <span class="hljs-literal"><span class="hljs-literal">t</span></span> )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E chegamos ao seguinte: </font></font><br><br><pre> <code class="hljs lisp"> finalColor = lerp(<span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, intensityMask * drunkIntensity);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sim, essa parte do artigo acabou sendo muito detalhada, mas finalmente terminamos! </font><font style="vertical-align: inherit;">Pessoalmente, aprendi algo no processo de escrever, espero que voc√™ tamb√©m! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ estiver interessado, as fontes HLSL completas est√£o dispon√≠veis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Testei-os com meu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e, embora n√£o haja correspond√™ncias diretas individuais com o shader original, as diferen√ßas s√£o t√£o pequenas (uma linha a menos) que posso dizer com confian√ßa que ele funciona. </font><font style="vertical-align: inherit;">Obrigado pela leitura!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422573/">https://habr.com/ru/post/pt422573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422555/index.html">Arquitetura multi-m√≥dulo Android. A a Z</a></li>
<li><a href="../pt422561/index.html">Como a Yandex aplicou a vis√£o computacional para melhorar a qualidade das transmiss√µes de v√≠deo. Tecnologia DeepHD</a></li>
<li><a href="../pt422565/index.html">Webinars de sexta-feira da Skillbox: tudo para programadores e designers</a></li>
<li><a href="../pt422569/index.html">De hora em hora, aplicativo de rastreamento de tempo</a></li>
<li><a href="../pt422571/index.html">Paralelizando tarefas com depend√™ncias - exemplo .NET</a></li>
<li><a href="../pt422575/index.html">Intercomunicador raro</a></li>
<li><a href="../pt422577/index.html">C√≥pias e direitos autorais: como a patente e os direitos autorais afetam o desenvolvimento da impress√£o 3D</a></li>
<li><a href="../pt422581/index.html">Interruptor qu√¢ntico no estilo Schr√∂dinger</a></li>
<li><a href="../pt422583/index.html">Tough Middling: Revis√£o do telefone IP Snom D735</a></li>
<li><a href="../pt422585/index.html">O uso pr√°tico de redes neurais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>