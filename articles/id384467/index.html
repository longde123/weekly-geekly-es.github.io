<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöï üìõ üë∞ Watchdog berbasis Arduino Nano ü§öüèΩ ü§πüèº üå¨Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Watchdog adalah perangkat yang dirancang untuk mendeteksi dan memecahkan masalah perangkat keras. Biasanya, timer digunakan untuk ini, restart secara ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Watchdog berbasis Arduino Nano</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384467/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watchdog adalah perangkat yang dirancang untuk mendeteksi dan memecahkan masalah perangkat keras. </font><font style="vertical-align: inherit;">Biasanya, timer digunakan untuk ini, restart secara berkala yang mencegah sinyal dikirim ke reboot. </font></font></i><br>
<br>
<img src="https://habrastorage.org/files/521/6a2/019/5216a20198774a66bbc61882047bfe8b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Server utama di Gentoo digunakan oleh saya terutama untuk percobaan, namun, ia menjalankan sejumlah layanan yang, jika mungkin, harus tersedia tanpa gangguan. </font><font style="vertical-align: inherit;">Sayangnya, konsekuensi dari beberapa percobaan menyebabkan panik kernel, beban CPU 100% dan masalah lainnya pada saat yang paling tidak tepat. </font><font style="vertical-align: inherit;">Jadi ide menambahkan anjing pengawas telah lama membutuhkan perhatian dan akhirnya terwujud dalam perangkat ini.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah pemeriksaan cermat atas apa yang tersedia dan penilaian waktu yang tersedia, pengawas berkumpul berdasarkan Arduino Nano adalah pilihan terbaik. </font><font style="vertical-align: inherit;">Daftar persyaratan muncul hampir sama:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memulai dan menghentikan daemon agar berfungsi dengan timer, alat OS biasa (OpenRC).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watchdog sendiri di perangkat, di ATmega itu, Anda harus menggunakannya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log peristiwa pada perangkat untuk memperbaiki reboot dan timer.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sinkronkan waktu perangkat dengan host untuk mencatat waktu yang benar dalam log.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menerima dan menampilkan status perangkat dan entri log-nya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menghapus log dan mengatur ulang perangkat ke kondisi semula.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, "mikroskop" ditemukan, "kuku" ditandai ... Anda dapat palu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perangkat keras</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dasar perangkat itu adalah klon Cina, Arduino Nano, yang dibuat atas dasar chip CH340. </font><font style="vertical-align: inherit;">Kernel Linux segar (diuji sejak 3.16) memiliki driver yang sesuai, sehingga perangkat ini mudah dideteksi sebagai port serial USB.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Unwanted Reboot</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap kali terminal terhubung, Arduino reboot. </font><font style="vertical-align: inherit;">Alasannya adalah bahwa terminal mengirimkan sinyal DTR (Data Terminal Ready), yang menyebabkan perangkat melakukan reboot. </font><font style="vertical-align: inherit;">Dengan demikian, IDE Arduino menempatkan perangkat ke mode untuk memuat sketsa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada beberapa opsi untuk menyelesaikan masalah, tetapi hanya satu yang ternyata berfungsi - perlu untuk menginstal elektrolit 10ŒºF (C1 pada diagram di bawah) antara kontak RST dan GND. </font><font style="vertical-align: inherit;">Sayangnya, ini juga memblokir unduhan sketsa ke perangkat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya - skema adalah sebagai berikut: </font></font><br>
<br>
<img src="https://habrastorage.org/files/2e3/9f0/ac0/2e39f0ac019f42459a7d599306573f5c.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diambil menggunakan KiCad</font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penjelasan untuk skema</font></font></b><div class="spoiler_text"><ul>
<li><b>R1</b> ‚Äî    ,      PC817: <nobr>(5V ‚Äî 1.2V / 0.02A) = 190Œ©</nobr>,    180Œ©.</li>
<li><b>U2</b> ‚Äî     Arduino  PC.    ,     ( USB ),    .</li>
<li><b>JP1</b> ‚Äî ,      .        .</li>
<li><b>1</b> ‚Äî ,        DTR.</li>
<li><b>MB_RST</b>, <b>MB_GND</b> ‚Äî RESET     ,    RST   (GND).    ,    .</li>
<li><b>BTN_RST</b>, <b>BTN_GND</b> ‚Äî   ,    , ,   ,   .</li>
</ul><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boot-loop (cyclic reboot) saat bekerja dengan WDT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mikrokontroler ATmega memiliki mekanisme reset WDT (TimerDog Timer) bawaan. Namun, semua upaya untuk menggunakan fungsi ini menyebabkan boot-loop, yang hanya dapat keluar dengan mematikan daya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pencarian yang tidak lama mengungkapkan bahwa bootloader dari sebagian besar klon Arduino tidak mendukung WDT. Untungnya, masalah ini telah diatasi dalam bootloader alternatif </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optiboot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mem-flash bootloader, Anda memerlukan seorang programmer yang dapat bekerja pada protokol SPI, juga diharapkan bahwa Arduino IDE mengetahui perangkat ini ‚Äúsecara langsung‚Äù. Dalam hal ini, Arduino lain ideal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita mengambil Arduino UNO, sebagai programmer, dan versi terbaru Arduino IDE v1.6.5, maka algoritmenya adalah sebagai berikut:</font></font><br>
<br>
<ol>
<li>   <b>boards-1.6.txt</b>   optiboot    <b><nobr>hardware/arduino/avr/boards.txt</nobr></b>    Arduino IDE.</li>
<li> Arduino Uno,    <b><nobr>File ‚Üí Examples ‚Üí ArduinoISP</nobr></b>.</li>
<li>    Arduino Nano  :<br>
<table>
<tbody><tr>
<th>Arduino Uno ()</th>
<th>Arduino Nano (ICSP )</th>
</tr>
<tr>
<td> <table>
<tbody><tr>
<td><b>5V</b> ‚Üí Vcc</td>
</tr>
<tr>
<td><b>GND</b> ‚Üí GND</td>
</tr>
<tr>
<td><b>D11</b> ‚Üí MOSI</td>
</tr>
<tr>
<td><b>D12</b> ‚Üí MISO</td>
</tr>
<tr>
<td><b>D13</b> ‚Üí SCK</td>
</tr>
<tr>
<td><b>D10</b> ‚Üí Reset</td>
</tr>
</tbody></table><br>
 </td>
<td> <table>
<tbody><tr>
<td><b>Pin1</b> (MISO) ‚Üê D12</td>
<td><b>Pin2</b> (Vcc) ‚Üê 5V</td>
</tr>
<tr>
<td><b>Pin3</b> (SCK) ‚Üê D13</td>
<td><b>Pin4</b> (MOSI) ‚Üê D11</td>
</tr>
<tr>
<td><b>Pin5</b> (Reset) ‚Üê D10</td>
<td><b>Pin6</b> (GND) ‚Üê GND</td>
</tr>
</tbody></table><br>
 </td>
</tr>
</tbody></table><br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><img src="https://habrastorage.org/files/868/919/4fe/8689194fe6a94d9cbd22b6ec284cc7e3.jpg"><br>
</div></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di Arduino IDE, di menu Tools, atur pengaturan seperti pada tangkapan layar:</font></font><br>
<img src="https://habrastorage.org/files/699/f29/4af/699f294af6cc48179e44c65543a758c5.png"></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilih item menu </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tools ‚Üí Burn Bootloader</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan pastikan prosesnya selesai tanpa kesalahan.</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah prosedur ini, Anda perlu mengunggah sketsa ke Arduino Nano dengan memilih pengaturan yang sama - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Papan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Optiboot pada cpus 32 pin, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prosesor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ATmega328p, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kecepatan CPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 16MHz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pematerian</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, Anda perlu menyolder semuanya, sehingga terlihat seperti satu bagian. </font></font><br>
<br>
<img src="https://habrastorage.org/files/eab/32a/27c/eab32a27cc06458faf2589287cb886e4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini saya memerlukan colokan USB karena saya memiliki motherboard mini-ITX dengan hanya satu konektor untuk sepasang USB2.0, yang diperlukan di panel depan, dan tidak ada yang terhubung ke pad USB3.0. </font><font style="vertical-align: inherit;">Jika memungkinkan, perangkat tersebut harus terhubung langsung ke motherboard sehingga kabel tidak menonjol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solder, sebagai suatu peraturan, tidak menyebabkan masalah, tetapi dalam hal ini papan tempat memotong roti digunakan, dan ini memiliki spesifikasi sendiri.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara menyolder trek di papan tempat memotong roti</font></font></b><div class="spoiler_text">      (  ,      ).             .<br>
<br>
   :<br>
<br>
<img src="https://habrastorage.org/files/847/e13/6d5/847e136d5af547abafdfcb4e40ced271.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasil: </font></font><br>
<br>
<img src="https://habrastorage.org/files/86b/5dc/95b/86b5dc95b0d142288c0a007826abcaa0.jpg"><br>
<br>
<img src="https://habrastorage.org/files/1ce/697/fa3/1ce697fa32f04962a5a9324fb365fe48.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kelihatannya beberapa kontak disolder dengan buruk, tetapi ini hanya fluks. </font><font style="vertical-align: inherit;">Konsumsi solder di papan tempat memotong roti cukup besar, jadi segala sesuatu yang mungkin ditutupi dengan fluks di sini. </font><font style="vertical-align: inherit;">Sebenarnya, ini adalah contoh yang baik tentang bagaimana Anda tidak perlu meninggalkan produk setelah menyolder. </font><font style="vertical-align: inherit;">Fluks harus dicuci, kalau tidak mungkin ada masalah dengan korosi senyawa. </font><font style="vertical-align: inherit;">Saya akan menambahkan dan pergi mencuci ... Itu lebih baik:</font></font><br>
<br>
<img src="https://habrastorage.org/files/a91/fd1/111/a91fd11110b348f2b9dcc8d9326d4f37.jpg"><br>
<br>
&nbsp;<br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian perangkat lunak</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara obyektif, kode proyek ini tidak menarik. </font><font style="vertical-align: inherit;">Kata pengantar jauh dari ekstrim, dan arsitekturnya dijelaskan dalam satu frasa: kirim perintah - tunggu jawaban. </font><font style="vertical-align: inherit;">Demi ketertiban, saya akan menjelaskan fungsi utama di sini dan secara singkat membahas poin yang paling menarik, dari sudut pandang saya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua kode diterbitkan di GitHub, jadi jika Anda terbiasa dengan Bash dan C / C ++ (dalam konteks sketsa Arduino), membaca pada titik ini dapat diselesaikan. </font><font style="vertical-align: inherit;">Jika Anda tertarik, hasil akhirnya dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koneksi anjing penjaga</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat Anda menyambungkan watchdog, file perangkat dibuat berisi nomor seri. </font><font style="vertical-align: inherit;">Jika sistem memiliki perangkat ttyUSB lainnya (dalam kasus saya, modem), maka ada masalah dengan penomoran. </font><font style="vertical-align: inherit;">Untuk mengidentifikasi perangkat secara unik, Anda perlu membuat symlink dengan nama yang unik. </font><font style="vertical-align: inherit;">Untuk ini, udev dirancang, yang mungkin sudah ada dalam sistem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, Anda perlu menemukan pengawas yang terhubung secara visual, misalnya, dengan melihat file log sistem. </font><font style="vertical-align: inherit;">Kemudian, ganti / dev / ttyUSB0 dengan perangkat yang diinginkan, tulis di terminal:</font></font><br>
<br>
<pre><code class="bash hljs">udevadm info -a -p <span class="hljs-string">"<span class="hljs-subst">$(udevadm info -q path -n /dev/ttyUSB0)</span>"</span>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh keluaran</font></font></b><div class="spoiler_text"><pre>  looking at device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0/tty/ttyUSB0':<font></font>
    KERNEL=="ttyUSB0"<font></font>
    SUBSYSTEM=="tty"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0':<font></font>
    KERNELS=="ttyUSB0"<font></font>
    SUBSYSTEMS=="usb-serial"<font></font>
    DRIVERS=="ch341-uart"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0':<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4':<font></font>
    SUBSYSTEMS=="usb"<font></font>
    DRIVERS=="usb"<font></font>
    ATTRS{idVendor}=="1a86"<font></font>
    ATTRS{idProduct}=="7523"<font></font>
    ATTRS{product}=="USB2.0-Serial"<font></font>
    ...<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, aturannya akan terlihat seperti ini: </font></font><pre><code class="hljs cs">ACTION==<span class="hljs-string">"add"</span>, KERNEL==<span class="hljs-string">"ttyUSB[0-9]*"</span>, SUBSYSTEM==<span class="hljs-string">"tty"</span>, SUBSYSTEMS==<span class="hljs-string">"usb"</span>, ATTRS{idVendor}==<span class="hljs-string">"1a86"</span>, ATTRS{idProduct}==<span class="hljs-string">"7523"</span>, SYMLINK+=<span class="hljs-string">"ttyrst-watchdog"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda harus meletakkannya di file terpisah di direktori </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/udev/rules.d</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , misalnya </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">51-ttyrst-watchdog.rules</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan beri tahu udev untuk memuat ulang aturan:</font></font><pre><code class="bash hljs">udevadm control --reload-rules</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mulai saat ini, saat menghubungkan watchdog, link </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / ttyrst-</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> watchdog akan dibuat </font><font style="vertical-align: inherit;">pada perangkat yang diinginkan, yang akan digunakan nanti.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skrip Bash (ttyrst-watchdog.sh)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komunikasi dengan pengawas dilakukan pada kecepatan 9600 baud. </font><font style="vertical-align: inherit;">Arduino bekerja tanpa masalah dengan terminal dengan kecepatan tinggi, tetapi perintah untuk bekerja dengan teks (cat, echo, dll.) Hanya menerima dan mengirim sampah. </font><font style="vertical-align: inherit;">Mungkin saja ini hanya fitur salinan Arduino Nano saya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk siklus restart timer utama dan untuk fungsi baris perintah, satu skrip digunakan. </font><font style="vertical-align: inherit;">Alasannya adalah bahwa kedua komponen menggunakan sumber daya umum - file perangkat, dan perlu untuk menyediakan akses sinkron ke sana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinkronisasi pada dasarnya terdiri dari satu lingkaran tunggu:</font></font><pre><code class="bash hljs"><span class="hljs-keyword">while</span> fuser <span class="hljs-variable">${DEVICE}</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">do</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">done</span></code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan tangkap perangkat untuk waktu yang diperlukan: </font></font><pre><code class="bash hljs">cat &lt;<span class="hljs-variable">${DEVICE}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jelas, skema semacam itu tunduk pada kondisi balapan. Anda dapat menangani hal ini dengan cara dewasa (misalnya, untuk mengatur antrian pesan), tetapi dalam hal ini, cukup untuk mengatur batas waktu dengan benar untuk menjamin hasil dalam waktu yang dapat diterima. Bahkan, seluruh skrip bekerja dengan batas waktu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demonisasi (berjalan di latar belakang) dilakukan dengan menggunakan paket OpenRC. Diasumsikan bahwa skrip ini ada di file </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/ttyrst-watchdog.sh</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan skrip OpenRC ada di </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/ttyrst-watchdog</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika daemon berhenti, penonaktifan pengawas yang benar diperlukan. Untuk melakukan ini, skrip mengatur penangan sinyal yang membutuhkan penyelesaian:</font></font><pre><code class="bash hljs"><span class="hljs-built_in">trap</span> deactivate SIGINT SIGTERM</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan di sini muncul masalah - OpenRC tidak dapat menghentikan daemon, atau lebih tepatnya, tetapi tidak sering. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faktanya adalah bahwa perintah kill mengirim sinyal ke skrip, dan program sleep, yang digunakan untuk menjeda skrip, dieksekusi dalam proses lain dan tidak menerima sinyal. Akibatnya, fungsi nonaktifkan diluncurkan hanya setelah tidur selesai, yang terlalu lama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusinya adalah mulai tidur di latar belakang dan menunggu proses untuk menyelesaikan dalam skrip:</font></font><pre><code class="bash hljs">sleep <span class="hljs-variable">${SLEEP_TIME}</span> &amp; <span class="hljs-built_in">wait</span> $!  <span class="hljs-comment">#  $!  ID   </span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konstanta dasar: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_ACTIVE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - YA atau TIDAK, masing-masing, mengirim sinyal untuk memulai kembali ketika timer dipicu atau tidak. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_TIMER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - waktu dalam detik untuk mana timer diatur. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SLEEP_TIME</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - waktu dalam detik setelah mana timer harus dihidupkan ulang. Seharusnya lebih kecil dari WATCHDOG_TIMER, tetapi tidak terlalu kecil, sehingga tidak membuat beban berlebihan pada sistem dan perangkat. Pada batas waktu saat ini, minimum yang masuk akal adalah sekitar 5 detik. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_LOG_LINES</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - jumlah entri log perangkat terbaru yang dikembalikan oleh perintah log default. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perintah Skrip: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mulai</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- mulai dari siklus restart timer utama. </font><font style="vertical-align: inherit;">Anda dapat menambahkan kode verifikasi tambahan ke fungsi is_alive, misalnya, untuk memeriksa kemungkinan menghubungkan melalui ssh. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - menampilkan status perangkat. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - mengatur ulang EEPROM (data log) dan me-reboot perangkat untuk mengembalikan anjing penjaga ke keadaan semula. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log &lt;jumlah entri&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - menampilkan jumlah tertentu dari entri log terbaru.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sketsa Arduino (ttyrst-watchdog.ino)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk berhasil menyusun sketsa, Anda memerlukan perpustakaan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">waktu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pihak ketiga </font><font style="vertical-align: inherit;">, yang diperlukan untuk sinkronisasi waktu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sketsa terdiri dari dua file. Ini disebabkan oleh fakta bahwa IDE Arduino tidak menerima struktur (struct) yang dinyatakan dalam file utama, mereka harus dipindahkan ke file header eksternal. Selain itu, kata kunci typedef tidak diperlukan untuk mendeklarasikan struktur, bahkan mungkin berbahaya ... setelah memeriksa opsi standar, saya tidak dapat menemukan sintaksis yang sesuai. Sisanya kurang lebih standar C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsi wdt_enable dan wdt_reset bekerja dengan pengawas yang terintegrasi dalam mikrokontroler. Setelah menginisialisasi WDT, hal utama yang harus diingat adalah mengatur ulang di loop utama dan di dalam loop semua operasi yang panjang.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entri log ditulis ke memori EEPROM non-volatil, ukuran yang tersedia dapat ditentukan dalam logrecord.h, dalam hal ini 1024. Log dibuat dalam bentuk cincin, pemisah adalah struktur dengan nilai nol. </font><font style="vertical-align: inherit;">Jumlah entri maksimum untuk 1 KiB EEPROM adalah 203. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catatan tentang memuat perangkat sampai ke log hanya setelah sinkronisasi waktu. </font><font style="vertical-align: inherit;">Sinkronisasi dilakukan pada saat yang sama dengan timer dihidupkan ulang dan sebelum perintah apa pun dijalankan selama inisialisasi perangkat. </font><font style="vertical-align: inherit;">Kalau tidak, tidak mungkin membandingkan waktu yang tepat dengan kejadian ini, dan informasi tentang reboot perangkat, terpisah dari daemon yang berfungsi, tidak terlalu menarik. </font></font><br>
<br>
<img src="https://habrastorage.org/files/11c/823/d3e/11c823d3eac445b6b543cec6ca061a95.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu saja, terima kasih sudah menonton! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File sumber proyek terletak di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id384467/">https://habr.com/ru/post/id384467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id384457/index.html">Pekerjaan modul Master Wi-Fi di sistem kontrol otomatisasi rumah OpenHAB. Bagian 2: Sambungkan termostat MP3502</a></li>
<li><a href="../id384459/index.html">Bug di mesin Google Chrome dengan setetes 16 karakter sudah digunakan untuk membuat game</a></li>
<li><a href="../id384461/index.html">Otak. Memori holografik. Biologi komputasi kuantum</a></li>
<li><a href="../id384463/index.html">Perhatian! Kontes Aksesoris Dicetak 3D untuk Apple iPhone 6s</a></li>
<li><a href="../id384465/index.html">Quadcopters membangun jembatan tali</a></li>
<li><a href="../id384471/index.html">Robot konstruksi Hadrian dapat berjalan 20 kali lebih cepat dari manusia</a></li>
<li><a href="../id384473/index.html">Berbicara tentang teater rumah</a></li>
<li><a href="../id384475/index.html">Ulasan ini bukan gadget. Memilih wadah pelatihan terbaik dan aksesori lainnya untuk telepon pintar: Pembalut Adidas, tas, dan kantong silikon</a></li>
<li><a href="../id384477/index.html">NASA akan menguji teknologi pengembangan asteroid menggunakan sinar matahari</a></li>
<li><a href="../id384479/index.html">Pengembangan game pada Pengolahan dengan kontrol melalui papan Arduino Uno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>