<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚫️ 🕋 👨🏾‍🚀 Iniciador para trabajar con Spring Cloud 🎉 🏯 👏🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! 


 En este artículo, demostraré los componentes básicos para crear servicios de mezcladores RESTful reactivos usando Spring WebFlux, Sp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Iniciador para trabajar con Spring Cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434810/"><p>  Hola a todos! </p><br><p>  En este artículo, demostraré los componentes básicos para crear servicios de mezcladores RESTful reactivos usando Spring WebFlux, Spring Security, Spring Cloud Netflix Eureka (Service Discovery), Hystrix (Circuit Breaker), Ribbon (Client Side Load Balancer), Configuración externa (a través del repositorio git) , Spring Cloud Sleuth, Spring Cloud Gateway, Spring Boot Reactive MongoDB.  Además de Spring Boot Admin y Zipkin para el monitoreo. </p><a name="habracut"></a><br><p> Esta revisión se realizó después de estudiar los libros Spring Microservices in Action y Hands-On Spring 5 Security for Reactive Applications. </p><br><p>  En este artículo, crearemos una aplicación primaria con tres consultas: obtener una lista de juegos, obtener una lista de jugadores, crear un juego desde la identificación de los jugadores, una solicitud para verificar el retroceso (Hystrix fallback) en caso de una larga espera para obtener una respuesta.  Y la implementación de la autenticación a través del token JWT basado en el libro Hands-On Spring 5 Security para aplicaciones reactivas. </p><br><p>  No describiré cómo se crea cada aplicación en el IDE, ya que este artículo está destinado a un usuario experimentado. </p><br><h1 id="struktura-proekta">  Estructura del proyecto </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/157/13f/e68/15713fe681fb005e4b94a75bae127f40.png" alt="Texto alternativo"></p><br><p> El proyecto consta de dos módulos.  El módulo de <code>spring-servers</code> se puede copiar de forma segura de un proyecto a otro.  Casi no hay código y configuraciones.  El <code>tictactoe-services</code> contiene los módulos y microservicios de nuestra aplicación.  Notaré de inmediato que al agregar <code>auth-module</code> <code>domain-module</code> a los servicios, infringe uno de los principios de la arquitectura de microservicios sobre la autonomía de los microservicios.  Pero en la etapa de desarrollo de estos módulos, creo que esta es la solución más óptima. </p><br><h1 id="konfiguraciya-gradle">  Configuración de Gradle </h1><br><p>  Me gusta cuando toda la configuración de Gradle está en un archivo, así que configuré todo el proyecto en un <code>build.gradle</code> . </p><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="java hljs">buildscript { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'2.1.1.RELEASE'</span></span> gradleDockerVersion = <span class="hljs-string"><span class="hljs-string">'0.20.1'</span></span> } repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span> } } dependencies { classpath(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"gradle.plugin.com.palantir.gradle.docker:gradle-docker:${gradleDockerVersion}"</span></span>) } } allprojects { group = <span class="hljs-string"><span class="hljs-string">'com.tictactoe'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'eclipse'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'io.spring.dependency-management'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker-run'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker-compose'</span></span> } docker.name = <span class="hljs-string"><span class="hljs-string">'com.tictactoe'</span></span> bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> sourceCompatibility = <span class="hljs-number"><span class="hljs-number">11</span></span> repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://repo.spring.io/milestone"</span></span> } } subprojects { ext[<span class="hljs-string"><span class="hljs-string">'springCloudVersion'</span></span>] = <span class="hljs-string"><span class="hljs-string">'Greenwich.M3'</span></span> sourceSets.configureEach { sourceSet -&gt; tasks.named(sourceSet.compileJavaTaskName, { options.annotationProcessorGeneratedSourcesDirectory = file(<span class="hljs-string"><span class="hljs-string">"$buildDir/generated/sources/annotationProcessor/java/${sourceSet.name}"</span></span>) }) } repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://repo.spring.io/milestone"</span></span> } } dependencyManagement { imports { mavenBom <span class="hljs-string"><span class="hljs-string">"org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"</span></span> } } dependencies { <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(include: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'*.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'org.projectlombok:lombok'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">annotationProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'org.projectlombok:lombok'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> } } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">':spring-servers'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> task cleanAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'clean'</span></span>) } task buildAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'build'</span></span>) } dockerCompose { template <span class="hljs-string"><span class="hljs-string">'docker-compose.spring-servers.template.yml'</span></span> dockerComposeFile <span class="hljs-string"><span class="hljs-string">'docker-compose.spring-servers.yml'</span></span> } } project(<span class="hljs-string"><span class="hljs-string">':tictactoe-services'</span></span>) { bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> task cleanAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'clean'</span></span>) } task buildAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'build'</span></span>) } } <span class="hljs-comment"><span class="hljs-comment">// Tictactoe Modules project(':tictactoe-services:domain-module') { bootJar.enabled = false jar { enabled = true group 'com.tictactoe' baseName = 'domain-module' version = '1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-validation') implementation('com.fasterxml.jackson.core:jackson-annotations:2.9.3') implementation 'com.intellij:annotations:+@jar' compileOnly('org.projectlombok:lombok') testCompile group: 'junit', name: 'junit', version: '4.12' } } project(':tictactoe-services:auth-module') { bootJar.enabled = false jar { enabled = true baseName = 'auth-module' version = '1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.security:spring-security-oauth2-core') implementation('org.springframework.security:spring-security-oauth2-jose') implementation 'com.intellij:annotations:+@jar' testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('io.projectreactor:reactor-test') testImplementation('org.springframework.security:spring-security-test') } } project(':tictactoe-services:user-service') { bootJar { launchScript() baseName = 'user-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } project(':tictactoe-services:game-service') { bootJar { launchScript() baseName = 'game-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } project(':tictactoe-services:webapi-service') { bootJar { launchScript() baseName = 'webapi-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } // Spring Servers project(':spring-servers:discovery-server') { bootJar { launchScript() baseName = 'discovery-server' version = '0.1.0' } dependencies { implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-server') implementation('org.springframework.boot:spring-boot-starter-security') compile('javax.xml.bind:jaxb-api:2.3.0') compile('javax.activation:activation:1.1') compile('org.glassfish.jaxb:jaxb-runtime:2.3.0') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:config-server') { bootJar { launchScript() baseName = 'config-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.cloud:spring-cloud-config-server') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:gateway-server') { bootJar { launchScript() baseName = 'gateway-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-actuator') implementation('org.springframework.cloud:spring-cloud-starter-gateway') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:admin-server') { ext['springBootAdminVersion'] = '2.1.1' bootJar { launchScript() baseName = 'admin-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-web') implementation('org.springframework.boot:spring-boot-starter-security') implementation('de.codecentric:spring-boot-admin-starter-server') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('org.springframework.security:spring-security-test') } dependencyManagement { imports { mavenBom "de.codecentric:spring-boot-admin-dependencies:${springBootAdminVersion}" } } } subprojects { subproject -&gt; if (file("${subproject.projectDir}/docker/Dockerfile").exists()) { docker { // workingbit - replace with your dockerhub's username name "workingbit/${subproject.group}.${subproject.bootJar.baseName}" tags 'latest' dockerfile file("${subproject.projectDir}/docker/Dockerfile") files tasks.bootJar.archivePath, 'docker/run.sh' buildArgs "JAR_FILE": "${subproject.bootJar.baseName}-${subproject.bootJar.version}.jar", "RUN_SH": "run.sh" } } else { docker.name = 'noop' } if (subproject.name.endsWith('service')) { dependencies { implementation('org.springframework.boot:spring-boot-starter-actuator') implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.security:spring-security-oauth2-core') implementation('org.springframework.security:spring-security-oauth2-jose') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') implementation('org.springframework.cloud:spring-cloud-starter-netflix-hystrix') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.cloud:spring-cloud-starter-sleuth') implementation('org.springframework.cloud:spring-cloud-starter-zipkin') implementation('org.springframework.security:spring-security-rsa') implementation('com.intellij:annotations:+@jar') implementation('org.apache.commons:commons-lang3:3.8.1') runtimeOnly('org.springframework.boot:spring-boot-devtools') testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('de.flapdoodle.embed:de.flapdoodle.embed.mongo') testImplementation('io.projectreactor:reactor-test') } } }</span></span></code> </pre> </div></div><br><p>  El uso de un archivo de configuración común le permite hacer que las dependencias sean comunes a los microservicios, en este caso los servicios con un nombre que termina en "servicio", en un solo lugar.  PERO, esto viola nuevamente el principio de autonomía de los microservicios.  Además de las dependencias comunes, puede agregar tareas a subproyectos.  <code>gradle.plugin.com.palantir.gradle.docker:gradle-docker</code> tareas del complemento <code>gradle.plugin.com.palantir.gradle.docker:gradle-docker</code> para trabajar con <code>Docker</code> . </p><br><h1 id="modul-auth-module">  Módulo de autenticación </h1><br><p>  Ahora, considere el módulo de autenticación JWT.  Se puede encontrar una descripción del paquete de <code>auth</code> de este módulo en el libro de autenticación reactiva que mencioné anteriormente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/777/df9/da5/777df9da5df30a97673493012008377c.png" alt="Texto alternativo"></p><br><p>  Ah, detengámonos en el paquete de <code>config</code> con más detalle. </p><br><h1 id="klass-slozhnyh-svoystv-applicationclientspropertiesjava">  La clase de propiedades "complejas" ApplicationClientsProperties.java </h1><br><pre> <code class="plaintext hljs">@Data @Component @ConfigurationProperties("appclients") public class ApplicationClientsProperties { private List&lt;ApplicationClient&gt; clients = new ArrayList&lt;&gt;(); @Data public static class ApplicationClient { private String username; private String password; private String[] roles; } }</code> </pre> <br><p>  Esta clase contiene propiedades "complejas" para la configuración de la base de datos inMemory. </p><br><h1 id="klass-konfiguracii-modulya-authmoduleconfigjava">  Clase de configuración del módulo AuthModuleConfig.java </h1><br><pre> <code class="plaintext hljs">@Data @Configuration @PropertySource("classpath:moduleConfig.yml") public class AuthModuleConfig { @Value("${tokenExpirationMinutes:60}") private Integer tokenExpirationMinutes; @Value("${tokenIssuer:workingbit-example.com}") private String tokenIssuer; @Value("${tokenSecret:secret}") // length minimum 256 bites private String tokenSecret; }</code> </pre> <br><p>  En el archivo de recursos, debe especificar estas variables.  En mi configuración, el token se apaga después de 10 horas. </p><br><h1 id="klass-konfiguracii-matcherov-filtrov-microserviceservicejwtauthwebfilterjava">  MicroserviceServiceJwtAuthWebFilter.java Clase de configuración de filtros de matchers </h1><br><pre> <code class="plaintext hljs">public class MicroserviceServiceJwtAuthWebFilter extends JwtAuthWebFilter { private final String[] matchersStrings; public MicroserviceServiceJwtAuthWebFilter(JwtService jwtService, String[] matchersStrings) { super(jwtService); this.matchersStrings = matchersStrings; } @Override protected ServerWebExchangeMatcher getAuthMatcher() { List&lt;ServerWebExchangeMatcher&gt; matchers = Arrays.stream(this.matchersStrings) .map(PathPatternParserServerWebExchangeMatcher::new) .collect(Collectors.toList()); return ServerWebExchangeMatchers.matchers(new OrServerWebExchangeMatcher(matchers)); } }</code> </pre> <br><p>  Durante la construcción, este filtro pasa el servicio para trabajar con JWT y una lista de rutas que procesará este filtro. </p><br><h1 id="klass-konfiguracii-reactive-spring-boot-security-microservicespringsecuritywebfluxconfigjava">  Clase de configuración Reactive Spring Boot Security MicroserviceSpringSecurityWebFluxConfig.java </h1><br><pre> <code class="plaintext hljs">@ConditionalOnProperty(value = "microservice", havingValue = "true") @EnableReactiveMethodSecurity @PropertySource(value = "classpath:/application.properties") public class MicroserviceSpringSecurityWebFluxConfig { @Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls; /** * Bean which configures whiteListed and JWT filter urls * Also it configures authentication for Actuator. Actuator takes configured AuthenticationManager automatically * which uses MapReactiveUserDetailsService to configure inMemory users */ @Bean public SecurityWebFilterChain springSecurityFilterChain( ServerHttpSecurity http, JwtService jwtService ) { MicroserviceServiceJwtAuthWebFilter userServiceJwtAuthWebFilter = new MicroserviceServiceJwtAuthWebFilter(jwtService, jwtTokenMatchUrls); http.csrf().disable(); http .authorizeExchange() .pathMatchers(whiteListedAuthUrls) .permitAll() .and() .authorizeExchange() .pathMatchers("/actuator/**").hasRole("SYSTEM") .and() .httpBasic() .and() .addFilterAt(userServiceJwtAuthWebFilter, SecurityWebFiltersOrder.AUTHENTICATION); return http.build(); } }</code> </pre> <br><p>  Aquí hay tres anotaciones interesantes. </p><br><pre> <code class="plaintext hljs">@ConditionalOnProperty(value = "microservice", havingValue = "true")</code> </pre> <br><p>  Una anotación que conecta este módulo en función de la variable de microservicio en el archivo de configuración que se especifica en la anotación.  Esto es necesario para deshabilitar la comprobación general de tokens en algunos módulos.  En esta aplicación, este es el <code>webapi-service</code> , que tiene su propia implementación del bean <code>SecurityWebFilterChain</code> . </p><br><pre> <code class="plaintext hljs">@PropertySource(value = "classpath:/application.properties")</code> </pre> <br><p>  Esta anotación también le permite tomar propiedades del servicio principal al que se importa este módulo.  En otras palabras, variables </p><br><pre> <code class="plaintext hljs">@Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls;</code> </pre> <br><p>  Tome sus valores de la configuración de microservicio del descendiente. </p><br><p>  Y, una anotación que le permite adjuntar anotaciones de seguridad como <code>@PreAuthorize(“hasRole('MY_ROLE')”)</code> </p><br><pre> <code class="plaintext hljs">@EnableReactiveMethodSecurity</code> </pre> <br><p>  Y en este módulo, se crea el bean <code>SecurityWebFilterChain</code> , que configura el acceso al actuador, la url permitida y la url en la que se comprueba el token JWT.  Cabe señalar que el acceso al filtro de token JWT debe estar abierto. </p><br><h1 id="konfiguraciya-springwebfluxconfigjava">  Configuración SpringWebFluxConfig.java </h1><br><p>  En esta configuración, los <code>MapReactiveUserDetailsService</code> se crean para configurar el actuador y otros usuarios del sistema en la memoria. </p><br><pre> <code class="plaintext hljs">@Bean @Primary public MapReactiveUserDetailsService userDetailsRepositoryInMemory() { List&lt;UserDetails&gt; users = applicationClients.getClients() .stream() .map(applicationClient -&gt; User.builder() .username(applicationClient.getUsername()) .password(passwordEncoder().encode(applicationClient.getPassword())) .roles(applicationClient.getRoles()).build()) .collect(toList()); return new MapReactiveUserDetailsService(users); }</code> </pre> <br><p>  El <code>ReactiveUserDetailsService</code> que es necesario para unir nuestro repositorio de usuarios con <code>Spring Security</code> . </p><br><pre> <code class="plaintext hljs">@Bean public ReactiveUserDetailsService userDetailsRepository(UserRepository users) { return (email) -&gt; users.findByEmail(email).cast(UserDetails.class); }</code> </pre> <br><p>  Un bean para crear un cliente <code>WebClient</code> para realizar solicitudes reactivas. </p><br><pre> <code class="plaintext hljs">@Bean public WebClient loadBalancedWebClientBuilder(JwtService jwtService) { return WebClient.builder() .filter(lbFunction) .filter(authorizationFilter(jwtService)) .build(); } private ExchangeFilterFunction authorizationFilter(JwtService jwtService) { return ExchangeFilterFunction .ofRequestProcessor(clientRequest -&gt; ReactiveSecurityContextHolder.getContext() .map(securityContext -&gt; ClientRequest.from(clientRequest) .header(HttpHeaders.AUTHORIZATION, jwtService.getHttpAuthHeaderValue(securityContext.getAuthentication())) .build())); }</code> </pre> <br><p>  Durante la creación, se agregan dos filtros.  <code>LoadBalancer</code> y el filtro que toma la instancia de <code>Authentication</code> del contexto <code>ReactiveSecurityContext</code> y crea un token a partir de él para que el servidor de destino autentique el filtro y lo autorice en consecuencia. </p><br><p>  Y para la conveniencia de trabajar con el tipo y las fechas de <code>ObjectId</code> MongoDB, agregué un bin de creación de objectMapper: </p><br><pre> <code class="plaintext hljs">@Bean @Primary ObjectMapper objectMapper() { Jackson2ObjectMapperBuilder builder = new Jackson2ObjectMapperBuilder(); builder.serializerByType(ObjectId.class, new ToStringSerializer()); builder.deserializerByType(ObjectId.class, new JsonDeserializer() { @Override public Object deserialize(JsonParser p, DeserializationContext ctxt) throws IOException { Map oid = p.readValueAs(Map.class); return new ObjectId( (Integer) oid.get("timestamp"), (Integer) oid.get("machineIdentifier"), ((Integer) oid.get("processIdentifier")).shortValue(), (Integer) oid.get("counter")); } }); builder.featuresToDisable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); return builder.build(); }</code> </pre> <br><h1 id="mikroservis-game-service">  Servicio de juegos de microservicio </h1><br><p>  El servicio de juegos de microservicios tiene la siguiente estructura: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4d8/c3c/e15/4d8c3ce15b22736bff0eda748f2a215e.png" alt="Texto alternativo"></p><br><p>  Como puede ver en él, solo un archivo de configuración de ApplicationConfig </p><br><h1 id="konfigurator-applicationconfigjava">  Configurador ApplicationConfig.java </h1><br><pre> <code class="plaintext hljs">@Data @Configuration @EnableReactiveMongoRepositories("com.tictactoe.gameservice.repository") @Import({ApplicationClientsProperties.class, SpringWebFluxConfig.class, MicroserviceSpringSecurityWebFluxConfig.class}) public class ApplicationConfig { @Value("${userserviceUrl}") private String userServiceUrl; }</code> </pre> <br><p>  Contiene una variable con la dirección del <code>user-service</code> al <code>user-service</code> y hay dos anotaciones interesantes: </p><br><pre> <code class="plaintext hljs">@EnableReactiveMongoRepositories("com.tictactoe.gameservice.repository")</code> </pre> <br><p>  Esta anotación es necesaria para indicar el repositorio de MongoDB al configurador. </p><br><pre> <code class="plaintext hljs">@Import({ApplicationClientsProperties.class, SpringWebFluxConfig.class, MicroserviceSpringSecurityWebFluxConfig.class})</code> </pre> <br><p>  Esta anotación importa las configuraciones del <code>auth-module</code> . </p><br><h1 id="servis-gameservicejava">  Servicio GameService.java </h1><br><p>  Este servicio solo tiene el siguiente código interesante: </p><br><pre> <code class="plaintext hljs">@HystrixCommand public Flux&lt;Game&gt; getAllGames() { return gameRepository.findAll(); } @HystrixCommand(fallbackMethod = "buildFallbackAllGames", threadPoolKey = "licenseByOrgThreadPool", threadPoolProperties = {@HystrixProperty(name = "coreSize", value = "30"), @HystrixProperty(name = "maxQueueSize", value = "10")}, commandProperties = { @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"), @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "75"), @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "7000"), @HystrixProperty(name = "metrics.rollingStats.timeInMilliseconds", value = "15000"), @HystrixProperty(name = "metrics.rollingStats.numBuckets", value = "5")} ) public Flux&lt;Game&gt; getAllGamesLong() { // logger.debug("LicenseService.getLicensesByOrg Correlation id: {}", UserContextHolder.getContext().getCorrelationId()); randomlyRunLong(); return gameRepository.findAll(); }</code> </pre> <br><p>  Este método arroja una excepción al azar y Hystrix de acuerdo con la anotación devuelve el resultado del siguiente método: </p><br><pre> <code class="plaintext hljs">private Flux&lt;Game&gt; buildFallbackAllGames() { User fakeUserBlack = new User("fakeUserBlack", "password", Collections.emptyList()); User fakeUserWhite = new User("fakeUserBlack", "password", Collections.emptyList()); Game game = new Game(fakeUserBlack, fakeUserWhite); List&lt;Game&gt; games = List.of(game); return Flux.fromIterable(games); }</code> </pre> <br><p>  Como se indica en el libro mencionado anteriormente, si algo está roto, entonces vamos a mostrar los datos en caché o alternativos mejor que nada. </p><br><h1 id="mikroservis-webapi-service">  Servicio de microservicio webapi </h1><br><p>  Este es un tipo de middleware entre el Gateway y los microservicios internos que no son visibles desde el exterior.  El propósito de este servicio es obtener una selección de otros servicios y formar una respuesta al usuario sobre la base. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/35c/a1f/773/35ca1f77332fc0a78566650549a9b625.png" alt="Texto alternativo"></p><br><p>  Comenzamos la revisión con la configuración. </p><br><h1 id="konfiguraciya-springsecuritywebfluxconfigjava">  Configuración de SpringSecurityWebFluxConfig.java </h1><br><pre> <code class="plaintext hljs">@Configuration @EnableReactiveMethodSecurity public class SpringSecurityWebFluxConfig { private static final String AUTH_TOKEN_PATH = "/auth/token"; @Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls; @Bean @Primary public SecurityWebFilterChain systemSecurityFilterChain( ServerHttpSecurity http, JwtService jwtService, @Qualifier("userDetailsRepository") ReactiveUserDetailsService userDetailsService ) {</code> </pre> <br><p>  Aquí creamos un administrador de autenticación a partir de los servicios <code>userDetailsService</code> , que definimos anteriormente en el <code>auth-module</code> . </p><br><pre> <code class="plaintext hljs"> UserDetailsRepositoryReactiveAuthenticationManager authenticationManager = new UserDetailsRepositoryReactiveAuthenticationManager(userDetailsService);</code> </pre> <br><p>  Y creamos un filtro con este administrador, y también agregamos un convertidor de instancia de autenticación para obtener los datos del usuario codificados en <code>x-www-form-urlencoded</code> . </p><br><pre> <code class="plaintext hljs"> AuthenticationWebFilter tokenWebFilter = new AuthenticationWebFilter(authenticationManager); tokenWebFilter.setServerAuthenticationConverter(exchange -&gt; Mono.justOrEmpty(exchange) .filter(ex -&gt; AUTH_TOKEN_PATH.equalsIgnoreCase(ex.getRequest().getPath().value())) .flatMap(ServerWebExchange::getFormData) .filter(formData -&gt; !formData.isEmpty()) .map((formData) -&gt; { String email = formData.getFirst("email"); String password = formData.getFirst("password"); return new UsernamePasswordAuthenticationToken(email, password); }) );</code> </pre> <br><p>  Agregamos un controlador de autorización exitoso, cuya esencia es colocar el token JWT en el encabezado de solicitud generado a partir de <code>Authentication</code> para que la autenticación solo se pueda hacer usando un token de invitado válido. </p><br><pre> <code class="plaintext hljs"> tokenWebFilter.setAuthenticationSuccessHandler(new JwtAuthSuccessHandler(jwtService)); MicroserviceServiceJwtAuthWebFilter webApiJwtServiceWebFilter = new MicroserviceServiceJwtAuthWebFilter(jwtService, jwtTokenMatchUrls); http.csrf().disable(); http .authorizeExchange()</code> </pre> <br><p>  Resolvemos direcciones de la lista blanca.  Como escribí anteriormente, las direcciones que serán procesadas por el filtro JWT también deben abrirse </p><br><pre> <code class="plaintext hljs"> .pathMatchers(whiteListedAuthUrls) .permitAll() .and() .authorizeExchange()</code> </pre> <br><p>  Protegemos el actuador y algunas direcciones con autenticación básica. </p><br><pre> <code class="plaintext hljs"> .pathMatchers("/actuator/**").hasRole("SYSTEM") .pathMatchers(HttpMethod.GET, "/url-protected/**").hasRole("GUEST") .pathMatchers(HttpMethod.POST, "/url-protected/**").hasRole("USER") .and() .httpBasic() .and() .authorizeExchange()</code> </pre> <br><p>  Hacer que el acceso al token de autenticación sea obligatorio </p><br><pre> <code class="plaintext hljs"> .pathMatchers(AUTH_TOKEN_PATH).authenticated() .and()</code> </pre> <br><p>  Agregar filtros  Para autenticar y verificar el token JWT. </p><br><pre> <code class="plaintext hljs"> .addFilterAt(webApiJwtServiceWebFilter, SecurityWebFiltersOrder.AUTHENTICATION) .addFilterAt(tokenWebFilter, SecurityWebFiltersOrder.AUTHENTICATION); return http.build(); }</code> </pre> <br><p>  Y como escribí anteriormente, este servicio deshabilita la verificación de token JWT, común para otros servicios, al especificar el valor de la variable <code>micoservice=false</code> en el archivo <code>application.properites</code> . </p><br><h1 id="kontroller-vydachi-tokenov-registracii-i-avtorizacii-authcontrollerjava">  Controlador de emisión, registro y autorización de tokens AuthController.java </h1><br><p>  No describiré este controlador, ya que es puramente específico. </p><br><h1 id="servis-webapiservicejava">  Servicio WebApiService.java </h1><br><p>  Este servicio se llama en el controlador <code>WebApiMethodProtectedController.jav</code> y tiene una anotación interesante: </p><br><pre> <code class="plaintext hljs">@PreAuthorize("hasRole('GUEST')") public Flux&lt;User&gt; getAllUsers() { }</code> </pre> <br><p>  Esta anotación permite el acceso a métodos solo a usuarios autorizados con el rol de invitado. </p><br><h1 id="kak-testirovat">  Cómo probar </h1><br><p>  Crea un entorno: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c5e/88b/2c9/c5e88b2c9aa336ef901f6bef678b94e5.png" alt="Texto alternativo"></p><br><p>  Obtener token </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/02f/19f/a7a/02f19fa7a858e41b9db8ca658f3e66d4.png" alt="Texto alternativo"></p><br><p>  Actualice la variable TOKEN en el entorno con el token recibido. </p><br><p>  Registrar un nuevo usuario </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d78/f70/77b/d78f7077b7e224ff394def349446a322.png" alt="Texto alternativo"></p><br><p>  Después del registro, recibirá un token de usuario.  Caduca en 10 horas.  Cuando caduque, debe obtener uno nuevo.  Para hacer esto, solicite nuevamente el token de invitado, actualice el entorno y ejecute la solicitud </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e68/b1f/e2d/e68b1fe2da20635e8cdd7eabfcd1a420.png" alt="Texto alternativo"></p><br><p>  A continuación, puede obtener una lista de usuarios, juegos o crear un nuevo juego.  Y también pruebe Hystrix, vea las configuraciones del servicio y cifre las variables para el repositorio git. </p><br><h1 id="ssylki">  Referencias </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Repositorio de GitHub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Repositorio de configuración</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Microservicios de primavera en acción</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Seguridad práctica Spring 5 para aplicaciones reactivas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El código para el libro Spring Microservices in Action</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El código para el libro Hands-On Spring 5 Security for Reactive Applications</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434810/">https://habr.com/ru/post/es434810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434798/index.html">Swagger: documentación inteligente para su API web RESTful: revisión del desarrollador back-end junior para novatos</a></li>
<li><a href="../es434800/index.html">(5-2) Formas de migrar una tabla SQL grande</a></li>
<li><a href="../es434802/index.html">"No daré una piedra" o cómo se organizan los recursos del juego "Tierras malditas"</a></li>
<li><a href="../es434804/index.html">Fintech-startup Robinhood no pudo lanzar un análogo de cuentas bancarias</a></li>
<li><a href="../es434806/index.html">Año nuevo desmontaje con canoa</a></li>
<li><a href="../es434812/index.html">Gestión del tiempo del proyecto</a></li>
<li><a href="../es434816/index.html">Detox y Appium: Prueba de interfaz automatizada en React Native</a></li>
<li><a href="../es434818/index.html">Un accidente en el centro de datos de CenturyLink causó interrupciones del servicio del 911</a></li>
<li><a href="../es434822/index.html">Programa PRC "Autos con nuevas fuentes de energía". Que esperar en 2019</a></li>
<li><a href="../es434824/index.html">Ingeniería Político-Eléctrica. Modelado de procesos sociopolíticos por circuitos eléctricos.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>