<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛤️ 🥧 🤜🏿 在GraalVM上开发实用程序 🙆🏻 👩🏿‍✈️ 🚦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="问题陈述 


我定期执行一项任务，例如与项目同事共享本地网络上的文件。 


 可以有很多解决方案-Samba / FTP / scp。 您只需将文件上传到Google云端硬盘等公共场所，将其附加到Jira中的任务上，甚至通过电子邮件发送即可。 


 但是所有这一切在某种程度上都是不灵活的，需要...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在GraalVM上开发实用程序</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451574/"><h2 id="postanovka-zadachi"> 问题陈述 </h2><br><p>我定期执行一项任务，例如与项目同事共享本地网络上的文件。 </p><br><p> 可以有很多解决方案-Samba / FTP / scp。 您只需将文件上传到Google云端硬盘等公共场所，将其附加到Jira中的任务上，甚至通过电子邮件发送即可。 </p><br><p> 但是所有这一切在某种程度上都是不灵活的，需要进行初步调整并且有其自身的局限性（例如，最大投资规模）。 </p><br><p> 您想要更轻便，更灵活的产品。 </p><br><p>  Linux总是有机会使用可用的方法快速构建实用的解决方案，这使我始终感到惊喜。 </p><br><p> 说，我经常使用以下单行代码使用系统python解决上述任务 </p><br><pre><code class="bash hljs">$ python3 -mhttp.server Serving HTTP on 0.0.0.0 port 8000 ...</code> </pre> <br><p> 此命令将在当前文件夹中启动Web服务器，并允许您获取文件列表并通过Web界面下载它们。 这些东西更多的可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里倾销</a> 。 </p><a name="habracut"></a><br><p> 有一些不便之处。 现在，为了将下载链接传送给同事，您需要知道网络上的IP地址。 </p><br><p> 使用命令很方便 </p><br><pre> <code class="bash hljs">$ ifconfig -a</code> </pre> <br><p> 然后从结果的网络接口列表中选择适当的接口，并手动组成一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：// IP：8000</a>形式的链接，您可以发送该链接。 </p><br><p> 第二个不便之处：此服务器是单线程的。 这意味着，虽然您的一位同事下载了文件，但第二位同事甚至无法下载文件列表。 </p><br><p> 第三，它不灵活。 如果您只需要传输一个文件，它将打开整个文件夹，即 您将必须执行以下手势（然后清理垃圾）： </p><br><pre> <code class="bash hljs">$ mkdir tmp1 $ cp file.zip tmp1 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tmp1 $ python3 -mhttp.server</code> </pre> <br><p> 第四个不便之处-没有<em>简单的</em>方法可以下载文件夹的全部内容。 </p><br><p> 为了传输文件夹的内容，他们通常使用称为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tar pipe</a>的技术。 </p><br><p> 他们这样做： </p><br><pre> <code class="bash hljs">$ ssh user@host <span class="hljs-string"><span class="hljs-string">'cd /path/to/source &amp;&amp; tar cf - .'</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/destination &amp;&amp; tar xvf -</code> </pre> <br><p> 如果突然不清楚，我将解释其工作原理。  <code>tar cf - .</code>命令的第一部分<code>tar cf - .</code> 创建当前文件夹内容的存档，并写入标准输出。 此外，此输出通过安全ssh通道通过管道传输到类似的<code>tar xvf -</code>的输入<code>tar xvf -</code>该<code>tar xvf -</code>执行相反的过程，即 读取标准输入并解压缩到当前文件夹。 实际上，文件存档已传输，但未创建中间文件！ </p><br><p> 这种方法的不便之处也很明显。 我们需要从一台机器到另一台机器的ssh访问，而在一般情况下几乎从来没有这样做。 </p><br><p> 是否可以实现上述所有条件，但没有上述问题？ </p><br><p> 因此，是时候正式确定我们将要构建的内容了： </p><br><ol><li> 易于安装的程序（静态二进制） </li><li> 这将使您既可以传输文件又可以传输所有内容的文件夹 </li><li> 带有可选压缩 </li><li> 允许主机仅使用标准* nix工具（wget / curl / tar）下载文件 </li><li> 该程序将在启动后立即发出确切的命令进行下载 </li></ol><br><h2 id="reshenie"> 解决方案 </h2><br><p> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">不久前</a>我参加的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JEEConf</a>会议上， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Graal</a>主题反复提出。 这个话题不是什么新鲜事物，但是对我来说，这是一个触发，让我终于可以亲手感受到这头野兽。 </p><br><p> 对于那些尚未参与主题讨论的人（真的有这样的事情吗？OO），让我提醒您，GraalVM是Oracle提供的具有许多附加功能的JVM，其中最引人注目的是： </p><br><ol><li>  Polyglot JVM-无缝运行Java，Javascript，Python，Ruby，R等的功能。 代号 </li><li> 支持AOT编译-将Java直接编译为本地二进制文件 </li><li> 一个不太引人注目但非常酷的功能-C2编译器从C ++重写为Java，以便更方便地进行进一步的开发。 这已经产生了明显的结果。 该编译器在将Java字节码转换为本地代码的阶段进行了更多优化。 例如，它能够更有效地消除分配。 只需启用此设置，Twitter就能将CPU消耗减少11％，这在其规模上可显着节省资源（和金钱）。 </li></ol><br><p> 例如，您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此habr文章中</a>刷新Graal的想法。 </p><br><p> 我们将用Java编写，因此对我们而言，最相关的功能是AOT编译。 </p><br><p> 实际上，开发结果<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此Github存储库中给出</a> 。 </p><br><p> 传输单个文件的用法示例： </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/report.pdf'</span></span> To download the file please use one of the commands below: curl http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> curl http://192.168.0.179:17777/dl?z --compressed &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl?z | gunzip &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span></code> </pre> <br><p> 传输文件夹内容（包括附件的所有文件！）时使用的示例： </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/folder'</span></span> To download the files please use one of the commands below. NB! All files will be placed into current folder! curl http://192.168.0.179:17777/dl | tar -xvf - wget -O- http://192.168.0.179:17777/dl | tar -xvf - curl http://192.168.0.179:17777/dl?z | tar -xzvf - wget -O- http://192.168.0.179:17777/dl?z | tar -xzvf -</code> </pre> <br><p> 是的，很简单！ </p><br><p> 请注意-程序本身将确定可下载文件的正确IP地址。 </p><br><h2 id="nablyudeniya--razmyshleniya"> 意见/想法 </h2><br><p> 显然，创建程序的目标之一就是程序的紧凑性。 这是已实现的结果： </p><br><pre> <code class="bash hljs">$ du -hs `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> serv` 2.4M /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/serv</code> </pre> <br><p> 令人难以置信的是，整个JVM以及应用程序代码可容纳几兆字节！ 当然，一切都有些错误，但稍后会更多。 </p><br><p> 实际上，Graal编译器生成的二进制文件的大小略大于7兆字节。 我决定<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">用UPX</a>进一步<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">压缩它</a> 。 </p><br><p> 事实证明，这是一个好主意，因为启动时间增加了，但时间却微不足道： </p><br><p> 未压缩的选项： </p><br><pre> <code class="bash hljs">$ time ./build/com.cmlteam.serv.serv -v 0.1 real 0m0.001s user 0m0.001s sys 0m0.000s</code> </pre> <br><p> 压缩后： </p><br><pre> <code class="bash hljs">$ time ./build/serv -v 0.1 real 0m0.021s user 0m0.021s sys 0m0.000s</code> </pre> <br><p> 为了进行比较，发射时间以“传统方式”： </p><br><pre> <code class="bash hljs">$ time java -cp <span class="hljs-string"><span class="hljs-string">"/home/xonix/proj/serv/target/classes:/home/xonix/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/xonix/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar"</span></span> com.cmlteam.serv.Serv -v 0.1 real 0m0.040s user 0m0.030s sys 0m0.019s</code> </pre> <br><p> 如您所见，速度是UPX版本的两倍。 </p><br><p> 通常，启动时间短是GraalVM的优势之一。 这以及较低的内存消耗，导致对该技术在微服务和无服务器环境中的使用表现出极大的热情。 </p><br><p> 我试图使程序逻辑尽可能少，并使用最少的库。 原则上，这种方法通常是合理的，在这种情况下，我担心添加第三方maven依赖项会极大地“加权”生成的程序文件。 </p><br><p> 例如，这就是为什么我不对Java Web服务器使用第三方依赖项（并且每种口味和颜色都有很多依赖项），但是我使用了<code>com.sun.net.httpserver.*</code>服务器的JDK实现。 实际上，使用<code>com.sun.*</code>软件包被认为是一种<code>com.sun.*</code> ，但是在这种情况下，我认为这是允许的，因为我正在编译为本机代码，因此，JVM之间没有兼容性问题。 </p><br><p> 但是，我的恐惧完全没有用。 在程序中，为了方便起见，我使用了两个依赖项 </p><br><ol><li>  <code>commons-cli</code>用于解析命令行参数 </li><li>  <code>commons-compress</code>生成文件夹tarball和可选的gzip压缩 </li></ol><br><p> 同时，文件大小非常微小地增加。 我冒昧地建议Graal编译器非常聪明，不要将所有插件jar-nicks都放在可执行文件中，而只需将其中的代码实际用于应用程序代码中即可。 </p><br><p> 通过本<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">机图像</a>实用程序将其编译为本机Graal代码。 值得一提的是，此过程需要大量资源。 说，在我的板载Intel 7700K CPU不太慢的配置下，此过程需要19秒。 因此，我建议在开发时，像往常一样（通过java）运行程序，并在最后阶段收集二进制文件。 </p><br><h2 id="vyvody"> 结论 </h2><br><p> 在我看来，该实验非常成功。 在使用Graal工具包进行开发时，我没有遇到任何无法克服甚至重大的问题。 一切都可以预期且稳定地进行。 尽管几乎可以肯定，如果您尝试以这种方式构建更复杂的东西，例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Spring Boot上</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">应用程序</a> ，一切都不会那么顺利。 尽管如此，已经提出了许多平台，其中宣布了对Graal的本地支持。 其中包括<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Micronaut</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Microprofile</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Quarkus</a> 。 </p><br><p> 至于该项目的进一步开发，已经准备了针对0.2版计划<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的改进清单</a> 。 另外，目前，最终二进制文件的汇编仅针对Linux x64实现。 我希望这一遗漏会在将来得到解决，特别是因为Graal的<code>native-image</code>编译器支持MacOS和Windows。 不幸的是，它还不支持交叉编译，这会使事情变得容易得多。 </p><br><p> 我希望提出的实用程序至少对著名的habr社区中的某人有用。 如果有人愿意<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">为该项目</a>做出贡献<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，</a>我将倍加高兴。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451574/">https://habr.com/ru/post/zh-CN451574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451560/index.html">尊敬的客户，这就是为什么这项更改花了这么长时间的原因。</a></li>
<li><a href="../zh-CN451562/index.html">如何逃离一个教派？</a></li>
<li><a href="../zh-CN451566/index.html">Operation TaskMaster：我们如何揭露俄罗斯和独联体的网络集团攻击组织</a></li>
<li><a href="../zh-CN451570/index.html">前往法国工作：薪金，签证和简历</a></li>
<li><a href="../zh-CN451572/index.html">Web开发技术趋势2019</a></li>
<li><a href="../zh-CN451576/index.html">该书“我们的代码。 工艺，专业，艺术“</a></li>
<li><a href="../zh-CN451580/index.html">MODX摘要＃5（2019年4月22日至5月13日）</a></li>
<li><a href="../zh-CN451582/index.html">英文内容营销：5个帮助初创企业的重要数据</a></li>
<li><a href="../zh-CN451586/index.html">欢迎观看BD和DWH Raiffeisen MeetUp UPD广播</a></li>
<li><a href="../zh-CN451588/index.html">在Kubernetes上使用Jenkins进行集成测试说明</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>