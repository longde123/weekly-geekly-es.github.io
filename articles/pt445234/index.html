<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüíª üöü ü•ô As exce√ß√µes do Python agora s√£o consideradas anti-padr√£o üìò ü§≥üèº üçÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que s√£o exce√ß√µes? Pelo nome, √© claro - eles surgem quando ocorre uma exce√ß√£o no programa. Voc√™ pode perguntar por que as exce√ß√µes s√£o um antipadr√£o ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>As exce√ß√µes do Python agora s√£o consideradas anti-padr√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/445234/">  O que s√£o exce√ß√µes?  Pelo nome, √© claro - eles surgem quando ocorre uma exce√ß√£o no programa.  Voc√™ pode perguntar por que as exce√ß√µes s√£o um antipadr√£o e como elas se relacionam com a digita√ß√£o?  Tentei <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descobrir</a> e agora quero discutir isso com voc√™, harazhiteli. <br><br><h2>  Problemas de exce√ß√£o </h2><br>  √â dif√≠cil encontrar falhas no que voc√™ enfrenta todos os dias.  H√°bito e cegueira transformam insetos em caracter√≠sticas, mas vamos tentar examinar as exce√ß√µes com a mente aberta. <br><br><h3>  Exce√ß√µes s√£o dif√≠ceis de detectar </h3><br>  Existem dois tipos de exce√ß√µes: "expl√≠cito" √© criado chamando <code>raise</code> diretamente no c√≥digo que voc√™ est√° lendo;  "Oculto" est√£o ocultos nas fun√ß√µes, classes e m√©todos utilizados. <br><br>  O problema √© que as exce√ß√µes "ocultas" s√£o realmente dif√≠ceis de perceber.  Deixe-me mostrar um exemplo de uma fun√ß√£o pura: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first: float, second: float)</span></span></span><span class="hljs-function"> -&gt; float:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> first / second</code> </pre><br>  A fun√ß√£o simplesmente divide um n√∫mero por outro, retornando um n√∫mero <code>float</code> .  Os tipos s√£o verificados e voc√™ pode executar algo como isto: <br><br><pre> <code class="python hljs">result = divide(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) print(<span class="hljs-string"><span class="hljs-string">'x / y = '</span></span>, result)</code> </pre><br>  Voc√™ j√° reparou?  De fato, a execu√ß√£o do programa nunca chegar√° √† <code>print</code> , porque dividir 1 por 0 √© uma opera√ß√£o imposs√≠vel, pois <code>ZeroDivisionError</code> um <code>ZeroDivisionError</code> .  Sim, esse c√≥digo √© do tipo seguro, mas n√£o pode ser usado de qualquer maneira. <br><a name="habracut"></a><br>  Para perceber um problema em potencial, mesmo em um c√≥digo t√£o simples e leg√≠vel, √© preciso ter experi√™ncia.  Qualquer coisa no Python pode parar de funcionar com diferentes tipos de exce√ß√µes: divis√£o, chamadas de fun√ß√£o, <code>int</code> , <code>str</code> , geradores, iteradores em loops, acesso a atributos ou chaves.  At√© <code>raise something()</code> pode causar um acidente.  Al√©m disso, eu nem menciono opera√ß√µes de entrada e sa√≠da.  E <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">as exce√ß√µes verificadas n√£o ser√£o mais suportadas</a> no futuro pr√≥ximo. <br><br><h3>  N√£o √© poss√≠vel restaurar o comportamento normal no local </h3><br>  Mas precisamente para esse caso, temos exce√ß√µes.  Vamos apenas lidar com <code>ZeroDivisionError</code> e o c√≥digo se tornar√° seguro para o tipo. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first: float, second: float)</span></span></span><span class="hljs-function"> -&gt; float:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> first / second <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ZeroDivisionError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span></code> </pre><br>  Agora est√° tudo bem.  Mas por que retornamos 0?  Por que n√£o 1 ou <code>None</code> ?  Obviamente, na maioria dos casos, obter <code>None</code> quase t√£o ruim (se n√£o pior) como uma exce√ß√£o, mas voc√™ ainda precisa confiar na l√≥gica de neg√≥cios e nas op√ß√µes para usar a fun√ß√£o. <br><br>  O que exatamente estamos compartilhando?  N√∫meros arbitr√°rios, alguma unidade espec√≠fica ou dinheiro?  Nem todas as op√ß√µes s√£o f√°ceis de prever e restaurar.  Pode acontecer que da pr√≥xima vez que voc√™ use uma fun√ß√£o, voc√™ precise de uma l√≥gica de recupera√ß√£o diferente. <br><br><blockquote>  A triste conclus√£o: a solu√ß√£o para cada problema √© individual, dependendo do contexto espec√≠fico de uso. </blockquote><br>  N√£o existe uma bala de prata para lidar com o <code>ZeroDivisionError</code> uma vez por todas.  E n√£o estamos falando sobre a possibilidade de E / S complexa com solicita√ß√µes e tempos limite repetidos. <br><br>  Talvez n√£o seja necess√°rio lidar com exce√ß√µes exatamente onde elas surgem?  Talvez apenas jogue no processo de execu√ß√£o de c√≥digo - algu√©m descobrir√° mais tarde.  E ent√£o somos for√ßados a voltar ao estado atual. <br><br><h3>  Processo de execu√ß√£o pouco claro </h3><br>  Bem, vamos esperar que outra pessoa pegue a exce√ß√£o e talvez lide com isso.  Por exemplo, o sistema pode solicitar ao usu√°rio que altere o valor inserido, porque n√£o pode ser dividido por 0. E a fun√ß√£o de <code>divide</code> n√£o deve ser explicitamente respons√°vel pela recupera√ß√£o do erro. <br><br>  Nesse caso, voc√™ precisa verificar onde capturamos a exce√ß√£o.  A prop√≥sito, como determinar exatamente onde ser√° processado?  √â poss√≠vel ir ao lugar certo no c√≥digo?  Acontece que n√£o, <strong>√© imposs√≠vel</strong> . <br><br>  N√£o √© poss√≠vel determinar qual linha de c√≥digo ser√° executada ap√≥s a exce√ß√£o ser lan√ßada.  Diferentes tipos de exce√ß√µes podem ser manipulados com diferentes op√ß√µes <code>except</code> , e algumas exce√ß√µes podem ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ignoradas</a> .  E voc√™ pode lan√ßar exce√ß√µes adicionais em outros m√≥dulos que ser√£o executados anteriormente e, em geral, quebrar√£o toda a l√≥gica. <br><br>  Suponha que haja dois encadeamentos independentes em um aplicativo: um encadeamento regular que √© executado de cima para baixo e um encadeamento de exce√ß√£o que √© executado como desejar.  Como ler e entender esse c√≥digo? <br><br>  Somente com o depurador ativado no modo "capturar todas as exce√ß√µes". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8k/bn/do/8kbndolwukkaluarfk3vpexws2w.png"></div><br>  Exce√ß√µes, como o not√≥rio <code>goto</code> , rasgam a estrutura do programa. <br><br><h3>  Exce√ß√µes n√£o s√£o exclusivas </h3><br>  Vejamos outro exemplo: o c√≥digo de acesso √† API HTTP usual: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch_user_profile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id: int)</span></span></span><span class="hljs-function"> -&gt; 'UserProfile':</span></span> <span class="hljs-string"><span class="hljs-string">"""Fetches UserProfile dict from foreign API."""</span></span> response = requests.get(<span class="hljs-string"><span class="hljs-string">'/api/users/{0}'</span></span>.format(user_id)) response.raise_for_status() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.json()</code> </pre><br>  Neste exemplo, literalmente tudo pode dar errado.  Aqui est√° uma lista parcial de poss√≠veis erros: <br><br><ul><li>  A rede pode n√£o estar dispon√≠vel e a solicita√ß√£o n√£o ser√° executada. </li><li>  O servidor pode n√£o funcionar. </li><li>  O servidor pode estar muito ocupado, o tempo limite ocorrer√°. </li><li>  O servidor pode exigir autentica√ß√£o. </li><li>  Uma API pode n√£o ter esse URL. </li><li>  Um usu√°rio inexistente pode ser transferido. </li><li>  Pode n√£o haver direitos suficientes. </li><li>  O servidor pode falhar devido a um erro interno ao processar sua solicita√ß√£o </li><li>  O servidor pode retornar uma resposta inv√°lida ou danificada. </li><li>  O servidor pode retornar JSON inv√°lido que n√£o pode ser analisado. </li></ul><br>  A lista continua, e h√° tantos problemas em potencial no c√≥digo das tr√™s linhas infelizes.  Podemos dizer que geralmente funciona apenas por uma chance de sorte e √© muito mais prov√°vel que caia com uma exce√ß√£o. <br><br><h2>  Como se proteger? </h2><br>  Agora que garantimos que as exce√ß√µes podem ser prejudiciais ao c√≥digo, vamos descobrir como se livrar delas.  Para escrever c√≥digo sem exce√ß√£o, existem padr√µes diferentes. <br><br><ul><li>  Em todos os lugares, <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">except Exception: pass</a></code> .  Beco sem sa√≠da.  <strong>N√£o fa√ßa isso.</strong> </li><li>  Retorno <code>None</code> .  Muito mal.  Como resultado, voc√™ ter√° que iniciar quase todas as linhas <code>if something is not None:</code> e toda a l√≥gica ser√° perdida por tr√°s do lixo das verifica√ß√µes de limpeza, ou voc√™ sofrer√° <code>TypeError</code> o tempo todo.  N√£o √© uma boa escolha. </li><li>  Escreva aulas para casos de uso especiais.  Por exemplo, a classe base <code>User</code> com subclasses para erros como <code>UserNotFound</code> e <code>MissingUser</code> .  Essa abordagem pode ser usada em algumas situa√ß√µes espec√≠ficas, como <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AnonymousUser</a></code> no Django, mas agrupar todos os erros poss√≠veis nas classes n√£o √© realista.  Isso exigir√° muito trabalho e o modelo de dom√≠nio se tornar√° inimaginavelmente complexo. </li><li>  Use cont√™ineres para agrupar a vari√°vel resultante ou o valor do erro em um inv√≥lucro e continue trabalhando com o valor do cont√™iner.  Por isso, criamos o projeto <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@dry-python/return</a></code> .  Portanto, essas fun√ß√µes retornam algo significativo, digitado e seguro. </li></ul><br>  Vamos retornar ao exemplo de divis√£o, que retorna 0. Quando ocorre um erro.Podemos indicar explicitamente que a fun√ß√£o n√£o teve √™xito sem retornar um valor num√©rico espec√≠fico? <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.result <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Result, Success, Failure <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first: float, second: float)</span></span></span><span class="hljs-function"> -&gt; Result[float, ZeroDivisionError]:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Success(first / second) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ZeroDivisionError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> exc: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Failure(exc)</code> </pre><br>  Colocamos os valores em um dos dois inv√≥lucros: <code>Success</code> ou <code>Failure</code> .  Essas classes s√£o herdadas da classe base <code>Result</code> .  Tipos de valores compactados podem ser especificados na anota√ß√£o com a fun√ß√£o retornada, por exemplo, <code>Result[float, ZeroDivisionError]</code> retorna <code>Success[float]</code> ou <code>Failure[ZeroDivisionError]</code> . <br><br>  O que isso nos d√°?  Mais <strong>exce√ß√µes n√£o s√£o excepcionais, mas s√£o problemas esperados</strong> .  Al√©m disso, agrupar uma exce√ß√£o em <code>Failure</code> resolve um segundo problema: a complexidade de identificar poss√≠veis exce√ß√µes. <br><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> + divide(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># =&gt; mypy error: Unsupported operand types for + ("int" and "Result[float, ZeroDivisionError]")</span></span></code> </pre><br>  Agora eles s√£o f√°ceis de detectar.  Se voc√™ vir <code>Result</code> no c√≥digo, a fun√ß√£o poder√° gerar uma exce√ß√£o.  E voc√™ at√© conhece o tipo dele com anteced√™ncia. <br><br>  Al√©m disso, a biblioteca √© totalmente digitada e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compat√≠vel com o PEP561</a> .  Ou seja, mypy ir√° avis√°-lo se voc√™ tentar retornar algo que n√£o corresponde ao tipo declarado. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.result <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Result, Success, Failure <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first: float, second: float)</span></span></span><span class="hljs-function"> -&gt; Result[float, ZeroDivisionError]:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Success(<span class="hljs-string"><span class="hljs-string">'Done'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># =&gt; error: incompatible type "str"; expected "float" except ZeroDivisionError as exc: return Failure(0) # =&gt; error: incompatible type "int"; expected "ZeroDivisionError"</span></span></code> </pre><br><h3>  Como trabalhar com cont√™ineres? </h3><br>  Existem dois <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√©todos</a> : <br><br><ul><li>  <code>map</code> para fun√ß√µes que retornam valores normais; </li><li>  <code>bind</code> para fun√ß√µes que retornam outros cont√™ineres. </li></ul><br><pre> <code class="python hljs">Success(<span class="hljs-number"><span class="hljs-number">4</span></span>).bind(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> number: Success(number / <span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># =&gt; Success(2) Success(4).map(lambda number: number + 1) # =&gt; Success(5)</span></span></code> </pre><br>  A <code>.bind</code> √© que esse c√≥digo o proteger√° de scripts sem √™xito, pois <code>.bind</code> e <code>.map</code> n√£o ser√£o executados para cont√™ineres com <code>Failure</code> : <br><br><pre> <code class="python hljs">Failure(<span class="hljs-number"><span class="hljs-number">4</span></span>).bind(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> number: Success(number / <span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># =&gt; Failure(4) Failure(4).map(lambda number: number / 2) # =&gt; Failure(4)</span></span></code> </pre><br>  Agora voc√™ pode apenas se concentrar no processo de execu√ß√£o correto e garantir que o estado errado n√£o interrompa o programa em um local inesperado.  E sempre h√° a oportunidade de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">determinar o estado errado, corrigi-lo</a> e retornar ao caminho concebido do processo. <br><br><pre> <code class="python hljs">Failure(<span class="hljs-number"><span class="hljs-number">4</span></span>).rescue(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> number: Success(number + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># =&gt; Success(5) Failure(4).fix(lambda number: number / 2) # =&gt; Success(2)</span></span></code> </pre><br>  Em nossa abordagem, "todos os problemas s√£o resolvidos individualmente" e "o processo de execu√ß√£o agora √© transparente".  Aproveite a programa√ß√£o que monta nos trilhos! <br><br><h3>  Mas como expandir os valores dos cont√™ineres? </h3><br>  De fato, se voc√™ trabalha com fun√ß√µes que n√£o sabem nada sobre cont√™ineres, precisa dos pr√≥prios valores.  Ent√£o voc√™ pode usar os <code>.unwrap()</code> ou <code>.value_or()</code> : <br><br><pre> <code class="python hljs">Success(<span class="hljs-number"><span class="hljs-number">1</span></span>).unwrap() <span class="hljs-comment"><span class="hljs-comment"># =&gt; 1 Success(0).value_or(None) # =&gt; 0 Failure(0).value_or(None) # =&gt; None Failure(1).unwrap() # =&gt; Raises UnwrapFailedError()</span></span></code> </pre><br>  Espere, tivemos que nos livrar das exce√ß√µes e agora acontece que todas as chamadas <code>.unwrap()</code> podem levar a outra exce√ß√£o? <br><br><h3>  Como n√£o pensar em UnwrapFailedErrors? </h3><br>  Ok, vamos ver como conviver com as novas exce√ß√µes.  Considere este exemplo: voc√™ precisa verificar a entrada do usu√°rio e criar dois modelos no banco de dados.  Cada etapa pode terminar com uma exce√ß√£o, e √© por isso que todos os m√©todos s√£o agrupados em <code>Result</code> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.result <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Result, Success, Failure <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateAccountAndUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Creates new Account-User pair."""</span></span> <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> we need to create a pipeline of these methods somehow... def _validate_user( self, username: str, email: str, ) -&gt; Result['UserSchema', str]: """Returns an UserSchema for valid input, otherwise a Failure.""" def _create_account( self, user_schema: 'UserSchema', ) -&gt; Result['Account', str]: """Creates an Account for valid UserSchema's. Or returns a Failure.""" def _create_user( self, account: 'Account', ) -&gt; Result['User', str]: """Create an User instance. If user already exists returns Failure."""</span></span></code> </pre><br>  Primeiro, voc√™ n√£o precisa expandir os valores em sua pr√≥pria l√≥gica de neg√≥cios: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateAccountAndUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Creates new Account-User pair."""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, username: str, email: str)</span></span></span><span class="hljs-function"> -&gt; Result['User', str]:</span></span> <span class="hljs-string"><span class="hljs-string">"""Can return a Success(user) or Failure(str_reason)."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._validate_user( username, email, ).bind( self._create_account, ).bind( self._create_user, ) <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br>  Tudo funcionar√° sem problemas, sem exce√ß√µes, porque <code>.unwrap()</code> n√£o <code>.unwrap()</code> usado.  Mas √© f√°cil ler esse c√≥digo?  N√£o.  E qual √© a alternativa?  <code>@pipeline</code> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> result.functions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pipeline <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateAccountAndUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Creates new Account-User pair."""</span></span> @pipeline <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, username: str, email: str)</span></span></span><span class="hljs-function"> -&gt; Result['User', str]:</span></span> <span class="hljs-string"><span class="hljs-string">"""Can return a Success(user) or Failure(str_reason)."""</span></span> user_schema = self._validate_user(username, email).unwrap() account = self._create_account(user_schema).unwrap() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._create_user(account) <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br>  Agora este c√≥digo est√° bem lido.  Veja como <code>.unwrap()</code> e <code>@pipeline</code> trabalham juntos: sempre que um m√©todo <code>.unwrap()</code> falha e <code>Failure[str]</code> , o decorador <code>@pipeline</code> captura e retorna <code>Failure[str]</code> como o valor resultante.  √â assim que proponho remover todas as exce√ß√µes do c√≥digo e torn√°-lo realmente seguro e digitado. <br><br><h2>  Enrole tudo junto </h2><br>  Bem, agora aplicaremos as novas ferramentas, por exemplo, com uma solicita√ß√£o √† API HTTP.  Lembre-se que cada linha pode lan√ßar uma exce√ß√£o?  E n√£o h√° como faz√™-los retornar o cont√™iner com <code>Result</code> .  Mas voc√™ pode usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">decorador @safe</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">agrupar</a> fun√ß√µes n√£o seguras e torn√°-las seguras.  Abaixo est√£o duas op√ß√µes de c√≥digo que fazem a mesma coisa: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.functions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> safe @safe <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(first: float, second: float)</span></span></span><span class="hljs-function"> -&gt; float:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> first / second <span class="hljs-comment"><span class="hljs-comment"># is the same as: def divide(first: float, second: float) -&gt; Result[float, ZeroDivisionError]: try: return Success(first / second) except ZeroDivisionError as exc: return Failure(exc)</span></span></code> </pre><br>  O primeiro, com <code>@safe</code> , √© mais f√°cil e melhor de ler. <br><br>  A √∫ltima coisa a fazer no exemplo de solicita√ß√£o da API √© adicionar o decorador <code>@safe</code> .  O resultado √© o seguinte c√≥digo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.functions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pipeline, safe <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> returns.result <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Result <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FetchUserProfile</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Single responsibility callable object that fetches user profile."""</span></span> <span class="hljs-comment"><span class="hljs-comment">#: You can later use dependency injection to replace `requests` #: with any other http library (or even a custom service). _http = requests @pipeline def __call__(self, user_id: int) -&gt; Result['UserProfile', Exception]: """Fetches UserProfile dict from foreign API.""" response = self._make_request(user_id).unwrap() return self._parse_json(response) @safe def _make_request(self, user_id: int) -&gt; requests.Response: response = self._http.get('/api/users/{0}'.format(user_id)) response.raise_for_status() return response @safe def _parse_json(self, response: requests.Response) -&gt; 'UserProfile': return response.json()</span></span></code> </pre><br>  <strong>Para resumir como se livrar das exce√ß√µes e proteger o c√≥digo</strong> : <br><br><ul><li>  Use o wrapper <code>@safe</code> para todos os m√©todos que podem lan√ßar uma exce√ß√£o.  Ele mudar√° o tipo de retorno da fun√ß√£o para <code>Result[OldReturnType, Exception]</code> . </li><li>  Use <code>Result</code> como um cont√™iner para transferir valores e erros em uma abstra√ß√£o simples. </li><li>  Use <code>.unwrap()</code> para expandir o valor do cont√™iner. </li><li>  Use <code>@pipeline</code> para facilitar a leitura das <code>.unwrap</code> chamadas <code>.unwrap</code> . </li></ul><br>  Ao observar essas regras, podemos fazer exatamente a mesma coisa - apenas segura e bem leg√≠vel.  Todos os problemas que estavam com exce√ß√µes foram resolvidos: <br><br><ul><li>  <strong>"Exce√ß√µes s√£o dif√≠ceis de detectar</strong> . <strong>"</strong>  Agora eles est√£o envolvidos em um cont√™iner de <code>Result</code> digitado, o que os torna completamente transparentes. </li><li>  <strong>"Restaurar o comportamento normal √© imposs√≠vel</strong> . <strong>"</strong>  Agora voc√™ pode delegar com seguran√ßa o processo de recupera√ß√£o ao chamador.  <code>.fix()</code> caso, existem <code>.fix()</code> e <code>.rescue()</code> . </li><li>  <strong>"A sequ√™ncia de execu√ß√£o n√£o √© clara</strong> . <strong>"</strong>  Agora eles s√£o um com o fluxo comercial usual.  Do in√≠cio ao fim. </li><li>  <strong>"Exce√ß√µes n√£o s√£o excepcionais</strong> . <strong>"</strong>  N√≥s sabemos!  E esperamos que algo d√™ errado e esteja pronto para qualquer coisa. </li></ul><br><h3>  Casos de uso e limita√ß√µes </h3><br>  Obviamente, voc√™ n√£o pode usar essa abordagem em todo o seu c√≥digo.  Ser√° <strong>muito seguro</strong> para a maioria das situa√ß√µes cotidianas e √© incompat√≠vel com outras bibliotecas ou estruturas.  Mas voc√™ deve escrever as partes mais importantes da l√≥gica de neg√≥cios exatamente como mostrei, para garantir a opera√ß√£o correta do seu sistema e facilitar o suporte futuro. <br><br><blockquote>  O t√≥pico faz voc√™ pensar ou at√© parecer holivarny?  Venha para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moscou Python Conf ++</a> em 5 de abril, discutiremos!  Al√©m de mim, Artyom Malyshev, o fundador do projeto dry-python e desenvolvedor principal do Django Channels, estar√° l√°.  Ele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falar√°</a> mais sobre python seco e l√≥gica de neg√≥cios. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445234/">https://habr.com/ru/post/pt445234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445220/index.html">AMD Radeon VII: chip de √∫ltima gera√ß√£o (parte 3)</a></li>
<li><a href="../pt445222/index.html">Receba uma oferta em 1 dia para a equipe de back-end no Dia da Cosmon√°utica</a></li>
<li><a href="../pt445226/index.html">O desenvolvimento de um foguete capaz de atingir a lua custar√° √† R√∫ssia 740 bilh√µes de rublos</a></li>
<li><a href="../pt445228/index.html">Criptografia em Java. Classe Mac</a></li>
<li><a href="../pt445230/index.html">As inscri√ß√µes para a II confer√™ncia de TI para iniciantes SMARTRHINO-2019 come√ßaram</a></li>
<li><a href="../pt445236/index.html">‚ÄúExtreme NOW Forum 2019‚Äù: inscri√ß√µes abertas</a></li>
<li><a href="../pt445238/index.html">Crescer: os 10 principais relat√≥rios do Mobius 2018 em Moscou</a></li>
<li><a href="../pt445240/index.html">Como mover, fazer upload e integrar dados muito grandes de maneira barata e r√°pida? O que √© otimiza√ß√£o de empilhamento?</a></li>
<li><a href="../pt445242/index.html">Experi√™ncia com Coroutines e Retrofit2</a></li>
<li><a href="../pt445244/index.html">"Jogos de dinheiro fora do blockchain devem morrer"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>