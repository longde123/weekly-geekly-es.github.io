<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçö ‚è∞ üè§ Enrutamiento directo y equilibrio con NFT vs Nginx üç† üí† üë©üèº‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al desarrollar aplicaciones de red altamente cargadas, es necesario equilibrar la carga. 

 Una herramienta de equilibrio L7 popular es Nginx. Le perm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Enrutamiento directo y equilibrio con NFT vs Nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441348/">  Al desarrollar aplicaciones de red altamente cargadas, es necesario equilibrar la carga. <br><br>  Una herramienta de equilibrio L7 popular es Nginx.  Le permite almacenar en cach√© las respuestas, elegir diferentes estrategias e incluso escribir en LUA. <br><br>  A pesar de todos los encantos de Nginx, si: <br><br><ol><li>  No es necesario trabajar con HTTP (s). </li><li>  Debe exprimir al m√°ximo la red. </li><li>  No es necesario almacenar en cach√© nada: el equilibrador tiene servidores API limpios con din√°mica. </li></ol><br>  Puede surgir la pregunta: ¬øpor qu√© necesita Nginx?  ¬øPor qu√© desperdiciar el equilibrio de recursos en L7? ¬øNo es m√°s f√°cil simplemente reenviar el paquete SYN?  (Enrutamiento directo L4). <br><a name="habracut"></a><br><h3>  Equilibrio de capa 4 o c√≥mo equilibrar en la antig√ºedad </h3><br>  Una herramienta popular de reenv√≠o de paquetes fue IPVS.  Realiz√≥ tareas de equilibrio a trav√©s del t√∫nel y enrutamiento directo. <br><br>  En el primer caso, se estableci√≥ un canal TCP para cada conexi√≥n y el paquete del usuario fue al equilibrador, luego al minion y luego en el orden inverso. <br><br><img src="https://habrastorage.org/webt/cy/so/j6/cysoj6mgraildwjgs1sbwvufpt4.png"><br><br>  En este esquema, el problema principal es visible: en la direcci√≥n opuesta, los datos van primero al equilibrador y luego al usuario (Nginx funciona de la misma manera).  Se realiza un trabajo innecesario, dado el hecho de que generalmente se env√≠an m√°s datos al usuario, este comportamiento conduce a una p√©rdida de rendimiento. <br><br>  No existe un m√©todo de equilibrio (pero dotado de nuevo) llamado Enrutamiento directo.  Esquem√°ticamente, se ve as√≠: <br><br><img src="https://habrastorage.org/webt/hy/9r/5-/hy9r5-brkhgzmjgmotrnnibfta4.png"><br><br>  En el caso del enrutamiento directo, los paquetes de retorno van directamente al usuario, sin pasar por el equilibrador.  Obviamente, tanto los recursos del equilibrador como la red se guardan.  Al ahorrar recursos de red, no se trata tanto de ahorrar tr√°fico, porque la pr√°ctica habitual es conectar los servidores a una red separada y no tener en cuenta el tr√°fico, pero el hecho de que incluso la transferencia a trav√©s del equilibrador es una p√©rdida de milisegundos. <br><br>  Este m√©todo impone ciertas restricciones: <br><br><ol><li>  El centro de datos donde se ubica la infraestructura debe permitir falsificar direcciones locales.  En el diagrama anterior, cada minion debe enviar paquetes de vuelta en nombre de IP 10.10.0.1, que se asigna al equilibrador. </li><li>  El equilibrador no sabe nada sobre el estado de los minions.  En consecuencia, las estrategias de menor tiempo de conexi√≥n y menor tiempo no son factibles desde el primer momento.  En uno de los siguientes art√≠culos, intentar√© implementarlos y mostrar el resultado. </li></ol><br><h3>  Aqu√≠ viene NFTables </h3><br>  Hace unos a√±os, Linux comenz√≥ a promover activamente NFTables como un reemplazo para IPTables, ArpTables, EBTables y todos los dem√°s [az] {1,} Tablas.  En el momento en que en Adram tuvimos la necesidad de exprimir cada milisegundo de la respuesta de la red, decid√≠ sacar el verificador y buscar, o tal vez ipTables aprendi√≥ a hacer el reenv√≠o de iphash y puede acelerarlo para equilibrarlo.  Luego me top√© con nftables, que puede y no solo eso, sino que iptables a√∫n no puede hacer esto. <br>  Despu√©s de varios d√≠as de prueba, finalmente pude obtener enrutamiento directo y enrutamiento de canales a trav√©s de NFTables en el laboratorio de pruebas y tambi√©n compararlos con nginx. <br><br>  Entonces, el laboratorio de pruebas.  Tenemos 5 autos: <br><br><ol><li>  nft-router: un enrutador que realiza la tarea de conectar el cliente y la subred de AppServer.  Hay 2 tarjetas de red: 192.168.56.254 - mira la red del servidor de aplicaciones, 192.168.97.254 - mira a los clientes.  Ip_forward est√° habilitado y todas las rutas est√°n registradas. </li><li>  nft-client: cliente desde el cual se perseguir√° ab, ip 192.168.97.2 </li><li>  nft-balancer: balanceador.  Tiene dos IP: 192.168.56.4, a las que acceden los clientes y 192.168.13.1, desde la subred de minion. </li><li>  nft-minion-a y nft-minion-b: minions ipy: 192.168.56.2, 192.168.56.3 y 192.168.13.2 y 192.168.13.3 (intent√© usar la misma red y diferentes para equilibrar).  En las pruebas, me detuve ante el hecho de que los minions tienen tipos "externos", en la subred 192.168.56.0/24 </li></ol><br>  Todas las interfaces MTU 1500. <br><br><h4>  Enrutamiento directo </h4><br>  Configuraci√≥n de NFTables en el equilibrador: <br><br><pre><code class="json hljs">table ip raw { chain input { type filter hook prerouting priority -300; policy accept; tcp dport http ip daddr set jhash tcp sport mod 2 map { 0: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, 1: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.56</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> } } }</code> </pre> <br>  Se crea una cadena sin procesar, en el gancho, con una prioridad de -300. <br><br>  Si llega un paquete con una direcci√≥n de destino http, dependiendo del puerto de origen (hecho para probar desde una m√°quina, realmente necesita ip saddr), se selecciona 56.2 o 56.3 y se configura como la direcci√≥n de destino en el paquete, y luego se env√≠a m√°s a lo largo de las rutas.  En t√©rminos generales, para los puertos pares 56.2, para los puertos impares, respectivamente, 56.3 (de hecho, no, porque para los hashes pares / impares, pero es m√°s f√°cil de entender exactamente eso).  Despu√©s de configurar la IP de destino, el paquete vuelve a la red.  No se produce NAT, el paquete llega a los minions con la IP de origen del cliente y no con el equilibrador, que es importante para el enrutamiento directo. <br><br>  Configuraci√≥n de Minion NFT: <br><br><pre> <code class="json hljs">table ip raw { chain output { type filter hook output priority -300; policy accept; tcp sport http ip saddr set 192.168.56.4 } }</code> </pre><br>  Se crea un enlace de salida sin formato con una prioridad de -300 (la prioridad es muy importante aqu√≠, a niveles m√°s altos, la menulaci√≥n necesaria no funcionar√° para los paquetes de respuesta). <br><br>  Todo el tr√°fico saliente desde el puerto http est√° firmado por 56.4 (equilibrador de ip) y se env√≠a directamente al cliente, sin pasar por el equilibrador. <br><br>  Para verificar si todo funcionar√° correctamente, traje el cliente a otra red y lo dej√© pasar por el enrutador. <br><br>  Tambi√©n deshabilit√© arp_filter, rp_filter (para que la suplantaci√≥n funcionara) y habilit√© ip_forward tanto en el equilibrador como en el enrutador. <br><br>  Para los bancos, en el caso de NFT, Nginx + php7.2-FPM se utiliza a trav√©s de un socket Unix en cada minion.  No hab√≠a nada en el equilibrador. <br><br>  En el caso de Nginx, utilizamos: nginx en el equilibrador y php7.2-FPM sobre TCP en minions.  Como resultado, no equilibr√© el servidor web detr√°s del equilibrador, sino inmediatamente FPM (que ser√° m√°s honesto con nginx y m√°s coherente con la vida real). <br><br>  Para NFT, solo se us√≥ la estrategia hash ( <b>nft dr</b> en la tabla), para nginx: hash ( <b>ngx eq</b> ) y menos conn ( <b>ngx lc</b> ) <br><br>  Se han realizado varias pruebas. <br><br><ol><li>  Peque√±o gui√≥n r√°pido <b>(peque√±o)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> system(<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>);</code> </pre><br></li><li>  El gui√≥n con un retraso aleatorio <b>(rand)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> usleep(mt_rand(<span class="hljs-number"><span class="hljs-number">100000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ok"</span></span>;</code> </pre></li><li>  Un script con el env√≠o de una gran cantidad de datos <b>(tama√±o)</b> . <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $size=$_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]; $file=<span class="hljs-string"><span class="hljs-string">'/tmp/'</span></span>.$size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($file)) { $dummy=<span class="hljs-string"><span class="hljs-string">""</span></span>; exec (<span class="hljs-string"><span class="hljs-string">"dd if=/dev/urandom of=$file bs=$size count=1 2&gt;&amp;1"</span></span>,$dummy); } fpassthru (fopen($file,<span class="hljs-string"><span class="hljs-string">'rb'</span></span>));</code> </pre><br>  Se utilizaron los siguientes tama√±os: <br>  512.1440.1460.1480.1500.2048.65535.655350 bytes. <br>  Antes de las pruebas, calent√© los archivos de estad√≠sticas de cada minion. <br></li></ol><br>  Probado ab tres veces en cada prueba: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash function do_test() { rep=$3 for i in $(seq $rep) do echo "testing $2 # $i" echo "$2 pass $i" &gt;&gt; $2 ab $1 &gt;&gt; $2 echo "--------------------------" &gt;&gt; $2 done } do_test " -n 5000 -c 100 http://192.168.56.4:80/rand.php" "ngx_eq_test_rand" 3 do_test " -n 10000 -c 100 http://192.168.56.4:80/" "ngx_eq_test_small" 3 size=512 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1440 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1460 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1480 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=1500 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=2048 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=65535 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3 size=655350 do_test " -n 10000 -c 100 http://192.168.56.4:80/size.php?size=$size" "ngx_eq_test_size_$size" 3</span></span></code> </pre> <br>  Inicialmente, plane√© traer el tiempo de prueba, milisegundos y el resto, como resultado me detuve en RPS: son representativos y se correlacionan con los indicadores de tiempo. <br><br>  Obtuve los siguientes resultados: <br><br>  Prueba de tama√±o - columnas - el tama√±o de los datos dados. <br><br><img src="https://habrastorage.org/webt/hk/yi/ma/hkyimanxhaoa_7ejz-ehvmecp1s.png"><br><br>  Como puede ver, el enrutamiento directo nft gana por un amplio margen. <br><br>  Contaba con algunos otros resultados relacionados con el tama√±o del marco de ethernet, pero no se encontr√≥ correlaci√≥n.  Quiz√°s el cuerpo 512 no cabe en 1500 MTU, aunque, dudo, la peque√±a prueba ser√° indicativa. <br><br>  Not√© que en grandes vol√∫menes (650k) nginx reduce la brecha.  Tal vez esto tenga algo que ver con los b√∫feres y el tama√±o de Windows TCP. <br><br>  El resultado de la prueba de rand.  Muestra c√≥mo se maneja conn menos en condiciones de diferente velocidad de ejecuci√≥n del script en diferentes secuaces. <br><br><img src="https://habrastorage.org/webt/z_/pe/se/z_pesed0h37wmanijte9wjsr7ra.png"><br><br>  Sorprendentemente, nginx hash funcion√≥ m√°s r√°pido que la menor conexi√≥n, y solo en la pasada final la menor conexi√≥n avanz√≥ un poco, lo que no pretende ser significativo. <br>  Los n√∫meros de los pases son muy diferentes debido al hecho de que salen 100 hilos a la vez, y el FPM-ok desde el principio carga alrededor de 10. Para el tercer pase, tuvieron tiempo de acostumbrarse, lo que muestra la aplicabilidad de las estrategias para los estallidos. <br><br>  NFT se esperaba que perdiera esta prueba.  Nginx optimiza bien la interacci√≥n con los FPM en tales situaciones. <br><br>  peque√±a prueba <br><br><img src="https://habrastorage.org/webt/wo/l-/ua/wol-uar4xattjpfztcpppy53hae.png"><br><br>  nft gana marginalmente en RPS, menos conn vuelve a ser un extra√±o. <br><br>  Por cierto, en esta prueba puede ver que se emiten 400-500RPS, aunque, en la prueba con el env√≠o de 512 bytes, fue para 1500, parece que el sistema se come este millar. <br><br><h2>  Conclusiones </h2><br>  NFT funcion√≥ bien en una situaci√≥n de optimizaci√≥n de cargas uniformes: cuando se proporcionan muchos datos, se determina el tiempo de funcionamiento de la aplicaci√≥n y los recursos del cl√∫ster son suficientes para procesar la transmisi√≥n entrante sin caer en picada. <br><br>  En una situaci√≥n en la que la carga para cada solicitud es ca√≥tica y es imposible equilibrar uniformemente la carga del servidor con el resto primitivo de la divisi√≥n hash, la NFT perder√°. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441348/">https://habr.com/ru/post/441348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441336/index.html">RTOS o no RTOS es la pregunta</a></li>
<li><a href="../441338/index.html">C√≥mo hicimos un sistema de pago de criptomonedas: cinco problemas principales</a></li>
<li><a href="../441340/index.html">El patrimonio cultural de Kazajst√°n en modelos 3D</a></li>
<li><a href="../441344/index.html">Entra al cielo. Una historia honesta sobre una seria pasi√≥n por el paracaidismo.</a></li>
<li><a href="../441346/index.html">Conozca a un estratega de contenido: una entrevista con Dmitry Kabanov, curador de Startup Digest de Techstars y asesor de SXSW</a></li>
<li><a href="../441350/index.html">¬øHaskell es realmente el lenguaje de los genios y la academia?</a></li>
<li><a href="../441352/index.html">Patrones de CI / CD y antipatrones. Parte 2</a></li>
<li><a href="../441356/index.html">¬øC√≥mo entender el c√≥digo "extranjero" y unirme a un nuevo equipo?</a></li>
<li><a href="../441358/index.html">Lanz√≥ el primer m√≥dulo de aterrizaje lunar comercial Beresheet</a></li>
<li><a href="../441360/index.html">OpenShift - manualidades de sombrero rojo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>