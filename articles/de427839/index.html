<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüåæ üë®üèø‚Äçüîß ü§õüèø Benutzerautorisierung in Django durch GSSAPI und Delegierung von Benutzerrechten an den Server üòØ üçò üòá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor kurzem mussten meine Kollegen und ich eine transparente (SSO) Autorisierung in unserem Projekt implementieren. Jetzt gibt es einige Informationen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Benutzerautorisierung in Django durch GSSAPI und Delegierung von Benutzerrechten an den Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427839/">  Vor kurzem mussten meine Kollegen und ich eine transparente (SSO) Autorisierung in unserem Projekt implementieren.  Jetzt gibt es einige Informationen zu diesem Thema, insbesondere auf Russisch.  Aus diesem Grund wurde beschlossen, die Implementierung solcher Funktionen mit Nachkommen zu teilen. <br><br>  Die Aufgabe war also wie folgt: Es war notwendig, eine transparente Autorisierung √ºber GSSAPI vom Benutzer zum Server zu konfigurieren und dann auch die M√∂glichkeit zu haben, im Namen dieses Benutzers zur Datenbank zu wechseln. <br><a name="habracut"></a><br>  Wir hatten: <br><br><ul><li>  konfigurierter Kerberos + LDAP-Server </li><li>  PostgreSQL-Server, der ausschlie√ülich f√ºr die Autorisierung durch GSSAPI konfiguriert ist </li><li>  Django + UWSGI + Nginx-Anwendungsserver mit konfiguriertem Kerberos </li></ul><br>  Urspr√ºnglich bestand die Idee darin, die Benutzerautorisierung in der Anwendung an den Webserver zu delegieren, die GSSAPI-Autorisierung darauf einzurichten und Django anzugeben, dass wir mit RemoteUser arbeiten w√ºrden.  Als Teil dieser Beschreibung werde ich nicht dar√ºber sprechen, wie Nginx f√ºr die Arbeit mit GSSAPI konfiguriert wird und Django die Autorisierung an einen Webserver delegiert. Dies ist ein gut dokumentierter Teil, und es gibt viele Artikel dazu.  Nach dem Tuning und den Tests haben wir festgestellt, dass dies absolut nicht das ist, was wir brauchen.  Ja, wir k√∂nnen den Benutzerprinzipalnamen autorisieren und abrufen, haben jedoch keine Rechte, im Namen dieses Benutzers etwas zu tun. <br><br>  Dann haben wir versucht, im Internet etwas Wertvolles zu finden.  Sie waren relativ erfolgreich und die folgenden Pakete f√ºr Django wurden gefunden: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">django-kerberos</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">django-auth-spnego</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">django-auth-kerbero</a> .  Tats√§chlich haben alle diese Pakete das Gleiche getan, einige wurden lange Zeit nicht aktualisiert und mussten lange Zeit "mit einem Tamburin tanzen", damit zumindest etwas funktionierte.  Sie boten die gleiche Funktionalit√§t wie das Nginx-Bundle (GSSAPI) + Django (RemouteUser).  Alle haben geholfen, das Problem mit ihrem Quellcode zu l√∂sen. <br><br>  Als n√§chstes wurden die folgenden Pakete f√ºr die Arbeit mit GSSAPI in Python gefunden: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ccs-pykerberos</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">python-gssapi</a> . Tats√§chlich importieren sie die Implementierung der Standards RFC2744 und RFC4559 in Python.  Mit dem Paket ccs-pykerberos haben wir es gerade geschafft, die beabsichtigte Funktionalit√§t zu implementieren. Dann werde ich einen kleinen Code zeigen, in dem die Kommunikation mit LDAP und dem Benutzer implementiert ist, sowie eine Abfrage an die Datenbank in seinem Namen. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.shortcuts <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TemplateResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kerberos <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 def <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(request): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.META: kind, initial_client_token = request.META[<span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span>].split(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> kind == <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span>: service = <span class="hljs-string"><span class="hljs-string">'HTTP@django-server-pricipal.che.ru'</span></span> _ignore_result, krb_context = kerberos.authGSSServerInit(service) kerberos.authGSSServerStep(krb_context, initial_client_token) principal = kerberos.authGSSServerUserName(krb_context) _ignore_result = kerberos.authGSSServerStoreDelegate(krb_context) conn = psycopg2.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>( host=<span class="hljs-string"><span class="hljs-string">'postgresql-server-host'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=principal, dbname=<span class="hljs-string"><span class="hljs-string">'request-db'</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> = conn.<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("SELECT version()") records = <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: unauthorized_template_name = <span class="hljs-string"><span class="hljs-string">'gssapi_test/unauthorized.html'</span></span> response = TemplateResponse(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, status=<span class="hljs-number"><span class="hljs-number">401</span></span>) response[<span class="hljs-string"><span class="hljs-string">'WWW-Authenticate'</span></span>] = <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response content = {<span class="hljs-string"><span class="hljs-string">'records'</span></span>: records} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, content)</code> </pre> <br>  Zuerst m√ºssen wir pr√ºfen, ob der Autorisierungsheader an uns √ºbergeben wurde. Wenn nicht, sollten wir den Header mit Negotiate als Antwort senden und erneut auf das Token des Negotiate-Benutzers warten.  Dieser Token sieht aus wie ein gro√ües Fu√ütuch, das in base64 codiert ist.  Nach Erhalt des Tokens initialisieren (autorisieren) wir den Server unserer Anwendung im LDAP-Dienst mit der Funktion authGSSServerInit ().  Als N√§chstes autorisieren wir den LDAP-Dienst im Namen des Benutzers mithilfe der Funktion authGSSServerStep () nur f√ºr das Token, das vom Header empfangen wurde.  Dann erhalten wir den Principal des Benutzers, den wir als Benutzer verwenden, wenn wir die Abfrage in der Datenbank ausf√ºhren.  Au√üerdem m√ºssen wir einen Kerberos-Bitel-Cache erstellen, der automatisch verwendet wird, um uns in PostgreSQL, der authGSSServerStoreDelegate () -Funktion, zu autorisieren.  Diese Funktion ist nur in der neuesten Version dieses Pakets verf√ºgbar, daher m√ºssen Sie Ihre Quellen mit git und build klonen. <br><br>  Der Browser sollte so konfiguriert sein, dass Negotiate zur√ºckgegeben wird. Standardm√§√üig ist diese Option deaktiviert.  Alle Tests wurden unter Firefox in CentOS7 durchgef√ºhrt, und CentOS7 wurde auf allen Servern installiert. <br><br>  Au√üerdem haben wir m√∂glicherweise ein Problem, bei dem der von unserer Funktion generierte Ticket-Cache f√ºr unseren Prozess nicht sichtbar ist und wir dementsprechend feststellen, dass der Benutzer nicht in GSSAPI autorisiert wurde.  Es wird gel√∂st, indem das Ticket-Caching in krb5.conf festgelegt wird.  F√ºr alle F√§lle gebe ich ein Beispiel f√ºr unsere Konfiguration: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/krb5.conf</b> <div class="spoiler_text"><pre> <code class="python hljs">includedir /etc/krb5.conf.d/ includedir /var/lib/sss/pubconf/krb5.include.d/ [libdefaults] default_realm = DOMAIN.RU dns_lookup_realm = false dns_lookup_kdc = false rdns = false ticket_lifetime = <span class="hljs-number"><span class="hljs-number">24</span></span>h forwardable = true udp_preference_limit = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    #default_ccache_name = KEYRING:persistent:%{uid} #    KRB5_KTNAME     default_keytab_name = FILE:/etc/httpd/http.keytab [realms] DOMAIN.RU = { kdc = ldap-server-host.domain.ru:88 master_kdc = ldap-server-host.domain.ru:88 admin_server = ldap-server-host.domain.ru:749 kpasswd_server = ldap-server-host.domain.ru:464 default_domain = domain.ru pkinit_anchors = FILE:/etc/domain/ca.crt } [domain_realm] .domain.ru = DOMAIN.RU domain.ru = DOMAIN.RU .domain.ru = DOMAIN.RU</span></span></code> </pre><br></div></div><br>  Dieser Code wurde erstellt, um zu verstehen, wie die Autorisierung und Delegierung von Rechten erfolgt. Mit diesem Wissen k√∂nnen Sie Autorisierungsdekoratoren und Kommunikations-Backlinks mit der Datenbank erstellen.  Das ccs-pykerberos-Paket wurde von Apple f√ºr seine internen Anforderungen entwickelt. Ich werde einen Link zu ihrem Code bereitstellen, wo sie ihn verwenden.  Er hat uns sehr geholfen zu verstehen, dass sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ccs-calendarserver / twistedcaldav / authkerb.py entwickelt haben</a> <br><br><h4>  N√ºtzliche Links </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfigurieren Sie Kerberos + LDAP</a> </li><li>  <a href="">Implementierung einer √§hnlichen Aufgabe in Java</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfigurieren von nginx f√ºr SPNEGO</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Spezifikation RFC2744</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RFC4559 Spezifikation f√ºr SPNEGO</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427839/">https://habr.com/ru/post/de427839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427821/index.html">Dell Inspiron 5570: Kosteng√ºnstiger Laptop f√ºr Heim und B√ºro</a></li>
<li><a href="../de427825/index.html">Slurm-2: der Anfang. Arbeitsplan. Docker: Ger√§t, Docker-Datei, Docker-Compose</a></li>
<li><a href="../de427829/index.html">Supervising oder Outsourcing? Das ist die Frage</a></li>
<li><a href="../de427833/index.html">Bericht der Joker-Konferenz 2018</a></li>
<li><a href="../de427837/index.html">Die ersten Tage im Entwicklungsteam - so wie es bei uns passiert</a></li>
<li><a href="../de427841/index.html">Magic Leap Scam</a></li>
<li><a href="../de427843/index.html">Wie man richtig und falsch schl√§ft</a></li>
<li><a href="../de427845/index.html">Wie man eine Million Sterne in ein iPhone passt</a></li>
<li><a href="../de427847/index.html">Neugier und Aufschub beim maschinellen Lernen</a></li>
<li><a href="../de427849/index.html">Gerade mit TM. v3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>