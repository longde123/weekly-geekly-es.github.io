<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëñ üßëüèº üìõ 50 tons de toco * Recep√ß√£o de hardware de sinais codificados em PWM por microcontroladores Microchip üà¥ üßï üíõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* NIP - Perif√©ricos independentes de n√∫cleo em microcontroladores de microchip, tamb√©m conhecidos como CIP - Core Independent Peripheral. 

 Parte 4 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>50 tons de toco * Recep√ß√£o de hardware de sinais codificados em PWM por microcontroladores Microchip</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401541/"><div style="text-align:center;"><img src="https://habrastorage.org/files/344/eea/f79/344eeaf79b9a424fb5c5272f4506a24f.JPG" width="300"></div><br>  * NIP - Perif√©ricos independentes de n√∫cleo em microcontroladores de microchip, tamb√©m conhecidos como CIP - Core Independent Peripheral. <br><br><h1>  Parte 4 </h1><br>  Os artigos anteriores [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a> ], [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2</a> ] e [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3</a> ] foram dedicados aos microcontroladores Microchip Perif√©ricos dos N√∫cleos Independentes (NEV): c√©lulas l√≥gicas configur√°veis, portas de entrada / sa√≠da com uma fun√ß√£o limitadora de corrente e ADCs com um computador; alguns recursos desses perif√©ricos foram mostrados.  Deixe-me lembr√°-lo de que a independ√™ncia n√£o est√° impl√≠cita no tipo de n√∫cleo PIC dos microcontroladores (BaseLine, Mid-Range, Enhanced Mid-Range, PIC18, 16-, 32 bits), mas na opera√ß√£o do n√∫cleo, ou seja,  execu√ß√£o independente de tarefas atribu√≠das √† periferia do estado da CPU.  Esses perif√©ricos, e em particular a possibilidade de configur√°-lo para colabora√ß√£o e s√≠ntese de fun√ß√µes de hardware, s√£o projetados para descarregar a parte do software e reduzir o consumo de energia. <br><br>  Neste breve artigo, quero mostrar exemplos da implementa√ß√£o da recep√ß√£o de interfaces de comunica√ß√£o n√£o personalizadas ‚Äúpersonalizadas‚Äù usando os Perif√©ricos Independentes do Kernel. <br><a name="habracut"></a><br>  A codifica√ß√£o de informa√ß√µes PWM √© muito comum quando sinais discretos, log. 1 e log. 0, s√£o codificados pela largura do pulso.  Considere a op√ß√£o de receber e decodificar esses sinais usando os controladores PIC independentes de n√∫cleo perif√©rico. <br><br><h2>  Decodifica√ß√£o PWM do sinal do sensor AM2302 </h2><br>  Em projetos de bricolage, o sensor de temperatura e umidade DHT22 (AM2302) √© frequentemente usado.  O sensor possui 3 sa√≠das, a informa√ß√£o √© transmitida atrav√©s de um √∫nico fio.  Em resposta a uma solicita√ß√£o (n√≠vel baixo com dura√ß√£o de aproximadamente 1ms), o sensor responde com um bit de in√≠cio e, em seguida, uma sequ√™ncia de 40 bits, onde as informa√ß√µes s√£o codificadas na dura√ß√£o do pulso: log.  "0" - impulso 30mk seg, log.  "1" - 70mk seg (valores t√≠picos).  A resposta do sensor cont√©m 5 bytes: 2 bytes de dados de umidade, 2 bytes de temperatura e 1 byte de controle. <br><br><img src="https://habrastorage.org/files/d89/ab5/d3a/d89ab5d3a7204c46aeb299ace4023003.png"><br>  <i>Fig. 1.</i>  <i>Explica√ß√µes do princ√≠pio de gera√ß√£o de sinal do sensor DHT22.</i> <br><br>  A rede tem muitos exemplos de como trabalhar com esses sensores no Arduino.  Algumas implementa√ß√µes de bibliotecas usam constru√ß√µes como: <br><br><pre><code class="hljs ruby">loopCnt = TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(PIN) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(--loopCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ErrorTimeout; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loopCnt &lt; cntOne) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">1</span></span> ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> bit =<span class="hljs-number"><span class="hljs-number">0</span></span> ‚Ä¶ }</code> </pre> <br>  Em tais implementa√ß√µes, vejo os seguintes problemas: <br><br>  - o programa para todo o tempo de medi√ß√£o (&gt; 5 ms) "trava" no c√≥digo de medi√ß√£o; <br>  - a ocorr√™ncia de uma interrup√ß√£o suficientemente longa interromper√° a leitura dos dados do sensor; <br>  - poss√≠veis problemas com o trabalho em baixa freq√º√™ncia do microcontrolador; <br><br>  O algoritmo do programa de tais solu√ß√µes tem aproximadamente a seguinte forma (ver Fig. 2) <br><br><img src="https://habrastorage.org/files/c97/8c0/d3f/c978c0d3f5444843aa4caa67c2d62f14.png"><br>  <i>Fig.</i>  <i>2. Um algoritmo para receber e decodificar sinais do sensor de forma program√°tica.</i> <br><br>  A seguir, √© considerada uma variante da recep√ß√£o / decodifica√ß√£o de hardware do protocolo com sobrecarga m√≠nima de software. <br><br>  A id√©ia √© isolar pulsos de clock do fluxo de bits, seguidos pela dire√ß√£o do sinal original e pulsos de clock no m√≥dulo de hardware SPI.  Nesse caso, o programa do microcontrolador pode levar apenas sequencialmente 5 bytes de dados do SPI. <br><br>  Parte do CIP √© um cron√¥metro com a capacidade de acionar eventos (altera√ß√µes no status de entrada ou outros perif√©ricos).  I.e.  alterar o estado de entrada pode acionar um temporizador, consulte o sinal TMR6 na Fig. 3.  Quando o cron√¥metro atinge o valor ajustado, sua contagem para e o cron√¥metro est√° no estado TMR6 = PR6 (registro de per√≠odo PR).  O status do timer pode ser uma entrada para uma c√©lula l√≥gica configur√°vel (CLC, consulte a parte 1). <br><br>  Assim, usando um timer e c√©lulas l√≥gicas, podemos gerar um sinal adequado para aplicar √† entrada de rel√≥gio do SCK do m√≥dulo SPI.  Para extrair informa√ß√µes, a dura√ß√£o desse bloco deve ter um valor m√©dio entre a dura√ß√£o de zero e um.  Ent√£o o SPI pode fixar o bit de acordo com a deteriora√ß√£o do bloco (veja a Fig. 3 sinal SCK). <br><br>  O sinal do sensor ter√° pulsos falsos gerados a partir da solicita√ß√£o e pulsos de in√≠cio.  Para que esses pulsos n√£o interfiram na opera√ß√£o, voc√™ precisa habilitar o SPI apenas pela dura√ß√£o dos pulsos de informa√ß√£o ou cortar pulsos desnecess√°rios.  Tamb√©m podemos resolver esse problema usando o CIP. <br><br>  Outro temporizador atua como um contador de pulsos com comuta√ß√£o durante a recess√£o: escreva o n√∫mero 2 no registro de per√≠odo, o temporizador conta os 2 primeiros pulsos (veja o sinal TMR4 na Fig. 3) e interrompe a contagem (veja o sinal EN na Fig. 3), que atrav√©s de o bloco de c√©lulas l√≥gicas permite a emiss√£o dos pulsos restantes para o SPI de entrada. <br><br><img src="https://habrastorage.org/files/063/871/47f/06387147f53f4a24b875feee752b271b.png"><br>  <i>Fig. 3.</i>  <i>Diagramas explicando a recep√ß√£o do sinal do sensor DHT22.</i> <br><br>  A fun√ß√£o l√≥gica da gera√ß√£o do sinal SCK √© implementada em uma c√©lula l√≥gica (CLC), o circuito completo na configura√ß√£o AND-OR √© mostrado na Fig. 4. <br><br>  A sa√≠da da c√©lula l√≥gica √© conectada √† entrada SCK e o sinal do sensor DHT22 √© conectado ao MOSI do m√≥dulo SPI.  Todas as conex√µes s√£o feitas dentro do microcontrolador (Fig. 5).  Para monitoramento e depura√ß√£o, os sinais podem ser enviados para as portas do microcontrolador. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f99/2ab/63f/f992ab63fbc048a1ae5b6dad31748263.png"></div><br>  <i>Fig. 4.</i>  <i>Configura√ß√£o da c√©lula l√≥gica do CLC no microcontrolador PIC.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b27/d35/f60/b27d35f60fc04de9890ed357bb84309d.png"></div><br>  <i>Fig.</i>  <i>5. A estrutura completa da configura√ß√£o da periferia.</i> <br><br>  Se parece que 2 temporizadores para a tarefa de decodificar o protocolo do sensor s√£o um desperd√≠cio de recursos, um contador de at√© dois pode ser "coletado" em c√©lulas l√≥gicas CLC livres. <br><br>  No total, a tarefa de decodifica√ß√£o se resume a um algoritmo muito simples: o microcontrolador e seus perif√©ricos s√£o inicializados, se necess√°rio, o m√≥dulo SPI √© ativado e uma solicita√ß√£o de medi√ß√£o √© gerada (log. "0" por ~ 1ms). <br><br>  Resta ler os dados do buffer quando ocorre uma interrup√ß√£o do SPI. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/434/536/fef/434536fef59a4b569a45aa334d9df535.png"></div><br>  <i>Fig. 6.</i>  <i>O algoritmo para trabalhar com o sensor DHT22 ao usar o tronco.</i> <br><br><img src="https://habrastorage.org/files/966/2d4/798/9662d4798e9f4d289957d2c6ff619898.png"><br>  <i>Fig. 7.</i>  <i>Sinais das portas do microcontrolador.</i>  <i>Sinal SSP1IF - interrup√ß√µes na recep√ß√£o de um byte pelo m√≥dulo SPI.</i> <br><br>  A Figura 7 mostra os diagramas de sinal, em que: <br><blockquote>  DHT (dat) - sinal na linha de sinal do sensor - alimenta a entrada do m√≥dulo MOSI SPI; <br>  TMR6! = RP6 - rel√≥gio dedicado - envia para o SCK do m√≥dulo SPI; <br>  SSP1IF - sinal de interrup√ß√£o (prontid√£o dos dados no buffer SPI) - na verdade, esse sinal mostra a carga do n√∫cleo do microcontrolador - lendo os dados do resultado. </blockquote><br><h2>  Decodificando outros protocolos PWM </h2><br>  Protocolos PWM de "fio √∫nico" similares s√£o usados ‚Äã‚Äãem controles remotos por infravermelho para eletrodom√©sticos.  Frequentemente, durante a transmiss√£o por infravermelho, a codifica√ß√£o pela posi√ß√£o do pulso √© usada quando a dura√ß√£o √© constante e a pausa √© vari√°vel.  Essa op√ß√£o tamb√©m √© chamada de "Codifica√ß√£o de pausa vari√°vel".  De fato, esta √© a mesma codifica√ß√£o PWM, mas com um sinal invertido.  Na presen√ßa de c√©lulas l√≥gicas, a invers√£o n√£o √© um problema; al√©m disso, os receptores de infravermelho invertem o sinal recebido.  Na fig.  A Figura 8 mostra os sinais ap√≥s o receptor receber de dois consoles diferentes. <br><br><img src="https://habrastorage.org/files/6a8/6ca/62e/6a86ca62ec704b029650cfc4cb1d70a8.png"><br><img src="https://habrastorage.org/files/739/1a1/4bb/7391a14bb1764eef9a3d36d4f19c40c9.png"><br>  <i>Fig. 8.</i>  <i>Op√ß√µes de codifica√ß√£o para controles remotos por infravermelho.</i> <br><br>  Ambos os consoles t√™m protocolos diferentes, mas esses protocolos s√£o facilmente decodificados da maneira descrita acima, a √∫nica coisa √© que √© necess√°rio determinar o in√≠cio do envio para sincronizar a inclus√£o do SPI, pois o receptor de IR pode capturar interfer√™ncias. <br><br><img src="https://habrastorage.org/files/205/4b6/99a/2054b699a4244346990f8748f65733df.png"><br><img src="https://habrastorage.org/files/c3b/4f0/49c/c3b4f049ce3b408b9ff8715cdf017579.png"><br>  <i>Fig.</i>  <i>9. Sinais decodificados usando SPI.</i> <br><br>  Nem todos os controles remotos IR possuem codifica√ß√£o PWM.  Alguns protocolos, por exemplo RC5, possuem codifica√ß√£o de fase (o c√≥digo Manchester, ‚Äú0‚Äù √© transmitido como 10 e ‚Äú1‚Äù como 01) [4].  A decodifica√ß√£o do c√≥digo de Manchester usando a periferia de um kernel independente j√° foi considerada anteriormente na primeira parte [1]. <br><br><h2>  Sum√°rio </h2><br>  Em vez de quase 100% da carga da CPU do microcontrolador para a tarefa de decodificar o protocolo PWM na vers√£o Arduino (sim, eu sei, o problema pode ser resolvido com mais efici√™ncia usando m√≥dulos de captura ou outros perif√©ricos), transferimos a recep√ß√£o do pacote de informa√ß√µes para o hardware.  A frente do sinal de entrada inicia o timer, o status do timer determina a sa√≠da do bloco de c√©lulas l√≥gicas, a sa√≠da da c√©lula l√≥gica √© alimentada ao SPI. <br><br>  O uso de perif√©ricos independentes do n√∫cleo permite otimizar o uso de recursos, transferir algumas das tarefas para o hardware, simplificar o c√≥digo e reduzir o consumo. <br><br><h2>  Literatura </h2><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√©lulas l√≥gicas configur√°veis ‚Äã‚Äãnos controladores PIC.</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">50 tons de toco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Portas de entrada / sa√≠da</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">50 tons de toco.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ADC e ADC com computador microcontrolador Microchip</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sbprojects.com/knowledge/ir/rc5.php</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt401541/">https://habr.com/ru/post/pt401541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt401529/index.html">Pergunte a Ethan: o universo pode ser considerado vivo?</a></li>
<li><a href="../pt401531/index.html">No √¢mbito do projeto ‚ÄúCi√™ncia n√£o √© farinha‚Äù, ser√° realizada uma discuss√£o sobre o tema: ‚ÄúSexo, drogas, rock and roll: depend√™ncia ou vida?‚Äù</a></li>
<li><a href="../pt401533/index.html">Dificuldades na escolha de uma placa de v√≠deo de or√ßamento no exemplo da RX 460</a></li>
<li><a href="../pt401535/index.html">Col√¥nia. Cap√≠tulo 4: a antiga base militar</a></li>
<li><a href="../pt401539/index.html">Teste de estresse da GPU NVidia na transcodifica√ß√£o de transmiss√£o ao vivo</a></li>
<li><a href="../pt401543/index.html">Usando conjuntos de dados do portal de dados abertos russo data.gov.ru</a></li>
<li><a href="../pt401545/index.html">Chef, vejo voc√™. Intel Unite - Ferramenta de comunica√ß√£o profissional</a></li>
<li><a href="../pt401549/index.html">Estados ex√≥ticos da mat√©ria, LCDs e o futuro da √°gua</a></li>
<li><a href="../pt401555/index.html">Os rob√¥s dom√©sticos mais √∫teis</a></li>
<li><a href="../pt401561/index.html">Est√° longe de ir ao STB chin√™s?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>