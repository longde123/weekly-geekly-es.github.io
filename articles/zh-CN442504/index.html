<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🃏 🛡️ 🤲🏾 PHP Xdebug代理：当Xdebug的标准功能不够用时 🧑🏻‍🤝‍🧑🏻 👨‍👩‍👧 🚡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="为了调试PHP程序，通常使用Xdebug 。 但是，IDE和Xdebug的标准功能并不总是足够的。 使用Xdebug代理-pydbgpproxy可以解决一些问题，但还不是全部。 因此，我基于amphp异步框架实现了PHP Xdebug代理 。 


 削减后，我将告诉您pydbgpproxy的问题是...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP Xdebug代理：当Xdebug的标准功能不够用时</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442504/"><p><img src="https://habrastorage.org/webt/qr/30/pd/qr30pdoglljz7da1c8uooyutxu8.jpeg" alt="PHP Xdebug代理：当Xdebug的标准功能不够用时"></p><br><p> 为了调试PHP程序，通常使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Xdebug</a> 。 但是，IDE和Xdebug的标准功能并不总是足够的。 使用Xdebug代理-pydbgpproxy可以解决一些问题，但还不是全部。 因此，我基于amphp异步框架实现了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Xdebug代理</a> 。 </p><br><p> 削减后，我将告诉您pydbgpproxy的问题是什么，它缺少什么以及为什么我没有对其进行修改。 我还将通过示例说明PHP Xdebug代理的工作原理，并展示如何扩展它。 <a name="habracut"></a></p><br><h2 id="pydbgpproxy-vs-php-xdebug-proxy">  Pydbgpproxy vs PHP Xdebug代理 </h2><br><p>  Xdebug代理是IDE和Xdebug之间的中间服务（代理从Xdebug到IDE的请求，反之亦然）。 通常，它用于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">多用户调试</a> 。 这是当您有一个Web服务器和几个开发人员时。 </p><br><p> 作为代理，通常使用pydbgpproxy。 但是他有一些问题： </p><br><ul><li> 没有官方页面； </li><li> 很难找到下载位置； 事实证明，这可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>完成-突然，Python远程调试客户端； </li><li> 我没有找到官方资料库； </li><li> 作为上一段的结果，不清楚将拉取请求提交到何处； </li><li> 顾名思义，代理是用Python编写的，并不是所有PHP开发人员都知道，这意味着扩展它是一个问题。 </li><li> 上一段的继续：如果PHP中有任何代码，并且需要在代理中使用，则必须将其移植到Python，并且重复代码始终不是很好。 </li></ul><br><p> 在GitHub和Internet上搜索用PHP编写的Xdebug代理均未返回任何结果。 所以我写了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Xdebug代理</a> 。 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">后台</a> ，我使用了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">amphp</a>异步框架。 </p><br><p>  PHP Xdebug代理相对于pydbgpproxy的主要优点： </p><br><ul><li>  PHP Xdebug代理使用PHP开发人员熟悉的语言编写，这意味着： <br><ul><li> 解决其中的问题更容易； </li><li> 更容易扩展； </li></ul></li><li>  PHP Xdebug代理具有一个公共存储库，这意味着： <br><ul><li> 您可以根据需要分叉并完成它； </li><li> 您可以发送缺少功能或问题解决方案的请求请求。 </li></ul></li></ul><br><h2 id="kak-rabotat-s-php-xdebug-proxy"> 如何使用PHP Xdebug代理 </h2><br><h3 id="ustanovka"> 安装方式 </h3><br><p> 可以通过<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">composer</a>将PHP Xdebug代理作为dev依赖项安装： </p><br><pre><code class="bash hljs">composer.phar require mougrim/php-xdebug-proxy --dev</code> </pre> <br><p> 但是，如果您不想将额外的依赖项拖到您的项目中，则可以通过相同的编辑器将PHP Xdebug代理作为项目安装： </p><br><pre> <code class="bash hljs">composer.phar create-project mougrim/php-xdebug-proxy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-xdebug-proxy</code> </pre> <br><p>  PHP Xdebug代理是可扩展的，但默认情况下需要<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ext-dom</a> （在PHP中默认启用扩展名）来解析XML，而<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">amphp / log则</a>用于异步<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">日志记录</a> ： </p><br><pre> <code class="bash hljs">composer.phar require amphp/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-string"><span class="hljs-string">'^1.0.0'</span></span></code> </pre> <br><h3 id="zapusk"> 发射 </h3><br><p><img src="https://habrastorage.org/webt/jb/n4/dc/jbn4dcyqwpirx7koyqjzwxfwozc.jpeg" alt="PHP Xdebug代理"></p><br><p> 代理开始如下： </p><br><pre> <code class="bash hljs">bin/xdebug-proxy</code> </pre> <br><p> 代理将从默认设置开始： </p><br><pre> <code class="plaintext hljs">Using config path /path/to/php-xdebug-proxy/config [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use default ide: 127.0.0.1:9000 array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use predefined ides array ( 'predefinedIdeList' =&gt; array ( 'idekey' =&gt; '127.0.0.1:9000', ), ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][IdeRegistration] Listening for new connections on '127.0.0.1:9001'... array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][Xdebug] Listening for new connections on '127.0.0.1:9002'... array ( ) array ( )</code> </pre> <br><p> 从日志中，您可以看到默认代理： </p><br><ul><li> 侦听<code>127.0.0.1:9001</code>的IDE登录连接； </li><li> 监听<code>127.0.0.1:9002</code>的Xdebug连接; </li><li> 使用<code>127.0.0.1:9000</code>作为默认IDE和带有idekey键的预定义IDE。 </li></ul><br><h3 id="konfiguraciya"> 构型 </h3><br><p> 如果要配置监听端口等，则可以指定设置文件夹的路径。 只需复制<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">config</a>文件夹： </p><br><pre> <code class="bash hljs">cp -r /path/to/php-xdebug-proxy/config /your/custom/path</code> </pre> <br><p> 设置文件夹中有三个文件： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>config.php</code></a> ： <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'xdebugServer'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// host:port    Xdebug 'listen' =&gt; '127.0.0.1:9002', ], 'ideServer' =&gt; [ //  proxy    IDE,     IDE  , //    IDE  ,     . // IDE   ,  proxy    . 'defaultIde' =&gt; '127.0.0.1:9000', //  IDE    'idekey' =&gt; 'host:port', //   IDE  ,     . //  IDE ,   proxy  , //           proxy. 'predefinedIdeList' =&gt; [ 'idekey' =&gt; '127.0.0.1:9000', ], ], 'ideRegistrationServer' =&gt; [ // host:port     IDE, //     IDE,     . 'listen' =&gt; '127.0.0.1:9001', ], ];</span></span></code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>logger.php</code></a> ：您可以配置记录器； 该文件应返回一个对象，该对象是<code>\Psr\Log\LoggerInterface</code>的实例，默认值为<code>\Monolog\Logger</code> with <code>\Amp\Log\StreamHandler</code> （用于非阻塞记录），将日志显示到stdout； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>factory.php</code></a> ：您可以配置代理中使用的类； 该文件应返回一个对象，该对象是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\Factory</code></a>的实例，默认值为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\DefaultFactory</code></a> 。 </li></ul><br><p> 复制文件后，您可以编辑并运行代理： </p><br><pre> <code class="bash hljs">bin/xdebug-proxy --configs=/your/custom/path/config</code> </pre> <br><h3 id="otladka"> 侦错 </h3><br><p> 关于如何使用Xdebug调试代码的文章很多。 我会指出要点。 </p><br><p> 在php.ini中，以下设置应位于<code>[xdebug]</code>部分中（如果它们与标准设置不同，请更正它们）： </p><br><ul><li>  idekey = idekey </li><li>  remote_host = 127.0.0.1 </li><li>  remote_port = 9002 </li><li>  remote_enable =开 </li><li>  remote_autostart =开 </li><li>  remote_connect_back =关 </li></ul><br><p> 然后，您可以运行调试的PHP代码： </p><br><pre> <code class="bash hljs">php /path/to/your/script.php</code> </pre> <br><p> 如果一切正确，那么调试将从IDE中的第一个断点开始。 几个开发人员在php-fpm模式下进行调试超出了本文的范围，但例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处进行了</a>描述。 </p><br><h2 id="rasshirenie-funkciy-proxy"> 扩展代理功能 </h2><br><p> 上面我们检查的所有内容pydbgpproxy都可以达到某一程度。 </p><br><p> 现在让我们谈谈PHP Xdebug代理中最有趣的部分。 可以使用您自己的工厂（在<code>factory.php</code>配置中创建，请参见上文）扩展代理。 工厂必须实现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\Factory</code></a>接口。 </p><br><p> 最强大的是所谓的请求准备器。 他们可以修改从Xdebug到IDE的请求，反之亦然。 要添加查询<code>Factory\DefaultFactory::createRequestPreparers()</code> ，必须重写<code>Factory\DefaultFactory::createRequestPreparers()</code>方法。 该方法返回实现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>RequestPreparer\RequestPreparer</code></a>接口的对象数组。 当将Xdebug的请求代理到IDE时，它们以直接顺序执行；当将IDE的请求代理到Xdebug时，请求被反向。 </p><br><p> 查询处理程序可用于例如更改文件的路径（在断点和可执行文件中）。 </p><br><h3 id="debag-perepisannyh-faylov"> 调试覆盖的文件 </h3><br><p> 为了举例说明准备者，我将做一点题外话。 在单元测试中，我们使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">软包装</a> （ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a> ）。 软模拟允许您在测试中替换函数，静态方法，常量等，是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">runkit</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">uopz</a>的替代方法。 通过即时重写PHP文件来工作。 同样， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AspectMock</a>仍然有效。 </p><br><p> 但是Xdebug和IDE的标准功能允许您调试重写的文件（具有不同的路径），而不是原始文件。 </p><br><p> 让我们仔细看看在测试中使用软模拟的调试问题。 首先，以PHP代码在本地执行为例。 </p><br><p> 第一个困难出现在设置断点（断点）的阶段。 在IDE中，它们安装在原始文件中，而不是重写文件中。 要通过IDE设置断点，您需要找到实际的重写文件。 由于每次更改原始文件都会创建一个新的重写文件，因此事实变得更加复杂，也就是说，对于每个唯一文件内容，都会有一个唯一的重写文件。 </p><br><p> 可以通过调用<code>xdebug_break()</code>函数来解决此问题，该函数类似于设置断点。 在这种情况下，无需搜索重写的文件。 </p><br><p> 现在考虑情况更加复杂：应用程序在远程计算机上运行。 </p><br><p> 在这种情况下，您可以使用重写的文件挂载该文件夹，例如通过SSHFS。 如果文件夹的本地和远程路径不同，则仍然需要在IDE中注册映射。 </p><br><p> 无论哪种方式，此方法都与通常的方法略有不同，并且仅允许您调试复制的文件，而不能调试原始文件。 但是我仍然想编辑和调试相同的原始文件。 </p><br><p>  AspectMock通过<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">启用调试模式</a>而不禁用它来解决该问题： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $options = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>])) { $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>] = []; } $options[<span class="hljs-string"><span class="hljs-string">'debug'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>][] = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::init($options); }</code> </pre> <br><p> 在一个简单的测试示例中，调试模式的速度要慢20％，但我没有足够的AspectMock测试来更准确地估计它的速度。 如果您在AspectMock上进行了许多测试，如果您在评论中分享比较信息，我将非常高兴。 </p><br><h3 id="ispolzovanie-xdebug-s-soft-mocks"> 结合使用Xdebug和轻弹 </h3><br><p><img src="https://habrastorage.org/webt/eu/3d/ui/eu3duipif0jihrhzwlquhfpywuc.jpeg" alt="Xdebug +软装"></p><br><p> 现在问题已经很清楚了，请考虑如何使用PHP Xdebug代理解决问题。 主要部分在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>RequestPreparer\SoftMocksRequestPreparer</code></a> 。 </p><br><p> 在类构造函数中，定义到soft-mocks初始化脚本的路径并运行它（假定将soft-mocks作为依赖关系进行连接，但是任何路径都可以传递给构造函数）： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerInterface $logger, string $initScript = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$initScript) { $possibleInitScriptPaths = [ <span class="hljs-comment"><span class="hljs-comment">// proxy   , soft-mocks —    __DIR__.'/../../vendor/badoo/soft-mocks/src/init_with_composer.php', // proxy  soft-mocks    __DIR__.'/../../../../badoo/soft-mocks/src/init_with_composer.php', ]; foreach ($possibleInitScriptPaths as $possiblInitScriptPath) { if (file_exists($possiblInitScriptPath)) { $initScript = $possiblInitScriptPath; break; } } } if (!$initScript) { throw new Error("Can't find soft-mocks init script"); } //  soft-mocks (       ..) require $initScript; }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/9p/8t/u7/9p8tu7eatpdhaewvfxvv2ossunu.jpeg" alt="Xdebug +软包装：从Xdebug到IDE"></p><br><p> 要准备从Xdebug到IDE的请求，您需要用原始文件替换重写文件的路径： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToIde</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XmlDocument $xmlRequest, string $rawRequest)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context = [ <span class="hljs-string"><span class="hljs-string">'request'</span></span> =&gt; $rawRequest, ]; $root = $xmlRequest-&gt;getRoot(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$root) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($root-&gt;getChildren() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { <span class="hljs-comment"><span class="hljs-comment">//         : // - 'stack': https://xdebug.org/docs-dbgp.php#stack-get // - 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message': https://xdebug.org/docs-dbgp.php#error-notification if (!in_array($child-&gt;getName(), ['stack', 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message'], true)) { continue; } $attributes = $child-&gt;getAttributes(); if (isset($attributes['filename'])) { //         ,      $filename = $this-&gt;getOriginalFilePath($attributes['filename'], $context); if ($attributes['filename'] !== $filename) { $this-&gt;logger-&gt;info("Change '{$attributes['filename']}' to '{$filename}'", $context); $child-&gt;addAttribute('filename', $filename); } } } }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/6h/qw/er/6hqwerwharffc9a_ylzobqxut9o.jpeg" alt="Xdebug +软包装：从IDE到Xdebug"></p><br><p> 要准备从IDE到Xdebug的请求，您需要用重写的路径替换原始文件的路径： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToXdebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $request, CommandToXdebugParser $commandToXdebugParser)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       [$command, $arguments] = $commandToXdebugParser-&gt;parseCommand($request); $context = [ 'request' =&gt; $request, 'arguments' =&gt; $arguments, ]; if ($command === 'breakpoint_set') { //    -f,          // . https://xdebug.org/docs-dbgp.php#id3 if (isset($arguments['-f'])) { $file = $this-&gt;getRewrittenFilePath($arguments['-f'], $context); if ($file) { $this-&gt;logger-&gt;info("Change '{$arguments['-f']}' to '{$file}'", $context); $arguments['-f'] = $file; //    $request = $commandToXdebugParser-&gt;buildCommand($command, $arguments); } } else { $this-&gt;logger-&gt;error("Command {$command} is without argument '-f'", $context); } } return $request; }</span></span></code> </pre> <br><p> 为了使查询<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\DefaultFactory</code></a>正常工作，您需要创建工厂类并从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\DefaultFactory</code></a>继承它，或实现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\Factory</code></a>接口。 对于软嘲笑， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>Factory\SoftMocksFactory</code></a>看起来像这样： </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SoftMocksFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return new SoftMocksConfig($config); } public function createRequestPreparers(LoggerInterface $logger, Config $config): array { $requestPreparers = parent::createRequestPreparers($logger, $config); return array_merge($requestPreparers, [$this-&gt;createSoftMocksRequestPreparer($logger, $config)]); } public function createSoftMocksRequestPreparer(LoggerInterface $logger, SoftMocksConfig $config): SoftMocksRequestPreparer { //     init-   return new SoftMocksRequestPreparer($logger, $config-&gt;getSoftMocks()-&gt;getInitScript()); } }</span></span></code> </pre> <br><p> 在这里，您需要自己的config类，以便您可以指定soft-mocks初始化脚本的路径。 它是什么，您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Config \ SoftMocksConfig中</a>看到。 </p><br><p> 剩下的只有一点：创建一个新的工厂并指出软嘲笑初始化脚本的路径。 可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>softMocksConfig</code></a>查看如何完成此操作。 </p><br><h3 id="neblokiruyuschiy-api"> 非阻塞API </h3><br><p> 正如我在上面所写，PHP Xdebug代理在后台使用amphp，这意味着必须使用非阻塞API来处理<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">I / O。</a>  Apmphp已经拥有许多实现此非阻塞API的组件。 如果要扩展PHP Xdebug代理并在多用户模式下使用它，请确保使用非阻塞API。 </p><br><h2 id="vyvody"> 结论 </h2><br><p>  PHP Xdebug代理仍然是一个相当年轻的项目，但是在Badoo中，它已经被积极地用于使用软模拟调试测试。 </p><br><p>  PHP Xdebug代理： </p><br><ul><li> 在多用户调试中替换pydbgpproxy； </li><li> 可以和小混蛋一起工作； </li><li> 可以扩展： <br><ul><li> 您可以替换来自IDE和Xdebug的文件的路径。 </li><li> 可以收集统计信息：在调试模式下，调试时至少可以使用可执行上下文（变量的值和可执行代码行）。 </li></ul></li></ul><br><p> 如果您将Xdebug代理用于除多用户调试以外的任何其他功能，请在注释中共享您的案例和您使用的Xdebug代理。 </p><br><p> 如果您使用pydbgpproxy或其他Xdebug代理，请尝试使用PHP Xdebug代理，告知您的问题，共享请求请求。 让我们一起开发项目！  :) </p><br><p>  PS感谢我的同事Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Makhrov</a> aka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">eZH</a>的代理<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">smdbgpproxy</a>的想法！ </p><br><h2 id="eschyo-raz-ssylki"> 再次链接 </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Xdebug代理</a> -Xdebug代理，将在本文中进行讨论； </li><li>  pydbgpproxy可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>下载-突然，Python远程调试客户端； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">amphp-</a>异步非阻塞PHP框架； </li><li> 模拟S工具： <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">软mo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AspectMock</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">uopz</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">运行工具包</a> 。 </li></ul></li></ul><br><p> 感谢您的关注！ </p><br><p> 我将很乐意提出意见和建议。 </p><br><p> 里纳特·阿赫玛德耶夫（Rinat Akhmadeev）  PHP开发人员 </p><br><p>  <strong>UPD</strong> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">将</a>文章<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">翻译</a>成英文出版。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442504/">https://habr.com/ru/post/zh-CN442504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442494/index.html">Figma组件和实例组织（以Userpic为例）</a></li>
<li><a href="../zh-CN442496/index.html">企业猪</a></li>
<li><a href="../zh-CN442498/index.html">C ++ Russia 2018会议的十大报告：完整的视频，幻灯片，评论</a></li>
<li><a href="../zh-CN442500/index.html">用于Kotlin的Detekt静态分析仪</a></li>
<li><a href="../zh-CN442502/index.html">我们将工作场所变成了卧铺，只需200美元</a></li>
<li><a href="../zh-CN442506/index.html">俄罗斯是否因非法交易个人数据而受到惩罚？</a></li>
<li><a href="../zh-CN442508/index.html">udalenka如何加速GitLab的创新</a></li>
<li><a href="../zh-CN442512/index.html">在ZomboDB的示例上自定义Django ORM</a></li>
<li><a href="../zh-CN442514/index.html">分布式系统。 设计模式。 书评</a></li>
<li><a href="../zh-CN442516/index.html">熊猫大数据分析指南</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>