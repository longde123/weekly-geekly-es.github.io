<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèª üç∫ üé¶ Sichere Interoperabilit√§t in verteilten Systemen üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ üë† üßúüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 

 Mein Name ist Alexey Solodky, ich bin PHP-Entwickler bei Badoo. Und heute werde ich eine Textversion meines Vortrags f√ºr das erste Bado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sichere Interoperabilit√§t in verteilten Systemen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413555/"><img src="https://habrastorage.org/webt/ag/m-/8r/agm-8r1daffwnqqhzqagmayd4uc.png" width="800"><br><br>  Hallo Habr! <br><br>  Mein Name ist Alexey Solodky, ich bin PHP-Entwickler bei Badoo.  Und heute werde ich eine Textversion meines Vortrags f√ºr das erste Badoo PHP Meetup ver√∂ffentlichen.  Ein Video dieses und anderer Berichte aus dem Mitap finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Jedes System, das aus mindestens zwei Komponenten besteht (und wenn Sie sowohl PHP als auch eine Datenbank haben, sind dies zwei Komponenten), ist bei der Interaktion zwischen diesen Komponenten einer ganzen Reihe von Risiken ausgesetzt. <br><br>  Die Plattformabteilung, in der ich arbeite, integriert neue interne Services in unsere Anwendung.  Und bei der L√∂sung dieser Probleme haben wir Erfahrungen gesammelt, die ich teilen m√∂chte. <br><br>  Unser Backend ist ein PHP-Monolith, der mit vielen Diensten interagiert (derzeit gibt es etwa 50 davon).  Dienste interagieren selten miteinander.  Die Probleme, √ºber die ich in diesem Artikel spreche, sind aber auch f√ºr die Microservice-Architektur relevant.  In diesem Fall interagieren die Dienste sehr aktiv miteinander. Je mehr Interaktion Sie haben, desto mehr Probleme haben Sie. <br><br>  √úberlegen Sie, was zu tun ist, wenn der Dienst abst√ºrzt oder langweilig wird, wie die Erfassung von Metriken organisiert wird und was zu tun ist, wenn Sie durch all das nicht gerettet werden. <br><a name="habracut"></a><br><h2>  Service-Absturz </h2><br>  Fr√ºher oder sp√§ter f√§llt der Server, auf dem Ihr Dienst installiert ist.  Es wird sicher passieren, und Sie k√∂nnen sich nicht dagegen verteidigen - verringern Sie nur die Wahrscheinlichkeit.  Sie k√∂nnen durch Hardware, Netzwerk, Code, erfolglose Bereitstellung entt√§uscht werden - alles.  Und je mehr Server Sie haben, desto h√§ufiger wird dies passieren. <br><br>  Wie k√∂nnen Sie Ihre Dienste in einer Welt √ºberleben lassen, in der Server st√§ndig abst√ºrzen?  Ein allgemeiner Ansatz zur L√∂sung dieser Problemklasse ist die Redundanz. <br><br>  Redundanz wird √ºberall auf verschiedenen Ebenen eingesetzt: von Eisen bis zu ganzen Rechenzentren.  Zum Beispiel RAID1 zum Schutz vor Festplattenausf√§llen oder ein Backup-Netzteil f√ºr Ihren Server im Falle eines Ausfalls des ersten.  Dieses Schema wird auch h√§ufig auf Datenbanken angewendet.  Hierf√ºr k√∂nnen Sie beispielsweise Master-Slave verwenden. <br><br>  Betrachten wir typische Redundanzprobleme am Beispiel des einfachsten Schemas: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/9b/rb/lo9brbsy29ca8b0i-1ygtyckncq.png" width="300"></div><br>  Die Anwendung kommuniziert ausschlie√ülich mit dem Master, w√§hrend im Hintergrund asynchron Daten an den Slave √ºbertragen werden.  Wenn der Master abst√ºrzt, wechseln wir zum Slave und arbeiten weiter. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/lt/o5/galto5cgws3ed44dfwhnqq9zvd4.png" width="300"></div><br><br>  Nachdem wir den Master wiederhergestellt haben, machen wir einfach einen neuen Slave daraus und der alte verwandelt sich in einen Master. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6h/c8/gc/6hc8gc6qzhzso3xscnjblfn1frm.png" width="300"></div><br>  Das Schema ist einfach, weist aber auch viele Nuancen auf, die f√ºr redundante Schemata charakteristisch sind. <br><br><h3>  Laden </h3><br>  Nehmen wir an, ein Server aus dem obigen Beispiel kann ungef√§hr 100.000 RPS aushalten.  Jetzt betr√§gt die Last 60k RPS und alles funktioniert wie eine Uhr. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/99/gw/j1/99gwj19rezs-ywa-hdopmqcudk8.png" width="300"></div><br>  Mit der Zeit steigt jedoch die Belastung der Anwendung und damit des Masters.  Sie k√∂nnen es ausgleichen, indem Sie einen Teil des Messwerts auf einen Slave verschieben. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sv/r4/si/svr4sicizgym8gqndznsygpi0-o.png" width="300"></div><br>  Sieht ziemlich gut aus.  H√§lt die Last, der Server ist nicht mehr im Leerlauf.  Aber das ist eine schlechte Idee.  Es ist wichtig, sich daran zu erinnern, warum Sie den Slave urspr√ºnglich angehoben haben - um bei Problemen mit dem Haupt-Slave darauf umzuschalten.  Wenn Sie begonnen haben, beide Server zu laden, m√ºssen Sie beim Absturz Ihres Masters - und fr√ºher oder sp√§ter - den Hauptverkehr vom Master auf den Sicherungsserver umschalten, der bereits geladen ist.  Eine solche √úberlastung wird Ihr System entweder furchtbar langsam machen oder es vollst√§ndig deaktivieren. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/py/la/9tpylanqp3whk7tcr4csdln6yo0.png" width="300"></div><br><h3>  Daten </h3><br>  Das Hauptproblem beim Hinzuf√ºgen einer Fehlertoleranz zu einem Dienst ist der lokale Status.  Wenn Ihr Dienst zustandslos ist, d. H. Keine ver√§nderlichen Daten speichert, stellt die Skalierung kein Problem dar.  Wir erheben einfach so viele Instanzen, wie wir ben√∂tigen, und gleichen die Anforderungen zwischen ihnen aus. <br><br>  Wenn der Dienst zustandsbehaftet ist, k√∂nnen wir dies nicht mehr tun.  Sie m√ºssen dar√ºber nachdenken, wie Sie dieselben Daten auf allen Instanzen unseres Dienstes speichern k√∂nnen, damit sie konsistent bleiben. <br><br>  Um dieses Problem zu l√∂sen, wird einer von zwei Ans√§tzen verwendet: entweder synchrone oder asynchrone Replikation.  Im Allgemeinen empfehle ich Ihnen, die asynchrone Option zu verwenden, da das Schreiben im Allgemeinen einfacher und schneller ist und Sie unter den gegebenen Umst√§nden pr√ºfen m√ºssen, ob Sie auf synchron umschalten m√ºssen. <br><br>  Eine wichtige Nuance, die bei der Arbeit mit asynchroner Replikation ber√ºcksichtigt werden muss, ist die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eventuelle Konsistenz</a> .  Dies bedeutet, dass zu einem bestimmten Zeitpunkt auf verschiedenen Slaves Daten in unvorhersehbaren und unterschiedlichen Zeitintervallen hinter dem Master zur√ºckbleiben k√∂nnen. <br>  Dementsprechend k√∂nnen Sie nicht jedes Mal Daten von einem zuf√§lligen Server lesen, da dann unterschiedliche Antworten auf dieselben Benutzeranforderungen kommen k√∂nnen.  Um dieses Problem zu umgehen, wird der Mechanismus der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sticky-Sessions verwendet</a> , der sicherstellt, dass alle Anforderungen eines Benutzers an eine Instanz gehen. <br><br>  Die Vorteile eines synchronen Ansatzes bestehen darin, dass sich die Daten immer in einem konsistenten Zustand befinden und das Risiko eines Datenverlusts geringer ist (da davon ausgegangen wird, dass sie erst aufgezeichnet werden, nachdem alle Server dies getan haben).  Sie m√ºssen dies jedoch mit der Schreibgeschwindigkeit und Komplexit√§t des Systems selbst bezahlen (z. B. verschiedene Quorum-Algorithmen zum Schutz vor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Split-Brain</a> ). <br><br><h3>  Schlussfolgerungen </h3><br><ul><li>  <b>Reserve.</b>  Wenn die Daten selbst und die Verf√ºgbarkeit eines bestimmten Dienstes wichtig sind, stellen Sie sicher, dass Ihr Dienst den Sturz eines bestimmten Computers √ºberlebt. <br></li><li>  <b>Ber√ºcksichtigen Sie bei der Berechnung der Last den Ausfall einiger Server.</b>  Wenn Ihr Cluster √ºber vier Server verf√ºgt, stellen Sie sicher, dass bei einem Ausfall die drei verbleibenden die Last ziehen. <br></li><li>  <b>W√§hlen Sie den Replikationstyp abh√§ngig von den Aufgaben.</b> <br></li><li>  <b>Legen Sie nicht alle Eier in einen Korb.</b>  Stellen Sie sicher, dass Sie weit genug voneinander entfernt sind.  Abh√§ngig von der Kritikalit√§t der Serviceverf√ºgbarkeit k√∂nnen sich Ihre Server in verschiedenen Racks in einem Rechenzentrum oder in verschiedenen Rechenzentren in verschiedenen L√§ndern befinden.  Es h√§ngt alles davon ab, wie viel globale Katastrophe Sie wollen und bereit sind zu √ºberleben. <br></li></ul><br><h2>  Stummschaltungsdienst </h2><br>  Irgendwann beginnt Ihr Dienst m√∂glicherweise sehr langsam zu arbeiten.  Dieses Problem kann aus vielen Gr√ºnden auftreten: √ºberm√§√üige Auslastung, Netzwerkverz√∂gerungen, Hardwareprobleme oder Codefehler.  Es sieht aus wie ein nicht so schreckliches Problem, aber tats√§chlich ist es heimt√ºckischer als es scheint. <br><br>  Stellen Sie sich vor: Ein Benutzer fordert eine Seite an.  Wir greifen gleichzeitig und nacheinander auf die vier D√§monen zu, um sie zu zeichnen.  Sie reagieren schnell, alles funktioniert gut. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vo/u9/q5/vou9q5svtrqqptnxti-vkeuhmbm.png" width="400"></div><br>  Angenommen, dieser Fall wird mit nginx mit einer festen Anzahl von PHP-FPM-Workern (z. B. mit zehn) behandelt.  Wenn jede Anfrage ungef√§hr 20 ms lang verarbeitet wird, kann mit Hilfe einfacher Berechnungen verstanden werden, dass unser System ungef√§hr f√ºnfhundert Anfragen pro Sekunde verarbeiten kann. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/h2/o2/tqh2o239lvw7qiobm8scwzrjma4.png" width="450"></div><br>  Was passiert, wenn einer dieser vier Dienste stumpf wird und die Verarbeitung von Anforderungen an ihn von 20 ms auf ein Zeitlimit von 1000 ms ansteigt?  Es ist wichtig zu bedenken, dass die Verz√∂gerung bei der Arbeit mit dem Netzwerk unendlich gro√ü sein kann.  Daher m√ºssen Sie immer ein Zeitlimit festlegen (in diesem Fall entspricht es einer Sekunde). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rn/uq/ae/rnuqaevpyknuwpgd9a94oygknia.png" width="400"></div><br>  Es stellt sich heraus, dass das Backend gezwungen ist, auf das Ablaufzeitlimit zu warten und den Fehler vom Daemon zu empfangen und zu verarbeiten.  Dies bedeutet, dass der Benutzer die Seite in einer Sekunde statt in zehn Millisekunden empf√§ngt.  Langsam, aber nicht t√∂dlich. <br><br>  Aber was ist hier das eigentliche Problem?  Tatsache ist, dass der Durchsatz bei jeder pro Sekunde verarbeiteten Anfrage auf tragische Weise auf zehn Anfragen pro Sekunde sinkt.  Und der elfte Benutzer kann keine Antwort mehr erhalten, selbst wenn er eine Seite angefordert hat, die in keiner Weise mit einem langweiligen Dienst verbunden ist.  Nur weil alle zehn Mitarbeiter auf eine Zeit√ºberschreitung warten und keine neuen Anfragen bearbeiten k√∂nnen. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/tn/dz/sktndzfsfdbjsgobqxmm5sy_xkw.png" width="450"></div><br>  Es ist wichtig zu verstehen, dass dieses Problem nicht durch eine Erh√∂hung der Anzahl der Arbeitnehmer gel√∂st werden kann.  Schlie√ülich ben√∂tigt jeder Mitarbeiter eine bestimmte Menge an RAM f√ºr seine Arbeit, auch wenn er keine echte Arbeit ausf√ºhrt, sondern nur in Erwartung einer Zeit√ºberschreitung h√§ngt.  Wenn Sie daher die Anzahl der Mitarbeiter nicht entsprechend den Funktionen Ihres Servers begrenzen, wird der gesamte Server durch das Erh√∂hen von immer mehr neuen Mitarbeitern belastet.  Dieser Fall ist ein Beispiel f√ºr einen Kaskadenfehler, wenn der Ausfall eines Dienstes, auch wenn er f√ºr den Benutzer nicht kritisch ist, einen Ausfall des gesamten Systems verursacht. <br><br><h3>  L√∂sung </h3><br>  Es gibt ein Muster, das als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Leistungsschalter bezeichnet wird</a> .  Seine Aufgabe ist ganz einfach: Er muss irgendwann einen langweiligen Dienst einstellen.  Hierzu wird ein Proxy zwischen dem Dienst und den Arbeitern platziert.  Dies kann entweder PHP-Code mit Speicher oder ein Daemon auf dem lokalen Host sein.  Es ist wichtig zu beachten, dass dieser Proxy bei mehreren Instanzen (Ihr Dienst wird repliziert) jede Instanz separat verfolgen muss. <br><br>  Wir haben unsere Implementierung dieses Musters geschrieben.  Aber nicht, weil wir gerne Code schreiben, sondern weil es bei der L√∂sung dieses Problems vor vielen Jahren keine vorgefertigten L√∂sungen gab. <br><br>  Jetzt werde ich allgemein √ºber unsere Implementierung und wie es hilft, dieses Problem zu vermeiden, skizzieren.  Mehr √ºber sie und ihre Unterschiede zu anderen L√∂sungen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erfahren Sie in einem Bericht von Mikhail Kurmaev √ºber Highload Siberia</a> Ende Juni.  Das Protokoll seines Berichts wird auch in diesem Blog ver√∂ffentlicht. <br><br>  Es sieht ungef√§hr so ‚Äã‚Äãaus: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/em/-d/dzem-dkkbiq6qx04cknxzdo99bc.png" width="500"></div><br>  Es gibt einen abstrakten Sphinx-Dienst, dem ein Leistungsschalter gegen√ºbersteht.  Der Leistungsschalter speichert die Anzahl der aktiven Verbindungen zu einem bestimmten D√§mon.  Sobald dieser Wert den Schwellenwert erreicht, den wir als Prozentsatz der verf√ºgbaren FPM-Mitarbeiter auf der Maschine festgelegt haben, glauben wir, dass der Service langsamer wurde.  Bei Erreichen des ersten Schwellenwerts senden wir eine Benachrichtigung an die f√ºr den Service verantwortliche Person.  Eine solche Situation ist entweder ein Zeichen daf√ºr, dass Grenzen √ºberpr√ºft werden m√ºssen, oder ein Vorbote von Problemen mit der Langeweile. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_g/ou/k6/_gouk6h_xfurcn_o04rslmiwsh8.png" width="500"></div><br>  Wenn sich die Situation verschlechtert und die Anzahl der hemmenden Arbeitnehmer den zweiten Schwellenwert erreicht - in unserer Produktion sind es etwa 10% -, reduzieren wir diesen Wirt vollst√§ndig.  Genauer gesagt funktioniert der Dienst tats√§chlich weiter, aber wir senden keine Anfragen mehr an ihn.  Der Circuit-Browser lehnt sie ab und gibt den Arbeitern sofort einen Fehler, als ob der Dienst gelogen h√§tte. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/co/ao/pd/coaopdx7tp0swvu8qu0t01jf81u.png" width="500"></div><br>  Von Zeit zu Zeit √ºberspringen wir automatisch eine Anfrage eines Mitarbeiters, um festzustellen, ob der Service zum Leben erweckt wurde.  Wenn er angemessen antwortet, nehmen wir ihn wieder in die Arbeit auf. <br><br>  All dies geschieht, um die Situation auf das vorherige Replikationsschema zu reduzieren.  Anstatt eine Sekunde zu warten, bevor wir feststellen, dass der Host nicht verf√ºgbar ist, erhalten wir sofort eine Fehlermeldung und gehen zum Backup-Host. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/s8/iz/9cs8iz-aepaztqroslluwwregt0.png" width="400"></div><br><br><h3>  Implementierungen </h3><br>  Gl√ºcklicherweise steht Open Source nicht still und heute k√∂nnen Sie eine schl√ºsselfertige L√∂sung f√ºr Github verwenden. <br><br>  Es gibt zwei Hauptans√§tze f√ºr die Implementierung eines Leistungsschalters: eine Bibliothek auf Codeebene und einen eigenst√§ndigen Daemon, der Anforderungen √ºber sich selbst weiterleitet. <br><br>  Die Option mit der Bibliothek ist besser geeignet, wenn Sie einen Hauptmonolithen in PHP haben, der mit mehreren Diensten interagiert, und die Dienste fast nicht miteinander kommunizieren.  Hier sind einige Implementierungen verf√ºgbar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ganesha</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP Leistungsschalter</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Phystrix</a> <br></li></ul><br>  Wenn Sie viele Dienste in verschiedenen Sprachen haben und alle miteinander interagieren, muss die Option auf Codeebene in allen diesen Sprachen dupliziert werden.  Dies ist bei der Unterst√ºtzung unpraktisch und f√ºhrt letztendlich zu Unterschieden bei den Implementierungen. <br><br>  Das Einf√ºgen eines Daemons ist in diesem Fall viel einfacher.  In diesem Fall m√ºssen Sie den Code nicht speziell bearbeiten.  Der D√§mon versucht, die Interaktion transparent zu machen.  Diese Option ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jedoch architektonisch viel komplizierter</a> . <br><br>  Hier sind einige Optionen (die Funktionalit√§t ist dort umfangreicher, aber es gibt auch einen Leistungsschalter): <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gesandter</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linkerd</a> <br></li></ul><br><h3>  Schlussfolgerungen </h3><br><ul><li>  Verlassen Sie sich nicht auf das Netzwerk. <br></li><li>  Alle Netzwerkanforderungen m√ºssen eine Zeit√ºberschreitung aufweisen, da das Netzwerk unendlich lange dauern kann. <br></li><li>  Verwenden Sie einen Leistungsschalter, wenn Sie kaskadierende Anwendungsabst√ºrze vermeiden m√∂chten, da ein kleiner Dienst langsamer wird. <br></li></ul><br><h2>  √úberwachung und Telemetrie </h2><br><h3>  Was gibt es </h3><br><ul><li>  <b>Vorhersehbarkeit.</b>  Es ist wichtig, vorherzusagen, wie hoch die Last ist und was in einem Monat sein wird, um die Anzahl der Dienstinstanzen rechtzeitig zu erh√∂hen.  Dies gilt insbesondere dann, wenn Sie mit einer Eiseninfrastruktur zu tun haben, da die Bestellung neuer Server einige Zeit in Anspruch nimmt. </li><li>  <b>Untersuchung von Vorf√§llen.</b>  Fr√ºher oder sp√§ter wird sowieso etwas schief gehen, und Sie m√ºssen es untersuchen.  Und es ist wichtig, √ºber gen√ºgend Daten zu verf√ºgen, um das Problem zu verstehen und solche Situationen in Zukunft verhindern zu k√∂nnen. </li><li>  <b>Unfallverh√ºtung.</b>  Idealerweise sollten Sie verstehen, welche Muster zu Abst√ºrzen f√ºhren.  Es ist wichtig, diese Muster im Auge zu behalten und das Team rechtzeitig dar√ºber zu informieren. </li></ul><br><br><h3>  Was zu messen </h3><br>  <b>Integrationsmetriken</b> <br><br>  Da es sich um die Interaktion zwischen Diensten handelt, √ºberwachen wir alles, was in Bezug auf die Kommunikation des Dienstes mit der Anwendung m√∂glich ist.  Zum Beispiel: <br><br><ul><li>  Anzahl der Anfragen; <br></li><li>  Bearbeitungszeit f√ºr Anforderungen (einschlie√ülich Perzentile); <br></li><li>  Anzahl der logischen Fehler; <br></li><li>  Anzahl der Systemfehler. <br></li></ul><br>  Es ist wichtig, Logikfehler von Systemfehlern zu unterscheiden.  Wenn der Dienst ausf√§llt, ist dies eine normale Situation: Wir wechseln einfach zur zweiten.  Aber es ist nicht so be√§ngstigend.  Wenn Sie einen logischen Fehler starten, z. B. seltsame Daten in den Dienst gelangen oder diesen verlassen, muss dies bereits untersucht werden.  H√∂chstwahrscheinlich h√§ngt der Fehler mit einem Fehler im Code zusammen.  Sie selbst wird nicht bestehen. <br><br>  <b>Interne Metriken</b> <br><br>  Standardm√§√üig ist der Dienst eine Black Box, die ihre Arbeit unverst√§ndlich erledigt.  Es ist immer noch w√ºnschenswert, die maximalen Daten zu verstehen und zu sammeln, die der Dienst bereitstellen kann.  Wenn es sich bei dem Dienst um eine spezialisierte Datenbank handelt, in der einige Daten Ihrer Gesch√§ftslogik gespeichert sind, behalten Sie genau den √úberblick √ºber die Datenmenge, den Typ und andere Inhaltsmetriken.  Wenn Sie eine asynchrone Interaktion haben, ist es auch wichtig, die Warteschlangen zu √ºberwachen, √ºber die Ihr Dienst kommuniziert: Ankunfts- und Abfluggeschwindigkeit, Zeit in verschiedenen Phasen (wenn Sie mehrere Zwischenpunkte haben), die Anzahl der Ereignisse in der Warteschlange. <br><br>  Lassen Sie uns sehen, welche Metriken am Beispiel von memcached erfasst werden k√∂nnen: <br><br><ul><li>  Treffer / Miss-Verh√§ltnis; <br></li><li>  Reaktionszeit f√ºr verschiedene Operationen; <br></li><li>  RPS verschiedener Operationen; <br></li><li>  Aufschl√ºsselung der gleichen Daten auf verschiedenen Schl√ºsseln; <br></li><li>  oben geladene Schl√ºssel; <br></li><li>  Alle internen Metriken, die vom Befehl stats angegeben werden. <br></li></ul><br><br><h3>  Wie es geht </h3><br>  Wenn Sie ein kleines Unternehmen, ein kleines Projekt und wenige Server haben, ist es eine gute L√∂sung, eine Art SaaS zum Sammeln und Anzeigen anzuschlie√üen - es ist einfacher und billiger.  In diesem Fall verf√ºgt SaaS normalerweise √ºber umfangreiche Funktionen und muss sich nicht um viele Dinge k√ºmmern.  Beispiele f√ºr solche Dienste: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Datadog</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√úberrollb√ºgel</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Neues Relikt</a> <br></li></ul><br>  Alternativ k√∂nnen Sie Zabbix, Grafana oder eine andere selbst gehostete L√∂sung jederzeit auf Ihrem eigenen Computer installieren. <br><br><h3>  Schlussfolgerungen </h3><br><ul><li>  <b>Sammeln Sie alle Metriken, die Sie k√∂nnen.</b>  Daten sind nicht √ºberfl√ºssig.  Wenn Sie etwas untersuchen m√ºssen, werden Sie sich f√ºr Ihre Voraussicht bedanken. </li><li>  <b>Vergessen Sie nicht die asynchrone Interaktion.</b>  Wenn Sie Linien haben, die allm√§hlich erreichen, ist es wichtig zu verstehen, wie schnell sie erreichen und was mit Ihren Ereignissen an der Kreuzung zwischen den Diensten passiert. </li><li>  <b>Wenn Sie Ihren Dienst schreiben, bringen Sie ihm bei, Statistiken √ºber die Arbeit zu erstellen.</b>  Ein Teil der Daten kann auf der Integrationsschicht gemessen werden, wenn wir mit diesem Service kommunizieren.  Der Rest des Dienstes sollte in der Lage sein, Statistiken gem√§√ü dem bedingten Befehl zu geben.  Beispielsweise ist diese Funktionalit√§t in allen unseren Diensten f√ºr unterwegs Standard. </li><li>  <b>Passen Sie die Trigger an.</b>  <b>Diagramme sind gut, aber nur, wenn Sie sie betrachten.</b>  Es ist wichtig, dass Sie ein angepasstes System haben, das Sie informiert, wenn etwas schief geht. </li></ul><br><h2>  Memento mori </h2><br>  Und jetzt ein bisschen √ºber traurige Dinge.  M√∂glicherweise haben Sie das Gef√ºhl, dass das oben Genannte ein Allheilmittel ist, und jetzt wird nichts mehr fallen.  Aber selbst wenn Sie alles anwenden, was oben beschrieben wurde, wird jemals etwas fallen.  Es ist wichtig, dies zu ber√ºcksichtigen. <br>  Die Gr√ºnde f√ºr den Sturz sind vielf√§ltig.  Beispielsweise k√∂nnten Sie ein unzureichend paranoides Replikationsschema ausw√§hlen.  Ein Meteorit ist in Ihr Rechenzentrum gefallen und dann in das zweite.  Oder Sie haben den Code nur mit einem kniffligen Fehler bereitgestellt, der unerwartet aufgetreten ist. <br><br>  In Badoo gibt es beispielsweise die Seite "Personen in der N√§he".  Dort suchen Benutzer nach anderen Personen in der N√§he, um mit ihnen zu chatten. <br><br><img src="https://habrastorage.org/webt/3q/l4/xm/3ql4xmmqeobxu4vsrqygagstflw.png"><br><br>  Um die Seite zu rendern, ruft das Backend etwa sieben Dienste synchron auf.  Reduzieren Sie diese Zahl aus Gr√ºnden der √úbersichtlichkeit auf zwei.  Ein Dienst ist f√ºr das Rendern des zentralen Blocks mit Fotos verantwortlich.  Der zweite ist f√ºr den Werbeblock unten links.  Wer sichtbarer werden will, kann dorthin gelangen.  Wenn wir einen Dienst haben, der diese Werbung anzeigt, verschwindet der Block einfach. <br><br><img src="https://habrastorage.org/webt/rg/tu/pj/rgtupjtztftw7pgvxpwg7auwa1q.png"><br><br>  Die meisten Benutzer wissen nicht einmal davon: Unser Team reagiert schnell und bald wird der Block einfach wieder angezeigt. <br><br>  Aber nicht jede Funktionalit√§t k√∂nnen wir leise entfernen.  Wenn wir den Dienst verlieren, der f√ºr den zentralen Teil der Seite verantwortlich ist, funktioniert dies nicht, um ihn auszublenden.  Daher ist es wichtig, dem Benutzer in seiner Sprache mitzuteilen, was gerade passiert. <br><br><img src="https://habrastorage.org/webt/eh/1q/c3/eh1qc3sr6laokkydqscq_ydilue.png"><br><br>  Es ist auch w√ºnschenswert, dass der Ausfall eines Dienstes nicht zu einem Kaskadenfehler f√ºhrt.  F√ºr jeden Dienst muss Code geschrieben werden, der den Fall behandelt, da sonst die Anwendung insgesamt abst√ºrzen kann. <br><br>  Das ist aber noch nicht alles.  Manchmal f√§llt etwas, ohne das man in keiner Weise leben kann.  Zum Beispiel eine zentrale Datenbank oder ein Sitzungsdienst.  Es ist wichtig, es richtig auszuarbeiten und dem Benutzer etwas Angemessenes zu zeigen, ihn irgendwie zu unterhalten, um zu sagen, dass alles unter Kontrolle ist.  Gleichzeitig ist es wichtig, dass wirklich alles unter Kontrolle ist und die Monitore √ºber das Problem informiert werden. <br><br><img src="https://habrastorage.org/webt/e6/hs/wt/e6hswt9cdlv2kfnt47zuujzyoyq.png"><br><br><img src="https://habrastorage.org/webt/lr/ch/g9/lrchg9mdfortw-jjnzi9ejdzr8u.png"><br><br><h3>  So richtig zu sterben </h3><br><ul><li>  <b>Mach dich bereit f√ºr den Herbst.</b>  Es gibt keine Silberkugel, also legen Sie immer Strohhalme, falls der Service vollst√§ndig ausf√§llt, auch wenn Sie Redundanz verwenden. </li><li>  <b>Vermeiden Sie kaskadierende Fehler,</b> wenn Probleme mit einem der Dienste die gesamte Anwendung zum Erliegen bringen. </li><li>  <b>Deaktivieren Sie nicht kritische Benutzerfunktionen.</b>  Es ist in Ordnung.  Viele Dienste werden nur f√ºr interne Anforderungen verwendet und haben keinen Einfluss auf die bereitgestellten Funktionen.  Zum Beispiel ein Statistikdienst.  F√ºr den Benutzer spielt es keine Rolle, ob Statistiken von Ihnen gesammelt werden oder nicht.  F√ºr ihn ist es wichtig, dass die Seite funktioniert. </li></ul><br><h2>  Zusammenfassung </h2><br>  Um den neuen Service zuverl√§ssig in das System zu integrieren, schreiben wir in Badoo eine spezielle Wrapper-API darum, die folgende Aufgaben √ºbernimmt: <br><br><ul><li>  Lastausgleich; </li><li>  Zeit√ºberschreitungen; </li><li>  logisches Failover; </li><li>  Leistungsschalter; </li><li>  √úberwachung und Telemetrie; </li><li>  Autorisierungslogik; </li><li>  Serialisierung und Deserialisierung von Daten. </li></ul><br>  Stellen Sie besser sicher, dass alle diese Elemente auch in Ihrer Integrationsschicht enthalten sind.  Insbesondere, wenn Sie einen vorgefertigten Open-Source-API-Client verwenden.  Es ist wichtig zu beachten, dass die Integrationsschicht ein erh√∂htes Risiko f√ºr einen Kaskadenfehler Ihrer Anwendung darstellt. <br><br>  Vielen Dank f√ºr Ihre Aufmerksamkeit! <br><br>  <b>Literatur</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lass es los!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Site Reliability Engineering</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Microservices erstellen</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413555/">https://habr.com/ru/post/de413555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413545/index.html">Humor im Branding - warum es nicht immer gut ist</a></li>
<li><a href="../de413547/index.html">Erleben Sie 2 Millionen kopflose Sitzungen</a></li>
<li><a href="../de413549/index.html">Web Development Lecture Course</a></li>
<li><a href="../de413551/index.html">Scrollen und Aufmerksamkeit (Studie 2018)</a></li>
<li><a href="../de413553/index.html">Der Registrar REG.RU beraubte den Partner des Zugriffs auf 70.000 Domains und nahm deren Service f√ºr sich</a></li>
<li><a href="../de413557/index.html">NewSQL: SQL geht nirgendwo hin</a></li>
<li><a href="../de413559/index.html">Web-Verschlechterung oder wie man das Web f√ºr Menschen lesbar macht</a></li>
<li><a href="../de413561/index.html">Geschwindigkeit des kompilierten Linq Expression Tree</a></li>
<li><a href="../de413563/index.html">4 M√∂glichkeiten, ein Paket in Go zu importieren</a></li>
<li><a href="../de413565/index.html">Kubernetes Hack-Analyse - Hintert√ºr √ºber Kubelet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>