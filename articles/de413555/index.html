<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕺🏻 🍺 🎦 Sichere Interoperabilität in verteilten Systemen 👨‍👩‍👦‍👦 👠 🧜🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 

 Mein Name ist Alexey Solodky, ich bin PHP-Entwickler bei Badoo. Und heute werde ich eine Textversion meines Vortrags für das erste Bado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sichere Interoperabilität in verteilten Systemen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413555/"><img src="https://habrastorage.org/webt/ag/m-/8r/agm-8r1daffwnqqhzqagmayd4uc.png" width="800"><br><br>  Hallo Habr! <br><br>  Mein Name ist Alexey Solodky, ich bin PHP-Entwickler bei Badoo.  Und heute werde ich eine Textversion meines Vortrags für das erste Badoo PHP Meetup veröffentlichen.  Ein Video dieses und anderer Berichte aus dem Mitap finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Jedes System, das aus mindestens zwei Komponenten besteht (und wenn Sie sowohl PHP als auch eine Datenbank haben, sind dies zwei Komponenten), ist bei der Interaktion zwischen diesen Komponenten einer ganzen Reihe von Risiken ausgesetzt. <br><br>  Die Plattformabteilung, in der ich arbeite, integriert neue interne Services in unsere Anwendung.  Und bei der Lösung dieser Probleme haben wir Erfahrungen gesammelt, die ich teilen möchte. <br><br>  Unser Backend ist ein PHP-Monolith, der mit vielen Diensten interagiert (derzeit gibt es etwa 50 davon).  Dienste interagieren selten miteinander.  Die Probleme, über die ich in diesem Artikel spreche, sind aber auch für die Microservice-Architektur relevant.  In diesem Fall interagieren die Dienste sehr aktiv miteinander. Je mehr Interaktion Sie haben, desto mehr Probleme haben Sie. <br><br>  Überlegen Sie, was zu tun ist, wenn der Dienst abstürzt oder langweilig wird, wie die Erfassung von Metriken organisiert wird und was zu tun ist, wenn Sie durch all das nicht gerettet werden. <br><a name="habracut"></a><br><h2>  Service-Absturz </h2><br>  Früher oder später fällt der Server, auf dem Ihr Dienst installiert ist.  Es wird sicher passieren, und Sie können sich nicht dagegen verteidigen - verringern Sie nur die Wahrscheinlichkeit.  Sie können durch Hardware, Netzwerk, Code, erfolglose Bereitstellung enttäuscht werden - alles.  Und je mehr Server Sie haben, desto häufiger wird dies passieren. <br><br>  Wie können Sie Ihre Dienste in einer Welt überleben lassen, in der Server ständig abstürzen?  Ein allgemeiner Ansatz zur Lösung dieser Problemklasse ist die Redundanz. <br><br>  Redundanz wird überall auf verschiedenen Ebenen eingesetzt: von Eisen bis zu ganzen Rechenzentren.  Zum Beispiel RAID1 zum Schutz vor Festplattenausfällen oder ein Backup-Netzteil für Ihren Server im Falle eines Ausfalls des ersten.  Dieses Schema wird auch häufig auf Datenbanken angewendet.  Hierfür können Sie beispielsweise Master-Slave verwenden. <br><br>  Betrachten wir typische Redundanzprobleme am Beispiel des einfachsten Schemas: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/9b/rb/lo9brbsy29ca8b0i-1ygtyckncq.png" width="300"></div><br>  Die Anwendung kommuniziert ausschließlich mit dem Master, während im Hintergrund asynchron Daten an den Slave übertragen werden.  Wenn der Master abstürzt, wechseln wir zum Slave und arbeiten weiter. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/lt/o5/galto5cgws3ed44dfwhnqq9zvd4.png" width="300"></div><br><br>  Nachdem wir den Master wiederhergestellt haben, machen wir einfach einen neuen Slave daraus und der alte verwandelt sich in einen Master. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6h/c8/gc/6hc8gc6qzhzso3xscnjblfn1frm.png" width="300"></div><br>  Das Schema ist einfach, weist aber auch viele Nuancen auf, die für redundante Schemata charakteristisch sind. <br><br><h3>  Laden </h3><br>  Nehmen wir an, ein Server aus dem obigen Beispiel kann ungefähr 100.000 RPS aushalten.  Jetzt beträgt die Last 60k RPS und alles funktioniert wie eine Uhr. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/99/gw/j1/99gwj19rezs-ywa-hdopmqcudk8.png" width="300"></div><br>  Mit der Zeit steigt jedoch die Belastung der Anwendung und damit des Masters.  Sie können es ausgleichen, indem Sie einen Teil des Messwerts auf einen Slave verschieben. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sv/r4/si/svr4sicizgym8gqndznsygpi0-o.png" width="300"></div><br>  Sieht ziemlich gut aus.  Hält die Last, der Server ist nicht mehr im Leerlauf.  Aber das ist eine schlechte Idee.  Es ist wichtig, sich daran zu erinnern, warum Sie den Slave ursprünglich angehoben haben - um bei Problemen mit dem Haupt-Slave darauf umzuschalten.  Wenn Sie begonnen haben, beide Server zu laden, müssen Sie beim Absturz Ihres Masters - und früher oder später - den Hauptverkehr vom Master auf den Sicherungsserver umschalten, der bereits geladen ist.  Eine solche Überlastung wird Ihr System entweder furchtbar langsam machen oder es vollständig deaktivieren. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9t/py/la/9tpylanqp3whk7tcr4csdln6yo0.png" width="300"></div><br><h3>  Daten </h3><br>  Das Hauptproblem beim Hinzufügen einer Fehlertoleranz zu einem Dienst ist der lokale Status.  Wenn Ihr Dienst zustandslos ist, d. H. Keine veränderlichen Daten speichert, stellt die Skalierung kein Problem dar.  Wir erheben einfach so viele Instanzen, wie wir benötigen, und gleichen die Anforderungen zwischen ihnen aus. <br><br>  Wenn der Dienst zustandsbehaftet ist, können wir dies nicht mehr tun.  Sie müssen darüber nachdenken, wie Sie dieselben Daten auf allen Instanzen unseres Dienstes speichern können, damit sie konsistent bleiben. <br><br>  Um dieses Problem zu lösen, wird einer von zwei Ansätzen verwendet: entweder synchrone oder asynchrone Replikation.  Im Allgemeinen empfehle ich Ihnen, die asynchrone Option zu verwenden, da das Schreiben im Allgemeinen einfacher und schneller ist und Sie unter den gegebenen Umständen prüfen müssen, ob Sie auf synchron umschalten müssen. <br><br>  Eine wichtige Nuance, die bei der Arbeit mit asynchroner Replikation berücksichtigt werden muss, ist die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eventuelle Konsistenz</a> .  Dies bedeutet, dass zu einem bestimmten Zeitpunkt auf verschiedenen Slaves Daten in unvorhersehbaren und unterschiedlichen Zeitintervallen hinter dem Master zurückbleiben können. <br>  Dementsprechend können Sie nicht jedes Mal Daten von einem zufälligen Server lesen, da dann unterschiedliche Antworten auf dieselben Benutzeranforderungen kommen können.  Um dieses Problem zu umgehen, wird der Mechanismus der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sticky-Sessions verwendet</a> , der sicherstellt, dass alle Anforderungen eines Benutzers an eine Instanz gehen. <br><br>  Die Vorteile eines synchronen Ansatzes bestehen darin, dass sich die Daten immer in einem konsistenten Zustand befinden und das Risiko eines Datenverlusts geringer ist (da davon ausgegangen wird, dass sie erst aufgezeichnet werden, nachdem alle Server dies getan haben).  Sie müssen dies jedoch mit der Schreibgeschwindigkeit und Komplexität des Systems selbst bezahlen (z. B. verschiedene Quorum-Algorithmen zum Schutz vor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Split-Brain</a> ). <br><br><h3>  Schlussfolgerungen </h3><br><ul><li>  <b>Reserve.</b>  Wenn die Daten selbst und die Verfügbarkeit eines bestimmten Dienstes wichtig sind, stellen Sie sicher, dass Ihr Dienst den Sturz eines bestimmten Computers überlebt. <br></li><li>  <b>Berücksichtigen Sie bei der Berechnung der Last den Ausfall einiger Server.</b>  Wenn Ihr Cluster über vier Server verfügt, stellen Sie sicher, dass bei einem Ausfall die drei verbleibenden die Last ziehen. <br></li><li>  <b>Wählen Sie den Replikationstyp abhängig von den Aufgaben.</b> <br></li><li>  <b>Legen Sie nicht alle Eier in einen Korb.</b>  Stellen Sie sicher, dass Sie weit genug voneinander entfernt sind.  Abhängig von der Kritikalität der Serviceverfügbarkeit können sich Ihre Server in verschiedenen Racks in einem Rechenzentrum oder in verschiedenen Rechenzentren in verschiedenen Ländern befinden.  Es hängt alles davon ab, wie viel globale Katastrophe Sie wollen und bereit sind zu überleben. <br></li></ul><br><h2>  Stummschaltungsdienst </h2><br>  Irgendwann beginnt Ihr Dienst möglicherweise sehr langsam zu arbeiten.  Dieses Problem kann aus vielen Gründen auftreten: übermäßige Auslastung, Netzwerkverzögerungen, Hardwareprobleme oder Codefehler.  Es sieht aus wie ein nicht so schreckliches Problem, aber tatsächlich ist es heimtückischer als es scheint. <br><br>  Stellen Sie sich vor: Ein Benutzer fordert eine Seite an.  Wir greifen gleichzeitig und nacheinander auf die vier Dämonen zu, um sie zu zeichnen.  Sie reagieren schnell, alles funktioniert gut. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vo/u9/q5/vou9q5svtrqqptnxti-vkeuhmbm.png" width="400"></div><br>  Angenommen, dieser Fall wird mit nginx mit einer festen Anzahl von PHP-FPM-Workern (z. B. mit zehn) behandelt.  Wenn jede Anfrage ungefähr 20 ms lang verarbeitet wird, kann mit Hilfe einfacher Berechnungen verstanden werden, dass unser System ungefähr fünfhundert Anfragen pro Sekunde verarbeiten kann. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/h2/o2/tqh2o239lvw7qiobm8scwzrjma4.png" width="450"></div><br>  Was passiert, wenn einer dieser vier Dienste stumpf wird und die Verarbeitung von Anforderungen an ihn von 20 ms auf ein Zeitlimit von 1000 ms ansteigt?  Es ist wichtig zu bedenken, dass die Verzögerung bei der Arbeit mit dem Netzwerk unendlich groß sein kann.  Daher müssen Sie immer ein Zeitlimit festlegen (in diesem Fall entspricht es einer Sekunde). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rn/uq/ae/rnuqaevpyknuwpgd9a94oygknia.png" width="400"></div><br>  Es stellt sich heraus, dass das Backend gezwungen ist, auf das Ablaufzeitlimit zu warten und den Fehler vom Daemon zu empfangen und zu verarbeiten.  Dies bedeutet, dass der Benutzer die Seite in einer Sekunde statt in zehn Millisekunden empfängt.  Langsam, aber nicht tödlich. <br><br>  Aber was ist hier das eigentliche Problem?  Tatsache ist, dass der Durchsatz bei jeder pro Sekunde verarbeiteten Anfrage auf tragische Weise auf zehn Anfragen pro Sekunde sinkt.  Und der elfte Benutzer kann keine Antwort mehr erhalten, selbst wenn er eine Seite angefordert hat, die in keiner Weise mit einem langweiligen Dienst verbunden ist.  Nur weil alle zehn Mitarbeiter auf eine Zeitüberschreitung warten und keine neuen Anfragen bearbeiten können. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sk/tn/dz/sktndzfsfdbjsgobqxmm5sy_xkw.png" width="450"></div><br>  Es ist wichtig zu verstehen, dass dieses Problem nicht durch eine Erhöhung der Anzahl der Arbeitnehmer gelöst werden kann.  Schließlich benötigt jeder Mitarbeiter eine bestimmte Menge an RAM für seine Arbeit, auch wenn er keine echte Arbeit ausführt, sondern nur in Erwartung einer Zeitüberschreitung hängt.  Wenn Sie daher die Anzahl der Mitarbeiter nicht entsprechend den Funktionen Ihres Servers begrenzen, wird der gesamte Server durch das Erhöhen von immer mehr neuen Mitarbeitern belastet.  Dieser Fall ist ein Beispiel für einen Kaskadenfehler, wenn der Ausfall eines Dienstes, auch wenn er für den Benutzer nicht kritisch ist, einen Ausfall des gesamten Systems verursacht. <br><br><h3>  Lösung </h3><br>  Es gibt ein Muster, das als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Leistungsschalter bezeichnet wird</a> .  Seine Aufgabe ist ganz einfach: Er muss irgendwann einen langweiligen Dienst einstellen.  Hierzu wird ein Proxy zwischen dem Dienst und den Arbeitern platziert.  Dies kann entweder PHP-Code mit Speicher oder ein Daemon auf dem lokalen Host sein.  Es ist wichtig zu beachten, dass dieser Proxy bei mehreren Instanzen (Ihr Dienst wird repliziert) jede Instanz separat verfolgen muss. <br><br>  Wir haben unsere Implementierung dieses Musters geschrieben.  Aber nicht, weil wir gerne Code schreiben, sondern weil es bei der Lösung dieses Problems vor vielen Jahren keine vorgefertigten Lösungen gab. <br><br>  Jetzt werde ich allgemein über unsere Implementierung und wie es hilft, dieses Problem zu vermeiden, skizzieren.  Mehr über sie und ihre Unterschiede zu anderen Lösungen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erfahren Sie in einem Bericht von Mikhail Kurmaev über Highload Siberia</a> Ende Juni.  Das Protokoll seines Berichts wird auch in diesem Blog veröffentlicht. <br><br>  Es sieht ungefähr so ​​aus: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/em/-d/dzem-dkkbiq6qx04cknxzdo99bc.png" width="500"></div><br>  Es gibt einen abstrakten Sphinx-Dienst, dem ein Leistungsschalter gegenübersteht.  Der Leistungsschalter speichert die Anzahl der aktiven Verbindungen zu einem bestimmten Dämon.  Sobald dieser Wert den Schwellenwert erreicht, den wir als Prozentsatz der verfügbaren FPM-Mitarbeiter auf der Maschine festgelegt haben, glauben wir, dass der Service langsamer wurde.  Bei Erreichen des ersten Schwellenwerts senden wir eine Benachrichtigung an die für den Service verantwortliche Person.  Eine solche Situation ist entweder ein Zeichen dafür, dass Grenzen überprüft werden müssen, oder ein Vorbote von Problemen mit der Langeweile. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_g/ou/k6/_gouk6h_xfurcn_o04rslmiwsh8.png" width="500"></div><br>  Wenn sich die Situation verschlechtert und die Anzahl der hemmenden Arbeitnehmer den zweiten Schwellenwert erreicht - in unserer Produktion sind es etwa 10% -, reduzieren wir diesen Wirt vollständig.  Genauer gesagt funktioniert der Dienst tatsächlich weiter, aber wir senden keine Anfragen mehr an ihn.  Der Circuit-Browser lehnt sie ab und gibt den Arbeitern sofort einen Fehler, als ob der Dienst gelogen hätte. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/co/ao/pd/coaopdx7tp0swvu8qu0t01jf81u.png" width="500"></div><br>  Von Zeit zu Zeit überspringen wir automatisch eine Anfrage eines Mitarbeiters, um festzustellen, ob der Service zum Leben erweckt wurde.  Wenn er angemessen antwortet, nehmen wir ihn wieder in die Arbeit auf. <br><br>  All dies geschieht, um die Situation auf das vorherige Replikationsschema zu reduzieren.  Anstatt eine Sekunde zu warten, bevor wir feststellen, dass der Host nicht verfügbar ist, erhalten wir sofort eine Fehlermeldung und gehen zum Backup-Host. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9c/s8/iz/9cs8iz-aepaztqroslluwwregt0.png" width="400"></div><br><br><h3>  Implementierungen </h3><br>  Glücklicherweise steht Open Source nicht still und heute können Sie eine schlüsselfertige Lösung für Github verwenden. <br><br>  Es gibt zwei Hauptansätze für die Implementierung eines Leistungsschalters: eine Bibliothek auf Codeebene und einen eigenständigen Daemon, der Anforderungen über sich selbst weiterleitet. <br><br>  Die Option mit der Bibliothek ist besser geeignet, wenn Sie einen Hauptmonolithen in PHP haben, der mit mehreren Diensten interagiert, und die Dienste fast nicht miteinander kommunizieren.  Hier sind einige Implementierungen verfügbar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ganesha</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP Leistungsschalter</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Phystrix</a> <br></li></ul><br>  Wenn Sie viele Dienste in verschiedenen Sprachen haben und alle miteinander interagieren, muss die Option auf Codeebene in allen diesen Sprachen dupliziert werden.  Dies ist bei der Unterstützung unpraktisch und führt letztendlich zu Unterschieden bei den Implementierungen. <br><br>  Das Einfügen eines Daemons ist in diesem Fall viel einfacher.  In diesem Fall müssen Sie den Code nicht speziell bearbeiten.  Der Dämon versucht, die Interaktion transparent zu machen.  Diese Option ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jedoch architektonisch viel komplizierter</a> . <br><br>  Hier sind einige Optionen (die Funktionalität ist dort umfangreicher, aber es gibt auch einen Leistungsschalter): <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gesandter</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linkerd</a> <br></li></ul><br><h3>  Schlussfolgerungen </h3><br><ul><li>  Verlassen Sie sich nicht auf das Netzwerk. <br></li><li>  Alle Netzwerkanforderungen müssen eine Zeitüberschreitung aufweisen, da das Netzwerk unendlich lange dauern kann. <br></li><li>  Verwenden Sie einen Leistungsschalter, wenn Sie kaskadierende Anwendungsabstürze vermeiden möchten, da ein kleiner Dienst langsamer wird. <br></li></ul><br><h2>  Überwachung und Telemetrie </h2><br><h3>  Was gibt es </h3><br><ul><li>  <b>Vorhersehbarkeit.</b>  Es ist wichtig, vorherzusagen, wie hoch die Last ist und was in einem Monat sein wird, um die Anzahl der Dienstinstanzen rechtzeitig zu erhöhen.  Dies gilt insbesondere dann, wenn Sie mit einer Eiseninfrastruktur zu tun haben, da die Bestellung neuer Server einige Zeit in Anspruch nimmt. </li><li>  <b>Untersuchung von Vorfällen.</b>  Früher oder später wird sowieso etwas schief gehen, und Sie müssen es untersuchen.  Und es ist wichtig, über genügend Daten zu verfügen, um das Problem zu verstehen und solche Situationen in Zukunft verhindern zu können. </li><li>  <b>Unfallverhütung.</b>  Idealerweise sollten Sie verstehen, welche Muster zu Abstürzen führen.  Es ist wichtig, diese Muster im Auge zu behalten und das Team rechtzeitig darüber zu informieren. </li></ul><br><br><h3>  Was zu messen </h3><br>  <b>Integrationsmetriken</b> <br><br>  Da es sich um die Interaktion zwischen Diensten handelt, überwachen wir alles, was in Bezug auf die Kommunikation des Dienstes mit der Anwendung möglich ist.  Zum Beispiel: <br><br><ul><li>  Anzahl der Anfragen; <br></li><li>  Bearbeitungszeit für Anforderungen (einschließlich Perzentile); <br></li><li>  Anzahl der logischen Fehler; <br></li><li>  Anzahl der Systemfehler. <br></li></ul><br>  Es ist wichtig, Logikfehler von Systemfehlern zu unterscheiden.  Wenn der Dienst ausfällt, ist dies eine normale Situation: Wir wechseln einfach zur zweiten.  Aber es ist nicht so beängstigend.  Wenn Sie einen logischen Fehler starten, z. B. seltsame Daten in den Dienst gelangen oder diesen verlassen, muss dies bereits untersucht werden.  Höchstwahrscheinlich hängt der Fehler mit einem Fehler im Code zusammen.  Sie selbst wird nicht bestehen. <br><br>  <b>Interne Metriken</b> <br><br>  Standardmäßig ist der Dienst eine Black Box, die ihre Arbeit unverständlich erledigt.  Es ist immer noch wünschenswert, die maximalen Daten zu verstehen und zu sammeln, die der Dienst bereitstellen kann.  Wenn es sich bei dem Dienst um eine spezialisierte Datenbank handelt, in der einige Daten Ihrer Geschäftslogik gespeichert sind, behalten Sie genau den Überblick über die Datenmenge, den Typ und andere Inhaltsmetriken.  Wenn Sie eine asynchrone Interaktion haben, ist es auch wichtig, die Warteschlangen zu überwachen, über die Ihr Dienst kommuniziert: Ankunfts- und Abfluggeschwindigkeit, Zeit in verschiedenen Phasen (wenn Sie mehrere Zwischenpunkte haben), die Anzahl der Ereignisse in der Warteschlange. <br><br>  Lassen Sie uns sehen, welche Metriken am Beispiel von memcached erfasst werden können: <br><br><ul><li>  Treffer / Miss-Verhältnis; <br></li><li>  Reaktionszeit für verschiedene Operationen; <br></li><li>  RPS verschiedener Operationen; <br></li><li>  Aufschlüsselung der gleichen Daten auf verschiedenen Schlüsseln; <br></li><li>  oben geladene Schlüssel; <br></li><li>  Alle internen Metriken, die vom Befehl stats angegeben werden. <br></li></ul><br><br><h3>  Wie es geht </h3><br>  Wenn Sie ein kleines Unternehmen, ein kleines Projekt und wenige Server haben, ist es eine gute Lösung, eine Art SaaS zum Sammeln und Anzeigen anzuschließen - es ist einfacher und billiger.  In diesem Fall verfügt SaaS normalerweise über umfangreiche Funktionen und muss sich nicht um viele Dinge kümmern.  Beispiele für solche Dienste: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Datadog</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Überrollbügel</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Neues Relikt</a> <br></li></ul><br>  Alternativ können Sie Zabbix, Grafana oder eine andere selbst gehostete Lösung jederzeit auf Ihrem eigenen Computer installieren. <br><br><h3>  Schlussfolgerungen </h3><br><ul><li>  <b>Sammeln Sie alle Metriken, die Sie können.</b>  Daten sind nicht überflüssig.  Wenn Sie etwas untersuchen müssen, werden Sie sich für Ihre Voraussicht bedanken. </li><li>  <b>Vergessen Sie nicht die asynchrone Interaktion.</b>  Wenn Sie Linien haben, die allmählich erreichen, ist es wichtig zu verstehen, wie schnell sie erreichen und was mit Ihren Ereignissen an der Kreuzung zwischen den Diensten passiert. </li><li>  <b>Wenn Sie Ihren Dienst schreiben, bringen Sie ihm bei, Statistiken über die Arbeit zu erstellen.</b>  Ein Teil der Daten kann auf der Integrationsschicht gemessen werden, wenn wir mit diesem Service kommunizieren.  Der Rest des Dienstes sollte in der Lage sein, Statistiken gemäß dem bedingten Befehl zu geben.  Beispielsweise ist diese Funktionalität in allen unseren Diensten für unterwegs Standard. </li><li>  <b>Passen Sie die Trigger an.</b>  <b>Diagramme sind gut, aber nur, wenn Sie sie betrachten.</b>  Es ist wichtig, dass Sie ein angepasstes System haben, das Sie informiert, wenn etwas schief geht. </li></ul><br><h2>  Memento mori </h2><br>  Und jetzt ein bisschen über traurige Dinge.  Möglicherweise haben Sie das Gefühl, dass das oben Genannte ein Allheilmittel ist, und jetzt wird nichts mehr fallen.  Aber selbst wenn Sie alles anwenden, was oben beschrieben wurde, wird jemals etwas fallen.  Es ist wichtig, dies zu berücksichtigen. <br>  Die Gründe für den Sturz sind vielfältig.  Beispielsweise könnten Sie ein unzureichend paranoides Replikationsschema auswählen.  Ein Meteorit ist in Ihr Rechenzentrum gefallen und dann in das zweite.  Oder Sie haben den Code nur mit einem kniffligen Fehler bereitgestellt, der unerwartet aufgetreten ist. <br><br>  In Badoo gibt es beispielsweise die Seite "Personen in der Nähe".  Dort suchen Benutzer nach anderen Personen in der Nähe, um mit ihnen zu chatten. <br><br><img src="https://habrastorage.org/webt/3q/l4/xm/3ql4xmmqeobxu4vsrqygagstflw.png"><br><br>  Um die Seite zu rendern, ruft das Backend etwa sieben Dienste synchron auf.  Reduzieren Sie diese Zahl aus Gründen der Übersichtlichkeit auf zwei.  Ein Dienst ist für das Rendern des zentralen Blocks mit Fotos verantwortlich.  Der zweite ist für den Werbeblock unten links.  Wer sichtbarer werden will, kann dorthin gelangen.  Wenn wir einen Dienst haben, der diese Werbung anzeigt, verschwindet der Block einfach. <br><br><img src="https://habrastorage.org/webt/rg/tu/pj/rgtupjtztftw7pgvxpwg7auwa1q.png"><br><br>  Die meisten Benutzer wissen nicht einmal davon: Unser Team reagiert schnell und bald wird der Block einfach wieder angezeigt. <br><br>  Aber nicht jede Funktionalität können wir leise entfernen.  Wenn wir den Dienst verlieren, der für den zentralen Teil der Seite verantwortlich ist, funktioniert dies nicht, um ihn auszublenden.  Daher ist es wichtig, dem Benutzer in seiner Sprache mitzuteilen, was gerade passiert. <br><br><img src="https://habrastorage.org/webt/eh/1q/c3/eh1qc3sr6laokkydqscq_ydilue.png"><br><br>  Es ist auch wünschenswert, dass der Ausfall eines Dienstes nicht zu einem Kaskadenfehler führt.  Für jeden Dienst muss Code geschrieben werden, der den Fall behandelt, da sonst die Anwendung insgesamt abstürzen kann. <br><br>  Das ist aber noch nicht alles.  Manchmal fällt etwas, ohne das man in keiner Weise leben kann.  Zum Beispiel eine zentrale Datenbank oder ein Sitzungsdienst.  Es ist wichtig, es richtig auszuarbeiten und dem Benutzer etwas Angemessenes zu zeigen, ihn irgendwie zu unterhalten, um zu sagen, dass alles unter Kontrolle ist.  Gleichzeitig ist es wichtig, dass wirklich alles unter Kontrolle ist und die Monitore über das Problem informiert werden. <br><br><img src="https://habrastorage.org/webt/e6/hs/wt/e6hswt9cdlv2kfnt47zuujzyoyq.png"><br><br><img src="https://habrastorage.org/webt/lr/ch/g9/lrchg9mdfortw-jjnzi9ejdzr8u.png"><br><br><h3>  So richtig zu sterben </h3><br><ul><li>  <b>Mach dich bereit für den Herbst.</b>  Es gibt keine Silberkugel, also legen Sie immer Strohhalme, falls der Service vollständig ausfällt, auch wenn Sie Redundanz verwenden. </li><li>  <b>Vermeiden Sie kaskadierende Fehler,</b> wenn Probleme mit einem der Dienste die gesamte Anwendung zum Erliegen bringen. </li><li>  <b>Deaktivieren Sie nicht kritische Benutzerfunktionen.</b>  Es ist in Ordnung.  Viele Dienste werden nur für interne Anforderungen verwendet und haben keinen Einfluss auf die bereitgestellten Funktionen.  Zum Beispiel ein Statistikdienst.  Für den Benutzer spielt es keine Rolle, ob Statistiken von Ihnen gesammelt werden oder nicht.  Für ihn ist es wichtig, dass die Seite funktioniert. </li></ul><br><h2>  Zusammenfassung </h2><br>  Um den neuen Service zuverlässig in das System zu integrieren, schreiben wir in Badoo eine spezielle Wrapper-API darum, die folgende Aufgaben übernimmt: <br><br><ul><li>  Lastausgleich; </li><li>  Zeitüberschreitungen; </li><li>  logisches Failover; </li><li>  Leistungsschalter; </li><li>  Überwachung und Telemetrie; </li><li>  Autorisierungslogik; </li><li>  Serialisierung und Deserialisierung von Daten. </li></ul><br>  Stellen Sie besser sicher, dass alle diese Elemente auch in Ihrer Integrationsschicht enthalten sind.  Insbesondere, wenn Sie einen vorgefertigten Open-Source-API-Client verwenden.  Es ist wichtig zu beachten, dass die Integrationsschicht ein erhöhtes Risiko für einen Kaskadenfehler Ihrer Anwendung darstellt. <br><br>  Vielen Dank für Ihre Aufmerksamkeit! <br><br>  <b>Literatur</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lass es los!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Site Reliability Engineering</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Microservices erstellen</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413555/">https://habr.com/ru/post/de413555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413545/index.html">Humor im Branding - warum es nicht immer gut ist</a></li>
<li><a href="../de413547/index.html">Erleben Sie 2 Millionen kopflose Sitzungen</a></li>
<li><a href="../de413549/index.html">Web Development Lecture Course</a></li>
<li><a href="../de413551/index.html">Scrollen und Aufmerksamkeit (Studie 2018)</a></li>
<li><a href="../de413553/index.html">Der Registrar REG.RU beraubte den Partner des Zugriffs auf 70.000 Domains und nahm deren Service für sich</a></li>
<li><a href="../de413557/index.html">NewSQL: SQL geht nirgendwo hin</a></li>
<li><a href="../de413559/index.html">Web-Verschlechterung oder wie man das Web für Menschen lesbar macht</a></li>
<li><a href="../de413561/index.html">Geschwindigkeit des kompilierten Linq Expression Tree</a></li>
<li><a href="../de413563/index.html">4 Möglichkeiten, ein Paket in Go zu importieren</a></li>
<li><a href="../de413565/index.html">Kubernetes Hack-Analyse - Hintertür über Kubelet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>