<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìç üôÜüèΩ ‚öóÔ∏è Mises √† jour p√©riodiques des donn√©es ‚ôèÔ∏è üíØ üë¥üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je veux tout de suite faire une r√©servation pour que notre code s'ex√©cute dans un environnement virtuel (machine) du .NET Framework, qui √† son tour s'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mises √† jour p√©riodiques des donn√©es</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474038/"> Je veux tout de suite faire une r√©servation pour que notre code s'ex√©cute dans un environnement virtuel (machine) du .NET Framework, qui √† son tour s'ex√©cute sur un syst√®me d'exploitation √† usage g√©n√©ral, donc nous ne parlerons d'aucune pr√©cision m√™me dans un d√©lai de 1 √† 2 ms.  N√©anmoins, nous essaierons de faire tout ce qui est en notre pouvoir pour augmenter la pr√©cision temporelle. <br><br>  Souvent dans notre programme, il devient n√©cessaire de mettre √† jour certaines informations avec un certain intervalle de temps.  Dans mon cas, c'√©tait une mise √† jour de clich√©s (images) de cam√©ras IP.  Souvent, la logique m√©tier d'une application fixe certaines limites √† la fr√©quence des mises √† jour des donn√©es.  Pour ce temps, c'est 1 seconde. <br>  La solution dans le front consiste √† installer Thread.Sleep (1000) /Task.Await (1000) apr√®s la demande d'instantan√©. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Getsnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] DoSomethink </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms"</span></span>); Thread.Sleep(sleepMs); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { Getsnapshot(); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); }</code> </pre> <br>  Mais le terme de notre op√©ration est une quantit√© non d√©terministe.  Par cons√©quent, la simulation de la prise d'instantan√©s ressemble √† ceci: <br><a name="habracut"></a><br>  Ex√©cutez notre programme et ex√©cutez la sortie <br><br><pre> <code class="plaintext hljs">[15:10.39] DoSomethink 974 ms [15:12.39] DoSomethink 383 ms [15:13.78] DoSomethink 99 ms [15:14.88] DoSomethink 454 ms [15:16.33] DoSomethink 315 ms [15:17.65] DoSomethink 498 ms [15:19.15] DoSomethink 708 ms [15:20.86] DoSomethink 64 ms [15:21.92] DoSomethink 776 ms [15:23.70] DoSomethink 762 ms [15:25.46] DoSomethink 123 ms [15:26.59] DoSomethink 36 ms [15:27.62] DoSomethink 650 ms [15:29.28] DoSomethink 510 ms [15:30.79] DoSomethink 257 ms [15:32.04] DoSomethink 602 ms [15:33.65] DoSomethink 542 ms [15:35.19] DoSomethink 286 ms [15:36.48] DoSomethink 673 ms [15:38.16] DoSomethink 749 ms</code> </pre><br>  Comme nous le voyons, le d√©calage s'accumulera et donc la logique m√©tier de notre application sera viol√©e. <br><br><pre> <code class="plaintext hljs">,      60   1      49.</code> </pre> <br>  Vous pouvez essayer de mesurer le d√©calage moyen et de r√©duire le temps de sommeil en r√©duisant l'√©cart moyen, mais dans ce cas, nous pouvons obtenir plus de demandes que notre logique m√©tier ne l'exige.  Nous ne serons jamais en mesure de pr√©dire, sachant que la demande est trait√©e jusqu'√† 1 seconde - combien de millisecondes nous devons attendre pour garantir la p√©riode de mise √† jour n√©cessaire. <br><br><pre> <code class="plaintext hljs">,      60   1     62.</code> </pre><br>  La solution √©vidente se sugg√®re.  Mesurez le temps avant et apr√®s l'op√©ration.  Et calculez leur diff√©rence. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sleepMs = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = Stopwatch.StartNew(); watch.Start(); Getsnapshot(); watch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> needSleepMs = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(sleepMs - watch.ElapsedMilliseconds); Thread.Sleep(needSleepMs); }</code> </pre><br>  Ex√©cutez notre programme maintenant.  Si vous √™tes chanceux, vous verrez quelque chose comme ce qui suit. <br><br><pre> <code class="plaintext hljs">[16:57.25] DoSomethink 789 ms [16:58.05] Need sleep 192 ms [16:58.25] DoSomethink 436 ms [16:58.68] Need sleep 564 ms [16:59.25] DoSomethink 810 ms [17:00.06] Need sleep 190 ms [17:00.25] DoSomethink 302 ms [17:00.55] Need sleep 697 ms [17:01.25] DoSomethink 819 ms [17:02.07] Need sleep 181 ms [17:02.25] DoSomethink 872 ms [17:03.13] Need sleep 128 ms [17:03.25] DoSomethink 902 ms [17:04.16] Need sleep 98 ms [17:04.26] DoSomethink 717 ms [17:04.97] Need sleep 282 ms [17:05.26] DoSomethink 14 ms [17:05.27] Need sleep 985 ms</code> </pre><br>  Pourquoi ai-je √©crit si j'ai de la chance?  Parce que watch.Start () est ex√©cut√© avant DoSomethink () et watch.Stop () apr√®s DoSomethink ();  Ces op√©rations ne sont pas instantan√©es + l'environnement d'ex√©cution lui-m√™me ne garantit pas la pr√©cision du temps d'ex√©cution du programme (x).  Par cons√©quent, il y aura des frais g√©n√©raux.  Notre fonction DoSomethink () fonctionne de 0 √† 1 000 ms (y).  Par cons√©quent, des situations peuvent survenir lorsque x + y&gt; 1000 dans de tels cas <br><br><pre> <code class="plaintext hljs"> int needSleepMs = (int)(sleepMs - watch.ElapsedMilliseconds);</code> </pre><br>  prendra des valeurs n√©gatives et nous obtiendrons une ArgumentOutOfRangeException car la m√©thode Thread.Sleep () ne doit pas prendre de valeurs n√©gatives. <br><br>  Dans de tels cas, il est logique de d√©finir le temps needSleepMs √† 0; <br>  En fait, en r√©alit√©, la fonction DoSomethink () peut s'ex√©cuter aussi longtemps que vous le souhaitez et nous pouvons obtenir le d√©bordement variable lors du transtypage en int.  Puis notre temps de sommeil <br>  peut d√©passer sleepMs; <br><br>  Vous pouvez r√©soudre ce probl√®me comme suit: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needSleepMs = sleepMs - watch.ElapsedMilliseconds; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needSleepMs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watch.ElapsedMilliseconds &lt;= sleepMs) { needSleepMs = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)needSleepMs; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { needSleepMs = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Thread.Sleep(needSleepMs);</code> </pre><br>  En principe, tout est pr√™t.  Mais l'utilisation de cette approche m√™me en un seul endroit provoque une g√™ne pour l'≈ìil du programmeur.  Et s'il y a des dizaines de tels endroits dans le programme, alors le code se transformera en un tas illisible ... <br><br>  Pour r√©soudre ce probl√®me, nous encapsulons notre code dans une fonction.  Ici, vous pouvez le mettre dans une classe distincte ou utiliser Global comme un vidage normal pour la classe et l'utiliser comme statique (ma version). <br><br>  Dans notre exemple, laissez-le pour plus de simplicit√©, laissez-le dans la classe Program <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedWaitMs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = Stopwatch.StartNew(); watch.Start(); before(); watch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needSleepMs = sleepMs - watch.ElapsedMilliseconds; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needSleepMs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watch.ElapsedMilliseconds &lt;= sleepMs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) needSleepMs; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Notre fonction de saisie accepte un lien vers la fonction √† ex√©cuter et notre temps d'attente pr√©vu.  Et cela renvoie l'heure √† laquelle notre programme doit dormir. <br>  Pour faciliter l'utilisation, nous pouvons √©galement transmettre des fonctions lambda anonymes √† notre fonction. <br><br>  Une liste compl√®te du programme est donn√©e ci-dessous: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp2</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Getsnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] DoSomethink </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms"</span></span>); Thread.Sleep(sleepMs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = NeedWaitMs(Getsnapshot, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] Need sleep </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Environment.NewLine}</span></span></span><span class="hljs-string">"</span></span>); Thread.Sleep(sleepMs); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedWaitMs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = Stopwatch.StartNew(); before(); watch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needSleepMs = sleepMs - watch.ElapsedMilliseconds; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needSleepMs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) needSleepMs : <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> l' <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp2</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Getsnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] DoSomethink </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms"</span></span>); Thread.Sleep(sleepMs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = NeedWaitMs(Getsnapshot, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] Need sleep </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Environment.NewLine}</span></span></span><span class="hljs-string">"</span></span>); Thread.Sleep(sleepMs); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedWaitMs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = Stopwatch.StartNew(); before(); watch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needSleepMs = sleepMs - watch.ElapsedMilliseconds; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needSleepMs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) needSleepMs : <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> du <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp2</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Getsnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = rnd.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] DoSomethink </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms"</span></span>); Thread.Sleep(sleepMs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sleepMs = NeedWaitMs(Getsnapshot, <span class="hljs-number"><span class="hljs-number">1000</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToString(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"mm:ss.ff"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">] Need sleep </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{sleepMs}</span></span></span><span class="hljs-string"> ms </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Environment.NewLine}</span></span></span><span class="hljs-string">"</span></span>); Thread.Sleep(sleepMs); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedWaitMs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action before, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sleepMs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = Stopwatch.StartNew(); before(); watch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needSleepMs = sleepMs - watch.ElapsedMilliseconds; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> needSleepMs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) needSleepMs : <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr474038/">https://habr.com/ru/post/fr474038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr474024/index.html">Nous transformons un robot aspirateur en soldat universel</a></li>
<li><a href="../fr474026/index.html">Histoires de consommateurs, Asos abandonne son magazine et TikTok</a></li>
<li><a href="../fr474028/index.html">De quelles comp√©tences g√©n√©rales les d√©veloppeurs ont-ils besoin? L'avis de Yandex</a></li>
<li><a href="../fr474032/index.html">Organisation des cellules standard (notes d'un √©tranger)</a></li>
<li><a href="../fr474036/index.html">L'√©dition de texte vous d√©teste aussi</a></li>
<li><a href="../fr474040/index.html">Interview de Playboy: Steve Jobs, partie 1</a></li>
<li><a href="../fr474042/index.html">Comp√©tition! Histoires √† la lumi√®re de serveurs vacillants ...</a></li>
<li><a href="../fr474046/index.html">S√©minaires sur les services cloud, l'IA, la blockchain, la science des donn√©es, les microservices: maintenant √† Moscou et √† Saint-P√©tersbourg</a></li>
<li><a href="../fr474048/index.html">HILDACRYPT: un nouveau ransomware frappe les syst√®mes de sauvegarde et les solutions antivirus</a></li>
<li><a href="../fr474050/index.html">Vous ne pouvez pas simplement prendre et ex√©cuter votre application si vous √™tes la star de l'industrie musicale</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>