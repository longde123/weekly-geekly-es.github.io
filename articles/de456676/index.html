<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÖüèΩ ü•ï üåí Anmelden in einer verteilten PHP-Anwendung üßîüèæ ü§∏üèæ üëßüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werden die Vorteile der Protokollierung erl√§utert. Ich werde √ºber Protokolle auf PSR erz√§hlen. Ich werde einige pers√∂nliche Empfehlu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Anmelden in einer verteilten PHP-Anwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456676/"><p><img src="https://habrastorage.org/webt/xm/rd/rj/xmrdrjy7rtwa8f2__bcbjrdry4y.png"></p><br><p>  In diesem Artikel werden die Vorteile der Protokollierung erl√§utert.  Ich werde √ºber Protokolle auf PSR erz√§hlen.  Ich werde einige pers√∂nliche Empfehlungen zur Arbeit mit der Ebene, der Nachricht und dem Kontext des protokollierten Ereignisses hinzuf√ºgen.  Es wird ein Beispiel gegeben, wie die Protokollierung und √úberwachung mithilfe von ELK in einer in Laravel geschriebenen und in mehreren F√§llen √ºber Docker gestarteten Anwendung organisiert wird.  Ich werde eine wichtige Regel des Warnsystems unterzeichnen.  Ich werde ein Beispiel f√ºr ein Skript geben, das den gesamten √úberwachungsstapel mit einem Befehl ausl√∂st. </p><a name="habracut"></a><br><h2 id="polza-logirovaniya">  Die Vorteile der Protokollierung </h2><br><p>  Eine gut organisierte Protokollierung erm√∂glicht mindestens Folgendes: </p><br><ul><li>  Zu wissen, dass etwas nicht wie beabsichtigt l√§uft (es gibt Fehler) </li><li>  Kennen Sie die Details des Fehlers, anhand derer Sie feststellen k√∂nnen, bei wem und wo der Fehler aufgetreten ist, und verhindern Sie eine Wiederholung </li><li>  Wisse, dass alles wie vorgesehen l√§uft (access.log, debug-, info-level) </li></ul><br><p>  Die Protokollierung selbst sagt Ihnen dies alles nicht, aber mithilfe der Protokolle k√∂nnen Sie die Details von Ereignissen unabh√§ngig herausfinden oder ein √úberwachungssystem f√ºr Protokolle konfigurieren, das Probleme melden kann.  Wenn die Nachrichten in den Protokollen von einer ausreichenden Menge an Kontext begleitet werden, vereinfacht dies das Debuggen erheblich, da mehr Daten √ºber die Situation verf√ºgbar sind, in der das Ereignis aufgetreten ist. </p><br><h2 id="chem-pisat-i-chto-pisat">  Was zu schreiben und was zu schreiben </h2><br><p> Ein Teil der PHP-Community hat Empfehlungen f√ºr einige Code-Schreibaufgaben entwickelt.  Eine solche Empfehlung ist das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PSR-3 Logger Interface</a> .  Es beschreibt nur, was Sie protokollieren m√ºssen.  Zu diesem <code>Psr\Log\LoggerInterface</code> des Pakets "psr / log" entwickelt.  Wenn Sie es verwenden, m√ºssen Sie die drei Komponenten des Ereignisses kennen: </p><br><ol><li>  <strong>Level</strong> - Ereignisbedeutung </li><li>  <strong>Nachricht</strong> - Text, der das Ereignis beschreibt </li><li>  <strong>Kontext</strong> - Eine Reihe zus√§tzlicher Informationen zum Ereignis </li></ol><br><h3 id="urovni-sobytiya-po-psr-3">  PSR-3-Ereignisebenen </h3><br><p>  Die Ebenen stammen aus RFC 5424 - The Syslog Protocol. Ihre ungef√§hre Beschreibung lautet wie folgt: </p><br><ul><li>  Debug - Details zum Debuggen </li><li>  info - Interessante Ereignisse </li><li>  Hinweis - Wesentliche Ereignisse, aber keine Fehler </li><li>  Warnung - Ausnahmef√§lle, aber keine Fehler </li><li>  Fehler - Ausf√ºhrungsfehler, die keinen vor√ºbergehenden Eingriff erfordern </li><li>  kritisch - Kritische Bedingungen (Systemkomponente ist nicht verf√ºgbar, unerwartete Ausnahme) </li><li>  alert - Aktion erfordert sofortiges Eingreifen </li><li>  Notfall - Das System funktioniert nicht </li></ul><br><p>  Es gibt eine Beschreibung, die jedoch nicht immer leicht zu befolgen ist, da es schwierig ist, die Bedeutung bestimmter Ereignisse zu bestimmen.  Im Kontext einer einzelnen Anforderung war es beispielsweise nicht m√∂glich, auf die verbundene Ressource zuzugreifen.  Bei der Aufzeichnung dieses Ereignisses wissen wir nicht, ob eine solche Anforderung fehlgeschlagen ist oder nur ein Benutzer fehlschl√§gt.  Es h√§ngt davon ab, ob ein sofortiges Eingreifen erforderlich ist oder ob dies ein seltener Fall ist, es kann warten oder sogar ignoriert werden.  Solche Probleme werden im Rahmen der √úberwachung von Protokollen gel√∂st.  Sie m√ºssen jedoch noch das Niveau bestimmen.  Daher k√∂nnen die Protokollierungsstufen im Team vereinbart werden.  Ein Beispiel: </p><br><ul><li>  <strong>Notfall</strong> ist die Ebene f√ºr externe Systeme, die Ihr System √ºberpr√ºfen und sicherstellen k√∂nnen, dass es vollst√§ndig nicht funktioniert oder die Eigendiagnose nicht funktioniert. </li><li>  <strong>alert</strong> - Das System selbst kann seinen Status beispielsweise mit einer geplanten Aufgabe diagnostizieren und als Ergebnis ein Ereignis mit dieser Ebene aufzeichnen.  Dies k√∂nnen √úberpr√ºfungen verbundener Ressourcen oder etwas Bestimmtes sein, z. B. ein Saldo auf dem Konto einer verwendeten externen Ressource. </li><li>  <strong>kritisch</strong> - ein Ereignis, bei dem ein Fehler eine Systemkomponente ergibt, die sehr wichtig ist und immer funktionieren sollte.  Es h√§ngt schon sehr davon ab, was das System macht.  Geeignet f√ºr Ereignisse, die wichtig sind, um schnell herauszufinden, auch wenn es nur einmal passiert ist. </li><li>  <strong>Fehler</strong> - Es ist ein Ereignis aufgetreten, √ºber das Sie bei baldiger Wiederholung Bericht erstatten m√ºssen.  Fehler beim Abschlie√üen der Aktion, die ausgef√ºhrt werden muss, aber diese Aktion f√§llt nicht unter die Beschreibung von kritisch.  Beispielsweise war es nicht m√∂glich, das Profilbild eines Benutzers auf seine Anfrage hin zu speichern, aber das System ist kein Profilbilddienst, sondern ein Chat-System. </li><li>  <strong>Warnung</strong> - Ereignisse, f√ºr deren sofortige Benachrichtigung Sie √ºber einen bestimmten Zeitraum eine erhebliche Anzahl von Ereignissen w√§hlen m√ºssen.  Fehler beim Ausf√ºhren einer Aktion, deren Fehler nichts Ernstes bricht.  Dies sind immer noch Fehler, deren Korrektur jedoch auf den Arbeitsplan warten kann.  Beispielsweise konnte der Avatar des Benutzers nicht gespeichert werden, und das System war ein Online-Shop.  Eine Benachrichtigung √ºber sie ist (mit hoher H√§ufigkeit) erforderlich, um √ºber pl√∂tzliche Anomalien informiert zu werden, da sie Symptome schwerwiegenderer Probleme sein k√∂nnen. </li><li>  <strong>Hinweis</strong> - Dies sind Ereignisse, die vom System bereitgestellte Abweichungen melden, die Teil der normalen Funktionsweise des Systems sind.  Zum Beispiel hat der Benutzer am Eingang das falsche Passwort angegeben, der Benutzer hat den zweiten Vornamen nicht eingegeben, aber es ist nicht erforderlich, der Benutzer hat die Bestellung f√ºr 0 Rubel gekauft, dies wird jedoch in seltenen F√§llen f√ºr Sie bereitgestellt.  Eine Benachrichtigung mit hoher Frequenz ist ebenfalls erforderlich, da ein starker Anstieg der Anzahl der Abweichungen auf einen Fehler zur√ºckzuf√ºhren sein kann, der dringend behoben werden muss. </li><li>  <strong>Info</strong> - Ereignisse, deren Auftreten die normale Funktionsweise des Systems meldet.  Beispielsweise hat sich ein Benutzer registriert, ein Benutzer hat ein Produkt gekauft, ein Benutzer hat ein Feedback hinterlassen.  Die Benachrichtigung f√ºr solche Ereignisse muss in umgekehrter Weise konfiguriert werden: Wenn √ºber einen bestimmten Zeitraum nicht gen√ºgend solche Ereignisse aufgetreten sind, m√ºssen Sie benachrichtigt werden, da deren Verringerung auf einen Fehler zur√ºckzuf√ºhren sein kann. </li><li>  <strong>Debug</strong> - Ereignisse zum Debuggen eines Prozesses auf dem System.  Wenn Sie dem Kontext des Ereignisses gen√ºgend Daten hinzuf√ºgen, k√∂nnen Sie das Problem diagnostizieren oder daraus schlie√üen, dass der Prozess im System ordnungsgem√§√ü funktioniert.  Beispielsweise hat ein Benutzer eine Produktseite ge√∂ffnet und eine Liste mit Empfehlungen erhalten.  Erh√∂ht die Anzahl der gesendeten Ereignisse erheblich, sodass die Protokollierung solcher Ereignisse nach einer Weile entfernt werden kann.  Infolgedessen ist die Anzahl solcher Ereignisse im normalen Betrieb variabel, und die √úberwachung auf Benachrichtigung dar√ºber kann weggelassen werden. </li></ul><br><h3 id="soobschenie-sobytiya">  Ereignismeldung </h3><br><p>  Nach PSR-3 muss eine Nachricht entweder eine Zeichenfolge oder ein Objekt mit der Methode <code>__toString()</code> .  Dar√ºber hinaus kann die Nachrichtenzeile gem√§√ü PSR-3 Platzhalter der Form <code>‚ÄùUser {username} created‚Äù</code> , die durch Werte aus dem Kontextarray ersetzt werden k√∂nnen.  Wenn Sie Elasticsearch und Kibana f√ºr die √úberwachung verwenden, empfehle ich, keine Platzhalter zu verwenden, sondern feste Zeilen zu schreiben, da dies das Filtern von Ereignissen vereinfacht und der Kontext immer vorhanden ist.  Dar√ºber hinaus schlage ich vor, auf zus√§tzliche Anforderungen f√ºr die Nachricht zu achten: </p><br><ol><li>  Der Text sollte kurz, aber aussagekr√§ftig sein.  Dies wird in Warnungen und in den Listen der aufgetretenen Ereignisse angezeigt. </li><li>  Der Text ist besser, um f√ºr verschiedene Teile des Programms eindeutig zu sein.  Auf diese Weise k√∂nnen Sie anhand der Warnung, ohne in den Kontext zu schauen, nachvollziehen, in welchem ‚Äã‚ÄãTeil das Ereignis aufgetreten ist. </li></ol><br><h3 id="kontekst-sobytiya">  Ereigniskontext </h3><br><p>  Der Ereigniskontext f√ºr PSR-3 ist ein Array (m√∂glicherweise verschachtelt) von Variablenwerten, z. B. Entit√§ts-IDs.  Der Kontext kann leer gelassen werden, wenn die Nachricht √ºber das Ereignis klar ist.  <code>getMessage()</code> Sie eine Ausnahme protokollieren, sollten Sie die gesamte Ausnahme √ºbergeben, nicht nur <code>getMessage()</code> .  Bei Verwendung von Monolog √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NormalizerFormatter werden</a> n√ºtzliche Daten automatisch aus der Ausnahme extrahiert und dem Ereigniskontext hinzugef√ºgt, einschlie√ülich der Stapelverfolgung.  Das hei√üt, Sie brauchen stattdessen </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception-&gt;getMessage(), ]</code> </pre> <br><p>  zu verwenden </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]</code> </pre> <br><p>  In Laravel k√∂nnen Sie automatisch Daten f√ºr Ereignisse in Ereignisse eingeben.  Dies kann √ºber den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">globalen Protokollkontext</a> (nur f√ºr erfolglose Ausnahmen oder √ºber <code>report()</code> ) oder √ºber LogFormatter (f√ºr alle Ereignisse) erfolgen.  Normalerweise werden Informationen mit der ID des aktuellen Benutzers, der Anforderungs-URI, der IP, der Anforderungs-UUID und dergleichen hinzugef√ºgt. </p><br><p>  Denken Sie bei der Verwendung von Elasticsearch als Protokoll-Repository daran, dass feste Datentypen verwendet werden.  Wenn Sie also <code>customer_id</code> im Kontext einer Nummer √ºbergeben haben und versuchen, ein Ereignis mit einem anderen Typ zu speichern, z. B. einer Zeichenfolge (uuid), wird eine solche Nachricht nicht geschrieben.  Typen im Index werden beim ersten Empfang des Werts festgelegt.  Wenn jeden Tag Indizes erstellt werden, wird der neue Typ erst am n√§chsten Tag aufgezeichnet.  Aber selbst dies wird nicht alle Probleme l√∂sen, da f√ºr Kibana die Typen gemischt werden und einige der mit dem Typ verbundenen Operationen erst verf√ºgbar sind, wenn gemischte Indizes vorhanden sind. </p><br><p>  Um dieses Problem zu vermeiden, empfehle ich Ihnen, die folgenden Regeln zu befolgen: </p><br><ul><li>  Verwenden Sie keine zu generischen Schl√ºsselnamen, die unterschiedlichen Typs sein k√∂nnen </li><li>  F√ºhren Sie eine explizite Umwandlung in einen Werttyp durch, wenn Sie sich √ºber den Typ nicht sicher sind </li></ul><br><p>  Beispiel: stattdessen </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'response'</span></span> =&gt; $response-&gt;all(), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; $id, <span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; $someValue, ]</code> </pre> <br><p>  zu verwenden </p><br><pre> <code class="php hljs">[ <span class="hljs-string"><span class="hljs-string">'smsc_response_data'</span></span> =&gt; json_encode($response-&gt;all()), <span class="hljs-string"><span class="hljs-string">'customer_id'</span></span> =&gt; (string) $customer_id, <span class="hljs-string"><span class="hljs-string">'smsc_request_some_value'</span></span> =&gt; (string) $someValue, ]</code> </pre> <br><h3 id="vyzov-loggera-iz-koda">  Aufruf eines Loggers aus dem Code </h3><br><p>  Um ein Ereignis schnell im Protokoll aufzuzeichnen, k√∂nnen Sie verschiedene Optionen ausw√§hlen.  Betrachten wir einige davon. </p><br><ol><li>  Deklarieren Sie das globale Funktionsprotokoll <code>log()</code> und rufen Sie es aus verschiedenen Teilen des Programms auf.  Dieser Ansatz hat viele Nachteile.  In Klassen, in denen wir auf diese Funktion zugreifen, wird beispielsweise eine implizite Abh√§ngigkeit gebildet.  Dies sollte vermieden werden.  Dar√ºber hinaus ist ein solcher Logger schwer zu konfigurieren, wenn das System mehrere verschiedene haben muss.  Ein weiterer Nachteil, wenn wir √ºber die Arbeit mit Laravel sprechen, ist, dass wir die vom Framework bereitgestellten Funktionen nicht verwenden, um dieses Problem zu l√∂sen. </li><li>  Verwenden Sie Laravel Fassade \ Log.  Bei diesem Ansatz h√§ngen die Teile des Systems, die auf diese Fassade zugreifen, vom Rahmen ab.  In Teilen des Systems, die wir nicht aus dem Framework entfernen werden, ist eine solche L√∂sung durchaus geeignet.  Schreiben Sie beispielsweise von einigen Instanzen eines Konsolenbefehls, einer Hintergrundaufgabe oder eines Controllers.  Oder wenn es bereits eine komplizierte Struktur von Diensten gibt und das Einwerfen einer Instanz eines Loggers in diese nicht so einfach ist. </li><li>  L√∂sen Sie die Logger-Abh√§ngigkeit √ºber die Helfer des Frameworks <code>app()</code> und <code>resolve()</code> .  Der Ansatz hat die gleichen Nachteile wie die Verwendung der Fassade, Sie m√ºssen jedoch etwas mehr Code schreiben. </li><li>  Geben Sie die Abh√§ngigkeit vom Logger im Konstruktor der Klasse an, die dieser Logger verwenden wird.  Gleichzeitig sollte dasselbe <code>LoggerInterface</code> als Typ angegeben werden, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DIP</a> zu erf√ºllen.  Dank Autowiring-Frameworks werden Abh√§ngigkeiten bei der Implementierung ihrer deklarierten Abstraktionen automatisch aufgel√∂st.  In Laravel k√∂nnen einige Abh√§ngigkeitsklassen in einer separaten Methode angegeben werden, anstatt im Konstruktor der gesamten Klasse angegeben zu werden. </li></ol><br><h3 id="gde-v-kode-vyzyvat-logger">  Wo im Code, um den Logger aufzurufen </h3><br><p>  Bei der Organisation des Codes im Projekt kann sich die Frage stellen, in welcher Klasse ich in das Protokoll schreiben soll.  Sollte es ein Service sein?  Oder sollte dies dort erfolgen, wo der Dienst aufgerufen wird: Controller, Hintergrundaufgabe, Konsolenbefehl?  Oder sollte jede Ausnahme entscheiden, was mit ihrer <code>report</code> (Laravel) in das Protokoll geschrieben werden soll?  Es gibt keine einfache Antwort auf alle Fragen gleichzeitig. </p><br><p>  Betrachten Sie die von Laravel gegebene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gelegenheit</a> , die Aufgabe der Protokollierung selbst an die Ausnahmeklasse zu delegieren.  Eine Ausnahme kann nicht wissen, wie wichtig es f√ºr das System ist, die Ebene eines Ereignisses zu bestimmen.  Dar√ºber hinaus hat eine Ausnahme keinen Zugriff auf den Kontext, es sei denn, sie wird beim Aufruf dieser Ausnahme speziell hinzugef√ºgt.  Um die <code>render</code> f√ºr eine Ausnahme aufzurufen, d√ºrfen Sie entweder die Ausnahme nicht abfangen (der globale ErrorHandler wird verwendet) oder den globalen Helfer <code>report()</code> abfangen und verwenden.  Mit dieser Methode k√∂nnen wir den PSR-3-Logger nicht jedes Mal aufrufen, wenn wir diese Ausnahme abfangen k√∂nnen.  Aber ich denke nicht, dass es sich lohnt, der Ausnahme eine solche Verantwortung zu √ºbertragen. </p><br><p>  Es scheint, dass wir uns immer nur bei Diensten anmelden k√∂nnen.  In der Tat k√∂nnen Sie in einigen Diensten die Protokollierung durchf√ºhren.  Betrachten Sie jedoch einen Service, der nicht vom Projekt abh√§ngt, und planen Sie im Allgemeinen, ihn in einem separaten Paket zusammenzufassen.  Dann wei√ü dieser Dienst nicht, wie wichtig er f√ºr das Projekt ist, und kann daher den Protokollierungsgrad nicht bestimmen.  Zum Beispiel ein Integrationsdienst mit einem bestimmten SMS-Gateway.  Wenn wir einen Netzwerkfehler erhalten, bedeutet dies nicht, dass er ziemlich schwerwiegend ist.  M√∂glicherweise verf√ºgt das System √ºber einen Integrationsdienst mit einem anderen SMS-Gateway, √ºber den ein zweiter Sendeversuch ausgef√ºhrt wird. Dann kann der Fehler des ersten als Warnung und der Fehler des zweiten als Fehler gemeldet werden.  Erst jetzt sollten alle diese Integrationen von einem anderen Dienst aufgerufen werden, der sich genau anmeldet.  Es stellt sich heraus, dass der Fehler in einem Dienst liegt und wir uns in einem anderen anmelden.  Aber manchmal haben wir keinen Service-Wrapper √ºber einem anderen Service - wir rufen ihn direkt vom Controller aus auf.  In diesem Fall halte ich es f√ºr zul√§ssig, in das Protokoll in der Steuerung zu schreiben, anstatt einen Service-Dekorateur f√ºr die Protokollierung zu schreiben. </p><br><p>  Ein Beispiel f√ºr die Verwendung von Abh√§ngigkeit und das √úbergeben von Kontext: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Commands</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Services</span></span>\<span class="hljs-title"><span class="hljs-title">ExampleService</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Log</span></span>\<span class="hljs-title"><span class="hljs-title">LoggerInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $signature = <span class="hljs-string"><span class="hljs-string">'example'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExampleService $service, LoggerInterface $logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $service-&gt;example(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $exception) { $logger-&gt;critical(<span class="hljs-string"><span class="hljs-string">'Example error'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'exception'</span></span> =&gt; $exception, ]); } } }</code> </pre><br><h2 id="kuda-pisat">  Wo man schreibt </h2><br><p>  Betrachten Sie die folgenden Optionen. </p><br><ol><li>  Gem√§√ü der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">12-Faktor-Anwendung</a> und einigen anderen Empfehlungen m√ºssen Sie in stdout, stderr der Anwendungslaufzeit schreiben.  Dazu k√∂nnen Sie im Konfigurationslogger <code>php://stdout</code> * angeben. </li><li>  Ignorieren Sie den 12-Faktor-Docker und schreiben Sie in Dateien.  Mit Laravel (Monolog) k√∂nnen Sie sogar die Protokollrotation konfigurieren.  Weitere Nachrichten aus Dateien k√∂nnen mit Filebeat gesammelt und zur Analyse an Logstash gesendet werden. </li><li>  Senden Sie Protokolle von der Anwendung direkt weiter, z. B. √ºber UDP, um die Leistung zu steigern. </li><li>  L√∂sungen kombinieren.  Schreiben Sie in Dateien, die mit Filebeat gesammelt und an Logstash gesendet werden.  Schreiben Sie in den Container stderr, um die <code>docker logs</code> und Protokolle bequem aus der Container-Orchestrierungsumgebung erfassen zu k√∂nnen.  In diesem Fall k√∂nnen Sie einige Kan√§le nur lokal schreiben, andere √ºber das Netzwerk senden. </li></ol><br><p>  * <em>In php-fpm 7.2 erhalten wir beim Schreiben von Protokollen in stdout "WARNUNG: [pool www] Kind X hat in stdout gesagt ...", und lange Nachrichten werden abgeschnitten.</em>  <em>Eine L√∂sung f√ºr dieses Problem ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .</em>  <em>In php-fpm 7.3 gibt es kein solches Problem.</em> </p><br><p>  Optionen f√ºr das Aufnahmeformat: </p><br><ul><li>  Vom Menschen lesbar (Zeilenumbr√ºche, Einr√ºckungen usw.) </li><li>  Maschinenlesbar (normalerweise json) </li><li>  Beide Formate gleichzeitig: maschinenlesbar in stdout f√ºr weiteres Routing, lesbar bei pl√∂tzlichen Routingproblemen und schnellem Debugging </li></ul><br><p>  Bei jeder der Optionen wird davon ausgegangen, dass die Protokolle weitergeleitet werden. Zumindest werden sie aus folgenden Gr√ºnden an ein einzelnes Verarbeitungssystem (Speicher) von Protokollen gesendet: </p><br><ol><li>  Langzeitspeicherung und Archivierung </li><li>  Gro√üe Trends </li><li>  Flexibles Ereignisbenachrichtigungssystem </li></ol><br><p>  Docker kann einen Protokollmanager angeben.  Der Standardwert ist <code>json-file</code> , dh der Docker f√ºgt die Ausgabe des Containers zur json-file auf dem Host hinzu.  Wenn wir einen Protokollmanager ausw√§hlen, der Datens√§tze irgendwo √ºber das Netzwerk sendet, k√∂nnen wir den <code>docker logs</code> nicht mehr verwenden.  Wenn stdout / stderr des Containers als einziger Ort zum Aufzeichnen von Anwendungsprotokollen ausgew√§hlt wurde, ist es bei Netzwerkproblemen oder Problemen mit einem einzelnen Repository m√∂glicherweise nicht m√∂glich, Eintr√§ge f√ºr das Debuggen schnell zu extrahieren. </p><br><p>  Wir k√∂nnen json-file docker und Filebeat verwenden.  Wir erhalten sowohl lokale Protokolle als auch weiteres Routing.  Es ist erw√§hnenswert, dass hier ein weiteres Merkmal des Dockers ist.  Wenn Sie ein Ereignis aufzeichnen, das l√§nger als 16 KB ist, bricht der Docker den Datensatz mit dem Symbol <code>\n</code> , was viele Protokollsammler verwirrt.  Hier gibt es ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Problem</a> .  Das Problem des Dockers konnte nicht gel√∂st werden, so dass es von den Sammlern gel√∂st wurde.  In einigen Versionen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unterst√ºtzt</a> Filebeat dieses Docker-Verhalten und kombiniert Ereignisse korrekt. </p><br><p>  Welche Kombination aller M√∂glichkeiten von Zielen und Aufnahmeformaten k√∂nnen Sie f√ºr Ihr Projekt selbst ausw√§hlen? </p><br><h2 id="ispolzovanie-filebeat--elk--elastalert">  Verwenden von Filebeat + ELK + Elastalert </h2><br><p>  Kurz gesagt kann die Rolle jedes Dienstes wie folgt beschrieben werden: </p><br><ul><li>  Filebeat - sammelt Ereignisse aus Dateien und sendet sie </li><li>  Logstash - analysiert Ereignisse und sendet </li><li>  Elasticsearch - speichert strukturierte Ereignisse </li><li>  Kibana - zeigt Ereignisse an (Grafiken, Aggregationen usw.) </li><li>  Elastalert - Sendet Warnungen basierend auf Anforderungen </li></ul><br><p>  Zus√§tzlich k√∂nnen Sie: zabbix, metricbeat, grafana und mehr. </p><br><p>  Nun mehr zu jedem. </p><br><h3 id="filebeat">  Filebeat </h3><br><p>  Sie k√∂nnen als separater Dienst auf dem Host ausgef√ºhrt werden. Sie k√∂nnen einen separaten Docker-Container verwenden.  Um mit dem Ereignisstrom von Docker zu arbeiten, wird der <code>/var/lib/docker/containers/*/*.log</code> .  Filebeat bietet eine Vielzahl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">von Optionen,</a> mit denen Sie das Verhalten in verschiedenen Situationen festlegen k√∂nnen (die Datei wird umbenannt, die Datei wird gel√∂scht und dergleichen).  Filebeat selbst kann json innerhalb des Ereignisses analysieren, aber nicht json kann auch in Ereignisse geraten, was zu einem Fehler f√ºhrt.  Die gesamte Ereignisverarbeitung erfolgt am besten an einem Ort. </p><br><div class="spoiler">  <b class="spoiler_title">Fragmentkonfiguration f√ºr Filebeat 6</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">filebeat.inputs: - type: docker containers: ids: - "*" processors: - add_docker_metadata: ~</code> </pre></div></div><br><h3 id="logstash">  Logstash </h3><br><p>  Kann Ereignisse aus vielen Quellen akzeptieren, aber hier betrachten wir Filebeat. <br>  In jedem Ereignis gibt es neben dem Ereignis selbst von stdout / stderr Metadaten (Host, Container usw.).  Es gibt viele integrierte Verarbeitungsfilter: Analysieren in regelm√§√üigen Abst√§nden, Analysieren von JSON, √Ñndern, Hinzuf√ºgen, L√∂schen von Feldern usw. Geeignet zum Parsen von Anwendungsprotokollen und nginx access.log in einem beliebigen Format.  Kann Daten in verschiedene Repositorys √ºbertragen, aber hier betrachten wir Elasticsearch. </p><br><div class="spoiler">  <b class="spoiler_title">Konfigurationsfragment des Logstash-Filters</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">if [status] { date { match =&gt; ["timestamp_nginx_access", "dd/MMM/yyyy:HH:mm:ss Z"] target =&gt; "timestamp_nginx" remove_field =&gt; ["timestamp_nginx_access"] } mutate { convert =&gt; { "bytes_sent" =&gt; "integer" "body_bytes_sent" =&gt; "integer" "request_length" =&gt; "integer" "request_time" =&gt; "float" "upstream_response_time" =&gt; "float" "upstream_connect_time" =&gt; "float" "upstream_header_time" =&gt; "float" "status" =&gt; "integer" "upstream_status" =&gt; "integer" } remove_field =&gt; [ "message" ] rename =&gt; { "@timestamp" =&gt; "event_timestamp" "timestamp_nginx" =&gt; "@timestamp" } } }</code> </pre> </div></div><br><h3 id="elasticsearch">  Elasticsearch </h3><br><p>  Elasticsearch ist ein sehr leistungsf√§higes Tool f√ºr eine Vielzahl von Aufgaben, kann jedoch zur √úberwachung von Protokollen nur mit einem bestimmten Minimum verwendet werden. <br>  Gespeicherte Ereignisse sind ein Dokument, Dokumente werden in Indizes gespeichert. <br>  Jeder Index ist ein Schema, in dem f√ºr jedes Feld des Dokuments ein Typ definiert ist.  Sie k√∂nnen ein Ereignis nicht im Index speichern, wenn mindestens ein Feld den falschen Typ hat. <br>  Mit verschiedenen Typen k√∂nnen Sie verschiedene Vorg√§nge f√ºr eine Gruppe von Dokumenten ausf√ºhren (f√ºr Zahlen - Summe, Min, Max, Durchschnitt usw., f√ºr Zeichenfolgen - Fuzzy-Suche usw.). <br>  F√ºr Protokolle empfiehlt das Management normalerweise die Verwendung von Tagesindizes - jeden Tag einen neuen Index. </p><br><p>  Die Gew√§hrleistung eines stabilen Betriebs von Elasticsearch mit zunehmendem Datenvolumen ist eine Aufgabe, die tiefere Kenntnisse √ºber dieses Tool erfordert.  Eine schnelle L√∂sung f√ºr das Stabilit√§tsproblem besteht jedoch darin, veraltete Daten automatisch zu l√∂schen.  Zu diesem Zweck empfehle ich, die Ereignisebenen in logstash auf verschiedene Indizes aufzuteilen.  Dadurch k√∂nnen seltene, aber wichtigere Ereignisse l√§nger gespeichert werden. </p><br><div class="spoiler">  <b class="spoiler_title">Logstash-Ausgabekonfigurations-Snippet</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">output { if [fields][log_type] == "app_log" { if [level] in ["DEBUG", "INFO", "NOTICE"] { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-debug-%{+YYYY.MM.dd}" } } else { elasticsearch { hosts =&gt; "${ES_HOST}" index =&gt; "logstash-app-log-error-%{+YYYY.MM.dd}" } } } }</code> </pre> </div></div><br><p>  Um veraltete Indizes automatisch zu entfernen, empfehle ich die Verwendung eines Programms von Elastic <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Curator</a> .  Der Start des Programms wird dem Cron-Zeitplan hinzugef√ºgt. Die Konfiguration selbst kann in einer separaten Datei gespeichert werden. </p><br><div class="spoiler">  <b class="spoiler_title">Ein Fragment der Konfiguration zum Entfernen veralteter Indizes</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">action: delete_indices description: logstash-app-log-error options: ignore_empty_list: True filters: - filtertype: pattern kind: prefix value: logstash-app-log-error- - filtertype: age source: name direction: older timestring: '%Y.%m.%d' unit: months unit_count: 6</code> </pre> </div></div><br><p>         ,         Filebeat  Logstash,   .    Elasticsearch    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">-- </a> , ,    . </p><br><h3 id="kibana"> Kibana </h3><br><p> Kibana        .  -,     Elasticsearch.       . </p><br><p>   Kibana ‚Äî         Discovery   . ,   Discovery       app   warning  ,    time, message, exception class, host, client_id. </p><br><p>  ,  Discovery       nginx,       404    time, message, request, status. <br>   Kibana   ,        :  ,  ,     . ,       (        ). </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/habr/post_images/c1d/feb/5a3/c1dfeb5a364508015c4787f5e457528a.jpg" alt="Bild"></p></div></div><br><h3 id="elastalert"> Elastalert </h3><br><p> Elastalert      Elasticsearch      .  , .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  </a> ,          . <br>       ,         (),       . </p><br><p>   : </p><br><ul><li>       ALERT, EMERGENCY.  ‚Äî 10  </li><li>       CRITICAL.  ‚Äî 30  </li><li>    ,  N   X  M  </li><li>    10 INFO  3  </li><li>   nginx   200, 201, 304     75%  ,     50  </li></ul><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Blacklist ALERT, EMERGENCY type: blacklist index: logstash-app-* compare_key: "level" blacklist: - "ALERT" - "EMERGENCY" realert: minutes: 5 alert: - "slack"</code> </pre></div></div><br><p>             ‚Äî <strong>  </strong> .       ,      ,   .        Kibana. </p><br><p>    , ,   http-     75%  ,     ,   ,     ,    .  -   ,     ,      ,     . </p><br><p>         , ,  ,     ,       Kibana,        . </p><br><p>    5     .    , ,     ,  ,  ,     . </p><br><p>      ,          .       . </p><br><p>            Kibana    .            . </p><br><h2 id="vsyo-vmeste">   </h2><br><p>      docker-.     ,         ,    staging-  production-,      . </p><br><p>   ,   Elastalert,      .  Elastalert  ,    <br> <code>envsubst &lt; /opt/elastalert/config.dist.yaml &gt; /opt/elastalert/config.yaml</code>  entrypoint-   ,   . </p><br><p>        ,       ,       ,     . </p><br><div class="spoiler"> <b class="spoiler_title">    Makefile       </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">build: docker build -t some-registry/elasticsearch elasticsearch docker build -t some-registry/logstash logstash docker build -t some-registry/kibana kibana docker build -t some-registry/nginx nginx docker build -t some-registry/curator curator docker build -t some-registry/elastalert elastalert push: docker push some-registry/elasticsearch docker push some-registry/logstash docker push some-registry/kibana docker push some-registry/nginx docker push some-registry/curator docker push some-registry/elastalert pull: docker pull some-registry/elasticsearch docker pull some-registry/logstash docker pull some-registry/kibana docker pull some-registry/nginx docker pull some-registry/curator docker pull some-registry/elastalert prepare: docker network create -d bridge elk-network || echo "ok" stop: docker rm -f kibana || true docker rm -f logstash || true docker rm -f elasticsearch || true docker rm -f nginx || true docker rm -f elastalert || true run-logstash: docker rm -f logstash || echo "ok" docker run -d --restart=always --network=elk-network --name=logstash -p 127.0.0.1:5001:5001 -e "LS_JAVA_OPTS=-Xms256m -Xmx256m" -e "ES_HOST=elasticsearch:9200" some-registry/logstash run-kibana: docker rm -f kibana || echo "ok" docker run -d --restart=always --network=elk-network --name=kibana -p 127.0.0.1:5601:5601 --mount source=elk-kibana,target=/usr/share/kibana/optimize some-registry/kibana run-elasticsearch: docker rm -f elasticsearch || echo "ok" docker run -d --restart=always --network=elk-network --name=elasticsearch -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" --mount source=elk-esdata,target=/usr/share/elasticsearch/data some-registry/elasticsearch run-nginx: docker rm -f nginx || echo "ok" docker run -d --restart=always --network=elk-network --name=nginx -p 80:80 -v /root/elk/.htpasswd:/etc/nginx/.htpasswd some-registry/nginx run-elastalert: docker rm -f elastalert || echo "ok" docker run -d --restart=always --network=elk-network --name=elastalert --env-file=./elastalert/.env some-registry/elastalert run: prepare run-elasticsearch run-kibana run-logstash run-elastalert delete-old-indices: docker run --rm --network=elk-network -e "ES_HOST=elasticsearch:9200" some-registry/curator curator --config /curator/curator.yml /curator/actions.yml</code> </pre> </div></div><br><p>      : </p><br><ul><li>    80  nginx,     basic auth  Kibana </li><li>  Logstash  .       ssh- </li><li>       nginx </li><li>    ,  docker- </li><li>           </li><li>          </li><li>       ,  .env-    nginx- </li><li>  *_JAVA_OPTS   ,          4GB RAM (        ES). </li></ul><br><p>  ,          xpack-. </p><br><p>    docker-compose. ,   ,   Dockerfile-,  Filebeat,  Logstash,  ,   ,     ,    ,        VCS. </p><br><p>       .      .     ,    ( Laravel    scheduler), ,     5   .          ALERT.     ,    .    ,     ,      . </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  ,      ,    ,           .       . ,   -      .              .   ,   ,  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de456676/">https://habr.com/ru/post/de456676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de456666/index.html">WebTotem oder wie wir das Internet sicherer machen wollen</a></li>
<li><a href="../de456668/index.html">Microsoft ML Spark: Eine Spark-Erweiterung, die SparkML humaner und LightGBM als Bonus macht</a></li>
<li><a href="../de456670/index.html">√úber die Spionageauthentifizierungsmethode</a></li>
<li><a href="../de456672/index.html">Nginx-Rezepte: Asynchrone Benachrichtigungen von PostgreSQL an den Websocket</a></li>
<li><a href="../de456674/index.html">Neue Werbem√∂glichkeiten auf Facebook, von denen Sie nichts wussten</a></li>
<li><a href="../de456678/index.html">Der elektronische Zustand der Zukunft. Teil 4</a></li>
<li><a href="../de456680/index.html">Acht Namensgesetze im UX-Design (Teil 2)</a></li>
<li><a href="../de456682/index.html">Undefiniertes Verhalten mit veralteten Funktionsdeklarationen in ANSI C.</a></li>
<li><a href="../de456684/index.html">Behebung eines kleinen Fehlers in calc.exe</a></li>
<li><a href="../de456686/index.html">Die Feinheiten von Interviews bei der Einstellung von Udalenka</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>