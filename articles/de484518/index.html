<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí´ ‚≠ïÔ∏è üçü Wir bekommen das Video von der Kamera via DVRIP mit PHP üëÉüèΩ üë©üèø‚Äçüîß üë®‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In einem fr√ºheren Artikel habe ich versprochen, ein Skript zu zeigen, das das Video aus der Kamera zieht, und obwohl seitdem eine gewisse Zeit vergang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir bekommen das Video von der Kamera via DVRIP mit PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/"> In einem <a href="https://habr.com/ru/post/482864/">fr√ºheren Artikel habe</a> ich versprochen, ein Skript zu zeigen, das das Video aus der Kamera zieht, und obwohl seitdem eine gewisse Zeit vergangen ist, m√ºssen die Versprechen erf√ºllt werden.  Also mache ich es. <br><br>  Es ist einfach so passiert, dass mit Asynchronit√§t in der Welt des Server-Web alles zusammenh√§ngt, aber nicht PHP. <br><br>  Nun, weil dieses aussterbende Modell Speicherverluste aufweist und es in PHP in der Tat nichts von der <a href="https://www.php.net/manual/ru/function.stream-select.php">Stange gibt,</a> au√üer <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_select ()</a> und <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_set_blocking ()</a> . <br><br>  Irgendwo dort, in PECL, gibt es eine Art <a href="https://pecl.php.net/package/uv">libuv</a> , das im Prinzip nur ein Wrapper f√ºr die urspr√ºnglichen Funktionen der urspr√ºnglichen Bibliothek ist. <a href="https://pecl.php.net/package/uv">Wenn</a> Sie es also so verwenden, wie es ist, ergeben sich einige Herausforderungen.  Wie auch immer, wer wird das bei klarem Verstand tun? <br><br>  Aber wenn wir aufh√∂ren, in der Welt von PHP4 zu leben, und ein wenig zu modernen Realit√§ten zur√ºckkehren, werden wir sehen, dass sich die Dinge in den letzten Jahren etwas ver√§ndert haben.  Wir haben so interessante Tools wie <b>ReactPHP</b> und <b>AmPHP</b> , deren Komponenten die Funktionalit√§t von <b>Node.j</b> <b>gut</b> abdecken, und das Vorhandensein von Generatoren erm√∂glicht es uns, asynchronen Code in einem praktischen Stil wie <i>async / await</i> zu schreiben und all diese endlosen R√ºckrufe in R√ºckrufen und Kilometerketten zu <i>vermeiden. ) .then (). then ()</i> . <br><br>  Aus diesem Grund gibt es meiner Meinung nach praktisch keine Aufgaben aus der Welt von Node.js, die PHP nicht l√∂sen konnte.  Aber wenn es noch welche gibt, dann h√§ngt alles nur vom Vorhandensein einiger separater Bibliotheken ab und nicht vom Mangel an M√∂glichkeiten an sich. <br><blockquote>  Es mag Leute √ºberraschen, zu erfahren, dass die PHP-Standardbibliothek bereits alles enth√§lt, was wir zum Schreiben ereignisgesteuerter und nicht blockierender Anwendungen ben√∂tigen.  Wir sto√üen in diesem Bereich nur dann an die Grenzen der nativen PHP-Funktionalit√§t, wenn wir Tausende von Dateideskriptoren gleichzeitig nach IO-Aktivit√§ten fragen.  Selbst in diesem Fall liegt der Fehler jedoch nicht bei PHP, sondern beim zugrunde liegenden Aufruf select () des Systems, der bei zunehmender Last eine lineare Verschlechterung der Leistung aufweist. <br><br>  <i><a href="https://amphp.org/amp/event-loop/">amphp.org/amp/event-loop</a></i> </blockquote><a name="habracut"></a><br>  Nat√ºrlich ist die Frage, ob Sie all dies in der Produktion nutzen k√∂nnen, noch nicht vollst√§ndig gekl√§rt. Wenn Sie jedoch keine offensichtlichen Fehler machen, die Ihnen eine andere asynchrone Laufzeitumgebung nicht verzeihen w√ºrde, ist alles in Ordnung. <br><br><h3>  DVRIP </h3><br>  Wir werden das angeblich von den Chinesen erfundene Protokoll betrachten, das zur Kommunikation von Software mit √úberwachungskameras verwendet wird. <br><br>  Es funktioniert alles √ºber TCP, DVRIP (manchmal Sofia) genannt, und als ich es brauchte, fand ich nur zwei mehr oder weniger vern√ºnftige Bibliotheken, von denen eine beschrieb, dass im Allgemeinen nur eine Verbindung mit der Kamera hergestellt und ein paar Nachrichten ausgetauscht wurden, aber Paket-Header-Beschreibung, die mir sehr geholfen hat. <br><br>  Das zweite wurde ein wenig sp√§ter gefunden, als sich mein Syndrom verschlimmerte, und es funktionierte ein wenig anders als ich es gerne h√§tte. <br><br>  Im Allgemeinen habe ich mit einem Schn√ºffler und einer Beschreibung des Paket-Headers ein bestimmtes Skript skizziert, das sich irgendwo auf meinem Server dreht, und in diesem Artikel wird ein bestimmter Proof of Concept vorgestellt. <br><br>  Das Protokoll selbst ist nicht komplex und das Paket sieht folgenderma√üen aus: <br><br><ul><li>  Header von 20 Bytes, der in PHP als bezeichnet werden kann <br><br><pre><code class="php hljs">unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, $buffer)</code> </pre> </li><li>  Der Header wird von einer langen Nachricht gefolgt und kann entweder json, erg√§nzt durch zwei Bytes \ x0a \ x00, oder Bin√§rdaten enthalten. </li></ul><br>  Wir werden nur json senden, aber wir werden beide empfangen. <br><br>  Die Antwort (wenn es sich um ein Paket mit json handelt) enth√§lt normalerweise ein <b>Ret-</b> Feld, das den Erfolg unserer Anfrage anzeigt.  Antworten, die einen <b>Ret-</b> Code ungleich <b>100</b> oder <b>515 enthalten</b> , werden absichtlich als fehlerhaft eingestuft. <br><br>  Lassen Sie uns mit diesem Grundwissen eine Verbindung zur Kamera herstellen und verstehen. <br>  Wir brauchen zwei Bibliotheken - <a href="https://github.com/amphp/socket">amphp / socket</a> , die fast alles <a href="https://packagist.org/packages/evenement/evenement">abrufen</a> , was wir brauchen, und <a href="https://packagist.org/packages/evenement/evenement">evenement / evenement</a> , die in packagist verf√ºgbar sind und keine Erweiterungen erfordern. <br><br>  Die Arbeit mit TCP in Amp sieht ungef√§hr so ‚Äã‚Äãaus: <br><br><pre> <code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">"tcp://{$addr}:{$port}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($chunk = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $chunk; } $socket-&gt;close(); });</code> </pre> <br>  DVRIP l√§uft normalerweise auf Port 34567, in unserem Fall ist es also ungef√§hr so: <br><br><pre> <code class="php hljs">$socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://192.168.0.200:34567'</span></span>);</code> </pre> <br>  Als n√§chstes melden wir uns an, indem wir unseren Benutzernamen und unser Passwort an die Kamera senden. Diese werden wie folgt berechnet: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); }</code> </pre> <br>  Bei erfolgreicher Autorisierung fordern wir ein Video an, und wenn die Kamera es uns geben kann, beginnen wir mit der √úbertragung. <br><br>  Jeder Pakettyp hat eine eigene msgId, damit wir verstehen, auf welche Anfrage wir die Antwort erhalten haben.  Im Allgemeinen kein staubiger Job. <br><br>  Beschreiben wir der Einfachheit halber zun√§chst die Klasse f√ºr unser Paket: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } }</code> </pre> <br>  und versuchen Sie, eine Autorisierungsanfrage zu senden <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ]));</code> </pre> <br>  Ja, gro√üartig.  Wir haben eine Verbindung hergestellt und eine Nachricht gesendet, aber wir wissen nicht einmal, ob die Kamera korrekt war und haben zumindest irgendwie darauf reagiert.  Wir m√ºssen die Antwort irgendwie lesen (machen wir es asynchron), bestimmte Pakete darin ausw√§hlen und sie dekodieren. <br><br>  Um die Logik der Verarbeitung von Paketen, die als Antwort <b>eingehen</b> , irgendwie zu trennen, entschied ich mich f√ºr die Verwendung der <b>Abendbibliothek</b> und skizzierte darauf basierend eine Klasse, die bereits dekodierte Pakete <b>auswirft</b> <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  Au√üerdem wurden unserer Packet-Klasse einige statische Methoden hinzugef√ºgt, mit denen Pakete aus dem Datenstrom extrahiert und dekodiert werden <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; }</code> </pre><br>  Jetzt k√∂nnen wir durch die Verwendung von <b>Evenement</b> unsere Logik in der Form beschreiben <br><br><pre> <code class="php hljs">$reader-&gt;on($packetType, $handler);</code> </pre> <br>  Und so bekam ich diese Kette, in der ich eine weitere Keep Alive- und SIGINT / SIGTERM-Verarbeitung hinzuf√ºgte: <br><br><pre> <code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout());</code> </pre> <br>  Es versteht sich von selbst, dass wir anstelle von stdout den Videostream umleiten k√∂nnen, wo immer wir wollen. <br><br><div class="spoiler">  <b class="spoiler_title">Letztes Drehbuch</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Emitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Promise</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">InputStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">IteratorStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Evenement</span></span>\<span class="hljs-title"><span class="hljs-title">EventEmitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">call</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCoroutine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStderr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStdout</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">pipe</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Socket</span></span>\<span class="hljs-title"><span class="hljs-title">connect</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } } Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout()); });</code> </pre> </div></div><br>  Jetzt k√∂nnen wir versuchen, auf diese Weise ein Video aufzunehmen <br><br><pre> <code class="bash hljs">$ php recorder.php &gt; output.h264</code> </pre> <br>  Wir haben einen SIGINT-Handler hinzugef√ºgt. Wenn Sie also m√ºde werden, dr√ºcken Sie einfach Strg + C und das Skript stoppt die Video√ºbertragung und schlie√üt die Verbindung normal. <br><br>  Und wir k√∂nnen zum Beispiel den Stream nach ffmpeg umleiten und on the fly transcodieren. <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code> </pre> <br>  Und Sie k√∂nnen aus der Form verzweifelte Ketten machen <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ...</code> </pre> <br>  Starten Sie all dies mit einer Art Skript, das jede Stunde neu gestartet wird, sodass wir reibungslose Teile mit einer Dauer von 1 Stunde erhalten, und zwar im Handumdrehen, wo immer wir sie ben√∂tigen. <br><br><h3>  Warum? </h3><br>  Ich bin geneigt zu glauben, dass dieser Artikel die Frage "Warum?"  Es gibt fertige L√∂sungen f√ºr die Registrierung von Kameras, Kameras k√∂nnen im Allgemeinen eine Menge Dinge selbst tun, wie sie in den Kommentaren zum vorherigen Artikel zu Recht beanstandet haben, und im Allgemeinen k√∂nnte es viel einfacher gemacht werden. <br><br>  Ich hatte nur Freizeit, die ich irgendwo machen musste, den Wunsch, meinen eigenen Weg zu gehen, und das unerm√ºdliche Verlangen nach Experimenten. <br><br>  Und es funktioniert. <br><br>  Nat√ºrlich erfordert das im Artikel vorgestellte Skript einige √Ñnderungen, und Sie sollten es nicht in dieser Form verwenden - ich wiederhole, dies ist ein Proof of Concept.  Im Allgemeinen rate ich Ihnen dringend, kniehohe hausgemachte Produkte zu verwenden, um die Sicherheit Ihres Zuhauses zu gew√§hrleisten. <br>  In meinem Fall ist Zuverl√§ssigkeit nicht so wichtig, daher funktioniert diese Option.  √úber dieses Skript dreht sich ein Skript-Beobachter, der den Stream zu ffmpeg √ºbertr√§gt, stundenweise St√ºcke aufzeichnet und auf die VK hochl√§dt. Bei einer Unterbrechung oder einigen unvorhergesehenen Ereignissen wird das Skript neu gestartet. <br><br>  Im Allgemeinen h√§tte dies alles vermieden werden k√∂nnen, indem einfach das Video √ºber RTSP √ºber TCP abgerufen wurde, wie ich am Ende des vorherigen Artikels angedeutet hatte, aber ffmpeg hielt gerne zu einem zuf√§lligen Zeitpunkt inne und reagierte nur auf SIGKILL. <br><br>  Ich begann zu vermuten, dass all dies darauf zur√ºckzuf√ºhren war, dass die √ºbergeordnete Skript√ºberwachung von der Krone ausgef√ºhrt wurde und eine niedrigere Priorit√§t erhielt, die Erh√∂hung der Priorit√§t jedoch nur die H√§ufigkeit des Problems verringerte. <br><br>  Im Falle des obigen Skripts funktioniert alles viel stabiler und hat noch keine Beschwerden hervorgerufen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de484518/">https://habr.com/ru/post/de484518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de484502/index.html">Facebook zwingt die Moderatoren, sekundengenau ihre Arbeitszeiten zu dokumentieren - sogar auf die Toilette zu gehen</a></li>
<li><a href="../de484504/index.html">Herstellung eines Luftionisators f√ºr weniger als 10 US-Dollar</a></li>
<li><a href="../de484506/index.html">Ich bin Fotograf und werde mich selbst zum Arbeitsger√§t machen</a></li>
<li><a href="../de484512/index.html">TOP 25 der gr√∂√üten ICOs: Was ist jetzt mit ihnen los?</a></li>
<li><a href="../de484514/index.html">Universelles Routing f√ºr reaktive Anwendungen</a></li>
<li><a href="../de484520/index.html">Wie das Zip-Archiv aussieht und was wir damit machen k√∂nnen. Teil 3 - Praktische Anwendung</a></li>
<li><a href="../de484522/index.html">DEFCON-Konferenz 27. Hacken Sie die Polizei. Teil 2</a></li>
<li><a href="../de484526/index.html">Vorbereiten eines SDL2-Projekts f√ºr die Ausf√ºhrung unter Android</a></li>
<li><a href="../de484528/index.html">Wie ich mein Hobbyprojekt auf k8s √ºbertragen habe</a></li>
<li><a href="../de484530/index.html">CNC-Maschine zur Plasmabearbeitung / Modifikation von Polymerwerkstoffen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>