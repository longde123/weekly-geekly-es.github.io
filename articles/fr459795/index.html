<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèª ‚õé üíò Bitrix et mettre √† jour MariaDB vers la derni√®re version stable üë©üèø‚Äç‚úàÔ∏è üì´ ‚åõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, chers Khabrovchians! Permettez-moi de me pr√©senter, Alexander. Administrateur syst√®me d'un petit mais fier WEB-studio. Nous voulons vraiment ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bitrix et mettre √† jour MariaDB vers la derni√®re version stable</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459795/">  Bonjour, chers Khabrovchians!  Permettez-moi de me pr√©senter, Alexander.  Administrateur syst√®me d'un petit mais fier WEB-studio.  Nous voulons vraiment que tout fonctionne rapidement, en toute s√©curit√© et avec de nouveaux logiciels.  Pour ce faire, ils ont m√™me lev√© un tas de nagios + PhantomJS sur l'ordinateur de bureau et v√©rifi√© la vitesse de chargement des pages toutes les 30 minutes.  Selon les conditions de service, nous suivons √©galement les mises √† jour de 1C-Bitrix et les installons r√©guli√®rement.  Et une fois, apr√®s la prochaine mise √† jour, nous voyons un message dans le panneau d'administration indiquant qu'√† l'√©t√© 2019, 1C-Bitrix cesse de fonctionner avec MySQL 5.5 et doit √™tre mis √† jour.  Les gars de ISPSystem sont beaux et √©tendent r√©guli√®rement les fonctionnalit√©s du panneau, pour lesquelles un merci sp√©cial √† eux.  Mais cette fois, il n'a pas √©t√© possible de cliquer sur toute la souris.  Mais ce qui s'est pass√© et la quantit√© de cheveux gris dans ma barbe se trouvent sous la coupe. <br><a name="habracut"></a><br>  Il n'y avait qu'une option pour mettre un ¬´serveur SGBD alternatif¬ª qui est plac√© dans le conteneur Docker.  Bien s√ªr, je comprends que Docker est tr√®s √©conome en ressources, mais peu importe √† quel point il fonctionne, les frais g√©n√©raux seront toujours&gt; 0.  Et l√†, on se bat, pour ainsi dire, en dixi√®mes de seconde, et √† l'entr√©e on optimise tous les sites avant de publier et signer un contrat.  Ce n'est donc pas mon option. <br>  Ok, qu'est-ce qui est √©crit dans la documentation?  Total de la sauvegarde, ajoutez un fichier avec un lien vers le r√©f√©rentiel MariaDB dans yum.repos.d, puis <br><br><pre><code class="bash hljs">rpm -e --nodeps MariaDB-server MariaDB-client MariaDB-common</code> </pre> <br>  Yum maudira plus tard que quelqu'un ait supprim√© / install√© des packages √† son insu.  Mais d'abord - laissez-le jurer, √ßa va.  Et deuxi√®mement, si vous effectuez la suppression via yum, alors il essaie de d√©molir avec MariaDB tout ce qui lui est li√©, et c'est PHP et ISPManager et PHPmyadmin.  Par cons√©quent, nous traiterons des gribouillis. <br><br><pre> <code class="bash hljs">yum clean all yum update yum install MariaDB-server MariaDB-client MariaDB-common</code> </pre> <br>  En g√©n√©ral, tout a √©t√© install√© et termin√©.  Ce qui est bien, c'est que les bases ont √©t√© r√©cup√©r√©es et qu'il n'a pas √©t√© n√©cessaire de les restaurer √† partir des d√©charges.  J'ai v√©rifi√© les sites - ils fonctionnent et rapidement.  Je suis all√© dans quelques pages d'administration pour m'assurer que rien ne tombait et j'ai √©crit au directeur que tout allait bien.  En moins de 30 minutes, il s'est av√©r√© que ce n'√©tait pas du tout OK ... <br><br>  Lorsque vous essayez d'acc√©der au panneau d'administration et d'ajouter / modifier quoi que ce soit, un message est tomb√© dans le contenu <br><br><pre> <code class="sql hljs">MySQL Query Error: <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> b_iblock_element_property (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, IBLOCK_ELEMENT_ID, IBLOCK_PROPERTY_ID, VAL UE, VALUE_NUM) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10555</span></span> ,<span class="hljs-number"><span class="hljs-number">2201</span></span> ,P.ID ,<span class="hljs-string"><span class="hljs-string">'3607'</span></span> ,<span class="hljs-number"><span class="hljs-number">3607.0000</span></span> FR OM b_iblock_property P <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> = <span class="hljs-number"><span class="hljs-number">184</span></span> [[<span class="hljs-number"><span class="hljs-number">1062</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">Duplicate</span></span> entry <span class="hljs-string"><span class="hljs-string">'10555'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> <span class="hljs-string"><span class="hljs-string">'PRIMARY'</span></span>]</code> </pre> <br>  Depuis que nos employ√©s ajoutent du contenu au site, les clients ne savaient toujours rien et n'avaient pas encore commenc√© √† nous s√©parer.  Mais c'√©tait une question de temps car les informations sur les sites doivent √™tre mises √† jour et c'est ce que de nombreux clients se suivent et suivent de pr√®s. <br><br>  √Ä partir du texte d'erreur, nous pouvons conclure que Bitrix essaie d'ajouter un nouvel enregistrement √† la base de donn√©es tout en indiquant la m√™me cl√© primaire que l'article √©dit√©.  Il y a donc lieu de soup√ßonner que le probl√®me se pose du c√¥t√© de Bitrix.  Nous allons sur leur site Web et nous tournons vers le support.  Presque imm√©diatement, nous obtenons la r√©ponse ¬´un probl√®me difficile.  Je l'ai donn√© aux ing√©nieurs seniors - attendez ... " <br><br>  J'ai d√ª attendre longtemps (tout le dialogue a eu lieu du 25/06/2019 au 07/09/2019) et le r√©sultat a √©t√© le message ¬´ce probl√®me n'est pas li√© au travail de Bitrix CMS, mais √† la base de donn√©es elle-m√™me dans mariadb 10.4.6 et malheureusement avec du c√¥t√© du site ce probl√®me pour r√©soudre la possibilit√© est manquant il faudra passer √† l'ancienne version de MariaDB. <br><br>  Ils sont arriv√©s ... J'ai pens√© au d√©classement au d√©but de l'histoire, mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici on dit en noir et blanc</a> qu'il ne peut y avoir de d√©classement.  Fusionnez les vidages et d√©ployez √† nouveau sur un serveur correctement install√©.  C'est-√†-dire  c'est bien que je n'ai pas mis √† jour tous les serveurs √† la fois.  C'est-√†-dire  ¬´Juste¬ª une centaine de sites (un rire nerveux :-)).  Ils ont √©galement d√©clar√© √† l'appui: ¬´Pour r√©soudre le probl√®me lors de l'utilisation de la base de donn√©es MariaDB 10.4.6, vous devrez contacter le support technique de MariaDB que la transaction ne supprimera pas l'enregistrement de la base de donn√©es si la demande est faite: <br><br><pre> <code class="sql hljs">$DB-&gt;Query("<span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">".$strTable."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> = <span class="hljs-string"><span class="hljs-string">".$res["</span></span><span class="hljs-keyword"><span class="hljs-keyword">ID</span></span><span class="hljs-string"><span class="hljs-string">"]); $results = $DB-&gt;Query("</span></span><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">".$strTable."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> = <span class="hljs-string"><span class="hljs-string">".$res["</span></span><span class="hljs-keyword"><span class="hljs-keyword">ID</span></span><span class="hljs-string"><span class="hljs-string">"]);‚Äù</span></span></code> </pre> <br>  L'espoir se r√©chauffe depuis quelques heures depuis le d√©but de la communication avec le support de MariaDB, mais une lettre est arriv√©e dans laquelle ils m'ont correctement dit que je n'√©tais pas un utilisateur commercial et donc personne ne r√©soudrait d√©lib√©r√©ment mon probl√®me, mais il y avait un forum sur leur site Web et vous pouviez essayer de chercher des options l√†-bas ... Je ne porterai pas les d√©tails.  Il n'y a pas d'options l√†-bas. <br>  Oh!  Nous avons une licence achet√©e pour ISP! <br>  - Bonjour, support?  Les gars, aidez-moi! <br>  - D√©sol√©, nous ne prenons pas en charge les scumbags qui modifient la version native du SGBD.  Voulez-vous - il existe une option avec un autre serveur dans le docker. <br>  - Mais comment les utilisateurs et les bases de donn√©es y arrivent-ils?  Au docker? <br>  - Eh bien, vous les faites glisser avec vos mains ... <br>  - Oui!  Et n'oubliez pas que le port de mysql va changer et que vous devrez parcourir toutes les configurations et le r√©√©crire. <br>  - D'accord, merci, je vais penser ... <br>  J'ai pens√© et d√©cid√© de d√©molir 10.4 avec des stylos et de mettre 10.2 avec lequel il n'y avait aucun probl√®me sur d'autres serveurs. <br><br>  Le processus n'√©tait pas tr√®s diff√©rent du processus de mise √† jour.  Seulement, il √©tait n√©cessaire dans le lien vers le r√©f√©rentiel de changer 10.4 en 10.2, de r√©initialiser et de recr√©er le cache pour yum.  Eh bien, une autre "bagatelle": apr√®s avoir supprim√© 10.4, allez dans / var / lib / mysql et supprimez tout de l√†.  Sans cette √©tape, apr√®s l'installation de 10.2, le service tombera constamment et vous verrez <br><br><pre> <code class="bash hljs">      <span class="hljs-string"><span class="hljs-string">''</span></span> Lost connection to MySQL server at <span class="hljs-string"><span class="hljs-string">'reading initial communication packet'</span></span>, system error: 104 <span class="hljs-string"><span class="hljs-string">"Connection reset by peer"</span></span></code> </pre> <br>  Ou <br><br><pre> <code class="bash hljs">Lost connection to MySQL server at <span class="hljs-string"><span class="hljs-string">'handshake: reading inital communication packet'</span></span>, system error: 104</code> </pre> <br>  Avant d'importer les bases de donn√©es, j'ai d'abord d√©fini le mot de passe root pour mysql qui a √©t√© enregistr√© dans les configurations ISP et j'ai import√© le vidage de la base de donn√©es mysql.  Eh bien, comme il y a d√©j√† des utilisateurs et des droits, nous importons simplement toutes les bases d'utilisateurs d'affil√©e avec le compte root. <br><br>  Texte du script pour le vidage de la base de donn√©es: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo 'show databases' | mysql -u root --password="_" --skip-column-names | grep -v information_schema | xargs -I {} -t bash -c 'mysqldump -u root --password="_" {} | gzip &gt; /BACK/back-$(hostname)-{}-$(date +%Y-%m-%d-%H.%M.%S).sql.gz'</span></span></code> </pre> <br>  Avant d'importer des bases de donn√©es, vous devez les d√©compresser.  Il suffit donc d'ex√©cuter la commande <br><br><pre> <code class="bash hljs">gunzip /BACK/*.gz</code> </pre> <br>  Et le dernier: pour une raison quelconque, les tirets sont autoris√©s dans le nom des bases de donn√©es (si vous cr√©ez via ISPmanager).  Mais lorsque vous cr√©ez ou essayez de remplir le vidage dans la base de donn√©es avec un trait d'union dans le nom, vous obtenez un message indiquant que la syntaxe de la requ√™te est incorrecte. <br><br>  Lisez jusqu'√† la fin de toutes les b√©n√©dictions.  Je m'excuse pour les virgules les plus probablement non plac√©es - des probl√®mes avec eux.  S'il y a des souhaits / suggestions sur l'essence de ce qui est d√©crit - √©crivez dans un message personnel parce que j'ai peur de manquer quelque chose dans les commentaires.  Et ne jure pas beaucoup - c'est mon premier article :-) <br><br>  UPD1: <br><br>  J'ai presque oubli√© de mentionner: alors que j'essayais de trouver une solution au probl√®me sans r√©trograder MariaDB, j'ai d√ª mettre √† jour les informations en quelque sorte.  Il a √©t√© mis √† jour comme suit: toute la base de donn√©es est convertie d'InnoDB en MyISAM, les informations sont mises √† jour, puis elles sont reconverties en InooDB. <br>  UPD2: <br><br>  Une lettre vient d'arriver de 1C-Bitrix avec le contenu suivant: <br><blockquote>  Demande de r√©vision mise en ≈ìuvre <br>  "Apr√®s la mise √† jour de mariadb vers 10.4.6, une erreur s'est produite lors de l'enregistrement de l'√©l√©ment de bloc d'informations" <br>  Module: iblock, version: inconnue <br>  Solution: rejet√©e </blockquote>  Donc, m√™me s'il est apparemment impossible de mettre √† jour vers 10.4 :-( </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459795/">https://habr.com/ru/post/fr459795/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459775/index.html">Ce que j'ai appris sur l'apprentissage automatique apr√®s avoir travaill√© dans 12 startups</a></li>
<li><a href="../fr459785/index.html">Deep Learning: Pr√©sentation</a></li>
<li><a href="../fr459787/index.html">C ++, est le type d√©fini: d√©claration pr√©alable des objets n√©cessaires</a></li>
<li><a href="../fr459789/index.html">Mise √† jour des projets Unity Android pour la compatibilit√© avec l'architecture ARM64</a></li>
<li><a href="../fr459793/index.html">Comment trouver des noms significatifs pour votre code</a></li>
<li><a href="../fr459797/index.html">"Des lunettes N-nada?" ou "quel est le danger des verres chinois pr√™ts √† l'emploi avec des dioptries"?</a></li>
<li><a href="../fr459798/index.html">Snom D335 - T√©l√©phone IP multifonctionnel avec √©cran couleur TFT grand √©cran</a></li>
<li><a href="../fr459800/index.html">Visite photographique: ITMO University Optics Museum</a></li>
<li><a href="../fr459802/index.html">Habr Weekly # 9 / Burnout chez les jeunes, interfaces japonaises, r√©seau de neurones Battle.net, jeux et cruaut√©</a></li>
<li><a href="../fr459804/index.html">Cr√©ez des cartes d'aide de crowdsourcing sur WordPress + shMapper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>