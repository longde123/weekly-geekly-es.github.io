<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë®üèº üßíüèæ üèÇüèø An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio üë®‚Äç‚ù§Ô∏è‚Äçüë® üÖ±Ô∏è üï†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A partir de la versi√≥n 7.04, el analizador PVS-Studio para los lenguajes C y C ++ en Linux y macOS proporciona la funci√≥n de prueba de verificar la li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470982/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Cuadro 11"></div><br>  A partir de la versi√≥n 7.04, el analizador PVS-Studio para los lenguajes C y C ++ en Linux y macOS proporciona la funci√≥n de prueba de verificar la lista de archivos especificados.  Usando el nuevo modo, puede configurar el analizador para verificar las confirmaciones y las solicitudes de extracci√≥n.  Este art√≠culo cubre la configuraci√≥n de la verificaci√≥n de ciertos archivos modificados de un proyecto GitHub en sistemas populares de CI (integraci√≥n continua), como Travis CI, Buddy y AppVeyor. <br><a name="habracut"></a><br><h2>  Modo de verificar la lista de archivos </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PVS-Studio</a> es una herramienta dise√±ada para detectar errores y vulnerabilidades potenciales en el c√≥digo fuente de los programas, escritos en C, C ++, C # y Java.  Funciona en sistemas de 64 bits en Windows, Linux y macOS. <br><br>  En la versi√≥n PVS-Studio 7.04 para Linux y macOS ahora existe el modo de verificar la lista de archivos.  Funciona para proyectos, cuyo sistema de compilaci√≥n permite generar el archivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compile_commands.json</a> .  Es necesario para que el analizador obtenga informaci√≥n sobre la compilaci√≥n de ciertos archivos.  Si su sistema de compilaci√≥n no admite la generaci√≥n del archivo compile_commands.json, puede intentar generar dicho archivo utilizando la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bear</a> . <br><br>  Este modo de verificar la lista de archivos tambi√©n se puede usar con el registro de seguimiento de ejecuci√≥n del compilador generado por strace (pvs-studio-analyzer trace).  Para hacerlo, primero debe completar una compilaci√≥n completa del proyecto y rastrearla para que el analizador recopile informaci√≥n completa sobre los par√°metros de compilaci√≥n de todos los archivos verificados. <br><br>  Sin embargo, esta opci√≥n tiene un inconveniente importante: tendr√° que realizar un seguimiento de compilaci√≥n completo de todo el proyecto con cada ejecuci√≥n, lo que va en contra de la idea de una comprobaci√≥n de confirmaci√≥n r√°pida.  O si almacena en cach√© el resultado del seguimiento en s√≠, las ejecuciones posteriores del analizador podr√≠an estar incompletas en caso de que despu√©s de rastrear la estructura de los cambios de dependencias de los archivos de origen (por ejemplo, se agregue un nuevo #include en uno de los archivos de origen). <br><br>  Por lo tanto, no recomendamos usar el modo de verificar la lista de archivos con un registro de seguimiento para verificar las confirmaciones o las solicitudes de extracci√≥n.  Si puede realizar una compilaci√≥n incremental al verificar una confirmaci√≥n, considere usar el modo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis incremental</a> . <br><br>  La lista de archivos fuente para el an√°lisis se guarda en el archivo de texto y se pasa al analizador utilizando el par√°metro <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  Este archivo contiene rutas relativas y absolutas a los archivos donde cada nuevo archivo entra en una nueva l√≠nea.  Puede especificar ambos nombres de archivo para el an√°lisis y texto diferente.  En cuanto al texto, el analizador notar√° que no es un nombre de archivo e ignorar√° la l√≠nea.  Puede ser √∫til para comentar si los archivos se especifican manualmente.  Sin embargo, a menudo la lista de archivos se generar√° durante el an√°lisis de CI, por ejemplo, pueden ser archivos de una solicitud de confirmaci√≥n o extracci√≥n. <br><br>  Ahora, usando este modo, puede verificar r√°pidamente el nuevo c√≥digo antes de que entre en la rama de desarrollo principal.  El <i>indicador --indicate-warnings</i> se agreg√≥ en la utilidad <i>plog-converter</i> para que el sistema de verificaci√≥n respondiera a la presencia de advertencias del analizador. <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Con este indicador, el convertidor devolver√° un c√≥digo distinto de cero si hay advertencias en el informe del analizador.  Puede bloquear la solicitud de enlace de confirmaci√≥n previa, confirmaci√≥n o extracci√≥n y mostrar el informe del analizador generado, compartirlo o enviarlo por correo. <br><br>  <i>Nota</i>  <i>Durante el primer an√°lisis de la lista de archivos, se verificar√° todo el proyecto, ya que el analizador debe generar el archivo con dependencias de los archivos fuente del proyecto a partir de los archivos de encabezado.</i>  <i>Esta es una peculiaridad del an√°lisis de archivos C y C ++.</i>  <i>En el futuro, este archivo de dependencia se puede almacenar en cach√© y el analizador lo actualizar√° autom√°ticamente.</i>  <i>La ventaja de verificar las confirmaciones utilizando el modo de verificar la lista de archivos sobre el modo de an√°lisis incremental es el hecho de que debe almacenar en cach√© solo este archivo, no los archivos de objeto.</i> <br><br><h2>  Principios generales del an√°lisis de solicitud de extracci√≥n </h2><br>  El an√°lisis completo del proyecto lleva bastante tiempo, por lo que tiene sentido verificar solo una parte.  El problema es que necesita separar los archivos nuevos del resto de los archivos del proyecto. <br><br>  Veamos el ejemplo de un √°rbol de confirmaci√≥n de dos ramas: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Cuadro 5"></div><br><br>  Imagine que la confirmaci√≥n <i>A1</i> contiene una cantidad bastante grande de c√≥digo que ya se ha verificado.  Anteriormente, creamos una rama desde la confirmaci√≥n <i>A1</i> y cambiamos algunos archivos. <br><br>  Por supuesto, habr√°s notado que despu√©s de <i>A1</i> se llevaron a cabo otras dos confirmaciones, y otras dos ramas se fusionaron, ya que no nos comprometemos en <i>master</i> .  Aqu√≠ llega el momento en que la <i>revisi√≥n</i> est√° lista.  Es por eso que recibimos una solicitud de extracci√≥n para la fusi√≥n de <i>B3</i> y <i>A3</i> . <br><br>  Podr√≠amos verificar el resultado de su fusi√≥n, pero ser√≠a demasiado largo e irrazonable, ya que solo se han modificado algunos archivos.  Por lo tanto, es m√°s eficiente analizar solo los modificados. <br><br>  Para hacerlo, recibiremos la diferencia entre las ramas, estando en la CABEZA de la rama, de la que queremos fusionarnos en el maestro: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Consideraremos <i>$ MERGE_BASE</i> en detalle m√°s adelante.  El hecho es que no todos los servicios de CI proporcionan la informaci√≥n necesaria sobre la base de fusi√≥n, por lo que cada vez tenemos que pensar en nuevas formas de obtener estos datos.  Esto se considerar√° en los detalles a continuaci√≥n para cada uno de los servicios web descritos. <br><br>  Entonces obtuvimos una diferencia entre las ramas, que es la lista de nombres de archivos modificados.  Ahora necesitamos alimentar este archivo <i>.pvs-pr.list</i> al analizador.  Hemos redirigido la salida a ella anteriormente. <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Despu√©s del an√°lisis, necesitamos convertir el archivo de registro (PVS-Studio.log) a un formato f√°cil de usar: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Este comando generar√° la lista de errores en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">stderr</a> (flujo de error est√°ndar). <br><br>  El problema es que no solo necesitamos generar los errores, sino tambi√©n informar a nuestro servicio de compilaci√≥n y prueba sobre los problemas.  Para hacer esto, se agreg√≥ el indicador <i>-W</i> ( <i>--indicate-warnings</i> ) en el convertidor.  Si hay al menos una advertencia del analizador, el c√≥digo de retorno de la utilidad <i>plog-converter</i> cambiar√° a 2, lo que a su vez informar√° al servicio de CI sobre posibles errores en los archivos de solicitud de extracci√≥n. <br><br><h2>  Travis ci </h2><br>  La configuraci√≥n se realiza en forma de archivo <i>.travis.yml</i> .  Por conveniencia, le aconsejo que a√≠sle todos los comandos relacionados con PVS-Studio en un script bash separado con funciones que se <i>invocar√°n</i> desde el archivo <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ). <br><br>  Al expandir el script, obtendr√° m√°s funcionalidad.  En la secci√≥n de <i>instalaci√≥n</i> escriba lo siguiente: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Si ten√≠a algunas instrucciones, puede moverlas en el script, eliminando los guiones. <br><br>  Abra el archivo <i>.travis.sh</i> y agregue la instalaci√≥n del analizador en la funci√≥n <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Ahora agreguemos el analizador ejecutado en la secci√≥n de <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  Y en el script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Debe ejecutar este c√≥digo despu√©s de compilar el proyecto, por ejemplo, si tuvo una compilaci√≥n en CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Obtendr√°s lo siguiente: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Lo m√°s probable es que ya haya notado las variables de entorno <i>$ TRAVIS_PULL_REQUEST</i> y <i>$ TRAVIS_BRANCH</i> .  Travis CI los declara a s√≠ mismo: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> almacena el n√∫mero de solicitud de extracci√≥n o <i>falso</i> si es una rama regular; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> almacena el nombre del repositorio del proyecto. </li></ul><br>  Aqu√≠ est√° el algoritmo operativo de esta funci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebe/643/58b/ebe64358b6f4cc73db5d4b0094919faa.png" alt="Cuadro 13"></div><br>  Travis CI responde a los c√≥digos de retorno, por lo que la presencia de advertencias informar√° que el servicio marcar√° el compromiso como que contiene errores. <br><br>  Ahora echemos un vistazo m√°s de cerca a esta l√≠nea de c√≥digo: <br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  El hecho es que Travis CI fusiona autom√°ticamente las ramas al analizar una solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Cuadro 8"></div><br>  Por eso analizamos <i>A4</i> , no <i>B3-&gt; A3</i> .  Debido a esta peculiaridad, necesitamos evaluar la diferencia con <i>A3</i> , que es la cabeza de la rama desde el <i>origen</i> . <br><br>  Queda un detalle importante: el almacenamiento en cach√© de las dependencias de los archivos de encabezado de las unidades de traducci√≥n compiladas (* .c, * .cc, * .cpp y otras).  El analizador eval√∫a estas dependencias durante la primera ejecuci√≥n en el modo de verificar la lista de archivos y luego los almacena en el directorio .PVS-Studio.  Travis CI permite el almacenamiento en cach√© de repositorios, por lo que <i>guardaremos</i> datos en el <i>directorio .PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Este c√≥digo debe agregarse en el archivo <i>.travis.yml</i> : este directorio almacena varios datos, recopilados despu√©s del an√°lisis.  Estos datos aceleran significativamente las ejecuciones posteriores de an√°lisis de listas de archivos o an√°lisis incremental.  Si no lo hace, el analizador analizar√° todos los archivos cada vez. <br><br><h2>  Amigo </h2><br>  Al igual que Travis CI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Buddy le</a> permite crear y probar proyectos autom√°ticamente desde GitHub.  A diferencia de Travis CI, est√° configurado en la interfaz web (el soporte de bash est√° disponible), por lo que no es necesario almacenar archivos de configuraci√≥n en el proyecto. <br><br>  Primero, necesitamos agregar un nuevo paso a la tuber√≠a: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Imagen 1"></div><br>  Especifiquemos el compilador utilizado para construir el proyecto.  Preste atenci√≥n al contenedor acoplable, instalado durante este paso.  Por ejemplo, hay un contenedor especial para GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Cuadro 6"></div><br>  Ahora instalemos PVS-Studio y las utilidades necesarias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Imagen 2"></div><br>  Agregue las siguientes l√≠neas al editor: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Pasemos a la pesta√±a Ejecutar (primer icono) y agreguemos el siguiente c√≥digo al campo del editor apropiado: <br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Si lee la secci√≥n sobre Travs-CI, este c√≥digo le es familiar.  Pero aqu√≠ hay un nuevo paso: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/c65/3e3/a7ac653e3e89c4fc2a2b425b1ccefec8.png" alt="Cuadro 14"></div><br>  El hecho es que ahora analizamos no el resultado de la fusi√≥n, sino el HEAD de la rama con la solicitud de extracci√≥n marcada: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Cuadro 10"></div><br>  As√≠ que estamos en una confirmaci√≥n de <i>B3</i> y necesitamos obtener la diferencia con <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Para definir <i>A3</i> , usemos la API de GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Utilizamos las siguientes variables, que Buddy nos proporciona: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> : n√∫mero de una solicitud de extracci√≥n; </li><li>  <i>$ BUDDY_REPO_SLUG</i> : combinaci√≥n de un nombre de usuario y un repositorio (por ejemplo, max / test). </li></ul><br>  Ahora guardemos los cambios, usando el bot√≥n de abajo y habilite el an√°lisis de solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Cuadro 3"></div><br>  A diferencia de Travis CI, no tenemos que especificar <i>.pvs-studio</i> para el almacenamiento en cach√©, ya que Buddy almacena autom√°ticamente en cach√© todos los archivos para ejecuciones posteriores.  Entonces, lo √∫ltimo que queda es guardar el nombre de usuario y la contrase√±a para PVS-Studio en Buddy.  Despu√©s de guardar los cambios, volveremos a la canalizaci√≥n.  Necesitamos pasar a configurar las variables e insertar el inicio de sesi√≥n y la clave para PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Cuadro 4"></div><br>  Despu√©s de esto, se iniciar√° una verificaci√≥n con cada nueva solicitud de extracci√≥n o confirmaci√≥n.  Si un commit contiene errores, Buddy lo se√±alar√° en la p√°gina de solicitud de extracci√≥n. <br><br><h2>  Transportador </h2><br>  La configuraci√≥n de AppVeyor es similar a Buddy, ya que todo sucede en la interfaz web y no es necesario agregar el archivo * .yml en el repositorio del proyecto. <br><br>  Vayamos a la pesta√±a Configuraci√≥n en la revisi√≥n del proyecto: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Cuadro 12"></div><br>  Despl√°cese hacia abajo en esta p√°gina y habilite el almacenamiento en cach√© para la compilaci√≥n de solicitud de extracci√≥n: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Cuadro 18"></div><br><br>  Ahora pasemos a la pesta√±a Entorno, donde especificaremos la imagen para la compilaci√≥n y las variables de entorno necesarias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Cuadro 19"></div><br>  Si ha le√≠do las secciones anteriores, ya est√° familiarizado con estas dos variables: <i>PVS_KEY</i> y <i>PVS_USERNAME</i> .  Si no, perm√≠tame recordarle que son necesarios para verificar la licencia del analizador PVS-Studio.  En el futuro, los volveremos a encontrar en los scripts de Bash. <br><br>  En la misma p√°gina en la parte inferior, especifiquemos la carpeta de cach√©: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Cuadro 15"></div><br>  Si no lo hacemos, analizaremos todo el proyecto en lugar de un par de archivos, pero recibiremos el resultado de los archivos especificados.  Por lo tanto, es importante ingresar el nombre correcto del repositorio. <br><br>  Ahora ha llegado el momento de la secuencia de comandos de verificaci√≥n.  Abra la pesta√±a Pruebas y elija Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Cuadro 20"></div><br>  El siguiente c√≥digo debe insertarse en este formulario: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Prestemos atenci√≥n a la siguiente parte del c√≥digo: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  Es una asignaci√≥n bastante espec√≠fica del valor de salida del comando pwd a la variable, que tiene que almacenar este valor por defecto.  Al principio parece extra√±o, pero d√©jame explicarte todo. <br><br>  Mientras configuraba el analizador en AppVeyor, me top√© con un comportamiento muy extra√±o del analizador.  Por un lado, todo funcion√≥ correctamente, pero el an√°lisis no comenz√≥.  Nos llev√≥ mucho tiempo notar que est√°bamos en el directorio / home / appveyor / projects / testcalc /, mientras que el analizador estaba seguro de que est√°bamos en / opt / appveyor / build-agent /.  En ese momento me di cuenta de que la variable $ PWD es enga√±osa.  Por esta raz√≥n, renove manualmente su valor antes de ejecutar el an√°lisis. <br><br>  El orden adicional de las acciones fue el mismo que anteriormente: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/1be/5b1/a991be5b13dd4e17ccb9cb47e4f48cf2.png" alt="Cuadro 16"></div><br>  Ahora eche un vistazo a este fragmento: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  En √©l obtenemos la diferencia entre ramas, relacionada con la solicitud de extracci√≥n comprobada.  Para hacer esto, necesitamos las siguientes variables de entorno: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - extraer el n√∫mero de solicitud; </li><li>  $ APPVEYOR_REPO_NAME: nombre de usuario y repositorio del proyecto. </li></ul><br><h2>  Conclusi√≥n </h2><br>  Bueno, no hemos considerado todos los servicios de integraci√≥n continua posibles, sin embargo, todos tienen detalles operativos similares.  Pero en cuanto al almacenamiento en cach√©, cada servicio reinventa su propia rueda, por lo que siempre es diferente. <br><br>  En algunos casos (como en Travis-CI) se necesitan un par de l√≠neas de c√≥digo, y el almacenamiento en cach√© funciona a la perfecci√≥n.  En otros casos (como en AppVeyor), solo tiene que especificar el directorio en la configuraci√≥n.  Pero hay algunos servicios en los que necesita crear claves especiales e intentar convencer al sistema para que le brinde la oportunidad de reescribir un fragmento almacenado en cach√©.  Por lo tanto, si desea configurar el an√°lisis de solicitud de extracci√≥n en un servicio de integraci√≥n continua, que no se consider√≥ anteriormente, primero, aseg√∫rese de que no tendr√° problemas con el almacenamiento en cach√©. <br><br>  Gracias por su atencion  Si algo no funciona, puede escribir con seguridad a nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soporte</a> .  Le daremos una pista y ayuda. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470982/">https://habr.com/ru/post/470982/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470966/index.html">Contrase√±a de Unix de Ken Thompson</a></li>
<li><a href="../470974/index.html">DNS pasivo en manos del analista</a></li>
<li><a href="../470976/index.html">Canci√≥n de hielo (Empresa sangrienta) y llamas (DevOps e IaC)</a></li>
<li><a href="../470978/index.html">Investigaci√≥n de mercado de analistas: d√≥nde estudian, qu√© herramientas usan y cu√°nto ganan</a></li>
<li><a href="../470980/index.html">Las tareas que los robots de software (RPA) resuelven en el sector bancario</a></li>
<li><a href="../470984/index.html">An√°lisis de confirmaciones y solicitudes de extracci√≥n en Travis CI, Buddy y AppVeyor utilizando PVS-Studio</a></li>
<li><a href="../470988/index.html">El registro est√° abierto para Slerm DevOps en Mosc√∫</a></li>
<li><a href="../470990/index.html">Kit de herramientas de marketing en l√≠nea: 3 aplicaciones para impulsar la comunicaci√≥n visual</a></li>
<li><a href="../470994/index.html">Herencia de JavaScript desde el punto de vista de un nerd aburrido: F√°brica de constructores</a></li>
<li><a href="../470996/index.html">¬øC√≥mo puede una simple etiqueta <img> convertirse en un alto riesgo para una empresa?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>