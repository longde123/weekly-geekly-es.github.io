<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😠 👩🏼‍🚀 🏪 HomeKit و ioBroker لنكن صداقات في المنزل 🥠 🎎 👩🏿‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="مما لا شك فيه أن Apple iOS لا يزال أحد أكثر أنظمة التشغيل المحمولة شعبية ، مما يعني أن أنظمة التشغيل الآلي الحديثة يجب أن تكون قادرة على الاندماج في ه...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HomeKit و ioBroker لنكن صداقات في المنزل</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433798/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/r6/5c/kp/r65ckpg2b-xatrgqefbyo7lflxa.png"></p><br><p style=";text-align:right;direction:rtl">  مما لا شك فيه أن Apple iOS لا يزال أحد أكثر أنظمة التشغيل المحمولة شعبية ، مما يعني أن أنظمة التشغيل الآلي الحديثة يجب أن تكون قادرة على الاندماج في هذا النظام البيئي وتوفير إمكانية التشغيل البيني.  هذا هو بالضبط ما تم تصميم إطار Homekit له ، والذي يسمح لك بالعمل مع الأجهزة الذكية من شاشة iPhone / iPad / iWatch ، ومؤخرا Mac (macOS Mojave). </p><br><p style=";text-align:right;direction:rtl">  تضمنت معظم أنظمة التشغيل الآلي (لا أحب اسم التسويق "المنزل الذكي") وحدات طويلة للتكامل مع Homekit ، ولكن حتى المستخدم المدرب لا يمكنه دائمًا اكتشاف كيفية جعل أجهزته متوفرة في تطبيق الصفحة الرئيسية (أو حواء). </p><br><p style=";text-align:right;direction:rtl">  سأخبرك اليوم عن كيفية القيام بهذه التلاعبات في نظام ioBroker (هذا نظام أتمتة مفتوح ومجاني).  ولكن حتى لا أعطي كل الأمثلة العديدة للأجهزة بغباء ، أريد أن أشرح بعض المبادئ وأظهر الأساليب ، ومعرفة أي منها ، يمكنك بسهولة تنفيذ أمثلة أخرى. </p><br><p style=";text-align:right;direction:rtl">  <em>"معرفة بعض المبادئ يعوض بسهولة عن جهل بعض الحقائق."</em> <em><br></em>  <em>كلود أدريان هلفتيوس</em> </p><a name="habracut"></a><br><h3 id="iobroker-drayvery-ustroystva-i-sostoyaniya" style=";text-align:right;direction:rtl">  ioBroker.  برامج التشغيل والأجهزة والحالات </h3><br><p style=";text-align:right;direction:rtl">  بادئ ذي بدء ، أود أن أوضح ما هو الجهاز في نظام ioBroker ، وكيف يتم تقديمه. </p><br><p style=";text-align:right;direction:rtl">  دعني أذكرك بأن نظام ioBroker نظامي ، وأن وحدات الامتداد تسمى برامج التشغيل (أو المحولات).  برنامج التشغيل عبارة عن وحدة تكامل مع بعض الأجهزة أو مجموعة من الأجهزة ، موحد بواسطة وظيفة أو بروتوكول أو مُصنّع شائع ، وبالتالي يمكنه "سحب" جهاز واحد أو عدة أجهزة في نظام ioBroker.  ميزة أخرى هي القدرة على إنشاء مثيلات متعددة لنفس برنامج التشغيل ، تختلف في أي إعدادات. </p><br><p style=";text-align:right;direction:rtl">  لكن كل جهاز فريد من نوعه وغير قابل للفك ، له خصائص وقدرات مختلفة.  بناءً على هذا ، لا يركز ioBroker بشكل أساسي على الجهاز نفسه ، ولكن على خصائصه ، التي تمثلها الولايات.  <strong>الحالة</strong> هي كائن ioBroker داخلي يقبل ويخزن قيمة.  يمكن اعتبار مرادفات الحالة: علامات وسمات وخصائص وخصائص وأحداث.  أمثلة للظروف: "درجة الحرارة" ، "مستوى السطوع" ، "مستوى البطارية" ، "إشارة التشغيل" ، "إشارة الخطأ" ، "إشارة الضغط" ، "إشارة الضغط المزدوج" ، إلخ.  وبالتالي ، يتم تمثيل كل جهاز من قبل العديد من الدول المختلفة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/oc/mn/q_/ocmnq_d-zdyhjj7bflfxaa3dxb8.png" alt="هيكل الكائن" title="هيكل الكائن"></p><br><p style=";text-align:right;direction:rtl">  يمكن تقسيم الحالات إلى حالات مفيدة - تعرض المعلومات من الجهاز ، وحالة قابلة للتغيير - يمكن تغييرها بواسطة المستخدم أو البرنامج النصي وإرسال هذه التغييرات إلى الجهاز.  وفقًا لذلك ، عندما يتغير شيء ما على الجهاز - يتم عرض هذه البيانات في الولايات ، وعندما تتغير الحالة من ioBroker (من قبل المستخدم أو بواسطة البرنامج النصي) - يتلقى الجهاز إشارة حول التغيير ويجب أن يستجيب وفقًا لذلك (يعتمد ذلك على الجهاز نفسه وبرنامج التشغيل معه. يعمل). </p><br><p style=";text-align:right;direction:rtl">  يتم دمج كل حالات الجهاز في شجرة واحدة (سجل) من الحالات.  يتم تجميعها أولاً حسب الجهاز (في بعض الحالات لا تزال القنوات مستخدمة) ، ثم بواسطة مثيلات برنامج التشغيل. </p><br><p style=";text-align:right;direction:rtl">  مفهوم مواضيع بروتوكول MQTT يناسب بسهولة شجرة شجرة من هذا القبيل.  وبهذه الطريقة ، يمكنك توصيل معدات إضافية أو أنظمة خارجية تدعم بروتوكول MQTT.  يكفي تثبيت برنامج التشغيل MQTT - سيظهر الفرع المقابل في شجرة الحالة. </p><br><p style=";text-align:right;direction:rtl">  وهناك جميع أنواع الخدمات عبر الإنترنت التي يمكن أن توفر معلومات مفيدة و / أو تجعل من الممكن السيطرة على المعدات الأخرى (أجهزة الإنذار سيارة ، على سبيل المثال).  يتم تمثيل نتيجة التفاعل مع هذه الخدمات أيضًا كمجموعة من الحالات. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xi/qk/ay/xiqkay8bgotkcb7qjhouj5-zln4.png" alt="شجرة الدولة" title="شجرة الدولة"></p><br><p style=";text-align:right;direction:rtl">  في المجموع ، يتم تمثيل الجهاز في ioBroker بمجموعة من الحالات التي تميز الجهاز وتسمح بالتفاعل معه. </p><br><h3 id="homekit-aksessuary-servisy-i-harakteristiki" style=";text-align:right;direction:rtl">  Homekit  الملحقات والخدمات والمواصفات </h3><br><p style=";text-align:right;direction:rtl">  أنتقل الآن إلى Homekit.  هنا يتم تصنيف الأجهزة ، وظائفها وخصائصها. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xk/ch/8m/xkch8mdj6gv4zxw5g-kapazvuyy.png" alt="فئات أجهزة Homekit" title="فئات أجهزة Homekit"></p><br><p style=";text-align:right;direction:rtl">  <strong>الملحقات</strong> هي المكافئ لجهاز مادي.  يحتوي الملحق على <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">فئة</a> لتعيينه إلى مجموعة محددة. </p><br><p style=";text-align:right;direction:rtl">  <strong>الخدمات</strong> هي المكافئ للوظائف التي يمتلكها الملحق.  ملحق واحد يمكن أن يكون لها العديد من الخدمات. </p><br><p style=";text-align:right;direction:rtl">  تشير الخدمات إلى قدرات الجهاز: المصباح ، البطارية ، الزر ، مستشعر جودة الهواء ، الباب ، منظف الهواء ، الكاميرا .. </p><br><p style=";text-align:right;direction:rtl">  إنها الخدمة التي تحدد العرض وسلوك الجهاز ومجموعة الخصائص. </p><br><p style=";text-align:right;direction:rtl">  <strong>السمة</strong> هي المكافئ للسمات / الخصائص التي تميز الخدمة.  هذه هي الخصائص التي تحدد ما إذا كان الجهاز قيد التشغيل أم مستوى السطوع للمصباح أم عدد المرات التي يتم فيها الضغط على الزر.  خدمة واحدة يمكن أن يكون لها العديد من الخصائص. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/2f/rl/io/2frliotkqesh2zanlhpfiaskmaq.png" alt="هيكل الكائن" title="هيكل الكائن"></p><br><p style=";text-align:right;direction:rtl">  تقرأ التطبيقات التي تعمل مع Homekit الخدمات وخصائص الملحقات ، ثم تعرض وتتيح لك تغيير القيم في الخصائص من خلال واجهة المستخدم.  يتم إرسال القيم التي تم تغييرها إلى أجهزة Homekit لتطبيقها ، ومن أجهزة Homekit ، على التوالي ، يتم أيضًا إرسال قيم الخصائص مع بعض التغييرات من جانب الجهاز. </p><br><p style=";text-align:right;direction:rtl">  في المجموع ، يبدو أن الجهاز الموجود في HomeKit هو ملحق به مجموعة من الخدمات والميزات. </p><br><h3 id="yahka-stykuem-koncepcii" style=";text-align:right;direction:rtl">  ياهكا.  ننضم إلى المفهوم </h3><br><p style=";text-align:right;direction:rtl">  للعمل مع Homekit ، يستخدم <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ioBroker</a> برنامج تشغيل <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Yahka</a> (يجب عليك <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">تثبيت وحدات إضافية</a> قبل التثبيت) - وظيفة إضافية إلى مكتبة معروفة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://github.com/KhaosT/HAP-NodeJS</a> ، الذي يبني أيضًا مشروع HomeBridge الشهير.  تم تصميم هذه المكتبة لإنشاء بوابة / جسر افتراضي يوفر مجموعة من الأجهزة الافتراضية في HomeKit.  تكوين الأجهزة والخدمات الافتراضية وفقًا لذلك ، وتحديد قيم الخصائص ، نحصل على الجهاز النهائي في Homekit والتطبيق المنزلي ، ويمكننا أيضًا مطالبة Siri بإدارته. </p><br><p style=";text-align:right;direction:rtl">  تم تصميم برنامج Yahka لتكوين الملحقات ، وإضافة خدمات إليها والإشارة إلى توافق الخصائص (HomeKit) والشروط (ioBroker). </p><br><p style=";text-align:right;direction:rtl">  لكن أولاً ، بعد التثبيت ، تحتاج إلى تكوين العبارة وإدخالها في التطبيق Home.  بعد التكوين ، ستتم إضافة جميع الأجهزة المضافة إلى البوابة تلقائيًا إلى الصفحة الرئيسية.  للقيام بذلك ، حدد "اسم الجهاز" (من المرغوب فيه تحديد الحروف اللاتينية فقط) وتذكر الرمز السري (أو تعيين الخاصة بك). </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mj/b9/lf/mjb9lfsfvknvbjjmec9x0nexnns.png" alt="إعداد بوابة" title="إعداد بوابة"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">نذهب إلى تطبيق المنزل ونضيف ملحق جديد.</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/5k/m1/hr/5km1hrkrxh6whzmb8dn5zcvqtm4.png"><br><img src="https://habrastorage.org/webt/fo/p-/oz/fop-oz-o99nnegmciq7drkxjdyu.png"></p></div></div><br><p style=";text-align:right;direction:rtl">  الآن دعونا ننكب على الأجهزة.  سيكون كل شيء على ما يرام إذا كانت مجموعة الحالات للجهاز في ioBroker تتوافق بوضوح مع مجموعة الخدمات والميزات في HomeKit.  وسيكون من الأفضل لو كانت القيم في الولايات مناسبة لقيم الخصائص.  ولكن في كثير من الأحيان هذا ليس كذلك ، وعليك التوصل إلى طرق غير عادية لرسو السفن.  سأتحدث عن بعضها أدناه ، وسوف يتعين عليك تنفيذ جميع الخيارات الأخرى بنفسك ، "في الصورة ومثالها". </p><br><p style=";text-align:right;direction:rtl">  للراحة ، قمت <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">بإنشاء مستند</a> مع ترجمة الخدمات والأنواع ، وكذلك القيم المحتملة للخصائص.  تتوافق جميع الأنواع والخدمات المستخدمة مع <a href="">مكتبة HAP-NodeJS</a> . </p><br><h3 id="datchik-temperatury" style=";text-align:right;direction:rtl">  استشعار درجة الحرارة </h3><br>  هذا هو أبسط مثال - كل ما عليك فعله هو وجود حالة واحدة تحتوي على القيمة العددية لدرجة الحرارة.  يمكن الحصول عليها من أي مكان: من أجهزة الاستشعار أو من خدمات الإنترنت (الطقس). <br><p style=";text-align:right;direction:rtl">  تحتاج إلى إضافة جهاز من فئة Sensor ، وإضافة خدمة TemperatureSensor إلى الجهاز ، وإعطاء اسم لهذه الخدمة.  هناك 5 خصائص في هذه الخدمة ، أهمها بالنسبة لنا هي CurrentTemperature. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xn/yr/k7/xnyrk7hwwcmtwhiy_kcbub-nlms.png" alt="ميزان الحرارة التبعي" title="ميزان الحرارة التبعي"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/j4/bj/bn/j4bjbnuijam7qadtoq9r9eh16ns.png" alt="خدمة استشعار الحرارة" title="خدمة استشعار الحرارة"></p><br><p style=";text-align:right;direction:rtl">  يكفي الإشارة إلى اسم الحالة المطابقة لدرجة الحرارة في خاصية CurrentTemperature. </p><br><p style=";text-align:right;direction:rtl">  أضف خدمة HumiditySensor للرطوبة هنا أيضًا ، وسيتم إنشاء رمز ملحق منفصل في Homekit. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ag/na/90/agna90qhvaz84v3qutrvu4dltei.png" alt="خدمة الرطوبة الرطوبة" title="خدمة الرطوبة الرطوبة"></p><br><p style=";text-align:right;direction:rtl">  حفظ ، والانتهاء من ذلك.  الآن يمكنك اللجوء إلى سيري ، ويسألها عن درجة الحرارة والرطوبة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/s4/cx/kg/s4cxkg72-7ycfuaentktjrhpdjy.png"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">محادثة مع سيري</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ff/p9/tt/ffp9ttfpcj3_wcbt4ztgisnwxzi.png"><br><img src="https://habrastorage.org/webt/ax/7z/1i/ax7z1ioiynurem96c3gof_2gnha.png"></p></div></div><br><h3 id="batareyka" style=";text-align:right;direction:rtl">  البطارية </h3><br><p style=";text-align:right;direction:rtl">  خدمة أخرى بسيطة.  خدعة هي أنه يمكن إضافتها إلى أي ملحق تقريبًا.  أضف خدمة BatteryService وأشر في خاصية BatteryLevel إلى حالة تحتوي على نسبة شحن البطارية.  بعد ذلك ، ستظهر بيانات الشحن في البيانات الإضافية حول الجهاز. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/pd/4p/ib/pd4pibwilwjymthk2g30ldqneey.png" alt="خدمة البطارية" title="خدمة البطارية"></p><br><p style=";text-align:right;direction:rtl">  يمكنك على الفور تعيين علامة "انخفاض الشحن" (السمة المميزة StatusLowBattery) ، إذا كانت قيمة الحالة المحددة تساوي 1 ، فسيتم عرض الرمز المقابل على صورة الجهاز. </p><br><p style=";text-align:right;direction:rtl">  ولكن ماذا لو لم يكن لديك مثل هذه الحالة ، ولكنك تريد أن ترى أيقونة البطارية المنخفضة؟  تحتاج إلى إنشاء هذه الحالة يدويًا أو باستخدام برنامج نصي ، والإشارة إلى الحالة التي تم إنشاؤها في الخصائص. </p><br><p style=";text-align:right;direction:rtl">  الآن يبقى فقط لتعيين القيمة الحقيقية بشكل صحيح في هذه الحالة.  للقيام بذلك ، سوف نستخدم البرنامج النصي - سيتم ضبطه عندما تصل البطارية إلى 30 بالمائة. </p><br><pre style=";text-align:right;direction:rtl"><code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">""</span></span>); on({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"zigbee.0.00158d0001f41725.battery"</span></span>, <span class="hljs-attr"><span class="hljs-attr">change</span></span>: <span class="hljs-string"><span class="hljs-string">"ne"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = obj.state.val; setState(<span class="hljs-string"><span class="hljs-string">"javascript.0."</span></span>, (value &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>)); });</code> </pre> <br><p style=";text-align:right;direction:rtl">  بعد التشغيل الأول ، سينشئ البرنامج النصي حالة ، ويمكن تحديده في الخصائص. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/tx/2z/6r/tx2z6r4deofbbram-k_muwaxut0.png"></p><br><p style=";text-align:right;direction:rtl">  سيتم عرض هذه العلامة على صور الملحقات </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/9o/nu/it/9onuitzmxs8exjofr7cfkwtwrqi.png"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">وتفاصيل الجهاز</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/fx/jg/av/fxjgavhu-spu27lskbzkmvb_dh8.png"></p></div></div><br><h3 id="lampy" style=";text-align:right;direction:rtl">  مصابيح </h3><br><p style=";text-align:right;direction:rtl">  المصابيح الكهربائية مختلفة - مشرق ، دافئ ، أحمر.  هناك 4 حالات: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  بسيطة - التي تسيطر عليها وخارجها </li><li style=";text-align:right;direction:rtl">  عكس الضوء - تسيطر عليها أيضا مستوى السطوع </li><li style=";text-align:right;direction:rtl">  مع درجة الحرارة - من الممكن التحكم في درجة حرارة التوهج </li><li style=";text-align:right;direction:rtl">  اللون - يمكنك التحكم في لون التوهج </li></ul><br><p style=";text-align:right;direction:rtl">  لكل حالة من هذه الحالات ، هناك خاصية مماثلة في خدمة Lightbulb: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  على - على / قبالة </li><li style=";text-align:right;direction:rtl">  السطوع - مستوى السطوع </li><li style=";text-align:right;direction:rtl">  هوى الظل </li><li style=";text-align:right;direction:rtl">  التشبع - التشبع </li><li style=";text-align:right;direction:rtl">  ColorTemperature - درجة حرارة اللون </li></ul><br><p style=";text-align:right;direction:rtl">  في الحالة البسيطة ، في خاصية "On" ، نشير إلى الحالة المسؤولة عن التبديل وإيقاف التشغيل. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/7p/2j/l2/7p2jl2cqi7q8rbw98d_ytedxwke.png"></p><br><p style=";text-align:right;direction:rtl">  إذا كان المصباح خافتًا ، فسنشير بالإضافة إلى ذلك إلى الحالة بمستوى السطوع. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/b6/da/n1/b6dan1fjltcn8sry8doex2hl6ck.png"></p><br><p style=";text-align:right;direction:rtl">  بالإضافة إلى تعيين الحالات الصحيحة ، من المهم مراعاة الفاصل الزمني للقيم المقبولة! </p><br><p style=";text-align:right;direction:rtl">  على سبيل المثال: في بعض الحالات ، يمكن أن تأخذ الحالة المسؤولة عن سطوع المصباح قيمًا من 0 إلى 255 ، ولكن في Homekit تقتصر هذه القيم على فاصل زمني من 0 إلى 100. في هذه الحالة ، يمكنك استخدام <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وظائف تحويل</a> برنامج تشغيل Yahka.  تعمل الدالة "level255" على تحويل الفاصل الزمني للقيم من 0.55 إلى الفاصل الزمني 0..100 (والعكس صحيح). </p><br><p style=";text-align:right;direction:rtl">  قد تنشأ الصعوبات التالية إذا كان المصباح ملونًا ، ولكن اللون المستخدم هو RGB.  يمكن أن يكون إما ثلاث حالات مختلفة ، أو رقم واحد (أو سلسلة).  في هذه الحالة ، ستحتاج إلى التحويل من مساحة ألوان RGB إلى مساحة XYB أخرى (يتم استخدام هذه المساحة بواسطة HomeKit) ، أو إلى الطائرة XY. </p><br><p style=";text-align:right;direction:rtl">  للقيام بذلك ، تحتاج إلى إنشاء حالتين جديدتين (الصبغة والتشبع) ، حيث سنقوم بتحويل القيم من حالة RGB والعكس. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">البرنامج النصي الناتج للون هو</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       createState("Hue"); createState("Sat"); //      RGB- on({id: "Hue", ack: false, change: 'any'}, function (obj) {  var hue = parseInt(obj.state.val);  var sat = parseInt(getState('Sat').val);  var res = hsvToRgb(hue, sat, 100);  setRGB(parseInt(res[0]), parseInt(res[1]), parseInt(res[2])); }); //    RGB- function setRGB(r, g, b){  var val = ('00'+r.toString(16)).slice(-2)+('00'+g.toString(16)).slice(-2)+('00'+b.toString(16)).slice(-2);  // RGB-   setState('zigbee.0.00124b0014d016ab.color', val, false); } //   HSV   RGB function hsvToRgb(h, s, v) {  var r, g, b;  var i;  var f, p, q, t;   h = Math.max(0, Math.min(360, h));  s = Math.max(0, Math.min(100, s));  v = Math.max(0, Math.min(100, v));  s /= 100;  v /= 100;   if(s == 0) {      r = g = b = v;      return [          Math.round(r * 255),          Math.round(g * 255),          Math.round(b * 255)      ];  }   h /= 60;  i = Math.floor(h);  f = h - i;  p = v * (1 - s);  q = v * (1 - s * f);  t = v * (1 - s * (1 - f));   switch(i) {      case 0:          r = v;          g = t;          b = p;          break;       case 1:          r = q;          g = v;          b = p;          break;       case 2:          r = p;          g = v;          b = t;          break;       case 3:          r = p;          g = q;          b = v;          break;       case 4:          r = t;          g = p;          b = v;          break;       default: // case 5:          r = v;          g = p;          b = q;  }   return [      Math.round(r * 255),      Math.round(g * 255),      Math.round(b * 255)  ]; }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  يمكن إجراء درجة حرارة اللون بسهولة - إذا كان نطاق القيم المتاحة للمصباح معروفًا ، فيمكن تحويله إلى الفاصل الزمني المتاح لـ HomeKit (عبر وظيفة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">scaleInt</a> ). </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/f0/vm/xh/f0vmxhpcndendf_efjf9xrmjxke.png" alt="خدمة مصباح" title="خدمة مصباح"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/et/sp/fg/etspfg0idwn5v-cun2hh2y9xmm0.png"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">أعمق في المصباح</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/w_/q8/8p/w_q88pboeca8hl0fygtssrjegim.png"><br><img src="https://habrastorage.org/webt/bt/5c/bc/bt5cbc59jttu8ibjev1hfnnwkdm.png"></p></div></div><br><h3 id="termostat" style=";text-align:right;direction:rtl">  ترموستات </h3><br><p style=";text-align:right;direction:rtl">  ترموستات - جهاز للحفاظ على درجة الحرارة المحددة (خدمة ترموستات).  وفقا لذلك ، فإن السمة الرئيسية للحرارة هي درجة الحرارة المرغوبة (TargetTemperature).  بالإضافة إلى درجة الحرارة المحددة ، يمكن الإشارة إلى درجة الحرارة الحالية (CurrentTemperature) ، وهي ذات طبيعة إعلامية (نظرًا لأن الجهاز يقرأها فقط من المستشعرات). </p><br><p style=";text-align:right;direction:rtl">  من التطبيق Home ، يتم ضبط درجة الحرارة المستهدفة في الترموستات ويتم مراقبة درجة الحرارة الحالية.  في منظم الحرارة الخاص بي (Zont) ، لم يكن هناك سوى هاتين الحالتين - كانت متاحة من خلال واجهة الخدمة السحابية. </p><br><p style=";text-align:right;direction:rtl">  من أجل جمال عرض الجهاز في HomeKit ، اضطررت إلى إضافة اثنين من الثوابت: الحالة الحالية للتدفئة نشطة (1) ، والحالة المستهدفة للتدفئة تلقائية (3). </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/vn/dd/ey/vnddeyypjlofn2jkxrqwe5ybwuw.png" alt="خدمة ترموستات" title="خدمة ترموستات"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/pk/9u/k3/pk9uk3vfurepl1kfgow5lrp66dc.png"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">اختيار درجة الحرارة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/_4/g8/co/_4g8coln1rlsodscr8sah8p_h9o.png"></p></div></div><br><h3 id="vorota" style=";text-align:right;direction:rtl">  بوابات </h3><br><p style=";text-align:right;direction:rtl">  مع باب الجراج (خدمة GarageDoorOpener) ، كل شيء أصعب من ترموستات. </p><br><p style=";text-align:right;direction:rtl">  من الخصائص المتاحة ، تحتوي البوابة على حالة مستهدفة (TargetDoorState) ، مما يشير إلى رغبتنا في أن تكون البوابة "مفتوحة" أو "مغلقة".  لكنك تحتاج أيضًا إلى عرض الحالة الحالية للبوابة (CurrentDoorState) بشكل صحيح: هل هي مفتوحة أم مغلقة ، أو ربما تفتح أو تغلق؟ </p><br><p style=";text-align:right;direction:rtl">  في حالتي ، تم فتح البوابات من خلال mqtt في ioBroker مع العديد من حالات المعلومات: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  علامة انفتاح البوابة (OB) </li><li style=";text-align:right;direction:rtl">  علامة حركة البوابة (LW) </li></ul><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/aw/b3/ip/awb3ipo5vz8qrn8jawhcfunuouc.png" alt="دول مراقبة باب المرآب" title="دول مراقبة باب المرآب"></p><br><p style=";text-align:right;direction:rtl">  بفضل هذه الحالات ، يمكنك حساب الوضع الحالي للبوابة: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  إذا لم يكن هناك OB ولا DV ، ثم يتم إغلاق البوابات </li><li style=";text-align:right;direction:rtl">  إذا لم يكن هناك OB وكان هناك DV ، ثم فتح البوابات </li><li style=";text-align:right;direction:rtl">  إذا كان هناك OB وبدون DV ، فإن البوابات مفتوحة </li><li style=";text-align:right;direction:rtl">  إذا كان هناك OB وكان هناك DV ، ثم تغلق البوابة </li></ul><br><p style=";text-align:right;direction:rtl">  لإرسال إشارة لفتح وإغلاق البوابة ، لدي حالتان منفصلتان (سيكون من الممكن إدارته باستخدام حالة واحدة ، لكن لدي حالتان) ، والتي ترسل رسالة عبر mqtt إلى وحدة التحكم في البوابة: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  فتح إشارة </li><li style=";text-align:right;direction:rtl">  إشارة الختام </li></ul><br><p style=";text-align:right;direction:rtl">  لإرسال إشارة ، تحتاج إلى محاكاة زر "النقر": اضبط القيمة على "صحيح" ، وبعد فترة إعادة تعيينها إلى "خطأ".  في هذا الصدد ، للتكامل مع HomeKit ، كان من الضروري إنشاء حالة أخرى - "الحالة الهدف للبوابة" ، عند تغييرها ، سيتم إرسال الإشارة المقابلة. </p><br><p style=";text-align:right;direction:rtl">  يمكن استبدال علامة انفتاح البوابة بالحالة المستهدفة (أي ما الهدف الذي يهدف إليه): </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  إذا كان "المرجع المصدق" مغلقًا ولا يوجد DV ، فإن البوابة مغلقة </li><li style=";text-align:right;direction:rtl">  إذا كان "CA" مغلقًا وكان هناك DV ، فتفتح البوابات </li><li style=";text-align:right;direction:rtl">  إذا كان المرجع المصدق "مفتوحًا" ولم يكن هناك DV ، فإن البوابة مفتوحة </li><li style=";text-align:right;direction:rtl">  إذا كان المرجع المصدق "مفتوحًا" وكان هناك DV ، يتم إغلاق البوابة </li></ul><br><p style=";text-align:right;direction:rtl">  سنقوم أيضًا بإنشاء "حالة بوابة الحالية" منفصلة الحالة ، وسنملأها في البرنامج النصي بناءً على قيمة العلامات والحالة المستهدفة. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">تغيير الدولة النصي لأبواب المرآب</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">"gate_0.current"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   createState("gate_0.target"); //   //    0,   300 on({id: "mqtt.0.gate.gpio.13", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.13", 0,  300); }); on({id: "mqtt.0.gate.gpio.12", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.12", 0,  300); }); //     on({id: "mqtt.0.gate.is_open", ack: false, val: 1}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 0, true); }); on({id: "mqtt.0.gate.is_open", ack: false, val: 0}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 1, true); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 0}, function (obj) {  setState("mqtt.0.gate.gpio.12", 1); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 1}, function (obj) {  setState("mqtt.0.gate.gpio.13", 1); }); on({id: "mqtt.0.gate.in_progress", ack: true, change: 'any'}, function (obj) {  //    " ",      if (obj.state.val === 1) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 2, true);      } else {          // ""          setState("javascript.0.gate_0.current", 3, true);      }  }  //    " ",      if (obj.state.val === 0) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 0, true);      } else {          // ""          setState("javascript.0.gate_0.current", 1, true);      }  } });</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  بعد تشغيل البرنامج النصي ، يمكنك تكوين خصائص خدمة باب الجراج: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lb/cm/t5/lbcmt51du7vnivrjbj2o_h_u28u.png" alt="خدمة GarageDoorOpener" title="خدمة GarageDoorOpener"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/pg/rh/ey/pgrhey_qs-cxm8rg6yj_lufgmgs.png"></p><br><h3 id="kamera" style=";text-align:right;direction:rtl">  الكاميرا </h3><br><p style=";text-align:right;direction:rtl">  لإضافة كاميرا إلى HomeKit ، سيتم استخدام الطريقة "الكلاسيكية".  يتم تنظيم بث الصورة من الكاميرا عبر وحدة ffmpeg.  من خلاله ، سيتم تشفير تيار الإدخال ، تشفيره وإعطائه إلى Homekit. </p><br><p style=";text-align:right;direction:rtl">  بادئ ذي بدء ، تحتاج إلى تثبيت ffmpeg على الخادم حيث يوجد ioBroker. </p><br><p style=";text-align:right;direction:rtl">  لكل منصة ، يتم تثبيتها بطرق مختلفة ، يمكنك تجميعها من المصدر ، أو البحث عن مجموعة جاهزة ، على سبيل المثال ، هنا: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://www.johnvansickle.com/ffmpeg/</a> يجب أن يكون لديك برنامج ترميز libx264.  يمكنك التحقق من برنامج التشفير بعد تثبيت ffmpeg باستخدام الأمر: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">ffmpeg -codecs | grep 264</code> </pre> <br><p style=";text-align:right;direction:rtl">  يجب أن تحتوي النتائج على سطر من النموذج </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_vdpau ) (encoders: libx264 libx264rgb h264_v4l2m2m )</code> </pre> <br><p style=";text-align:right;direction:rtl">  بالنسبة إلى Raspberry Pi 3 ، يمكنك استخدام <a href="">التجميع الجاهز</a> ، والذي يحتوي على برنامج ترميز مع دعم لترميز أجهزة GPU (h264_omx ، يستهلك موارد أقل).  ضعها مثل هذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">wget https://github.com/legotheboss/YouTube-files/raw/master/ffmpeg_3.1.4-1_armhf.deb sudo dpkg -i ffmpeg_3.1.4-1_armhf.deb</code> </pre> <br><p style=";text-align:right;direction:rtl">  كل من برامج الترميز موجودة في هذا التجميع: libx264 و h264_omx </p><br><p style=";text-align:right;direction:rtl">  بعد ذلك ، تحتاج إلى الحصول على عنوان دفق الكاميرا الذي يجب بثه (هذه الخطوة خارج نطاق هذه المقالة).  على سبيل المثال ، يمكنك أن تأخذ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">دفقًا عامًا جاهزًا</a> . </p><br><p style=";text-align:right;direction:rtl">  أضف الآن الكاميرا إلى Yahka ، وأشر إلى عنوان الدفق ، وقم بتغيير معلمات برنامج الترميز وحجم الصورة ومعدل الإطار ، إذا لزم الأمر. </p><br><p style=";text-align:right;direction:rtl">  <strong>هام: مجموعات المعلمات مهمة جدًا للعرض الصحيح للكاميرا في Homekit وتعتمد على الكاميرا والدفق.</strong>  <strong>كما يؤثر على أداء النظام ، كما</strong>  <strong>عملية تشغيل ffmpeg تستهلك الكثير من الموارد.</strong> </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zh/uj/6g/zhuj6gv7alolh2nfvmpyxgmnoju.png" alt="إضافة كاميرا" title="إضافة كاميرا"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/w7/_z/pl/w7_zplfretbtbw0v66nb9ip9ira.png" alt="دفق الإعداد" title="دفق الإعداد"></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">تتم إضافة الكاميرات كأجهزة منفصلة خارج البوابة ، ويجب إضافتها بنفس طريقة إضافة البوابة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ib/8v/s9/ib8vs9ksuw5mk4ese_-gg6rnrv4.png"></p></div></div><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0d/hp/qd/0dhpqdbfe_hgez4u7x2edcu92za.png" alt="صورة مصغرة للكاميرا" title="صورة مصغرة للكاميرا"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ue/tj/o4/uetjo4rqvi-fsae2rlkt56cmaji.png" alt="البث من الكاميرا" title="البث من الكاميرا"></p><br><h3 id="bonus" style=";text-align:right;direction:rtl">  مكافأة </h3><br><p style=";text-align:right;direction:rtl">  على سبيل المكافأة ، سأتحدث عن الاستخدام غير المعتاد لبث الكاميرا. </p><br><p style=";text-align:right;direction:rtl">  باستخدام نفس ffmpeg ، بدلاً من الكاميرا ، يمكنك محاولة بث الصورة ، أي صورة.  يمكن أيضًا دمج هذه الصور مع دفق الفيديو.  يمكنك عرض النص والرسومات وغيرها من المعلومات على الصورة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/sg/cl/f7/sgclf7ssws1pkm_rlf3qy_avmhi.png" alt="تراكب النص المصبوب" title="تراكب النص المصبوب"></p><br><p style=";text-align:right;direction:rtl">  نتيجة لذلك ، يمكنك الحصول على لوحة معلومات مثيرة للاهتمام.  وإذا قمت بتحديث الصورة بشكل دوري ، فستحصل على بيانات ديناميكية. </p><br><p style=";text-align:right;direction:rtl">  على سبيل المثال ، قمت بإظهار رسم بياني للتغيرات في بعض المؤشرات في شكل صورة (ملف على القرص).  يتم تحديث هذا الرسم البياني مرة واحدة في الدقيقة والكتابة فوق الصورة في الملف. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">(وظائف createImage1 ، و createImage2 ، وتشكيل الرسم البياني ، وفرض النص على صورة ما هي خارج نطاق هذه المقالة ، لكنني سأقدم تلميحًا).</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  سأخبرك كيف يمكنك الحصول على رسم بياني في صورة. </p><br><p style=";text-align:right;direction:rtl">  لدى IoBroker طريقة قياسية لبناء الرسوم البيانية - برنامج التشغيل Flot.  يقترن برنامج التشغيل هذا ببرنامج تشغيل ويب ويعرض النتيجة في متصفح.  ولكن من أجل الحصول على الرسم البياني الذي تم إنشاؤه على الخادم (في البرنامج النصي) كصورة ، هناك حاجة إلى برنامج تشغيل إضافي PhantomJS ، والذي يأخذ "لقطة شاشة" للصفحة (التي سنرسم عليها رسم تخطيطي Flot). </p><br><p style=";text-align:right;direction:rtl">  ولكن سأتحدث عن طريقة بديلة لبناء الرسوم البيانية على الخادم في برنامج نصي. </p><br><p style=";text-align:right;direction:rtl">  يوجد مثل مكتبة Chart.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">http://www.chartjs.org/</a> التي تسمح لك برسم رسومات جميلة في المتصفح (أمثلة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">http://www.chartjs.org/samples/latest/</a> ). </p><br><p style=";text-align:right;direction:rtl">  للرسم ، فإنه يستخدم "قماش" (قماش ، قماش) من المتصفح.  لذلك ، لرسم استخدام هذه المكتبة على الخادم ، تحتاج إلى استخدام إصدار "server" لكائنات "canvas" و DOM.  هذا هو ما تفعله الحزمة chartjs-node ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://github.com/vmpowerio/chartjs-node</a> ). </p><br><p style=";text-align:right;direction:rtl">  التبعية الرئيسية لهذه الحزمة هي الحزمة القماشية ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://github.com/Automattic/node-canvas</a> ) ، والتي يجب تثبيتها عالميًا (أو في مجلد iobroker).  من المهم تثبيت جميع التبعيات للمنصة حيث تضع <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://github.com/Automattic/node-canvas#compiling</a> . </p><br><p style=";text-align:right;direction:rtl">  بعد ذلك ، يمكنك إضافة وحدات chart.js ، و chartjs-node في إعدادات برنامج تشغيل javascript.  يجب تثبيت بشكل صحيح ، دون أخطاء.  خلاف ذلك ، تعامل مع الأخطاء وحلها. </p><br><p style=";text-align:right;direction:rtl">  وبعد ذلك ، يمكنك كتابة السيناريو. </p><br><p style=";text-align:right;direction:rtl">  أدناه هو السيناريو للحصول على مثال ، كما  يتضمن استخدام برنامج التشغيل History ويستخدم أسماء حالة محددة. </p><br><p style=";text-align:right;direction:rtl">  انتباه!  البرنامج النصي له تعقيدات البناء للمبتدئين - وعد.  هذه طريقة ملائمة لعدم كتابة وظائف مع رد الاتصال ، ولكن لإنشاء سلاسل من الخطوات.  لذلك ، على سبيل المثال ، من المناسب القيام بذلك للحصول على بيانات من تاريخ الحالات. </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ChartjsNode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chartjs-node'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *  sendTo  Promise,      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter, cmd, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendTo(adapter, cmd, params, (result) =&gt; { resolve(result); }); }); } <span class="hljs-comment"><span class="hljs-comment">//    const chartColors = { black: 'rgb(0, 0, 0)', red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)', grey: 'rgb(201, 203, 207)' }; /** *        * : * @param config -     * @param filename -     * : * @param Promise -    */ function doDraw(config, filename) { //     640x480  var chartNode = new ChartjsNode(640, 480); return chartNode.drawChart(config) .then(() =&gt; { //     return chartNode.writeImageToFile('image/png', filename); }); } /** *     ChartJS. * : * @param Promise -    */ function prepareDraw0(){ // ,    var ; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       ,      .then(()=&gt;{ //  ,   ,      = [ {"val":3,"ack":1,"ts":1539063874301}, {"val":5,"ack":1,"ts":1539063884299}, {"val":5.3,"ack":1,"ts":1539063894299}, {"val":3.39,"ack":1,"ts":1539063904301}, {"val":5.6,"ack":1,"ts":1539063914300}, {"val":-1.3,"ack":1,"ts":1539063924300}, {"val":-6.3,"ack":1,"ts":1539063934302}, {"val":1.23,"ack":1,"ts":1539063944301}, ]; }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //   label: '', //  backgroundColor: chartColors.black, borderColor: chartColors.black, //   pointRadius: 3, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, }] } } }; return chartJsOptions; }); } /** *     ChartJS. *         , *     . * * : * @param hours -  ,     * : * @param Promise -    */ function prepareDraw1(hours){ //   ,      const end = new Date().getTime(), start = end - 3600000*(hours || 1); // 1 =   //  ,       //   var , 2, 1, 2, 2; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       'mqtt.0.ESP_Easy..Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'mqtt.0.ESP_Easy..Temperature', options: { start: start, end: end, aggregate: 'onchange' } } ).then((result) =&gt; { //     ''  = result.result; }); }) //       'sonoff.0.chicken2.DS18B20_Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ //     '2' 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.sonoff_chicken_vent.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 1 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER1', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER2', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //           label: ' ('+[.length - 1].val+')', //  backgroundColor: chartColors.blue, borderColor: chartColors.blue, //  . 0 -   pointRadius: 0, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, //   Y yAxisID: 'y-axis-1', },{ label: ' 1 ('+1[1.length - 1].val+')', backgroundColor: chartColors.green, borderColor: chartColors.green, pointRadius: 0, borderWidth: 3, data: 1.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2 ('+2[2.length - 1].val+')', backgroundColor: chartColors.red, borderColor: chartColors.red, pointRadius: 0, borderWidth: 3, data: 2.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.yellow, borderColor: chartColors.yellow, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? 1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.grey, borderColor: chartColors.grey, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? -1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, //    () time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, //   -  position: 'left', //   id: 'y-axis-1', },{ type: 'linear', display: true, scaleLabel: { display: true, labelString: '  ' }, ticks: { min: -4, max: 2 }, //   -  position: 'right', id: 'y-axis-2', }] } } }; return chartJsOptions; }); } function createImage(filename, callback){ // filename -  ,       //    prepareDraw1(2) //     .then((result) =&gt; { //        return doDraw(result, filename); }) .then(()=&gt;{ if (callback) callback(); }) .catch((err)=&gt;{ console.error(err); }); }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/4c/d5/bs/4cd5bslfzniznrd16qfmqu0tuly.png" alt="بث الصورة بدلاً من الدفق" title="بث الصورة ولت من الدفق"></p><br><p style=";text-align:right;direction:rtl">  يتم تحديث الصورة المصغرة مرة واحدة تقريبًا في الدقيقة ، لذلك نقوم بتعيين الصورة ليتم تحديثها كل 10 ثوانٍ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">var fs = require('fs'); //  10    schedule("*/10 * * * * *", () =&gt; {  createImage1('/tmp/1_new.jpg', ()=&gt; {      fs.renameSync('/tmp/1_new.jpg', '/tmp/1.jpg');  });  createImage2('/tmp/2_new.jpg', ()=&gt; {      fs.renameSync('/tmp/2_new.jpg', '/tmp/2.jpg');  }); });</code> </pre> <br><p style=";text-align:right;direction:rtl">  الخصوصية هي أنه في عملية بث الصورة ، من الضروري استبدال الصورة بسرعة كافية حتى لا يتعطل ffmpeg :) وبالتالي ، يتم تكوين الصورة أولاً في ملف واحد ، ثم تتم إعادة تسمية الملف إلى الصورة المستخدمة للترجمة. </p><br><p style=";text-align:right;direction:rtl">  الآن في إعدادات الكاميرا ، سنحدد اسم الملف الذي تم إنشاؤه بدلاً من عنوان الدفق ، ونضيف الإعدادات التي يتم "تحديثها" للصورة (المعلمة "-loop 1").  تم تكوين هذا في خصائص الكاميرا المتقدمة.  هذه الخصائص ليست أكثر من خيارات سطر الأوامر لتشغيل ffmpeg.  لذلك ، يجب العثور على مجموعات من المعلمات في وثائق ffmpeg والأمثلة. </p><br><p style=";text-align:right;direction:rtl">  يتم تقسيم الخصائص إلى نوعين: للحصول على "معاينة" (صورة كاميرا صغيرة) وللإذاعة.  لذلك ، يمكنك تحديد ملفات مصدر صور مختلفة ، على سبيل المثال بتفاصيل مختلفة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zy/30/b4/zy30b4wc2zud54wr-px_ezovdgu.png" alt="خيارات بدء التشغيل Ffmpeg" title="خيارات بدء التشغيل Ffmpeg"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mk/l5/qi/mkl5qizqb41if_youa62qrgm9hc.png" alt="بث مباشر صورة" title="بث مباشر صورة"></p><br><h3 id="zaklyuchenie" style=";text-align:right;direction:rtl">  الخاتمة </h3><br><p style=";text-align:right;direction:rtl">         ioBroker     .       ,       . ,   ,        . </p><br><p style=";text-align:right;direction:rtl">  ,    Yahka       ,      Material.           ,            HomeKit. </p><br><p style=";text-align:right;direction:rtl">       Yahka,    HomeKit     —  Ham,     HomeBridge         .       . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar433798/">https://habr.com/ru/post/ar433798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar433786/index.html">Fintech Digest: cryptocurrency هي خاصية ، تم إصدار عدد قياسي من بطاقات الائتمان في الاتحاد الروسي</a></li>
<li><a href="../ar433788/index.html">صفقة آمنة ومراجعات جديدة لحسابهم الخاص</a></li>
<li><a href="../ar433790/index.html">قوالب البناء المتقدمة متعددة المراحل</a></li>
<li><a href="../ar433792/index.html">نصوص شل في Ansible</a></li>
<li><a href="../ar433796/index.html">كيف غزا هومو سابينس العالم. مهارات الاتصال والتفاوض</a></li>
<li><a href="../ar433800/index.html">استخدام وحدات تحكم Cypress في UDB PSoC لتقليل الانقطاعات في طابعة ثلاثية الأبعاد</a></li>
<li><a href="../ar433802/index.html">كيف ولماذا فزنا في مسار البيانات الكبيرة في Urban Tech Challenge Hackathon</a></li>
<li><a href="../ar433804/index.html">شبكات كثافة الخليط</a></li>
<li><a href="../ar433806/index.html">عندما ينسى الأرشيف على الإنترنت</a></li>
<li><a href="../ar433808/index.html">5 الأخطاء الأكثر شيوعًا التي يرتكبها المبرمجون في المقابلة</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>