<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍💼 👩‍👩‍👧‍👧 👆 安全漏洞：Docker 🤰 👩🏿‍🤝‍👨🏾 🏂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker容器是最流行的容器化技术。 最初，它主要用于开发和测试环境，随着时间的推移，它开始转为生产。 Docker容器在生产环境中开始大量繁殖，就像雨后的蘑菇一样，但是，使用该技术的人很少考虑如何安全发布Docker容器。 

 基于OWASP ，我们准备了一系列规则，这些规则的实施将极大地保护...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>安全漏洞：Docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/448704/"><img src="https://habrastorage.org/webt/8w/2q/ga/8w2qgad0hpcszydr-apdn1uib-8.png"><br><br>  Docker容器是最流行的容器化技术。 最初，它主要用于开发和测试环境，随着时间的推移，它开始转为生产。  Docker容器在生产环境中开始大量繁殖，就像雨后的蘑菇一样，但是，使用该技术的人很少考虑如何安全发布Docker容器。 <br><br> 基于<a href="">OWASP</a> ，我们准备了一系列规则，这些规则的实施将极大地保护基于Docker容器的环境。 <br><a name="habracut"></a><br><h3> 规则0 </h3><h4> 主机和Docker必须包含所有当前更新。 </h4><br> 为了防止导致从容器环境逃逸到主机系统的已知漏洞（通​​常会导致主机系统上的特权升级），为主机OS，Docker Engine和Docker Machine安装所有补丁非常重要。 <br><br> 此外，容器（与虚拟机不同）与主机一起使用内核，因此在容器内部运行的内核漏洞利用程序直接在主机内核中执行。 例如，在隔离良好的容器中运行的内核特权升级漏洞（例如Dirty COW）将导致对主机的根访问。 <br><br><h3> 规则一 </h3><h4> 不要访问docker守护进程的套接字 </h4><br>  Docker服务（守护程序）使用UNIX套接字/var/run/docker.sock进行传入API连接。  <b>此资源的所有者必须是root用户。</b> 而且没有其他办法。 更改对此套接字的访问权限实质上等同于授予对主机系统的根访问权限。 <br><br> 另外，您不应该在容器中弄乱/var/run/docker.sock套接字，在没有套接字的情况下也可以这样做，因为在这种情况下，破坏容器中的服务将导致对主机系统的完全控制。 如果您的容器使用以下内容： <br><br><pre><code class="bash hljs">-v /var/run/docker.sock://var/run/docker.sock</code> </pre> <br> 或对于docker-compose： <br><br><pre> <code class="bash hljs">volumes: - <span class="hljs-string"><span class="hljs-string">"/var/run/docker.sock:/var/run/docker.sock"</span></span></code> </pre> <br> 迫切需要改变这一点。 <br><br> 最后-在没有绝对需要的情况下， <b>永远不要</b>使用Docker TCP套接字，尤其是在不使用其他保护方法（至少是授权）的情况下。 默认情况下，Docker TCP套接字在外部接口0.0.0.0:2375（对于HTTPs为2376）上打开端口，并允许您完全控制容器以及潜在的主机系统。 <br><br><h3> 规则二 </h3><h4> 在容器内配置一个非特权用户 </h4><br> 配置容器以使用非特权用户是避免特权升级攻击的最佳方法。 这可以通过多种方式完成： <br><br>  1.使用“ docker run”命令的“ -u”选项： <br><br><pre> <code class="bash hljs">docker run -u 4000 alpine</code> </pre> <br>  2.在映像构建期间： <br><br><pre> <code class="bash hljs">FROM alpine RUN groupadd -r myuser &amp;&amp; useradd -r -g myuser myuser &lt;      root-, ,  &gt; USER myuser</code> </pre> <br>  3.在Docker守护程序中启用对“用户名称空间”（用户环境）的支持： <br><br><pre> <code class="bash hljs">--userns-remap=default</code> </pre> <br> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方文档中</a>阅读有关此内容的更多信息。 <br><br> 在Kubernetes中，后者是通过runAsNonRoot选项在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">安全上下文中</a>配置的： <br><br><pre> <code class="bash hljs">kind: ... apiVersion: ... metadata: name: ... spec: ... containers: - name: ... image: .... securityContext: ... runAsNonRoot: <span class="hljs-literal"><span class="hljs-literal">true</span></span> ...</code> </pre> <br><h3> 规则三 </h3><h4> 限制容器功能 </h4><br> 在Linux上，从内核2.2开始，有一种方法可以控制特权进程的功能，称为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux内核功能</a> （有关详细信息，请参见链接）。 <br><br>  Docker默认使用一组预定义的内核功能。 它允许您使用以下命令更改此设置： <br><br><pre> <code class="bash hljs">--<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-drop —     --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-add —    </code> </pre> <br> 最好的安全设置是先禁用所有功能（--cap-drop all），然后仅连接必要的功能。 例如，像这样： <br><br><pre> <code class="bash hljs">docker run --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-drop all --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-add CHOWN alpine</code> </pre> <br> 最重要的（！）：避免使用–privileged标志运行容器！ <br><br> 在Kubernetes中，通过功能选项在安全上下文中配置Linux内核功能约束： <br><br><pre> <code class="bash hljs">kind: ... apiVersion: ... metadata: name: ... spec: ... containers: - name: ... image: .... securityContext: ... capabilities: drop: - all add: - CHOWN ...</code> </pre><br><h3> 规则四 </h3><h4> 使用no-new-privileges标志 </h4><br> 启动容器时，使用--security-opt = no-new-privileges标志很有用，它可以防止容器内部的特权升级。 <br><br> 在Kubernetes中，可通过allowPrivilegeEscalation选项在安全上下文中配置Linux内核功能约束： <br><br><pre> <code class="bash hljs">kind: ... apiVersion: ... metadata: name: ... spec: ... containers: - name: ... image: .... securityContext: ... allowPrivilegeEscalation: <span class="hljs-literal"><span class="hljs-literal">false</span></span> ...</code> </pre><br><h3> 规则五 </h3><h4> 关闭容器间通信 </h4><br> 默认情况下，在Docker中启用容器间通信，这意味着所有容器都可以彼此通信（使用docker0网络）。 可以通过使用–icc = false标志运行Docker服务来禁用此功能。 <br><br><h3> 规则六 </h3><h4> 使用Linux安全模块（Linux安全模块-seccomp，AppArmor，SELinux） </h4><br> 默认情况下，Docker已经将配置文件用于Linux安全模块。 因此， <b>切勿禁用安全配置文件！</b> 他们可以做的最大事情就是收紧规则。 <br><br>  seccomp的默认配置文件位于<a href="">此处</a> 。 <br><br>  Docker还使用AppArmor进行保护，当容器启动时，Docker Engine本身会为AppArmor生成默认配置文件。 换句话说，代替： <br><br><pre> <code class="bash hljs">$ docker run --rm -it hello-world</code> </pre> <br> 启动： <br><br><pre> <code class="bash hljs">$ docker run --rm -it --security-opt apparmor=docker-default hello-world</code> </pre> <br> 该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a>还提供了一个用于nginx的AppArmor配置文件的示例，这很有可能（必要！）使用： <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#include &lt;tunables/global&gt; profile docker-nginx flags=(attach_disconnected,mediate_deleted) { #include &lt;abstractions/base&gt; network inet tcp, network inet udp, network inet icmp, deny network raw, deny network packet, file, umount, deny /bin/** wl, deny /boot/** wl, deny /dev/** wl, deny /etc/** wl, deny /home/** wl, deny /lib/** wl, deny /lib64/** wl, deny /media/** wl, deny /mnt/** wl, deny /opt/** wl, deny /proc/** wl, deny /root/** wl, deny /sbin/** wl, deny /srv/** wl, deny /tmp/** wl, deny /sys/** wl, deny /usr/** wl, audit /** w, /var/run/nginx.pid w, /usr/sbin/nginx ix, deny /bin/dash mrwklx, deny /bin/sh mrwklx, deny /usr/bin/top mrwklx, capability chown, capability dac_override, capability setuid, capability setgid, capability net_bind_service, deny @{PROC}/* w, # deny write for all files directly in /proc (not in a subdir) # deny write to files not in /proc/&lt;number&gt;/** or /proc/sys/** deny @{PROC}/{[^1-9],[^1-9][^0-9],[^1-9s][^0-9y][^0-9s],[^1-9][^0-9][^0-9][^0-9]*}/** w, deny @{PROC}/sys/[^k]** w, # deny /proc/sys except /proc/sys/k* (effectively /proc/sys/kernel) deny @{PROC}/sys/kernel/{?,??,[^s][^h][^m]**} w, # deny everything except shm* in /proc/sys/kernel/ deny @{PROC}/sysrq-trigger rwklx, deny @{PROC}/mem rwklx, deny @{PROC}/kmem rwklx, deny @{PROC}/kcore rwklx, deny mount, deny /sys/[^f]*/** wklx, deny /sys/f[^s]*/** wklx, deny /sys/fs/[^c]*/** wklx, deny /sys/fs/c[^g]*/** wklx, deny /sys/fs/cg[^r]*/** wklx, deny /sys/firmware/** rwklx, deny /sys/kernel/security/** rwklx, }</span></span></code> </pre><br><h3> 规则七 </h3><h4> 限制容器资源 </h4><br> 该规则非常简单：为了防止容器在下一次DoS / DDoS攻击期间吞噬所有服务器资源，我们可以分别为每个容器设置内存使用限制。 您可以限制：内存量，CPU，容器重新启动的次数。 <br><br> 因此，让我们按顺序进行。 <br><br>  <b><u>记忆</u></b> <br><br>  <b>-m或--memory选项</b> <br><br> 容器可以使用的最大内存量。 最小值为4m（4兆字节）。 <br><br>  <b>选项-内存交换</b> <br><br> 用于配置交换（交换文件）的选项。 巧妙配置： <br><br><ul><li> 如果--memory-swap&gt; 0，则还必须设置–memory标志。 在这种情况下，内存交换会显示容器与交换一起可使用的总内存量。 </li><li> 一个简单的例子。 如果--memory =“ 300m”，并且--memory-swap =“ 1g”，则该容器可以使用300MB内存和700MB交换空间（1g-300m）。 </li><li> 如果--memory-swap = 0，则忽略该设置。 </li><li> 如果--memory-swap设置为与--memory相同的值，则该容器将不具有交换功能。 </li><li> 如果未指定--memory-swap，但指定了--memory，则交换次数将等于指定的内存量的两倍。 例如，如果--memory =“ 300m”，并且未设置--memory-swap，则该容器将使用300MB内存和600MB交换空间。 </li><li> 如果--memory-swap = -1，则容器将使用主机系统上所有可能的交换。 </li></ul><br>  <b>给女主人的提示：在</b>容器内启动<b>的</b>免费实用程序并不显示容器可用交换的实际价值，而是主机交换的数量。 <br><br>  <b>选项-禁用oom-kill</b> <br><br> 允许您启用或禁用OOM（内存不足）杀手。 <br><br> 注意！ 您只能使用--memory选项设置来关闭OOM Killer，否则，如果容器内存不足，内核可能会开始杀死主机系统进程。 <br><br> 其他内存管理配置选项（例如--memory-swappiness，-memory-reservation和--kernel-memory）更多地用于调整容器的性能。 <br><br>  <b><u>中央处理器</u></b> <br><br>  <b>选项--cpus</b> <br><br> 该选项设置容器可以使用多少可用处理器资源。 例如，如果我们有一台带有两个CPU的主机，并且将--cpus =“ 1.5”设置为1，则该容器将保证使用一个半处理器。 <br><br>  <b>选项--cpuset-cpus</b> <br><br> 配置特定内核或CPU的使用。 可以用连字符或逗号指定该值。 在第一种情况下，将在第二个特定内核中指示允许的内核范围。 <br><br>  <b><u>容器重启次数</u></b> <br><br><pre> <code class="bash hljs">--restart=on-failure:&lt;number_of_restarts&gt;</code> </pre> <br> 此设置可设置Docker在意外崩溃时将尝试重新启动容器的次数。 如果容器的状态已更改为运行，则重置计数器。 <br><br> 建议设置一个较小的正数，例如5，这样可以避免无休止的服务重启。 <br><br><h3> 规则八 </h3><h4> 使用只读文件系统和卷 </h4><br> 如果容器不应该在任何地方写任何东西，那么您需要尽可能多地使用只读文件系统。 这将大大增加潜在入侵者的生命。 <br><br> 使用只读文件系统启动容器的示例： <br><br><pre> <code class="bash hljs">docker run --<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>-only alpine</code> </pre> <br> 以只读模式连接卷的示例： <br><br><pre> <code class="bash hljs">docker run -v volume-name:/path/<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>/container:ro alpine</code> </pre> <br><h3> 规则9 </h3><h4> 使用容器安全性分析工具 </h4><br> 必须使用工具来检测具有已知漏洞的容器。 它们还不是很多，但是它们是： <br><br>  •免费： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">克莱尔</a> </li></ul><br>  •商业： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Snyk</a> （有免费版本）； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">主持人</a> （有免费版本）； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JFrog XRay</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Qualys</a> 。 </li></ul><br> 对于Kubernetes，有一些用于检测配置错误的工具： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubeaudit</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubesec.io</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kube-bench</a> 。 </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448704/">https://habr.com/ru/post/zh-CN448704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448692/index.html">Zimbra的三个明显功能可以提高企业工作人员的效率</a></li>
<li><a href="../zh-CN448694/index.html">我们没有上电视的故事</a></li>
<li><a href="../zh-CN448696/index.html">网络研讨会Group-IB“威胁狩猎的新视角：攻击基础设施检测技术”</a></li>
<li><a href="../zh-CN448700/index.html">DjangoCon Europe2019。您的小马死了吗？</a></li>
<li><a href="../zh-CN448702/index.html">MicroPython加速</a></li>
<li><a href="../zh-CN448706/index.html">IPO初创公司Zoom之后，Zoom Technologies的股价上涨了47,000％。 许多投资者错误地购买了它们。</a></li>
<li><a href="../zh-CN448708/index.html">如果加密无济于事：谈论对设备的物理访问</a></li>
<li><a href="../zh-CN448710/index.html">UPS和电力回收：如何用蛇穿越刺猬？</a></li>
<li><a href="../zh-CN448712/index.html">学习英语的正式“请求-响应”逻辑：程序员的好处</a></li>
<li><a href="../zh-CN448718/index.html">在SPDS中创建金属桁架</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>