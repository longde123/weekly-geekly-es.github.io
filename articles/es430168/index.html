<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèº üëßüèΩ üÜò Usando ClickHouse en VK, o por qu√© escribimos KittenHouse üå°Ô∏è üë®‚Äçüë®‚Äçüë¶ üìÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A principios de a√±o, decidimos aprender a almacenar y leer registros de depuraci√≥n de VK de manera m√°s eficiente que antes. Los registros de depuraci√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando ClickHouse en VK, o por qu√© escribimos KittenHouse</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/430168/"><img src="https://habrastorage.org/webt/rr/st/hl/rrsthl86lfjf6fjaojdxickg_wu.jpeg" width="300" align="left">  A principios de a√±o, decidimos aprender a almacenar y leer registros de depuraci√≥n de VK de manera m√°s eficiente que antes.  Los registros de depuraci√≥n son, por ejemplo, registros de conversi√≥n de video (b√°sicamente la salida del comando ffmpeg y una lista de pasos para preprocesar archivos), que a veces solo necesitamos 2-3 meses despu√©s de procesar el archivo del problema. <br><br>  En ese momento, ten√≠amos 2 formas de almacenar y procesar registros: nuestro propio motor de registros y rsyslog, que utilizamos en paralelo.  Comenzamos a considerar otras opciones y nos dimos cuenta de que ClickHouse de Yandex es bastante adecuado para nosotros; decidimos implementarlo. <br><br>  En este art√≠culo, hablar√© sobre c√≥mo comenzamos a usar ClickHouse en VKontakte, qu√© rastrillo pisamos y qu√© son KittenHouse y LightHouse.  Ambos productos se presentan en enlaces de c√≥digo abierto al final del art√≠culo. <br><a name="habracut"></a><br><h3>  Tarea de recopilaci√≥n de registros </h3><br>  Requerimientos del sistema: <br><br><ol><li>  Almacenamiento de cientos de terabytes de troncos. </li><li>  Almacenamiento durante meses o (rara vez) a√±os. </li><li>  Alta velocidad de escritura. </li><li>  Alta velocidad de lectura (la lectura es rara). </li><li>  √çndice de soporte </li><li>  Soporte para cadenas largas (&gt; 4 Kb). </li><li>  Simplicidad de operaci√≥n. </li><li>  Almacenamiento compacto </li><li>  La capacidad de insertar desde decenas de miles de servidores (UDP ser√° una ventaja). </li></ol><br><h3>  Posibles soluciones </h3><br>  Enumeremos brevemente las opciones que consideramos y sus contras: <br><br><h4>  Motor de registros </h4><br>  Nuestro microservicio autoescrito para registros. <br><blockquote>  - Capaz de dar solo las √∫ltimas N l√≠neas que caben en la RAM. <br>  - Almacenamiento no muy compacto (sin compresi√≥n transparente). </blockquote><br><h4>  Hadoop </h4><br><blockquote>  - No todos los formatos tienen √≠ndices. <br>  - La velocidad de lectura podr√≠a ser mayor (seg√∫n el formato). <br>  - La complejidad de la configuraci√≥n. <br>  - No hay posibilidad de insertar desde decenas de miles de servidores (se necesitan Kafka o an√°logos). </blockquote><h4>  Rsyslog + archivos </h4><br><blockquote>  - No hay √≠ndices. <br>  - Baja velocidad de lectura (grep / zgrep regular). <br>  - Cadenas arquitect√≥nicamente no compatibles&gt; 4 Kb, UDP incluso menos (1.5 Kb). <br>  ¬± El almacenamiento compacto se logra mediante logrotate sobre la corona </blockquote><br>  Utilizamos rsyslog como respaldo para el almacenamiento a largo plazo, pero las l√≠neas largas se truncaron, por lo que dif√≠cilmente se puede llamar ideal. <br><br><h4>  Archivos LSD + </h4><br><blockquote>  - No hay √≠ndices. <br>  - Baja velocidad de lectura (grep / zgrep regular). <br>  - No est√° especialmente dise√±ado para la inserci√≥n de decenas de miles de servidores. <br>  ¬± El almacenamiento compacto se logra mediante logrotate sobre la corona. </blockquote>  Las diferencias con rsyslog en nuestro caso son que LSD admite cadenas largas, pero se requieren cambios significativos en el protocolo interno para insertar desde decenas de miles de servidores, aunque esto se puede hacer. <br><br><h4>  B√∫squeda el√°stica </h4><br><blockquote>  - Problemas con la operaci√≥n. <br>  - Grabaci√≥n inestable. <br>  - No UDP. <br>  - Mala compresi√≥n. </blockquote> La pila ELK ya es casi el est√°ndar de la industria para el almacenamiento de registros.  En nuestra experiencia, todo est√° bien con la velocidad de lectura, pero hay problemas con la escritura, por ejemplo, al fusionar √≠ndices. <br><br>  ElasticSearch est√° dise√±ado principalmente para b√∫squedas de texto completo y solicitudes de lectura relativamente frecuentes.  Para nosotros, la grabaci√≥n estable y la capacidad de leer nuestros datos m√°s o menos r√°pidamente son m√°s importantes y por coincidencia exacta.  El √≠ndice en ElasticSearch se agudiza para la b√∫squeda de texto completo, y el espacio en disco es bastante grande en comparaci√≥n con el gzip del contenido original. <br><br><h4>  Clickhouse </h4><br><blockquote>  - No UDP. </blockquote><br>  En general, lo √∫nico que no nos conven√≠a en ClickHouse era la falta de comunicaci√≥n UDP.  De hecho, de las opciones anteriores, solo rsyslog lo ten√≠a, pero rsyslog no admit√≠a largas colas. <br><br>  Seg√∫n otros criterios, ClickHouse se nos acerc√≥ y decidimos usarlo, y los problemas con el transporte se resolvieron en el proceso. <br><br><h3>  ¬øPor qu√© se necesita KittenHouse? </h3><br>  Como probablemente sepa, VKontakte funciona en PHP / KPHP, con "motores" (microservicios) en C / C ++ y un poco en Go.  PHP no tiene un concepto de "estado" entre las solicitudes, excepto quiz√°s para la memoria compartida y las conexiones abiertas. <br><br>  Dado que tenemos decenas de miles de servidores desde los cuales queremos poder enviar registros a ClickHouse, no ser√≠a rentable mantener conexiones abiertas de cada trabajador PHP (puede haber m√°s de 100 trabajadores para cada servidor).  Por lo tanto, necesitamos alg√∫n tipo de proxy entre ClickHouse y PHP.  Llamamos a este proxy KittenHouse. <br><br><h3>  KittenHouse, v1 </h3><br>  Primero, decidimos probar el esquema m√°s simple posible para comprender si nuestro enfoque funcionar√° o no.  Si Kafka te viene a la mente al resolver este problema, entonces no est√°s solo.  Sin embargo, no quer√≠amos usar servidores intermedios adicionales; en este caso, podr√≠amos descansar f√°cilmente en el rendimiento de estos servidores y no en ClickHouse.  Adem√°s, recopilamos registros y necesit√°bamos un retraso predecible y peque√±o en la inserci√≥n de datos.  El esquema es el siguiente: <br><br><img src="https://habrastorage.org/webt/az/pv/b8/azpvb8fivabsjrpasiemvl0_udw.png"><br><br>  En cada uno de los servidores, nuestro proxy local (kittenhouse) est√° instalado, y cada instancia mantiene estrictamente una conexi√≥n HTTP con el servidor ClickHouse necesario.  El pegado se realiza en tablas en cola, ya que a menudo no se recomienda insertar MergeTree. <br><br><h3>  Caracter√≠sticas KittenHouse, v1 </h3><br>  La primera versi√≥n de KittenHouse sab√≠a bastante, pero esto fue suficiente para probar: <br><br><ul><li>  Comunicaci√≥n a trav√©s de nuestro RPC (Esquema TL). </li><li>  Mantener 1 conexi√≥n TCP / IP por servidor. </li><li>  B√∫fer en memoria de forma predeterminada, con un tama√±o de b√∫fer limitado (el resto se descarta). </li><li>  La capacidad de escribir en el disco, en este caso, hay una garant√≠a de entrega (al menos una vez). </li><li>  El intervalo de inserci√≥n es una vez cada 2 segundos. </li></ul><br><h3>  Primeros problemas </h3><br>  Encontramos el primer problema cuando "pagamos" el servidor ClickHouse durante varias horas y luego lo volvimos a encender.  A continuaci√≥n puede ver el promedio de carga en el servidor despu√©s de que ha "aumentado": <br><br><img src="https://habrastorage.org/webt/jr/sm/o6/jrsmo61d61pmkmf1wt39l8igl_i.png"><br><br>  La explicaci√≥n es bastante simple: ClickHouse tiene una red por modelo de subproceso, por lo que cuando trato de hacer INSERT desde miles de nodos al mismo tiempo, hubo una fuerte competencia por los recursos de la CPU y el servidor apenas respondi√≥.  Sin embargo, todos los datos finalmente se insertaron y nada cay√≥. <br><br>  Para resolver este problema, colocamos nginx delante de ClickHouse y, en general, ayud√≥. <br><br><h3>  Mayor desarrollo </h3><br>  Durante la operaci√≥n, encontramos varios problemas, principalmente relacionados no con ClickHouse, sino con nuestra forma de operarlo.  Aqu√≠ hay otro rastrillo que pisamos: <br><br><h4>  Un gran n√∫mero de "fragmentos" de tablas de b√∫fer conduce a frecuentes descargas de b√∫fer en MergeTree </h4><br>  En nuestro caso, hab√≠a 16 piezas de b√∫fer y un intervalo de reinicio cada 2 segundos, y hab√≠a 20 piezas de tablas, que daban hasta 160 inserciones por segundo.  Esto afect√≥ peri√≥dicamente el rendimiento de la inserci√≥n: hubo muchas fusiones de fondo y la utilizaci√≥n del disco alcanz√≥ el 80% o m√°s. <br><br>  <b>Soluci√≥n:</b> aumente el intervalo predeterminado de reinicio del b√∫fer, reduzca el n√∫mero de piezas a 2. <br><br><h4>  Nginx devuelve 502 cuando las conexiones al extremo ascendente </h4><br>  Esto en s√≠ mismo no es un problema, pero en combinaci√≥n con el vaciado frecuente del b√∫fer, esto proporcion√≥ un fondo bastante alto de errores 502 al intentar insertar en cualquiera de las tablas, as√≠ como al intentar realizar SELECT. <br><br>  <b>Soluci√≥n:</b> escribieron su proxy inverso utilizando la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://github.com/valyala/fast">fasthttp</a> , que agrupa la inserci√≥n en tablas y consume conexiones de manera muy econ√≥mica.  Tambi√©n distingue entre SELECCIONAR e INSERTAR y tiene agrupaciones de conexiones separadas para inserci√≥n y lectura. <br><br><img src="https://habrastorage.org/webt/7i/4z/wl/7i4zwlmtjgfpgodsdqup1coqqus.png"><br><br><h4>  Quedarse sin memoria con inserci√≥n intensiva </h4><br>  La biblioteca fasthttp tiene sus ventajas y desventajas.  Uno de los inconvenientes es que la solicitud y la respuesta est√°n completamente almacenadas en la memoria antes de dar el control al manejador de solicitudes.  Para nosotros, esto result√≥ en el hecho de que si la inserci√≥n en ClickHouse "no ten√≠a tiempo", entonces los b√∫feres comenzaron a crecer y, finalmente, se acab√≥ toda la memoria en el servidor, lo que llev√≥ a la eliminaci√≥n de proxy inverso por parte de OOM.  Los colegas dibujaron un desmotivador: <br><br><img src="https://habrastorage.org/webt/ny/cb/k1/nycbk1toeiw_x-ktpun4gmicsf0.png" width="300"><br><br>  <b>Soluci√≥n:</b> parchear fasthttp para admitir la transmisi√≥n del cuerpo de la solicitud POST result√≥ ser una tarea desalentadora, por lo que decidimos usar conexiones Hijack () y actualizar la conexi√≥n a nuestro protocolo si la solicitud ven√≠a con el m√©todo HTTP KITTEN.  Dado que el servidor debe responder MEOW en respuesta, si comprende este protocolo, todo el esquema se denomina protocolo KITTEN / MEOW. <br><br>  Solo leemos de 50 conexiones aleatorias a la vez, por lo tanto, gracias a TCP / IP, el resto de los clientes "esperan" y no gastamos memoria en buffers hasta que la cola llegue a los respectivos clientes.  Esto redujo el consumo de memoria al menos 20 veces, y no tuvimos m√°s problemas de este tipo. <br><br><h4>  Las tablas ALTER pueden durar mucho si hay consultas largas </h4><br>  ClickHouse tiene un ALTER sin bloqueo en el sentido de que no interfiere con las consultas SELECT e INSERT.  Pero ALTER no puede comenzar hasta que haya terminado de ejecutar consultas a esta tabla enviada antes de ALTER. <br><br>  Si su servidor tiene un fondo de consultas "largas" para algunas tablas, entonces puede encontrar una situaci√≥n en la que ALTER en esta tabla no tendr√° tiempo para ejecutarse en un tiempo de espera predeterminado de 60 segundos.  Pero esto no significa que ALTER fallar√°: se ejecutar√° tan pronto como finalicen esas consultas SELECT. <br><br>  Esto significa que no sabe en qu√© momento realmente ocurri√≥ ALTER, y no tiene la capacidad de recrear autom√°ticamente las tablas de Buffer para que su dise√±o sea siempre el mismo.  Esto puede conducir a problemas de inserci√≥n. <br><br><img src="https://habrastorage.org/webt/59/3n/qn/593nqn-p_ujm0uqitctfapgj8t4.png"><br><br><img src="https://habrastorage.org/webt/pj/2p/8p/pj2p8pxgpjxefjjgo_yzbvqg_ys.png"><br><br>  <b>Soluci√≥n:</b> Como resultado, planeamos abandonar por completo el uso de tablas de b√∫fer.  En general, las tablas de b√∫fer tienen un alcance, hasta ahora las usamos y no experimentamos grandes problemas.  Pero ahora finalmente llegamos al punto en el que es m√°s f√°cil implementar la funcionalidad de las tablas de b√∫fer en el lado del proxy inverso que continuar soportando sus deficiencias.  Un circuito de ejemplo se ver√° as√≠ (la l√≠nea discontinua muestra la asincron√≠a ACK en INSERT). <br><br><img src="https://habrastorage.org/webt/1_/1f/l4/1_1fl4op3ycts_jltiboixtxmoq.png"><br><br><h3>  Lectura de datos </h3><br>  Digamos que descubrimos el inserto.  ¬øC√≥mo leer estos registros de ClickHouse?  Desafortunadamente, no encontramos ninguna herramienta conveniente y f√°cil de usar para leer datos sin procesar (sin gr√°ficos y otros) de ClickHouse, por lo que escribimos nuestra propia soluci√≥n: LightHouse.  Sus capacidades son bastante modestas: <br><br><ul><li>  Vista r√°pida del contenido de la tabla. </li><li>  Filtrado, clasificaci√≥n. </li><li>  Edici√≥n de una consulta SQL. </li><li>  Ver estructura de tabla. </li><li>  Muestra el n√∫mero aproximado de l√≠neas y espacio en disco utilizado. </li></ul><br>  Sin embargo, LightHouse es r√°pido y capaz de hacer lo que necesitamos.  Aqu√≠ hay un par de capturas de pantalla: <br><br>  <b>Ver estructura de tabla</b> <br><br><img src="https://habrastorage.org/webt/ne/jb/vt/nejbvtrgm8w2plmtk9rt24vtu9c.png"><br><br>  <b>Filtrado de contenido</b> <br><br><img src="https://habrastorage.org/webt/qe/-m/lj/qe-mlja21vnhuxziu3bzoj2gvek.png"><br><br><h3>  Resultados </h3><br>  ClickHouse es pr√°cticamente la √∫nica base de datos de c√≥digo abierto que ha echado ra√≠ces en VKontakte.  Estamos satisfechos con la velocidad de su trabajo y estamos listos para soportar las deficiencias, que se analizan a continuaci√≥n. <br><br><h4>  Dificultad en el trabajo </h4><br>  Con todo, ClickHouse es una base de datos muy estable y muy r√°pida.  Sin embargo, como con cualquier producto, especialmente tan joven, hay caracter√≠sticas en el trabajo que deben considerarse: <br><br><ul><li>  No todas las versiones son igualmente estables: no actualice directamente a la nueva versi√≥n en producci√≥n, es mejor esperar varias versiones de correcci√≥n de errores. </li><li>  Para un rendimiento √≥ptimo, es muy recomendable configurar RAID y algunas otras cosas de acuerdo con las instrucciones.  Esto se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">inform√≥ recientemente en alta carga</a> . </li><li>  La replicaci√≥n no tiene l√≠mites de velocidad incorporados y puede causar una degradaci√≥n significativa del rendimiento del servidor si no lo limita usted mismo (pero prometen solucionarlo). </li><li>  Linux tiene una caracter√≠stica desagradable del mecanismo de memoria virtual: si escribe activamente en el disco y los datos no tienen tiempo para ser vaciados, en alg√∫n momento el servidor "entra en s√≠ mismo" por completo, comienza a vaciar activamente el cach√© de la p√°gina en el disco y bloquea casi por completo el proceso ClickHouse.  Esto a veces ocurre con grandes fusiones, y debe supervisar esto, por ejemplo, peri√≥dicamente para limpiar los buffers o sincronizar. </li></ul><br><h3>  C√≥digo abierto </h3><br>  KittenHouse y LightHouse ahora est√°n disponibles en c√≥digo abierto en nuestro repositorio de github: <br><br><ul><li>  KittenHouse: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/vkcom/kittenhouse</a> </li><li>  LightHouse: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/vkcom/lighthouse</a> </li></ul><br>  Gracias <br><br>  <i>Yuri Nasretdinov, desarrollador en el departamento de infraestructura de back-end de VKontakte</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430168/">https://habr.com/ru/post/es430168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430156/index.html">"Despegue o no": aparecer√° un nuevo reproductor en el mercado de servicios de transmisi√≥n de video</a></li>
<li><a href="../es430158/index.html">10 mandamientos de seguridad que podr√≠an ser √∫tiles para cualquier organizaci√≥n</a></li>
<li><a href="../es430160/index.html">Dise√±o UX / UI del nuevo VS 2019</a></li>
<li><a href="../es430164/index.html">C√≥mo decir no a un cliente extranjero y no arruinar las relaciones comerciales</a></li>
<li><a href="../es430166/index.html">Lo nuevo en Blazor 0.7.0</a></li>
<li><a href="../es430172/index.html">Sitio est√°tico sin servidor utilizando IPFS</a></li>
<li><a href="../es430178/index.html">Sol artificial chino ...</a></li>
<li><a href="../es430180/index.html">"La mente est√° en l√≠nea". Contacto con una mente diferente</a></li>
<li><a href="../es430182/index.html">CodeOne 2018 como JavaOne pero solo en m√°scara</a></li>
<li><a href="../es430186/index.html">Computaci√≥n perezosa en la vida cotidiana</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>