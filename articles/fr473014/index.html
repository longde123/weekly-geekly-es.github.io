<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíª üîÆ üïù Pr√©sentation de l'autorisation Kubernetes du consul Hashicorp üö° üë∞üèø üôãüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C'est vrai, apr√®s la sortie de Hashicorp Consul 1.5.0 au d√©but de mai 2019 dans Consul, vous pouvez autoriser les applications et les services s'ex√©cu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√©sentation de l'autorisation Kubernetes du consul Hashicorp</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/473014/"><img src="https://habrastorage.org/webt/ge/q3/ey/geq3eyqujybgzgmalsngtz3azuu.png"><br><p>  C'est vrai, apr√®s la sortie de <a href="">Hashicorp Consul 1.5.0</a> au d√©but de mai 2019 dans Consul, vous pouvez autoriser les applications et les services s'ex√©cutant dans Kubernetes en mode natif. </p><br><p>  Dans ce tutoriel, nous allons cr√©er pas √† pas un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">POC</a> (Proof of concept, PoC - proof of concept] - d√©montrant cette nouvelle fonctionnalit√©. Une connaissance de base de Kubernetes et du Consul d'Hashicorp est attendue de vous. Et bien que vous vous pouvez utiliser n'importe quelle plateforme cloud ou environnement local, dans ce guide, nous utiliserons la plateforme cloud de Google. </p><a name="habracut"></a><br><h2>  Revue </h2><br><p>  Si nous nous tournons vers la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Consul sur sa m√©thode d'autorisation</a> , nous obtiendrons un bref aper√ßu de son objet et de son cas d'utilisation, ainsi que quelques d√©tails techniques et un aper√ßu g√©n√©ral de la logique.  Je recommande fortement de le lire au moins une fois avant de continuer, car je vais l'expliquer et le m√¢cher maintenant. </p><br><img src="https://habrastorage.org/webt/ca/xp/mp/caxpmprm5u-8bupb1_fpjgehvcw.png"><br><p>  <i>Figure 1: Aper√ßu de la m√©thode d'autorisation du consul officiel</i> </p><br><p>  Jetons un coup d'≈ìil √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de la m√©thode d'autorisation Kubernetes sp√©cifique</a> . </p><br><p>  Bien s√ªr, il y a des informations utiles, mais il n'y a pas de guide sur la fa√ßon d'utiliser r√©ellement tout cela.  Par cons√©quent, comme toute personne sens√©e, vous parcourez Internet pour vous guider.  Et puis ... √™tre vaincu.  √áa arrive.  Corrigeons-le. </p><br><p>  Avant de passer √† la cr√©ation de notre POC, revenons √† l'aper√ßu des m√©thodes d'autorisation du consul (figure 1) et affinons-le dans le contexte de Kubernetes. </p><br><h2 id="arhitektura">  L'architecture </h2><br><p>  Dans ce guide, nous allons cr√©er un serveur Consul sur une machine distincte qui interagira avec le cluster Kubernetes avec le client Consul install√©.  Ensuite, nous allons cr√©er notre application factice dans l'√¢tre et utiliser notre m√©thode d'autorisation personnalis√©e pour lire √† partir de notre r√©f√©rentiel de cl√©s / valeurs Consul. </p><br><p>  Le sch√©ma ci-dessous montre en d√©tail l'architecture que nous cr√©ons dans ce guide, ainsi que la logique de la m√©thode d'autorisation, qui sera expliqu√©e plus loin. </p><br><img src="https://habrastorage.org/webt/az/zn/kj/azznkjy-wrxrndezbwxezarbs-4.png"><br><p>  <em>Figure 2: Pr√©sentation de la m√©thode d'autorisation dans Kubernetes</em> </p><br><p>  Une note rapide: le serveur consul n'a pas besoin de vivre en dehors du cluster Kubernetes pour que cela fonctionne.  Mais oui, il peut faire ceci et cela. </p><br><p> Donc, en prenant le diagramme de vue d'ensemble du consul (sch√©ma 1) et en lui appliquant Kubernetes, nous obtenons le diagramme ci-dessus (sch√©ma 2), et ici la logique sera la suivante: </p><br><ol><li>  Chaque pod aura un compte de service attach√© contenant un jeton JWT g√©n√©r√© et connu par Kubernetes.  Ce jeton est √©galement ins√©r√© dans le sous par d√©faut. </li><li>  Notre application ou service √† l'int√©rieur du foyer lance une commande pour entrer dans notre client Consul.  La demande de connexion indiquera √©galement notre token et le nom d'une m√©thode d'autorisation <strong>sp√©cialement cr√©√©e</strong> (telle que Kubernetes).  Cette √©tape n ¬∞ 2 correspond √† l'√©tape 1 du dispositif Consul (sch√©ma 1). </li><li>  Notre client Consul transmettra ensuite cette demande √† notre serveur Consul. </li><li>  MAGIQUE!  C'est ici que le serveur Consul v√©rifie l'authenticit√© de la demande, recueille des informations sur l'identit√© de la demande et la compare avec les r√®gles pr√©d√©finies associ√©es.  Voici un autre diagramme pour illustrer cela.  Cette √©tape correspond aux √©tapes 3, 4 et 5 du sch√©ma de synth√®se Consul (Sch√©ma 1). </li><li>  Notre serveur Consul g√©n√®re un jeton Consul avec des autorisations conform√©ment aux r√®gles de la m√©thode d'autorisation que nous avons sp√©cifi√©e (que nous avons d√©termin√©e) concernant l'identit√© du demandeur.  Ensuite, il renverra ce jeton.  Cela correspond √† l'√©tape 6 du programme Consul (sch√©ma 1). </li><li>  Notre client Consul redirige le jeton vers l'application ou le service demandeur. </li></ol><br><p>  Notre application ou service peut d√©sormais utiliser ce jeton Consul pour communiquer avec nos donn√©es Consul, comme d√©termin√© par les privil√®ges du jeton. </p><br><h2 id="volshebstvo-raskryto">  La magie est r√©v√©l√©e! </h2><br><p>  Pour ceux d'entre vous qui ne sont pas satisfaits du lapin dans le chapeau et qui veulent savoir comment cela fonctionne ... permettez-moi de "vous montrer la profondeur du <strong>trou</strong> du <strong>lapin</strong> ". </p><br><p>  Comme mentionn√© pr√©c√©demment, notre √©tape ¬´magique¬ª (Sch√©ma 2: √âtape 4) est que le serveur Consul v√©rifie l'authenticit√© de la demande, recueille des informations sur la demande et la compare avec toutes les r√®gles pr√©d√©finies associ√©es.  Cette √©tape correspond aux √©tapes 3, 4 et 5 du sch√©ma de synth√®se Consul (Sch√©ma 1).  Vous trouverez ci-dessous un diagramme (sch√©ma 3), dont le but est de montrer clairement ce qui se passe r√©ellement <em>sous le capot d'une</em> m√©thode d'autorisation Kubernetes sp√©cifique. </p><br><img src="https://habrastorage.org/webt/5e/5w/eg/5e5wegybhhtjkwkotfs1disgzc8.png"><br><p>  <em>Sch√©ma 3: La magie est r√©v√©l√©e!</em> </p><br><ol><li>  Comme point de d√©part, notre client Consul redirige la demande de connexion vers notre serveur Consul avec le jeton de compte Kubernetes et le nom sp√©cifique de l'instance de la m√©thode d'autorisation qui a √©t√© cr√©√©e pr√©c√©demment.  Cette √©tape correspond √† l'√©tape 3 de l'explication pr√©c√©dente du circuit. </li><li>  Le serveur Consul (ou leader) doit maintenant v√©rifier l'authenticit√© du jeton re√ßu.  Par cons√©quent, il consultera le cluster Kubernetes (via le client Consul) et, avec les autorisations appropri√©es, nous verrons si le jeton est authentique et √† qui il appartient. </li><li>  Ensuite, la demande v√©rifi√©e revient au responsable Consul et le serveur Consul recherche une instance de la m√©thode d'autorisation avec le nom sp√©cifi√© dans la demande de connexion (et tapez Kubernetes). </li><li>  Le chef de consul d√©termine l'instance sp√©cifi√©e de la m√©thode d'autorisation (s'il en existe une) et lit l'ensemble des r√®gles contraignantes qui lui sont attach√©es.  Il lit ensuite ces r√®gles et les compare avec des attributs d'identit√© v√©rifi√©s. </li><li>  Tada!  Passez √† l'√©tape 5 de l'explication pr√©c√©dente du circuit. </li></ol><br><h2 id="zapustite-consul-server-na-obychnoy-virtualnoy-mashine">  Ex√©cutez Consul-server sur une machine virtuelle standard </h2><br><p>  D√©sormais, je donnerai principalement des instructions pour cr√©er ce POC, souvent en points, sans phrases enti√®res explicatives.  En outre, comme indiqu√© pr√©c√©demment, j'utiliserai GCP pour cr√©er l'ensemble de l'infrastructure, mais vous pouvez cr√©er la m√™me infrastructure n'importe o√π ailleurs. </p><br><ul><li>  D√©marrez la machine virtuelle (instance / serveur). </li></ul><br><img src="https://habrastorage.org/webt/gg/5m/j-/gg5mj-dyw9frdaglrfwizvbkna8.png"><br><ul><li>  Cr√©ez une r√®gle pour le pare-feu (groupe de s√©curit√© dans AWS): </li><li>  J'aime attribuer le m√™me nom de machine √† la r√®gle et √† la balise r√©seau, dans ce cas, c'est ¬´skywiz-consul-server-poc¬ª. </li><li>  Trouvez l'adresse IP de votre ordinateur local et ajoutez-la √† la liste des adresses IP source afin que nous puissions acc√©der √† l'interface utilisateur (UI). </li><li>  Ouvrez le port 8500 pour l'interface utilisateur.  Cliquez sur Cr√©er.  Nous allons bient√¥t changer ce pare-feu [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ]. </li><li>  Ajoutez la r√®gle de pare-feu √† l'instance.  Revenez au tableau de bord de la VM sur le serveur Consul et ajoutez ¬´skywiz-consul-server-poc¬ª au champ de balise r√©seau.  Cliquez sur Enregistrer. </li></ul><br><img src="https://habrastorage.org/webt/o3/7i/52/o37i52gc_8k8fxu4ve113oh7ljc.png"><br><ul><li>  Installez Consul sur une machine virtuelle, v√©rifiez ici.  N'oubliez pas que vous avez besoin de la version Consul ‚â• 1.5 [link] </li><li>  Cr√©ez un seul n≈ìud Consul - la configuration est la suivante. </li></ul><br><pre><code class="plaintext hljs">groupadd --system consul useradd -s /sbin/nologin --system -g consul consul mkdir -p /var/lib/consul chown -R consul:consul /var/lib/consul chmod -R 775 /var/lib/consul mkdir /etc/consul.d chown -R consul:consul /etc/consul.d</code> </pre> <br><ul><li>  Pour un guide plus d√©taill√© sur l'installation de Consul et la configuration d'un cluster de 3 n≈ìuds, voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </li><li>  Cr√©ez le fichier /etc/consul.d/agent.json comme suit [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ]: </li></ul><br><pre> <code class="plaintext hljs">### /etc/consul.d/agent.json { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } }</code> </pre> <br><ul><li>  Lancez notre serveur Consul: </li></ul><br><pre> <code class="plaintext hljs">consul agent \ -server \ -ui \ -client 0.0.0.0 \ -data-dir=/var/lib/consul \ -bootstrap-expect=1 \ -config-dir=/etc/consul.d</code> </pre> <br><ul><li>  Vous devriez voir un tas de sortie et vous retrouver avec "... mise √† jour bloqu√©e par les ACL". </li><li>  Localisez l'adresse IP externe du serveur Consul et ouvrez un navigateur avec cette adresse IP sur le port 8500. Assurez-vous que l'interface utilisateur s'ouvre. </li><li>  Essayez d'ajouter une paire cl√© / valeur.  Il doit y avoir une erreur.  En effet, nous avons charg√© le serveur Consul √† l'aide de l'ACL et refus√© toutes les r√®gles. </li><li>  Revenez √† votre shell sur le serveur Consul et d√©marrez le processus en arri√®re-plan ou d'une autre mani√®re pour qu'il fonctionne, et entrez ce qui suit: </li></ul><br><pre> <code class="plaintext hljs">consul acl bootstrap</code> </pre> <br><ul><li>  Trouvez la valeur "SecretID" et revenez √† l'interface utilisateur.  Dans l'onglet ACL, entrez l'identifiant secret du jeton que vous venez de copier.  Copiez SecretID ailleurs, nous en aurons besoin plus tard. </li><li>  Ajoutez maintenant une paire cl√© / valeur.  Pour ce POC, ajoutez ce qui suit: cl√©: "custom-ns / test_key", valeur: "Je suis dans le dossier custom-ns!" </li></ul><br><h2 id="zapusk-kubernetes-klastera-dlya-nashego-prilozheniya-s-consul-klientom-v-kachestve-daemonset">  Lancez Kubernetes Cluster pour notre application avec Consul Client en tant que Daemonset </h2><br><ul><li>  Cr√©ez un cluster K8s (Kubernetes).  Nous allons le cr√©er dans la m√™me zone que le serveur pour un acc√®s plus rapide, et donc nous pouvons utiliser le m√™me sous-r√©seau pour une connexion facile avec les adresses IP internes.  Nous l'appellerons skywiz-app-with-consul-client-poc. </li></ul><br><img src="https://habrastorage.org/webt/_l/vp/gu/_lvpgupywaktqzykauebirhibm0.png"><br><ul><li>  Comme note, voici un bon guide que j'ai rencontr√© lors de la configuration d'un cluster POC Consul avec Consul Connect. </li><li>  Nous utiliserons √©galement le graphique de barre Hashicorp avec un fichier de valeurs √©tendu. </li><li>  Installez et configurez Helm.  √âtapes de configuration: </li></ul><br><pre> <code class="plaintext hljs">kubectl create serviceaccount tiller --namespace kube-system kubectl create clusterrolebinding tiller-admin-binding \ --clusterrole=cluster-admin --serviceaccount=kube-system:tiller ./helm init --service-account=tiller ./helm update</code> </pre> <br><ul><li>  graphique de barre: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/docs/platform/k8s/helm.html</a> </li><li>  Utilisez le fichier de valeurs suivant (notez la plupart que j'ai d√©sactiv√©): </li></ul><br><pre> <code class="plaintext hljs">### poc-helm-consul-values.yaml global: enabled: false image: "consul:latest" # Expose the Consul UI through this LoadBalancer ui: enabled: false # Allow Consul to inject the Connect proxy into Kubernetes containers connectInject: enabled: false # Configure a Consul client on Kubernetes nodes. GRPC listener is required for Connect. client: enabled: true join: ["&lt;PRIVATE_IP_CONSUL_SERVER&gt;"] extraConfig: | { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } } # Minimal Consul configuration. Not suitable for production. server: enabled: false # Sync Kubernetes and Consul services syncCatalog: enabled: false</code> </pre> <br><ul><li>  Appliquer le tableau de barre: </li></ul><br><pre> <code class="plaintext hljs">./helm install -f poc-helm-consul-values.yaml ./consul-helm - name skywiz-app-with-consul-client-poc</code> </pre> <br><ul><li>  Lorsque vous essayez de d√©marrer, il aura besoin d'autorisations pour le serveur Consul, alors ajoutons-les. </li><li>  Faites attention √† la "plage d'adresses Pod" situ√©e sur le tableau de bord du cluster et revenez √† notre r√®gle pour le pare-feu skywiz-consul-server-poc. </li><li>  Ajoutez la plage d'adresses pour l'IPA √† la liste des adresses IP et ouvrez les ports 8301 et 8300. </li></ul><br><img src="https://habrastorage.org/webt/gh/wu/bi/ghwubingk53amwe3qnbiendjgvm.png"><br><ul><li>  Acc√©dez √† l'interface utilisateur du Consul, et dans quelques minutes, vous verrez que notre cluster appara√Ætra sur l'onglet du n≈ìud. </li></ul><br><img src="https://habrastorage.org/webt/j1/l_/h5/j1l_h5fj5iusg3ea3rxc7qc_sb8.png"><br><h2 id="nastroyka-metoda-avtorizacii-putem-integracii-consul-s-kubernetes">  Configurer la m√©thode d'autorisation en int√©grant Consul √† Kubernetes </h2><br><ul><li>  Revenez au shell du serveur Consul et exportez le jeton que vous avez enregistr√© pr√©c√©demment: </li></ul><br><pre> <code class="plaintext hljs">export CONSUL_HTTP_TOKEN=&lt;SecretID&gt;</code> </pre> <br><ul><li>  Nous avons besoin des informations de notre cluster Kubernetes pour cr√©er une instance de m√©thode d'authentification: </li><li>  kubernetes-host </li></ul><br><pre> <code class="plaintext hljs">kubectl get endpoints | grep kubernetes</code> </pre> <br><ul><li>  kubernetes-service-account-jwt </li></ul><br><pre> <code class="plaintext hljs">kubectl get sa &lt;helm_deployment_name&gt;-consul-client -o yaml | grep "\- name:" kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep token:</code> </pre> <br><ul><li>  Le jeton est encod√© en base64, alors d√©chiffrez-le √† l'aide de votre outil pr√©f√©r√© [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">link</a> ] </li><li>  kubernetes-ca-cert </li></ul><br><pre> <code class="plaintext hljs">kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep ca.crt:</code> </pre> <br><ul><li>  Prenez le certificat ¬´ca.crt¬ª (apr√®s d√©codage avec base64) et √©crivez-le dans le fichier ¬´ca.crt¬ª. </li><li>  Cr√©ez maintenant une instance de la m√©thode auth, en rempla√ßant les espaces r√©serv√©s par les valeurs que vous venez de recevoir. </li></ul><br><pre> <code class="plaintext hljs">consul acl auth-method create \ -type "kubernetes" \ -name "auth-method-skywiz-consul-poc" \ -description "This is an auth method using kubernetes for the cluster skywiz-app-with-consul-client-poc" \ -kubernetes-host "&lt;k8s_endpoint_retrieved earlier&gt;" \ -kubernetes-ca-cert=@ca.crt \ -kubernetes-service-account- jwt="&lt;decoded_token_retrieved_earlier&gt;"</code> </pre> <br><ul><li>  Ensuite, nous devons cr√©er une r√®gle et l'attacher au nouveau r√¥le.  Vous pouvez utiliser l'interface utilisateur Consul pour cette partie, mais nous utiliserons la ligne de commande. </li><li>  √âcrivez une r√®gle </li></ul><br><pre> <code class="plaintext hljs">### kv-custom-ns-policy.hcl key_prefix "custom-ns/" { policy = "write" }</code> </pre> <br><ul><li>  Appliquer la r√®gle </li></ul><br><pre> <code class="plaintext hljs">consul acl policy create \ -name kv-custom-ns-policy \ -description "This is an example policy for kv at custom-ns/" \ -rules @kv-custom-ns-policy.hcl</code> </pre> <br><ul><li>  Recherchez l'identifiant de la r√®gle que vous venez de cr√©er √† partir de la sortie. </li><li>  Cr√©ez un r√¥le avec une nouvelle r√®gle. </li></ul><br><pre> <code class="plaintext hljs">consul acl role create \ -name "custom-ns-role" \ -description "This is an example role for custom-ns namespace" \ -policy-id &lt;policy_id&gt;</code> </pre> <br><ul><li>  Nous allons maintenant associer notre nouveau r√¥le √† l'instance de la m√©thode auth.  Veuillez noter que l'indicateur de s√©lection d√©termine si notre demande de connexion recevra ce r√¥le.  D√©couvrez les autres options du s√©lecteur ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/docs/acl/auth-methods/kubernetes.html#trusted-identity-attributes</a> </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-ns-role' \ -selector='serviceaccount.namespace=="custom-ns"'</code> </pre> <br><h2 id="konfiguracii-naposledok">  Derni√®res configurations </h2><br><h3 id="prava-dostupa">  Droits d'acc√®s </h3><br><ul><li>  Cr√©ez des autorisations.  Nous devons donner au consul l'autorisation de v√©rifier et d'identifier l'identit√© du jeton du compte de service K8s. </li><li>  √âcrivez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[lien] suivant</a> dans le fichier: </li></ul><br><pre> <code class="plaintext hljs">###skywiz-poc-consul-server_rbac.yaml --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: review-tokens namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: system:auth-delegator apiGroup: rbac.authorization.k8s.io --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: service-account-getter namespace: default rules: - apiGroups: [""] resources: ["serviceaccounts"] verbs: ["get"] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: get-service-accounts namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: service-account-getter apiGroup: rbac.authorization.k8s.io</code> </pre> <br><ul><li>  Cr√©er des droits d'acc√®s </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f skywiz-poc-consul-server_rbac.yaml</code> </pre> <br><h3 id="podklyuchenie-k-consul-client">  Connectez-vous au client Consul </h3><br><ul><li>  Comme indiqu√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , il existe plusieurs options pour se connecter √† daemonset, mais nous allons passer √† la solution simple suivante: </li><li>  Appliquez le fichier suivant [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ]. </li></ul><br><pre> <code class="plaintext hljs">### poc-consul-client-ds-svc.yaml apiVersion: v1 kind: Service metadata: name: consul-ds-client spec: selector: app: consul chart: consul-helm component: client hasDNS: "true" release: skywiz-app-with-consul-client-poc ports: - protocol: TCP port: 80 targetPort: 8500</code> </pre> <br><ul><li>  Utilisez ensuite la commande int√©gr√©e suivante pour cr√©er le configmap [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ].  Veuillez noter que nous nous r√©f√©rons au nom de notre service, remplacez-le si n√©cessaire. </li></ul><br><pre> <code class="plaintext hljs">cat &lt;&lt;EOF | kubectl apply -f - apiVersion: v1 kind: ConfigMap metadata: labels: addonmanager.kubernetes.io/mode: EnsureExists name: kube-dns namespace: kube-system data: stubDomains: | {"consul": ["$(kubectl get svc consul-ds-client -o jsonpath='{.spec.clusterIP}')"]} EOF</code> </pre> <br><h2 id="testirovanie-auth-metoda">  Test de la m√©thode d'authentification </h2><br><p>  Voyons maintenant la magie en action! </p><br><ul><li>  Cr√©ez quelques dossiers de cl√©s suppl√©mentaires avec la m√™me cl√© de niveau sup√©rieur (c'est-√†-dire &lt;nouveau_fichier&gt; / sample_key) et la valeur de votre choix.  Cr√©ez des strat√©gies et des r√¥les appropri√©s pour de nouveaux chemins d'acc√®s cl√©s.  Nous ferons les reliures plus tard. </li></ul><br><img src="https://habrastorage.org/webt/qm/yi/jn/qmyijnz6f7yy4kx-3l6owupoulk.png"><br><h3 id="polzovatelskiy-test-prostranstva-imen">  Test d'espace de noms personnalis√©: </h3><br><ul><li>  Cr√©ez notre propre espace de noms: </li></ul><br><pre> <code class="plaintext hljs">kubectl create namespace custom-ns</code> </pre> <br><ul><li>  Cr√©ez sous dans notre nouvel espace de noms.  √âcrivez la configuration du foyer. </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-ns.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-ns namespace: custom-ns spec: containers: - name: poc-ubuntu-custom-ns image: ubuntu command: ["/bin/bash", "-ec", "sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Cr√©er sous: </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f poc-ubuntu-custom-ns.yaml</code> </pre> <br><ul><li>  Une fois le conteneur d√©marr√©, allez-y et installez curl. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec poc-ubuntu-custom-ns -n custom-ns -it /bin/bash apt-get update &amp;&amp; apt-get install curl -y</code> </pre> <br><ul><li>  Nous allons maintenant envoyer une demande pour entrer dans Consul en utilisant la m√©thode d'autorisation que nous avons cr√©√©e plus t√¥t [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ]. </li><li>  Pour afficher le jeton entr√© √† partir de votre compte de service: </li></ul><br><pre> <code class="plaintext hljs">cat /run/secrets/kubernetes.io/serviceaccount/token</code> </pre> <br><ul><li>  √âcrivez ce qui suit dans un fichier √† l'int√©rieur du conteneur: </li></ul><br><pre> <code class="plaintext hljs">### payload.json { "AuthMethod": "auth-method-test", "BearerToken": "&lt;jwt_token&gt;" }</code> </pre> <br><ul><li>  Connectez-vous! </li></ul><br><pre> <code class="plaintext hljs">curl \ --request POST \ --data @payload.json \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Pour effectuer les √©tapes ci-dessus sur une seule ligne (car nous ex√©cuterons plusieurs tests), vous pouvez effectuer les op√©rations suivantes: </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  √áa marche!  Doit au moins.  Maintenant, prenez le SecretID et essayez d'acc√©der √† la cl√© / valeur √† laquelle nous devons avoir acc√®s. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-ns/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID_from_prev_response&gt;‚Äù</code> </pre> <br><ul><li>  Vous pouvez d√©coder la base ¬´Value¬ª 64 et voir qu'elle correspond √† la valeur dans custom-ns / test_key dans l'interface utilisateur.  Si vous avez utilis√© la m√™me valeur ci-dessus dans ce manuel, votre valeur encod√©e serait IkknbSBpbiB0aGUgY3VzdG9tLW5zIGZvbGRlciEi. </li></ul><br><h3 id="test-uchetnoy-zapisi-polzovatelskoy-sluzhby">  Test de compte de service utilisateur: </h3><br><ul><li>  Cr√©ez un ServiceAccount personnalis√© avec la commande suivante [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ]. </li></ul><br><pre> <code class="plaintext hljs">kubectl apply -f - &lt;&lt;EOF apiVersion: v1 kind: ServiceAccount metadata: name: custom-sa EOF</code> </pre> <br><ul><li>  Cr√©ez un nouveau fichier de configuration pour l'√¢tre.  Veuillez noter que j'ai activ√© l'installation de boucle pour √©conomiser du travail :) </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-sa.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-sa namespace: default spec: serviceAccountName: custom-sa containers: - name: poc-ubuntu-custom-sa image: ubuntu command: ["/bin/bash","-ec"] args: ["apt-get update &amp;&amp; apt-get install curl -y; sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Apr√®s cela, ex√©cutez le shell √† l'int√©rieur du conteneur. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec -it poc-ubuntu-custom-sa /bin/bash</code> </pre> <br><ul><li>  Connectez-vous! </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Autorisation refus√©e.  Oh, nous avons oubli√© d'ajouter une nouvelle liaison de r√®gle avec les autorisations appropri√©es, faisons-le maintenant. </li></ul><br><p>  R√©p√©tez les √©tapes pr√©c√©dentes ci-dessus: <br>  a) Cr√©ez une politique identique pour le pr√©fixe "custom-sa /". <br>  b) Cr√©ez un r√¥le, nommez-le "custom-sa-role" <br>  c) Attachez la strat√©gie au r√¥le. </p><br><ul><li>  Cr√©ez une r√®gle de liaison (uniquement possible √† partir de cli / api).  Notez la valeur diff√©rente de l'indicateur de s√©lection. </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-sa-role' \ -selector='serviceaccount.name=="custom-sa"'</code> </pre> <br><ul><li>  Connectez-vous √† nouveau √† partir du conteneur poc-ubuntu-custom-sa.  Succ√®s! </li><li>  V√©rifiez notre acc√®s au chemin custom-sa / key. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-sa/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID&gt;‚Äù</code> </pre> <br><ul><li>  Vous pouvez √©galement vous assurer que ce jeton ne donne pas acc√®s √† kv dans ¬´custom-ns /¬ª.  R√©p√©tez simplement la commande ci-dessus apr√®s avoir remplac√© ¬´custom-sa¬ª par le pr√©fixe ¬´custom-ns¬ª. <br>  Autorisation refus√©e. </li></ul><br><h3 id="primer-overleya">  Exemple de superposition: </h3><br><ul><li>  Il convient de noter que tous les mappages de liaison de r√®gles seront ajout√©s au jeton avec ces droits. </li><li>  Notre conteneur poc-ubuntu-custom-sa est dans l'espace de noms par d√©faut - nous allons donc l'utiliser pour une autre liaison de r√®gles. </li><li>  R√©p√©tez les √©tapes pr√©c√©dentes: <br>  a) Cr√©ez une politique identique pour le pr√©fixe de cl√© ¬´par d√©faut /¬ª. <br>  b) Cr√©ez un r√¥le, nommez-le "default-ns-role" <br>  c) Attachez la strat√©gie au r√¥le. </li><li>  Cr√©er une liaison de r√®gles (uniquement possible √† partir de cli / api) </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='default-ns-role' \ -selector='serviceaccount.namespace=="default"'</code> </pre> <br><ul><li>  Revenez √† notre conteneur poc-ubuntu-custom-sa et essayez d'acc√©der au chemin "default /" kv. </li><li>  Autorisation refus√©e. <br>  Vous pouvez afficher les informations d'identification sp√©cifi√©es pour chaque jeton dans l'interface utilisateur sous ACL&gt; Tokens.  Comme vous pouvez le voir, un seul ¬´r√¥le custom-sa¬ª est attach√© √† notre jeton actuel.  Le jeton que nous utilisons actuellement a √©t√© g√©n√©r√© lorsque nous nous sommes connect√©s, puis il n'y a eu qu'une seule liaison de r√®gles, qui correspondait alors.  Nous devons nous reconnecter et utiliser le nouveau jeton. </li><li>  Assurez-vous que vous pouvez lire √† la fois les chemins kv ¬´custom-sa /¬ª et ¬´default /¬ª. <br>  Succ√®s! <br>  En effet, notre poc-ubuntu-custom-sa correspond aux liaisons des r√®gles custom-sa et default-ns. </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><h3 id="ttl-token-mgmt">  Mgmt de jeton TTL? </h3><br><p>  Au moment d'√©crire ces lignes, il n'existe aucun moyen int√©gr√© de d√©terminer le TTL pour les jetons g√©n√©r√©s par cette m√©thode d'autorisation.  Ce serait une opportunit√© fantastique de fournir une automatisation s√©curis√©e de l'autorisation du consul. </p><br><p>  Il est possible de cr√©er manuellement un token avec TTL: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/docs/acl/acl-system.html#acl-tokens</a> <br>  Heure d'expiration - L'heure √† laquelle ce jeton sera r√©voqu√©.  (Facultatif; ajout√© dans Consul 1.5.0) </li><li>  Existe uniquement pour la cr√©ation / mise √† jour manuelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/api/acl/tokens.html#expirationtime</a> </li></ul><br><p>  J'esp√®re que dans un avenir proche, nous serons en mesure de contr√¥ler la fa√ßon dont les jetons sont g√©n√©r√©s (pour chaque r√®gle ou m√©thode d'autorisation) et d'ajouter TTL. </p><br><p>  D'ici l√†, il est propos√© d'utiliser dans votre logique le point final de la sortie du syst√®me. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/api/acl/acl.html#logout-from-auth-method</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.consul.io/docs/acl/acl-auth-methods.html#overall-login-process</a> </li></ul><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Lisez √©galement d'autres articles sur notre blog: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quel a √©t√© le r√©sultat de la migration de ClickHouse sans autorisation vers ClickHouse avec autorisation</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment ex√©cuter plusieurs pipelines √† l'aide de GitLab CI / CD</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Trois astuces simples pour r√©duire les images de docker</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Traefik en tant que contr√¥leur d'entr√©e pour K8S</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sauvegarde d'un grand nombre de projets Web h√©t√©rog√®nes</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bot t√©l√©gramme pour Redmine.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment simplifier la vie pour vous et les gens</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473014/">https://habr.com/ru/post/fr473014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472996/index.html">Le Pentagone d√©veloppe une technologie de contr√¥le des drones avec les pens√©es des soldats</a></li>
<li><a href="../fr473000/index.html">Un petit guide math√©matique pour les √©trangers</a></li>
<li><a href="../fr473002/index.html">Explication du paradoxe de Fermi dans le cadre de la sociologie spatiale Liu Qixin</a></li>
<li><a href="../fr473008/index.html">La loi de l'acc√©l√©ration des retours (partie 2)</a></li>
<li><a href="../fr473012/index.html">R√©sultats de la conf√©rence des partenaires Advantech √† Moscou</a></li>
<li><a href="../fr473018/index.html">Conseils aux candidats d'un programmeur r√©alisant des entretiens sur Facebook</a></li>
<li><a href="../fr473026/index.html">Om-yum-yum et validation des donn√©es</a></li>
<li><a href="../fr473028/index.html">En Russie a commenc√© √† importer des d√©chets radioactifs d'Europe? Tri√©</a></li>
<li><a href="../fr473030/index.html">Nous calculons les bots "mal√©fiques" potentiels et les bloquons par IP</a></li>
<li><a href="../fr473032/index.html">"L'espoir est une mauvaise strat√©gie." SRE intensif √† Moscou, 3-5 f√©vrier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>