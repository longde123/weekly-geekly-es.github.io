<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµüèæ üï§ üë©üèº‚Äçüéì MongoDB Survival Guide üì¢ üÖøÔ∏è ü•ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alle guten Startups sterben entweder schnell oder wachsen ma√üstabsgetreu. Wir werden ein solches Startup modellieren, bei dem es zuerst um Funktionen ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MongoDB Survival Guide</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/454748/">  Alle guten Startups sterben entweder schnell oder wachsen ma√üstabsgetreu.  Wir werden ein solches Startup modellieren, bei dem es zuerst um Funktionen und dann um Leistung geht.  Mit MongoDB, einer beliebten NoSQL-Datenspeicherl√∂sung, verbessern wir die Leistung.  MongoDB ist einfach zu starten und viele Probleme haben sofort einsatzbereite L√∂sungen.  Wenn jedoch die Last zunimmt, kommt ein Rechen heraus, vor dem Sie noch niemand gewarnt hat ... bis heute! <br><br><img src="https://habrastorage.org/webt/oh/rq/ua/ohrquayfyh04hfgs-gareddfzlk.gif" alt="Bild"><br><br>  Die Modellierung wird von <strong>Sergey Zagursky durchgef√ºhrt</strong> , der f√ºr die Backend-Infrastruktur im Allgemeinen und MongoDB im Besonderen in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Joom verantwortlich ist</a> .  Es wurde auch auf der Serverseite der Entwicklung von MMORPG Skyforge gesehen.  Wie Sergei sich selbst beschreibt, ist er ‚Äûein professioneller Kegelnehmer mit eigener Stirn und Rechen‚Äú.  Unter dem Mikroskop ein Projekt, das eine Akkumulationsstrategie verwendet, um technische Schulden zu verwalten.  In dieser Textversion des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Berichts</a> in HighLoad ++ werden wir in chronologischer Reihenfolge vom Auftreten des Problems zur L√∂sung mit MongoDB √ºbergehen. <br><a name="habracut"></a><br><h2>  Erste Schwierigkeiten </h2><br>  Wir modellieren ein Startup, das Unebenheiten stopft.  Die erste Lebensphase - Funktionen werden in unserem Startup gestartet und unerwartet kommen Benutzer.  Unser kleiner MongoDB-Server hat eine Last, von der wir nie getr√§umt haben.  Aber wir sind in der Cloud, wir sind ein Startup!  Wir machen die einfachsten Dinge: Schauen Sie sich die Anforderungen an - oh, und hier haben wir die gesamte Korrektur f√ºr jeden Benutzer abgezogen, hier werden wir die Indizes erstellen, wir werden die Hardware dort hinzuf√ºgen und hier werden wir zwischenspeichern. <br>  Alles - wir leben weiter! <br><br><blockquote>  Wenn Probleme mit so einfachen Mitteln gel√∂st werden k√∂nnen, sollten sie auf diese Weise gel√∂st werden. </blockquote><br>  Der zuk√ºnftige Weg eines erfolgreichen Starts ist jedoch eine langsame, schmerzhafte Verz√∂gerung des horizontalen Skalierungsmoments.  Ich werde versuchen, Ratschl√§ge zu geben, wie man diese Zeit √ºberlebt, zur Skalierung kommt und nicht auf den Rechen tritt. <br><br><h2>  Langsame Aufnahme </h2><br>  Dies ist eines der Probleme, auf die Sie m√∂glicherweise sto√üen.  Was tun, wenn Sie sie treffen und die oben genannten Methoden nicht helfen?  Antwort: <strong>Standardm√§√üig ist der</strong> <strong>Haltbarkeitsgarantiemodus</strong> <strong>in MongoDB</strong> .  In drei Worten funktioniert es so: <br><br><ul><li>  Wir kamen zur Hauptleitung und sagten: "Schreiben!". <br></li><li>  Prim√§rreplik aufgezeichnet. <br></li><li>  Danach wurden sekund√§re Repliken von ihr gelesen und sie sagten prim√§r: "Wir haben aufgenommen!" <br></li></ul><br>  In dem Moment, in dem die meisten sekund√§ren Replikate dies getan haben, wird die Anforderung als vollst√§ndig betrachtet und die Steuerung kehrt zum Treiber in der Anwendung zur√ºck.  Mit solchen Garantien k√∂nnen wir sicher sein, dass die Haltbarkeit nach der R√ºckkehr der Kontrolle zur Anwendung nirgendwohin f√ºhrt, selbst wenn MongoDB sich hinlegt, au√üer bei absolut schrecklichen Katastrophen. <br><br><blockquote>  Gl√ºcklicherweise ist MongoDB eine solche Datenbank, mit der Sie die Haltbarkeitsgarantien f√ºr jede einzelne Anfrage reduzieren k√∂nnen. </blockquote><br>  Bei wichtigen Anfragen k√∂nnen wir standardm√§√üig die maximalen Haltbarkeitsgarantien beibehalten und bei einigen Anfragen reduzieren. <br><br><h3>  Klassen anfordern </h3><br>  Die erste Garantieebene, die wir entfernen k√∂nnen, besteht darin, <strong>nicht auf die Best√§tigung des Datensatzes durch die meisten Replikate zu warten</strong> .  Dies spart Latenz, erh√∂ht jedoch nicht die Bandbreite.  Manchmal ist jedoch eine Latenz erforderlich, insbesondere wenn der Cluster etwas √ºberlastet ist und sekund√§re Replikate nicht so schnell funktionieren, wie wir es m√∂chten. <br><br><pre><code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>}</code> </pre> <br>  Wenn wir Aufzeichnungen mit solchen Garantien schreiben, wissen wir in dem Moment, in dem wir die Kontrolle √ºber die Anwendung erhalten, nicht mehr, ob die Aufzeichnung nach einem Unfall lebendig sein wird.  Aber normalerweise lebt sie noch. <br><br>  Die n√§chste Garantie, die sich auch auf Bandbreite und Latenz auswirkt, ist das <strong>Deaktivieren der Protokollierungsbest√§tigung</strong> .  Ein Journaleintrag wird trotzdem geschrieben.  Das Magazin ist einer der grundlegenden Mechanismen.  Wenn wir die Best√§tigung des Schreibens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><u><strong>deaktivieren</strong></u></a> , tun wir nicht zwei Dinge: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><u><strong>fsync</strong></u></a> <strong>im Protokoll</strong> und <strong>warten nicht, bis es endet</strong> .  Dies kann <strong>eine Menge Festplattenressourcen einsparen</strong> und den <strong>Durchsatz</strong> um ein <strong>Vielfaches steigern, indem</strong> einfach die Dauer der Garantie ge√§ndert wird. <br><br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}</code> </pre> <br>  Die strengsten Haltbarkeitsgarantien sind das <strong>Deaktivieren von Best√§tigungen</strong> .  Wir erhalten nur eine Best√§tigung, dass die Anfrage das prim√§re Replikat erreicht hat.  Dies spart Latenz und erh√∂ht den Durchsatz in keiner Weise. <br><br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>} ‚Äî   .</code> </pre> <br>  Wir werden auch verschiedene andere Dinge erhalten, zum Beispiel, dass die Aufzeichnung aufgrund eines Konflikts mit einem eindeutigen Schl√ºssel fehlgeschlagen ist. <br><br><h3>  F√ºr welche Operationen gilt dies? </h3><br>  Ich erz√§hle Ihnen von der Anwendung f√ºr das Setup in Joom.  Zus√§tzlich zur Last von Benutzern, bei denen es keine Zugest√§ndnisse f√ºr die Haltbarkeit gibt, gibt es eine Last, die als Hintergrund-Batch-Last bezeichnet werden kann: Aktualisieren, Nachz√§hlen von Bewertungen, Sammeln von Analysedaten. <br><br>  Diese Hintergrundoperationen k√∂nnen Stunden dauern, sind jedoch so konzipiert, dass sie bei einem Absturz, beispielsweise einem Backend, nicht das Ergebnis all ihrer Arbeit verlieren, sondern von dem Punkt in der j√ºngeren Vergangenheit aus fortgesetzt werden.  Das Reduzieren der Haltbarkeitsgarantie ist f√ºr solche Aufgaben n√ºtzlich, insbesondere da fsync im Protokoll wie bei allen anderen Vorg√§ngen die Latenz auch beim Lesen erh√∂ht. <br><br><h2>  Skalierung lesen </h2><br>  Das n√§chste Problem ist die <strong>unzureichende Lesebandbreite</strong> .  Denken Sie daran, dass es in unserem Cluster nicht nur prim√§re, sondern auch sekund√§re Replikate gibt, <strong>aus denen Sie lesen k√∂nnen</strong> .  Lass es uns tun. <br><br>  Sie k√∂nnen lesen, aber es gibt Nuancen.  Etwas veraltete Daten stammen von sekund√§ren Replikaten - um 0,5 bis 1 Sekunden.  In den meisten F√§llen ist dies normal, aber das Verhalten des sekund√§ren Replikats unterscheidet sich vom Verhalten der prim√§ren Replikate. <br><br>  Auf der sekund√§ren Ebene wird oplog verwendet, das sich nicht auf der prim√§ren Replik befindet.  Dieser Prozess ist nicht auf niedrige Latenz ausgelegt - nur die MongoDB-Entwickler haben sich nicht darum gek√ºmmert.  Unter bestimmten Umst√§nden kann die Verwendung von Oplog von prim√§r zu sekund√§r zu Verz√∂gerungen von bis zu 10 s f√ºhren. <br><br><blockquote>  Sekund√§re Replikate sind nicht f√ºr Benutzeranfragen geeignet - Benutzererfahrungen machen einen flotten Schritt in den Papierkorb. </blockquote><br>  Auf nicht schattierten Clustern sind diese Spitzen weniger auff√§llig, aber immer noch vorhanden.  Shard-Cluster leiden darunter, dass Oplog besonders vom L√∂schen betroffen ist und das <strong>L√∂schen Teil der Aufgabe des Balancers ist</strong> .  Der Balancer l√∂scht Dokumente in kurzer Zeit zuverl√§ssig und geschmackvoll zu Zehntausenden. <br><br><h2>  Anzahl der Verbindungen </h2><br>  Der n√§chste zu ber√ºcksichtigende Faktor ist die <strong>Begrenzung der Anzahl der Verbindungen auf MongoDB-Instanzen</strong> .  Standardm√§√üig gibt es keine Einschr√§nkungen, <strong>au√üer f√ºr Betriebssystemressourcen.</strong> Sie k√∂nnen eine Verbindung herstellen, solange dies zul√§ssig ist. <br><br>  Je mehr gleichzeitige Anforderungen gleichzeitig ausgef√ºhrt werden, desto langsamer werden sie ausgef√ºhrt.  <strong>Die Leistung verschlechtert sich nichtlinear</strong> .  Wenn daher eine Zunahme von Anfragen bei uns eintrifft, ist es besser, 80% zu bedienen, als 100% nicht zu bedienen.  Die Anzahl der Verbindungen muss direkt auf MongoDB begrenzt werden. <br><br>  Es gibt jedoch Fehler, die aufgrund dessen Probleme verursachen k√∂nnen.  Insbesondere ist der <strong>Verbindungspool auf der MongoDB-Seite sowohl f√ºr Benutzer- als auch f√ºr Service-Intracluster-Verbindungen gleich</strong> .  Wenn die Anwendung alle Verbindungen aus diesem Pool "gefressen" hat, kann die Integrit√§t im Cluster verletzt werden. <br><br>  Wir haben davon erfahren, als wir den Index neu erstellen wollten, und da wir die Eindeutigkeit aus dem Index entfernen mussten, durchlief das Verfahren mehrere Phasen.  In MongoDB k√∂nnen Sie nicht gleich neben dem Index erstellen, jedoch ohne Eindeutigkeit.  Deshalb wollten wir: <br><br><ul><li>  Erstellen Sie einen √§hnlichen Index ohne Eindeutigkeit <br></li><li>  Entfernen Sie den Index mit Eindeutigkeit. <br></li><li>  Erstellen Sie einen Index ohne Eindeutigkeit anstelle von Remote. <br></li><li>  vor√ºbergehend l√∂schen. <br></li></ul><br>  Als der tempor√§re Index noch auf dem sekund√§ren Index fertiggestellt wurde, haben wir begonnen, den eindeutigen Index zu l√∂schen.  Zu diesem Zeitpunkt k√ºndigte die sekund√§re MongoDB ihre Sperre an.  Einige Metadaten wurden blockiert, und in der Mehrzahl wurden alle Datens√§tze gestoppt: Sie hingen im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><u>Verbindungspool</u></a> und warteten darauf, dass sie best√§tigten, dass der Datensatz bestanden wurde.  Alle Lesevorg√§nge auf der Sekund√§rseite wurden ebenfalls gestoppt, da das globale Protokoll erfasst wurde. <br><br>  Der Cluster in einem so interessanten Zustand verlor auch seine Konnektivit√§t.  Manchmal erschien es und als zwei Bemerkungen miteinander verbunden waren, versuchten sie, in ihrem Zustand eine Wahl zu treffen, die sie nicht treffen konnten, weil sie eine globale Sperre haben. <br><br><blockquote>  Moral der Geschichte: Die Anzahl der Verbindungen muss √ºberwacht werden. </blockquote><br>  Es gibt einen bekannten MongoDB-Rechen, der immer noch so oft angegriffen wird, dass ich mich entschlossen habe, einen kurzen Spaziergang darauf zu machen. <br><br><h2>  Verlieren Sie keine Dokumente </h2><br>  Wenn Sie eine Anforderung per Index an MongoDB senden, gibt die <strong>Anforderung m√∂glicherweise nicht alle Dokumente zur√ºck</strong> , die die Bedingung erf√ºllen, und dies in v√∂llig unerwarteten F√§llen.  Dies liegt an der Tatsache, dass wenn wir zum Anfang des Index gehen, das Dokument, das am Ende f√ºr die Dokumente, die wir √ºbergeben haben, an den Anfang verschoben wird.  Dies ist ausschlie√ülich <strong>auf die Ver√§nderlichkeit des Index zur√ºckzuf√ºhren</strong> .  Verwenden Sie f√ºr eine zuverl√§ssige Iteration <strong>Indizes f√ºr nicht stabile Felder,</strong> und es treten keine Schwierigkeiten auf. <br>  MongoDB hat seine eigenen Ansichten, welche Indizes verwendet werden sollen.  Die L√∂sung ist einfach: <strong>Mit Hilfe von $ Hinweis zwingen wir MongoDB, den von uns angegebenen Index zu verwenden</strong> . <br><br><h2>  Sammlungsgr√∂√üen </h2><br>  Unser Startup entwickelt sich, es gibt viele Daten, aber ich m√∂chte keine Festplatten hinzuf√ºgen - wir haben im letzten Monat bereits dreimal hinzugef√ºgt.  Mal sehen, was in unseren Daten gespeichert ist, schauen wir uns die Gr√∂√üe der Dokumente an.  Wie k√∂nnen Sie verstehen, wo in der Sammlung Sie die Gr√∂√üe reduzieren k√∂nnen?  Nach zwei Parametern. <br><br><ul><li>  <strong>Die Gr√∂√üe</strong> <strong>bestimmter Dokumente</strong> , die mit ihrer L√§nge <code>Object.bsonsize()</code> : <code>Object.bsonsize()</code> ; <br></li><li>  <strong>Entsprechend der durchschnittlichen</strong> <strong>Gr√∂√üe des Dokuments in</strong> <strong>der</strong> <strong>Sammlung</strong> : <code>db.c.stats().avgObjectSize</code> . <br></li></ul><br><h3>  Wie kann die Gr√∂√üe des Dokuments beeinflusst werden? </h3><br>  Ich habe unspezifische Antworten auf diese Frage.  Erstens <strong>erh√∂ht</strong> ein <strong>langer Feldname die Gr√∂√üe des Dokuments.</strong>  In jedem Dokument werden alle Feldnamen kopiert. Wenn das Dokument also einen langen Feldnamen hat, muss die Gr√∂√üe des Namens zur Gr√∂√üe jedes Dokuments hinzugef√ºgt werden.  Wenn Sie eine Sammlung mit einer gro√üen Anzahl kleiner Dokumente in mehreren Feldern haben, benennen Sie die Felder mit Kurznamen: "A", "B", "CD" - maximal zwei Buchstaben.  <strong>Auf der Festplatte wird dies durch Komprimierung ausgeglichen</strong> , aber alles wird unver√§ndert im Cache gespeichert. <br><br>  Der zweite Tipp ist, dass manchmal <strong>einige Felder mit geringer Kardinalit√§t im Namen der Sammlung platziert werden k√∂nnen</strong> .  Beispielsweise kann ein solches Feld eine Sprache sein.  Wenn wir eine Sammlung mit √úbersetzungen ins Russische, Englische, Franz√∂sische und ein Feld mit Informationen zur gespeicherten Sprache haben, kann der Wert dieses Feldes in den Namen der Sammlung eingetragen werden.  So <strong>reduzieren</strong> wir <strong>die Gr√∂√üe von Dokumenten</strong> und k√∂nnen <strong>die Anzahl und Gr√∂√üe von Indizes reduzieren</strong> - <strong>reine</strong> Einsparungen!  Dies ist nicht immer m√∂glich, da manchmal Indizes im Dokument vorhanden sind, die nicht funktionieren, wenn die Sammlung in verschiedene Sammlungen unterteilt ist. <br><br>  Letzter Tipp zur Dokumentgr√∂√üe - <strong>Verwenden Sie das Feld _id</strong> .  Wenn Ihre Daten einen nat√ºrlichen eindeutigen Schl√ºssel haben, geben Sie ihn direkt in das Feld id_field ein.  Auch wenn der Schl√ºssel zusammengesetzt ist - verwenden Sie eine zusammengesetzte ID.  Es ist perfekt indiziert.  Es gibt nur einen kleinen Rechen: Wenn Ihr Marshaller manchmal die Reihenfolge der Felder √§ndert, wird die ID mit denselben Feldwerten, aber mit unterschiedlicher Reihenfolge als unterschiedliche ID in Bezug auf einen eindeutigen Index in MongoDB betrachtet.  In einigen F√§llen kann dies in Go passieren. <br><br><h2>  Indexgr√∂√üen </h2><br>  <strong>Der Index speichert eine Kopie der darin enthaltenen Felder</strong> .  Die Gr√∂√üe des Index besteht aus den indizierten Daten.  Wenn wir versuchen, gro√üe Felder zu indizieren, m√ºssen Sie sich darauf einstellen, dass der Index gro√ü ist. <br><br>  Der zweite Moment erh√∂ht die Indizes stark: <strong>Array-Felder im Index multiplizieren andere Felder aus dem Dokument in diesem Index</strong> .  Seien Sie vorsichtig mit gro√üen Arrays in Dokumenten: Indizieren Sie entweder nichts anderes f√ºr das Array oder spielen Sie mit der Reihenfolge, in der die Felder im Index aufgelistet sind. <br><br>  <strong>Die Reihenfolge der Felder ist wichtig</strong> , <strong>insbesondere wenn eines der Indexfelder ein Array ist</strong> .  Wenn sich die Felder in der Kardinalit√§t unterscheiden und sich in einem Feld die Anzahl der m√∂glichen Werte stark von der Anzahl der m√∂glichen Werte in einem anderen Feld unterscheidet, ist es sinnvoll, sie durch Erh√∂hen der Kardinalit√§t zu erstellen.  <strong>Sie k√∂nnen problemlos 50% der Indexgr√∂√üe speichern, wenn Sie Felder mit unterschiedlicher Kardinalit√§t austauschen.</strong>  Die Permutation der Felder kann zu einer signifikanteren Verringerung der Gr√∂√üe f√ºhren. <br><br>  Manchmal, wenn das Feld einen gro√üen Wert enth√§lt, m√ºssen wir diesen Wert nicht mehr oder weniger vergleichen, sondern einen klaren Gleichheitsvergleich.  Dann kann der <strong>Index f√ºr das Feld mit starkem Inhalt</strong> <strong>durch den Index f√ºr Hash aus diesem Feld ersetzt werden</strong> .  Kopien von Hash werden im Index gespeichert, keine Kopien dieser Felder. <br><br><h2>  Dokumente l√∂schen </h2><br>  Ich habe bereits erw√§hnt, dass das L√∂schen von Dokumenten ein unangenehmer Vorgang ist und <strong>es besser ist, wenn m√∂glich nicht zu l√∂schen.</strong>  Versuchen Sie beim Entwerfen eines Datenschemas, entweder das Entfernen einzelner Daten zu minimieren oder ganze Sammlungen zu l√∂schen.  Sie k√∂nnten mit ganzen Sammlungen gel√∂scht werden.  Das Entfernen von Sammlungen ist ein billiger Vorgang, und das L√∂schen von Tausenden einzelner Dokumente ist ein schwieriger Vorgang. <br><br>  Wenn Sie immer noch viele Dokumente l√∂schen m√ºssen, <strong>m√ºssen Sie die Drosselung durchf√ºhren</strong> . Andernfalls <strong>wirkt sich</strong> das Massenl√∂schen von Dokumenten auf die Leselatenz aus und ist unangenehm.  Dies ist besonders schlecht f√ºr die Latenz auf sekund√§ren. <br><br>  Es lohnt sich, eine Art ‚ÄûStift‚Äú zu machen, um die Drosselung zu aktivieren - es ist sehr schwierig, das Niveau beim ersten Mal zu erreichen.  Wir haben es so oft durchlaufen, dass die Drosselung ab dem dritten, vierten Mal vermutet wird.  Betrachten Sie zun√§chst die M√∂glichkeit eines Festziehens. <br><br>  <strong>Wenn Sie mehr als 30% einer gro√üen Sammlung l√∂schen, √ºbertragen Sie Live-Dokumente in die benachbarte Sammlung</strong> und l√∂schen Sie die alte Sammlung als Ganzes.  Es ist klar, dass es Nuancen gibt, weil die Last von der alten auf die neue Sammlung umgeschaltet wird, aber wenn m√∂glich verschoben wird. <br><br>  Eine andere M√∂glichkeit, Dokumente zu l√∂schen, ist der <strong>TTL-</strong> Index, ein Index, der das Feld indiziert, das den Mongo-Zeitstempel enth√§lt, der das Datum enth√§lt, an dem das Dokument gestorben ist.  Zu diesem Zeitpunkt l√∂scht MongoDB dieses Dokument automatisch. <br><br>  Der TTL-Index ist praktisch, aber <strong>es gibt keine Drosselung in der Implementierung.</strong>  MongoDB ist es egal, wie diese L√∂schungen entfernt werden.  Wenn Sie versuchen, eine Million Dokumente gleichzeitig zu l√∂schen, haben Sie einige Minuten lang einen nicht funktionsf√§higen Cluster, der sich nur mit dem L√∂schen und nicht mehr befasst.  Um dies zu verhindern, f√ºgen Sie etwas <strong>Zuf√§lligkeit hinzu</strong> , <strong>verbreiten Sie die TTL</strong> so weit, wie es Ihre Gesch√§ftslogik und die Spezialeffekte auf die Latenz zulassen.  Das Verschmieren von TTL ist unerl√§sslich, wenn Sie nat√ºrliche Gr√ºnde f√ºr die Gesch√§ftslogik haben, die das L√∂schen zu einem bestimmten Zeitpunkt konzentrieren. <br><br><h2>  Scherben </h2><br>  Wir haben versucht, diesen Moment zu verschieben, aber es ist soweit - wir m√ºssen immer noch horizontal skalieren.  F√ºr MongoDB ist dies eine Scherbe. <br><br><blockquote>  Wenn Sie bezweifeln, dass Sie Scherben ben√∂tigen, brauchen Sie diese nicht. </blockquote><br>  Sharding verkompliziert das Leben eines Entwicklers und entwickelt sich auf verschiedene Weise.  In einem Unternehmen nennen wir es Sharding Tax.  Wenn wir eine Sammlung sharden, nimmt die <strong>spezifische Leistung der Sammlung ab</strong> : MongoDB ben√∂tigt einen separaten Index f√ºr das Sharding, und zus√§tzliche Parameter m√ºssen an die Anforderung √ºbergeben werden, damit sie effizienter ausgef√ºhrt werden kann. <br><br>  Einige Sharding-Dinge funktionieren einfach nicht gut.  Zum Beispiel ist es eine schlechte Idee, Abfragen mit <code>skip</code> , insbesondere wenn Sie viele Dokumente haben.  Sie geben den Befehl: "100.000 Dokumente √ºberspringen." <br><br>  MongoDB denkt so: ‚ÄûErstens, zweitens, drittens ... einhunderttausendstel, gehen wir weiter.  Und wir werden dies dem Benutzer zur√ºckgeben. ‚Äú <br><br>  In einer nicht gemeinsam genutzten Sammlung f√ºhrt MongoDB eine Operation irgendwo in sich selbst aus.  In Shard-like - sie liest wirklich alle 100.000 Dokumente und sendet sie an einen Sharding-Proxy - in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><u>Mongos</u></a> , die bereits auf ihrer Seite die ersten 100.000 herausfiltern und verwerfen. Eine unangenehme Funktion, die man beachten sollte. <br><br>  <strong>Der Code wird mit dem Sharding sicherlich komplizierter - Sie</strong> m√ºssen den Sharding-Schl√ºssel an viele Stellen ziehen.  Dies ist nicht immer bequem und nicht immer m√∂glich.  Einige Abfragen werden entweder per Broadcast oder Multicast gesendet, wodurch auch die Skalierbarkeit nicht erh√∂ht wird.  Treffen Sie die Wahl eines Schl√ºssels, mit dem das Sharding genauer wird. <br><br>  <strong>In Shard-Sammlungen wird die <code>count</code> unterbrochen</strong> .  Sie beginnt mehr als in der Realit√§t eine Zahl zur√ºckzugeben - sie kann zweimal l√ºgen.  Der Grund liegt im Ausgleichsprozess, wenn Dokumente von einem Splitter zum anderen gegossen werden.  Wenn die Dokumente auf den benachbarten Splitter gegossen, aber noch nicht auf dem Original gel√∂scht wurden, <code>count</code> sie trotzdem gez√§hlt.  MongoDB-Entwickler nennen dies keinen Fehler - es ist eine solche Funktion.  Ich wei√ü nicht, ob sie das Problem beheben werden oder nicht. <br><br>  <strong>Ein gemischter Cluster ist viel schwieriger zu verwalten</strong> .  Devops werden Sie nicht mehr begr√º√üen, da das Entfernen eines Backups radikal komplizierter wird.  Beim Sharding blinkt die Notwendigkeit einer Infrastrukturautomatisierung wie ein Feueralarm - etwas, auf das Sie vorher h√§tten verzichten k√∂nnen. <br><br><h3>  Wie Sharding in MongoDB funktioniert </h3><br>  Es gibt eine Sammlung, wir wollen sie irgendwie um Scherben verteilen.  Zu diesem <strong>Zweck teilt MongoDB die Sammlung</strong> mithilfe des Shard-Schl√ºssels <strong>in Bl√∂cke</strong> auf und versucht, sie im Shard-Schl√ºsselbereich in gleiche Teile zu teilen.  Als n√§chstes kommt der Balancer, der <strong>diese Brocken</strong> sorgf√§ltig <strong>nach den Scherben im Cluster auslegt</strong> .  Dar√ºber hinaus ist es dem Balancer egal, wie viel diese Brocken wiegen und wie viele Dokumente sich darin befinden, da das Balancieren St√ºck f√ºr St√ºck erfolgt. <br><br><h2>  Sharding Key </h2><br>  Entscheiden Sie immer noch, was Sie scherben m√∂chten?  Nun, die erste Frage ist, wie man einen Sharding-Schl√ºssel ausw√§hlt.  Ein guter Schl√ºssel hat mehrere Parameter: <strong>hohe Kardinalit√§t</strong> , <strong>Nichtstabilit√§t</strong> und <strong>passt gut zu h√§ufigen Anforderungen</strong> . <br><br>  Die nat√ºrliche Wahl eines Sharding-Schl√ºssels ist der Prim√§rschl√ºssel - das ID-Feld.  Wenn das ID-Feld zum Sharding geeignet ist, ist es besser, direkt darauf zu sharden.  Dies ist eine ausgezeichnete Wahl - er hat eine gute Kardinalit√§t, er ist nicht stabil, aber wie gut er in h√§ufige Anfragen passt, h√§ngt von Ihrer Gesch√§ftsspezifit√§t ab.  Bauen Sie auf Ihre Situation auf. <br><br>  Ich werde ein Beispiel f√ºr einen fehlgeschlagenen Sharding-Schl√ºssel geben.  Ich habe bereits die Sammlung von √úbersetzungen erw√§hnt - √úbersetzungen.  Es hat ein Sprachfeld, in dem die Sprache gespeichert ist.  Zum Beispiel unterst√ºtzt die Sammlung 100 Sprachen und wir shard Sprache.  Das ist schlecht - Kardinalit√§t, die Anzahl der m√∂glichen Werte betr√§gt nur 100 St√ºck, was klein ist.  Dies ist jedoch nicht das Schlimmste - vielleicht reicht Kardinalit√§t f√ºr diese Zwecke aus.  Schlimmer noch, sobald wir uns in der Sprache umgesehen haben, stellen wir sofort fest, dass wir dreimal mehr englischsprachige Benutzer haben als die anderen.  Dreimal so viele Anfragen kommen an die ungl√ºckliche Scherbe, in der sich Englisch befindet, als an alle anderen zusammen. <br><br>  Daher sollte ber√ºcksichtigt werden, dass ein Splitterschl√ºssel manchmal nat√ºrlich zu einer ungleichm√§√üigen Lastverteilung neigt. <br><br><h3>  Ausbalancieren </h3><br>  Wir kommen zum Sharding, wenn der Bedarf f√ºr uns gereift ist - unser MongoDB-Cluster knarrt, knirscht mit seinen Festplatten, Prozessor - mit allem, was wir k√∂nnen.  Wohin?  Nirgendwo, und wir mischen heldenhaft die Fersen der Sammlungen.  Wir scherben, starten und stellen pl√∂tzlich fest, dass das <strong>Balancieren nicht kostenlos ist</strong> . <br><br>  Das Balancieren durchl√§uft mehrere Phasen.  Der Balancer w√§hlt Brocken und Scherben aus, von wo und wohin er transferiert.  Die weitere Arbeit erfolgt in zwei Phasen: Zuerst werden <strong>Dokumente</strong> von der Quelle zum Ziel <strong>kopiert</strong> und dann <strong>werden kopierte</strong> Dokumente <strong>gel√∂scht</strong> . <br><br>  Unsere Scherbe ist √ºberladen, sie enth√§lt alle Sammlungen, aber der erste Teil der Operation ist f√ºr ihn einfach.  Aber das zweite - das Entfernen - ist ziemlich unangenehm, weil es eine Scherbe auf die Schulterbl√§tter legt und bereits unter Last leidet. <br><br>  Das Problem wird durch die Tatsache versch√§rft, dass, wenn wir viele Chunks, zum Beispiel Tausende, ausgleichen, mit den Standardeinstellungen alle diese Chunks zuerst kopiert werden und dann ein Entferner hereinkommt und beginnt, sie in gro√üen Mengen zu l√∂schen.  Ab diesem Zeitpunkt ist der Vorgang nicht mehr betroffen und Sie m√ºssen nur noch traurig beobachten, was passiert. <br><br>  Wenn Sie sich einem √ºberlasteten Cluster n√§hern, m√ºssen Sie daher planen, da das <strong>Ausgleichen Zeit ben√∂tigt.</strong>  Es ist ratsam, diese Zeit nicht zur Hauptsendezeit, sondern in Zeiten geringer Last zu nehmen.  Balancer - ein nicht angeschlossenes Ersatzteil.  Sie k√∂nnen sich dem prim√§ren Ausgleich im manuellen Modus n√§hern, den Ausgleich in der Hauptsendezeit ausschalten und ihn einschalten, wenn die Last abgenommen hat, um sich mehr zu erlauben. <br><br>  Wenn Sie mit den Funktionen der Cloud weiterhin vertikal skalieren k√∂nnen, sollten Sie die Shard-Quelle im Voraus verbessern, um all diese Spezialeffekte geringf√ºgig zu reduzieren. <br><br>  <b>Scherben m√ºssen sorgf√§ltig vorbereitet werden.</b> <br><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HighLoad ++ Siberia 2019</a> wird am 24. und 25. Juni in Nowosibirsk erscheinen.  HighLoad ++ Sibirien bietet Entwicklern aus Sibirien die M√∂glichkeit, Berichte anzuh√∂ren, √ºber hochgeladene Themen zu sprechen und in die Umgebung einzutauchen, in der "jeder seine eigenen hat", ohne √ºber dreitausend Kilometer nach Moskau oder St. Petersburg zu fliegen.  Von den 80 Antr√§gen genehmigte das Programmkomitee 25, und wir berichten √ºber alle anderen √Ñnderungen im Programm, Ank√ºndigungen von Berichten und andere Neuigkeiten in unserer Mailingliste.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Abonnieren Sie</a> , um auf dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Laufenden</a> zu bleiben. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de454748/">https://habr.com/ru/post/de454748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de454736/index.html">Unterst√ºtzung von Visual Studio 2019 in PVS-Studio</a></li>
<li><a href="../de454738/index.html">Visual Studio 2019-Unterst√ºtzung in PVS-Studio</a></li>
<li><a href="../de454740/index.html">Mai 2019 Joomla Digest</a></li>
<li><a href="../de454742/index.html">Mindestens ein Vim-Trick, von dem Sie nichts wussten</a></li>
<li><a href="../de454744/index.html">√úbersicht √ºber Java Track Reports von der RigaDevDays Konferenz</a></li>
<li><a href="../de454750/index.html">Schnelle Benutzeroberfl√§che - Galoppieren durch Europa</a></li>
<li><a href="../de454754/index.html">Wann lohnt es sich, die Hypothese einer nicht geringeren Wirksamkeit zu √ºberpr√ºfen?</a></li>
<li><a href="../de454756/index.html">√úberpr√ºfung der Effektivit√§t der Website und der Werbeeinstellungen sowie der Kosten f√ºr die Kundengewinnung des Gro√ühandelsunternehmens</a></li>
<li><a href="../de454758/index.html">Billig und fr√∂hlich mit Windows Defender umgehen: Mimikatz verschleiern</a></li>
<li><a href="../de454760/index.html">Intel Optane Memory M15 - schneller als M10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>