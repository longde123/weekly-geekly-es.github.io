<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤™ ğŸ‘¸ğŸ¼ ğŸŒ¡ï¸ IsomÃ©trie, z-indices dans les jeux mobiles et leur optimisation ğŸ•• ğŸ’” âœŠğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! RÃ©cemment, nous avons sorti notre jeu , que nous avons prÃ©parÃ© depuis longtemps et au cours duquel un nombre considÃ©rable de sujets int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>IsomÃ©trie, z-indices dans les jeux mobiles et leur optimisation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415051/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/lk/eu/4v/lkeu4vc8aqhbtyddxs_2cckvcbq.gif"></div><br>  Bonjour, Habr!  RÃ©cemment, nous avons sorti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre jeu</a> , que nous avons prÃ©parÃ© depuis longtemps et au cours duquel un nombre considÃ©rable de sujets intÃ©ressants se sont accumulÃ©s qui mÃ©ritent d'Ãªtre partagÃ©s avec la communautÃ©.  Le sujet sera intÃ©ressant non seulement pour iOS et d'autres dÃ©veloppeurs mobiles, mais aussi pour tous ceux qui sont intÃ©ressÃ©s par la faÃ§on dont toutes sortes de choses graphiques fonctionnent sous le capot, ainsi que tous les fans de stratÃ©gies 2D, que je suis moi-mÃªme depuis la troisiÃ¨me dÃ©cennie. <br><a name="habracut"></a><br>  Aujourd'hui, nous allons parler des nuances d'un sujet aussi important que les index z sur une surface isomÃ©trique (oui, tout n'est pas aussi simple qu'il y paraÃ®t Ã  certains sages).  Dans le monde 3D, nous avons, curieusement, trois coordonnÃ©es - x, y, z - qui dÃ©terminent complÃ¨tement la position de l'objet dans l'espace.  La tÃ¢che de dÃ©terminer la proximitÃ© des objets avec la camÃ©ra est Ã©galement lÃ , mais repose entiÃ¨rement sur les Ã©paules d'OpenGL.  Le dÃ©veloppeur ne fonctionne qu'avec des paramÃ¨tres de haut niveau tels que la profondeur du tampon z, qui affectent les performances, mais sinon vous pouvez faire confiance Ã  OpenGL comme une boÃ®te noire - il a suffisamment d'informations. <br><br>  Une situation complÃ¨tement diffÃ©rente est observÃ©e dans notre monde Â«pseudo-3DÂ» - chaque objet n'a que (x, y) - coordonnÃ©es et taille du sprite.  La premiÃ¨re tÃ¢che d'un programmeur lors de l'Ã©criture d'un moteur est de dÃ©terminer quels objets doivent se chevaucher devant notre Â«camÃ©raÂ» virtuelle. <br><br><h3>  Synopsis </h3><br>  Les coordonnÃ©es SpriteKit (oÃ¹ (0; 0) est le centre du Â«mondeÂ» et Y monte) dans ce cas, cela ne nous intÃ©resse pas du tout, car  ils ne signifient rien dans notre Â«mondeÂ» isomÃ©trique avec vous, alors faisons une rÃ©servation - nous avons un champ en forme de diamant comme Age of Empires. <br><br><img src="https://habrastorage.org/webt/wr/5e/vv/wr5evvkc_hek_pscypdlvngc_rc.jpeg"><br><br>  Une tuile avec les coordonnÃ©es (0; 0) est situÃ©e dans le coin gauche du losange, l'abscisse X augmente "en bas" et "Ã  droite", c'est-Ã -dire  se rapproche de l'observateur, l'ordonnÃ©e Y augmente "vers le haut" et "vers la droite", c'est-Ã -dire  diminue Ã  mesure que vous vous approchez de l'observateur. <br><br>  De plus, les rails doivent Ãªtre Â«sousÂ» le train, la fumÃ©e de la cheminÃ©e doit Ãªtre Â«au-dessusÂ» du train.  Mais nous ne nous occuperons pas maintenant des Â«couches de l'ÃªtreÂ» - Ã©videmment, rien ne nous empÃªche de faire autant de Â«tranchesÂ» isomÃ©triques que vous le souhaitez, en travaillant selon les mÃªmes rÃ¨gles.  Nous supposons que dans une tuile, il y a toujours un objet - pour plus de clartÃ©, plus n'est pas nÃ©cessaire. <br><br><img src="https://habrastorage.org/webt/qi/2u/cs/qi2ucse8xajdr-r3ttwf1t9smt4.jpeg"><br><br>  ConsidÃ©rez les deux trains ci-dessus.  De toute Ã©vidence, du point de vue de l'observateur, les wagons doivent Ãªtre situÃ©s Â«en dessousÂ» du train, c'est-Ã -dire  leur indice z devrait Ãªtre infÃ©rieur.  En mÃªme temps, le train Â«supÃ©rieurÂ» devrait Â«se chevaucherÂ» avec le voisin, Ãªtre Â«plus loinÂ».  Pouvons-nous, n'ayant que les coordonnÃ©es (x; y), construire une carte des z-indices pour chaque tuile? <br><br>  Ã‰videmment, oui, en utilisant la formule suivante (pseudocode a la swift): <br><br><pre><code class="hljs matlab">zIndex = pos.x * field.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>.width - pos.y</code> </pre> <br>  Ainsi, nous garantissons qu'Ã  mesure que les ordonnÃ©es grandissent, les objets s'Ã©loignent (-pos.y), ainsi qu'avec la croissance des abscisses, l'approche des objets (pos.x) et, surtout, tout objet qui a une abscisse de, disons, 44, est Ã©videmment "plus proche" Â»Que tout objet ayant une abscisse 43. Pour ajouter iciÂ« stratification Â»(rappelez-vous, les rails sous le train, fumÃ©e au-dessus de la cheminÃ©e), il suffit d'ajouter uneÂ« hauteur Â»constante de la couche: <br><br><pre> <code class="hljs matlab">zIndex = layerZIndex + pos.x * field.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>.width - pos.y</code> </pre> <br>  VoilÃ , vous pouvez terminer l'article et vous fÃ©liciter pour les bases de la stÃ©rÃ©omÃ©trie apprises en 10e annÃ©e et dÃ©marrer la logique du jeu.  Non?  Si seulement!  J'Ã©crirais sur les choses Ã©videntes!  (Eh bien, comme c'est Ã©vident, quelques jours sont Ã©crasÃ©s et cela) <br><br>  Nous passons juste Ã  la partie amusante, passant Ã  autre chose. <br><br><h3>  Lutte pour la performance </h3><br>  Tout le monde, au moins une fois, a exÃ©cutÃ© un projet de test pour SpriteKit (ou une noix de coco, ou tout autre moteur), a vu des nombres magiques - fps et nÅ“uds. <br><br><img src="https://habrastorage.org/webt/ej/ly/fg/ejlyfgpeamuachzwte2aucpuxhy.jpeg"><br><br>  Ã‰videmment, fps est le nombre d'images par seconde, nÅ“uds est le nombre de nÅ“uds, principalement des sprites.  Mais dans la pratique, la plupart de tous les fps sont dÃ©finis non pas par le nombre de nÅ“uds, mais par un autre paramÃ¨tre, qui par dÃ©faut n'est pas affichÃ©, mais qui peut Ã©galement Ãªtre affichÃ© avec une seule ligne - le nombre de tirages redessinÃ©s. <br><br><img src="https://habrastorage.org/webt/or/w6/mq/orw6mqdp2bgxt5bfybnz1evzt5y.jpeg"><br><br>  Dans la mÃªme scÃ¨ne, comme vous le voyez maintenant, le nombre de nÅ“uds est d'environ 6000, et le nombre de rendus est d'environ 120. C'est au zoom minimum (la camÃ©ra est aussi proche de la surface que possible), 1: 1. <br><br>  Maintenant, dÃ©plaÃ§ons la camÃ©ra Ã  la distance maximale (dans notre jeu, c'est 2,5: 1) <br><br><img src="https://habrastorage.org/webt/g1/78/wz/g178wz_a1q85pqtrtyzvffswndo.jpeg"><br><br>  Nous avons changÃ© l'Ã©chelle de seulement 2,5 fois (dans l'exemple, loin de tous les objets sont dessinÃ©s), et le nombre de tirages a augmentÃ© de 5-6 fois avec le nombre de nÅ“uds inchangÃ©! <br><br>  Bien sÃ»r, le nombre de rendus affecte fps incommensurablement plus que le nombre abstrait de nÅ“uds.  SpriteKit ne dessine tout simplement pas les nÅ“uds qui ne tombent pas dans la fenÃªtre (dans la camÃ©ra).  La seule exception que j'ai trouvÃ©e jusqu'Ã  prÃ©sent concerne les Ã©metteurs de particules, qui sont toujours dessinÃ©s, qu'ils soient visibles ou non. <br><br>  Parlons maintenant de ce que signifie ce dessin "dessin".  La carte vidÃ©o possÃ¨de tous les nÅ“uds Â«couchesÂ», guidÃ©s par leurs z-index.  Et cela passe en revue toute l'image encore et encore, du plus bas au plus haut.  Le nombre de ces cycles de rendu est nul. <br><br>  Vous comprenez maintenant que si vous dessinez chaque petit objet (et nous avons une grande carte, environ 6000 x 3000) avec son propre index z, cela ruinera les performances de n'importe quel tÃ©lÃ©phone. <br><br>  Les problÃ¨mes sont mieux visibles sur les anciens 5 et 5, mais la prÃ©sence de l'iPhone 10 ne garantit rien - avec la mauvaise approche, vous pouvez abandonner tout matÃ©riel puissant.  Dans notre jeu, l'une des pierres angulaires Ã©tait une extrÃªme clartÃ©.  Au zoom le plus proche, les sprites en tÃªte-Ã -tÃªte correspondent aux pixels rÃ©tin.  Je dois dire que dans la plupart des jeux mobiles, la rÃ©solution est de l'ordre de grandeur infÃ©rieure, donc les exigences ne sont pas si Ã©normes, mais nous l'avons fait qualitativement, comme pour nous-mÃªmes ... <br><br>  Il faut donc aller aux trucs. <br><br><ul><li>  Tous les objets avec lesquels le joueur n'interagit pas et qui sont au mÃªme niveau dans la coordonnÃ©e X, peuvent gÃ©nÃ©ralement Ãªtre fusionnÃ©s en un seul sprite.  Pour une carte vidÃ©o, il est beaucoup plus facile de dessiner un grand sprite que 10 petits.  Par consÃ©quent, les voies forestiÃ¨res entre les routes sont des sprites intÃ©graux composÃ©s de plusieurs arbres.  Et les arbres qui ne chevauchent pas les chemins et les autres arbres sont gÃ©nÃ©ralement cousus dans la carte.  En alpha, au fait, il y avait pas mal de bugs lorsque le chÃªne centenaire poussait juste sous les rails d'un train ou sous un feu de circulation, alors testez soigneusement votre jeu afin de ne pas amuser les utilisateurs. <br></li><li>  Les objets qui ont un z-index sont dessinÃ©s dans l'ordre dans lequel ils apparaissent sur la carte vidÃ©o.  C'est-Ã -dire  en ajoutant des objets Â«distantsÂ» avant ceux Â«prochesÂ», ils tomberont correctement, mais n'augmenteront pas le nombre de rendus de carte graphique. <br></li></ul><br>  Tout cela vous permet de rÃ©duire le nombre de tirages Ã  certains moments, en fixant des fps mÃªme sur un ancien iPhone.  J'ai dÃ» leur limiter sÃ©vÃ¨rement certains effets, mais Apple n'a pas publiÃ© de mises Ã  jour pour eux depuis un an maintenant - un pÃ©chÃ© se plaindra! <br><br><h3>  Ã‰lÃ©vation </h3><br>  Eh bien, tout, le moteur est prÃªt, pouvez-vous dÃ©jÃ  dÃ©marrer quelque chose d'intÃ©ressant?  Quelqu'un peut, mais c'est trop tÃ´t pour nous.  AprÃ¨s tout, le train devrait magnifiquement quitter le tunnel, et ici, tout n'est pas aussi simple qu'il y paraÃ®t. <br><br><img src="https://habrastorage.org/webt/sp/cb/nm/spcbnmehem8_bu1ogy0fijlt_ho.jpeg"><br><br>  Le train doit Ãªtre situÃ© Â«plus hautÂ» que le mur Â«Ã©loignÃ©Â» du tunnel et Â«plus basÂ» que le toit du tunnel et les montagnes qui le suivent.  C'est beau, aprÃ¨s tout, quand la carte est Ã  plusieurs niveaux, avec des changements d'altitude - encore une fois, nous ne faisons pas de bÃªtises sans Ã¢me, mais ce que nous aimons nous-mÃªmes! <br><br>  Mais revenons aux dÃ©tails - pour cela, la carte a Ã©tÃ© Â«coupÃ©eÂ» comme suit. <br><br><img src="https://habrastorage.org/webt/wj/vc/cq/wjvccqdd_chsxclx127yy127ffo.png"><br><br>  La paroi intÃ©rieure du tunnel et tout le reste Ã  gauche est infÃ©rieure et <br><br><img src="https://habrastorage.org/webt/7e/iz/4v/7eiz4vshagonj-yf5of3ndzsr6m.png"><br><br>  le haut du tunnel avec les montagnes dans lesquelles il se jette.  Ici, aucune gÃ©nÃ©ration procÃ©durale d'indices z n'aidera, seulement un code dur biÃ©lorusse sÃ©vÃ¨re. <br><br>  L'habrayuzer attentif a remarquÃ© dans la capture d'Ã©cran du jeu que prÃ¨s des tunnels, les arbres Ã©taient soigneusement Â«tondusÂ», exposant le sable de la plage immaculÃ©e.  Cette faille apparemment vient de l'impossibilitÃ© fondamentale de rÃ©aliser de telles plantations d'arbres en 2D.  Le train, sortant du tunnel, doit Ãªtre dÃ©libÃ©rÃ©ment Â«au-dessusÂ» des arbres qu'il chevauche, en les recouvrant de lui-mÃªme.  Mais ces mÃªmes arbres devraient chevaucher le toit du tunnel, sous lequel le train devrait appeler!  Et le toit devrait Ãªtre plus haut que le train, et donc dans un cercle, nous avons une contradiction logique ... <br><br>  Pour une raison similaire, en raison de l'imperfection du moteur graphique, dans les anciens jeux comme Duke Nukem et Doom2, il n'y a pas de grandes diffÃ©rences dans les hauteurs et les planchers des bÃ¢timents. <br><br>  C'est pourquoi les arbres ne poussent pas prÃ¨s des tunnels. <br><br>  J'espÃ¨re que c'Ã©tait intÃ©ressant, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jouet en direct ici (gratuit Ã  jouer)</a> , le prochain article de la sÃ©rie sera consacrÃ© Ã  une belle eau 2D rÃ©aliste, ne le manquez pas! <br><br>  PS Au fait, une vidÃ©o pour attirer l'attention peut Ãªtre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">visionnÃ©e sur youtube</a> en qualitÃ© normale. <br><br>  PPS Le jeu n'est pour l'instant disponible que dans la CEI, au Canada et en Irlande, si quelqu'un veut regarder depuis d'autres pays, envoyez un e-mail personnel avec appleId - je l'ajouterai Ã  TestFlight </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415051/">https://habr.com/ru/post/fr415051/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436938/index.html">Guix es el sistema operativo mÃ¡s avanzado.</a></li>
<li><a href="../fr415043/index.html">Un robot volant change de forme dans l'air</a></li>
<li><a href="../fr415045/index.html">La politique de licence d'Oracle pousse l'analyse sur Hadoop</a></li>
<li><a href="../fr415047/index.html">Ã‰vÃ©nements numÃ©riques Ã  Moscou du 25 juin au 1er juillet</a></li>
<li><a href="../fr415049/index.html">CrÃ©ation de commandes de gestion dans Django</a></li>
<li><a href="../fr415053/index.html">Pourquoi les processeurs Skylake fonctionnent parfois 2 fois plus lentement</a></li>
<li><a href="../fr415055/index.html">Le condensÃ© de matiÃ¨res fraÃ®ches du monde du front-end de la derniÃ¨re semaine n Â° 320 (18-24 juin 2018)</a></li>
<li><a href="../fr415057/index.html">PHP Digest n Â° 133 (10-24 juin 2018)</a></li>
<li><a href="../fr415059/index.html">Secrets de la cuisine JavaScript: Ã©pices</a></li>
<li><a href="../fr415061/index.html">Du frontend au backend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>