<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèø üâê üë©‚Äçüëß Pinterest Sharding: como escalamos nosso parque MySQL üçô üêó üê≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sauda√ß√£o, Khabrovites! Parab√©ns a todos no dia do programador e compartilhem a tradu√ß√£o do artigo, que foi especialmente preparado para os alunos do c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pinterest Sharding: como escalamos nosso parque MySQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/467389/">  <i>Sauda√ß√£o, Khabrovites!</i>  <i>Parab√©ns a todos no dia do programador e compartilhem a tradu√ß√£o do artigo, que foi especialmente preparado para os alunos do curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"High Load Architect"</a> .</i> <br><br><img src="https://habrastorage.org/webt/3o/s-/k6/3os-k6l2f122mbs6d1lufcif6ke.png"><br><br>  <b><i>"Fragmento.</i></b>  <b><i>Ou n√£o caco.</i></b>  <b><i>Sem tentar. "</i></b> <b><i><br></i></b>  <b><i>- Yoda</i></b> <br><br>  Hoje vamos mergulhar na separa√ß√£o de dados entre v√°rios servidores MySQL.  Conclu√≠mos o sharding no in√≠cio de 2012, e esse sistema ainda √© usado para armazenar nossos dados b√°sicos. <a name="habracut"></a><br><br>  Antes de discutirmos como compartilhar dados, vamos conhec√™-los melhor.  Prepare uma luz agrad√°vel, pegue morangos no chocolate, lembre-se de cita√ß√µes de Star Trek ... <br><br>  O Pinterest √© um mecanismo de pesquisa para tudo o que lhe interessa.  Em termos de dados, o Pinterest √© o maior gr√°fico de interesses humanos em todo o mundo.  Ele cont√©m mais de 50 bilh√µes de pinos que foram salvos pelos usu√°rios em mais de um bilh√£o de placas.  As pessoas mant√™m alguns alfinetes para si e, como outros alfinetes, assinam outros alfinetes, placas e interesses, visualizam o feed dom√©stico de todos os alfinetes, placas e interesses aos quais est√£o inscritos.  √ìtimo!  Agora vamos torn√°-lo escal√°vel! <br><br><h3>  Crescimento doloroso </h3><br>  Em 2011, come√ßamos a ganhar impulso.  Segundo algumas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estimativas</a> , crescemos mais r√°pido do que qualquer startup conhecida na √©poca.  Por volta de setembro de 2011, todos os componentes de nossa infraestrutura foram sobrecarregados.  T√≠nhamos v√°rias tecnologias NoSQL √† nossa disposi√ß√£o e todas falharam catastroficamente.  Tamb√©m t√≠nhamos muitos escravos do MySQL, que costum√°vamos ler, o que causava muitos erros extraordin√°rios, principalmente quando o cache era feito.  N√≥s reconstru√≠mos todo o nosso modelo de armazenamento.  Para trabalhar com efici√™ncia, abordamos cuidadosamente o desenvolvimento de requisitos. <br><br><h3>  Exig√™ncias </h3><br><ul><li>  Todo o sistema deve ser muito est√°vel, f√°cil de usar e dimensionar do tamanho de uma caixa pequena ao tamanho da lua √† medida que o local cresce. </li><li>  Todo o conte√∫do gerado pelo pinner deve estar dispon√≠vel no site a qualquer momento. </li><li>  O sistema deve suportar a solicita√ß√£o de N pinos na placa em uma ordem determin√≠stica (por exemplo, na ordem inversa do hor√°rio de cria√ß√£o ou na ordem especificada pelo usu√°rio).  O mesmo vale para pinners, pinos, etc. </li><li> Para simplificar, voc√™ deve se esfor√ßar para atualizar de todas as maneiras poss√≠veis.  Para obter a consist√™ncia necess√°ria, ser√£o necess√°rios brinquedos adicionais, como um di√°rio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transa√ß√µes</a> distribu√≠das.  √â divertido e (n√£o muito) f√°cil! </li></ul><br><h3>  Filosofia da Arquitetura e Notas </h3><br>  Como queremos que esses dados abranjam v√°rios bancos de dados, n√£o podemos usar apenas uma jun√ß√£o, chaves estrangeiras e √≠ndices para coletar todos os dados, embora possam ser usados ‚Äã‚Äãpara subconsultas que n√£o abrangem o banco de dados. <br><br>  Tamb√©m precis√°vamos manter o balanceamento de carga nos dados.  Decidimos que a movimenta√ß√£o de dados, elemento por elemento, tornaria o sistema desnecessariamente complexo e causaria muitos erros.  Se precis√°ssemos mover dados, era melhor mover o n√≥ virtual inteiro para outro n√≥ f√≠sico. <br><br>  Para que nossa implementa√ß√£o entre rapidamente em circula√ß√£o, precis√°vamos da solu√ß√£o mais simples e conveniente e de n√≥s muito est√°veis ‚Äã‚Äãem nossa plataforma de dados distribu√≠dos. <br>  Todos os dados tiveram que ser replicados na m√°quina escrava para criar um backup, com alta disponibilidade e despejo no S3 para o MapReduce.  Interagimos com o mestre apenas na produ√ß√£o.  Na produ√ß√£o, voc√™ n√£o desejar√° escrever ou ler em escravo.  Escravo lag, e isso causa bugs estranhos.  Se o sharding for feito, n√£o h√° sentido em interagir com um escravo na produ√ß√£o. <br><br>  Finalmente, precisamos de uma boa maneira de gerar identificadores exclusivos universais (UUIDs) para todos os nossos objetos. <br><br><h3>  Como fizemos sharding </h3><br>  O que √≠amos criar, tinha que atender aos requisitos, trabalhar de forma est√°vel, em geral, ser vi√°vel e sustent√°vel.  √â por isso que escolhemos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tecnologia</a> MySQL j√° bastante madura como a tecnologia subjacente.  √â intencionalmente cauteloso com as novas tecnologias para o dimensionamento autom√°tico do MongoDB, Cassandra e Membase, porque elas estavam longe o suficiente da maturidade (e, no nosso caso, quebraram de maneira impressionante!). <br><blockquote>  Al√©m disso: eu ainda recomendo startups para evitar coisas bizarras - tente usar o MySQL.  Confie em mim.  Eu posso provar isso com cicatrizes. </blockquote>  MySQL - a tecnologia √© comprovada, est√°vel e simples - ela funciona.  Al√©m de us√°-lo, ele √© popular em outras empresas com escalas ainda mais impressionantes.  O MySQL atende totalmente a nossa necessidade de otimizar consultas de dados, selecionar intervalos de dados espec√≠ficos e transa√ß√µes no n√≠vel de linha.  De fato, em seu arsenal, h√° muito mais oportunidades, mas todos n√≥s n√£o precisamos delas.  Mas o MySQL √© uma solu√ß√£o "in a box", ent√£o os dados tiveram que ser fragmentados.  Aqui est√° a nossa solu√ß√£o: <br>  Come√ßamos com oito servidores EC2, uma inst√¢ncia do MySQL em cada: <br><br><img src="https://habrastorage.org/webt/e0/d0/o0/e0d0o0fijurp6mabuvbwecacnfi.png"><br><br>  Cada servidor mestre do MySQL √© replicado para o host de backup no caso de uma falha prim√°ria.  Nossos servidores de produ√ß√£o apenas l√™em ou gravam no master.  Eu recomendo que voc√™ fa√ßa tamb√©m.  Isso simplifica e evita erros com atrasos na replica√ß√£o. <br><br>  Cada entidade do MySQL possui muitos bancos de dados: <br><br><img src="https://habrastorage.org/webt/zf/vl/sx/zfvlsxbhhh6uict7kf9ly6f2y9m.png"><br><br>  Observe que cada banco de dados √© nomeado exclusivamente: db00000, db00001 a dbNNNNN.  Cada banco de dados √© um fragmento de nossos dados.  Tomamos uma decis√£o arquitetural, com base na qual apenas parte dos dados cai no fragmento e nunca vai al√©m desse fragmento.  No entanto, voc√™ pode obter mais capacidade movendo shards para outras m√°quinas (falaremos sobre isso mais adiante). <br><br>  Trabalhamos com uma tabela de configura√ß√£o que indica quais m√°quinas possuem shards: <br><br><pre><code class="bash hljs">[{‚Äúrange‚Äù: (0,511), ‚Äúmaster‚Äù: ‚ÄúMySQL001A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL001B‚Äù}, {‚Äúrange‚Äù: (512, 1023), ‚Äúmaster‚Äù: ‚ÄúMySQL002A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL002B‚Äù}, ... {‚Äúrange‚Äù: (3584, 4095), ‚Äúmaster‚Äù: ‚ÄúMySQL008A‚Äù, ‚Äúslave‚Äù: ‚ÄúMySQL008B‚Äù}]</code> </pre> <br>  Essa configura√ß√£o muda apenas quando precisamos mover shards ou substituir o host.  Se o <code>master</code> morre, podemos usar o <code>slave</code> existente e depois pegar um novo.  A configura√ß√£o est√° localizada no <a href="">ZooKeeper</a> e, quando atualizada, √© enviada para servi√ßos que atendem ao shard do MySQL. <br><br>  Cada shard possui o mesmo conjunto de tabelas: <code>pins</code> , <code>boards</code> , <code>users_has_pins</code> , <code>users_likes_pins</code> , <code>pin_liked_by_user</code> etc.  Vou falar sobre isso um pouco mais tarde. <br><br>  Como distribu√≠mos dados para esses fragmentos? <br><br>  Criamos um ID de 64 bits que cont√©m o ID do fragmento, o tipo de dados contido nele e o local em que esses dados est√£o na tabela (ID local).  O ID do shard consiste em 16 bits, o ID do tipo √© 10 bits e o ID local √© 36 bits.  Os matem√°ticos avan√ßados perceber√£o que existem apenas 62 bits.  Minha experi√™ncia anterior como desenvolvedor de compiladores e placas de circuito me ensinou que os bits de backup valem seu peso em ouro.  Portanto, temos dois desses bits (definidos como zero). <br><br><pre> <code class="bash hljs">ID = (shard ID &lt;&lt; 46) | (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> ID &lt;&lt; 36) | (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ID&lt;&lt;0)</code> </pre> <br>  Vamos pegar este pino: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.pinterest.com/pin/241294492511762325/</a> , vamos analisar seu ID 241294492511762325: <br><br><pre> <code class="bash hljs">Shard ID = (241294492511762325 &gt;&gt; 46) &amp; 0xFFFF = 3429 Type ID = (241294492511762325 &gt;&gt; 36) &amp; 0x3FF = 1 Local ID = (241294492511762325 &gt;&gt; 0) &amp; 0xFFFFFFFFF = 7075733</code> </pre> <br>  Assim, o objeto pin vive no fragmento 3429.  Seu tipo √© "1" (ou seja, "Pino") e est√° na linha 7075733 na tabela de pinos.  Por exemplo, vamos imaginar que esse fragmento est√° no MySQL012A.  Podemos chegar a ele da seguinte maneira: <br><br><pre> <code class="bash hljs">conn = MySQLdb.connect(host=‚ÄùMySQL012A‚Äù) conn.execute(‚ÄúSELECT data FROM db03429.pins <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> local_id=7075733‚Äù)</code> </pre> <br><br>  Existem dois tipos de dados: objetos e mapeamentos.  Os objetos cont√™m partes, como dados de pinos. <br><br><h4>  Tabelas de Objetos </h4><br>  As tabelas de objetos, como Pins, usu√°rios, quadros e coment√°rios, t√™m um ID (ID local, com uma chave prim√°ria que aumenta automaticamente) e um blob que cont√©m JSON com todos os dados do objeto. <br><br><pre> <code class="bash hljs">CREATE TABLE pins ( local_id INT PRIMARY KEY AUTO_INCREMENT, data TEXT, ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ) ENGINE=InnoDB;</code> </pre> <br>  Por exemplo, os objetos pin s√£o assim: <br><br><pre> <code class="bash hljs">{‚Äúdetails‚Äù: ‚ÄúNew Star Wars character‚Äù, ‚Äúlink‚Äù: ‚Äúhttp://webpage.com/asdf‚Äù, ‚Äúuser_id‚Äù: 241294629943640797, ‚Äúboard_id‚Äù: 241294561224164665, ‚Ä¶}</code> </pre> <br>  Para criar um novo pino, coletamos todos os dados e criamos um blob JSON.  Em seguida, selecionamos o ID do shard (preferimos escolher o mesmo ID do shard no quadro em que ele est√° colocado, mas isso n√£o √© necess√°rio).  Para o tipo de pino 1. N√≥s nos conectamos a esse banco de dados e inserimos JSON na tabela de pinos.  O MySQL retornar√° um ID local aumentado automaticamente.  Agora temos um fragmento, um tipo e um novo ID local, para que possamos compilar um identificador completo de 64 bits! <br><br>  Para editar o pino, lemos-modificamos-escrevemos JSON usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transa√ß√£o MySQL</a> : <br><br><pre> <code class="bash hljs">&gt; BEGIN &gt; SELECT blob FROM db03429.pins WHERE local_id=7075733 FOR UPDATE [Modify the json blob] &gt; UPDATE db03429.pins SET blob=<span class="hljs-string"><span class="hljs-string">'&lt;modified blob&gt;'</span></span> WHERE local_id=7075733 &gt; COMMIT</code> </pre> <br>  Para remover um alfinete, voc√™ pode excluir sua linha no MySQL.  No entanto, √© melhor adicionar o campo <i>"ativo"</i> no JSON e configur√°-lo como <i>"falso"</i> , al√©m de filtrar os resultados no lado do cliente. <br><br><h4>  Tabelas de mapeamento </h4><br>  A tabela de mapeamento vincula um objeto a outro, por exemplo, uma placa com pinos.  A tabela MySQL para mapeamentos cont√©m tr√™s colunas: 64 bits para o ID "from", 64 bits para o ID "where" e o ID da sequ√™ncia.  Nesta tripla (de onde, onde, sequ√™ncia), existem chaves de √≠ndice e elas est√£o no fragmento do identificador "de". <br><br><pre> <code class="bash hljs">CREATE TABLE board_has_pins ( board_id INT, pin_id INT, sequence INT, INDEX(board_id, pin_id, sequence) ) ENGINE=InnoDB;</code> </pre> <br>  As tabelas de mapeamento s√£o unidirecionais, por exemplo, como a tabela <code>board_has_pins</code> .  Se voc√™ precisar da dire√ß√£o oposta, precisar√° de uma tabela separada <code>pin_owned_by_board</code> .  O ID da sequ√™ncia define a sequ√™ncia (nossos IDs n√£o podem ser comparados entre os shards, porque os novos IDs locais s√£o diferentes).  Normalmente, inserimos novos pinos em uma nova placa com um ID de sequ√™ncia igual ao tempo no unix (registro de data e hora unix).  Qualquer n√∫mero pode estar na sequ√™ncia, mas o tempo unix √© uma boa maneira de armazenar novos materiais sequencialmente, pois esse indicador aumenta monotonamente.  Voc√™ pode dar uma olhada nos dados na tabela de mapeamento: <br><br><pre> <code class="bash hljs">SELECT pin_id FROM board_has_pins WHERE board_id=241294561224164665 ORDER BY sequence LIMIT 50 OFFSET 150</code> </pre> <br>  Isso fornecer√° mais de 50 pinos_id, que voc√™ poder√° usar para procurar objetos de pinos. <br>  O que acabamos de fazer √© uma jun√ß√£o da camada de aplica√ß√£o (board_id -&gt; pin_id -&gt; pin objects).  Uma das propriedades surpreendentes das conex√µes no n√≠vel do aplicativo √© que voc√™ pode armazenar em cache a imagem separadamente do objeto.  Armazenamos pin_id no cache do objeto pin no cluster memcache, no entanto, salvamos board_id em pin_id no cluster redis.  Isso nos permite escolher a tecnologia certa que melhor se adequa ao objeto em cache. <br><br><h3>  Aumentar capacidade </h3><br>  Existem tr√™s maneiras principais de aumentar a capacidade em nosso sistema.  A maneira mais f√°cil de atualizar a m√°quina (para aumentar o espa√ßo, colocar discos r√≠gidos mais r√°pidos, mais RAM). <br>  A pr√≥xima maneira de aumentar a capacidade √© abrir novos intervalos.  Inicialmente, criamos um total de 4096 shards, apesar do ID do shard consistir em 16 bits (um total de 64k shards).  Novos objetos s√≥ podem ser criados nesses primeiros 4k shards.  Em algum momento, decidimos criar novos servidores MySQL com shards de 4096 a 8191 e come√ßamos a preench√™-los. <br><br>  A √∫ltima maneira de aumentar a capacidade √© transferir alguns fragmentos para novas m√°quinas.  Se queremos aumentar a capacidade do MySQL001A (com shards de 0 a 511), criamos um novo par mestre-mestre com os seguintes nomes m√°ximos poss√≠veis (por exemplo, MySQL009A e B) e iniciamos a replica√ß√£o do MySQL001A. <br><br><img src="https://habrastorage.org/webt/d2/uf/gd/d2ufgd1tttsa6tmxvpywfzgqugs.png"><br><br>  Assim que a replica√ß√£o √© conclu√≠da, alteramos nossa configura√ß√£o para que no MySQL001A existam apenas shards de 0 a 255 e no MySQL009A de 256 a 511. Agora, cada servidor deve processar apenas metade dos shards processados ‚Äã‚Äãanteriormente. <br><br><img src="https://habrastorage.org/webt/4f/cp/do/4fcpdo2g16molbdkkfbf8xvujbi.png"><br><br><h3>  Alguns recursos interessantes </h3><br>  Aqueles que j√° possu√≠am sistemas para gerar novos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UUIDs</a> entender√£o que neste sistema os obtemos sem nenhum custo!  Quando voc√™ cria um novo objeto e o insere na tabela de objetos, ele retorna um novo identificador local.  Esse ID local, combinado com o ID do shard e o ID do tipo, fornece um UUID. <br><br>  Aqueles de voc√™s que executaram ALTERs para adicionar mais colunas √†s tabelas MySQL sabem que eles podem trabalhar extremamente devagar e se tornar um grande problema.  Nossa abordagem n√£o requer nenhuma altera√ß√£o no n√≠vel do MySQL.  No Pinterest, provavelmente fizemos apenas um ALTER nos √∫ltimos tr√™s anos.  Para adicionar novos campos aos objetos, diga aos seus servi√ßos que existem v√°rios novos campos no esquema JSON.  Voc√™ pode alterar o valor padr√£o para que, ao desserializar o JSON de um objeto sem um novo campo, obtenha o valor padr√£o.  Se voc√™ precisar de uma tabela de mapeamento, crie uma nova tabela de mapeamento e comece a preench√™-la sempre que desejar.  E quando terminar, voc√™ pode enviar! <br><br><h3>  Fragmento de modifica√ß√£o </h3><br>  √â quase como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquadr√£o de mods</a> , apenas completamente diferente. <br><br>  Alguns objetos precisam ser encontrados sem um ID.  Por exemplo, se um usu√°rio efetuar login com uma conta do Facebook, precisamos mapear do ID do Facebook para o Pinterest.  Para n√≥s, os IDs do Facebook s√£o apenas bits, ent√£o os armazenamos em um sistema de fragmentos separado chamado mod shard. <br><br>  Outros exemplos incluem endere√ßos IP, nome de usu√°rio e endere√ßo de email. <br>  O Mod Shard √© muito semelhante ao sistema de sharding descrito na se√ß√£o anterior, com a √∫nica diferen√ßa: voc√™ pode procurar dados usando dados de entrada arbitr√°rios.  Essa entrada √© dividida em hash e modificada de acordo com o n√∫mero total de shards no sistema.  Como resultado, um fragmento ser√° obtido no qual os dados estar√£o ou j√° est√£o localizados.  Por exemplo: <br><br><pre> <code class="bash hljs">shard = md5(‚Äú1.2.3.4<span class="hljs-string"><span class="hljs-string">") % 4096</span></span></code> </pre> <br>  Nesse caso, o shard ser√° igual a 1524. Processamos o arquivo de configura√ß√£o correspondente ao ID do shard: <br><br><pre> <code class="bash hljs">[{‚Äúrange‚Äù: (0, 511), ‚Äúmaster‚Äù: ‚Äúmsdb001a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb001b‚Äù}, {‚Äúrange‚Äù: (512, 1023), ‚Äúmaster‚Äù: ‚Äúmsdb002a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb002b‚Äù}, {‚Äúrange‚Äù: (1024, 1535), ‚Äúmaster‚Äù: ‚Äúmsdb003a‚Äù, ‚Äúslave‚Äù: ‚Äúmsdb003b‚Äù}, ‚Ä¶]</code> </pre> <br>  Portanto, para encontrar dados no endere√ßo IP 1.2.3.4, precisamos fazer o seguinte: <br><br><pre> <code class="bash hljs">conn = MySQLdb.connect(host=‚Äùmsdb003a‚Äù) conn.execute(‚ÄúSELECT data FROM msdb001a.ip_data WHERE ip=<span class="hljs-string"><span class="hljs-string">'1.2.3.4'</span></span>‚Äù)</code> </pre> <br>  Voc√™ est√° perdendo algumas boas propriedades do ID do shard, como localidade espacial.  Voc√™ ter√° que come√ßar com todos os shards criados no in√≠cio e criar a chave voc√™ mesmo (ela n√£o ser√° gerada automaticamente).  √â sempre melhor representar objetos no seu sistema com IDs imut√°veis.  Portanto, voc√™ n√£o precisa atualizar muitos links quando, por exemplo, o usu√°rio altera seu "nome de usu√°rio". <br><br><h3>  √öltimos pensamentos </h3><br>  Este sistema produz produ√ß√£o no Pinterest h√° 3,5 anos e provavelmente permanecer√° l√° para sempre.  A implementa√ß√£o foi relativamente simples, mas foi dif√≠cil coloc√°-lo em opera√ß√£o e mover todos os dados de m√°quinas antigas.  Se voc√™ encontrar um problema ao criar um novo shard, considere criar um cluster de m√°quinas de processamento de dados em segundo plano (dica: use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pyres</a> ) para mover seus dados com scripts de bancos de dados antigos para o novo shard.  Eu garanto que alguns dados ser√£o perdidos, n√£o importa o quanto voc√™ tente (√© tudo gremlins, eu juro), ent√£o repita a transfer√™ncia de dados v√°rias vezes at√© que a quantidade de novas informa√ß√µes no fragmento se torne muito pequena ou n√£o seja. <br><br>  Todo esfor√ßo foi feito para esse sistema.  Mas n√£o fornece atomicidade, isolamento ou coer√™ncia de forma alguma.  Uau!  Isso parece ruim!  Mas n√£o se preocupe.  Certamente, voc√™ se sentir√° excelente sem eles.  Voc√™ sempre pode criar essas camadas com outros processos / sistemas, se necess√°rio, mas, por padr√£o e sem nenhum custo, j√° obt√©m bastante: capacidade de trabalho.  Confiabilidade alcan√ßada atrav√©s da simplicidade e at√© funciona r√°pido! <br><br>  Mas e a toler√¢ncia a falhas?  Criamos um servi√ßo para manuten√ß√£o de shards do MySQL, salvamos a tabela de configura√ß√£o de shard no ZooKeeper.  Quando o servidor mestre falha, aumentamos a m√°quina escrava e, em seguida, aumentamos a m√°quina que a substituir√° (sempre atualizada).  N√£o usamos o processamento autom√°tico de falhas at√© hoje. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt467389/">https://habr.com/ru/post/pt467389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt467377/index.html">Tr√™s em linha: os 10 principais relat√≥rios do Mobius 2019 Piter</a></li>
<li><a href="../pt467381/index.html">LEDs de v√°rios andares, luzes inteligentes e l√¢mpadas por 18 rublos</a></li>
<li><a href="../pt467383/index.html">‚ÄúO gerente precisa continuar codificando‚Äù: entrevista com Stephen Chin</a></li>
<li><a href="../pt467385/index.html">Uma sele√ß√£o de perguntas t√©cnicas psicol√≥gicas e at√≠picas em entrevistas com desenvolvedores Java</a></li>
<li><a href="../pt467387/index.html">Solu√ß√µes para trabalhar com feedback e experi√™ncia do cliente: de pequenos servi√ßos a plataformas pesadas</a></li>
<li><a href="../pt467391/index.html">Yandex apresenta RPKI</a></li>
<li><a href="../pt467393/index.html">NX Bootcamp come√ßa em outubro</a></li>
<li><a href="../pt467395/index.html">Habr Weekly # 18 / New Apple Gadgets, um smartphone totalmente modular, a vila de programadores na Bielorr√∫ssia, o fen√¥meno XY</a></li>
<li><a href="../pt467399/index.html">Voc√™ n√£o pode proibir: como implementar o conceito BYOD e n√£o prejudicar a seguran√ßa das informa√ß√µes</a></li>
<li><a href="../pt467401/index.html">Compara√ß√£o de Tesla Model S e Porsche Taycan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>