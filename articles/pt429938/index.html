<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé´ üîç ‚òÅÔ∏è Qual a velocidade de R para produtividade? üåö üî∫ üë©üèº‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Existe uma classe de tarefas t√£o popular na qual √© necess√°rio realizar uma an√°lise suficientemente profunda de todo o volume de cadeias de trabalho re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Qual a velocidade de R para produtividade?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429938/"><p>  Existe uma classe de tarefas t√£o popular na qual √© necess√°rio realizar uma an√°lise suficientemente profunda de todo o volume de cadeias de trabalho registradas por qualquer sistema de informa√ß√£o (SI).  Como um IP, pode haver um fluxo de documentos, uma central de atendimento, um rastreador de erros, um di√°rio eletr√¥nico, contabilidade de armaz√©m, etc. As nuances se manifestam em modelos de dados, APIs, volumes de dados e outros aspectos, mas os princ√≠pios para resolver esses problemas s√£o aproximadamente os mesmos.  E o rake em que voc√™ pode pisar tamb√©m √© muito semelhante. </p><br><p>  Para resolver essa classe de problemas, R se encaixa perfeitamente.  Mas, para n√£o encolher os ombros de maneira decepcionante, R pode ser bom, mas muito lento, √© importante prestar aten√ß√£o ao desempenho dos m√©todos de processamento de dados selecionados. </p><br><p>  √â uma continua√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publica√ß√µes anteriores</a> . <a name="habracut"></a></p><br><p> Geralmente, uma abordagem superficial da "testa" n√£o √© a mais eficaz.  99% das tarefas associadas √† an√°lise e processamento de dados come√ßam com a importa√ß√£o.  Neste breve ensaio, consideraremos os problemas que surgem no est√°gio b√°sico de importa√ß√£o de dados com dados no formato <code>json</code> , usando o exemplo de uma tarefa t√≠pica de an√°lise "profunda" dos dados de instala√ß√£o do Jira.  <code>json</code> suporta um modelo de objeto complexo, diferentemente do <code>csv</code> , portanto, analis√°-lo no caso de estruturas complexas pode se tornar muito dif√≠cil e demorado. </p><br><h1 id="postanovka-zadachi">  Declara√ß√£o do problema </h1><br><p>  Dado: </p><br><ul><li>  O jira √© implementado e usado no processo de desenvolvimento de software como um sistema de gerenciamento de tarefas e rastreador de erros. </li><li>  N√£o h√° acesso direto ao banco de dados jira, a intera√ß√£o √© via API REST (isolamento galv√¢nico). </li><li>  Os arquivos json a serem obtidos possuem uma estrutura de √°rvore muito complexa com tuplas aninhadas necess√°rias para fazer upload de todo o hist√≥rico de a√ß√µes.  O c√°lculo das m√©tricas requer um n√∫mero relativamente pequeno de par√¢metros espalhados por diferentes n√≠veis da hierarquia. </li></ul><br><p>  Um exemplo de jira json regular na figura. </p><br><p><img src="https://habrastorage.org/webt/g1/me/t7/g1met7plll0ltss2wzho4bxzbcs.png"></p><br><p>  √â necess√°rio: </p><br><ul><li>  Com base nos dados do jira, √© necess√°rio encontrar gargalos e pontos de um poss√≠vel aumento na efici√™ncia dos processos de desenvolvimento e melhorar a qualidade do produto resultante com base na an√°lise de todas as a√ß√µes registradas. </li></ul><br><h1 id="reshenie">  Solu√ß√£o </h1><br><p>  Teoricamente, existem v√°rios pacotes diferentes no R para carregar o json e convert√™-los em <code>data.frame</code> .  O pacote mais conveniente √© o <code>jsonlite</code> .  No entanto, a convers√£o direta da hierarquia json em <code>data.frame</code> dif√≠cil devido ao aninhamento em v√°rios n√≠veis e √† forte parametriza√ß√£o da estrutura de registros.  A jun√ß√£o de par√¢metros espec√≠ficos relacionados, por exemplo, ao hist√≥rico de a√ß√µes, pode exigir v√°rias extens√µes.  verifica√ß√µes e loops.  I.e.  o problema pode ser resolvido, mas para um arquivo json de 32 tarefas (inclui todos os artefatos e todo o hist√≥rico das tarefas), essa an√°lise n√£o linear usando jsonlite e tidyverse leva aproximadamente 10 segundos em um laptop com desempenho m√©dio. </p><br><p>  10 segundos por si s√≥ n√£o √© muito.  Mas exatamente at√© o momento em que n√£o h√° muitos desses arquivos.  A avalia√ß√£o em uma amostra analisando e carregando usando um m√©todo "direto" semelhante ~ 4000 arquivos (~ 4 GB) deu 8-9 horas de trabalho. </p><br><p>  Um n√∫mero t√£o grande de arquivos apareceu por um motivo.  Em primeiro lugar, jira tem limites de tempo para uma sess√£o REST, √© imposs√≠vel extrair tudo com uma viga.  Em segundo lugar, sendo incorporado ao circuito produtivo, √© esperado o upload di√°rio de dados em tarefas atualizadas.  Em terceiro lugar, e isso ser√° mencionado abaixo, a tarefa √© muito boa para o dimensionamento linear e voc√™ precisa pensar em paraleliza√ß√£o desde o primeiro passo. </p><br><p>  Mesmo 10 a 15 itera√ß√µes no est√°gio de an√°lise de dados, identificando o conjunto m√≠nimo necess√°rio de par√¢metros, detectando situa√ß√µes excepcionais ou err√¥neas e desenvolvendo algoritmos de p√≥s-processamento, geram custos na quantidade de 2-3 semanas (apenas o tempo de contagem). <br>  Naturalmente, esse "desempenho" n√£o √© adequado para an√°lises operacionais, integradas ao circuito produtivo, e √© muito ineficaz na fase inicial da an√°lise de dados e do desenvolvimento do prot√≥tipo. </p><br><p>  Ignorando todos os detalhes intermedi√°rios, volto-me imediatamente √† resposta.  Lembramos de Donald Knuth, arrega√ßamos as mangas e come√ßamos a microbenching todas as opera√ß√µes principais, cortando impiedosamente tudo o que √© poss√≠vel. </p><br><p>  A solu√ß√£o resultante √© reduzida para as 10 linhas a seguir (este √© um esqueleto falso, sem o kit para o corpo n√£o funcional subsequente): </p><br><pre> <code class="plaintext hljs">library(tidyverse) library(jsonlite) library(readtext) fnames &lt;- fs::dir_ls(here::here("input_data"), glob = "*.txt") ff &lt;- function(fname){ json_vec &lt;- readtext(fname, text_field = "texts", encoding = "UTF-8") %&gt;% .$text %&gt;% jqr::jq('[. | {issues: .issues}[] | .[]', '{id: .id, key: .key, created: .fields.created, type: .fields.issuetype.name, summary: .fields.summary, descr: .fields.description}]') jsonlite::fromJSON(json_vec, flatten = TRUE) } tictoc::tic("Loading with jqr-jsonlite single-threaded technique") issues_df &lt;- fnames %&gt;% purrr::map(ff) %&gt;% data.table::rbindlist(use.names = FALSE) tictoc::toc() system.time({fst::write_fst(issues_df, here::here("data", "issues.fst"))})</code> </pre> <br><p>  O que √© interessante aqui? </p><br><ol><li>  Para acelerar o processo de carregamento, √© bom usar pacotes especializados com perfil, como <code>readtext</code> . </li><li>  O uso do analisador de fluxo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>jq</code></a> permite converter todos os atributos necess√°rios em um idioma funcional, reduzi-lo ao n√≠vel do CPP e minimizar a manipula√ß√£o manual de listas ou listas aninhadas no <code>data.frame</code> . </li><li>  Um pacote de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>bench</code></a> muito promissor para marcas de micropigmenta√ß√£o apareceu.  Ele permite que voc√™ estude n√£o apenas o tempo de execu√ß√£o das opera√ß√µes, mas tamb√©m a manipula√ß√£o da mem√≥ria.  N√£o √© segredo que voc√™ pode perder muito ao copiar dados na mem√≥ria. </li><li>  Para grandes quantidades de dados e processamento simples, geralmente √© necess√°rio, na decis√£o final, abandonar o <code>tidyverse</code> e transferir as pe√ßas demoradas para <code>data.table</code> , em particular, as tabelas s√£o mescladas usando <code>data.table</code> .  E tamb√©m todas as transforma√ß√µes no est√°gio de p√≥s-processamento (inclu√≠das no ciclo atrav√©s da fun√ß√£o <code>ff</code> tamb√©m s√£o feitas usando ferramentas <code>data.table</code> com a abordagem de alterar dados por refer√™ncia ou pacotes constru√≠dos usando <code>Rcpp</code> , por exemplo, pacote a <code>anytime</code> para trabalhar com datas e horas. </li><li>  O pacote <code>fst</code> √© muito bom para despejar dados em um arquivo e depois l√™-lo.  Em particular, leva apenas uma fra√ß√£o de segundo para salvar todas as an√°lises de hist√≥rico do jira por 4 anos, e os dados s√£o salvos exatamente como os tipos de dados R, o que √© bom para a reutiliza√ß√£o subsequente. </li></ol><br><p>  Durante a solu√ß√£o, uma abordagem usando o pacote <code>rjson</code> foi <code>rjson</code> .  A <code>jsonlite::fromJSON</code> cerca de 2 vezes mais lenta que <code>rjson = rjson::fromJSON(json_vec)</code> , mas foi necess√°rio deix√°-lo, porque existem valores NULL nos dados e, no est√°gio de convers√£o de <code>NULL</code> para <code>NA</code> nas listas <code>rjson</code> por <code>rjson</code> , perdemos vantagem, e o c√≥digo fica mais pesado. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><ol><li>  Essa refatora√ß√£o levou a uma altera√ß√£o no tempo de processamento de todos os arquivos json no modo de thread √∫nico no mesmo laptop de 8 a 9 horas para 10 minutos. </li><li>  Adicionar paralelismo da tarefa usando o <code>foreach</code> praticamente n√£o sobrecarregou o c√≥digo (+ 5 linhas), mas reduziu o tempo de execu√ß√£o para 5 minutos. </li><li>  Transferir a solu√ß√£o para um servidor linux fraco (apenas 4 n√∫cleos), mas rodar em um SSD no modo multithread reduziu o tempo de execu√ß√£o para 40 segundos. </li><li>  A publica√ß√£o em um circuito produtivo (20 n√∫cleos, 3 GHz, SSD) reduziu o tempo de execu√ß√£o para 6-8 segundos, o que √© mais do que aceit√°vel para tarefas de an√°lise operacional. </li></ol><br><p>  No total, permanecendo na estrutura da plataforma R, uma refatora√ß√£o de c√≥digo simples conseguiu reduzir o tempo de execu√ß√£o de ~ 9 horas para ~ 9 segundos. </p><br><p>  As decis√µes sobre R podem ser bastante r√°pidas.  Se algo n√£o der certo para voc√™, tente analis√°-lo de um √¢ngulo diferente e usar novas t√©cnicas. </p><br><p>  Publica√ß√£o anterior - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúP√°ra-quedas anal√≠tico para gerente‚Äù</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429938/">https://habr.com/ru/post/pt429938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429922/index.html">Como transformar um projeto simples em uma constru√ß√£o de longo prazo ou cortar todos os itens desnecess√°rios</a></li>
<li><a href="../pt429928/index.html">Tudo o que voc√™ precisa saber sobre estresse e emo√ß√µes fortes</a></li>
<li><a href="../pt429930/index.html">Splunk Solu√ß√£o de problemas f√°cil de aplicativos</a></li>
<li><a href="../pt429934/index.html">O que tem ai?</a></li>
<li><a href="../pt429936/index.html">Devo esperar o Android no iOS da Parallels?</a></li>
<li><a href="../pt429940/index.html">Por que as plantas precisam de aprendizado de m√°quina</a></li>
<li><a href="../pt429942/index.html">Obter m√∫sica VK atrav√©s de uma API de terceiros</a></li>
<li><a href="../pt429946/index.html">Loucura e sucesso do c√≥digo do banco de dados Oracle</a></li>
<li><a href="../pt429948/index.html">Por que os gerentes de produto da fintech s√£o necess√°rios</a></li>
<li><a href="../pt429950/index.html">Como manter h√°bitos saud√°veis ‚Äã‚Äãde comunica√ß√£o de equipes remotas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>