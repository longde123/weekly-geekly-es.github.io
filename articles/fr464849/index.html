<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíª ü•ë üë©üèø‚Äçüé§ L'utilisation de R pour les t√¢ches utilitaires üï£ üîç üî¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un bon outil + la disponibilit√© des comp√©tences pour travailler avec lui, qui est obtenue gr√¢ce √† la pratique, vous permet de r√©soudre facilement et a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'utilisation de R pour les t√¢ches utilitaires</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464849/"><p>  Un bon outil + la disponibilit√© des comp√©tences pour travailler avec lui, qui est obtenue gr√¢ce √† la pratique, vous permet de r√©soudre facilement et avec √©l√©gance de nombreuses t√¢ches atypiques "similaires" diff√©rentes.  Voici quelques exemples similaires.  Je suis s√ªr que beaucoup peuvent √©tendre cette liste. </p><br><p>  Il s'agit d'une continuation des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publications pr√©c√©dentes</a> . <a name="habracut"></a></p><br><h1 id="analitika-po-logam-prilozheniy">  Analyse du journal des applications </h1><br><p>  La t√¢che consistant √† effectuer des calculs analytiques sur la base des journaux d'application est assez populaire.  Par exemple, effectuez une analyse des actions des utilisateurs et estimez des indicateurs de pr√©vision, ou testez des hypoth√®ses.  Vous pouvez suivre la version classique et augmenter la pile ELK ou similaire (r√©cemment, Splunk a abandonn√© les syst√®mes disponibles en Russie).  Mais vous pouvez r√©fl√©chir un peu et tout faire rapidement sur R. Rapidement dans tous les sens, √† la fois dans la mise en ≈ìuvre et dans le temps de traitement. </p><br><p>  Mais il existe un certain nombre de fonctionnalit√©s pour r√©soudre un probl√®me similaire: </p><br><ol><li> En r√®gle g√©n√©rale, les fichiers journaux sont √©crits au format <code>log4j</code> classique: horodatage, importance, type de sous-syst√®me, corps du message. </li><li>  L'horodatage peut contenir des √©v√©nements avec une r√©solution en millisecondes, qui doivent √™tre conserv√©s pour la pr√©cision des analyses ult√©rieures.  Les millisecondes peuvent √©crire sans se conformer √† ISO 8601. </li><li>  Le corps du message est une entit√© pratiquement non structur√©e.  Les d√©veloppeurs y √©crivent tout ce qu'ils jugent n√©cessaire, sans se limiter √† aucun format de pr√©sentation. </li><li>  Parfois, le corps du message est multiligne, par exemple, la sortie de la pile d'appels Java ou le package d'√©change intersyst√®mes xml.  Il est n√©cessaire de reconstruire des enregistrements multi-lignes en un seul (un marqueur d'horodatage est un signe du d√©but de l'enregistrement). </li><li>  Plusieurs atriutes peuvent √™tre externes au contenu et doivent √™tre obtenus d'une mani√®re diff√©rente, par exemple, l'id de l'objet peut √™tre encod√© dans le nom du fichier journal. </li><li>  Les journaux sous forme de fichiers peuvent √™tre de plusieurs m√©gaoctets ou centaines de gigaoctets. </li><li>  La t√¢che est tr√®s bien parall√®le. </li></ol><br><p>  En fait, la t√¢che peut √™tre divis√©e en 2 √©tapes: </p><br><ul><li>  pr√©traitement des donn√©es brutes; </li><li>  analyses ult√©rieures. </li></ul><br><p>  Le contenu de la derni√®re √©tape est d√©termin√© par le domaine et les t√¢ches commerciales, R est id√©alement adapt√© √† cette √©tape.  Beaucoup de gens ne le savent pas, mais la premi√®re √©tape peut √©galement √™tre r√©solue assez facilement avec R. De plus, en fonction de la taille des fichiers journaux, un r√©sultat de pr√©traitement partiellement structur√© adapt√© √† une analyse plus approfondie peut √™tre ajout√© aux fichiers ainsi qu'√† la base de donn√©es.  Les t√©raoctets en broient un ou deux. </p><br><div class="spoiler">  <b class="spoiler_title">Juste un exemple de code:</b> <div class="spoiler_text"><pre> <code class="python hljs">library(readr) library(tidyverse) library(magrittr) library(stringi) library(fs) library(glue) library(RClickhouse) library(DBI) library(anytime) library(tictoc) library(iterators) library(foreach) library(doParallel) library(futile.logger) library(re2r) library(data.table) library(future) library(doFuture) common_logname &lt;- <span class="hljs-string"><span class="hljs-string">"DEV_log_parser.log"</span></span> table_name &lt;- <span class="hljs-string"><span class="hljs-string">"DEV_LOGS"</span></span> flog.appender(appender.file(common_logname)) flog.threshold(INFO) flog.info(<span class="hljs-string"><span class="hljs-string">"Start batch processing"</span></span>) oneTimeProcessing &lt;- function(f_iter, log_type = c(<span class="hljs-string"><span class="hljs-string">"app"</span></span>, <span class="hljs-string"><span class="hljs-string">"system"</span></span>)) { log_type &lt;- match.arg(log_type) checkmate::assertNames(names(f_iter), permutation.of = c(<span class="hljs-string"><span class="hljs-string">"fname"</span></span>, <span class="hljs-string"><span class="hljs-string">"short_fname"</span></span>, <span class="hljs-string"><span class="hljs-string">"location"</span></span>, <span class="hljs-string"><span class="hljs-string">"wk"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>)) cfg &lt;- list(app = list(db_table = <span class="hljs-string"><span class="hljs-string">"DEV_APP_LOGS"</span></span>), system = list(db_table = <span class="hljs-string"><span class="hljs-string">"DEV_LOGS"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#   data &lt;- readr::read_lines(file = f_iter$fname, progress = FALSE) log_df &lt;- setDT(tibble::enframe(data, name = NULL)) %&gt;% .[, log_line_start := re2r::re2_detect(value, pattern = "^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}", parallel = F)] %&gt;% .[, log_line_number := cumsum(log_line_start)] %&gt;% .[, body := stri_c(value, collapse = "\n"), by = log_line_number] %&gt;% .[, `:=`(value = NULL, log_line_start = NULL, log_line_number = NULL)] %&gt;% tibble::as_tibble() %&gt;% #  body = character(0)      0  #      POSIXct tidyr::extract(col = "body", into = c("timestamp", "tz", "level", "module", "class", "message"), # tz   (  DEV),      ( DEV) regex = "^(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}:\\d+([+-]\\d+)?) (.*?) &lt;(.*?)&gt; \\[(.*?)\\] (?s:(.*))$", case_insensitive = TRUE, ignore.case = TRUE) %&gt;% #     ISO         (   ?) #  ISO 8601 (https://en.wikipedia.org/wiki/ISO_8601) mutate_at("timestamp", re2r::re2_replace, # tz   (  DEV),      ( DEV) pattern = "(.*) (\\d{2}:\\d{2}:\\d{2}):(\\d+([+-]\\d+)?)", replacement = "\\1T\\2.\\3") %&gt;% mutate_at("timestamp", lubridate::as_datetime, tz = "Europe/Moscow") %&gt;% #    mutate(location = f_iter$location, wk = f_iter$wk) # TRUNCATE  CH    ,           #    CH, ms    (timestamp %% 1) conn &lt;- DBI::dbConnect(RClickhouse::clickhouse(), host = "10.0.0.1", db = "DEV_LOGS") # m &lt;- DBI::dbExecute(conn, glue("ALTER TABLE {table_name}")) write_res &lt;- log_df %&gt;% mutate(ms = (as.numeric(timestamp) %% 1) * 1000) %&gt;% select(location, wk, timestamp, ms, level, module, class, message) %&gt;% #            DBI::dbWriteTable(conn, cfg[[log_type]][["db_table"]], ., append = TRUE) DBI::dbDisconnect(conn) #       res &lt;- tibble::tibble(id = f_iter$id, lines = nrow(log_df), min_t = min(log_df$timestamp), max_t = max(log_df$timestamp), write_res) rm(data, log_df) return(res) } #    tic("Batch processing") #    gc(full = TRUE) nworkers &lt;- parallel::detectCores() - 1 registerDoFuture() # future::plan(multiprocess) # future::plan(multisession) future::plan(multisession, workers = nworkers) # future::plan(sequential) #  ~  #      CH #   ------------------ fnames_tbl &lt;- here::here("raw_data") %&gt;% fs::dir_ls(recurse = TRUE, glob = "*dev_app*.gz") %&gt;% enframe(name = "fname") %&gt;% #         mutate(short_fname = as.character(fs::path_rel(fname, start = "./raw_data"))) %&gt;% select(-value) %&gt;% mutate(size = fs::file_size(fname)) %&gt;% tidyr::extract(col = "short_fname", into = c("location", "wk"), regex = "^([^/]+)/wk(\\d+)", remove = FALSE) %&gt;% arrange(size) %&gt;% mutate(id = paste(format(row_number(), justify = "r", width = 4), "/", n())) %&gt;% #   ~ N  mutate(chunk = (row_number() %% nworkers + 1)) %&gt;% #    ,  dopar    arrange(chunk) start_time &lt;- Sys.time() stat_list &lt;- foreach(it = iter(fnames_tbl, by = "row"), .export = c("start_time"), .verbose = TRUE, .inorder = FALSE, .errorhandling = "remove") %dopar% { #   flog.appender(appender.file(common_logname)) # flog.info(capture.output(gc(verbose = TRUE))) res &lt;- oneTimeProcessing(it, log_type = "app") flog.info(glue("Step {it$id} finished.", "Elapsed {round(difftime(Sys.time(), start_time, units = 'mins'), digits = 2)} min(s) -----------&gt;", .sep = " ")) return(res) } flog.info("Load finished") #    -------------- #    ,    future::plan(sequential) gc(reset = TRUE, full = TRUE) flog.info(capture.output(toc())) #     ------------- logstat_tbl &lt;- stat_list %&gt;% dplyr::bind_rows() %&gt;% #    left_join(fnames_tbl, by = "id") %&gt;% #          mutate(delta_t = as.numeric(difftime(max_t, min_t, units = "mins"))) %&gt;% arrange(min_t) write_delim(logstat_tbl, here::here("output", "DEV_parse_stat.csv.gz"), delim = ";") # ,     ? if(nrow(logstat_tbl) &lt; nrow(fnames_tbl)){ flog.error("!!!!!!! Not all workers were executed successfully !!!!!!!!!") }</span></span></code> </pre> </div></div><br><p>  Cet exemple de code contient des concepts de base tels que la parall√©lisation, le traitement du temps en tenant compte des millisecondes, l'enregistrement dans la base de donn√©es, la comptabilisation des enregistrements sur plusieurs lignes, la synth√®se des r√©sultats du travail, l'utilisation des attributs externes, l'analyse comparative pr√©liminaire et le choix des fonctions et des packages <code>re2r</code> ( <code>re2r</code> , par exemple; ce la biblioth√®que google pour travailler avec les biblioth√®ques normales est la plus rapide et est beaucoup utilis√©e o√π, prenez le m√™me ClickHouse mentionn√© dans le code { <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bencmark</a> , certains op√©rateurs peuvent avoir ILV ferm√©}).  Mais le code ne pr√©tend pas √™tre id√©al, car il ne s'agit que d'une action ponctuelle sur le pr√©traitement des donn√©es.  Il le fait rapidement et correctement, eh bien, ok.  Pour une autre t√¢che similaire, nous corrigeons, en tenant compte de resp.  donn√©es d'entr√©e. </p><br><p>  Sera-t-il incroyablement plus rapide en termes de temps pour obtenir le r√©sultat final dans d'autres langues?  La question est ouverte.  Les versions parall√®les avec <code>python</code> , <code>perl</code> , <code>awk</code> n'ont montr√© aucune diff√©rence frappante.  Il est possible que le gourou en <code>python</code> obtienne de meilleurs r√©sultats, mais n'oubliez pas que ce n'est qu'une t√¢che p√©riodique "ponctuelle" qui passe. </p><br><h1 id="navedenie-poryadka-v-fotografiyah">  Restauration de l'ordre dans les photos </h1><br><p>  Apr√®s un voyage avec plusieurs appareils √† port√©e de main, vous devez collecter toutes les photos ensemble et les organiser avant de poursuivre le traitement.  L'une des meilleures options est de nommer les fichiers par la date de prise de vue ( <code>YYYY-MM-DD hh_mm_ss</code> ), assurant ainsi l'ordre de la photo sur la fl√®che de temps.  Les attributs Exif aident √† r√©soudre ce probl√®me en une seule √©tape. </p><br><p>  Et cela peut √©galement √™tre fait en utilisant R dans un "couple de lignes".  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>exifr</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>exifr</code></a> pour vous aider. </p><br><ul><li>  fait une liste de fichiers; </li><li>  retir√© les attributs; </li><li>  fichiers copi√©s avec renommer acc.  avec les bons attributs. </li></ul><br><p>  En fait, la t√¢che a √©t√© r√©duite √† la pr√©c√©dente, seuls les attributs sont collect√©s non pas par le nom du fichier, mais par ses attributs exif, et lors du traitement, il suffit de copier le fichier avec renommer.  Le squelette du script et la logique du travail restent inchang√©s. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de code de main rapide:</b> <div class="spoiler_text"><pre> <code class="julia hljs">library(tidyverse) library(magrittr) library(stringi) library(lubridate) library(stringi) library(fs) library(glue) library(futile.logger) library(anytime) library(tictoc) library(bench) library(exifr) library(tictoc) input_path &lt;- <span class="hljs-string"><span class="hljs-string">"S:/ "</span></span> %&gt;% fs::path_real() <span class="hljs-comment"><span class="hljs-comment">#       output_path &lt;- "S:/ " %&gt;% fs::path_real() i_fnames &lt;- input_path %&gt;% fs::dir_ls(recurse = TRUE, regexp = "(JPG|jpg)$") raw_df &lt;- read_exif(i_fnames, tags = c("SourceFile", "Model", "DateTimeOriginal")) %&gt;% #      base64, ,    mutate(tmp = sub("^base64:(.*)", "\\1", SourceFile)) %&gt;% mutate(i_fname = purrr::map_chr(tmp, ~rawToChar(jsonlite::base64_dec(.)))) %&gt;% mutate(tm = anytime::anytime(DateTimeOriginal)) %&gt;% select(i_fname, DateTimeOriginal, model = Model, tm) #         clean_df &lt;- raw_df %&gt;% mutate(timestamp = case_when( model == 'iPhone ...' ~ tm, model == 'Nikon ...' ~ tm - lubridate::minutes(56), model == 'Samsung ...' ~ tm - lubridate::minutes(62), TRUE ~ tm) ) %&gt;% mutate_at("i_fname", fs::path_real) %&gt;% mutate(fname = format(timestamp, format = '%Y-%m-%d %H_%M_%S')) %&gt;% #  ,     (""),      mutate(fname = dplyr::coalesce(fname, fs::path_ext_remove(fs::path_file(i_fname)))) %&gt;% #  ,         group_by(fname) %&gt;% mutate(n = n(), idx = row_number()) %&gt;% ungroup() %&gt;% #        mutate(fname = case_when( n &gt; 1 ~ stri_c(fname, '_', idx), TRUE ~ fname ) ) %&gt;% mutate(o_fname = fs::path(!!output_path, paste0(fname, ".jpg"))) #     janitor::get_dupes(clean_df, o_fname) #   tic(" ") clean_df %$% # purrr::walk2(i_fname, o_fname, ~print(glue("{.x} -&gt; {.y}"))) purrr::walk2(i_fname, o_fname, ~fs::file_copy(.x, .y, overwrite = TRUE)) toc() #             </span></span></code> </pre> </div></div><br><p>  Pourquoi <code>exifr</code> ?  Parce que c'est un wrapper pour le puissant utilitaire multiplateforme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ExifTool</code></a> . </p><br><p>  Peut-√™tre que la t√¢che semble synth√©tique, ce qui est difficile √† discuter, car il existe de nombreux utilitaires et interfaces graphiques diff√©rents pour travailler avec Exif et renommer, mais il y a une nuance.  Tous les appareils ne peuvent pas d√©tecter le fuseau horaire modifi√© et ajuster l'heure (cam√©ras, par exemple, √† quelle fr√©quence l'utilisateur de la cam√©ra d√©finit-il l'heure exacte?), Donc lors du changement de nom, vous devez √©galement modifier les horodatages en fonction de la source. </p><br><h1 id="zavershenie">  Ach√®vement </h1><br><p>  Il existe de nombreux probl√®mes similaires, beaucoup d'entre eux peuvent √©galement √™tre r√©solus √† l'aide de R. </p><br><p>  Publication pr√©c√©dente - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Enfants, math√©matiques et R¬ª</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464849/">https://habr.com/ru/post/fr464849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464833/index.html">Count Scoring de la Fer ou une √©tude sur la notation du cr√©dit dans le cadre de l'√©largissement de ses horizons. 2e partie</a></li>
<li><a href="../fr464837/index.html">Du Gange √† la Volga: comment sauver les fleuves de la pollution?</a></li>
<li><a href="../fr464839/index.html">√Ä propos d'un brevet Tesla Motors</a></li>
<li><a href="../fr464843/index.html">Agr√©able avec utile ou d√©veloppement pour ASIO en C ++</a></li>
<li><a href="../fr464847/index.html">Projet de formation √† Godot - Pong (Partie 1) Cr√©ation et personnalisation d'une sc√®ne de gameplay</a></li>
<li><a href="../fr464853/index.html">O√π √©couter du mat√©riel audio: une culture des institutions th√©matiques pour les fans audio - du Japon √† la Russie</a></li>
<li><a href="../fr464857/index.html">D√©veloppement du syst√®me d'exploitation multit√¢che Microkernel - Scheduler</a></li>
<li><a href="../fr464859/index.html">Contr√¥le de plusieurs moteurs pas √† pas Nema 17 en m√™me temps ou NemaStepper</a></li>
<li><a href="../fr464861/index.html">Scrum Mini Reference and Guide</a></li>
<li><a href="../fr464863/index.html">Natas Web. Passage de la plateforme CTF visant √† exploiter les vuln√©rabilit√©s du Web. Partie 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>