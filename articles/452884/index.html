<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👥 🥌 🤙🏼 Análisis del rendimiento de la máquina virtual en VMware vSphere. Parte 1: CPU 💦 🙍🏿 🔰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si administra una infraestructura virtual basada en VMware vSphere (o cualquier otra pila de tecnología), probablemente escuche quejas de los usuarios...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Análisis del rendimiento de la máquina virtual en VMware vSphere. Parte 1: CPU</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/452884/"><img src="https://habrastorage.org/webt/m9/sx/3b/m9sx3brt_zkyowlzywiwyoobc60.png"><br><br>  Si administra una infraestructura virtual basada en VMware vSphere (o cualquier otra pila de tecnología), probablemente escuche quejas de los usuarios: "¡La máquina virtual es lenta!".  En esta serie de artículos analizaré las métricas de rendimiento y explicaré qué y por qué se "ralentiza" y cómo asegurarse de que no se "ralentice". <br><br>  Consideraré los siguientes aspectos de rendimiento de las máquinas virtuales: <br><br><ul><li>  CPU </li><li>  RAM </li><li>  DISCO </li><li>  Red </li></ul><br>  Comenzaré con la CPU. <br><br>  Para el análisis de rendimiento necesitamos: <br><br><ul><li> <b>Los vCenter Performance Counters</b> son contadores de rendimiento cuyos gráficos se pueden ver a través de vSphere Client.  La información sobre estos contadores está disponible en cualquier versión de cliente (cliente "grueso" en C #, cliente web en Flex y cliente web en HTML5).  En estos artículos, utilizaremos capturas de pantalla del cliente C #, solo porque se ven mejor en miniatura :) </li><li>  <b>ESXTOP</b> es una utilidad que se ejecuta desde la línea de comandos de ESXi.  Con su ayuda, puede obtener los valores de los contadores de rendimiento en tiempo real o cargar estos valores durante un período determinado en un archivo .csv para su posterior análisis.  A continuación, le contaré más sobre esta herramienta y le proporcionaré algunos enlaces útiles a la documentación y artículos relacionados. </li></ul><br><a name="habracut"></a><br><h3>  Poco de teoría </h3><br><img src="https://habrastorage.org/webt/zf/rh/dx/zfrhdxqi6ys3wgdgzs0m5ibk96i.png"><br><br>  En ESXi, un proceso separado es responsable del funcionamiento de cada vCPU (núcleo de máquina virtual), el mundo en terminología de VMware.  También hay procesos de servicio, pero desde el punto de vista del análisis de rendimiento de VM, son menos interesantes. <br><br>  Un proceso en ESXi puede estar en uno de cuatro estados: <br><br><ul><li>  <b>Ejecutar</b> : el proceso hace un trabajo útil. </li><li>  <b>Espere</b> : el proceso no funciona (inactivo) o está esperando entrada / salida. </li><li>  <b>Costop</b> es una condición que ocurre en máquinas virtuales multinúcleo.  Ocurre cuando el planificador de la CPU del hipervisor (ESXi CPU Scheduler) no puede programar todos los núcleos activos de la máquina virtual para que se ejecuten simultáneamente en los núcleos del servidor físico.  En el mundo físico, todos los núcleos de procesador funcionan en paralelo, el sistema operativo invitado dentro de la VM espera un comportamiento similar, por lo que el hipervisor debe ralentizar los núcleos de VM, que tienen la capacidad de terminar el ritmo más rápido.  En las versiones modernas de ESXi, el programador de la CPU utiliza un mecanismo llamado co-programación relajada: el hipervisor considera la brecha entre el núcleo de la máquina virtual más rápido y más lento (sesgo). Si los núcleos de VM pasan mucho tiempo en este estado, esto puede causar problemas de rendimiento. </li><li>  <b>Listo</b> : el proceso pasa a este estado cuando el hipervisor no tiene la capacidad de asignar recursos para su ejecución.  Los valores altos listos pueden causar problemas de rendimiento de VM. </li></ul><br><h3>  Contadores básicos de rendimiento de CPU de una máquina virtual </h3><br>  <b>Uso de CPU,%.</b>  Muestra el porcentaje de uso de CPU para un período determinado. <br><br><img src="https://habrastorage.org/webt/ly/ad/rg/lyadrgztwkrkipbfnzllfcjtrq4.png"><br><br>  <b>¿Cómo analizar?</b>  Si la VM utiliza de manera estable la CPU para el 90% o hay picos de hasta el 100%, entonces tenemos problemas.  Los problemas se pueden expresar no solo en el funcionamiento "lento" de la aplicación dentro de la VM, sino también en la inaccesibilidad de la VM a través de la red.  Si el sistema de monitoreo muestra que la VM se cae periódicamente, preste atención a los picos en el gráfico de Uso de la CPU. <br><br>  Hay una alarma estándar, que muestra la carga de CPU de la máquina virtual: <br><br><img src="https://habrastorage.org/webt/6a/pr/b9/6aprb9vc1gwbtioocqpjdm7jzhk.png"><br><br>  <b>Que hacer</b>  Si el uso de la CPU está constantemente abrumando a la VM, puede pensar en aumentar el número de vCPU (desafortunadamente, esto no siempre ayuda) o transferir las VM a un servidor con procesadores más eficientes. <br><br><h3>  Uso de CPU en Mhz </h3><br>  En los gráficos de uso de vCenter en% solo puede ver la máquina virtual completa, no hay gráficos para núcleos individuales (Esxtop tiene valores en% para núcleos).  Para cada núcleo, puede ver Uso en MHz. <br><br>  <b>¿Cómo analizar?</b>  Sucede que la aplicación no está optimizada para la arquitectura multinúcleo: utiliza 100% solo un núcleo, y el resto está inactivo sin carga.  Por ejemplo, con la configuración de copia de seguridad predeterminada, MS SQL inicia el proceso en un solo núcleo.  Como resultado, la copia de seguridad se ralentiza no debido a la velocidad lenta del disco (esto es de lo que se quejó inicialmente el usuario), sino porque el procesador no puede hacer frente.  El problema se resolvió cambiando los parámetros: la copia de seguridad comenzó a ejecutarse en paralelo en varios archivos (respectivamente, en varios procesos). <br><br><img src="https://habrastorage.org/webt/6p/pm/w8/6ppmw8d5vqe2gepkiahzqx9tfms.png"><br>  <i>Un ejemplo de una carga desigual de núcleos.</i> <br><br>  También existe una situación (como en el gráfico anterior) cuando los núcleos están cargados de manera desigual y algunos de ellos tienen picos del 100%.  Al igual que con la carga de un solo núcleo, la alarma en el uso de la CPU no funcionará (está en toda la VM), pero habrá problemas de rendimiento. <br><br>  <b>Que hacer</b>  Si el software en la máquina virtual carga los núcleos de manera desigual (usa solo un núcleo o parte de los núcleos), no tiene sentido aumentar su número.  En este caso, es mejor mover la VM a un servidor con procesadores más eficientes. <br><br>  También puede intentar verificar la configuración de energía en el BIOS del servidor.  Muchos administradores activan el modo de alto rendimiento en el BIOS y, por lo tanto, desactivan las tecnologías de ahorro de energía de los estados C y P.  Los procesadores Intel modernos usan la tecnología Turbo Boost, que aumenta la frecuencia de los núcleos de procesadores individuales debido a otros núcleos.  Pero solo funciona con las tecnologías de ahorro de energía incluidas.  Si los apagamos, el procesador no puede reducir el consumo de energía de los núcleos que no están cargados. <br><br>  VMware recomienda no desactivar las tecnologías de ahorro de energía en los servidores, sino elegir modos que maximicen la administración de energía para el hipervisor.  Al mismo tiempo, en la configuración de energía del hipervisor, debe seleccionar Alto rendimiento. <br><br>  Si tiene máquinas virtuales separadas (o núcleos de máquinas virtuales) en su infraestructura que requieren una frecuencia de CPU aumentada, la configuración correcta del consumo de energía puede mejorar significativamente su rendimiento. <br><br><img src="https://habrastorage.org/webt/uq/ov/-o/uqov-ooazq0fetmazbwzhvxlgeg.png"><br><br><h3>  CPU lista (preparación) </h3><br>  Si el núcleo de VM (vCPU) está en estado Listo, no hace un trabajo útil.  Esta condición ocurre cuando el hipervisor no encuentra un núcleo físico libre al que se pueda asignar el proceso de vCPU de la máquina virtual. <br><br>  <b>¿Cómo analizar?</b>  Por lo general, si los núcleos de la máquina virtual están en estado Listo durante más del 10% del tiempo, notará problemas de rendimiento.  En pocas palabras, más del 10% del tiempo que una VM espera la disponibilidad de recursos físicos. <br><br>  En vCenter, puede ver 2 contadores asociados con la CPU Ready: <br><br><ul><li>  Preparación </li><li>  Listo </li></ul><br>  Los valores de ambos contadores se pueden ver tanto en toda la VM como en núcleos individuales. <br>  La preparación muestra el valor inmediatamente en porcentaje, pero solo en tiempo real (datos de la última hora, intervalo de medición de 20 segundos).  Este contador se usa mejor solo para buscar problemas "en persecución". <br><br>  Los valores de contador listos también se pueden ver en perspectiva histórica.  Esto es útil para establecer patrones y para un análisis más profundo del problema.  Por ejemplo, si una máquina virtual comienza a tener problemas de rendimiento en algún momento específico, puede comparar los intervalos del valor de CPU Ready bloqueado con la carga total en el servidor donde se está ejecutando la VM, y tomar medidas para reducir la carga (si DRS no puede hacer frente). <br><br>  Listo, a diferencia de Readiness, no se muestra en porcentajes, sino en milisegundos.  Este es un contador de tipo de Suma, es decir, muestra cuánto tiempo estuvo el núcleo de VM en el estado Listo durante el período de medición.  Puede traducir este valor en porcentaje mediante una fórmula simple: <br><br>  (Valor de suma de CPU listo / (intervalo de actualización predeterminado del gráfico en segundos * 1000)) * 100 =% de CPU listo <br><br>  Por ejemplo, para las máquinas virtuales en el gráfico a continuación, el valor máximo de Ready para toda la máquina virtual es el siguiente: <br><br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo stretchy=&quot;false&quot;>(</mo><mn>4286</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mo stretchy=&quot;false&quot;>(</mo><mn>20</mn><mo>&amp;#x2217;</mo><mn>1000</mn><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2217;</mo><mn>100</mn><mo>=</mo><mn>21</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="29.706ex" height="2.66ex" viewBox="0 -832 12789.9 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-34"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-32" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-38" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-36" x="1501" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-2F" x="2391" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-28" x="2892" y="0"></use><g transform="translate(3281,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-2217" x="4504" y="0"></use><g transform="translate(5227,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="1501" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-29" x="7229" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-29" x="7618" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-2217" x="8230" y="0"></use><g transform="translate(8953,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-30" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-3D" x="10732" y="0"></use><g transform="translate(11788,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/company/dataline/blog/452884/&amp;usg=ALkJrhhda4xrsMr5_62yExwBzSkOEuas9A#MJMAIN-31" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo stretchy="false">(</mo><mn>4286</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mo stretchy="false">(</mo><mn>20</mn><mo>∗</mo><mn>1000</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>∗</mo><mn>100</mn><mo>=</mo><mn>21</mn></math></span></span><script type="math/tex" id="MathJax-Element-1"> (4286 / (20 * 1000)) * 100 = 21% (4286 / (20 * 1000)) * 100 = 21% </script><br><br><img src="https://habrastorage.org/webt/oq/ma/1u/oqma1u-x4wdruct6jqgvlak9ia0.png"><br><br>  Al calcular el valor Listo como un porcentaje, debe prestar atención a dos puntos: <br><br><ul><li>  El valor de Ready en toda la VM es la suma de Ready en los núcleos. </li><li>  Intervalo de medida.  En tiempo real, son 20 segundos y, por ejemplo, en gráficos diarios, son 300 segundos. </li></ul><br>  Con la resolución activa de problemas, estos puntos simples se pueden perder fácilmente y se puede dedicar un tiempo valioso a resolver problemas inexistentes. <br><br>  Calculamos Ready en base a los datos del gráfico a continuación.  (324474 / (20 * 1000)) * 100 = 1622% para toda la VM.  Si nos fijamos en los núcleos, resultará no tan aterrador: 1622/64 = 25% por núcleo.  En este caso, detectar un truco es bastante simple: el valor Listo no es realista.  Pero si estamos hablando del 10-20% para toda la VM con varios núcleos, entonces para cada núcleo el valor puede estar dentro del rango normal. <br><br><img src="https://habrastorage.org/webt/_m/qe/cc/_mqeccs8ivn_r-zrogedc_ofw9a.png"><br><br>  <b>Que hacer</b>  Un valor alto de Listo indica que el servidor no tiene suficientes recursos de procesador para el funcionamiento normal de las máquinas virtuales.  En esta situación, solo queda reducir la suscripción excesiva en el procesador (vCPU: pCPU).  Obviamente, esto se puede lograr reduciendo los parámetros de las máquinas virtuales existentes o migrando parte de la máquina virtual a otros servidores. <br><br><h3>  Co-stop </h3><br>  <b>¿Cómo analizar?</b>  Este contador también tiene el tipo de Suma y se traduce en porcentajes como Listo: <br><br>  (Valor de suma de paro de CPU / (intervalo de actualización predeterminado del gráfico en segundos * 1000)) * 100 =% de paro de CPU <br><br>  Aquí también debe prestar atención a la cantidad de núcleos por VM y al intervalo de medición. <br>  En el estado costop, el núcleo no hace un trabajo útil.  Con la selección correcta del tamaño de la máquina virtual y la carga normal en el servidor, el contador de parada simultánea debe estar cerca de cero. <br><br><img src="https://habrastorage.org/webt/pz/y8/sr/pzy8sr12hk1z2yosm9devw7knvs.png"><br>  <i>En este caso, la carga es claramente anormal :)</i> <br><br>  <b>Que hacer</b>  Si varias máquinas virtuales con una gran cantidad de núcleos se ejecutan en el mismo hipervisor y hay una suscripción excesiva en la CPU, entonces el contador de detención simultánea puede crecer, lo que provocará problemas con el rendimiento de estas máquinas virtuales. <br><br>  Además, co-stop aumentará si se usan subprocesos para núcleos activos de una VM en el mismo núcleo del servidor físico con hipercadena habilitada.  Tal situación puede surgir, por ejemplo, si la VM tiene más núcleos de los que tiene físicamente en el servidor donde trabaja, o si la configuración "preferHT" está habilitada para la VM.  Puede leer sobre esta configuración <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . <br><br>  Para evitar problemas con el rendimiento de la VM debido a la alta parada simultánea, seleccione el tamaño de la VM de acuerdo con las recomendaciones del fabricante del software que se ejecuta en esta VM y con las capacidades del servidor físico donde se ejecuta la VM. <br><br>  No agregue kernels en reserva, esto puede causar problemas de rendimiento no solo de la VM en sí, sino también de sus servidores vecinos. <br><br><h3>  Otras métricas útiles de CPU </h3><br>  <b>Ejecutar</b> : cuánto tiempo (ms) para el período de medición de vCPU estuvo en el estado EJECUTAR, es decir, realmente realizó un trabajo útil. <br><br>  <b>Inactivo</b> : cuánto tiempo (ms) para el período de medición de vCPU estuvo inactivo.  Los valores altos de inactividad no son un problema, solo vCPU no tenía "nada que hacer". <br><br>  <b>Esperar</b> : cuánto tiempo (ms) para el período de medición de vCPU estuvo en el estado Esperar.  Dado que IDLE se incluye en este contador, los valores de espera altos tampoco indican un problema.  Pero si el nivel de espera alto es bajo, entonces la máquina virtual estaba esperando que se completaran las operaciones de E / S y esto, a su vez, puede indicar un problema con el rendimiento del disco duro o de algunos dispositivos virtuales de la máquina virtual. <br><br>  <b>Limitado máximo</b> : cuánto tiempo (ms) para el período de medición de vCPU estuvo en estado Listo debido al límite de recursos establecido.  Si el rendimiento es inexplicablemente bajo, es útil verificar el valor de este contador y el límite de CPU en la configuración de VM.  De hecho, las máquinas virtuales pueden tener límites que desconoce.  Por ejemplo, esto sucede cuando la VM se inclinó desde la plantilla en la que se estableció el límite de CPU. <br><br>  <b>Swap wait</b> : cuánto tiempo esperó la vCPU para funcionar con VMkernel Swap durante el período de medición.  Si los valores de este contador están por encima de cero, entonces la VM definitivamente tiene problemas de rendimiento.  Hablaremos más sobre SWAP en el artículo sobre contadores de RAM. <br><br><h3>  ESXTOP </h3><br>  Si los contadores de rendimiento en vCenter son buenos para analizar datos históricos, entonces el análisis en línea del problema se realiza mejor en ESXTOP.  Aquí, todos los valores se presentan en forma terminada (no es necesario traducir nada), y el período mínimo de medición es de 2 segundos. <br>  La pantalla "c" activa la pantalla ESXTOP en la CPU y tiene este aspecto: <br><br><img src="https://habrastorage.org/webt/5x/8g/-o/5x8g-ovkxsc4xsuuvvk6guv3t0u.png"><br><br>  Para mayor comodidad, solo puede dejar procesos de máquinas virtuales presionando Shift-V. <br>  Para ver las métricas de los núcleos de máquinas virtuales individuales, presione "e" y escriba el GID de la máquina virtual que le interesa (30919 en la captura de pantalla a continuación): <br><br><img src="https://habrastorage.org/webt/tu/fn/jz/tufnjzwauierg5thzwsij3elpca.png"><br><br>  Revise brevemente las columnas que se presentan por defecto.  Se pueden agregar columnas adicionales presionando "f". <br><br>  <b>NWLD (Número de mundos)</b> : el número de procesos en el grupo.  Para expandir el grupo y ver las métricas de cada proceso (por ejemplo, para cada núcleo de una VM multinúcleo), presione "e".  Si un grupo tiene más de un proceso, los valores de las métricas para el grupo son iguales a la suma de las métricas para los procesos individuales. <br><br>  <b>% USADO</b> : cuántos ciclos utiliza la CPU del servidor un proceso o grupo de procesos. <br><br>  <b>% RUN</b> : cuánto tiempo durante el período de medición el proceso estuvo en el estado RUN, es decir  realizó un trabajo útil.  Se diferencia del% USADO en que no tiene en cuenta el subprocesamiento, el escalado de frecuencia y el tiempo dedicado a las tareas del sistema (% SYS). <br><br>  <b>% SYS</b> : tiempo dedicado a tareas del sistema, por ejemplo: manejo de interrupciones, entrada / salida, funcionamiento de la red, etc. El valor puede ser alto si hay mucha entrada / salida en la VM. <br><br>  <b>% OVRLP</b> : cuánto tiempo pasó el núcleo físico en el que se ejecuta el proceso VM en tareas de otros procesos. <br><br>  Estas métricas están relacionadas de la siguiente manera: <br><br>  % USED =% RUN +% SYS -% OVRLP. <br><br>  Por lo general, la métrica% USADO es más informativa. <br><br>  <b>% WAIT</b> : cuánto tiempo durante el período de medición estuvo el proceso en el estado Wait.  Incluye inactivo. <br><br>  <b>% IDLE</b> : cuánto tiempo estuvo el proceso en estado IDLE durante el período de medición. <br><br>  <b>% SWPWT</b> : cuánto tiempo esperó vCPU para la operación con VMkernel Swap durante el período de medición. <br><br>  <b>% VMWAIT</b> : cuánto tiempo estuvo la vCPU en el estado de espera de un evento (generalmente E / S) durante el período de medición.  No hay un contador similar en vCenter.  Los valores altos indican problemas con la entrada / salida a la VM. <br><br>  % WAIT =% VMWAIT +% IDLE +% SWPWT. <br><br>  Si la VM no usa VMkernel Swap, cuando analice problemas de rendimiento es aconsejable mirar% VMWAIT, ya que esta métrica no tiene en cuenta el momento en que la VM no hizo nada (% IDLE). <br><br>  <b>% RDY</b> : cuánto tiempo estuvo el proceso en estado Listo durante el período de medición. <br><br>  <b>% CSTP</b> : cuánto tiempo estuvo el proceso en el estado posterior durante el período de medición. <br><br>  <b>% MLMTD</b> : cuánto tiempo durante el período de medición de vCPU estuvo en estado Listo debido al límite de recursos establecido. <br><br>  % WAIT +% RDY +% CSTP +% RUN = 100%: el núcleo de VM siempre está en uno de estos cuatro estados. <br><br><h3>  CPU en el hipervisor </h3><br>  También hay contadores de rendimiento de CPU para el hipervisor en vCenter, pero no representan nada interesante: es solo la suma de los contadores para todas las máquinas virtuales en el servidor. <br>  La forma más conveniente de ver el estado de la CPU en el servidor es en la pestaña Resumen: <br><br><img src="https://habrastorage.org/webt/cr/zn/bb/crznbbcz3ifhippyvvrpqaotvps.png"><br><br>  Para el servidor, así como para la máquina virtual, hay una alarma estándar: <br><br><img src="https://habrastorage.org/webt/-v/x0/gz/-vx0gzuta3wskstyrmu8ylixqla.png"><br><br>  Con una alta carga en la CPU del servidor, las máquinas virtuales que se ejecutan en él comienzan a experimentar problemas de rendimiento. <br><br>  En ESXTOP, los datos de utilización de la CPU del servidor se presentan en la parte superior de la pantalla.  Además de la carga estándar de la CPU, que no es informativa para los hipervisores, hay tres métricas más: <br><br>  <b>CORE UTIL (%)</b> : carga del núcleo del servidor físico.  Este contador muestra cuánto tiempo el núcleo realizó el trabajo durante el período de medición. <br><br>  <b>PCPU UTIL (%)</b> : si el hiperprocesamiento está habilitado, entonces hay dos subprocesos (PCPU) para cada núcleo físico.  Esta métrica muestra cuánto tiempo trabajó cada subproceso. <br><br>  <b>PCPU USED (%)</b> es lo mismo que PCPU UTIL (%), pero tiene en cuenta la escala de frecuencia (ya sea reduciendo la frecuencia del núcleo para ahorrar energía o aumentando la frecuencia del núcleo debido a la tecnología Turbo Boost) e hiper-threading. <br><br>  PCPU_USED% = PCPU_UTIL% * frecuencia central efectiva / frecuencia central nominal. <br><br><img src="https://habrastorage.org/webt/gk/il/nh/gkilnhtdazgv5nxiwbydkhda-oe.png"><br>  <i>En esta captura de pantalla, para algunos núcleos, debido a la operación de Turbo Boost, el valor USADO es más del 100%, ya que la frecuencia del núcleo es más alta que la nominal.</i> <br><br>  Algunas palabras sobre cómo se tiene en cuenta el hiperprocesamiento.  Si los procesos se ejecutan el 100% del tiempo en ambos subprocesos del núcleo físico del servidor, mientras que el núcleo se ejecuta a la frecuencia nominal, entonces: <br><br><ul><li>  CORE UTIL para el núcleo será 100%, </li><li>  PCPU UTIL para ambos hilos será 100%, </li><li>  PCED UTILIZADO para ambos hilos será del 50%. </li></ul><br>  Si ambos hilos no funcionaron el 100% del tiempo durante el período de medición, entonces, en aquellos períodos en que los hilos trabajaron en paralelo, la PCPU UTILIZADA para núcleos se divide por la mitad. <br><br>  ESXTOP también tiene una pantalla con los parámetros de consumo de energía del servidor de la CPU.  Aquí puede ver si el servidor utiliza tecnologías de ahorro de energía: estados C y estados P.  Llamado por la tecla p: <br><br><img src="https://habrastorage.org/webt/cd/qv/he/cdqvhelnmce9qeseanbqzl3qsqs.png"><br><br><h3>  Problemas comunes de rendimiento de la CPU </h3><br>  Finalmente, revisaré por razones típicas de problemas con el rendimiento de la CPU VM y daré algunos consejos para resolverlos: <br><br>  <b>No hay suficiente velocidad de reloj central.</b>  Si no hay forma de transferir máquinas virtuales a núcleos más eficientes, puede intentar cambiar la configuración de energía para que Turbo Boost funcione de manera más eficiente. <br><br>  <b>Dimensionamiento incorrecto de la VM (demasiados / pocos núcleos).</b>  Si coloca pocos núcleos, habrá una gran carga en la CPU de VM.  Si es mucho, coge una parada alta. <br><br>  <b>Gran sobresuscripción en la CPU en el servidor.</b>  Si la máquina virtual está preparada, reduzca la suscripción excesiva en la CPU. <br><br>  <b>Topología de NUMA incorrecta en máquinas virtuales grandes.</b>  La topología NUMA que ve la VM (vNUMA) debe coincidir con la topología del servidor NUMA (pNUMA).  Los diagnósticos y las posibles soluciones a este problema están escritos, por ejemplo, en el libro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"VMware vSphere 6.5 Host Resources Deep Dive"</a> .  Si no desea profundizar y no tiene restricciones de licencia en el sistema operativo instalado en la VM, realice muchos sockets virtuales en la VM en un núcleo.  No perderás mucho :) <br><br>  Eso es todo por la CPU.  Haz preguntas  En la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">siguiente parte</a> hablaré sobre RAM. <br><br><div class="spoiler">  <b class="spoiler_title">Enlaces utiles</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://virtual-red-dot.info/vm-cpu-counters-vsphere/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://kb.vmware.com/kb/1017926</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.yellow-bricks.com/2012/07/17/why-is-wait-so-high/</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://communities.vmware.com/docs/DOC-9279</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/whats-new-vsphere65-perf.pdf</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://pages.rubrik.com/host-resources-deep-dive_request.html</a> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452884/">https://habr.com/ru/post/452884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452880/index.html">Fugas de datos de usuarios sensacionales para enero - abril de 2019</a></li>
<li><a href="../452882/index.html">Errores del cliente en el primer contacto con Freelancer</a></li>
<li><a href="../452886/index.html">Proyectos de Wiki y nombre de Noosphere en HACKNOWLEGE</a></li>
<li><a href="../452888/index.html">Cerca de Múnich comenzó a probar el tiltrotor de cinco asientos de tamaño completo Lilium Jet</a></li>
<li><a href="../452890/index.html">23 de mayo, 18:30 - transmisión en vivo de QIWI Kitchen</a></li>
<li><a href="../452892/index.html">¿Cómo puede un no programador mudarse a los Estados Unidos? Instrucciones paso a paso.</a></li>
<li><a href="../452894/index.html">Face Anti-Spoofing o tecnológicamente reconoce a un tramposo de mil por cara</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>