<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧔🏾 🥪 ✊🏻 Sauvegarde rapide et fiable des données dans le cloud 2 💜 🏚️ 👇🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans mon article précédent , j'ai décrit un exemple de script qui peut archiver et télécharger une certaine quantité de fichiers utilisateur dans le c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegarde rapide et fiable des données dans le cloud 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437794/">  Dans mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> précédent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> j'ai décrit un exemple de script qui peut archiver et télécharger une certaine quantité de fichiers utilisateur dans le cloud sans sa participation, fournissant ainsi la sauvegarde la plus simple des fichiers utilisateur.  Le script fournit la fermeture des problèmes suivants: <br><br><ul><li>  rapide (parfait en arrière-plan); </li><li>  Il conserverait à la fois la version actuelle des fichiers et les précédents; </li><li>  le stockage des fichiers ne serait pas accessible aux virus ou aux catastrophes naturelles telles que la destruction du transporteur ou son vol; </li><li>  le contenu de la copie de sauvegarde ne serait accessible qu'à l'utilisateur, c'est-à-dire  était protégé par mot de passe. </li></ul><br>  Naturellement, la simplicité du script s'est transformée en ses défauts, à savoir: <br><br><ul><li>  Stockage des mots de passe dans le corps du script.  Oui, de nombreux programmes stockent les mots de passe non chiffrés dans des fichiers texte, et la protection de ces données se fait par le contrôle d'accès aux fichiers, mais toujours extraire le mot de passe du code est un signe de bon goût et de protection minimale au cas où le script de travail tomberait entre de mauvaises mains d'une manière ou d'une autre. . </li><li>  Absence de vérification de la réussite de l'opération et retour à l'état précédent si l'opération ne s'est pas terminée avec succès. </li><li> Absence de journalisation et de notification à l'utilisateur du succès de l'opération si le script est exécuté via le planificateur de tâches. </li></ul><br>  À cet égard, le code de script pour l'archive complète et incrémentielle a été complété par les fonctionnalités nécessaires.  Pour une description générale, voir l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article précédent</a> , ici je veux m'attarder uniquement sur les changements. <br><a name="habracut"></a><br><h3>  Script pour créer une archive complète </h3><br><pre><code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">chcp</span></span> <span class="hljs-number"><span class="hljs-number">1251</span></span> &gt;<span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> filebkp=server <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat user <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat pass <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat pwd <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat recipient <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsend=mailsend1.<span class="hljs-number"><span class="hljs-number">17</span></span>b15.exe <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pathbkp=..\backup <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pathtemp=..\temp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> srvbkp=https://<span class="hljs-variable"><span class="hljs-variable">%user%</span></span>:<span class="hljs-variable"><span class="hljs-variable">%pass%</span></span>@webdav.yandex.ru/backup/<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> full=<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-full <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> inc=<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-inc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> h=<span class="hljs-variable"><span class="hljs-variable">%TIME:~0,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> m=<span class="hljs-variable"><span class="hljs-variable">%TIME:~3,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> s=<span class="hljs-variable"><span class="hljs-variable">%TIME:~6,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ms=<span class="hljs-variable"><span class="hljs-variable">%TIME:~9,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curtime=<span class="hljs-variable"><span class="hljs-variable">%h%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%m%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%s%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dd=<span class="hljs-variable"><span class="hljs-variable">%DATE:~0,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mm=<span class="hljs-variable"><span class="hljs-variable">%DATE:~3,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> yyyy=<span class="hljs-variable"><span class="hljs-variable">%DATE:~6,4%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curdate=<span class="hljs-variable"><span class="hljs-variable">%yyyy%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%mm%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%dd%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curdatetime=%curdate: =<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-variable"><span class="hljs-variable">%-%</span></span>curtime: =<span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "-----------------------------------" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "  - <span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "    " <span class="hljs-built_in"><span class="hljs-built_in">ren</span></span> "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>" temp-bkp <span class="hljs-built_in"><span class="hljs-built_in">md</span></span> "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   <span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z" <span class="hljs-number"><span class="hljs-number">7</span></span>z.exe a -xr0!*.log -xr0!*.bak -xr0!*.tmp "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z -r -mx1 "<span class="hljs-variable"><span class="hljs-variable">%pathbkp%</span></span>\*" -<span class="hljs-variable"><span class="hljs-variable">%pwd%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "      " curl.exe -k -X <span class="hljs-built_in"><span class="hljs-built_in">MOVE</span></span> -H "Destination:/backup/<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>"-bkp "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>" -o .\stdout curl.exe -k -X MKCOL "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>" -o .\stdout :upload <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   <span class="hljs-variable"><span class="hljs-variable">%i%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "    <span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z" curl.exe -k -T "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"/ --progress-bar -o .\stdout <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "  <span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z      " curl.exe -k "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>/<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z -o "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z --progress-bar -o .\stdout <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "    " fc /LB1 /B "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ERRORLEVEL</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> Different <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " :" <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tolog="<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z    " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging <span class="hljs-variable"><span class="hljs-variable">%tolog%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsubject=<span class="hljs-variable"><span class="hljs-variable">%tolog:"=%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "       " <span class="hljs-built_in"><span class="hljs-built_in">RD</span></span> /s/q "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"-bkp curl.exe -k -X DELETE "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"-bkp -o .\stdout <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> /q "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> :Different <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " : <span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z      " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " " <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /a i+=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%i%</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>-f <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> upload :<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>-f <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tolog="  <span class="hljs-variable"><span class="hljs-variable">%full%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z    " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging <span class="hljs-variable"><span class="hljs-variable">%tolog%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsubject=<span class="hljs-variable"><span class="hljs-variable">%tolog:"=%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   " <span class="hljs-built_in"><span class="hljs-built_in">RD</span></span> /s/q "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">ren</span></span> "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"-bkp temp curl.exe -k -X DELETE "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>" -o .\stdout curl.exe -k -X <span class="hljs-built_in"><span class="hljs-built_in">MOVE</span></span> -H "Destination:/backup/<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"-bkp -o .\stdout :<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>   <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt   curl.exe -k -T <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"/../ --progress-bar -o .\stdout <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>     <span class="hljs-variable"><span class="hljs-variable">%mailsend%</span></span> -to <span class="hljs-variable"><span class="hljs-variable">%recipient%</span></span> -from <span class="hljs-variable"><span class="hljs-variable">%user%</span></span>@yandex.ru -ssl -port <span class="hljs-number"><span class="hljs-number">465</span></span> -auth -smtp smtp.yandex.ru -user <span class="hljs-variable"><span class="hljs-variable">%user%</span></span> -pass <span class="hljs-variable"><span class="hljs-variable">%pass%</span></span> -sub "<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>: <span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span> - <span class="hljs-variable"><span class="hljs-variable">%mailsubject%</span></span>" -cs "windows-<span class="hljs-number"><span class="hljs-number">1251</span></span>" -mime-<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> "text/plain" -msg-body <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> /q <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> :loging <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> /b</code> </pre> <br><h3>  Script pour créer une archive incrémentielle </h3><br><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">chcp</span></span> <span class="hljs-number"><span class="hljs-number">1251</span></span> &gt;<span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> filebkp=server <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat user <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat pass <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat pwd <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> pass.bat recipient <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsend=mailsend1.<span class="hljs-number"><span class="hljs-number">17</span></span>b15.exe <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tolog=zero <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsubject=zero <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pathbkp=..\backup <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> pathtemp=..\temp <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> srvbkp=https://<span class="hljs-variable"><span class="hljs-variable">%user%</span></span>:<span class="hljs-variable"><span class="hljs-variable">%pass%</span></span>@webdav.yandex.ru/backup/<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> full=<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-full <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> inc=<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-inc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> h=<span class="hljs-variable"><span class="hljs-variable">%TIME:~0,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> m=<span class="hljs-variable"><span class="hljs-variable">%TIME:~3,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> s=<span class="hljs-variable"><span class="hljs-variable">%TIME:~6,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> ms=<span class="hljs-variable"><span class="hljs-variable">%TIME:~9,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curtime=<span class="hljs-variable"><span class="hljs-variable">%h%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%m%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%s%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dd=<span class="hljs-variable"><span class="hljs-variable">%DATE:~0,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mm=<span class="hljs-variable"><span class="hljs-variable">%DATE:~3,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> yyyy=<span class="hljs-variable"><span class="hljs-variable">%DATE:~6,4%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curdate=<span class="hljs-variable"><span class="hljs-variable">%yyyy%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%mm%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%dd%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> curdatetime=%curdate: =<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-variable"><span class="hljs-variable">%-%</span></span>curtime: =<span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "-----------------------------------" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "  - <span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   <span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z" <span class="hljs-number"><span class="hljs-number">7</span></span>z.exe u -xr0!*.log -xr0!*.bak -xr0!*.tmp "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%full%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z -u- -up3q3r2x2y2z0w2!"<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z "<span class="hljs-variable"><span class="hljs-variable">%pathbkp%</span></span>\*" -<span class="hljs-variable"><span class="hljs-variable">%pwd%</span></span> :upload <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   <span class="hljs-variable"><span class="hljs-variable">%i%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "   " curl.exe -k -T "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"/ --progress-bar -o .\stdout <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "       " curl.exe -k "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>/<span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z -o "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z --progress-bar -o .\stdout <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging "    " fc /LB1 /B "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>".<span class="hljs-number"><span class="hljs-number">7</span></span>z "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z &gt; <span class="hljs-built_in"><span class="hljs-built_in">nul</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ERRORLEVEL</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> Different <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " " <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tolog="<span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z    " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging <span class="hljs-variable"><span class="hljs-variable">%tolog%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsubject=<span class="hljs-variable"><span class="hljs-variable">%tolog:"=%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> :Different <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " : <span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z      " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging " " <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /a i+=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-variable"><span class="hljs-variable">%i%</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>-f <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> upload :<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>-f <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tolog="  <span class="hljs-variable"><span class="hljs-variable">%inc%</span></span>-<span class="hljs-variable"><span class="hljs-variable">%curdatetime%</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>z    " <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> :loging <span class="hljs-variable"><span class="hljs-variable">%tolog%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> mailsubject=<span class="hljs-variable"><span class="hljs-variable">%tolog:"=%</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> /q "<span class="hljs-variable"><span class="hljs-variable">%pathtemp%</span></span>"\test.<span class="hljs-number"><span class="hljs-number">7</span></span>z <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>   <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt   curl.exe -k -T <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt "<span class="hljs-variable"><span class="hljs-variable">%srvbkp%</span></span>"/../ --progress-bar -o .\stdout <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>     <span class="hljs-variable"><span class="hljs-variable">%mailsend%</span></span> -to <span class="hljs-variable"><span class="hljs-variable">%recipient%</span></span> -from <span class="hljs-variable"><span class="hljs-variable">%user%</span></span>@yandex.ru -ssl -port <span class="hljs-number"><span class="hljs-number">465</span></span> -auth -smtp smtp.yandex.ru -user <span class="hljs-variable"><span class="hljs-variable">%user%</span></span> -pass <span class="hljs-variable"><span class="hljs-variable">%pass%</span></span> -sub "<span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>: <span class="hljs-variable"><span class="hljs-variable">%mailsubject%</span></span>" -cs "windows-<span class="hljs-number"><span class="hljs-number">1251</span></span>" -mime-<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> "text/plain" -msg-body <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> /q <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> :loging <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.txt <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> %~<span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; <span class="hljs-variable"><span class="hljs-variable">%filebkp%</span></span>-log.tmp <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> /b</code> </pre><br><h3>  Nouvelles équipes: </h3><br>  call pass.bat xx x - appelle un programme externe qui renvoie la variable <b>xx</b> avec la valeur spécifiée pour l'identificateur x. <br><br>  En conséquence, la variable utilisateur se voit attribuer une valeur associée à l'identifiant 1 (nom d'utilisateur du compte yandex), pass - 2 (mot de passe du compte yandex), pwd - 3 (mot de passe pour l'archive), destinataire - 4 (mail, où envoyer le journal des opérations). <br><br>  Le script pass.bat est donné sous condition, la méthode de protection par mot de passe peut être choisie différemment, mais pour ceux-ci, cette option convient également, je donne le code le plus simple pour ce script: <br><br><pre> <code class="dos hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> /f "usebackq delims=" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (`<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> /n /v "" "%~dp0"pass.txt ^| <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> "[%<span class="hljs-number"><span class="hljs-number">2</span></span>]"`) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> newvar=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-variable"><span class="hljs-variable">%1=%</span></span>newvar:~<span class="hljs-number"><span class="hljs-number">3</span></span>%</code> </pre><br>  Lorsqu'il est appelé, ce code localise le fichier pass.txt à côté de lui et attribue à la variable dont le nom est spécifié dans le premier argument du script appeler la valeur de cette ligne du fichier pass.txt dont le numéro est indiqué dans le deuxième argument de l'appel de script.  L'emplacement des fichiers pass.bat et pass.txt n'est pas critique, tant qu'ils se trouvent dans le même répertoire que celui spécifié dans le chemin des variables système. <br><br>  <b>set mailsend = mailsend1.17b15.exe</b> - indique le programme d'envoi d'un rapport au courrier de l'utilisateur.  La lettre est envoyée depuis le compte yandex.ru, à partir duquel les fichiers sont envoyés vers le cloud. <br><br>  <b>set i = 1</b> - place le compteur de tentatives à 1 <br><br>  <b>call: loging "-----------------------------------"</b> - appelez la procédure de journalisation.  Une ligne est transmise à la procédure, qui est ensuite écrite dans 2 fichiers - le fichier journal <b>% filebkp% -log.txt</b> et un fichier séparé des opérations en cours <b>% filebkp% -log.tmp</b> , qui est ensuite envoyé à l'utilisateur sous forme de rapport sur le résultat de l'archivage. <br><br>  En conséquence, les lignes de journalisation dans le corps des scripts montrent simultanément à l'utilisateur les opérations effectuées pendant l'opération, les écrivent dans les journaux et pour moi, ce sont des commentaires dans le corps du script expliquant ce qui est fait sur les lignes suivantes. <br><br>  Par conséquent, le script de copie complète et le script de copie incrémentielle effectuent les opérations suivantes: <br><br><ol><li>  pour une archive complète - crée des copies de sauvegarde des archives actuelles sur le serveur et sur l'ordinateur local </li><li>  crée une nouvelle sauvegarde </li><li>  essayer de l'envoyer au serveur </li><li>  après l'envoi, téléchargez une copie de sauvegarde et comparez avec l'original </li><li>  si la comparaison réussit, il envoie un journal des opérations au serveur et l'utilisateur reçoit un rapport sur l'opération réussie via mailsend1.17b15.exe + pour l'archive complète, supprime les versions obsolètes de l'archive </li><li>  s'il y a une différence entre les fichiers, il essaie d'envoyer à nouveau le fichier au serveur et s'il ne parvient pas à envoyer dans les 5 tentatives, il envoie le journal des opérations au serveur et l'utilisateur signale l'échec via mailsend1.17b15.exe: </li><li>  nettoie un fichier temporaire des opérations en cours. </li></ol><br><h3>  PS </h3><br>  Ces scripts ne sont donnés qu'à titre d'exemples, il n'y a aucune envie de réécrire sous PowerShell, car  Il est important pour moi que cela fonctionne sur n'importe quel système, y compris Windows XP.  Il n'y a pas de protection contre le vol de mot de passe, ce que les experts en sécurité offriraient serait intéressant, mais la séparation du code et des mots de passe avec la possibilité de placer les mots de passe dans un autre répertoire élimine au moins la possibilité d'une erreur stupide qu'en envoyant un script à un ami, il obtiendra également des mots de passe. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437794/">https://habr.com/ru/post/fr437794/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437784/index.html">Elon Musk a expliqué pourquoi Starship sera en acier inoxydable</a></li>
<li><a href="../fr437786/index.html">SAPUI5 for dummies part 4: Un exercice complet étape par étape</a></li>
<li><a href="../fr437788/index.html">Conférence DEFCON 19. Hack MMORPG pour le plaisir et le profit. Partie 1</a></li>
<li><a href="../fr437790/index.html">Conférence DEFCON 19. Hack MMORPG pour le plaisir et le profit. 2e partie</a></li>
<li><a href="../fr437792/index.html">Les Gémeaux ont obtenu des résultats «mystérieux» en vérifiant 5 services de recherche d'ancêtres ADN</a></li>
<li><a href="../fr437796/index.html">AlphaStar a-t-il implémenté la vitesse surhumaine en tant que patch pour l'erreur d'entraînement à la simulation?</a></li>
<li><a href="../fr437800/index.html">ScrumBut dans l'équipe d'analyse: avant le décollage</a></li>
<li><a href="../fr437802/index.html">Innovate Cloud Technology: Catastrophic Cloud</a></li>
<li><a href="../fr437804/index.html">Puis-je utiliser Redux sur un serveur?</a></li>
<li><a href="../fr437806/index.html">EcmaScript 10 - JavaScript de cette année (ES2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>