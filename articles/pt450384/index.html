<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüíº üíµ üîã A hist√≥ria de um pequeno estudo de c√≥digo legado üèáüèª üçá üëå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√â bom que haja algu√©m mais experiente na equipe que mostre o que e como fazer, o que ajuntar e inclinar o que e onde baixar os melhores desenhos de bi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A hist√≥ria de um pequeno estudo de c√≥digo legado</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450384/">  √â bom que haja algu√©m mais experiente na equipe que mostre o que e como fazer, o que ajuntar e inclinar o que e onde baixar os melhores desenhos de bicicletas para 2007 em DVD.  Esta hist√≥ria √© sobre como o desejo foi dado como v√°lido, qual foi o resultado e como a crise foi superada. <br><br>  Isso aconteceu no momento em que, tendo-me parecido uma experi√™ncia med√≠ocre no desenvolvimento, eu estava procurando um lugar onde voc√™ pudesse evoluir (ou mudar) de um n√£o-j√∫nior para um j√∫nior confiante.  Nos caminhos misteriosos do Senhor, esse lugar foi encontrado, um projeto foi anexado ao local e o programador da ‚Äúvelha escola‚Äù, que escreveu mais de meninas sobre sua carreira em sistemas.  ‚Äú√ìtimo!  O projeto e, portanto, h√° dinheiro para a RFP, o mentor est√° anexado, n√≥s vivemos! ‚Äù  Eu pensei, mas ent√£o, como na descri√ß√£o de um horror t√≠pico, os her√≥is na escurid√£o enfrentaram um horror terr√≠vel ... <br><a name="habracut"></a><br>  Primeiras coisas primeiro: <br><br><h4>  1. O tamanho importa </h4><br>  Iniciamos o desenvolvimento em um mecanismo php escrito uma vez, usado para armazenar dados (aqui voc√™ pode pensar em MySQL \ PostgreSQL \ SQLite \ MongoDB \ Algo-l√°-mas-necessariamente-com-sufixo DB-caso contr√°rio- caras-n√£o entendo, mas eles n√£o adivinharam) api-gateway. <br><br>  ‚ÄúHaha, usando php, voc√™ anexa outro gateway API a ele e armazena dados nele?  N√£o √© mais f√°cil trabalhar com a API diretamente do c√≥digo js?  Ou usa DBMS + PHP? ‚Äù  - pergunte ao leitor experiente.  E ele estar√° certo.  Mas naquela √©poca, eu, que ainda n√£o tinha visto a esp√©cie, n√£o pensava assim, bem, quem sabe, caras legais provavelmente fazem isso, e os programadores da ‚Äúvelha escola‚Äù sabem melhor. <br><br>  Como fui explicado mais adiante: <br><br><ol><li>  Gateway = seguran√ßa, ningu√©m entrar√° e sair√° assim </li><li>  Gateway = armazenamento seguro de dados, voc√™ n√£o pode entrar nele + backups </li><li>  Gateway = velocidade, funciona rapidamente e sem falhas, testado pelo tempo </li><li>  O ponto de vista autorit√°rio dos programadores da ‚Äúvelha escola‚Äù √© que o seu php est√° cheio de falhas, qualquer aplicativo da Web √© hackeado por padr√£o, portanto n√£o h√° nada para armazenar dados pr√≥ximos a ele </li></ol><br>  Uma caracter√≠stica do gateway api era que os dados json eram transmitidos em uma solicita√ß√£o get.  Sim, sim, esses objetos json muito ador√°veis ‚Äã‚Äãforam submetidos √† codifica√ß√£o de URL e colocados na string de consulta.  E tudo ficaria bem, quando de repente um dia ... a dura√ß√£o da solicita√ß√£o de obten√ß√£o deixasse de ser suficiente.  Estupidamente, o json codificado em url, kanalya, n√£o se encaixava l√°!  O programador da ‚Äúvelha escola‚Äù, co√ßando a cabe√ßa, perguntou: <br>  ‚ÄúO que n√≥s vamos fazer?  Nosso json cresceu, mas n√£o percebemos ... " <br>  "Bem, talvez possamos public√°-las no correio?"  Eu sugeri, ent√£o parece ser mais correto. <br>  "Ok, passe para postar." <br>  Era o n√∫mero um. <br><br><h4>  2. Gerenciamento de tempo e backup </h4><br>  Para parafusar novas funcionalidades no projeto, foi necess√°rio implementar <br>  solicita√ß√µes CRUD correspondentes no gateway, que √© exatamente o que nosso camarada da ‚Äúvelha escola‚Äù realmente fez.  O problema era que ele fazia isso uma vez a cada 3 dias, dando "Conclu√≠do, verifique".  √Äs vezes, verifica√ß√µes mostravam que nem tudo funcionava, por exemplo, obter a lista √© aceit√°vel, adicionar um novo item n√£o √© ok.  Demorou algum tempo para corrigir e refinar, ap√≥s o qual foi poss√≠vel liberar a funcionalidade no acesso em massa.  A proposta de fazer a implementa√ß√£o de consultas no gateway por conta pr√≥pria, porque √© pelo menos mais r√°pida, foi rejeitada, porque "√© dif√≠cil l√°, voc√™ n√£o vai entender".  O resultado dessa abordagem foi o encerramento do trabalho "em mim".  Se, por exemplo, fosse necess√°rio consertar algo em massa no banco de dados, escolhendo entre 3 dias de espera e a implementa√ß√£o das corre√ß√µes por meio de consultas - escolhi a 2¬™ op√ß√£o.  Os clientes n√£o gostam de esperar particularmente, o novo lan√ßamento chegou de forma est√°vel.  Um desses introdut√≥rios, ou seja, a fixa√ß√£o em massa de um sinal para os usu√°rios de algum sinal, foi confiado a mim para implementar, havia uma hora para tudo, tudo, as autoridades estavam esperando por um relat√≥rio bonito.  Aqui nos espera como n√∫mero dois-s. <br><br>  O fato √© que o formato dos dados json transmitidos nas solicita√ß√µes implicava apenas alguns campos obrigat√≥rios, todos os outros eram arbitr√°rios, uma estrutura clara e final n√£o existia.  Por exemplo, para adicionar um usu√°rio, passei um json do formul√°rio: <br><br><pre><code class="json hljs">POST /api/users { <span class="hljs-attr"><span class="hljs-attr">"email"</span></span>:<span class="hljs-string"><span class="hljs-string">"ivanov@mail.ru"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"myEmailIsVeryBig"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_last"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_first"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name_middle"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"birth"</span></span>:<span class="hljs-string"><span class="hljs-string">"01.01.1961"</span></span>, //     ,    -    <span class="hljs-attr"><span class="hljs-attr">"living_at"</span></span>:<span class="hljs-string"><span class="hljs-string">"., .3 .4 .24"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phone_num"</span></span>:<span class="hljs-string"><span class="hljs-string">"+70000000000"</span></span> }</code> </pre> <br>  A parte opcional que foi transmitida nas solicita√ß√µes de adi√ß√£o / atualiza√ß√£o foi salva e fornecida na √≠ntegra (falarei sobre como isso foi implementado abaixo).  A linha inferior √©, o tempo n√£o p√°ra, seria necess√°rio resolver o problema - atualizar usu√°rios, colocar suas etiquetas.  Mas n√£o dirija toda a estrutura toda vez?  Deve verificar!  Eu testei em mim mesmo - transmiti apenas um campo na solicita√ß√£o de atualiza√ß√£o, verifiquei, o campo apareceu e o restante dos dados est√° no local.  A quest√£o √© fazer um loop pequeno e atualizar o restante. <br><br>  O script bufou suavemente, recebendo e transmitindo dados, e tudo parecia estar indo bem ... quando de repente - uma liga√ß√£o.  "N√£o vemos o nome dos usu√°rios no sistema!"  - relat√≥rio desse lado do fio.  ‚ÄúVamos l√°!  Bem, deu certo! ‚Äù  - Um calafrio desagrad√°vel correu pelas minhas costas.  Investiga√ß√µes posteriores mostraram que, de fato, o nome "" foi indicado no nome, embora todos os outros dados estivessem no lugar.  O que fazer em tal situa√ß√£o?  Implante o backup! <br><br>  Programador "camarada" da velha escola ", sem problemas!  Precisa de backup!  Quando √© que o √∫ltimo relevante √© feito? ‚Äù  Eu pergunto. <br><br>  "Uhh ... eu vou ver agora ....  N√£o, n√£o h√° bakapa. " <br><br>  A situa√ß√£o foi salva pelo fato de que, algumas horas antes, finalizei e testei o m√≥dulo com relat√≥rios, eu tinha uma caixa csv com todos os dados necess√°rios, o pedido foi restaurado em mais uma hora. <br><br>  A falta de documenta√ß√£o intelig√≠vel, uma descri√ß√£o dos algoritmos de opera√ß√£o, verifica√ß√µes de validade de entrada e o mais importante - backups de bancos de dados - s√£o o n√∫mero dois-s. <br><br>  Desde ent√£o, os backups come√ßaram a ser removidos todos os dias. <br><br><h4>  3. Golpe profundo </h4><br>  Tr√™mulo, mas o trabalho estava em andamento, os problemas foram resolvidos, alguns mais r√°pidos, outros mais lentos, quando de repente ... os clientes perceberam que o sistema n√£o era compreendido pelos servidores de outra pessoa e por essa atitude em rela√ß√£o ao PD e organiza√ß√£o das atividades de ZI no ISPD eles n√£o v√£o acariciar a cabe√ßa.  √â necess√°rio transferir o servidor para si mesmo. <br><br>  Por que o sistema n√£o foi originalmente transferido?  A lideran√ßa tinha uma paix√£o - centraliza√ß√£o.  A ger√™ncia sonhava com um sistema que faria tudo!  Voc√™ precisa anexar uma crian√ßa √† escola?  Voc√™ entra no sistema, em um escrit√≥rio especial, onde envia uma inscri√ß√£o.  Voc√™ precisa, digamos, pedir pizza - voc√™ entra no sistema, em outro escrit√≥rio especial, solicita pizza.  Talvez voc√™ queira se comunicar com belas senhoras / senhores?  Ao seu servi√ßo, existe um terceiro gabinete especial - voc√™ tamb√©m est√° enviando uma solicita√ß√£o para l√° e assim por diante ad infinitum. <br><br>  Vantagens - um login e senha para tudo, os dados s√£o armazenados com seguran√ßa no gateway.  Existem at√© backups.  E, lembre-se, ningu√©m vai tirar esse sistema de n√≥s!  E mesmo que isso leve embora - o que vem a seguir?  Mesmo assim, eles n√£o entender√£o o sistema de prote√ß√£o contra programadores da "velha escola" - tudo √© complicado l√°. <br><br>  O VDS com o sistema foi descarregado, atribu√≠do aos clientes, eles o implantaram, todo mundo dan√ßa e canta, beleza! <br><br>  E ent√£o uma onda de curiosidade e alguma suspeita me cobriram. <br><br>  Se nosso aplicativo da Web estiver cheio de falhas, onde est√£o os dados?  Voc√™ realmente ficou em outros servidores?  E se eles decidirem fechar o sistema de fora, tudo entrar√° em colapso? <br><br>  Uma verifica√ß√£o simples mostrou que os dados, assim como os pr√≥prios processadores de gateway, estavam no mesmo servidor.  E, n√£o, eles n√£o foram transferidos para l√° por causa da transfer√™ncia do servidor, eles estavam sempre l√°. <br>  Agora eu tinha a disposi√ß√£o o muito secreto desenvolvimento da "velha escola", que me propus a pesquisar.  √â claro que a engenharia reversa legal no estilo dos artigos da revista Hacker, com ollydbg, compensa√ß√µes e outras coisas legais, n√£o funcionou, por isso estou compartilhando o que tenho. <br>  O desenvolvimento em si foi implementado em python, havia apenas arquivos .pyc que podiam ser facilmente descompilados novamente em c√≥digo leg√≠vel.  Francamente, demorou muito tempo, at√© 25 minutos, para descobrir como isso funciona. <br><br>  Portanto, o complexo sistema desenvolvido pelo programador da ‚Äúvelha escola‚Äù, que poucos conseguem entender, consiste em: <br><br><ol><li>  O script processado pelo Apache, que realmente recebeu a solicita√ß√£o.  O que esse script fez?  Abriu uma conex√£o com uma porta localhost espec√≠fica e passou uma solicita√ß√£o para l√° com todos os seus dados.  S√≥ isso.  Os interesses v√£o al√©m. </li><li>  A parte do servidor que processou solicita√ß√µes do script.  A l√≥gica de suas a√ß√µes foi bastante interessante.  Primeiramente, n√£o havia manipula√ß√£o de dados no c√≥digo e nenhuma consulta no banco de dados; em vez disso, as fun√ß√µes de banco de dados em PL \ SQL foram chamadas.  Toda a l√≥gica, verifica√ß√µes e assim por diante, tudo foi estabelecido na fun√ß√£o de banco de dados.  50% do script era um dicion√°rio que cont√©m o nome da solicita√ß√£o, a fun√ß√£o associada a ela e os nomes dos par√¢metros da fun√ß√£o que devem corresponder aos dados transmitidos na linha de solicita√ß√£o de obten√ß√£o.  Dados JSON, se necess√°rio, foram passados ‚Äã‚Äãcomo um par√¢metro separado.  Um recurso da organiza√ß√£o da parte do servidor era a conex√£o de backup durante a autentica√ß√£o do usu√°rio.  Se o login e a senha foram encontrados no banco de dados, o ID da sess√£o foi gerado e a inst√¢ncia de conex√£o aberta foi dobrada no dicion√°rio (e foi eliminada pelo tempo limite de 10 minutos para que n√£o fosse eliminada - havia um m√©todo especial para prolongar a vida √∫til da sess√£o), a chave era o ID da sess√£o, diretamente no banco de dados n√£o armazenado.  Como exatamente o ID da sess√£o est√° associado aos dados do usu√°rio?  Afinal, h√° uma solicita√ß√£o de dados nos quais o ID do usu√°rio n√£o √© transmitido?  Funciona, o que significa que algo est√° errado aqui. </li></ol><br>  Um desenvolvimento muito dif√≠cil foi dado √† consci√™ncia com dificuldade e n√£o teve pressa em revelar os segredos h√° muito perdidos dos mestres do passado. <br><br>  Incr√≠vel (V√° para&gt; Defini√ß√£o, obrigado PhpStorm por entender PL \ SQL), incompreens√≠vel para a mente do leigo que sofre o Conhecimento Verdadeiro da Civiliza√ß√£o Perdida dos Programadores da Velha Escola.  Em geral, quando conectado, uma tabela tempor√°ria foi gerada na fun√ß√£o de verifica√ß√£o de dados de autentica√ß√£o, na qual o ID do usu√°rio foi armazenado. <br><br>  Este foi apenas o come√ßo, uma lista indicativa de vulnerabilidades s√©rias encontrada: <br><br><ul><li>  DDoS usando autentica√ß√£o em massa (as conex√µes eram reservadas e, portanto, repousavam no limite de conex√£o do DBMS, o que, dada a possibilidade de estender o tempo de vida da sess√£o, tornava poss√≠vel encher completamente a mem√≥ria com conex√µes, e o trabalho de novos usu√°rios no sistema seria imposs√≠vel); </li><li>  falta de prote√ß√£o contra for√ßa bruta (o n√∫mero de tentativas com falha de login n√£o √© detectado, n√£o √© armazenado, n√£o √© verificado; </li><li>  falta de controle sobre a√ß√µes com entidades (por exemplo, a lista de documentos solicitados pelo usu√°rio foi emitida levando em considera√ß√£o a organiza√ß√£o √† qual o usu√°rio est√° anexado e, se voc√™ souber o ID do documento, poder√° executar com √™xito a solicita√ß√£o de atualiza√ß√£o / exclus√£o do documento, e a lista de usu√°rios √© boa mesmo sem senhas que, ali√°s, eram armazenadas no banco de dados de forma clara, sem hash, podiam ser recebidas por qualquer pessoa). </li></ul><br>  E outro problema s√©rio n√£o √© um esquema formal de armazenamento de dados.  Como prometido anteriormente, estou falando sobre o armazenamento de "qualquer campo" do JSON.  N√£o, eles n√£o foram armazenados como uma linha na tabela.  Eles foram divididos em pares de valores-chave e armazenados em uma tabela separada.  Por exemplo, para usu√°rios, havia duas tabelas - users e users_data (chave da string, valor da string) - onde os dados foram realmente armazenados.  O resultado dessa abordagem foi um aumento no tempo com amostras complexas do banco de dados. <br><br>  Na verdade, isso foi suficiente para tomar e implementar a decis√£o de transferir o sistema para uma nova API, compreens√≠vel, documentada e suportada. <br><br><h4>  Moral </h4><br>  Talvez este sistema seja "Legado", e o programador da "velha escola" que o criou seja a ess√™ncia do Legado. <br><br>  No entanto, as conclus√µes s√£o as seguintes: <br><br><ol><li>  Se lhe disserem que "l√° √© dif√≠cil, voc√™ n√£o entender√°" - significa que h√° um atas completo </li><li>  Se eles s√£o esmagados pela autoridade, ent√£o algo √© impuro </li><li>  Confie, mas verifique - a seguran√ßa n√£o √© um estado, a seguran√ßa √© um processo, al√©m disso cont√≠nuo, portanto, √© melhor garantir que as qualidades declaradas sejam verdadeiras do que descobrir mais tarde que todos os usu√°rios se tornam "Ivanov Ivanov Ivanitch" de repente, mas n√£o h√° bacaps. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450384/">https://habr.com/ru/post/pt450384/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450368/index.html">Obter taxas absolutas com taxas de c√¢mbio cruzadas</a></li>
<li><a href="../pt450372/index.html">Como os algoritmos da Amazon determinam quem √© hora de descartar</a></li>
<li><a href="../pt450374/index.html">Placa de expans√£o RAM para Apple IIgs</a></li>
<li><a href="../pt450376/index.html">Como o Yandex.Taxi procura carros quando n√£o est√£o</a></li>
<li><a href="../pt450378/index.html">GitLab 11.10</a></li>
<li><a href="../pt450386/index.html">Interfaces como tipos de dados abstratos no Go</a></li>
<li><a href="../pt450394/index.html">Investiga√ß√£o de um arquivo desconhecido</a></li>
<li><a href="../pt450396/index.html">Como melhorar o seu ingl√™s escrito: dicas pr√°ticas e ferramentas √∫teis</a></li>
<li><a href="../pt450398/index.html">Os venenos mais destemidos</a></li>
<li><a href="../pt450410/index.html">Terraformer - Infraestrutura para codificar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>