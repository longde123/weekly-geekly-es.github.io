<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏣 🚋 🙇 Telegraff: Kotlin DSL for Telegram 🏩 🧒🏾 🌯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="على Habré الآلاف من المقالات حول كيفية إنشاء روبوت Telegram للغات ومنصات البرمجة المختلفة. الموضوع أبعد ما يكون عن الجديد. 


 لكن Telegraff هو أفضل إ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: Kotlin DSL for Telegram</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="شعار"></p><br><p style=";text-align:right;direction:rtl">  على Habré الآلاف من المقالات حول كيفية إنشاء روبوت Telegram للغات ومنصات البرمجة المختلفة.  الموضوع أبعد ما يكون عن الجديد. </p><br><p style=";text-align:right;direction:rtl">  لكن Telegraff هو أفضل إطار لتنفيذ روبوتات Telegram ، وسأثبت ذلك تحت الخفض. </p><a name="habracut"></a><br><h2 id="preambula" style=";text-align:right;direction:rtl">  مقدمة </h2><br><p style=";text-align:right;direction:rtl">  في عام 2015 ، كان الروبل الروسي في حمى.  كان لدي مدخرات بالدولار ودققت السعر حرفيًا كل خمس دقائق لبيع العملة بالسعر الذي أحتاجه.  الحمى التي استمرت ، تعبت وكتبت روبوت Telegram ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">TinkoffRatesBot</a> ) ، والذي يخطرك إذا وصل سعر الصرف إلى القيمة (المتوقعة). <br>  لقد تأثرت كثيرا بهذه المهمة.  كتب بوتا بسرعة كبيرة ، لكنه لم يحصل على الرضا. </p><br><p style=";text-align:right;direction:rtl"> التكامل مع Telegram ليس ولم تكن هناك مشاكل.  تم حل هذه المشكلة في بضع ساعات.  وأنا مندهش من وجود مكتبات بأكملها في Java (ذاتي ، مع رمز مثير للاشمئزاز في الجودة) للتكامل مع Telegrams ، التي كسبت أكثر من ألف نجم على Github. </p><br><p style=";text-align:right;direction:rtl">  كان التحدي الرئيسي بالنسبة لي هو نظام البرمجة النصية: يقوم المستخدم باستدعاء أمر ، على سبيل المثال ، "/ taxi" ، يسأله الروبوت سلسلة من الأسئلة ، يتم التحقق من صحة كل إجابة ويمكن أن تؤثر على ترتيب الأسئلة اللاحقة ، يتم تشكيل "النموذج" المعتاد ، ويتم إعطاء طريقة المعالجة النهائية لتشكيل استجابة. <br>  لقد فعلت ذلك ، لكن بنية الطبقات ، ومستويات التجريد ، كان كل شيء غير متجانس لدرجة أنه كان من المرير النظر إليها.  لقد تعذبني السؤال: كيف يمكن نقل ذلك بإيجاز وعضوية إلى نموذج وجوه المنحى؟ </p><br><p style=";text-align:right;direction:rtl">  كنت أرغب في الحصول على شيء بسيط ومريح ، والأهم من ذلك - أن أكون قادرًا على وصف النص بأكمله في ملف واحد معزول حتى لا أحتاج إلى عرض نصف المشروع من أجل فهم سلسلة تفاعل المستخدم. </p><br><p style=";text-align:right;direction:rtl">  كي لا نقول أن القضية كانت حادة للغاية ، لأن المهمة قد تم حلها بالفعل.  بدلا من ذلك ، في بعض الأحيان فكرت به.  كان الفكر هو Groovy DSL ، ولكن عندما وصل Kotlin ، أصبح الاختيار واضحًا.  هكذا بدا Telegraff. </p><br><p style=";text-align:right;direction:rtl">  نعم ، بالطبع ، لم تكن هناك منافسة سيفوز بها Telegraff.  والادعاء بأن Telegraff هو الأفضل لا ينبغي أن يؤخذ حرفيا.  لكن Telegraff هو نهج جديد وفريد ​​لهذا التحدي.  من السهل أن تكون الأفضل ، كونك الوحيد. </p><br><h2 id="kak-etim-polzovatsya" style=";text-align:right;direction:rtl">  كيفية استخدامها؟ </h2><br><h3 id="zavisimosti" style=";text-align:right;direction:rtl">  اعتمادا على </h3><br><p style=";text-align:right;direction:rtl">  الخطوة الأولى هي تحديد مستودع إضافي للتبعيات.  ربما في مرحلة ما سوف أنشر Telegraff في Maven Central أو في JCenter ، لكن الآن. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مخضرم</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  يبقى الحال بالنسبة للصغيرة.  لاستخدام Telegraff ، تحتاج إلى تحديد تبعية واحدة فقط لبدء تشغيل الربيع: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مخضرم</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya" style=";text-align:right;direction:rtl">  ترتيب </h3><br><p style=";text-align:right;direction:rtl">  تكوين المشروع بسيط ويمكن أن يقتصر على المعلمتين أو الثلاثة الأولى: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">telegram.access-key=123 # ① telegram.mode=webhook # ② telegram.webhook-base-url=https://ruslanys.me # ③ telegram.webhook-endpoint-url=/telegram # ④ telegram.handlers-path=handlers # ⑤ telegram.unresolved-filter.enabled=false # ⑥</code> </pre> </div></div><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  المفتاح الخاص بك إلى Telegram API. </li><li style=";text-align:right;direction:rtl">  وضع تلقي الرسائل (التحديثات) من Telegram.  يمكن أن يكون إما الاقتراع أو webhook. </li><li style=";text-align:right;direction:rtl">  إذا تم الإشارة إلى طريقة تلقي التحديثات بواسطة "webhook" ، يجب عليك تحديد المسار إلى التطبيق الخاص بك. </li><li style=";text-align:right;direction:rtl">  إذا كنت ترغب في ذلك ، يمكنك تحديد المسار الخاص بك إلى نقطة النهاية.  إذا لم يتم إعادة تعريف هذه المعلمة ، فسيتم إنشاء مسار النموذج التالي: <code>/telegram/${UUID}</code> .  قبل بدء التطبيق ، يتم تعيين العنوان المحدد كعنوان ربط الويب.  في نهاية العمل ، يتم استبدال عنوان ربط الويب لتكون قادرًا على التبديل إلى الاستقصاء في المرة التالية التي يبدأ فيها. </li><li style=";text-align:right;direction:rtl">  إذا رغبت في ذلك ، يمكنك تغيير المجلد الذي توجد به البرامج النصية للمعالجات.  بشكل افتراضي ، هذا هو مجلد <code>handlers</code> . </li><li style=";text-align:right;direction:rtl">  <code>UnresolvedFilter</code> تضمين <code>UnresolvedFilter</code> في "التسليم" ويتم تمكينه بشكل افتراضي.  في حالة عدم العثور على معالج على رسالة المستخدم ، يستجيب <code>UnresolvedFilter</code> بشيء مثل "عذرًا ، أنا لا أفهمك :(". </li></ol><br><p style=";text-align:right;direction:rtl">  حان الوقت لكتابة النصوص! </p><br><h3 id="obrabotchiki" style=";text-align:right;direction:rtl">  معالجات </h3><br><p style=";text-align:right;direction:rtl">  معالجات (البرامج النصية) هي جزء رئيسي من Telegraff.  هذا هو المكان الذي يتم فيه تعيين سلسلة تفاعل المستخدم.  خلاصة القول هي أن كل أمر ، مثل "/ start" ، "/ taxi" ، "/ help" ، هو برنامج نصي / نصي / معالج / معالج منفصل. </p><br><p style=";text-align:right;direction:rtl">  يمكن أن يحتوي البرنامج النصي على مجموعة من الخطوات (الأسئلة) التي يحتاج المستخدم إلى تنفيذها من أجل تنفيذ أمر.  بمعنى آخر ، يجب على المستخدم ملء النموذج.  ونظرًا لأن messenger من الواجهة ، فأنت بحاجة إلى التحدث وطلب المستخدم. </p><br><p style=";text-align:right;direction:rtl">  هل أحتاج إلى توضيح أن استجابات المستخدم يجب التحقق من صحتها؟  أول شيء سيفعله المستخدم هو أنه سوف يستجيب بشكل مختلف عما تتوقعه. </p><br><p style=";text-align:right;direction:rtl">  حسنًا ، في النهاية ، يمكن أن يتفرع النص البرمجي ، أي  يمكن أن تؤثر كل إجابة على سؤال في ترتيب الإجابات اللاحقة. </p><br><p style=";text-align:right;direction:rtl">  على سبيل المثال! </p><br><p style=";text-align:right;direction:rtl">  للبدء ، ضع الملف بالملحق <code>.kts</code> في المجلد مع <code>handlers</code> الموارد: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">سيناريو استدعاء سيارة أجرة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ① step&lt;String&gt;("locationFrom") { // ② question { // ③ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // ④ } validation { // ⑤ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // ⑥ } } next { state -&gt; null // ⑦ } } process { state, answers -&gt; // ⑧ val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // ⑨ // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // ⑩ } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  مفاتيح السهوب عن عمد لم تؤخذ في الثوابت.  في الإنتاج ، بالطبع ، من الأفضل تجنب هذا. </p><br><p style=";text-align:right;direction:rtl">  دعونا معرفة ذلك: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  نعلن السيناريو.  مطلوب اسم فريق واحد على الأقل.  في هذه الحالة ، هناك فريقان: "/ تاكسي" ، "تاكسي".  إذا كانت رسالة المستخدم تبدأ بهذه الكلمات ، فسيتم استدعاء المعالج المقابل. </li><li style=";text-align:right;direction:rtl">  نحدد الخطوات (الأسئلة).  مطلوب اسم خطوة فريدة ل  بعد ذلك ، يمكن الوصول إلى استجابة المستخدم بدقة بواسطة هذا المفتاح ("locationFrom"). </li><li style=";text-align:right;direction:rtl">  تحتوي كل خطوة على ثلاثة أقسام ، أولها هو السؤال نفسه.  السؤال هو قسم إلزامي يجب أن يكون حاضراً في كل خطوة.  لا يوجد أي معنى في خطوة دون سؤال. </li><li style=";text-align:right;direction:rtl">  يمكنك ملء السؤال كما يحلو لك.  في هذه الحالة ، سيُطلب من المستخدم من خلال لوحة المفاتيح تحديد أحد الخيارات: "البطاقة" أو "النقدية".  نتيجة لاستدعاء هذا الحظر ، يجب أن يكون هناك كائن من النوع <code>TelegramSendRequest</code> .  عذرًا ، لم أتمكن من التوصل إلى أي شيء أفضل من لاحقة <code>SendRequest</code> ، التي تصف البنية على أنها طلب صادر في Telegram. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="هيكل الطبقة"></li><li style=";text-align:right;direction:rtl">  الخطوة الثانية الأكثر أهمية هي التحقق من استجابة المستخدم.  يتم تحديد نوع كل خطوة (عام) ، وبالتالي ، يجب على كتلة التحقق من الصحة أن ترجع بالضبط النوع الذي يتم به تحديد الخطوة. </li><li style=";text-align:right;direction:rtl">  إذا كانت استجابة المستخدم غير مرضية ، فيمكنك طرح <code>ValidationException</code> مع توضيح النص ، ولكن نفس لوحة المفاتيح ، إذا تمت الإشارة إليه في السؤال. </li><li style=";text-align:right;direction:rtl">  قسم الخطوة الأخيرة عبارة عن كتلة تشير إلى الخطوة التالية.  بشكل افتراضي ، سيتم تنفيذ الخطوات بترتيب إعلانها ، من أعلى إلى أسفل.  ولكن يمكن أن تتأثر هذه العملية بتجاوز الكتلة المقابلة.  يمكن إرجاع إما مفتاح الخطوة التالية ( <code>String</code> ) أو "فارغة" نتيجة لتنفيذ هذه الكتلة ، مما يشير إلى أنه لا توجد خطوات أخرى وأنه قد حان الوقت لمتابعة تنفيذ الأمر. </li><li style=";text-align:right;direction:rtl">  عند إنشاء طلب مستخدم ، تكون المعالجة مطلوبة.  الحجج في lambda هي الحالة (هذا يشبه الجلسة) وردود المستخدمين. </li><li style=";text-align:right;direction:rtl">  لاحظ أن الاستجابة الفاشلة لم تعد سلسلة استجابة المستخدم ، ولكنها كائن تم معالجته بالفعل من النوع المطلوب. </li><li style=";text-align:right;direction:rtl">  يمكن أن يكون الرد على الأمر مشابهًا للفقرة 4. إذا لم يكن الرد على الأمر مطلوبًا ، فيمكنك إرجاع "خالية". </li></ol><br><p style=";text-align:right;direction:rtl">  قد لا يحتوي المعالج على خطوات على الإطلاق.  في هذه الحالة ، تحتاج فقط إلى تحديد سلوك المعالج لاستدعاء الأمر. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">النصي الترحيب</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem" style=";text-align:right;direction:rtl">  محاولة </h3><br><p style=";text-align:right;direction:rtl">  من أجل المحاولة ، قم بتفرع <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">المستودع</a> ، وقم <code>telegraff-sample</code> إلى الجهاز المحلي <code>telegraff-sample</code> مجلد <code>telegraff-sample</code> .  تكوين ، إطلاق ، اللمس! </p><br><p style=";text-align:right;direction:rtl">  بشكل عام ، <code>telegraff-sample</code> هو مشروع مستقل بشكل متعمد لا يرتبط بالوالد وحتى لديه Gradle Wrapper.  يمكنك ترك هذا المجلد فقط.  هذا هو نوع من النموذج الأصلي. </p><br><h2 id="kak-eto-ustroeno" style=";text-align:right;direction:rtl">  كيف يعمل؟ </h2><br><h3 id="telegram" style=";text-align:right;direction:rtl">  برقية </h3><br><p style=";text-align:right;direction:rtl">  التكامل مع Telegram بسيط للغاية ويتم تنفيذه في <a href=""><code>TelegramApi</code></a> . </p><br><p style=";text-align:right;direction:rtl">  تم تنفيذ كل طريقة بشكل متعمد بشكل فردي بسبب عدد من الظروف: بدءًا من استخدام Spring's RestTemplate (واختباراته) ، إلى خصوصية Telegram API. </p><br><p style=";text-align:right;direction:rtl">  كما ترى من التكوين ، هناك نوعان من عملاء واجهة برمجة التطبيقات هذه في Telegraff: <a href="">PollingClient</a> ، <a href="">WebhookClient</a> .  اعتمادا على التكوين ، سيتم الإعلان عن صندوق معين. </p><br><p style=";text-align:right;direction:rtl">  وعلى الرغم من أن طرق تلقي التحديثات (رسائل جديدة) تختلف عن Telegram ، إلا أن جوهرها لم يتغير ويتلخص في شيء واحد - نشر حدث ( <a href=""><code>TelegramUpdateEvent</code></a> ) حول الرسائل الجديدة من خلال <code>EventPublisher</code> (نمط "المراقب").  إذا كنت ترغب في ذلك ، يمكنك تنفيذ المستمع الخاص بك عن طريق الاشتراك في هذا النوع من الأحداث.  طبقة منطقية ، كما يبدو لي ، تجريدية ، لأنه لا يهم مطلقًا كيف تم استلام الرسالة. </p><br><h3 id="filtry" style=";text-align:right;direction:rtl">  مرشحات </h3><br><p style=";text-align:right;direction:rtl">  بمجرد استلام رسالة جديدة ، يجب معالجتها والرد على المستخدم.  للقيام بذلك ، تحتاج الرسالة إلى الانتقال عبر سلسلة التصفية. </p><br><p style=";text-align:right;direction:rtl">  هذا مشابه لمرشحات Java EE المألوفة لمبرمجي Java.  الفرق الوحيد هو أن ما يسمى بالمعالجات (إذا رسمنا موازٍ مع Java EE ، فهذه هي Servlets) ليست مستقلة عن المرشحات ، ولكنها جزء منها. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="سلسلة مرشح"></p><br><p style=";text-align:right;direction:rtl">  لذلك ، يتم ترشيح الفلاتر ويمكن أن تسمح للرسائل بالذهاب أبعد من السلسلة ، ربما لا. </p><br><p style=";text-align:right;direction:rtl">  <code>LoggingFilter</code> الواضح أن <code>LoggingFilter</code> هو <code>LoggingFilter</code> ذي الأولوية العليا (الأول) الذي سيتم استدعاؤه كجزء من معالجة رسالة جديدة.  يسجل المعلومات على رسالة واردة ويرسلها إلى أسفل السلسلة.  أضفت عمدا <code>LoggingFilter</code> كمثال.  في الواقع ، قد لا يكون ذلك منطقيا ، لأن  يتم تسجيل الرسائل الواردة على مستوى العميل. </p><br><p style=";text-align:right;direction:rtl">  المرشح التالي هو <code>CancelFilter</code> .  إنه يعمل بشكل أساسي مع <code>HandlersFilter</code> وهو مكمل له.  مهمته بسيطة: إذا أراد المستخدم التخلي عن البرنامج النصي الحالي ، فيمكنه كتابة "/ إلغاء" أو "إلغاء" ويجب إلغاء حالته (الجلسة).  يمكنه بدء أي سيناريو جديد دون إكمال السيناريو السابق.  لهذا السبب ، قم <code>CancelFilter</code> "أعلى" (الأولوية). </p><br><p style=";text-align:right;direction:rtl">  <code>HandlersFilter</code> هو المرشح الرئيسي في العملية الحالية.  هذا المرشح هو الذي يخزن حالة دردشات المستخدم ، ويجد ويدعو المعالج المطلوب (البرنامج النصي) ، ويطبق كتل التحقق من الصحة ، ويحدد ترتيب الخطوات ويستجيب للمستخدم. </p><br><p style=";text-align:right;direction:rtl">  إذا لم يعثر <code>HandlersFilter</code> على أي معالجات مناسبة لرسالة المستخدم ، سواء في الجلسة أو في المحتوى ، يتم إرسال الرسالة إلى أسفل السلسلة.  مرشح المدقع هو <code>UnresolvedFilter</code> .  هذا مرشح يعرف أنه الأخير ، وبالتالي فإن وظيفته بسيطة: إذا وصلوا إلي ، فإن كيفية الرد على رسالة غير واضحة ، سأقول أنني لم أفهم شيئًا.  يبدو لي أنه من الأفضل تلقي بعض الرسائل على الأقل من برنامج الروبوت إذا لم يكن يعرف كيفية الرد ، بدلاً من تلقي أي شيء على الإطلاق. </p><br><p style=";text-align:right;direction:rtl">  لإضافة عامل التصفية الخاص بك ، يلزمك إعلان Bean من فئة <code>TelegramFilter</code> وتحديد التعليق التوضيحي <code>@TelegramFilterOrder(ORDER_NUMBER)</code> . </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">مثال مرشح</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  هذه هي الطريقة التي تنفذ بها <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">TinkoffRatesBot</a> "آلة حاسبة".  بدون الاتصال بأي برنامج نصي وأمر ، يمكنك إرسال رقم ، على سبيل المثال ، "1000" ، أو حتى تعبير كامل ، على سبيل المثال ، "4500 * 3 - 12000".  سوف يحسب الروبوت نتيجة التعبير ، ويطبق أسعار الصرف الحالية على النتيجة ويعرض معلومات عنها.  في الواقع ، نتيجة هذه الإجراءات هي تنفيذ <code>CalculationFilter</code> ، والذي يقع في السلسلة أسفل <code>HandlersFilter</code> ، ولكن أعلى <code>UnresolvedFilter</code> . </p><br><h3 id="obrabotchiki-1" style=";text-align:right;direction:rtl">  معالجات </h3><br><p style=";text-align:right;direction:rtl">  نظام البرمجة النصية Telegraff (معالجات) مبني على Kotlin DSL.  باختصار ، يدور حول لامبدا وبناة. </p><br><p style=";text-align:right;direction:rtl">  أنا لا أرى وجهة نظر بشكل منفصل عرض Kotlin DSL ، ل  هذه محادثة مختلفة تمامًا.  هناك <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وثائق</a> كبيرة من <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">JetBrains</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وتقرير</a> شامل من <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy" style=";text-align:right;direction:rtl">  الفروق الدقيقة </h3><br><p style=";text-align:right;direction:rtl">  هذا القسم مخصص للميزات الحالية.  كلهم ، في رأيي ، ليسوا مهمين ، بعضهم يمكن إصلاحه ، البعض الآخر لا يمكن إصلاحه.  ولكن عليك أن تعرف عن هذه الجوانب. </p><br><p style=";text-align:right;direction:rtl">  إذا كنت ترغب في المشاركة أو معرفة كيفية تصحيح نقطة أو نقطة أخرى من هذا القسم ، سأكون ممتنًا للغاية. </p><br><h4 id="telegram-1" style=";text-align:right;direction:rtl">  برقية </h4><br><p style=";text-align:right;direction:rtl">  ربما لم يتم وصف طبقة التكامل مع Telegram بالكامل.  فقط تلك الأساليب التي كنت بحاجة إلى تنفيذها.  إذا كان هناك شيء تفتقر إليه شخصيًا ، <a href=""><code>TelegramApi</code></a> بتصحيح <a href=""><code>TelegramApi</code></a> وإرسال PR! </p><br><p style=";text-align:right;direction:rtl">  من بين الأجزاء المهمة في الوقت الحالي عدم وجود دعم لوحة المفاتيح المضمنة (وهذا هو عندما تكون لوحة المفاتيح مباشرة أسفل الرسالة الموجودة في الشريط).  تتفاقم المهمة بسبب الحاجة إلى "إدخال" لوحات المفاتيح المضمنة بشكل صحيح في الهيكل الحالي بحيث تظل بسيطة ومريحة ومعزولة.  هناك بالفعل فكرة جيدة لتنفيذ هذه الوظيفة ، ولكن لم يتم تنفيذها واختبارها بأي شكل من الأشكال. </p><br><h4 id="fat-jar" style=";text-align:right;direction:rtl">  جرة الدهون </h4><br><p style=";text-align:right;direction:rtl">  لسوء الحظ ، يمكن أن تواجه بعض المكتبات ، مثل <code>JRuby</code> وربما <code>Kotlin Embedded Compiler</code> (اللازمة لتجميع البرامج النصية) مشاكل كجزء من <code>Fat JAR</code> .  <code>Fat JAR</code> هو عندما يتم تعبئة الكود الخاص بك وكل التبعيات في ملف واحد ( <code>*.jar</code> ). </p><br><p style=";text-align:right;direction:rtl">  لحل هذه المشكلة ، يمكنك فك التبعيات في وقت التشغيل.  وهذا هو ، عند بدء تشغيل التطبيق ، يتم نشر التبعية JAR من الحزمة الرئيسية في مكان ما على القرص ويشار إلى classpath قبل ذلك.  هذا سهل جدًا من خلال <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">تكوين</a> <code>bootJar</code> : </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">التكوين المساعد</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ومع ذلك ، من أجل الرجوع من معالجات (البرامج النصية) إلى حبوبك (الخدمات ، على سبيل المثال) ، يجب أيضًا تفريغها.  الذي ، من حيث المبدأ ، يلغي فائدة هذا النهج. </p><br><p style=";text-align:right;direction:rtl">  كما أراها ، يظل <code>application</code> المكوّن الإضافي <code>application</code> Gradle الطريقة الأكثر موثوقية وبساطة وملاءمة.  علاوة على ذلك ، إذا كنت تقوم بتعبئة التطبيق الخاص بك ، فلن يكون هناك اختلاف حسب النتيجة. </p><br><p style=";text-align:right;direction:rtl">  حول كل هذا كتبت بشيء من التفصيل <a href="">هنا</a> . </p><br><h4 id="poryadok-inicializacii" style=";text-align:right;direction:rtl">  ترتيب التهيئة </h4><br><p style=";text-align:right;direction:rtl">  هنا أود أن أشير إلى حالتين. </p><br><p style=";text-align:right;direction:rtl">  أولاً ، إذا نظرت إلى سيناريو استدعاء سيارة أجرة ، يمكنك أن ترى أن فئة <code>enum</code> محددة أعلى من استدعاء <code>handler(...)</code> .  يتم فرض هذه الضرورة من خلال حقيقة أن <code>handler</code> هو استدعاء دالة.  مكالمة دالة ، والنتيجة التي يجب أن تكون بعض البنية ، والتي سوف تستخدم Telegraff في وقت لاحق.  إذا ، وفقًا لنتائج تنفيذ البرنامج النصي الخاص بك ، لا يمكن للمصنع إحضار النتيجة إلى النوع المطلوب ، فسيحدث خطأ في مرحلة التهيئة. </p><br><p style=";text-align:right;direction:rtl">  ثانياً ، عليك أن تتذكر أنه يمكن تهيئة البرامج النصية في وقت أبكر من تطبيقك وفولك بالكامل.  على سبيل المثال ، إذا وضعت رابطًا لسياق في متغير ثابت وحاولت الحصول على بعض الخدمات على السطر الأول في ملف البرنامج النصي ، فقد يتضح أن السياق لن يحتوي عليه ، لأن  لم تتم تهيئته بعد.  لتجنب مثل هذه المشكلات ، استخدم طريقة Telegraff.  إنه يضمن تهيئة السياق وأن جميع الحبوب اللازمة متوفرة.  مثال يمكن رؤيته <a href="">هنا</a> . </p><br><h2 id="zaklyuchenie" style=";text-align:right;direction:rtl">  استنتاج </h2><br><p style=";text-align:right;direction:rtl">  أردت أن أحاول - شوكة ، <br>  أردت إصلاحه - إرسال العلاقات العامة ، <br>  أردت أن أشكر - وضع علامة النجمة في جيثب ، مثل هذا المنصب وأخبر أصدقائك! </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مستودع المشروع</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar445072/">https://habr.com/ru/post/ar445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar445060/index.html">تنظيم عمليات البحث عن البيانات باستخدام مستودعات بيانات مفتاح الربيع</a></li>
<li><a href="../ar445062/index.html">تنسيق العرض التقديمي الحديث؟</a></li>
<li><a href="../ar445064/index.html">المعركة من أجل صافي الحياد - فرصة للعودة</a></li>
<li><a href="../ar445066/index.html">كيف أكتب ملاحظات الرياضيات على LaTeX في Vim</a></li>
<li><a href="../ar445070/index.html">ملخص المواد المثيرة للاهتمام لمطور الهاتف المحمول رقم 291 (18 مارس - 24 مارس)</a></li>
<li><a href="../ar445074/index.html">برمجة قاعدة LibreOffice. الجزء 1</a></li>
<li><a href="../ar445076/index.html">قدم عملاق تكنولوجيا المعلومات جدار الحماية المعرفة</a></li>
<li><a href="../ar445078/index.html">من المرجح أن تحمي فيزياء الكم الشبكات الكهربائية الأمريكية من المتسللين</a></li>
<li><a href="../ar445080/index.html">في روسيا ، سيتم إنشاء "السكك الحديدية الرقمية"</a></li>
<li><a href="../ar445082/index.html">في الشهر الماضي ، أطلقنا على Zuckerberg اسم المعتوه. تصحيح: في الواقع ، هو وفيسبوك له هو مجرد عار سخيف</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>