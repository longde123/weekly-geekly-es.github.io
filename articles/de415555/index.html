<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨 🚹 🎲 Die Rückseite des Neuromancers. Teil 3: Fertiges Rendern, mach das Spiel 👨‍👧‍👧 📊 🖲️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo, dies ist der dritte Teil einer Reihe meiner Veröffentlichungen, die sich mit der umgekehrten Entwicklung von Neuromancer befassen - einer Video...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Rückseite des Neuromancers. Teil 3: Fertiges Rendern, mach das Spiel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415555/"><img src="https://habrastorage.org/webt/wn/4k/jm/wn4kjm-p2fyta0emos5ufhkop_0.png"><br><p>  Hallo, dies ist der dritte Teil einer Reihe meiner Veröffentlichungen, die sich mit der umgekehrten Entwicklung von Neuromancer befassen - einer Videospiel-Verkörperung des gleichnamigen Romans von William Gibson. </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Rückseite des Neuromancers.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1: Sprites</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Rückseite des Neuromancers.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2: Schriftart rendern</a> </blockquote><p>  Dieser Teil mag etwas chaotisch erscheinen.  Tatsache ist, dass das meiste, was hier beschrieben wird, zum Zeitpunkt des Schreibens des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen</a> fertig war.  Da seitdem bereits zwei Monate vergangen sind und ich leider nicht die Gewohnheit habe, Arbeitsnotizen zu führen, habe ich einfach einige Details vergessen.  Aber wie es ist, lass uns gehen. </p><a name="habracut"></a><br><hr><br><p> <em>[Nachdem ich gelernt hatte, Zeilen zu drucken, wäre es logisch, die Konstruktion von Dialogfeldern weiter umzukehren.</em>  <em>Aber aus irgendeinem Grund, der mir entgangen ist, habe ich mich stattdessen vollständig mit der Analyse des Renderingsystems befasst.]</em> Wieder konnte ich den Anruf lokalisieren, der zuerst etwas auf dem Bildschirm anzeigt: <code>seg000:0159: call sub_1D0B2</code> .  "Alles" ist in diesem Fall der Cursor und das Hintergrundbild des Hauptmenüs: </p><br><p><img src="https://habrastorage.org/webt/9l/9h/yq/9l9hyqeu9n7m8vyt8iizlz5wnze.png"><br></p><br><p>  Es ist bemerkenswert, dass die Funktion <code>sub_1D0B2</code> <em>[im Folgenden - <code>render</code> ]</em> keine Argumente hat. Dem ersten Aufruf gehen jedoch zwei, fast identische Codeabschnitte voraus: </p><br><pre> <code class="hljs perl">loc_100E5: loc_10123: mov ax, <span class="hljs-number"><span class="hljs-number">2</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">2</span></span> mov dx, seg seg009 mov dx, seg seg01<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> dx <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> dx <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">506</span></span>Ah mov ax, <span class="hljs-number"><span class="hljs-number">5076</span></span>h ; <span class="hljs-string"><span class="hljs-string">"cursors.imh"</span></span>, <span class="hljs-string"><span class="hljs-string">"title.imh"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call load_imh call load_imh ; load_imh(res, offt, seg) add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ah</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_123F8</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_123F8</span></span></span><span class="hljs-function"> </span></span>; sub_123F8(<span class="hljs-number"><span class="hljs-number">0</span></span>), sub_123F8(<span class="hljs-number"><span class="hljs-number">10</span></span>) add sp, <span class="hljs-number"><span class="hljs-number">2</span></span> add sp, <span class="hljs-number"><span class="hljs-number">2</span></span> cmp word_5AA92, <span class="hljs-number"><span class="hljs-number">0</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">1</span></span> jz short loc_10123 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg010</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seg009</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 64</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ah</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A0h</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_1CF5B</span></span></span><span class="hljs-function"> </span></span>; sub_1CF5B(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, seg01<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sp</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ch</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_1CF5B</span></span></span><span class="hljs-function"> </span></span>; sub_1CF5B(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, seg009, <span class="hljs-number"><span class="hljs-number">0</span></span>) add sp, 0Ch</code> </pre> <br><p>  Vor dem Aufruf von <code>render</code> werden die Cursor ( <code>cursors.imh</code> ) und der Hintergrund ( <code>title.imh</code> ) in den Speicher ( <code>load_imh</code> ist das umbenannte <code>sub_126CB</code> aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ersten Teil</a> ) in das neunte bzw. zehnte Segment entpackt.  Eine oberflächliche Untersuchung der Funktion <code>sub_123F8</code> brachte mir keine neuen Informationen, aber ich habe nur die Argumente von <code>sub_1CF5B</code> und die folgenden Schlussfolgerungen gezogen: </p><br><ul><li>  Die Argumente 4 und 5 stellen zusammen die Adresse des dekomprimierten Sprites dar ( <code>segment:offset</code> ). </li><li>  Die Argumente 2 und 3 sind wahrscheinlich Koordinaten, da diese Zahlen mit dem Bild korrelieren, das nach dem Aufruf von <code>render</code> angezeigt wird. </li><li>  Das letzte Argument kann das Flag für die Deckkraft des Hintergrunds des Sprites sein, da die entpackten Sprites einen schwarzen Hintergrund haben und wir den Cursor ohne diesen auf dem Bildschirm sehen. </li></ul><br><p>  Mit dem ersten Argument <em>[und gleichzeitig mit dem Rendern im Allgemeinen] wurde</em> alles klar, nachdem <code>sub_1CF5B</code> .  Tatsache ist, dass sich im Datensegment, beginnend mit der Adresse <code>0x3BD4</code> , ein Array von 11 Strukturen des folgenden Typs befindet: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sprite_layer_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> update; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dleft; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dtop; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sprite_segment; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sprite_pixels; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> _sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> _sprite_segment; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> _sprite_pixels; } <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>;</code> </pre> <br><p>  Ich nenne dieses Konzept Sprite-Kette.  Tatsächlich fügt die Funktion <code>sub_1CF5B</code> (im Folgenden <code>add_sprite_to_chain</code> ) das ausgewählte Sprite zur Kette hinzu.  Auf einem 16-Bit-Computer hätte es ungefähr die folgende Signatur: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> g_sprite_chain[<span class="hljs-number"><span class="hljs-number">11</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_sprite_to_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> segment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opaque)</span></span></span></span>;</code> </pre> <br><p>  Es funktioniert so: </p><br><ul><li>  Das erste Argument ist der Index im Array <code>g_sprite_chain</code> . </li><li>  Das <code>left</code> und das <code>top</code> Argument werden in die <code>g_sprite_chain[index].left</code> und <code>g_sprite_chain[index].top</code> . </li><li>  Der Sprite-Header (die ersten 8 Bytes im <code>segment:offset</code> ) wird in das <code>g_sprite_chain[index].sprite_hdr</code> kopiert. <code>g_sprite_chain[index].sprite_hdr</code> <code>imh_hdr_t</code> (vom ersten Teil in <code>rle_hdr_t</code> umbenannt): </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> unknown; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> height; } <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>;</code> </pre> <br><ul><li>  Das Feld <code>g_sprite_chain[index].sprite_segment</code> zeichnet den Wert des <code>segment</code> . </li><li>  In das <code>g_sprite_chain[index].sprite_pixels</code> wird ein Wert geschrieben, der dem <code>offset + 8</code> <code>sprite_segment:sprite_pixels</code> ist die Adresse der Bitmap des hinzugefügten Sprites. </li><li>  Die <code>sprite_hdr</code> , <code>sprite_segment</code> und <code>sprite_pixels</code> in <code>_sprite_hdr</code> , <code>_sprite_segment</code> und <code>_sprite_pixels</code> <em>[warum?</em>  <em>- Ich habe keine Ahnung, und dies ist nicht der einzige Fall einer solchen Vervielfältigung von Feldern</em> . </li><li>  In das Feld <code>g_sprite_chain[index].flags</code> Wert gleich <code>1 + (opaque &lt;&lt; 4)</code> geschrieben <code>1 + (opaque &lt;&lt; 4)</code> .  Dieser Datensatz bedeutet, dass das erste Bit des <code>flags</code> Werts die "Aktivität" der "aktuellen" Ebene "und das fünfte Bit die <strong>Deckkraft</strong> ihres Hintergrunds angibt.  <em>[Meine Zweifel an der Transparenzflagge wurden ausgeräumt, nachdem ich ihre Wirkung auf das angezeigte Bild experimentell getestet hatte.</em>  <em>Wenn Sie den Wert des fünften Bits zur Laufzeit ändern, können Sie diese Artefakte beobachten]:</em> <br><img src="https://habrastorage.org/webt/9z/i8/ui/9zi8uizaa3s9fwsqke4rwa_3jqa.png"><br></li></ul><br><p>  Wie bereits erwähnt, hat die <code>g_sprite_chain</code> keine Argumente, benötigt sie jedoch nicht - sie arbeitet direkt mit dem Array <code>g_sprite_chain</code> und überträgt abwechselnd die "Ebenen" vom letzten ( <code>g_sprite_chain[10]</code> - Hintergrund) zum ersten ( <code>g_sprite_chain[0]</code> ) in den <em>VGA-</em> Speicher <code>g_sprite_chain[0]</code> - Vordergrund).  Die <code>sprite_layer_t</code> Struktur bietet alles Notwendige dafür und noch mehr.  Ich spreche über die nicht überprüften Felder <code>update</code> , <code>dleft</code> und <code>dtop</code> . </p><br><p>  Tatsächlich zeichnet die Renderfunktion <strong>NICHT ALLE</strong> Sprites in jedem Frame neu.  Ein Wert ungleich Null im Feld <code>g_sprite_chain.update</code> gibt an, dass das aktuelle Sprite neu gezeichnet werden muss.  Angenommen, wir bewegen den Cursor ( <code>g_sprite_chain[0]</code> ), dann passiert so etwas im Mausbewegungshandler: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse_move_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].update = <span class="hljs-number"><span class="hljs-number">1</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft = mouse_x - g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].left; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop = mouse_y - g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].top; }</code> </pre> <br><p>  Wenn die Steuerung an die <code>g_sprite_chain[0]</code> wird, sieht diese nach Erreichen der <code>g_sprite_chain[0]</code> , dass sie aktualisiert werden muss.  Dann: </p><br><ul><li>  Der Schnittpunkt des Bereichs, den das Cursor-Sprite vor der Aktualisierung mit allen vorherigen Ebenen einnimmt, wird berechnet und gezeichnet. </li><li>  Sprite-Koordinaten werden aktualisiert: </li></ul><br><pre> <code class="hljs powershell">g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].update = <span class="hljs-number"><span class="hljs-number">0</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].left += g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dleft = <span class="hljs-number"><span class="hljs-number">0</span></span>; g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].top += g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop g_sprite_chain[<span class="hljs-number"><span class="hljs-number">0</span></span>].dtop = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br><ul><li>  Das Sprite wird an den aktualisierten Koordinaten gezeichnet. </li></ul><br><p>  Dies minimiert die Anzahl der von der <code>render</code> Operationen. </p><br><hr><br><p>  Es war nicht schwierig, diese Logik zu implementieren, obwohl ich sie ziemlich vereinfacht habe.  Unter Berücksichtigung der Rechenleistung moderner Computer können wir es uns leisten, alle 11 Ketten-Sprites in jedem Frame neu zu zeichnen. <code>.dleft</code> <code>.dtop</code> <code>g_sprite_chain.update</code> , <code>.dleft</code> , <code>.dtop</code> und die damit verbundene Verarbeitung.  Eine weitere Vereinfachung betrifft die Behandlung des Opazitätsflags.  Im ursprünglichen Code wird für jedes transparente Pixel im Sprite der Schnittpunkt mit dem ersten undurchsichtigen Pixel in den unteren Ebenen gesucht.  Ich verwende jedoch den 32-Bit-Videomodus und kann daher nur den Wert des Transparenzbytes im <em>RGBA-</em> Schema ändern.  Als Ergebnis habe ich folgende Funktionen zum Hinzufügen (Löschen) eines Sprites zu (von) einer Kette (n) erhalten: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sprite_layer_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *sprite_pixels; <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span> _sprite_hdr; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *_sprite_pixels; } <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> g_sprite_chain[<span class="hljs-number"><span class="hljs-number">11</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_sprite_to_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *sprite, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opaque)</span></span></span><span class="hljs-function"> </span></span>{ assert(n &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> *layer = &amp;g_sprite_chain[n]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(layer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>)); layer-&gt;left = left; layer-&gt;top = top; memmove(&amp;layer-&gt;sprite_hdr, sprite, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>)); layer-&gt;sprite_pixels = sprite + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>); memmove(&amp;layer-&gt;_sprite_hdr, &amp;layer-&gt;sprite_hdr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)); layer-&gt;flags = ((opaque &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">16</span></span>) | <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove_sprite_from_chain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ assert(n &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span> *layer = &amp;g_sprite_chain[n]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(layer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>)); }</code> </pre> </div></div><br><p>  Die Funktion zum Übertragen einer Schicht in einen <em>VGA-</em> Puffer ist wie folgt: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_to_vga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pixels, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bg_transparency)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_sprite_to_vga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">sprite_layer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *sprite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> top = sprite-&gt;top; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> left = sprite-&gt;left; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> w = sprite-&gt;sprite_hdr.width * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> h = sprite-&gt;sprite_hdr.height; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bg_transparency = ((sprite-&gt;flags &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *pixels = sprite-&gt;sprite_pixels; draw_to_vga(left, top, w, h, pixels, bg_transparency); }</code> </pre> <br><p>  Die Funktion <code>draw_to_vga</code> ist die gleichnamige Funktion, die im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zweiten Teil beschrieben wurde</a> , jedoch mit einem zusätzlichen Argument, das die Transparenz des Bildhintergrunds angibt.  Fügen <code>draw_sprite_to_vga</code> am Anfang der <code>draw_sprite_to_vga</code> Aufruf <code>draw_sprite_to_vga</code> (der Rest des Inhalts wurde aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zweiten Teil</a> migriert): </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(g_sprite_chain[i].flags &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } draw_sprite_to_vga(&amp;g_sprite_chain[i]); } ... }</code> </pre> <br><p>  Ich habe auch eine Funktion geschrieben, die die Position des Cursor-Sprites abhängig von der aktuellen Position des Mauszeigers ( <code>update_cursor</code> ) <code>update_cursor</code> , und einen einfachen Ressourcenmanager.  Wir machen all diese Arbeit zusammen: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span> { SCI_CURSOR = <span class="hljs-number"><span class="hljs-number">0</span></span>, SCI_BACKGRND = <span class="hljs-number"><span class="hljs-number">10</span></span>, SCI_TOTAL = <span class="hljs-number"><span class="hljs-number">11</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> g_cursors[<span class="hljs-number"><span class="hljs-number">399</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* seg009 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> g_background[<span class="hljs-number"><span class="hljs-number">32063</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* seg010 */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ ... assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"CURSORS.IMH"</span></span>, g_cursors)); add_sprite_to_chain(SCI_CURSOR, <span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, g_cursors, <span class="hljs-number"><span class="hljs-number">0</span></span>); assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"TITLE.IMH"</span></span>, g_background)); add_sprite_to_chain(SCI_BACKGRND, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, g_background, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sfRenderWindow_isOpen(g_window)) { ... update_cursor(); render(); } ... }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Cursor.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lw/ji/sm/lwjismkxi7ewlzw9m9zahx3imjy.gif"></div></div><br><hr><br><p>  Okay, für ein vollwertiges Hauptmenü reicht das Menü selbst eigentlich nicht aus.  Es ist Zeit, zur Umkehrung der Dialogfelder zurückzukehren.  <em>[Beim letzten Mal habe ich <code>draw_frame</code> Funktion <code>draw_frame</code> , die das Dialogfeld bildet, und teilweise die Funktion <code>draw_string</code> , wobei nur die <code>draw_string</code> von dort übernommen wurde.] Als</em> ich die <code>add_sprite_to_chain</code> Funktion <code>draw_frame</code> , stellte ich fest, dass dort die Funktion <code>add_sprite_to_chain</code> verwendet wurde - nichts Überraschendes, nur ein Dialogfeld hinzuzufügen in Sprite-Kette.  Es war notwendig, sich mit der Positionierung des Textes innerhalb des Dialogfelds zu befassen.  Ich <code>draw_string</code> Sie daran erinnern, wie der Aufruf von <code>draw_string</code> aussieht: </p><br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5098</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call draw_string ; draw_string(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p>  und die Struktur, die <code>draw_frame</code> <em>[hier ist ein wenig voraus, da ich die meisten Elemente umbenannt habe, nachdem ich <code>draw_string</code> vollständig herausgefunden <code>draw_string</code> .</em>  <em>Übrigens gibt es hier, wie im Fall von <code>sprite_layer_t</code> , eine Duplizierung von Feldern]</em> : </p><br><pre> <code class="hljs powershell">typedef struct neuro_dialog_t { uint16_t left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FA</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x20 uint16_t top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FC</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x98 uint16_t right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x65FE</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x7F uint16_t bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6600</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xAF uint16_t inner_left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6602</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x28 uint16_t inner_top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6604</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t inner_right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6604</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t inner_bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6608</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA7 uint16_t _inner_left; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660A</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x28 uint16_t _inner_top; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660C</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA0 uint16_t _inner_right; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x660E</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x77 uint16_t _inner_bottom; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6610</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>xA7 uint16_t flags; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6612</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x06 uint16_t unknown; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x6614</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x00 uint8_t padding[<span class="hljs-number"><span class="hljs-number">192</span></span>] // ... uint16_t width; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66D6</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x30 uint16_t pixels_offset; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66D8</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x02 uint16_t pixels_segment; // word[<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">x66DA</span></span>]: <span class="hljs-number"><span class="hljs-number">0</span></span>x22FB } neuro_dialog_t;</code> </pre> <br><p>  Anstatt zu erklären, was hier ist, wie und warum, lasse ich einfach dieses Bild: </p><br><img src="https://habrastorage.org/webt/db/tf/nw/dbtfnw8fn1qx9aktubuvwojuw7y.png"><br><p>  Die Variablen <code>x_offt</code> und <code>y_offt</code> sind das zweite und dritte Argument für die Funktion <code>draw_string</code> .  Basierend auf diesen Informationen war es einfach, eigene Versionen von <code>draw_frame</code> und <code>draw_text</code> , nachdem diese in <code>build_dialog_frame</code> und <code>build_dialog_text</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_dialog_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">neuro_dialog_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> top, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pixels)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_dialog_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">neuro_dialog_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dialog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x_offt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y_offt)</span></span></span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span> { SCI_CURSOR = <span class="hljs-number"><span class="hljs-number">0</span></span>, SCI_DIALOG = <span class="hljs-number"><span class="hljs-number">2</span></span>, ... } <span class="hljs-keyword"><span class="hljs-keyword">spite_chain_index_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_dialog = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">neuro_dialog_t</span></span> g_menu_dialog; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ ... assert(g_dialog = <span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">8192</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); build_dialog_frame(&amp;g_menu_dialog, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, g_dialog); build_dialog_text(&amp;g_menu_dialog, <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); add_sprite_to_chain(SCI_DIALOG, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, g_dialog, <span class="hljs-number"><span class="hljs-number">1</span></span>); ... }</code> </pre> <br><img src="https://habrastorage.org/webt/ms/xt/bg/msxtbgydwxelkcfgng8vdud10ee.png"><br><p>  Der Hauptunterschied zwischen meinen Versionen und den Originalversionen besteht darin, dass ich absolute Werte für die Pixelgröße verwende - es ist einfacher. </p><br><hr><br><p>  Schon damals war ich mir sicher, dass der Codeabschnitt unmittelbar nach dem Aufruf von <code>build_dialog_text</code> für die Erstellung der Schaltflächen verantwortlich war: </p><br><pre> <code class="hljs perl"> ... mov ax, <span class="hljs-number"><span class="hljs-number">5098</span></span>h ; <span class="hljs-string"><span class="hljs-string">"New/Load"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax call build_dialog_text ; build_dialog_text(<span class="hljs-string"><span class="hljs-string">"New/Load"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) add sp, <span class="hljs-number"><span class="hljs-number">6</span></span> mov ax, <span class="hljs-number"><span class="hljs-number">6</span></span>Eh ; <span class="hljs-string"><span class="hljs-string">'n'</span></span> -  <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_181A3</span></span></span><span class="hljs-function"> </span></span>; sub_181A3(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'n'</span></span>) add sp, 0Ah mov ax, <span class="hljs-number"><span class="hljs-number">6</span></span>Ch ; <span class="hljs-string"><span class="hljs-string">'l'</span></span> -      <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax mov ax, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ax <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mov</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function">, 5 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ax</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_181A3</span></span></span><span class="hljs-function"> </span></span>; sub_181A3(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'l'</span></span>)</code> </pre> <br><p>  Es geht nur um diese generierten Kommentare - <code>'n'</code> und <code>'l'</code> , die offensichtlich die ersten Buchstaben in den Wörtern <code>"New"</code> und <code>"load"</code> .  Wenn wir analog zu <code>build_dialog_text</code> argumentieren, können die ersten vier Argumente von <code>sub_181A3</code> (im Folgenden - <code>build_dialog_item</code> ) Faktoren von Koordinaten und Größen sein <em>[tatsächlich die ersten drei Argumente, das vierte, wie sich herausstellte, über das andere]</em> .  Alles konvergiert, wenn Sie diese Werte wie folgt über das Bild legen: </p><br><img src="https://habrastorage.org/webt/xy/gw/hj/xygwhjq2ykcj7wf9z0dbtzhzr7q.png"><br><p>  Die Variablen <code>x_offt</code> , <code>y_offt</code> und <code>width</code> im Bild sind jeweils die ersten drei Argumente der Funktion <code>build_dialog_item</code> .  Die Höhe dieses Rechtecks ​​entspricht immer der Höhe des Symbols - acht.  Nach einem <code>build_dialog_item</code> Blick auf <code>build_dialog_item</code> stellte ich fest, dass das, was ich in der <code>neuro_dialog_t</code> Struktur als <code>padding</code> (jetzt <code>items</code> ) bezeichnet habe, ein Array von 16 Strukturen der folgenden Form ist: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dialog_item_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> left; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> top; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> right; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bottom; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> unknown; <span class="hljs-comment"><span class="hljs-comment">/* index? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> letter; } <span class="hljs-keyword"><span class="hljs-keyword">dialog_item_t</span></span>;</code> </pre> <br><p>  Und das Feld <code>neuro_dialog_t.unknown</code> (jetzt - <code>neuro_dialog_t.items_count</code> ) ist der Zähler für die Anzahl der Elemente im Menü: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">neuro_dialog_t</span></span></span><span class="hljs-class"> {</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> flags; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> items_count; <span class="hljs-keyword"><span class="hljs-keyword">dialog_item_t</span></span> items[<span class="hljs-number"><span class="hljs-number">16</span></span>]; ... } <span class="hljs-keyword"><span class="hljs-keyword">neuro_dialog_t</span></span>;</code> </pre> <br><p>  Das Feld <code>dialog_item_t.unknown</code> mit dem vierten Argument für die Funktion <code>dialog_item_t.unknown</code> initialisiert.  Vielleicht ist dies der Index des Elements im Array, aber es scheint, dass dies nicht immer der Fall ist und daher <code>unknown</code> .  Das Feld <code>dialog_item_t.letter</code> mit dem fünften Argument für die Funktion <code>dialog_item_t.letter</code> initialisiert.  Auch hier ist es möglich, dass das Spiel im Linksklick-Handler im Bereich eines der Elemente nach den Koordinaten des Mauszeigers sucht (z. B. nur nach Reihenfolge sortiert). Wenn ein Treffer erfolgt, wird aus diesem Feld der gewünschte Handler zum Klicken auf eine bestimmte Schaltfläche ausgewählt.  <em>[Ich weiß nicht, wie das tatsächlich gemacht wird, aber ich habe genau diese Logik implementiert.]</em> </p><br><p>  Dies reicht aus, um ein vollwertiges Hauptmenü zu erstellen, das nicht auf den ursprünglichen Code zurückblickt, sondern lediglich das im Spiel beobachtete Verhalten wiederholt. </p><br><div class="spoiler">  <b class="spoiler_title">Main_Menu.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/we/q8/ni/weq8ni9fy9vuusoaitjgazjt6e4.gif"></div></div><br><hr><br><p>  Wenn Sie das vorherige GIF bis zum Ende gesehen haben, haben Sie wahrscheinlich den Startbildschirm auf den letzten Frames bemerkt.  Tatsächlich habe ich schon alles, um es zu zeichnen.  Nehmen Sie es einfach und laden Sie die erforderlichen Sprites herunter und fügen Sie sie der Sprite-Kette hinzu.  Als ich jedoch das Sprite der Hauptfigur auf die Bühne brachte, machte ich eine wichtige Entdeckung im Zusammenhang mit der Struktur <code>imh_hdr_t</code> . </p><br><p>  Im ursprünglichen Code wird die Funktion <code>add_sprite_to_chain</code> , die das Bild des Protagonisten zur Kette hinzufügt, mit den Koordinaten 156 und 110 aufgerufen. <code>add_sprite_to_chain</code> ich gesehen und dies selbst wiederholt: </p><br><img src="https://habrastorage.org/webt/i1/5s/yf/i15syfep7bdhuhxgsbkhr-bxev4.png" align="left"><br><p>  Nachdem ich herausgefunden hatte, was was ist, bekam ich die folgende Art von Struktur <code>imh_hdr_t</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dx; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> dy; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> height; } <span class="hljs-keyword"><span class="hljs-keyword">imh_hdr_t</span></span>;</code> </pre> <br><p>  Was früher ein <code>unknown</code> Feld war, stellte sich als Versatzwerte heraus, die von den entsprechenden Koordinaten (während des Renderns) abgezogen wurden, die in der Sprite-Kette gespeichert waren. </p><br><p><br clear="left"></p><br><p>  Somit wird die reale Koordinate der oberen linken Ecke des gezeichneten Sprites ungefähr so ​​berechnet: </p><br><pre> <code class="hljs cpp">left = <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.left - <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.sprite_hdr.dx top = <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.top - <span class="hljs-keyword"><span class="hljs-keyword">sprite_layer_t</span></span>.sprite_hdr.dy</code> </pre> <br><p>  Wenn ich dies in meinem Code anwendete, bekam ich das richtige Bild und danach begann ich, die Hauptfigur wiederzubeleben.  Tatsächlich habe ich den gesamten Code für die Steuerung des Charakters (Maus und Tastatur), seine Animation und Bewegung selbst geschrieben, ohne auf das Original zurückzublicken. </p><br><div class="spoiler">  <b class="spoiler_title">Moonwalk.gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/ei/m2/tweim2zx4hrsefql82ny-elnimc.gif"></div></div><br><hr><br><p>  Habe ein Text-Intro für das erste Level.  Ich <code>.BIH</code> Sie daran erinnern, dass Zeichenfolgenressourcen in <code>.BIH</code> Dateien gespeichert sind.  <code>.BIH</code> Dateien bestehen aus einem Header mit variabler Größe und einer Folge von nullterminierten Zeichenfolgen.  Bei der Untersuchung des Originalcodes, der das Intro <code>.BIH</code> , stellte ich fest, dass der Versatz des Anfangs des Textteils in der <code>.BIH</code> Datei in der vierten Überschrift enthalten ist.  Die erste Zeile ist das Intro: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bih_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> unknown[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> text_offset; } <span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> r1_bih[<span class="hljs-number"><span class="hljs-number">12288</span></span>]; assert(resource_manager_load(<span class="hljs-string"><span class="hljs-string">"R1.BIH"</span></span>, r1_bih)); <span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">bih_hdr_t</span></span>*)r1_bih; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *intro = r1_bih + hdr-&gt;text_offset;</code> </pre> <br><p>  Ausgehend vom Original habe ich die Aufteilung der Originalzeichenfolge in Teilzeichenfolgen implementiert, sodass sie in den Bereich für die Textausgabe passen, durch diese Zeilen scrollen und auf die Eingabe warten, bevor der nächste Stapel ausgegeben wird. </p><br><div class="spoiler">  <b class="spoiler_title">Intro.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/uk/oa/ag/ukoaagah17k7eegsy4unobeskbg.gif"></div></div><br><hr><br><p>  Zum Zeitpunkt der Veröffentlichung habe ich zusätzlich zu dem, was bereits in drei Teilen beschrieben wurde, die Wiedergabe von Ton herausgefunden.  Bisher ist dies nur in meinem Kopf und es wird einige Zeit dauern, dies in meinem Projekt zu realisieren.  Im vierten Teil geht es also wahrscheinlich nur um den Klang.  Ich habe auch vor, ein wenig über die Architektur des Projekts zu erzählen, aber mal sehen, wie es geht. </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Rückseite des Neuromancers.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 4: Sound, Animation, Huffman, Github</a> </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de415555/">https://habr.com/ru/post/de415555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de415545/index.html">Installieren Sie Veeam Backup & Replication mithilfe eines PowerShell-Skripts</a></li>
<li><a href="../de415547/index.html">Ein bisschen über OSDAY oder Was Sie brauchen, um Studenten beizubringen, in russischen IT-Unternehmen zu arbeiten und dort zu bleiben</a></li>
<li><a href="../de415549/index.html">Wie Elektroroller das Silicon Valley eroberten und warum sie sie hassen</a></li>
<li><a href="../de415551/index.html">VoLTE / ViLTE + Wi-Fi-Anrufe sind fast kompliziert</a></li>
<li><a href="../de415553/index.html">Aufschluss von frischen Materialien aus der Welt der AR-Technologien</a></li>
<li><a href="../de415557/index.html">Codec 2 + neuronales Netzwerk = ganzer Podcast auf einer Diskette</a></li>
<li><a href="../de415559/index.html">Die Geschichte der Entwicklung von Call Centern oder wie Technologien die Arbeit der Betreiber mit Kunden verändert haben</a></li>
<li><a href="../de415561/index.html">So übertragen Sie Ereignisse von Veeam Backup & Replication in Instant Messenger</a></li>
<li><a href="../de415563/index.html">Die Behandlung von "mechanischem" Scrum. Teil 2. Team</a></li>
<li><a href="../de415565/index.html">Warum (heute) 444 zurückgibt, ist nicht immer sinnvoll</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>