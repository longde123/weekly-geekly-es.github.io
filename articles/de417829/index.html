<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏈 🏗️ 💅🏻 Reduzieren Sie die Anzahl der Architekturebenen von 5 auf 2 🚡 🍑 👩🏼‍⚖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Während ich an mehreren Open-Source-Projekten arbeitete, beschloss ich eines Tages, mein Leben zu vereinfachen, und entwickelte das Upstream-Modul für...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reduzieren Sie die Anzahl der Architekturebenen von 5 auf 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/417829/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/kw/j7/fd/kwj7fdn4wlfdatsf5joghqb3we8.jpeg" width="400"></div><br>  Während ich an mehreren Open-Source-Projekten arbeitete, beschloss ich eines Tages, mein Leben zu vereinfachen, und entwickelte das Upstream-Modul für Nginx, mit dem ich sperrige Schichten mehrschichtiger Architektur entfernen konnte.  Es war eine lustige Erfahrung, die ich in diesem Artikel teilen möchte.  Mein Code ist hier öffentlich verfügbar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/tarantool/nginx_upstream_module</a> .  Sie können es von Grund auf neu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">abrufen</a> oder das Docker-Image über diesen Link herunterladen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hub.docker.com/r/tarantool/tarantool-nginx</a> . <br><br>  Auf der Tagesordnung: <br><br><ul><li>  Einführung und Theorie. </li><li>  Verwendung dieser Technologien. </li><li>  Leistungsbewertung. </li><li>  Nützliche Links. </li></ul><a name="habracut"></a><br><h2>  Einführung und Theorie </h2><br><img src="https://habrastorage.org/webt/10/rj/x5/10rjx5ayayibzqllg9-u3hdw-ei.png"><br><br>  So sieht die Standard-Microservice-Architektur aus.  Benutzeranforderungen kommen über nginx an den Anwendungsserver.  Auf dem Server befindet sich eine Geschäftslogik, mit der Benutzer interagieren. <br><br>  Der Anwendungsserver speichert den Status von Objekten nicht, daher müssen sie an einem anderen Ort gespeichert werden.  Hierfür können Sie Datenbanken verwenden.  Vergessen Sie nicht den Cache, der die Latenz verringert und eine schnellere Bereitstellung von Inhalten ermöglicht. <br><br>  Teilen Sie es in Schichten: <br><br>  <b>1. Schicht</b> - Nginx. <br>  <b>2. Schicht</b> - Anwendungsserver. <br>  <b>3. Schicht</b> - Cache. <br>  <b>4. Schicht</b> - Datenbank-Proxy.  Dieser Proxy ist erforderlich, um die Fehlertoleranz sicherzustellen und eine konstante Verbindung zur Datenbank aufrechtzuerhalten. <br>  <b>Die 5. Schicht</b> ist der Datenbankserver. <br><br>  Als ich über diese Ebenen nachdachte, fand ich heraus, wie ich einige davon ausschließen konnte.  Warum?  Viele Gründe.  Ich mag einfache verständliche Dinge;  Ich mag es nicht, eine große Anzahl verschiedener Systeme bei der Herstellung zu unterstützen.  und nicht zuletzt, je weniger Schichten, desto weniger Fehlerstellen.  Als Ergebnis habe ich das Tarantool Upstream-Modul unter nginx erstellt, wodurch die Anzahl der Ebenen auf zwei reduziert wurde. <br><br><img src="https://habrastorage.org/webt/_j/3g/4a/_j3g4akjywetwlgaayru26ot0vi.png" width="622"><br><br>  Wie hilft Tarantool, die Anzahl der Schichten zu reduzieren?  Die erste Schicht ist Nginx, die zweite, dritte und fünfte Schicht ersetzen Tarantool.  Die vierte Schicht, der Datenbank-Proxy, befindet sich jetzt in Nginx.  Der Trick ist, dass Tarantool eine Datenbank, ein Cache und ein Anwendungsserver ist, drei in einem.  Mein Upstream-Modul verbindet Nginx und Tarantool miteinander und ermöglicht es ihnen, nahtlos ohne die anderen drei Schichten zu arbeiten. <br><br><img src="https://habrastorage.org/webt/aj/fn/tx/ajfntx13aw0r1hsbopzn9soky50.png"><br><br>  So sieht der neue Microservice aus.  Der Benutzer sendet mit dem Tarantool Upstream-Modul eine Anfrage an REST oder JSON RPC in nginx.  Das Modul kann direkt mit Tarantool verbunden werden, oder die Last kann auf mehreren Tarantool-Servern ausgeglichen werden.  Zwischen nginx und Tarantool verwenden wir ein effizientes Protokoll, das auf MSGPack basiert.  Weitere Informationen finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel</a> . <br><br>  Sie können diesen Links auch folgen, um Tarantool und das Nginx-Modul herunterzuladen.  Ich würde jedoch empfehlen, sie über den Paketmanager Ihrer Distribution oder über das Docker-Image ( <code>docker pull tarantool/tarantool-nginx</code> ) zu <code>docker pull tarantool/tarantool-nginx</code> . <br><br>  Docker-Images: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hub.docker.com/r/tarantool/tarantool</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tarantool NginX Upstream-Modul</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Binärpakete</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tarantool - Download</a> <br><br>  Quellcode: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tarantool</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tarantool / nginx_upstream_module</a> <br><br><h2>  Verwendung dieser Technologien </h2><br>  Hier ist ein Beispiel für eine nginx.conf-Datei.  Wie Sie sehen können, handelt es sich hierbei um einen regulären Upstream-Nginx.  Hier haben wir <code>tnt_pass</code> , das nginx direkt <code>tnt_pass</code> welchen Pfad das Upstream-Tarantool eingefügt werden soll. <br><br>  <i>nginx-tnt.conf</i> <br><pre> <code class="hljs pgsql">http { # upstream upstream tnt { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3301</span></span>; keepalive <span class="hljs-number"><span class="hljs-number">1000</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">8081</span></span>; # gateway <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> /api/<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { tnt_pass_http_request parse_args; tnt_pass tnt; } } }</code> </pre> <br>  Hier sind die Links zur Dokumentation: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://nginx.org/en/docs/http/ngx_">nginx.org/en/docs/http/ngx_http_upstream_module.html</a> <br>  <a href="">github.com/tarantool/nginx_upstream_module/blob/master/README.md</a> <br><br>  Konfiguriert ein paar Nginx und Tarantool, was dann?  Jetzt müssen wir eine Handlerfunktion für unseren Dienst registrieren und in eine Datei einfügen.  Ich habe es in die Datei "app.lua" eingefügt. <br><br>  Hier ist ein Link zur Tarantool-Dokumentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tarantool.io/en/doc/1.9/book/box/data_model/#index</a> <br><br><pre> <code class="hljs powershell">-- Bootstrap Tarantool box.cfg { listen=<span class="hljs-string"><span class="hljs-string">'*:3301'</span></span> } -- Grants box.once(<span class="hljs-string"><span class="hljs-string">'grants'</span></span>, function() box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'read,write,execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'universe'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) -- Global variable hello_str = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> -- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(http_request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">local</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello_str</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_request</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method</span></span></span><span class="hljs-function"> == '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GET</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str</span></span></span><span class="hljs-function"> = '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Goodbye</span></span></span><span class="hljs-function">' </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-function">', </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">2</span></span></span><span class="hljs-function">,</span></span> { str .. <span class="hljs-string"><span class="hljs-string">'world!'</span></span> }, http_request.args <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Betrachten Sie nun den Lua-Code. <br><br>  Unsere <code>Box.cfg {}</code> weist Tarantool an, Port 3301 abzuhören, kann jedoch andere Parameter akzeptieren. <br><br>  <code>Box.once</code> weist Tarantool an, eine Funktion einmal aufzurufen. <br><br>  <code>function api ()</code> ist eine Funktion, die ich bald aufrufen werde.  Es nimmt eine HTTP-Anforderung als erstes Argument und gibt ein Array von Werten zurück. <br><br>  Ich habe diesen Code in einer Datei gespeichert und ihn "app.lua" genannt.  Sie können es ausführen, indem Sie einfach die Tarantool-Anwendung starten. <br><br> <code>$&gt; tarantool app.lua</code> <br> <br>  Wir rufen unsere Funktion über eine GET-Anfrage auf.  Ich benutze dafür "wget".  Standardmäßig speichert "wget" die Antwort auf eine Datei.  Und um die Daten aus der Datei zu lesen, benutze ich "cat". <br><br><pre> <code class="lua hljs">$ wget <span class="hljs-string"><span class="hljs-string">'0.0.0.0:8081/api/do?arg_1=1&amp;arg_2=2'</span></span> $ cat <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>* { “id”:<span class="hljs-number"><span class="hljs-number">0</span></span>, # — unique identifier of the request “result”: [ # — is what our Tarantool <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> [“</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-function">”], [2], [{ “</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">”:{“</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arg_2</span></span></span><span class="hljs-function">”:”2",”</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arg_1</span></span></span><span class="hljs-function">":”1"} “1”:”</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Goodbye</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">world</span></span></span><span class="hljs-function">!” }] ]}</span></span></code> </pre> <br><h2>  Leistungsbewertung </h2><br>  Die Bewertung wurde anhand von Daten aus der Produktion durchgeführt.  Die Eingabe ist ein großes JSON-Objekt.  Die durchschnittliche Größe eines solchen Objekts beträgt 2 KB.  Einzelner Server, 4-Kern-CPU, 90 GB RAM, Betriebssystem Ubuntu 14.04.1 LTS. <br><br>  Für diesen Test verwenden wir nur einen Nginx-Worker.  Dieser Worker ist ein Balancer mit einem einfachen ROUND-ROBIN-Algorithmus.  Es verteilt die Last zwischen den beiden Tarantool-Knoten.  Die Last wird mithilfe von Sharding skaliert. <br><br>  Diese Grafiken zeigen die Anzahl der Lesevorgänge pro Sekunde.  Das obere Diagramm zeigt die Verzögerungen (in Millisekunden). <br><br><img src="https://habrastorage.org/webt/ji/ob/ef/jiobefhg74ac5e6u298d755qpak.png"><br><br>  Diese Grafiken zeigen die Anzahl der Schreibvorgänge pro Sekunde.  Das obere Diagramm zeigt Verzögerungen (in Millisekunden). <br><br><img src="https://habrastorage.org/webt/m0/k1/_i/m0k1_i2pcdkqjsrbwckwpv6g4_e.png"><br><br>  Beeindruckend! <br><br>  Im nächsten Artikel werde ich ausführlich über REST und JSON RPC sprechen. <br><br>  <i>Englische Version des Artikels: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hackernoon.com/shrink-the-number-of-tiers-in-a-multitier-architecture-from-5-to-2-c59b7bf46c86</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de417829/">https://habr.com/ru/post/de417829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de417813/index.html">Zabbix - Überwachung von OSPF-Nachbarn mithilfe von SNMPv3-TRAPs, Schmerz und Verzweiflung</a></li>
<li><a href="../de417821/index.html">Network Digest: 20 Expertenmaterialien zu Protokollen, Standards und Informationssicherheit</a></li>
<li><a href="../de417823/index.html">Neue Generation: Das weltweit erste kommerzielle 5G-Netzwerk wurde gestartet</a></li>
<li><a href="../de417825/index.html">"Grenzen erweitern": Der 6-GHz-Bereich wird den Anforderungen von Wi-Fi angepasst</a></li>
<li><a href="../de417827/index.html">Kostenloses WLAN: Das deutsche Gericht hebt die Strafen für Kaffeehäuser für Urheberrechtsverletzungen von Kunden auf</a></li>
<li><a href="../de417831/index.html">Das Leben mit Java SE 8 und Java SE 11 kostet 25 US-Dollar pro Prozessor und Monat</a></li>
<li><a href="../de417835/index.html">„Empire in Depth“: Warum große IT-Unternehmen ihre U-Boot-Kabel verlegen</a></li>
<li><a href="../de417837/index.html">Upgrade von Django von Version 1.9 auf Version 2.0</a></li>
<li><a href="../de417839/index.html">Angreifer verwenden das Spiel "Clash of Clans", um Geld von gestohlenen Kreditkarten zu waschen</a></li>
<li><a href="../de417841/index.html">Wir verbieten Govnokod oder nützliche Plug-Ins für ESLint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>