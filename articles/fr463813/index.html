<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèΩ üë®üèæ‚Äçü§ù‚Äçüë®üèª üë®üèº‚Äçüöí Multivan et routage sur Mikrotik RouterOS üç© üë®üèª‚Äçüíº üíö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Avec corrections et ajouts du 02/11/2020 
 Pr√©sentation 
 Outre la vanit√©, la fr√©quence d√©primante des questions sur ce sujet dans les groupes concern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Multivan et routage sur Mikrotik RouterOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463813/">  Avec corrections et ajouts du 02/11/2020 <br><h4>  Pr√©sentation </h4><br>  Outre la vanit√©, la fr√©quence d√©primante des questions sur ce sujet dans les groupes concern√©s de la communaut√© des t√©l√©grammes russophones m'a incit√© √† reprendre l'article.  Cet article est destin√© aux administrateurs novices de Mikrotik RouterOS (ci-apr√®s ROS).  Il ne consid√®re qu'un multivan, avec un accent sur le routage.  Le bonus comprend des param√®tres minimalement suffisants pour assurer un fonctionnement s√ªr et pratique.  Ceux qui recherchent la divulgation de ces files d'attente, l'√©quilibrage de charge, le vlan, les ponts, l'analyse approfondie en plusieurs √©tapes de l'√©tat du canal et similaires - ne peuvent pas perdre de temps et d'efforts pour lire. <br><a name="habracut"></a><br><h4>  Donn√©es source </h4><br>  En tant que sujet de test, un routeur Mikrotik √† cinq ports avec ROS version 6.45+ a √©t√© s√©lectionn√©.  Il acheminera le trafic entre deux r√©seaux locaux (LAN1 et LAN2) et trois fournisseurs (ISP1, ISP2, ISP3).  Le canal vers ISP1 a une adresse statique ¬´grise¬ª, ISP2 est ¬´blanc¬ª re√ßu via DHCP, ISP3 est ¬´blanc¬ª avec authentification PPPoE.  Le sch√©ma de connexion est illustr√© dans la figure: <br><br><img src="https://habrastorage.org/webt/pd/di/mv/pddimv_vbwqmityow2oe2oxngam.jpeg"><br><br>  La t√¢che consiste √† configurer le routeur MTK en fonction du sch√©ma afin que: <br><br><ol><li>  Fournit une commutation automatique vers le fournisseur de sauvegarde.  Le principal fournisseur est ISP2, la premi√®re r√©serve est ISP1, la deuxi√®me r√©serve est ISP3. </li><li>  Pour organiser l'acc√®s LAN1 √† Internet uniquement via ISP1. </li><li>  Permet d'acheminer le trafic des r√©seaux locaux vers Internet via le fournisseur s√©lectionn√© en fonction de la liste d'adresses. </li><li>  Fournir la possibilit√© de publier des services d'un r√©seau local sur Internet (DSTNAT) </li><li>  Configurez un filtre pare-feu pour fournir la s√©curit√© minimale suffisante √† partir d'Internet. </li><li>  Le routeur peut √©mettre son propre trafic via l'un des trois fournisseurs, en fonction de l'adresse source s√©lectionn√©e. </li><li>  Fournissez le routage des paquets de r√©ponse vers le canal d'o√π ils proviennent (y compris le LAN). </li></ol><br>  <i><b>Remarque.</b></i>  <i>Nous allons configurer le routeur ¬´√† partir de z√©ro¬ª afin de garantir qu'il n'y a pas de surprise √† d√©marrer des configurations ¬´pr√™tes √† l'emploi¬ª changeant de version en version.</i>  <i>Winbox a √©t√© choisi comme outil de configuration, o√π les modifications seront affich√©es visuellement.</i>  <i>Les param√®tres eux-m√™mes seront d√©finis par des commandes dans le terminal Winbox.</i>  <i>La connexion physique pour la configuration se fait via une connexion directe √† l'interface Ether5.</i> <br><br><h4>  Une petite discussion sur ce qu'est un multivan, que ce soit un probl√®me ou que des gens astucieux et astucieux tissent des r√©seaux de conspirations </h4><br>  Un administrateur curieux et attentif, mettant en place tel ou tel sch√©ma par lui-m√™me, se rend soudain compte qu'il fonctionne normalement.  Oui, oui, sans ces tables de routage personnalis√©es et autres r√®gles de routage, qui regorgent de la plupart des articles sur ce sujet.  V√©rifiez-le? <br><br>  Peut-on configurer l'adressage sur les interfaces et les passerelles par d√©faut?  Oui: <br><br>  L'adresse et la passerelle avec <b>distance = 2</b> et <b>check-gateway = ping</b> ont √©t√© enregistr√©es sur ISP1 <b>.</b> <br>  Sur ISP2, le param√®tre DHCP par d√©faut pour le client est la distance, respectivement, √©gale √† un. <br>  Sur ISP3 dans les param√®tres pppoe du client avec <b>add-default-route = yes</b> set <b>default-route-distance = 3</b> . <br><br>  N'oubliez pas d'enregistrer NAT pour la sortie: <br><br>  <b>/ ip firewall nat add action = cha√Æne de mascarade = srcnat out-interface-list = WAN</b> <br><br>  En cons√©quence, les utilisateurs des r√©seaux locaux ont du plaisir √† charger les scell√©s via le fournisseur principal ISP2 et il y a une r√©servation du canal √† l'aide du m√©canisme de <b>passerelle de v√©rification</b> <sup>.</sup> <br><br>  Le point 1 de la t√¢che est mis en ≈ìuvre.  O√π est le multivan avec ses √©tiquettes?  Non ... <br><br>  Plus loin.  Vous devez lib√©rer des clients sp√©cifiques du LAN via ISP1: <br><br>  <b>/ ip firewall mangle add action = route chain = pr√©routage dst-address-list =! BOGONS \</b> <b><br></b>  <b>passthrough = oui route-dst = 100.66.66.1 src-address-list = Via_ISP1</b> <b><br></b>  <b>/ ip firewall mangle add action = route chain = pr√©routage dst-address-list =! BOGONS \</b> <b><br></b>  <b>passthrough = no route-dst = 100.66.66.1 src-address = 192.168.88.0 / 24</b> <br><br>  Les points 2 et 3 de la t√¢che sont mis en ≈ìuvre.  Tags, tampons, r√®gles de parcours, o√π √™tes-vous?! <br><br>  Besoin de donner acc√®s √† votre serveur OpenVPN pr√©f√©r√© avec l'adresse 172.17.17.17 pour les clients Internet?  SVP: <br><br>  <b>/ ip cloud set ddns-enabled = yes</b> <br><br>  Nous donnons le r√©sultat de sortie aux clients comme un festin: " <b>: put [ip cloud get dns-name]</b> " <br><br>  Nous enregistrons la redirection de port depuis Internet: <br><br>  <b>/ ip firewall nat add action = dst-nat chain = dstnat dst-port = 1194 \</b> <b><br></b>  <b>in-interface-list = protocole WAN = adresses udp = 172.17.17.17</b> <br><br>  Le point 4 est pr√™t. <br><br>  Nous avons mis en place un pare-feu et d'autres √©l√©ments de s√©curit√© pour le point 5, en m√™me temps, nous sommes heureux que tout fonctionne pour les utilisateurs et atteignons un conteneur avec une boisson pr√©f√©r√©e ... <br>  Ah!  Les tunnels sont encore oubli√©s. <br><br>  Le client l2tp configur√© selon l'article googl√© est pass√© au VDS n√©erlandais bien-aim√©?  Oui <br>  l2tp-server avec IPsec rose et les clients par nom DNS depuis IP Cloud (voir ci-dessus) s'accrochent?  Oui <br>  En nous penchant en arri√®re, en buvant une gorg√©e de boisson, nous examinons paresseusement les points 6 et 7 du probl√®me.  Nous pensons - en avons-nous besoin?  Tout fonctionne comme √ßa (s) ... Donc si ce n'est pas n√©cessaire, alors c'est tout.  Multivan impl√©ment√©. <br><br>  <b>Qu'est-ce qu'un multivan?</b>  <b>Il s'agit de la connexion de plusieurs canaux Internet √† un routeur.</b> <br><br>  Vous ne pouvez pas lire l'article plus loin, car que peut-il y avoir en plus d'une d√©monstration d'applicabilit√© douteuse? <br><br>  Avec ceux qui restent, qui sont int√©ress√©s par les points 6 et 7 de la t√¢che, et ressentent √©galement les d√©mangeaisons du perfectionnisme, nous plongeons plus profond√©ment. <br><br>  La t√¢che la plus importante de la mise en ≈ìuvre de multivans est le routage correct du trafic.  A savoir: quel que soit (ou lequel) <sup>Voir la note 3,</sup> le ou les canaux du fournisseur regardent la route par d√©faut sur notre routeur, il devrait retourner la r√©ponse exactement au canal d'o√π provient le paquet.  La t√¢che est claire.  O√π est le probl√®me?  En effet, dans un simple r√©seau local, la t√¢che est la m√™me, mais personne ne d√©range avec des param√®tres suppl√©mentaires et ne ressent aucun probl√®me.  La diff√©rence est que tout n≈ìud rout√© sur Internet est accessible via chacun de nos canaux, et non via un canal strictement sp√©cifique, comme dans un simple LAN.  Mais le ¬´probl√®me¬ª est que si nous recevons une demande d'adresse IP d'ISP3, alors dans notre cas la r√©ponse passera par le canal ISP2, puisque la passerelle par d√©faut y est dirig√©e.  Il partira et sera rejet√© par le fournisseur comme √©tant incorrect.  Nous avons d√©cid√© du probl√®me.  Comment le r√©soudre? <br><br>  La solution est divis√©e en trois √©tapes: <br><br><ol><li>  <b>Pr√©configuration</b>  √Ä ce stade, les param√®tres de base du routeur seront d√©finis: r√©seau local, pare-feu, listes d'adresses, √©pingle √† cheveux NAT, etc. </li><li>  <b>Multivan.</b>  √Ä ce stade, les connexions n√©cessaires seront marqu√©es et tri√©es en fonction des tables de routage. </li><li>  <b>Connexion au FAI.</b>  A ce stade, les interfaces fournissant la connexion Internet seront configur√©es, le routage et le m√©canisme de r√©servation des canaux Internet seront impliqu√©s. </li></ol><br>  <i><b>Remarque.</b></i>  <i>Trois types diff√©rents de connexion au FAI ont √©t√© choisis sp√©cifiquement pour montrer qu'il n'y a rien d'insoluble dans la configuration de multivans avec des adresses dynamiques et d√©montrer l'une des options de la solution.</i> <br>  <u><b>Important!</b></u>  Pour commuter les canaux selon l'algorithme sp√©cifi√© en utilisant le co√ªt des itin√©raires √† <b>distance</b> , le m√©canisme de <b>passerelle de v√©rification</b> est utilis√© <b>.</b>  <sup>Voir note 1</sup> <br>  Les scripts donn√©s dans l'article n'ont rien √† voir avec la r√©servation de cha√Æne. <br><br><h4>  1. Pr√©r√©glage </h4><br>  1.1.  Nous effa√ßons la configuration du routeur avec la commande: <br><br><pre><code class="plaintext hljs">/system reset-configuration skip-backup=yes no-defaults=yes</code> </pre> <br>  d'accord avec " <b>Dangereux!</b>  <b>R√©initialiser quand m√™me?</b>  <b>[y / N]:</b> ‚Äùet, apr√®s le red√©marrage, nous nous connectons √† Winbox via MAC.  √Ä ce stade, la configuration et la base d'utilisateurs sont effac√©es. <br><br>  1.2.  Cr√©ez un nouvel utilisateur: <br><br><pre> <code class="plaintext hljs">/user add group=full name=knight password=ultrasecret comment="Not horse"</code> </pre> <br>  connectez-vous en dessous et supprimez la valeur par d√©faut: <br><br><pre> <code class="plaintext hljs">/user remove admin</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>C'est la suppression et non la d√©connexion de l'utilisateur par d√©faut que l'auteur consid√®re plus s√ªr et recommande d'utiliser.</i> <br><br>  1.3.  Nous cr√©ons des listes d'interfaces de base pour la commodit√© de fonctionner dans un pare-feu, des param√®tres de d√©couverte et d'autres serveurs MAC: <br><br><pre> <code class="plaintext hljs">/interface list add name=WAN comment="For Internet" /interface list add name=LAN comment="For Local Area"</code> </pre> <br>  Nous signons des interfaces avec des commentaires <br><br><pre> <code class="plaintext hljs">/interface ethernet set ether1 comment="to ISP1" /interface ethernet set ether2 comment="to ISP2" /interface ethernet set ether3 comment="to ISP3" /interface ethernet set ether4 comment="to LAN1" /interface ethernet set ether5 comment="to LAN2"</code> </pre> <br>  et remplissez les listes d'interfaces: <br><br><pre> <code class="plaintext hljs">/interface list member add interface=ether1 list=WAN comment=ISP1 /interface list member add interface=ether2 list=WAN comment=ISP2 /interface list member add interface=ether3 list=WAN comment="to ISP3" /interface list member add interface=ether4 list=LAN comment="LAN1" /interface list member add interface=ether5 list=LAN comment="LAN2"</code> </pre><br>  <i><b>Remarque.</b></i>  <i>√âcrire des commentaires clairs vaut le temps consacr√© √† cela, ce qui facilite grandement le d√©pannage et la compr√©hension de la configuration.</i> <i><br><br></i>  <i>L'auteur consid√®re qu'il est n√©cessaire, pour des raisons de s√©curit√©, d'ajouter l'interface ether3 √† la liste d'interfaces ¬´WAN¬ª, malgr√© le fait que le protocole ip ne le traversera pas.</i> <i><br><br></i>  <i>N'oubliez pas qu'une fois l'interface PPP augment√©e sur ether3, elle devra √©galement √™tre ajout√©e √† la liste des interfaces ¬´WAN¬ª</i> <br><br>  1.4.  Nous cachons le routeur de la d√©tection de proximit√© et du contr√¥le des r√©seaux des fournisseurs par MAC: <br><br><pre> <code class="plaintext hljs">/ip neighbor discovery-settings set discover-interface-list=!WAN /tool mac-server set allowed-interface-list=LAN /tool mac-server mac-winbox set allowed-interface-list=LAN</code> </pre> <br>  1.5.  Nous cr√©ons un ensemble minimum suffisant de r√®gles de filtrage du pare-feu pour prot√©ger le routeur: <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=input \ comment="Related Established Untracked Allow" \ connection-state=established,related,untracked</code> </pre> <br>  (la r√®gle autorise les connexions √©tablies et connexes initi√©es √† la fois √† partir des r√©seaux connect√©s et par le routeur lui-m√™me) <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=input \ comment="ICMP from ALL" protocol=icmp</code> </pre> <br>  (ping et pas seulement ping. Tout icmp est autoris√© √† entrer. Il est tr√®s utile pour trouver des probl√®mes avec MTU) <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=drop chain=input comment="All other WAN Drop" \ in-interface-list=WAN</code> </pre> <br>  (la r√®gle de fermeture de la cha√Æne d'entr√©e interdit tout ce qui arrive d'Internet) <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward \ comment="Established, Related, Untracked allow" \ connection-state=established,related,untracked</code> </pre> <br>  (la r√®gle autorise les connexions √©tablies et connexes qui transitent par le routeur) <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=drop chain=forward comment="Invalid drop" \ connection-state=invalid</code> </pre> <br>  (la r√®gle supprime les connexions, avec connection-state = invalide, passant par le routeur. Elle est fortement recommand√©e par Mikrotik, mais dans certaines situations rares, elle peut bloquer le trafic utile) <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=drop chain=forward \ comment="Drop all from WAN not DSTNATed" connection-nat-state=!dstnat \ connection-state=new in-interface-list=WAN</code> </pre> <br>  (la r√®gle interdit les paquets qui transitent par Internet et qui n'ont pas suivi la proc√©dure dstnat via le routeur. Cela prot√©gera les r√©seaux locaux des intrus qui, √©tant dans le m√™me domaine de diffusion avec nos r√©seaux externes, enregistreront nos adresses IP externes en tant que passerelle et, par cons√©quent, essaieront ¬´Explorez¬ª nos r√©seaux locaux.) <br><br>  <i><b>Remarque.</b></i>  <i>Supposons que LAN1 et LAN2 sont des r√©seaux de confiance et que le trafic entre eux et √† partir d'eux ne soit pas filtr√©.</i> <br><br>  1.6.  Cr√©ez une liste avec une liste de r√©seaux non routables: <br><br><pre> <code class="plaintext hljs">/ip firewall address-list add address=0.0.0.0/8 comment="\"This\" Network" list=BOGONS add address=10.0.0.0/8 comment="Private-Use Networks" list=BOGONS add address=100.64.0.0/10 comment="Shared Address Space. RFC 6598" list=BOGONS add address=127.0.0.0/8 comment=Loopback list=BOGONS add address=169.254.0.0/16 comment="Link Local" list=BOGONS add address=172.16.0.0/12 comment="Private-Use Networks" list=BOGONS add address=192.0.0.0/24 comment="IETF Protocol Assignments" list=BOGONS add address=192.0.2.0/24 comment=TEST-NET-1 list=BOGONS add address=192.168.0.0/16 comment="Private-Use Networks" list=BOGONS add address=198.18.0.0/15 comment="Network Interconnect Device Benchmark Testing"\ list=BOGONS add address=198.51.100.0/24 comment=TEST-NET-2 list=BOGONS add address=203.0.113.0/24 comment=TEST-NET-3 list=BOGONS add address=224.0.0.0/4 comment=Multicast list=BOGONS add address=192.88.99.0/24 comment="6to4 Relay Anycast" list=BOGONS add address=240.0.0.0/4 comment="Reserved for Future Use" list=BOGONS add address=255.255.255.255 comment="Limited Broadcast" list=BOGONS</code> </pre> <br>  (Il s'agit d'une liste d'adresses et de r√©seaux qui ne sont pas achemin√©s vers Internet et, par cons√©quent, nous suivrons √©galement cela.) <br><br>  <i><b>Remarque.</b></i>  <i>La liste peut changer, je vous conseille donc de v√©rifier p√©riodiquement la pertinence.</i> <br><br>  1.7.  Configurez DNS pour le routeur lui-m√™me: <br><br><pre> <code class="plaintext hljs">/ip dns set servers=1.1.1.1,8.8.8.8</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>Dans la version actuelle de ROS, les serveurs dynamiques ont priorit√© sur ceux d√©finis statiquement.</i>  <i>Une demande de r√©solution de nom est envoy√©e au premier serveur dans l'ordre de la liste.</i>  <i>La transition vers le serveur suivant se produit lorsque le serveur actuel n'est pas disponible.</i>  <i>Big timeout - plus de 5 secondes.</i>  <i>Le retour lorsque le ¬´serveur tomb√© en panne¬ª est repris ne se produit pas automatiquement.</i>  <i>Compte tenu de cet algorithme et de la pr√©sence d'un multivan, l'auteur recommande de ne pas utiliser de serveurs √©mis par des fournisseurs.</i> <br><br>  1.8.  Configurez le r√©seau local. <br>  1.8.1.  Configurez les adresses IP statiques sur les interfaces LAN: <br><br><pre> <code class="plaintext hljs">/ip address add interface=ether4 address=192.168.88.254/24 comment="LAN1 IP" /ip address add interface=ether5 address=172.16.1.0/23 comment="LAN2 IP"</code> </pre> <br>  1.8.2.  Nous d√©finissons les r√®gles pour les itin√©raires vers nos r√©seaux locaux via la table de routage principale: <br><br><pre> <code class="plaintext hljs">/ip route rule add dst-address=192.168.88.0/24 table=main comment="to LAN1" /ip route rule add dst-address=172.16.0.0/23 table=main comment="to LAN2"</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>C'est l'un des moyens les plus simples et les plus rapides d'acc√©der aux adresses de r√©seau local avec des adresses IP externes des interfaces de routeur par lesquelles la route par d√©faut ne passe pas.</i> <br><br>  1.8.3.  Si n√©cessaire, activez Hairpin NAT pour LAN1 et LAN2: <br><br><pre> <code class="plaintext hljs">/ip firewall nat add action=src-nat chain=srcnat comment="Hairpin to LAN1" \ out-interface=ether4 src-address=192.168.88.0/24 to-addresses=192.168.88.254 /ip firewall nat add action=src-nat chain=srcnat comment="Hairpin to LAN2" \ out-interface=ether5 src-address=172.16.0.0/23 to-addresses=172.16.1.0</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>Cela permet aux utilisateurs de LAN1 et LAN2 d'acc√©der via une IP externe (dstnat) √† des serveurs situ√©s avec des utilisateurs sur le m√™me segment de r√©seau.</i> <br><br><h4>  2. En fait, la mise en ≈ìuvre des multivans corrects </h4><br>  Pour r√©soudre le probl√®me de ¬´r√©pondre d'o√π ils l'ont demand√©¬ª, nous utiliserons deux outils ROS: la <b>marque de connexion</b> et la <b>marque de routage</b> .  <b>La marque de connexion</b> vous permet de marquer la connexion souhait√©e et de continuer √† travailler avec cette √©tiquette comme condition pour appliquer la <b>marque de routage</b> .  Et d√©j√† avec la <b>marque de routage,</b> il est possible de travailler sur les <b>routes IP</b> et les <b>r√®gles de route</b> .  Nous avons compris les outils, maintenant nous devons d√©cider quelles connexions marquer - un, o√π exactement marquer - deux. <br><br>  Avec le premier, tout est simple - nous devons marquer toutes les connexions qui arrivent au routeur depuis Internet via le canal appropri√©.  Dans notre cas, il s'agira de trois labels (selon le nombre de canaux): "conn_isp1", "conn_isp2" et "conn_isp3". <br><br>  La nuance avec la seconde est que les connexions entrantes seront de deux types: transit et celles qui sont destin√©es au routeur lui-m√™me.  Le m√©canisme de marque de connexion fonctionne dans la table <b>mangle</b> .  Consid√©rez le d√©placement du colis sur un sch√©ma simplifi√©, aimablement collect√© par les sp√©cialistes de la ressource mikrotik-trainings.com (non publicitaire): <br><br><img src="https://habrastorage.org/webt/gg/yc/u4/ggycu4_z4ps93z-crahvri9pshw.jpeg"><br><br>  En suivant les fl√®ches, nous voyons que le paquet arrivant √† ¬´ <b>l'interface d'entr√©e</b> ¬ª passe par la cha√Æne ¬´ <b>Pr√©routage</b> ¬ª et seulement alors il est divis√© en transit et local dans le bloc ¬´ <b>D√©cision de routage</b> ¬ª.  Par cons√©quent, pour tuer deux oiseaux avec une pierre, utilisez la <b>marque de connexion</b> dans la table de <b>pr√©</b> - <b>routage Mangle</b> de la cha√Æne de <b>pr√©</b> - <b>routage</b> . <br><br>  <i><b>Remarque</b> .</i>  <i>Dans ROS, les √©tiquettes ¬´Routing mark¬ª sont indiqu√©es dans la section Ip / Routes / Rules comme ¬´Table¬ª, et dans les autres sections comme ¬´Routing Mark¬ª.</i>  <i>Cela peut entra√Æner une certaine confusion dans la compr√©hension, mais, en fait, c'est la m√™me chose, et c'est l'analogue de rt_tables dans iproute2 sur linux.</i> <br><br>  2.1.  Nous marquons les connexions entrantes de chacun des fournisseurs: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle add action=mark-connection chain=prerouting \ comment="Connmark in from ISP1" connection-mark=no-mark in-interface=ether1 \ new-connection-mark=conn_isp1 passthrough=no /ip firewall mangle add action=mark-connection chain=prerouting \ comment="Connmark in from ISP2" connection-mark=no-mark in-interface=ether2 \ new-connection-mark=conn_isp2 passthrough=no /ip firewall mangle add action=mark-connection chain=prerouting \ comment="Connmark in from ISP3" connection-mark=no-mark in-interface=pppoe-isp3 \ new-connection-mark=conn_isp3 passthrough=no</code> </pre> <br>  <i><b>Remarque.</b></i> <i><br></i>  <i>Les lecteurs qui tentent de r√©p√©ter litt√©ralement et dans l'ordre de lecture le param√®tre sugg√©r√© dans l'article, lors de la saisie de la troisi√®me commande, ils rencontreront l'erreur: "l'entr√©e ne correspond √† aucune valeur d'interface".</i>  <i>Cela est d√ª √† l'absence de l'interface ¬´pppoe-isp3¬ª, qui sera configur√©e dans la section 3.3.2.</i>  <i>√Ä ce stade, vous pouvez entrer ¬´ether3¬ª au lieu de ¬´pppoe-isp3¬ª.</i>  <i>Apr√®s avoir termin√© le paragraphe 3.3.2, vous devez revenir en arri√®re et mettre le nom actuel de l'interface.</i> <i><br><br></i>  <i>Afin de ne pas marquer les connexions d√©j√† marqu√©es, j'utilise la condition connection-mark = no-mark au lieu de connection-state = new.</i> <i><br><br></i>  <i>passthrough = no - car dans cette m√©thode d'impl√©mentation, le re-marquage est exclu, et pour acc√©l√©rer, vous pouvez interrompre l'√©num√©ration des r√®gles apr√®s la premi√®re correspondance.</i> <br><br>  Il convient de garder √† l'esprit que nous n'interf√©rons toujours pas avec le routage.  Maintenant, il n'y a que des √©tapes de pr√©paration.  La prochaine √©tape de mise en ≈ìuvre sera le traitement du trafic de transit, qui est retourn√© via une connexion r√©guli√®re du destinataire dans le r√©seau local.  C'est-√†-dire  ces paquets qui (voir sch√©ma) ont travers√© le routeur en cours de route: <br><br>  <b>"Input Interface" =&gt; "Prerouting" =&gt; "Routing Decision" =&gt; "Forward" =&gt; "Post Routing" =&gt; "Output Interface"</b> et arriv√© √† destination sur le r√©seau local. <br><br>  <u><b>Important!</b></u>  Dans ROS, il n'y a pas de division logique entre les interfaces externes et internes.  Si nous suivons le chemin du paquet de r√©ponse dans le diagramme ci-dessous, il suivra le m√™me chemin logique que la demande: <br><br>  <b>"Input Interface" =&gt; "Prerouting" =&gt; "Routing Decision" =&gt; "Forward" =&gt; "Post Routing" =&gt; "Output Interface"</b> juste pour la requ√™te " <b>Input Interface</b> " il y avait une interface ISP, et pour la r√©ponse - LAN <br><br>  2.2.  Nous dirigeons le trafic de retour vers les tables de routage correspondantes: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=prerouting \ comment="Routemark transit out via ISP1" connection-mark=conn_isp1 \ dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp1 passthrough=no /ip firewall mangle add action=mark-routing chain=prerouting \ comment="Routemark transit out via ISP2" connection-mark=conn_isp2 \ dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp2 passthrough=no /ip firewall mangle add action=mark-routing chain=prerouting \ comment="Routemark transit out via ISP3" connection-mark=conn_isp3 \ dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp3 passthrough=no</code> </pre> <br>  <i><b>Remarque.</b></i>  <i><b>in-interface-list =! WAN - nous travaillons uniquement avec le trafic provenant du r√©seau local et dst-address-type =! local sans l'adresse de destination des adresses d'interface du routeur lui-m√™me.</b></i> <i><b><br></b></i> <br><br>  La m√™me chose pour les paquets locaux qui sont arriv√©s au routeur en cours de route: <br><br>  <b>"Interface d'entr√©e" =&gt; "Pr√©routage" =&gt; "D√©cision de routage" =&gt; "Entr√©e" =&gt; "Processus local"</b> <br><br>  <u><b>Important!</b></u>  La r√©ponse ira dans le sens suivant: <br><br>  <b>"Processus local" =&gt; "D√©cision de routage" =&gt; "Sortie" =&gt; "Post-routage" =&gt; "Interface de sortie"</b> <b><br></b> <br>  2.3.  Nous dirigeons le trafic local de r√©ponse vers les tables de routage correspondantes: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=output \ comment="Routemark local out via ISP1" connection-mark=conn_isp1 \ dst-address-type=!local new-routing-mark=to_isp1 passthrough=no /ip firewall mangle add action=mark-routing chain=output \ comment="Routemark local out via ISP2" connection-mark=conn_isp2 \ dst-address-type=!local new-routing-mark=to_isp2 passthrough=no /ip firewall mangle add action=mark-routing chain=output \ comment="Routemark local out via ISP3" connection-mark=conn_isp3 \ dst-address-type=!local new-routing-mark=to_isp3 passthrough=no</code> </pre> <br>  √Ä ce stade, la t√¢che de pr√©parer l'envoi d'une r√©ponse au canal Internet d'o√π provient la demande peut √™tre consid√©r√©e comme r√©solue.  Tout est balis√©, balis√© et pr√™t √† √™tre achemin√©. <br>  Un excellent effet ¬´secondaire¬ª de cette configuration est la possibilit√© de transf√©rer des ports DSNAT √† partir des deux fournisseurs (ISP2, ISP3) en m√™me temps.  Pas du tout, car sur ISP1, nous n'avons pas d'adresse routable.  Cet effet est important, par exemple, pour un serveur de messagerie avec deux MX qui regardent diff√©rents canaux Internet. <br><br>  Pour √©liminer les nuances du fonctionnement des r√©seaux locaux avec des routeurs IP externes, nous utilisons les solutions des paragraphes.  1.8.2 et 3.1.2.6. <br><br>  De plus, vous pouvez utiliser l'outil avec des marquages ‚Äã‚Äãet pour r√©soudre le paragraphe 3 du probl√®me.  Nous l'impl√©mentons comme ceci: <br><br>  2.4.  Nous dirigeons le trafic des clients locaux des listes de routage vers les tables correspondantes: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=prerouting \ comment="Address List via ISP1" dst-address-list=!BOGONS new-routing-mark=to_isp1 \ passthrough=no src-address-list=Via_ISP1 /ip firewall mangle add action=mark-routing chain=prerouting \ comment="Address List via ISP2" dst-address-list=!BOGONS new-routing-mark=to_isp2 \ passthrough=no src-address-list=Via_ISP2 /ip firewall mangle add action=mark-routing chain=prerouting \ comment="Address List via ISP3" dst-address-list=!BOGONS new-routing-mark=to_isp3 \ passthrough=no src-address-list=Via_ISP3</code> </pre> <br>  En cons√©quence, cela ressemble √† ceci (l'image est cliquable): <br><br> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/jw/bt/of/jwbtofiohmdeunznqgpnamyuhrm.jpeg"></a> <br><br><h4>  3. Configurer la connectivit√© ISP et activer le routage bas√© sur la marque </h4><br>  3.1.  Configurez la connexion √† ISP1: <br>  3.1.1.  Configurez une adresse IP statique: <br><br><pre> <code class="plaintext hljs">/ip address add interface=ether1 address=100.66.66.2/30 comment="ISP1 IP"</code> </pre> <br>  3.1.2.  Configurer le routage statique: <br>  3.1.2.1.  Ajoutez un itin√©raire d'urgence par d√©faut: <br><br><pre> <code class="plaintext hljs">/ip route add comment="Emergency route" distance=254 type=blackhole</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>Cette route permet au trafic provenant des processus locaux de passer par l'√©tape Route Decision, quel que soit l'√©tat des canaux de l'un des fournisseurs.</i>  <i>La nuance du trafic local sortant est que pour que le paquet se d√©place au moins quelque part, le routage actif vers la passerelle par d√©faut doit √™tre pr√©sent dans la table de routage principale.</i>  <i>Sinon, le colis sera simplement d√©truit.</i> <br><br>  En tant qu'extension de l'outil de <b>passerelle de contr√¥le</b> pour une analyse plus approfondie de l'√©tat du canal, je propose d'utiliser la m√©thode de l'itin√©raire r√©cursif.  L'essence de la m√©thode est que nous demandons au routeur de rechercher le chemin vers sa passerelle non pas directement, mais via une passerelle interm√©diaire.  En tant que telles passerelles de ¬´test¬ª, 4.2.2.1, 4.2.2.2 et 4.2.2.3 seront s√©lectionn√©es respectivement pour ISP1, ISP2 et ISP3. <br><br>  3.1.2.2.  Itin√©raire vers l'adresse de ¬´v√©rification¬ª: <br><br><pre> <code class="plaintext hljs">/ip route add check-gateway=ping comment="For recursion via ISP1" \ distance=1 dst-address=4.2.2.1 gateway=100.66.66.1 scope=10</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>La valeur d'√©tendue est r√©duite par d√©faut dans l'√©tendue cible ROS, afin d'utiliser davantage 4.2.2.1 comme passerelle r√©cursive.</i>  <i>Je souligne: la port√©e de la route vers l'adresse de ¬´v√©rification¬ª doit √™tre inf√©rieure ou √©gale √† la port√©e cible de la route qui r√©f√©rencera la v√©rification.</i> <br><br>  3.1.2.3.  Route r√©cursive par d√©faut pour le trafic sans marque de routage: <br><br><pre> <code class="plaintext hljs">/ip route add check-gateway=ping comment="Unmarked via ISP1" \ distance=2 gateway=4.2.2.1</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>La valeur distance = 2 est utilis√©e car ISP1 est d√©clar√© comme le premier en attente selon les termes de la t√¢che.</i> <br><br>  3.1.2.4.  Route r√©cursive par d√©faut pour le trafic avec la marque de routage "to_isp1": <br><br><pre> <code class="plaintext hljs">/ip route add comment="Marked via ISP1 Main" distance=1 gateway=4.2.2.1 \ routing-mark=to_isp1</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>En fait, nous commen√ßons enfin ici √† utiliser les fruits des travaux pr√©paratoires men√©s au paragraphe 2.</i> <i><br><br></i>  <i>Sur cette route, tout le trafic qui a marqu√© la route ¬´to_isp1¬ª sera dirig√© vers la passerelle du premier fournisseur, quelle que soit la passerelle par d√©faut pour la table principale actuellement active.</i> <br><br>  3.1.2.5.  La premi√®re route r√©cursive par d√©faut de secours pour le trafic √©tiquet√© des fournisseurs ISP2 et ISP3: <br><br><pre> <code class="plaintext hljs">/ip route add comment="Marked via ISP2 Backup1" distance=2 gateway=4.2.2.1 \ routing-mark=to_isp2 /ip route add comment="Marked via ISP3 Backup1" distance=2 gateway=4.2.2.1 \ routing-mark=to_isp3</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>Ces routes sont √©galement n√©cessaires pour r√©server le trafic provenant des r√©seaux locaux, qui sont membres de la liste d'adresses ¬´to_isp *¬ª ¬ª</i> <br><br>  3.1.2.6.  Nous √©crivons l'itin√©raire pour le trafic du routeur local vers Internet via ISP1: <br><br><pre> <code class="plaintext hljs">/ip route rule add comment="From ISP1 IP to Inet" src-address=100.66.66.2 table=to_isp1</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>En combinaison avec les r√®gles de la clause 1.8.2, une sortie vers le canal souhait√© avec une source donn√©e est fournie.</i>  <i>Ceci est essentiel pour la construction de tunnels dans lesquels l'adresse IP du c√¥t√© local (EoIP, IP-IP, GRE) est sp√©cifi√©e.</i>  <i>√âtant donn√© que les r√®gles des r√®gles de routage ip sont ex√©cut√©es de haut en bas, jusqu'√† ce que les conditions correspondent pour la premi√®re fois, cette r√®gle doit √™tre post√©rieure aux r√®gles du paragraphe 1.8.2.</i> <br><br>  3.1.3.  Nous √©crivons la r√®gle NAT pour le trafic sortant: <br><br><pre> <code class="plaintext hljs">/ip firewall nat add action=src-nat chain=srcnat comment="NAT via ISP1" \ ipsec-policy=out,none out-interface=ether1 to-addresses=100.66.66.2</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>NAT est tout ce qui va, sauf qu'il tombe dans les politiques IPsec.</i>  <i>J'essaie de ne pas utiliser action = masquerade √† moins que cela ne soit absolument n√©cessaire.</i>  <i>Il est plus lent et plus gourmand en ressources que src-nat car il calcule une adresse pour NAT pour chaque nouvelle connexion.</i> <br><br>  3.1.4.  Nous envoyons les clients de la liste auxquels il est interdit de quitter via d'autres fournisseurs directement √† la passerelle du fournisseur ISP1. <br><br><pre> <code class="plaintext hljs">/ip firewall mangle add action=route chain=prerouting \ comment="Address List via ISP1 only" dst-address-list=!BOGONS passthrough=no \ route-dst=100.66.66.1 src-address-list=Via_only_ISP1 place-before=0</code> </pre> <br>  <i><b>Remarque.</b></i>  <i>action = la route a une priorit√© plus √©lev√©e et est appliqu√©e plus t√¥t que les autres r√®gles de routage.</i> <i><br><br></i>  <i>place-before = 0 - place notre r√®gle en premier dans la liste.</i> <br><br>  3.2.  Nous configurons la connexion √† ISP2. <br><br>  √âtant donn√© que le fournisseur ISP2 nous donne les param√®tres via DHCP, il est raisonnable d'effectuer les modifications n√©cessaires avec un script qui d√©marre lorsque le client DHCP est d√©clench√©: <br><br><pre> <code class="plaintext hljs">/ip dhcp-client add add-default-route=no disabled=no interface=ether2 script=":if (\$bound=1) do={\r\ \n /ip route remove [ find gateway=\"4.2.2.2\" ]; /ip route remove \ [ find where dst-address ~\"4.2.2.2\" ]\r\ \n /ip route add check-gateway=ping comment=\"For recursion via ISP2\" \ distance=1 dst-address=4.2.2.2/32 gateway=\$\"gateway-address\" scope=10\r\ \n /ip route add check-gateway=ping comment=\"Unmarked via ISP2\" \ distance=1 gateway=4.2.2.2\r\ \n /ip route add comment=\"Marked via ISP2 Main\" distance=1 gateway=4.2.2.2 \ routing-mark=to_isp2\r\ \n /ip route add comment=\"Marked via ISP1 Backup1\" distance=2 \ gateway=4.2.2.2 routing-mark=to_isp1\r\ \n /ip route add comment=\"Marked via ISP3 Backup2\" distance=3 \ gateway=4.2.2.2 routing-mark=to_isp3\r\ \n /ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \ out-interface=\$\"interface\" to-addresses=\$\"lease-address\" \ comment=\"NAT via ISP2\"\r\ \n /ip route rule add comment=\"From ISP2 IP to Inet\" \ src-address=\$\"lease-address\" table=to_isp2 \r\ \n} else={\r\ \n /ip route remove [ find gateway=\"4.2.2.2\" ]; /ip route remove \ [ find where dst-address ~\"4.2.2.2\" ]\r\ \n /ip firewall nat remove [find comment=\"NAT via ISP2\"]\r\ \n /ip route rule remove [find comment=\"From ISP2 IP to Inet\"]\r\ \n}\r\ \n" use-peer-dns=no use-peer-ntp=no</code> </pre> <br>  Le script lui-m√™me dans la fen√™tre Winbox (cliquable): <br><br> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/dz/_f/hh/dz_fhhyltpdet5oush5wqwpud2e.jpeg"></a> <br>  <i><b>Remarque.</b></i>  <i>La premi√®re partie du script est d√©clench√©e lorsque le bail est re√ßu avec succ√®s, la seconde - apr√®s la lib√©ration du bail.</i>  <sup>Voir note 2</sup> <br><br>  3.3.  Nous configurons la connexion au fournisseur ISP3. <br><br>  Puisque le fournisseur de configuration nous donne de la dynamique, il est raisonnable de faire les changements n√©cessaires avec des scripts qui d√©marrent apr√®s la mont√©e et la chute de l'interface ppp. <br><br>  <i><b>Remarque.</b></i>  <i>L'interface ppp peut √™tre sp√©cifi√©e comme passerelle au lieu d'une adresse IP.</i>  <i>Cependant, dans ce cas, la route r√©cursive ne peut pas √™tre activ√©e.</i>  <i>Par cons√©quent, nous obtenons l'adresse IP du c√¥t√© fournisseur dans la variable et nous l'utilisons plus loin de la m√™me mani√®re que pour les autres fournisseurs</i> <br><br>  3.3.1.  Tout d'abord, configurez le profil: <br><br><pre> <code class="plaintext hljs">/ppp profile add comment="for PPPoE to ISP3" interface-list=WAN name=isp3_client \ on-down="/ip route remove [ find gateway=\"4.2.2.3\" ]\r\ \n/ip route remove [ find where dst-address ~\"4.2.2.3\" ]\r\ \n/ip firewall nat remove [find comment=\"NAT via ISP3\"]\r\ \n/ip route rule remove [find comment=\"From ISP3 IP to Inet\"]" \ on-up="/ip route remove [ find gateway=\"4.2.2.3\" ]; /ip route remove \ [ find where dst-address ~\"4.2.2.3\" ]\r\ \n/ip route add check-gateway=ping comment=\"For recursion via ISP3\" distance=1 \ dst-address=4.2.2.3/32 gateway=\$\"remote-address\" scope=10\r\ \n/ip route add check-gateway=ping comment=\"Unmarked via ISP3\" distance=3 \ gateway=4.2.2.3\r\ \n/ip route add comment=\"Marked via ISP3 Main\" distance=1 gateway=4.2.2.3 \ routing-mark=to_isp3\r\ \n/ip route add comment=\"Marked via ISP1 Backup2\" distance=3 gateway=4.2.2.3 \ routing-mark=to_isp1\r\ \n/ip route add comment=\"Marked via ISP2 Backup2\" distance=3 gateway=4.2.2.3 \ routing-mark=to_isp2\r\ \n/ip firewall mangle set [find comment=\"Connmark in from ISP3\"] \ in-interface=\$\"interface\"\r\ \n/ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \ out-interface=\$\"interface\" to-addresses=\$\"local-address\" \ comment=\"NAT via ISP3\"\r\ \n/ip route rule add comment=\"From ISP3 IP to Inet\" \ src-address=\$\"local-address\" table=to_isp3 "</code> </pre><br>  Le script lui-m√™me dans la fen√™tre Winbox (cliquable): <br><br> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/oz/tz/it/oztzitzzxgl5jz0g9jxskvtf3us.jpeg"></a> <br>  <i><b>Remarque.</b></i>  <i>String</i> <i><br></i>  <i><b>/ ip firewall mangle set [find comment = "Connmark in from ISP3"] in-interface = $ "interface";</b></i> <i><br></i>  <i>Vous permet de traiter correctement le changement de nom de l'interface, car il fonctionne avec son code et non le nom d'affichage.</i> <br><br>  3.3.2.  Maintenant, en utilisant le profil, cr√©ez une connexion ppp: <br><br><pre> <code class="plaintext hljs">/interface pppoe-client add allow=mschap2 comment="to ISP3" disabled=no \ interface=ether3 name=pppoe-isp3 password=isp3_pass profile=isp3_client \ user=isp3_client</code> </pre> <br><br>  <i><b>Remarque.</b></i>  <i>Certains fournisseurs "oublient" de donner le param√®tre "remote-address".</i>  <i>Dans ce cas, une fois connect√©, le script de configuration ne fonctionnera pas correctement et dans le journal, vous verrez l'erreur suivante:</i> <i><br></i>  <i>pppoe, ppp, info pppoe-isp3: impossible de d√©terminer l'adresse distante, en utilisant xxx.xxx.xxx.xxx</i> <i><br></i>  <i>Pour r√©soudre ce probl√®me, vous devez d√©finir manuellement l'adresse dans le profil ppp (n'importe quel mannequin):</i> <i><br></i> <pre> <i><code class="plaintext hljs">/ppp profile set isp3_client remote-address=169.254.69.96</code></i> </pre> <i><br></i>  <i>String</i> <i><br></i>  <i><b>/ ip firewall mangle set [find comment = "Connmark in from ISP3"] in-interface = $ "interface";</b></i> <i><br></i>  <i>Vous permet de traiter correctement le changement de nom de l'interface, car il fonctionne avec son code et non le nom d'affichage.</i> <br><br>  En touche finale, r√©glez l'horloge: <br><br><pre> <code class="plaintext hljs">/system ntp client set enabled=yes \ server-dns-names=0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pour ceux qui lisent jusqu'au bout </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La m√©thode propos√©e pour impl√©menter les multivans est la pr√©f√©rence personnelle de l'auteur et n'est pas la seule possible. </font><font style="vertical-align: inherit;">La bo√Æte √† outils ROS est vaste et flexible, ce qui, d'une part, cause des difficult√©s aux d√©butants, d'autre part - la raison de la popularit√©. </font><font style="vertical-align: inherit;">Explorez, essayez, d√©couvrez de nouveaux outils et solutions. </font><font style="vertical-align: inherit;">Par exemple, en application des connaissances acquises, il est possible dans cette impl√©mentation du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multivan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de remplacer l'outil </font><b><font style="vertical-align: inherit;">check-gateway</font></b><font style="vertical-align: inherit;"> par des routes r√©cursives avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netwatch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Remarques </font></font></h4><br><ol><li> <i><b>Check-gateway</b> ‚Äî ,             .     10 ,   . ,       20-30 .       ‚Äî     <b>Netwatch</b> ,      . <br>  <b>Check-gateway</b>        . <br><br> <u><b>!</b></u>          ,    .     <b>check-gateway=ping</b>  .</i> </li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il arrive qu'une d√©faillance se produise dans le m√©canisme d'op√©ration DHP, qui ressemble √† un client suspendu dans un √©tat de renouvellement. </font><font style="vertical-align: inherit;">Dans ce cas, la deuxi√®me partie du script ne fonctionnera pas, mais le trafic ne fera pas de mal √† marcher correctement, car l'√©tat surveille l'itin√©raire r√©cursif correspondant.</font></font></i> </li><li> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ECMP (Equal Cost Multi-Path)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ROS a la possibilit√© de sp√©cifier un itin√©raire avec plusieurs passerelles et la m√™me distance. </font><font style="vertical-align: inherit;">Dans ce cas, les connexions seront r√©parties sur les canaux √† l'aide de l'algorithme round robin, proportionnellement au nombre de passerelles sp√©cifi√©.</font></font></i> </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour que l'√©lan pour √©crire l'article aide √† fa√ßonner sa structure et √† mettre l'accent - merci personnel √† Eugene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@jscar</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr463813/">https://habr.com/ru/post/fr463813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr463799/index.html">Ce que je n'aime pas dans Windows 10</a></li>
<li><a href="../fr463801/index.html">3 qualit√©s cl√©s pour un chef de produit performant: Anton Stozhko</a></li>
<li><a href="../fr463803/index.html">Mon cinqui√®me jour avec Haiku: portons quelques programmes</a></li>
<li><a href="../fr463805/index.html">Sept livres pour ceux qui veulent devenir game designer</a></li>
<li><a href="../fr463811/index.html">Pr√©paration de l'application pour Android Q. Partie 1</a></li>
<li><a href="../fr463815/index.html">Pourquoi une banque √©trang√®re s'int√©resse-t-elle √† la source de vos fonds?</a></li>
<li><a href="../fr463817/index.html">20 chefs de produits et la structure matricielle la plus multidimensionnelle de tous. Conversation avec Skyeng</a></li>
<li><a href="../fr463819/index.html">Verrous PostgreSQL: 2. Verrous de cha√Æne</a></li>
<li><a href="../fr463821/index.html">AMO, Bitrix, 1C et autres: comment choisir par o√π commencer?</a></li>
<li><a href="../fr463823/index.html">Version Rust 1.37.0: optimisation guid√©e par le profil, constantes sans nom et fournisseur de fret</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>