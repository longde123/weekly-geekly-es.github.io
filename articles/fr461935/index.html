<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô£Ô∏è üòä üßïüèª Comment travailler avec Postgres in Go: pratiques, fonctionnalit√©s, nuances üë®‚Äçüî¨ üéπ üôà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le comportement inattendu de l'application par rapport √† l'utilisation de la base de donn√©es entra√Æne une guerre entre le DBA et les d√©veloppeurs: DBA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment travailler avec Postgres in Go: pratiques, fonctionnalit√©s, nuances</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/461935/"><p><img src="https://habrastorage.org/webt/yg/8e/hm/yg8ehmpmicsm7ye6fwju6kwog14.png"></p><br><p>  Le comportement inattendu de l'application par rapport √† l'utilisation de la base de donn√©es entra√Æne une guerre entre le DBA et les d√©veloppeurs: DBA crie: "Votre application supprime la base de donn√©es", les d√©veloppeurs - "Mais tout fonctionnait avant!"  Pire encore, DBA et les d√©veloppeurs ne peuvent pas s'entraider: certains ne connaissent pas les nuances de l'application et du pilote, d'autres ne connaissent pas les fonctionnalit√©s li√©es √† l'infrastructure.  Ce serait bien d'√©viter une telle situation. </p><br><p>  Vous devez comprendre, il ne suffit souvent pas de parcourir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">go-database-sql.org</a> .  Il vaut mieux s'armer de l'exp√©rience des autres.  Encore mieux si c'est une exp√©rience acquise par le sang et l'argent perdu. </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Uojy57I-xP0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Je m'appelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ryabinkov Artemy</a> et cet article est une interpr√©tation gratuite de mon rapport de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saints HighLoad 2019</a> . </p><br><h1 id="instrumenty">  Les outils </h1><br><p>  Vous pouvez trouver les informations minimales n√©cessaires sur la fa√ßon de travailler avec Go avec n'importe quelle base de donn√©es de type SQL sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">go-database-sql.org</a> .  Si vous ne l'avez pas lu, lisez-le. </p><br><h2 id="sqlx">  sqlx </h2><br><p>  √Ä mon avis, le pouvoir de Go est la simplicit√©.  Et cela s'exprime, par exemple, en ce qu'il est habituel pour Go d'√©crire des requ√™tes en SQL nu (ORM n'est pas √† l'honneur).  C'est √† la fois un avantage et une source de difficult√©s suppl√©mentaires. </p><br><p> Par cons√©quent, en prenant le package de langue standard de <code>database/sql</code> , vous souhaiterez √©tendre ses interfaces.  Une fois que cela se produit, consultez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/jmoiron/sqlx</a> .  Permettez-moi de vous montrer quelques exemples de la fa√ßon dont cette extension peut vous simplifier la vie. </p><br><p>  L'utilisation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StructScan</a> √©limine le besoin de d√©placer manuellement les donn√©es des colonnes dans les propri√©t√©s de la structure. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Place <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Country <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> City sql.NullString TelephoneCode <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`db:"telcode"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place err = rows.StructScan(&amp;p)</code> </pre> <br><p>  L'utilisation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NamedQuery</a> vous permet d'utiliser les propri√©t√©s de structure comme espaces r√©serv√©s dans une requ√™te. </p><br><pre> <code class="go hljs">p := Place{Country: <span class="hljs-string"><span class="hljs-string">"South Africa"</span></span>} sql := <span class="hljs-string"><span class="hljs-string">`.. WHERE country=:country`</span></span> rows, err := db.NamedQuery(sql, p)</code> </pre> <br><p>  L'utilisation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Get</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Select</a> vous permet de vous d√©barrasser de la n√©cessit√© d'√©crire manuellement des boucles qui r√©cup√®rent les lignes de la base de donn√©es. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pp []Place <span class="hljs-comment"><span class="hljs-comment">// Get   p     err = db.Get(&amp;p, ".. LIMIT 1") // Select   pp   . err = db.Select(&amp;pp, ".. WHERE telcode &gt; ?", 50)</span></span></code> </pre> <br><h1 id="drayvery">  Pilotes </h1><br><p>  <code>database/sql</code> est un ensemble d'interfaces pour travailler avec la base de donn√©es, et <code>sqlx</code> est leur extension.  Pour que ces interfaces fonctionnent, elles ont besoin d'une impl√©mentation.  Les pilotes sont responsables de la mise en ≈ìuvre. </p><br><p>  Pilotes les plus populaires: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/lib/pq</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pilote</a> <code>pure Go Postgres driver for database/sql.</code>  Ce pilote est rest√© longtemps la norme par d√©faut.  Mais aujourd'hui, il a perdu sa pertinence et n'est pas d√©velopp√© par l'auteur. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/jackc/pgx</a> - <code>PostgreSQL driver and toolkit for Go.</code>  Aujourd'hui, il vaut mieux choisir cet outil. </li></ul><br><p>  <strong>github.com/jackc/pgx</strong> - c'est le pilote que vous souhaitez utiliser.  Pourquoi? </p><br><ul><li>  <strong>Soutenu et d√©velopp√©</strong> activement. </li><li>  Il peut √™tre plus <strong>productif</strong> s'il est utilis√© sans interfaces de <code>database/sql</code> . </li><li>  Prise en charge de plus de <strong>60 types de PostgreSQL</strong> que <code>PostgreSQL</code> impl√©mente en dehors du standard <code>SQL</code> . </li><li>  La possibilit√© d'impl√©menter facilement la <strong>journalisation</strong> de ce qui se passe √† l'int√©rieur du pilote. </li><li>  <code>pgx</code> <strong>des erreurs lisibles par l'homme</strong> , tandis que juste <code>lib/pq</code> lance des attaques de panique.  Si vous n'attrapez pas de panique, le programme se bloquera.  ( <em>Vous ne devez pas utiliser la panique dans Go, ce n'est pas la m√™me chose que l'exception.</em> ) </li><li>  Avec <code>pgx</code> , nous avons la possibilit√© de <strong>configurer</strong> ind√©pendamment <strong>chaque connexion</strong> . </li><li>  Il existe un support <strong>pour le protocole de r√©plication logique</strong> <code>PostgreSQL</code> . </li></ul><br><h2 id="4kb">  4Ko </h2><br><p>  En r√®gle g√©n√©rale, nous √©crivons cette boucle pour obtenir des donn√©es de la base de donn√©es: </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, sql) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { err = rows.Scan(...) }</code> </pre> <br><p>  √Ä l'int√©rieur du pilote, nous obtenons des donn√©es en les stockant dans <strong>une m√©moire tampon de 4 Ko</strong> .  <code>rows.Next()</code> g√©n√®re un voyage r√©seau et remplit le tampon.  Si le tampon n'est pas suffisant, nous allons sur le r√©seau pour les donn√©es restantes.  Plus de visites sur le r√©seau - moins de vitesse de traitement.  En revanche, comme la limite de m√©moire tampon est de 4 Ko, n'oublions pas la totalit√© de la m√©moire du processus. </p><br><p>  Mais, bien s√ªr, je veux d√©visser le volume de tampon au maximum pour r√©duire le nombre de requ√™tes vers le r√©seau et r√©duire la latence de notre service.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous ajoutons</a> cette opportunit√© et essayons de d√©couvrir l'acc√©l√©ration attendue sur les <a href="">tests synth√©tiques</a> : </p><br><pre> <code class="bash hljs">$ go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -v -run=XXX -bench=. -benchmem goos: linux goarch: amd64 pkg: github.com/furdarius/pgxexperiments/bufsize BenchmarkBufferSize/4KB 5 315763978 ns/op 53112832 B/op 12967 allocs/op BenchmarkBufferSize/8KB 5 300140961 ns/op 53082521 B/op 6479 allocs/op BenchmarkBufferSize/16KB 5 298477972 ns/op 52910489 B/op 3229 allocs/op BenchmarkBufferSize/1MB 5 299602670 ns/op 52848230 B/op 50 allocs/op PASS ok github.com/furdarius/pgxexperiments/bufsize 10.964s</code> </pre> <br><p>  On peut voir qu'il n'y a pas de grande diff√©rence de vitesse de traitement.  Pourquoi </p><br><p>  Il s'av√®re que nous sommes limit√©s par la taille du tampon pour l'envoi de donn√©es √† l'int√©rieur m√™me de Postgres.  Ce tampon a une taille <a href="">fixe</a> de 8 <strong>Ko</strong> .  √Ä l'aide de <code>strace</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vous pouvez voir</a> que le syst√®me d'exploitation renvoie <code>8192</code> octets dans l'appel syst√®me en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lecture</a> .  Et <code>tcpdump</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">confirme avec la</a> taille des paquets. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tom Lane</a> (l' <em>un des principaux d√©veloppeurs du noyau Postgres</em> ) <a href="">commente</a> ceci comme ceci: </p><br><blockquote>  Traditionnellement, au moins, c'√©tait la taille des tampons de tuyau dans les machines Unix, donc en principe c'est la taille de bloc la plus optimale pour envoyer des donn√©es via un socket Unix. </blockquote><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Andres Freund</a> ( <em>d√©veloppeur Postgres de EnterpriseDB</em> ) <a href="">estime</a> qu'un tampon de 8 Ko n'est pas la meilleure option d'impl√©mentation √† ce jour, et vous devez tester le comportement sur diff√©rentes tailles et avec une configuration de socket diff√©rente. </p><br><p>  Nous devons √©galement nous rappeler que PgBouncer poss√®de √©galement un tampon et sa taille peut √™tre configur√©e avec le param√®tre <code>pkt_buf</code> . </p><br><h2 id="oids">  OID </h2><br><p>  Autre caract√©ristique du pilote pgx ( <em>v3</em> ): pour chaque connexion, il demande √† la base de donn√©es d'obtenir des informations sur l' <strong>ID d'objet</strong> ( <em>OID</em> ). </p><br><p>  Ces identifiants ont √©t√© ajout√©s √† Postgres pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">identifier de mani√®re unique</a> les objets internes: lignes, tableaux, fonctions, etc. </p><br><p>  Le pilote utilise la connaissance des <code>OIDs</code> pour comprendre quelle colonne de base de donn√©es dans quelle langue primitive ajouter des donn√©es.  Pour cela, <code>pgx</code> prend en charge une telle table (la <em>cl√© est le nom du type, la valeur est l'ID d'objet</em> ) </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]Value{ <span class="hljs-string"><span class="hljs-string">"_aclitem"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"_bool"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"_int4"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"_int8"</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, ... }</code> </pre> <br><p>  Cette impl√©mentation conduit au fait que le pilote pour chaque connexion √©tablie avec la base de donn√©es fait environ trois demandes pour former une table avec un <code>Object ID</code> .  Dans le mode de fonctionnement normal de la base de donn√©es et de l'application, le pool de connexions dans Go vous permet de ne pas g√©n√©rer de nouvelles connexions √† la base de donn√©es.  Mais √† la moindre d√©gradation de la base de donn√©es, le pool de connexions c√¥t√© application est √©puis√© et le nombre de connexions g√©n√©r√©es par unit√© de temps augmente consid√©rablement.  Les demandes d' <code>OIDs</code> assez lourdes, par cons√©quent, le pilote peut mettre la base de donn√©es dans un √©tat critique. </p><br><p>  Voici le moment o√π de telles demandes ont √©t√© vers√©es sur l'une de nos bases de donn√©es: </p><br><p><img src="https://habrastorage.org/webt/lm/ra/vb/lmravbubtqb2ah8dvbvvpklbz8m.png"></p><br><p>  <strong>15 transactions par minute</strong> en mode normal, soit un saut jusqu'√† <strong>6500 transactions</strong> lors de la d√©gradation. </p><br><p>  <strong>Que faire</strong> </p><br><p>  Tout d'abord, limitez la taille de votre piscine par le haut. </p><br><p>  Pour la <code>database/sql</code> cela peut √™tre fait avec la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DB.SetMaxOpenConns</a> .  Si vous abandonnez les interfaces <code>database/sql</code> et utilisez <code>pgx.ConnPool</code> (le <em>pool de connexions impl√©ment√© par le pilote lui-m√™me</em> ), vous pouvez sp√©cifier <code>MaxConnections</code> (la <em>valeur par d√©faut est 5</em> ). </p><br><p>  Par ailleurs, lors de l'utilisation de <code>pgx.ConnPool</code> pilote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©utilisera les</a> informations sur les <code>OIDs</code> re√ßus et n'effectuera pas de requ√™tes dans la base de donn√©es pour chaque nouvelle connexion. </p><br><p>  Si vous ne souhaitez pas refuser la <code>database/sql</code> , vous pouvez mettre en cache vous-m√™me les informations sur les <code>OIDs</code> . </p><br><pre> <code class="go hljs">github.com/jackc/pgx/stdlib.OpenDB(pgx.ConnConfig{ CustomConnInfo: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pgtype.ConnInfo, error)</span></span></span></span> { cachedOids = <span class="hljs-comment"><span class="hljs-comment">//  OIDs   . info := pgtype.NewConnInfo() info.InitializeDataTypes(cachedOids) return info, nil } })</span></span></code> </pre> <br><p>  Il s'agit d'une m√©thode de travail, mais son utilisation peut √™tre dangereuse dans deux conditions: </p><br><ul><li>  vous utilisez des types d'√©num√©ration ou de domaine dans Postgres; </li><li>  si l'assistant √©choue, vous basculez l'application vers la r√©plique, qui est vers√©e par r√©plication logique. </li></ul><br><p>  Le respect de ces conditions conduit au fait que les <code>OIDs</code> mis en cache deviennent invalides.  Mais nous ne pourrons pas les nettoyer, car nous ne savons pas √† quel moment passer √† une nouvelle base. </p><br><p>  Dans le monde <code>Postgres</code> , la r√©plication physique est g√©n√©ralement utilis√©e pour organiser la haute disponibilit√©, qui copie les instances de base de donn√©es petit √† petit, de sorte que les probl√®mes de mise en cache <code>OIDs</code> rarement vus dans la nature.  ( <em>Mais il vaut mieux v√©rifier avec votre administrateur de base de donn√©es le fonctionnement de la veille pour vous</em> ). </p><br><p>  Dans la prochaine version majeure du pilote <code>pgx</code> - <code>v4</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il n'y aura pas de</a> campagnes pour les <code>OIDs</code> .  D√©sormais, le pilote ne s'appuiera que sur la liste des <code>OIDs</code> en <code>OIDs</code> dans le code.  Pour les types personnalis√©s, vous devrez prendre le contr√¥le de la d√©s√©rialisation du c√¥t√© de votre application: le pilote abandonnera simplement un morceau de m√©moire en tant que tableau d'octets. </p><br><h1 id="logirovanie-i-monitoring">  Journalisation et surveillance </h1><br><p>  La surveillance et la journalisation aideront √† remarquer les probl√®mes avant que la base ne plante. </p><br><p>  <code>database/sql</code> fournit la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DB.Stats ()</a> .  L'instantan√© d'√©tat renvoy√© vous donnera une id√©e de ce qui se passe √† l'int√©rieur du pilote. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> DBStats <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxOpenConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-comment"><span class="hljs-comment">// Pool State OpenConnections int InUse int Idle int // Counters WaitCount int64 WaitDuration time.Duration MaxIdleClosed int64 MaxLifetimeClosed int64 }</span></span></code> </pre> <br><p>  Si vous utilisez directement le pool dans <code>pgx</code> , la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ConnPool.Stat ()</a> vous donnera des informations similaires: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ConnPoolStat <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AvailableConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> }</code> </pre> <br><p>  La journalisation est tout aussi importante et <code>pgx</code> vous permet de le faire.  Le pilote accepte l'interface <code>Logger</code> , en impl√©mentant laquelle, vous obtenez tous les √©v√©nements qui se produisent √† l'int√©rieur du pilote. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Logger <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Log a message at the given level with data key/value pairs. // data may be nil. Log(level LogLevel, msg string, data map[string]interface{}) }</span></span></code> </pre> <br><p>  Tr√®s probablement, vous n'avez m√™me pas √† impl√©menter cette interface vous-m√™me.  Dans <code>pgx</code> , il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ensemble d'adaptateurs</a> pour les enregistreurs les plus populaires, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">uber-go / zap</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sirupsen / logrus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rs / zerolog</a> . </p><br><h1 id="infrastruktura">  L'infrastructure </h1><br><p>  Presque toujours, lorsque vous travaillez avec <code>Postgres</code> vous utiliserez le <strong>pool de connexions</strong> , et ce sera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PgBouncer</a> ( <em>ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">odyss√©e</a> - si vous √™tes Yandex</em> ). </p><br><p>  Pourquoi donc, vous pouvez lire dans l'excellent article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">brandur.org/postgres-connections</a> .  En bref, lorsque le nombre de clients <strong>d√©passe 100, la</strong> vitesse de traitement des demandes commence √† se d√©grader.  Cela se produit en raison des caract√©ristiques de l'impl√©mentation de Postgres: le lancement d'un processus distinct pour chaque connexion, le m√©canisme de suppression des instantan√©s et l'utilisation de la m√©moire partag√©e pour l'interaction - tout cela affecte. </p><br><p>  Voici la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rence de</a> diverses impl√©mentations de pool de connexions: <br><img src="https://habrastorage.org/webt/im/p1/-n/imp1-nuasdxn1wmve7l89rrvmbw.png"></p><br><p>  Et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comparer la</a> bande passante avec et sans PgBouncer. </p><br><p><img src="https://habrastorage.org/webt/jc/cp/21/jccp2150oefyeiixeu005lpsl_0.png"></p><br><p>  Par cons√©quent, votre infrastructure ressemblera √† ceci: </p><br><p><img src="https://habrastorage.org/webt/bf/ee/ok/bfeeokt_cdojbuddo7_rhzddjis.png"></p><br><p>  O√π <code>Server</code> est le processus qui traite les demandes des utilisateurs.  Ce processus tourne dans <code>kubernetes</code> en 3 exemplaires ( <em>au moins</em> ).  S√©par√©ment, sur un serveur de fer, il y a <code>Postgres</code> , couvert par <code>PgBouncer'</code> .  <code>PgBouncer</code> lui <code>PgBouncer</code> m√™me <code>PgBouncer</code> un thread unique, nous lan√ßons donc plusieurs videurs, le trafic pour lequel nous √©quilibrons en utilisant <code>HAProxy</code> .  En cons√©quence, nous obtenons une telle cha√Æne d'ex√©cution de requ√™te dans la base de donn√©es: <code>   ‚Üí HAProxy ‚Üí PgBouncer ‚Üí Postgres</code> . </p><br><p>  <code>PgBouncer</code> peut fonctionner en trois modes: </p><br><ul><li>  <strong>Regroupement de sessions</strong> - pour chaque session, une connexion est √©mise et affect√©e √† celle-ci pour toute la dur√©e de vie. </li><li>  <strong>Pool de transactions</strong> - la connexion est active pendant l'ex√©cution de la transaction.  D√®s que la transaction est termin√©e, <code>PgBouncer</code> prend cette connexion et la rend √† une autre transaction.  Ce mode permet une tr√®s bonne √©limination des compos√©s. </li><li>  <strong>Mise en commun des instructions</strong> - mode <strong>obsol√®te</strong> .  Il a √©t√© cr√©√© uniquement pour prendre en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PL / Proxy</a> . </li></ul><br><p>  Vous pouvez voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">matrice</a> des propri√©t√©s disponibles dans chaque mode.  Nous choisissons le <strong>regroupement de transactions</strong> , mais il a des limites sur l'utilisation des <code>Prepared Statements</code> . </p><br><h2 id="transaction-pooling--prepared-statements">  Regroupement de transactions + √©tats pr√©par√©s </h2><br><p>  Imaginons que nous voulons pr√©parer une demande, puis l'ex√©cuter.  √Ä un moment donn√©, nous d√©marrons une transaction dans laquelle nous envoyons une demande de pr√©paration et nous obtenons l'ID de la demande pr√©par√©e dans la base de donn√©es. </p><br><p><img src="https://habrastorage.org/webt/pb/tu/bq/pbtubqa7cvmly0ntnhs0dwc9etc.png"></p><br><p>  Apr√®s, √† tout autre moment, nous g√©n√©rons une autre transaction.  Dans ce document, nous nous tournons vers la base de donn√©es et voulons r√©pondre √† la demande en utilisant l'identifiant avec les param√®tres sp√©cifi√©s. </p><br><p><img src="https://habrastorage.org/webt/uy/ci/h4/uycih4iuh8aasw43aqodbsxolac.png"></p><br><p>  En mode <strong>Transaction Pooling</strong> , deux transactions peuvent √™tre ex√©cut√©es dans des connexions diff√©rentes, mais l' <strong>ID d'instruction n'est</strong> valide que dans une seule connexion.  Nous obtenons une <code>prepared statement does not exist</code> erreur lors de la tentative d'ex√©cution d'une demande. </p><br><p>  Le plus d√©sagr√©able: puisque lors du d√©veloppement et des tests la charge est faible, <code>PgBouncer</code> √©met souvent la m√™me connexion et tout fonctionne correctement.  Mais d√®s que nous nous d√©ployons vers prod, les demandes commencent √† tomber avec une erreur. </p><br><p>  Trouvez maintenant les <code>Prepared Statements</code> dans ce code: </p><br><pre> <code class="go hljs">sql := <span class="hljs-string"><span class="hljs-string">`select * from places where city = ?`</span></span> rows, err := s.db.Query(sql, city)</code> </pre> <br><p>  Vous ne le verrez pas!  La pr√©paration des requ√™tes se fera implicitement dans <code>Query()</code> .  Dans le m√™me temps, la pr√©paration et l'ex√©cution de la demande se feront dans diff√©rentes transactions et nous recevrons pleinement tout ce que j'ai d√©crit ci-dessus. </p><br><p>  <strong>Que faire</strong> </p><br><p>  La premi√®re option, la plus simple, consiste √† <strong>basculer <code>PgBouncer</code> vers le <code>PgBouncer</code> de <code>Session pooling</code></strong> .  Une connexion est allou√©e √† la session, toutes les transactions commencent √† se connecter √† cette connexion et les requ√™tes pr√©par√©es fonctionnent correctement.  Mais dans ce mode, l'efficacit√© de l'utilisation des compos√©s laisse beaucoup √† d√©sirer.  Par cons√©quent, cette option n'est pas consid√©r√©e. </p><br><p>  La deuxi√®me option consiste <strong>√† pr√©parer une demande c√¥t√© client</strong> .  Je ne veux pas le faire pour deux raisons: </p><br><ul><li>  Vuln√©rabilit√©s SQL potentielles.  Le d√©veloppeur peut oublier ou faire √©chapper incorrectement. </li><li>  √âchapper aux param√®tres de la requ√™te chaque fois que vous devez √©crire avec vos mains. </li></ul><br><p>  Une autre option consiste √† <strong>encapsuler explicitement chaque demande dans une transaction</strong> .  Apr√®s tout, tant que la transaction est en cours, <code>PgBouncer</code> ne reprend pas la connexion.  Cela fonctionne, mais, en plus de la verbosit√© de notre code, nous recevons √©galement plus d'appels r√©seau: Begin, Prepare, Execute, Commit.  Total 4 appels r√©seau par demande.  La latence augmente. </p><br><p>  Mais je le veux √† la fois en toute s√©curit√© et de mani√®re pratique et efficace.  Et il y a une telle option!  Vous pouvez indiquer explicitement au pilote que vous souhaitez <strong>utiliser le mode de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">requ√™te simple</a></strong> .  Dans ce mode, il n'y aura pas de pr√©paration et la demande enti√®re passera en un seul appel r√©seau.  Dans ce cas, le pilote effectuera lui-m√™me le blindage de chacun des param√®tres ( <em><code>standard_conforming_strings</code> doit √™tre activ√© au niveau de la base ou lors de l'√©tablissement d'une connexion</em> ). </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... RuntimeParams: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"standard_conforming_strings"</span></span>: <span class="hljs-string"><span class="hljs-string">"on"</span></span>, }, PreferSimpleProtocol: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }</code> </pre> <br><h1 id="otmena-zaprosov">  Annuler les demandes </h1><br><p>  Les probl√®mes suivants sont li√©s √† l'annulation des demandes c√¥t√© application. </p><br><p>  Jetez un oeil √† ce code.  O√π sont les pi√®ges? </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, ...)</code> </pre> <br><p>  Go a une m√©thode pour contr√¥ler le flux d'ex√©cution du programme - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">context.Context</a> .  Dans ce code, nous transmettons le <code>ctx</code> pilote de sorte que lorsque le contexte est ferm√©, le pilote annule la demande au niveau de la base de donn√©es. </p><br><p>  En m√™me temps, nous pr√©voyons √©conomiser des ressources en annulant les demandes que personne n'attend.  Mais lors de l'annulation d'une demande, <code>PgBouncer</code> version <em>1.7</em> envoie √† la connexion des informations indiquant que cette connexion est pr√™te √† √™tre utilis√©e, puis la renvoie au pool.  Ce comportement de <code>PgBouncer'</code> induit en erreur le pilote qui, lors de l'envoi de la prochaine demande, re√ßoit instantan√©ment <code>ReadyForQuery</code> en r√©ponse.  Au final, nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©tectons des erreurs ReadyForQuery inattendues</a> . </p><br><p>  <code>PgBouncer</code> version <em>1.8 de</em> <code>PgBouncer</code> <em>,</em> ce comportement a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©t√© corrig√©</a> .  Utilisez la version actuelle de <code>PgBouncer</code> . </p><br><p>  Et, bien que, dans ce cas, les erreurs disparaissent - un comportement int√©ressant restera.  Dans certains cas, notre application peut recevoir des r√©ponses non pas √† sa demande, mais √† la voisine (l'essentiel est que les demandes correspondent au type et √† l'ordre des donn√©es demand√©es).  C'est-√†-dire, par exemple, √† la requ√™te <code>where user_id = 2</code> , la r√©ponse de la requ√™te <code>where user_id = 42</code> sera retourn√©e.  Cela est d√ª au traitement des demandes d'annulation √† diff√©rents niveaux: au niveau du pool de pilotes et du pool de videurs. </p><br><h3 id="otlozhennaya-otmena">  Annulation retard√©e </h3><br><p>  Pour annuler la demande, nous devons cr√©er une nouvelle connexion √† la base de donn√©es et demander une annulation.  <code>Postgres</code> cr√©e un processus distinct pour chaque connexion.  Nous envoyons une commande pour annuler la demande en <strong>cours</strong> dans un processus sp√©cifique.  Pour ce faire, cr√©ez une nouvelle connexion et transf√©rez-y l'ID de processus (PID) qui nous int√©resse.  Mais tandis que la commande d'annulation vole vers la base, la demande annul√©e peut se terminer d'elle-m√™me. </p><br><p><img src="https://habrastorage.org/webt/us/xf/v_/usxfv_i0ze_axpmjtlir183reiu.png"></p><br><p>  <code>Postgres</code> ex√©cutera la commande et annulera la demande en cours dans le processus donn√©.  Mais la demande en cours ne sera pas celle que nous souhaitions initialement annuler.  En raison de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce comportement</a> lorsque vous travaillez avec <code>Postgres</code> avec <code>PgBouncer</code> plus s√ªr de ne pas annuler la demande au niveau du pilote.  Pour ce faire, vous pouvez d√©finir la <code>CustomCancel</code> , qui n'annulera pas la demande, m√™me si <code>context.Context</code> utilis√©. </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... CustomCancel: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_ *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, }</code> </pre> <br><h1 id="cheklist-po-rabote-s-postgres">  Liste de contr√¥le Postgres </h1><br><p>  Au lieu de conclusions, j'ai d√©cid√© de faire une liste de contr√¥le pour travailler avec Postgres.  Cela devrait aider l'article √† s'ins√©rer dans ma t√™te. </p><br><ul><li>  Utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/jackc/pgx</a> comme pilote pour travailler avec Postgres. </li><li>  Limitez la taille du pool de connexions par le haut. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cachez les</a> <code>OIDs</code> ou utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pgx.ConnPool</a> si vous travaillez avec <code>pgx</code> version 3. </li><li>  Collectez les m√©triques du pool de connexions √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DB.Stats ()</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ConnPool.Stat ()</a> . </li><li>  Enregistrez ce qui se passe dans le pilote. </li><li>  Utilisez le mode de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">requ√™te simple</a> pour √©viter les probl√®mes de pr√©paration des requ√™tes en mode transactionnel <code>PgBouncer</code> . </li><li>  Mettez √† jour <code>PgBouncer</code> vers la derni√®re version. </li><li>  Soyez prudent avec l'annulation des demandes de l'application. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461935/">https://habr.com/ru/post/fr461935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461919/index.html">R√©utilisation des formulaires sur React</a></li>
<li><a href="../fr461921/index.html">HDMI-LVDS. D√©veloppement sur TSUMV59 de MStar</a></li>
<li><a href="../fr461923/index.html">Journ√©e portes ouvertes JetBrains √† Saint-P√©tersbourg: vid√©o</a></li>
<li><a href="../fr461927/index.html">Apprentissage par classement actif</a></li>
<li><a href="../fr461929/index.html">Surveillance et v√©rification de l'√©tat SSD sous Linux</a></li>
<li><a href="../fr461937/index.html">La loi de Parkinson et comment la briser</a></li>
<li><a href="../fr461939/index.html">Ann√©e d'aventure avec graph√®ne-python</a></li>
<li><a href="../fr461941/index.html">Masser</a></li>
<li><a href="../fr461945/index.html">Le condens√© des √©v√©nements pour les professionnels des RH dans le domaine des TI pour ao√ªt 2019</a></li>
<li><a href="../fr461949/index.html">AppCode 2019.2: Swift 5.1, analyse de la couverture du code par des tests, affichage du code d√©sassembl√© et plus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>