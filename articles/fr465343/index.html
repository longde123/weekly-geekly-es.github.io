<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîä üïµüèæ üò° Comment nous avons cr√©√© le moteur et le jeu pendant un an et demi. Deuxi√®me partie L'infrastructure üèà ‚è¨ üèõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tout d'abord, quelques commentaires sur les traces de l'article pr√©c√©dent. Nous travaillions vraiment √† Wargaming , o√π nous avons d√©velopp√© un moteur ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons cr√©√© le moteur et le jeu pendant un an et demi. Deuxi√®me partie L'infrastructure</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465343/"> Tout d'abord, quelques commentaires sur les traces de l'article pr√©c√©dent.  Nous travaillions vraiment √† <b>Wargaming</b> , o√π nous avons d√©velopp√© un moteur connu sous le nom de <b>dava.framework</b> ou <b>dava.engine</b> .  C'est pourquoi de nombreux anciens coll√®gues avec lesquels nous sommes toujours en bonnes relations participent activement √† la discussion. <br><br>  Un certain nombre de personnes ont des doutes: s'agit-il de la m√™me technologie ou d'une autre?  R√©ponse: il s'agit d'une nouvelle technologie √©crite √† partir de z√©ro. <br><br>  Comment avons-nous r√©ussi en seulement un an?  Notre √©quipe poss√®de une vaste exp√©rience.  Beaucoup d√©veloppent des moteurs et des jeux depuis plus de 15 ans. <br><br>  Pourquoi √† partir de z√©ro, si vous pouviez prendre notre ancien moteur, qui r√©side √©galement en open-source?  Il a environ 10 ans et la plupart du code est obsol√®te.  M√™me les meilleures parties du moteur, dont nous sommes fiers, contenaient parfois des morceaux de code et des rudiments de 5, 7 et parfois m√™me 10 ans.  De nombreuses solutions architecturales ont √©t√© con√ßues pour les appareils de l'√©poque - √† commencer par un iPhone 3G.  Maintenant, nous nous concentrons au moins sur l'iPad Air 1 et les appareils Android de puissance similaire.  En cons√©quence, les approches ont quelque peu chang√©. <br><a name="habracut"></a><br>  Et la question la plus courante: pourquoi poss√©der son moteur?  Dans le dernier article, il y avait plusieurs arguments de divers degr√©s de persuasion.  Je veux me concentrer sur l'essentiel: seule notre propre technologie peut vous permettre de tirer le meilleur parti du fer, de faire le maximum d'optimisations sp√©cifiquement pour votre gameplay, votre style visuel.  Nous nous positionnons, notamment en tant qu'entreprise technologique, non seulement en tant que d√©veloppeur de jeux.  Nous pensons qu'avec notre niveau d'ing√©nieurs et notre exp√©rience, nous pouvons s√©rieusement rivaliser sur le march√© des produits mobiles de haute technologie. <br><br>  Et maintenant au point: quels outils et techniques nous ont aid√©s √† accomplir cette t√¢che plut√¥t ambitieuse en peu de temps? <br><br><h4>  L'infrastructure </h4><br>  Nous avons choisi Atlassian Bitbucket Server + Jenkins.  Dans le Bitbucket se trouve le r√©f√©rentiel principal (ma√Ætre), auquel Jenkins est connect√©.  Chaque d√©veloppeur a sa propre fourchette.  Pour chaque t√¢che, une nouvelle fourche est cr√©√©e dans la fourche, qui est int√©gr√©e √† nouveau via la demande de tirage.  En g√©n√©ral, le sch√©ma est assez standard.  Chaque demande de traction est soumise √† un examen obligatoire et √† des tests automatiques.  Et, en cas de succ√®s, il fusionne automatiquement dans le ma√Ætre. <br><br><h4>  Jenkins </h4><br>  Jenkins a plusieurs d√©fauts: il est un ancien museau du Web, pas tr√®s rapide, gourmand, qui ressemble √† un portail Internet des ann√©es 90.  Cependant, sa flexibilit√©, un grand nombre de modules et sa gratuit√© en font un bon choix m√™me en 2019.  Apr√®s avoir jou√© avec les modules et les param√®tres, vous pouvez obtenir une apparence digestible, une description d√©clarative des pipelines (se trouvant dans le r√©f√©rentiel).  Soit dit en passant, il y a maintenant environ 40 pipelines: tests, √©diteurs, un jeu pour toutes les plateformes;  travailler avec l'infrastructure du serveur et le m√©ta-jeu.  Collectionnez les 20 buildagentov. <br><br>  √Ä l'avenir, bien s√ªr, je veux essayer des solutions hipster modernes, par exemple GitLab ou TravisCI auto-h√©berg√©.  Nous ne consid√©rons pas compl√®tement les solutions cloud (Nevercode, Bitrise, CircleCI, etc.) en raison de la grande taille de notre r√©f√©rentiel, de nos actifs et, par cons√©quent, du temps de construction et de la taille des artefacts. <br><br><h4>  Syst√®me de construction </h4><br>  La principale exigence du syst√®me √©tait la suivante: g√©n√©ration de projet pour iOS, MacOS, Android, Windows, Linux dans un seul script.  Nous avons r√©ussi √† essayer Premake, SCons, Bazel et CMake.  Pour diverses raisons, nous nous sommes arr√™t√©s au CMake √©prouv√©. <br><br>  Ces derni√®res ann√©es, CMake est devenu presque la norme pour les biblioth√®ques C ++.  Presque tout, du rappel √† SDL, peut √™tre connect√© √† votre projet CMake en quelques lignes.  Il y a bien s√ªr des exceptions, comme OpenSSL ou V8, avec lesquelles j'ai d√ª transpirer un peu.  En plus du Zmeik nu, nous avons d√©velopp√© un petit cadre (environ 3 000 lignes au total).  Caract√©ristiques cl√©s: <br>  Modularit√©.  Les diff√©rentes parties du moteur sont con√ßues comme des modules.  Par exemple, le son, l'interface utilisateur, la physique, le r√©seau, etc.  Chaque module peut avoir ses propres actifs (par exemple, des shaders) et peut avoir des d√©pendances sur d'autres modules. <br><br>  L'application finale sur le moteur (jeu, √©diteur, utilitaires) connecte uniquement les modules dont il a besoin.  Un peu √† part est le module de base, qui est une d√©pendance pour la plupart des autres modules.  Le noyau impl√©mente le point d'entr√©e, le cycle d'application principal, l'interaction avec le syst√®me d'exploitation et d'autres entit√©s de base. <br>  Modules tiers.  Notre framework vous permet de t√©l√©charger un d√©p√¥t ou une archive git en plusieurs lignes, de d√©compresser, de compiler, de copier des biblioth√®ques et / ou des sources.  Aujourd'hui, nous avons 66 de ces modules tiers: analytique, formats de fichiers tiers, middleware comme la physique, une biblioth√®que de sons, etc. <br><br><h4>  Processus de d√©veloppement </h4><br>  Sur la base de l'exp√©rience pr√©c√©dente, nous avons d√©cid√© d'ajouter √† la fois le moteur et le jeu dans un r√©f√©rentiel.  Cela vous permet de modifier sans difficult√© l'API du moteur et d'adapter le jeu de mani√®re synchrone.  Le r√©sultat a √©t√© le soi-disant monorepositaire avec ses avantages et ses inconv√©nients.  Mais, comme nous avions imm√©diatement pr√©vu de maintenir un rythme de d√©veloppement tr√®s √©lev√©, la possibilit√© d'un refactoring synchrone du moteur et du jeu l'emportait sur tous les autres inconv√©nients de cette solution. <br><br>  En moyenne, nous ajoutons plus de 20 demandes de tirage par jour.  Cela signifie que le ma√Ætre peut potentiellement √™tre bris√© 20 fois par jour.  Heureusement, en 1991, ils ont mis au point la technique d'int√©gration continue.  O√π en sommes-nous? <br><br><h4>  Int√©gration continue </h4><br>  Comme mentionn√© ci-dessus, un brunch est cr√©√© pour chaque t√¢che dans la fourchette du d√©veloppeur.  Ensuite, une demande d'extraction est cr√©√©e √† partir de ce brunch vers le r√©f√©rentiel principal.  Cette demande de traction r√©ussit une s√©rie de tests automatis√©s chez Jenkins: <br><br><ol><li>  Tests unitaires pour toutes les plateformes (windows, linux, macos, ios, android).  Googletest est utilis√© comme base et OpenCppCoverage, dont le rapport est v√©rifi√© par un script python suppl√©mentaire, est utilis√© pour v√©rifier le pourcentage de couverture.  Si le pourcentage de couverture pour un fichier particulier est inf√©rieur √† 75%, le test est consid√©r√© comme ayant √©chou√©.  Ainsi, nous avons couvert la plupart des classes de moteurs de bas niveau avec des tests. </li><li>  Codeformatter  Pour le code C ++, nous utilisons le format clang.  Le formatage du code modifi√© se produit d'abord automatiquement lors de la validation sur la machine du d√©veloppeur, puis il est v√©rifi√© dans le test.  Pour javascript, qui est utilis√© comme langage de script, npm linter est utilis√©. </li><li>  Tests d'actifs.  Un groupe de tests assez important: de la validation des formats de fichiers √† la v√©rification des d√©pendances (par exemple, v√©rification de l'existence de la texture utilis√©e dans le niveau de jeu). </li><li>  Tests unitaires et fonctionnels de l'√©diteur.  Une partie int√©grante du moteur est l'√©diteur, o√π les niveaux de jeu et autres actifs sont cr√©√©s et modifi√©s.  En plus des tests unitaires, froglogic Squish pour Qt est utilis√© pour tester l'√©diteur - un utilitaire pour les tests GUI automatiques.  Tout cela nous permet de nous passer de tests manuels de l'√©diteur.  De plus, selon les critiques d'artistes et de level designers, le niveau de sa qualit√© et de sa stabilit√© est plus √©lev√© que dans l'entreprise pr√©c√©dente, lorsque nous avions une √©quipe de cinq testeurs.  Dans le m√™me temps, les versions se produisent quotidiennement et, avec des tests manuels, les versions se produisent toutes les 2 semaines. </li><li>  Tests fonctionnels du jeu.  Il est clair que je souhaite utiliser des tests fonctionnels automatiques pour le jeu.  Par cons√©quent, nous avons commenc√© √† d√©velopper le syst√®me suivant: </li></ol><br><ul><li>  l'application de test (en particulier - un script python) lance un serveur de jeu et un client avec certains param√®tres </li><li>  le serveur et le client en cours d'ex√©cution ouvrent le port r√©seau, </li><li>  L'application de test s'y connecte et envoie des commandes: t√©l√©chargez une carte, s√©lectionnez un personnage et des armes, d√©placez-vous vers un point, visez, tirez, etc. </li><li>  la syntaxe de test elle-m√™me est python pytest.  Ce syst√®me est actuellement en d√©veloppement actif. </li></ul><br>  La plupart des projets de tests sont collect√©s avec le drapeau ¬´traiter les avertissements comme des erreurs¬ª activ√©, et sur la plate-forme MacOS avec le clang AddressSanitizer √©galement activ√©, ce qui vous permet de d√©tecter encore plus d'erreurs au stade de la pr√©paration de la demande d'extraction. <br><br>  En plus des tests, chaque demande d'extraction est examin√©e par au moins deux autres d√©veloppeurs et, si n√©cessaire, est envoy√©e pour r√©vision.  Lorsque tous les tests sont termin√©s et que les examinateurs n'ont aucun commentaire, la demande de retrait se bloque automatiquement. <br>  √âtant donn√© que certains tests peuvent prendre un temps consid√©rable (par exemple, un test complet de l'√©diteur d'interface graphique dure plus d'une heure), un script raccourci est utilis√© dans les demandes d'extraction.  L'ensemble complet de tests est lanc√© dans l'assistant toutes les 4 heures. <br><br>  √Ä ce jour, 6 600 pull-qu√™tes ont √©t√© cr√©√©es et organis√©es de cette mani√®re. <br><br><img src="https://habrastorage.org/webt/sh/io/7k/shio7kkx60nm-urpb2sx97z9w0s.jpeg"><br><br><h4>  Livraison continue </h4><br>  Nous utilisons le concept de versions automatiques quotidiennes (ou plut√¥t quotidiennes).  Comment cela se produit-il exactement: <br><br><ol><li>  la balise git est cr√©√©e, </li><li>  il ex√©cute des versions compl√®tes de tous les tests, </li><li>  en cas de succ√®s, des artefacts sont collect√©s: </li></ol><br><ul><li>  √©diteurs pour MacOS et Windows.  Ainsi, chaque matin, tout le monde a une nouvelle version des outils.  Et, gr√¢ce aux tests automatiques, nous avons confiance en leur qualit√© et leur stabilit√©. </li><li>  client et serveur de jeu pour toutes les plateformes.  Le client pour iOS est t√©l√©charg√© sur TestFlight, pour Android - sur Google Play, d'autres plates-formes - sur JFrog Artifactory, des serveurs de jeux et d'autres services - sur le cloud.  Autrement dit, chaque matin, nous avons une nouvelle version du jeu, pr√™te √† √™tre test√©e et test√©e. </li></ul><br>  Bien s√ªr, toutes les versions nocturnes ne se terminent pas avec succ√®s.  Certains tests peuvent √©chouer ou une erreur critique se produira au d√©marrage de l'application.  Dans ce cas, les probl√®mes d√©tect√©s sont r√©par√©s par le d√©veloppeur en service pendant la journ√©e et le processus de lib√©ration est red√©marr√©. <br>  Il y en a plusieurs en service tous les jours: <br><br><ol><li>  Pr√©pos√© de 1er niveau.  Surveille la stabilit√© des tests dans le r√©f√©rentiel principal. </li><li>  Pr√©pos√© de 2e niveau sur le jeu.  R√©parer les bugs du jeu. </li><li>  Pr√©pos√© de 2e niveau aux √©diteurs.  Corrige des bugs √©ditoriaux, conseille les utilisateurs (artistes, level designers, game designers). </li></ol><br>  Le jour m√™me de votre devoir, vous pouvez vous engager sur une dette technique: ajoutez les tests manquants pour l'ancienne fonctionnalit√©, compl√©tez la documentation ou effectuez une refactorisation, ce qui ne prend pas le temps avec la planification habituelle des versions. <br><br><img src="https://habrastorage.org/webt/bu/kf/w-/bukfw-ef19i1in1woa5ozjxgecm.jpeg"><br><br>  Dans le prochain article, nous examinerons de plus pr√®s l'architecture logicielle du moteur lui-m√™me, ainsi que les principaux modules et sous-syst√®mes. <br><br>  √Ä suivre ... <br><br>  La premi√®re partie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">habr.com/en/post/461623</a> <br><br><img src="https://habrastorage.org/webt/ic/l2/m8/icl2m8bbkuivjomsbt8ugzsibus.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465343/">https://habr.com/ru/post/fr465343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465323/index.html">Quelle sera la cryptographie post-quantique?</a></li>
<li><a href="../fr465325/index.html">Objets sp√©ciaux difficiles √† saisir pour les robots</a></li>
<li><a href="../fr465329/index.html">Mod√®le d'apprentissage automatique interpr√©t√©. 2e partie</a></li>
<li><a href="../fr465333/index.html">Comment regarder dans les yeux de Cassandra et ne pas perdre de donn√©es, de stabilit√© et de confiance en NoSQL</a></li>
<li><a href="../fr465341/index.html">Comment cr√©er un cloud priv√© pour la vid√©osurveillance</a></li>
<li><a href="../fr465345/index.html">√âv√©nement d'embauche FunCorp Mobile</a></li>
<li><a href="../fr465349/index.html">Avez-vous besoin d'Agile: 5 mod√®les √† tester</a></li>
<li><a href="../fr465351/index.html">Probl√®mes courants pour ceux qui ont remport√© le Gostender</a></li>
<li><a href="../fr465353/index.html">Audit de s√©curit√© ICS</a></li>
<li><a href="../fr465355/index.html">Lorsque ¬´a¬ª n'est pas √©gal √† ¬´a¬ª. Dans le sillage d'un hack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>