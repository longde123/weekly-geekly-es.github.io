<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äç‚öïÔ∏è ü§õüèº üçü Bouton magique pour LED sur ATtiny4 üë®‚Äçüé§ üß£ üë®‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SESAM 


 Il y a longtemps, j'avais un interrupteur miracle tactile SESAM . Je l'aimais vraiment. Mais les temps changent, il ne rentre plus √† l'int√©r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bouton magique pour LED sur ATtiny4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411263/"><h4 id="sezam">  SESAM </h4><br><p> Il y a longtemps, j'avais un interrupteur miracle tactile <em>SESAM</em> .  Je l'aimais vraiment.  Mais les temps changent, il ne rentre plus √† l'int√©rieur, puis il n'a pas √©t√© con√ßu pour fonctionner avec toutes sortes de lampes √† √©conomie d'√©nergie √† la mode.  J'ai aim√© le principe de gestion.  Une courte pression du capteur alluma / √©teint la lumi√®re et une longue ajusta la luminosit√©.  <em>Peu importe</em> - le disjoncteur √©tait <em>K145AP2</em> , un analogue de <em>Siemens S576B</em> (K145AP2 est toujours vendu). </p><br><p>  Sous la coupe, ma version d'√©mulation du fonctionnement de cette puce. </p><a name="habracut"></a><br><p>  Il n'y a pas si longtemps, j'ai construit moi-m√™me une bande lumineuse √† LED dans un profil en aluminium avec un diffuseur au-dessus de la table et la question s'est pos√©e √† propos de l'interrupteur.  La pr√©paration est en quelque sorte fastidieuse.  Alors qu'il accroche au fil - ce n'est pas beau, pour mettre un interrupteur ordinaire - g√¢che la vue, et il n'y a vraiment nulle part o√π aller. </p><br><p>  J'ai d√©cid√© de construire un interrupteur, et pour un et un gradateur, √† la fin du panneau de particules de 16 mm.  Faites-le toucher, recouvrez d'un autocollant que les fabricants de meubles boulonnent. </p><br><h4 id="zhelezo">  Le fer </h4><br><p>  Commenc√© avec un capteur.  J'ai essay√© sur le principe du transfert de charge vers l' <em>ATtiny13A</em> .  L'option fonctionne, mais j'√©tais trop paresseux pour me soucier des param√®tres de r√©glage automatique, etc.  Il n'a pas non plus pris la finale. </p><br><p>  J'ai alors d√©cid√© d'essayer d'impl√©menter le capteur sur la biblioth√®que <em>QTouch</em> .  En tant <em>que</em> capteur <em>ATtiny10</em> .  Il existe un utilitaire pr√™t √† l'emploi qui transforme <em>ATtiny10</em> en un bouton tactile avec tous les goodies.  Mais en sortie, le binaire est difficile √† y ajouter votre code.  J'ai pens√© √† quoi faire, j'ai surf√© sur Internet, puis je suis tomb√© <em>sur une</em> mention du <em>TTP223</em> - le contr√¥leur d'un bouton tactile.  Cette option me convenait parfaitement. </p><br><p>  En tant que MK, le choix s'est <em>port√©</em> sur <em>ATtiny4</em> .  Aussi petit que <em>TTP223</em> , un minuteur 16 bits.  Oui, et depuis longtemps je voulais faire quelque chose d'utile sur ces tinki. </p><br><p>  Comme cl√© - <em>P3055LD</em> de l'ancienne carte m√®re. </p><br><h4 id="pechatnaya-plata">  Circuit imprim√© </h4><br><p>  Lors du d√©veloppement d'une carte de circuit imprim√©, je suis parti du fait que les trous √† l'extr√©mit√© du panneau de particules n√©cessitaient le minimum possible, j'ai d√©cid√© qu'un diam√®tre de 7 mm serait tout √† fait suffisant.  Le conseil s'est av√©r√© 7x28mm, deux couches. </p><br><p>  Plus tard, lorsque la carte a √©t√© soud√©e, il est devenu clair que la carte ne rentrerait pas dans le trou de 7 mm, au moins 9 mm - ne tenait pas compte de la hauteur des √©l√©ments.  L'id√©e d'un autocollant a √©galement cess√© de plaire.  Et puis un talon de meuble a attir√© mon attention!  Con√ßu pour un trou de 10 mm et un diam√®tre int√©rieur de 7 mm exactement!  Tout a co√Øncid√©! </p><br><p>  Le capteur se patch sur une √©charpe s√©par√©e qui est soud√©e √† l'extr√©mit√© principale.  Sur les photos, vous pouvez voir. </p><br><div class="spoiler">  <b class="spoiler_title">Les photos</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/c90/811/124/c908111247ab756b2667c342f63910ef.jpg" alt="image sympa"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/8e7/bb2/c17/8e7bb2c177c2f1f1940cc7a9edf1d7c6.jpg" alt="image sympa"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/626/916/1bb/6269161bb3a78aa01bd7f6b77119af5d.jpg" alt="image sympa"><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e14/976/8f0/e149768f0a162a2598003f83d5741e4a.jpg" alt="image sympa"></p></div></div><br><h4 id="programma">  Le programme </h4><br><p>  Le programme de contr√¥le est √©crit en assembleur.  Toutes les 32 ms (horloge de surveillance), le capteur est interrog√©.  Selon l'√©tat actuel et la dur√©e de l'appui, certaines actions sont effectu√©es.  La logique de travail est l√©g√®rement diff√©rente du prototype <em>K145AP2</em> </p><br><p>  Si le voyant est √©teint (√©tat apr√®s la mise sous tension): </p><br><ul><li>  Un appui court allume l'√©clairage au m√™me niveau auquel il a √©t√© √©teint.  Lorsqu'il est allum√© pour la premi√®re fois avec une luminosit√© maximale </li><li>  Un appui long allume la lumi√®re au niveau maximum. </li></ul><br><p>  Si le voyant est allum√©: </p><br><ul><li>  Une courte pression √©teint la lumi√®re </li><li>  Un appui long modifie la luminosit√©.  La direction du changement de luminosit√© change par appui long r√©p√©t√© </li></ul><br><p>  Les pressions trop courtes (interf√©rences) du programme sont ignor√©es.  La luminosit√© est d√©finie par le coefficient PWM (16 bits).  Fr√©quence PWM environ 122 Hz (8 000 000 Hz / 2 <sup>16</sup> ‚âà 122 Hz) </p><br><p>  <strong>Pour compenser la perception psychophysiologique de la luminosit√© de l'√©clairage par rapport √† la luminosit√© r√©elle, un changement de cette derni√®re se produit le long d'une partie de la parabole cubique</strong> .  Habituellement, des tableaux sont utilis√©s pour cela, mais dans ma version, le coefficient est calcul√©.  Le coefficient varie avec la fr√©quence PWM, c'est-√†-dire que lorsque la luminosit√© change, chaque impulsion est obtenue avec sa propre dur√©e.  La valeur PWM minimale est limit√©e par logiciel. </p><br><p>  La plupart du temps, MK dort et consomme environ 16 microamp√®res avec le <em>TTP223</em> .  Autrement dit, le circuit est tout √† fait adapt√© aux appareils avec une alimentation autonome. </p><br><p>  <em>ATtiny4 a</em> six broches.  Deux pour l'alimentation, un par d√©faut pour la r√©initialisation.  J'en ai d√©j√† impliqu√© deux.  Un seul √† gauche.  J'ai pens√© comment l'utiliser.  Et puis je me suis souvenu du portable d'un nouvel ami avec trackpad Force Touch.  √Ä titre d'exp√©rience, j'ai d√©cid√© de faire quelque chose de similaire.  Je n'ai pas besoin de beaucoup de fiabilit√© de la r√©ponse, et il y a beaucoup de vibromoteurs d'anciens t√©l√©phones.  En cons√©quence, j'ai impl√©ment√© une telle fonction dans le programme qu'une impulsion courte appara√Æt sur une sortie libre, lorsque la limite de r√©glage est atteinte.  Dans <em>K145AP2,</em> lorsque la limite de r√©glage est atteinte, la direction du r√©glage change.  Par cons√©quent, une certaine habilet√© √©tait n√©cessaire pour retirer la main du capteur au maximum ou au minimum.  Dans ma mise en ≈ìuvre, lorsque la fronti√®re est atteinte, l'ajustement s'arr√™te.  Le temps d'ajustement total d'une fronti√®re √† l'autre est d'environ 4 secondes. </p><br><p>  Code disponible sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Poussez-le!">GitHub</a> </p><br><h4 id="tpi-cherez-arduinu">  TPI via Arduino </h4><br><p>  S√©par√©ment, je note la programmation de MK.  Mon <em>JTAGICE3</em> ne prend pas en charge l'interface de programmation TPI.  Mais, heureusement, de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bonnes personnes ont √©crit un croquis sur Arduin</a> pour programmer cette petite chose.  Pas tout de suite, mais tout a fonctionn√© pour moi, le firmware a √©t√© inond√© et tout a fonctionn√©.  En plus des arduins, 4 r√©sistances sont n√©cessaires.  L'ensemble du processus est peint dans un croquis. </p><br><h4 id="itog">  R√©sum√© </h4><br><p>  Le bouton magique est install√© et fonctionne comme pr√©vu.  La consommation et les dimensions actuelles lui permettent d'√™tre int√©gr√© dans des appareils √† alimentation autonome. </p><br><p>  Je n'ai pas obtenu l'effet attendu de la vibration.  Ici, des exp√©riences avec le site d'installation sont apparemment n√©cessaires. </p><br><p>  Dans le prototype <em>K145AP2</em> et l'analogue <em>Siemens S576B,</em> il y a une conclusion "Sleep".  Il s'agit d'un tel mode dans lequel la luminosit√© diminue tr√®s lentement jusqu'√† ce qu'elle soit compl√®tement d√©sactiv√©e.  Comme pr√©vu par le constructeur, pour cela un capteur suppl√©mentaire est install√© pr√®s de la t√™te du lit.  16 bits du temporisateur PWM activent ce mode. </p><br><p>  Cela vient d'id√©es pour l'avenir. </p><br><div class="spoiler">  <b class="spoiler_title">Bouton en place</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/getpro/geektimes/post_images/757/2da/2b5/7572da2b50cf61fc18aef6e609b80650.jpg" alt="image sympa"></p></div></div><br><p>  Comme tout. </p><br><p>  Merci √† tous! </p><br><p>  UPD: Comme promis, j'ai augment√© la fr√©quence PWM √† pr√®s de 1 kHz.  Code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Poussez-le!">Github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr411263/">https://habr.com/ru/post/fr411263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr411253/index.html">La fusion des √©toiles √† neutrons a mis fin aux alternatives de la mati√®re noire et de l'√©nergie noire</a></li>
<li><a href="../fr411255/index.html">Des applications d√©centralis√©es pour des millions d'utilisateurs sur Ethereum</a></li>
<li><a href="../fr411257/index.html">Aux √âtats-Unis, ils cr√©ent un syst√®me laser qui effrayera l'ennemi par le son</a></li>
<li><a href="../fr411259/index.html">Nous connectons un compteur d'eau √† une maison intelligente</a></li>
<li><a href="../fr411261/index.html">R√©ponse vibratoire dans les proth√®ses: une nouvelle fa√ßon d'am√©liorer le contr√¥le des membres bioniques</a></li>
<li><a href="../fr411265/index.html">Cas d'espionnage (partie 3)</a></li>
<li><a href="../fr411267/index.html">Qui est vraiment derri√®re les nouveaux smartphones de marque Nokia?</a></li>
<li><a href="../fr411269/index.html">Les trois composantes de ¬´LOAD¬ª</a></li>
<li><a href="../fr411271/index.html">La voiture √©lectrique Tesla Autopilot s'emm√™le sur des sections de route difficiles</a></li>
<li><a href="../fr411273/index.html">La premi√®re √©tude de l'attractivit√© des robolits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>