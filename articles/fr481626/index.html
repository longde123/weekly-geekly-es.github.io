<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª ü§ë ‚úäüèº Collections d'affichage complexes dans iOS: probl√®mes et solutions sur l'exemple du flux VKontakte üôáüèª üôÜüèΩ ü§æüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Je m'appelle Sasha, je suis d√©veloppeur iOS dans l'√©quipe qui cr√©e le flux VKontakte. Je vais maintenant vous expliquer comment nous optimisons ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Collections d'affichage complexes dans iOS: probl√®mes et solutions sur l'exemple du flux VKontakte</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/481626/"><p>  Salut  Je m'appelle Sasha, je suis d√©veloppeur iOS dans l'√©quipe qui cr√©e le flux VKontakte.  Je vais maintenant vous expliquer comment nous optimisons l'affichage de l'interface et contournons les probl√®mes associ√©s. <br>  Je pense que vous pouvez imaginer ce qu'est la bande VK.  Il s'agit d'un √©cran o√π vous pouvez visualiser une vari√©t√© de contenus: textes, images statiques, gifs anim√©s, √©l√©ments int√©gr√©s (vid√©o et musique).  Tout cela doit √™tre affich√© en douceur, d'o√π les exigences √©lev√©es sur les performances des solutions. </p><br><p>  Voyons maintenant quelles approches standard pour travailler avec les mappages existent et quelles limitations ou avantages doivent √™tre pris en compte. </p><br><p>  Si vous aimez √©couter plus que lire, l'enregistrement vid√©o du reportage est <a href="https://vk.com/video-147415323_456239051">ici</a> . </p><br><p><img src="https://habrastorage.org/webt/6u/np/1d/6unp1dycdkq5wxkhtv-6ixrmv-q.png"></p><a name="habracut"></a><br><h1 id="soderzhanie">  Table des mati√®res </h1><br><ol><li> Description et calcul de la disposition <br>  1.1.  Disposition automatique <br>  1.2.  Calcul de <code>frame</code> manuel </li><li>  Calcul de la taille du texte <br>  2.1.  M√©thodes standard pour calculer la taille de <code>UILabel</code> / <code>UITextView</code> / <code>UITextField</code> <br>  2.2.  <code>NSAttributedString</code> / <code>NSString</code> <br>  2.3.  Textkit <br>  2.4.  Coretext </li><li>  Comment fonctionne le flux VKontakte? </li><li>  Comment obtenir de meilleures performances <br>  4.1 Pourquoi des probl√®mes de performances <br>  4.2. <code>CATransaction.commit</code> <br>  4.3.  Pipeline de rendu <br>  4.4.  Les lieux de performance les plus vuln√©rables </li><li>  Outils de mesure <br>  5.1.  Trace de syst√®me m√©tallique <br>  5.2.  Nous corrigeons les baisses de performances dans le code pendant l'ex√©cution de l'application </li></ol><br><ul><li>  Comment rechercher des probl√®mes.  Recommandations </li><li>  Conclusion </li><li>  Sources d'information </li></ul><br><h1 id="1-opisanie-i-vychislenie-layout">  <strong>1. Description et calcul de la disposition</strong> </h1><br><p>  Tout d'abord, rappelons comment cr√©er une structure d'interface visuelle ( <em>mise en page</em> ) √† l'aide d'outils classiques.  Par souci d'√©conomie d'espace, nous nous passerons des listes - je vais simplement lister les solutions et expliquer leurs fonctionnalit√©s. </p><br><h2 id="11-auto-layout">  <strong>1.1.</strong>  <strong>Disposition automatique</strong> </h2><br><p>  La fa√ßon la plus populaire de cr√©er une interface dans iOS est peut-√™tre d'utiliser le syst√®me de mise en <a href="https://developer.apple.com/library/archive/documentation/UserExperience/Conceptual/AutolayoutPG/index.html">page Auto Layout d'</a> Apple.  Il est <a href="https://habr.com/ru/company/oleg-bunin/blog/437584/">bas√© sur</a> l'algorithme de <a href="https://constraints.cs.washington.edu/cassowary/">Cassowary</a> , inextricablement li√© au concept de <em>contraintes.</em> </p><br><p>  <em>Pour l'instant, n'oubliez pas que l'interface impl√©ment√©e √† l'aide de la mise en page automatique est bas√©e sur des restrictions.</em> </p><br><p>  <strong>Caract√©ristiques de l'approche:</strong> </p><br><ul><li>  Le syst√®me de contraintes est transform√© en <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">un probl√®me de programmation lin√©aire</a> . </li><li>  <a href="https://constraints.cs.washington.edu/solvers/cassowary-tochi.pdf">Cassowary r√©sout le</a> probl√®me d'optimisation r√©sultant en utilisant la <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25BC%25D0%25BF%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2581-%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4">m√©thode simplex</a> .  Cette m√©thode a une complexit√© asymptotique exponentielle.  Qu'est-ce que cela signifie?  √Ä mesure que le nombre de contraintes dans la disposition augmente, dans le pire des cas, les calculs peuvent ralentir de fa√ßon exponentielle. </li><li>  Les valeurs de <a href="https://developer.apple.com/documentation/uikit/uiview/1622621-frame"><code>frame</code></a> r√©sultantes pour <a href="https://developer.apple.com/documentation/uikit/uiview"><code>UIView</code></a> sont la solution au probl√®me d'optimisation correspondant. </li></ul><br><p>  <strong>Avantages de l'utilisation de la mise en page automatique:</strong> </p><br><ul><li>  <a href="https://developer.apple.com/videos/play/wwdc2018/220">Sur des mappages simples, une complexit√© de calcul lin√©aire est possible</a> . </li><li>  Il s'entend bien avec tous les √©l√©ments standard, car il s'agit de la technologie "native" d'Apple. </li><li>  <code>UIView</code> √† l' <code>UIView</code> fonctionne avec <code>UIView</code> . </li><li>  Disponible dans Interface Builder, qui vous permet de d√©crire la mise en page dans un Storyboard ou XIB. </li><li>  Il garantit une solution √† jour m√™me pendant la transition.  Cela signifie que la valeur de <code>frame</code> de chaque <code>UIView</code> toujours (!) Une solution √† la t√¢che de mise en page r√©elle. </li></ul><br><p>  Les capacit√©s du syst√®me sont suffisantes pour la plupart des √©crans.  Mais il ne convient pas pour cr√©er des bandes avec une √©norme quantit√© de contenu h√©t√©rog√®ne.  Pourquoi? </p><br><p>  <strong>Il est important de se rappeler que la disposition automatique:</strong> </p><br><ul><li>  <em>Fonctionne uniquement dans le thread principal</em> .  Supposons que les ing√©nieurs Apple aient choisi le Mainstream comme point de synchronisation de la solution de mise en page automatique et les valeurs de trame de tous les <code>UIView</code> .  Sans cela, vous devrez calculer la disposition automatique dans un thread s√©par√© et synchroniser constamment les valeurs avec le thread principal. </li><li>  <em>Il peut fonctionner lentement sur des repr√©sentations complexes</em> , car il est bas√© sur un algorithme de force brute dont la complexit√© dans le pire des cas est exponentielle. </li><li>  <em>Disponible</em> <em>avec iOS 6.0</em> .  Maintenant, ce n'est gu√®re un probl√®me, mais cela vaut la peine d'√™tre consid√©r√©. </li></ul><br><p>  <em>Conclusion: en utilisant la disposition automatique, il est pratique de cr√©er des affichages sans ou avec des collections, mais sans relations complexes entre les √©l√©ments.</em> </p><br><h2 id="12-raschyot-frame-vruchnuyu">  <strong>1.2.</strong>  <strong>Calcul de <code>frame</code> manuel</strong> </h2><br><p>  L'essence de l'approche: nous calculons nous-m√™mes toutes les valeurs de <code>frame</code> .  Par exemple, nous impl√©mentons les m√©thodes <a href="https://developer.apple.com/documentation/uikit/uiview/1622482-layoutsubviews%3Flanguage%3Dobjc%2560"><code>layoutSubviews</code></a> , <a href="https://developer.apple.com/documentation/uikit/uiview/1622625-sizethatfits"><code>sizeThatFits</code></a> .  Autrement dit, dans <code>layoutSubviews</code> m√™mes tous les √©l√©ments enfants, dans <code>sizeThatFits</code> nous calculons la taille correspondant √† l'emplacement souhait√© des √©l√©ments enfants et du contenu. </p><br><p>  Qu'est-ce que √ßa donne?  Nous pouvons transf√©rer des calculs complexes vers le flux d'arri√®re-plan et des calculs relativement simples peuvent √™tre effectu√©s dans le flux principal. </p><br><p>  Quel est le probl√®me?  Vous devez impl√©menter les calculs vous-m√™me, il est facile de se tromper.  Vous devez √©galement vous assurer que la position des enfants et les r√©sultats renvoy√©s dans <code>sizeThatFits</code> . </p><br><p>  <strong>L'auto-√©valuation est justifi√©e si:</strong> </p><br><ul><li>  Nous avons rencontr√© ou nous pr√©voyons rencontrer des limitations de performances de mise en page automatique. </li><li>  l'application a une collection complexe et il y a de fortes chances que l'√©l√©ment d√©velopp√© tombe dans l'une de ses cellules; </li><li>  nous voulons calculer la taille de l'√©l√©ment dans le fil d'arri√®re-plan; </li><li>  nous affichons √† l'√©cran des √©l√©ments non standard, dont la taille doit √™tre constamment recompt√©e en fonction du contenu ou de l'environnement. <br><img src="https://habrastorage.org/webt/tg/-l/nl/tg-lnlwfkzfzkqir1xdd2dun6la.png"></li></ul><br><p>  <strong>Un exemple.</strong>  Dessinez des info-bulles qui √©voluent automatiquement pour s'adapter au contenu.  La partie la plus int√©ressante de cette t√¢che est de savoir comment calculer la taille visuelle du texte dans chaque info-bulle. </p><br><hr><br><h1 id="2-vychislenie-razmera-teksta">  <strong>2. Calcul de la taille du texte</strong> </h1><br><p>  Ce probl√®me peut √™tre r√©solu de quatre mani√®res au moins, chacune reposant sur son propre ensemble de m√©thodes.  Et chacun a ses propres caract√©ristiques et limites. </p><br><h2 id="21-standartnye-metody-vychisleniya-razmera-uilabeluitextviewuitextfield">  <strong>2.1.</strong>  <strong>M√©thodes standard pour calculer la taille de <code>UILabel</code> / <code>UITextView</code> / <code>UITextField</code></strong> </h2><br><p>  Les <a href="https://developer.apple.com/documentation/uikit/uiview/1622625-sizethatfits"><code>sizeThatFits</code></a> (utilis√©es par d√©faut dans <a href="https://developer.apple.com/documentation/uikit/uiview/1622630-sizetofit"><code>sizeToFit</code></a> ) et <a href="https://developer.apple.com/documentation/uikit/uiview/1622600-intrinsiccontentsize"><code>intrinsicContentSize</code></a> (utilis√©es dans Auto Layout) renvoient la taille pr√©f√©r√©e du contenu de la vue.  Par exemple, avec leur aide, nous pouvons savoir combien d'espace le texte √©crit dans <code>UILabel</code> . </p><br><p>  L'inconv√©nient est que les deux m√©thodes ne fonctionnent que dans le thread principal - elles ne peuvent pas √™tre appel√©es en arri√®re-plan. </p><br><p>  <strong>Quand les m√©thodes standard sont-elles utiles?</strong> </p><br><ul><li>  Si nous utilisons d√©j√† <code>sizeToFit</code> ou Auto Layout. </li><li>  Lorsqu'il y a des √©l√©ments standard dans l'affichage, et nous voulons obtenir leur taille dans le code. </li><li>  Pour tous les √©crans sans collections complexes. </li></ul><br><h2 id="22-metody-nsattributedstringnsstring">  <strong>2.2.</strong>  <strong>M√©thodes NSAttributedString / NSString</strong> </h2><br><p>  Notez les <a href="https://developer.apple.com/documentation/foundation/nsstring/1531844-sizewithattributes%3Flanguage%3Dobjc"><code>sizeWithAttributes</code></a> et <a href="https://developer.apple.com/documentation/foundation/nsstring/1531844-sizewithattributes%3Flanguage%3Dobjc"><code>sizeWithAttributes</code></a> .  Je ne conseille pas de les utiliser pour lire la taille du contenu de <code>UILabel</code> / <code>UITextView</code> / <code>UITextField</code> .  Je n'ai trouv√© nulle part dans la documentation des informations que les m√©thodes <code>NSString</code> et les m√©thodes de mise en page des √©l√©ments <code>UIView</code> sont bas√©es sur le m√™me code (m√™mes classes).  Ces deux groupes de classes appartiennent √† des cadres diff√©rents: Foundation et UIKit, respectivement.  Peut-√™tre avez-vous d√©j√† d√ª adapter le r√©sultat <code>UILabel</code> taille <code>UILabel</code> ?  Ou avez-vous rencontr√© le fait que les <a href="https://stackoverflow.com/questions/15965525/how-to-get-nsstring-size-when-nsstring-includes-emojis"><code> NSString</code> ne prennent pas en compte la taille des emoji</a> ?  Ce sont les probl√®mes que vous pouvez rencontrer. </p><br><p>  Je vais √©galement vous dire quelles classes sont responsables du dessin du texte dans <code>UILabel</code> / <code>UITextView</code> / <code>UITextField</code> , mais pour le moment, <code>UITextField</code> aux m√©thodes. </p><br><p>  <strong>L'utilisation de boundingRect et sizeWithAttributes en vaut la peine si nous:</strong> </p><br><ul><li>  Nous <a href="https://developer.apple.com/documentation/foundation/nsstring/1529855-drawinrect"><code>drawInRect</code></a> √©l√©ments d'interface non standard √† l'aide de <a href="https://developer.apple.com/documentation/foundation/nsstring/1529855-drawinrect"><code>drawInRect</code></a> , <a href="https://developer.apple.com/documentation/foundation/nsstring/1533109-drawatpoint"><code>drawAtPoint</code></a> ou d'autres m√©thodes de la <code>NSAttributedString</code> <code>NSString</code> / <code>NSAttributedString</code> . </li><li>  Nous voulons consid√©rer la taille des √©l√©ments dans le flux d'arri√®re-plan.  Encore une fois, ce n'est que lorsque vous utilisez les m√©thodes de rendu appropri√©es. </li><li>  Dessinez sur un <a href="https://developer.apple.com/documentation/coregraphics/cgcontextref%3Flanguage%3Dobjc">contexte</a> arbitraire, par exemple, affichez une ligne au-dessus de l'image. </li></ul><br><h2 id="23-textkit">  <strong>2.3.</strong>  <strong>Textkit</strong> </h2><br><p>  Cet outil comprend les classes standard <a href="https://developer.apple.com/documentation/uikit/nslayoutmanager"><code>NLayoutManager</code></a> , <a href="https://developer.apple.com/documentation/uikit/nstextstorage"><code>NSTextStorage</code></a> et <a href="https://developer.apple.com/documentation/uikit/nstextcontainer"><code>NSTextContainer</code></a> .  La disposition <code>UILabel</code> / <code>UITextView</code> / <code>UITextField</code> √©galement <a href="https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/TextAndWebiPhoneOS/CustomTextProcessing/CustomTextProcessing.html">bas√©e</a> sur eux. </p><br><p>  TextKit est tr√®s pratique lorsque vous devez d√©crire en d√©tail l'emplacement du texte et <a href="https://developer.apple.com/documentation/uikit/nstextcontainer/1444569-exclusionpaths">indiquer les formes autour desquelles il circulera</a> : </p><br><p><img src="https://habrastorage.org/webt/g8/m1/hi/g8m1hixof_ic7gpugctcvug9gsk.png"></p><br><p>  √Ä l'aide de TextKit, vous pouvez calculer la taille des √©l√©ments d'interface dans la file d'attente d'arri√®re-plan, ainsi que le <a href="https://developer.apple.com/documentation/uikit/nslayoutmanager/1403160-enumeratelinefragments"><code>  frame</code> lignes / caract√®res</a> .  De plus, le cadre vous permet <a href="https://developer.apple.com/documentation/uikit/nslayoutmanager/1403158-drawglyphs">de dessiner des glyphes</a> et de changer compl√®tement l'apparence du texte dans la mise en page existante.  Tout cela fonctionne dans iOS 7.0 et sup√©rieur. </p><br><p>  <strong>TextKit est utile lorsque vous devez:</strong> </p><br><ul><li>  afficher du texte avec une mise en page complexe; </li><li>  dessiner du texte sur des images; </li><li>  calculer les tailles de sous-cha√Ænes individuelles; </li><li>  compter le nombre de lignes; </li><li>  utiliser les r√©sultats des calculs dans un <code>UITextView</code> . </li></ul><br><p>  J'insiste encore.  Si vous devez calculer la taille de l' <code>UITextView</code> , nous configurons d'abord les instances des <code>NSLayoutManager</code> , <code>NSTextStorage</code> et <code>NSTextContainer</code> , puis <a href="https://developer.apple.com/documentation/uikit/uitextview/1618602-layoutmanager">passons ces instances √† l'</a> <code>UITextView</code> <a href="https://developer.apple.com/documentation/uikit/uitextview/1618602-layoutmanager">correspondante</a> , o√π elles seront responsables de la mise en page.  Ce n'est qu'ainsi que nous garantissons la pleine co√Øncidence de toutes les valeurs. </p><br><p>  N'utilisez pas TextKit avec <code>UILabel</code> et <code>UITextField</code> !  Pour eux (contrairement √† <code>UITextView</code> ), vous ne pouvez pas configurer <code>NSLayoutManager</code> , <code>NSTextStorage</code> et <code>NSTextContainer</code> . </p><br><h2 id="24-coretext">  <strong>2.4.</strong>  <strong>Coretext</strong> </h2><br><p>  Il s'agit de l'outil de texte de niveau le plus bas dans iOS.  Il donne un contr√¥le maximal sur le rendu des polices, des caract√®res, des lignes et des retraits.  Et lui, comme TextKit, vous permet de calculer les param√®tres typographiques du texte, tels que la ligne de base et la taille du cadre des lignes individuelles. </p><br><p>  Comme vous le savez, plus il y a de libert√©, plus la responsabilit√© est √©lev√©e.  Et pour obtenir de bons r√©sultats en utilisant CoreText, vous devez pouvoir utiliser ses m√©thodes. </p><br><p>  CoreText assure la s√©curit√© des threads pour les op√©rations sur la plupart des objets.  Cela signifie que nous pouvons appeler ses m√©thodes √† partir de diff√©rents threads.  √Ä titre de comparaison, lorsque vous utilisez TextKit, vous devez vous-m√™me penser √† la s√©quence des appels de m√©thode. </p><br><p>  CoreText doit √™tre utilis√© si: </p><br><ul><li>  Une API de bas niveau extr√™mement simple est n√©cessaire pour acc√©der directement aux param√®tres de texte.  Je dois dire tout de suite que pour la grande majorit√© des t√¢ches, les capacit√©s de TextKit sont suffisantes. </li><li>  Il y a beaucoup de travail √† faire avec les lignes individuelles ( <a href="https://developer.apple.com/documentation/coretext/ctline-61l"><code>CTLine</code></a> ) et les caract√®res / √©l√©ments. </li><li>  Le support est important dans iOS 6.0. </li></ul><br><p>  Pour le flux VKontakte, nous avons utilis√© CoreText.  Pourquoi?  Juste au moment o√π nous avons impl√©ment√© les fonctions de base de travailler avec du texte, TextKit n'√©tait pas encore l√†. </p><br><hr><br><h1 id="3-kak-rabotaet-lenta-vkontakte">  <strong>3. Comment fonctionne le flux VKontakte?</strong> </h1><br><p>  En bref sur la fa√ßon dont nous recevons les donn√©es du serveur, la pr√©sentation du formulaire et les affichages. </p><br><p><img src="https://habrastorage.org/webt/7g/kx/pt/7gkxptt4lpgjhjzbtyl3prm4vxy.png"></p><br><p>  Tout d'abord, consid√©rez les t√¢ches effectu√©es dans la file d'attente d'arri√®re-plan.  Nous recevons des donn√©es du serveur, les traitons et d√©crivons de mani√®re d√©clarative l'affichage suivant.  √Ä ce stade, nous n'avons pas encore d'instances <code>UIView</code> , nous ne d√©finissons que les r√®gles et la structure de la future interface avec notre outil d√©claratif, quelque peu similaire √† <a href="https://developer.apple.com/xcode/swiftui/">SwiftUI</a> .  Pour calculer la mise en page, nous calculons la totalit√© du <code>frame</code> en tenant compte des restrictions actuelles, par exemple, la largeur de l'√©cran.  Nous effectuons une mise √† jour de la <code>dataSource</code> actuelle ( <code>dataSourceUpdate</code> ).  Ici, dans la file d'attente d'arri√®re-plan, nous pr√©parons les images: effectuez une d√©compression (voir la section performances pour plus de d√©tails), dessinez des ombres, des arrondis et d'autres effets. </p><br><p>  Allez maintenant dans la file d'attente principale.  <code>dataSourceUpdate</code> re√ßu √† l' <code>UITableView</code> , r√©utilisons et traitons les √©v√©nements d'interface, remplissons les cellules. </p><br><p>  Pour d√©crire notre syst√®me de mise en page, un article s√©par√© serait n√©cessaire, mais ici je vais √©num√©rer ses principales caract√©ristiques: </p><br><ul><li>  Une API d√©clarative est un ensemble de r√®gles sur lesquelles une interface est construite. </li><li>  Les composants de base forment un arbre ( <code>nodes</code> ). </li><li>  Calculs simples dans les composants de base.  Par exemple, dans les listes, nous calculons uniquement le d√©calage d' <code>origin</code> , en tenant compte de la largeur / hauteur de tous les enfants. </li><li>  Les √©l√©ments de base ne cr√©ent pas de ¬´conteneurs¬ª inutiles de l' <code>UIView</code> dans la hi√©rarchie.  Par exemple, le composant de liste ne forme pas une <code>UIView</code> suppl√©mentaire et n'y ajoute pas d'enfants.  Au lieu de cela, nous calculons le d√©calage d' <code>origin</code> des enfants par rapport √† l'√©l√©ment parent (pour la liste). </li><li>  Gestion de texte de bas niveau avec CoreText. </li></ul><br><p>  Mais m√™me avec cette approche, la visualisation des bandes peut ne pas √™tre fluide en raison de probl√®mes de performances.  Pourquoi? </p><br><p>  Chaque cellule a une hi√©rarchie complexe de <code>nodes</code> .  Et bien que les √©l√©ments de base ne cr√©ent pas de conteneurs inutiles, de nombreux <code>UIView</code> toujours affich√©s dans le ruban.  Et lorsque vous remplissez la hi√©rarchie avec des ¬´n≈ìuds¬ª (liaison de vue) dans la file d'attente principale, il y a du travail suppl√©mentaire dont il est difficile de s'√©loigner. </p><br><p>  Nous avons essay√© de transf√©rer autant de t√¢ches que possible dans la file d'attente d'arri√®re-plan et continuons maintenant √† le faire.  De plus, il existe des op√©rations gourmandes en CPU et en GPU qui doivent √™tre prises en compte et contourn√©es. </p><br><hr><br><h1 id="4-kak-dobitsya-luchshey-proizvoditelnosti">  <strong>4. Comment obtenir de meilleures performances</strong> </h1><br><p>  La r√©ponse la plus simple consiste √† d√©charger le thread principal, le CPU et le GPU.  Pour ce faire, vous devez comprendre en profondeur le travail des applications iOS.  Et surtout, identifier les sources de probl√®mes. </p><br><h2 id="41-pochemu-voznikayut-problemy-s-proizvoditelnostyu">  <strong>4.1 Pourquoi des probl√®mes de performances</strong> </h2><br><p>  <strong>Animation de base, <code>RunLoop</code> et Scroll</strong> <br>  Rappelons-nous comment l'interface est construite dans iOS.  Au niveau sup√©rieur, il y a <a href="https://developer.apple.com/documentation/uikit">UIKit</a> , qui est charg√© d'interagir avec l'utilisateur: traitement des gestes, sortie de l'application du sommeil et autres choses similaires.  Pour le rendu de l'interface, un outil de niveau inf√©rieur est responsable - <a href="https://developer.apple.com/documentation/quartzcore">Core Animation</a> (comme dans macOS).  Il s'agit d'un framework avec son propre <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/CoreAnimationBasics/CoreAnimationBasics.html">syst√®me de description d'interface</a> .  Consid√©rez les concepts de base de la construction d'une interface. </p><br><p>  Pour Core Animation, toute l'interface est <a href="https://developer.apple.com/documentation/quartzcore/calayer"><code>CALayer</code></a> couches <a href="https://developer.apple.com/documentation/quartzcore/calayer"><code>CALayer</code></a> .  Ils forment un arbre de rendu, g√©r√© via des transactions <a href="https://developer.apple.com/documentation/quartzcore/catransaction"><code>CATransaction</code></a> . </p><br><p>  Une transaction est un groupe de modifications, plus pr√©cis√©ment, des informations sur la n√©cessit√© de mettre √† jour quelque chose dans l'interface affich√©e.  Toute modification du <code>frame</code> ou d'autres param√®tres de couche tombe dans la transaction en cours.  Si ce n'est pas d√©j√† fait, le syst√®me lui-m√™me cr√©e une <a href="https://developer.apple.com/documentation/quartzcore/catransaction%3Flanguage%3Dobjc"><em>transaction implicite</em></a> . </p><br><p>  Plusieurs transactions forment une pile.  Les nouvelles mises √† jour tombent dans la transaction la plus √©lev√©e de la pile. </p><br><p>  <em>Nous savons maintenant que pour mettre √† jour l'√©cran, nous devons former des transactions avec de nouveaux param√®tres pour l'arborescence des couches.</em> </p><br><p><img src="https://habrastorage.org/webt/84/2n/q5/842nq5jznw5i30ybdmqjrngqhiw.png"></p><br><p>  <strong>Quand et comment cr√©er des transactions?</strong>  Dans notre application, les threads ont une <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html">entit√©</a> appel√©e <a href="https://developer.apple.com/documentation/foundation/runloop"><code>RunLoop</code></a> .  En termes simples, il s'agit d'une boucle infinie, √† chaque it√©ration dont la <a href="https://ru.wikipedia.org/wiki/%25D0%25A6%25D0%25B8%25D0%25BA%25D0%25BB_%25D1%2581%25D0%25BE%25D0%25B1%25D1%258B%25D1%2582%25D0%25B8%25D0%25B9">file d'attente d'√©v√©nements actuelle</a> est trait√©e. </p><br><p>  Dans le thread principal, <code>RunLoop</code> n√©cessaire pour traiter les √©v√©nements provenant de diverses sources, telles qu'une interface (gestes), des temporisateurs ou, par exemple, des gestionnaires pour recevoir des donn√©es de <a href="https://developer.apple.com/documentation/foundation/nsstream"><code>NSStream</code></a> et <a href="https://developer.apple.com/documentation/foundation/nsport"><code>NSPort</code></a> . </p><br><p><img src="https://habrastorage.org/webt/rd/f_/_m/rdf__mlll7k8wkiz6ijg8cnhhba.png"></p><br><p>  Quel est le <code>RunLoop</code> Core Animation et <code>RunLoop</code> ?  Nous avons constat√© ci-dessus que lors de la modification des propri√©t√©s d'une couche dans l'arbre de rendu, le syst√®me cr√©e des transactions implicites si n√©cessaire (par cons√©quent, nous n'avons pas besoin d'appeler <a href="https://developer.apple.com/documentation/quartzcore/catransaction/1448282-begin"><code>CATransaction.begin</code></a> pour redessiner quelque chose).  De plus, √† chaque it√©ration <code>RunLoop</code> syst√®me ferme automatiquement les transactions ouvertes et applique les modifications apport√©es ( <a href="https://developer.apple.com/documentation/quartzcore/catransaction/1448255-commit"><code>CATransaction.commit</code></a> ). </p><br><p>  <strong>Faites attention!</strong>  Le nombre d'it√©rations <code>RunLoop</code> ne d√©pend pas du taux de rafra√Æchissement de l'√©cran.  Le cycle n'est pas du tout synchronis√© avec l'√©cran et fonctionne comme ¬´sans fin <code>while()</code> ¬ª. </p><br><p>  Voyons maintenant ce qui se passe dans les it√©rations <code>RunLoop</code> sur le thread principal pendant le d√©filement: </p><br><pre> <code class="plaintext hljs"> ... if (dispatchBlocks.count &gt; 0) { //   MainQueue doBlocks() } ... if (hasPanEvent) { handlePan() // UIScrollView change content offset -&gt; change bounds } ... if (hasCATransaction) { CATransaction.commit() } ...</code> </pre> <br><p>  Tout d'abord, les blocs ajout√©s √† la file d'attente principale via <a href="https://developer.apple.com/documentation/dispatch/1453057-dispatch_async"><code>dispatch_async</code></a> / <a href="https://developer.apple.com/documentation/dispatch/1452870-dispatch_sync"><code>dispatch_sync</code></a> sont ex√©cut√©s.  Et tant qu'ils ne sont pas termin√©s, le programme ne proc√®de pas aux t√¢ches suivantes. </p><br><p>  Ensuite, UIKit commence √† traiter le mouvement <a href="https://developer.apple.com/documentation/uikit/uipangesturerecognizer">panoramique de</a> l'utilisateur.  Dans le cadre du traitement de ce geste, <a href="https://developer.apple.com/documentation/uikit/uiscrollview/1619404-contentoffset"><code>UIScrollView.contentOffset</code></a> change et, par cons√©quent, <a href="https://developer.apple.com/documentation/uikit/uiview/1622580-bounds"><code>UIScrollView.bounds</code></a> .  La modification des <code>bounds</code> <a href="https://developer.apple.com/documentation/uikit/uiscrollview"><code>UIScrollView</code></a> (respectivement, et de ses descendants <a href="https://developer.apple.com/documentation/uikit/uitableview"><code>UITableView</code></a> , <a href="https://developer.apple.com/documentation/uikit/uicollectionview"><code>UICollectionView</code></a> ) met √† jour la partie visible du contenu ( <code>viewport</code> ). </p><br><p>  √Ä la fin de l'it√©ration <code>RunLoop</code> , si nous avons des transactions ouvertes, la <code>commit</code> ou le <code>RunLoop</code> se produit automatiquement. </p><br><p>  Pour v√©rifier comment cela fonctionne, placez les points d'arr√™t aux endroits appropri√©s. <br>  Voici √† quoi ressemblera le traitement des gestes: </p><br><p><img src="https://habrastorage.org/webt/9c/kw/08/9ckw08wo9cay2nhxqm7qikm1n4w.png"></p><br><p>  Et voici <code>CATransaction.commit</code> apr√®s <code>handlePan</code> : </p><br><p><img src="https://habrastorage.org/webt/0k/h0/xc/0kh0xcaq1yx04htvepmilc_przq.png"></p><br><p>  Pendant la d√©c√©l√©ration du d√©filement, <code>UIScrollView</code> cr√©e un minuteur <a href="https://developer.apple.com/documentation/quartzcore/cadisplaylink"><code>CADisplayLink</code></a> pour synchroniser le nombre de modifications de <code>contentOffset</code> par seconde avec le taux de rafra√Æchissement de l'√©cran. </p><br><p><img src="https://habrastorage.org/webt/42/gz/5x/42gz5xmatumqfi9jpcl3z1gabic.png"></p><br><p>  Nous <code>CATransaction.commit</code> que <code>CATransaction.commit</code> ne se produit pas √† la fin de l'it√©ration <code>RunLoop</code> , mais directement dans le traitement du temporisateur <code>CADisplayLink</code> .  Mais cela n'a pas d'importance: </p><br><p><img src="https://habrastorage.org/webt/oq/si/f0/oqsif0ek7f1-w4f4lguvp_eun20.png"></p><br><h2 id="42-catransactioncommit">  <strong>4.2.</strong> <strong><code>CATransaction.commit</code></strong> </h2><br><p>  En fait, toutes les op√©rations dans <code>CATransaction.commit</code> sont effectu√©es sur des couches <code>CALayer</code> .  <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410935-layoutsublayers%3Flanguage%3Dobjc"><code>layoutSublayers</code></a> ont leurs propres m√©thodes pour mettre √† jour la mise en page ( <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410935-layoutsublayers%3Flanguage%3Dobjc"><code>layoutSublayers</code></a> ) et l'image ( <a href="https://developer.apple.com/documentation/quartzcore/calayerdelegate/2097262-draw"><code>drawLayer</code></a> ).  L'impl√©mentation par d√©faut de ces m√©thodes entra√Æne <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410984-delegate">des</a> appels de m√©thode <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410984-delegate">d√©l√©gu√©s</a> .  En ajoutant une nouvelle instance de <code>UIView</code> √† la hi√©rarchie <code>UIView</code> , nous ajoutons implicitement la couche correspondante √† la hi√©rarchie de couches Core Animation.  Dans ce cas, l' <code>UIView</code> par d√©faut un d√©l√©gu√© de sa couche.  Comme vous pouvez le voir dans la pile des appels, <code>UIView</code> dans le cadre de l'impl√©mentation des m√©thodes d√©l√©gu√©es <code>CALayer</code> , ex√©cute ses m√©thodes, qui seront discut√©es: </p><br><p><img src="https://habrastorage.org/webt/oq/si/f0/oqsif0ek7f1-w4f4lguvp_eun20.png"></p><br><p>  Comme nous travaillons habituellement avec la hi√©rarchie <code>UIView</code> , la description continuera avec des exemples d' <code>UIView</code> . </p><br><p>  Pendant <code>CATransaction.commit</code> , la mise en page de tous les <code>UIView</code> marqu√©s avec <a href="https://developer.apple.com/documentation/uikit/uiview/1622601-setneedslayout"><code>setNeedsLayout</code></a> .  Notez qu'une fois de plus, nous <a href="https://developer.apple.com/documentation/uikit/uiview/1622482-layoutsubviews"><code>layoutSubviews</code></a> pas <a href="https://developer.apple.com/documentation/uikit/uiview/1622482-layoutsubviews"><code>layoutSubviews</code></a> ou <a href="https://developer.apple.com/documentation/uikit/uiview/1622507-layoutifneeded"><code>layoutIfNeeded</code></a> raison de leur ex√©cution diff√©r√©e garantie dans le syst√®me √† l'int√©rieur de <code>CATransaction.commit</code> .  M√™me si dans une transaction (entre les appels √† <code>CATransaction.begin</code> et <code>CATransaction.commit</code> ) vous modifiez plusieurs fois la <code>frame</code> et appelez <code>setNeedsLayout</code> , chaque modification ne s'appliquera pas instantan√©ment.  Les modifications finales ne prendront effet qu'apr√®s avoir appel√© <code>CATransaction.commit</code> .  M√©thodes <code>CALayer</code> pertinentes: <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410946-setneedslayout%3Flanguage%3Dobjc"><code>setNeedsLayout</code></a> , <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410873-layoutifneeded%3Flanguage%3Dobjc"><code>layoutIfNeeded</code></a> et <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410935-layoutsublayers%3Flanguage%3Dobjc"><code>layoutSublayers</code></a> . </p><br><p>  Un groupe similaire pour le dessin est form√© par les m√©thodes <a href="https://developer.apple.com/documentation/uikit/uiview/1622437-setneedsdisplay"><code>setNeedsDisplay</code></a> et <a href="https://developer.apple.com/documentation/uikit/uiview/1622529-drawrect"><code>drawRect</code></a> .  Pour <code>CALayer</code> il s'agit de <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410855-setneedsdisplay"><code>setNeedsDisplay</code></a> , <a href="https://developer.apple.com/documentation/quartzcore/calayerdelegate/2097262-draw"><code>drawLayer</code></a> et <a href="https://developer.apple.com/documentation/quartzcore/calayerdelegate/2097262-draw"><code>drawLayer</code></a> .  <code>CATransaction.commit</code> appelle les m√©thodes de rendu sur tous les √©l√©ments marqu√©s avec <code>setNeedsDisplay</code> .  Cette √©tape est parfois appel√©e dessin hors √©cran. </p><br><p>  <strong>Un exemple</strong> .  Pour la sp√©cificit√© et la commodit√©, prenez le <code>UITableView</code> : </p><br><pre> <code class="plaintext hljs"> ... // Layout UITableView.layoutSubviews() //  ,   .. ... // Offscreen drawing UITableView.drawRect() //    ...</code> </pre> <br><p>  UIKit r√©utilise les <code>UICollectionView</code> <code>UITableView</code> / <code>UICollectionView</code> dans <code>layoutSubviews</code> : appelle la <code>willDisplayCell</code> d√©l√©gu√©e <code>willDisplayCell</code> et ainsi de suite.  Pendant <code>CATransaction.commit</code> , un dessin hors √©cran se produit: les m√©thodes <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410757-drawincontext%3Flanguage%3Dobjc"><code>drawInContext</code></a> de tous les calques ou <a href="https://developer.apple.com/documentation/uikit/uiview/1622529-drawrect"><code>drawRect</code></a> tous <code>UIView</code> , marqu√©es comme <a href="https://developer.apple.com/documentation/uikit/uiview/1622437-setneedsdisplay"><code>setNeedsDisplay</code></a> , sont <a href="https://developer.apple.com/documentation/uikit/uiview/1622437-setneedsdisplay"><code>setNeedsDisplay</code></a> .  Je remarque que lorsque nous <code>drawRect</code> quelque chose dans <code>drawRect</code> , cela se produit sur le thread principal, et nous devons de toute urgence changer l'affichage des calques pour un nouveau cadre.  Il est clair qu'une telle solution peut √™tre tr√®s inefficace. </p><br><p>  Que se passe-t-il ensuite dans <code>CATransaction.commit</code> ?  L'arbre de rendu est envoy√© au serveur de rendu. </p><br><h2 id="43-rendering-pipeline">  <strong>4.3.</strong>  <strong>Pipeline de rendu</strong> </h2><br><p>  Rappelez tout le processus de formation d'un cadre d'interface dans iOS (pipeline de rendu [WWDC 2014 Session 419. Advanced Graphics and Animations for iOS Apps]): </p><br><p><img src="https://habrastorage.org/webt/wh/ac/dj/whacdjlwdz9p3yxk4q2lonad4ag.png"></p><br><p>  Non seulement le processus de notre application est responsable de la formation du cadre - Core Animation fonctionne √©galement dans un processus syst√®me s√©par√© appel√© Render Server. </p><br><p>  <strong>Comment le cadre est form√©.</strong>  Nous (ou le syst√®me pour nous) cr√©ons une nouvelle transaction ( <code>CATransaction</code> ) dans l'application avec une description des modifications de l'interface, la ¬´validons¬ª et la transf√©rons vers le serveur de rendu.  Tout, c√¥t√© application, le travail est fait.  Ensuite, le serveur de rendu d√©code la transaction (arbre de rendu), appelle les commandes n√©cessaires sur la puce vid√©o, dessine un nouveau cadre et l'affiche √† l'√©cran. </p><br><p>  Fait int√©ressant, lors de la cr√©ation du cadre, un certain ¬´multithreading¬ª est utilis√©.  Si le taux de rafra√Æchissement de l'√©cran est de 60 images par seconde, une nouvelle image est form√©e au total non pas en 1/60, mais en 1/30 de seconde.  En effet, pendant que l'application pr√©pare un nouveau cadre, le serveur de rendu traite toujours le pr√©c√©dent: </p><br><p><img src="https://habrastorage.org/webt/vz/cp/oa/vzcpoae_zvhzw0zkhll1_tjuwwy.png"></p><br><p>  En gros, le temps total de formation de la trame avant l'affichage √† l'√©cran est de 1/60 seconde dans notre processus pour la formation de la transaction et 1/60 seconde dans le processus Render Server pendant le traitement de la transaction. </p><br><p>  Je voudrais faire la remarque suivante.  <strong>Nous pouvons parall√©liser le dessin des couches nous</strong> - <strong>m√™mes</strong> et <a href="https://developer.apple.com/documentation/uikit/1623912-uigraphicsbeginimagecontextwitho">rendre le</a> contenu de la <code>CGImage</code> <code>UIImage</code> / <code>CGImage</code> dans le flux d'arri√®re-plan.  Apr√®s cela, dans le thread principal, vous devez affecter l'image cr√©√©e √† la propri√©t√© <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410773-contents"><code>CALayer.contents</code></a> .  En termes de performances, c'est une tr√®s bonne approche.  Ce sont les d√©veloppeurs qui l'utilisent <a href="https://texturegroup.org/">Texture</a> .  Mais comme nous ne pouvons changer <code>CALayer.contents</code> que dans le processus de g√©n√©ration d'une transaction dans le processus de notre application, nous n'avons que 1/60 seconde √† 60 images au lieu de 1/30 seconde pour cr√©er et remplacer une nouvelle image (en tenant compte des optimisations et de la parall√©lisation du pipeline de rendu avec le serveur de rendu ) </p><br><p>  De plus, le serveur de rendu peut toujours g√©rer le m√©lange (voir ci-dessous) et la mise en cache des couches √† court terme [iOS Core Animation: Advanced Techniques.  Nick Lockwood].<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et si nous n'avons pas le temps de dessiner une nouvelle image pour la propri√©t√© en 1/60 seconde </font></font><code>CALayer.contents</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le calque correspondant restera vide ou avec l'ancien contenu mis en cache. </font><font style="vertical-align: inherit;">Mais c'est une approche bien parall√©lis√©e.</font></font></p><br><p> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion: vous devez toujours choisir la solution la plus adapt√©e √† une t√¢che particuli√®re.</font></font></em> </p><br><h2 id="44-samye-uyazvimye-po-proizvoditelnosti-mesta"> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.4. </font><font style="vertical-align: inherit;">Les lieux de performance les plus vuln√©rables</font></font></strong> </h2><br><p> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fil principal</font></font></strong> </p><br><p><img src="https://habrastorage.org/webt/yt/c7/2n/ytc72nywgvqohz44yx_lsr9jhti.png"></p><br><p> <strong><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probl√®me 1. Incapacit√© √† appliquer rapidement les modifications ( </font></font><code>CATransaction.commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) en</font></font></em></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> raison d'une longue ex√©cution</font></font><code>UIView.layoutSubviews</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou d'une hi√©rarchie complexe des</font></font><code>UIView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">couches</font><font style="vertical-align: inherit;">affich√©es</font><font style="vertical-align: inherit;">(plus pr√©cis√©ment, des couches</font></font><code>CALayer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me, vous devez simplifier autant que possible la hi√©rarchie et les calculs dans le cadre de</font></font><code>layoutSubviews</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/</font></font><code>cellForRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/</font></font><code>willDisplayCell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></p><br><p> <strong><em> 2.    <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410757-drawincontext%3Flanguage%3Dobjc"><code>drawInContext</code></a> / <a href="https://developer.apple.com/documentation/uikit/uiview/1622529-drawrect"><code>drawRect</code></a> .</em></strong>  -  Main-      ( <code>CATransaction.commit</code> ) ‚Äî  .                 ,    . </p><br><p> <strong><em> 3.     </em></strong> .          .        <code>CATransaction.commit</code> ,        ,  <a href="https://developer.apple.com/documentation/uikit/uiimage/1624092-draw"></a>    . </p><br><p> <strong><em> 4.   .</em></strong>                <code>UIImage</code> / <code>CGImage</code> . </p><br><p> <strong><em> 5.  </em></strong> .     Main-thread   ,     scroll.           -  ,       UI. </p><br><p> <strong><em> 6.    Main-.</em></strong>    , <code>RunLoop</code>  Main-   ,     ,   Main-.         . </p><br><p> <strong>GPU</strong> </p><br><p><img src="https://habrastorage.org/webt/xx/gl/cq/xxglcqd-3yjgmjsuxkppjbzbc38.png"></p><br><p> <strong><em>Blending</em></strong> .        GPU       (  Render Server       GPU,         ).   ,      ,      Background-. </p><br><p> <strong><em> </em></strong> . ,    <a href="https://developer.apple.com/documentation/uikit/uiblureffect"><code>UIBlurEffect</code></a> , <a href="https://developer.apple.com/documentation/uikit/uivibrancyeffect"><code>UIVibrancyEffect</code></a>    ,  ,    (Render Pass).      ,       ,    . </p><br><p> <strong>Offscreen rendering (Render Server)</strong> </p><br><p><img src="https://habrastorage.org/webt/zm/ru/b4/zmrub4eko8bdeelh2lbivcem8bi.png"></p><br><p> Render Server        .        , ,     : </p><br><ul><li> <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410818-cornerradius"><code>cornerRadius</code></a> ‚Äî  Render Server      ,         ; </li><li> <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410819-shadowradius"><code>shadowRadius</code></a> ‚Äî   Render Server    ,   ; </li><li> <a href="https://developer.apple.com/documentation/quartzcore/calayer/1410861-mask"><code>mask</code></a> ‚Äî        . </li></ul><br><p>    <code>CALayer</code> ,       ,    Offscreen rendering.    ,     <a href="https://developer.apple.com/documentation/uikit/uivisualeffect"><code>UIVisualEffect</code></a> (   ,     Render Server  CPU,   GPU). </p><br><p>  ,       . </p><br><hr><br><h1 id="5-instrumenty-izmereniy"> <strong>5.  </strong> </h1><br><p>    ,    ,    Time Profiler.   <a href="https://developer.apple.com/documentation/metal/using_metal_system_trace_in_instruments_to_profile_your_app">Metal System Trace</a> ‚Äî         Time Profiler    . </p><br><h2 id="51-metal-system-trace"> <strong>5.1. Metal System Trace</strong> </h2><br><p>  ,          ( ).   ,    : ,    . </p><br><p>  ,   Metal System Trace  ,           .     ,       Render Server.       ,      Main-,   ‚Äî ,     . </p><br><p><img src="https://habrastorage.org/webt/gy/pv/ay/gypvay-wwr1f0ldbjazina-ewtg.png"></p><br><p>      - ,   : </p><br><p><img src="https://habrastorage.org/webt/0r/af/6e/0raf6e-cvoukj_6jzt1o6frzjom.png"></p><br><p>  Metal System Trace   .     64- ,     iPhone 5s.  ,    <em></em>    .   , -   ,  ,          UI. </p><br><h2 id="52-fiksiruem-prosadki-proizvoditelnosti-v-kode-vo-vremya-raboty-prilozheniya"> <strong>5.2.         </strong> </h2><br><p>         . ,   - -  .         ,    <a href="https://developer.apple.com/documentation/quartzcore/cadisplaylink"><code>CADisplayLink</code></a> . </p><br><p>   <code>CADisplayLink</code>   <a href="https://developer.apple.com/documentation/quartzcore/cadisplaylink/1621257-timestamp"><code>timestamp</code></a> ‚Äî     (    Render Server).         <code>CADisplayLink.timestamp</code>     <code>timestamp</code> .   ,          (, 1/60 )  : </p><br><pre> <code class="plaintext hljs"> //  CADisplayLink. link = [CADisplayLink displayLinkWithTarget:target selector:selector] [link addToRunLoop:[NSRunLoop mainRunLoop] forMode:UITrackingRunLoopMode] //    CADisplayLink : diff = prevTimestamp - link.timestamp if (diff &gt; 1/fps) { //  freeze } prevTimestamp = link.timestamp</code> </pre> <br><p> <code>CADisplayLink</code>   <a href="https://developer.apple.com/documentation/uikit/uitrackingrunloopmode%3Flanguage%3Dobjc"><code>UITrackingRunLoopMode</code></a> ,       . </p><br><p>     Rendering Pipeline: <br><img src="https://habrastorage.org/webt/yv/ca/t3/yvcat3yxparod3whs19qzwwjzhw.png"></p><br><p>      UI-,         .    ¬´¬ª     <code>freezeFrameTimeRate</code> : </p><br><pre> <code class="plaintext hljs">scrollTime //    Scroll freezeFrameTime //    ,  "",       freezeFrameTimeRate = freezeFrameTime / scrollTime</code> </pre> <br><p>  ,            -    <code>UIView</code> .   ,      ¬´¬ª: </p><br><p><img src="https://habrastorage.org/webt/ws/l7/tr/wsl7trcro6gr-t7ax-paqn_rxls.png"></p><br><p>  ,          ,    ¬´ <code>UIView</code> ¬ª         .  Pourquoi?   ,   . , ,      ,     : <code>CADisplayLink</code> ,       Render Server    <code>link.timetamp</code> ,    Render Server     ,      .   60     UI-,         Render Server.   Render Server      ,     . </p><br><p>  ,     ,   ,  Render Server    .    <a href="https://developer.apple.com/documentation/metal/mtlcommandbuffer/1442997-addcompletedhandler%3Flanguage%3Dobjc">Metal</a> ,        Render Server. ,  ,       iOS,   Render Server            . </p><br><h2 id="kak-issledovat-problemy-rekomendacii"> <strong>  . </strong> </h2><br><p>   ,   ,      .             ,        . </p><br><p> :   ‚Äî   !          ‚Äî        . </p><br><hr><br><h1 id="zaklyuchenie">  <strong>Conclusion</strong> </h1><br><p>   ‚Äî               .    ,     ,      . </p><br><hr><br><h1 id="istochniki-informacii"> <strong> </strong> </h1><br><p>  ,        ‚Äî        .        ,   . </p><br><p>  ,        : </p><br><ol><li> <a href="https://developer.apple.com/documentation"> Apple</a> . </li><li> <a href="https://habr.com/ru/company/oleg-bunin/blog/437584/">    Auto Layout</a> . </li><li> <a href="https://constraints.cs.washington.edu/solvers/cassowary-tochi.pdf">The Cassowary Linear Arithmetic Constraint Solving Algorithm</a> . </li><li> iOS Core Animation: Advanced Techniques. Nick Lockwood. </li><li> WWDC 2014 Session 419. Advanced Graphics and Animations for iOS Apps. </li></ol><br><p><img src="https://habrastorage.org/webt/ij/vj/ex/ijvjexv2ppdy6bdkepcwbqk7wy8.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481626/">https://habr.com/ru/post/fr481626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481612/index.html">Notre petite contribution √† la lutte d'Avalonia UI pour moins de plateformes</a></li>
<li><a href="../fr481616/index.html">D√¥me g√©od√©sique. √Ä propos de l'appareil et mon exp√©rience des calculs</a></li>
<li><a href="../fr481618/index.html">MVP dans Unity ou comment simplifier la vie</a></li>
<li><a href="../fr481620/index.html">Juniper SRX et Cisco ASA: nouvelle s√©rie</a></li>
<li><a href="../fr481624/index.html">√âcrire une application sur Flutter en collaboration avec Redux</a></li>
<li><a href="../fr481628/index.html">R√®gles de r√©daction des √©tapes pr√©liminaires dans les cas de test</a></li>
<li><a href="../fr481630/index.html">Meilleurs outils et ressources utiles pour rendre une startup plus intelligente en 2019</a></li>
<li><a href="../fr481632/index.html">Fournisseurs de cloud: qui est le plus beau du march√©?</a></li>
<li><a href="../fr481634/index.html">Food Design Digest, novembre 2019</a></li>
<li><a href="../fr481638/index.html">Pourquoi les mod√®les 3D de production complexe sont utiles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>