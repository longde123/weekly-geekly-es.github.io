<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏾 🧑🏽‍🤝‍🧑🏼 👧🏽 Reagieren: Wenn Sie den Status erhöhen, wird Ihre App zerstört 🕓 🍽️ 💬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Haben Sie von "Lifting State Up" gehört? Ich denke du hast und das ist der genaue Grund warum du hier bist. Wie könnte es möglich sein, dass eines der...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reagieren: Wenn Sie den Status erhöhen, wird Ihre App zerstört</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471300/"><p><img src="https://habrastorage.org/webt/gd/9i/zn/gd9iznyftdnoffeagz18yy8aqeu.jpeg" alt="Abdecken"></p><br><p>  Haben Sie von "Lifting State Up" gehört?  Ich denke du hast und das ist der genaue Grund warum du hier bist.  Wie könnte es möglich sein, dass <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eines der 12 Hauptkonzepte, die in der offiziellen Dokumentation von React aufgeführt sind,</a> zu einer schlechten Leistung führt?  In diesem Artikel werden wir eine Situation betrachten, in der dies tatsächlich der Fall ist. </p><a name="habracut"></a><br><h2 id="step-1-lift-it-up">  Schritt 1: Heben Sie es an </h2><br><p>  Ich schlage vor, dass Sie ein einfaches Tic-Tac-Toe-Spiel erstellen.  Für das Spiel brauchen wir: </p><br><ul><li><p> Ein Spielzustand.  Keine echte Spiellogik, um herauszufinden, ob wir gewinnen oder verlieren.  Nur ein einfaches zweidimensionales Array, gefüllt mit <code>undefined</code> <code>"x"</code> oder <code>"0".</code> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> size = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">// Two-dimensional array (size * size) filled with `undefined`. Represents an empty field. const initialField = new Array(size).fill(new Array(size).fill(undefined))</span></span></code> </pre> <br></li><li><p>  Ein übergeordneter Container, in dem der Status unseres Spiels gehostet wird. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Update</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">single</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two-dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">new</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">newContent</span></span></span></span><span class="xml"><span class="hljs-tag">) =&gt;</span></span></span><span class="xml"> setField([ // Copy rows before our target row ...field.slice(0, rowI), [ // Copy cells before our target cell ...field[rowI].slice(0, cellI), newContent, // Copy cells after our target cell ...field[rowI].slice(cellI + 1), ], // Copy rows after our target row ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br></li><li><p>  Eine untergeordnete Komponente zum Anzeigen des Status einer einzelnen Zelle. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> randomContent = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-string"><span class="hljs-string">'x'</span></span> : <span class="hljs-string"><span class="hljs-string">'0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> )</code> </pre> <br></li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 1</a> </p><br><p>  Bisher sieht es gut aus.  Ein perfekt reaktives Feld, mit dem Sie mit Lichtgeschwindigkeit interagieren können :) Erhöhen wir die Größe.  Sagen wir zu 100. Ja, es ist Zeit, auf diesen Demo-Link zu klicken und die Größenvariable ganz oben zu ändern.  Immer noch schnell für dich?  Versuchen Sie es mit 200 oder verwenden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die in Chrome integrierte CPU-Drosselung</a> .  Sehen Sie jetzt eine signifikante Verzögerung zwischen dem Klicken auf eine Zelle und dem Ändern des Inhalts? </p><br><p>  Lassen Sie uns die <code>size</code> wieder auf 10 ändern und ein Profil hinzufügen, um die Ursache zu untersuchen. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell rendered'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 2</a> </p><br><p>  Ja, das ist es.  Ein einfaches <code>console.log</code> würde ausreichen, da es bei jedem Rendern ausgeführt wird. </p><br><p>  Was sehen wir also?  Basierend auf der Anzahl der Anweisungen "Zelle gerendert" (für <code>size</code> = N sollte es N sein) in unserer Konsole scheint es, als würde das gesamte Feld jedes Mal neu gerendert, wenn sich eine einzelne Zelle ändert. </p><br><p>  Am naheliegendsten ist es, einige Schlüssel hinzuzufügen, wie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">React-Dokumentation vorgeschlagen</a> . </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{(newContent)</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setField([ ...field.slice(0, rowI), [ ...field[rowI].slice(0, cellI), newContent, ...field[rowI].slice(cellI + 1), ], ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 3</a> </p><br><p>  Nach erneuter Vergrößerung sehen wir jedoch, dass dieses Problem immer noch besteht.  Wenn wir nur sehen könnten, warum eine Komponente gerendert wird ... Zum Glück können wir mit Hilfe von erstaunlichen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">React DevTools</a> .  Es kann aufzeichnen, warum Komponenten gerendert werden.  Sie müssen es jedoch manuell aktivieren. </p><br><p><img src="https://habrastorage.org/webt/36/ms/b4/36msb4eskbqe6txnqv5j3phjfda.png" alt="Reagieren Sie auf DevTools-Einstellungen"></p><br><p>  Sobald es aktiviert ist, können wir sehen, dass alle Zellen neu gerendert wurden, weil ihre Requisiten geändert wurden, insbesondere <code>setContent</code> prop. </p><br><p><img src="https://habrastorage.org/webt/nv/3o/on/nv3oon4uvu6om8oea4fnnaun8m4.png" alt="Reagieren Sie auf den DevTools-Bericht Nr. 1"></p><br><p>  Jede Zelle hat zwei Requisiten: <code>content</code> und <code>setContent</code> .  Wenn sich Zelle [0] [0] ändert, ändert sich der Inhalt von Zelle [0] [1] nicht.  Auf der anderen Seite erfasst <code>setContent</code> <code>field</code> , <code>cellI</code> und <code>rowI</code> in seinem Abschluss.  <code>cellI</code> und <code>rowI</code> bleiben gleich, aber das <code>field</code> ändert sich mit jeder Änderung einer Zelle. </p><br><p>  Lassen Sie uns unseren Code umgestalten und <code>setContent</code> . </p><br><p>  Um den Verweis auf <code>setContent</code> gleich zu halten, <code>setContent</code> wir die Verschlüsse <code>setContent</code> .  Wir könnten <code>rowI</code> Schließen von <code>cellI</code> und <code>rowI</code> beseitigen, indem unsere <code>Cell</code> <code>cellI</code> und <code>rowI</code> explizit an <code>cellI</code> <code>setContent</code> .  In <code>setState</code> auf das <code>field</code> könnten wir eine nette Funktion von <code>setState</code> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">es akzeptiert Rückrufe</a> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-comment"><span class="hljs-comment">// `useCallback` keeps reference to `setCell` the same. const setCell = useCallback( (rowI, cellI, newContent) =&gt; setField((oldField) =&gt; [ ...oldField.slice(0, rowI), [ ...oldField[rowI].slice(0, cellI), newContent, ...oldField[rowI].slice(cellI + 1), ], ...oldField.slice(rowI + 1), ]), [], )</span></span></code> </pre> <br><p>  Dadurch sieht die <code>App</code> so aus </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{setCell}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  Jetzt muss <code>Cell</code> <code>cellI</code> und <code>rowI</code> an den <code>setContent</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 4</a> </p><br><p>  Werfen wir einen Blick auf den DevTools-Bericht. </p><br><p><img src="https://habrastorage.org/webt/63/i5/po/63i5poiao3t3rt62mr_zubgycjw.png" alt="Reagieren Sie auf den DevTools-Bericht Nr. 2"></p><br><p>  Was ?!  Warum zum Teufel heißt es "Eltern Requisiten geändert"?  Die Sache ist also, dass jedes Mal, wenn unser Feld aktualisiert wird, die <code>App</code> neu gerendert wird.  Daher werden die untergeordneten Komponenten neu gerendert.  Ok  Sagt Stackoverflow etwas Nützliches über die Optimierung der Reaktionsleistung aus?  Das Internet schlägt vor, <code>shouldComponentUpdate</code> oder seine nahen Verwandten zu verwenden: <code>PureComponent</code> und <code>memo</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = memo(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) })</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 5</a> </p><br><p>  Ja  Jetzt wird nur eine Zelle neu gerendert, sobald sich ihr Inhalt ändert.  Aber warte ... Gab es eine Überraschung?  Wir haben Best Practices befolgt und das erwartete Ergebnis erzielt. </p><br><p>  Ein böses Lachen sollte hier sein.  Da ich nicht bei dir bin, versuche bitte, es dir so gut wie möglich vorzustellen.  Erhöhen Sie die <code>size</code> in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 5</a> .  Diesmal müssen Sie möglicherweise mit einer etwas größeren Anzahl gehen.  Die Verzögerung ist jedoch immer noch da.  Warum ??? </p><br><p>  Schauen wir uns noch einmal den DebTools-Bericht an. </p><br><p><img src="https://habrastorage.org/webt/ls/w8/gs/lsw8gsgvp_bnjvnxjramglhrnng.png" alt="Reagieren Sie auf den DevTools-Bericht Nr. 3"></p><br><p>  Es gibt nur ein Rendern von <code>Cell</code> und es war ziemlich schnell, aber es gibt auch ein Rendern von <code>App</code> , was einige Zeit in <code>App</code> hat.  Die Sache ist, dass bei jedem erneuten Rendern der <code>App</code> jede <code>Cell</code> ihre neuen Requisiten mit ihren vorherigen Requisiten vergleichen muss.  Selbst wenn es sich entscheidet, nicht zu rendern (was genau unser Fall ist), braucht dieser Vergleich immer noch Zeit.  O (1), aber das O (1) kommt <code>size</code> * <code>size</code> mal vor! </p><br><h2 id="step-2-move-it-down">  Schritt 2: Bewegen Sie es nach unten </h2><br><p>  Was können wir tun, um das zu umgehen?  Wenn das Rendern der <code>App</code> uns zu viel kostet, müssen wir das Rendern der <code>App</code> beenden.  Es ist nicht möglich, unseren Status in der <code>App</code> mit <code>useState</code> , da genau dies das erneute Rendern auslöst.  Wir müssen also unseren Status nach unten verschieben und jede <code>Cell</code> den Status für sich abonnieren lassen. </p><br><p>  Lassen Sie uns eine dedizierte Klasse erstellen, die ein Container für unseren Staat sein wird. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-comment"><span class="hljs-comment">// Copy-paste from `initialState` this.data = new Array(this.size).fill(new Array(this.size).fill(undefined)) } cellContent(rowI, cellI) { return this.data[rowI][cellI] } // Copy-paste from old `setCell` setCell(rowI, cellI, newContent) { console.log('setCell') this.data = [ ...this.data.slice(0, rowI), [ ...this.data[rowI].slice(0, cellI), newContent, ...this.data[rowI].slice(cellI + 1), ], ...this.data.slice(rowI + 1), ] } map(cb) { return this.data.map(cb) } } const field = new Field(size)</span></span></code> </pre> <br><p>  Dann könnte unsere <code>App</code> so aussehen: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">//</span></span></span></span><span class="hljs-function"><span class="hljs-params"> As you can see we still need to iterate over our state to get indexes. field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br><p>  Und unsere <code>Cell</code> kann den Inhalt aus dem <code>field</code> selbst anzeigen: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 6</a> </p><br><p>  An diesem Punkt können wir sehen, wie unser Feld gerendert wird.  Wenn wir jedoch auf eine Zelle klicken, passiert nichts.  In den Protokollen sehen wir "setCell" für jeden Klick, aber die Zelle bleibt leer.  Der Grund hierfür ist, dass nichts die Zelle zum erneuten Rendern auffordert.  Unser Zustand außerhalb von React ändert sich, aber React weiß nichts davon.  Das muss sich ändern. </p><br><p>  Wie können wir ein Rendering programmgesteuert auslösen? </p><br><p>  Mit Klassen haben wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">forceUpdate</a> .  Bedeutet das, dass wir unseren Code in Klassen umschreiben müssen?  Nicht wirklich.  Was wir mit funktionalen Komponenten tun können, ist die Einführung eines Dummy-Status, den wir nur ändern, um unsere Komponente zum erneuten Rendern zu zwingen. </p><br><p>  Hier erfahren Sie, wie Sie einen benutzerdefinierten Hook erstellen können, um das erneute Rendern zu erzwingen. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useForceRender = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, setDummy] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useCallback(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> setDummy(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oldVal</span></span></span><span class="hljs-function">) =&gt;</span></span> oldVal + <span class="hljs-number"><span class="hljs-number">1</span></span>), []) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> forceRender }</code> </pre> <br><p>  Um ein erneutes Rendern auszulösen, wenn unser Feld aktualisiert wird, müssen wir wissen, wann es aktualisiert wird.  Das bedeutet, dass wir in der Lage sein müssen, Feldaktualisierungen irgendwie zu abonnieren. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers = {} } _cellSubscriberId(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`row</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rowI}</span></span></span><span class="hljs-string">cell</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cellI}</span></span></span><span class="hljs-string">`</span></span> } cellContent(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data[rowI][cellI] } setCell(rowI, cellI, newContent) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'setCell'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = [ ...this.data.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, rowI), [ ...this.data[rowI].slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, cellI), newContent, ...this.data[rowI].slice(cellI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ], ...this.data.slice(rowI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ] <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cellSubscriber = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._cellSubscriberId(rowI, cellI)] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cellSubscriber) { cellSubscriber() } } map(cb) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data.map(cb) } <span class="hljs-comment"><span class="hljs-comment">// Note that we subscribe not to updates of the whole filed, but to updates of one cell only subscribeCellUpdates(rowI, cellI, onSetCellCallback) { this.subscribers[this._cellSubscriberId(rowI, cellI)] = onSetCellCallback } }</span></span></code> </pre> <br><p>  Jetzt können wir Feldaktualisierungen abonnieren. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.subscribeCellUpdates(rowI, cellI, forceRender), [ forceRender, ]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 7</a> </p><br><p>  Lassen Sie uns mit dieser Implementierung mit der <code>size</code> spielen.  Versuchen Sie, es auf die Werte zu erhöhen, die sich zuvor verzögert anfühlten.  Und ... es ist Zeit, eine gute Flasche Champagner zu öffnen!  Wir haben uns eine App besorgt, die nur dann eine Zelle und eine Zelle rendert, wenn sich der Status dieser Zelle ändert! </p><br><p>  Werfen wir einen Blick auf den DevTools-Bericht. </p><br><p><img src="https://habrastorage.org/webt/qm/yw/3y/qmyw3yetdbimipruhngx5pa_chu.png" alt="Reagieren Sie auf den DevTools-Bericht Nr. 4"></p><br><p>  Wie wir jetzt sehen können, wird nur <code>Cell</code> gerendert und es ist schnell verrückt. </p><br><p>  Was ist, wenn Sie sagen, dass der Code unserer <code>Cell</code> jetzt eine mögliche Ursache für einen Speicherverlust ist?  Wie Sie sehen können, <code>useEffect</code> wir in <code>useEffect</code> , aber wir <code>useEffect</code> uns nie ab.  Dies bedeutet, dass das Abonnement auch dann <code>Cell</code> , wenn <code>Cell</code> zerstört wird.  Lassen Sie uns das ändern. </p><br><p>  Zuerst müssen wir <code>Field</code> beibringen, was es bedeutet, sich abzumelden. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... unsubscribeCellUpdates(rowI, cellI) { delete this.subscribers[this._cellSubscriberId(rowI, cellI)] } }</span></span></code> </pre> <br><p>  Jetzt können wir <code>unsubscribeCellUpdates</code> auf unsere <code>Cell</code> anwenden. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo # 8</a> </p><br><p>  Was ist die Lektion hier?  Wann ist es sinnvoll, den Status im Komponentenbaum nach unten zu verschieben?  Niemals!  Nun, nicht wirklich :) Halten Sie sich an die Best Practices, bis sie fehlschlagen, und führen Sie keine vorzeitigen Optimierungen durch.  Ehrlich gesagt ist der Fall, den wir oben betrachtet haben, etwas spezifisch, aber ich hoffe, Sie werden sich daran erinnern, wenn Sie jemals eine wirklich große Liste anzeigen müssen. </p><br><h2 id="bonus-step-real-world-refactoring">  Bonusschritt: Reales Refactoring </h2><br><p>  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 8 haben</a> wir ein globales <code>field</code> , was in einer realen App nicht der Fall sein sollte.  Um dies zu lösen, können wir das <code>field</code> in unserer <code>App</code> hosten und es mit [context] () an den Baum weitergeben. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AppContext = createContext() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Note how we used a factory to initialize our state here. // Field creation could be quite expensive for big fields. // So we don't want to create it each time we render and block the event loop. const [field] = useState(() =&gt; new Field(size)) return ( &lt;AppContext.Provider value={field}&gt; &lt;div&gt; {field.map((row, rowI) =&gt; ( &lt;div key={rowI}&gt; {row.map((cell, cellI) =&gt; ( &lt;Cell key={`row${rowI}cell${cellI}`} rowI={rowI} cellI={cellI} /&gt; ))} &lt;/div&gt; ))} &lt;/div&gt; &lt;/AppContext.Provider&gt; ) }</span></span></code> </pre> <br><p>  Jetzt können wir <code>field</code> aus dem Kontext in unserer <code>Cell</code> konsumieren. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> field = useContext(AppContext) useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Live-Demo Nr. 9</a> </p><br><p>  Hoffentlich haben Sie etwas Nützliches für Ihr Projekt gefunden.  Zögern Sie nicht, mir Ihr Feedback mitzuteilen!  Ich freue mich über Kritik und Fragen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de471300/">https://habr.com/ru/post/de471300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de471282/index.html">Auf der Suche nach Lungenentzündung bei Röntgenaufnahmen mit Fast.ai</a></li>
<li><a href="../de471288/index.html">Das Gesicht eines Charakters für das Spiel "OnAir" erstellen</a></li>
<li><a href="../de471294/index.html">Gedichte über Haskell, C ++ und Programmierer</a></li>
<li><a href="../de471296/index.html">Lean Manufacturing - Ein Werkzeug für Effizienz</a></li>
<li><a href="../de471298/index.html">Bieber und Bilan winken mit einem Stift. AI singt jetzt Lieder</a></li>
<li><a href="../de471302/index.html">Benutzerüberprüfung in China und Sozialkredit</a></li>
<li><a href="../de471304/index.html">Empire ERP. Unterhaltsame Buchhaltung: Hauptbuch, Konten, Saldo</a></li>
<li><a href="../de471306/index.html">Entwicklung des Continent-AP VPN Plugins für Sailfish OS</a></li>
<li><a href="../de471310/index.html">Meine sehr subjektive Meinung über berufliche und nicht nur IT-Ausbildung</a></li>
<li><a href="../de471312/index.html">Vorbereitung auf die Spring Professional-Zertifizierung. Frühlingsstiefel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>