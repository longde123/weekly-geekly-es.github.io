<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๐ฝ โ๐พ โ ุจูุช ููุฑุณูู. ุงูุฐูุงุจ ุฅูู ูุฑุฉ ุงููุฏู ูุน ุงูุชูููุงุช ุงูุฌุฏูุฏุฉ โฎ๏ธ ๐ซ โจ๏ธ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ููุฏูุฉ 


 ูุฑุญุจุง ุจุงูุฌููุน. ูู ูุฐู ุงูููุงูุฉ ุณูู ุฃุตู chatbot ุงูุฎุงุต ุจู ูุฎุฏูุฉ ุฑุณุงุฆู ุงูุจุฑู ูุงูุดุจูุฉ ุงูุงุฌุชูุงุนูุฉ VK ุจุงุณุชุฎุฏุงู NodeJS. 


 ุนูุฏ ูุฐู ุงูููุทุฉ ุ ูุฌุจ ุนูู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุจูุช ููุฑุณูู. ุงูุฐูุงุจ ุฅูู ูุฑุฉ ุงููุฏู ูุน ุงูุชูููุงุช ุงูุฌุฏูุฏุฉ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/" style=";text-align:right;direction:rtl"><h2 id="vvedenie" style=";text-align:right;direction:rtl">  ููุฏูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูุฑุญุจุง ุจุงูุฌููุน.  ูู ูุฐู ุงูููุงูุฉ ุณูู ุฃุตู chatbot ุงูุฎุงุต ุจู ูุฎุฏูุฉ ุฑุณุงุฆู ุงูุจุฑู ูุงูุดุจูุฉ ุงูุงุฌุชูุงุนูุฉ VK ุจุงุณุชุฎุฏุงู NodeJS. </p><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ูุฐู ุงูููุทุฉ ุ ูุฌุจ ุนูู ุงูุนุฏูุฏ ูู ุงููุฑุงุก ุงูุฎุฑูุฌ ุจุดูุก ูุซู: "ูู ูู ุงูููุช!"  ุฃู "ูุงุฐุง ุ ูุฑุฉ ุฃุฎุฑูุ!" <br>  ูุนู ุ ููุดูุฑุงุช ููุงุซูุฉ ุจุงููุนู ุนูู habr ุจูุง ูู ุฐูู.  ููู ุ ูุน ุฐูู ุ ุฃุนุชูุฏ ุฃู ุงูููุงู ุณูููู ูููุฏูุง.  ุจุงุฎุชุตุงุฑ ุญูู ูุง ููุซูู ุงูุชูููุฐ ุงูููู ููุฑูุจูุช: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุฅุทุงุฑ ููุชุทุจูู ุ <a href="https://nestjs.com/">ููุชุณุจ</a> ุฅุทุงุฑ ุนูู <a href="https://nestjs.com/">NestJS</a> ุดุนุจูุฉ. </li><li style=";text-align:right;direction:rtl">  ููุชุจุฉ <a href="https://www.npmjs.com/package/telegraf">telegraf</a> ููุชูุงุนู ูุน Telegram API. </li><li style=";text-align:right;direction:rtl">  ููุชุจุฉ <a href="https://www.npmjs.com/package/node-vk-bot-api">node-vk-bot-api</a> ููุชูุงุนู ูุน VK API. </li><li style=";text-align:right;direction:rtl">  ููุชุจุฉ <a href="https://www.npmjs.com/package/typeorm">Typeorm</a> ูุชูุธูู ุทุจูุฉ ุชุฎุฒูู ุงูุจูุงูุงุช. </li><li style=";text-align:right;direction:rtl">  ุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู <a href="https://www.npmjs.com/package/mocha">ุงููุฎุงูู</a> ูููุชุจุฉ ุชุดุงู <a href="https://www.npmjs.com/package/chai">ุชุคูุฏ</a> . </li><li style=";text-align:right;direction:rtl">  CI ุจุงุณุชุฎุฏุงู Travis CI ููุงุฎุชุจุงุฑ ูุฅุฌุฑุงุกุงุช GitHub ููุดุฑ ุตูุฑ ุนุงูู ูููุงุก. </li></ol><br><p style=";text-align:right;direction:rtl">  ูุนูู ุฌุงูุจู ุ ุฏุนููุง ูุญุงูู ุชูููู ุตุฏุงูุงุช ูุฏููุง ูุน Viber ุ ููุง ูุฌุนููุง ุนุงูููุฉ ููุงุณุชุฎุฏุงู ูู ุงูุนุฏูุฏ ูู ุฎุฏูุงุช ุงููุฑุงุณูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูุฃููุฆู ุงูุฐูู ูุฑูุฏูู ูุนุฑูุฉ ูุง ุฌุงุก ููู ุ ูุฑุญุจุง ุจูู ูู ุงููุท. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi" style=";text-align:right;direction:rtl">  ุจูุงู ุงููุดููุฉ </h2><br><p style=";text-align:right;direction:rtl">  ููุดุงุท ุจุฏูู ูููุฏ ุ ุฃูุถู ูุฑุฉ ุงููุฏู.  ุนูู ูุณุชูู ุงูููุงุฉ ุ ุจุงูุทุจุน.  ูููู ุนุถููุง ูู ุงูุนุฏูุฏ ูู ุงููููุงุช ูุงูุฏุฑุฏุดุฉ ูู vk ู viber ู telegram ุ ูุบุงูุจูุง ูุง ูุชุนูู ุนููู ุฑุคูุฉ ุงูุตูุฑุฉ ุงูุชุงููุฉ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="ุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ูุง ูุฑุงู ููุง: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  "P" ุฃุถุงู ููุณู. </li><li style=";text-align:right;direction:rtl">  ุจุนุฏู ุ ุชู ุฅุถุงูุฉ 3 ุฃุดุฎุงุต ุขุฎุฑูู ุ ูู ุจูููู ูุงู "C" ูุนูู. </li><li style=";text-align:right;direction:rtl">  ุฃุถุงู "P" ุฑูููู ุงููุณูู "Dimon". </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ูู ููู "P" ูุณูููุง ุฌุฏูุง ูุงุญุชุณุจ ุฃูู ููุฌุฏ ูู ุงูููุช ุงูุญุงูู ูุง ูุตู ุฅูู 5 ุฃุดุฎุงุต. </li><li style=";text-align:right;direction:rtl">  ููุน ุฐูู ุ ูู ุชูู ูุฐู ุงููุนูููุงุช ุฐุงุช ุตูุฉ ููุชุฑุฉ ุทูููุฉ ุ ุญูุซ ูุฑุฑุช ุฃูุถูุง ุงูุฑูุถ ูุฅุถุงูุฉ ููุณู. </li></ol><br><p style=";text-align:right;direction:rtl">  ูู ุงูุญุงูุงุช ุงูููููุฉ ุจุดูู ุฎุงุต ุ ูููู ููุฃุดุฎุงุต ูุถุน ุนูุงูุฉ "+" ุซู ุฅูุบุงุก ูุดุงุฑูุชูู ุฃู ุฏุนูุฉ ุงูุฃุตุฏูุงุก ููุณ ูู ุงูุฏุฑุฏุดุฉ ุฃู ุงูุชุณุฌูู ูููุดุงุฑููู ุงูุขุฎุฑูู ูู ุงูุฏุฑุฏุดุฉ ูุงูููุงู ุจุฃูุดุทุฉ ุฃุฎุฑู.  ูู ุงูููุงูุฉ ุ ูุคุฏู ูุฐุง ุฅูู ุญูููุฉ ุฃูู ุนูุฏูุง ูุฃุชู ุงูุฌููุน ูู ุงูููุงูุฉ ููุนุจ ุ ุงุชุถุญ ุฃู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุนููู ูุงุณูุง +1 ูุนูู ููุณ ููุท ููุณู ุ ูููู ุฃูุถุง ุตุฏููู ุบูุด. </li><li style=";text-align:right;direction:rtl">  ูุชุจ ููููุง ุฃูู ุณูุฃุชู ุ ููู ุงูููุธู ุณุจูุฑูุฏูู ูุธุฑ ุจุนูููู ููุท ุฅูุฌุงุจูุงุช. </li></ol><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ุฑุจูุง ูููู ูุฏููุง ุนุฏุฏ ุบูุฑ ูุชุณุงูู ูู ุนุฏุฏ ุงููุฑู "ุบูุด ุงูุฅุถุงููุฉ" ูุจุฏุง ููููุง ุจุดูู ุบูุฑ ูุชููุน. </p><br><p style=";text-align:right;direction:rtl">  ูู ุฃุฌู ุชุฌูุจ ูุซู ูุฐู ุงูุชุตุงุฏูุงุช ุ ูุชุจุช ุฑูุจูุชูุง ุจุณูุทูุง ูุณุงุนุฏ ุนูู ุนุฑุถ ููููุงุช ุงููุดุงุฑููู ูู ุงููุนุจุฉ ุงููุฑุฆูุฉ ุจุดูู ูุฑุฆู ููููู ููุงุฆููุง ูุฅุถุงูุชูุง / ุญุฐููุง (ุญุฐููุง). </p><br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ูู ุนููู ุงูุฃุณุงุณู ุ ูู ุฑุฃูู ุ ูุฌุจ ุฃู ูููู ุงูุฑูุจูุช ูุงุฏุฑูุง ุนูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฃู ุชููู ุฌุฒุกุง ูุง ูุชุฌุฒุฃ ูู ุฃู ุนุฏุฏ ูู ุงูุฏุฑุฏุดุงุช.  ุชุฎุฒูู ุฏููุชู ููู ุฏุฑุฏุดุฉ ุนูู ุญุฏุฉ. </li><li style=";text-align:right;direction:rtl">  <em>ุจุงุณุชุฎุฏุงู</em> ุงูุฃูุฑ <em>/ event_add ุ</em> ุฃูุดุฆ ุญุฏุซูุง ูุดุทูุง ุฌุฏูุฏูุง ูุญุชูู ุนูู ูุนูููุงุช ูุนููุฉ ููุงุฆูุฉ ูุงุฑุบุฉ ูู ุงููุงุนุจูู.  ูุฌุจ ุฃู ูุตุจุญ ุงูุญุฏุซ ุงููุดุท ุงูุณุงุจู ุบูุฑ ูุดุท. </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ููุบู <em>ุงูุฃูุฑ / event_remove</em> ุงูุญุฏุซ ุงููุดุท ุญุงูููุง. </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู <em>ูุถูู</em> ุงูุฃูุฑ <em>/ add</em> ุนุถููุง ุฌุฏูุฏูุง ุฅูู ุงูุญุฏุซ ุงููุดุท ุญุงูููุง.  ุนูุงูุฉ ุนูู ุฐูู ุ ุฅุฐุง ุชู ุงุณุชุฏุนุงุก ุงูุฃูุฑ ุฏูู ุฃู ูุต ุฅุถุงูู ุ ููุฌุจ ุฅุถุงูุฉ ุงูุดุฎุต ุงูุฐู ูุชุจ ุงูุฃูุฑ.  ุฎูุงู ุฐูู ุ ูุชู ุฅุถุงูุฉ ุดุฎุต ูุชู ุชุญุฏูุฏ ุงุณูู ุนูุฏ ุงุณุชุฏุนุงุก ุงูุฃูุฑ. </li><li style=";text-align:right;direction:rtl">  ูุฒูู ุงูุฃูุฑ <em>/ remove</em> ุดุฎุตูุง ูู ูุงุฆูุฉ ุงููุดุงุฑููู ููููุง ููููุงุนุฏ ุงูููุถุญุฉ ููุฃูุฑ <em>/ add</em> . </li><li style=";text-align:right;direction:rtl">  ูุชูุญ ูู ุงูุฃูุฑ <em>/ info</em> ูุนุฑูุฉ ูู ูุงู ุจุงูุชุณุฌูู ุจุงููุนู ูู ุงููุนุจุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ุงููุฑุบูุจ ููู ููุบุงูุฉ ุฃู ูุณุชุฌูุจ ุงูุฑูุจูุช ุจููุณ ุงููุบุฉ ุงูุชู ุชู ุชูููู ุงููุดุบู ุจูุง (ุฃู ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ุงูุชุฑุงุถููุง). </li></ol><br><p style=";text-align:right;direction:rtl">  ูุฑุคูุฉ ูุง ุญุฏุซ ูู ุงูููุงูุฉ ุจุณุฑุนุฉ ุ ููููู ุงูุงูุชูุงู ุนูู ุงูููุฑ ุฅูู ุงููุณู ุงูุฃุฎูุฑ "ุงููุชูุฌุฉ ูุงูุงุณุชูุชุงุฌุงุช".  ุญุณููุง ุ ุฅุฐุง ููุช ููุชููุง ุจุชูุงุตูู ุงูุชูููุฐ ุ ูุณูุชู ูุตู ูุฐู ุงููุนูููุงุช ุจุชูุงุตูู ูุงููุฉ ุฃุฏูุงู. </p><br><h2 id="proektirovanie-i-razrabotka" style=";text-align:right;direction:rtl">  ุงูุชุตููู ูุงูุชุทููุฑ </h2><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชุตููู ุงูุชุทุจูู ุ ุธูุฑ ุงููุฎุทุท ุงูุชุงูู ูู ุฑุฃุณู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="ุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููุง ุ ูุงูุช ุงูููุฑุฉ ุงูุฑุฆูุณูุฉ ูู ุฅุญุถุงุฑ ุฌููุน ุชูุงุตูู ุงูุนูู ูุน ุฃูุธูุฉ ุงููุฑุงุณูุฉ ุงููุฎุชููุฉ ุฅูู ุงููุญููุงุช ุงูููุงุณุจุฉ ูุชุบููู ููุทู ุงูุชูุงุนู ูุน ุงูููุชุจุงุช ุงูุชู ุชููุฐ ูุงุฌูุงุช ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุงูููุงุจูุฉ ุ ููุนุงูุฌุฉ ุงูุจูุงูุงุช ูุฅุญุถุงุฑูุง ูู ูููุฐุฌ ูุงุญุฏ. </p><br><h3 id="interfeys-i-modeli-soobscheniy" style=";text-align:right;direction:rtl">  ููุงุฐุฌ ูุงุฌูุฉ ูุฑุณุงูุฉ </h3><br><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ููุฑุณุงุฆู ุ ูุงู ูู ุงููููู ุชุตููู ูุงุฌูุฉ <em>IMessage</em> ุงูุชุงููุฉ ุ ูุงูุชู ุชุฑุถููุง ุงููุฆุงุช ุงูุชู ุชุฎุฒู ุจูุงูุงุช ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ ููุนุฏูุฏ ูู ุงูุฃูุธูุฉ ูุงูุฃุณุงููุจ ููุชุนุงูู ูุน ูุฐู ุงูุจูุงูุงุช: </p><br><pre style=";text-align:right;direction:rtl"><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { <span class="hljs-attr"><span class="hljs-attr">chatId</span></span>: number; lang: string; text: string; fullText: string; command: string; name: string; getReplyStatus: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> string; getReplyData: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> any; setStatus: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status: string</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; withData: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; answer: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุญุชูู ุงููุฆุฉ ุงูุฃุณุงุณูุฉ <em>BaseMessage</em> ุงูุชู ุชููุฐ ูุฐู ุงููุงุฌูุฉ ุนูู ุงููููุฐุฌ ุงูุชุงูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">BaseMessage</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ public chatId: number; public lang: string; public text: string; public fullText: string; public command: string; protected firstName: string; protected lastName: string; protected replyStatus: string; protected replyData: any; get name(): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> firstName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${firstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lastName}</span></span></span><span class="hljs-string">`</span></span>.trim(); } public getReplyStatus(): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus; } public getReplyData(): any { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData; } public setStatus(status: string): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus = status; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public withData(data: any): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุฆุฉ ุงูุฑุณุงูุฉ ูู Telegram: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">TelegramMessage</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.update; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = message.chat.id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = message.from.language_code; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.replyWithHTML(args); } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ู VK: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">VKMessage</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getChatId(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = <span class="hljs-string"><span class="hljs-string">'ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> answer: string = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${args}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.reply(answer); } private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุง ูุฌุจ ุงูุงูุชุจุงู ุฅููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <em>chatId</em> ูู ุงููุนุฑู ุงููุฑูุฏ ููุฏุฑุฏุดุฉ.  ุจุงููุณุจุฉ ูู Telegram ุ ุชุฃุชู ูุฐู ุงูุฑุณุงูุฉ ุจูุถูุญ ูู ุจููุฉ ูู ุฑุณุงูุฉ.  ููุน ุฐูู ุ ูู ุญุงูุฉ VK ูุง ููุฌุฏ ูุซู ูุฐุง ุงููุนุฑู ุจุดูู ุตุฑูุญ.  ููู ุชูููุ  ููุฅุฌุงุจุฉ ุนูู ูุฐุง ุงูุณุคุงู ุ ุชุญุชุงุฌ ุฅูู ููู ููููุฉ ุนูู ุงูุฑูุจูุช ูู VK.  ูู ูุฐุง ุงููุธุงู ุ ุชุนูู ุฑูุจูุชุงุช ุงููุฑุงุณูุฉ ุงูุฌูุงุนูุฉ ููุงุจุฉ ุนู ุงููุฌุชูุน ุงูุฐู ูุจุฏุฃ ูู ุฃุฌูู.  ุฃู  ุชุญุชูู ูู ุฑุณุงูุฉ ุจูุช ุนูู <em>ูุนุฑู</em> ูุฌุชูุน <em>group_id</em> .  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุฃุชู <em>peer_id</em> ูู ุงูุฑุณุงูุฉ (ูููู ูุฑุงุกุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู <a href="">ููุง</a> ) <em>ููุนุฑู</em> ูููุญุงุฏุซุฉ ุงูุฌูุงุนูุฉ ูู ุญุงูุชูุง.  ุจูุงุกู ุนูู ูุงุชูู ุงููุนุฑูุชูู ุ ููููู ุฅูุดุงุก ูุนุฑู ุงูุฏุฑุฏุดุฉ ุงูุฎุงุต ุจู ุ ุนูู ุณุจูู ุงููุซุงู ุนูู ุงููุญู ุงูุชุงูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐู ุงูุทุฑููุฉ ูู ุจุงูุชุฃููุฏ ููุณุช ูุซุงููุฉ ุ ูููู ุชูุทุจู ุนูู ุงููููุฉ ุงูุญุงููุฉ. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <em>ุงููุต</em> <em>ุงููุงูู</em> <em>ูุงููุต</em> .  ููุง ูุดูุฑ ุงุณู ุงููุชุบูุฑุงุช ุ ูุญุชูู ุงููุต ุงููุงูู ุนูู ุงููุต ุงููุงูู ููุฑุณุงูุฉ ุ ุจูููุง ูุญุชูู <em>ุงููุต</em> ููุท ุนูู ุงูุฌุฒุก ุงูุฐู ูุฃุชู ุจุนุฏ ุงุณู ุงูุฃูุฑ. </p><br></li></ol><br><p style=";text-align:right;direction:rtl">  ูุฐุง ููุงุณุจ ูุฃูู ูุณูุญ ูู ุจุงุณุชุฎุฏุงู ุญูู <em>ุงููุต</em> ุงูุฌุงูุฒ ูุชุญููู ุงููุนูููุงุช ุงููุณุงุนุฏุฉ ุงูููุฌูุฏุฉ ููู ุ ูุซู ุชุงุฑูุฎ ุงูุญุฏุซ ุฃู ุงุณู ุงููุงุนุจ. </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุฎูุงู Telegram ุ ูุง ุชุฏุนู ุฑุณุงุฆู VK ูุฌููุนุฉ ูู ุงูุนูุงูุงุช ูุชูููุฒ ูุต ูุซู <code>&lt;b&gt;</code> ุฃู <code>&lt;i&gt;</code> ุ ูุฐูู ุ ุนูุฏ ุงูุงุณุชุฌุงุจุฉ ุ ูุฌุจ ุญุฐู ูุฐู ุงูุนูุงูุงุช ุจุงุณุชุฎุฏุงู ุงูุชุนุจูุฑุงุช ุงููุนุชุงุฏุฉ. </li></ol><br><h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy" style=";text-align:right;direction:rtl">  ูุญููุงุช ูุชููู ูุฅุฑุณุงู ุงูุฑุณุงุฆู </h3><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุฅูุดุงุก ุงููุงุฌูุฉ ูุจููุฉ ุงูุจูุงูุงุช ูุฑุณุงุฆู Telegram ู VK ุ ุญุงู ุงูููุช ูุชูููุฐ ุงูุฎุฏูุงุช ููุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ุงููุงุฑุฏุฉ. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="ุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ุชููู ูุฐู ุงูุฎุฏูุงุช ุจุชููุฆุฉ ุงููุญุฏุงุช ุงูุชุงุจุนุฉ ูุฌูุงุช ุฎุงุฑุฌูุฉ ููุชูุงุนู ูุน ูุงุฌูุงุช ุจุฑูุฌุฉ ุงูุชุทุจููุงุช Telegram ู VK ูุฅุทูุงู ุขููุงุช ุงูุงูุชุฑุงุน ุงูุทููู ุ ุจุงูุฅุถุงูุฉ ุฅูู ูุฌูุฏ ุงุชุตุงู ุจูู ุงูุฃูุงูุฑ ุงููุงุฑุฏุฉ ูุงูุฃุญุฏุงุซ ุงูุฏุงุฎููุฉ ุงูุชู ุชุญุฏุซ ูู ุงููุธุงู ุนูุฏ ุชููู ุงูุจูุงูุงุช ูู ุฎุฏูุงุช ุงููุฑุงุณูุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">TelegramService</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telegraf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'telegraf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SocksAgent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socks5-https-client/lib/Agent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TelegramMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./telegram.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramService</span></span></span><span class="hljs-class"> </span></span>{ private bot: Telegraf&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_USE_PROXY'</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken, { <span class="hljs-attr"><span class="hljs-attr">telegram</span></span>: {<span class="hljs-attr"><span class="hljs-attr">agent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getProxy(config)}, }) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(command, ctx =&gt; { ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.launch(); } private getProxy(config: ConfigService): SocksAgent { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SocksAgent({ <span class="hljs-attr"><span class="hljs-attr">socksHost</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_HOST'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPort</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PORT'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksUsername</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPassword</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span></span>), }); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">VKService</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VkBot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'node-vk-bot-api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {VKMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./vk.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKService</span></span></span><span class="hljs-class"> </span></span>{ private bot: VkBot&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'VK_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VkBot(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, }); ctx.message.from = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VKMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.startPolling(); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุง ูุฌุจ ุงูุงูุชุจุงู ุฅููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุธุฑูุง ููุฌูุฏ ุจุนุถ ุงููุดููุงุช ูู ุงููุตูู ุฅูู ุฎุฏูุฉ Telegram (ูุฑุญุจูุง Roskomnadzor) ุ ูุงู ูู ุงูุถุฑูุฑู ุงุณุชุฎุฏุงู ูููููุง ุงุฎุชูุงุฑููุง ูููุฑ ุญุฒูุฉ <a href="https-client">socks5-https-client</a> . </li><li style=";text-align:right;direction:rtl">  ุนูุฏ ูุนุงูุฌุฉ ุญุฏุซ ุ ูุถุงู ุญูู ุฅูู ุงูุณูุงู ูุน ูููุฉ ุงูุฃูุฑ ูุน ูุต ุงูุฑุณุงูุฉ ุงูุชู ุชู ุงุณุชูุงููุง. </li><li style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูู VK ุ ูุฌุจ ุนููู ุชูุฒูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุฐู ุฃุฑุณู ุงูุฑุณุงูุฉ ุจุดูู ูููุตู ุจุงุณุชุฎุฏุงู ููุงููุฉ API ูููุตูุฉ: <br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, });</code> </pre> </li></ol><br><h3 id="model-dannyh" style=";text-align:right;direction:rtl">  ูููุฐุฌ ุงูุจูุงูุงุช </h3><br><p style=";text-align:right;direction:rtl">  ูุชูููุฐ ุงููุธููุฉ ุงููุนููุฉ ููุจูุช ุ ูุงูุช ุซูุงุซุฉ ุทุฑุฒ ูุงููุฉ: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>Chat</code> - ุงูุฏุฑุฏุดุฉ ุฃู ุงููุญุงุฏุซุฉ. </li><li style=";text-align:right;direction:rtl">  <code>Event</code> - ุญุฏุซ ููุฏุฑุฏุดุฉ ุงููุฌุฏููุฉ ูุชุงุฑูุฎ ูููุช ูุญุฏุฏูู. </li><li style=";text-align:right;direction:rtl">  <code>Player</code> - ูุดุงุฑู ุฃู ูุงุนุจ ูุดุงุฑู ูู ุงูุญุฏุซ. </li></ol><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="ูุฎุทุท ุงูุจูุงูุงุช"></p><br><p style=";text-align:right;direction:rtl">  ุชุทุจููุงุช ุงูููุงุฐุฌ ุจุงุณุชุฎุฏุงู ููุชุจุฉ <a href="https://www.npmjs.com/package/typeorm">typeorm</a> ูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฏุฑุฏุดุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, Index, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Index({<span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) @Column() chatId: number; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.chat) @JoinColumn() events: Event[]; }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุญุฏุซ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() date: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>; @Column() active: boolean; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Chat, chat =&gt; chat.events) chat: Chat; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Player, player =&gt; player.event) @JoinColumn() players: Player[]; }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุงุนุจ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() name: string; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.players) @JoinColumn() event: Event; }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ููุง ุ ูู ุงูุถุฑูุฑู ุฃู ููุงูุด ูุฑุฉ ุฃุฎุฑู ุขููุฉ ุงูุฑูุจูุช ููุฎุชูู ุงููุฑู ูู ุญูุซ ุงูุชูุงุนุจ ุจููุงุฐุฌ <em>ุงูุฏุฑุฏุดุฉ</em> <em>ูุงูุญุฏุซ</em> ูุงููุดุบู. </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุนูุฏ ุงุณุชูุงู ุฃู ุฃูุฑ ุ ูุชู ุงูุชุญูู ูู ูุฌูุฏ ูุญุงุฏุซุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน <code>chatId</code> .  ุฅุฐุง ูู ููู ููุงู ุณุฌู ูุทุงุจู ุ ูุณูุชู ุฅูุดุงุคู. </li><li style=";text-align:right;direction:rtl">  ูุชุจุณูุท ุงูููุทู ุ ูููู ุฃู ุชุญุชูู ูู ูุญุงุฏุซุฉ ุนูู ุญุฏุซ ูุดุท ูุงุญุฏ ููุท ( <em>ุญุฏุซ</em> ).  ุฃู  ุนูุฏ ุงุณุชูุงู <code>/event_add</code> ุ ูุชู ุฅูุดุงุก ุญุฏุซ ูุดุท ุฌุฏูุฏ ูู ุงููุธุงู ูุน ุงูุชุงุฑูุฎ ุงููุญุฏุฏ. <br>  ุงูุญุฏุซ ุงููุดุท ุงูุญุงูู (ุฅู ูุฌุฏ) ูุตุจุญ ุบูุฑ ูุดุท. </li><li style=";text-align:right;direction:rtl">  <code>/event_remove</code> ูุนุซุฑ ุนูู ุงูุญุฏุซ ุงููุดุท ูู ุงูุฏุฑุฏุดุฉ ุงูุญุงููุฉ ููููู ุจุฅูุบุงุก ุชูุดูุทู. </li><li style=";text-align:right;direction:rtl">  <code>/info</code> ูุนุซุฑ ุนูู ุญุฏุซ ูุดุท ูู ุงูุฏุฑุฏุดุฉ ุงูุญุงููุฉ ุ ููุนุฑุถ ูุนูููุงุช ุนู ูุฐุง ุงูุญุฏุซ ููุงุฆูุฉ ูู ุงููุงุนุจูู ( <em>ูุงุนุจ</em> ). </li><li style=";text-align:right;direction:rtl">  <code>/add</code> ู <code>/remove</code> ุงูุนูู ูุน ุงูุญุฏุซ ุงููุดุท ุฅุถุงูุฉ ูุฅุฒุงูุฉ ุงููุงุนุจูู ููู. </li></ol><br><p style=";text-align:right;direction:rtl">  ุงูุฎุฏูุฉ ุงูููุงุจูุฉ ููุนูู ูุน ุงูุจูุงูุงุช ูู ููุง ููู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">StorageService</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {InjectConnection} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Connection, Repository, UpdateResult} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/player'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StorageService</span></span></span><span class="hljs-class"> </span></span>{ private chatRepository: Repository&lt;Chat&gt;; private eventRepository: Repository&lt;Event&gt;; private playerRepository: Repository&lt;Player&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(@InjectConnection() private readonly dbConnection: Connection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Chat); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Event); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Player); } public get connection() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ensureChat(chatId: number): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Chat&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.findOne({chatId}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chat; } chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); chat.chatId = chatId; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.save(chat); } public markChatEventsInactive(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;UpdateResult&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection .createQueryBuilder() .update(Event) .set({<span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) .where({chat}) .execute(); } public appendChatActiveEvent(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); event.chat = chat; event.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; event.date = date; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.save(event); } public findChatActiveEvent(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {chat, <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}); } public getPlayers(event: Event): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.find({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event}}); } public findPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event, name}}); } public addPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player: Player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(); player.event = event; player.name = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.save(player); } public removePlayer(player: Player): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.remove(player); } }</code> </pre> </div></div><br><h3 id="shablonizaciya-otvetov" style=";text-align:right;direction:rtl">  ุงุณุชุฌุงุจุฉ ุงููุงูุจ </h3><br><p style=";text-align:right;direction:rtl">  ุจุงูุฅุถุงูุฉ ุฅูู ุฎุฏูุฉ <em>StorageService</em> ุงูููุตููุฉ ููุนูู ูุน ุงูุจูุงูุงุช ุ ูุงูุช ููุงู ุฃูุถูุง ุญุงุฌุฉ ุฅูู ุชูููุฐ ุฎุฏูุฉ <em>TemplateService</em> ูุฎุตุตุฉ ุชุชูุซู ููุงููุง ูู ุงูููุช ุงูุญุงูู ูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู ุจุชูุฒูู ูุชุฌููุน ููุงูุจ <a href="https://handlebarsjs.com/">ุงูููุงูุฏ</a> ููุญุตูู ุนูู ุฎูุงุฑุงุช ููุฅุฌุงุจุฉ ููุฎุชูู ุงูุฃูุงูุฑ ุจูุบุงุช ูุฎุชููุฉ. </li><li style=";text-align:right;direction:rtl">  ุงุฎุชูุงุฑ ูุงูุจ ููุงุณุจ ุญุณุจ ุงูุญุฏุซ ุงูุญุงูู ูุญุงูุฉ ุงูุงุณุชุฌุงุจุฉ ููุบุฉ ุงููุณุชุฎุฏู. </li><li style=";text-align:right;direction:rtl">  ุชุนุจุฆุฉ ุงููุงูุจ ุจุงูุจูุงูุงุช ุงูุชู ุชู ุงูุญุตูู ุนูููุง ูุชูุฌุฉ ููุฃูุฑ. </li></ol><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">TemplateService</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> handlebars <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'handlebars'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {readDirDeepSync} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'read-dir-deep'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IParams { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string; status: string; lang?: string; } @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateService</span></span></span><span class="hljs-class"> </span></span>{ private readonly DEFAULT_LANG: string = <span class="hljs-string"><span class="hljs-string">'en'</span></span>; private readonly TEMPLATE_PATH: string = <span class="hljs-string"><span class="hljs-string">'templates'</span></span>; private logger: Logger; private templatesMap: <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;string, (d: any) =&gt; string&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(logger: Logger) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(); } public apply(params: IParams, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: any): string { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log( <span class="hljs-string"><span class="hljs-string">`apply template: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.action}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.status}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.lang}</span></span></span><span class="hljs-string">`</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { params.lang = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DEFAULT_LANG; template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'template-not-found'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(data); } private getTemplate(params: IParams): <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {lang, action, status} = params; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status)); } private load() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templatesDir: string = path.join( process.cwd(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TEMPLATE_PATH, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templateFileNames: string[] = readDirDeepSync(templatesDir); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap = templateFileNames.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, fileName</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = fs.readFileSync(fileName, {<span class="hljs-attr"><span class="hljs-attr">encoding</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, lang, action, status] = fileName .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\.hbs$/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) .split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.set( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status), handlebars.compile(template), ); }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); } private getTemplateKey( lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string, ): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุง ูุฌุจ ุงูุงูุชุจุงู ุฅููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุชูุฌุฏ ูููุงุช ุงูููุงูุจ ูู ุฏููู ูููุตู. / ููุงูุจ ูู ุฌุฐุฑ ุงููุดุฑูุน ููุชู ุชูุธูููุง ุญุณุจ ุงููุบุฉ ูุงูุฅุฌุฑุงุก (ุงูุฃูุฑ) ูุญุงูุฉ ุงูุงุณุชุฌุงุจุฉ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">- templates - en - event_add - invalid_date.hbs - success.hbs - event_info - ru</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชููุฆุฉ ุงูุชุทุจูู ุ ูุชู ุชุญููู ุฌููุน ููุงูุจ ุงูุงุณุชุฌุงุจุฉ ูู ุงูุฐุงูุฑุฉ ูุชุนุจุฆุฉ ุฎุฑูุทุฉ ุจูุง ููุงุชูุญ ุชุญุฏุฏ ุงููุงูุจ ุจุดูู ูุฑูุฏ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; }</code> </pre> <br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ูุญุชูู ุงููุธุงู ุญุงูููุง ุนูู ูุฌููุนุชูู ูู ุงูููุงูุจ: ููุฑูุณูุฉ ูุงูุฅูุฌููุฒูุฉ. <br>  ูุชู ุชูููุฑ ุงุญุชูุงุทู ุจุงููุบุฉ ุงูุงูุชุฑุงุถูุฉ (ุงูุฅูุฌููุฒูุฉ) ูู ุบูุงุจ ุงููุงูุจ ุงูุถุฑูุฑู ููุบุฉ ุงูุญุฏุซ ุงูุญุงูู. </p><br></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  <a href="https://handlebarsjs.com/">ุงูููุงูุฏ</a> ููุงูุจ ุฃููุณูู ุ ุนูู ุณุจูู ุงููุซุงู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game List of players: {{#each players}} {{index}}: &lt;i&gt;{{name}}&lt;/i&gt; {{/each}} Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญุชูู ุนูู ูู ูู ุงูุนูุงุตุฑ ุงููุงุฆุจุฉ ุงูุชูููุฏูุฉ <a href="https://tlgrm.ru/docs/bots/api">ููุฌููุนุฉ ูู ุงูุนูุงูุงุช ุงูุตุงูุญุฉ</a> ูุชูุณูู ุงูุงุณุชุฌุงุจุงุช ูู Telegram. </p><br></li></ol><br><h3 id="servisy-obrabotki-komand-actions" style=";text-align:right;direction:rtl">  ุฎุฏูุงุช ูุนุงูุฌุฉ ุงูุฃูุงูุฑ (ุงูุฅุฌุฑุงุกุงุช) </h3><br><p style=";text-align:right;direction:rtl">  ุงูุขู ููุฏ ุชู ูุตู ุฎุฏูุงุช ุงูุฏุนู ุงูุฃุณุงุณูุฉ ุ ููุฏ ุญุงู ุงูููุช ููุงูุชูุงู ุฅูู ุชูููุฐ ููุทู ุฃุนูุงู ุงูุฑูุจูุช ููุณู.  ุชุฎุทูุทูุง ุงูุนูุงูุฉ ุจูู ุงููุญุฏุงุช ุงูููุฏูุฉ ููุง: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="ุงูุฅุฌุฑุงุกุงุช"></p><br><p style=";text-align:right;direction:rtl">  ุชุชุถูู ููุงู ุงููุฆุฉ <em>BaseAction</em> ุงูุฃุณุงุณูุฉ ูุง ููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงุดุชุฑู ูู ุญุฏุซ ูุนูู ูู <em>AppEmitter</em> . </li><li style=";text-align:right;direction:rtl">  ุงููุธููุฉ ุงูุนุงูุฉ ููุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ุ ููู: <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุจุญุซ ุนู ูุงุญุฏุฉ ููุฌูุฏุฉ ุฃู ุฅูุดุงุก ุฏุฑุฏุดุฉ ุฌุฏูุฏุฉ ูู ุณูุงููุง ุณุชุชู ูุนุงูุฌุฉ ุงููุฑูู. </li><li style=";text-align:right;direction:rtl">  ุงุณุชุฏุนุงุก ุฅูู ุฃุณููุจ ูุงูุจ <code>doAction</code> ุชุทุจููู ูุฑุฏููุง ููู ูุฆุฉ ูู ูุฆุงุช <em>BaseAction</em> ุงูููุฑูุซุฉ. </li><li style=";text-align:right;direction:rtl">  ุชุทุจูู ุงูููุงูุจ ุนูู ุงุณุชุฌุงุจุฉ <code>doAction</code> ุงููุงุชุฌุฉ ุจุงุณุชุฎุฏุงู <em>TemplateService</em> . </li></ul></li></ol><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุนูู ุงูุฃุณุงุณู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected appEmitter: AppEmitter; protected config: ConfigService; protected logger: Logger; protected templateService: TemplateService; protected storageService: StorageService; protected event: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = config; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter = appEmitter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService = templateService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setEvent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`subscribe on "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.on(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleEvent.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } private <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handleEvent(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event received`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chatId: number = message.chatId; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.ensureChat(chatId); message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doAction(chat, message); message.answer( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService.apply( { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: message.getReplyStatus(), <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: message.lang, }, message.getReplyData(), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.error(error); message.answer(error.message); } } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุชุชูุซู ูููุฉ ุงููุฆุงุช ุงููุฑุนูุฉ <em>BaseAction</em> ูู ุชูููุฐ ุทุฑููุฉ <code>doAction</code> ูููุฏุฎูุงุช: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <em>ุงููุญุงุฏุซุฉ</em> ุงูุชู ุชู ุฅูุดุงุคูุง ุฃู ุชุนุฑูููุง ูู ุงููุฆุฉ ุงูุฃุณุงุณูุฉ </li><li style=";text-align:right;direction:rtl">  ูุงุฆู ูุชูุงูู ูุน ุจุฑูุชูููู <em>IMessage</em> . </li></ol><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุชูููุฐ ูุฐู ุงูุทุฑููุฉ ุ <em>ูุชู</em> ุฅุฑุฌุงุน <em>IMessage</em> ุฃูุถูุง ุ ูููู ูุน ุงูุญุงูุฉ ุงููุญุฏุฏุฉ ูุงุฎุชูุงุฑ ุงููุงูุจ ุงูุตุญูุญ ูุงูุจูุงูุงุช ุงูุชู ุณุชุดุงุฑู ูู ูุงูุจ ุงูุงุณุชุฌุงุจุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">EventAddAction</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {parseEventDate, formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventDate: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> = parseEventDate(message.text.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventDate) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_INVALID_DATE); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.appendChatActiveEvent( chat, eventDate, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(event.date), }); } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">EventRemoveAction</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">EventInfoAction</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventInfoAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_INFO; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers( activeEvent, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">PlayerAddAction</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_ALREADY_ADDED) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.addPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: newPlayer.name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">PlayerRemoveAction</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_NO_PLAYER) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.removePlayer(existedPlayer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ูุง ูุฌุจ ุงูุงูุชุจุงู ุฅููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุฃูุงูุฑ <code>/add</code> ู <code>/remove</code> ุชุถูู / ุชุฒูู ุงููุดุบู ุงูุฐู ูุฃุชู ุงุณูู ุจุนุฏ ุงูุฃูุฑ.  ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ุงูุงุณู ุ ูุณูุชู ุฅุถุงูุฉ / ุฅุฒุงูุฉ ุงููุงุนุจ ุงูุฐู ุงุชุตู ุจุงููุฑูู. </li><li style=";text-align:right;direction:rtl">  ุงุณุชุฌุงุจุฉ ูุฃูุงูุฑ <code>/add</code> ู <code>/remove</code> ู <code>/info</code> ุ ูุชู ุนุฑุถ ูุงุฆูุฉ ูุญุฏูุซุฉ ูู ูุดุบูุงุช ุงูุญุฏุซ ุงููุดุท. </li></ol><br><p style=";text-align:right;direction:rtl">  ุชู ููู ุงููุธููุฉ ุงููุทููุจุฉ ููุชุทุจูู (1) ู (2) ุฅูู ูุฆุฉ ูุณุงุนุฏุฉ ุฎุงุตุฉ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">PlayerHelper</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerHelper</span></span></span><span class="hljs-class"> </span></span>{ protected storageService: StorageService; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(storageService: StorageService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; } public getPlayerName(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name = message.text.trim(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? name : message.name; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getPlayersList(event: Event) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers(event); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">total</span></span>: players.length, <span class="hljs-attr"><span class="hljs-attr">players</span></span>: players.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player, index</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: player.name, })), }; } }</code> </pre></div></div><br><h3 id="sobiraem-vse-vmeste" style=";text-align:right;direction:rtl">  ูุถุน ูู ุฐูู ูุนุง </h3><br><p style=";text-align:right;direction:rtl">  ููุง ุฐูุฑ ูู ุจุฏุงูุฉ ุงูููุงู ุ ูุชู ุงุณุชุฎุฏุงู ุฅุทุงุฑ ุนูู <a href="https://nestjs.com/">NestJS</a> ูุฅุทุงุฑ ุนูู ููุชุทุจูู.  ููุช ูุญุธูุธูุง ูู ุฐูู ุงูููุช ูุญุถูุฑ <a href="https://www.youtube.com/watch%3Fv%3Djo-1EUxMmxc">ุงูุชูุฑูุฑ</a> ุดุฎุตููุง ูู ุฎุงูู ูุฐู ุงูููุชุจุฉ ุงูุฑุงุฆุนุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุบุงูุจูุง ูุง ุชุฎุทุฆ ุงูุนุฏูุฏ ูู ููุงุนุฏ ุงูุจูุงูุงุช ูุงูุฃุฏูุฉ ูุงูููุชุจุงุช ูู NodeJS ุจุนุฏู ุชูุฏูู ุฃู ุฅุณุชุฑุงุชูุฌูุงุช ุนููุงููุฉ ููุชููุฆุฉ ูุงูุงุชุตุงู ุจูู ุงููุญุฏุงุช ุงูููุทูุฉ.  ูุน ููู ุงูุชุทุจูู ุ ูู ุบูุงุจ ุงูุงูุชูุงู ุงูููุงุณุจ ุ ุชุตุจุญ ูุงุนุฏุฉ ุงูููุฏ ุจูุซุงุจุฉ ุฎููุท ูู ุงููุชุทูุจุงุช ุจูู ุงููุญุฏุงุช ุ ููุง ูุคุฏู ูู ูุซูุฑ ูู ุงูุฃุญูุงู ุฅูู ุงูุชุจุนูุงุช ุงูุฏูุฑูุฉ ุฃู ุงูุนูุงูุงุช ุงูุชู ูุง ููุจุบู ุฃู ุชููู ุนูููุง ูู ุญูุซ ุงููุจุฏุฃ.        Dependency Injection   <a href="https://www.npmjs.com/package/awilix">awilix</a> ,  <a href="https://nestjs.com/">NestJS</a>  . </p><br><p style=";text-align:right;direction:rtl">   DI      ,    NodeJS ,            ,        . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="  "></p><br><h2 id="konfiguraciya" style=";text-align:right;direction:rtl">  </h2><br><p style=";text-align:right;direction:rtl">            . </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_BOT_TOKEN</code> โ    Telegram . </li><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_USE_PROXY</code> โ          TelegramAPI. </li><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_PROXY_HOST</code> โ       TelegramAPI. </li><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_PROXY_PORT</code> โ       TelegramAPI. </li><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_PROXY_LOGIN</code> โ       TelegramAPI. </li><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_PROXY_PASSWORD</code> โ       TelegramAPI. </li><li style=";text-align:right;direction:rtl"> <code>VK_TOKEN</code> โ    VK . </li><li style=";text-align:right;direction:rtl"> <code>DATABASE_URL</code> โ    .   production . </li></ol><br><p style=";text-align:right;direction:rtl">      : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>TELEGRAM_BOT_TOKEN</code>       <a href="https://tlgrm.ru/docs/bots"> </a>      Telegram. </li><li style=";text-align:right;direction:rtl"> <code>VK_TOKEN</code> โ    ,  VK    .  ุฃู    ,             .       <a href="https://vk.com/dev/bots_docs">  </a>  . </li><li style=";text-align:right;direction:rtl"> <code>DATABASE_URL</code> โ  production      PostgreSQL.          DBaaS   <a href="https://www.elephantsql.com/">elephantsql</a>   . </li></ol><br><h2 id="ci" style=";text-align:right;direction:rtl"> CI </h2><br><p style=";text-align:right;direction:rtl"> " -   โ   ".    ,       <a href="https://travis-ci.org/">TravisCI</a>       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">language: node_js node_js: - '8' - '10' - '12' script: - npm run lint - npm run build - npm run test:cov after_script: - npm install -g codecov - codecov</code> </pre> <br><p style=";text-align:right;direction:rtl">                      <a href="https://codecov.io/">codecov</a> . </p><br><p style=";text-align:right;direction:rtl">    <a href="https://www.docker.com/">Docker</a>      <a href="https://hub.docker.com/">Docker Hub</a>        <a href="https://habr.com/ru/users/Gonf/">Gonf</a>    <a href="https://habr.com/ru/post/476368/">  CI/CD   GitHub Actions  Python</a> .         Continuous Deployment,       Github: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">name: Release on: release: types: [published] jobs: build: runs-on: ubuntu-latest env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - uses: actions/checkout@v1 - name: Install Node.js uses: actions/setup-node@v1 - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - name: npm install and build run: npm ci &amp;&amp; npm run build - name: Build the Docker image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code> </pre> <br><h2 id="rezultat-i-vyvody" style=";text-align:right;direction:rtl">    </h2><br><p style=";text-align:right;direction:rtl">     .  Telegram     : <br>        . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="demo1"></p><br><p style=";text-align:right;direction:rtl">    . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="demo2"></p><br><p style=";text-align:right;direction:rtl">      . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br><p style=";text-align:right;direction:rtl">     VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code> . <br>        . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="demo4"></p><br><p style=";text-align:right;direction:rtl">      . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br><p style=";text-align:right;direction:rtl">   <a href="https://www.viber.com/">Viber</a> ,              .         ,    <a href="https://www.viber.com/">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://github.com/Viber/sample-bot-isitup/issues/2"></a> .          (?) . </p><br><p style=";text-align:right;direction:rtl">  Telegram            <code>@Tormozz48bot</code> . </p><br><p style=";text-align:right;direction:rtl">     <a href="https://github.com/tormozz48/football-chat-bot-2"> Github</a> .   ,   . </p><br><p style=";text-align:right;direction:rtl"> PS    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar483194/">https://habr.com/ru/post/ar483194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar483178/index.html">ุฅููู ุชุญุฏูุซูุง ุญูู ุฅุตุฏุงุฑ Flutter 1.9 ูุน ุจุฑูุฌุฉ Dart 2.5</a></li>
<li><a href="../ar483182/index.html">ุฎูุณ ุทุฑู ูุซูุฑุฉ ููุงูุชูุงู ูุงุณุชุฎุฏุงู Array.reduce () (ูุทุฑููุฉ ูููุฉ ูุงุญุฏุฉ)</a></li>
<li><a href="../ar483184/index.html">ุงูุชููุงุฆู ุฑูุฒ ุงูุชุฑููุฉ ุฅูู TensorFlow 2</a></li>
<li><a href="../ar483186/index.html">ุชูุฏูู Java 13: ุฏุนูุง ูุชุตูุญ ููุฒุงุช JDK ุงูุฌุฏูุฏุฉ</a></li>
<li><a href="../ar483190/index.html">ุฅุฌุงุจุงุช ุงูุฏุนู ุงูููู ูู 3CX: ุงูุชุฑููุฉ ุฅูู ุงูุฅุตุฏุงุฑ 3CX v16 ูู ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ</a></li>
<li><a href="../ar483198/index.html">ููู ุชุฏูุฑ Alibaba Cloud ุนุดุฑุงุช ุงูุขูุงู ูู ูุฌููุนุงุช Kubernetes ุจุงุณุชุฎุฏุงู ...</a></li>
<li><a href="../ar483202/index.html">ููุฏูุฉ ุฅูู REST API - ุฎุฏูุงุช ุงูููุจ RESTful</a></li>
<li><a href="../ar483204/index.html">ุงูุงุฎุชูุงูุงุช ุจูู ุงูุฑุงุญุฉ ูุงูุตุงุจูู</a></li>
<li><a href="../ar483206/index.html">ุชุทููุฑ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช REST - ูุง ูู ุงูุนูุฏ ุฃููุงูุ</a></li>
<li><a href="../ar483208/index.html">ูุฑุงุฌุนุฉ Kaggle ML & DS Survey 2019. ุฃู ูู ููุณุจ ุงุฎุชุตุงุตูู ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>