<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèΩ ü§µüèø üßô Sauvegarde d'un grand nombre de projets Web h√©t√©rog√®nes üöÑ üéüÔ∏è üé©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il semblerait que le sujet soit galvaud√© - beaucoup a √©t√© dit et √©crit sur la sauvegarde, donc il n'y a rien pour r√©inventer la roue, il suffit de la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sauvegarde d'un grand nombre de projets Web h√©t√©rog√®nes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/424717/"><p>  Il semblerait que le sujet soit galvaud√© - beaucoup a √©t√© dit et √©crit sur la sauvegarde, donc il n'y a rien pour r√©inventer la roue, il suffit de la prendre et de la faire.  N√©anmoins, chaque fois que l'administrateur syst√®me d'un projet Web est confront√© √† la t√¢che de configurer des sauvegardes, pour beaucoup, il est suspendu dans l'air avec un gros point d'interrogation.  Comment collecter correctement la sauvegarde des donn√©es?  O√π stocker les sauvegardes?  Comment assurer le niveau n√©cessaire de stockage r√©trospectif des copies?  Comment unifier le processus de sauvegarde pour l'ensemble du zoo de diff√©rents logiciels? </p><br><p><img src="https://habrastorage.org/webt/xk/rn/7r/xkrn7rrnask1pgpv4uvrby6tnrc.jpeg"></p><a name="habracut"></a><br><p>  Pour nous-m√™mes, nous avons r√©solu ce probl√®me pour la premi√®re fois en 2011. Ensuite, nous nous sommes assis et avons √©crit nos scripts de sauvegarde.  Au fil des ans, nous les avons utilis√©s uniquement et ils ont fourni avec succ√®s un processus fiable de collecte et de synchronisation des sauvegardes des projets Web de nos clients.  Les sauvegardes ont √©t√© stock√©es dans notre ou un autre stockage externe, avec la possibilit√© de r√©gler pour un projet sp√©cifique. </p><br><p>  Je dois dire que ces scripts ont fonctionn√© au maximum.  Mais plus nous progressions, plus nous avions de projets divers avec diff√©rents logiciels et r√©f√©rentiels externes que nos scripts ne prenaient pas en charge.  Par exemple, nous n'avons pas pris en charge Redis et les sauvegardes √† chaud MySQL et PostgreSQL qui sont apparues plus tard.  Le processus de sauvegarde n'a pas √©t√© surveill√©, il n'y a eu que des alertes par e-mail. </p><br><p>  Un autre probl√®me √©tait le processus de support.  Au fil des ans, nos scripts autrefois compacts se sont d√©velopp√©s et se sont transform√©s en un √©norme monstre maladroit.  Et lorsque nous nous sommes r√©unis et avons publi√© une nouvelle version, cela valait la peine de d√©ployer la mise √† jour pour cette partie des clients qui utilisaient la version pr√©c√©dente avec une sorte de personnalisation. </p><br><p>  En cons√©quence, au d√©but de cette ann√©e, nous avons pris une d√©cision ferme: remplacer nos anciens scripts de sauvegarde par quelque chose de plus moderne.  Par cons√©quent, au d√©but, nous nous sommes assis et avons √©crit toute la liste de souhaits pour une nouvelle solution.  Il s'est av√©r√© approximativement ce qui suit: </p><br><ul><li>  Sauvegardez les donn√©es des logiciels les plus fr√©quemment utilis√©s: <br><ul><li>  Fichiers (copie discr√®te et incr√©mentielle) </li><li>  MySQL (sauvegardes √† froid / √† chaud) </li><li>  PostgreSQL (sauvegardes √† froid / √† chaud) </li><li>  Mongodb </li><li>  Redis </li></ul></li><li>  Stockez les sauvegardes dans des r√©f√©rentiels populaires: <br><ul><li>  Local </li><li>  FTP </li><li>  Ssh </li><li>  SMB </li><li>  Nfs </li><li>  Webdav </li><li>  S3 </li></ul></li><li>  Recevez des alertes en cas de probl√®me pendant le processus de sauvegarde </li><li>  Avoir un seul fichier de configuration qui vous permet de g√©rer les sauvegardes de mani√®re centralis√©e </li><li>  Ajoutez la prise en charge de nouveaux logiciels en connectant des modules externes </li><li>  Sp√©cifiez des options suppl√©mentaires pour la collecte des vidages </li><li>  Avoir la possibilit√© de restaurer des sauvegardes par des moyens r√©guliers </li><li>  Configuration initiale facile </li></ul><br><h1 id="analiziruem-imeyuschiesya-resheniya">  Nous analysons les solutions disponibles </h1><br><p>  Nous avons examin√© les solutions open source qui existent d√©j√†: </p><br><ul><li>  Bacula et ses fourchettes, par exemple, Bareos </li><li>  Amanda </li><li>  Borg </li><li>  Duplicaty </li><li>  Duplicit√© </li><li>  Rsnapshot </li><li>  Rdiff-backup </li></ul><br><p>  Mais chacun d'eux avait ses inconv√©nients.  Par exemple, Bacula est surcharg√© de fonctions dont nous n'avons pas besoin, la configuration initiale est une t√¢che assez laborieuse en raison de la grande quantit√© de travail manuel (par exemple, pour √©crire / rechercher des scripts de sauvegarde de base de donn√©es), et pour r√©cup√©rer des copies, il est n√©cessaire d'utiliser des utilitaires sp√©ciaux, etc. </p><br><p>  En fin de compte, nous sommes arriv√©s √† deux conclusions importantes: </p><br><ol><li> Aucune des solutions existantes ne nous convenait parfaitement; </li><li>  Il semble que nous-m√™mes avions suffisamment d'exp√©rience et de folie pour commencer √† r√©diger notre d√©cision. </li></ol><br><p>  Nous l'avons donc fait. </p><br><h1 id="rozhdenie-nxs-backup">  La naissance de nxs-backup </h1><br><p>  Python a √©t√© choisi comme langage d'impl√©mentation - il est facile √† √©crire et √† maintenir, flexible et pratique.  Il a √©t√© d√©cid√© de d√©crire les fichiers de configuration au format yaml. </p><br><p>  Pour faciliter la prise en charge et l'ajout de sauvegardes de nouveaux logiciels, une architecture modulaire a √©t√© choisie o√π le processus de collecte des sauvegardes de chaque logiciel sp√©cifique (par exemple, MySQL) est d√©crit dans un module distinct. </p><br><h2 id="podderzhka-faylov-bd-i-udalyonnyh-hranilisch">  Prise en charge des fichiers, des bases de donn√©es et du stockage √† distance </h2><br><p>  Actuellement, les types de sauvegardes de fichiers, bases de donn√©es et r√©f√©rentiels distants suivants sont pris en charge: </p><br><p>  DB: </p><br><ul><li>  MySQL (sauvegardes √† chaud / √† froid) </li><li>  PostgreSQL (sauvegardes √† chaud / √† froid) </li><li>  Redis </li><li>  Mongodb </li></ul><br><p>  Fichiers: </p><br><ul><li>  Copie discr√®te </li><li>  Copie incr√©mentielle </li></ul><br><p>  R√©f√©rentiels distants: </p><br><ul><li>  Local </li><li>  S3 </li><li>  SMB </li><li>  Nfs </li><li>  FTP </li><li>  Ssh </li><li>  Webdav </li></ul><br><h2 id="diskretnoe-rezervnoe-kopirovanie">  Sauvegarde discr√®te </h2><br><p>  Pour diff√©rentes t√¢ches, des sauvegardes discr√®tes ou incr√©mentielles conviennent, par cons√©quent, elles ont impl√©ment√© les deux types.  Vous pouvez sp√©cifier la m√©thode √† utiliser au niveau des fichiers et r√©pertoires individuels. </p><br><p>  Pour les copies discr√®tes (fichiers et bases de donn√©es), vous pouvez d√©finir une r√©trospective au format jours / semaines / mois. </p><br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Sauvegarde incr√©mentielle </h2><br><p>  Des copies incr√©mentielles des fichiers sont effectu√©es comme suit: <br><img src="https://habrastorage.org/webt/c7/wk/ss/c7wksse4j_mxjkgdffptngpglkw.jpeg"></p><br><p>  Au d√©but de l'ann√©e, une sauvegarde compl√®te est en cours.  Ensuite, au d√©but de chaque mois - une copie mensuelle incr√©mentielle par rapport √† l'ann√©e.  Au cours de la menstruation - d√©cadale incr√©mentielle par rapport au mois.  Dans chaque jour incr√©mentiel de dix jours par rapport √† la p√©riode de dix jours. </p><br><p>  Il convient de noter que, m√™me s'il existe des probl√®mes lors de l'utilisation de r√©pertoires contenant un grand nombre de sous-r√©pertoires (des dizaines de milliers).  Dans de tels cas, la collecte de copies est consid√©rablement ralentie et peut prendre plus d'une journ√©e.  Nous nous attaquons activement √† cette lacune. </p><br><h2 id="vosstanavlivaemsya-iz-inkrementnyh-bekapov">  Nous r√©cup√©rons des sauvegardes incr√©mentielles </h2><br><p>  Il n'y a aucun probl√®me avec la r√©cup√©ration √† partir de sauvegardes discr√®tes - il suffit de prendre une copie pour la date requise et de la d√©ployer avec le tar de console habituel.  Les copies incr√©mentielles sont un peu plus compliqu√©es.  Pour r√©cup√©rer, par exemple, le 24 juillet 2018, vous devez proc√©der comme suit: </p><br><ol><li>  D√©veloppez une sauvegarde d'un an, m√™me si dans notre cas elle commence √† partir du 1er janvier 2018 (en pratique, cela peut √™tre n'importe quelle date, selon le moment o√π il a √©t√© d√©cid√© d'impl√©menter des sauvegardes incr√©mentielles) </li><li>  Rouler sur lui une sauvegarde mensuelle pour juillet </li><li>  Rouler la sauvegarde de la d√©cennie du 21 juillet </li><li>  Roll up sauvegarde quotidienne pour le 24 juillet </li></ol><br><p>  Dans le m√™me temps, pour effectuer 2 √† 4 points, vous devez ajouter le commutateur -G √† la commande tar, indiquant ainsi qu'il s'agit d'une sauvegarde incr√©mentielle.  Bien s√ªr, ce n'est pas le processus le plus rapide, mais si vous consid√©rez qu'il n'est pas si souvent n√©cessaire de r√©cup√©rer des sauvegardes et que la rentabilit√© est importante, un tel sch√©ma s'av√®re assez efficace. </p><br><h2 id="isklyucheniya">  Exceptions </h2><br><p>  Souvent, vous devez exclure des fichiers ou des r√©pertoires individuels des sauvegardes, par exemple, des r√©pertoires avec un cache.  Cela peut √™tre fait en sp√©cifiant les r√®gles d'exception appropri√©es: </p><br><div class="spoiler">  <b class="spoiler_title">exemple de fichier de configuration</b> <div class="spoiler_text"><pre><code class="hljs ruby">- <span class="hljs-symbol"><span class="hljs-symbol">target:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/*/data</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ excludes: - exclude1/exclude</span></span>_file - exclude2 - <span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/exclude_3</span></span></code> </pre> </div></div><br><h2 id="rotaciya-bekapov">  Rotation de sauvegarde </h2><br><p>  Dans nos anciens scripts, la rotation √©tait impl√©ment√©e de sorte que l'ancienne copie n'√©tait supprim√©e qu'apr√®s que la nouvelle ait √©t√© correctement assembl√©e.  Cela a entra√Æn√© des probl√®mes sur les projets o√π l'espace pour les sauvegardes, en principe, √©tait allou√© exactement pour une copie - une nouvelle copie n'a pas pu √™tre collect√©e √† cause d'un manque d'espace. </p><br><p>  Dans la nouvelle impl√©mentation, nous avons d√©cid√© de changer cette approche: supprimez d'abord l'ancienne et ensuite seulement collectez une nouvelle copie.  Et le processus de collecte des sauvegardes doit √™tre surveill√© pour d√©tecter tout probl√®me. </p><br><p>  Pour les sauvegardes discr√®tes, une archive est consid√©r√©e comme une ancienne copie qui va au-del√† du sch√©ma de stockage sp√©cifi√© au format jours / semaines / mois.  Dans le cas des sauvegardes incr√©mentielles, les sauvegardes sont stock√©es par d√©faut pendant un an, et les anciennes copies sont supprim√©es au d√©but de chaque mois, tandis que les archives du m√™me mois de l'ann√©e derni√®re sont consid√©r√©es comme des anciennes sauvegardes.  Par exemple, avant de collecter une sauvegarde mensuelle le 1er ao√ªt 2018, le syst√®me v√©rifiera s'il existe des sauvegardes pour ao√ªt 2017 et, dans l'affirmative, il les supprimera.  Cela permet une utilisation optimale de l'espace disque. </p><br><h2 id="logirovanie">  Journalisation </h2><br><p>  Dans tous les processus, et en particulier dans les sauvegardes, il est important de se tenir au courant et de savoir si quelque chose s'est mal pass√©.  Le syst√®me conserve un journal de son travail et capture le r√©sultat de chaque √©tape: d√©but / fin des fonds, d√©but / fin d'une t√¢che sp√©cifique, r√©sultat de la collecte d'une copie dans un r√©pertoire temporaire, r√©sultat de la copie / d√©placement d'une copie d'un r√©pertoire temporaire vers un emplacement permanent, r√©sultat d'une rotation de sauvegarde, etc. .. </p><br><p>  Les √©v√©nements sont divis√©s en 2 niveaux: </p><br><ul><li>  <em>Info</em> : niveau d'information - le vol est normal, l'√©tape suivante s'est termin√©e avec succ√®s, une entr√©e d'information correspondante est effectu√©e dans le journal </li><li>  <em>Erreur</em> : niveau d'erreur - quelque chose s'est mal pass√©, l'√©tape suivante a √©chou√©, un enregistrement d'erreur correspondant est cr√©√© dans le journal </li></ul><br><h2 id="e-mail-notifikacii">  Notifications par e-mail </h2><br><p>  √Ä la fin de la collecte de sauvegarde, le syst√®me peut envoyer des notifications par e-mail. </p><br><p>  2 listes de destinataires sont prises en charge: </p><br><ul><li>  <em>Les administrateurs</em> sont ceux qui servent le serveur.  Ils ne re√ßoivent que des notifications d'erreurs; ils ne sont pas int√©ress√©s par les notifications d'op√©rations r√©ussies </li><li>  <em>Utilisateurs professionnels</em> - dans notre cas, ce sont des clients qui souhaitent parfois recevoir des notifications afin de s'assurer que tout va bien avec les sauvegardes.  Ou, inversement, pas vraiment.  Ils peuvent choisir de recevoir un journal complet ou uniquement un journal avec des erreurs. </li></ul><br><h2 id="struktura-konfiguracionnyh-faylov">  Structure du fichier de configuration </h2><br><p>  La structure des fichiers de configuration est la suivante: </p><br><div class="spoiler">  <b class="spoiler_title">exemple de structure</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/nxs-backup ‚îú‚îÄ‚îÄ conf.d ‚îÇ ‚îú‚îÄ‚îÄ desc_files_local.conf ‚îÇ ‚îú‚îÄ‚îÄ external_clickhouse_local.conf ‚îÇ ‚îú‚îÄ‚îÄ inc_files_smb.conf ‚îÇ ‚îú‚îÄ‚îÄ mongodb_nfs.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_s3.conf ‚îÇ ‚îú‚îÄ‚îÄ mysql_xtradb_scp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_ftp.conf ‚îÇ ‚îú‚îÄ‚îÄ postgresql_hot_webdav.conf ‚îÇ ‚îî‚îÄ‚îÄ redis_local_ftp.conf ‚îî‚îÄ‚îÄ nxs-backup.conf</code> </pre> </div></div><br><p>  Ici <em>/etc/nxs-backup/nxs-backup.conf</em> est le fichier de configuration principal dans lequel les param√®tres globaux sont indiqu√©s: </p><br><div class="spoiler">  <b class="spoiler_title">fichier de configuration</b> <div class="spoiler_text"><pre> <code class="hljs sql">main: server_name: SERVER_NAME admin_mail: project-tech@nixys.ru client_mail: - '' mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@domain.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file_name: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/nxs-backup.log jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> </div></div><br><p>  Le tableau des t√¢ches (travaux) contient une liste de t√¢ches (travaux), qui sont une description de quoi exactement sauvegarder, o√π stocker et en quelle quantit√©.  En r√®gle g√©n√©rale, ils sont d√©plac√©s vers des fichiers s√©par√©s (un fichier par t√¢che), qui sont connect√©s via include dans le fichier de configuration principal. </p><br><p>  Ils ont √©galement pris soin d'optimiser au maximum le processus de pr√©paration de ces fichiers et ont √©crit un g√©n√©rateur simple.  Par cons√©quent, l'administrateur n'a pas besoin de passer du temps √† rechercher le mod√®le de configuration pour un service, par exemple, MySQL, mais il suffit d'ex√©cuter la commande: </p><br><pre> <code class="bash hljs">nxs-backup generate --storage <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> scp --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> mysql --path /etc/nxs-backup/conf.d/mysql_local_scp.conf</code> </pre> <br><p>  La sortie g√©n√®re le fichier <em>/etc/nxs-backup/conf.d/mysql_local_scp.conf</em> : </p><br><div class="spoiler">  <b class="spoiler_title">Contenu du fichier</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: PROJECT-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: <span class="hljs-string"><span class="hljs-string">''</span></span> db_port: <span class="hljs-string"><span class="hljs-string">''</span></span> socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: <span class="hljs-string"><span class="hljs-string">''</span></span> db_password: <span class="hljs-string"><span class="hljs-string">''</span></span> auth_file: <span class="hljs-string"><span class="hljs-string">''</span></span> target: - all excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: scp <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> host: <span class="hljs-string"><span class="hljs-string">''</span></span> port: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> path_to_key: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> weeks: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> </div></div><br><p>  Dans lequel il ne reste plus qu'√† substituer quelques valeurs n√©cessaires. </p><br><p>  Prenons un exemple.  Supposons que sur notre serveur dans le r√©pertoire / var / www, il existe deux sites de la boutique en ligne 1C-Bitrix (bitrix-1.ru, bitrix-2.ru), chacun travaillant avec sa propre base de donn√©es dans diff√©rentes instances MySQL (port 3306 pour bitrix_1_db et port 3307 pour bitrix_2_db). </p><br><p>  La structure de fichiers d'un projet Bitrix typique est approximativement la suivante: </p><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ bitrix ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ admin ‚îÇ ‚îú‚îÄ‚îÄ backup ‚îÇ ‚îú‚îÄ‚îÄ cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ managed_cache ‚îÇ ‚îú‚îÄ‚îÄ .. ‚îÇ ‚îú‚îÄ‚îÄ stack_cache ‚îÇ ‚îî‚îÄ‚îÄ .. ‚îú‚îÄ‚îÄ upload ‚îî‚îÄ‚îÄ ...</code> </pre> <br><p>  En r√®gle g√©n√©rale, le r√©pertoire de <em>t√©l√©chargement</em> p√®se beaucoup et ne fait qu'augmenter avec le temps, il sera donc sauvegard√© de mani√®re incr√©mentielle.  Tous les autres r√©pertoires sont discrets, √† l'exception des r√©pertoires avec cache et sauvegardes collect√©s par les outils Bitrix natifs.  Laissez le sch√©ma de stockage de sauvegarde pour ces deux sites devrait √™tre le m√™me, tandis que les copies des fichiers doivent √™tre stock√©es localement et sur le stockage ftp distant, et la base de donn√©es doit √™tre stock√©e uniquement sur le stockage smb distant. </p><br><p>  Les fichiers de configuration r√©sultants pour une telle configuration ressembleront √† ceci: </p><br><div class="spoiler">  <b class="spoiler_title">bitrix-desc-files.conf (fichier de configuration avec description du travail pour la sauvegarde discr√®te)</b> <div class="spoiler_text"><pre> <code class="hljs powershell"> - job: Bitrix<span class="hljs-literal"><span class="hljs-literal">-desc</span></span><span class="hljs-literal"><span class="hljs-literal">-files</span></span> type: desc_files tmp_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump_tmp sources: - target: - /var/www/*/ excludes: - bitrix/backup - bitrix/cache - bitrix/managed_cache - bitrix/stack_cache - upload gzip: yes storages: - storage: local enable: yes backup_dir: /var/nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/files/desc/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span> - storage: ftp enable: yes backup_dir: /nxs<span class="hljs-literal"><span class="hljs-literal">-backup</span></span>/databases/mysql/dump host: ftp_host user: ftp_usr password: ftp_usr_pass store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-inc-files.conf (fichier de configuration avec description du travail pour la sauvegarde incr√©mentielle)</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript"> - job: Bitrix-inc-files type: inc_files sources: - target: - <span class="hljs-regexp"><span class="hljs-regexp">/var/www/</span></span>*<span class="hljs-regexp"><span class="hljs-regexp">/upload/</span></span> gzip: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> storages: - storage: ftp enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /nxs-backup/files/inc host: ftp_host user: ftp_usr password: ftp_usr_pass - storage: local enable: <span class="hljs-literal"><span class="hljs-literal">yes</span></span> backup_dir: /var/nxs-backup/files/inc</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">bitrix-mysql.conf (fichier de configuration avec description du travail pour les sauvegardes MySQL)</b> <div class="spoiler_text"><pre> <code class="hljs sql"> - job: Bitrix-mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3306</span></span> db_user: bitrux_usr_1 db_password: password_1 target: - bitrix_1_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: localhost db_port: <span class="hljs-number"><span class="hljs-number">3307</span></span> db_user: bitrix_usr_2 db_password: password_2 target: - bitrix_2_db excludes: - information_schema - performance_schema - mysql - <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span> gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: smb <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump host: smb_host port: smb_port <span class="hljs-keyword"><span class="hljs-keyword">share</span></span>: smb_share_name <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: smb_usr <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: smb_usr_pass <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><h2 id="parametry-dlya-zapuska-sbora-bekapov">  Options pour commencer √† collecter des sauvegardes </h2><br><p>  Dans l'exemple pr√©c√©dent, nous avons pr√©par√© des fichiers de configuration de travail pour collecter les sauvegardes de tous les √©l√©ments √† la fois: fichiers (discrets et incr√©mentiels), deux bases de donn√©es et les stocker sur des stockages locaux et externes (ftp, smb). </p><br><p>  Il reste √† g√©rer le tout.  Le lancement est effectu√© par la commande: </p><br><pre> <code class="bash hljs">nxs-backup start <span class="hljs-variable"><span class="hljs-variable">$JOB_NAME</span></span> -c <span class="hljs-variable"><span class="hljs-variable">$PATH_TO_MAIN_CONFIG</span></span></code> </pre> <br><p>  Il existe plusieurs noms de t√¢ches r√©serv√©s: </p><br><ul><li>  <strong>fichiers</strong> - ex√©cution arbitraire de tous les <em>travaux</em> avec les types <em>desc_files</em> , <em>inc_files</em> (c'est-√†-dire, essentiellement, seuls les fichiers sont <em>sauvegard√©s</em> ) </li><li>  <strong>bases de donn√©es</strong> - ex√©cution al√©atoire de toutes les t√¢ches avec les types <em>mysql</em> , <em>mysql_xtradb</em> , <em>postgresql</em> , <em>postgresql_hot</em> , <em>mongodb</em> , <em>redis</em> (c'est-√†-dire, sauvegarder uniquement la base de donn√©es) </li><li>  <strong>externe</strong> - ex√©cution al√©atoire de toutes les t√¢ches avec le type <em>externe</em> (ex√©cution uniquement de scripts personnalis√©s suppl√©mentaires, plus d'informations ci-dessous) </li><li>  <strong>all</strong> - imitation d'ex√©cuter la commande une par une avec les <em>fichiers de</em> travail, les <em>bases de donn√©es</em> , <em>externes</em> (valeur par d√©faut) </li></ul><br><p>  √âtant donn√© que nous devons obtenir des sauvegardes de donn√©es des fichiers et de la base de donn√©es en m√™me temps (ou avec une diff√©rence minimale) en sortie, il est recommand√© d'ex√©cuter nxs-backup avec job <strong>all</strong> , ce qui garantira une ex√©cution coh√©rente du travail d√©crit (Bitrix-desc- fichiers, Bitrix-inc_files, Bitrix-mysql). </p><br><p>  Autrement dit, un point important - les sauvegardes ne seront pas collect√©es en parall√®le, mais s√©quentiellement, l'une apr√®s l'autre, avec un d√©calage horaire minimum.  De plus, au prochain d√©marrage, le logiciel lui-m√™me v√©rifie le processus d√©j√† en cours dans le syst√®me et s'il est d√©tect√©, il terminera automatiquement son travail avec la marque correspondante dans le journal.  Cette approche r√©duit consid√©rablement la charge sur le syst√®me.  Moins - les sauvegardes des √©l√©ments individuels sont collect√©es non pas imm√©diatement, mais avec un certain d√©calage horaire.  Mais alors que notre pratique montre que ce n'est pas critique. </p><br><h2 id="vneshnie-moduli">  Modules externes </h2><br><p>  Comme mentionn√© ci-dessus, gr√¢ce √† l'architecture modulaire, les capacit√©s du syst√®me peuvent √™tre √©tendues √† l'aide de modules utilisateur suppl√©mentaires qui interagissent avec le syst√®me via une interface sp√©ciale.  L'objectif est de pouvoir √† l'avenir ajouter la prise en charge des sauvegardes de nouveaux logiciels sans avoir √† r√©√©crire nxs-backup. </p><br><div class="spoiler">  <b class="spoiler_title">exemple de fichier de configuration</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: TEST-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">''</span></span> storages: ‚Ä¶.</code> </pre> </div></div><br><p>  Une attention particuli√®re doit √™tre accord√©e √† la cl√© <strong>dump_cmd</strong> , o√π la valeur est la commande compl√®te pour ex√©cuter un script externe.  De plus, √† la fin de cette commande, il est pr√©vu que: </p><br><ul><li>  Une archive pr√™te √† l'emploi des donn√©es du logiciel sera collect√©e </li><li>  Les donn√©es seront envoy√©es √† stdout au format json, sous la forme: <br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"full_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"ABS_PATH_TO_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"basename"</span></span>: <span class="hljs-string"><span class="hljs-string">"BASENAME_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"EXTERNSION_OF_ARCHIVE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gzip"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>/<span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><ul><li>  Dans ce cas, les cl√©s <em>basename</em> , <em>extension</em> , <em>gzip sont</em> n√©cessaires exclusivement pour la formation du nom de sauvegarde final. </li></ul></li><li>  En cas de r√©ussite du script, le code retour doit √™tre 0 et tout autre en cas de probl√®me. </li></ul><br><p>  Par exemple, supposons que nous ayons un script pour cr√©er un instantan√© etcd <em>/etc/nxs-backup-ext/etcd.py</em> : </p><br><div class="spoiler">  <b class="spoiler_title">code de script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#! /usr/bin/env python3 # -*- coding: utf-8 -*- import json import os import subprocess import sys import tarfile def archive(snapshot_path): abs_tmp_path = '%s.tar' %(snapshot_path) with tarfile.open(abs_tmp_path, 'w:') as tar: tar.add(snapshot_path) os.unlink(snapshot_path) return abs_tmp_path def exec_cmd(cmdline): data_dict = {} current_process = subprocess.Popen([cmdline], stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True, executable='/bin/bash') data = current_process.communicate() data_dict['stdout'] = data[0][0:-1].decode('utf-8') data_dict['stderr'] = data[1][0:-1].decode('utf-8') data_dict['code'] = current_process.returncode return data_dict def main(): snapshot_path = "/var/backups/snapshot.db" dump_cmd = "ETCDCTL_API=3 etcdctl --cacert=/etc/ssl/etcd/ssl/ca.pem --cert=/etc/ssl/etcd/ssl/member-node1.pem"+\ " --key=/etc/ssl/etcd/ssl/member-node1-key.pem --endpoints 'https://127.0.0.1:2379' snapshot save %s" %snapshot_path command = exec_cmd(dump_cmd) result_code = command['code'] if result_code: sys.stderr.write(command['stderr']) else: try: new_path = archive(snapshot_path) except tarfile.TarError as e: sys.exit(1) else: result_dict = { "full_path": new_path, "basename": "etcd", "extension": "tar", "gzip": False } print(json.dumps(result_dict)) sys.exit(result_code) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  La configuration pour ex√©cuter ce script est la suivante: </p><br><div class="spoiler">  <b class="spoiler_title">fichier de configuration</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> - job: etcd-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> dump_cmd: <span class="hljs-string"><span class="hljs-string">'/etc/nxs-backup-ext/etcd.py'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /var/nxs-backup/<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>/dump store: days: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> month: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> </div></div><br><p>  Dans ce cas, le programme lors de l'ex√©cution du travail <em>etcd-external</em> : </p><br><ul><li>  Ex√©cutez le script <em>/etc/nxs-backup-ext/etcd.py</em> sans param√®tres </li><li>  Une fois le script termin√©, il v√©rifiera le code d'ach√®vement et la disponibilit√© des donn√©es n√©cessaires dans stdout </li><li>  Si toutes les v√©rifications r√©ussissent, le m√™me m√©canisme est utilis√© qu'avec les modules d√©j√† int√©gr√©s, o√π la valeur de la cl√© full_path est utilis√©e comme tmp_path.  Sinon, il terminera cette t√¢che avec la marque correspondante dans le journal. </li></ul><br><h1 id="podderzhka-i-obnovlenie">  Support et mise √† jour </h1><br><p>  Le processus de d√©veloppement et de prise en charge du nouveau syst√®me de sauvegarde a √©t√© mis en ≈ìuvre avec tous les canons de CI / CD.  Plus de mises √† jour et de modifications de script sur les serveurs de combat.  Toutes les modifications passent par notre r√©f√©rentiel git central dans Gitlab, o√π l'assemblage de nouvelles versions des paquets deb / rpm est enregistr√© dans le pipeline, qui sont ensuite t√©l√©charg√©s dans nos r√©f√©rentiels deb / rpm.  Et apr√®s cela, via le gestionnaire de packages, ils sont livr√©s aux serveurs clients finaux. </p><br><h1 id="kak-skachat-nxs-backup">  Comment t√©l√©charger nxs-backup? </h1><br><p>  Nous avons fait un projet open-source nxs-backup.  Tout le monde peut le t√©l√©charger et l'utiliser pour organiser le processus de sauvegarde dans ses projets, ainsi que modifier selon ses besoins, √©crire des modules externes. </p><br><p>  Le code source de nxs-backup peut √™tre t√©l√©charg√© √† partir du r√©f√©rentiel Github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur ce lien</a> .  Il y a √©galement des instructions d'installation et de configuration. </p><br><p>  Nous avons √©galement pr√©par√© une image Docker et l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avons</a> publi√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DockerHub</a> . </p><br><p>  Si vous avez des questions pendant la configuration ou l'utilisation, √©crivez-nous.  Nous vous aiderons √† comprendre et √† finaliser les instructions. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Dans un avenir proche, nous mettrons en ≈ìuvre les fonctionnalit√©s suivantes: </p><br><ul><li>  Surveillance de l'int√©gration </li><li>  Chiffrement de sauvegarde </li><li>  Interface Web pour g√©rer les param√®tres de sauvegarde </li><li>  D√©ployer des sauvegardes √† l'aide de nxs-backup </li><li>  Et bien plus </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424717/">https://habr.com/ru/post/fr424717/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424701/index.html">Des histoires informatiques fictives sur des imposteurs et pourquoi ces pratiques obscures sont apparues lors des interviews</a></li>
<li><a href="../fr424703/index.html">Et encore une fois sur la d√©personnalisation</a></li>
<li><a href="../fr424709/index.html">Chefs-d'≈ìuvre de la construction de colonnes du monde: 225 W RMS pour 28 000 roubles</a></li>
<li><a href="../fr424711/index.html">De l'hydrogel au boyau de porc: des mat√©riaux inhabituels en robotique</a></li>
<li><a href="../fr424713/index.html">Toute la v√©rit√© sur RTOS. Article # 12. Services pour travailler avec des t√¢ches</a></li>
<li><a href="../fr424723/index.html">Webinaires Skillbox Friday: utiles pour les d√©butants et plus</a></li>
<li><a href="../fr424725/index.html">√Ä propos d'Oracle JDK 11+ (licence et distribution)</a></li>
<li><a href="../fr424729/index.html">Pourquoi le compilateur a-t-il transform√© ma boucle conditionnelle en infini?</a></li>
<li><a href="../fr424731/index.html">Historique du support technique √† chaud, ou Pourquoi AutoCAD supprime-t-il les objets proxy?</a></li>
<li><a href="../fr424733/index.html">Pilule bleue STM32F103 comme PLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>