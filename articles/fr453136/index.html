<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèº üìÉ üéûÔ∏è API √©crite - XML ‚Äã‚Äãcass√© (deux) üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üçπ üïâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La premi√®re API MyStore est apparue il y a 10 ans. Pendant tout ce temps, nous travaillons sur des versions existantes de l'API et en d√©veloppons de n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>API √©crite - XML ‚Äã‚Äãcass√© (deux)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moysklad/blog/453136/">  La premi√®re API MyStore est apparue il y a 10 ans.  Pendant tout ce temps, nous travaillons sur des versions existantes de l'API et en d√©veloppons de nouvelles.  Et plusieurs versions de l'API ont d√©j√† √©t√© enterr√©es. <br><br>  Cet article aura beaucoup de choses: comment cr√©er l'API, pourquoi le service cloud en a besoin, ce qui donne aux utilisateurs quel rake nous avons r√©ussi √† utiliser et ce que nous voulons faire ensuite. <br><a name="habracut"></a><br>  Je m'appelle Oleg Alekseev <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">oalexeev</a> , je suis le directeur technique et co-fondateur de MySklad. <br><br><h2>  Pourquoi cr√©er une API pour un service </h2><br>  Nos clients, qui sont des dizaines de milliers d'entrepreneurs, utilisent activement les solutions cloud: banque, boutiques en ligne, comptabilit√© produit, CRM.  Connect√© √† un - et c'est d√©j√† difficile de s'arr√™ter.  Et maintenant, le cinqui√®me, huiti√®me, dixi√®me service facilite le travail de l'entrepreneur, mais les utilisateurs transf√®rent manuellement les donn√©es entre ces services cloud.  Le travail se transforme en cauchemar. <br><br>  La solution √©vidente est de donner aux utilisateurs la possibilit√© de transf√©rer des donn√©es entre les services cloud.  Par exemple, importez et exportez des donn√©es sous forme de fichiers, qui peuvent ensuite √™tre t√©l√©charg√©s vers le service souhait√©.  Les fichiers sont g√©n√©ralement modifi√©s au format de chaque service.  Il s'agit d'un travail manuel plus ou moins simple, mais avec l'augmentation du nombre de ces services, il devient plus difficile de l'ex√©cuter. <br><br>  Par cons√©quent, l'√©tape suivante est l'API.  Avec lui, un service cloud b√©n√©ficie de la connexion de plusieurs services en un seul point.  L'√©mergence d'un tel √©cosyst√®me attire de nouveaux clients gr√¢ce √† des opportunit√©s suppl√©mentaires.  Un produit dot√© de nouvelles fonctionnalit√©s devient plus rentable et utile. <br><br>  Si vous cr√©ez vos propres interfaces de programme, cela attire des vendeurs tiers sous la forme de programmeurs qui connaissent votre produit gr√¢ce √† l'API.  Ils commencent √† construire des solutions bas√©es sur l'API propos√©e et gagnent de l'argent en automatisant les t√¢ches de leurs clients. <br><br>  Le syst√®me comptable de MyStore est construit sur des processus simples.  L'essentiel est de travailler avec des documents primaires, la capacit√© d'accepter et d'exp√©dier des marchandises, et de recevoir des rapports d'activit√© sur la base du primaire.  Il y a aussi le transfert de donn√©es, par exemple, vers la comptabilit√© cloud, et leur r√©ception par les syst√®mes bancaires ou les points de vente.  Nous travaillons √©galement avec des boutiques en ligne: nous recevons des informations sur les marchandises et envoyons des donn√©es sur les soldes. <br><br><img src="https://habrastorage.org/webt/bu/cm/xx/bucmxx8qzy9efcgtznvyncdprje.png" alt="Le cycle de donn√©es autour des boutiques en ligne dans MyStore"><br><br><h2>  Premi√®re API MyStore </h2><br>  Au cours de 10 ann√©es de travail de MyStore avec l'API, nous avons acquis toutes sortes d'int√©grations qui vous permettent d'√©changer des donn√©es, de travailler avec des banques, de payer et d'utiliser la t√©l√©phonie externe. <br><br>  La premi√®re ann√©e, nous avons permis de t√©l√©charger toutes les donn√©es au format XML.  Ensuite, il √©tait beaucoup plus compr√©hensible et familier pour les utilisateurs de garder les donn√©es hors ligne, et non dans une sorte de cloud, et nous leur avons donn√© ceci.  Le d√©chargement a commenc√© par une exportation manuelle depuis l'interface.  Autrement dit, l'API n'a pas encore pu √™tre appel√©e. <br><br>  Ensuite, nous avons commenc√© √† coop√©rer avec Rusagro - ils utilisaient d√©j√† l'ERP "adulte" pour planifier la production et les ventes, mais le chargement des voitures dans les usines a √©t√© automatis√© √† MySklad.  Nous avons donc eu les premiers rudiments de cette API: l'√©change entre notre service et l'ERP a eu lieu en envoyant un fichier volumineux avec des donn√©es pour tous types de documents. <br><br>  C'est une bonne option pour l'√©change de donn√©es par lots, mais avec les documents, ils devaient transf√©rer leurs d√©pendances: informations sur les marchandises, les entrepreneurs et les entrep√¥ts.  Une telle d√©charge n'est pas si difficile √† g√©n√©rer lors de l'exportation, mais elle est plut√¥t difficile √† d√©monter lors de l'importation, car toutes les informations sont r√©unies dans un seul paquet: √† la fois sur les nouveaux documents et sur les documents existants. <br><br>  La premi√®re API XML n'a pas dur√© longtemps - deux ans plus tard, nous avons commenc√© √† la reconstruire.  M√™me au d√©but de son travail, nous avons fait plusieurs erreurs lors de la construction de l'interface logicielle. <br><br><img src="https://habrastorage.org/storage2/51d/0be/dca/51d0bedca4dcedbabf6cf125e2acc93a.jpg" alt="Comment l'API XML a √©t√© cr√©√©e: une illustration d'un de nos architectes. Soit dit en passant, attendez ses articles."><br>  <i>Comment l'API XML a √©t√© cr√©√©e: une illustration d'un de nos architectes.</i>  <i>Soit dit en passant, attendez ses articles.</i> <br><br>  Voici nos principales erreurs: <br><br><ol><li>  Le balisage JAXB a √©t√© effectu√© directement sur les beans entit√©.  Nous utilisons Hibernate pour communiquer avec la base de donn√©es et le balisage JAXB a √©t√© effectu√© sur les m√™mes beans.  Cette erreur est survenue presque imm√©diatement: toute mise √† jour de la structure de donn√©es a conduit √† la n√©cessit√© de pr√©venir de toute urgence tous ceux qui utilisent l'API, ou de construire des b√©quilles qui garantiraient la compatibilit√© avec la structure de donn√©es pr√©c√©dente. </li><li>  L'API s'est d√©velopp√©e comme une sorte d'ajout, et au d√©part, nous n'avons pas d√©termin√© quelle partie du produit elle constituait.  Nous n'avons m√™me pas pens√© √† savoir si l'API √©tait quelque chose d'important, s'il √©tait n√©cessaire de maintenir la compatibilit√© descendante pour ses premiers clients.  √Ä un moment donn√©, le nombre d'utilisateurs d'API √©tait d'environ 5% du petit nombre total, et aucune attention n'a √©t√© accord√©e √† eux.  Le filtrage universel r√©alis√© en temps voulu nous a conduit √† nous utiliser comme backend.  Ce filtrage n'√©tait pas du tout GraphQL, mais quelque chose comme √ßa - il a fonctionn√© √† travers de nombreux param√®tres de cha√Æne de requ√™te.  Avec un outil aussi puissant, il √©tait difficile pour les utilisateurs de r√©sister, et les demandes nous √©taient transf√©r√©es afin qu'elles soient envoy√©es directement depuis l'interface utilisateur de leurs boutiques en ligne.  La situation a √©t√© une surprise d√©sagr√©able, car la fourniture d'un tel service devrait n√©cessiter une tarification diff√©rente et une compr√©hension diff√©rente de l'API elle-m√™me en tant que produit. </li><li>  √âtant donn√© que l'API ne s'est pas d√©velopp√©e en tant que produit principal, la documentation de l'API a √©t√© produite et publi√©e selon le principe r√©siduel - par r√©tro-ing√©nierie.  Cette m√©thode semble assez simple et pratique, mais contraire au travail √† contrat.  C'est quand il y a un certain composant avec un sch√©ma de travail pr√©d√©fini.  Le d√©veloppeur le met en ≈ìuvre conform√©ment √† ce sch√©ma et √† cette t√¢che, le composant est test√©, le client re√ßoit un produit qui correspond √† l'id√©e de l'analyste.  La r√©tro-ing√©nierie, d'autre part, lance un produit qui existe simplement: avec des b√©quilles, des solutions √©tranges et des v√©los au lieu des fonctionnalit√©s n√©cessaires. </li><li>  L'ensemble du flux de demandes provenant de l'API n'a pu √™tre analys√© que dans un journal ou un serveur d'applications Nginx.  Cela ne nous a pas permis d'isoler les sujets, sauf peut-√™tre de les diviser par utilisateurs et abonn√©s.  S'il n'est pas possible de r√©glementer l'enregistrement de l'application ou des clients, il devient impossible d'analyser la situation.  Ce probl√®me a eu le moins d'impact sur le d√©veloppement de l'API, il s'agit plut√¥t de comprendre sa pertinence et ses fonctionnalit√©s. </li></ol><br><h2>  Tentative num√©ro deux: API REST </h2><br>  En 2010, nous avons essay√© de construire un syst√®me d'√©change avec comptabilit√© en ligne - BukhSoft.  N'a pas d√©coll√©.  Mais dans le processus d'int√©gration, une API √† part enti√®re est apparue: un service d'√©change REST, o√π il n'y avait pas de libert√©s comme les appels aux op√©rations sous forme d'appels RPC.  Toutes les communications avec l'API ont √©t√© ramen√©es √† un mode standard de repos: la cha√Æne de requ√™te contient le nom de l'entit√© et l'op√©ration qui est effectu√©e avec elle est d√©finie √† l'aide de la m√©thode http.  Nous avons ajout√© le filtrage au moment de la mise √† jour des entit√©s, et les utilisateurs ont d√©sormais la possibilit√© de cr√©er une r√©plication avec leurs syst√®mes. <br><br>  La m√™me ann√©e, une API est apparue pour le d√©chargement des soldes d'entrep√¥t et de marchandises.  Les parties les plus pr√©cieuses du syst√®me sont devenues disponibles pour les utilisateurs via l'API - l'√©change de documents primaires et de donn√©es estim√©es sur les soldes et le co√ªt des marchandises. <br><br>  En d√©cembre 2015, RetailCRM a publi√© la premi√®re biblioth√®que tierce √† acc√©der √† notre API.  Ils ont commenc√© √† l'utiliser assez activement, alors que la popularit√© du service dans son ensemble augmentait, la charge sur l'API augmentait plus vite que la charge sur l'interface Web.  Une fois, la croissance s'est transform√©e en un saut de charge. <br><br><img src="https://habrastorage.org/webt/8h/1p/no/8h1pnokzk8grz6kcs3ok0b1txua.png" alt="Voici la chute du Black Hawk. Ou le r√¢teau que nous avons travers√©."><br><br><img src="https://habrastorage.org/webt/2n/ry/4h/2nry4hnfml6miv4axqp_cxrgthy.png" alt="La solution est simple - donnez √† chacun des ressources √©gales."><br><br>  Et ce saut, qui est indiqu√© par la fl√®che √† gauche, a conduit √† la stup√©faction totale du serveur desservant notre API.  Pendant une semaine, nous avons compris ce que g√©n√®re exactement cette charge.  Il s'est av√©r√© que ce sont les demandes m√™mes diffus√©es √† notre API depuis les fronts des clients.  Une cinquantaine de clients ont tout mang√©.  C'est alors que nous avons r√©alis√© l'une de nos erreurs - l'absence totale de limites. <br><br>  En cons√©quence, nous avons introduit une limite sur le nombre de demandes simultan√©es.  √Ä partir d'un compte, il est devenu possible d'ouvrir simultan√©ment pas plus de deux demandes.  Cela suffit pour travailler en mode r√©plication pour √©changer des donn√©es en mode batch.  Et ceux qui voulaient nous utiliser comme backend, √† partir de ce moment, ont √©t√© oblig√©s de se conformer davantage aux tarifs, car ils ont introduit des travaux sur plusieurs comptes dans leur logiciel. <br><br><h2>  Ranger </h2><br>  Depuis 2014, la demande pour l'API existante est devenue une partie importante de l'entreprise, et l'API elle-m√™me a g√©n√©r√© la plus grande quantit√© de donn√©es lors de l'√©change de donn√©es avec les clients.  En 2015, nous avons lanc√© un projet de nettoyage de l'API.  Nous avons choisi JSON au lieu de XML comme format et avons commenc√© √† le construire sur la base des fonctionnalit√©s r√©v√©l√©es lors de la mise en ≈ìuvre de la version pr√©c√©dente: <br><br><ol><li>  Capacit√© √† g√©rer les versions.  Le contr√¥le de version vous permet de d√©velopper une nouvelle version sans affecter une application existante et sans perturber les utilisateurs. </li><li>  La possibilit√© pour l'utilisateur de voir les m√©tadonn√©es dans la r√©ponse qu'il re√ßoit. </li><li>  La possibilit√© d'√©changer des documents volumineux.  Si nous traitons un document avec un nombre de positions sup√©rieur √† 4-5 000, cela devient un probl√®me pour le serveur: une longue transaction, une longue requ√™te http.  Nous avons construit un m√©canisme sp√©cial qui vous permet de mettre √† jour le document en plusieurs parties et de g√©rer les positions individuelles de ce document en les envoyant au serveur. </li><li>  Outils de r√©plication - √©taient dans la version pr√©c√©dente. </li><li>  Les limites de charge sont comme l'h√©ritage du r√¢teau qui a √©t√© utilis√© dans la version pr√©c√©dente.  Introduit des limites sur le nombre de demandes dans une p√©riode de temps, le nombre de demandes simultan√©es et les demandes d'une adresse IP. </li></ol><br>  √Ä partir de ce moment, nous avons publi√© deux versions mineures de l'API et lanc√© plusieurs API sp√©cialis√©es, mais en g√©n√©ral, l'approche est rest√©e inchang√©e.  Un format d'√©change mis √† jour et une nouvelle architecture ont permis de corriger beaucoup plus rapidement les lacunes de l'API. <br><br><h2>  API MyStore aujourd'hui </h2><br>  Aujourd'hui, l'API MyStore r√©sout de nombreux probl√®mes: <br><br><ul><li>  √©change de donn√©es avec les magasins en ligne, les syst√®mes comptables, les banques; </li><li>  recevoir des donn√©es de r√®glement, des rapports; </li><li>  utiliser comme backend pour les applications client - nos applications mobiles et nos caisses de bureau fonctionnent via l'API </li><li>  envoyer des notifications sur les modifications de donn√©es dans MyStore - webhooks; </li><li>  t√©l√©phonie; </li><li>  syst√®mes de fid√©lit√©. </li></ul><br>  Bas√© sur l'API, notre PDG <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">rhinoc√©ros</a> Askar Rakhimberdiev a √©crit en quatre heures un robot t√©l√©gramme qui tire le reste √† travers l'API: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/arahimberdiev/com-lognex-telegram-moysklad-stock</a> <br><br>  Maintenant des chiffres secs. <br><br>  Voici nos statistiques pour l'ancienne API REST: <br><br><ul><li>  400 entreprises; </li><li>  600 utilisateurs; </li><li>  2 millions de demandes par jour; </li><li>  200 Go / jour de trafic sortant. </li></ul><br>  Et voici √† quoi nous sommes arriv√©s avec toutes les API MyStore: <br><br><ul><li>  plus de 70 int√©grations (certaines d'entre elles peuvent √™tre trouv√©es ici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.moysklad.ru/integratsii</a> ); </li><li>  8500 entreprises; </li><li>  12 000 utilisateurs; </li><li>  46 millions de demandes par jour; </li><li>  2 To / jour de trafic sortant. </li></ul><br><h2>  Et ensuite </h2><br>  Les plans de d√©veloppement d'API sont en discussion active.  Nous essayons de prendre en compte l'exp√©rience d'exploitation que les utilisateurs nous fournissent.  Pas toujours et tout ne se fait pas tout de suite, mais pas loin se trouve une nouvelle version de l'API avec des m√©tadonn√©es plus pratiques et une structure moins lourde, OAuth pour l'authentification, une API pour les applications int√©gr√©es √† l'interface. <br><br>  Vous pouvez suivre l'actualit√© sur un site sp√©cial pour les d√©veloppeurs d'int√©gration avec MySklad: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dev.moysklad.ru</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453136/">https://habr.com/ru/post/fr453136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453120/index.html">Comment prot√©ger la 5G contre le piratage: explorer l'architecture de s√©curit√©</a></li>
<li><a href="../fr453122/index.html">Concours de programmation Kotlin Heroes</a></li>
<li><a href="../fr453126/index.html">UIAappearance n'√©tait pas si simple</a></li>
<li><a href="../fr453128/index.html">Telecom digest: 15 documents d'experts sur IPv6, SI, normes et l√©gislation en informatique</a></li>
<li><a href="../fr453130/index.html">Codes correctifs syst√©matiques. Code de groupe lin√©aire</a></li>
<li><a href="../fr453138/index.html">Art et science: projet VITAE - nombreuses empreintes de palmier sur une fleur de lune</a></li>
<li><a href="../fr453140/index.html">Qui vole le temps CPU virtuel?</a></li>
<li><a href="../fr453146/index.html">Comment tirer le meilleur parti d'une conf√©rence</a></li>
<li><a href="../fr453154/index.html">Histoire d'Internet: am√©liorer l'interactivit√©</a></li>
<li><a href="../fr453156/index.html">General Motors donnera une √¢me √† toutes ses nouvelles voitures (coque num√©rique)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>