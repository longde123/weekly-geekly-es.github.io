<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ù£Ô∏è üñïüèø üò∏ Wie f√ºge ich einen Index auf einem geladenen System rund um die Uhr ohne Ausfallzeiten hinzu? üßëüèø‚Äçü§ù‚Äçüßëüèº üóûÔ∏è üë©üèø‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Freunde, Ende Januar werden wir einen neuen Kurs namens "MS SQL Server Developer " starten. Im Vorgriff auf den Start haben wir die Kurslehrerin Krist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie f√ºge ich einen Index auf einem geladenen System rund um die Uhr ohne Ausfallzeiten hinzu?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/435582/">  <i>Freunde, Ende Januar werden wir einen neuen Kurs namens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"MS SQL Server Developer</a> " starten.</i>  <i>Im Vorgriff auf den Start haben wir die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kurslehrerin Kristina Kucherova gebeten</a> , einen Artikel des Autors vorzubereiten.</i>  <i>Dieser Artikel ist n√ºtzlich, wenn Sie eine sehr beliebte Tabelle auf Prod mit 24/7-Zugriff haben und pl√∂tzlich feststellen, dass Sie dringend einen Index hinzuf√ºgen m√ºssen, um dabei nichts zu besch√§digen.</i> <br><br>  Was tun?  Die traditionelle Methode CREATE INDEX WITH (ONLINE = ON) ist f√ºr Sie nicht geeignet, da sie beispielsweise einen Systemabsturz und einen Herzinfarkt Ihres DBA verursacht. Alle Spitzen √ºberwachen die Reaktionszeit Ihres Systems genau und kommen, wenn sie zunimmt, zu Ihnen und Ihrem DBA, um zu sprechen in Bezug auf die √ºbersch√§tzten Zahlen Ihrer Arbeitsentsch√§digung. <br><br>  Skripte und beschriebene Techniken wurden auf einem System mit einer Last von 400.000 Anforderungen pro Minute verwendet, Versionen von SQL Server 2012 und 2016 (Enterprise). <br><br>  Es gibt zwei sehr unterschiedliche Ans√§tze zum Erstellen eines Index, die je nach Gr√∂√üe der Tabelle verwendet werden. <br><br><h3>  Fall Nr. 1. Ein kleiner, aber sehr beliebter Tisch </h3><br>  Eine Tabelle mit 50.000 Datens√§tzen (klein), aber sehr beliebt (mehrere tausend Treffer pro Minute).  Sie ben√∂tigen einen neuen Index und minimale Ausfallzeiten und Sperren f√ºr die Tabelle. <br>  In der Anwendung erfolgt der gesamte Zugriff auf die Datenbank nur √ºber Prozeduren. <br><br>  Wenn ein Fehler auftritt, versucht die Anwendung erneut, auf die Tabelle zuzugreifen. <br><br><img src="https://habrastorage.org/webt/0b/7k/oj/0b7kojuvqjl6d_ty__et9g3wgiu.png"><br><a name="habracut"></a><br>  Was ist das Problem bei der einfachen Anwendung dieses Index?  Mit dem Satz WITH ONLINE = ON (ja, wir hatten Gl√ºck und dieser war Enterprise). <br><br>  Tatsache ist, dass es bei einem solchen aktiven Zugriff einige Zeit dauert, bis eine Sperre vorliegt (selbst die minimale, die mit der Option mit Online = EIN ben√∂tigt wird).  W√§hrend des Wartens werden neue Anforderungen in die Warteschlange gestellt, die Warteschlange sammelt sich, die CPU w√§chst, der DBA schwitzt und blinzelt nerv√∂s auf die Entwickler zu, w√§hrend in den Anwendungs√ºberwachungsdiagrammen Ihre Antwortzeit reibungslos, aber unvermeidlich zunimmt.  Ihr Vice President of Engeneering ist sehr daran interessiert, ob es aufgrund dieser Verl√§ngerung der Reaktionszeit zu Systemausf√§llen kommen wird, bei denen die Verf√ºgbarkeit der Anwendung zum Jahresende nicht auf 5 Neunen (99.999), sondern auf weniger gesch√§tzt wird.  Und dann hat das Unternehmen Vertr√§ge, Verpflichtungen und hohe Geldstrafen bei reduzierter Verf√ºgbarkeit, und nat√ºrlich werden wir Reputationsverluste nicht vergessen. <br><br>  Was haben wir getan, um diese ungl√ºckliche Situation zu vermeiden? <br>  Das System ben√∂tigt noch einen Index. <br>  Sie haben die Rechte von allen au√üer der aktuellen Sitzung auf diesem Tisch √ºbernommen. <br>  Wenden Sie den Index an. <br><br>  Ja, die L√∂sung hat ein Minus: Jeder, der sich in diesen Sekunden an den Tisch gewandt hat, erh√§lt Zugriff verweigert.  Wenn Ihre Anwendung normalerweise mit einer solchen Situation umgeht und die Abfrage an die Datenbank wiederholt, sollten Sie sich diese Option genauer ansehen.  Bei unserem Projekt hat diese Methode gut funktioniert.  Auch hier k√∂nnen Sie ONLINE = ON sicher entfernen, da wir wissen, dass nur die Sitzung w√§hrend der Indexerstellung Zugriff auf die Tabelle hat. <br><br>  Code zum Anwenden des Index: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">REVOKE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Users_Email_Status <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Users</span></span>] ([Email],[<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserCreate] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User1] <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[spUserLogin] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [User2]</code> </pre> <br>  Zeitplan f√ºr die Antwortzeit und den Prozentsatz der Fehler beim Testen unter Last. <br><br><img src="https://habrastorage.org/webt/h_/nd/ug/h_ndugyc0hybrm5-bps5pmxinuo.png" alt="Bild"><br><br>  Die Methode kann angewendet werden, wenn Sie wie im beschriebenen Fall eine kleine Tabelle haben und wissen, dass der Index ohne Laden in Sekunden (oder in einer f√ºr Sie akzeptablen Zeit) erstellt wird.  Gleichzeitig erh√∂ht sich, wie Sie in der obigen Grafik sehen k√∂nnen, die Antwortzeit der Anwendung nicht, obwohl ersichtlich ist, dass die Fehlerrate in Sekunden ohne Zugriff auf die Tabelle h√∂her war. <br><br><h3>  Fall Nr. 2. Gro√üer Tisch </h3><br>  Wenn Sie eine gro√üe Tabelle haben und die Indizes √§ndern m√ºssen, ist es oft am einfachsten, eine Tabelle mit dem richtigen Index daneben zu erstellen und die Daten schrittweise in eine neue Tabelle zu √ºbertragen. <br><br>  Es gibt zwei M√∂glichkeiten: <br><br><ol><li>  Wenn Sie eine spezielle Prozedur zum √Ñndern einer Tabelle haben, √§ndern Sie einfach den Prozedurcode so, dass neue Daten nur in die neue Tabelle eingef√ºgt werden, das L√∂schen von beiden erfolgt, die Aktualisierung auch auf beide angewendet wurde und die Auswahl aus zwei Tabellen mit UNION ALL getroffen wurde. </li><li>  Wenn Sie viele verschiedene Teile des Codes haben, in denen Sie die Daten in der Tabelle √§ndern k√∂nnen, gibt es zwei beliebte Tricks: Anzeigen mit Triggern oder Umschreiben aller Teile des Codes, um Daten in eine neue Tabelle einzuf√ºgen, L√∂schen aus beiden und Aktualisieren beider Tabellen.  Eine Ansicht mit Triggern ist eine Option, wenn Sie eine Ansicht mit zwei Tabellen erstellen und umbenennen, Ihre aktuelle Tabelle in TableOld umbenennen und in Tabelle anzeigen.  Dann erhalten Sie automatisch den gesamten Tabellenzugriff auf die Ansicht. Hier kann beim Umbenennen ebenfalls ein Problem auftreten, da SchemaLock ben√∂tigt wird, das Umbenennen jedoch sehr schnell erfolgt. </li></ol><br>  Eine etwas detailliertere Version zum Umschreiben von Aufrufen einer neuen Tabelle: <br><br><ol><li>  Sie haben die Orders-Tabelle, erstellen eine neue OrdersNew-Tabelle mit demselben Schema, aber mit dem gew√ºnschten Index.  Wenn Sie Indentity verwenden, m√ºssen Sie gleichzeitig den ersten Identit√§tswert in der neuen Tabelle so einstellen, dass er dem Maximalwert in der alten Tabelle + dem √Ñnderungsschritt oder der L√ºcke entspricht, die Sie sich leisten k√∂nnen, um vom Maximalwert in Bestellungen abzuweichen. </li><li>  Erstellen Sie eine OrdersView, in der eine Auswahl aus Orders UNION ALL OrdersNew </li><li>  √Ñndern Sie alle Prozeduren / Aufrufe, um Daten aus der Ansicht auszuw√§hlen, f√ºgen Sie sie in OrdersNew ein, l√∂schen und √§ndern Sie beide Tabellen. </li><li>  Migrieren Sie beispielsweise Daten von der alten Tabelle in die neue: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @rowcount <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, @batchsize <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> = <span class="hljs-number"><span class="hljs-number">4999</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @batchsize; WHILE @rowcount = @batchsize <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> TOP (@batchsize) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Orders <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> deleted.Id ,deleted.Column1 ,deleted.Column2 ,deleted.Column3 <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.OrdersNew (<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span> ,Column1 ,Column2 ,Column3); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rowcount = @@ROWCOUNT; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ERROR_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorNumber, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ErrorMessage; THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT dbo.OrdersNew <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre><br></li><li>  Setzen Sie alle Prozeduren vor der Migration auf die Version zur√ºck - mit einer Tabelle.  Dies kann durch √Ñndern oder durch L√∂schen und Erstellen von Prozeduren erfolgen (vergessen Sie dann nicht die Rechte), und Sie k√∂nnen die neue Tabelle in Bestellungen umbenennen, die leere Tabelle l√∂schen und anzeigen. </li></ol><br>  In Schritt 2 war es m√∂glich, die Haupttabelle Orders -&gt; OrdersOld und OrdersView -&gt; Orders - und die Ansicht selbst in OrdersOld UNION ALL OrdersNew umzubenennen, wenn das Laden dies zul√§sst. Dann m√ºssen Sie nicht alle Stellen √§ndern, an denen eine Auswahl aus der Tabelle vorhanden ist. <br><br>  Beim Verschieben von Bl√∂cken von einer Tabelle in eine andere werden die Daten fragmentiert. <br>  Wenn die zu √§ndernde Tabelle aktiv zum Lesen verwendet wird, sich die darin enthaltenen Daten jedoch selten √§ndern, k√∂nnen Sie erneut Trigger verwenden - eine Kopie aller √Ñnderungen in die 3. Tabelle schreiben - Daten aus der Tabelle √ºber bcp out und bcp in (oder Bulk Insert) in eine neue Tabelle √ºbertragen Erstellen Sie nach der Daten√ºbertragung Indizes und wenden Sie dann die √Ñnderungen aus der Tabelle mit dem √Ñnderungsprotokoll an - und wechseln Sie eine Tabelle in eine andere - die aktuelle, benennen Sie sie in TableOld um und die neue von TableNew in Table. <br><br>  Die Fehlerwahrscheinlichkeit ist in dieser Situation etwas h√∂her. Testen Sie daher in diesem Fall die Anwendung von √Ñnderungen und verschiedenen Schaltf√§llen. <br><br>  Die beschriebenen Optionen sind nicht die einzigen.  Sie wurden von mir in einer stark ausgelasteten SQL Server-Datenbank verwendet und verursachten w√§hrend der Anwendung keine Probleme, was unserem DBA-Team gefiel.  Ein solches Aufprallen ist normalerweise nicht f√ºr Basen mit einem ruhigeren Lademodus erforderlich, wenn Sie √Ñnderungen in den Stunden mit der geringsten Aktivit√§t sicher anwenden k√∂nnen.  Benutzer des Projekts, die die beschriebenen Ans√§tze verwendet haben, befinden sich in den USA und in Europa und verwenden die Anwendung an Wochentagen und Wochenenden aktiv. Die Tabellen, auf die die √Ñnderungen angewendet wurden, werden st√§ndig in der Arbeit verwendet.  Weitere "leisere" Objekte wurden normalerweise durch automatische Skripte ge√§ndert, die √ºber das Redgate Toolkit generiert wurden, nachdem die Skripte vom Entwickler und einem der Datenbankadministratoren √ºberpr√ºft wurden. <br><br>  <i>Gut zu allen!</i>  <i>Teilen Sie in den Kommentaren mit, ob Sie eine dieser Methoden verwendet oder Ihre Methode beschrieben haben!</i>  <i>Wir laden Sie auch zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einer offenen Lektion</a> und einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Tag der offenen T√ºr</a> unseres neuen Kurses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"MS SQL Server Developer" ein.</a></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de435582/">https://habr.com/ru/post/de435582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de435572/index.html">Anycubic i3 Mega: Qualit√§ts-Remake von Prusa i3</a></li>
<li><a href="../de435574/index.html">Wie funktioniert Zickzack?</a></li>
<li><a href="../de435576/index.html">1C, keine Schmerzen</a></li>
<li><a href="../de435578/index.html">Weltraumspaziergang zu Weihnachten</a></li>
<li><a href="../de435580/index.html">Java, Spring, Kurento und Media Services</a></li>
<li><a href="../de435584/index.html">Slush 2018. Erster Tag, Zweiter Tag</a></li>
<li><a href="../de435586/index.html">Die Kunst des Schamanismus oder der benutzerdefinierten Firmware f√ºr Olinuxino. Kernel und Ubuntu Teil 3</a></li>
<li><a href="../de435588/index.html">F√∂rderung einer mobilen Anwendung mit echter Erfahrung in Zahlen</a></li>
<li><a href="../de435590/index.html">Erneute Prognose, Teil 1</a></li>
<li><a href="../de435592/index.html">Azoren: letztes Pflanzenreservat mitten im Atlantik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>