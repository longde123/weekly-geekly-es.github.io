<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïì üßíüèª üñáÔ∏è C√≥mo comenzamos a registrar cajas registradoras para nuestros clientes üò∞ üë®üèø‚Äçüíº üë©üèº‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seg√∫n las enmiendas a 54-, desde julio de este a√±o, casi todas las empresas comerciales est√°n obligadas a utilizar cajas en l√≠nea que transmiten datos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo comenzamos a registrar cajas registradoras para nuestros clientes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/420033/">  Seg√∫n las enmiendas a 54-, desde julio de este a√±o, casi todas las empresas comerciales est√°n obligadas a utilizar cajas en l√≠nea que transmiten datos a trav√©s de Internet al servicio de impuestos.  Para adquirir dicho aparato, tendr√° que comprar una caja registradora y una unidad fiscal, firmar un acuerdo y pagar los servicios de un operador de datos fiscales, registrarse en dos oficinas personales del Servicio de Impuestos Federales y OFD, ingresar los detalles en el cajero y recibir un informe de registro en papel.  Bueno, tambi√©n necesitar√° una firma digital electr√≥nica, de lo contrario tendr√° que acudir al Servicio de Impuestos Federales y hacer cola personalmente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/fb3/9b6/3a9fb39b680344c3f892804eb41b1a11.png"><br><br>  Decidimos salvar a nuestros clientes de todo este horror haciendo un servicio que registra todo autom√°ticamente casi con un solo clic.  Hablaremos de esto ahora. <br><a name="habracut"></a><br><h2>  ¬øPor qu√© lo necesitamos? </h2><br>  Ya te diste cuenta de que registrar una taquilla es una tediosa b√∫squeda de varias etapas, pero este no es el √∫nico problema.  En cada etapa, el zool√≥gico est√° esperando interfaces, cuyas formas deber√°n completarse manualmente con los datos de registro para cada taquilla, as√≠ como un conjunto completo de errores relevantes (saludos separados a los requisitos de impuestos para usar los navegadores IE, Yandex.Browser o Sputnik).  Cientos de oportunidades para cometer un error, arruinar el procedimiento y comenzar de nuevo.  Y si configura 5-10 cajas registradoras, la posibilidad de un error al ingresar los mismos detalles aumenta a veces.  Sin mencionar la p√©rdida de tiempo improductiva y descubrir por qu√© la oficina de impuestos personales se niega a aceptar el token, que fue "tragado" perfectamente ayer. <br><br><img src="https://habrastorage.org/webt/cz/bk/qn/czbkqnhvog24qqgwodhckwfyhew.png"><br><br>  Y cuando sentimos la peor parte de la tragedia anterior, decidimos retomar el desarrollo. <br><br><h2>  Pasos de registro </h2><br>  Varias partes participan en el registro de una caja registradora a la vez.  Este es el servicio de impuestos (FTS), OFD: el operador de datos fiscales a trav√©s del cual las cajas registradoras interact√∫an con la autoridad tributaria, un centro de certificaci√≥n que emite firmas electr√≥nicas y, por regla general, un peque√±o empresario desconcertado perdido en trastornos burocr√°ticos.  Quer√≠amos intervenir en su relaci√≥n, tanto como para enfrentarnos a todas las dificultades. <br><br>  Condicionalmente, el procedimiento se divide en dos etapas: <br><br>  Registro en la caja: los datos de un dispositivo en particular se env√≠an al Servicio de Impuestos Federales, y el n√∫mero de registro aparece en respuesta. <br><br>  Fiscalizaci√≥n: activaci√≥n del cajero utilizando el n√∫mero de registro del veh√≠culo asignado por el Servicio de Impuestos Federales. <br><br>  En primer lugar, fuimos a nuestros socios para trabajar en la primera etapa con ellos. <br><br><h2>  API para el Servicio de Impuestos Federales </h2><br>  No fuimos los primeros en pensar en la automatizaci√≥n del registro.  Muchos dijeron que estaban haciendo algo en esta √°rea, que el desarrollo estaba en marcha, pero nadie ten√≠a una interfaz externa lista para usar.  La API proporcion√≥ uno de los operadores de datos fiscales, casi listo para interactuar con el impuesto. <br><br>  En ese momento, solo se enviaron alrededor de 80 aplicaciones de prueba utilizando el protocolo.  Cre√≠amos que pronto la interfaz funcionar√≠a a plena capacidad, y comenzamos la implementaci√≥n y las pruebas en los "stubs". <br><br>  Al ir al producto, nos dimos cuenta de que nuestras pruebas y la aplicaci√≥n real son diferentes, como el d√≠a y la noche.  Los "talones" que recibimos de la OFD incluyeron solo simulacros de √©xito y reprodujeron un gui√≥n exitoso.  De hecho, lograr ese "√©xito" no fue f√°cil. <br><br>  Los resultados incluyeron: solicitudes del lado de socios que no fueron procesadas durante varios d√≠as, falta de comentarios del Servicio Federal de Impuestos y OFD, errores de firma y nuestro "error desconocido" favorito.  El protocolo FTS result√≥ estar pobremente documentado y, a menudo, respondi√≥ con fallas no especificadas, por lo que no est√° claro qu√© los caus√≥.  A√∫n no existe una especificaci√≥n clara.  Entonces, la primera vez que probamos el protocolo y, junto con la OFD, tomamos decisiones sobre c√≥mo responder a ciertas respuestas del Servicio Federal de Impuestos en casos espec√≠ficos. <br><br><h2>  API de cajero </h2><br>  Si bien parte del equipo estudi√≥ el comportamiento de los sistemas del Servicio Federal de Impuestos en la pr√°ctica, el trabajo no se detuvo.  Paralelamente, organizamos negociaciones con los fabricantes de cajas registradoras, los invitamos a intercambiar datos de nosotros a su plataforma, de la plataforma a la caja registradora y en el orden inverso para establecer la fiscalizaci√≥n autom√°tica de las cajas registradoras. <br><br>  Seleccionamos un par de soluciones universales de una pieza.  Las cajas registradoras Evotor con pantallas t√°ctiles y DreamCas son para aquellos clientes que est√°n acostumbrados a los viejos botones y consideran que la funcionalidad adicional es redundante.  Los modelos son diferentes: con y sin esc√°ner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/r7/dc/ror7dcretvhsilz3yiw12judrxi.png"></div><br>  Si la OFD ten√≠a su propia API lista, entonces para los contratistas de la caja registradora ten√≠a que desarrollarse desde cero.  De lo contrario, es imposible hacer que todos los datos de registro lleguen a la caja registradora autom√°ticamente, sin entrada manual. <br><br>  Los colegas lograron establecer una interacci√≥n a trav√©s de su plataforma y pronto estuvieron listos: una API para abrir la cuenta personal de un cliente y un protocolo patentado para administrar una caja registradora. <br><br><img src="https://habrastorage.org/webt/wy/5h/hr/wy5hhrv-agl7qmya0x9pnpbppde.png"><br><br>  Nuestros proveedores fueron los primeros en configurar el env√≠o autom√°tico de informaci√≥n de registro a la taquilla.  Y pronto, la API har√° que sea tan f√°cil cancelar el registro y volver a registrar las cajas registradoras. <br><br>  Ahora, cuando estamos negociando con otros proveedores de efectivo, es precisamente el soporte de esta interfaz lo que se convierte en uno de los requisitos clave. <br><br><h2>  Anatom√≠a del registro autom√°tico </h2><br>  Despu√©s de que aprendimos c√≥mo trabajar con el Servicio de Impuestos Federales e implementamos API con proveedores para transferir datos de registro al cajero, lleg√≥ el momento de conectar todo esto en un solo sistema y establecer un procedimiento de registro. <br><br>  Esta es la tarea de elegir la arquitectura correcta, que nos permitir√≠a controlar el registro as√≠ncrono de las cajas registradoras en la OFD, tanto con el Servicio de Impuestos Federales como con el vendedor.  Dado que responden a las solicitudes con retraso, el proceso lleva mucho tiempo y tiene una gran cantidad de integraciones con sistemas externos.  Debido a esto, tuvimos que escribir dos aplicaciones en Java. <br><br>  El servicio de trabajo se comunica directamente con CRF y los sistemas de fabricantes de cajas registradoras.  Por ejemplo, enviamos datos de clientes a la OFD y esperamos recibir un n√∫mero de registro en respuesta. <br><br>  El servicio de trabajo sondea el estado del trabajo a intervalos espec√≠ficos.  √âl pregunta de nuevo y pregunta de nuevo hasta que el resultado regrese.  Se guarda el n√∫mero de registro, Job transfiere la solicitud a la siguiente etapa y comienza la fiscalizaci√≥n. <br><br>  Si al principio monitoreamos cuidadosamente el paso de las aplicaciones y estudiamos manualmente cada error que dio el sistema, ahora el proceso est√° automatizado. <br><br>  Determinamos de inmediato la causa del error.  Y en caso de problemas masivos, se han establecido sistemas de monitoreo que registran anomal√≠as que indican fallas importantes en el Servicio de Impuestos Federales o OFD.  Sin embargo, el cliente se entera de los problemas en el √∫nico caso: si, en respuesta a una solicitud, recibimos un rechazo espec√≠fico, una negativa razonada para registrarse. <br><br>  La segunda aplicaci√≥n, CashReg, es un sistema de procesamiento donde se mantiene un modelo de estado, presentado en forma relacional. <br><br>  Fue desarrollado en base a las API proporcionadas por los proveedores y el CRF, e incluy√≥ todas las transiciones posibles para cada clase que participa en el proceso de registro.  El modelo de estado evita errores internos y elimina las desviaciones del algoritmo de procesamiento de aplicaciones est√°ndar. <br><br>  Entonces, si la aplicaci√≥n ha estado en el mismo estado durante demasiado tiempo, por ejemplo, no recibe el n√∫mero de registro durante varias horas, o el CRF responde con una etapa o estado incorrecto de la aplicaci√≥n, CashReg informar√° un error. <br><br>  Por supuesto, se necesitaba un administrador para administrar el procedimiento.  Un grupo de apoyo de decisi√≥n comercial trabaja con √©l, sirviendo y acompa√±ando las cajas registradoras durante el registro.  Ahora solo dos empleados est√°n involucrados en esto, pero su interfaz de trabajo no es complicada y el proceso de preparaci√≥n de caja, gracias al rechazo de la entrada manual de datos, es simple.  Por lo tanto, podemos escalar r√°pida y f√°cilmente el departamento. <br><br>  Los tres componentes del sistema de registro no implican altas cargas, ya que se implementan en entornos virtuales. <br><br><h2>  ¬øC√≥mo se procesa la solicitud? </h2><br>  Todo esto fue necesario para que el cliente, dejando una solicitud en su cuenta personal, unos d√≠as despu√©s pusiera la caja activa lista para trabajar detr√°s del mostrador. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f14/777/abe/f14777abe2e59529a31a321dcfbe01ca.png"></div><br>  Desde el punto de vista de la cocina dom√©stica, la magia del auto registro parece un poco m√°s complicada.  Al dejar la aplicaci√≥n en su cuenta personal, el cliente nos da su consentimiento legal para emitir una firma electr√≥nica y realizar todo el procedimiento en su nombre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/36e/5ef/ccb/36e5efccba0427be9fef8324a50323c3.png"></div><br>  La informaci√≥n sobre la empresa, los datos de registro de una tienda en particular y el firmante (por ejemplo, para el director general) se extraen de las bases bancarias.  Se actualizan en SPARK, pasan por la puntuaci√≥n e ingresan al sistema maestro en la taquilla. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/749/b78/ae4749b7824fe74ebc8ddefb2d952955.png"></div><br>  Luego se forma una aplicaci√≥n en CASHREG.  Se muestra como una nueva tarea en el panel de administraci√≥n de un empleado del grupo de soporte de soluciones comerciales.  √âl ve qu√© caja registradora e impulso fiscal necesita el cliente.  El empleado encuentra el dispositivo necesario en el almac√©n, selecciona la unidad fiscal, codifica sus c√≥digos de barras con sus n√∫meros de serie y confirma la solicitud.  Por lo tanto, se le asignan dispositivos espec√≠ficos, que se entregar√°n al cliente.  En este punto, la OFD recibe una solicitud: "Formule una solicitud para el registro de tal y tal caja, para tal y tal empresa". <br><br>  El archivo enviado por la OFD en respuesta se autentica mediante firma electr√≥nica y, utilizando la API OFD, se env√≠a a las autoridades fiscales.  All√≠, a la caja se le asigna un n√∫mero de registro. <br><br>  Ahora el paquete completo de documentos en la caja llega al fabricante de la caja registradora (s√≠, tambi√©n est√°n involucrados aqu√≠).  Al mismo tiempo, aparece una tarea en el panel de administraci√≥n: fiscalizar al mismo cajero.  Esto significa que el empleado simplemente incluye al cajero.  El sistema del proveedor "ve" que el dispositivo est√° en contacto y carga autom√°ticamente todos los datos de registro necesarios en su memoria.  Se excluyen los errores con la entrada manual, los mismos detalles van al Servicio de Impuestos Federales y al cajero. <br><br>  El cajero imprime un informe de registro, algo para lo cual se inici√≥ todo.  Los datos fiscales del informe: fecha de impresi√≥n, firma, signo fiscal, sirven como confirmaci√≥n de que la caja est√° lista para trabajar.  Estos detalles se env√≠an nuevamente a la OFD. <br><br>  Inmediatamente despu√©s de que la OFD genera un informe de registro, lo firmamos para el cliente y la taquilla se va con el servicio de mensajer√≠a. <br><br><img src="https://habrastorage.org/webt/dc/cs/et/dccsetgp8qnjvcijl84ra3n6vu0.png"><br><br>  OFD a√∫n no ha preparado una tarjeta de registro, pero no puede esperar.  Estar√° disponible en forma electr√≥nica en la cuenta personal del cliente en dos o tres d√≠as. <br><br><h2>  Conclusi√≥n </h2><br>  Para implementar este proyecto, unos veinte empleados de todo el banco y muchos m√°s especialistas de nuestros socios, DFD y vendedores en efectivo se distrajeron de sus tareas habituales, pero sus esfuerzos no fueron en vano. <br><br>  El tiempo promedio para obtener un n√∫mero de registro, con la excepci√≥n de los casos m√°s negativos, es de tres horas.  En general, todo el procedimiento dura de 5 a 6 horas.  El 90% de los registros tienen √©xito.  Por el momento, ya se han procesado unas 1000 solicitudes. <br><br>  En general, como comprende, en nuestra empresa nos encantan estos casos, que pueden simplificar enormemente la vida de una gran cantidad de personas.  Al resolver estos problemas, siente que est√° haciendo algo realmente √∫til. <br><br>  PD: si est√° interesado, puede leer c√≥mo nosotros mismos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lavamos nuestro cajero autom√°tico</a> .  Adem√°s, junto con los protocolos de intercambio de datos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420033/">https://habr.com/ru/post/es420033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420021/index.html">¬øPor qu√© necesitas Splunk? Internet de las cosas y datos industriales</a></li>
<li><a href="../es420023/index.html">Guardar estados en aplicaciones de Android</a></li>
<li><a href="../es420025/index.html">Granja inteligente ¬øC√≥mo ser√° ella?</a></li>
<li><a href="../es420029/index.html">C√≥mo en 1C: Enterprise resolvemos sistemas de ecuaciones algebraicas</a></li>
<li><a href="../es420031/index.html">Dibujar con objetivos de renderizado en Unreal Engine</a></li>
<li><a href="../es420035/index.html">Golang GUI: GTK + 3</a></li>
<li><a href="../es420037/index.html">Transmita con varias c√°maras de materiales improvisados</a></li>
<li><a href="../es420039/index.html">Pensamiento funcional Parte 2</a></li>
<li><a href="../es420041/index.html">TypeScript War o Enum Conquest</a></li>
<li><a href="../es420045/index.html">Bunker para la fecha: c√≥mo se me permiti√≥ caminar por el centro de datos RUVDS en el territorio de la planta espacial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>