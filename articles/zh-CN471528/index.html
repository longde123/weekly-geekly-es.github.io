<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¾ğŸ¼ ğŸ‘¨ğŸ½â€ğŸŒ¾ ğŸ––ğŸ¾ ä½¿ç”¨docker swarméƒ¨ç½²åº”ç”¨ ğŸ’  ğŸ‘©ğŸ¿â€ğŸ’¼ ğŸš¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„åœ¨çº¿è§†é¢‘å†…å®¹æ¨èç³»ç»Ÿæ˜¯ä¸€ä¸ªå°é—­çš„å•†ä¸šå¼€å‘ï¼Œä»æŠ€æœ¯ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªç”±å…¶è‡ªå·±çš„ç»„ä»¶å’Œå¼€æºç»„ä»¶ç»„æˆçš„å¤šç»„ä»¶é›†ç¾¤ã€‚ æœ¬æ–‡çš„ç›®çš„æ˜¯æè¿°åœ¨ç™»å°å¹³å°ä¸‹å¼•å…¥docker swarmé›†ç¾¤ç³»ç»Ÿçš„è¿‡ç¨‹ï¼Œè€Œä¸ä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…ä¸­æ–­æˆ‘ä»¬æµç¨‹çš„ç°æœ‰å·¥ä½œæµç¨‹ã€‚ æè¯·æ‚¨æ³¨æ„çš„å™è¿°åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚ ç¬¬ä¸€éƒ¨åˆ†æè¿°ä½¿ç”¨docker ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨docker swarméƒ¨ç½²åº”ç”¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471528/"> æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„åœ¨çº¿è§†é¢‘å†…å®¹æ¨èç³»ç»Ÿæ˜¯ä¸€ä¸ªå°é—­çš„å•†ä¸šå¼€å‘ï¼Œä»æŠ€æœ¯ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªç”±å…¶è‡ªå·±çš„ç»„ä»¶å’Œå¼€æºç»„ä»¶ç»„æˆçš„å¤šç»„ä»¶é›†ç¾¤ã€‚ æœ¬æ–‡çš„ç›®çš„æ˜¯æè¿°åœ¨ç™»å°å¹³å°ä¸‹å¼•å…¥docker swarmé›†ç¾¤ç³»ç»Ÿçš„è¿‡ç¨‹ï¼Œè€Œä¸ä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…ä¸­æ–­æˆ‘ä»¬æµç¨‹çš„ç°æœ‰å·¥ä½œæµç¨‹ã€‚ æè¯·æ‚¨æ³¨æ„çš„å™è¿°åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚ ç¬¬ä¸€éƒ¨åˆ†æè¿°ä½¿ç”¨docker swarmä¹‹å‰çš„CI / CDï¼Œç¬¬äºŒéƒ¨åˆ†æè¿°å®ç°è¿‡ç¨‹ã€‚ é‚£äº›å¯¹é˜…è¯»ç¬¬ä¸€éƒ¨åˆ†ä¸æ„Ÿå…´è¶£çš„äººå¯ä»¥å®‰å…¨åœ°è½¬åˆ°ç¬¬äºŒéƒ¨åˆ†ã€‚ <br><a name="habracut"></a><br><h3> ç¬¬ä¸€éƒ¨åˆ† </h3><br> åœ¨é¥è¿œçš„ä¸€å¹´ä¸­ï¼Œéœ€è¦å°½å¿«é…ç½®CI / CDæµç¨‹ã€‚ å…¶ä¸­ä¸€ä¸ªæ¡ä»¶æ˜¯ä¸ä½¿ç”¨Docker <i>éƒ¨ç½²</i>å¼€å‘çš„ç»„ä»¶ï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š <br><br><ul><li> ä½¿ç”Ÿäº§ä¸­çš„ç»„ä»¶æ›´å¯é ï¼Œæ›´ç¨³å®šåœ°è¿è¡Œï¼ˆå³å®é™…ä¸Šè¦æ±‚ä¸ä½¿ç”¨è™šæ‹ŸåŒ–ï¼‰ </li><li> é¢†å…ˆçš„å¼€å‘äººå‘˜ä¸æƒ³ä½¿ç”¨Dockerï¼ˆå¾ˆå¥‡æ€ªï¼Œä½†è¿™ä»…ä»…æ˜¯é‚£æ ·ï¼‰ </li><li> ç”±äºæ„è¯†å½¢æ€åŸå› ï¼Œç ”å‘ç®¡ç† </li></ul><br>  MVPçš„åŸºç¡€ç»“æ„ï¼Œå †æ ˆå’Œç¤ºä¾‹åˆå§‹è¦æ±‚å¦‚ä¸‹ï¼š <br><br><ul><li>  4å°å¸¦Debiançš„IntelÂ®X5650æœåŠ¡å™¨ï¼ˆä¸€å°åŠŸèƒ½å¼ºå¤§çš„æœºå™¨å®Œå…¨å¯ä»¥å¼€å‘ï¼‰ </li><li> è‡ªå®šä¹‰ç»„ä»¶çš„å¼€å‘åœ¨C ++ï¼ŒPython3ä¸­è¿›è¡Œ </li><li>  3rdpartyä½¿ç”¨çš„ä¸»è¦å·¥å…·ï¼šKafkaï¼ŒClickhouseï¼ŒAirflowï¼ŒRedisï¼ŒGrafanaï¼ŒPostgresqlï¼ŒMysqlï¼Œ... </li><li> åˆ†åˆ«ç®¡é“ç»„è£…å’Œæµ‹è¯•ç»„ä»¶ä»¥è¿›è¡Œè°ƒè¯•å’Œå‘å¸ƒ </li></ul><br> åœ¨åˆå§‹é˜¶æ®µè¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•åœ¨ä»»ä½•ç¯å¢ƒï¼ˆCI / CDï¼‰ä¸­éƒ¨ç½²è‡ªå®šä¹‰ç»„ä»¶ã€‚ <br><br> ç¬¬ä¸‰æ–¹ç»„ä»¶å†³å®šç³»ç»Ÿå®‰è£…å¹¶è¿›è¡Œç³»ç»Ÿæ›´æ–°ã€‚ ç”¨C ++æˆ–Pythonå¼€å‘çš„è‡ªå®šä¹‰åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚ å…¶ä¸­ï¼Œä¾‹å¦‚ï¼šåˆ›å»ºç³»ç»Ÿè½¯ä»¶åŒ…ï¼Œå°†å…¶å‘é€åˆ°æ”¶é›†çš„æ˜ åƒçš„å­˜å‚¨åº“ä¸­ï¼Œç„¶åå°†å…¶éšåå®‰è£…åœ¨æœåŠ¡å™¨ä¸Šã€‚ ç”±äºæœªçŸ¥çš„åŸå› ï¼Œé€‰æ‹©äº†å¦ä¸€ç§æ–¹æ³•ï¼Œå³ä½¿ç”¨CIï¼Œç¼–è¯‘å¯æ‰§è¡Œçš„åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼Œåˆ›å»ºè™šæ‹Ÿé¡¹ç›®ç¯å¢ƒï¼Œå®‰è£…æ¥è‡ªrequirements.txtçš„py-moduleså¹¶å°†æ‰€æœ‰è¿™äº›å·¥ä»¶ä¸é…ç½®ï¼Œè„šæœ¬å’Œéšé™„çš„åº”ç”¨ç¨‹åºç¯å¢ƒä¸€èµ·å‘é€åˆ°æœåŠ¡å™¨ã€‚ æ¥ä¸‹æ¥ï¼Œä»æ²¡æœ‰ç®¡ç†å‘˜æƒé™çš„è™šæ‹Ÿç”¨æˆ·å¯åŠ¨åº”ç”¨ç¨‹åºã€‚ <br><br>  Gitlab-CIè¢«é€‰ä¸ºCI / CDç³»ç»Ÿã€‚ äº§ç”Ÿçš„ç®¡é“å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/460/406/c27/460406c27d873dc28928ac3ba901f903.png" alt="å›¾ç‰‡"><br><div class="spoiler">  <b class="spoiler_title">åœ¨ç»“æ„ä¸Šï¼Œgitlab-ci.ymlçœ‹èµ·æ¥åƒè¿™æ ·</b> <div class="spoiler_text"><pre><code class="xml hljs">--- variables: #     ,    CMAKE_CPUTYPE: "westmere" DEBIAN: "MYREGISTRY:5000/debian:latest" before_script: - eval $(ssh-agent -s) - ssh-add <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">(echo</span></span></span><span class="hljs-tag"> "$</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SSH_PRIVATE_KEY</span></span></span><span class="hljs-tag">") </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mkdir</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-p</span></span></span><span class="hljs-tag"> ~/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.ssh</span></span></span><span class="hljs-tag"> &amp;&amp; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">echo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-e</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Host</span></span></span><span class="hljs-tag"> *\</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span><span class="hljs-tag">\</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tStrictHostKeyChecking</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">no</span></span></span><span class="hljs-tag">\</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span><span class="hljs-tag">\</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">n</span></span></span><span class="hljs-tag">" &gt;</span></span> ~/.ssh/config stages: - build - testing - deploy debug.debian: stage: build image: $DEBIAN script: - cd builds/release &amp;&amp; ./build.sh paths: - bin/ - builds/release/bin/ when: always release.debian: stage: build image: $DEBIAN script: - cd builds/release &amp;&amp; ./build.sh paths: - bin/ - builds/release/bin/ when: always ## testing stage tests.codestyle: stage: testing image: $DEBIAN dependencies: - release.debian script: - /bin/bash run_tests.sh -t codestyle -b "${CI_COMMIT_REF_NAME}_codestyle" tests.debug.debian: stage: testing image: $DEBIAN dependencies: - debug.debian script: - /bin/bash run_tests.sh -e codestyle/test_pylint.py -b "${CI_COMMIT_REF_NAME}_debian_debug" artifacts: paths: - run_tests/username/ when: always expire_in: 1 week tests.release.debian: stage: testing image: $DEBIAN dependencies: - release.debian script: - /bin/bash run_tests.sh -e codestyle/test_pylint.py -b "${CI_COMMIT_REF_NAME}_debian_release" artifacts: paths: - run_tests/username/ when: always expire_in: 1 week ## staging stage deploy_staging: stage: deploy environment: staging image: $DEBIAN dependencies: - release.debian script: - cd scripts/deploy/ &amp;&amp; python3 createconfig.py -s $CI_ENVIRONMENT_NAME &amp;&amp; /bin/bash install_venv.sh -d -r ../../requirements.txt &amp;&amp; python3 prepare_init.d.py &amp;&amp; python3 deploy.py -s $CI_ENVIRONMENT_NAME when: manual</code> </pre> <br></div></div><br> å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç»„è£…å’Œæµ‹è¯•æ˜¯åœ¨å…¶è‡ªå·±çš„æ˜ åƒä¸Šå®Œæˆçš„ï¼Œåœ¨è¯¥æ˜ åƒä¸Šå·²ç»å®‰è£…äº†æ‰€æœ‰å¿…éœ€çš„ç³»ç»Ÿè½¯ä»¶åŒ…å¹¶è¿›è¡Œäº†å…¶ä»–è®¾ç½®ã€‚ <br><br> å°½ç®¡å·¥ä½œä¸­çš„æ¯ä¸ªè„šæœ¬éƒ½ä»¥å…¶è‡ªå·±çš„æ–¹å¼å¾ˆæœ‰è¶£ï¼Œä½†æ˜¯<s>æˆ‘å½“ç„¶ä¸ä¼šè°ˆè®ºå®ƒä»¬</s> ï¼Œä½†æ˜¯å¯¹æ¯ä¸ªè„šæœ¬çš„æè¿°å°†èŠ±è´¹å¤§é‡æ—¶é—´ï¼Œè€Œè¿™å¹¶ä¸æ˜¯æœ¬æ–‡çš„ç›®çš„ã€‚ æˆ‘å°†ä»…æ³¨æ„ä»¥ä¸‹äº‹å®ï¼šéƒ¨ç½²é˜¶æ®µåŒ…æ‹¬ä¸€ç³»åˆ—è„šæœ¬è°ƒç”¨ï¼š <br><br><ol><li>  <b>createconfig.py-</b>ä½¿ç”¨ä¸åŒç¯å¢ƒä¸­çš„ç»„ä»¶è®¾ç½®åˆ›å»ºsettings.iniæ–‡ä»¶ï¼Œä»¥ç”¨äºåç»­éƒ¨ç½²ï¼ˆé¢„ç”Ÿäº§ï¼Œç”Ÿäº§ï¼Œæµ‹è¯•ç­‰ï¼‰ </li><li>  <b>install_venv.sh-</b>åœ¨ç‰¹å®šç›®å½•ä¸­ä¸ºpyç»„ä»¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å°†å…¶å¤åˆ¶åˆ°è¿œç¨‹æœåŠ¡å™¨ </li><li>  <b>prepare_init.d.py-</b>æ ¹æ®æ¨¡æ¿å‡†å¤‡ç»„ä»¶çš„èµ·æ­¢è„šæœ¬ </li><li>  <b>deploy.py-è§£å‹ç¼©</b>å¹¶é‡æ–°å¯åŠ¨æ–°ç»„ä»¶ </li></ol><br> æ—¶é—´è¿‡å»äº†ã€‚ è¿‡æ¸¡é˜¶æ®µå·²è¢«é¢„ç”Ÿäº§å’Œç”Ÿäº§æ‰€å–ä»£ã€‚ äº§å“æ”¯æŒå·²æ·»åŠ åˆ°å¦ä¸€ä¸ªåˆ†å‘å·¥å…·åŒ…ï¼ˆCentOSï¼‰ã€‚ æ·»åŠ äº†5ä¸ªåŠŸèƒ½æ›´å¼ºå¤§çš„ç‰©ç†æœåŠ¡å™¨å’Œ12ä¸ªè™šæ‹ŸæœåŠ¡å™¨ã€‚ å¯¹äºå¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜æ¥è¯´ï¼Œåœ¨æˆ–å¤šæˆ–å°‘æ¥è¿‘å·¥ä½œçŠ¶æ€çš„ç¯å¢ƒä¸­è¿è¡Œä»»åŠ¡å˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚ è¿™æ—¶ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ²¡æœ‰ä»–å°±æ— æ³•åš... <br><br><h3> ç¬¬äºŒéƒ¨åˆ† </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/f0e/673/166/f0e67316667fed0c0d673653419e8b8a.png" alt="å›¾ç‰‡"><br><br> å› æ­¤ï¼Œæˆ‘ä»¬çš„é›†ç¾¤<s>ä»ç„¶æ˜¯</s>ç”±Dockerfilesæœªæè¿°çš„æ•°åä¸ªç‹¬ç«‹ç»„ä»¶ç»„æˆ<s>çš„</s>ç³»ç»Ÿçš„å¥‡è§‚ã€‚ æ‚¨åªèƒ½å°†å…¶é…ç½®ä¸ºä»…æ•´ä½“éƒ¨ç½²åˆ°ç‰¹å®šç¯å¢ƒã€‚ æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯åœ¨é¢„å‘å¸ƒæµ‹è¯•ä¹‹å‰å°†é›†ç¾¤éƒ¨ç½²åˆ°æš‚å­˜ç¯å¢ƒä¸­ä»¥è¿è¡Œå®ƒã€‚ <br><br> ä»ç†è®ºä¸Šè®²ï¼Œå¯ä»¥æœ‰å¤šä¸ªåŒæ—¶å·¥ä½œçš„é›†ç¾¤ï¼šå¤„äºå®ŒæˆçŠ¶æ€æˆ–æ¥è¿‘å®ŒæˆçŠ¶æ€çš„ä»»åŠ¡æ•°é‡ä¹‹å¤šã€‚ æœåŠ¡å™¨å¯ç”¨çš„å®¹é‡ä½¿æˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªé›†ç¾¤ã€‚ æ¯ä¸ªæš‚å­˜ç¾¤é›†å¿…é¡»éš”ç¦»ï¼ˆç«¯å£ï¼Œç›®å½•ç­‰ä¸Šä¸åº”æœ‰äº¤å‰ç‚¹ï¼‰ã€‚ <br><br> æœ€å®è´µçš„èµ„æºæ˜¯æˆ‘ä»¬çš„æ—¶é—´ï¼Œè€Œæˆ‘ä»¬å´æ²¡æœ‰å¤ªå¤šã€‚ <br><br> ä¸ºäº†å¿«é€Ÿèµ·æ­¥ï¼Œä»–ä»¬é€‰æ‹©äº†Docker Swarmï¼Œå› ä¸ºå®ƒå…·æœ‰ç®€å•æ€§å’Œæ¶æ„çµæ´»æ€§ã€‚ æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åœ¨è¿œç¨‹ç®¡ç†å™¨æœåŠ¡å™¨å’Œå‡ ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºï¼š <br><br><pre> <code class="bash hljs">$ docker node ls ID HOSTNAME STATUS AVAILABILITY MANAGER STATUS ENGINE VERSION kilqc94pi2upzvabttikrfr5d nop-test-1 Ready Active 19.03.2 jilwe56pl2zvabupryuosdj78 nop-test-2 Ready Active 19.03.2 j5a4yz1kr2xke6b1ohoqlnbq5 * nop-test-3 Ready Active Leader 19.03.2</code> </pre><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç½‘ç»œï¼š <br><br><pre> <code class="bash hljs">$ docker network create --driver overlay --subnet 10.10.10.0/24 nw_swarm</code> </pre><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ ¹æ®CIèŠ‚ç‚¹çš„è¿œç¨‹ç®¡ç†è¿æ¥äº†Gitlab-CIå’ŒSwarmèŠ‚ç‚¹ï¼šå®‰è£…è¯ä¹¦ï¼Œè®¾ç½®ç§˜å¯†å˜é‡ä»¥åŠåœ¨ç®¡ç†æœåŠ¡å™¨ä¸Šè®¾ç½®DockeræœåŠ¡ã€‚ è¿™ç¯‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« ä¸º</a>æˆ‘ä»¬èŠ‚çœäº†å¾ˆå¤šæ—¶é—´ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨.gitlab-ci .ymlä¸­æ·»åŠ äº†ç”¨äºåˆ›å»ºå’Œé”€æ¯å †æ ˆçš„ä½œä¸šã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">.gitlab-ci .ymlä¸­æ·»åŠ äº†ä¸€äº›å·¥ä½œ</b> <div class="spoiler_text"><pre> <code class="xml hljs">## staging stage deploy_staging: stage: testing before_script: - echo "override global 'before_script'" image: "REGISTRY:5000/docker:latest" environment: staging dependencies: [] variables: DOCKER_CERT_PATH: "/certs" DOCKER_HOST: tcp://10.50.173.107:2376 DOCKER_TLS_VERIFY: 1 CI_BIN_DEPENDENCIES_JOB: "release.centos.7" script: - mkdir -p $DOCKER_CERT_PATH - echo "$TLSCACERT" &gt; $DOCKER_CERT_PATH/ca.pem - echo "$TLSCERT" &gt; $DOCKER_CERT_PATH/cert.pem - echo "$TLSKEY" &gt; $DOCKER_CERT_PATH/key.pem - docker stack deploy -c docker-compose.yml ${CI_ENVIRONMENT_NAME}_${CI_COMMIT_REF_NAME} --with-registry-auth - rm -rf $DOCKER_CERT_PATH when: manual ## stop staging stage stop_staging: stage: testing before_script: - echo "override global 'before_script'" image: "REGISTRY:5000/docker:latest" environment: staging dependencies: [] variables: DOCKER_CERT_PATH: "/certs" DOCKER_HOST: tcp://10.50.173.107:2376 DOCKER_TLS_VERIFY: 1 script: - mkdir -p $DOCKER_CERT_PATH - echo "$TLSCACERT" &gt; $DOCKER_CERT_PATH/ca.pem - echo "$TLSCERT" &gt; $DOCKER_CERT_PATH/cert.pem - echo "$TLSKEY" &gt; $DOCKER_CERT_PATH/key.pem - docker stack rm ${CI_ENVIRONMENT_NAME}_${CI_COMMIT_REF_NAME} # TODO: need check that stopped when: manual</code> </pre><br></div></div><br> ä»ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œå·²åœ¨ç®¡é“ä¸­æ·»åŠ äº†ä¸¤ä¸ªæŒ‰é’®ï¼ˆdeploy_stagingï¼Œstop_stagingï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2de/e3c/790/2dee3c7907f75f793499665d8a60de8a.png" alt="å›¾ç‰‡"><br> å †æ ˆçš„åç§°ä¸åˆ†æ”¯çš„åç§°ç›¸å¯¹åº”ï¼Œå¹¶ä¸”å”¯ä¸€æ€§å°±è¶³å¤Ÿäº†ã€‚ å †æ ˆä¸­çš„æœåŠ¡æ¥æ”¶å”¯ä¸€çš„IPåœ°å€ä»¥åŠç«¯å£ï¼Œç›®å½•ç­‰ã€‚ å°†è¢«éš”ç¦»ï¼Œä½†å¯¹äºæ¯ä¸ªå †æ ˆæ¥è¯´éƒ½æ˜¯ç›¸åŒçš„ï¼ˆå› ä¸ºæ‰€æœ‰å †æ ˆçš„é…ç½®æ–‡ä»¶éƒ½æ˜¯ç›¸åŒçš„ï¼‰-è¿™å°±æ˜¯æˆ‘ä»¬æ‰€å®ç°çš„ã€‚ æˆ‘ä»¬ä½¿ç”¨æè¿°é›†ç¾¤<b>çš„docker-compose.yml</b>éƒ¨ç½²<b>å †æ ˆ</b> ï¼ˆé›†ç¾¤ï¼‰ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="xml hljs">--- version: '3' services: userprop: image: redis:alpine deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none networks: nw_swarm: celery_bcd: image: redis:alpine deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none networks: nw_swarm: schedulerdb: image: mariadb:latest environment: MYSQL_ALLOW_EMPTY_PASSWORD: 'yes' MYSQL_DATABASE: schedulerdb MYSQL_USER: **** MYSQL_PASSWORD: **** command: ['--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci', '--explicit_defaults_for_timestamp=1'] deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none networks: nw_swarm: celerydb: image: mariadb:latest environment: MYSQL_ALLOW_EMPTY_PASSWORD: 'yes' MYSQL_DATABASE: celerydb MYSQL_USER: **** MYSQL_PASSWORD: **** deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none networks: nw_swarm: cluster: image: $CENTOS7 environment: - CENTOS - CI_ENVIRONMENT_NAME - CI_API_V4_URL - CI_REPOSITORY_URL - CI_PROJECT_ID - CI_PROJECT_URL - CI_PROJECT_PATH - CI_PROJECT_NAME - CI_COMMIT_REF_NAME - CI_BIN_DEPENDENCIES_JOB command: &gt; sudo -u myusername -H /bin/bash -c ". /etc/profile &amp;&amp; mkdir -p /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME &amp;&amp; cd /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME &amp;&amp; git clone -b $CI_COMMIT_REF_NAME $CI_REPOSITORY_URL . &amp;&amp; curl $CI_API_V4_URL/projects/$CI_PROJECT_ID/jobs/artifacts/$CI_COMMIT_REF_NAME/download?job=$CI_BIN_DEPENDENCIES_JOB -o artifacts.zip &amp;&amp; unzip artifacts.zip ; cd /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME/scripts/deploy/ &amp;&amp; python3 createconfig.py -s $CI_ENVIRONMENT_NAME &amp;&amp; /bin/bash install_venv.sh -d -r ../../requirements.txt &amp;&amp; python3 prepare_init.d.py &amp;&amp; python3 deploy.py -s $CI_ENVIRONMENT_NAME" deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none tty: true stdin_open: true networks: nw_swarm: networks: nw_swarm: external: true</code> </pre><br></div></div><br> åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ç»„ä»¶é€šè¿‡ä¸€ä¸ªç½‘ç»œï¼ˆnw_swarmï¼‰è¿æ¥å¹¶ä¸”å¯ä»¥ç›¸äº’è®¿é—®ã€‚ <br><br> ç³»ç»Ÿç»„ä»¶ï¼ˆåŸºäºredisï¼Œmysqlï¼‰ä¸å®šåˆ¶ç»„ä»¶çš„å…¬å…±æ± ï¼ˆè®¡åˆ’å’Œå®šåˆ¶è¢«åˆ’åˆ†ä¸ºæœåŠ¡ï¼‰åˆ†å¼€ã€‚ æˆ‘ä»¬é›†ç¾¤çš„éƒ¨ç½²é˜¶æ®µçœ‹èµ·æ¥åƒæ˜¯å°†CMDè½¬ç§»åˆ°ä¸€ä¸ªå¤§å‹é…ç½®æ˜ åƒï¼Œå¹¶ä¸”æ€»ä½“ä¸Šæ¥è¯´ï¼Œä¸ç¬¬ä¸€éƒ¨åˆ†ä¸­æè¿°çš„éƒ¨ç½²å‡ ä¹æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚æˆ‘ç€é‡å¼ºè°ƒä»¥ä¸‹å·®å¼‚ï¼š <br><br><ul><li>  <b>git clone ...-</b>æˆ‘ä»¬è·å¾—è¿›è¡Œéƒ¨ç½²æ‰€éœ€çš„æ–‡ä»¶ï¼ˆcreateconfig.pyï¼Œinstall_venv.shç­‰ï¼‰ </li><li>  <b>curl ... &amp;&amp;è§£å‹ç¼©...-</b>ä¸‹è½½å¹¶è§£å‹ç¼©æ±‡ç¼–å·¥ä»¶ï¼ˆå·²ç¼–è¯‘çš„å®ç”¨ç¨‹åºï¼‰ </li></ul><br> ä»…æœ‰ä¸€ä¸ªå°šæœªæè¿°çš„é—®é¢˜ï¼šå…·æœ‰Webç•Œé¢çš„ç»„ä»¶æ— æ³•ä»å¼€å‘äººå‘˜æµè§ˆå™¨è®¿é—®ã€‚ æˆ‘ä»¬ä½¿ç”¨åå‘ä»£ç†è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤ï¼š <br><br> åœ¨.gitlab-ci.ymlä¸­ï¼Œéƒ¨ç½²é›†ç¾¤å †æ ˆåï¼Œæ·»åŠ å¹³è¡¡å™¨éƒ¨ç½²è¡Œï¼ˆæäº¤æ—¶ä»…æ›´æ–°å…¶é…ç½®ï¼ˆä½¿ç”¨æ¨¡æ¿åˆ›å»ºæ–°çš„nginxé…ç½®æ–‡ä»¶ï¼š/etc/nginx/conf.d/${CI_COMMIT_REF_NAMEâ–º.confï¼‰ï¼‰-å‚è§ä»£ç docker-compose-nginx.ymlï¼‰ <br><br><pre> <code class="xml hljs"> - docker stack deploy -c docker-compose-nginx.yml ${CI_ENVIRONMENT_NAME} --with-registry-auth</code> </pre><br><div class="spoiler">  <b class="spoiler_title">docker-compose-nginx.yml</b> <div class="spoiler_text"><pre> <code class="xml hljs">--- version: '3' services: nginx: image: nginx:latest environment: CI_COMMIT_REF_NAME: ${CI_COMMIT_REF_NAME} NGINX_CONFIG: |- server { listen 8080; server_name staging_${CI_COMMIT_REF_NAME}_cluster.dev; location / { proxy_pass http://staging_${CI_COMMIT_REF_NAME}_cluster:8080; } } server { listen 5555; server_name staging_${CI_COMMIT_REF_NAME}_cluster.dev; location / { proxy_pass http://staging_${CI_COMMIT_REF_NAME}_cluster:5555; } } volumes: - /tmp/staging/nginx:/etc/nginx/conf.d command: /bin/bash -c "echo -e \"$$NGINX_CONFIG\" &gt; /etc/nginx/conf.d/${CI_COMMIT_REF_NAME}.conf; nginx -g \"daemon off;\"; /etc/init.d/nginx reload" ports: - 8080:8080 - 5555:5555 - 3000:3000 - 443:443 - 80:80 deploy: replicas: 1 placement: constraints: [node.id == kilqc94pi2upzvabttikrfr5d] restart_policy: condition: none networks: nw_swarm: networks: nw_swarm: external: true</code> </pre><br></div></div><br> åœ¨å¼€å‘è®¡ç®—æœºä¸Šï¼Œæ›´æ–°/ etc /ä¸»æœºï¼› å‘nginxæ³¨å†Œç½‘å€ï¼š <br><br> <code>10.50.173.106 staging_BRANCH-1831_cluster.dev <br></code> <br> å› æ­¤ï¼Œå·²ç»å®ç°äº†éš”ç¦»çš„æš‚å­˜ç¾¤é›†çš„éƒ¨ç½²ï¼Œå¹¶ä¸”å¼€å‘äººå‘˜ç°åœ¨å¯ä»¥ä»¥è¶³å¤Ÿçš„æ•°é‡å¯åŠ¨å®ƒä»¬ä»¥æµ‹è¯•å…¶ä»»åŠ¡ã€‚ <br><br> è¿›ä¸€æ­¥çš„è®¡åˆ’ï¼š <br><br><ul><li> å°†æˆ‘ä»¬çš„ç»„ä»¶ä½œä¸ºæœåŠ¡åˆ†å¼€ </li><li> ä¸ºæ¯ä¸ªDockerfileåˆ¶ä½œ </li><li> è‡ªåŠ¨æ£€æµ‹å †æ ˆä¸­è¾ƒå°‘åŠ è½½çš„èŠ‚ç‚¹ </li><li> é€šè¿‡åç§°æ¨¡å¼è®¾ç½®èŠ‚ç‚¹ï¼ˆè€Œä¸æ˜¯åƒæ–‡ç« ä¸­é‚£æ ·ä½¿ç”¨idï¼‰ </li><li> æ·»åŠ æ£€æŸ¥å †æ ˆæ˜¯å¦å·²æŸå </li><li>  ... </li></ul><br> ç‰¹åˆ«æ„Ÿè°¢æ‚¨çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471528/">https://habr.com/ru/post/zh-CN471528/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471516/index.html">è‹±ç‰¹å°”665p-å…·æœ‰96å±‚QLC NANDçš„SSD</a></li>
<li><a href="../zh-CN471518/index.html">è‹¹æœåœ¨2019å¹´æ˜¯Linuxåœ¨2000å¹´</a></li>
<li><a href="../zh-CN471520/index.html">ã€Š Pythonä¸­çš„ç»å…¸è®¡ç®—æœºç§‘å­¦ä»»åŠ¡ã€‹ä¸€ä¹¦</a></li>
<li><a href="../zh-CN471522/index.html">Askoziaã€‚ è‡ªåŠ¨é…ç½®å³æ’å³ç”¨çš„å·¥ä½œåŸç†</a></li>
<li><a href="../zh-CN471524/index.html">å®Œæ•´çš„é’ˆå¯¹è¯„ä¼°äººçš„è¯´æ˜çš„ç¿»è¯‘Google</a></li>
<li><a href="../zh-CN471530/index.html">GitLabèµ°ä¸Šäº†ä¸€æ¡é€šå‘CI / CDå’ŒKubernetesçš„ä¸å¯»å¸¸é“è·¯</a></li>
<li><a href="../zh-CN471532/index.html">å†è§PCBï¼› ä½ å¥½ç¡…äº’è¿</a></li>
<li><a href="../zh-CN471536/index.html">Google Floodé¢„æµ‹ï¼šæ·±å…¥äº†è§£</a></li>
<li><a href="../zh-CN471538/index.html">ä»ç§»åŠ¨åº”ç”¨ç¨‹åºçš„æƒ³æ³•åˆ°æŠ•èµ„è€…å°†æŠ•èµ„çš„MVP</a></li>
<li><a href="../zh-CN471542/index.html">OCRæ–‡å­—è¯†åˆ«</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>