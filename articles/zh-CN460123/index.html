<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ€ ğŸ‘§ğŸ½ ğŸª åœ¨å‚ä¸è€…ä¹‹ä¸Šçš„å£°æ˜å¼æ•°æ®å¤„ç†ç®¡é“ï¼Ÿ ä¸ºä»€ä¹ˆä¸å‘¢ ğŸ›ŒğŸ¿ ğŸš´ğŸ¼ â˜”ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ä¹…å‰ï¼Œåœ¨å…³äºSObjectizerå‘è¡Œç‰ˆä¹‹ä¸€çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬è¢«é—®åˆ°ï¼šâ€œæ˜¯å¦æœ‰å¯èƒ½ä½¿DSLæ¥æè¿°æ•°æ®å¤„ç†ç®¡é“ï¼Ÿâ€ æ¢å¥è¯è¯´ï¼Œæ˜¯å¦å¯ä»¥è¿™æ ·å†™ï¼š 


A | B | C | D  


 å¹¶è·å¾—ä¸€æ¡å·¥ä½œæµæ°´çº¿ï¼Œå…¶ä¸­æ¶ˆæ¯ä»Aåˆ°Bï¼Œå†åˆ°Cï¼Œå†åˆ°Dã€‚åœ¨æ§åˆ¶ä¹‹ä¸‹ï¼ŒBæ¥æ”¶äº†Aæ‰€è¿”å›çš„ç¡®åˆ‡ç±»å‹ã€‚ Cæ°å¥½æ”¶åˆ°Bè¿”å›çš„...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨å‚ä¸è€…ä¹‹ä¸Šçš„å£°æ˜å¼æ•°æ®å¤„ç†ç®¡é“ï¼Ÿ ä¸ºä»€ä¹ˆä¸å‘¢</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460123/"><p> ä¸ä¹…å‰ï¼Œåœ¨å…³äºSObjectizerå‘è¡Œç‰ˆä¹‹ä¸€çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬è¢«é—®åˆ°ï¼šâ€œæ˜¯å¦æœ‰å¯èƒ½ä½¿DSLæ¥æè¿°æ•°æ®å¤„ç†ç®¡é“ï¼Ÿâ€ æ¢å¥è¯è¯´ï¼Œæ˜¯å¦å¯ä»¥è¿™æ ·å†™ï¼š </p><br><p><code>A | B | C | D</code> </p> <br><p> å¹¶è·å¾—ä¸€æ¡å·¥ä½œæµæ°´çº¿ï¼Œå…¶ä¸­æ¶ˆæ¯ä»Aåˆ°Bï¼Œå†åˆ°Cï¼Œå†åˆ°Dã€‚åœ¨æ§åˆ¶ä¹‹ä¸‹ï¼ŒBæ¥æ”¶äº†Aæ‰€è¿”å›çš„ç¡®åˆ‡ç±»å‹ã€‚  Cæ°å¥½æ”¶åˆ°Bè¿”å›çš„é‚£ç§ç±»å‹ã€‚ ä¾æ­¤ç±»æ¨ã€‚ </p><br><p> ä½¿ç”¨ä»¤äººæƒŠè®¶çš„ç®€å•è§£å†³æ–¹æ¡ˆï¼Œè¿™æ˜¯ä¸€é¡¹æœ‰è¶£çš„ä»»åŠ¡ã€‚ ä¾‹å¦‚ï¼Œè¿™å°±æ˜¯ç®¡é“åˆ›å»ºçš„æ ·å­ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pipeline = make_pipeline(env, stage(A) | stage(B) | stage(C) | stage(D));</code> </pre> <br><p> æˆ–è€…ï¼Œåœ¨æ›´å¤æ‚çš„æƒ…å†µä¸‹ï¼ˆå°†åœ¨ä¸‹é¢è®¨è®ºï¼‰ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pipeline = make_pipeline( sobj.environment(), stage(validation) | stage(conversion) | broadcast( stage(archiving), stage(distribution), stage(range_checking) | stage(alarm_detector{}) | broadcast( stage(alarm_initiator), stage( []( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> alarm_detected &amp; v ) { alarm_distribution( <span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span>, v ); } ) ) ) );</code> </pre> <br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºè¿™ç§ç®¡é“DSLçš„å®ç°ã€‚ æˆ‘ä»¬å°†é€šè¿‡å‡ ä¸ªä½¿ç”¨C ++æ¨¡æ¿çš„ç¤ºä¾‹æ¥è®¨è®ºä¸<code>stage()</code> ï¼Œ <code>broadcast()</code>å’Œ<code>operator|()</code>å‡½æ•°æœ‰å…³çš„å¤§éƒ¨åˆ†å†…å®¹ã€‚ å› æ­¤ï¼Œæˆ‘å¸Œæœ›å³ä½¿å¯¹äºä¸äº†è§£SObjectizerçš„è¯»è€…æ¥è¯´ï¼Œå®ƒä¹Ÿä¼šå¾ˆæœ‰è¶£ï¼ˆå¦‚æœæ‚¨ä»æœªå¬è¯´è¿‡SObjectizerï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>æ˜¯æ­¤å·¥å…·çš„æ¦‚è¿°ï¼‰ã€‚ </p><a name="habracut"></a><br><h1 id="a-couple-of-words-about-the-used-demo"> å…³äºäºŒæ‰‹æ¼”ç¤ºçš„å‡ å¥è¯ </h1><br><p> æœ¬æ–‡ä¸­ä½¿ç”¨çš„ç¤ºä¾‹å—åˆ°äº†æˆ‘åœ¨SCADAé¢†åŸŸçš„è¿‡å¾€ï¼ˆç”šè‡³æ˜¯è¢«é—å¿˜çš„ï¼‰ç»å†çš„å½±å“ã€‚ </p><br><p> è¯¥æ¼”ç¤ºçš„æƒ³æ³•æ˜¯å¤„ç†ä»æŸäº›ä¼ æ„Ÿå™¨è¯»å–çš„æ•°æ®ã€‚ éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ä»ä¼ æ„Ÿå™¨è·å–æ•°æ®ï¼Œç„¶åå¿…é¡»å¯¹è¯¥æ•°æ®è¿›è¡ŒéªŒè¯ï¼ˆåº”å¿½ç•¥ä¸æ­£ç¡®çš„æ•°æ®ï¼‰å¹¶å°†å…¶è½¬æ¢ä¸ºä¸€äº›å®é™…å€¼ã€‚ ä¾‹å¦‚ï¼Œä»ä¼ æ„Ÿå™¨è¯»å–çš„åŸå§‹æ•°æ®å¯ä»¥æ˜¯ä¸¤ä¸ª8ä½æ•´æ•°å€¼ï¼Œå¹¶ä¸”è¿™äº›å€¼åº”è½¬æ¢ä¸ºä¸€ä¸ªæµ®ç‚¹æ•°ã€‚ </p><br><p> ç„¶åï¼Œåº”å°†æœ‰æ•ˆå€¼å’Œè½¬æ¢åçš„å€¼å­˜æ¡£ï¼Œåˆ†å¸ƒåœ¨æŸä¸ªä½ç½®ï¼ˆä¾‹å¦‚ï¼Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šä»¥è¿›è¡Œå¯è§†åŒ–ï¼‰ï¼Œæ£€æŸ¥â€œè­¦æŠ¥â€ï¼ˆå¦‚æœå€¼è¶…å‡ºå®‰å…¨èŒƒå›´ï¼Œåˆ™åº”è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼‰ã€‚ è¿™äº›æ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ </p><br><p> ä¸æ£€æµ‹åˆ°çš„è­¦æŠ¥ç›¸å…³çš„æ“ä½œä¹Ÿå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼šåº”å¯åŠ¨â€œè­¦æŠ¥â€ï¼ˆè¿™æ ·ï¼Œå½“å‰èŠ‚ç‚¹ä¸Šçš„SCADAéƒ¨åˆ†å¯ä»¥å¯¹æ­¤ä½œå‡ºååº”ï¼‰ï¼Œæœ‰å…³â€œè­¦æŠ¥â€çš„ä¿¡æ¯åº”åˆ†å‘åˆ°å…¶ä»–åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼šå­˜å‚¨åˆ°å†å²æ•°æ®åº“å’Œ/æˆ–åœ¨SCADAæ“ä½œå‘˜çš„æ˜¾ç¤ºå±ä¸Šå¯è§†åŒ–ï¼‰ã€‚ </p><br><p> è¿™ç§é€»è¾‘å¯ä»¥ç”¨æ–‡æœ¬å½¢å¼è¡¨ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">optional(valid_raw_data) = validate(raw_data); if valid_raw_data is not empty then { converted_value = convert(valid_raw_data); do_async archive(converted_value); do_async distribute(converted_value); do_async { optional(suspicious_value) = check_range(converted_value); if suspicious_value is not empty then { optional(alarm) = detect_alarm(suspicious_value); if alarm is not empty then { do_async initiate_alarm(alarm); do_async distribute_alarm(alam); } } } }</code> </pre> <br><p> æˆ–è€…ï¼Œä»¥å›¾å½¢å½¢å¼ï¼š </p><br><p><img src="https://habrastorage.org/webt/5z/nm/vv/5znmvvaqnou_qwh808t8vkbrdc8.jpeg"></p><br><p> è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒäººä¸ºçš„ç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘æƒ³å±•ç¤ºä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ã€‚ é¦–å…ˆæ˜¯æµæ°´çº¿ä¸­å­˜åœ¨å¹¶è¡Œé˜¶æ®µ<code>broadcast()</code>æ­£æ˜¯ç”±äºè¿™ä¸ªåŸå› è€Œå­˜åœ¨<code>broadcast()</code>æ“ä½œ<code>broadcast()</code> ï¼‰ã€‚ ç¬¬äºŒä¸ªæ˜¯åœ¨æŸäº›é˜¶æ®µå­˜åœ¨çŠ¶æ€ã€‚ ä¾‹å¦‚ï¼Œalarm_detectoræ˜¯æœ‰çŠ¶æ€é˜¶æ®µã€‚ </p><br><h1 id="pipeline-capabilities"> ç®¡é“åŠŸèƒ½ </h1><br><p> ç®¡é“æ˜¯ä»ä¸åŒçš„é˜¶æ®µæ„å»ºçš„ã€‚ æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä»¥ä¸‹æ ¼å¼çš„å‡½æ•°æˆ–å‡½å­ï¼š </p><br><pre> <code class="cpp hljs">opt&lt;Out&gt; func(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> In &amp;);</code> </pre> <br><p> æˆ– </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> In &amp;)</span></span></span></span>;</code> </pre> <br><p> è¿”å›<code>void</code>é˜¶æ®µåªèƒ½ç”¨ä½œç®¡é“çš„æœ€åé˜¶æ®µã€‚ </p><br><p> é˜¶æ®µè¢«æ†ç»‘åœ¨ä¸€èµ·ã€‚ æ¯ä¸ªä¸‹ä¸€ä¸ªé˜¶æ®µéƒ½æ¥æ”¶ä¸Šä¸€ä¸ªé˜¶æ®µè¿”å›çš„å¯¹è±¡ã€‚ å¦‚æœä¸Šä¸€çº§è¿”å›ç©ºçš„<code>opt&lt;Out&gt;</code>å€¼ï¼Œåˆ™ä¸è°ƒç”¨ä¸‹ä¸€çº§ã€‚ </p><br><p> æœ‰ä¸€ä¸ªç‰¹æ®Šçš„<code>broadcast</code>é˜¶æ®µã€‚ å®ƒæ˜¯ç”±å¤šä¸ªç®¡é“æ„æˆçš„ã€‚  <code>broadcast</code>é˜¶æ®µä»ä¸Šä¸€é˜¶æ®µæ¥æ”¶å¯¹è±¡ï¼Œå¹¶å°†å…¶å¹¿æ’­åˆ°æ¯ä¸ªè¾…åŠ©ç®¡é“ã€‚ </p><br><p> ä»ç®¡é“çš„è§’åº¦æ¥çœ‹ï¼Œ <code>broadcast</code>é˜¶æ®µçœ‹èµ·æ¥åƒä»¥ä¸‹æ ¼å¼çš„å‡½æ•°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> In &amp;)</span></span></span></span>;</code> </pre> <br><p> å› ä¸º<code>broadcast</code>é˜¶æ®µæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥<code>broadcast</code>é˜¶æ®µåªèƒ½æ˜¯ç®¡é“ä¸­çš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚ </p><br><h2 id="why-does-the-pipeline-stage-return-an-optional-value"> ä¸ºä»€ä¹ˆç®¡é“é˜¶æ®µè¿”å›ä¸€ä¸ªå¯é€‰å€¼ï¼Ÿ </h2><br><p> è¿™æ˜¯å› ä¸ºéœ€è¦åˆ é™¤ä¸€äº›ä¼ å…¥çš„å€¼ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåŸå§‹å€¼ä¸æ­£ç¡®ï¼Œé‚£ä¹ˆ<code>validate</code>é˜¶æ®µå°†ä¸è¿”å›ä»»ä½•å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å¤„ç†æ„ä¹‰ã€‚ </p><br><p> å¦ä¸€ä¸ªç¤ºä¾‹ï¼šå¦‚æœå½“å‰çš„å¯ç–‘å€¼æœªäº§ç”Ÿæ–°çš„è­¦æŠ¥æƒ…å†µï¼Œåˆ™<code>alarm_detector</code>é˜¶æ®µä¸è¿”å›ä»»ä½•å†…å®¹ã€‚ </p><br><h1 id="implementation-details"> å®æ–½ç»†èŠ‚ </h1><br><h2 id="types-and-functions-related-to-the-application-logic"> ä¸åº”ç”¨ç¨‹åºé€»è¾‘ç›¸å…³çš„ç±»å‹å’ŒåŠŸèƒ½ </h2><br><p> è®©æˆ‘ä»¬ä»ä¸åº”ç”¨ç¨‹åºé€»è¾‘ç›¸å…³çš„æ•°æ®ç±»å‹å’ŒåŠŸèƒ½å¼€å§‹ã€‚ åœ¨è®¨è®ºçš„ç¤ºä¾‹ä¸­ï¼Œä»¥ä¸‹æ•°æ®ç±»å‹ç”¨äºå°†ä¿¡æ¯ä»ä¸€ä¸ªé˜¶æ®µä¼ é€’åˆ°å¦ä¸€é˜¶æ®µï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Raw data from a sensor. struct raw_measure { int m_meter_id; uint8_t m_high_bits; uint8_t m_low_bits; }; // Type of input for validation stage with raw data from a sensor. struct raw_value { raw_measure m_data; }; // Type of input for conversion stage with valid raw data from a sensor. struct valid_raw_value { raw_measure m_data; }; // Data from a sensor after conversion to Celsius degrees. struct calculated_measure { int m_meter_id; float m_measure; }; // The type for result of conversion stage with converted data from a sensor. struct sensor_value { calculated_measure m_data; }; // Type with value which could mean a dangerous level of temperature. struct suspicious_value { calculated_measure m_data; }; // Type with information about detected dangerous situation. struct alarm_detected { int m_meter_id; };</span></span></code> </pre> <br><p>  <code>raw_value</code>çš„å®ä¾‹å°†è¿›å…¥ç®¡é“çš„ç¬¬ä¸€é˜¶æ®µã€‚ è¯¥<code>raw_value</code>åŒ…å«ä»¥<code>raw_measure</code>å¯¹è±¡çš„å½¢å¼ä»ä¼ æ„Ÿå™¨è·å–çš„ä¿¡æ¯ã€‚ ç„¶åå°†<code>raw_value</code>è½¬æ¢ä¸º<code>valid_raw_value</code> ã€‚ ç„¶åï¼Œå°†<code>valid_raw_value</code>è½¬æ¢ä¸º<code>sensor_value</code>å¹¶å°†å®é™…ä¼ æ„Ÿå™¨çš„å€¼å½¢å¼ä¸º<code>calulated_measure</code> ã€‚ å¦‚æœ<code>sensor_value</code>çš„å®ä¾‹åŒ…å«å¯ç–‘å€¼ï¼Œåˆ™å°†ç”Ÿæˆ<code>suspicious_value</code>çš„å®ä¾‹ã€‚ è€Œä¸”è¯¥<code>suspicious_value</code>å¯ä»¥åœ¨ä»¥åè½¬æ¢ä¸º<code>alarm_detected</code>å®ä¾‹ã€‚ </p><br><p> æˆ–è€…ï¼Œä»¥å›¾å½¢å½¢å¼ï¼š </p><br><p><img src="https://habrastorage.org/webt/dp/dx/rz/dpdxrzpp-rvo05zk-8rwdwucszo.jpeg"></p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æµæ°´çº¿é˜¶æ®µçš„å®ç°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // The first stage of a pipeline. Validation of raw data from a sensor. // // Returns valid_raw_value or nothing if value is invalid. // stage_result_t&lt; valid_raw_value &gt; validation( const raw_value &amp; v ) { if( 0x7 &gt;= v.m_data.m_high_bits ) return make_result&lt; valid_raw_value &gt;( v.m_data ); else return make_empty&lt; valid_raw_value &gt;(); } // // The second stage of a pipeline. Conversion from raw data to a value // in Celsius degrees. // stage_result_t&lt; sensor_value &gt; conversion( const valid_raw_value &amp; v ) { return make_result&lt; sensor_value &gt;( calculated_measure{ v.m_data.m_meter_id, 0.5f * ((static_cast&lt; uint16_t &gt;( v.m_data.m_high_bits ) &lt;&lt; 8) + v.m_data.m_low_bits) } ); } // // Simulation of the data archiving. // void archiving( const sensor_value &amp; v ) { clog &lt;&lt; "archiving (" &lt;&lt; v.m_data.m_meter_id &lt;&lt; "," &lt;&lt; v.m_data.m_measure &lt;&lt; ")" &lt;&lt; endl; } // // Simulation of the data distribution. // void distribution( const sensor_value &amp; v ) { clog &lt;&lt; "distributing (" &lt;&lt; v.m_data.m_meter_id &lt;&lt; "," &lt;&lt; v.m_data.m_measure &lt;&lt; ")" &lt;&lt; endl; } // // The first stage of a child pipeline at third level of the main pipeline. // // Checking for to high value of the temperature. // // Returns suspicious_value message or nothing. // stage_result_t&lt; suspicious_value &gt; range_checking( const sensor_value &amp; v ) { if( v.m_data.m_measure &gt;= 45.0f ) return make_result&lt; suspicious_value &gt;( v.m_data ); else return make_empty&lt; suspicious_value &gt;(); } // // The next stage of a child pipeline. // // Checks for two suspicious_value-es in 25ms time window. // class alarm_detector { using clock = chrono::steady_clock; public : stage_result_t&lt; alarm_detected &gt; operator()( const suspicious_value &amp; v ) { if( m_previous ) if( *m_previous + chrono::milliseconds(25) &gt; clock::now() ) { m_previous = nullopt; return make_result&lt; alarm_detected &gt;( v.m_data.m_meter_id ); } m_previous = clock::now(); return make_empty&lt; alarm_detected &gt;(); } private : optional&lt; clock::time_point &gt; m_previous; }; // // One of last stages of a child pipeline. // Imitates beginning of the alarm processing. // void alarm_initiator( const alarm_detected &amp; v ) { clog &lt;&lt; "=== alarm (" &lt;&lt; v.m_meter_id &lt;&lt; ") ===" &lt;&lt; endl; } // // Another of last stages of a child pipeline. // Imitates distribution of the alarm. // void alarm_distribution( ostream &amp; to, const alarm_detected &amp; v ) { to &lt;&lt; "alarm_distribution (" &lt;&lt; v.m_meter_id &lt;&lt; ")" &lt;&lt; endl; }</span></span></code> </pre> <br><p> åªéœ€è·³è¿‡<code>stage_result_t</code> ï¼Œ <code>make_result</code>å’Œ<code>make_empty</code> ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­è®¨è®ºã€‚ </p><br><p> æˆ‘å¸Œæœ›è¿™äº›é˜¶æ®µçš„ä»£ç ç›¸å½“ç®€å•ã€‚ å”¯ä¸€éœ€è¦ä¸€äº›å…¶ä»–è¯´æ˜çš„éƒ¨åˆ†æ˜¯<code>alarm_detector</code>é˜¶æ®µçš„å®ç°ã€‚ </p><br><p> åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œä»…åœ¨25msæ—¶é—´çª—å£ä¸­è‡³å°‘æœ‰ä¸¤ä¸ª<code>suspicious_values</code>æ—¶æ‰å‘å‡ºè­¦æŠ¥ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è®°ä½åœ¨<code>alarm_detector</code>é˜¶æ®µå‰ä¸€ä¸ª<code>suspicious_value</code>å®ä¾‹çš„æ—¶é—´ã€‚ è¿™æ˜¯å› ä¸º<code>alarm_detector</code>é€šè¿‡å‡½æ•°è°ƒç”¨è¿ç®—ç¬¦å®ç°ä¸ºæœ‰çŠ¶æ€å‡½å­ã€‚ </p><br><h2 id="stages-return-sobjectizers-type-instead-of-stdoptional"> é˜¶æ®µè¿”å›SObjectizerçš„ç±»å‹ï¼Œè€Œä¸æ˜¯std ::å¯é€‰ </h2><br><p> æˆ‘ä¹‹å‰å‘Šè¯‰è¿‡é˜¶æ®µå¯ä»¥è¿”å›å¯é€‰å€¼ã€‚ ä½†æ˜¯ä»£ç ä¸­æ²¡æœ‰ä½¿ç”¨<code>std::optional</code> ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µå¯ä»¥çœ‹åˆ°ä¸åŒç±»å‹çš„<code>stage_result_t</code> ã€‚ </p><br><p> è¿™æ˜¯å› ä¸ºSObjectizerçš„æŸäº›ç‰¹å®šåŠŸèƒ½åœ¨è¿™é‡Œå‘æŒ¥äº†ä½œç”¨ã€‚ è¿”å›çš„å€¼å°†ä½œä¸ºæ¶ˆæ¯åœ¨SObjectizerçš„ä»£ç†ï¼ˆä¹Ÿç§°ä¸ºactorï¼‰ä¹‹é—´åˆ†å‘ã€‚  SObjectizerä¸­çš„æ¯ä¸ªæ¶ˆæ¯éƒ½ä½œä¸ºåŠ¨æ€åˆ†é…çš„å¯¹è±¡å‘é€ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„è¿›è¡Œäº†æŸç§â€œä¼˜åŒ–â€ï¼šè€Œä¸æ˜¯è¿”å›<code>std::optional</code>ç„¶ååˆ†é…æ–°çš„æ¶ˆæ¯å¯¹è±¡ï¼Œæˆ‘ä»¬åªæ˜¯åˆ†é…ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡å¹¶è¿”å›æŒ‡å‘å®ƒçš„æ™ºèƒ½æŒ‡é’ˆã€‚ </p><br><p> å®é™…ä¸Šï¼Œ <code>stage_result_t</code>åªæ˜¯SObjectizerçš„shared_ptræ¨¡æ‹Ÿçš„typedefï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M &gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stage_result_t</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt; M &gt;;</code> </pre> <br><p> å¹¶ä¸”<code>make_result</code>å’Œ<code>make_empty</code>åªæ˜¯ç”¨äºæ„é€ <code>stage_result_t</code>è¾…åŠ©å‡½æ•°ï¼Œå†…éƒ¨æ˜¯å¦å¸¦æœ‰å®é™…å€¼ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_result_t</span></span>&lt; M &gt; make_result( Args &amp;&amp;... args ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stage_result_t</span></span>&lt; M &gt;::make(forward&lt; Args &gt;(args)...); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_result_t</span></span>&lt; M &gt; make_empty() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stage_result_t</span></span>&lt; M &gt;(); }</code> </pre> <br><p> ä¸ºç®€å•èµ·è§ï¼Œå¯ä»¥è‚¯å®šåœ°è¯´<code>validation</code>é˜¶æ®µå¯ä»¥è¿™æ ·è¡¨ç¤ºï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt; valid_raw_value &gt; validation( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> raw_value &amp; v ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-number"><span class="hljs-number">0x7</span></span> &gt;= v.m_data.m_high_bits ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; valid_raw_value &gt;( v.m_data ); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt; valid_raw_value &gt;{}; }</code> </pre> <br><p> ä½†æ˜¯ï¼Œç”±äºSObjectizerçš„ç‰¹å®šæ€§ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨<code>std::shared_ptr</code>è€Œå¿…é¡»å¤„ç†<code>so_5::message_holder_t</code>ç±»å‹ã€‚ å¹¶ä¸”æˆ‘ä»¬å°†å…·ä½“çš„éšè—åœ¨<code>stage_result_t</code> ï¼Œ <code>make_result</code>å’Œ<code>make_empty</code>å¸®åŠ©å™¨åé¢ã€‚ </p><br><h2 id="stage_handler_t-and-stage_builder_t-separation">  stage_handler_tå’Œstage_builder_tåˆ†ç¦» </h2><br><p> æµæ°´çº¿å®ç°çš„ä¸€ä¸ªé‡ç‚¹æ˜¯<em>é˜¶æ®µå¤„ç†ç¨‹åº</em>å’Œ<em>é˜¶æ®µæ„å»ºå™¨</em>æ¦‚å¿µçš„åˆ†ç¦»ã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç®€åŒ–ã€‚ è¿™äº›æ¦‚å¿µçš„å‡ºç°ä½¿æˆ‘åœ¨ç®¡é“å®šä¹‰ä¸­æœ‰ä¸¤ä¸ªæ­¥éª¤ã€‚ </p><br><p> ç¬¬ä¸€æ­¥ï¼Œç”¨æˆ·æè¿°æµæ°´çº¿é˜¶æ®µã€‚ ç»“æœï¼Œæˆ‘æ”¶åˆ°ä¸€ä¸ª<code>stage_t</code>å®ä¾‹ï¼Œè¯¥å®ä¾‹å°†æ‰€æœ‰ç®¡é“é˜¶æ®µä¿å­˜åœ¨å…¶ä¸­ã€‚ </p><br><p> ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºä¸€ç»„åŸºç¡€SObjectizerçš„ä»£ç†ã€‚ è¿™äº›ä»£ç†æ¥æ”¶å¸¦æœ‰ä¸Šä¸€é˜¶æ®µç»“æœçš„æ¶ˆæ¯ï¼Œå¹¶è°ƒç”¨å®é™…çš„<em>é˜¶æ®µå¤„ç†ç¨‹åº</em> ï¼Œç„¶åå°†ç»“æœå‘é€åˆ°ä¸‹ä¸€é˜¶æ®µã€‚ </p><br><p> ä½†æ˜¯è¦åˆ›å»ºè¿™ç»„ä»£ç†ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½å¿…é¡»æœ‰ä¸€ä¸ª<em>é˜¶æ®µæ„å»ºå™¨</em> ã€‚  <em>é˜¶æ®µæ„å»ºå™¨</em>å¯ä»¥çœ‹ä½œæ˜¯åˆ›å»ºåŸºç¡€SObjectizerä»£ç†çš„å·¥å‚ã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å…·æœ‰ä»¥ä¸‹å…³ç³»ï¼šæ¯ä¸ªç®¡é“é˜¶æ®µéƒ½äº§ç”Ÿä¸¤ä¸ªå¯¹è±¡ï¼š <em>é˜¶æ®µå¤„ç†ç¨‹åº</em> ï¼Œå…¶ä¿å­˜ä¸é˜¶æ®µç›¸å…³çš„é€»è¾‘ï¼›ä»¥åŠ<em>é˜¶æ®µæ„å»ºå™¨</em> ï¼Œå…¶åˆ›å»ºåŸºç¡€SObjectizerçš„ä»£ç†ä»¥åœ¨é€‚å½“çš„æ—¶é—´è°ƒç”¨<em>é˜¶æ®µå¤„ç†ç¨‹åº</em> ï¼š </p><br><p><img src="https://habrastorage.org/webt/gl/tp/nn/gltpnnqhjqslsscxvellndh6n0u.jpeg"></p><br><p>  <em>é˜¶æ®µå¤„ç†ç¨‹åº</em>ä»¥ä»¥ä¸‹æ–¹å¼è¡¨ç¤ºï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stage_handler_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> traits = <span class="hljs-keyword"><span class="hljs-keyword">handler_traits_t</span></span>&lt; In, Out &gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> func_type = function&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> traits::output(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> traits::input &amp;) &gt;; <span class="hljs-keyword"><span class="hljs-keyword">stage_handler_t</span></span>( func_type handler ) : m_handler( move(handler) ) {} <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Callable &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_handler_t</span></span>( Callable handler ) : m_handler( handler ) {} <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> traits::<span class="hljs-function"><span class="hljs-function">output </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typename</span></span></span></span><span class="hljs-function"><span class="hljs-params"> traits::input &amp; a )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_handler( a ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> : func_type m_handler; };</code> </pre> <br><p> å…¶ä¸­<code>handler_traits_t</code>çš„å®šä¹‰æ–¹å¼å¦‚ä¸‹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // We have to deal with two types of stage handlers: // - intermediate handlers which will return some result (eg some new // message); // - terminal handlers which can return nothing (eg void instead of // stage_result_t&lt;M&gt;); // // This template with specialization defines `input` and `output` // aliases for both cases. // template&lt; typename In, typename Out &gt; struct handler_traits_t { using input = In; using output = stage_result_t&lt; Out &gt;; }; template&lt; typename In &gt; struct handler_traits_t&lt; In, void &gt; { using input = In; using output = void; };</span></span></code> </pre> <br><p>  <em>é˜¶æ®µæ„å»ºå™¨</em>ä»…ç”±<code>std::function</code> ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> = function&lt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp;, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span>) &gt;;</code> </pre> <br><h2 id="helper-types-lambda_traits_t-and-callable_traits_t"> å¸®æ‰‹ç±»å‹lambda_traits_tå’Œcallable_traits_t </h2><br><p> å› ä¸ºé˜¶æ®µå¯ä»¥ç”±è‡ªç”±å‡½æ•°æˆ–å‡½å­è¡¨ç¤ºï¼ˆä¾‹å¦‚ï¼Œ <code>alarm_detector</code>ç±»çš„å®ä¾‹æˆ–è¡¨ç¤ºlambdaçš„åŒ¿åç¼–è¯‘å™¨ç”Ÿæˆçš„ç±»çš„å®ä¾‹ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›å¸®åŠ©ç¨‹åºæ¥æ£€æµ‹é˜¶æ®µçš„å‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä½¿ç”¨äº†ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // Helper type for `arg_type` and `result_type` alises definition. // template&lt; typename R, typename A &gt; struct callable_traits_typedefs_t { using arg_type = A; using result_type = R; }; // // Helper type for dealing with stateful objects with operator() // (they could be user-defined objects or generated by compiler // like lambdas). // template&lt; typename T &gt; struct lambda_traits_t; template&lt; typename M, typename A, typename T &gt; struct lambda_traits_t&lt; stage_result_t&lt; M &gt;(T::*)(const A &amp;) const &gt; : public callable_traits_typedefs_t&lt; M, A &gt; {}; template&lt; typename A, typename T &gt; struct lambda_traits_t&lt; void (T::*)(const A &amp;) const &gt; : public callable_traits_typedefs_t&lt; void, A &gt; {}; template&lt; typename M, typename A, typename T &gt; struct lambda_traits_t&lt; stage_result_t&lt; M &gt;(T::*)(const A &amp;) &gt; : public callable_traits_typedefs_t&lt; M, A &gt; {}; template&lt; typename A, typename T &gt; struct lambda_traits_t&lt; void (T::*)(const A &amp;) &gt; : public callable_traits_typedefs_t&lt; void, A &gt; {}; // // Main type for definition of `arg_type` and `result_type` aliases. // With specialization for various cases. // template&lt; typename T &gt; struct callable_traits_t : public lambda_traits_t&lt; decltype(&amp;T::operator()) &gt; {}; template&lt; typename M, typename A &gt; struct callable_traits_t&lt; stage_result_t&lt; M &gt;(*)(const A &amp;) &gt; : public callable_traits_typedefs_t&lt; M, A &gt; {}; template&lt; typename A &gt; struct callable_traits_t&lt; void(*)(const A &amp;) &gt; : public callable_traits_typedefs_t&lt; void, A &gt; {};</span></span></code> </pre> <br><p> æˆ‘å¸Œæœ›å¯¹äºå…·æœ‰C ++çŸ¥è¯†çš„è¯»è€…æ¥è¯´ï¼Œè¿™æ®µä»£ç æ˜¯å¯ä»¥ç†è§£çš„ã€‚ å¦‚æœæ²¡æœ‰ï¼Œè¯·éšæ—¶åœ¨è¯„è®ºä¸­é—®æˆ‘ï¼Œæˆ‘å°†å¾ˆé«˜å…´è¯¦ç»†è§£é‡Š<code>lambda_traits_t</code>å’Œ<code>callable_traits_t</code>èƒŒåçš„é€»è¾‘ã€‚ </p><br><h2 id="stage-broadcast-and-operator-functions"> é˜¶æ®µï¼ˆï¼‰ï¼Œå¹¿æ’­ï¼ˆï¼‰å’Œè¿ç®—ç¬¦|ï¼ˆï¼‰å‡½æ•° </h2><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸»è¦çš„ç®¡é“æ„å»ºåŠŸèƒ½ã€‚ ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œæœ‰å¿…è¦æŸ¥çœ‹ä¸€ä¸‹æ¨¡æ¿ç±»<code>stage_t</code>çš„å®šä¹‰ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stage_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> m_builder; };</code> </pre> <br><p> è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç»“æ„ï¼Œä»…<code>stage_bulder_t</code>å®ä¾‹ã€‚ æ¨¡æ¿å‚æ•°æœªåœ¨<code>stage_t</code>å†…éƒ¨<code>stage_t</code> ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨æ­¤å¤„ä½¿ç”¨å®ƒä»¬ï¼Ÿ </p><br><p> å®ƒä»¬æ˜¯åœ¨ç®¡é“é˜¶æ®µä¹‹é—´è¿›è¡Œç±»å‹å…¼å®¹æ€§çš„ç¼–è¯‘æ—¶æ£€æŸ¥æ‰€å¿…éœ€çš„ã€‚ æˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æœ€ç®€å•çš„ç®¡é“æ„å»ºå‡½æ•°ï¼Œ <code>stage()</code> ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Callable, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-keyword"><span class="hljs-keyword">callable_traits_t</span></span>&lt; Callable &gt;::arg_type, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-keyword"><span class="hljs-keyword">callable_traits_t</span></span>&lt; Callable &gt;::result_type &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, Out &gt; stage( Callable handler ) { <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> builder{ [h = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(handler)]( <span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> next_stage) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coop.make_agent&lt; <span class="hljs-keyword"><span class="hljs-keyword">a_stage_point_t</span></span>&lt;In, Out&gt; &gt;( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(h), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(next_stage) ) -&gt;so_direct_mbox(); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(builder) }; }</code> </pre> <br><p> å®ƒæ¥æ”¶ä¸€ä¸ªå®é™…çš„<em>é˜¶æ®µå¤„ç†ç¨‹åº</em>ä½œä¸ºå•ä¸ªå‚æ•°ã€‚ å®ƒå¯ä»¥æ˜¯æŒ‡å‘å‡½æ•°ï¼Œlambdaå‡½æ•°æˆ–å‡½å­çš„æŒ‡é’ˆã€‚ ç”±äº<code>callable_traits_t</code>æ¨¡æ¿åé¢çš„â€œæ¨¡æ¿é­”æœ¯â€ï¼Œè‡ªåŠ¨æ¨å¯¼å‡ºäº†èˆå°çš„è¾“å…¥å’Œè¾“å‡ºç±»å‹ã€‚ </p><br><p> åœ¨å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ª<em>é˜¶æ®µæ„å»ºå™¨</em>çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹ä½œä¸º<code>stage()</code>å‡½æ•°çš„ç»“æœè¿”å›åˆ°ä¸€ä¸ªæ–°çš„<code>stage_t</code>å¯¹è±¡ä¸­ã€‚ å®é™…çš„<em>é˜¶æ®µå¤„ç†ç¨‹åº</em>ç”±<em>é˜¶æ®µæ„å»ºå™¨</em> lambdaæ•è·ï¼Œç„¶åå°†å…¶ç”¨äºæ„å»ºåŸºç¡€SObjectizerçš„ä»£ç†ï¼ˆæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è®¨è®ºï¼‰ã€‚ </p><br><p> ä¸‹ä¸€ä¸ªè¦æ£€æŸ¥çš„å‡½æ•°æ˜¯<code>operator|()</code> ï¼Œå®ƒå°†ä¸¤ä¸ªé˜¶æ®µè¿æ¥åœ¨ä¸€èµ·å¹¶è¿”å›ä¸€ä¸ªæ–°é˜¶æ®µï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out1, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out2 &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, Out2 &gt; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>|( <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, Out1 &gt; &amp;&amp; prev, <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; Out1, Out2 &gt; &amp;&amp; next ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span>{ [prev, next]( <span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> next_stage ) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> m = next.m_builder( coop, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(next_stage) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev.m_builder( coop, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(m) ); } } }; }</code> </pre> <br><p> è§£é‡Š<code>operator|()</code>çš„é€»è¾‘çš„æœ€ç®€å•æ–¹æ³•æ˜¯å°è¯•ç»˜åˆ¶å›¾ç‰‡ã€‚ å‡è®¾æˆ‘ä»¬æœ‰è¡¨è¾¾å¼ï¼š </p><br><pre> <code class="cpp hljs">stage(A) | stage(B) | stage(C) | stage(B)</code> </pre> <br><p> è¯¥è¡¨è¾¾å¼å°†ä»¥è¿™ç§æ–¹å¼è½¬æ¢ï¼š </p><br><p><img src="https://habrastorage.org/webt/jo/rr/aq/jorraqaawl6y7ju3om7zfq3java.jpeg"></p><br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥çš„å·¥ä½œæ–¹å¼ï¼š <code>operator|()</code>çš„å®šä¹‰è¦æ±‚ç¬¬ä¸€é˜¶æ®µçš„è¾“å‡ºç±»å‹æ˜¯ç¬¬äºŒé˜¶æ®µçš„è¾“å…¥ã€‚ å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œåˆ™ä¸ä¼šç¼–è¯‘ä»£ç ã€‚ </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€å¤æ‚çš„ç®¡é“æ„å»ºåŠŸèƒ½ï¼Œå³<code>broadcast()</code> ã€‚ è¯¥å‡½æ•°æœ¬èº«éå¸¸ç®€å•ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Rest &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> &gt; broadcast( <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, Out &gt; &amp;&amp; first, Rest &amp;&amp;... stages ) { <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> builder{ [broadcasts = collect_sink_builders( move(first), forward&lt; Rest &gt;(stages)...)] ( <span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> ) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> &gt; mboxes; mboxes.reserve( broadcasts.size() ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> &amp; b : broadcasts ) mboxes.emplace_back( b( coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span>{} ) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">broadcast_mbox_t</span></span>::make( coop.environment(), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(mboxes) ); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(builder) }; }</code> </pre> <br><p> æ™®é€šé˜¶æ®µå’Œå¹¿æ’­é˜¶æ®µä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¹¿æ’­é˜¶æ®µå¿…é¡»æ‹¥æœ‰è¾…åŠ©<em>é˜¶æ®µæ„å»ºè€…</em>çš„å‘é‡ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºè¯¥çŸ¢é‡å¹¶å°†å…¶ä¼ é€’åˆ°å¹¿æ’­çº§çš„ä¸»<em>çº§æ„å»ºå™¨</em>ä¸­ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>broadcast()</code>å‡½æ•°å†…çš„lambdaæ•è·åˆ—è¡¨ä¸­çœ‹åˆ°å¯¹<code>collect_sink_builders</code>çš„è°ƒç”¨ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> builder{ [broadcasts = collect_sink_builders( move(first), forward&lt; Rest &gt;(stages)...)]</code> </pre> <br><p> å¦‚æœæˆ‘ä»¬æŸ¥çœ‹<code>collect_sink_builder</code>æˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // Serie of helper functions for building description for // `broadcast` stage. // // Those functions are used for collecting // `builders` functions for every child pipeline. // // Please note that this functions checks that each child pipeline has the // same In type. // template&lt; typename In, typename Out, typename... Rest &gt; void move_sink_builder_to( vector&lt; stage_builder_t &gt; &amp; receiver, stage_t&lt; In, Out &gt; &amp;&amp; first, Rest &amp;&amp;... rest ) { receiver.emplace_back( move( first.m_builder ) ); if constexpr( 0u != sizeof...(rest) ) move_sink_builder_to&lt;In&gt;( receiver, forward&lt; Rest &gt;(rest)... ); } template&lt; typename In, typename Out, typename... Rest &gt; vector&lt; stage_builder_t &gt; collect_sink_builders( stage_t&lt; In, Out &gt; &amp;&amp; first, Rest &amp;&amp;... stages ) { vector&lt; stage_builder_t &gt; receiver; receiver.reserve( 1 + sizeof...(stages) ); move_sink_builder_to&lt;In&gt;( receiver, move(first), std::forward&lt;Rest&gt;(stages)... ); return receiver; }</span></span></code> </pre> <br><p> ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥åœ¨è¿™é‡Œä¹Ÿèµ·ä½œç”¨ï¼šè¿™æ˜¯å› ä¸ºå¯¹ç±»å‹ä¸º<code>move_sink_builder_to</code>çš„è°ƒç”¨<code>move_sink_builder_to</code>æ˜¾å¼å‚æ•°åŒ–ã€‚ è¿™æ„å‘³ç€ä»¥<code>collect_sink_builders(stage_t&lt;In1, Out1&gt;, stage_t&lt;In2, Out2&gt;, ...)</code>è¿›è¡Œçš„è°ƒç”¨å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºç¼–è¯‘å™¨ç¦æ­¢è°ƒç”¨<code>move_sink_builder_to&lt;In1&gt;(receiver, stage_t&lt;In2, Out2&gt;, ...)</code> ã€‚ </p><br><p> æˆ‘è¿˜å¯ä»¥æ³¨æ„åˆ°ï¼Œç”±äº<code>broadcast()</code>çš„å­ç®¡é“çš„æ•°é‡åœ¨ç¼–è¯‘æ—¶æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>std::array</code>è€Œä¸æ˜¯<code>std::vector</code> ï¼Œå¹¶ä¸”å¯ä»¥é¿å…ä¸€äº›å†…å­˜åˆ†é…ã€‚ ä½†æ˜¯è¿™é‡Œ<code>std::vector</code>åªæ˜¯ä¸ºäº†ç®€å•èµ·è§ã€‚ </p><br><h2 id="relation-between-stages-and-sobjectizers-agentsmboxes"> é˜¶æ®µä¸SObjectizerçš„ä»£ç†/ mboxä¹‹é—´çš„å…³ç³» </h2><br><p> å®æ–½ç®¡é“èƒŒåçš„æƒ³æ³•æ˜¯ä¸ºæ¯ä¸ªç®¡é“é˜¶æ®µåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ä»£ç†ã€‚ ä»£ç†æ¥æ”¶ä¼ å…¥çš„æ¶ˆæ¯ï¼Œå°†å…¶ä¼ é€’åˆ°ç›¸åº”çš„<em>é˜¶æ®µå¤„ç†ç¨‹åº</em> ï¼Œåˆ†æç»“æœï¼Œå¦‚æœç»“æœä¸ä¸ºç©ºï¼Œåˆ™å°†ç»“æœä½œä¸ºä¼ å…¥æ¶ˆæ¯å‘é€åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹åºåˆ—å›¾è¿›è¡Œè¯´æ˜ï¼š </p><br><p><img src="https://habrastorage.org/webt/om/pn/wy/ompnwye792gjgad7zzgphpv4ctu.png"></p><br><p> å¿…é¡»è‡³å°‘ç®€çŸ­åœ°è®¨è®ºä¸€äº›ä¸SObjectizerç›¸å…³çš„äº‹æƒ…ã€‚ å¦‚æœæ‚¨å¯¹æ­¤ç±»è¯¦ç»†ä¿¡æ¯ä¸æ„Ÿå…´è¶£ï¼Œåˆ™å¯ä»¥è·³è¿‡ä»¥ä¸‹éƒ¨åˆ†ï¼Œç›´æ¥æŸ¥çœ‹ç»“è®ºã€‚ </p><br><h3 id="coop-is-a-group-of-agents-to-work-together"> åˆä½œç¤¾æ˜¯ä¸€ç»„ä¸€èµ·å·¥ä½œçš„ä»£ç†å•† </h3><br><p> ä»£ç†ä¸æ˜¯å•ç‹¬å¼•å…¥åˆ°SObjectizerä¸­ï¼Œè€Œæ˜¯ä»¥åä¸ºcoopsçš„ç»„å¼•å…¥ã€‚ åˆä½œç¤¾æ˜¯ä¸€ç»„åº”è¯¥ä¸€èµ·å·¥ä½œçš„ç‰¹å·¥ï¼Œå¦‚æœç¼ºå°‘è¯¥ç»„ç‰¹å·¥ä¸­çš„ä¸€ä¸ªï¼Œåˆ™æ²¡æœ‰ç»§ç»­å·¥ä½œçš„æ„Ÿè§‰ã€‚ </p><br><p> å› æ­¤ï¼Œå°†ä»£ç†å¼•å…¥SObjectizerçš„è¿‡ç¨‹å°±åƒåˆ›å»ºcoopå®ä¾‹ï¼Œç”¨é€‚å½“çš„ä»£ç†å¡«å……è¯¥å®ä¾‹ï¼Œç„¶ååœ¨SObjectizerä¸­æ³¨å†Œè¯¥coopã€‚ </p><br><p> å› æ­¤ï¼Œ <em>é˜¶æ®µæ„å»ºå™¨</em>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹æ–°åˆä½œç¤¾çš„å¼•ç”¨ã€‚ æ­¤åˆä½œç¤¾æ˜¯åœ¨<code>make_pipeline()</code>å‡½æ•°ä¸­åˆ›å»ºçš„ï¼ˆä¸‹é¢è®¨è®ºï¼‰ï¼Œç„¶åç”±<em>èˆå°æ„å»ºå™¨</em>å¡«å……å¹¶è¿›è¡Œæ³¨å†Œï¼ˆå†æ¬¡åœ¨<code>make_pipeline()</code>å‡½æ•°ä¸­ï¼‰ã€‚ </p><br><h3 id="message-boxes"> ç•™è¨€æ¡† </h3><br><p>  SObjectizerå®ç°äº†å‡ ä¸ªä¸å¹¶å‘ç›¸å…³çš„æ¨¡å‹ã€‚ æ¼”å‘˜æ¨¡å‹åªæ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚ å› æ­¤ï¼ŒSObjectizerå¯ä»¥ä¸å…¶ä»–å‚ä¸è€…æ¡†æ¶æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ åŒºåˆ«ä¹‹ä¸€æ˜¯æ¶ˆæ¯çš„å¯»å€æ–¹æ¡ˆã€‚ </p><br><p>  SObjectizerä¸­çš„æ¶ˆæ¯ä¸æ˜¯é’ˆå¯¹å‚ä¸è€…ï¼Œè€Œæ˜¯<em>æ¶ˆæ¯æ¡†</em> ï¼ˆmboxï¼‰ã€‚ å‚ä¸è€…å¿…é¡»ä»mboxè®¢é˜…æ¶ˆæ¯ã€‚ å¦‚æœæ¼”å‘˜ä»mboxè®¢é˜…äº†ç‰¹å®šçš„æ¶ˆæ¯ç±»å‹ï¼Œå®ƒå°†æ”¶åˆ°è¯¥ç±»å‹çš„æ¶ˆæ¯ï¼š </p><br><p><img src="https://habrastorage.org/webt/o4/bf/ee/o4bfee0lp8hdvks68cas4yjlkgu.png"></p><br><p> è¿™ä¸€äº‹å®è‡³å…³é‡è¦ï¼Œå› ä¸ºæœ‰å¿…è¦å°†æ¶ˆæ¯ä»ä¸€ä¸ªé˜¶æ®µå‘é€åˆ°å¦ä¸€ä¸ªé˜¶æ®µã€‚ è¿™æ„å‘³ç€æ¯ä¸ªé˜¶æ®µéƒ½åº”è¯¥æœ‰å…¶mboxï¼Œå¹¶ä¸”ä¸Šä¸€ä¸ªé˜¶æ®µåº”è¯¥çŸ¥é“mboxã€‚ </p><br><p>  SObjectizerä¸­<em>çš„</em>æ¯ä¸ªactorï¼ˆakaä»£ç†ï¼‰éƒ½æœ‰<em>ç›´æ¥çš„mbox</em> ã€‚ è¯¥mboxä»…ä¸æ‰€æœ‰è€…ä»£ç†å…³è”ï¼Œå¹¶ä¸”ä¸èƒ½è¢«ä»»ä½•å…¶ä»–ä»£ç†ä½¿ç”¨ã€‚ ä¸ºé˜¶æ®µåˆ›å»ºçš„ä»£ç†çš„ç›´æ¥mboxå°†ç”¨äºé˜¶æ®µäº¤äº’ã€‚ </p><br><p> è¯¥SObjectizerçš„ç‰¹å®šåŠŸèƒ½è§„å®šäº†ä¸€äº›ç®¡é“å®ç°ç»†èŠ‚ã€‚ </p><br><p> é¦–å…ˆæ˜¯<em>èˆå°æ„å»ºå™¨</em>å…·æœ‰ä»¥ä¸‹åŸå‹çš„äº‹å®ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> builder(<span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp;, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span>);</code> </pre> <br><p> è¿™æ„å‘³ç€<em>é˜¶æ®µæ„å»ºå™¨å°†</em>æ¥æ”¶ä¸‹ä¸€ä¸ªé˜¶æ®µçš„mboxï¼Œå¹¶åº”åˆ›å»ºä¸€ä¸ªæ–°ä»£ç†ï¼Œè¯¥ä»£ç†ä¼šå°†é˜¶æ®µçš„ç»“æœå‘é€åˆ°è¯¥mboxã€‚  <em>é˜¶æ®µæ„å»ºå™¨</em>åº”è¿”å›æ–°ä»£ç†çš„mboxã€‚ è¯¥mboxå°†ç”¨äºåˆ›å»ºä¸Šä¸€é˜¶æ®µçš„ä»£ç†ã€‚ </p><br><p> ç¬¬äºŒä¸ªäº‹å®æ˜¯ï¼Œé˜¶æ®µä»£ç†å·²æŒ‰å¤‡ç”¨è®¢å•åˆ›å»ºã€‚ è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬æœ‰ç®¡é“ï¼š </p><br><pre> <code class="cpp hljs">stage(A) | stage(B) | stage(C)</code> </pre> <br><p> é¦–å…ˆåˆ›å»ºé˜¶æ®µCçš„ä»£ç†ï¼Œç„¶åå°†å…¶mboxç”¨äºé˜¶æ®µBçš„ä»£ç†åˆ›å»ºï¼Œç„¶åå°†Bé˜¶æ®µä»£ç†çš„mboxç”¨äºåˆ›å»ºé˜¶æ®µAçš„ä»£ç†ã€‚ </p><br><p> è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ <code>operator|()</code>ä¸ä¼šåˆ›å»ºä»£ç†ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span>{ [prev, next]( <span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> next_stage ) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> m = next.m_builder( coop, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(next_stage) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev.m_builder( coop, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(m) ); } }</code> </pre> <br><p>  <code>operator|()</code>åˆ›å»ºä¸€ä¸ªä»…è°ƒç”¨å…¶ä»–æ„å»ºå™¨ä½†ä¸å¼•å…¥å…¶ä»–ä»£ç†çš„æ„å»ºå™¨ã€‚ å› æ­¤ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼š </p><br><pre> <code class="cpp hljs">stage(A) | stage(B)</code> </pre> <br><p> ä»…å°†åˆ›å»ºä¸¤ä¸ªä»£ç†ï¼ˆç”¨äºAé˜¶æ®µå’ŒBé˜¶æ®µï¼‰ï¼Œç„¶ååœ¨<code>operator|()</code>åˆ›å»ºçš„<em>é˜¶æ®µæ„å»ºå™¨</em>ä¸­å°†å®ƒä»¬é“¾æ¥åœ¨ä¸€èµ·ã€‚ </p><br><h3 id="there-is-no-agent-for-broadcast-implementation"> æ²¡æœ‰ç”¨äº<code>broadcast()</code>å®ç°çš„ä»£ç† </h3><br><p> å®ç°å¹¿æ’­é˜¶æ®µçš„ä¸€ç§æ˜æ˜¾æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªç‰¹æ®Šä»£ç†ï¼Œè¯¥ä»£ç†å°†æ¥æ”¶ä¼ å…¥çš„æ¶ˆæ¯ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯é‡æ–°å‘é€åˆ°ç›®æ ‡mboxåˆ—è¡¨ã€‚ åœ¨æè¿°çš„ç®¡é“DSL <a href="">çš„ç¬¬ä¸€ä¸ªå®ç°</a>ä¸­<a href="">ä½¿ç”¨äº†</a>è¿™ç§æ–¹å¼ã€‚ </p><br><p> ä½†æ˜¯æˆ‘ä»¬çš„é…å¥—é¡¹ç›®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">so5extra</a>ç°åœ¨å…·æœ‰mboxçš„ä¸€ä¸ªç‰¹æ®Šå˜ä½“ï¼šå¹¿æ’­ä¸€ä¸ªã€‚ è¯¥mboxå®Œå…¨æ»¡è¶³æ­¤å¤„çš„è¦æ±‚ï¼šå®ƒæ¥æ”¶ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œå¹¶å°†å…¶ä¼ é€’åˆ°ä¸€ç»„ç›®æ ‡mboxã€‚ </p><br><p> å› æ­¤ï¼Œæ— éœ€åˆ›å»ºå•ç‹¬çš„å¹¿æ’­ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä»…ä½¿ç”¨so5extraçš„å¹¿æ’­mboxï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // A special mbox for broadcasting of a message to a set of destination // mboxes. // using broadcast_mbox_t = so_5::extra::mboxes::broadcast::fixed_mbox_template_t&lt;&gt;; ... // // Inside the broadcast() function: // stage_builder_t builder{ [broadcasts = collect_sink_builders( move(first), forward&lt; Rest &gt;(stages)...)] ( coop_t &amp; coop, mbox_t ) -&gt; mbox_t { vector&lt; mbox_t &gt; mboxes; mboxes.reserve( broadcasts.size() ); for( const auto &amp; b : broadcasts ) mboxes.emplace_back( b( coop, mbox_t{} ) ); // That is the creation of broadcasting mbox instance. return broadcast_mbox_t::make( coop.environment(), std::move(mboxes) ); } };</span></span></code> </pre> <br><h3 id="implementation-of-stage-agent"> å®æ–½é˜¶æ®µä»£ç† </h3><br><p> ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹é˜¶æ®µä»£ç†çš„å®ç°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// // An agent which will be used as intermediate or terminal pipeline stage. // It will receive input message, call the stage handler and pass // handler result to the next stage (if any). // template&lt; typename In, typename Out &gt; class a_stage_point_t final : public agent_t { public : a_stage_point_t( context_t ctx, stage_handler_t&lt; In, Out &gt; handler, mbox_t next_stage ) : agent_t{ ctx } , m_handler{ move( handler ) } , m_next{ move(next_stage) } {} void so_define_agent() override { if( m_next ) // Because there is the next stage the appropriate // message handler will be used. so_subscribe_self().event( [=]( const In &amp; evt ) { auto r = m_handler( evt ); if( r ) so_5::send( m_next, r ); } ); else // There is no next stage. A very simple message handler // will be used for that case. so_subscribe_self().event( [=]( const In &amp; evt ) { m_handler( evt ); } ); } private : const stage_handler_t&lt; In, Out &gt; m_handler; const mbox_t m_next; }; // // A specialization of a_stage_point_t for the case of terminal stage of // a pipeline. This type will be used for stage handlers with void // return type. // template&lt; typename In &gt; class a_stage_point_t&lt; In, void &gt; final : public agent_t { public : a_stage_point_t( context_t ctx, stage_handler_t&lt; In, void &gt; handler, mbox_t next_stage ) : agent_t{ ctx } , m_handler{ move( handler ) } { if( next_stage ) throw std::runtime_error( "sink point cannot have next stage" ); } void so_define_agent() override { so_subscribe_self().event( [=]( const In &amp; evt ) { m_handler( evt ); } ); } private : const stage_handler_t&lt; In, void &gt; m_handler; };</span></span></code> </pre> <br><p> å¦‚æœæ‚¨äº†è§£SObjectizerçš„åŸºç¡€çŸ¥è¯†ï¼Œé‚£å°†æ˜¯å¾®ä¸è¶³é“çš„ã€‚ å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆå¾ˆéš¾ç”¨å‡ å¥è¯æ¥è§£é‡Šï¼ˆæ‰€ä»¥è¯·éšæ—¶åœ¨è¯„è®ºä¸­æé—®ï¼‰ã€‚ </p><br><p>  <code>a_stage_point_t</code>ä»£ç†çš„ä¸»è¦å®ç°åˆ›å»ºå¯¹Inç±»å‹æ¶ˆæ¯çš„é¢„è®¢ã€‚ å½“æ­¤ç±»æ¶ˆæ¯åˆ°è¾¾æ—¶ï¼Œå°†è°ƒç”¨<em>é˜¶æ®µå¤„ç†ç¨‹åº</em> ã€‚ å¦‚æœ<em>é˜¶æ®µå¤„ç†ç¨‹åº</em>è¿”å›å®é™…ç»“æœï¼Œåˆ™å°†ç»“æœå‘é€åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µï¼ˆå¦‚æœå­˜åœ¨è¯¥é˜¶æ®µï¼‰ã€‚ </p><br><p> å½“ç›¸åº”çš„é˜¶æ®µæ˜¯ç»ˆç«¯é˜¶æ®µè€Œæ²¡æœ‰ä¸‹ä¸€ä¸ªé˜¶æ®µæ—¶ï¼Œè¿˜æœ‰<code>a_stage_point_t</code>çš„ç‰ˆæœ¬ã€‚ </p><br><p>  <code>a_stage_point_t</code>çš„å®ç°å¯èƒ½çœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†æ˜¯è¯·ç›¸ä¿¡æˆ‘ï¼Œå®ƒæ˜¯æˆ‘ç¼–å†™çš„æœ€ç®€å•çš„ä»£ç†ä¹‹ä¸€ã€‚ </p><br><h2 id="make_pipeline-function">  make_pipelineï¼ˆï¼‰å‡½æ•° </h2><br><p> ç°åœ¨è¯¥è®¨è®ºæœ€åä¸€ä¸ªç®¡é“æ„å»ºå‡½æ•°<code>make_pipeline()</code> ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args &gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> make_pipeline( <span class="hljs-comment"><span class="hljs-comment">// SObjectizer Environment to work in. so_5::environment_t &amp; env, // Definition of a pipeline. stage_t&lt; In, Out &gt; &amp;&amp; sink, // Optional args to be passed to make_coop() function. Args &amp;&amp;... args ) { auto coop = env.make_coop( forward&lt; Args &gt;(args)... ); auto mbox = sink.m_builder( *coop, mbox_t{} ); env.register_coop( move(coop) ); return mbox; }</span></span></code> </pre> <br><p> è¿™é‡Œæ²¡æœ‰é­”æœ¯ï¼Œä¹Ÿæ²¡æœ‰æƒŠå–œã€‚ æˆ‘ä»¬åªéœ€è¦ä¸ºç®¡é“çš„åº•å±‚ä»£ç†åˆ›å»ºä¸€ä¸ªæ–°çš„åˆä½œç¤¾ï¼Œé€šè¿‡è°ƒç”¨é¡¶çº§<em>é˜¶æ®µæ„å»ºå™¨</em>å°†è¯¥åˆä½œç¤¾å¡«å……åˆ°ä»£ç†ä¸­ï¼Œç„¶åå°†è¯¥åˆä½œç¤¾æ³¨å†Œåˆ°SObjectizerä¸­å³å¯ã€‚ å°±è¿™æ · </p><br><p>  <code>make_pipeline()</code>çš„ç»“æœæ˜¯<code>make_pipeline()</code>æœ€å·¦ä¾§ï¼ˆç¬¬ä¸€çº§<code>make_pipeline()</code>çš„mboxã€‚ è¯¥mboxåº”è¯¥ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ°ç®¡é“ã€‚ </p><br><h1 id="the-simulation-and-experiments-with-it"> ä»¿çœŸä¸å®éªŒ </h1><br><p> å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†åº”ç”¨ç¨‹åºé€»è¾‘çš„æ•°æ®ç±»å‹å’Œå‡½æ•°ï¼Œä»¥åŠå°†è¿™äº›å‡½æ•°é“¾æ¥åˆ°æ•°æ®å¤„ç†ç®¡é“çš„å·¥å…·ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç»“æœï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Launch SObjectizer in a separate thread. wrapped_env_t sobj; // Make a pipeline. auto pipeline = make_pipeline( sobj.environment(), stage(validation) | stage(conversion) | broadcast( stage(archiving), stage(distribution), stage(range_checking) | stage(alarm_detector{}) | broadcast( stage(alarm_initiator), stage( []( const alarm_detected &amp; v ) { alarm_distribution( cerr, v ); } ) ) ) ); // Send messages to a pipeline in a loop with 10ms delays. for( uint8_t i = 0; i &lt; static_cast&lt; uint8_t &gt;(250); i += 10 ) { send&lt; raw_value &gt;( pipeline, raw_measure{ 0, 0, i } ); std::this_thread::sleep_for( chrono::milliseconds{10} ); } }</span></span></code> </pre> <br><p> å¦‚æœè¿è¡Œè¯¥ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š </p><br><pre> <code class="plaintext hljs">archiving (0,0) distributing (0,0) archiving (0,5) distributing (0,5) archiving (0,10) distributing (0,10) archiving (0,15) distributing (0,15) archiving (0,20) distributing (0,20) archiving (0,25) distributing (0,25) archiving (0,30) distributing (0,30) ... archiving (0,105) distributing (0,105) archiving (0,110) distributing (0,110) === alarm (0) === alarm_distribution (0) archiving (0,115) distributing (0,115) archiving (0,120) distributing (0,120) === alarm (0) === alarm_distribution (0)</code> </pre> <br><p> å¯ä»¥ç”¨ </p><br><p> ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„ç®¡é“çš„å„ä¸ªé˜¶æ®µä¼¼ä¹ç›¸ç»§å·¥ä½œï¼Œä¸æ˜¯å—ï¼Ÿ </p><br><p> æ˜¯çš„ï¼Œæ˜¯çš„ã€‚ è¿™æ˜¯å› ä¸ºæ‰€æœ‰ç®¡é“ä»£ç†éƒ½ç»‘å®šåˆ°é»˜è®¤çš„SObjectizerçš„è°ƒåº¦ç¨‹åºã€‚ è¯¥è°ƒåº¦ç¨‹åºä»…ä½¿ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰ä»£ç†çš„æ¶ˆæ¯å¤„ç†ã€‚ </p><br><p> ä½†è¿™å¾ˆå®¹æ˜“æ”¹å˜ã€‚ åªéœ€å°†å¦ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™<code>make_pipeline()</code>è°ƒç”¨å³å¯ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Make a pipeline. auto pipeline = make_pipeline( sobj.environment(), stage(validation) | stage(conversion) | broadcast( stage(archiving), stage(distribution), stage(range_checking) | stage(alarm_detector{}) | broadcast( stage(alarm_initiator), stage( []( const alarm_detected &amp; v ) { alarm_distribution( cerr, v ); } ) ) ), disp::thread_pool::make_dispatcher( sobj.environment() ).binder( disp::thread_pool::bind_params_t{}.fifo( disp::thread_pool::fifo_t::individual ) ) );</span></span></code> </pre> <br><p> è¿™å°†åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ± ï¼Œå¹¶å°†æ‰€æœ‰ç®¡é“ä»£ç†ç»‘å®šåˆ°è¯¥æ± ã€‚ æ¯ä¸ªä»£ç†å°†ç‹¬ç«‹äºå…¶ä»–ä»£ç†ç”±æ± æœåŠ¡ã€‚ </p><br><p> å¦‚æœè¿è¡Œä¿®æ”¹åçš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç±»ä¼¼çš„å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs">archiving (0,0) distributing (0,0) distributing (0,5) archiving (0,5) archiving (0,10) distributing (0,10) distributing (archiving (0,15) 0,15) archiving (0,20) distributing (0,20) archiving (0,25) distributing (0,25) archiving (0,distributing (030) ,30) ... archiving (0,distributing (0,105) 105) archiving (0,alarm_distribution (0) distributing (0,=== alarm (0) === 110) 110) archiving (distributing (0,0,115) 115) archiving (distributing (=== alarm (0) === 0alarm_distribution (0) 0,120) ,120)</code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç®¡é“çš„ä¸åŒé˜¶æ®µå¹¶è¡Œå·¥ä½œã€‚ </p><br><p> ä½†æ˜¯æ˜¯å¦å¯ä»¥èµ°å¾—æ›´è¿œï¼Œå¹¶æœ‰èƒ½åŠ›å°†é˜¶æ®µç»‘å®šåˆ°ä¸åŒçš„è°ƒåº¦ç¨‹åºï¼Ÿ </p><br><p> æ˜¯çš„ï¼Œè¿™æ˜¯å¯èƒ½çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»ä¸º<code>stage()</code>å‡½æ•°å®ç°å¦ä¸€ä¸ªé‡è½½ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Callable, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> In = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-keyword"><span class="hljs-keyword">callable_traits_t</span></span>&lt; Callable &gt;::arg_type, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Out = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-keyword"><span class="hljs-keyword">callable_traits_t</span></span>&lt; Callable &gt;::result_type &gt; <span class="hljs-keyword"><span class="hljs-keyword">stage_t</span></span>&lt; In, Out &gt; stage( <span class="hljs-keyword"><span class="hljs-keyword">disp_binder_shptr_t</span></span> disp_binder, Callable handler ) { <span class="hljs-keyword"><span class="hljs-keyword">stage_builder_t</span></span> builder{ [binder = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(disp_binder), h = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(handler)]( <span class="hljs-keyword"><span class="hljs-keyword">coop_t</span></span> &amp; coop, <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> next_stage) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">mbox_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coop.make_agent_with_binder&lt; <span class="hljs-keyword"><span class="hljs-keyword">a_stage_point_t</span></span>&lt;In, Out&gt; &gt;( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(binder), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(h), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(next_stage) ) -&gt;so_direct_mbox(); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(builder) }; }</code> </pre> <br><p> This version of <code>stage()</code> accepts not only a <em>stage handler</em> but also a dispatcher binder. Dispatcher binder is a way to bind an agent to the particular dispatcher. So to assign a stage to a specific working context we can create an appropriate dispatcher and then pass the binder to that dispatcher to <code>stage()</code> function. Let's do that: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// An active_obj dispatcher to be used for some stages. auto ao_disp = disp::active_obj::make_dispatcher( sobj.environment() ); // Make a pipeline. auto pipeline = make_pipeline( sobj.environment(), stage(validation) | stage(conversion) | broadcast( stage(ao_disp.binder(), archiving), stage(ao_disp.binder(), distribution), stage(range_checking) | stage(alarm_detector{}) | broadcast( stage(ao_disp.binder(), alarm_initiator), stage(ao_disp.binder(), []( const alarm_detected &amp; v ) { alarm_distribution( cerr, v ); } ) ) ), disp::one_thread::make_dispatcher( sobj.environment() ).binder() );</span></span></code> </pre> <br><p> In that case stages <code>archiving</code> , <code>distribution</code> , <code>alarm_initiator</code> and <code>alarm_distribution</code> will work on own worker threads. All other stages will work on the same single worker thread. </p><br><h1 id="the-conclusion"> The conclusion </h1><br><p> This was an interesting experiment and I was surprised how easy SObjectizer could be used in something like reactive programming or data-flow programming. </p><br><p> However, I don't think that pipeline DSL can be practically meaningful. It's too simple and, maybe not flexible enough. But, I hope, it can be a base for more interesting experiments for those why need to deal with different workflows and data-processing pipelines. At least as a base for some ideas in that area. C++ language a rather good here and some (not so complicated) template magic can help to catch various errors at compile-time. </p><br><p> In conclusion, I want to say that we see SObjectizer not as a specialized tool for solving a particular problem, but as a basic set of tools to be used in solutions for different problems. And, more importantly, that basic set can be extended for your needs. Just take a look at <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SObjectizer</a> , try it, and share your feedback. Maybe you missed something in SObjectizer? Perhaps you don't like something? <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Tell us</a> , and we can try to help you. </p><br><p> If you want to help further development of SObjectizer, please share a reference to it or to this article somewhere you want (Reddit, HackerNews, LinkedIn, Facebook, Twitter, ...). The more attention and the more feedback, the more new features will be incorporated into SObjectizer. </p><br><p> And many thanks for reading this ;) </p><br><p>  PSã€‚ The source code for that example can be found in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">that repository</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460123/">https://habr.com/ru/post/zh-CN460123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460113/index.html">æœ‰å…³JSOC CERTæˆ–Unbanalæ³•åŒ»å­¦çš„ä¸€äº›æ•…äº‹</a></li>
<li><a href="../zh-CN460115/index.html">Erlangåå¹´ç¼–ç¨‹</a></li>
<li><a href="../zh-CN460117/index.html">ä¿„ç½—æ–¯æœ€å¤§çš„å®¢æˆ·æ˜¯ä¸­å¥–è¿˜æ˜¯å¤´ç—›ï¼Ÿ AGIMAç»éªŒ</a></li>
<li><a href="../zh-CN460119/index.html">ç”±äºæœªä½¿ç”¨é™æ€ä»£ç åˆ†æè€Œæ— æ³•æ‰¾åˆ°çš„é”™è¯¯</a></li>
<li><a href="../zh-CN460121/index.html">ç”±äºæœªä½¿ç”¨é™æ€ä»£ç åˆ†æè€Œæ— æ³•æ‰¾åˆ°çš„é”™è¯¯</a></li>
<li><a href="../zh-CN460125/index.html">Node.jsæˆ–Javaï¼šæ€§èƒ½ï¼Œèµ„æºï¼Œæµæ§åˆ¶ï¼Œå—æ¬¢è¿ç¨‹åº¦å’Œä¸ªäººç»éªŒ</a></li>
<li><a href="../zh-CN460129/index.html">æœºå™¨äººå’Œè‰è“ï¼šäººå·¥æ™ºèƒ½å¦‚ä½•æé«˜ç”°é—´äº§é‡</a></li>
<li><a href="../zh-CN460131/index.html">Sophos XG Firewallï¼šä»ç»å…¸çš„MEåˆ°NGFWï¼Œå¯è‡ªåŠ¨å“åº”ä¿¡æ¯å®‰å…¨äº‹ä»¶</a></li>
<li><a href="../zh-CN460133/index.html">Kotlin / Everywhere-å±•ç¤ºæ´»åŠ¨ï¼š7æœˆ31æ—¥</a></li>
<li><a href="../zh-CN460135/index.html">å®‰å…¨å‘¨29ï¼šç¼©æ”¾ï¼Œå®‰å…¨å’Œæˆå‰§æ€§æ¼æ´</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>