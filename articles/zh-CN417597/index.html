<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♀️ 🖕 👼 具有DRBD9和Proxmox的可信存储（第2部分：iSCSI + LVM） 🌷 🕊️ 💖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在上一篇文章中，我研究了使用DRBD和Proxmox创建容错NFS服务器的可能性。 事实证明还不错，但是我们不会为获得桂冠而休息，现在我们将尝试从存储中“榨出所有果汁”。 


在本文中，我将告诉您如何以这种方式创建容错iSCSI目标，我们将使用LVM将其切成小块并将其用于虚拟机。 


 这种方法...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>具有DRBD9和Proxmox的可信存储（第2部分：iSCSI + LVM）</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417597/"><p><img src="https://habrastorage.org/getpro/habr/post_images/101/70c/524/10170c52443d67bd757a09ef22ba39e2.jpg" alt="图片"></p><br><p> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一篇文章中，</a>我研究了使用DRBD和Proxmox创建容错NFS服务器的可能性。 事实证明还不错，但是我们不会为获得桂冠而休息，现在我们将尝试从存储中“榨出所有果汁”。 </p><br><p>在本文中，我将告诉您如何以这种方式创建容错iSCSI目标，我们将使用LVM将其切成小块并将其用于虚拟机。 </p><br><p> 这种方法将减少负载并提高数次访问数据的速度，这在不需要竞争性访问数据的情况下（例如，当您需要为虚拟机组织存储时）特别有用。 </p><a name="habracut"></a><br><h2 id="para-slov-o-drbd"> 关于DRBD的几句话 </h2><br><p>  DRBD是一个相当简单和成熟的解决方案，第八版代码被用作Linux内核的一部分。 实际上，它代表网络镜像RAID1。 第九版引入了对具有两个以上节点的仲裁和复制的支持。 </p><br><p> 实际上，它允许您将多个物理节点上的块设备组合到一个公用共享网络中。 </p><br><p> 使用DRBD，您可以实现非常有趣的配置。 今天我们将讨论iSCSI和LVM。 </p><br><p> 更多关于他的，你可以通过阅读我的学习<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">以前的文章中</a> ，我在那里所描述的决定。 </p><br><h2 id="para-slov-ob-iscsi"> 关于iSCSI的几句话 </h2><br><p>  iSCSI是网络上的块设备传送协议。 </p><br><p> 与NBD不同，它支持授权，可以毫无问题地解决网络故障，并支持许多其他有用的功能，最重要的是，它具有非常好的性能。 </p><br><p> 它的实现方式很多，其中一些也包含在内核中，对其配置和连接没有特殊的要求。 </p><br><h2 id="para-slov-ob-lvm"> 关于LVM的几句话 </h2><br><p> 值得一提的是，LINBIT为Proxmox提供了自己的解决方案，它应该开箱即用，并可以实现类似的结果，但是在本文中，我不想只关注Proxmox并描述一些适​​用于Proxmox和Proxmox的通用解决方案。在此示例中，proxmox仅用作容器编排的一种方式，实际上，您可以将其替换为另一种解决方案，例如，在Kubernetes中使用目标启动容器。 </p><br><p> 特别是对于Proxmox，它仅使用自己的标准驱动程序就可以与共享LUN和LVM正常工作。 </p><br><p>  LVM的优点包括以下事实：它的使用不是革命性的新事物，并且无法充分磨合，但是相反，它显示出干燥稳定性，这通常是存储所需的。 值得一提的是，LVM在其他环境中非常活跃，例如在OpenNebula或Kubernetes中，并得到了很好的支持。 </p><br><p> 因此，您将获得仅在使用现成的驱动程序即可用于不同系统（不仅在proxmox中）的通用存储，而无需使用文件进行任何特殊修改。 </p><br><p> 不幸的是，在选择存储解决方案时，您总是必须做出一些妥协。 因此，在这里，这种解决方案不会像Ceph那样给您带来灵活性。 <br> 虚拟磁盘的大小受LVM组的大小限制，并且必须重新分配为特定虚拟磁盘标记的区域-这大大提高了访问数据的速度，但不允许进行精简配置（当虚拟磁盘占用的空间少于实际空间时）。 值得一提的是，使用快照时LVM的性能下降很多，因此通常消除了自由使用快照的可能性。 </p><br><p> 是的，LVM支持没有此缺点的精简配置池，但是不幸的是，它们只能在单个节点的上下文中使用，并且无法将一个精简配置池共享到群集中的多个节点中。 </p><br><p> 尽管存在这些缺点，但由于其简单性，LVM仍然不允许竞争对手绕过它并将其完全推离战场。 </p><br><p>  LVM的开销很小，仍然提供了非常快速，稳定和相当灵活的解决方案。 </p><br><h1 id="obschaya-shema"> 一般方案 </h1><br><ul><li> 我们有<strong>三个节点</strong> </li><li> 每个节点都有一个分布式<strong>drbd设备</strong> 。 </li><li> 在drbd设备的顶部，启动了具有iSCSI目标的<strong>LXC容器</strong> 。 </li><li> 目标连接到所有三个节点。 </li><li> 已在连接的目标上创建一个<strong>LVM组</strong> 。 </li><li> 如有必要， <strong>LXC容器</strong>可以与<strong>iSCSI目标</strong>一起移动到另一个节点 </li></ul><br><h1 id="nastroyka"> 客制化 </h1><br><p> 我们现在想出了主意，让我们继续执行。 </p><br><p> 默认情况下<strong>，</strong> <strong>Linux内核</strong>提供<strong>了</strong> <strong>drbd的第八个版本</strong> ，不幸的是它不<strong>适合</strong>我们，我们需要安装模块的第九个版本。 </p><br><p> 连接LINBIT存储库并安装所需的一切： </p><br><pre><code class="bash hljs">wget -O- https://packages.linbit.com/package-signing-pubkey.asc | apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.linbit.com/proxmox/ proxmox-5 drbd-9.0"</span></span> \ &gt; /etc/apt/sources.list.d/linbit.list apt-get update &amp;&amp; apt-get -y install pve-headers drbd-dkms drbd-utils drbdtop</code> </pre> <br><ul><li>  <code>pve-headers</code> -必要的内核头文件的模块组装 </li><li>  <code>drbd-dkms</code> -DKMS格式的内核模块 </li><li>  <code>drbd-utils</code>基本的DRBD管理实用程序 </li><li>  <code>drbdtop</code>是仅用于DRBD的交互式工具，如top </li></ul><br><p> 安装<strong>模块后，</strong>检查是否一切正常： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># modprobe drbd # cat /proc/drbd version: 9.0.14-1 (api:2/proto:86-113)</span></span></code> </pre> <br><p> 如果在命令的输出中看到<strong>第八个版本</strong> ，则出了点问题，并且<strong>树内</strong>内核模块已加载。 检查<code>dkms status</code>找出原因。 </p><br><p> 我们拥有的每个节点都将在常规分区之上运行相同的<strong>drbd设备</strong> 。 首先，我们需要为每个节点上的drbd准备本节。 </p><br><p> 这样的分区可以是任何<strong>块设备</strong> ，可以是lvm，zvol，磁盘分区或整个磁盘。 在本文中，我将使用单独的nvme磁盘，并在drbd下使用一个分区： <code>/dev/nvme1n1p1</code> </p><br><p> 值得注意的是，设备名称有时会更改，因此最好立即养成对设备使用恒定符号链接的习惯。 </p><br><p> 查找符号链接<code>/dev/nvme1n1p1</code>可以如下： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find /dev/disk/ -lname '*/nvme1n1p1' /dev/disk/by-partuuid/847b9713-8c00-48a1-8dff-f84c328b9da2 /dev/disk/by-path/pci-0000:0e:00.0-nvme-1-part1 /dev/disk/by-id/nvme-eui.0000000001000000e4d25c33da9f4d01-part1 /dev/disk/by-id/nvme-INTEL_SSDPEKKA010T7_BTPY703505FB1P0H-part1</span></span></code> </pre> <br><p> 我们在所有三个节点上描述我们的资源： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/drbd.d/tgt1.res resource tgt1 { meta-disk internal; device /dev/drbd100; protocol C; net { after-sb-0pri discard-zero-changes; after-sb-1pri discard-secondary; after-sb-2pri disconnect; } on pve1 { address 192.168.2.11:7000; disk /dev/disk/by-partuuid/95e7eabb-436e-4585-94ea-961ceac936f7; node-id 0; } on pve2 { address 192.168.2.12:7000; disk /dev/disk/by-partuuid/aa7490c0-fe1a-4b1f-ba3f-0ddee07dfee3; node-id 1; } on pve3 { address 192.168.2.13:7000; disk /dev/disk/by-partuuid/847b9713-8c00-48a1-8dff-f84c328b9da2; node-id 2; } connection-mesh { hosts pve1 pve2 pve3; } }</span></span></code> </pre> <br><p> 建议使用<strong>单独的网络</strong>进行drbd同步。 </p><br><p> 现在为drbd创建元数据并运行它： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># drbdadm create-md tgt1 initializing activity log initializing bitmap (320 KB) to all zero Writing meta data... New drbd meta data block successfully created. success # drbdadm up tgt1</span></span></code> </pre> <br><p> 在所有三个节点上重复这些步骤，并检查状态： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># drbdadm status tgt1 role:Secondary disk:Inconsistent pve2 role:Secondary peer-disk:Inconsistent pve3 role:Secondary peer-disk:Inconsistent</span></span></code> </pre> <br><p> 现在，我们的<strong>不一致</strong>磁盘位于所有三个节点上，这是因为drbd不知道应将哪个磁盘作为原始磁盘。 我们必须将其中一个标记为“ <strong>主要”，</strong>以便其状态与其他节点同步： </p><br><pre> <code class="bash hljs">drbdadm primary --force tgt1 drbdadm secondary tgt1</code> </pre> <br><p> 此后， <strong>同步</strong>将立即开始： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># drbdadm status tgt1 role:Secondary disk:UpToDate pve2 role:Secondary replication:SyncSource peer-disk:Inconsistent done:26.66 pve3 role:Secondary replication:SyncSource peer-disk:Inconsistent done:14.20</span></span></code> </pre><br><p> 我们不必等待它完成，我们可以并行执行其他步骤。 它们可以在<strong>任何节点</strong>上执行，而不管其在DRBD中本地磁盘的当前状态如何。 所有请求将自动重定向到状态为<strong>UpToDate</strong>的设备。 </p><br><p> 不要忘记在节点上激活drbd服务的<strong>自动运行</strong> ： </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> drbd.service</code> </pre> <br><h2 id="nastroyka-lxc-konteynera"> 配置LXC容器 </h2><br><p> 我们<strong>将</strong>省略由三个节点组成的<strong>Proxmox集群</strong>的配置部分，该部分在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方Wiki中</a>有充分描述 </p><br><p> 如前所述，我们的<strong>iSCSI目标</strong>将在<strong>LXC容器中工作</strong> 。 我们将继续在设备上的容器<code>/dev/drbd100</code> ，我们刚刚创建的。 </p><br><p> 首先，我们需要在其上创建一个<strong>文件系统</strong> ： </p><br><pre> <code class="hljs powershell">mkfs <span class="hljs-literal"><span class="hljs-literal">-t</span></span> ext4 <span class="hljs-literal"><span class="hljs-literal">-O</span></span> mmp <span class="hljs-literal"><span class="hljs-literal">-E</span></span> mmp_update_interval=<span class="hljs-number"><span class="hljs-number">5</span></span> /dev/drbd100</code> </pre> <br><p> 默认情况下， <strong>Proxmox</strong>在文件系统级别包括<strong>多重安装保护</strong> ，原则上我们可以不用它，因为 默认情况下，DRBD具有其自身的保护，它仅禁止该设备使用第二个<strong>主要</strong>对象，但谨慎并不会伤害我们。 </p><br><p> 现在下载Ubuntu模板： </p><br><pre> <code class="hljs pgsql"># wget http://download.proxmox.com/images/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/ubuntu<span class="hljs-number"><span class="hljs-number">-16.04</span></span>-standard_16<span class="hljs-number"><span class="hljs-number">.04</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>_amd64.tar.gz -P /var/lib/vz/<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/</code> </pre> <br><p> 并从中创建我们的容器： </p><br><pre> <code class="hljs powershell">pct create <span class="hljs-number"><span class="hljs-number">101</span></span> local:vztmpl/ubuntu<span class="hljs-literal"><span class="hljs-literal">-16</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-literal"><span class="hljs-literal">-standard_16</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span><span class="hljs-literal"><span class="hljs-literal">-1_amd64</span></span>.tar.gz \ -<span class="hljs-literal"><span class="hljs-literal">-hostname</span></span>=tgt1 \ -<span class="hljs-literal"><span class="hljs-literal">-net0</span></span>=name=eth0,bridge=vmbr0,gw=<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span>,ip=<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">1.11</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> \ -<span class="hljs-literal"><span class="hljs-literal">-rootfs</span></span>=volume=/dev/drbd100,shared=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p> 在此命令中，我们指示容器的<strong>根系统</strong>将位于设备<code>/dev/drbd100</code>并添加参数<code>shared=1</code>以允许容器在节点之间<strong>迁移</strong> 。 </p><br><p> 如果出现问题，您可以随时通过<strong>Proxmox</strong>界面或在<code>/etc/pve/lxc/101.conf</code>容器<code>/etc/pve/lxc/101.conf</code>中对其进行<code>/etc/pve/lxc/101.conf</code> </p><br><p>  Proxmox将解压缩模板并为我们准备容器<strong>根系统</strong> 。 之后，我们可以启动我们的容器： </p><br><pre> <code class="hljs pgsql">pct <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span></code> </pre> <br><h2 id="nastroyka-iscsi-targeta"> 配置iSCSI目标。 </h2><br><p> 在所有<strong>目标中</strong> ，我选择<strong>istgt</strong> ，因为它具有最高的性能并且可以在用户空间中工作。 </p><br><p> 现在，我们登录到容器： </p><br><pre> <code class="hljs perl">pct <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> <span class="hljs-number"><span class="hljs-number">101</span></span> bash</code> </pre> <br><p> 安装更新和<strong>istgt</strong> ： </p><br><pre> <code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y <span class="hljs-keyword"><span class="hljs-keyword">upgrade</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> istgt</code> </pre> <br><p> 创建一个我们将通过网络提供的文件： </p><br><pre> <code class="hljs powershell">mkdir <span class="hljs-literal"><span class="hljs-literal">-p</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> fallocate <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">740</span></span>G /<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/target1.img</code> </pre> <br><p> 现在我们需要为<strong>istgt</strong> <code>/etc/istgt/istgt.conf</code>编写一个配置： </p><br><pre> <code class="hljs sql">[Global] <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-string"><span class="hljs-string">"Global section"</span></span> NodeBase <span class="hljs-string"><span class="hljs-string">"iqn.2018-07.org.example.tgt1"</span></span> PidFile /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/istgt.pid AuthFile /etc/istgt/auth.conf MediaDirectory /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/istgt LogFacility <span class="hljs-string"><span class="hljs-string">"local7"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Timeout</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> NopInInterval <span class="hljs-number"><span class="hljs-number">20</span></span> DiscoveryAuthMethod <span class="hljs-keyword"><span class="hljs-keyword">Auto</span></span> MaxSessions <span class="hljs-number"><span class="hljs-number">16</span></span> MaxConnections <span class="hljs-number"><span class="hljs-number">4</span></span> MaxR2T <span class="hljs-number"><span class="hljs-number">32</span></span> MaxOutstandingR2T <span class="hljs-number"><span class="hljs-number">16</span></span> DefaultTime2Wait <span class="hljs-number"><span class="hljs-number">2</span></span> DefaultTime2Retain <span class="hljs-number"><span class="hljs-number">60</span></span> FirstBurstLength <span class="hljs-number"><span class="hljs-number">262144</span></span> MaxBurstLength <span class="hljs-number"><span class="hljs-number">1048576</span></span> MaxRecvDataSegmentLength <span class="hljs-number"><span class="hljs-number">262144</span></span> InitialR2T Yes ImmediateData Yes DataPDUInOrder Yes DataSequenceInOrder Yes ErrorRecoveryLevel <span class="hljs-number"><span class="hljs-number">0</span></span> [UnitControl] <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-string"><span class="hljs-string">"Internal Logical Unit Controller"</span></span> AuthMethod CHAP Mutual AuthGroup AuthGroup10000 Portal UC1 <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3261</span></span> Netmask <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> [PortalGroup1] <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-string"><span class="hljs-string">"SINGLE PORT TEST"</span></span> Portal DA1 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>:<span class="hljs-number"><span class="hljs-number">3260</span></span> [InitiatorGroup1] <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-string"><span class="hljs-string">"Initiator Group1"</span></span> InitiatorName <span class="hljs-string"><span class="hljs-string">"ALL"</span></span> Netmask <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> [LogicalUnit1] <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-string"><span class="hljs-string">"Hard Disk Sample"</span></span> TargetName disk1 TargetAlias <span class="hljs-string"><span class="hljs-string">"Data Disk1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Mapping</span></span> PortalGroup1 InitiatorGroup1 AuthMethod <span class="hljs-keyword"><span class="hljs-keyword">Auto</span></span> AuthGroup AuthGroup1 UseDigest <span class="hljs-keyword"><span class="hljs-keyword">Auto</span></span> UnitType Disk LUN0 <span class="hljs-keyword"><span class="hljs-keyword">Storage</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/target1.img <span class="hljs-keyword"><span class="hljs-keyword">Auto</span></span></code> </pre> <br><p> 重启istgt： </p><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> istgt</code> </pre> <br><p> 这样就完成了目标设置 </p><br><h2 id="nastroyka-ha">  HA设置 </h2><br><p> 现在我们可以去<strong>HA-经理</strong> kofiguratsii。 让我们为设备创建一个单独的HA组： </p><br><pre> <code class="hljs powershell">ha<span class="hljs-literal"><span class="hljs-literal">-manager</span></span> groupadd tgt1 -<span class="hljs-literal"><span class="hljs-literal">-nodes</span></span> pve1,pve2,pve3 -<span class="hljs-literal"><span class="hljs-literal">-nofailback</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> -<span class="hljs-literal"><span class="hljs-literal">-restricted</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p> 我们的<strong>资源</strong>将仅在为此组指定的节点上工作。 将我们的容器添加到该组： </p><br><pre> <code class="hljs powershell">ha<span class="hljs-literal"><span class="hljs-literal">-manager</span></span> add ct:<span class="hljs-number"><span class="hljs-number">101</span></span> -<span class="hljs-literal"><span class="hljs-literal">-group</span></span>=tgt1 -<span class="hljs-literal"><span class="hljs-literal">-max_relocate</span></span>=<span class="hljs-number"><span class="hljs-number">3</span></span> -<span class="hljs-literal"><span class="hljs-literal">-max_restart</span></span>=<span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><h2 id="rekomendacii-i-tyuning"> 建议和调优 </h2><br><h5 id="drbd"> 广播电视 </h5><br><p> 如上文所述，始终建议使用单独的网络进行复制。 强烈建议使用<strong>10 Gb网络适配器</strong> ，否则会遇到端口速度问题。 <br> 如果复制似乎足够慢，请尝试使用<strong>DRBD的</strong>某些选项。 这是配置，我认为这是我的<strong>10G网络的</strong>最佳配置： </p><br><pre> <code class="hljs swift"># cat /etc/drbd.d/global_common.conf global { usage-<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> yes; udev-always-use-vnr; } common { handlers { } startup { } options { } disk { <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>-fill-target 10M; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-rate 720M; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>-plan-ahead <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>-rate 20M; } net { <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-buffers 36k; sndbuf-size 1024k; rcvbuf-size 2048k; } }</code> </pre> <br><p> 您可以从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方DRBD文档中</a>获取有关每个参数的更多信息<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">。</a> </p><br><h5 id="open-iscsi"> 开启iSCSI </h5><br><p> 由于我们不使用多路径，因此在我们的情况下<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，建议</a>在客户端上禁用定期连接检查， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">并建议</a>在<code>/etc/iscsi/iscsid.conf</code>增加会话恢复的等待超时。 </p><br><pre> <code class="hljs powershell">node.conn[<span class="hljs-number"><span class="hljs-number">0</span></span>].timeo.noop_out_interval = <span class="hljs-number"><span class="hljs-number">0</span></span> node.conn[<span class="hljs-number"><span class="hljs-number">0</span></span>].timeo.noop_out_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span> node.session.timeo.replacement_timeout = <span class="hljs-number"><span class="hljs-number">86400</span></span></code> </pre> <br><h2 id="ispolzovanie"> 使用方法 </h2><br><h4 id="proxmox">  Proxmox </h4><br><p> 生成的<strong>iSCSI目标</strong>可以立即连接到Proxmox，而不必忘记取消选中<strong>直接使用LUN</strong> 。 </p><br><p><img src="https://habrastorage.org/webt/uw/j3/pu/uwj3pusr-nf9bc7neisd5x-fcsg.png"></p><br><p> 之后立即可以在其之上创建LVM，请不要忘记选中<strong>共享</strong>框： </p><br><p><img src="https://habrastorage.org/webt/j1/ob/mw/j1obmwcwhz-e6krjix72pmiz118.png"></p><br><h4 id="drugie-sredy"> 其他环境 </h4><br><p> 如果计划在不同的环境中使用此解决方案，则在有两种实现时，可能需要为LVM安装集群扩展。  <strong>CLVM</strong>和<strong>lvmlockd</strong> 。 </p><br><p> 设置<strong>CLVM</strong> sovesm不容易，而且需要一个工作集群管理器。 <br> 作为第二种方法， <strong>lvmlockd</strong>尚未经过全面测试，并且刚刚开始出现在稳定的存储库中。 </p><br><p> 我建议阅读<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>有关LVM中阻塞</strong></a>的出色<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>文章</strong></a> </p><br><p> 当将<strong>LVM</strong>与<strong>Proxmox</strong>一起使用时<strong>，</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">不需要</a>添加群集，因为卷管理是由proxmox本身提供的，它可以独立更新和监视LVM元数据。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方文档</a>明确指出， <strong>OpenNebula</strong>也是如此。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417597/">https://habr.com/ru/post/zh-CN417597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417587/index.html">媒体：大规模网络攻击加速了信息安全行业公司资本总额的增长</a></li>
<li><a href="../zh-CN417589/index.html">使所有人都可以访问Internet的七个简单规则</a></li>
<li><a href="../zh-CN417591/index.html">如何一年内自己“学习”英语，或者为那些不懂英语的人写一篇文章</a></li>
<li><a href="../zh-CN417593/index.html">NewSQL = NoSQL + ACID</a></li>
<li><a href="../zh-CN417595/index.html">古迹：Palm OS，高效的代码和令人反感的照片</a></li>
<li><a href="../zh-CN417599/index.html">金融科技摘要：金融监管机构需要AI才能在现代条件下工作</a></li>
<li><a href="../zh-CN417601/index.html">选择一个服务器。 寻找什么？ 检查清单</a></li>
<li><a href="../zh-CN417603/index.html">移动mitap的公告：应用程序变大后该怎么办？</a></li>
<li><a href="../zh-CN417605/index.html">3D打印的3D建模基础知识</a></li>
<li><a href="../zh-CN417607/index.html">A / B测试不起作用。 检查你做错了什么</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>