<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ฉ๐ฟโโ๏ธ ๐ ๐ ูู ุงุฑุชูุงุน ุฒูู ุงูุงูุชูุงู ุฅูู ุชุตุญูุญ Kernel ุจุงุณุชุฎุฏุงู eBPF / BCC ๐ซ ๐คฝ๐ฝ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุญุชูู Linux ุนูู ุนุฏุฏ ูุจูุฑ ูู ุฃุฏูุงุช ูุชุทุจููุงุช ุชุตุญูุญ ุฃุฎุทุงุก kernel. ุชุคุซุฑ ูุนุธููุง ุจุดูู ุณูุจู ุนูู ุฃุฏุงุก ุงูุชุทุจูู ููุง ูููู ุงุณุชุฎุฏุงููุง ูู ุงูุฅูุชุงุฌ. 

 ูุจู ุนุงููู ุ ุชู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูู ุงุฑุชูุงุน ุฒูู ุงูุงูุชูุงู ุฅูู ุชุตุญูุญ Kernel ุจุงุณุชุฎุฏุงู eBPF / BCC</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/458592/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/-8/ok/na/-8okna9qfyroicvgoz-zenv7-si.png" alt="ุตูุฑุฉ"><br><br>  ูุญุชูู Linux ุนูู ุนุฏุฏ ูุจูุฑ ูู ุฃุฏูุงุช ูุชุทุจููุงุช ุชุตุญูุญ ุฃุฎุทุงุก kernel.  ุชุคุซุฑ ูุนุธููุง ุจุดูู ุณูุจู ุนูู ุฃุฏุงุก ุงูุชุทุจูู ููุง ูููู ุงุณุชุฎุฏุงููุง ูู ุงูุฅูุชุงุฌ. <br><a name="habracut"></a><br>  ูุจู ุนุงููู ุ ุชู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุทููุฑ ุฃุฏุงุฉ ุฃุฎุฑู</a> - eBPF.  ูุฌุนู ูู ุงููููู ุชุชุจุน ุชุทุจููุงุช kernel ูุงููุณุชุฎุฏููู ูุน ุงูุฎูุงุถ ุงูุญูู ูุฏูู ุงูุญุงุฌุฉ ุฅูู ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุจุฑุงูุฌ ูุชุญููู ุงููุญุฏุงุช ุงูููุทูุฉ ูุฌูุฉ ุฎุงุฑุฌูุฉ ูู kernel. <br><br>  ููุฌุฏ ุงูุขู ุงูุนุฏูุฏ ูู ุฃุฏูุงุช ุงูุชุทุจูู ุงููุณุงุนุฏุฉ ุงูุชู ุชุณุชุฎุฏู eBPF ุ ููู ูุฐู ุงูููุงูุฉ ุณูุจุญุซ ูู ููููุฉ ูุชุงุจุฉ ุฃุฏุงุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชูุตูู</a> ุงูุฎุงุตุฉ ุจูุง ุงุณุชูุงุฏูุง ุฅูู ููุชุจุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">PythonBCC</a> .  ูุณุชูุฏ ุงูููุงู ุฅูู ุฃุญุฏุงุซ ุญููููุฉ.  ุณููุชูู ูู ุธููุฑ ุงููุดููุฉ ุฅูู ุชุตุญูุญูุง ูุฅุธูุงุฑ ููููุฉ ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ุงูููุฌูุฏุฉ ูู ููุงูู ูุญุฏุฏุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  Ceph ุจุทูุก </h2><br>  ุชูุช ุฅุถุงูุฉ ูุถูู ุฌุฏูุฏ ุฅูู ูุชูุฉ Ceph.  ุจุนุฏ ููู ุจุนุถ ุงูุจูุงูุงุช ุฅูููุง ุ ูุงุญุธูุง ุฃู ุณุฑุนุฉ ูุนุงูุฌุฉ ุทูุจุงุช ุงููุชุงุจุฉ ุฃูู ุจูุซูุฑ ูู ุฎูุงุฏู ุฃุฎุฑู. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/4c/_r/yv/4c_ryvapivstw8l-nr7dipfvh8e.png"></div><br>  ุนูู ุนูุณ ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ ุงูุฃุฎุฑู ุ ุชู ุงุณุชุฎุฏุงู bcache ู linux 4.15 kernel ุงูุฌุฏูุฏ ุนูู ูุฐุง ุงููุถูู.  ุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูู ูุฐุง ุงูุชูููู ููุง ูุฃูู ูุฑุฉ.  ููู ุฐูู ุงูููุช ูุงู ูู ุงููุงุถุญ ุฃู ุฃู ุดูุก ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ูููู ุฃู ูููู ุฃุตู ุงููุดููุฉ. <br><br><h3 style=";text-align:right;direction:rtl">  ุงูุชุญููู ูู ุงููุถูู </h3><br>  ุจุงุฏุฆ ุฐู ุจุฏุก ุ ุฏุนููุง ูุฑู ูุง ูุญุฏุซ ุฏุงุฎู ุนูููุฉ ceph-osd.  ููููุงู ุจุฐูู ุ ูุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">perf</a> ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">flamescope</a> (ุงููุฒูุฏ ุญููู ูููู ูุฑุงุกุชู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> ): <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/uw/gj/ox/uwgjoxekagdl-noj-wp_uy5g8q8.png"></div><br>  ุชุฎุจุฑูุง ุงูุตูุฑุฉ ุฃู ูุธููุฉ <strong>fdatasync ()</strong> ูุถุช ุงููุซูุฑ ูู ุงูููุช ูู ุฅุฑุณุงู ุทูุจ ุฅูู <strong>generic_make_request ()</strong> .  ูุฐุง ูุนูู ุฃู ุณุจุจ ุงููุดููุงุช ุนูู ุงูุฃุฑุฌุญ ุฎุงุฑุฌ ููุงู ุงูุจุฑูุงูุฌ ุงูุฎูู ููุณู.  ูููู ุฃู ูููู ุฅูุง ููุงุฉ ุฃู ุฃูุฑุงุต.  ุฃุธูุฑ ุฅุฎุฑุงุฌ iostat ุฒูู ุงูุชูุงู ุนุงูู ูู ูุนุงูุฌุฉ ุงูุทูุจุงุช ุจุงุณุชุฎุฏุงู ุฃูุฑุงุต bcache. <br><br>  ุนูุฏ ุงูุชุญูู ูู ุงููุถูู ุ ูุฌุฏูุง ุฃู ุงูุจุฑูุงูุฌ ุงูุฎูู systemd-udevd ูุณุชููู ูููุฉ ูุจูุฑุฉ ูู ููุช ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ - ุญูุงูู 20ูช ุนูู ุนุฏุฉ ูุฑุงูุฒ.  ูุฐุง ุณููู ุบุฑูุจ ุ ูุฐูู ุชุญุชุงุฌ ุฅูู ูุนุฑูุฉ ุงูุณุจุจ.  ูุธุฑูุง ูุฃู Systemd-udevd ูุนูู ูุน uevents ุ ููุฏ ูุฑุฑูุง ุฃู ููุธุฑ ุฅูููู ูู ุฎูุงู <strong>ุดุงุดุฉ udevadm</strong> .  ุงุชุถุญ ุฃูู ุชู ุฅูุดุงุก ุนุฏุฏ ูุจูุฑ ูู ุฃุญุฏุงุซ ุงูุชุบููุฑ ููู ุฌูุงุฒ ูุชูุฉ ูู ุงููุธุงู.  ูุฐุง ุบูุฑ ูุนุชุงุฏ ููุบุงูุฉ ุ ูุฐูู ุณูู ุชุญุชุงุฌ ุฅูู ูุนุฑูุฉ ูุง ูููุฏ ูู ูุฐู ุงูุฃุญุฏุงุซ. <br><br><h3 style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ูุฌููุนุฉ ุฃุฏูุงุช BCC </h3><br>  ููุง ุงูุชุดููุง ุจุงููุนู ุ ุชูุถู kernel (ู daemon ceph ูู ุงุณุชุฏุนุงุก ุงููุธุงู) ุงููุซูุฑ ูู ุงูููุช ูู <strong>generic_make_request ()</strong> .  ุฏุนูุง ูุญุงูู ููุงุณ ุณุฑุนุฉ ูุฐู ุงููุธููุฉ.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">BCC</a> ูุฏููุง ุจุงููุนู ูุงุฆุฏุฉ ูุจูุฑุฉ - <strong>funclatency</strong> .  ุณูููู ุจุชุชุจุน ุงูุจุฑูุงูุฌ ุงูุฎูู ุจูุงุณุทุฉ ูุนุฑู ุงูููุชุฌ ุงูุฎุงุต ุจู ูุน ูุงุตู ุฒููู ุจูู ูุฎุฑุฌุงุช ุงููุนูููุงุช ูู 1 ุซุงููุฉ ูุฅุฎุฑุงุฌ ุงููุชูุฌุฉ ุจุงููููู ุซุงููุฉ. <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/o7/zw/rl/o7zwrly0nejoo5r7zbezws3jxmo.png"></div><br>  ุนุงุฏุฉ ูุง ุชููู ูุฐู ุงููุธููุฉ ุณุฑูุนุฉ.  ูู ูุง ุชูุนูู ูู ุฅุฑุณุงู ุงูุทูุจ ุฅูู ูุงุฆูุฉ ุงูุชุธุงุฑ ุจุฑูุงูุฌ ุชุดุบูู ุงูุฌูุงุฒ. <br><br>  <strong>Bcache</strong> ูู ุฌูุงุฒ ูุนูุฏ ูุชููู ูู ุงููุงูุน ูู ุซูุงุซุฉ ุฃูุฑุงุต: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฏุนู ุงูุฌูุงุฒ (ุงููุฑุต ุงููุคูุช) ุ ูู ูุฐู ุงูุญุงูุฉ ูู HDD ุจุทูุก. </li><li style=";text-align:right;direction:rtl">  ุฌูุงุฒ ุงูุชุฎุฒูู ุงููุคูุช (ูุฑุต ุงูุชุฎุฒูู ุงููุคูุช) ุ ูููุง ูุณู ูุงุญุฏ ูู ุฌูุงุฒ NVMe ุ </li><li style=";text-align:right;direction:rtl">  bcache ุงูุฌูุงุฒ ุงูุธุงูุฑู ุงูุฐู ูุนูู ุจู ุงูุชุทุจูู. </li></ul><br>  ูุญู ูุนูู ุฃู ุทูุจ ุงูุฅุฑุณุงู ุจุทูุก ุ ูููู ูุฃู ูู ูุฐู ุงูุฃุฌูุฒุฉุ  ุณูุชุนุงูู ูุน ูุฐุง ูู ููุช ูุงุญู ููููุง. <br><br>  ูุญู ูุนูู ุงูุขู ุฃู ุงูุงุญูุฑุงุฑ ูุณุจุจ ูุดุงูู.  ุงูุนุซูุฑ ุนูู ูุง ูุณุจุจ ุฌูููู ุจุงูุถุจุท ููุณ ุจูุฐู ุงูุจุณุงุทุฉ.  ุงูุชุฑุถ ุฃู ูุฐุง ูู ููุน ูู ุงูุจุฑุงูุฌ ุงูุชู ูุชู ุชุดุบูููุง ุจุดูู ุฏูุฑู.  ุฏุนููุง ูุฑู ุฃู <strong>ููุน</strong> ูู ุงูุจุฑุงูุฌ ูุชู ุชุดุบููู ุนูู ุงููุธุงู ุจุงุณุชุฎุฏุงู ุงูุจุฑูุงูุฌ ุงููุตู <strong>execsnoop</strong> ูู ููุณ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฌููุนุฉ ุฃุฏูุงุช BCC ุงููุณุงุนุฏุฉ</a> .  ุชุดุบููู ูุชูุฌูู ุงูุฅุฎุฑุงุฌ ุฅูู ููู. <br><br>  ุนูู ุณุจูู ุงููุซุงู ุ ูุซู ูุฐุง: <br><br><pre style=";text-align:right;direction:rtl"><code class="bash hljs">/usr/share/bcc/tools/execsnoop | tee ./execdump</code> </pre> <br>  ูู ูุนุทู ุงููุงุชุฌ ุงููุงูู ูู execsnoop ููุง ุ ูููู ูุจุฏู ุฃู ุฃุญุฏ ุฃูุฌู ุงูุงูุชูุงู ุจุงููุณุจุฉ ููุง ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">sh 1764905 5802 0 sudo arcconf getconfig 1 AD | grep Temperature | awk -F <span class="hljs-string"><span class="hljs-string">'[:/]'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> | sed <span class="hljs-string"><span class="hljs-string">'s/^ \([0-9]*\) C.*/\1/'</span></span></code> </pre><br>  ุงูุนููุฏ ุงูุซุงูุซ ูู PPID (ุฃุตู PID) ููุนูููุฉ.  ุชุญููุช ุงูุนูููุฉ ูุน PID 5802 ุฅูู ูุงุญุฏุฉ ูู ุฎููุท ูุธุงู ุงููุฑุงูุจุฉ ูุฏููุง.  ุนูุฏ ุงูุชุญูู ูู ุชูููู ูุธุงู ุงููุฑุงูุจุฉ ุ ุชู ุงูุนุซูุฑ ุนูู ูุนููุงุช ุฎุงุทุฆุฉ.  ุชู ุฃุฎุฐ ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ูุญูู HBA ูุฑุฉ ูุงุญุฏุฉ ูู 30 ุซุงููุฉ ุ ููู ุฃูุซุฑ ุจูุซูุฑ ูู ุงููุงุฒู.  ุจุนุฏ ุชุบููุฑ ุงููุงุตู ุงูุฒููู ููุชุญูู ุฅูู ูุชุฑุฉ ุฃุทูู ุ ูุฌุฏูุง ุฃู ุงูุชุฃุฎูุฑ ูู ูุนุงูุฌุฉ ุงูุทูุจุงุช ุนูู ูุฐุง ุงููุถูู ูุฏ ุชููู ุนู ุงูุธููุฑ ูู ุจููุฉ ุงููุถูููู. <br><br>  ููู ูุง ุฒุงู ูู ุบูุฑ ุงููุงุถุญ ุณุจุจ ุจุทุก ุฌูุงุฒ bcache.  ูููุง ุจุฅุนุฏุงุฏ ููุตุฉ ุงุฎุชุจุงุฑ ุจุชูููู ููุงุซู ูุญุงูููุง ุฅุนุงุฏุฉ ุฅูุชุงุฌ ุงููุดููุฉ ุนู ุทุฑูู ุชุดุบูู fio ุนูู bcache ุ ูุจุฏุก ุชุดุบูู ูุดุบู udevadm ุฏูุฑููุง ูุฅูุดุงุก ููุฌุงุช. <br><br><h3 style=";text-align:right;direction:rtl">  ูุชุงุจุฉ ุงูุฃุฏูุงุช ุงููุณุชูุฏุฉ ุฅูู BCC </h3><br>  ุฏุนูุง ูุญุงูู ูุชุงุจุฉ ุฃุฏุงุฉ ูุณุงุนุฏุฉ ุจุณูุทุฉ ูุชุชุจุน ูุนุฑุถ ุฃุจุทุฃ ุงูููุงููุงุช ุฅูู <strong>generic_make_request ()</strong> .  ูุญู ููุชููู ุฃูุถูุง ุจุงุณู ูุญุฑู ุงูุฃูุฑุงุต ุงูุฐู ุชู ุงุณุชุฏุนุงุก ูุฐู ุงููุธููุฉ ูู ุฃุฌูู. <br><br>  ุงูุฎุทุฉ ุจุณูุทุฉ: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุณุฌูู <strong>kprobe</strong> ุฅูู <strong>generic_make_request ()</strong> : <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุญูุธ ุงุณู ุงููุฑุต ูููู ุงููุตูู ุฅูููุง ูู ุฎูุงู ูุณูุทุฉ ูุธููุฉ. </li><li style=";text-align:right;direction:rtl">  ุญูุธ ุงูุทุงุจุน ุงูุฒููู. </li></ul><br></li></ul><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุณุฌู <strong>kretprobe</strong> ููุนูุฏุฉ ูู <strong>generic_make_request ()</strong> : <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุญุตูู ุนูู ุงูุทุงุจุน ุงูุฒููู ุงูุญุงูู. </li><li style=";text-align:right;direction:rtl">  ูุญู ูุจุญุซ ุนู ุงูุทุงุจุน ุงูุฒููู ุงููุญููุธ ูููุงุฑูุชู ูุน ุงูุญุงูู ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงูุช ุงููุชูุฌุฉ ุฃูุจุฑ ูู ุงููุชูุฌุฉ ุงููุญุฏุฏุฉ ุ ูุณูุฌุฏ ุงุณู ุงููุฑุต ุงููุญููุธ ููุนุฑุถู ุนูู ุงูุฌูุงุฒ ุงูุทุฑูู. </li></ul><br></li></ul>  <strong>Kprobes</strong> ู <strong>kretprobes</strong> ุงุณุชุฎุฏุงู ุขููุฉ ููุทุฉ ุชููู ูุชุบููุฑ ุฑูุฒ ุงููุธููุฉ ุนูู ุงูุทุงูุฑ.  ููููู ูุฑุงุกุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุซุงุฆู</a> ูููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุฏ</a> ุญูู ูุฐุง ุงูููุถูุน.  ุฅุฐุง ูุธุฑุช ุฅูู ุดูุฑุฉ ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ุงููุฎุชููุฉ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุณุฎุฉ ูุฎููุฉ ุงููุฌูุฉ</a> ุ ุณุชูุงุญุธ ุฃู ูุฏููู ุจููุฉ ูุชุทุงุจูุฉ.  ุฅุฐู ูู ูุฐู ุงูููุงูุฉ ุ ุณูุญุฐู ุชุญููู ูุณูุทุงุช ุงููุต ูููุชูู ุฅูู ุจุฑูุงูุฌ BPF ููุณู. <br><br>  ูุจุฏู ุงููุต eBPF ุฏุงุฎู ุงูุจุฑูุงูุฌ ุงููุตู ุจูุซูู ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">bpf_text = โโโ <span class="hljs-comment"><span class="hljs-comment"># Here will be the bpf program code โโโ</span></span></code> </pre><br>  ูุชุจุงุฏู ุงูุจูุงูุงุช ุจูู ุงููุธุงุฆู ุ ุชุณุชุฎุฏู ุจุฑุงูุฌ eBPF <a href="">ุฌุฏุงูู ุงูุชุฌุฒุฆุฉ</a> .  ููู ูุญู.  ูููุชุงุญ ุ ุณูู ูุณุชุฎุฏู ูุนุฑู ุงูุนูููุฉ ุงูุฎุงุต ุจุงูุนูููุฉ ุ ูููููุฉ ูุญุฏุฏ ุงููููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">struct data_t { u64 pid; u64 ts; char comm[TASK_COMM_LEN]; u64 lat; char disk[DISK_NAME_LEN]; }; BPF_HASH(p, u64, struct data_t); BPF_PERF_OUTPUT(events);</code> </pre><br>  ูุญู ููุง ูุณุฌู ุฌุฏูู ุชุฌุฒุฆุฉ ูุณูู <em>p</em> ุ ูุน ููุชุงุญ ูู ุงูููุน <em>u64</em> ููููุฉ type <em>struct data_t</em> .  ุณูููู ุงูุฌุฏูู ูุชุงุญูุง ูู ุณูุงู ุจุฑูุงูุฌ BPF ุงูุฎุงุต ุจูุง.  ูุณุฌู ุงููุงูุฑู BPF_PERF_OUTPUT ุฌุฏูููุง ุขุฎุฑ ูุณูู <em>ุงูุฃุญุฏุงุซ</em> ุ ูุงูุฐู ูุชู ุงุณุชุฎุฏุงูู <a href="">ูููู ุงูุจูุงูุงุช</a> ุฅูู ูุณุงุญุฉ ุงููุณุชุฎุฏู. <br><br>  ุนูุฏ ููุงุณ ุงูุชุฃุฎูุฑุงุช ุจูู ุงุณุชุฏุนุงุก ุฏุงูุฉ ูุงูุนูุฏุฉ ููู ุ ุฃู ุจูู ุงูููุงููุงุช ุฅูู ูุธุงุฆู ูุฎุชููุฉ ุ ูุฌุจ ุฃู ูุคุฎุฐ ูู ุงูุงุนุชุจุงุฑ ุฃู ุงูุจูุงูุงุช ุงููุณุชููุฉ ูุฌุจ ุฃู ุชูุชูู ุฅูู ููุณ ุงูุณูุงู.  ุจูุนูู ุขุฎุฑ ุ ุนููู ุฃู ุชุชุฐูุฑ ุญูู ุงูุชุดุบูู ุงููุชูุงุฒู ุงููุญุชูู ูููุธุงุฆู.  ูุฏููุง ุงููุฑุตุฉ ูููุงุณ ุงูุชุฃุฎูุฑ ุจูู ุงุณุชุฏุนุงุก ุฏุงูุฉ ูู ุณูุงู ุนูููุฉ ูุง ูุงูุนูุฏุฉ ูู ุชูู ุงููุธููุฉ ูู ุณูุงู ุนูููุฉ ุฃุฎุฑู ุ ูููู ูุฐุง ุนูู ุงูุฃุฑุฌุญ ุบูุฑ ูุฌุฏู.  ูุซุงู ุฌูุฏ ููุง ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ biolatency</a> ุ ุญูุซ ูุชู ุชุนููู ูุคุดุฑ <em>ูุทูุจ ุจูุงุก</em> ุ ูุงูุฐู ูุนูุณ <em>ุทูุจ</em> ูุฑุต ูุงุญุฏ ุ ูููุชุงุญ ูู ุฌุฏูู ุงูุชุฌุฒุฆุฉ. <br><br>  ุจุนุฏ ุฐูู ุ ูุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุงูููุฏ ุงูุฐู ุณูุชู ุชุดุบููู ุนูุฏ ุงุณุชุฏุนุงุก ุงููุธููุฉ ููุฏ ุงูุชุญููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">void start(struct pt_regs *ctx, struct bio *bio) { u64 pid = bpf_get_current_pid_tgid(); struct data_t data = {}; u64 ts = bpf_ktime_get_ns(); data.pid = pid; data.ts = ts; bpf_probe_read_str(&amp;data.disk, sizeof(data.disk), (void*)bio-&gt;bi_disk-&gt;disk_name); p.update(&amp;pid, &amp;data); }</code> </pre><br>  ููุง ุ ุณูุชู ุงุณุชุจุฏุงู ุงููุณูุทุฉ ุงูุซุงููุฉ <a href="">ููุฏุงูุฉ</a> ุงููุณูุงุฉ <a href="">generic_make_request ()</a> ูุงููุณูุทุฉ ุงูุซุงููุฉ.  ุจุนุฏ ุฐูู ุ ูุญุตู ุนูู ูุนุฑูู ุงูุนูููุฉ ุงูุฎุงุต ุจุงูุนูููุฉ ุงูุชู ูุนูู ุจูุง ุ ูุงูุทุงุจุน ุงูุฒููู ุงูุญุงูู ุจุงููุงูู ุซุงููุฉ.  ููุชุจ ูู ูุฐุง ูู <em>ุจูุงูุงุช ุจููุฉ data_t ุงููุฎุตุตุฉ ุญุฏูุซุง</em> .  ูุญุตู ุนูู ุงุณู ุงููุฑุต ูู ุงููููู <em>ุงูุญููู</em> ุ ูุงูุฐู ูุชู ุชูุฑูุฑู ุนูุฏ ุงุณุชุฏุนุงุก <strong>generic_make_request ()</strong> ุ ูุญูุธู ูู ุจููุฉ <em>ุงูุจูุงูุงุช</em> ููุณูุง.  ุงูุฎุทูุฉ ุงูุฃุฎูุฑุฉ ูู ุฅุถุงูุฉ ุฅุฏุฎุงู ุฅูู ุฌุฏูู ุงูุชุฌุฒุฆุฉ ุงููุฐููุฑ ุณุงุจููุง. <br><br>  ุณูุชู ุงุณุชุฏุนุงุก ุงููุธููุฉ ุงูุชุงููุฉ ุนูุฏ ุงูุฑุฌูุน ูู <strong>generic_make_request ()</strong> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">void stop(struct pt_regs *ctx) { u64 pid = bpf_get_current_pid_tgid(); u64 ts = bpf_ktime_get_ns(); struct data_t* data = p.lookup(&amp;pid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; data-&gt;ts &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { bpf_get_current_comm(&amp;data-&gt;comm, sizeof(data-&gt;comm)); data-&gt;lat = (ts - data-&gt;ts)/<span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data-&gt;lat &gt; MIN_US) { FACTOR data-&gt;pid &gt;&gt;= <span class="hljs-number"><span class="hljs-number">32</span></span>; events.perf_submit(ctx, data, sizeof(struct data_t)); } p.delete(&amp;pid); } }</code> </pre><br>  ุชุดุจู ูุฐู ุงููุธููุฉ ุงููุธููุฉ ุงูุณุงุจูุฉ: ูุชุนุฑู ุนูู ุงูุนูููุฉ PID ูุงูุทุงุจุน ุงูุฒููู ุ ููู ูุง ูุฎุตุต ุฐุงูุฑุฉ ูุจููุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ.  ุจุฏูุงู ูู ุฐูู ุ ูุญู ูุจุญุซ ูู ุฌุฏูู ุงูุชุฌุฒุฆุฉ ุนู ุจููุฉ ููุฌูุฏุฉ ุจุงุณุชุฎุฏุงู ุงูููุชุงุญ == ูุนุฑู PID ุงูุญุงูู.  ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ุงููููู ุ ูุณููุชุดู ุงุณู ุงูุนูููุฉ ุงูุฌุงุฑูุฉ ููุถูููุง ุฅูููุง. <br><br>  ููุงู ุญุงุฌุฉ ุฅูู ุงูุชุญูู ุงูุซูุงุฆู ุงูุฐู ูุณุชุฎุฏูู ููุง ููุญุตูู ุนูู ูุคุดุฑ ุชุฑุงุจุท ุฏุงุฆุฑุฉ ุงููุฎุงุจุฑุงุช ุงูุนุงูุฉ.  ุฃู  ูุนุฑู ุงูุนูููุฉ ุงูุฎุงุต ุจุงูุนูููุฉ ุงูุฑุฆูุณูุฉ ุงูุชู ุจุฏุฃุช ุงูุฎูุท ูู ุงูุณูุงู ุงูุฐู ูุนูู ููู.  ุชููู <a href="">ุฏุงูุฉ bpf_get_current_pid_tgid () ุงูุชู ูุฏุนููุง</a> ุจุฅุฑุฌุงุน ูู ูู GID ููุคุดุฑ ุงูุชุฑุงุจุท ู PID ุงูุฎุงุต ุจู ุจูููุฉ ูุงุญุฏุฉ 64 ุจุช. <br><br>  ุนูุฏ ุงูุฅุฎุฑุงุฌ ุฅูู ุงููุญุทุฉ ุงูุทุฑููุฉ ุ ุงูุขู ูุญู ูุณูุง ููุชููู ุจุงูุชูุงุฑ ุ ูููู ูู ุงูุนูููุฉ ุงูุฑุฆูุณูุฉ.  ุจุนุฏ ููุงุฑูุฉ ุงูุชุฃุฎูุฑ ุงููุณุชูู ูุน ุญุฏ ูุนูู ุ ูููู ุจููุฉ <em>ุงูุจูุงูุงุช ุงูุฎุงุตุฉ</em> ุจูุง ุฅูู ูุณุงุญุฉ ุงููุณุชุฎุฏู ูู ุฎูุงู ุฌุฏูู <em>ุงูุฃุญุฏุงุซ</em> ุ ุซู ูููู ุจุญุฐู ุงูุณุฌู ูู <em>ุตูุญุฉ</em> . <br><br>  ูู ุงูุจุฑูุงูุฌ ุงููุตู python ุงูุฐู ุณูููู ุจุชุญููู ูุฐุง ุงูุฑูุฒ ุ ูุญุชุงุฌ ุฅูู ุงุณุชุจุฏุงู MIN_US ู FACTOR ุจุนุชุจุงุช ุงูุชุฃุฎูุฑ ูุงููุญุฏุงุช ุงูุฒูููุฉ ุ ูุงูุชู ุณููุฑ ุจูุง ุนุจุฑ ุงููุณุงุฆุท: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'MIN_US'</span></span>,str(min_usec)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.milliseconds: bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'FACTOR'</span></span>,<span class="hljs-string"><span class="hljs-string">'data-&gt;lat /= 1000;'</span></span>) label = <span class="hljs-string"><span class="hljs-string">"msec"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'FACTOR'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>) label = <span class="hljs-string"><span class="hljs-string">"usec"</span></span></code> </pre><br>  ูุญุชุงุฌ ุงูุขู ุฅูู ุฅุนุฏุงุฏ ุจุฑูุงูุฌ BPF ูู ุฎูุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุงูุฑู BPF</a> ูุชุณุฌูู ุงูุนููุงุช: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">b = BPF(text=bpf_text) b.attach_kprobe(event=<span class="hljs-string"><span class="hljs-string">"generic_make_request"</span></span>,fn_name=<span class="hljs-string"><span class="hljs-string">"start"</span></span>) b.attach_kretprobe(event=<span class="hljs-string"><span class="hljs-string">"generic_make_request"</span></span>,fn_name=<span class="hljs-string"><span class="hljs-string">"stop"</span></span>)</code> </pre><br>  ุณูุชุนูู ุนูููุง ุฃูุถูุง ุชุญุฏูุฏ <em>struct data_t</em> ูู <em>ูุตูุง</em> ุ ูุฅูุง ููู ูุชููู ูู ูุฑุงุกุฉ ุฃู ุดูุก: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">TASK_COMM_LEN = <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-comment"><span class="hljs-comment"># linux/sched.h DISK_NAME_LEN = 32 # linux/genhd.h class Data(ct.Structure): _fields_ = [("pid", ct.c_ulonglong), ("ts", ct.c_ulonglong), ("comm", ct.c_char * TASK_COMM_LEN), ("lat", ct.c_ulonglong), ("disk",ct.c_char * DISK_NAME_LEN)]</span></span></code> </pre><br>  ุงูุฎุทูุฉ ุงูุฃุฎูุฑุฉ ูู ุฅุฎุฑุงุฌ ุงูุจูุงูุงุช ุฅูู ุงููุญุทุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cpu, data, size)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> start event = ct.cast(data, ct.POINTER(Data)).contents <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> start == <span class="hljs-number"><span class="hljs-number">0</span></span>: start = event.ts time_s = (float(event.ts - start)) / <span class="hljs-number"><span class="hljs-number">1000000000</span></span> print(<span class="hljs-string"><span class="hljs-string">"%-18.9f %-16s %-6d %-1s %s %s"</span></span> % (time_s, event.comm, event.pid, event.lat, label, event.disk)) b[<span class="hljs-string"><span class="hljs-string">"events"</span></span>].open_perf_buffer(print_event) <span class="hljs-comment"><span class="hljs-comment"># format output start = 0 while 1: try: b.perf_buffer_poll() except KeyboardInterrupt: exit()</span></span></code> </pre><br>  ุงูุจุฑูุงูุฌ ุงููุตู ููุณู ูุชุงุญ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฌูุซุจ</a> .  ุฏุนููุง ูุญุงูู ุชุดุบููู ุนูู ููุตุฉ ุงุฎุชุจุงุฑ ุญูุซ ุชุชู ูุชุงุจุฉ fio ูู bcache ูุงุณุชุฏุนุงุก ุดุงุดุฉ udevadm: <br><br><div style="text-align:center;;text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0q/wl/yo/0qwlyofk3ynh0ksh1rcqe_9kt6w.png"></div><br>  ูุฃุฎูุฑุง!  ุงูุขู ูุฑู ุฃู ูุง ูุดุจู ุฌูุงุฒ bcache ุงููุจุญ ูู ูู ุงููุงูุน ููุงููุฉ ูุจุญ ุฅูู <strong>generic_make_request ()</strong> ุนูู ูุญุฑู ุฃูุฑุงุต <strong>ูุฎุจุฃ</strong> . <br><br><h3 style=";text-align:right;direction:rtl">  ุญูุฑ ูู ุงูููุงุฉ </h3><br>  ูุง ุงูุฐู ูุจุทุฆ ุจุงูุถุจุท ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจุ  ูุฑู ุฃู ุงูุชุฃุฎูุฑ ูุญุฏุซ ุญุชู ูุจู ุจุฏุก ูุญุงุณุจุฉ ุงูุทูุจ ุ ุฃู  ูู ูุจุฏุฃ ุจุนุฏ ุญุณุงุจ ุทูุจ ูุญุฏุฏ ููุฒูุฏ ูู ุงูุฅุญุตุงุกุงุช ุญููู (/ proc / diskstats ุฃู iostat).  ูููู ุงูุชุญูู ูู ุฐูู ุจุณูููุฉ ุนู ุทุฑูู ุชุดุบูู iostat ุฃุซูุงุก ุฅุนุงุฏุฉ ุฅูุชุงุฌ ุงููุดููุฉ ุ ุฃู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุจุฑูุงูุฌ ุงููุตู biolatency BCC</a> ุ ุงูุฐู ูุณุชูุฏ ุฅูู ุจุฏุงูุฉ ูููุงูุฉ ูุญุงุณุจุฉ ุงูุทูุจุงุช.  ูู ุชุธูุฑ ุฃู ูู ูุฐู ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ูุดุงูู ููุงุณุชุนูุงูุงุช ุฅูู ูุญุฑู ุงูุฃูุฑุงุต ุงููุฎุฒู ูุคูุชุงู. <br><br>  ุฅุฐุง ุฃููููุง ูุธุฑุฉ ุนูู ุงูุฏุงูุฉ <strong>generic_make_request ()</strong> ุ <strong>ูุณูุฑู</strong> ุฃูู ูุชู ุงุณุชุฏุนุงุก ูุธููุชูู ุฃุฎุฑููู ูุจู <strong>ุชุณุฌูู</strong> ุงูุทูุจ.  ุฃูู ูุงุญุฏ ุ <strong>generic_make_request_checks ()</strong> ุ ูุชุญูู ูู ุดุฑุนูุฉ ุทูุจ ุฅุนุฏุงุฏุงุช ุงููุฑุต.  ูุงูุซุงูู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">blk_queue_enter ()</a> ุ ุงูุฐู ูุฏูู ุฏุนูุฉ ูุซูุฑุฉ ููุงูุชูุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">wait_event_interruptible ()</a> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">ret = wait_event_interruptible(q-&gt;mq_freeze_wq, (atomic_read(&amp;q-&gt;mq_freeze_depth) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; (preempt || !blk_queue_preempt_only(q))) || blk_queue_dying(q));</code> </pre><br>  ูู ุฐูู ุ ููุงุฉ ููุชุธุฑ ุฅุฒุงูุฉ ุงูุฌููุฏ ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ.  ูููุณ ุงูุชุฃุฎูุฑ <strong>blk_queue_enter ()</strong> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">~<span class="hljs-comment"><span class="hljs-comment"># /usr/share/bcc/tools/funclatency blk_queue_enter -i 1 -m Tracing 1 functions for "blk_queue_enter"... Hit Ctrl-C to end. msecs : count distribution 0 -&gt; 1 : 341 |****************************************| msecs : count distribution 0 -&gt; 1 : 316 |****************************************| msecs : count distribution 0 -&gt; 1 : 255 |****************************************| 2 -&gt; 3 : 0 | | 4 -&gt; 7 : 0 | | 8 -&gt; 15 : 1 | |</span></span></code> </pre><br>  ูุจุฏู ุฃููุง ูุฑูุจูู ูู ุงูุญู.  ุงููุธุงุฆู ุงููุณุชุฎุฏูุฉ "ูุชุฌููุฏ / ุฅูุบุงุก ุชุฌููุฏ" ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">blk_mq_freeze_queue</a> ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">blk_mq_unfreeze_queue</a> .  ูุชู ุงุณุชุฎุฏุงููุง ุนูุฏ ุงูุถุฑูุฑุฉ ูุชุบููุฑ ุฅุนุฏุงุฏุงุช ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุงุณุชุนูุงู ุ ูุงูุชู ูู ุงููุญุชูู ุฃู ุชููู ุฎุทุฑุฉ ุจุงููุณุจุฉ ููุงุณุชุนูุงูุงุช ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุฐู.  ุนูุฏูุง <strong>ูุชู</strong> ุงุณุชุฏุนุงุก <strong>blk_mq_freeze_queue () ุ ูุฅู</strong> ุงูุฏุงูุฉ <strong>blk_freeze_queue_start ()</strong> <strong>ุชุฒูุฏ ุงูุนุฏุงุฏ q-&gt; mq_freeze_depth</strong> .  ุจุนุฏ ุฐูู ุ ุชูุชุธุฑ ุงูููุงุฉ ุฅูุฑุงุบ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">blk_mq_freeze_queue_wait ()</a> . <br><br>  ูุนุงุฏู ููุช ุงูุงูุชุธุงุฑ ููุณุญ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุฐู ุฒูู ุงูุชูุงู ุงููุฑุต ุ ูุธุฑูุง ูุฃู kernel ููุชุธุฑ ุฃู ุชูุชูู ุฌููุน ุนูููุงุช ุงูุงูุชุธุงุฑ.  ุจูุฌุฑุฏ ุฃู ุชููู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุงุฑุบุฉ ุ ูุชู ุชุทุจูู ุงูุชุบููุฑุงุช ุนูู ุงูุฅุนุฏุงุฏุงุช.  ุซู ูุชู ุงุณุชุฏุนุงุก <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">blk_mq_unfreeze_queue ()</a> ุ ููุง <strong>ูููู ูู</strong> ุนุฏุงุฏ <strong>freeze_depth</strong> . <br><br>  ุงูุขู ูุญู ูุนุฑู ูุง ูููู ูุชุตุญูุญ ุงููุถุน.  ููุชุฌ ุนู ุงูุฃูุฑ udevadm trigger ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ูุฌูุงุฒ ุงููุชูุฉ.  ูุฐู ุงูุฅุนุฏุงุฏุงุช ููุตููุฉ ูู ููุงุนุฏ udev.  ูููููุง ุฃู ูุนุฑู ุจุงูุถุจุท ุฃู ุงูุฅุนุฏุงุฏุงุช "ุชุฌููุฏ" ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูู ุฎูุงู ูุญุงููุฉ ุชุบููุฑูุง ูู ุฎูุงู sysfs ุฃู ูู ุฎูุงู ุงููุธุฑ ูู ุดูุฑุฉ ุงููุตุฏุฑ kernel.  ูููููุง ุฃูุถูุง ุชุฌุฑุจุฉ ุงูุฃุฏุงุฉ ุงููุณุงุนุฏุฉ BCC <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">trace</a> ุ ุงูุชู ุชุนุฑุถ ููุฏุณ kernel ูุชุชุจุน ูุณุงุญุฉ ุงููุณุชุฎุฏู ูููุญุทุฉ ููู ููุงููุฉ <strong>blk_freeze_queue</strong> ุ ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">~<span class="hljs-comment"><span class="hljs-comment"># /usr/share/bcc/tools/trace blk_freeze_queue -K -U PID TID COMM FUNC 3809642 3809642 systemd-udevd blk_freeze_queue blk_freeze_queue+0x1 [kernel] elevator_switch+0x29 [kernel] elv_iosched_store+0x197 [kernel] queue_attr_store+0x5c [kernel] sysfs_kf_write+0x3c [kernel] kernfs_fop_write+0x125 [kernel] __vfs_write+0x1b [kernel] vfs_write+0xb8 [kernel] sys_write+0x55 [kernel] do_syscall_64+0x73 [kernel] entry_SYSCALL_64_after_hwframe+0x3d [kernel] __write_nocancel+0x7 [libc-2.23.so] [unknown] 3809631 3809631 systemd-udevd blk_freeze_queue blk_freeze_queue+0x1 [kernel] queue_requests_store+0xb6 [kernel] queue_attr_store+0x5c [kernel] sysfs_kf_write+0x3c [kernel] kernfs_fop_write+0x125 [kernel] __vfs_write+0x1b [kernel] vfs_write+0xb8 [kernel] sys_write+0x55 [kernel] do_syscall_64+0x73 [kernel] entry_SYSCALL_64_after_hwframe+0x3d [kernel] __write_nocancel+0x7 [libc-2.23.so] [unknown]</span></span></code> </pre><br>  ูุงุฏุฑุงู ูุง ุชุชุบูุฑ ููุงุนุฏ Udev ูุนุงุฏุฉ ูุง ูุญุฏุซ ูุฐุง ุชุญุช ุงูุณูุทุฑุฉ.  ูุฐูู ูุฑู ุฃูู ุญุชู ุงุณุชุฎุฏุงู ุงูููู ุงููุญุฏุฏุฉ ุจุงููุนู ูุคุฏู ุฅูู ุฒูุงุฏุฉ ุงูุชุฃุฎูุฑ ูู ุฅุฑุณุงู ุงูุทูุจ ูู ุงูุชุทุจูู ุฅูู ุงููุฑุต.  ุจุงูุทุจุน ุ ูุฅูุดุงุก ุฃุญุฏุงุซ udev ุนูุฏ ุนุฏู ูุฌูุฏ ุชุบููุฑุงุช ูู ุชูููู ุงููุฑุต (ุนูู ุณุจูู ุงููุซุงู ุ ุงูุฌูุงุฒ ูุง ูุชุตู / ูุทุน ุงูุงุชุตุงู) ููุณุช ููุงุฑุณุฉ ุฌูุฏุฉ.  ููุน ุฐูู ุ ูููููุง ูุณุงุนุฏุฉ ุงูููุงุฉ ุนูู ุนุฏู ุงูููุงู ุจุนูู ุนุฏูู ุงููุงุฆุฏุฉ ูุนุฏู ุชุฌููุฏ ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูุทูุจ ุฅุฐุง ูู ููู ุฐูู ุถุฑูุฑููุง.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุซูุงุซ</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงุฑุชูุงุจ</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุตุบูุฑ</a> ูุตุญุญ ุงููุถุน. <br><br><h2 style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br>  eBPF ูู ุฃุฏุงุฉ ูุฑูุฉ ููููุฉ ููุบุงูุฉ.  ูู ุงูููุงู ุ ุฏุฑุณูุง ุญุงูุฉ ุนูููุฉ ูุงุญุฏุฉ ูุฃุธูุฑูุง ุฌุฒุกูุง ุตุบูุฑูุง ููุง ูููู ูุนูู.  ุฅุฐุง ููุช ููุชููุง ุจุชุทููุฑ ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ BCC ุ ููุฌุจ ุนููู ุฅููุงุก ูุธุฑุฉ ุนูู <a href="">ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุงูุฑุณูู</a> ุงูุฐู ูุตู ุงูุฃุณุงุณูุงุช ุฌูุฏูุง. <br><br>  ููุงู ุฃุฏูุงุช ุชุตุญูุญ ุฃุฎุทุงุก ูููุฒุงุช ุชุนุฑูู ุฃุฎุฑู ูุจููุฉ ุนูู eBPF.  ุฃุญุฏูุง ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">bpftrace</a> ุ ูุงูุฐู ูุณูุญ ูู ุจูุชุงุจุฉ ุจุฑุงูุฌ ูููุฉ ุฐุงุช ุณุทุฑ ูุงุญุฏ ูุตุบูุฑุฉ ุจูุบุฉ ุชุดุจู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุงุช</a> .  ุขุฎุฑ - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ebpf_exporter</a> ุ ูุณูุญ ูู ุจุฌูุน ููุงููุณ ุนุงููุฉ ุงูุฏูุฉ ููุฎูุถุฉ ุงููุณุชูู ูุจุงุดุฑุฉ ูู ุฎุงุฏู prometheus ุงูุฎุงุต ุจู ุ ูุน ุงููุฏุฑุฉ ุนูู ุงูุญุตูู ุนูู ุชุตูุฑ ุฌููู ูุญุชู ุชูุจููุงุช ูู ุงููุณุชูุจู. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar458592/">https://habr.com/ru/post/ar458592/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar458572/index.html">ุฃูุงุชููู ุณูููุณุงุฑ: "ูุชุฑุฉ ุงูููุจููุชุฑ ูู ุงูุงุชุญุงุฏ ุงูุฃูุฑูุจู ุณูุญุช ููุง ุจุชุฏุฑูุจ ุงููุธุงู ูุงููุจุฑูุฌูู ุงูุชุทุจููููู"</a></li>
<li><a href="../ar458574/index.html">ููู ุชููู ูู ูุทูุฑ ุฅูู ูุฑูู ูููุฏ ููุนูุด ูุนู ุฃูุซุฑ</a></li>
<li><a href="../ar458576/index.html">ุฅุฏุงุฑุฉ ุงููุตูุต ูุงูุชุนุฑูุจ ูู ุชุทุจูู ุงูููุจ</a></li>
<li><a href="../ar458582/index.html">ุงุจุชูุฑ ูููุฏุณ ุงูุฃูุงุฒูู ุฌูุงุฒ ุญุฌุจ ูููุธูุฉ ุงูุนูู ุงูุฏูููุฉ ูุจูู ุงููุทุท ุฎุงุฑุฌ ุงูุดุงุฑุน</a></li>
<li><a href="../ar458584/index.html">11 ุชููุฒ (ููููู) ุ Group-IB Webinar "ุชุญููู ุงูุจุฑุงูุฌ ุงูุถุงุฑุฉ ูููุจุชุฏุฆูู: ุงูุฃุณุงููุจ ุงูุฃุณุงุณูุฉ"</a></li>
<li><a href="../ar458594/index.html">ูุง ุชูุณ ุฒูุงุฏุฉ ูุฑุตุฉ ุงุณุชุฌุงุจุฉ ุงูุนููู ุจุงุณุชุฎุฏุงู ุทูุจ ูุชูุฑุฑ ูู ููุงุฒูุฉ L7</a></li>
<li><a href="../ar458598/index.html">ุงูุชุนุฑู ุนูู ูุตุงุฏุฑ ุงูุถูุก ุนูู ุฎุฑุงุฆุท ุงูุจูุฆุฉ</a></li>
<li><a href="../ar458600/index.html">ูุง ูู ุงูุฏุฑุงุฌุงุช ุงูููุฑุจุงุฆูุฉ (ุงุณุชุนุฑุงุถ ุงููุฌููุนุฉ ูู ุฌุฒุฃูู ูู ุฎูุณุฉ ููุงุฐุฌ ูู ุงุซููู ูู ุงูุดุฑูุงุช ุงููุตูุนุฉ) ุ ุงูุฌุฒุก 1</a></li>
<li><a href="../ar458604/index.html">ููุงุฐุง ุงูุถู ุฃูุจุฑ ูุตูุนู ุฅููุชุฑูููุงุช ุฅูู ูุดุฑูุน GPU ุฌุฏูุฏ</a></li>
<li><a href="../ar458606/index.html">ุดุบูู OpenVPN ูู Docker ุฎูุงู ุซุงููุชูู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>