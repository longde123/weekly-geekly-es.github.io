<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé® üêó üï∫üèΩ Gu√≠a de supervivencia de MongoDB üõ∏ üë®üèª‚Äçüéì ü§ôüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todas las buenas nuevas empresas mueren r√°pidamente o crecen a escala. Modelaremos una startup de este tipo, que primero trata sobre caracter√≠sticas y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gu√≠a de supervivencia de MongoDB</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/454748/">  Todas las buenas nuevas empresas mueren r√°pidamente o crecen a escala.  Modelaremos una startup de este tipo, que primero trata sobre caracter√≠sticas y luego sobre rendimiento.  Mejoraremos el rendimiento con MongoDB, una popular soluci√≥n de almacenamiento de datos NoSQL.  MongoDB es f√°cil de comenzar y muchos problemas tienen soluciones listas para usar.  Sin embargo, cuando aumenta la carga, sale un rastrillo que nadie le advirti√≥ antes ... ¬°hasta hoy! <br><br><img src="https://habrastorage.org/webt/oh/rq/ua/ohrquayfyh04hfgs-gareddfzlk.gif" alt="imagen"><br><br>  <strong>Sergey Zagursky</strong> , responsable de la infraestructura de back-end en general, y MongoDB en particular en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Joom,</a> realizan el modelado.  Tambi√©n se vio en el lado del servidor del desarrollo de MMORPG Skyforge.  Como Sergei se describe a s√≠ mismo, √©l es "un tomador de cono profesional con su propia frente y rastrillo".  Bajo un microscopio, un proyecto que utiliza una estrategia de acumulaci√≥n para gestionar la deuda t√©cnica.  En esta versi√≥n de texto del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> en HighLoad ++, nos moveremos en orden cronol√≥gico desde la aparici√≥n del problema hasta la soluci√≥n usando MongoDB. <br><a name="habracut"></a><br><h2>  Primeras dificultades </h2><br>  Estamos modelando una startup que llena los baches.  La primera etapa de la vida: las caracter√≠sticas se lanzan en nuestro inicio y, inesperadamente, llegan los usuarios.  Nuestro peque√±o y peque√±o servidor MongoDB tiene una carga que nunca so√±amos.  Pero estamos en la nube, ¬°somos una startup!  Hacemos las cosas m√°s simples posibles: mira las solicitudes, oh, y aqu√≠ tenemos la correcci√≥n completa restada para cada usuario, aqu√≠ construiremos los √≠ndices, agregaremos el hardware all√≠, y aqu√≠ almacenaremos en cach√©. <br>  ¬°Todo, vivimos! <br><br><blockquote>  Si los problemas pueden resolverse por medios tan simples, deben resolverse de esta manera. </blockquote><br>  Pero el camino futuro de un inicio exitoso es un retraso lento y doloroso del momento de escala horizontal.  Intentar√© dar consejos sobre c√≥mo sobrevivir a este per√≠odo, escalar y no pisar el rastrillo. <br><br><h2>  Grabaci√≥n lenta </h2><br>  Este es uno de los problemas que puede encontrar.  ¬øQu√© hacer si la conoces y los m√©todos anteriores no te ayudan?  Respuesta: <strong>modo de garant√≠a de</strong> <strong>durabilidad</strong> <strong>en MongoDB por defecto</strong> .  En tres palabras, funciona as√≠: <br><br><ul><li>  Llegamos a la l√≠nea primaria y dijimos: "¬°Escribe!". <br></li><li>  R√©plica primaria registrada. <br></li><li>  Despu√©s de eso, se leyeron r√©plicas secundarias de ella y dijeron primaria: "¬°Grabamos!" <br></li></ul><br>  En el momento en que la mayor√≠a de las r√©plicas secundarias hicieron esto, la solicitud se considera completa y el control vuelve al controlador en la aplicaci√≥n.  Dichas garant√≠as nos permiten estar seguros de que cuando el control haya regresado a la aplicaci√≥n, la durabilidad no ir√° a ning√∫n lado, incluso si MongoDB se acuesta, excepto por desastres absolutamente terribles. <br><br><blockquote>  Afortunadamente, MongoDB es una base de datos que le permite reducir las garant√≠as de durabilidad para cada solicitud individual. </blockquote><br>  Para solicitudes importantes, podemos dejar las garant√≠as de m√°xima durabilidad por defecto, y para algunas solicitudes podemos reducirlas. <br><br><h3>  Solicitar clases </h3><br>  La primera capa de garant√≠as que podemos eliminar es <strong>no esperar la confirmaci√≥n del registro por la mayor√≠a de las r√©plicas</strong> .  Esto ahorra latencia, pero no agrega ancho de banda.  Pero a veces la latencia es lo que necesita, especialmente si el cl√∫ster est√° un poco sobrecargado y las r√©plicas secundarias no funcionan tan r√°pido como nos gustar√≠a. <br><br><pre><code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>}</code> </pre> <br>  Si escribimos registros con tales garant√≠as, en el momento en que tengamos el control en la aplicaci√≥n, ya no sabemos si el registro estar√° vivo despu√©s de alg√∫n tipo de accidente.  Pero por lo general, ella todav√≠a est√° viva. <br><br>  La siguiente garant√≠a, que tambi√©n afecta el ancho de banda y la latencia, es <strong>deshabilitar la confirmaci√≥n de registro</strong> .  Una entrada de diario se escribe de todos modos.  La revista es uno de los mecanismos fundamentales.  Si desactivamos la confirmaci√≥n de escritura, no hacemos dos cosas: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><u><strong>fsync</strong></u></a> <strong>en el registro</strong> y <strong>no esperamos a que termine</strong> .  Esto puede <strong>ahorrar muchos recursos de disco</strong> y obtener un <strong>aumento m√∫ltiple en el rendimiento</strong> simplemente cambiando la durabilidad de la garant√≠a. <br><br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}</code> </pre> <br>  Las garant√≠as de durabilidad m√°s estrictas est√°n <strong>deshabilitando cualquier reconocimiento</strong> .  Solo recibiremos confirmaci√≥n de que la solicitud ha llegado a la r√©plica principal.  Esto ahorrar√° latencia y no aumentar√° el rendimiento de ninguna manera. <br><br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">w</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">j</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>} ‚Äî   .</code> </pre> <br>  Tambi√©n recibiremos varias otras cosas, por ejemplo, la grabaci√≥n fall√≥ debido a un conflicto con una clave √∫nica. <br><br><h3>  ¬øA qu√© operaciones se aplica esto? </h3><br>  Te contar√© sobre la aplicaci√≥n para la configuraci√≥n en Joom.  Adem√°s de la carga de los usuarios, en la que no hay concesiones de durabilidad, hay una carga que puede describirse como una carga por lotes en segundo plano: actualizaci√≥n, recuento de clasificaciones, recopilaci√≥n de datos anal√≠ticos. <br><br>  Estas operaciones en segundo plano pueden llevar horas, pero est√°n dise√±adas de modo que si se rompe un corte, por ejemplo, un backend, no perder√°n el resultado de todo su trabajo, sino que se reanudar√°n desde el punto en el pasado reciente.  Reducir la garant√≠a de durabilidad es √∫til para tales tareas, especialmente porque fsync en el registro, como cualquier otra operaci√≥n, aumentar√° la latencia tambi√©n para la lectura. <br><br><h2>  Leer escalado </h2><br>  El siguiente problema es el <strong>ancho de banda de lectura insuficiente</strong> .  Recuerde que en nuestro cl√∫ster no solo hay r√©plicas primarias, sino tambi√©n secundarias de las <strong>que puede leer</strong> .  Hag√°moslo <br><br>  Puedes leer, pero hay matices.  Los datos ligeramente desactualizados provendr√°n de r√©plicas secundarias, por 0.5‚Äì1 segundos.  En la mayor√≠a de los casos, esto es normal, pero el comportamiento de la r√©plica secundaria es diferente del comportamiento de las r√©plicas primarias. <br><br>  En secundaria, est√° el proceso de usar oplog, que no est√° en la r√©plica primaria.  Este proceso no est√° dise√±ado para baja latencia, solo los desarrolladores de MongoDB no se molestaron con esto.  Bajo ciertas condiciones, el proceso de usar oplog de primario a secundario puede causar demoras de hasta 10 s. <br><br><blockquote>  Las r√©plicas secundarias no son adecuadas para las consultas de los usuarios: las experiencias de los usuarios dan un paso r√°pido hacia el contenedor. </blockquote><br>  En grupos sin sombra, estos picos son menos notables, pero a√∫n est√°n all√≠.  Los grupos de fragmentos sufren porque el oplog se ve particularmente afectado por la eliminaci√≥n, y la <strong>eliminaci√≥n es parte del trabajo del equilibrador</strong> .  El equilibrador elimina de manera confiable y de buen gusto documentos por decenas de miles en un corto per√≠odo de tiempo. <br><br><h2>  Numero de conexiones </h2><br>  El siguiente factor a considerar es el <strong>l√≠mite en el n√∫mero de conexiones en instancias de MongoDB</strong> .  De manera predeterminada, no hay restricciones, <strong>excepto los recursos del sistema operativo:</strong> puede conectarse mientras lo permita. <br><br>  Sin embargo, cuanto m√°s concurrentes solicitudes concurrentes, m√°s lento se ejecutan.  <strong>El rendimiento se degrada de forma no lineal</strong> .  Por lo tanto, si nos llega un aumento de solicitudes, es mejor atender el 80% que no atender el 100%.  El n√∫mero de conexiones debe limitarse directamente a MongoDB. <br><br>  Pero hay errores que pueden causar problemas debido a esto.  En particular, el <strong>grupo de conexiones en el lado MongoDB es com√∫n tanto para las conexiones intracluster de usuarios como de servicios</strong> .  Si la aplicaci√≥n "comi√≥" todas las conexiones de este grupo, se podr√≠a violar la integridad en el cl√∫ster. <br><br>  Aprendimos sobre esto cuando √≠bamos a reconstruir el √≠ndice, y dado que necesit√°bamos eliminar la unicidad del √≠ndice, el procedimiento pas√≥ por varias etapas.  En MongoDB, no puede construir al lado del √≠ndice de la misma manera, pero sin unicidad.  Por lo tanto, quer√≠amos: <br><br><ul><li>  Construye un √≠ndice similar sin unicidad <br></li><li>  eliminar el √≠ndice con unicidad; <br></li><li>  Cree un √≠ndice sin unicidad en lugar de remoto; <br></li><li>  Eliminar temporal. <br></li></ul><br>  Cuando el √≠ndice temporal todav√≠a se estaba completando en la secundaria, comenzamos a eliminar el √≠ndice √∫nico.  En este punto, MongoDB secundario anunci√≥ su bloqueo.  Se bloquearon algunos metadatos, y en la mayor√≠a de los registros se detuvieron: colgaron en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><u>grupo de conexiones</u></a> y esperaron a que confirmaran que el registro hab√≠a pasado.  Todas las lecturas en secundaria tambi√©n se detuvieron porque se captur√≥ el registro global. <br><br>  El cl√∫ster en un estado tan interesante tambi√©n perdi√≥ su conectividad.  A veces aparec√≠a y cuando dos comentarios se conectaban entre s√≠, intentaban tomar una decisi√≥n en su estado que no pod√≠an hacer, porque ten√≠an un bloqueo global. <br><br><blockquote>  Moraleja de la historia: el n√∫mero de conexiones debe ser monitoreado. </blockquote><br>  Hay un rastrillo conocido de MongoDB, que todav√≠a es atacado con tanta frecuencia que decid√≠ dar un breve paseo. <br><br><h2>  No perder documentos </h2><br>  Si env√≠a una solicitud por √≠ndice a MongoDB, es posible que la <strong>solicitud no devuelva todos los documentos</strong> que satisfacen la condici√≥n, y en casos completamente inesperados.  Esto se debe al hecho de que cuando vamos al principio del √≠ndice, el documento, que al final, se mueve al principio para aquellos documentos que pasamos.  Esto se debe √∫nicamente <strong>a la mutabilidad del √≠ndice</strong> .  Para una iteraci√≥n confiable, use <strong>√≠ndices en campos no estables</strong> y no habr√° dificultades. <br>  MongoDB tiene sus propias vistas sobre qu√© √≠ndices usar.  La soluci√≥n es simple: <strong>con la ayuda de $ hint, forzamos a MongoDB a usar el √≠ndice que especificamos</strong> . <br><br><h2>  Tama√±os de colecci√≥n </h2><br>  Nuestra startup se est√° desarrollando, hay muchos datos, pero no quiero agregar discos, ya hemos agregado tres veces en el √∫ltimo mes.  Veamos qu√© se almacena en nuestros datos, observe el tama√±o de los documentos.  ¬øC√≥mo entender en qu√© parte de la colecci√≥n puedes reducir el tama√±o?  Seg√∫n dos par√°metros. <br><br><ul><li>  <strong>El tama√±o de</strong> <strong>documentos espec√≠ficos</strong> para jugar con su longitud: <code>Object.bsonsize()</code> ; <br></li><li>  <strong>Seg√∫n el</strong> <strong>tama√±o</strong> <strong>promedio</strong> <strong>del documento en</strong> <strong>la</strong> <strong>colecci√≥n</strong> : <code>db.c.stats().avgObjectSize</code> . <br></li></ul><br><h3>  ¬øC√≥mo afectar el tama√±o del documento? </h3><br>  Tengo respuestas no espec√≠ficas a esta pregunta.  Primero, un <strong>nombre de campo largo aumenta el tama√±o del documento.</strong>  En cada documento, se copian todos los nombres de campo, por lo que si el documento tiene un nombre de campo largo, entonces el tama√±o del nombre debe agregarse al tama√±o de cada documento.  Si tiene una colecci√≥n con una gran cantidad de documentos peque√±os en varios campos, nombre los campos con nombres cortos: "A", "B", "CD": un m√°ximo de dos letras.  <strong>En el disco, esto se compensa con la compresi√≥n</strong> , pero todo se almacena en la memoria cach√© tal como est√°. <br><br>  El segundo consejo es que a veces <strong>algunos campos con baja cardinalidad se pueden colocar en el nombre de la colecci√≥n</strong> .  Por ejemplo, dicho campo puede ser un idioma.  Si tenemos una colecci√≥n con traducciones al ruso, ingl√©s, franc√©s y un campo con informaci√≥n sobre el idioma almacenado, el valor de este campo se puede poner en el nombre de la colecci√≥n.  Por lo tanto, <strong>reduciremos el tama√±o de los documentos</strong> y podemos <strong>reducir el n√∫mero y el tama√±o de los √≠ndices</strong> : ¬°un <strong>gran</strong> ahorro!  Esto no siempre se puede hacer, porque a veces hay √≠ndices dentro del documento que no funcionar√°n si la colecci√≥n se divide en diferentes colecciones. <br><br>  √öltimo consejo sobre el tama√±o del documento: <strong>use el campo _id</strong> .  Si sus datos tienen una clave √∫nica natural, col√≥quela directamente en id_field.  Incluso si la clave es compuesta, use una identificaci√≥n compuesta.  Est√° perfectamente indexado.  Solo hay un peque√±o rastrillo: si su jefe de clasificaci√≥n a veces cambia el orden de los campos, la identificaci√≥n con los mismos valores de campo, pero con un orden diferente se considerar√° una identificaci√≥n diferente en t√©rminos de un √≠ndice √∫nico en MongoDB.  En algunos casos, esto puede suceder en Go. <br><br><h2>  Tama√±os de √≠ndice </h2><br>  <strong>El √≠ndice almacena una copia de los campos que est√°n incluidos en √©l</strong> .  El tama√±o del √≠ndice consta de los datos que se indexan.  Si estamos tratando de indexar campos grandes, prep√°rese para que el tama√±o del √≠ndice sea grande. <br><br>  El segundo momento infla fuertemente los √≠ndices: los <strong>campos de matriz en el √≠ndice multiplican otros campos del documento en este √≠ndice</strong> .  Tenga cuidado con las matrices grandes en los documentos: o no indexe otra cosa a la matriz, o juegue con el orden en que se enumeran los campos en el √≠ndice. <br><br>  <strong>El orden de los campos es importante</strong> , <strong>especialmente si uno de los campos de √≠ndice es una matriz</strong> .  Si los campos difieren en cardinalidad, y en un campo el n√∫mero de valores posibles es muy diferente del n√∫mero de valores posibles en otro, entonces tiene sentido construirlos aumentando la cardinalidad.  <strong>Puede guardar f√°cilmente el 50% del tama√±o del √≠ndice si intercambia campos con diferente cardinalidad.</strong>  La permutaci√≥n de los campos puede dar una reducci√≥n m√°s significativa en el tama√±o. <br><br>  A veces, cuando el campo contiene un valor grande, no necesitamos comparar este valor m√°s o menos, sino una comparaci√≥n clara de igualdad.  Luego, el <strong>√≠ndice en el campo con contenido pesado</strong> puede ser <strong>reemplazado por el √≠ndice en hash de este campo</strong> .  Se almacenar√°n copias del hash en el √≠ndice, no copias de estos campos. <br><br><h2>  Eliminar documentos </h2><br>  Ya mencion√© que eliminar documentos es una operaci√≥n desagradable y <strong>es mejor no eliminarlos si es posible.</strong>  Al dise√±ar un esquema de datos, intente considerar minimizar la eliminaci√≥n de datos individuales o eliminar colecciones enteras.  podr√≠an eliminarse con colecciones completas.  Eliminar colecciones es una operaci√≥n barata, y eliminar miles de documentos individuales es una operaci√≥n dif√≠cil. <br><br>  Si a√∫n necesita eliminar muchos documentos, aseg√∫rese de <strong>acelerar</strong> , de lo contrario, la eliminaci√≥n masiva de documentos afectar√° la latencia de la lectura y ser√° desagradable.  Esto es especialmente malo para la latencia en secundaria. <br><br>  Vale la pena hacer alg√∫n tipo de "bol√≠grafo" para acelerar el acelerador: es muy dif√≠cil aumentar el nivel la primera vez.  Lo pasamos tantas veces que se acelera la tercera, cuarta vez.  Inicialmente, considere la posibilidad de apretarlo. <br><br>  <strong>Si elimina m√°s del 30% de una colecci√≥n grande, transfiera documentos en vivo a la colecci√≥n vecina</strong> y elimine la colecci√≥n anterior en su conjunto.  Est√° claro que hay matices, porque la carga cambia de la colecci√≥n antigua a la nueva, pero cambia si es posible. <br><br>  Otra forma de eliminar documentos es el √≠ndice <strong>TTL</strong> , que es un √≠ndice que indexa el campo que contiene la marca de tiempo Mongo, que contiene la fecha en que muri√≥ el documento.  Cuando llegue este momento, MongoDB eliminar√° este documento autom√°ticamente. <br><br>  El √≠ndice TTL es conveniente, pero <strong>no hay limitaci√≥n en la implementaci√≥n.</strong>  MongoDB no se preocupa por c√≥mo eliminar estas eliminaciones.  Si intenta eliminar un mill√≥n de documentos al mismo tiempo, durante unos minutos tendr√° un cl√∫ster inoperable que solo se ocupa de la eliminaci√≥n y nada m√°s.  Para evitar que esto suceda, agregue algo de <strong>aleatoriedad</strong> , <strong>difunda el TTL</strong> tanto como lo permita su l√≥gica comercial y los efectos especiales sobre la latencia.  Es imperativo difuminar TTL si tiene razones l√≥gicas comerciales naturales que concentran la eliminaci√≥n en un momento dado. <br><br><h2>  Sharding </h2><br>  Intentamos posponer este momento, pero ha llegado, todav√≠a tenemos que escalar horizontalmente.  Para MongoDB, esto es fragmentaci√≥n. <br><br><blockquote>  Si duda de que necesita fragmentaci√≥n, entonces no lo necesita. </blockquote><br>  Sharding complica la vida de un desarrollador y devops en una variedad de formas.  En una empresa, lo llamamos impuesto de fragmentaci√≥n.  Cuando fragmentamos una colecci√≥n, el <strong>rendimiento espec√≠fico de la colecci√≥n disminuye</strong> : MongoDB requiere un √≠ndice separado para la divisi√≥n, y se deben pasar par√°metros adicionales a la solicitud para que pueda ejecutarse de manera m√°s eficiente. <br><br>  Algunas cosas de fragmentaci√≥n simplemente no funcionan bien.  Por ejemplo, es una mala idea usar consultas con <code>skip</code> , especialmente si tiene muchos documentos.  Usted da el comando: "Saltar 100,000 documentos". <br><br>  MongoDB piensa de esta manera: ‚ÄúPrimero, segundo, tercero ... cien mil√©simos, vamos m√°s all√°.  Y se lo devolveremos al usuario ". <br><br>  En una colecci√≥n no compartida, MongoDB realizar√° una operaci√≥n en alg√∫n lugar dentro de s√≠ mismo.  En forma de fragmento, ella realmente lee y env√≠a todos los 100,000 documentos a un proxy de fragmentaci√≥n en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><u>mongos</u></a> , que de alguna manera filtrar√° y descartar√° los primeros 100,000. Una caracter√≠stica desagradable a tener en cuenta. <br><br>  <strong>El c√≥digo ciertamente se volver√° m√°s complicado con el fragmentaci√≥n: tendr√°</strong> que arrastrar la clave de fragmentaci√≥n a muchos lugares.  Esto no siempre es conveniente, y no siempre es posible.  Algunas consultas ir√°n ya sea de difusi√≥n o multidifusi√≥n, lo que tampoco agrega escalabilidad.  Llegue a la elecci√≥n de una clave mediante la cual el fragmentaci√≥n ser√° m√°s preciso. <br><br>  <strong>En colecciones de fragmentos, la operaci√≥n de <code>count</code> rompe</strong> .  Ella comienza a devolver un n√∫mero m√°s que en la realidad: puede mentir 2 veces.  La raz√≥n radica en el proceso de equilibrio, cuando los documentos se vierten de un fragmento a otro.  Cuando los documentos se vierten en el fragmento vecino, pero a√∫n no se han eliminado en el original, el <code>count</code> todos modos.  Los desarrolladores de MongoDB no llaman a esto un error, es una caracter√≠stica.  No s√© si lo arreglar√°n o no. <br><br>  <strong>Un cl√∫ster aleatorio es mucho m√°s dif√≠cil de administrar</strong> .  Devops dejar√° de saludarte, porque el proceso de eliminar una copia de seguridad se vuelve radicalmente m√°s complicado.  Al fragmentar, la necesidad de automatizaci√≥n de infraestructura parpadea como una alarma de incendio, algo que podr√≠a haber hecho sin antes. <br><br><h3>  C√≥mo funciona el sharding en MongoDB </h3><br>  Hay una colecci√≥n, queremos dispersarla de alguna manera por fragmentos.  Para hacer esto, <strong>MongoDB divide la colecci√≥n en fragmentos</strong> utilizando la clave de fragmento, tratando de dividirlos en partes iguales en el espacio de la clave de fragmento.  Luego viene el equilibrador, que <strong>distribuye</strong> diligentemente <strong>estos trozos de acuerdo con los fragmentos en el grupo</strong> .  Adem√°s, al equilibrador no le importa cu√°nto pesan estos trozos y cu√°ntos documentos hay en ellos, ya que el equilibrio se realiza pieza por pieza. <br><br><h2>  Clave de fragmentaci√≥n </h2><br>  ¬øTodav√≠a decides qu√© fragmentar?  Bueno, la primera pregunta es c√≥mo elegir una clave de fragmentaci√≥n.  Una buena clave tiene varios par√°metros: <strong>alta cardinalidad</strong> , <strong>falta de estabilidad</strong> y se <strong>adapta bien en solicitudes frecuentes</strong> . <br><br>  La elecci√≥n natural de una clave de fragmentaci√≥n es la clave principal: el campo id.  Si el campo id es adecuado para fragmentar, entonces es mejor fragmentar directamente en √©l.  Esta es una excelente opci√≥n: tiene una buena cardinalidad, no es estable, pero lo bien que se adapta a las solicitudes frecuentes es la especificidad de su negocio.  Construye sobre tu situaci√≥n. <br><br>  Dar√© un ejemplo de una clave de fragmentaci√≥n fallida.  Ya mencion√© la colecci√≥n de traducciones - traducciones.  Tiene un campo de idioma que almacena el idioma.  Por ejemplo, la colecci√≥n admite 100 idiomas y compartimos el idioma.  Esto es malo: cardinalidad, el n√∫mero de valores posibles es de solo 100 piezas, lo cual es peque√±o.  Pero esto no es lo peor, tal vez la cardinalidad sea suficiente para estos fines.  Peor a√∫n, tan pronto como barajamos el idioma, inmediatamente descubrimos que tenemos 3 veces m√°s usuarios de habla inglesa que el resto.  Tres veces m√°s solicitudes llegan al fragmento desafortunado en el que se encuentra el ingl√©s que a todos los dem√°s combinados. <br><br>  Por lo tanto, debe tenerse en cuenta que a veces una clave de fragmento tiende naturalmente a una distribuci√≥n de carga desigual. <br><br><h3>  Equilibrio </h3><br>  Llegamos a fragmentar cuando la necesidad ha madurado para nosotros: nuestro cl√∫ster MongoDB cruje, cruje con sus discos, procesador, con todo lo que podemos.  A donde ir  En ninguna parte, y heroicamente barajamos los talones de las colecciones.  Fragmentamos, lanzamos y de repente descubrimos que el <strong>equilibrio no es gratis</strong> . <br><br>  El equilibrio pasa por varias etapas.  El equilibrador elige trozos y fragmentos, de d√≥nde y d√≥nde se transferir√°.  El trabajo adicional se realiza en dos fases: primero, los <strong>documentos se copian</strong> del origen al destino, y luego los documentos que se copiaron <strong>se eliminan</strong> . <br><br>  Nuestro fragmento est√° sobrecargado, contiene todas las colecciones, pero la primera parte de la operaci√≥n es f√°cil para √©l.  Pero el segundo, la extracci√≥n, es bastante desagradable, ya que pondr√° un fragmento en los om√≥platos y ya sufrir√° bajo carga. <br><br>  El problema se agrava por el hecho de que si equilibramos muchos fragmentos, por ejemplo, miles, entonces con la configuraci√≥n predeterminada, todos estos fragmentos se copian primero, y luego entra un eliminador y comienza a eliminarlos en masa.  En este punto, el procedimiento ya no se ve afectado y solo tiene que mirar tristemente lo que est√° sucediendo. <br><br>  Por lo tanto, si se acerca a fragmentar un cl√∫ster sobrecargado, debe planificar, ya que el <strong>equilibrio lleva tiempo.</strong>  Es aconsejable aprovechar este tiempo no en horario de m√°xima audiencia, sino en per√≠odos de baja carga.  Balancer: una pieza de repuesto desconectada.  Puede acercarse al equilibrio primario en modo manual, apagar el equilibrador en horario de m√°xima audiencia y encenderlo cuando la carga haya disminuido para permitirse m√°s. <br><br>  Si las capacidades de la nube a√∫n le permiten escalar verticalmente, es mejor mejorar la fuente de fragmentos de antemano para reducir ligeramente todos estos efectos especiales. <br><br>  <b>El fragmentaci√≥n debe estar cuidadosamente preparado.</b> <br><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HighLoad ++ Siberia 2019</a> llegar√° a Novosibirsk los d√≠as 24 y 25 de junio.  HighLoad ++ Siberia es una oportunidad para que los desarrolladores de Siberia escuchen informes, hablen sobre temas de alta carga y se sumerjan en el entorno "donde todos tienen lo suyo", sin volar m√°s de tres mil kil√≥metros a Mosc√∫ o San Petersburgo.  De las 80 solicitudes, el Comit√© del Programa aprob√≥ 25, y le informamos sobre todos los dem√°s cambios en el programa, anuncios de informes y otras noticias en nuestra lista de correo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Suscr√≠base</a> para mantenerse informado. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454748/">https://habr.com/ru/post/454748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454736/index.html">Soporte de Visual Studio 2019 en PVS-Studio</a></li>
<li><a href="../454738/index.html">Soporte de Visual Studio 2019 en PVS-Studio</a></li>
<li><a href="../454740/index.html">Mayo de 2019 Joomla Digest</a></li>
<li><a href="../454742/index.html">Al menos un truco de Vim que no conoc√≠as</a></li>
<li><a href="../454744/index.html">Descripci√≥n general de los informes de seguimiento de Java de la conferencia RigaDevDays</a></li>
<li><a href="../454750/index.html">Interfaz de usuario r√°pida - galopando por Europa</a></li>
<li><a href="../454754/index.html">¬øCu√°ndo vale la pena verificar la hip√≥tesis de no menos efectividad?</a></li>
<li><a href="../454756/index.html">Verificando la efectividad del sitio y la configuraci√≥n publicitaria, el costo de atraer clientes de la empresa mayorista</a></li>
<li><a href="../454758/index.html">C√≥mo moverse por Windows Defender de forma econ√≥mica y alegre: ofuscando a Mimikatz</a></li>
<li><a href="../454760/index.html">Intel Optane Memory M15: m√°s r√°pido que M10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>