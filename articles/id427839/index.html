<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚟 🛁 🤶🏼 Otorisasi pengguna di Django melalui GSSAPI dan pendelegasian hak pengguna ke server 💃🏾 🔄 ✅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini, kolega saya dan saya perlu menerapkan otorisasi transparan (SSO) dalam proyek kami. Sekarang ada sedikit informasi tentang topik ini, t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Otorisasi pengguna di Django melalui GSSAPI dan pendelegasian hak pengguna ke server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427839/">  Baru-baru ini, kolega saya dan saya perlu menerapkan otorisasi transparan (SSO) dalam proyek kami.  Sekarang ada sedikit informasi tentang topik ini, terutama dalam bahasa Rusia.  Untuk alasan ini, diputuskan untuk berbagi dengan keturunan implementasi fungsi tersebut. <br><br>  Jadi tugasnya adalah sebagai berikut: perlu mengkonfigurasi otorisasi transparan melalui GSSAPI dari pengguna ke server, dan kemudian dapat pergi ke database atas nama pengguna ini. <br><a name="habracut"></a><br>  Kami memiliki: <br><br><ul><li>  mengkonfigurasi server Kerberos + LDAP </li><li>  Server PostgreSQL dikonfigurasi untuk otorisasi secara eksklusif oleh GSSAPI </li><li>  Server aplikasi Django + UWSGI + nginx dengan Kerberos terkonfigurasi </li></ul><br>  Awalnya, idenya adalah untuk mendelegasikan otorisasi pengguna dalam aplikasi ke server web, menyiapkan otorisasi GSSAPI di atasnya, dan Django untuk menunjukkan bahwa kami akan bekerja dengan RemoteUser.  Sebagai bagian dari uraian ini, saya tidak akan berbicara tentang cara mengkonfigurasi nginx agar berfungsi pada GSSAPI, dan Django untuk mendelegasikan otorisasi ke server web, ini adalah bagian yang terdokumentasi dengan baik, dan ada banyak artikel tentang ini.  Setelah penyetelan dan pengujian, kami menyadari bahwa ini sama sekali bukan yang kami butuhkan.  Ya, kami dapat mengotorisasi dan mendapatkan nama utama pengguna, tetapi kami tidak berhak melakukan apa pun atas nama pengguna ini. <br><br>  Kemudian kami berusaha menemukan sesuatu yang bermanfaat di Internet.  Mereka relatif sukses, dan paket-paket berikut untuk Django ditemukan: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Django-kerberos</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Django-auth-spnego</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Django-auth-kerbero</a> .  Faktanya, semua paket ini melakukan hal yang sama, beberapa tidak diperbarui untuk waktu yang lama dan harus "menari dengan rebana" untuk waktu yang lama, sehingga setidaknya ada sesuatu yang berhasil.  Mereka menyediakan fungsionalitas yang sama dengan bundel nginx (GSSAPI) + Django (RemouteUser).  Semua dari mereka membantu menyelesaikan masalah dengan kode sumber mereka. <br><br>  Selanjutnya, paket-paket berikut ditemukan untuk bekerja dengan GSSAPI di Python: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ccs-pykerberos</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">python-gssapi</a> , bahkan mereka mengimpor implementasi standar RFC2744 dan RFC4559 dalam Python.  Menggunakan paket ccs-pykerberos, kami baru saja berhasil mengimplementasikan fungsionalitas yang dimaksud, maka saya akan menunjukkan sedikit kode di mana komunikasi dengan LDAP dan pengguna diimplementasikan, serta permintaan ke database atas namanya. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.shortcuts <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.<span class="hljs-keyword"><span class="hljs-keyword">template</span></span>.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TemplateResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kerberos <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 def <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(request): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.META: kind, initial_client_token = request.META[<span class="hljs-string"><span class="hljs-string">'HTTP_AUTHORIZATION'</span></span>].split(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> kind == <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span>: service = <span class="hljs-string"><span class="hljs-string">'HTTP@django-server-pricipal.che.ru'</span></span> _ignore_result, krb_context = kerberos.authGSSServerInit(service) kerberos.authGSSServerStep(krb_context, initial_client_token) principal = kerberos.authGSSServerUserName(krb_context) _ignore_result = kerberos.authGSSServerStoreDelegate(krb_context) conn = psycopg2.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>( host=<span class="hljs-string"><span class="hljs-string">'postgresql-server-host'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=principal, dbname=<span class="hljs-string"><span class="hljs-string">'request-db'</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> = conn.<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>("SELECT version()") records = <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span>.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: unauthorized_template_name = <span class="hljs-string"><span class="hljs-string">'gssapi_test/unauthorized.html'</span></span> response = TemplateResponse(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, status=<span class="hljs-number"><span class="hljs-number">401</span></span>) response[<span class="hljs-string"><span class="hljs-string">'WWW-Authenticate'</span></span>] = <span class="hljs-string"><span class="hljs-string">'Negotiate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response content = {<span class="hljs-string"><span class="hljs-string">'records'</span></span>: records} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render(request, <span class="hljs-string"><span class="hljs-string">'gssapi_test/index.html'</span></span>, content)</code> </pre> <br>  Pertama, kita perlu memeriksa apakah header otorisasi diberikan kepada kita, jika tidak, kita harus mengirim header dengan Negosiasi sebagai tanggapan, dan lagi menunggu token dari pengguna Negosiasi.  Token ini terlihat seperti kain besar yang disandikan di base64.  Setelah menerima token, kami menginisialisasi (mengesahkan) server aplikasi kami di layanan LDAP menggunakan fungsi authGSSServerInit ().  Selanjutnya, kami akan mengotorisasi dalam layanan LDAP atas nama pengguna, menggunakan fungsi authGSSServerStep () hanya untuk token yang diterima dari header.  Kemudian kita mendapatkan prinsipal dari pengguna, yang akan kita gunakan sebagai pengguna, ketika mengeksekusi query dalam database.  Dan juga, kita perlu membuat cache bitel Kerberos, yang akan digunakan secara otomatis untuk mengotorisasi kita di PostgreSQL, fungsi authGSSServerStoreDelegate ().  Fungsi ini hanya tersedia dalam versi terbaru dari paket ini, jadi Anda perlu mengkloning sumber Anda dengan git dan build. <br><br>  Browser harus dikonfigurasi untuk mengembalikan Negosiasi, secara default opsi ini dinonaktifkan.  Semua tes dilakukan pada Firefox di CentOS7, dan CentOS7 diinstal pada semua server. <br><br>  Selain itu, kami mungkin memiliki masalah di mana cache tiket yang dihasilkan oleh fungsi kami tidak akan terlihat oleh proses kami dan, oleh karena itu, kami akan mendapatkan bahwa pengguna tidak diotorisasi di GSSAPI.  Ini diselesaikan dengan mengatur caching tiket di krb5.conf.  Untuk berjaga-jaga, saya akan memberikan contoh konfigurasi kami: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/krb5.conf</b> <div class="spoiler_text"><pre> <code class="python hljs">includedir /etc/krb5.conf.d/ includedir /var/lib/sss/pubconf/krb5.include.d/ [libdefaults] default_realm = DOMAIN.RU dns_lookup_realm = false dns_lookup_kdc = false rdns = false ticket_lifetime = <span class="hljs-number"><span class="hljs-number">24</span></span>h forwardable = true udp_preference_limit = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    #default_ccache_name = KEYRING:persistent:%{uid} #    KRB5_KTNAME     default_keytab_name = FILE:/etc/httpd/http.keytab [realms] DOMAIN.RU = { kdc = ldap-server-host.domain.ru:88 master_kdc = ldap-server-host.domain.ru:88 admin_server = ldap-server-host.domain.ru:749 kpasswd_server = ldap-server-host.domain.ru:464 default_domain = domain.ru pkinit_anchors = FILE:/etc/domain/ca.crt } [domain_realm] .domain.ru = DOMAIN.RU domain.ru = DOMAIN.RU .domain.ru = DOMAIN.RU</span></span></code> </pre><br></div></div><br>  Sepotong kode ini dibuat untuk membantu memahami bagaimana otorisasi dan pendelegasian hak terjadi, kemudian dengan pengetahuan ini Anda dapat membangun dekorator otorisasi dan backlink komunikasi dengan database.  Paket ccs-pykerberos dikembangkan oleh Apple untuk kebutuhan internalnya, masing-masing, saya akan memberikan tautan ke kode mereka, di mana mereka menggunakannya.  Dia banyak membantu kami dalam memahami bahwa mereka mengembangkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ccs-calendarserver / twistedcaldav / authkerb.py</a> <br><br><h4>  Tautan yang bermanfaat </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Konfigurasikan Kerberos + LDAP</a> </li><li>  <a href="">Menerapkan tugas serupa di Jawa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mengkonfigurasi nginx agar berfungsi di SPNEGO</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Spesifikasi RFC2744</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Spesifikasi RFC4559 untuk SPNEGO</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id427839/">https://habr.com/ru/post/id427839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id427821/index.html">Dell Inspiron 5570: Laptop Hemat Biaya untuk Rumah dan Kantor</a></li>
<li><a href="../id427825/index.html">Slurm-2: awal. Rencana kerja. Docker: perangkat, Dockerfile, docker-compose</a></li>
<li><a href="../id427829/index.html">Mengawasi atau melakukan outsourcing? Itu pertanyaannya</a></li>
<li><a href="../id427833/index.html">Laporan Konferensi Joker 2018</a></li>
<li><a href="../id427837/index.html">Hari-hari pertama di tim pengembangan - seperti yang terjadi pada kami</a></li>
<li><a href="../id427841/index.html">Magic Leap Scam</a></li>
<li><a href="../id427843/index.html">Cara tidur benar dan salah</a></li>
<li><a href="../id427845/index.html">Cara memuat jutaan bintang di iPhone</a></li>
<li><a href="../id427847/index.html">Keingintahuan dan penundaan dalam pembelajaran mesin</a></li>
<li><a href="../id427849/index.html">Garis lurus dengan TM. v3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>