<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî¶ üëäüèæ ü•î bear_hug: jogos em arte ASCII em Python3.6 + üçù ü§ûüèΩ üà∑Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para meus jogos na arte ASCII, escrevi a biblioteca bear_hug com uma fila de eventos, uma cole√ß√£o de widgets, suporte ao ECS e outras pequenas coisas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>bear_hug: jogos em arte ASCII em Python3.6 +</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470950/"><img src="https://habrastorage.org/webt/b0/zu/vj/b0zuvjk4xdzcznbys9oslxl_veo.png"><br><br>  Para meus jogos na arte ASCII, escrevi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a biblioteca bear_hug</a> com uma fila de eventos, uma cole√ß√£o de widgets, suporte ao ECS e outras pequenas coisas √∫teis.  Neste artigo, veremos como us√°-lo para criar um jogo de trabalho m√≠nimo. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Isen√ß√µes de responsabilidade</b> <div class="spoiler_text"><ul><li>  Sou o √∫nico desenvolvedor da biblioteca, portanto, posso ser tendencioso. </li><li>  bear_hug √© essencialmente um inv√≥lucro em torno de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bearlibterminal</a> , portanto n√£o haver√° opera√ß√µes de n√≠vel relativamente baixo com glifos. </li><li>  Existe uma funcionalidade semelhante no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">clubsandwich</a> , mas n√£o a usei e n√£o posso compar√°-la. </li></ul></div></div><br>  Sob o cap√¥ de bear_hug est√° o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bearlibterminal</a> , uma biblioteca SDL para criar uma janela de pseudo-console.  Ou seja, em TTY puro, como algumas maldi√ß√µes, n√£o funcionar√°.  Mas a imagem √© a mesma no Linux, no Windows e n√£o depende das configura√ß√µes do terminal do usu√°rio.  Isso √© importante, especialmente para jogos, porque quando voc√™ altera a fonte ASCII-art, Deus pode se transformar no que: <br><br><img src="https://habrastorage.org/webt/ys/rh/6f/ysrh6fhay5u9slnpwvqn53is1ek.png"><br>  <i>O mesmo desenho em sua forma original e ap√≥s copiar e colar em diferentes programas</i> <br><br>  Obviamente, a biblioteca foi escrita para projetos de larga escala.  Mas para n√£o se distrair com o design e a arquitetura dos jogos, neste artigo, criaremos algo simples.  Um projeto de uma noite, no qual h√° algo para mostrar as fun√ß√µes b√°sicas da biblioteca.  Ou seja - um clone simplificado desses mesmos tanques com Dandy (eles tamb√©m s√£o a Cidade da Batalha).  Haver√° tanque de um jogador, tanques inimigos, paredes destrut√≠veis, som e pontua√ß√£o.  Mas o menu principal, os n√≠veis e os b√¥nus selecionados n√£o ser√£o.  N√£o porque seria imposs√≠vel adicion√°-los, mas porque esse projeto nada mais √© do que um mundo da Hallow. <br><br><img src="https://habrastorage.org/webt/8k/e7/my/8ke7mymnrejpei7isjbxtbwvyjs.png"><br>  <i>Haver√° um gameover, mas n√£o haver√° vit√≥ria.</i>  <i>Porque a vida √© dor.</i> <br><br>  Todo o material usado no artigo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no github</a> ;  a pr√≥pria biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tamb√©m</a> est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em PyPI</a> (sob a licen√ßa MIT). <br><br>  Primeiro de tudo, precisamos de ativos.  Para desenhar arte ASCII, eu uso o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">REXpaint</a> de Josh Ge (tamb√©m conhecido como Kyzrati), o desenvolvedor do bagel de fic√ß√£o cient√≠fica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cogmind</a> .  O editor √© gratuito, embora n√£o seja de c√≥digo aberto;  a vers√£o oficial √© apenas para Windows, mas tudo funciona bem no vinho.  A interface √© bastante clara e conveniente: <br><br><img src="https://habrastorage.org/webt/jf/x-/bi/jfx-bigu3sedblmkuspxh_pd4d4.png"><br><br>  N√≥s salvamos no formato bin√°rio local .xp e copiamos de <code>/path/to/rexpaint/images</code> para a pasta com o jogo futuro.  Em princ√≠pio, o carregamento de imagens de arquivos .txt tamb√©m √© suportado, mas √© obviamente imposs√≠vel salvar as cores de caracteres individuais em um arquivo de texto.  Sim, e editar arte ASCII em um notebook n√£o √© conveniente para mim pessoalmente.  Para n√£o codificar as coordenadas e o tamanho de cada elemento, esses dados s√£o armazenados em um arquivo JSON separado: <br><br><div class="spoiler">  <b class="spoiler_title">battlecity.json</b> <div class="spoiler_text"><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"player_r"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"xsize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ysize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"player_l"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-attr"><span class="hljs-attr">"xsize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ysize"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> }, ... ]</code> </pre> <br></div></div><br>  Soa sob licen√ßas gratuitas baixadas da Internet.  At√© agora, apenas o .wav √© suportado.  Isso √© tudo com ativos, voc√™ pode come√ßar a codificar.  Primeiro de tudo, voc√™ precisa inicializar o terminal e a fila de eventos. <br><br><div class="spoiler">  <b class="spoiler_title">game.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  terminal = BearTerminal(font_path='cp437_12x12.png', size='91x60', title='AsciiCity', filter=['keyboard', 'mouse']) #   dispatcher = BearEventDispatcher() # ,         loop = BearLoop(terminal, dispatcher)</span></span></code> </pre> <br></div></div><br>  O terminal √© a janela real do jogo.  Voc√™ pode colocar widgets nele e lan√ßar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">eventos de entrada</a> conforme necess√°rio.  Como teclas ao criar um terminal, voc√™ pode usar todas as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">op√ß√µes de terminal bearlibterminal</a> ;  nesse caso, definimos a fonte, o tamanho da janela (em caracteres), o t√≠tulo da janela e os m√©todos de entrada que nos interessam. <br><br>  Quanto √† fila de eventos, ela possui uma interface muito simples: dispatcher.add_event (event) adiciona o evento √† fila, e dispatcher.register_listener (listener, event_types) permite que voc√™ se inscreva.  Um assinante (por exemplo, um widget ou componente) deve ter um retorno de chamada on_event, que recebe um evento como um √∫nico argumento e n√£o retorna nada ou retorna outro evento ou conjunto de eventos.  O evento em si consiste em tipo e valor;  o tipo aqui n√£o est√° no sentido de str ou int, mas no sentido de "variedade", por exemplo, 'key_down' ou 'tick'.  A fila aceita apenas eventos dos tipos conhecidos (internos ou criados pelo usu√°rio) e os envia para on_event a todos aqueles que se inscreverem nesse tipo.  Ele n√£o verifica os valores de forma alguma, mas existem conven√ß√µes na biblioteca sobre qual √© um valor v√°lido para cada tipo de evento. <br><br>  Primeiro, colocamos alguns ouvintes na fila.  Esta √© a classe base para objetos que podem se inscrever em eventos, mas n√£o s√£o widgets ou componentes.  Em princ√≠pio, n√£o √© necess√°rio us√°-lo, desde que o signat√°rio possua o m√©todo on_event. <br><br><div class="spoiler">  <b class="spoiler_title">Ouvintes</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       dispatcher.register_listener(ClosingListener(), ['misc_input', 'tick']) #       dispatcher.register_listener(EntityTracker(), ['ecs_create', 'ecs_destroy']) #   jukebox = SoundListener({'shot': 'shot.wav', 'explosion': 'explosion.wav'}) # https://freesound.org/people/EMSIarma/sounds/108852/ # https://freesound.org/people/FlashTrauma/sounds/398283/ dispatcher.register_listener(jukebox, 'play_sound')</span></span></code> </pre> <br></div></div><br>  Uma lista completa de tipos de eventos internos est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">na documenta√ß√£o</a> .  √â f√°cil ver que existem eventos para a cria√ß√£o e destrui√ß√£o de entidades, mas n√£o para danos.  Como teremos objetos que n√£o se separam de um tiro (as paredes e o tanque do jogador), vamos cri√°-lo: <br><br><div class="spoiler">  <b class="spoiler_title">Registro de tipo de evento</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,    #   dispatcher.register_event_type('ac_damage') #       logger = LoggingListener(sys.stderr) dispatcher.register_listener(logger, ['ac_damage', 'play_sound'])</span></span></code> </pre> <br></div></div><br>  Concordamos que, como valor, esse evento ter√° uma tupla do ID da entidade que sofreu o dano e do valor do dano.  LoggingListener √© apenas uma ferramenta de depura√ß√£o que imprime todos os eventos recebidos onde quer que eles digam, neste caso no stderr.  Nesse caso, eu queria ter certeza de que o dano passasse corretamente e que o som fosse solicitado sempre que deveria. <br><br>  Com os Listeners, por enquanto, voc√™ pode adicionar o primeiro widget.  Temos este campo de jogo da classe ECSLayout.  Esse √© um layout, que pode colocar widgets nas entidades e mov√™-los em resposta a eventos ecs_move e, ao mesmo tempo, considerar colis√µes.  Como a maioria dos widgets, ele possui dois argumentos obrigat√≥rios: uma lista aninhada de caracteres (possivelmente espa√ßo vazio ou Nenhum) e uma lista aninhada de cores para cada caractere.  As cores nomeadas s√£o aceitas como cores, RGB no formato `0xAARRGGBB` (ou` 0xARGB`, `0xRGB`,` 0xRRGGBB`) e no formato '#fff'.  Os tamanhos das duas listas devem corresponder;  caso contr√°rio, uma exce√ß√£o ser√° lan√ßada. <br><br><div class="spoiler">  <b class="spoiler_title">Primeiro widget</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   .  8460,   9160. # 7         chars = [[' ' for x in range(84)] for y in range(60)] colors = copy_shape(chars, 'gray') layout = ECSLayout(chars, colors) # 'all' -  ,      dispatcher.register_listener(layout, 'all')</span></span></code> </pre> <br></div></div><br>  Como agora temos o que colocar objetos no jogo, podemos come√ßar a criar entidades.  Todo o c√≥digo de entidades e componentes √© movido para um arquivo separado.  O mais simples deles √© uma parede de tijolos destrut√≠vel.  Ela sabe como estar em um determinado lugar, exibir seu widget, servir como um objeto de colis√£o e receber dano.  Ap√≥s danos suficientes, a parede desaparece. <br><br><div class="spoiler">  <b class="spoiler_title">entity.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_wall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dispatcher, atlas, entity_id, x, y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   wall = Entity(entity_id) #  wall.add_component(PositionComponent(dispatcher, x, y)) wall.add_component(CollisionComponent(dispatcher)) wall.add_component(PassingComponent(dispatcher)) wall.add_component(DestructorComponent(dispatcher)) #     ,      #    -  /   images_dict = {'wall_3': atlas.get_element('wall_3'), 'wall_2': atlas.get_element('wall_2'), 'wall_1': atlas.get_element('wall_1')} wall.add_component(SwitchWidgetComponent(dispatcher, SwitchingWidget(images_dict=images_dict, initial_image='wall_3'))) wall.add_component(VisualDamageHealthComponent(dispatcher, hitpoints=3, widgets_dict={3: 'wall_3', 2: 'wall_2', 1: 'wall_1'})) #     dispatcher.add_event(BearEvent('ecs_create', wall)) dispatcher.add_event(BearEvent('ecs_add', (wall.id, wall.position.x, wall.position.y)))</span></span></code> </pre> <br></div></div><br>  Primeiro de tudo, o pr√≥prio objeto de entidade √© criado.  Ele cont√©m apenas um nome (que deve ser exclusivo) e um conjunto de componentes.  Eles podem ser transferidos todos de uma vez ap√≥s a cria√ß√£o ou, como aqui, adicionados um de cada vez.  Todos os componentes necess√°rios s√£o criados.  Como widget, √© utilizado o SwitchWidget, que cont√©m v√°rios desenhos do mesmo tamanho e pode alter√°-los por comando.  A prop√≥sito, os desenhos s√£o carregados do atlas ao criar um widget.  E, finalmente, o an√∫ncio da cria√ß√£o da entidade e a ordem para desenh√°-la nas coordenadas necess√°rias entram na fila. <br><br>  Dos componentes n√£o integrados, h√° apenas integridade.  Criei a classe base ‚ÄúComponente de sa√∫de‚Äù e herdei dela o ‚ÄúWidget de altera√ß√£o do componente de sa√∫de‚Äù (para mostrar a parede intacta e em v√°rios est√°gios de destrui√ß√£o). <br><br><div class="spoiler">  <b class="spoiler_title">classe HealthComponent</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HealthComponent</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Component)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, hitpoints=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params">, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, name=<span class="hljs-string"><span class="hljs-string">'health'</span></span>, **kwargs) self.dispatcher.register_listener(self, <span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span>) self._hitpoints = hitpoints <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.event_type == <span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> event.event_value[<span class="hljs-number"><span class="hljs-number">0</span></span>] == self.owner.id: self.hitpoints -= event.event_value[<span class="hljs-number"><span class="hljs-number">1</span></span>] @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hitpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._hitpoints @hitpoints.setter <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hitpoints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(value, int): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> BearECSException( <span class="hljs-string"><span class="hljs-string">f'Attempting to set hitpoints of </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.owner.id}</span></span></span><span class="hljs-string"> to non-integer </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{value}</span></span></span><span class="hljs-string">'</span></span>) self._hitpoints = value <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._hitpoints &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>: self._hitpoints = <span class="hljs-number"><span class="hljs-number">0</span></span> self.process_hitpoint_update() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_hitpoint_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Should be overridden by child classes. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError(<span class="hljs-string"><span class="hljs-string">'HP update processing should be overridden'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#           return dumps({'class': self.__class__.__name__, 'hitpoints': self.hitpoints})</span></span></code> </pre> <br></div></div><br>  Ao criar um componente, a chave 'name' √© passada para super () .__ init__.  Quando um componente √© adicionado a uma entidade, sob o nome dessa chave, ele √© adicionado ao __dict__ da entidade e pode ser acessado atrav√©s de entity_object.health.  Al√©m da conveni√™ncia da interface, essa abordagem √© boa porque pro√≠be a emiss√£o de entidades de v√°rios componentes homog√™neos.  E o fato de ser codificado dentro do componente n√£o permite inserir por engano, por exemplo, o WidgetComponent no slot do componente de integridade.  Imediatamente ap√≥s a cria√ß√£o, o componente assina as classes de eventos de seu interesse, neste caso ac_damage.  Ap√≥s receber esse evento, o m√©todo on_event verificar√° se √© sobre o propriet√°rio por uma hora.  Nesse caso, ele subtrair√° o valor desejado dos pontos de vida e puxar√° o retorno de chamada para alterar a sa√∫de, a classe base √© abstrata.  H√° tamb√©m o m√©todo __repr__, usado para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">serializa√ß√£o no JSON</a> (por exemplo, para salvar).  N√£o √© necess√°rio adicion√°-lo, mas todos os componentes internos e a maioria dos widgets internos possuem. <br><br>  A heran√ßa do componente de integridade subjacente de VisualDamageHealthComponent substitui o retorno de chamada na altera√ß√£o de integridade: <br><br><div class="spoiler">  <b class="spoiler_title">classe VisualDamageHealthComponent</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VisualDamageHealthComponent</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(HealthComponent)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       .    HP=0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, widgets_dict={}, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, **kwargs) self.widgets_dict = OrderedDict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sorted(widgets_dict.keys()): self.widgets_dict[int(x)] = widgets_dict[x] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_hitpoint_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.hitpoints == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> hasattr(self.owner, <span class="hljs-string"><span class="hljs-string">'destructor'</span></span>): self.owner.destructor.destroy() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.widgets_dict: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.hitpoints &gt;= x: self.owner.widget.switch_to_image(self.widgets_dict[x])</code> </pre> <br></div></div><br>  Enquanto a sa√∫de estiver acima de 0, ele pede ao componente respons√°vel pelo widget que desenhe a parede no estado desejado.  Aqui, a chamada descrita acima √© usada atrav√©s do atributo do objeto de entidade.  Depois que os hitpoints terminarem, o componente respons√°vel pela destrui√ß√£o correta da entidade e todos os componentes ser√£o chamados da mesma maneira. <br><br>  Para outras entidades, tudo √© semelhante, apenas o conjunto de componentes √© diferente.  Os tanques s√£o adicionados com controladores (entrada para o jogador, IA para oponentes) e widgets rotativos, para proj√©teis - um componente de colis√£o que causa danos √†queles que atingem.  N√£o analisarei cada um deles, porque √© volumoso e bastante trivial;  olhe apenas para o colisor de proj√©teis.  Ele tem um m√©todo collided_into, chamado quando a entidade host colidiu com algo: <br><br><div class="spoiler">  <b class="spoiler_title">colisor de componentes de bala</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collided_into</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, entity)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> entity: self.owner.destructor.destroy() <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> hasattr(EntityTracker().entities[entity], <span class="hljs-string"><span class="hljs-string">'collision'</span></span>): self.dispatcher.add_event(BearEvent(event_type=<span class="hljs-string"><span class="hljs-string">'ac_damage'</span></span>, event_value=( entity, self.damage))) self.owner.destructor.destroy()</code> </pre> <br></div></div><br>  Para garantir que seja realmente poss√≠vel obter uma v√≠tima (o que pode estar errado para, por exemplo, elementos de segundo plano), o proj√©til usa EntityTracker ().  Este √© um singleton que rastreia todas as entidades criadas e destru√≠das;  atrav√©s dele, voc√™ pode obter um objeto de entidade pelo nome e fazer algo com seus componentes.  Nesse caso, √© verificado que entity.collision (o manipulador de colis√£o de v√≠tima) existe. <br><br>  Agora, no arquivo principal do jogo, simplesmente chamamos todas as fun√ß√µes necess√°rias para criar entidades: <br><br><div class="spoiler">  <b class="spoiler_title">Voltar ao game.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#  , -     atlas = Atlas(XpLoader('battlecity.xp'), 'battlecity.json') #   create_player_tank(dispatcher, atlas, 30, 50) #    wall_array = [[0 for _ in range(14)], [0 for _ in range(14)], [1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0], [1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0], [1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1], [1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0], [1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0], [0 for _ in range(14)], [0 for _ in range(14)], [0 for _ in range(14)] ] for y in range(10): for x in range(14): if wall_array[y][x] == 1: create_wall(dispatcher, atlas, f'wall{x}{y}', x*6, y*6) #   -  .     . create_spawner_house(dispatcher, atlas, 35, 0)</span></span></code> </pre> <br></div></div><br>  Os contadores de pontos e de pontos de vida n√£o s√£o entidades e n√£o est√£o no campo de batalha.  Portanto, eles n√£o s√£o adicionados ao ECSLayout, mas diretamente ao terminal √† direita do mapa.  Os widgets relevantes herdam do Label (widget de sa√≠da de texto) e t√™m um m√©todo on_event para descobrir o que lhes interessa.  Ao contr√°rio do Layout, o terminal n√£o atualiza automaticamente os widgets a cada tick, portanto, ap√≥s alterar o texto, os widgets dizem para ele fazer isso: <br><br><div class="spoiler">  <b class="spoiler_title">listeners.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScoreLabel</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Label)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(text=<span class="hljs-string"><span class="hljs-string">'Score:\n0'</span></span>) self.score = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, event)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.event_type == <span class="hljs-string"><span class="hljs-string">'ecs_destroy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'enemy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> event.event_value <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'bullet'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> event.event_value: <span class="hljs-comment"><span class="hljs-comment">#    self.score += 10 self.text = f'Score:\n{self.score}' self.terminal.update_widget(self) class HPLabel(Label): """   """ def __init__(self, *args, **kwargs): super().__init__(text='HP:\n5') self.hp = 5 def on_event(self, event): if event.event_type == 'ac_damage' and event.event_value[0] == 'player': self.hp -= event.event_value[1] self.text = f'HP:\n{self.hp}' self.terminal.update_widget(self)</span></span></code> </pre> <br></div></div><br>  O gerador inimigo e o objeto respons√°vel pela sa√≠da de "GAME OVER" n√£o s√£o exibidos, portanto eles herdam do Listener.  O princ√≠pio √© o mesmo: os objetos ouvem a fila, esperam o momento certo e, em seguida, criam uma entidade ou widget. <br><br><div class="spoiler">  <b class="spoiler_title">gameover</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    - . . . class GameOverListener(Listener): """       """ def __init__(self, *args, widget=None, **kwargs): print (args) super().__init__(*args, *kwargs) self.widget = widget def on_event(self, event): if event.event_type == 'ecs_destroy' and event.event_value == 'player': self.terminal.add_widget(self.widget, pos=(20, 20), layer=5)</span></span></code> </pre><br></div></div><br>  Agora criamos tudo o que precisamos e podemos come√ßar o jogo. <br><br><div class="spoiler">  <b class="spoiler_title">Lan√ßamos</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,   Listeners    terminal.start() terminal.add_widget(layout) terminal.add_widget(score, pos=(85, 10)) terminal.add_widget(hp, pos=(85, 15))</span></span></code> </pre> <br></div></div><br>  Os widgets s√£o adicionados √† tela somente ap√≥s o in√≠cio.  As entidades poderiam ser adicionadas ao mapa antes - os eventos de cria√ß√£o (nos quais toda a entidade est√° armazenada, incluindo o widget) s√£o simplesmente acumulados na fila e resolvidos no primeiro tique.  Mas o terminal pode adicionar widgets somente ap√≥s a cria√ß√£o de uma janela para ele. <br><br>  Neste ponto, temos um prot√≥tipo funcional, que voc√™ pode <s>emitir no Early Access por vinte d√≥lares,</s> adicionar recursos e aprimorar a jogabilidade.  Mas isso j√° est√° al√©m do escopo do mundo santo e, portanto, do artigo.  Acrescentarei apenas que a compila√ß√£o independente do python do sistema pode ser criada usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pyinstaller</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470950/">https://habr.com/ru/post/pt470950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470930/index.html">Gamifica√ß√£o do produto. Ratatype da hist√≥ria</a></li>
<li><a href="../pt470934/index.html">Cura antes do casamento: prolifera√ß√£o celular e habilidades regenerativas da √°gua-viva</a></li>
<li><a href="../pt470938/index.html">Como abrir um link em Python. Trabalhando com o WebBrowser e resolvendo um problema com o Internet Explorer</a></li>
<li><a href="../pt470940/index.html">MSK VUE.JS meetup # 3 no Mail.ru Group: materiais da mitap</a></li>
<li><a href="../pt470942/index.html">Do iniciante ao estilo √≠cones: como fizemos pr√™mios em 2GIS</a></li>
<li><a href="../pt470952/index.html">Dicas e truques para forense digital: aplicativo "Seu telefone" Forense</a></li>
<li><a href="../pt470954/index.html">Instale o Zimbra OSE 8.8.15 e o Zextras Suite Pro no Ubuntu 18.04 LTS</a></li>
<li><a href="../pt470958/index.html">Sondas de vida em Kubernetes podem ser perigosas</a></li>
<li><a href="../pt470962/index.html">JSConf Budapest 2019</a></li>
<li><a href="../pt470964/index.html">Brinquedos de madeira - inscri√ß√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>