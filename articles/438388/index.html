<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👟 👏🏻 💪🏽 Servidor de mensajes push 👴🏿 📯 😯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En cualquier servicio moderno de Internet, solo hay dos funciones principales: 



- El primero es la autorización del usuario. 
- El segundo es el en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor de mensajes push</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438388/">  En cualquier servicio moderno de Internet, solo hay dos funciones principales: <br><br><ul><li>  El primero es la autorización del usuario. </li><li>  El segundo es el envío instantáneo de un evento desde el servidor al cliente. </li></ul><br>  El primer punto, creo, no necesita una explicación. <br><br>  El segundo punto es la tecnología cliente-servidor, pero viceversa.  El cliente no realiza periódicamente una solicitud al servidor. ¿Hay algún mensaje nuevo?  El servidor, cuando ocurre un determinado evento, envía el mensaje inmediatamente al cliente. <br><br>  Para una mejor comprensión, el servicio no es un cierto esférico en el vacío.  El servicio se puede representar como: <br><br><ul><li>  Una carpeta con archivos en la nube.  La información sobre cómo cambiar, agregar y eliminar se envía a otros usuarios o al usuario actual, pero a otros dispositivos. </li><li>  Un programa de computadora para leer los registros del servidor, cuando aparecen registros de "error", enviando el contenido del registro al usuario en un teléfono móvil. </li><li>  Mirilla de video (cámara) tomando fotos cuando se mueve cerca de la puerta del apartamento. </li><li>  Un servicio que recibe telemetría de una aplicación Android-Auto. </li><li>  Un servicio similar al párrafo anterior, que le permite saber si un niño ha llegado a la escuela o ha regresado de la escuela. </li></ul><br>  La lista se puede expandir indefinidamente; como ejemplo, solo se dan los casos de uso más conocidos. <br><br>  Casi todos los ejemplos de servicios se pueden presentar en forma de "mensajero".  Parte de los ejemplos se describieron exactamente de esta manera; vi artículos sobre cómo conectar la cámara y enviar imágenes a un famoso mensajero. <br><br>  No hace mucho tiempo, había un artículo en el que los extraños observaban el servicio de la cámara en los ojos de la puerta, en lugar de la inteligencia artificial.  No me enfocaré en servicios gratuitos de grandes corporaciones "buenas".  Como dicen en el famoso proverbio "El queso gratis sucede en una trampa para ratones" y guiado por otro proverbio "Tu camisa está más cerca de tu cuerpo", tu "servicio" es mejor. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El código de script del servidor es abierto y gratuito</a> <br><br><img src="https://habrastorage.org/webt/wx/2d/a4/wx2da4acw9c3g_x0a_mxj8dukju.png"><br><a name="habracut"></a><br>  Elegí node.js socket.io postgreSQL para la implementación, implementé la primera versión hace más de dos años, y el servicio estaba estrechamente relacionado con 1c <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://infostart.ru/public/545047/</a> , todavía no habían anunciado un servidor de interacción en ninguna parte.  Pero fue hace mucho tiempo, en este momento, la parte del servidor no está conectada de ninguna manera con el programa mencionado, la parte del cliente puede integrarse como procesamiento externo o extensión. <br><br>  El nombre elegido es significativo: "push0k".  La primera parte está tomada de la frase "mensaje push", el segundo inglés bien conocido en forma abreviada, pero está escrito en cero para el más significativo. <br><br>  En este caso, esto no es un "queso gratis en una trampa para ratones", ya que requiere una computadora Windows, Linux, MacOS (servidor) para funcionar a través de Internet, necesita una dirección IP externa, posiblemente reenviada.  Preferiblemente el nombre de dominio asociado con la dirección IP externa.  Además, es deseable, pero no necesario, no un certificado autofirmado asociado con un nombre de dominio. <br><br>  No hay requisitos de hardware como tales, puede funcionar en el hogar nas, donde hay docker.  Docker en nas significa arquitectura x86-64, y postgreSQL no se puede instalar en tales nas sin docker.  Una comprensión precisa de cuántos clientes puede soportar dicho servidor depende de las tareas: la lógica del servicio y el tráfico transmitido entre los clientes. <br><br><h4>  Descripción del servidor: </h4><br>  El servidor usa módulos adicionales: <br><br><ul><li>  socket.io: el módulo agrega un protocolo websocket con una tonelada de ext.  oportunidades </li><li>  node-postgres - módulo para la comunicación con el servidor de base de datos postgreSQL. </li><li>  pm2 es un módulo para iniciar varios procesos del servidor con un equilibrador de carga. </li></ul><br><h4>  Archivos del servidor: </h4><br><ul><li>  starter.js - servicio http (s), puede decir el panel de administración del servidor.  A través de este servicio, se cambia la configuración y se inician los procesos del servidor websocket principal. </li><li>  push0k.js es el servidor websocket principal. </li><li>  starter_cfg.js: configuración del script administrativo del servidor.  Conexión a postgreSQL y archivos para conexión https.  Los archivos para las conexiones https, así como el nombre de dominio, pueden diferir del servidor principal, para mayor seguridad.  Se cambia manualmente en el primer inicio. </li><li>  config.js: la configuración básica de todo el servidor. </li><li>  package.js: módulos de autor de versión de descripción de archivo necesarios para el trabajo. </li><li>  push0kStructure.sql: descripción del archivo de la base de datos postgreSQL para la inicialización inicial, una base de datos vacía. </li></ul><br><h4>  Instalación: </h4><br>  1. Inicialmente, debe instalar node.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nodejs.org/en/download</a> <br><br>  2. PostgreSQL también debe instalarse en la computadora de la red local o en el mismo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">postgrespro.ru/products/download</a> <br><br>  En el servidor postgreSQL, es necesario ejecutar el archivo "push0kStructure.sql" o casi todas las consultas de este archivo para crear una base de datos con las tablas necesarias. <br><br>  3. Descargue los primeros cinco archivos del servidor, excepto push0kStructure.sql, en cualquier directorio de la computadora. <br><br>  4. En cualquier editor de texto, edite el archivo "starter_cfg.js".  Es importante especificar los parámetros para conectarse al servidor postgreSQL y establecer el puerto para conectarse a la parte administrativa del servidor push0k. <br><br>  5. Inicie el terminal (consola) y use el comando "cd / ruta / su / directorio /" para ir al directorio de archivos del servidor.  La ruta especificada en el comando del terminal debe ser desde el punto 3. <br><br>  6. Ejecute el comando en el terminal "npm install" para instalar módulos adicionales. <br>  Ejecute el comando en el terminal "node starter.js" para iniciar el servicio de administración. <br><br>  7. Descargue e instale el programa de administración push0k.  En "push0k admin" se configuran los parámetros básicos del websocket, el puerto del servidor, el número de procesos y muchos otros.  Puede controlar el inicio y la detención de los procesos del servidor, crear y administrar usuarios y sus salas (grupos). <br><br><h4>  Aplicación de administración Push0k </h4><br><img src="https://habrastorage.org/webt/fk/fo/go/fkfogovxziochbj901ouycltfjq.png"><br><br>  La aplicación se realiza en electrón usando vue.js.  En el interior, se implementa un tipo de sistema de ventanas, los pequeños cuadros de diálogo modales se pueden arrastrar y soltar como ventanas, los títulos de ventanas para Windows se hacen similares a Windows 10, para Mac OS como en las últimas versiones, pero hasta ahora sin tener en cuenta el tema oscuro.  Para Linux, compilaré más tarde, es un poco más complicado con los títulos de los diálogos, creo que será como en ubuntu y, si no es ubuntu, ganaré 10 estilos.  El consumo de memoria en win 10 y Mac OS más de 150 megabytes no se vio. <br><br>  En versiones anteriores no era posible agregar animación, lo hacía un poco sin fanatismo.  Los cuadros de diálogo descritos anteriormente: las ventanas aparecen desde el centro de la ventana de la aplicación, aumentando gradualmente, cuando están cerradas, vuelan hacia el centro, disminuyendo.  Además, las pulsaciones de botones y los campos obligatorios están animados. <br><br><img src="https://habrastorage.org/webt/rn/ts/vr/rntsvrtjjhvvsnpu6vf_oyguwou.gif"><br><br>  Durante la implementación, había un gran deseo de crear un tema oscuro, pero como todavía no había un tema claro, tuve que contentarme solo con el panel de botones de la derecha.  En Mac OS, esta única parte oscura tiene un efecto de vitalidad, es decir, es parcialmente transparente, similar a la mayoría de las ventanas de la interfaz estándar.  Desafortunadamente, en Windows, un efecto similar llamado diseño fluido no se pudo hacer porque no hay una funcionalidad similar en Windows para el electrón. <br><br>  Como se mencionó anteriormente, el control utiliza los protocolos http y ws (websocket).  Es posible utilizar conexiones seguras https y wss.  Con conexiones seguras, puede ver los datos de los certificados utilizados.  De manera similar a los navegadores, se utiliza el ícono "Bloquear": la conexión es segura, "Bloqueo abierto": la conexión no es segura.  Y sin iconos, respectivamente, no se utiliza una conexión segura. <br><br><img src="https://habrastorage.org/webt/xz/mt/ew/xzmtew2kpyuhppeugz2fth2lxvm.png"><br><br><h4>  Lógica general </h4><br>  Nunca he visto tal aplicación.  Durante el desarrollo, me guié por el hecho de que yo mismo estaría interesado en el monitoreo y qué parámetros ver en las estadísticas. <br><br>  Por ejemplo, en la tabla de conexión para cada conexión hay datos "tiempo de conexión", "tiempo de autorización", "tiempo de sincronización".  El primero le permite comprender qué tan rápido se establece la conexión "ws: //" o el "wss: //" protegido.  El segundo: después de la conexión, se envía un mensaje con datos de autorización por separado, durante la autorización, se realiza una solicitud de verificación del usuario y una comprobación de hash de contraseña es única para cada conexión.  En tercer lugar, es el momento de recibir nuevos mensajes y datos de referencia nuevos o actualizados.  Además, las versiones de node.js, socket.io y otros datos descritos generalmente se guardan, lo que permite comprender cómo la actualización de node.js o el módulo afectaron por separado la velocidad, o podría haber afectado algún refinamiento del servidor. <br><br><img src="https://habrastorage.org/webt/xs/_h/ak/xs_haktlpy5r-gb_6ktxpf9_osa.png"><br><br>  En el ejemplo anterior, solo se describe una pequeña parte de dichos datos.  Además, en una tabla separada, se guardan el tiempo, el tamaño y la velocidad de MB / s.  Descargar sincronización de datos.  La misma tabla almacena los datos de la descarga de archivos adjuntos al servidor y la descarga de estos datos del servidor. <br><br>  El tiempo para calcular la velocidad se calcula en el cliente o servidor, según la situación.  Es imposible usar el tiempo tanto del servidor como del cliente ya que no se puede sincronizar perfectamente.  Esto impone un pequeño retraso de tamaño de ping (confirmación de entrega) entre el cliente y el servidor.  Al cargar o descargar archivos grandes, el retraso descrito no es significativo. <br><br>  En la tabla de conexión, puede ver la conexión cerrada con los datos "byte transmitido", "byte recibido" y "tamaño" de los datos de sincronización más que el "byte transmitido".  Al sincronizar datos, se utiliza la compresión automática de socket.io, al descargar o descargar archivos adjuntos, la compresión automática se desactiva, ya que a menudo la compresión ya comprimida afecta negativamente la velocidad. <br><br>  Como se escribió al principio del artículo, nunca fue un objetivo crear un servicio común y conectar tantos usuarios como sea posible.  Pero siempre fue interesante cuántos teóricamente puede haber usuarios y qué tipo de carga soportará el servidor. <br><br>  Para hacer esto, hice una prueba simple: en línea a los clientes de una determinada sala (grupo), se envía un mensaje con los parámetros de prueba (en los parámetros solo hay un parámetro principal: el número de mensajes), que cada cliente enviará a otros clientes en línea.  Después de la distribución de prueba, se calcula el tiempo total de todos los mensajes, notificaciones, entradas en las tablas postgresql, se calcula el número de todos los mensajes, notificaciones y entradas y, en consecuencia, se calcula la velocidad, incluido el total de todas las operaciones en el servidor. <br><br><img src="https://habrastorage.org/webt/mj/ir/eo/mjireosal4qxzjintjlz4rddhao.png"><br><br>  <i>Ejemplo de la captura de pantalla:</i> <i><br><br></i>  <i>A veces es más sorprendente, solo 10,000 mensajes y 390,000 gestos,</i> <i><br></i>  <i>enviando 50,000 mensajes: Procesos del servidor: 4 Usuarios: 3</i> <i><br></i>  <i>Total de mensajes recibidos 10,000 * 3 = 30,000</i> <i><br></i>  <i>Reenvío a otros procesos del servidor 30,000 * Procesos del servidor: 4 - 1 = 90,000</i> <i><br></i>  <i>Enviado a destinatarios 30,000 * Usuarios: 3 - 1 = 60,000</i> <i><br></i>  <i>Los mensajes se escriben en la tabla postgreSQL 30 000</i> <i><br></i>  <i>90,000 notificaciones de entrega recibidas</i> <i><br></i>  <i>Grabado en la tabla de notificaciones de entrega postgreSQL 90,000</i> <i><br></i>  <i>Todas las operaciones 390,000</i> <br><br><h4>  Lógica de datos en administrador push0k </h4><br>  Con cada conexión, se obtienen todos los datos de referencia: usuarios, salas, dispositivos, bases de datos, así como las últimas 300 entradas del "diario estadístico": Conexiones, Sincronización de datos, Reenvío de archivos adjuntos, Mensajes, Diario. <br><br>  Los mensajes prácticamente repiten la tabla postgresql y no tienen filtros, configuraciones y un formulario donde pueda ver el mensaje por completo.  La lógica de la tabla es la depuración, es posible ver rápidamente durante el desarrollo si el mensaje ha llegado a la tabla o no. <br><br><img src="https://habrastorage.org/webt/6y/ra/gj/6yragjyt0ycnvzmiy8cvbspfpsc.png"><br><br>  Las tablas "Usuarios", "Salas (grupos)", "Conexiones" y "Diario" se actualizan automáticamente.  Para el resto de los datos, no tiene sentido actualizar en línea. <br><br>  La aplicación de administración push0k se puede descargar aquí: <br><br>  Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">push0kadmin Setup 19.1.11.exe</a> <br>  Mac OS: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">push0kadmin-19.1.11.dmg</a> <br><br>  Es gratis, pero a diferencia del servidor, todavía no planeo abrir el código fuente. <br><br>  En el próximo artículo describiré la parte del cliente del cliente Desctop push0k, así como un pequeño ejemplo, código y cómo conectarse, iniciar sesión y recibir datos del servidor. <br><br>  Para las versiones anteriores mencionadas anteriormente, también había un cliente de Android, que vivía inmortalmente en segundo plano en las versiones 7 y 8 de Android.  Pero por ahora, creo que no me retrasé por mucho tiempo.  Más tarde, creo que habrá un tercer artículo con un cliente de Android, y allí se ve y iOS no está lejos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438388/">https://habr.com/ru/post/438388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438376/index.html">Ingeniería inversa. La historia La mia</a></li>
<li><a href="../438380/index.html">Hombre, pausa en las excepciones detectadas</a></li>
<li><a href="../438382/index.html">Organización de una búsqueda en una página web en JavaScript (sin jQuery)</a></li>
<li><a href="../438384/index.html">Lección de química: cómo exponer el cristal de un microchip para fotografía</a></li>
<li><a href="../438386/index.html">En el camino hacia los principios físicos de la evolución biológica.</a></li>
<li><a href="../438390/index.html">Por qué los desarrolladores son más caros que el dinero, cómo ahorrarlos y aumentarlos</a></li>
<li><a href="../438392/index.html">Una breve historia de una "cinta inteligente"</a></li>
<li><a href="../438394/index.html">Yii 2.0.16</a></li>
<li><a href="../438396/index.html">¿Por qué deberías pensar en la programación funcional?</a></li>
<li><a href="../438398/index.html">Cómo lancé Keras en C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>