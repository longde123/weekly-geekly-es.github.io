<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍟 📴 🧜 Meine Erfahrung mit der Verbindung von LPS331AP mit Omega Onion2 🌷 🎤 👲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, Habrovsk! 

 Kurze Einführung 
 Neulich wurde ich der glückliche Besitzer eines der kleinsten Einzelzahler, die an LEDE arbeiteten, und das...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Meine Erfahrung mit der Verbindung von LPS331AP mit Omega Onion2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471232/">  Guten Tag, Habrovsk! <br><br><h4>  Kurze Einführung </h4><br>  Neulich wurde ich der glückliche Besitzer eines der kleinsten Einzelzahler, die an LEDE arbeiteten, und das erste, was ich (nach dem Blinken der LED) tun wollte, war eine Wetterstation zu Hause, auf die von überall aus zugegriffen werden kann.  Der erste Schritt bestand darin, Daten zu Temperatur, Luftfeuchtigkeit und Druck zu erfassen.  Hierzu wurden früher gekaufte <b>DHT11-</b> und <b>LPS3311AP-</b> Sensoren ausgewählt (Foto unter dem Schnitt). <br><br><div class="spoiler">  <b class="spoiler_title">Fotos für Interessierte</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-g/5z/mk/-g5zmk6kgvu0yhab0e_bz7j0g5y.jpeg" alt="Bild"></div></div><br>  Nach einer kurzen Google-Suche stellte sich heraus, dass das von mir gewählte Barometer nicht so beliebt ist, wenn die erste Familie gut dokumentiert ist und viele Bibliotheken für die Arbeit hat, mit Ausnahme der selbstgeschriebenen Bibliothek (wenn auch von sehr hoher Qualität) für das Arduino-Geschäft, in dem der Sensor gekauft wurde (keine Werbung, nur eine Hommage), nichts konnte gefunden werden. <br><br>  Welche Wahl bleibt? <br><br><ol><li>  <i>Sammeln Sie die Ebene auf dem ATmega328-Mikrocontroller, flashen Sie sie, geben Sie den fertigen Code ein und lesen Sie daraus.</i>  Sehr aufregend, aber es klingt wie der Versuch, ein Fahrrad für die spätere Verwendung als Krücke zusammenzubauen. </li><li>  <i>Lesen Sie "manuell" mit I2C und verlassen Sie sich dabei auf das offizielle Datenblatt</i> .  Ich habe es versucht, es ist möglich, aber ich wollte keine Bash-Skripte erstellen und schien methodisch nicht korrekt zu sein. </li><li>  <i>Schreiben Sie eine <b>Bibliothek</b></i> , um mit dem Sensor nach <i>Ihren <b>Wünschen</b></i> zu arbeiten. </li></ol><br>  Wenn Sie daran interessiert sind, wie es kam und was daraus wurde, dann willkommen bei cat. <br><a name="habracut"></a><br>  Die erste Frage, auf die ich gestoßen bin, ist die Wahl der Sprache.  Von dem, was auf diesem Single-Board funktioniert, ohne mit einem Tamburin zu tanzen - C ++ und Python.  Da ich dieses Projekt in Zukunft für mich selbst in den Mittelpunkt eines Smart Homes stellen möchte, fiel die Wahl auf Letzteres. <br><br>  Aufgrund des Entlein-Effekts habe ich die nächste Frage (welche Version) nicht gestellt und sofort das leichte Python3 und die Bibliothek für die Arbeit mit dem I2C-Bus eingefügt. <br><br>  Dann gab es Stunden des Rauchens, zuerst ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Datenblatt</a> , dann eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Software-Anleitung</a> des Herstellers.  Sie ermöglichten es, den Sensor schnell für den Betrieb vorzubereiten (obwohl sich herausstellte, dass die Softwareanleitung vollständiger war, einschließlich Empfehlungen zur Überprüfung des Messabschlusses und zum „Zurücksetzen“ des Sensors für eine genauere Erfassung. <br><br>  Die erste Schwierigkeit, auf die ich gestoßen bin, ist das Lesen von Daten.  Da die Daten vom Thermometer in zwei Bytes und der Druck in drei Bytes übertragen werden, ist es notwendig, mehrere Bytes zu erhalten und sie zu einer großen Anzahl zu kombinieren.  Python konvertiert hex standardmäßig in int, und die einfache Verkettung funktioniert nicht.  Das Konvertieren von int in hex gibt eine Zeichenfolge zurück, die perfekt verkettet, aber nicht wieder in eine Zahl konvertiert ist.  Ausweg?  Es wäre möglich, die Unterstützung für C-Typen zu verbinden, aber ich wollte nicht herumspielen und den Speicher mit einer zusätzlichen Bibliothek verstopfen. Daher wurde beschlossen, eine Funktion in 7 Zeilen (tatsächlich 8, wenn wir das Wörterbuch zählen) zu schreiben, um die Pseudo-Byte-Zeichenfolge in eine Zahl zu übersetzen. <br><br><div class="spoiler">  <b class="spoiler_title">Hex mit String zu int</b> <div class="spoiler_text"><pre><code class="python hljs">s_t_h = { <span class="hljs-string"><span class="hljs-string">'0'</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'3'</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'4'</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'5'</span></span> : <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'6'</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">'7'</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">'8'</span></span> : <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'9'</span></span> : <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span> : <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">'c'</span></span> : <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">'d'</span></span> : <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">'e'</span></span> : <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">'f'</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__string_to_int</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hex_string)</span></span></span><span class="hljs-function">:</span></span> l = len(hex_string) - <span class="hljs-number"><span class="hljs-number">1</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> h <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hex_string: res += s_t_h[h] * (<span class="hljs-number"><span class="hljs-number">16</span></span> ** l) l -= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre> <br>  Ich glaube, dass die Frage „Warum aus dem Wörterbuch lesen?“ Hier vernünftigerweise gestellt werden kann.  Die Antwort ist einfach: Es ist mir nicht in den Sinn gekommen, offensichtliche Entscheidungen zur Typkonvertierung zu treffen. Wenn Experten eine Antwort auf diese Frage haben, werde ich gerne Änderungen vornehmen. <br></div></div><br>  Die zweite Schwierigkeit, die mich verblüffte, ist die Interpretation der Daten.  Beide oben genannten Dokumente enthalten sehr einfache Formeln für die Konvertierung: <br><br>  <code>Pout(mbar)=(PRESS_OUT_H &amp; PRESS_OUT_L &amp; PRESS_OUT_XL)[dec] / 4096</code> für Druck; <br>  <code>T(degC) = 42.5 + (Temp_OUTH &amp; TEMP_OUT_L)[dec] / 480</code> für die Temperatur. <br><br>  Was gefällt, bieten sie sofort ein metrisches System. <br><br>  Der erste Ansatz ergab jedoch hartnäckig das Ergebnis 0x2F8000, was 760 Millibar oder etwa 585 mmHg bedeutet.  Art.  Für eine Höhe von 130 Metern über dem Meeresspiegel reicht dies eindeutig nicht aus.  Das erneute Überprüfen des Codes, das erneute Lesen von Informationen über die Druckmessung, das Neustarten des Sensors und das präzise Spielen haben nichts gebracht.  Das wiederholte Studium der Richtlinie hat jedoch geholfen - stabile 760 mbar werden als Signal dafür interpretiert, dass der Sensor fehlerhaft ist.  Leser, die sich das beigefügte Foto am Anfang des Artikels genau angesehen haben, können sicherstellen, dass der Sensor im Prinzip nicht auf dem Chip vorhanden ist :) Glücklicherweise habe ich schnell zwei davon gleichzeitig gekauft. <br><br><div class="spoiler">  <b class="spoiler_title">Foto eines funktionierenden Chips und ordnungsgemäßer Betrieb</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/7v/jy/z5/7vjyz5w10xg9qsd58stxhj1rakg.jpeg"><br><br>  Das kleine schwarze Quadrat in der Mitte ist die HCLGA-16L-Messplatte, das „Herz“ des Sensors. <br><br><img src="https://habrastorage.org/webt/gu/tt/om/guttom3d5dczqqgbikz4d1xocug.png" alt="Bild"></div></div><br>  Nach dieser Entdeckung wurde klar, dass ein Gesundheitscheck durchgeführt werden sollte.  So wurde die Funktion geboren: <br><br><div class="spoiler">  <b class="spoiler_title">Working_check</b> <div class="spoiler_text"><pre> <code class="python hljs">BROKEN_MARKER = <span class="hljs-number"><span class="hljs-number">0x2f8000</span></span>/<span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__working_check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, address)</span></span></span><span class="hljs-function">:</span></span> c1 = self.__read_pressure(address) c2 = self.__read_pressure(address) c3 = self.__read_pressure(address) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c1 == c2 == c3 == BROKEN_MARKER: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  Um einen seltenen, aber dennoch potenziell wahrscheinlichen Fall von Fehlalarmen zu vermeiden, werden die Messungen dreimal durchgeführt und erst danach wird ein Urteil über die Inoperabilität gefällt.  Es ist möglich, eine Konstante in einem solchen Code übermäßig zu verwenden, aber ein guter Ton sollte nach Möglichkeit beobachtet werden. <br></div></div><br>  Sofort kam mir die Idee, dass es während der Initialisierung nicht schlecht wäre, zu überprüfen, ob die Adresse auf dem Bus korrekt ist, und die Funktion <b>__deviceAdressCheck</b> wurde hinzugefügt, die das <b>WHO_AM_I-</b> Register überprüft und <b>erwartet</b> , die geschätzte Nummer 0xBB zu erhalten. <br><br>  Hierzu gibt es anscheinend keine interessanteren Punkte mehr.  Der vollständige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Code</a> ist auf dem Github verfügbar und kann verwendet und geändert werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de471232/">https://habr.com/ru/post/de471232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de471216/index.html">Die lange Geschichte des Reiseführers - wie ich 5 Jahre lang einen Dienst für intelligente Wanderwege geschrieben habe</a></li>
<li><a href="../de471220/index.html">Cockpit - Vereinfachen Sie typische Verwaltungsaufgaben unter Linux über eine praktische Weboberfläche</a></li>
<li><a href="../de471222/index.html">Das Verständnis der Datenschutzrichtlinien für Anwendungen und Dienste hilft neuronalen Netzen</a></li>
<li><a href="../de471226/index.html">Linux hat viele Gesichter: wie man an jeder Distribution arbeitet</a></li>
<li><a href="../de471228/index.html">Grokay PyTorch</a></li>
<li><a href="../de471236/index.html">Dosimeter für Seryozha. Teil III. Nationales Radiometer</a></li>
<li><a href="../de471240/index.html">"Bitchy Betty" und moderne Audio-Interfaces: Warum sprechen sie mit weiblicher Stimme?</a></li>
<li><a href="../de471242/index.html">Einführung in Bash Shell</a></li>
<li><a href="../de471244/index.html">Rosetta-Code: Messen Sie die Länge des Codes in einer Vielzahl von Programmiersprachen und untersuchen Sie die Nähe der Sprachen zueinander</a></li>
<li><a href="../de471248/index.html">Die US-Aufsichtsbehörden verbieten die Verteilung des Telegram Open Network-Tokens</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>