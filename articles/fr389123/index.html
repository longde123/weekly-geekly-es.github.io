<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏾 🕵🏼 👩🏾‍🎓 Méthodes de débogage d'un logiciel de microcontrôleur dans un entraînement électrique 👩🏽‍🤝‍👨🏿 💣 🌧️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment déboguer des programmes de microcontrôleur? Le JTAG est pris, l'oscilloscope est un couple de jours / semaines et le programme est débogué. Ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Méthodes de débogage d'un logiciel de microcontrôleur dans un entraînement électrique</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/npf_vektor/blog/389123/"><img src="https://habrastorage.org/files/95f/7de/cb5/95f7decb5aa64618b6ad35270c2e753f.JPG" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment déboguer des programmes de microcontrôleur? Le JTAG est pris, l'oscilloscope est un couple de jours / semaines et le programme est débogué. Ce sera une réponse typique, et dans la plupart des cas elle sera correcte ... Mais pas toujours. Les microcontrôleurs résolvent des problèmes très différents, et dans cet article, nous examinerons ce qu'il faut faire si vous avez besoin de développer un logiciel de bas niveau encombrant pour contrôler tout équipement électrique de puissance, par exemple, les convertisseurs de fréquence pour les moteurs électriques, les convertisseurs de charge de batterie DC / DC pour les trains, les correcteurs de puissance, les servos et etc. Équipement, où les kiloampères circulent et kilovolts PWM, où chaque commutation des clés de l'onduleur IGBT est comptée, où le temps de réponse du microcontrôleur à une situation anormale est mesuré en microsecondes, et l'équipement lui-même dans des cas scellés est installé et utilisé quelque part dans les usines de Yakoutie.Si vous voulez savoir quelles fonctionnalités cela impose aux méthodes de débogage, bienvenue dans cat.</font></font><br>
<a name="habracut"></a><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caractéristiques des systèmes de contrôle de débogage</font></font></h1><br>
<img src="https://habrastorage.org/files/b75/1ed/df5/b751eddf52ae41f4afbb776f6c31055c.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelles sont les caractéristiques du débogage des microcontrôleurs (MK) qui effectuent de telles tâches? </font><font style="vertical-align: inherit;">Premièrement, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lorsque MK fonctionne avec un équipement électrique, il ne peut pas être arrêté.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK à l'aide de PWM contrôle les touches de puissance, régule de nombreuses valeurs dans ses couloirs - courants des phases du moteur, tension du circuit intermédiaire, vitesse, position du corps de travail, etc. Si vous arrêtez le MK tout en travaillant au point d'arrêt, alors dans le meilleur des cas, l'équipement s'éteindra en raison de la protection matérielle, et dans le pire des cas, tout explosera simplement (si les interrupteurs d'alimentation restent allumés en position "un" ou avec un cycle de service). Par conséquent, la méthode classique de débogage consiste à «parcourir les étapes avec le débogueur» dans de telles tâches. Vous ne pouvez donc exécuter sur la table que des modules logiciels «complètement bruts» avant leur première intégration sur des équipements réels.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0ec/67d/061/0ec67d061c1d4bdc86b3c0fff1a21003.png" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxièmement, c'est la complexité des logiciels de bas niveau. La taille de la section de code de programme .text est de 50 à 200 Ko pour le code de programme qui contrôle exclusivement le matériel (sans pilotes de communication de haut niveau, etc.) - c'est une situation typique pour un microcontrôleur de certains servo variateurs industriels. Par conséquent, les microcontrôleurs de la série motorcontrol sont utilisés pour de telles tâches, qui combinent à la fois des périphériques très développés, de hautes performances et une taille de mémoire relativement grande (pour MK). Comme exemple des MK importés, on peut citer les instruments MK 32 bits de la série Texas Instruments C2000, de la puce K1921VK01T domestique de NIIET OJSC. Les logiciels pour ces MK contiennent généralement des dizaines ou des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">centaines de milliers de lignes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code C / C ++ optimisé parfait, qui ne peut tout simplement pas être débogué en "clignotant une LED", "printfom in UART" ou en observant le fonctionnement des jambes d'un oscilloscope externe. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e1a/d3e/2e5/e1ad3e2e5e394042886eb06b707c14f7.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisièmement, le contrôleur du système de commande de l'entraînement électrique se trouve le plus souvent à l'intérieur du convertisseur de puissance, dont le boîtier est fermé, et parfois même scellé. Par conséquent, l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accès via JTAG est déjà un gros problème,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne serait-ce que pour le firmware (hors tension). Et un problème encore plus grave est le débogage JTAG avec la mise sous tension. Ici, le JTAG nécessairement isolé galvaniquement et insonorisé doit être utilisé (nous utilisons pour MK TI JTAG SAURIS avec isolation galvanique intégrée - cher, mais cela fonctionne). </font></font><br>
<br>
<img src="https://habrastorage.org/files/e0c/89b/f08/e0c89bf08ca143d1a7f1760ca39b7dc2.png" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatrièmement, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de systèmes d'exploitation!</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous pouvons prévoir comment certaines personnes ont l'idée «eh bien, puisque vous avez une tâche si difficile, mettez un microcontrôleur normal avec Linux et écrivez des applications régulières pour cela, en mettant à jour le logiciel à partir d'un lecteur flash». Les systèmes de contrôle des équipements électriques sont des systèmes en temps réel très difficiles. Ce n'est pas que Linux, même tous les systèmes d'exploitation spécialisés en temps réel ne conviennent pas à de telles tâches. Par exemple, l'interruption de l'ADC par la lecture et la moyenne des données analogiques peut être provoquée avec une fréquence allant jusqu'à 100 kHz. En même temps, il ne contiendra qu'une douzaine ou deux lignes de code - collecte de données des canaux analogiques, quelques vérifications des protections à haute vitesse et sortie - tout, rien d'autre à faire. Si vous indiquez une telle interruption à un planificateur de tâches du système d'exploitation, alors simplement sa propre exécution prendra plus de ressources. Sans oublier que, en particulier,pour Linux, au lieu d'une puce MK, vous devez en mettre deux de plus sur la carte - RAM externe et mémoire flash, allouer un tas de pattes en cristal précieuses, utiliser une carte à six couches pour un câblage approprié, obtenir un temps de démarrage MK énorme (parfois en cas de panne de courant ou d'une minuterie de surveillance) commencer à travailler avant l'arrêt du moteur!), avoir des problèmes avec l'intégrité du système de fichiers, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, la cinquième caractéristique - les systèmes de contrôle de bas niveau pour les entraînements électriques et autres équipements électriques (contrairement aux tâches de communication sur différentes interfaces, les automates programmables, les contrôleurs de toutes sortes d'alarmes, les télécommandes, etc.) implémentent principalement des algorithmes de systèmes de contrôle automatique. À savoir: la moitié du logiciel se compose de différents types de structures fermées avec des contrôleurs PID, des blocs de saturation, des zones mortes, des tableaux de dépendance les uns des autres, des filtres, des observateurs, des ajusteurs d'intensité, des planificateurs de mouvement et autres. Les calculs dans ces logiciels sont effectués avec une certaine fréquence - disons, à une fréquence de 10 kHz, une interruption est déclenchée et calcule tous les blocs répertoriés, qui forment ensemble la structure de contrôle de l'équipement nécessaire. Dans de tels algorithmes, le débogage étape par étape n'aide pas - le plus souvent, à chaque étape, chaque module génère cece qu'on attend de lui - en fait, tous ces filtres, régulateurs, etc. sont déjà débogués depuis des années et il y a peu de surprises là-bas.</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des problèmes surviennent pendant le fonctionnement de l'ensemble de la structure dans son ensemble - chaque unité fonctionne individuellement et le processus de réglementation souhaité ne se produit pas comme prévu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Et les problèmes se trouvent dans l'ajustement de centaines de paramètres et de coefficients de ces blocs, ainsi que dans la structure assemblée à partir d'eux - il peut s'avérer que vous devez ajouter un nouveau circuit de stabilisation quelque part, ajouter un bloc de prédiction, des restrictions, etc. Par conséquent, c'est une autre "pierre dans le jardin" des messages de débogage étape par étape et de débogage printf: vous devez déboguer plus souvent qu'autrement le code du programme lui-même, mais la structure de contrôle automatique assemblée. Si quelqu'un a peu d'idée de ce que c'est (structure), alors voici la structure la plus simple d'une commande vectorielle sans capteur d'un moteur synchrone:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/bfd/b52/e6d/bfdb52e6d24c4d4ab7fac47a46fc8dd6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque case est parfois constituée de quelques formules, et parfois d'un module sur une douzaine ou deux pages de code. </font><font style="vertical-align: inherit;">Le module possède des entrées / sorties, ainsi que certaines variables d'état (par exemple, la partie intégrante du régulateur PI, etc.). </font><font style="vertical-align: inherit;">Ceux qui le souhaitent peuvent également voir une structure similaire sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la page Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Étant donné que le système de commande est fermé, le mauvais fonctionnement d'une unité (ou son réglage incorrect) conduit à l'inopérabilité de l'ensemble de la structure. </font><font style="vertical-align: inherit;">Et trouver exactement où est le problème - c'est une autre tâche.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment le déboguer?</font></font></h1><br>
<img src="https://habrastorage.org/files/ff6/921/70e/ff692170e60d460ba420efd360713681.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors que faire, comment le déboguer? Un oscilloscope externe? N'aidera pas. L'oscilloscope, bien sûr, est nécessaire pour déboguer certains problèmes purement matériels, mais ils ne peuvent voir que les valeurs d'entrée et de sortie du microcontrôleur, et des centaines de variables à l'intérieur de la structure resteront dans les coulisses. Eh bien, vous verrez que le courant de phase du moteur saccade étrangement et que la tension de sortie de l'onduleur saccade étrangement. Et pourquoi - quel bloc à l'intérieur du logiciel MK conduit à cela (ou un moteur ou un capteur de position ou autre chose conduit à cette courbe) - reste incertain. </font></font><br>
<br>
<img src="https://habrastorage.org/files/cb4/56d/195/cb456d1959b148e18c758a60bcbf4b1d.png" align="right"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modèle? Oui, c'est une bonne aide.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le plus souvent, le développement de structures de gestion complexes commence par la modélisation. En termes de TAU et sous forme d'équations différentielles, l'objet de contrôle est décrit, le système de contrôle proposé est construit (comme dans la figure ci-dessus, par exemple), puis tout cela est réalisé ... eh bien, qui aime quoi, mais la norme de facto est Simulink Matlab. Dans ce document, vous pouvez «dessiner» une structure avec un modèle de l'objet de contrôle, en utilisant «lâche» sous la forme d'intégrateurs, d'additionneurs, de fonctions de transition, etc. Vous pouvez utiliser son package pour modéliser des circuits électriques, où il y a des clés IGBT prêtes à l'emploi, des moteurs électriques, des résistances, des condensateurs et plus encore, donnant à la merci des programmeurs matlab la mise en œuvre du tracé sous la forme d'équations différentielles, et dessiner la structure de contrôle elle-même déjà sous la forme de «feuilles mobiles» elle-même.Et vous pouvez écrire tous les blocs nécessaires dans matlab en C. Cette méthode est pratique dans la mesure où le code de programme débogué dans le matlab peut simplement être copié sur le microcontrôleur. Habituellement, cette étape suit toujours le «dessin», lorsque la structure du système de contrôle après un travail de recherche approximatif sur la modélisation est plus ou moins formée. Mais souvent, les paramètres de l'objet sont inconnus a priori, ou ils sont connus de manière très imprécise - jamais auparavant le logiciel fonctionnant dans le modèle n'a commencé à fonctionner aussi bien sur l'objet. Il est également impossible de mettre "tout" dans le modèle - transistors de commutation transitoires, saturation du circuit magnétique, courants de Foucault, couplage capacitif, paramètres flottants de la température et d'instance en instance, interférences ici et là ... Et parfois, l'objet de régulation est si compliqué,qu'il est plus facile de faire le développement d'une structure de contrôle pour elle directement sur le site.</font></font><br>
<blockquote><i>,                 ,   ()  -    .        ,        ,     «»  –      ,    ,       - ? (   –  ,   «  »,   ).</i></blockquote><br>
<br>
<img src="https://habrastorage.org/files/87d/3fa/b55/87d3fab5514c4539abcba708c6601d24.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe également un certain nombre de produits qui vous permettent de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"dessiner" des programmes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directement pour les microcontrôleurs. Y compris le même Matlab est capable de générer du code C pour les marques célèbres MK basées sur le modèle de Simulink. Apparemment, vous pouvez dessiner et déboguer la structure dessinée du système de contrôle sur l'ordinateur dans le modèle, puis la télécharger sur MK - et vous avez terminé, c'est parti! Et même de tels environnements vous permettent de déboguer des structures de contrôle dessinées directement à l'intérieur du MK, de surveiller les variables, etc., et sur les sites de ces produits, il existe un tas de projets de démonstration pour les systèmes les plus complexes, «programmés» de cette façon. Mais comme tous les projets réels sont toujours programmés avec des «mains» pour une raison quelconque, nous pouvons deviner que quelque chose ne va pas avec le «dessin». Mais ici, il est même difficile de décrire ce qui est exactement, sinon, c'est tout. Le principal argument contre</font></font><b>–        </b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Vous appuyez sur un bouton dans un tel environnement «bien faire» et espérez que le générateur de code fera le reste pour vous. Pour certains systèmes simples, où les performances MK sont «derrière les yeux», le calendrier de développement est très serré, et personne ne sait comment programmer dans l'entreprise qui a lancé le projet ... alors oui, vous pouvez probablement essayer de «dessiner» le programme. Mais si cela ne fonctionne pas comme il se doit, ou aura un problème très spécifique, il n'y aura plus aucune chance de le déboguer. Et pour une tâche complexe, où même lorsque la programmation avec les mains avec des performances MK est toujours un problème, le dessin ne convient pas simplement en raison du manque de ressources - tout langage de programmation qu'il est de niveau supérieur (beaucoup plus élevé que le dessin) génère un code machine moins optimal. Et les optimisations de bas niveau qu'un programmeur C feraitun tel système ne sera pas en mesure de le faire (calcul de blocs de la même structure avec des horloges différentes, utilisation de valeurs mises en cache de sinus et cosinus, remplacement des fonctions de division par multiplication par une valeur pré-préparée, ou des choses absolument délicates comme</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tels</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, vous devez écrire votre logiciel et écrire en C.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et d'une manière ou d'une autre, vous devez déboguer votre logiciel, et c'est nécessaire sur l'objet. Probablement, tout le monde à ce stade de l'article a déjà compris que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la structure de contrôle ne peut être déboguée qu'en consultant les oscillogrammes des variables internes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est-à-dire voir les graphiques au fil du temps, comment telle ou telle variable en C change - disons, "la sortie de ce bloc, le cinquième à partir de la gauche, simultanément avec les entrées du troisième à partir de la droite". Obtenir des images comme celle-ci:</font></font><br>
 <div style="text-align:center;"><img src="https://habrastorage.org/files/0e0/2cc/c45/0e02ccc455504d699a7f8dfc02617634.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cela ne peut se faire qu'au moyen du microcontrôleur lui-même. Vous ne pouvez pas simplement prendre et mettre en place l'interface de communication rapide externe et envoyer «en haut» la valeur d'une variable, aussi rapidement que possible, et créer un graphique dans le système de niveau supérieur. Parce qu'aucune interface de communication MK n'aura le temps de le faire avec la fréquence à laquelle les transitoires régulés se produisent. Et si vous réussissez, toutes les ressources MK iront à la maintenance de cette interface de communication. Par conséquent, ils le font - ils </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enregistrent la forme d'onde dans la RAM de MK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">juste dans un tableau. Habituellement, beaucoup de points ne sont pas nécessaires - il suffit de saisir le bon moment pour écrire exactement les données: mettez le bon déclencheur au début de l'enregistrement. Et puis vous pouvez voir ce que ces ou ces blocs du système de contrôle distribuaient au moment de l'échec, comment il se développait, ce que MK essayait de faire. Bien sûr, toutes les variables ne peuvent pas être immédiatement oscillées simultanément - mais dans la pratique, selon notre expérience, il y a, disons, quatre tableaux de 256 points chacun - une sorte d'oscilloscope à quatre canaux utilisant des outils MK. Si l'équipement fonctionne plus d'une fois par semaine, le débogage n'est pas un problème - dans une expérience, nous examinons ces 4 variables, dans la suivante, nous remplaçons la moitié par les autres, regardons à nouveau ... jusqu'à ce qu'une unité défectueuse soit trouvée, ou jusqu'à ce que nous supprimions tout ce qui se passe sur tous les blocs et ne laissez pas regarder les "images", gratter l'endroit qui pense quoi ...</font></font><br>
<br>
<img src="https://habrastorage.org/files/e35/ad1/99c/e35ad199c3054cf88227b00e60ea4e42.png" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment filmer de tels oscillogrammes? Quel logiciel peut faire cela? Quelle interface de communication cela transmet-il? En fait, Texas Instruments est donc le leader dans la production de microcontrôleurs de motocontrôle, car il a tout fait pour cela: Code Composer Studio (leur environnement de développement) plus MK en temps réel. Le mode temps réel est lorsque, via le JTAG, l'environnement de développement peut demander et écrire des données dans la mémoire RAM du MK sans l'arrêter. Même pas seulement sans s'arrêter, mais sans la moindre interruption de son travail. Ce mode est disponible dans tous les MK de la série C2000, mais il nécessite le JTAG cher et rapide pour l'utiliser, ce qui le prend en charge. Mais en plus du mode lui-même, le MK devrait avoir quelque chose de correspondant à l'arrière du câble: l'environnement de développement Code Composer Studio est capable de créer des formes d'onde hors de la boîte.De plus, à la fois dans le mode le plus simple, lorsque l'utilisateur définit le nom de la variable C et voit son changement dans le temps sur le graphique, et que l'environnement demande des données avec la fréquence à laquelle il peut (généralement bon, si Hertz 10), et dans le mode d'affichage du tableau en mémoire dans forme d'onde - c.-à-d. juste ce qui est décrit ci-dessus.</font></font><b> ,     ,      ,  Code Composer Studio  JTAG       .</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le même temps, l'appareil peut continuer à fonctionner comme si de rien n'était. Cet outil est utilisé avec succès depuis plus de dix ans et, en fait, une telle idéologie de débogage (il semble, mais je peux me tromper) a été proposée par le Texas. Dans tous leurs projets de démonstration, il existe un module d'enregistreur de données (qui enregistre des tableaux de formes d'onde) et les manuels décrivent comment l'utiliser. Au fait, ici, vous devez jeter une pierre dans le jardin ARM. Ils ont également un mode en temps réel, et sur cette architecture, il y a des MK qui peuvent contrôler les moteurs électriques. Cependant, dans aucun environnement de développement, je suis tombé sur une fonction graphique, même si le mode temps réel est pris en charge. Par exemple, dans Keil est le bien-aimé de tout le monde, il est même impossible de changer normalement la valeur d'une variable sur un MK en cours d'exécution - elle est constamment mise à jour,et la nouvelle valeur entrée par l'utilisateur dans la fenêtre est effacée ... Sans parler des graphiques. Peut-être que quelqu'un dans les commentaires suggérera une option de travail? Ou est-ce "personne n'a besoin" et ne fonctionne donc pas?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y a un problème avec cette méthode de débogage, même via Code Composer Studio. </font><font style="vertical-align: inherit;">Et ce problème est JTAG. </font><font style="vertical-align: inherit;">Comme cela a été dit, son connecteur n'est pas toujours disponible, et le plus souvent sur des équipements en marche et n'est pas du tout disponible. </font><font style="vertical-align: inherit;">Et, franchement, ce n'est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas très confortable de s'asseoir à quelques mètres du convertisseur mégawatt, de regarder ses oscillogrammes de travail,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et très concentré et concentré pour contourner le bouton "stop" du microcontrôleur avec la souris, et si un doigt tremblait en cours de route? </font><font style="vertical-align: inherit;">Savez-vous comment le pavé tactile est bogué lors de l'utilisation d'un PWM puissant? </font><font style="vertical-align: inherit;">Et si l'environnement échoue? </font><font style="vertical-align: inherit;">Et JTAG? </font><font style="vertical-align: inherit;">Tout, larges?</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Babakh ordinaire</font></font></b><div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/files/de8/e31/f38/de8e31f38400412aaa02056649add98c.jpg"></div><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les formes d'onde dans l'environnement de développement sont affichées dans les valeurs «telles quelles» en C, sans aucune mise à l'échelle, dans différentes fenêtres des graphiques, sans unités de mesure personnalisées (rappelez-vous que dans ce graphique 0,342 sont des volts, ils doivent être multipliés dans l'esprit par 540 pour obtenir des unités physiques, et ici 1,2 sont des ampères avec une échelle de 800A). </font><font style="vertical-align: inherit;">Et inconfortable et effrayant. </font><font style="vertical-align: inherit;">Et pourtant, tous les MK et environnements de développement ne peuvent pas regarder les oscillogrammes! </font><font style="vertical-align: inherit;">Soudain, ce n'est pas le Texas? </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par conséquent, nous avons décidé d'inventer une autre façon.</font></font></b><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre décision</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, si nous n'avons pas besoin d'un débogage étape par étape, quel est le problème? </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous remplaçons tout ce que nous faisons via JTAG par toute autre interface de communication</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et créons notre propre shell de niveau supérieur, qui construit les graphiques comme nous le souhaitons. </font><font style="vertical-align: inherit;">Profit!</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/64f/f8d/f37/64ff8df373724e92af81eb389bc1becc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous l'avons donc fait. Interface de communication que nous avons choisie CAN, protocole - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CANopen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pourquoi? CAN est une très bonne interface de communication industrielle, résistante au bruit, a un arbitrage matériel, un accès non destructif au bus, une confirmation matérielle des packages, et en même temps - seulement deux fils et la terre. C'est mieux que tous les RS, et moins monstrueux qu'Ethernet (ce qui est plutôt exotique sur motorcontrol MK). Pourquoi canopen? En fait, il existe deux protocoles communs pour CAN, ce sont J1939 («automobile») et CANopen (machines-outils, automatisation, capteurs, etc.). Il n'y a pas beaucoup de différence entre eux, mais CANopen nous a semblé plus flexible, nous l'avons donc implémenté dans notre propre pile (driver). Qui ne sait rien de CANopen - sa fonction principale, comme de nombreux protocoles pour MK, est de donner accès au dictionnaire des objets (liste des variables en C MK) à une adresse spécifique. Cela peut se faire de deux manières principales:Messages SDO du type requête-réponse, ainsi que messages PDO sous forme de valeurs d'envoi constantes par temporisateur ou événement (définit le niveau supérieur de ce qui doit être envoyé et quand). Il existe également divers services de services tels que des messages d'urgence, des messages sur la présence d'appareils sur le réseau (battement de cœur), etc. Un assistant sur le réseau n'est pas nécessaire: celui qui veut - envoie, à qui il veut - accepte.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/5e6/c70/423/5e6c70423a3840419cb3b46741987eb4.png" align="left"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons créé la pile CANopen non seulement pour MK, mais aussi pour l'ordinateur sous la forme d'une bibliothèque. Et déjà sur sa base, Windows a écrit son propre environnement de haut niveau. D'abord, ils ont simplement rendu l'accès aux variables du dictionnaire d'objets afin qu'il était possible de regarder et de modifier les paramètres du système de contrôle (et il y en a des centaines, en passant!), Ensuite, ils ont fait des graphiques en interrogeant périodiquement le paramètre du dictionnaire d'objets sur le réseau, puis ont ajouté le chargement des formes d'onde des tableaux MK (de plus, le choix de l'oscillographe est également fait à partir des objets variables du dictionnaire). </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons tout de même pour le débogage via JTAG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ou pas? Non, car j'avais également besoin de la fonction de mise à jour du logiciel via CAN. Malgré la présence d'un chargeur de démarrage CAN au Texas MK, nous avons décidé de faire le notre, car celui standard n'était pas CANopen et pouvait interférer avec le fonctionnement d'autres appareils sur le réseau pendant que nous en cousions un, ainsi que les appareils pouvaient interférer avec le firmware. De plus, il y a eu des problèmes de correction d'erreurs et de perte de messages (bien que CAN soit très bon, il se bloque parfois, et le firmware est une chose très importante pour ne pas faire de vérification ou réessayer d'envoyer une pièce cassée). Nous avons donc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implémenté notre «programmeur» sur le réseau CAN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais dans le cadre du protocole CANOpen. Maintenant c'est tout. Nous avons maintenant pu abandonner complètement JTAG, en l'utilisant une seule fois, pour programmer un nouveau MK.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, cette approche a ouvert de nouveaux horizons de débogage que nous n'avions pas vus auparavant. Puisque nous avons créé l'environnement de premier niveau en tenant compte non seulement des programmeurs, mais également des «personnes ordinaires», nous avons créé tous les paramètres en russe et rédigé la documentation pour l'installateur pour chaque paramètre (la documentation n'est pas l'environnement, mais le périphérique, bien sûr). Et cela a été bénéfique - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenant, s'il y a un problème avec le lecteur, vous n'avez pas à "tirer" le développeur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- dans certains cas, le personnel du service client peut diagnostiquer indépendamment les problèmes. Maintenant, nous pouvons obtenir un e-mail comme «Notre lecteur a commencé à faire des sons étranges parfois, j'ai regardé l'oscillogramme du capteur de position, c'est ce que j'ai vu (photo). J'ai vérifié la mise à la terre de l'écran, elle est tombée, j'ai soudé et tout a fonctionné comme il se doit! » Et absolument pas besoin d'aller n'importe où ou de voler! La deuxième "découverte" - s'il y a un problème, nous demandons au client de connecter l'ordinateur à l'équipement et de donner le contrôle du bureau à distance sur Internet - nous lançons notre environnement de haut niveau, nous allons tout osciller nous-mêmes, nous corrigeons les paramètres / firmware / nous disons qu'il s'est cassé - profit! Encore une fois, vous n'avez pas besoin d'aller n'importe où (l'essentiel est qu'Internet soit installé dans l'établissement, au moins via un réseau cellulaire).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fil des ans, ce programme de haut niveau a acquis de petites fonctions, comme les champignons (un processus naturel pour les logiciels qu'ils utilisent). Cela inclut l'utilisation du journal des plantages du périphérique, l'enregistrement / le chargement d'un nugget de tous les paramètres dans un fichier sur l'ordinateur, et la configuration du panneau de contrôle du périphérique à la "panneau de contrôle", et la gestion des journaux réseau dans un fichier et le retour du trafic réseau CAN sur TCP / IP, et le firmware / paramétrage multiple automatique d'appareils similaires sur le réseau (s'il y a des dizaines d'appareils, alors tout flasher avec vos mains est paresseux, vous avez besoin d'un script), etc.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/files/9ba/78c/d12/9ba78cd1202b435f810aa132a0f3299e.png" align="left"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, maintenant de la publicité. Maintenant, c'est déjà un outil très puissant (nous l'avons appelé autant que UniCON), qui dans certaines tâches semble plus fonctionnel que les logiciels similaires de marques célèbres pour configurer leurs lecteurs et appareils. De plus, il n'est pas lié à un appareil spécifique - vous pouvez configurer au moins un entraînement électrique, au moins un poêle, au moins un chargeur - seul le dictionnaire des objets change. Maintenant, dans notre entreprise, nous ne voyons pas l'opportunité de mener à bien un nouveau projet complexe sans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos outils de débogage CANopen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pour travailler avec UniCON, il vous suffit d'intégrer notre pile CANopen dans MK, après quoi MK se transforme en laboratoire numérique. Nous sommes sûrs que toutes les entreprises qui font des systèmes de contrôle sérieux sur MK disposent d'outils de débogage similaires. Mais nous proposons notre solution CANopen sous la forme d'un produit logiciel indépendant, car il est universellement mis en œuvre en termes d'indépendance par rapport aux fonctions de l'appareil. Actuellement, nous avons implémenté la pile CANopen avec les fonctions avancées décrites pour le Texas Instruments C2000 MK, leurs microcontrôleurs ARM (par exemple, la famille Concerto) et pour le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K1921VK01T du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> NIIET OJSC. Par conséquent, si vous avez besoin de développer un système de contrôle pour un entraînement électrique ou un autre objet de contrôle complexe, nous vous invitons à coopérer.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les commentaires, nous attendons avec impatience les critiques de la forme "Il y a donc *** - ça fait tout de même et gratuitement." Depuis que nous recherchons depuis longtemps des outils de débogage similaires pour ARM pour la fonctionnalité, nous sommes même tombés sur des environnements de développement célèbres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: Merci aux commentaires d'   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indemsys</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">olekl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et   </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LeonidLenin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous avons trouvé des fonctions de cartographie dans les environnements de développement pour ARM Keil et STMStudio lors de l'utilisation de SWD. </font><font style="vertical-align: inherit;">Cependant, ils ne savent pas comment afficher un tableau de données de la mémoire MK sous la forme d'un graphique, ce qui est juste ce qui est nécessaire pour observer les processus rapides des systèmes de contrôle (mais STMStudio peut afficher des graphiques avec un temps d'échantillonnage d'environ 1 ms en utilisant la mise en cache des données). </font><font style="vertical-align: inherit;">L'outil NXP FreeMaster est également intéressant - dans sa description et son objectif, il est très similaire à notre développement UniCON, mais avec ses propres caractéristiques. </font><font style="vertical-align: inherit;">De plus, le Segger J-Link possède son propre outil d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affichage de forme d'onde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr389123/">https://habr.com/ru/post/fr389123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr389113/index.html">Le SSD le plus spacieux du monde: 13 To de Fixstars</a></li>
<li><a href="../fr389115/index.html">Il est proposé de développer des organes et des tissus humains pour la transplantation chez les animaux.</a></li>
<li><a href="../fr389117/index.html">L'imprimante 3D Ripple Maker transfère l'image ou le texte souhaité sur la surface de la mousse de café</a></li>
<li><a href="../fr389119/index.html">Ajout et configuration de la base de données 1C sur le serveur</a></li>
<li><a href="../fr389121/index.html">Firefox 46 prendra en charge plusieurs moniteurs avec différentes densités de pixels</a></li>
<li><a href="../fr389125/index.html">Galactosismologie: comment les galaxies naines composées de matière noire laissent des traces dans le gaz interstellaire</a></li>
<li><a href="../fr389127/index.html">Marketing agressif ou en quoi la motivation d'un arc lumineux au poignet ("babioles") diffère de la motivation d'un bracelet de fitness</a></li>
<li><a href="../fr389129/index.html">Nouveau microcontrôleur domestique de contrôle moteur K1921VK01T de OJSC NIIET</a></li>
<li><a href="../fr389133/index.html">Les chiens reconnaissent les émotions humaines à travers plusieurs sens</a></li>
<li><a href="../fr389139/index.html">Drinky est un robot copain qui est toujours là</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>