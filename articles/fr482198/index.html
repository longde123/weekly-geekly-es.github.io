<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíû üè¨ üëåüèΩ Comment faire votre autoscaler pour un cluster üíâ üë®‚Äçüë¶ üéÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Nous formons les gens √† travailler avec le Big Data. Il est impossible d'imaginer un programme √©ducatif sur les m√©gadonn√©es sans son propre clus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment faire votre autoscaler pour un cluster</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/newprolab/blog/482198/"><p>  Salut  Nous formons les gens √† travailler avec le Big Data.  Il est impossible d'imaginer un programme √©ducatif sur les m√©gadonn√©es sans son propre cluster, sur lequel tous les participants travaillent ensemble.  Pour cette raison, nous l'avons toujours sur notre programme :) Nous sommes engag√©s dans son r√©glage, son r√©glage et son administration, et les gars y lancent directement des jobs MapReduce et utilisent Spark. </p><br><p>  Dans cet article, nous d√©crirons comment nous avons r√©solu le probl√®me du chargement in√©gal des clusters en √©crivant notre autoscaler √† l'aide du <a href="https://mcs.mail.ru/">cloud Mail.ru Cloud Solutions</a> . </p><a name="habracut"></a><br><h2 id="problema">  Le probl√®me </h2><br><p>  Le cluster que nous utilisons n'est pas tout √† fait typique.  L'√©limination est tr√®s in√©gale.  Par exemple, il y a des exercices pratiques lorsque les 30 personnes et l'enseignant entrent dans le cluster et commencent √† l'utiliser.  Ou, encore une fois, il y a des jours avant la date limite, lorsque la charge augmente consid√©rablement.  Le reste du temps, le cluster fonctionne en mode de sous-charge. </p><br><p>  La solution n ¬∞ 1 consiste √† conserver un cluster qui r√©sistera aux pics de charge, mais restera inactif le reste du temps. </p><br><p>  La solution n ¬∞ 2 consiste √† conserver un petit cluster dans lequel ajouter manuellement des n≈ìuds avant les classes et pendant les pics de charge. </p><br><p>  La solution n ¬∞ 3 consiste √† conserver un petit cluster et √† √©crire un autoscaler qui surveillera la charge actuelle du cluster et, √† l'aide de diverses API, ajoutera et supprimera des n≈ìuds du cluster. </p><br><p>  Dans cet article, nous parlerons de la d√©cision n ¬∞ 3.  Un tel autoscaler d√©pend fortement de facteurs externes et non internes, et les fournisseurs ne le fournissent souvent pas.  Nous utilisons l'infrastructure cloud de Mail.ru Cloud Solutions et avons √©crit un autoscaler √† l'aide de l'API MCS.  Et puisque nous nous entra√Ænons √† travailler avec les donn√©es, nous avons d√©cid√© de montrer comment vous pouvez √©crire un autoscaler similaire pour vos besoins et l'utiliser avec votre cloud </p><br><h2 id="prerequisites">  Pr√©requis </h2><br><p>  Tout d'abord, vous devez disposer d'un cluster Hadoop.  Par exemple, nous utilisons la distribution HDP. </p><br><p>  Pour que vos n≈ìuds puissent √™tre rapidement ajout√©s et supprim√©s, vous devez avoir une certaine r√©partition des r√¥les entre les n≈ìuds. </p><br><ol><li>  Noeud ma√Ætre.  Eh bien, rien n'est particuli√®rement n√©cessaire √† expliquer ici: le n≈ìud principal du cluster, sur lequel, par exemple, le pilote Spark est lanc√©, si vous utilisez le mode interactif. </li><li>  Noeud de date.  Il s'agit du n≈ìud sur lequel vous stockez les donn√©es sur HDFS et les calculs y sont effectu√©s. </li><li>  N≈ìud informatique.  Il s'agit d'un n≈ìud sur lequel vous ne stockez rien sur HDFS, mais des calculs y sont effectu√©s. </li></ol><br><p>  Un point important.  La mise √† l'√©chelle automatique se produira en raison du troisi√®me type de n≈ìuds.  Si vous commencez √† prendre et √† ajouter des n≈ìuds du deuxi√®me type, la vitesse de r√©ponse sera tr√®s faible - d√©compress√©e et recommand√©e prendra des heures sur votre cluster.  Bien s√ªr, ce n'est pas ce que vous attendez de la mise √† l'√©chelle automatique.  Autrement dit, nous ne touchons pas les n≈ìuds du premier et du deuxi√®me type.  Il s'agira d'un cluster minimalement viable qui existera tout au long du programme. </p><br><p>  Ainsi, notre enrouleur automatique est √©crit en Python 3, utilise l'API Ambari pour g√©rer les services de cluster, utilise <a href="https://mcs.mail.ru/help/iaas-api/openstack-api">l'API Mail.ru Cloud Solutions</a> (MCS) pour d√©marrer et arr√™ter les machines. </p><br><h2 id="arhitektura-resheniya">  Architecture de la solution </h2><br><ol><li> Module <code>autoscaler.py</code> .  Trois classes y sont enregistr√©es: 1) fonctions pour travailler avec Ambari, 2) fonctions pour travailler avec MCS, 3) fonctions li√©es directement √† la logique de mise √† l'√©chelle automatique. </li><li>  Script <code>observer.py</code> .  En fait, il se compose de diff√©rentes r√®gles: quand et √† quels moments appeler les fonctions de mise √† l'√©chelle automatique. </li><li>  Le fichier avec les param√®tres de configuration <code>config.py</code> .  Il contient, par exemple, une liste de n≈ìuds autoris√©s pour la mise √† l'√©chelle automatique et d'autres param√®tres qui affectent, par exemple, le temps d'attente √† partir du moment o√π un nouveau n≈ìud a √©t√© ajout√©.  Il existe √©galement des horodatages du d√©but des classes, de sorte qu'avant la session, la configuration de cluster maximale autoris√©e est lanc√©e. </li></ol><br><p>  Regardons les morceaux de code √† l'int√©rieur des deux premiers fichiers. </p><br><h2 id="1-modul-autoscalerpy">  1. Le module autoscaler.py </h2><br><h3 id="klass-ambari">  Ambari classe </h3><br><p>  Voici le morceau de code qui contient la classe <code>Ambari</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ambari</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari_url, cluster_name, headers, auth)</span></span></span><span class="hljs-function">:</span></span> self.ambari_url = ambari_url self.cluster_name = cluster_name self.headers = headers self.auth = auth <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop_all_services</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> url = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname + <span class="hljs-string"><span class="hljs-string">'/host_components/'</span></span> url2 = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname req0 = requests.get(url2, headers=self.headers, auth=self.auth) services = req0.json()[<span class="hljs-string"><span class="hljs-string">'host_components'</span></span>] services_list = list(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x[<span class="hljs-string"><span class="hljs-string">'HostRoles'</span></span>][<span class="hljs-string"><span class="hljs-string">'component_name'</span></span>], services)) data = { <span class="hljs-string"><span class="hljs-string">"RequestInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"context"</span></span>:<span class="hljs-string"><span class="hljs-string">"Stop All Host Components"</span></span>, <span class="hljs-string"><span class="hljs-string">"operation_level"</span></span>: { <span class="hljs-string"><span class="hljs-string">"level"</span></span>:<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>, <span class="hljs-string"><span class="hljs-string">"cluster_name"</span></span>: self.cluster_name, <span class="hljs-string"><span class="hljs-string">"host_names"</span></span>: hostname }, <span class="hljs-string"><span class="hljs-string">"query"</span></span>:<span class="hljs-string"><span class="hljs-string">"HostRoles/component_name.in({0})"</span></span>.format(<span class="hljs-string"><span class="hljs-string">","</span></span>.join(services_list)) }, <span class="hljs-string"><span class="hljs-string">"Body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"HostRoles"</span></span>: { <span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"INSTALLED"</span></span> } } } req = requests.put(url, data=json.dumps(data), headers=self.headers, auth=self.auth) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req.status_code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>, <span class="hljs-number"><span class="hljs-number">202</span></span>]: message = <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: message = req.status_code <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p>  Pour un exemple ci-dessus, vous pouvez regarder l'impl√©mentation de la fonction <code>stop_all_services</code> , qui arr√™te tous les services sur le n≈ìud de cluster souhait√©. </p><br><p>  Pour la classe <code>Ambari</code> vous passez: </p><br><ul><li>  <code>ambari_url</code> , par exemple, de la forme <code>'http://localhost:8080/api/v1/clusters/'</code> , </li><li>  <code>cluster_name</code> est le nom de votre cluster dans Ambari, </li><li> <code>headers = {'X-Requested-By': 'ambari'}</code> </li> <li>  et √† l'int√©rieur d' <code>auth</code> se trouve votre nom d'utilisateur et votre mot de passe d'Ambari: <code>auth = ('login', 'password')</code> . </li></ul><br><p>  La fonction elle-m√™me n'est rien d'autre que quelques appels via l'API REST vers Ambari.  Du point de vue de la logique, nous obtenons d'abord une liste des services en cours d'ex√©cution sur le n≈ìud, puis nous demandons sur ce cluster, sur ce n≈ìud, de transf√©rer les services de la liste √† l'√©tat <code>INSTALLED</code> .  Les fonctions de lancement de tous les services, de mise des n≈ìuds √† l'√©tat <code>Maintenance</code> , etc. se ressemblent - ce ne sont que quelques requ√™tes via l'API. </p><br><h3 id="klass-mcs">  Classe mcs </h3><br><p>  C'est le morceau de code qui contient la classe <code>Mcs</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mcs</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id1, id2, password)</span></span></span><span class="hljs-function">:</span></span> self.id1 = id1 self.id2 = id2 self.password = password self.mcs_host = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:8774/v2.1'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm_turn_on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> self.token = self.get_mcs_token() host = self.hostname_to_vmname(hostname) vm_id = self.get_vm_id(host) mcs_url1 = self.mcs_host + <span class="hljs-string"><span class="hljs-string">'/servers/'</span></span> + self.vm_id + <span class="hljs-string"><span class="hljs-string">'/action'</span></span> headers = { <span class="hljs-string"><span class="hljs-string">'X-Auth-Token'</span></span>: <span class="hljs-string"><span class="hljs-string">'{0}'</span></span>.format(self.token), <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } data = {<span class="hljs-string"><span class="hljs-string">'os-start'</span></span> : <span class="hljs-string"><span class="hljs-string">'null'</span></span>} mcs = requests.post(mcs_url1, data=json.dumps(data), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mcs.status_code</code> </pre> <br><p>  √Ä la classe <code>Mcs</code> , nous transmettons l'ID du projet √† l'int√©rieur du cloud et l'ID utilisateur, ainsi que son mot de passe.  Dans la fonction <code>vm_turn_on</code> , nous voulons activer l'une des machines.  La logique ici est un peu plus compliqu√©e.  Au d√©but du code, trois autres fonctions sont appel√©es: 1) nous devons obtenir le jeton, 2) nous devons convertir le nom d'h√¥te en nom de la machine dans MCS, 3) obtenir l'ID de cette machine.  Ensuite, nous faisons une simple post-demande et ex√©cutons cette machine. </p><br><p>  Voici √† quoi ressemble la fonction de r√©ception de jetons: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mcs_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:35357/v3/auth/tokens?nocatalog'</span></span> headers = {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>} data = { <span class="hljs-string"><span class="hljs-string">'auth'</span></span>: { <span class="hljs-string"><span class="hljs-string">'identity'</span></span>: { <span class="hljs-string"><span class="hljs-string">'methods'</span></span>: [<span class="hljs-string"><span class="hljs-string">'password'</span></span>], <span class="hljs-string"><span class="hljs-string">'password'</span></span>: { <span class="hljs-string"><span class="hljs-string">'user'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id1, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: self.password } } }, <span class="hljs-string"><span class="hljs-string">'scope'</span></span>: { <span class="hljs-string"><span class="hljs-string">'project'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id2 } } } } params = ((<span class="hljs-string"><span class="hljs-string">'nocatalog'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>),) req = requests.post(url, data=json.dumps(data), headers=headers, params=params) self.token = req.headers[<span class="hljs-string"><span class="hljs-string">'X-Subject-Token'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.token</code> </pre> <br><h3 id="klass-autoscaler">  Autoscaler de classe </h3><br><p>  Cette classe contient des fonctions li√©es √† la logique du travail lui-m√™me. </p><br><p>  Voici √† quoi ressemble un morceau de code de cette classe: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Autoscaler</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari, mcs, scaling_hosts, yarn_ram_per_node, yarn_cpu_per_node)</span></span></span><span class="hljs-function">:</span></span> self.scaling_hosts = scaling_hosts self.ambari = ambari self.mcs = mcs self.q_ram = deque() self.q_cpu = deque() self.num = <span class="hljs-number"><span class="hljs-number">0</span></span> self.yarn_ram_per_node = yarn_ram_per_node self.yarn_cpu_per_node = yarn_cpu_per_node <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> flag1 = flag2 = flag3 = flag4 = flag5 = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.scaling_hosts: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status1 = self.ambari.decommission_nodemanager(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status1 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag1 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Decomission request accepted: {0}'</span></span>.format(flag1)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status3 = self.ambari.check_service(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status3 == <span class="hljs-string"><span class="hljs-string">'INSTALLED'</span></span>: flag3 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Nodemaneger decommissioned: {0}'</span></span>.format(flag3)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status2 = self.ambari.maintenance_on(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status2 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status2 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag2 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance request accepted: {0}'</span></span>.format(flag2)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status4 = self.ambari.check_maintenance(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'ON'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'IMPLIED_FROM_HOST'</span></span>: flag4 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.ambari.stop_all_services(hostname) logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance is on: {0}'</span></span>.format(flag4)) logging.info(<span class="hljs-string"><span class="hljs-string">'Stopping services'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">90</span></span>) status5 = self.mcs.vm_turn_off(hostname) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status5 = self.mcs.get_vm_info(hostname)[<span class="hljs-string"><span class="hljs-string">'server'</span></span>][<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status5 == <span class="hljs-string"><span class="hljs-string">'SHUTOFF'</span></span>: flag5 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'VM is turned off: {0}'</span></span>.format(flag5)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> flag1 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag2 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag3 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag4 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag5: message = <span class="hljs-string"><span class="hljs-string">'Success'</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Scale-down finished'</span></span>) logging.info(<span class="hljs-string"><span class="hljs-string">'Cooldown period has started. Wait for several minutes'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p>  Pour l'entr√©e, nous prenons les classes <code>Ambari</code> et <code>Ambari</code> , la liste des n≈ìuds qui sont autoris√©s pour la mise √† l'√©chelle, ainsi que les param√®tres de configuration des n≈ìuds: m√©moire et CPU allou√©s au n≈ìud dans YARN.  Il y a √©galement 2 param√®tres internes q_ram, q_cpu, qui sont des files d'attente.  En les utilisant, nous stockons les valeurs de la charge de cluster actuelle.  Si nous constatons qu'au cours des 5 derni√®res minutes, la charge a augment√© de mani√®re stable, nous d√©cidons que nous devons ajouter un n≈ìud +1 au cluster.  Il en va de m√™me pour l'√©tat de sous-charge du cluster. </p><br><p>  Le code ci-dessus montre un exemple de fonction qui supprime une machine d'un cluster et l'arr√™te dans le cloud.  Tout d'abord, le <code>YARN Nodemanager</code> , puis le mode <code>Maintenance</code> est activ√©, puis nous arr√™tons tous les services sur la machine et d√©sactivons la machine virtuelle dans le cloud. </p><br><h2 id="2-skript-observerpy">  2. Script observer.py </h2><br><p>  Exemple de code √† partir de l√†: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> scaler.assert_up(config.scale_up_thresholds) == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: hostname = cloud.get_vm_to_up(config.scaling_hosts) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: status1 = scaler.scale_up(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Success'</span></span>: text = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} has been successfully scaled-up"</span></span>.format(hostname)} post = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>.format(text)} json_data = json.dumps(post) req = requests.post(webhook, data=json_data.encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), headers={<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) time.sleep(config.cooldown_period*<span class="hljs-number"><span class="hljs-number">60</span></span>)</code> </pre> <br><p>  Dans ce document, nous v√©rifions si les conditions existent pour augmenter les capacit√©s du cluster et s'il y a des machines dans la r√©serve, nous obtenons le nom d'h√¥te de l'une d'entre elles, l'ajoutons au cluster et publions un message √† ce sujet dans Slack de notre √©quipe.  Apr√®s cela, <code>cooldown_period</code> lanc√©, lorsque nous n'ajoutons ni ne supprimons rien du cluster, mais surveillons simplement la charge.  S'il s'est stabilis√© et se trouve dans le couloir des valeurs de charge optimales, alors nous continuons simplement la surveillance.  Si un n≈ìud n'√©tait pas suffisant, ajoutez-en un autre. </p><br><p>  Pour les cas o√π nous avons une le√ßon √† venir, nous savons d√©j√† avec certitude qu'un n≈ìud n'est pas suffisant, donc nous d√©marrons imm√©diatement tous les n≈ìuds libres et les gardons actifs jusqu'√† la fin de la le√ßon.  Cela se produit avec une liste de classes d'horodatage. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  L'autoscaler est une bonne solution pratique pour les cas o√π le chargement des clusters est in√©gal.  Vous obtenez simultan√©ment la configuration de cluster souhait√©e pour les charges de pointe et, en m√™me temps, ne maintenez pas ce cluster pendant la sous-charge, ce qui permet d'√©conomiser de l'argent.  Eh bien, en plus, tout se passe automatiquement sans votre participation.  L'autoscaler lui-m√™me n'est rien d'autre qu'un ensemble de demandes adress√©es √† l'API du gestionnaire de cluster et √† l'API du fournisseur de cloud, qui sont enregistr√©es selon une certaine logique.  Ce qu'il faut exactement retenir, c'est la s√©paration des n≈ìuds en 3 types, comme nous l'avons √©crit plus t√¥t.  Et vous serez heureux. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482198/">https://habr.com/ru/post/fr482198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482186/index.html">La vie et l'informatique ou l'ann√©e o√π j'ai quitt√© mon dernier emploi</a></li>
<li><a href="../fr482188/index.html">Vendredi sondage sur les mises √† jour</a></li>
<li><a href="../fr482190/index.html">√Ä quoi ressemble le contenu Durex sur les r√©seaux sociaux en Chine</a></li>
<li><a href="../fr482194/index.html">G√©n√©rer et remplir automatiquement des √©l√©ments de configuration de p√©riph√©rique r√©seau avec Nornir</a></li>
<li><a href="../fr482196/index.html">Qu'est-ce que la mod√©lisation de la production et pourquoi est-elle n√©cessaire?</a></li>
<li><a href="../fr482202/index.html">M√©thodes de mise √† jour de la cryptographie sur l'√©quipement Check Point vers GOST 2012</a></li>
<li><a href="../fr482206/index.html">Comment rendre la production 3D de pi√®ces d'avion plus √©conomique</a></li>
<li><a href="../fr482208/index.html">Cadeaux qui vous font manquer le Nouvel An</a></li>
<li><a href="../fr482210/index.html">Bot pour Tetris et animation d'ing√©nierie inverse. Analyse de la piste mobile du deuxi√®me championnat de programmation</a></li>
<li><a href="../fr482212/index.html">Tu parles de ... fromage?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>