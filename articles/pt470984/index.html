<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§õüèª üßôüèæ ‚ùÑÔ∏è An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio ü§ú üöπ üéóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A partir da vers√£o 7.04, o analisador PVS-Studio para linguagens C e C ++ no Linux e macOS possui uma capacidade de teste para verificar a lista de ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/470984/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac4/d08/0e7/ac4d080e7661626569ef514abe190662.png" alt="Quadro 11"></div><br>  A partir da vers√£o 7.04, o analisador PVS-Studio para linguagens C e C ++ no Linux e macOS possui uma capacidade de teste para verificar a lista de arquivos especificados.  Usando o novo modo, voc√™ pode configurar o analisador para verificar confirma√ß√µes e solicita√ß√µes.  Este artigo mostra como configurar a verifica√ß√£o da lista de arquivos de projeto GitHub modificados em sistemas populares de CI (integra√ß√£o cont√≠nua) como Travis CI, Buddy e AppVeyor. <br><a name="habracut"></a><br><h2>  Modo de verifica√ß√£o da lista de arquivos </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O PVS-Studio</a> √© uma ferramenta para detectar erros e poss√≠veis vulnerabilidades no c√≥digo fonte de programas escritos em C, C ++, C # e Java.  Funciona em sistemas de 64 bits no Windows, Linux e macOS. <br><br>  No PVS-Studio vers√£o 7.04 para Linux e macOS, o modo de verificar a lista de arquivos de origem apareceu.  Isso funciona para projetos cujo sistema de constru√ß√£o permite que o arquivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compile_commands.json</a> seja gerado.  √â necess√°rio para o analisador extrair informa√ß√µes sobre a compila√ß√£o dos arquivos especificados.  Se o seu sistema de constru√ß√£o n√£o suportar a gera√ß√£o do arquivo compile_commands.json, voc√™ poder√° tentar gerar esse arquivo usando o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bear</a> . <br><br>  Al√©m disso, o modo de verifica√ß√£o da lista de arquivos pode ser usado junto com o log de rastreamento de strace das partidas do compilador (rastreamento do pvs-studio-analyzer).  Para fazer isso, primeiro voc√™ precisar√° realizar uma montagem completa do projeto e acompanh√°-lo, para que o analisador colete informa√ß√µes completas sobre os par√¢metros de compila√ß√£o de todos os arquivos testados. <br><br>  No entanto, essa op√ß√£o tem uma desvantagem significativa - voc√™ precisar√° fazer um rastreamento completo de toda a montagem do projeto a cada in√≠cio, o que por si s√≥ contradiz a id√©ia de uma verifica√ß√£o r√°pida da confirma√ß√£o.  Ou, se o pr√≥prio resultado do rastreamento estiver armazenado em cache, o in√≠cio subsequente do analisador poder√° n√£o ser conclu√≠do se a estrutura de depend√™ncia dos arquivos de origem for alterada ap√≥s o rastreamento (por exemplo, um novo #include √© adicionado a um dos arquivos de origem). <br><br>  Portanto, n√£o recomendamos o uso do modo de verifica√ß√£o da lista de arquivos com o log de rastreamento para verificar confirma√ß√µes ou solicita√ß√µes de recebimento.  Caso voc√™ possa fazer uma montagem incremental ao verificar uma confirma√ß√£o, considere usar o modo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">an√°lise incremental</a> . <br><br>  A lista de arquivos de origem para an√°lise √© salva em um arquivo de texto e transferida para o analisador usando o par√¢metro <i>-S</i> : <br><br><pre><code class="bash hljs">pvs-studio-analyzer analyze ... -f build/compile_commands.json -S check-list.txt</code> </pre> <br>  Nesse arquivo, os caminhos relativos ou absolutos para os arquivos s√£o indicados e cada novo arquivo deve estar em uma nova linha.  √â permitido especificar n√£o apenas os nomes dos arquivos para an√°lise, mas tamb√©m v√°rios textos.  O analisador ver√° que este n√£o √© um arquivo e ignorar√° a linha.  Isso pode ser √∫til para comentar se os arquivos forem especificados manualmente.  No entanto, muitas vezes uma lista de arquivos ser√° gerada durante a an√°lise no IC, por exemplo, esses podem ser arquivos de uma solicita√ß√£o de confirma√ß√£o ou recebimento. <br><br>  Agora, usando esse modo, voc√™ pode verificar rapidamente o novo c√≥digo antes que ele entre no ramo de desenvolvimento principal.  Para que o sistema de verifica√ß√£o responda aos avisos do analisador, o sinalizador <i>--indicate-</i> <i>warnings</i> foi adicionado ao <i>utilit√°rio</i> <i>plog-converter</i> : <br><br><pre> <code class="bash hljs">plog-converter ... --indicate-warnings ... -o /path/to/report.tasks ...</code> </pre> <br>  Com esse sinalizador, o conversor retornar√° um c√≥digo diferente de zero se houver avisos no relat√≥rio do analisador.  Usando o c√≥digo de retorno, voc√™ pode bloquear o gancho de pr√©-confirma√ß√£o, a solicita√ß√£o de confirma√ß√£o ou recebimento e exibir o relat√≥rio do analisador gerado na tela, compartilhar ou enviar por correio. <br><br>  <i>Nota</i>  <i>Na primeira vez em que voc√™ executa a an√°lise da lista de arquivos, todo o projeto ser√° analisado, porque</i>  <i>o analisador precisa gerar um arquivo de depend√™ncias dos arquivos de origem do projeto a partir dos arquivos de cabe√ßalho.</i>  <i>Esse √© um recurso da an√°lise de arquivos C e C ++.</i>  <i>No futuro, o arquivo de depend√™ncia poder√° ser armazenado em cache e ser√° atualizado automaticamente pelo analisador.</i>  <i>A vantagem de verificar confirma√ß√µes ao usar o modo de verifica√ß√£o da lista de arquivos sobre o modo de an√°lise incremental √© que voc√™ s√≥ precisa armazenar em cache esse arquivo, n√£o os arquivos de objeto.</i> <br><br><h2>  Princ√≠pios gerais da an√°lise de solicita√ß√£o pull </h2><br>  A an√°lise de todo o projeto leva muito tempo; portanto, faz sentido verificar apenas uma parte dele.  O problema √© que voc√™ precisa separar os novos arquivos do restante dos arquivos do projeto. <br><br>  Considere um exemplo de uma √°rvore de confirma√ß√£o com dois ramos: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Quadro 5"></div><br><br>  Vamos imaginar que o commit <i>A1</i> cont√©m uma quantidade bastante grande de c√≥digo que j√° foi testado.  Um pouco antes, fizemos uma ramifica√ß√£o a partir do commit <i>A1</i> e alteramos alguns arquivos. <br><br>  Obviamente, voc√™ notou que, depois da <i>A1,</i> havia mais duas confirma√ß√µes, mas tamb√©m eram fus√µes de outras filiais, porque n√£o nos comprometemos no <i>mestre</i> .  E agora chegou a hora em que o <i>hotfix est√°</i> pronto.  Portanto, um pedido pull para a fus√£o de <i>B3</i> e <i>A3 apareceu</i> . <br><br>  Obviamente, era poss√≠vel verificar todo o resultado da fus√£o, mas isso seria muito longo e injustificado, pois apenas alguns arquivos foram alterados.  Portanto, √© mais eficiente analisar apenas as altera√ß√µes. <br><br>  Para fazer isso, obtemos a diferen√ßa entre os galhos, estando na cabe√ßa do galho do qual queremos mesclar no master: <br><br><pre> <code class="bash hljs">git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  <i>$ MERGE_BASE</i> , consideraremos com mais detalhes posteriormente.  O fato √© que nem todo servi√ßo de IC fornece as informa√ß√µes necess√°rias sobre a base da mesclagem; portanto, toda vez que voc√™ precisar criar novas maneiras de obter esses dados.  Isso ser√° detalhado abaixo em cada um dos servi√ßos da web descritos. <br><br>  Portanto, temos a diferen√ßa entre os ramos, ou melhor, uma lista de nomes de arquivos que foram alterados.  Agora, precisamos fornecer o <i>arquivo .pvs-pr.list</i> (redirecionamos a sa√≠da para ele acima) para o analisador: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list</code> </pre> <br>  Ap√≥s a an√°lise, precisamos converter o arquivo de log (PVS-Studio.log) em um formato f√°cil de ler: <br><br><pre> <code class="bash hljs">plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Este comando listar√° erros no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">stderr</a> (fluxo de sa√≠da da mensagem de erro padr√£o). <br><br>  S√≥ agora precisamos n√£o apenas exibir erros, mas tamb√©m informar nosso servi√ßo para montagem e teste de problemas.  Para fazer isso, o sinalizador <i>-W</i> ( <i>--indicate-warnings</i> ) foi adicionado ao conversor.  Se houver pelo menos um aviso do analisador, o c√≥digo de retorno do utilit√°rio <i>plog-converter</i> ser√° alterado para 2, que, por sua vez, informar√° o servi√ßo de IC sobre a presen√ßa de poss√≠veis erros nos arquivos de solicita√ß√£o de recebimento. <br><br><h2>  Travis ci </h2><br>  A configura√ß√£o √© feita como um arquivo <i>.travis.yml</i> .  Por conveni√™ncia, recomendo que voc√™ coloque tudo em um script bash separado com fun√ß√µes que ser√£o chamadas no arquivo <i>.travis.yml</i> ( <i>bash script_name.sh function_name</i> ). <br><br>  Adicionaremos o c√≥digo necess√°rio ao script <i>bash</i> , para obter mais funcionalidade.  Na se√ß√£o de <i>instala√ß√£o</i> , escreva o seguinte: <br><br><pre> <code class="xml hljs">install: - bash .travis.sh travis_install</code> </pre> <br>  Se voc√™ teve alguma instru√ß√£o, pode transferi-la para o script removendo h√≠fens. <br><br>  Abra o arquivo <i>.travis.sh</i> e adicione a instala√ß√£o do analisador √† fun√ß√£o <i>travis_install ()</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_install</span></span></span></span>() { wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update -qq sudo apt-get install -qq pvs-studio }</code> </pre> <br>  Agora adicione a execu√ß√£o da an√°lise √† se√ß√£o de <i>script</i> : <br><br><pre> <code class="xml hljs">script: - bash .travis.sh travis_script</code> </pre> <br>  E no script bash: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Esse c√≥digo precisa ser executado ap√≥s a cria√ß√£o do projeto, por exemplo, se voc√™ construiu o CMake: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 }</code> </pre> <br>  Acontecer√° assim: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">travis_script</span></span></span></span>() { CMAKE_ARGS=<span class="hljs-string"><span class="hljs-string">"-DCMAKE_EXPORT_COMPILE_COMMANDS=On </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CMAKE_ARGS}</span></span></span><span class="hljs-string">"</span></span> cmake <span class="hljs-variable"><span class="hljs-variable">$CMAKE_ARGS</span></span> CMakeLists.txt make -j8 pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TRAVIS_PULL_REQUEST</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"false"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> git diff --name-only origin/HEAD &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ -S .pvs-pr.list \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w }</code> </pre> <br>  Voc√™ provavelmente j√° percebeu as vari√°veis ‚Äã‚Äãde ambiente especificadas <i>$ TRAVIS_PULL_REQUEST</i> e <i>$ TRAVIS_BRANCH</i> .  O Travis CI os anuncia por conta pr√≥pria: <br><br><ul><li>  <i>$ TRAVIS_PULL_REQUEST</i> armazena o n√∫mero da <i>solicita√ß√£o de recebimento</i> ou <i>false,</i> se for uma ramifica√ß√£o regular; </li><li>  <i>$ TRAVIS_REPO_SLUG</i> armazena o nome do reposit√≥rio do projeto. </li></ul><br>  O algoritmo desta fun√ß√£o: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9e2/d21/1c5/9e2d211c559a48b4bf144bdd606e4bc7.png" alt="Quadro 7"></div><br>  O Travis CI responde aos c√≥digos de retorno; portanto, a presen√ßa de avisos informar√° o servi√ßo para marcar o commit como contendo erros. <br><br>  Agora, vamos dar uma olhada mais de perto nesta linha de c√≥digo: <br><br><pre> <code class="bash hljs">git diff --name-only origin/HEAD &gt; .pvs-pr.list</code> </pre> <br>  O fato √© que o Travis CI mescla ramifica√ß√µes automaticamente durante a an√°lise de solicita√ß√£o de recebimento: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/443/986/1f4/4439861f46637d41119e83f83e2e440b.png" alt="Quadro 8"></div><br>  Portanto, analisamos <i>A4</i> , n√£o <i>B3-&gt; A3</i> .  Devido a esse recurso, precisamos calcular a diferen√ßa com <i>A3</i> , que √© precisamente o topo da ramifica√ß√£o desde a <i>origem</i> . <br><br>  Um detalhe importante permaneceu - as depend√™ncias de armazenamento em cache dos arquivos de cabe√ßalho nas unidades de convers√£o compiladas (* .c, * .cc, * .cpp, etc.).  O analisador calcula essas depend√™ncias na primeira inicializa√ß√£o no modo de verifica√ß√£o da lista de arquivos e, em seguida, salva no diret√≥rio .PVS-Studio.  O Travis CI permite que voc√™ <i>armazene</i> em cache as pastas, portanto salvaremos os dados do <i>diret√≥rio .PVS-Studio /</i> : <br><br><pre> <code class="xml hljs">cache: directories: - .PVS-Studio/</code> </pre> <br>  Esse c√≥digo precisa ser adicionado ao arquivo <i>.travis.yml</i> .  Esse diret√≥rio armazena v√°rios dados coletados ap√≥s a an√°lise, o que acelerar√° significativamente os lan√ßamentos subsequentes da an√°lise de lista de arquivos ou an√°lise incremental.  Se isso n√£o for feito, o analisador analisar√° todos os arquivos todas as vezes. <br><br><h2>  Amigo </h2><br>  Como o Travis CI, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Buddy</a> oferece a capacidade de criar e testar automaticamente projetos armazenados no GitHub.  Ao contr√°rio do Travis CI, ele √© configurado na interface da Web (o suporte ao bash est√° dispon√≠vel), portanto n√£o h√° necessidade de armazenar arquivos de configura√ß√£o no projeto. <br><br>  Primeiro de tudo, precisamos adicionar uma nova a√ß√£o √† linha de montagem: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/2fd/36e/75e2fd36e9a4420ff74256429ff73e0c.gif" alt="Quadro 1"></div><br>  Indicamos o compilador usado para construir o projeto.  Preste aten√ß√£o ao cont√™iner de docker instalado nesta a√ß√£o.  Por exemplo, h√° um cont√™iner especial para o GCC: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/95b/837/7ad/95b8377adbac7e50e55d97c5b318f56c.png" alt="Quadro 6"></div><br>  Agora instale o PVS-Studio e os utilit√°rios necess√°rios: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88e/fba/02b/88efba02b5a4c34f55c4344744812cc7.gif" alt="Quadro 2"></div><br>  Adicione as seguintes linhas ao editor: <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get -y install wget gnupg jq wget -q -O - https://files.viva64.com/etc/pubkey.txt | apt-key add - wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list apt-get update &amp;&amp; apt-get -y install pvs-studio</code> </pre> <br>  Agora v√° para a guia Executar (primeiro √≠cone) e adicione o seguinte c√≥digo ao campo apropriado do editor: <br><br><pre> <code class="bash hljs">pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Se voc√™ leu a se√ß√£o Travs-CI, esse c√≥digo j√° √© familiar para voc√™, no entanto, agora um novo est√°gio apareceu: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/615/40f/ec9/61540fec9bc7edf2032a84bdaf5a28fe.png" alt="Quadro 9"></div><br>  O fato √© que agora estamos analisando n√£o o resultado da fus√£o, mas o HEAD da filial da qual a solicita√ß√£o de recebimento √© feita: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/646/68c/72264668c4a90b96ccb63f363a46c683.png" alt="Quadro 10"></div><br>  Portanto, estamos no commit condicional <i>B3</i> e precisamos obter a diferen√ßa com <i>A3</i> : <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$BUDDY_EXECUTION_PULL_REQUEST_NO</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${BUDDY_REPO_SLUG}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list</code> </pre> <br>  Para determinar <i>A3,</i> use a API do GitHub: <br><br><pre> <code class="bash hljs">https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${USERNAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${REPO}</span></span>/pulls/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span></code> </pre> <br>  Usamos as seguintes vari√°veis ‚Äã‚Äãque o Buddy fornece: <br><br><ul><li>  <i>$ BUDDY_EXECUTION_PULL_REQEUST_NO</i> - puxa o n√∫mero da <i>solicita√ß√£o</i> ; </li><li>  <i>$ BUDDY_REPO_SLUG</i> - combina√ß√£o de nome de usu√°rio e reposit√≥rio (por exemplo, max / test). </li></ul><br>  Agora salve as altera√ß√µes usando o bot√£o abaixo e ative a an√°lise de solicita√ß√£o de recebimento: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74c/5d6/876/74c5d6876c07c0b2e0c10cdabb8b0f78.gif" alt="Quadro 3"></div><br>  Diferentemente do Travis CI, n√£o precisamos especificar <i>.pvs-studio</i> para armazenamento em cache, pois o Buddy armazena em cache automaticamente todos os arquivos para lan√ßamentos subsequentes.  Portanto, a √∫ltima coisa que resta √© salvar o login e a senha do PVS-Studio no Buddy.  Depois de salvar as altera√ß√µes, voltaremos ao Pipeline.  Precisamos continuar configurando as vari√°veis ‚Äã‚Äãe adicionar o login e a chave do PVS-Studio: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb1/816/e3e/eb1816e3e4aff72ad55b187ec1ebf0a2.gif" alt="Quadro 4"></div><br>  Depois disso, a apar√™ncia de uma nova solicita√ß√£o ou confirma√ß√£o de recebimento acionar√° uma verifica√ß√£o.  Se a confirma√ß√£o contiver erros, o Buddy indicar√° isso na p√°gina de solicita√ß√£o de recebimento. <br><br><h2>  Appveyor </h2><br>  A configura√ß√£o do AppVeyor √© semelhante ao Buddy, pois tudo acontece na interface da web e n√£o √© necess√°rio adicionar um arquivo * .yml ao reposit√≥rio do projeto. <br><br>  V√° para a guia Configura√ß√µes na vis√£o geral do projeto: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f11/2fc/576/f112fc576fc1f8bf7552625578093292.png" alt="Quadro 12"></div><br>  Role esta p√°gina para baixo e ative o salvamento de cache para criar solicita√ß√µes pull: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be8/8f3/f34/be88f3f34708075a49bdd13c65f5bc26.png" alt="Quadro 18"></div><br>  Agora v√° para a guia Ambiente, onde especificamos a imagem para a montagem e as vari√°veis ‚Äã‚Äãde ambiente necess√°rias: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/453/26a/80c/45326a80c62211c6b29bd16fad1ef0d1.png" alt="Quadro 19"></div><br>  Se voc√™ ler as se√ß√µes anteriores, estar√° familiarizado com essas duas vari√°veis ‚Äã‚Äã- <i>PVS_KEY</i> e <i>PVS_USERNAME</i> .  Caso contr√°rio, lembro que eles s√£o necess√°rios para verificar a licen√ßa do analisador PVS-Studio.  No futuro, n√≥s os encontraremos novamente nos scripts do Bash. <br><br>  Na mesma p√°gina abaixo, indicamos a pasta para armazenamento em cache: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e2/967/dbf/4e2967dbfb796e2d0104d5b6539be65a.png" alt="Quadro 15"></div><br>  Caso contr√°rio, analisaremos o projeto inteiro em vez de um par de arquivos, mas obteremos a sa√≠da dos arquivos especificados.  Portanto, √© importante inserir o nome do diret√≥rio correto. <br><br>  Agora √© hora do script verificar.  Abra a guia Testes e selecione Script: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5f/dbd/0d6/b5fdbd0d6d448174bc05222fe1965c1c.png" alt="Quadro 20"></div><br>  Insira o seguinte c√≥digo neste formul√°rio: <br><br><pre> <code class="bash hljs">sudo apt-get update &amp;&amp; sudo apt-get -y install jq wget -q -O - https://files.viva64.com/etc/pubkey.txt \ | sudo apt-key add - sudo wget -O /etc/apt/sources.list.d/viva64.list \ https://files.viva64.com/etc/viva64.list sudo apt-get update &amp;&amp; sudo apt-get -y install pvs-studio pvs-studio-analyzer credentials <span class="hljs-variable"><span class="hljs-variable">$PVS_USERNAME</span></span> <span class="hljs-variable"><span class="hljs-variable">$PVS_KEY</span></span> PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> plog-converter -t errorfile PVS-Studio.log --cerr -w</code> </pre> <br>  Preste aten√ß√£o √† seguinte parte do c√≥digo: <br><br><pre> <code class="bash hljs">PWD=$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> -L) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">''</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>` git diff --name-only HEAD origin/<span class="hljs-variable"><span class="hljs-variable">$MERGE_BASE</span></span> &gt; .pvs-pr.list pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck \ --dump-files --dump-log pvs-dump.log \ -S .pvs-pr.list <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pvs-studio-analyzer analyze -j8 \ -o PVS-Studio.log \ --disableLicenseExpirationCheck <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  A atribui√ß√£o bastante espec√≠fica do valor do comando pwd √† vari√°vel que deve armazenar esse valor padr√£o parece estranha √† primeira vista, no entanto, explicarei tudo agora. <br><br>  Ao configurar o analisador no AppVeyor, encontrei um comportamento extremamente estranho do analisador.  Por um lado, tudo funcionou corretamente, mas a an√°lise n√£o foi iniciada.  Passei muito tempo percebendo que estamos no diret√≥rio / home / appveyor / projects / testcalc /, e o analisador tem certeza de que est√° em / opt / appveyor / build-agent /.  Ent√£o percebi que a vari√°vel $ PWD est√° mentindo um pouco.  Por esse motivo, atualizei seu valor manualmente antes de iniciar a an√°lise. <br><br>  E ent√£o tudo, como antes: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/4b9/a33/0aa4b9a3398ce2f52cc8e1df0833f459.png" alt="Quadro 17"></div><br>  Agora considere o seguinte trecho: <br><br><pre> <code class="bash hljs">PULL_REQUEST_ID=<span class="hljs-string"><span class="hljs-string">"pulls/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$APPVEYOR_PULL_REQUEST_NUMBER</span></span></span><span class="hljs-string">"</span></span> MERGE_BASE=`wget -qO - \ https://api.github.com/repos/<span class="hljs-variable"><span class="hljs-variable">${APPVEYOR_REPO_NAME}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PULL_REQUEST_ID}</span></span> \ | jq -r <span class="hljs-string"><span class="hljs-string">".base.ref"</span></span>`</code> </pre> <br>  Nele, obtemos a diferen√ßa entre os ramos sobre os quais a solicita√ß√£o de recebimento √© declarada.  Para fazer isso, precisamos das seguintes vari√°veis ‚Äã‚Äãde ambiente: <br><br><ul><li>  $ APPVEYOR_PULL_REQUEST_NUMBER - n√∫mero de solicita√ß√£o de recebimento; </li><li>  $ APPVEYOR_REPO_NAME - nome de usu√°rio e reposit√≥rio do projeto. </li></ul><br><h2>  Conclus√£o </h2><br>  Obviamente, n√£o consideramos todos os servi√ßos poss√≠veis de integra√ß√£o cont√≠nua, no entanto, todos eles t√™m caracter√≠sticas muito semelhantes entre si.  Com exce√ß√£o do armazenamento em cache, cada servi√ßo faz sua pr√≥pria ‚Äúbicicleta‚Äù, ent√£o tudo √© sempre diferente. <br><br>  Em algum lugar, como no Travis-CI, algumas linhas de c√≥digo e cache funcionam perfeitamente;  em algum lugar, como no AppVeyor, voc√™ s√≥ precisa especificar a pasta nas configura√ß√µes;  mas em algum lugar voc√™ precisa criar chaves exclusivas e tentar convencer o sistema a dar a oportunidade de substituir o fragmento em cache.  Portanto, se voc√™ deseja configurar a an√°lise de solicita√ß√µes pull no servi√ßo de integra√ß√£o cont√≠nua, que n√£o foi discutido acima, primeiro verifique se voc√™ n√£o ter√° problemas com o cache. <br><br>  Obrigado pela aten√ß√£o.  Se algo n√£o der certo, sinta-se √† vontade para nos escrever em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suporte</a> .  Vamos pedir e ajudar. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Maxim Zvyagintsev.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470984/">https://habr.com/ru/post/pt470984/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470974/index.html">DNS passivo nas m√£os do analista</a></li>
<li><a href="../pt470976/index.html">Song of Ice (Empresa Sangrenta) e Chamas (DevOps e IaC)</a></li>
<li><a href="../pt470978/index.html">Pesquisa de mercado de analistas: onde eles estudam, quais ferramentas eles usam e quanto ganham</a></li>
<li><a href="../pt470980/index.html">As tarefas que os rob√¥s de software (RPAs) resolvem no setor banc√°rio</a></li>
<li><a href="../pt470982/index.html">An√°lise de confirma√ß√µes e solicita√ß√µes pull no Travis CI, Buddy e AppVeyor usando PVS-Studio</a></li>
<li><a href="../pt470988/index.html">As inscri√ß√µes est√£o abertas para o Slerm DevOps em Moscou</a></li>
<li><a href="../pt470990/index.html">Kit de ferramentas de marketing on-line: 3 aplicativos para aumentar a comunica√ß√£o visual</a></li>
<li><a href="../pt470994/index.html">Heran√ßa JavaScript do ponto de vista de um nerd entediado: f√°brica de construtores</a></li>
<li><a href="../pt470996/index.html">Como uma simples tag <img> se torna um alto risco para uma empresa?</a></li>
<li><a href="../pt470998/index.html">Brinquedos de madeira, parte dez - 1996</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>