<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍💻 🖐🏻 📽️ Comment regarder dans les yeux de Cassandra et ne pas perdre de données, de stabilité et de confiance en NoSQL 💀 💃 🏓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ils disent que dans la vie, tout vaut la peine d'être essayé au moins une fois. Et si vous avez l'habitude de travailler avec des SGBD relationnels, v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment regarder dans les yeux de Cassandra et ne pas perdre de données, de stabilité et de confiance en NoSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465333/"><img src="https://habrastorage.org/webt/qy/gg/eo/qyggeoq9bbwsmcnfpzlo2kpmnvk.png" alt="image"><br><br><p> Ils disent que dans la vie, tout vaut la peine d'être essayé au moins une fois.  Et si vous avez l'habitude de travailler avec des SGBD relationnels, vous familiariser avec NoSQL en vaut la peine, tout d'abord, au moins pour le développement général.  Maintenant, en raison du développement rapide de cette technologie, il y a beaucoup d'opinions contradictoires et de débats houleux sur ce sujet, ce qui alimente particulièrement l'intérêt. <br>  Si vous explorez l'essence de tous ces différends, vous pouvez voir qu'ils surviennent en raison d'une mauvaise approche.  Ceux qui utilisent les bases de données NoSQL exactement là où ils sont nécessaires sont satisfaits et tirent tous ses avantages de cette solution.  Et les expérimentateurs qui s'appuient sur cette technologie comme panacée où elle n'est pas du tout applicable, sont déçus de perdre les atouts des bases de données relationnelles sans en retirer des bénéfices significatifs. </p><br><p>  Je vais vous parler de notre expérience dans la mise en œuvre d'une solution basée sur le SGBD Cassandra: ce à quoi nous avons dû faire face, comment nous sommes sortis de situations difficiles, avons-nous réussi à tirer parti de l'utilisation de NoSQL et où avons-nous dû investir des efforts / de l'argent supplémentaires. <br>  La tâche initiale consiste à créer un système qui enregistre les appels vers un certain stockage. </p><br><p>  Le principe du système est le suivant.  Des fichiers avec une certaine structure décrivant la structure de l'appel arrivent à l'entrée.  Ensuite, l'application s'assure que cette structure est enregistrée dans les colonnes appropriées.  À l'avenir, les appels enregistrés sont utilisés pour afficher des informations sur la consommation de trafic des abonnés (frais, appels, historique des soldes). </p><br><img src="https://habrastorage.org/webt/ey/bv/zw/eybvzwrnggpddqjt7hpsta37ykc.png" alt="image"><br><p>  Pourquoi Kassandra a été choisie est tout à fait compréhensible - elle écrit comme une mitrailleuse, facilement évolutive et tolérante aux pannes. </p><br><a name="habracut"></a><br><h2>  Alors, voici ce que l'expérience nous a donné </h2><br><p>  Oui, le nœud écrasé n'est pas une tragédie.  C'est l'essence même de la tolérance aux fautes de Cassandra.  Mais le <b>nœud peut être actif et en même temps commencer à s'affaisser sur les performances</b> .  Il s'est avéré que cela affecte immédiatement les performances de l'ensemble du cluster. </p><br><p>  <b>Cassandra ne couvre pas où Oracle a enregistré avec ses constantes</b> .  Et si l'auteur de la demande n'a pas compris cela à l'avance, la prise de vol de Cassandra n'est pas pire que l'original.  Une fois qu'il est venu, nous l'insérerons. </p><br><p>  La Kassandra gratuite «prête à l'emploi» n'aimait pas beaucoup la sécurité de l'information: <b>il n'y a pas de journalisation des actions des utilisateurs, ni de différenciation des droits</b> .  Les informations sur les appels concernent des données personnelles, ce qui signifie que toutes les tentatives de demande / modification de quelque manière que ce soit devraient être enregistrées avec la possibilité d'un audit ultérieur.  En outre, vous devez être conscient de la nécessité de séparer les droits à différents niveaux pour différents utilisateurs.  Un simple ingénieur d'exploitation et un super administrateur qui peuvent supprimer librement l'intégralité de l'espace de touches sont différents rôles, différentes responsabilités, compétences.  Sans une telle différenciation des droits d'accès, la valeur et l'intégrité des données seront immédiatement remises en question plus rapidement qu'avec n'importe quel niveau de cohérence. </p><br><p>  Nous n'avons pas tenu compte du fait que les appels nécessitent des analyses sérieuses, ainsi que des échantillons périodiques pour diverses conditions.  Étant donné que les enregistrements sélectionnés sont ensuite censés être supprimés et réécrits (dans le cadre de la tâche, nous devons prendre en charge le processus de mise à jour des données lorsque la boucle de données est initialement entrée incorrectement), Kassandra n'est pas notre ami ici.  <b>Cassandra, comme une tirelire, est pratique à y mettre, mais vous ne pourrez pas y compter.</b> </p><br><p>  <b>Face au problème du transfert des données vers les zones de test</b> (5 nœuds dans le test contre 20 dans le bal).  Dans ce cas, un vidage ne peut pas être utilisé. </p><br><p>  Le problème de la mise à jour du schéma de données d'une application écrivant à Kassandra.  <b>Le retour en arrière donnera lieu à un grand nombre de pierres tombales, ce qui, de manière imprévisible, peut réduire notre productivité</b> .  Cassandra est optimisée pour l'enregistrement, et avant l'enregistrement, ne pense pas beaucoup.  Toute opération contenant des données existantes est également un enregistrement.  Autrement dit, après avoir supprimé l'excédent, nous générons simplement encore plus d'enregistrements, et seule une partie d'entre eux sera marquée de pierres tombales. </p><br><p>  Délais d'attente sur insert.  Cassandra est belle dans l'enregistrement, mais <b>parfois le flux entrant peut être très déroutant pour elle</b> .  Cela se produit lorsque l'application commence à encercler plusieurs enregistrements qui ne peuvent pas être insérés pour une raison quelconque.  Et nous aurons besoin d'un véritable DBA, qui suivra gc.log, les journaux système et de débogage pour les requêtes lentes, les mesures de compactage en attente. <br></p><br><p>  Plusieurs centres de données dans un cluster.  <b>Où lire et où écrire?</b> <br>  Peut-être divisé en lecture et en écriture?  Et si oui, devrait-il y avoir un DC pour écrire ou lire plus près de l'application?  Et n'obtiendrons-nous pas un vrai cerveau divisé si nous choisissons le niveau de cohérence incorrectement?  Beaucoup de questions, beaucoup de paramètres inexplorés, des fonctionnalités que je veux vraiment tordre. <br></p><br><h2>  Comment avons-nous décidé </h2><br><p>  <b>Que le nœud n'a pas gaspillé, désactivé SWAP</b> .  Et maintenant, avec un manque de mémoire, le nœud doit s'allonger et ne pas produire de grandes pauses gc. </p><br><p>  Donc, nous n'espérons plus de logique dans la base de données.  <b>Les développeurs d'applications réapprennent et commencent à sécuriser activement leur propre code.</b>  Séparation parfaite et parfaite du stockage et du traitement des données. </p><br><p>  <b>Nous avons acheté le support de DataStax.</b>  Le Kassandra en boîte a déjà cessé de se développer (le dernier commit en février 2018).  Dans le même temps, Datastax offre un excellent service et un grand nombre de solutions CI modifiées et adaptées aux solutions existantes. </p><br><p>  Je tiens également à noter que Kassandra n'est pas très pratique pour interroger des échantillons.  Bien sûr, CQL est un grand pas vers les utilisateurs (par rapport à Trift).  Mais si vous avez des départements entiers, habitués à de telles jointures pratiques, un filtrage gratuit par n'importe quel champ et des options d'optimisation des requêtes, et que ces départements travaillent pour fermer les réclamations et les accidents, alors la décision sur Kassandra lui semble ennemie et stupide.  Et nous avons commencé à aborder la question de savoir comment nos collègues peuvent faire des échantillons. </p><br><p>  Nous avons considéré deux options: dans la première, nous écrivons les appels non seulement en C *, mais aussi dans la base de données d'archives Oracle.  Seul, contrairement à C *, les appels sont stockés dans cette base de données uniquement pour le mois en cours (profondeur de stockage des appels suffisante pour les cas de recertification).  Ici, nous avons immédiatement vu le problème suivant: si vous écrivez de manière synchrone, nous perdons tous les avantages de C * associés à l'insertion rapide, si de manière asynchrone, il n'y a aucune garantie que tous les appels nécessaires atteignent généralement Oracle.  Il y avait un plus, mais grand: pour l'exploitation, le même développeur PL / SQL familier reste, c'est-à-dire que nous implémentons pratiquement le modèle «Facade». Une option alternative.  Nous implémentons un mécanisme qui décharge les appels de C *, extrait des données à enrichir des tables correspondantes dans Oracle, joint les échantillons reçus et nous donne le résultat, que nous utilisons ensuite d'une manière ou d'une autre (annule, répète, analyse, admire).  Inconvénients: le processus est assez multi-étapes, et en plus, il n'y a pas d'interface pour le personnel d'exploitation. </p><br><p>  En conséquence, nous avons toujours opté pour la deuxième option.  <b>Apache Spark a été utilisé pour des échantillons provenant de différentes boîtes.</b>  L'essence du mécanisme se résumait au code Java qui, en utilisant les clés spécifiées (abonné, clés de temps d'appel), extrait les données de C *, ainsi que les données nécessaires pour l'enrichissement de toute autre base de données.  Il les rejoint ensuite dans sa mémoire et affiche le résultat dans le tableau résultant.  Un museau en toile a été tiré sur l'étincelle et il s'est avéré être tout à fait utilisable. </p><br><img src="https://habrastorage.org/webt/cg/v9/zb/cgv9zbcbxsarbkhpirmvo2_vrqy.png" alt="image"><br><p>  Lors de la résolution d'un problème de mise à jour des données, un test promotionnel a de nouveau examiné plusieurs solutions.  À la fois le transfert via Sstloader et la possibilité de diviser le cluster dans la zone de test en deux parties, chacune entrant alternativement dans le même cluster que le promo, étant ainsi alimentée par celui-ci.  Lors de la mise à jour du test, il était prévu de changer de place: la partie qui a fonctionné dans le test est effacée et entrée dans le bal de promo, et l'autre commence à travailler séparément avec les données.  Cependant, en y repensant, nous avons évalué de manière plus rationnelle les données qui devraient être transférées, et nous avons réalisé que les appels eux-mêmes sont une entité incohérente pour les tests, générée rapidement si nécessaire, et c'est l'ensemble de données promo qui ne vaut pas la peine d'être transféré au test.  Il y a plusieurs objets de stockage qui valent la peine d'être déplacés, mais ce sont littéralement quelques tables, et pas très lourdes.  Par conséquent <b>, Spark est à nouveau venu à notre aide en tant que solution, avec l'aide de laquelle nous avons écrit et a commencé à utiliser activement le transfert de données entre les tables des scripts de test de prom.</b> </p><br><p>  <b>Notre politique de déploiement actuelle nous permet de travailler sans ristournes.</b>  Avant le bal, il y a un passage obligatoire au test, où l'erreur n'est pas si chère.  En cas d'échec, vous pouvez toujours supprimer l'espace de cas et lancer l'ensemble du schéma depuis le début. </p><br><p>  Pour assurer la disponibilité continue de Cassandra, vous avez besoin de dba et pas seulement.  <b>Tous ceux qui travaillent avec l'application doivent comprendre où et comment regarder la situation actuelle et comment diagnostiquer les problèmes en temps opportun.</b>  Pour ce faire, nous utilisons activement DataStax OpsCenter (Administration and Monitoring of Workloads), les métriques du système Cassandra Driver (nombre de timeouts pour l'écriture vers C *, nombre de timeouts pour la lecture depuis C *, latence maximale, etc.), la surveillance le travail de l'application elle-même, en collaboration avec Kassandra. <br></p><br><p>  Lorsque nous avons réfléchi à la question précédente, nous avons réalisé où pouvait se situer notre principal risque.  Ce sont des formulaires d'affichage de données qui produisent des données de plusieurs demandes de stockage indépendantes les unes des autres.  De cette façon, nous pouvons obtenir des informations assez incohérentes.  Mais ce problème serait tout aussi pertinent si nous travaillions avec un seul centre de données.  Donc, la chose la plus raisonnable ici est, bien sûr, de faire la fonction batch de lecture des données sur une application tierce, ce qui garantira que les données sont reçues en une seule période de temps.  Quant à la séparation de la lecture et de l'écriture en termes de performances, nous avons ici été stoppés par le risque qu'avec une certaine perte de connexion entre les DC, nous puissions obtenir deux clusters totalement incohérents. </p><br><p>  Par conséquent, pour le moment, nous nous sommes <b>arrêtés au niveau de cohérence pour l'enregistrement EACH_QUORUM, pour la lecture - LOCAL_QUORUM</b> </p><br><h2>  Brèves impressions et conclusions </h2><br><p>  Afin d'évaluer la solution qui en résulte du point de vue du soutien opérationnel et des perspectives de développement, nous avons décidé de réfléchir à d'autres possibilités d'application d'un tel développement. </p><br><p>  Si vous êtes en déplacement, scorez des données pour des programmes comme «Payez quand cela vous convient» (nous chargeons des informations dans C *, calcul à l'aide de scripts Spark), prenant en compte les revendications avec agrégation par directions, stockant les rôles et calculant les droits d'accès des utilisateurs à l'aide de la matrice des rôles. </p><br><p>  Comme vous pouvez le voir, le répertoire est large et varié.  Et si nous choisissons le camp des partisans / opposants de NoSQL, nous rejoindrons les partisans, puisque nous avons obtenu nos avantages, et exactement où nous nous attendions. </p><br><p>  Même l'option Cassandra prête à l'emploi permet une mise à l'échelle horizontale en temps réel, résolvant sans aucun problème le problème de l'augmentation des données dans le système.  Nous avons réussi à mettre dans un circuit séparé un mécanisme très chargé pour calculer les agrégats des appels, et aussi à séparer le schéma et la logique de l'application, en nous débarrassant de la vicieuse pratique d'écrire des travaux et des objets personnalisés dans la base de données elle-même.  Nous avons eu la possibilité de choisir et de configurer, afin d'accélérer, sur quels contrôleurs de domaine nous allons calculer et sur quels enregistrements de données, nous nous sommes assurés pour les baisses des nœuds individuels et de l'ensemble du contrôleur de domaine. </p><br><p>  En appliquant notre architecture à de nouveaux projets, et ayant déjà une certaine expérience, je voudrais prendre immédiatement en compte les nuances décrites ci-dessus, ne pas commettre d'erreurs, aplanir certains angles vifs, ce qui ne pouvait pas être évité au départ. </p><br><p>  Par exemple, <b>gardez une trace des mises à jour de Cassandra à temps</b> , car bon nombre de problèmes que nous avons reçus étaient déjà connus et corrigés. </p><br><p>  <b>Ne placez pas la base de données elle-même et Spark sur les mêmes nœuds</b> (ou divisez-les strictement par la quantité d'utilisation des ressources acceptable), car Spark peut consommer plus d'OP que prévu, et nous obtiendrons rapidement le problème numéro 1 de notre liste. </p><br><p>  <b>Pomper les compétences de surveillance et d'exploitation au stade des tests du projet.</b>  <b>Dans un premier temps, prenez en compte le maximum de tous les consommateurs potentiels de notre solution</b> , car la structure de la base de données en dépendra finalement. </p><br><p>  Tournez le circuit résultant plusieurs fois pour une optimisation possible.  Sélectionnez les champs qui peuvent être sérialisés.  Comprendre quelles tables supplémentaires nous pouvons faire afin de prendre en compte le plus correctement et de manière optimale, puis renvoyer les informations requises sur demande (par exemple, en supposant que nous pouvons stocker les mêmes données dans différentes tables, en tenant compte de différentes ventilations selon différents critères, peut économiser considérablement) temps processeur pour les requêtes de lecture). </p><br><p>  C'est une bonne idée de <b>monter immédiatement TTL et de nettoyer les données obsolètes.</b> </p><br><p>  Lors du déchargement des données de Cassandra, la <b>logique d'application doit fonctionner selon le principe FETCH, afin que toutes les lignes ne soient pas chargées en mémoire à la fois, mais sélectionnées par lots.</b> </p><br><p>  Avant de transférer le projet vers la solution décrite, il est conseillé de <b>vérifier la tolérance aux pannes du système en effectuant une série de tests de collision</b> , tels que la perte de données dans un centre de données, la restauration des données endommagées pendant une certaine période et la fermeture du réseau entre les centres de données.  De tels tests vous permettront non seulement d'évaluer les avantages et les inconvénients de l'architecture proposée, mais également de donner de bonnes pratiques d'échauffement aux ingénieurs qui les conduisent, et la compétence acquise sera loin d'être superflue si les défaillances du système sont reproduites dans le bal. </p><br><p>  Si nous travaillons avec des informations critiques (telles que les données de facturation, le calcul de la dette des abonnés), il convient également de prêter attention aux outils qui réduiront les risques qui découlent des caractéristiques du SGBD.  Par exemple, utilisez l'utilitaire nœudsync (Datastax), ayant développé une stratégie optimale pour son utilisation, afin que <b>par souci de cohérence de ne pas former une charge excessive sur Cassandra</b> et de ne l'utiliser que pour certaines tables dans une certaine période. </p><br><p>  Eh bien, après six mois de vie, avec Cassandra?  En général, il n'y a pas de problèmes non résolus.  Accidents graves et perte de données, nous n'avons pas non plus permis.  Oui, j'ai dû penser à compenser certains problèmes qui n'étaient pas apparus auparavant, mais au final cela n'a pas éclipsé notre solution architecturale.  Si vous voulez et n'avez pas peur d'essayer quelque chose de nouveau, et en même temps ne voulez pas être très déçu, alors préparez-vous au fait que rien ne se passe gratuitement.  Vous devrez comprendre, creuser dans la documentation et collecter votre râteau individuel que dans l'ancienne solution héritée et aucune théorie ne vous dira à l'avance exactement quel râteau vous attend. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465333/">https://habr.com/ru/post/fr465333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465319/index.html">Malentendus du passé</a></li>
<li><a href="../fr465321/index.html">À l'avenir, les scientifiques pourront apprendre à prédire exactement ce dont vous vous souviendrez.</a></li>
<li><a href="../fr465323/index.html">Quelle sera la cryptographie post-quantique?</a></li>
<li><a href="../fr465325/index.html">Objets spéciaux difficiles à saisir pour les robots</a></li>
<li><a href="../fr465329/index.html">Modèle d'apprentissage automatique interprété. 2e partie</a></li>
<li><a href="../fr465341/index.html">Comment créer un cloud privé pour la vidéosurveillance</a></li>
<li><a href="../fr465343/index.html">Comment nous avons créé le moteur et le jeu pendant un an et demi. Deuxième partie L'infrastructure</a></li>
<li><a href="../fr465345/index.html">Événement d'embauche FunCorp Mobile</a></li>
<li><a href="../fr465349/index.html">Avez-vous besoin d'Agile: 5 modèles à tester</a></li>
<li><a href="../fr465351/index.html">Problèmes courants pour ceux qui ont remporté le Gostender</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>