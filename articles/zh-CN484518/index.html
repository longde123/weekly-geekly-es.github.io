<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏬 🤛🏻 👐🏿 我们使用PHP通过DVRIP从摄像机获取视频 💆🏼 🏚️ 👏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在上一篇文章中，我曾承诺要展示一个从摄像机提取视频的脚本，尽管自那时以来已经经过了一定的时间，但仍需要兑现承诺。 所以我正在做。 

 碰巧的是，在服务器Web世界中，异步与所有事物相关联，而PHP与之无关。 

 好吧，因为，您知道，这种垂死的模型，内存泄漏以及PHP中除了stream_selec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们使用PHP通过DVRIP从摄像机获取视频</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/">在<a href="https://habr.com/ru/post/482864/">上一篇文章中，</a>我曾承诺要展示一个从摄像机提取视频的脚本，尽管自那时以来已经经过了一定的时间，但仍需要兑现承诺。 所以我正在做。 <br><br> 碰巧的是，在服务器Web世界中，异步与所有事物相关联，而PHP与之无关。 <br><br> 好吧，因为，您知道，这种垂死的模型，内存泄漏以及PHP中除了<a href="https://www.php.net/manual/ru/function.stream-select.php">stream_select（）</a>和<a href="https://www.php.net/manual/ru/function.stream-select.php">stream_set_blocking（）</a>之外确实没有其他<a href="https://www.php.net/manual/ru/function.stream-select.php">可用的东西</a> 。 <br><br> 在PECL上的某个地方，存在某种<a href="https://pecl.php.net/package/uv">libuv</a> ，它原则上只是原始库原始功能的包装，因此按原样使用它会给您带来一些挑战。 无论如何，谁会在他们的正确思维中做到这一点？ <br><br> 但是，如果我们不再生活在PHP4的世界中，而又回到现代现实中，那么我们会发现近年来情况有所改变。 我们有<b>ReactPHP</b>和<b>AmPHP</b>这样有趣的工具， <b>它们</b>的组件很好地覆盖了Node.js的功能，并且生成器的存在使我们能够以便利的方式编写异步代码，例如<i>async / await</i> ，避免了回调和公里链中所有这些无尽的回调。 <i>）。然后（）</i> 。 <i>然后（）</i> 。 <br><br> 因此，在我看来，这就是为什么在Node.js领域中几乎没有PHP无法解决的任务。 但是，如果仍然存在，那么一切都仅取决于是否存在一些单独的库，而不是缺少这样的机会。 <br><blockquote> 得知PHP标准库已经具备编写事件驱动和非阻塞应用程序所需的一切，可能会让人们感到惊讶。 当我们要求它同时轮询数以千计的文件描述符以进行IO活动时，我们才达到此区域中本机PHP功能的极限。 即使在这种情况下，故障也不在于PHP，而是底层系统的select（）调用，其性能随着负载的增加而线性下降。 <br><br>  <i><a href="https://amphp.org/amp/event-loop/">amphp.org/amp/event-loop</a></i> </blockquote><a name="habracut"></a><br> 当然，在生产环境中使用所有这些的问题尚未完全解决，但是如果您没有做错任何明显的错误事情（任何其他异步运行时环境都不会原谅您），那么一切都会很好。 <br><br><h3> 录像机 </h3><br> 我们将考虑该协议，该协议据说是中国人发明的，用于与监控摄像头进行软件通信。 <br><br> 所有这些都可以在称为DVRIP（有时是索非亚）的TCP上运行，到我需要它时，我发现仅两个或多个理智的库，其中一个通常描述为仅连接到相机并交换了一些消息，但是具有包标题说明对我有很大帮助。 <br><br> 第二个发现是在不久之后发现的，当时我的综合症没有在这里发明，这与我想要的有点不同。 <br><br> 通常，带着嗅探器和程序包头的描述，我简要地绘制了一个脚本，该脚本正在服务器上某个位置旋转，并将在本文中以某种概念验证的形式呈现。 <br><br> 协议本身并不复杂，程序包如下所示： <br><br><ul><li> 标头为20个字节，在PHP中可以指定为 <br><br><pre><code class="php hljs">unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, $buffer)</code> </pre> </li><li> 标头后跟一个长len消息，可以包含json（由两个字节\ x0a \ x00补充）或二进制数据。 </li></ul><br> 我们将只发送json，但同时接收两者。 <br><br> 答案（如果它是带有json的软件包）通常包含一个<b>Ret</b>字段，指示我们的请求成功。 包含不等于<b>100</b>或<b>515</b>的<b>Ret</b>码的响应将被视为故意错误。 <br><br> 有了这些基本知识，让我们连接到相机并进行了解。 <br> 我们需要两个库<a href="https://github.com/amphp/socket">-amphp / socket</a> ，几乎可以<a href="https://github.com/amphp/socket">提取</a>我们需要的所有东西，而<a href="https://packagist.org/packages/evenement/evenement">evenement / evenement</a>则可以在packagist中使用，不需要任何扩展。 <br><br> 在Amp中使用TCP看起来像这样： <br><br><pre> <code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">"tcp://{$addr}:{$port}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($chunk = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $chunk; } $socket-&gt;close(); });</code> </pre> <br>  DVRIP通常在端口34567上运行，因此在我们的情况下，它将是这样的： <br><br><pre> <code class="php hljs">$socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://192.168.0.200:34567'</span></span>);</code> </pre> <br> 接下来，我们通过将用户名和密码哈希发送到摄像机来登录，该哈希计算如下： <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); }</code> </pre> <br> 如果授权成功，我们会请求一个视频，如果摄像机可以将其提供给我们，那么我们将开始传输它。 <br><br> 每种类型的程序包都有其自己的msgId，因此我们可以了解收到答案的请求。 通常，这不是一个尘土飞扬的工作。 <br><br> 为了方便起见，让我们首先描述我们的包的类： <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } }</code> </pre> <br> 并尝试发送授权请求 <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ]));</code> </pre> <br> 是的，太好了 我们已建立联系并发送了一条消息，但我们甚至不知道相机是否正确，并且至少对此有所反应。 我们需要以某种方式读取答案（让我们异步执行），选择其中的特定数据包并对其进行解码。 <br><br> 为了以某种方式分离处理作为响应的数据包的逻辑，我决定使用<b>偶数</b>库并草绘一个基于该库的类，该类将丢弃已解码的数据包 <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br> 并且还向Packet类添加了一些静态方法，实际上，这些方法将从数据流中提取和解码数据包 <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; }</code> </pre><br> 现在，通过使用<b>Evenement</b> ，我们可以以以下形式描述我们的逻辑 <br><br><pre> <code class="php hljs">$reader-&gt;on($packetType, $handler);</code> </pre> <br> 所以我得到了这个链，在其中添加了另一个Keep Alive和SIGINT / SIGTERM处理： <br><br><pre> <code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout());</code> </pre> <br> 不用说，我们可以将视频流重定向到所需的位置，而不是stdout。 <br><br><div class="spoiler">  <b class="spoiler_title">最终脚本</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Emitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Promise</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">InputStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">IteratorStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Evenement</span></span>\<span class="hljs-title"><span class="hljs-title">EventEmitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">call</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCoroutine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStderr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStdout</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">pipe</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Socket</span></span>\<span class="hljs-title"><span class="hljs-title">connect</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } } Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout()); });</code> </pre> </div></div><br> 现在我们可以尝试以这种方式录制一段视频 <br><br><pre> <code class="bash hljs">$ php recorder.php &gt; output.h264</code> </pre> <br> 我们添加了一个SIGINT处理程序，因此当您感到疲倦时，只需按Ctrl + C，脚本将停止视频传输并正常关闭连接。 <br><br> 例如，我们可以将流重定向到ffmpeg并即时进行代码转换。 <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code> </pre> <br> 您可以将形式的疯狂链 <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ...</code> </pre> <br> 使用某种脚本（每个小时都会重新启动）来启动所有这些程序，因此无论何时何地，我们都可以随时随地获得持续1小时的流畅片段。 <br><br><h3> 怎么了 </h3><br> 我倾向于相信本文会引起“为什么？”的问题。 有现成的摄像机注册解决方案，通常，摄像机可以自己做很多事情，因为它们在上一篇文章的评论中正确地反对了，并且总体上可以简化很多。 <br><br> 只是我有空闲时间要在某个地方做，渴望以自己的方式进行，并且对实验充满热情。 <br><br> 而且有效。 <br><br> 当然，本文中介绍的脚本需要进行一些修改，并且您不应以这种形式使用它-我再说一遍，这是概念上的证明。 总的来说，我强烈警告您使用膝盖高的自制产品，以确保您的房屋安全。 <br> 就我而言，可靠性并不是那么关键，因此该选项将起作用。 脚本观察者正在对该脚本进行旋转，该脚本将流传输到ffmpeg，按小时记录片段并将其上载到VK，在断开连接或任何意外情况下重新启动脚本。 <br><br> 总的来说，所有这些都可以通过在RTSP over TCP上简单地拉出视频来避免，正如我在上一篇文章的结尾建议的那样，但是ffmpeg喜欢愚蠢地在一个随机的时间停顿，只开始响应SIGKILL。 <br><br> 我开始怀疑所有这一切是因为父级脚本监视表是由表冠运行的，并且其优先级较低，但是提高优先级只会降低问题发生的频率。 <br><br> 在上述脚本的情况下，一切工作都更加稳定，尚未引起任何投诉。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484518/">https://habr.com/ru/post/zh-CN484518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484502/index.html">Facebook迫使主持人将其工作时间记录在第二秒-甚至上厕所</a></li>
<li><a href="../zh-CN484504/index.html">制作不到10美元的空气离子发生器</a></li>
<li><a href="../zh-CN484506/index.html">我是一名摄影师，我将使自己成为一个工作工具</a></li>
<li><a href="../zh-CN484512/index.html">前25大ICO：现在有什么问题吗？</a></li>
<li><a href="../zh-CN484514/index.html">适用于React应用程序的通用路由</a></li>
<li><a href="../zh-CN484520/index.html">zip归档文件是什么样子，我们可以做什么。 第三部分-实际应用</a></li>
<li><a href="../zh-CN484522/index.html">DEFCON会议27.砍警察。 第二部分</a></li>
<li><a href="../zh-CN484526/index.html">准备要在Android上运行的SDL2项目</a></li>
<li><a href="../zh-CN484528/index.html">我如何将业余爱好项目转移到k8s</a></li>
<li><a href="../zh-CN484530/index.html">用于等离子处理/聚合物材料改性的数控机床</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>