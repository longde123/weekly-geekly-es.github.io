<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèª üèùÔ∏è üî• Unter der Haube Screeps - Virtualisierung in der MMO-Sandbox f√ºr Programmierer üï° üåó üßïüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werde ich √ºber eine wenig bekannte Technologie sprechen, die in unserem Online-Spiel f√ºr Programmierer eine Schl√ºsselanwendung gefun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unter der Haube Screeps - Virtualisierung in der MMO-Sandbox f√ºr Programmierer</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437836/"><p> In diesem Artikel werde ich √ºber eine wenig bekannte Technologie sprechen, die in unserem Online-Spiel f√ºr Programmierer eine Schl√ºsselanwendung gefunden hat.  Um nicht lange am Gummi zu ziehen, gibt es sofort einen Spoiler: Es scheint, dass niemand im nativen Node.js-Code, zu dem wir nach mehreren Jahren der Entwicklung gekommen sind, einen solchen Schamanismus betrieben hat.  Die isolierte Virtual Machine Engine (Open Source), die unter der Haube des Projekts ausgef√ºhrt wird, wurde speziell f√ºr ihre Anforderungen geschrieben und wird derzeit von uns und einem anderen Startup in der Produktion verwendet.  Und die Isolationsf√§higkeiten, die er gibt, sind einzigartig und verdienen es, dar√ºber informiert zu werden. </p><br><p>  Aber reden wir √ºber alles in Ordnung. </p><br><h2>  Hintergrund </h2><br><p>  Programmierst du gerne  Nicht die routinem√§√üige Unternehmenscodierung, zu der viele von uns gezwungen sind, 40 Stunden pro Woche zu arbeiten, mit Aufschub zu k√§mpfen, Liter Kaffee einzuschenken und professionell auszubrennen;  und <i>Programmieren</i> ist ein unvergleichlicher magischer Prozess, bei dem Gedanken in ein Arbeitsprogramm umgewandelt werden. Dabei wird Freude daran, dass der Code, den Sie gerade geschrieben haben, auf dem Bildschirm angezeigt wird und das Leben beginnt, das der Sch√∂pfer ihm sagt.  In solchen Momenten m√∂chte ich das Wort "Sch√∂pfer" mit einem Gro√übuchstaben schreiben - ein solches Gef√ºhl, das dabei entsteht, ist manchmal der Ehrfurcht nahe. </p><br><p><img src="https://habrastorage.org/webt/mm/2a/5h/mm2a5hmu2k6s26hviyoykwd6tv8.jpeg"></p><br><p>  Es ist nur schade, dass nur sehr wenige echte Projekte, die sich auf das t√§gliche Einkommen beziehen, ihren Entwicklern solche Gef√ºhle vermitteln k√∂nnen.  Um die Leidenschaft f√ºr das Programmieren nicht zu verlieren, m√ºssen Enthusiasten nebenbei eine Aff√§re beginnen: ein Programmierhobby, ein Haustierprojekt, ein modisches Open-Source-Programm, nur ein Python-Skript zur Automatisierung ihres Smart Homes ... oder das Verhalten eines Charakters in einigen beliebten Online-Versionen Spiel. </p><a name="habracut"></a><br><p>  Ja, es sind Online-Spiele, die Programmierern oft eine unersch√∂pfliche Inspirationsquelle bieten.  Schon die ersten Spiele in diesem Genre (Ultima Online, Everquest, ganz zu schweigen von allen Arten von MUDs) zogen viele Handwerker an, die nicht so sehr daran interessiert sind, die Rolle zu spielen und die Fantasie der Welt zu genie√üen, sondern ihre Talente einzusetzen, um alles und jedes zu automatisieren virtueller Spielraum.  Und bis heute bleibt dies eine besondere Disziplin der Online-MMO-Spiele-Olympiade: Verfeinern Sie Ihren Verstand beim Schreiben Ihres Bots, damit er von der Verwaltung unbemerkt bleibt und im Vergleich zu anderen Spielern den maximalen Gewinn erzielt.  Oder andere Bots - wie zum Beispiel in EVE Online, wo der Handel in dicht besiedelten M√§rkten etwas weniger als vollst√§ndig durch Handelsskripte kontrolliert wird, genau wie an echten B√∂rsen. </p><br><p>  Die Idee eines Online-Spiels, das <em>urspr√ºnglich und vollst√§ndig auf Programmierer ausgerichtet war,</em> schwebte in der Luft.  Ein solches Spiel, bei dem das Schreiben eines Bots keine strafbare Handlung ist, sondern die Essenz des Gameplays.  Wobei die Aufgabe nicht darin besteht, von Zeit zu Zeit dieselben Aktionen wie "T√∂te X Monster und finde Y Gegenst√§nde" auszuf√ºhren, sondern ein Skript zu schreiben, das diese Aktionen in deinem Namen korrekt ausf√ºhren kann.  Und da es sich um ein Online-Spiel im MMO-Genre handelt, findet die Rivalit√§t mit den Skripten anderer Spieler in Echtzeit in einer einzigen gemeinsamen Spielwelt statt. </p><br><p>  So erschien 2014 das Spiel Screeps (aus den W√∂rtern "Scripts" und "Creeps") - eine strategische Echtzeit-MMO-Sandbox mit einer einzigen gro√üen, <em>best√§ndigen Welt,</em> in der die Spieler keinen Einfluss darauf haben, was passiert, au√üer indem sie KI-Skripte f√ºr ihre Spieleinheiten schreiben .  Alle Mechanismen eines gew√∂hnlichen strategischen Spiels - Ressourcenextraktion, Aufbau von Einheiten, Aufbau einer Basis, Eroberung von Gebieten, Herstellung und Handel - m√ºssen vom Spieler selbst √ºber die von der Spielwelt bereitgestellte JavaScript-API programmiert werden.  Der Unterschied zu verschiedenen Wettbewerben beim Schreiben von KI besteht darin, dass die Spielwelt, wie sie in der Online-Spielewelt sein sollte, in den letzten 4 Jahren rund um die Uhr in Echtzeit arbeitet und ihr Leben lebt und die KI jedes Spielers in jedem Spielzyklus startet. </p><br><p>  Genug vom Spiel selbst - dies sollte ausreichen, um die Essenz der technischen Probleme, auf die wir w√§hrend der Entwicklung gesto√üen sind, besser zu verstehen.  Sie k√∂nnen mehr Ansichten von diesem Video erhalten, dies ist jedoch optional: </p><br><div class="spoiler">  <b class="spoiler_title">Video-Trailer</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZboTgOajnGg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2>  Technische Probleme </h2><br><p>  Das Wesen der Mechanik der Spielwelt ist wie folgt: Die ganze Welt ist in <strong>R√§ume unterteilt</strong> , die durch Ausg√§nge an vier Kardinalpunkten miteinander verbunden sind.  Ein Raum ist eine atomare Einheit des Prozesses zur Verarbeitung des Zustands der Spielwelt.  Der Raum kann bestimmte Objekte (z. B. Einheiten) haben, die ihren eigenen Status haben, und bei jedem Spielschritt erhalten sie Befehle von den Spielern.  Der Server-Handler nimmt jeweils einen Raum ein, f√ºhrt diese Befehle aus, √§ndert den Status der Objekte und schreibt den neuen Status des Raums in die Datenbank.  Dieses System l√§sst sich horizontal gut skalieren: Sie k√∂nnen dem Cluster weitere Handler hinzuf√ºgen. Da die R√§ume architektonisch voneinander isoliert sind, k√∂nnen so viele R√§ume parallel verarbeitet werden, wie Handler ausgef√ºhrt werden. </p><br><p><img src="https://habrastorage.org/webt/mp/d0/ed/mpd0ed40jp8efrihjrxkfft49fc.png"></p><br><p>  Im Moment haben wir <strong>42.060 R√§ume</strong> im Spiel.  Ein Servercluster von 36 physischen Quad-Core-Maschinen enth√§lt 144 Prozessoren.  Wir verwenden Redis, um Warteschlangen zu erstellen. Das gesamte Backend ist in Node.js geschrieben. </p><br><p>  Dies war eine Phase des Spieltakts.  Aber woher kommen die Spielerteams?  Die Besonderheit des Spiels ist, dass es keine Schnittstelle gibt, √ºber die Sie auf eine Einheit klicken und sie anweisen k√∂nnen, zu einem bestimmten Punkt zu gehen oder eine bestimmte Struktur aufzubauen.  Das Maximum, das in der Benutzeroberfl√§che erreicht werden kann, besteht darin, eine immaterielle Flagge an der richtigen Stelle im Raum zu platzieren.  Damit die Einheit an diesen Ort kommt und die erforderlichen Ma√ünahmen ergreift, muss Ihr Skript f√ºr mehrere Spiel-Ticks Folgendes ausf√ºhren: </p><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> creep = Game.creeps[<span class="hljs-string"><span class="hljs-string">'Creep1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> flag = Game.flags[<span class="hljs-string"><span class="hljs-string">'Flag1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!creep.pos.isEqualTo(flag.pos)) { creep.moveTo(flag.pos); } }</code> </pre> <br><p>  Es stellt sich heraus, dass Sie bei jedem Spielschritt die <code>loop</code> Funktion des Spielers ausf√ºhren, sie in einer vollwertigen JavaScript-Umgebung des jeweiligen Spielers (in der das f√ºr ihn gebildete Spielobjekt vorhanden ist) ausf√ºhren, eine Reihe von Befehlen f√ºr die Einheiten abrufen und sie der n√§chsten Verarbeitungsstufe √ºbergeben m√ºssen.  Alles scheint ziemlich einfach zu sein. </p><br><p><img src="https://habrastorage.org/webt/po/om/vh/poomvhcw4nhpjcsgk2df0a5hg_e.png"></p><br><p>  Probleme beginnen, wenn es um die Nuancen der Implementierung geht.  Im Moment haben wir <strong>1600 aktive Spieler</strong> auf der Welt.  Die Skripte einzelner Spieler k√∂nnen bereits nicht als "Skripte" bezeichnet werden - einige von ihnen enthalten bis zu <strong>25.000 Codezeilen</strong> , werden aus TypeScript oder sogar aus C / C ++ / Rust √ºber WebAssembly kompiliert (ja, wir unterst√ºtzen wasm!) Und implementieren das Konzept von echten Miniatur-Betriebssystemen. in dem die Spieler ihren eigenen Pool von Spielaufgaben-Prozessen und deren Verwaltung durch den Kern entwickelt haben, der so viele Aufgaben √ºbernimmt, wie sich herausstellt, um einen bestimmten Takt eines Spiels auszuf√ºhren, sie ausf√ºhrt und sie bis zur n√§chsten Ma√ünahme wieder in die Warteschlange stellt.  Da die CPU und der Speicher des Players bei jedem Taktzyklus begrenzt sind, funktioniert dieses Modell gut.  Obwohl es nicht obligatorisch ist - um das Spiel zu starten, reicht es f√ºr Anf√§nger aus, ein Skript mit 15 Zeilen zu erstellen, das auch bereits als Teil des Tutorials geschrieben wurde. </p><br><p>  Aber jetzt denken wir daran, dass das Player-Skript in einer echten JavaScript-Maschine funktionieren sollte.  Und dass das Spiel in Echtzeit funktioniert - das hei√üt, die JavaScript-Maschine jedes Spielers muss st√§ndig vorhanden sein und in einem bestimmten Tempo arbeiten, um das Spiel insgesamt nicht zu verlangsamen.  Das Ausf√ºhren von Spielskripten und das Bilden von Auftr√§gen f√ºr Einheiten erfolgt ungef√§hr nach dem gleichen Prinzip wie das Verarbeiten von R√§umen. Das Skript jedes Spielers ist eine Aufgabe, die ein Handler aus dem Pool √ºbernimmt. Viele parallele Handler arbeiten im Cluster.  Im Gegensatz zur Phase der Bearbeitung von R√§umen gibt es jedoch bereits viele Schwierigkeiten. </p><br><p>  Erstens k√∂nnen Sie Aufgaben nicht einfach nach dem Zufallsprinzip in jedem Taktzyklus auf Handler verteilen, wie dies bei R√§umen m√∂glich ist.  Die JavaScript-Maschine des Players sollte ohne Unterbrechung funktionieren. Jede nachfolgende Kennzahl ist nur ein neuer <code>loop</code> , aber der globale Kontext sollte weiterhin unver√§ndert bleiben.  Grob gesagt k√∂nnen Sie mit dem Spiel Folgendes tun: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> song = [<span class="hljs-string"><span class="hljs-string">'EX-'</span></span>, <span class="hljs-string"><span class="hljs-string">'TER-'</span></span>, <span class="hljs-string"><span class="hljs-string">'MI-'</span></span>, <span class="hljs-string"><span class="hljs-string">'NATE!'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Game.creeps[<span class="hljs-string"><span class="hljs-string">'DalekSinger'</span></span>].say(song[counter]); counter++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter == song.length) { counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/sz/sk/je/szskjecusiurkgvg1apq3sxzjdw.gif"></p><br><p>  Solch ein Grusel wird bei jedem Spielschlag in einer Zeile des Songs singen.  Die Zeilennummer des <code>counter</code> wird in einem globalen Kontext gespeichert, der zwischen den Takten gespeichert wird.  Wenn das Skript dieses Players jedes Mal in einem neuen Handlerprozess ausgef√ºhrt wird, geht der Kontext verloren.  Dies bedeutet, dass alle Spieler bestimmten Handlern zugeordnet und so wenig wie m√∂glich ge√§ndert werden sollten.  Aber was ist dann mit dem Lastausgleich?  Ein Spieler kann 500 ms Ausf√ºhrung auf diesem Knoten verbringen, und der andere Spieler kann 10 ms verbringen, und es ist sehr schwierig, dies im Voraus vorherzusagen.  Wenn 20 Spieler mit jeweils 500 ms auf einen Knoten fallen, dauert der Betrieb eines solchen Knotens 10 Sekunden. W√§hrend dieser Zeit warten alle anderen auf seine Fertigstellung und stehen im Leerlauf.  Und um diese Spieler wieder ins Gleichgewicht zu bringen und sie auf andere Knoten zu werfen, m√ºssen Sie ihren Kontext verlieren. </p><br><p>  Zweitens muss die Spielerumgebung gut von anderen Spielern und von der Serverumgebung isoliert sein.  Dies betrifft nicht nur die Sicherheit, sondern auch den Komfort f√ºr die Benutzer.  Wenn ein benachbarter Spieler, der auf demselben Knoten im Cluster l√§uft wie ich, es schrecklich macht, viel M√ºll erzeugt und sich im Allgemeinen nicht richtig verh√§lt, sollte ich es nicht f√ºhlen.  Da die CPU-Ressource im Spiel die Skriptausf√ºhrungszeit ist (sie wird vom Anfang bis zum Ende der <code>loop</code> berechnet), kann die Verschwendung von Ressourcen f√ºr externe Aufgaben w√§hrend der Ausf√ºhrung meines Skripts sehr empfindlich sein, da sie aus meinem CPU-Ressourcenbudget ausgegeben wird. </p><br><p>  Bei dem Versuch, diese Probleme zu l√∂sen, haben wir verschiedene L√∂sungen gefunden. </p><br><h2 id="pervaya-versiya">  Erste Version </h2><br><p>  Die erste Version der Spiel-Engine basierte auf zwei grundlegenden Dingen: </p><br><ul><li>  Vollzeit- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>vm</code></a> Modul in der Lieferung von Node.js, </li><li>  Gabel der Laufzeitprozesse. </li></ul><br><p>  Es sah so aus.  Auf jedem Computer im Cluster gab es 4 (entsprechend der Anzahl der Kerne) Prozesse von Spieleskript-Handlern.  Wenn eine neue Aufgabe aus der Warteschlange der Spielskripte empfangen wurde, forderte der Handler die erforderlichen Daten aus der Datenbank an und √ºbertrug sie an einen untergeordneten Prozess, der in einem st√§ndig laufenden Zustand gehalten, im Fehlerfall neu gestartet und von verschiedenen Spielern wiederverwendet wurde.  Der untergeordnete Prozess, der vom √ºbergeordneten Prozess isoliert war (der die Cluster-Gesch√§ftslogik enthielt), konnte nur eines tun: Aus den empfangenen Daten ein Spielobjekt erstellen und die virtuelle Maschine des Spielers starten.  Zu Beginn haben wir das <code>vm</code> Modul in Node.js verwendet. </p><br><p>  Warum war diese Entscheidung unvollkommen?  Genau genommen wurden die beiden oben genannten Probleme hier nicht gel√∂st. </p><br><p>  <code>vm</code> arbeitet im selben Single-Thread-Modus wie Node.js.  Um vier parallele Prozessoren auf jedem Kern einer 4-Kern-Maschine zu haben, ben√∂tigen Sie daher 4 Prozesse.  Das Verschieben eines Spielers, der in einem Prozess ‚Äûlebt‚Äú, in einen anderen Prozess f√ºhrt zu einer vollst√§ndigen Neuerstellung des globalen Kontexts, selbst wenn dies innerhalb derselben Maschine geschieht. </p><br><p><img src="https://habrastorage.org/webt/mu/pk/xl/mupkxlqzbbgh4zjnnymqjdjapm0.png"></p><br><p>  Dar√ºber hinaus erstellt <code>vm</code> keine vollst√§ndig isolierte virtuelle Maschine.  Sie erstellen lediglich einen isolierten <em>Kontext</em> oder Bereich, f√ºhren den Code jedoch in derselben Instanz der virtuellen JavaScript-Maschine aus, von der der Aufruf <code>vm.runInContext</code> .  Und das bedeutet - in demselben Fall, in dem andere Spieler gestartet werden.  Obwohl die Player durch isolierte globale Kontexte getrennt sind, haben sie als Teil derselben virtuellen Maschine einen gemeinsamen Heap-Speicher, einen gemeinsamen Garbage Collector und generieren gemeinsam M√ºll.  Wenn Spieler "A" w√§hrend der Ausf√ºhrung seines Spielskripts viel M√ºll erzeugt, die Arbeit beendet und die Kontrolle an Spieler "B" √ºbergeben hat, kann in diesem Moment der <em>gesamte</em> M√ºll des Prozesses gesammelt werden, und Spieler "B" zahlt CPU-Zeit f√ºr das Sammeln der M√ºll eines anderen.  Ganz zu schweigen von der Tatsache, dass alle Kontexte in derselben Ereignisschleife arbeiten und es theoretisch jederzeit m√∂glich ist, das Versprechen eines anderen auszuf√ºhren, obwohl wir versucht haben, dies zu verhindern.  Au√üerdem k√∂nnen Sie mit <code>vm</code> nicht steuern, wie viel <code>vm</code> f√ºr die Skriptausf√ºhrung zugewiesen wird. Der gesamte Prozessspeicher ist verf√ºgbar. </p><br><h2 id="isolated-vm">  isoliert-vm </h2><br><p>  Dort lebt eine so wundervolle Person namens Marcel Laverde.  F√ºr einige war er einmal bemerkenswert, weil er eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Node-Fiber-</a> Bibliothek geschrieben hatte, f√ºr andere, weil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">er Facebook gehackt hatte, und wurde angeheuert, um dort zu arbeiten</a> .  Und f√ºr uns ist er wunderbar, weil er gro√üz√ºgig an unserer allerersten Crowdfunding-Kampagne teilgenommen hat und bis heute ein gro√üer Fan von Screeps ist. </p><br><p>  Unser Projekt ist seit einigen Jahren in Open Source - der Spieleserver wird auf GitHub ver√∂ffentlicht.  Obwohl der offizielle Client gegen eine Geb√ºhr √ºber Steam verkauft wird, gibt es alternative Versionen davon, und der Server selbst kann in jeder Gr√∂√üenordnung studiert und ge√§ndert werden, was wir nachdr√ºcklich empfehlen. </p><br><p>  Und sobald Marcel uns schreibt: ‚ÄûLeute, ich habe gute Erfahrungen in der nativen C / C ++ - Entwicklung f√ºr Node.js und ich mag dein Spiel, aber nicht jedem gef√§llt, wie es funktioniert - lass uns ein brandneues schreiben Starttechnologie f√ºr virtuelle Maschinen f√ºr Node.js speziell f√ºr Screeps? ‚Äú </p><br><p>  Da Marcel nicht um Geld bat, konnten wir nicht ablehnen.  Nach einigen Monaten unserer Zusammenarbeit wurde die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><strong>isolierte VM-</strong></a> Bibliothek geboren.  Und das hat absolut alles ver√§ndert. </p><br><p>  <code>isolated-vm</code> unterscheidet sich von <code>vm</code> darin, dass es nicht den <em>Kontext</em> isoliert, sondern in Bezug auf <abbr title="In Node.js verwendete JavaScript-Engine">V8</abbr> <em>isoliert</em> .  Ohne auf Details einzugehen, bedeutet dies, dass eine vollwertige separate Instanz der JavaScript-Maschine erstellt wird, die nicht nur √ºber einen eigenen globalen Kontext verf√ºgt, sondern auch √ºber einen eigenen Heap-Speicher, einen Garbage Collector und als Teil einer separaten Ereignisschleife arbeitet.  Von den Minuspunkten: F√ºr jede laufende Maschine ist ein kleiner RAM-Overhead erforderlich (ca. 20 MB), und es ist auch unm√∂glich, Objekte zu √ºbertragen oder Funktionen direkt in die Maschine aufzurufen. Der gesamte Austausch muss serialisiert werden.  Dies beendet die Nachteile, der Rest - es ist nur ein Allheilmittel! </p><br><p><img src="https://habrastorage.org/webt/gh/cz/5v/ghcz5vxih2oaferse6kgv-zruvq.png"></p><br><p>  Jetzt ist es wirklich m√∂glich, das Skript jedes Spielers in einem v√∂llig isolierten Bereich auszuf√ºhren.  Der Spieler hat seine eigenen 500 MB H√ºfte. Wenn es endet, bedeutet dies, dass Ihre eigene H√ºfte geendet hat und nicht die H√ºfte des gesamten Prozesses.  Wenn Sie M√ºll erzeugt haben - dann ist dies Ihr eigener M√ºll, den Sie sammeln m√ºssen.  Dangling-Versprechen werden nur ausgef√ºhrt, wenn Ihr Isolat das n√§chste Mal √ºbernimmt, und nicht fr√ºher.  Gut und sicher - unter keinen Umst√§nden ist ein Zugriff au√üerhalb des Isolats m√∂glich, nur wenn Sie auf V8-Ebene eine Sicherheitsl√ºcke finden. </p><br><p>  Aber was ist mit dem Balancieren?  Ein weiteres Plus von isoliertem VM ist, dass die Maschinen vom selben Prozess aus gestartet werden, jedoch in separaten Threads (die Erfahrung von Marcel mit Knotenfasern hat sich hier als n√ºtzlich erwiesen).  Wenn wir eine 4-Kern-Maschine haben, k√∂nnen wir einen Pool von 4 Threads erstellen und 4 parallele Maschinen gleichzeitig starten.  Gleichzeitig k√∂nnen wir innerhalb desselben Prozesses, dh mit einem gemeinsamen Speicher, jeden Spieler innerhalb dieses Pools von einem Thread auf einen anderen √ºbertragen.  Obwohl jeder Spieler an einen bestimmten Prozess auf einem bestimmten Computer gebunden bleibt (um den globalen Kontext nicht zu verlieren), reicht das Ausbalancieren zwischen 4 Threads aus, um die Probleme der Verteilung von "schweren" und "leichten" Spielern zwischen Knoten zu l√∂sen, sodass alle Prozessoren fertig sind gleichzeitig und p√ºnktlich arbeiten. </p><br><p>  Nachdem wir diese Funktion im experimentellen Modus ausgef√ºhrt hatten, erhielten wir eine Menge positiver R√ºckmeldungen von Spielern, deren Skripte viel besser, stabiler und vorhersehbarer zu funktionieren begannen.  Und jetzt ist dies unsere Standard-Engine, obwohl die Spieler die Legacy-Laufzeit nur aus Gr√ºnden der Abw√§rtskompatibilit√§t mit alten Skripten ausw√§hlen k√∂nnen (einige Spieler haben sich bewusst auf die Besonderheiten der gemeinsam genutzten Umgebung im Spiel konzentriert). </p><br><p>  Nat√ºrlich gibt es noch Raum f√ºr weitere Optimierungen, und es gibt auch andere interessante Bereiche des Projekts, in denen wir verschiedene technische Probleme gel√∂st haben.  Aber dazu ein anderes Mal mehr. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de437836/">https://habr.com/ru/post/de437836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de437826/index.html">Wie wir die Datenbank von Redis und Riak KV auf PostgreSQL migriert haben. Teil 1: Der Prozess</a></li>
<li><a href="../de437828/index.html">√ñffnen Sie das Webinar "SELECT-Abfrageausf√ºhrungsreihenfolge und Abfrageplan in MS SQL Server".</a></li>
<li><a href="../de437830/index.html">Zuverl√§ssige Programmierung nach Sprache - Noob Review. Teil 1</a></li>
<li><a href="../de437832/index.html">Open Source: Code Humor, Code Tricks, NICHT Code</a></li>
<li><a href="../de437834/index.html">Zwei Geschichten dar√ºber, wie Programmierveranstaltungen in Jekaterinburg stattfanden</a></li>
<li><a href="../de437838/index.html">Technologien f√ºr maschinelles Lernen beschleunigen zeitweise den Prozess der Anpassung von Patienten an bionische Prothesen</a></li>
<li><a href="../de437842/index.html">Die geheime Geschichte von Donkey Kong: von Arcade-Automaten bis NES</a></li>
<li><a href="../de437844/index.html">Der immerw√§hrende Streit zwischen statischer und dynamischer Typisierung - TypeScript wird nicht helfen</a></li>
<li><a href="../de437846/index.html">bobaoskit - Zubeh√∂r, dnssd und WebSocket</a></li>
<li><a href="../de437848/index.html">Wir machen den Prozess der Entwicklung schwerer Software f√ºr Mikrocontroller bequemer (nein)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>