<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∑Ô∏è üòë üìü Como testamos v√°rios bancos de dados de s√©ries temporais üßöüèª üíà üßîüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos √∫ltimos anos, os bancos de dados de s√©ries temporais evolu√≠ram de uma coisa curiosa (altamente especializada em sistemas de monitoramento abertos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como testamos v√°rios bancos de dados de s√©ries temporais</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/462111/"><img src="https://habrastorage.org/webt/u_/ty/r0/u_tyr0djrlkmaz-swo9flhddymo.jpeg"><br><br>  Nos √∫ltimos anos, os bancos de dados de s√©ries temporais evolu√≠ram de uma coisa curiosa (altamente especializada em sistemas de monitoramento abertos (e vinculados a solu√ß√µes espec√≠ficas) ou em projetos de Big Data) em "bens de consumo".  No territ√≥rio da Federa√ß√£o Russa, agradecimentos especiais √† Yandex e ClickHouse por isso.  At√© o momento, se voc√™ precisava salvar uma grande quantidade de dados de s√©ries temporais, era necess√°rio aceitar a necessidade de criar uma pilha monstruosa do Hadoop e acompanh√°-la, ou comunicar-se com protocolos espec√≠ficos para cada sistema. <br><br>  Pode parecer que em 2019, um artigo sobre o qual o TSDB deva ser usado consistir√° em apenas uma frase: "basta usar o ClickHouse".  Mas ... existem nuances. <br><br>  De fato, o ClickHouse est√° se desenvolvendo ativamente, a base de usu√°rios est√° crescendo e o suporte est√° sendo muito ativo, mas nos tornamos ref√©ns do sucesso p√∫blico do ClickHouse, que ofusca outras solu√ß√µes possivelmente mais eficazes / confi√°veis? <br><br>  No in√≠cio do ano passado, come√ßamos a processar nosso pr√≥prio sistema de monitoramento, durante o qual surgiu a quest√£o de escolher a base apropriada para o armazenamento de dados.  Eu quero contar sobre a hist√≥ria dessa escolha aqui. <br><a name="habracut"></a><br><h4>  Declara√ß√£o do problema </h4><br>  Primeiro de tudo, o pref√°cio necess√°rio.  Por que precisamos de nosso pr√≥prio sistema de monitoramento e como foi organizado? <br><br>  Come√ßamos a fornecer servi√ßos de suporte em 2008 e, em 2010, ficou claro que era dif√≠cil agregar dados sobre processos que ocorrem na infraestrutura do cliente com as solu√ß√µes existentes naquele momento (estamos falando, Deus me perdoe, Cacti, Zabbix e o nascente Grafite). <br><br>  Nossos principais requisitos foram: <br><br><ul><li>  suporte (na √©poca - dezenas e no futuro - centenas) de clientes dentro do mesmo sistema e ao mesmo tempo a presen√ßa de um sistema centralizado de gerenciamento de alertas; </li><li>  flexibilidade no gerenciamento do sistema de alerta (encaminhamento de alertas entre atendentes, contabilidade de cronograma, base de conhecimento); </li><li>  a possibilidade de detalhes detalhados dos gr√°ficos (o Zabbix naquela √©poca estava desenhando gr√°ficos na forma de figuras); </li><li>  armazenamento de longo prazo de uma grande quantidade de dados (um ano ou mais) e a capacidade de selecion√°-los rapidamente. </li></ul><br>  Neste artigo, estamos interessados ‚Äã‚Äãno √∫ltimo ponto. <br><br>  Falando em armazenamento, os requisitos foram os seguintes: <br><br><ul><li>  o sistema deve funcionar rapidamente; </li><li>  √© desej√°vel que o sistema tenha uma interface SQL; </li><li> o sistema deve ser est√°vel e ter uma base de usu√°rios e suporte ativos (uma vez que enfrentamos a necessidade de oferecer suporte a sistemas como, por exemplo, o MemcacheDB, que paramos de desenvolver, ou o armazenamento distribu√≠do MooseFS, cujo rastreador de erros foi realizado em chin√™s: repetindo esta hist√≥ria para o nosso projeto n√£o quis); </li><li>  Correspond√™ncia para o teorema da PAC: Consit√™ncia (necess√°ria) - os dados devem ser relevantes, n√£o queremos que o sistema de gerenciamento de notifica√ß√µes n√£o receba novos dados e cuspa alertas sobre a n√£o chegada de dados para todos os projetos;  Toler√¢ncia de parti√ß√£o (necess√°rio) - n√£o queremos obter sistemas de c√©rebro dividido;  Disponibilidade (n√£o cr√≠tica, no caso de uma r√©plica ativa) - podemos mudar para o sistema de backup em caso de acidente, com um c√≥digo. </li></ul><br>  Curiosamente, naquela √©poca o MySQL era a solu√ß√£o perfeita para n√≥s.  Nossa estrutura de dados era extremamente simples: identifica√ß√£o do servidor, contador, carimbo de data e hora e valor;  a amostragem r√°pida de dados quentes foi fornecida por um grande buffer pool e a amostragem de dados hist√≥ricos foi fornecida pelo SSD. <br><br><img src="https://habrastorage.org/webt/ii/cd/es/iicdesd_tmiqwygfha8r4bepjgg.png"><br><br>  Assim, obtivemos uma amostragem de dados frescos de duas semanas, detalhando at√© um segundo de 200 ms antes que os dados fossem completamente renderizados e vivemos nesse sistema por algum tempo. <br><br>  Enquanto isso, o tempo passou e a quantidade de dados aumentou.  Em 2016, os volumes de dados atingiram dezenas de terabytes, o que em termos de armazenamento SSD alugado era uma despesa significativa. <br><br>  Nesse ponto, os bancos de dados colunares estavam se espalhando ativamente, sobre os quais come√ßamos a pensar ativamente: nos bancos de dados colunares, os dados s√£o armazenados, como pode ser entendido, em colunas, e se voc√™ olhar para os nossos dados, √© f√°cil ver um grande n√∫mero de duplicatas que poderiam ser Se estiver usando um banco de dados de coluna, comprima com a compacta√ß√£o. <br><br><img src="https://habrastorage.org/webt/zm/gu/x3/zmgux307lo7r3i7s9uykpgozadm.png"><br><br>  No entanto, o sistema principal do trabalho da empresa continuava funcionando de maneira est√°vel, e eu n√£o queria experimentar a transi√ß√£o para outra coisa. <br><br>  Em 2017, na confer√™ncia Percona Live em San Jose, provavelmente a primeira vez que os desenvolvedores da Clickhouse se anunciaram.  √Ä primeira vista, o sistema estava pronto para produ√ß√£o (bem, o Yandex.Metrica √© uma produ√ß√£o dura), o suporte era r√°pido e simples e, o mais importante, a opera√ß√£o era simples.  Desde 2018, iniciamos o processo de transi√ß√£o.  Mas, naquela √©poca, havia muitos sistemas TSDB "adultos" e testados pelo tempo, e decidimos alocar um tempo consider√°vel e comparar alternativas para garantir que n√£o houvesse solu√ß√µes alternativas da Clickhouse, de acordo com nossos requisitos. <br><br>  Al√©m dos requisitos de armazenamento j√° indicados, surgiram novos: <br><br><ul><li>  o novo sistema deve fornecer pelo menos o mesmo desempenho que o MySQL, na mesma quantidade de ferro; </li><li>  o armazenamento do novo sistema deve ocupar significativamente menos espa√ßo; </li><li>  O DBMS ainda deve ser f√°cil de gerenciar; </li><li>  Eu queria minimizar o aplicativo ao alterar o DBMS. </li></ul><br><h4>  Quais sistemas come√ßamos a considerar </h4><br>  <b><u>Apache Hive / Apache Impala</u></b> <br>  Pilha de Hadoop agredida velha.  De fato, essa √© uma interface SQL criada com base no armazenamento de dados em formatos nativos no HDFS. <br><br>  Pros. <br><br><ul><li>  Com opera√ß√£o est√°vel, √© muito f√°cil dimensionar os dados. </li><li>  Existem solu√ß√µes de coluna para armazenamento de dados (menos espa√ßo). </li><li>  Execu√ß√£o muito r√°pida de tarefas paralelas na presen√ßa de recursos. </li></ul><br>  Contras <br><br><ul><li>  Este √© um Hadoop e √© dif√≠cil de operar.  Se n√£o estamos prontos para tomar uma solu√ß√£o pronta na nuvem (e n√£o estamos prontos para o custo), toda a pilha ter√° que ser montada e suportada pelos administradores, mas eu realmente n√£o quero isso. </li><li>  Os dados s√£o agregados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muito rapidamente</a> . </li></ul><br>  No entanto: <br><br><img src="https://habrastorage.org/webt/zi/nv/qx/zinvqxvmxc43df-hd4xjqwprtmi.png"><br><br>  A velocidade √© alcan√ßada escalando o n√∫mero de servidores de computa√ß√£o.  Simplificando, se somos uma grande empresa envolvida em an√°lises e neg√≥cios, √© extremamente importante agregar informa√ß√µes o mais r√°pido poss√≠vel (mesmo ao custo de usar um grande n√∫mero de recursos de computa√ß√£o) - essa pode ser a nossa escolha.  Mas n√£o est√°vamos prontos para multiplicar o parque de ferro para acelerar as tarefas. <br><br>  <b><u>Druida / pinot</u></b> <br><br>  J√° h√° muito mais sobre o TSDB especificamente, mas novamente - Hadoop-stack. <br><br>  H√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√≥timo artigo comparando os pr√≥s e contras de Druid e Pinot em compara√ß√£o ao ClickHouse</a> . <br><br>  Em poucas palavras: Druid / Pinot parece melhor que Clickhouse nos casos em que: <br><br><ul><li>  Voc√™ tem uma natureza heterog√™nea dos dados (no nosso caso, registramos apenas s√©ries temporais de m√©tricas de servidor e, de fato, essa √© uma tabela. Mas pode haver outros casos: s√©ries temporais de equipamentos, s√©ries econ√¥micas etc. - cada um com sua pr√≥pria estrutura, que devem ser agregados e processados). </li><li>  Al√©m disso, existem muitos desses dados. </li><li>  As tabelas e os dados com s√©ries temporais aparecem e desaparecem (ou seja, algum tipo de conjunto de dados entrou, foi analisado e exclu√≠do). </li><li>  N√£o h√° um crit√©rio claro pelo qual os dados possam ser particionados. </li></ul><br>  Em casos opostos, o ClickHouse se mostra melhor, e esse √© o nosso caso. <br><br>  <b><u>Clickhouse</u></b> <br><br><ul><li>  Como SQL. </li><li>  F√°cil de gerenciar. </li><li>  As pessoas dizem que isso funciona. </li></ul><br>  Ele se enquadra na lista restrita de testes. <br><br>  <b><u>Influxdb</u></b> <br><br>  Alternativa estrangeira ao ClickHouse.  Das desvantagens: a alta disponibilidade est√° presente apenas na vers√£o comercial, mas deve ser comparada. <br><br>  Ele se enquadra na lista restrita de testes. <br><br>  <b><u>Cassandra</u></b> <br><br>  Por um lado, sabemos que √© usado para armazenar s√©ries temporais m√©tricas por sistemas de monitoramento como, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SignalFX</a> ou OkMeter.  No entanto, existem detalhes. <br><br>  Cassandra n√£o √© um banco de dados de colunas no sentido usual.  Parece mais uma letra min√∫scula, mas cada linha pode ter um n√∫mero diferente de colunas, devido ao qual √© f√°cil organizar uma representa√ß√£o de coluna.  Nesse sentido, √© claro que, com um limite de 2 bilh√µes de colunas, √© poss√≠vel armazenar alguns dados nas colunas (sim, a mesma s√©rie temporal).  Por exemplo, no MySQL, h√° um limite para 4096 colunas e √© f√°cil encontrar um erro com o c√≥digo 1117 se voc√™ tentar fazer o mesmo. <br><br>  O mecanismo Cassandra est√° focado em armazenar grandes quantidades de dados em um sistema distribu√≠do sem um assistente, e no teorema do CAP mencionado acima, Cassandra √© mais sobre AP, ou seja, sobre acessibilidade de dados e resist√™ncia ao particionamento.  Portanto, essa ferramenta pode ser √≥tima se voc√™ precisar apenas gravar neste banco de dados e raramente ler a partir dele.  E aqui √© l√≥gico usar o Cassandra como um armazenamento "frio".  Ou seja, como um local confi√°vel a longo prazo para armazenar grandes quantidades de dados hist√≥ricos que raramente s√£o necess√°rios, mas que podem ser obtidos se necess√°rio.  No entanto, por uma quest√£o de integridade, vamos test√°-lo.  Mas, como eu disse anteriormente, n√£o h√° desejo de reescrever ativamente o c√≥digo da solu√ß√£o de banco de dados selecionada, portanto, vamos test√°-lo um pouco limitado - sem adaptar a estrutura do banco de dados √†s especifica√ß√µes do Cassandra. <br><br>  <b><u>Prometeu</u></b> <br><br>  Bem, e sem interesse, decidimos testar o desempenho da loja Prometheus - apenas para entender se somos mais r√°pidos do que as solu√ß√µes atuais ou mais lentos e quanto. <br><br><h4>  Metodologia e Resultados dos Testes </h4><br>  Portanto, testamos 5 bancos de dados nas 6 configura√ß√µes a seguir: ClickHouse (1 n√≥), ClickHouse (tabela distribu√≠da de 3 n√≥s), InfluxDB, Mysql 8, Cassandra (3 n√≥s) e Prometheus.  O plano de teste √© o seguinte: <br><br><ol><li>  preencher os dados hist√≥ricos da semana (840 milh√µes de valores por dia; 208 mil m√©tricas); </li><li>  gerar uma carga de grava√ß√£o (foram considerados 6 modos de carga, veja abaixo); </li><li>  paralelamente √† grava√ß√£o, periodicamente fazemos amostras, simulando as solicita√ß√µes de um usu√°rio que trabalha com gr√°ficos.  Para n√£o complicar muito as coisas, selecionamos os dados em 10 m√©tricas (da mesma forma que no gr√°fico da CPU) por semana. </li></ol><br>  Carregamos emulando o comportamento do nosso agente de monitoramento, que envia valores para cada m√©trica a cada 15 segundos.  Nesse caso, estamos interessados ‚Äã‚Äãem variar: <br><br><ul><li>  n√∫mero total de m√©tricas nas quais os dados s√£o gravados; </li><li>  intervalo de envio de valores em uma m√©trica; </li><li>  tamanho do lote. </li></ul><br>  Sobre o tamanho do lote.  Como quase todas as nossas bases experimentais n√£o s√£o recomendadas para serem carregadas com inser√ß√µes √∫nicas, precisaremos de um rel√© que colete as m√©tricas recebidas e as agrupe o m√°ximo poss√≠vel e as grave no banco de dados com uma inser√ß√£o de pacote. <br><br>  Al√©m disso, para entender melhor como interpretar os dados recebidos posteriormente, imagine que n√£o estamos apenas enviando v√°rias m√©tricas, mas as m√©tricas s√£o organizadas em servidores - 125 m√©tricas por servidor.  Aqui, o servidor √© apenas uma entidade virtual - apenas para entender que, por exemplo, 10.000 m√©tricas correspondem a aproximadamente 80 servidores. <br><br>  E assim, levando tudo isso em considera√ß√£o, nossos 6 modos de carregamento de grava√ß√£o da base: <br><br><img src="https://habrastorage.org/webt/lr/li/oo/lrlioosoevoybfuw4--rsftdugi.jpeg"><br><br>  Existem dois pontos.  Em primeiro lugar, para cassandra tais tamanhos de lotes eram muito grandes, foram utilizados valores de 50 ou 100. Em segundo lugar, uma vez que o prometeus funciona estritamente no modo pull, ou seja,  ele caminha e coleta dados de fontes m√©tricas (e mesmo o pushgateway, apesar do nome, n√£o altera fundamentalmente a situa√ß√£o), as cargas correspondentes foram implementadas usando uma combina√ß√£o de configura√ß√µes est√°ticas. <br><br>  Os resultados do teste s√£o os seguintes: <br><br><img src="https://habrastorage.org/webt/0r/sz/vc/0rszvcd_aeoiqwlrixsgw0tauti.jpeg"><br><br><img src="https://habrastorage.org/webt/3r/gy/2g/3rgy2guskcodctly7nevknbygss.jpeg"><br><br><img src="https://habrastorage.org/webt/v8/mg/tm/v8mgtm0ytjkjkneal1mjcvw5n8w.jpeg"><br><br>  <b>O que vale a pena notar</b> : amostras fantasticamente r√°pidas de Prometheus, amostras terrivelmente lentas de Cassandra, amostras inaceitavelmente lentas de InfluxDB;  O ClickHouse venceu em termos de velocidade de grava√ß√£o e o Prometheus n√£o participa da competi√ß√£o, porque insere dentro de si e n√£o medimos nada. <br><br>  <u><b>Como resultado</b></u> : o ClickHouse e o InfluxDB se mostraram o melhor de todos, mas um cluster do Influx s√≥ pode ser constru√≠do com base na vers√£o Enterprise, que custa dinheiro, e o ClickHouse n√£o custa nada e √© fabricado na R√∫ssia.  √â l√≥gico que, nos EUA, a escolha provavelmente seja a favor do inInfluxDB e, no nosso caso, a favor do ClickHouse. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462111/">https://habr.com/ru/post/pt462111/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462095/index.html">Trabalhar com luz e √≥ptica: como iniciar uma carreira na universidade - a experi√™ncia de graduados em quatro programas de mestrado especializados</a></li>
<li><a href="../pt462097/index.html">Passeio verde claro</a></li>
<li><a href="../pt462101/index.html">Relat√≥rio do Java Virtual Machine Language Summit 2019</a></li>
<li><a href="../pt462107/index.html">Maratona gr√°tis ‚ÄúBig Data e super-her√≥is: sua primeira experi√™ncia em an√°lise de dados‚Äù</a></li>
<li><a href="../pt462109/index.html">Veja quase invis√≠vel, tamb√©m em cores: uma t√©cnica para visualizar objetos atrav√©s de um difusor</a></li>
<li><a href="../pt462113/index.html">Ambiente irrepreens√≠vel: ningu√©m deve escrever um c√≥digo de qualidade</a></li>
<li><a href="../pt462115/index.html">Ajuste o c√©u estrelado no WebGL em 1009 bytes de JavaScript</a></li>
<li><a href="../pt462117/index.html">Como maximizar o valor da prepara√ß√£o do backlog do produto?</a></li>
<li><a href="../pt462119/index.html">Delta Smart City Solutions: Voc√™ j√° se perguntou como o cinema pode ser ecol√≥gico?</a></li>
<li><a href="../pt462121/index.html">Swift funcional</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>