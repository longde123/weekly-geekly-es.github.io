<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📿 👩🏾‍🚒 🧑🏼 12,3 juta WebSockets bersamaan ⛲️ 🤽🏼 👩🏿‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Satu hal tentang WebSockets adalah bahwa Anda memerlukan banyak sumber daya di sisi klien untuk menghasilkan beban yang cukup tinggi bagi server untuk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>12,3 juta WebSockets bersamaan</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460847/"><p>  Satu hal tentang WebSockets adalah bahwa Anda memerlukan banyak sumber daya di sisi klien untuk menghasilkan beban yang cukup tinggi bagi server untuk benar-benar memakan semua sumber daya CPU. </p><br><p>  Ada beberapa tantangan yang harus Anda atasi karena protokol WebSockets lebih menuntut CPU di sisi klien daripada di sisi server.  Pada saat yang sama Anda memerlukan banyak RAM untuk menyimpan informasi tentang koneksi terbuka jika Anda memiliki jutaan dari mereka. </p><br><p>  Saya sudah cukup beruntung mendapatkan beberapa server baru untuk jangka waktu terbatas yang saya inginkan untuk pengujian perangkat keras "burnout".  Jadi saya memutuskan untuk menggunakan Server Aplikasi Lua - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">LAppS</a> untuk melakukan kedua pekerjaan: menguji perangkat keras dan melakukan tes beban tinggi LAppS. </p><br><p><a name="habracut"></a>  Mari kita lihat detailnya </p><br><h1 id="challenges">  Tantangan </h1><br><p>  Pertama-tama WebSockets di sisi klien memerlukan RNG yang cukup cepat untuk penutupan lalu lintas kecuali Anda ingin memalsukannya.  Saya ingin tesnya realistis, jadi saya membuang ide memalsukan RNG dengan menggantinya dengan konstanta.  Ini menyisakan satu-satunya pilihan - banyak daya CPU.  Seperti yang saya katakan, saya memiliki dua server: satu dengan dual Intel Gold 6148 CPU (total 40 core) 256GB RAM (DDR4-2666) dan satu dengan quad Intel Platinum 8180 CPU (total 112 core) 384GB RAM (DDR4-2666) .  Saya akan merujuk mereka sebagai Server A dan Server B selanjutnya. </p><br><p>  Tantangan kedua - tidak ada perpustakaan atau ruang tes untuk WebSockets yang cukup cepat.  Itulah sebabnya saya terpaksa mengembangkan modul klien WebSockets untuk LAppS (cws). </p><br><h1 id="the-tests-setup">  Pengaturan tes </h1><br><p>  Kedua server memiliki kartu dual port 10GbE.  Port 1 dari setiap kartu digabungkan ke antarmuka pengikat dan port-port ini pada kedua kartu saling terhubung dalam mode RR.  Port 2 dari setiap kartu dikumpulkan ke antarmuka ikatan dalam mode Active-Backup, yang terhubung melalui switch Ethernet.  Setiap server perangkat keras menjalankan RHEL 7.6.  Saya harus menginstal gcc-8.3 dari sumber untuk memiliki kompiler modern daripada default gcc-4.8.5.  Bukan pengaturan terbaik untuk tes kinerja, namun pengemis tidak bisa menjadi pemilih. </p><br><p>  CPU di Server A (2xGold 6148) memiliki frekuensi lebih tinggi daripada di Server B (4xPlatinum 8180).  Pada saat yang sama Server B memiliki lebih banyak core, jadi saya memutuskan untuk menjalankan server gema di Server A dan klien gema di Server B. </p><br><p>  Saya ingin melihat bagaimana LAppS berperilaku di bawah beban tinggi dengan jutaan koneksi dan berapa jumlah maksimum permintaan echo per detik yang dapat dilayani.  Ini sebenarnya dua set tes yang berbeda karena dengan pertumbuhan jumlah koneksi server dan klien melakukan pekerjaan yang semakin kompleks. </p><br><p>  Sebelum ini saya telah melakukan semua tes pada PC di rumah saya yang saya gunakan untuk pengembangan.  Hasil tes ini akan digunakan untuk perbandingan.  PC rumah saya memiliki Intel Core i7-7700 CPU 3.6GHz (4.0GHz Turbo) dengan 4 core dan 32GB DDR4-2400 RAM.  PC ini menjalankan Gentoo dengan kernel 4.14.72. </p><br><div class="spoiler">  <b class="spoiler_title">Level patch Spectre dan Meltdown</b> <div class="spoiler_text"><ul><li>  PC rumah <br><pre><code class="plaintext hljs">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable /sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI /sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp /sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization /sys/devices/system/cpu/vulnerabilities/spectre_v2:Vulnerable: Minimal generic ASM retpoline, IBPB, IBRS_FW</code> </pre> </li><li>  Server A dan B <br><pre> <code class="plaintext hljs">/sys/kernel/debug/x86/ibpb_enabled : 1 /sys/kernel/debug/x86/pti_enabled : 1 /sys/kernel/debug/x86/ssbd_enabled : 1 /sys/kernel/debug/x86/ibrs_enabled : 1 /sys/kernel/debug/x86/retp_enabled : 3</code> </pre> </li></ul><br><p>  Saya akan membuat catatan tambahan dengan hasil pengujian Server A dan B apakah tambalan ini diaktifkan atau tidak. </p><br><p>  Pada tingkat Home PC patch saya tidak pernah berubah. </p></div></div><br><h2 id="installing-lapps-081">  Menginstal LAppS 0.8.1 </h2><br><div class="spoiler">  <b class="spoiler_title">Menginstal prasyarat dan LAppS</b> <div class="spoiler_text"><p>  LAppS bergantung pada luajit-2.0.5 atau lebih tinggi, libcrypto ++ 8.2 dan wolfSSL-3.15.7 perpustakaan dan mereka harus diinstal dari sumber di RHEL 7.6 dan kemungkinan di distribusi linux lainnya. </p><br><p>  Awalan untuk instalasi adalah / usr / local.  Berikut adalah bagian Dockerfile cukup jelas untuk instalasi wolfSSL </p><br><pre> <code class="plaintext hljs">ADD https://github.com/wolfSSL/wolfssl/archive/v3.15.7-stable.tar.gz ${WORKSPACE} RUN tar xzvf v3.15.7-stable.tar.gz WORKDIR ${WORKSPACE}/wolfssl-3.15.7-stable RUN ./autogen.sh RUN ./configure CFLAGS="-pipe -O2 -march=native -mtune=native -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -DTFM_TIMING_RESISTANT -DECC_TIMING_RESISTANT -DWC_RSA_BLINDING" --prefix=/usr/local --enable-tls13 --enable-openssh --enable-aesni --enable-intelasm --enable-keygen --enable-certgen --enable-certreq --enable-curve25519 --enable-ed25519 --enable-intelasm --enable-harden RUN make -j40 all RUN make install</code> </pre><br><p>  Dan inilah bagian untuk instalasi libcrypto ++ </p><br><pre> <code class="plaintext hljs">ADD https://github.com/weidai11/cryptopp/archive/CRYPTOPP_8_2_0.tar.gz ${WORKSPACE} RUN rm -rf ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN tar xzvf ${WORKSPACE}/CRYPTOPP_8_2_0.tar.gz WORKDIR ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN make CFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" CXXFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" -j40 libcryptopp.a libcryptopp.so RUN make install</code> </pre><br><p>  Dan luajit </p><br><pre> <code class="plaintext hljs">ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz ${WORKSPACE} WORKDIR ${WORKSPACE} RUN tar xzvf LuaJIT-2.0.5.tar.gz WORKDIR ${WORKSPACE}/LuaJIT-2.0.5 RUN env CFLAGS="-pipe -Wall -pthread -O2 -fPIC -march=native -mtune=native -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -fstack-check -fstack-protector-strong -fno-omit-frame-pointer" make -j40 all RUN make install</code> </pre> <br><p>  Satu ketergantungan opsional LAppS, yang dapat diabaikan, adalah perpustakaan baru dari Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mimalloc</a> .  Perpustakaan ini membuat peningkatan kinerja yang signifikan (sekitar 1%) tetapi membutuhkan cmake-3.4 atau lebih tinggi.  Mengingat terbatasnya waktu untuk tes, saya memutuskan untuk mengorbankan peningkatan kinerja yang disebutkan. </p><br><p>  Di PC rumah saya, saya tidak akan menonaktifkan <em>mimalloc</em> selama pengujian. </p><br><p>  Memungkinkan checkout LAppS dari repositori: </p><br><pre> <code class="plaintext hljs">WORKDIR ${WORKSPACE} RUN rm -rf ITCLib ITCFramework lar utils LAppS RUN git clone https://github.com/ITpC/ITCLib.git RUN git clone https://github.com/ITpC/utils.git RUN git clone https://github.com/ITpC/ITCFramework.git RUN git clone https://github.com/ITpC/LAppS.git RUN git clone https://github.com/ITpC/lar.git WORKDIR ${WORKSPACE}/LAppS</code> </pre> <br><p>  Sekarang kita perlu menghapus "-lmimalloc" dari semua Makefile di subdirektori <strong>nbproject</strong> , sehingga kita dapat membangun LAppS (dengan asumsi direktori kita saat ini adalah $ {WORKSPACE} / LAppS) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find ./nbproject -type f -name "*.mk" -exec sed -i.bak -e 's/-lmimalloc//g' {} \; # find ./nbproject -type f -name "*.bak" -exec rm {} \;</span></span></code> </pre> <br><p>  Dan sekarang kita bisa membangun LAppS.  LAppS menyediakan beberapa konfigurasi bangunan, yang mungkin atau mungkin tidak mengecualikan beberapa fitur di sisi server: </p><br><ul><li>  dengan dukungan SSL dan dengan dukungan pengumpulan statistik </li><li>  dengan SSL dan tanpa pengumpulan statistik (meskipun pengumpulan statistik minimal akan berlanjut karena digunakan untuk penyetelan LAppS dinamis dalam runtime) </li><li>  tanpa SSL dan tanpa pengumpulan statistik. </li></ul><br><p>  Sebelum langkah selanjutnya pastikan Anda adalah pemilik direktori / opt / lapps (atau jalankan make installs dengan sudo) </p><br><p>  Mari kita membuat dua jenis biner dengan dukungan SSL dan pengumpulan statistik dan tanpa (dengan asumsi kita berada dalam direktori $ {WORKSPACE} / LAppS): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make CONF=Release.AVX2 install # make CONF=Release.AVX2.NO_STATS.NO_TLS install</span></span></code> </pre> <br><p>  Binari yang dihasilkan adalah: </p><br><ul><li>  dist / Release.AVX2 / GNU-Linux / lapps.avx2 </li><li>  dist / Release.AVX2.NO_STATS.NO_TLS / GNU-Linux / lapps.avx2.nostats.notls </li></ul><br><p>  Mereka akan diinstal ke / opt / lapps / bin. </p><br><p>  Harap dicatat bahwa modul klien WebSockets untuk Lua selalu dibangun dengan dukungan SSL.  Apakah diaktifkan atau tidak tergantung pada URI yang Anda gunakan untuk koneksi (ws: // atau wss: //) di runtime. </p></div></div><br><h2 id="test-1-top-performance-on-home-pc-configuration-for-baseline">  Uji 1. Performa terbaik di PC rumah.  Konfigurasi untuk baseline. </h2><br><p>  Saya telah menetapkan bahwa saya mendapatkan kinerja terbaik ketika saya mengkonfigurasi empat instance layanan benchmark dengan masing-masing 100 koneksi.  Pada saat yang sama saya hanya membutuhkan tiga IOWorkers dan empat instance layanan gema untuk mencapai kinerja terbaik.  Ingat?  Saya hanya punya 4 core di sini. </p><br><p>  Tujuan dari tes ini adalah hanya untuk menetapkan garis dasar untuk perbandingan lebih lanjut.  Tidak ada yang mengasyikkan di sini. </p><br><p>  Di bawah ini adalah langkah-langkah yang diperlukan untuk mengkonfigurasi LAppS untuk pengujian. </p><br><h3 id="self-signed-certificates">  Sertifikat yang ditandatangani sendiri </h3><br><div class="spoiler">  <b class="spoiler_title">skrip certgen.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash openssl genrsa -out example.org.key 2048 openssl req -new -key example.org.key -out example.org.csr openssl genrsa -out ca.key 2048 openssl req -new -x509 -key ca.key -out ca.crt openssl x509 -req -in example.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out example.org.crt cat example.org.crt ca.crt &gt; example.org.bundle.crt</span></span></code> </pre> </div></div><br><p>  Menjalankan skrip ini dari dalam direktori / opt / lapps / conf / ssl akan membuat semua file yang diperlukan.  Ini adalah output skrip dan apa yang saya ketikkan: </p><br><div class="spoiler">  <b class="spoiler_title">keluaran certgen.sh</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># certgen.sh Generating RSA private key, 2048 bit long modulus .................................................................................................................................................................+++++ .....................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []: Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Generating RSA private key, 2048 bit long modulus ...+++++ ............................................................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:none Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:*.example.org Email Address []: Signature ok subject=C = KZ, ST = none, L = Almaty, O = NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Getting CA Private Key</code> </pre> </div></div><br><h3 id="lapps-configuration">  Konfigurasi LAppS </h3><br><p>  Berikut ini adalah file konfigurasi WebSockets yang diatur untuk TLS 1.3, termasuk sertifikat yang dibuat di atas dan dikonfigurasi dengan 3 IOWorkers (lihat deskripsi terperinci tentang variabel dalam wiki LAppS). </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">40000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Layanan konfigurasi: server gema dan klien gema (benchmark), masing-masing dengan empat instance. </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } }, <span class="hljs-attr"><span class="hljs-attr">"benchmark"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"depends"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"echo"</span></span> ] } } }</code> </pre> </div></div><br><p>  Layanan gema cukup sepele: </p><br><div class="spoiler">  <b class="spoiler_title">kode sumber layanan gema</b> <div class="spoiler_text"><pre> <code class="lua hljs">echo = {} echo.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = echo; echo.onStart=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onStart"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onDisconnect=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onShutdown=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onShutdown()"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onMessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,opcode, message)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errmsg=ws:send(handler,opcode,message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::OnMessage(): "</span></span>..errmsg); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> echo</code> </pre> </div></div><br><p>  Layanan benchmark membuat sebanyak <strong>benchmark.max_connections</strong> ke <strong>benchmark.target</strong> dan kemudian berjalan sampai Anda menghentikan LAppS.  Tidak ada jeda dalam pendirian koneksi atau permintaan pemboman gema.  API modul <strong>cws</strong> menyerupai Web API untuk WebSockets.  Setelah semua <strong>benchmark.max_connections</strong> ditetapkan, benchmark mencetak jumlah Soket yang terhubung.  Setelah koneksi terbentuk, benchmark mengirimkan <strong>benchmark.message</strong> ke server.  Setelah server membalas metode <strong>onmessage</strong> anonim dari objek <strong>cws</strong> dipanggil, yang hanya mengirim pesan yang sama kembali ke server. </p><br><div class="spoiler">  <b class="spoiler_title">kode sumber layanan patokan</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">100</span></span>; benchmark.target=<span class="hljs-string"><span class="hljs-string">"wss://127.0.0.1:5083/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">-- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><h3 id="services-installation">  Instalasi layanan </h3><br><p>  Sekarang kita perlu menempatkan skrip layanan ke /opt/lapps/apps//.lua: <br></p><ul><li>  /opt/lapps/apps/benchmark/benchmark.lua </li><li>  /opt/lapps/apps/echo/echo.lua </li></ul><br><p>  Kami siap menjalankan tolok ukur kami sekarang.  Jalankan saja: <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code> dari dalam direktori LAppS dan tunggu selama 5 menit, lalu tekan Ctrl-C sekali, untuk menghentikan LAppS (itu tidak akan berhenti segera, itu akan mematikan koneksi terlebih dahulu), atau dua kali (ini akan mengganggu urutan shutdown). </p><br><p>  Oke, kami punya file teks dengan sesuatu seperti ini di dalamnya: </p><br><div class="spoiler">  <b class="spoiler_title">output patokan</b> <div class="spoiler_text"><p>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  berlari <br>  1 pesan diterima per 3196 ms <br>  1 pesan diterima per 3299 ms <br>  1 pesan diterima per 3299 ms <br>  1 pesan diterima per 3305 ms <br>  Soket terhubung: 100 <br>  Soket terhubung: 100 <br>  Soket terhubung: 100 <br>  Soket terhubung: 100 <br>  134597 pesan diterima per 1000ms <br>  139774 pesan diterima per 1000ms <br>  138521 pesan diterima per 1000ms <br>  139404 pesan diterima per 1000ms <br>  140162 pesan diterima per 1000ms <br>  139337 pesan diterima per 1000ms <br>  140088 pesan diterima per 1000ms <br>  139946 pesan diterima per 1000 ms <br>  141.204 pesan diterima per 1000ms <br>  137988 pesan diterima per 1000 ms <br>  141805 pesan diterima per 1000ms <br>  134733 pesan diterima per 1000 ms <br>  ... </p></div></div><br><p>  Mari kita bersihkan file log ini seperti ini: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G4/Sockets\n4\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span></code> </pre> <br><p>  '^ V ^ M' adalah representasi yang terlihat dari klik kunci berikut: Ctrl-V Ctrl-V Ctrl-V Ctrl-V, jadi akan sangat tidak berguna untuk hanya menyalin tempelkan garis bash ini.  Penjelasan singkat: </p><br><ul><li>  kita harus mengganti simbol 'ms' dengan end of line, karena kita tidak membutuhkannya, mereka akan mengacaukan perhitungan nanti dan 4 tolok ukur yang bekerja secara paralel dapat mencetak hasilnya dalam satu baris. </li><li>  kita perlu menghapus semua baris kosong sesudahnya </li><li>  kami menghapus baris terakhir juga, karena kami menghentikan server </li><li>  dalam file <strong>log</strong> hanya akan ada garis depan yang terdiri dari <em>Soket yang terhubung: 100</em> (itu karena kami hanya menjalankan empat layanan benchmark).  Jadi kita lewati 4 baris melewati yang terakhir, dan daripada menghapus semuanya ke atas file. </li><li>  menyimpan file. </li></ul><br><p>  File disimpan dan Anda kembali ke shell sekarang, dan file log siap untuk langkah selanjutnya: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># awk -v avg=0 '{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*4}' log</span></span></code> </pre> <br><p>  Single-liner awk ini menghitung jumlah respons gema per ms, dan mengakumulasikan hasilnya dalam variabel <em>rata-rata</em> .  Setelah semua baris dalam file log diproses, ini mengalikan <em>rata</em> - <em>rata</em> hingga 1000 untuk mendapatkan jumlah total respons gema per detik, membaginya ke jumlah baris dan mengalikannya dengan jumlah layanan benchmark.  Ini memberi kami jumlah rata-rata respons gema per detik untuk pengujian ini. </p><br><p>  Di PC saya nomor ini (ERps) adalah: <strong>563854</strong> </p><br><p>  Mari kita lakukan hal yang sama tanpa dukungan SSL dan lihat perbedaannya: </p><br><ul><li>  ubah nilai variabel <strong>tls</strong> di ws.json menjadi false </li><li>  ubah <strong>benchmark.target</strong> di benchmark.lua dari wss: // ke ws: // </li><li>  jalankan <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> dari dalam direktori LAppS, dan ulangi langkah-langkah di atas. </li></ul><br><p>  Saya mendapat: <strong>721236</strong> respons per detik </p><br><p>  Perbedaan kinerja dengan SSL dan tanpa SSL adalah sekitar 22%.  Mari kita ingat angka-angka ini untuk referensi di masa mendatang. </p><br><p>  Dengan pengaturan yang sama pada Server A, saya punya: <strong>421905</strong> ERpS dengan SSL dan <strong>443145</strong> ERpS tanpa SSL.  Patch untuk Specter dan Meltdown dinonaktifkan. <br>  Di Server B saya punya <strong>270996</strong> ERpS dengan SSL dan <strong>318522</strong> ERpS tanpa SSL dengan patch diaktifkan.  <strong>385726</strong> dan <strong>372126</strong> tanpa dan dengan SSL.  Patch untuk Specter dan Meltdown juga dinonaktifkan. </p><br><p>  Hasilnya lebih buruk dengan pengaturan yang sama karena CPU pada server ini memiliki frekuensi yang lebih rendah. </p><br><p>  Harap waspadai bahwa klien sangat tergantung pada ketersediaan data di / dev / urandom.  Mungkin perlu waktu hingga klien benar-benar mulai berjalan, jika Anda sudah menjalankannya sekali.  Jadi tunggu saja mereka untuk mulai bekerja, maka mereka cukup cepat pada apa yang mereka lakukan.  Pantau saja dengan <em>top</em> jika instance LAppS benar-benar melakukan pekerjaan apa pun.  Jika / dev / urandom habis maka LAppS tidak akan memakan CPU Anda sampai ada beberapa data yang tersedia. </p><br><h1 id="preparing-for-big-tests">  Bersiap untuk ujian besar </h1><br><p>  Pertama-tama kita perlu membuat beberapa perubahan pada parameter kernel dan jangan lupa ulimit untuk file terbuka.  Saya menggunakan pengaturan yang hampir sama seperti di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> ini. </p><br><p>  Buat file dengan konten berikut </p><br><pre> <code class="bash hljs">: sysctl -w fs.file-max=14000000 sysctl -w fs.nr_open=14000000 <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -n 14000000 sysctl -w net.ipv4.tcp_mem=<span class="hljs-string"><span class="hljs-string">"100000000 100000000 100000000"</span></span> sysctl -w net.core.somaxconn=20000 sysctl -w net.ipv4.tcp_max_syn_backlog=20000 sysctl -w net.ipv4.ip_local_port_range=<span class="hljs-string"><span class="hljs-string">"1025 65535"</span></span></code> </pre> <br><p>  Kemudian gunakan <em>source ./filename</em> di kedua server untuk mengubah parameter kernel dan ulimit. </p><br><p>  Kali ini tujuan saya adalah membuat beberapa juta klien di satu server dan menghubungkan mereka ke server kedua. </p><br><p>  Server A akan berfungsi sebagai sisi server layanan gema WebSockets. <br>  Server B akan berfungsi sebagai sisi klien layanan WebSockets echo. </p><br><p>  Ada batasan dalam LAppS yang diberlakukan oleh LuaJIT.  Anda hanya dapat menggunakan RAM 2GB per LuaJIT VM.  Itu adalah batas RAM yang dapat Anda gunakan dalam instance LAppS tunggal untuk semua layanan, karena layanan adalah utas yang terkait dengan satu instance libluajit.  Jika salah satu layanan Anda yang berjalan dalam satu contoh LAppS melebihi batas ini maka semua layanan akan kehabisan memori. </p><br><p>  Saya menemukan bahwa per instance LAppS Anda tidak dapat membuat lebih dari 2.464.000 klien WebSockets dengan ukuran pesan 64 byte.  Ukuran pesan mungkin sedikit mengubah batas ini, karena LAppS meneruskan pesan ke layanan <em>cws</em> dengan mengalokasikan ruang untuk pesan ini dalam LuaJIT. </p><br><p>  Ini menyiratkan bahwa saya harus memulai beberapa instance LAppS dengan konfigurasi yang sama pada Server B untuk membangun lebih dari 2,4 juta WebSockets.  Server A (server gema) tidak menggunakan banyak memori di sisi LuaJIT, sehingga satu contoh LAppS akan menangani 12,3 juta WebSockets tanpa masalah. </p><br><p>  Mari kita siapkan dua konfigurasi berbeda untuk server A dan B. </p><br><div class="spoiler">  <b class="spoiler_title">Server A ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5084</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">2000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Server A lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Server B ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"deny"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Server A memiliki dua antarmuka: </p><br><ul><li>  bond0 - xx203.37 </li><li>  bond1 - xx23.10 </li></ul><br><p>  Satu lebih cepat yang lain lebih lambat tetapi tidak terlalu penting.  Server akan berada di bawah beban yang berat. </p><br><p>  Mari kita siapkan templat dari /opt/lapps/benchmark/benchmark.lua </p><br><div class="spoiler">  <b class="spoiler_title">benchmark.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">10000</span></span>; benchmark.target_port=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.target_prefix=<span class="hljs-string"><span class="hljs-string">"wss://IPADDR:"</span></span>; benchmark.target_postfix=<span class="hljs-string"><span class="hljs-string">"/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> benchmark.target_port=<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">5084</span></span>,<span class="hljs-number"><span class="hljs-number">5307</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target_prefix..benchmark.target_port..benchmark.target_postfix, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- force garbage collection on connection failure. end -- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><p>  Mari kita menyimpan alamat IP Server A ke file masing-masing IP1 dan IP2 lalu: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir -p /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> sed -e <span class="hljs-string"><span class="hljs-string">"s/IPADDR/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat IP1)</span></span></span><span class="hljs-string">/g"</span></span> /opt/lapps/apps/benchmark/benchmark.lua &gt; /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>.lua <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Sekarang kita memodifikasi /opt/lapps/etc/conf/lapps.json di Server B untuk menggunakan dua layanan benchmark ini: </p><br><div class="spoiler">  <b class="spoiler_title">Server B lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"benchmark1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"benchmark2"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] } } }</code> </pre> </div></div><br><p>  Apakah kita siap?  Tidak, tidak.  Karena kami bermaksud untuk menghasilkan 2 240.000 soket keluar hanya untuk dua alamat dan kami membutuhkan lebih banyak port di sisi server.  Tidak mungkin membuat lebih dari 64k koneksi ke ip yang sama: port pair (sebenarnya sedikit kurang dari 64k). </p><br><p>  Pada Server A dalam file LAppS / include / wsServer.h ada fungsi void startListeners ().  Dalam fungsi ini kita akan mengganti baris 126 </p><br><pre> <code class="plaintext hljs">LAppSConfig::getInstance()-&gt;getWSConfig()["port"],</code> </pre> <br><p>  dengan ini: </p><br><pre> <code class="plaintext hljs">static_cast&lt;int&gt;(LAppSConfig::getInstance()-&gt;getWSConfig()["port"])+i,</code> </pre> <br><p>  Membangun kembali LAppS: </p><br><pre> <code class="bash hljs">make CONF=Release.AVX2 install</code> </pre> <br><h1 id="running-the-tests-for-2-240-000-client-websockets">  Menjalankan tes untuk 2 240.000 klien WebSockets. </h1><br><p>  Mulai LAppS di Server B, kemudian mulai LAppS di Server B dan arahkan output ke file seperti ini: </p><br><pre> <code class="bash hljs">/opt/lapps/bin/lapps.avx2 &gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Edit, NB: </p><br><pre> <code class="plaintext hljs">if you want to run several LAppS instances, then create separate directory for each instnace (like run1,run2, etc) and run each instance from within these directories. This is required for lapps.log file and of course for resulting standard output, for not to be overlapped/overwritten by concurrent LAppS instances.</code> </pre> <br><p>  Ini mungkin memerlukan waktu hingga semua koneksi terjalin.  Mari kita memantau perkembangannya. </p><br><p>  Jangan menggunakan netstat untuk menonton koneksi yang sudah ada, itu tidak ada gunanya ketika ia berjalan tanpa batas setelah seperti koneksi 150k yang dibuat dalam beberapa detik.  Lihatlah lapps.log di Server A, di direktori tempat Anda berada ketika memulai LAppS.  Anda dapat menggunakan one-liner berikut untuk melihat bagaimana koneksi dibuat dan bagaimana mereka didistribusikan di antara IOWorkers: </p><br><pre> <code class="bash hljs">date;awk <span class="hljs-string"><span class="hljs-string">'/ will be added to connection pool of worker/{a[$22]++}END{for(i in a){ print i, a[i]; sum+=a[i]} print sum}'</span></span> lapps.log | sort -n;date</code> </pre> <br><p>  Berikut adalah gagasan tentang seberapa cepat koneksi ini dibuat: </p><br><pre> <code class="plaintext hljs">375874 Sun Jul 21 20:33:07 +06 2019 650874 Sun Jul 21 20:34:42 +06 2019 2894 connections per second 1001874 Sun Jul 21 20:36:45 +06 2019 2974 connections per second 1182874 Sun Jul 21 20:37:50 +06 2019 2784 connections per second 1843874 Sun Jul 21 20:41:44 +06 2019 2824 connections per second 2207874 Sun Jul 21 20:45:43 +06 2019 3058 connections per second</code> </pre><br><p>  Di Server B kami dapat memeriksa jumlah tolok ukur yang telah selesai dibuat koneksi mereka: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep Sockets log | wc -l 224</span></span></code> </pre> <br><p>  Setelah Anda melihat bahwa angkanya 224, biarkan server bekerja sebentar, pantau penggunaan CPU dan memori dengan yang teratas.  Anda mungkin melihat sesuatu seperti ini (Server B di sebelah kiri dan Server A di sebelah kanan): </p><br><p><img src="https://habrastorage.org/webt/e0/vy/sv/e0vysvislttrfhwpn_vexnwseli.png" alt="gambar"></p><br><p>  Atau seperti ini (Server B di sebelah kiri dan Server A di sebelah kanan): </p><br><p><img src="https://habrastorage.org/webt/p1/cj/qk/p1cjqk6fxmthbnnexc2ikco9d6a.png"></p><br><p>  Ini jelas Server B, di mana layanan klien patokan berjalan, berada di bawah beban berat.  Server A berada di bawah beban berat juga tetapi tidak selalu.  Beberapa kali itu menggigil sementara Server B berjuang dengan sejumlah tugas untuk dikerjakan.  Penyandian lalu lintas pada TLS sangat intensif menggunakan CPU. </p><br><p>  Mari kita hentikan server (tekan Ctrl-C beberapa kali) dan modifikasi log seperti sebelumnya tetapi sehubungan dengan perubahan jumlah layanan benchmark (224): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G224/Sockets\n224\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span> awk -v avg=0 <span class="hljs-string"><span class="hljs-string">'{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*224}'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Anda mungkin ingin menghapus beberapa baris terakhir juga, untuk memperhitungkan hasil cetak dari menghentikan layanan benchmark.  Anda sudah punya ide tentang cara melakukan ini.  Jadi saya akan memposting hasil untuk berbagai skenario pengujian dan melanjutkan dengan masalah yang saya hadapi. </p><br><h1 id="results-for-all-the-other-tests-49-million-and-beyond">  Hasil untuk semua tes lainnya (4,9 juta dan lebih) </h1><br><p><img src="https://habrastorage.org/webt/az/4a/at/az4aatexickfttbrom2gg3yrymu.png"></p><br><div class="spoiler">  <b class="spoiler_title">uji beban # 4</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ra/ka/_f/raka_fia7i2vnqhwh2p-5lnulc8.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">uji beban # 5</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ln/z5/ml/lnz5mlaoz7aclxuyvjwjpwj25jm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Tes # 5 seimbang untuk berbagi CPU yang sama</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vi/cy/fe/vicyfenhzk7uvcjsiohq950c9fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">tes # 6</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7h/bg/ez/7hbgezb4zxuv3ijuemjmkilf110.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">tes # 8</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gq/5_/uj/gq5_uje-nnkfhlqmilb7xnbu5tc.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">tes # 12</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xa/tr/m9/xatrm9dbbaha13w9wjxzmecvxjm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">tes # 13</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-w/9t/i8/-w9ti8atzczna-9dvepihihlyqu.png"></p></div></div><br><h1 id="problems">  Masalah </h1><br><p>  Ditandai dalam tabel di atas dengan warna merah. </p><br><p>  Menjalankan lebih dari 224 instance benchmark pada Server B terbukti merupakan ide yang buruk, karena server di sisi klien tidak mampu mendistribusikan waktu CPU secara merata di antara proses / utas.  224 instance benchmark pertama yang telah membangun semua koneksi mereka mengambil sebagian besar sumber daya CPU dan sisa instance benchmark tertinggal.  Bahkan menggunakan renice -20 tidak banyak membantu (448 instance benchmark, 2 instance LAppS): </p><br><div class="spoiler">  <b class="spoiler_title">448 contoh benchmark</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/a2/ms/bg/a2msbgjgzuwvzzdl332linmmq98.png"><br>  Server B (sisi kiri) berada di bawah beban yang sangat berat dan Server A masih memiliki sumber daya CPU gratis. </p></div></div><br><p>  Jadi saya menggandakan <strong>benchmark.max_connections</strong> daripada memulai lebih banyak contoh LAppS yang terpisah. </p><br><p>  Masih untuk menjalankan 12,3 juta WebSockets, saya sudah memulai instance LAppS ke-5 (tes 5 dan 6) tanpa menghentikan empat yang sudah berjalan.  Dan memainkan peran CFQ dengan menangguhkan dan memulai kembali proses yang diprioritaskan secara manual dengan <em>kill -STOP / -CONT</em> atau / dan mengubah prioritas mereka.  Anda dapat menggunakan skrip templat berikut untuk ini: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ]; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -STOP &lt;4 fast-processes pids&gt; sleep 10 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -CONT &lt;4 fast-processes pids&gt; sleep 5 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Selamat datang di 2019 RHEL 7.6!  Jujur, saya menggunakan perintah renice pertama kali sejak 2009. Yang terburuk, - saya menggunakannya hampir tidak berhasil kali ini. </p><br><p>  Saya punya masalah dengan mesin pencar-pencar NIC.  Jadi saya menonaktifkannya untuk beberapa tes, tidak benar-benar menandai acara ini ke dalam tabel. </p><br><p>  Saya mengalami gangguan tautan parsial di bawah beban berat dan bug driver NIC, jadi saya harus membuang hasil tes terkait. </p><br><h1 id="end-of-story">  Akhir cerita </h1><br><p>  Jujur, tes berjalan lebih lancar dari yang saya perkirakan. </p><br><p>  Saya yakin bahwa saya belum berhasil memuat LAppS di Server A hingga potensi penuhnya (tanpa SSL), karena saya tidak memiliki cukup sumber daya CPU untuk sisi klien.  Meskipun dengan TLS 1.3 diaktifkan, LAppS di Server A memanfaatkan hampir semua sumber daya CPU yang tersedia. </p><br><p>  Saya masih yakin bahwa LAppS adalah server open source WebSockets paling scalable dan tercepat di luar sana dan modul klien <strong>cws</strong> WebSockets adalah satu-satunya dari jenisnya, menyediakan kerangka kerja untuk pengujian beban tinggi. </p><br><p>  Harap verifikasi hasilnya pada perangkat keras Anda sendiri. </p><br><p>  Catatan saran: Jangan pernah menggunakan nginx atau apache sebagai penyeimbang beban atau sebagai proxy-pass untuk WebSockets, atau Anda akan berakhir memotong kinerja berdasarkan urutan besarnya.  Mereka tidak membangun untuk WebSockets. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id460847/">https://habr.com/ru/post/id460847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id460837/index.html">Buku Pegangan Podcast Pemula</a></li>
<li><a href="../id460839/index.html">Peluncuran Predator - Repositori Data Terkompilasi</a></li>
<li><a href="../id460841/index.html">Aplikasi Pembelajaran Bahasa TOP-23</a></li>
<li><a href="../id460843/index.html">Memperkenalkan 3CX Call Flow Designer Baru dan Generator Template 3CX CRM</a></li>
<li><a href="../id460845/index.html">Fernando Corbato, bapak komputer Anda (dan kata sandi), meninggal pada usia 93</a></li>
<li><a href="../id460849/index.html">Bagian 4. Model grafik untuk menghitung fungsi logis untuk proses paralel asinkron</a></li>
<li><a href="../id460851/index.html">SamsPcbGuide, Bagian 10: Teknologi - Komponen Bebas Timah Solder</a></li>
<li><a href="../id460855/index.html">Bagaimana cara menggunakan PHP untuk mengimplementasikan layanan microser?</a></li>
<li><a href="../id460857/index.html">Bagaimana Namecoin Blockchain Research Memprediksi Serangan Cyber ​​RTM</a></li>
<li><a href="../id460859/index.html">Konferensi IThink # 3 di Kharkov - berdasarkan WWDC 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>