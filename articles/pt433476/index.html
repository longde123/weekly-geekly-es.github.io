<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå∫ üåú üí¨ 50 tons de aipo ‚úîÔ∏è üíÖüèª üåõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voc√™ est√° aqui se quiser saber como domesticar uma estrutura amplamente conhecida nos c√≠rculos de desenvolvedores de Python chamada Celery. E mesmo qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>50 tons de aipo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/433476/">  Voc√™ est√° aqui se quiser saber como domesticar uma estrutura amplamente conhecida nos c√≠rculos de desenvolvedores de Python chamada Celery.  E mesmo que o Celery execute com confian√ßa comandos b√°sicos em seu projeto, a experi√™ncia na fintech pode abrir lados desconhecidos para voc√™.  Porque o fintech √© sempre Big Data e, com ele, a necessidade de tarefas em segundo plano, processamento em lote, API ass√≠ncrona, etc. <br><img src="https://habrastorage.org/webt/oc/8a/rn/oc8arnnknqs37365anrx9mvuuru.jpeg"><br><br>  A beleza da hist√≥ria de Oleg Churkin sobre o aipo no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moscow Python Conf ++,</a> al√©m de instru√ß√µes detalhadas sobre como configurar o aipo sob carga e como monitor√°-lo, √© que voc√™ pode emprestar id√©ias √∫teis. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/SxgzHz-zE-c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>Sobre o palestrante e o projeto:</strong> Oleg Churkin ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Bahusss</a> ) desenvolve projetos em Python de v√°rias complexidades h√° 8 anos, trabalhou em muitas empresas conhecidas: Yandex, Rambler, RBC, Kaspersky Lab.  Agora, techlide na inicializa√ß√£o do fintech-StatusPoney. <br><a name="habracut"></a><br>  O projeto trabalha com uma grande quantidade de dados financeiros de usu√°rios (1,5 terabytes): contas, transa√ß√µes, comerciantes, etc.  Ele executa at√© um milh√£o de tarefas todos os dias.  Talvez esse n√∫mero n√£o pare√ßa realmente grande para algu√©m, mas para uma pequena startup com capacidades modestas, essa √© uma quantidade significativa de dados, e os desenvolvedores tiveram que enfrentar v√°rios problemas no caminho para um processo est√°vel. <br><br>  Oleg falou sobre os principais pontos do trabalho: <br><br><ul><li>  Quais tarefas voc√™ deseja resolver com a estrutura, por que voc√™ escolheu o Aipo. </li><li>  Como o aipo ajudou. </li><li>  Como configurar o aipo sob carga. </li><li>  Como monitorar o status do aipo. </li></ul><br>  E ele compartilhou alguns utilit√°rios de design que implementam a funcionalidade ausente no Celery.  Como se viu, em 2018, e isso pode ser.  A seguir, √© apresentada uma vers√£o em texto do relat√≥rio na primeira pessoa. <br><br><h2>  Edi√ß√£o <br></h2><br>  Foi necess√°rio resolver as seguintes tarefas: <br><br><ul><li>  Execute <strong>tarefas em segundo plano separadas</strong> . </li><li>  Fa√ßa o <strong>processamento em lote de tarefas</strong> , ou seja, execute v√°rias tarefas ao mesmo tempo. </li><li>  Incorporar o processo <strong>Extrair, Transformar, Carregar</strong> . </li><li>  Implemente a <strong>API ass√≠ncrona</strong> .  Acontece que a API ass√≠ncrona pode ser implementada n√£o apenas usando estruturas ass√≠ncronas, mas tamb√©m completamente s√≠ncrona; </li><li> Execute <strong>tarefas peri√≥dicas</strong> .  Nem um √∫nico projeto pode prescindir de tarefas peri√≥dicas; para alguns, Cron pode ser dispensado, mas existem ferramentas mais convenientes. </li><li>  Construa uma <strong>arquitetura de acionador</strong> : para acionar um acionador, execute uma tarefa que atualize os dados.  Isso √© feito para compensar a falta de energia em tempo de execu√ß√£o pr√©-computando dados em segundo plano. </li></ul><br>  <strong>As tarefas em segundo plano</strong> incluem qualquer tipo de notifica√ß√£o: email, push, √°rea de trabalho - tudo isso √© enviado em tarefas em segundo plano por um gatilho.  Da mesma maneira, uma atualiza√ß√£o peri√≥dica dos dados financeiros √© iniciada. <br><br>  Em segundo plano, v√°rias verifica√ß√µes espec√≠ficas s√£o realizadas, por exemplo, verificando se h√° fraude em um usu√°rio.  Nas startups financeiras, <strong>√© prestado muito esfor√ßo e aten√ß√£o especificamente √† seguran√ßa dos dados</strong> , pois permitimos que os usu√°rios adicionem suas contas banc√°rias ao nosso sistema e podemos ver todas as suas transa√ß√µes.  Os fraudadores podem tentar usar nosso servi√ßo para algo ruim, por exemplo, para verificar o saldo de uma conta roubada. <br><br>  A √∫ltima categoria de tarefas em segundo plano s√£o <strong>as tarefas de manuten√ß√£o</strong> : ajustar algo, ver, corrigir, monitorar etc. <br><br>  Para notifica√ß√µes em massa, o <strong>processamento em lote √© usado</strong> .  Uma grande quantidade de dados que recebemos de nossos usu√°rios deve ser calculada e processada de uma certa maneira, incluindo  no modo de lote. <br><br>  O mesmo conceito inclui o cl√°ssico <strong>Extrair, Transformar, Carregar</strong> : <br><br><ul><li>  carregar dados de fontes externas (API externa); </li><li>  mantenha n√£o processado; </li><li>  executar tarefas que leem e processam dados; </li><li>  salvamos os dados processados ‚Äã‚Äãno lugar certo, no formato certo, para que mais tarde seja conveniente usar na interface do usu√°rio, por exemplo. </li></ul><br>  N√£o √© segredo que a API ass√≠ncrona pode ser feita com uma simples solicita√ß√£o de pesquisa: o front-end inicia o processo no back-end, o back-end inicia uma tarefa que se lan√ßa periodicamente, "derrama" os resultados e atualiza o estado no banco de dados.  O frontend mostra ao usu√°rio que esse estado interativo est√° mudando.  Isso permite que voc√™: <br><br><ul><li>  executar tarefas de pesquisa de outras tarefas; </li><li>  execute tarefas diferentes, dependendo das condi√ß√µes. </li></ul><br>  Em nosso servi√ßo, isso √© suficiente por enquanto, mas no futuro provavelmente teremos que reescrever outra coisa. <br><br><h2>  Requisitos da ferramenta <br></h2><br>  Para implementar essas tarefas, t√≠nhamos os seguintes requisitos para ferramentas: <br><br><ul><li>  Funcionalidade necess√°ria para realizar nossas ambi√ß√µes. </li><li>  <strong>Escalabilidade</strong> sem muletas. </li><li>  <strong>Monitorando o</strong> sistema para entender como ele funciona.  N√≥s usamos relat√≥rios de bugs, ent√£o a integra√ß√£o com o Sentry n√£o ficar√° fora do lugar, com o Django tamb√©m. </li><li>  <strong>Desempenho</strong> , porque temos muitas tarefas. </li><li>  Maturidade, confiabilidade e desenvolvimento ativo s√£o coisas √≥bvias.  Est√°vamos procurando uma ferramenta que ser√° suportada e desenvolvida. </li><li>  Adequa√ß√£o da documenta√ß√£o - <strong>sem documenta√ß√£o em nenhum lugar</strong> . </li></ul><br><h2>  Qual ferramenta escolher? <br></h2><br>  Quais s√£o as op√ß√µes no mercado em 2018 para resolver esses problemas? <br><br>  Era uma vez para tarefas menos ambiciosas, escrevi uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> √∫til que ainda √© usada em alguns projetos.  √â f√°cil de operar e executa tarefas em segundo plano.  Mas, ao mesmo tempo, n√£o s√£o necess√°rios corretores (nem o Celery nem outros), apenas o servidor de aplicativos <strong>uwsgi</strong> , que possui um spooler, √© algo que come√ßa como um trabalhador separado.  Esta √© uma solu√ß√£o muito simples - todas as tarefas s√£o armazenadas condicionalmente em arquivos.  Para projetos simples, basta, mas para os nossos, n√£o √© suficiente. <br><br>  De alguma forma, consideramos: <br><br><ul><li>  Aipo (10 mil estrelas no GitHub); </li><li>  RQ (5 mil estrelas no GitHub); </li><li>  Huey (2 mil estrelas no GitHub); </li><li>  Dramatiq (1 mil estrelas no GitHub); </li><li>  Tasktiger (estrelas de 0,5 mil no GitHub); </li><li>  Fluxo de ar?  Luigi </li></ul><br><h2>  Candidato promissor 2018 <br></h2><br>  Agora, gostaria de chamar sua aten√ß√£o para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dramatiq</a> .  Esta √© uma biblioteca do adepto do aipo, que conhecia todas as desvantagens do aipo e decidiu reescrever tudo, muito bem.  Benef√≠cios do Dramatiq: <br><br><ul><li>  Um conjunto de todos os recursos necess√°rios. </li><li>  Afiando a produtividade. </li><li>  Suporte de m√©tricas e sentinelas para o Prometheus pronto para uso </li><li>  Uma base de c√≥digo pequena e claramente escrita, carregamento autom√°tico de c√≥digo. </li></ul><br>  H√° algum tempo, Dramatiq teve problemas com licen√ßas: primeiro houve AGPL, depois foi substitu√≠do por LGPL.  Mas agora voc√™ pode tentar. <br><br>  Mas em 2016, al√©m do aipo, n√£o havia nada de especial para levar.  Gostamos da sua rica funcionalidade e, ent√£o, ela se adequava idealmente √†s nossas tarefas, porque mesmo assim era madura e funcional: <br><br><ul><li>  teve tarefas peri√≥dicas prontas para uso; </li><li>  apoiou v√°rios corretores; </li><li>  Integrado com Django e Sentry. </li></ul><br><h2>  Recursos do projeto <br></h2><br>  Vou falar sobre o nosso contexto, para que a hist√≥ria seja mais clara. <br><br>  Usamos o <strong>Redis como um intermedi√°rio de mensagens</strong> .  Ouvi muitas hist√≥rias e rumores de que o Redis est√° perdendo mensagens, que n√£o est√° adaptado para ser um intermedi√°rio de mensagens.  Na experi√™ncia de produ√ß√£o, isso n√£o est√° confirmado, mas, como se v√™, o Redis agora funciona mais eficientemente que o RabbitMQ (√© com o Celery, pelo menos, aparentemente, o problema est√° no c√≥digo de integra√ß√£o com os corretores).  Na vers√£o 4, o corretor Redis foi corrigido, ele realmente parou de perder tarefas durante as reinicializa√ß√µes e funciona de maneira bastante est√°vel.  Em 2016, o Celery abandonaria o Redis e se concentraria na integra√ß√£o com o RabbitMQ, mas, felizmente, isso n√£o aconteceu. <br><br>  Em caso de problemas com o Redis, se precisarmos de alta disponibilidade s√©ria, n√≥s, porque usamos o poder da Amazon, mudaremos para o Amazon SQS ou o Amazon MQ. <br><br>  N√£o <strong>usamos backend de resultados para armazenar os resultados</strong> , porque preferimos armazenar os resultados onde queremos e verific√°-los da maneira que queremos.  N√£o queremos que o aipo fa√ßa isso por n√≥s. <br><br>  Usamos um <strong>pool de pefork</strong> , ou seja, trabalhadores de processo que criam bifurca√ß√µes de processos separados para simultaneidade adicional. <br><br><h2>  Unidade de trabalho <br></h2><br>  Discutiremos os elementos b√°sicos para atualizar aqueles que ainda n√£o experimentaram o aipo, mas que apenas o far√£o.  <strong>Unidade de trabalho para o aipo √© um desafio</strong> .  Vou dar um exemplo de uma tarefa simples que envia um email. <br><br>  Fun√ß√£o simples e decorador: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@current_app.task def send_email(email: str): print(f'Sending email to email={email}')</span></span></code> </pre> <br>  O in√≠cio da tarefa √© simples: chamamos a fun√ß√£o e a tarefa ser√° executada em tempo de execu√ß√£o (send_email (email = "python@example.com")) ou no trabalhador, ou seja, o pr√≥prio efeito da tarefa em segundo plano: <br><br><pre> <code class="python hljs">send_email.delay(email=<span class="hljs-string"><span class="hljs-string">"python@example.com"</span></span>) send_email.apply_async( kwargs={email: <span class="hljs-string"><span class="hljs-string">"python@example.com"</span></span>} )</code> </pre><br>  Por dois anos trabalhando com o aipo sob altas cargas, criamos as regras de boa forma.  Houve muitos ancinhos, aprendemos a contorn√°-los e vou compartilhar como. <br><br><h4>  Code Design <br></h4><br>  A tarefa pode conter uma l√≥gica diferente.  Em geral, o Aipo ajuda a manter as tarefas em arquivos ou pacotes ou a import√°-las de algum lugar.  √Äs vezes, voc√™ obt√©m uma pilha de l√≥gica de neg√≥cios em um m√≥dulo.  Em nossa opini√£o, a abordagem correta do ponto de vista da modularidade do aplicativo √© manter um <strong>m√≠nimo de l√≥gica na tarefa</strong> .  Usamos quebra-cabe√ßas apenas como "gatilhos" do c√≥digo.  Ou seja, a tarefa n√£o possui l√≥gica em si mesma, mas aciona o lan√ßamento do c√≥digo em segundo plano. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@celery_app.task(queue='...') def run_regular_update(provider_account_id, *args, **kwargs): """...""" flow = flows.RegularSyncProviderAccountFlow(provider_account_id) return flow.run(*args, **kwargs)</span></span></code> </pre><br>  Colocamos todo o c√≥digo em classes externas que usam outras classes.  Todas as tarefas consistem essencialmente em duas linhas. <br><br><h4>  Objetos simples em par√¢metros <br></h4><br>  No exemplo acima, um determinado ID √© passado para a tarefa.  Em todas as tarefas que usamos, <strong>transferimos apenas pequenos dados escalares</strong> , id.  N√£o serializamos modelos do Django para transmiti-los.  Mesmo no ETL, quando um grande blob de dados vem de um servi√ßo externo, primeiro o salvamos e, em seguida, executamos uma tarefa que l√™ todo esse blob por id e o processa. <br><br>  Se voc√™ n√£o fizer isso, vimos uma mistura muito grande de mem√≥ria consumida no Redis.  A mensagem come√ßa a ocupar mais mem√≥ria, a rede est√° muito carregada, o n√∫mero de tarefas processadas (desempenho) diminui.  Desde que o objeto chegue √† conclus√£o, as tarefas se tornam irrelevantes, o objeto j√° foi exclu√≠do.  Os dados precisavam ser serializados - nem tudo est√° bem serializado no JSON no Python.  Precis√°vamos da oportunidade, ao tentar novamente as tarefas, para decidir rapidamente o que fazer com esses dados, obt√™-los novamente e executar algumas verifica√ß√µes. <br><br><blockquote>  Se voc√™ transferir dados grandes em par√¢metros, pense novamente!  √â melhor transferir um pequeno escalar com uma pequena quantidade de informa√ß√µes no problema e dessas informa√ß√µes na tarefa para obter tudo o que voc√™ precisa. <br></blockquote><br><h4>  Problemas Idempotentes <br></h4><br>  Os desenvolvedores de aipo recomendam essa abordagem.  Quando a se√ß√£o de c√≥digo √© repetida, nenhum efeito colateral deve ocorrer, o resultado deve ser o mesmo.  Isso nem sempre √© f√°cil de conseguir, especialmente se houver uma intera√ß√£o com muitos servi√ßos ou confirma√ß√µes de duas fases. <br><br>  Mas quando voc√™ faz tudo localmente, sempre pode verificar se os dados recebidos existem e s√£o relevantes, pode realmente trabalhar com eles e usar transa√ß√µes.  Se houver muitas consultas no banco de dados para uma tarefa e algo puder dar errado no tempo de execu√ß√£o, use transa√ß√µes para reverter altera√ß√µes desnecess√°rias. <br><br><h4>  Compatibilidade com vers√µes anteriores <br></h4><br>  Tivemos alguns efeitos colaterais interessantes quando implantamos o aplicativo.  Independentemente do tipo de implanta√ß√£o usada (atualiza√ß√£o azul + verde ou cont√≠nua), sempre haver√° uma situa√ß√£o em que o c√≥digo de servi√ßo antigo cria mensagens para o novo c√≥digo do trabalhador e vice-versa, o trabalhador antigo recebe mensagens do novo c√≥digo de servi√ßo, porque foi lan√ßado ‚Äúprimeiro‚Äù e l√° o tr√°fego passou. <br><br>  Detectamos erros e perdemos tarefas at√© aprendermos a manter a <strong>compatibilidade com vers√µes anteriores entre as vers√µes</strong> .  A compatibilidade com vers√µes anteriores √© que, entre os lan√ßamentos, as tarefas devem funcionar com seguran√ßa, independentemente dos par√¢metros que entram nessa tarefa.  Portanto, em todas as tarefas, agora estamos fazendo uma assinatura "borracha" (** kwargs).  Quando voc√™ precisar adicionar um novo par√¢metro no pr√≥ximo release, voc√™ o usar√° ** kwargs no novo release, mas n√£o no antigo - nada ser√° interrompido.  Assim que a assinatura √© alterada, e o Celery n√£o sabe disso, ela falha e gera um erro de que n√£o existe tal par√¢metro na tarefa. <br><br>  Uma maneira mais rigorosa de evitar esses problemas √© a vers√£o das filas de tarefas entre os lan√ßamentos, mas √© bastante dif√≠cil de implementar e a deixamos no backlog por enquanto. <br><br><h4>  Timeouts <br></h4><br>  Podem surgir problemas devido a n√∫meros insuficientes ou tempos limite incorretos. <br><br><blockquote>  N√£o definir um tempo limite para uma tarefa √© ruim.  Isso significa que voc√™ n√£o entende o que est√° acontecendo na tarefa, como a l√≥gica de neg√≥cios deve funcionar. <br></blockquote><br>  Portanto, todas as nossas tarefas s√£o interrompidas com tempos limite, incluindo globais para todas as tarefas, e tamb√©m s√£o definidos tempos limite para cada tarefa espec√≠fica. <br><br>  <strong>Deve ser afixado: soft_limit_timeout</strong> e <strong>expira.</strong> <br><br>  Expira √© quanto uma tarefa pode viver na linha.  √â necess√°rio que as tarefas n√£o se acumulem nas filas em caso de problemas.  Por exemplo, se agora queremos relatar algo ao usu√°rio, mas algo aconteceu, e a tarefa pode ser conclu√≠da apenas amanh√£ - isso n√£o faz sentido, amanh√£ a mensagem n√£o ser√° mais relevante.  Portanto, para notifica√ß√µes, expiramos razoavelmente pequenos. <br><br>  Observe o uso de <strong>eta (contagem regressiva) + visibilidade</strong> <strong>_timeout</strong> .  As perguntas frequentes descrevem esse problema com o Redis - o chamado tempo limite de visibilidade do broker Redis.  Por padr√£o, seu valor √© de uma hora: se ap√≥s uma hora o trabalhador v√™ que ningu√©m levou a tarefa para execu√ß√£o, ele a adiciona novamente √† fila.  Portanto, se a contagem regressiva for de duas horas, ap√≥s uma hora, o broker descobrir√° que essa tarefa ainda n√£o foi conclu√≠da e criar√° outra da mesma.  E em duas horas, duas tarefas id√™nticas ser√£o conclu√≠das. <br><br><blockquote>  Se o tempo estimado ou a contagem regressiva exceder 1 hora, provavelmente o uso do Redis resultar√° na duplica√ß√£o de tarefas, a menos que, √© claro, voc√™ tenha alterado o valor visible_timeout nas configura√ß√µes de conex√£o com o broker. <br></blockquote><br><h4>  Pol√≠tica de Repeti√ß√£o <br></h4><br>  Para as tarefas que podem ser repetidas ou que podem falhar, usamos a pol√≠tica de Repetir.  Mas n√≥s o usamos com cuidado para n√£o sobrecarregar os servi√ßos externos.  Se voc√™ repetir rapidamente as tarefas sem especificar um retorno exponencial, um servi√ßo externo, ou talvez interno, pode simplesmente n√£o suport√°-lo. <br><br>  Os par√¢metros <strong>retry_backoff</strong> , <strong>retry_jitter</strong> e <strong>max_retries</strong> seriam bons para especificar explicitamente, especialmente max_retries.  retry_jitter - um par√¢metro que permite trazer um pouco de caos para que as tarefas n√£o comecem a se repetir ao mesmo tempo. <br><br><h4>  Vazamentos de mem√≥ria <br></h4><br><blockquote>  Infelizmente, os vazamentos de mem√≥ria s√£o muito f√°ceis e √© dif√≠cil encontr√°-los e corrigi-los. </blockquote><br>  Em geral, trabalhar com mem√≥ria em Python √© muito controverso.  Voc√™ gastar√° muito tempo e nervosismo para entender por que o vazamento ocorre e, em seguida, acontece que ele n√£o est√° no seu c√≥digo.  Portanto, sempre, ao iniciar um projeto, coloque um <strong>limite de mem√≥ria no worker</strong> : worker_max_memory_per_child. <br><br>  Isso garante que o OOM Killer n√£o chegue um dia, n√£o mate todos os trabalhadores e voc√™ n√£o perca todas as tarefas.  O aipo reiniciar√° os trabalhadores quando necess√°rio. <br><br><h4>  Tarefas priorit√°rias <br></h4><br>  Sempre h√° tarefas que devem ser conclu√≠das antes de todos, mais r√°pido que qualquer outra pessoa - elas devem ser conclu√≠das agora mesmo!  Existem tarefas que n√£o s√£o t√£o importantes - que sejam conclu√≠das durante o dia.  Para isso, a tarefa possui um par√¢metro de <strong>prioridade.</strong>  No Redis, ele funciona de maneira bastante interessante - uma nova fila √© criada com um nome no qual a prioridade √© adicionada. <br><br>  Utilizamos uma abordagem diferente - <strong>separar trabalhadores para prioridades</strong> , ou seja,  √† moda antiga, criamos trabalhadores de aipo com diferentes "import√¢ncia": <br><br><pre> <code class="python hljs">celery multi start high_priority low_priority -c:high_priority <span class="hljs-number"><span class="hljs-number">2</span></span> -c:low_priority <span class="hljs-number"><span class="hljs-number">6</span></span> -Q:high_priority urgent_notifications -Q:low_priority emails,urgent_notifications</code> </pre><br>  O Celery multi start √© um auxiliar que ajuda voc√™ a executar toda a configura√ß√£o do Celery em uma m√°quina e na mesma linha de comando.  Neste exemplo, criamos n√≥s (ou trabalhadores): high_priority e low_priority, 2 e 6 s√£o simultaneidade. <br><br>  Dois trabalhadores de alta prioridade processam constantemente a fila de notifica√ß√µes urgentes.  Ningu√©m mais aceitar√° esses trabalhadores, eles apenas ler√£o tarefas importantes da fila de urg√™ncias. <br><br>  Para tarefas sem import√¢ncia, h√° uma fila de baixa prioridade.  Existem 6 trabalhadores que recebem mensagens de todas as outras filas.  Tamb√©m inscrevemos trabalhadores de baixa prioridade em notifica√ß√µes urgentes, para que possam ajudar se os trabalhadores de alta prioridade n√£o puderem lidar com isso. <br><br>  Usamos esse esquema cl√°ssico para priorizar tarefas. <br><br><h4>  Extrair, transformar, carregar <br></h4><br>  Na maioria das vezes, o ETL se parece com uma cadeia de tarefas, cada uma das quais recebe entrada da tarefa anterior. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@task def download_account_data(account_id) ‚Ä¶ return account_id @task def process_account_data(account_id, processing_type) ‚Ä¶ return account_data @task def store_account_data(account_data) ‚Ä¶</span></span></code> </pre><br>  O exemplo tem tr√™s tarefas.  O aipo tem uma abordagem para o processamento distribu√≠do e v√°rios utilit√°rios √∫teis, incluindo a fun√ß√£o de <strong>cadeia</strong> , que faz um pipeline de tr√™s dessas tarefas: <br><br><pre> <code class="python hljs">chain( download_account_data.s(account_id), process_account_data.s(processing_type=<span class="hljs-string"><span class="hljs-string">'fast'</span></span>), store_account_data.s() ).delay()</code> </pre><br>  O aipo desmontar√° o pipeline, executar√° a primeira tarefa em ordem, depois transferir√° os dados recebidos para o segundo e os dados que a segunda tarefa retornar√° para a terceira.  √â assim que implementamos pipelines simples de ETL. <br><br>  Para cadeias mais complexas, √© necess√°rio conectar l√≥gica adicional.  Mas √© importante ter em mente que, se um problema surgir nessa cadeia em uma tarefa, <strong>toda a cadeia desmoronar√°</strong> .  Se voc√™ n√£o deseja esse comportamento, lide com a exce√ß√£o e continue a execu√ß√£o ou pare toda a cadeia por exce√ß√£o. <br><br>  De fato, essa cadeia dentro parece uma grande tarefa, que cont√©m todas as tarefas com todos os par√¢metros.  Portanto, se voc√™ abusar do n√∫mero de tarefas na cadeia, obter√° um consumo de mem√≥ria muito alto e uma lentid√£o no processo geral.  <strong>Criar cadeias de milhares de tarefas √© uma m√° ideia.</strong> <br><br><h2>  Processamento de tarefas em lote <br></h2><br>  Agora, a coisa mais interessante: o que acontece quando voc√™ precisa enviar um email para dois milh√µes de usu√°rios. <br><br>  Voc√™ escreve essa fun√ß√£o para ignorar todos os usu√°rios: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@task def send_report_emails_to_users(): for user_id in User.get_active_ids(): send_report_email.delay(user_id=user_id)</span></span></code> </pre><br>  No entanto, na maioria das vezes a fun√ß√£o receber√° n√£o apenas a identifica√ß√£o do usu√°rio, mas tamb√©m lavar√° toda a tabela de usu√°rios em geral.  Cada usu√°rio ter√° sua pr√≥pria tarefa. <br><br>  Existem v√°rios problemas nesta tarefa: <br><br><ul><li>  As tarefas s√£o iniciadas seq√ºencialmente, ou seja, a √∫ltima tarefa (dois milh√µes de usu√°rios) ser√° iniciada em 20 minutos e, talvez, por esse tempo limite j√° funcione. </li><li>  Todo o ID do usu√°rio √© carregado primeiro na mem√≥ria do aplicativo e, em seguida, na fila - delay () executar√° 2 milh√µes de tarefas. </li></ul><br>  Eu chamei de inunda√ß√£o de tarefas, o gr√°fico se parece com isso. <br><img src="https://habrastorage.org/webt/j_/ya/6r/j_ya6r359licn16439uohbpoaow.png"><br>  H√° um afluxo de tarefas que os trabalhadores come√ßam lentamente a processar.  O seguinte acontece se as tarefas usam uma r√©plica master, todo o projeto come√ßa a quebrar, nada funciona.  Abaixo est√° um exemplo de nossa pr√°tica, em que o uso da CPU do banco de dados foi de 100% por v√°rias horas, para ser sincero, conseguimos ficar com medo. <br><img src="https://habrastorage.org/webt/ac/wh/jy/acwhjy96edpu3dry_vatxj5z7yw.png"><br>  O problema √© que o sistema est√° bastante degradado com um aumento no n√∫mero de usu√°rios.  A tarefa que lida com o planejamento: <br><br><ul><li>  requer mais e mais mem√≥ria; </li><li>  corre mais tempo e pode ser "morto" por tempo limite. </li></ul><br>  Ocorre inunda√ß√£o de tarefas: as tarefas se acumulam nas filas e criam uma grande carga n√£o apenas nos servi√ßos internos, mas tamb√©m nos externos. <br><br>  Tentamos <strong>reduzir a competitividade dos trabalhadores</strong> , isso ajuda em certo sentido - a carga no servi√ßo √© reduzida.  Ou voc√™ pode <strong>dimensionar servi√ßos internos</strong> .  Mas isso n√£o resolver√° o problema do gerador, que ainda leva muito.  E de forma alguma afeta a depend√™ncia no desempenho de servi√ßos externos. <br><br><h3>  Gera√ß√£o de tarefas <br></h3><br>  Decidimos seguir um caminho diferente.  Na maioria das vezes, n√£o precisamos executar todos os 2 milh√µes de tarefas no momento.  √â normal que o envio de notifica√ß√µes a todos os usu√°rios leve, por exemplo, 4 horas se essas cartas n√£o forem t√£o importantes. <br><br>  Primeiro, tentamos usar o <strong>Celery.chunks</strong> : <br><br><pre> <code class="python hljs">send_report_email.chunks( ({<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>: user.id} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> User.objects.active()), n=<span class="hljs-number"><span class="hljs-number">100</span></span> ).apply_async()</code> </pre><br>  Isso n√£o mudou a situa√ß√£o, porque, apesar do iterador, todo o user_id ser√° carregado na mem√≥ria.  E todos os trabalhadores recebem uma cadeia de tarefas e, embora os trabalhadores relaxem um pouco, n√£o ficamos satisfeitos com essa decis√£o no final. <br><br>  Tentamos definir <strong>rate_limit</strong> como workers para que eles processem apenas um certo n√∫mero de tarefas por segundo, e descobrimos que, na verdade, rate_limit especificado como para a tarefa √© rate_limit para o worker.  Ou seja, se voc√™ especificar rate_limit para a tarefa, isso n√£o significa que a tarefa ser√° executada 70 vezes por segundo.  Isso significa que o trabalhador executar√° 70 vezes por segundo e, dependendo do que voc√™ tem com os trabalhadores, esse limite pode mudar dinamicamente, ou seja,  limite real rate_limit * len (trabalhadores). <br><br>  Se o trabalhador iniciar ou parar, o total rate_limit ser√° alterado.  Al√©m disso, se suas tarefas forem lentas, toda a pr√©-busca na fila que preenche o trabalhador ficar√° obstru√≠da com essas tarefas lentas.  O trabalhador parece: ‚ÄúAh, eu tenho essa tarefa no rate_limit, n√£o posso mais realiz√°-la.  E todas as tarefas a seguir na fila s√£o exatamente as mesmas - deixe-as travar! ‚Äù  - e esperando. <br><br><h3>  Chunkificator <br></h3><br>  No final, decidimos escrever nossa pr√≥pria e criamos uma pequena biblioteca, chamada Chunkificator. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@task @chunkify_task(sleep_timeout=...l initial_chunk=...) def send_report_emails_to_users(chunk: Chunk): for user_id in User.get_active_ids(chunk=chunk): send_report_email.delay(user_id=user_id)</span></span></code> </pre><br>  Leva sleep_timeout e initial_chunk e chama a si pr√≥prio com um novo peda√ßo.  Chunk √© uma abstra√ß√£o sobre listas inteiras ou sobre listas de data ou data e hora.  Passamos um peda√ßo para uma fun√ß√£o que recebe usu√°rios apenas com esse peda√ßo e executa tarefas apenas para esse peda√ßo. <br><br>  Portanto, o gerador de tarefas executa apenas o n√∫mero de tarefas necess√°rias e n√£o consome muita mem√≥ria.  A imagem ficou assim. <br><img src="https://habrastorage.org/webt/yh/gg/h_/yhggh__vbzgiexxwskakp1nltrw.png"><br>  O destaque √© que usamos partes esparsas, ou seja, usamos inst√¢ncias no banco de dados como identifica√ß√£o de parte (algumas delas podem ser ignoradas, portanto, pode haver menos tarefas).  Como resultado, a carga ficou mais uniforme, o processo ficou mais longo, mas todos est√£o vivos e bem, a base n√£o est√° sobrecarregada. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A biblioteca √©</a> implementada para Python 3.6+ e est√° dispon√≠vel no GitHub.  Pretendo corrigir uma nuance, mas por enquanto o datetime-chunk precisa de um serializador de pickles - muitos n√£o ser√£o capazes de fazer isso. <br><br>  Algumas perguntas ret√≥ricas - de onde veio toda essa informa√ß√£o?  Como descobrimos que t√≠nhamos problemas?  Como voc√™ sabe que um problema logo se tornar√° cr√≠tico e voc√™ precisa come√ßar a resolv√™-lo? <br><br>  A resposta √©, obviamente, o monitoramento. <br><br><h2>  Monitoramento <br></h2><br>  Eu realmente gosto de monitorar, gosto de monitorar tudo e manter meu dedo no pulso.  Se voc√™ n√£o mantiver o dedo no pulso, pisar√° constantemente no rake. <br><br>  Perguntas padr√£o de monitoramento: <br><br><ul><li>  A configura√ß√£o atual do trabalhador / simultaneidade lida com a carga? </li><li>  Qual √© a degrada√ß√£o do tempo de execu√ß√£o da tarefa? </li><li>  Quanto tempo as tarefas ficam na fila?  De repente a fila j√° est√° cheia? </li></ul><br>  Tentamos v√°rias op√ß√µes.  O aipo tem uma interface <strong>CLI</strong> , √© bastante rico e fornece: <br><br><ul><li>  inspecionar - informa√ß√µes sobre o sistema; </li><li>  controle - gerencie as configura√ß√µes do sistema; </li><li>  purgar - limpar filas (for√ßa maior); </li><li>  events - UI do console para exibir informa√ß√µes sobre as tarefas que est√£o sendo executadas. </li></ul><br>  Mas √© dif√≠cil realmente monitorar alguma coisa.  √â mais adequado para babados locais, ou se voc√™ deseja alterar algum rate_limit no tempo de execu√ß√£o. <br><br>  <strong>Nota: voc√™</strong> precisa acessar o intermedi√°rio de produ√ß√£o para usar a interface CLI. <br><br>  <strong>O Aipo Flor</strong> permite que voc√™ fa√ßa a mesma coisa que a CLI, apenas atrav√©s da interface da web, e isso n√£o √© tudo.  Mas ele cria alguns gr√°ficos simples e permite alterar as configura√ß√µes em tempo real. <br><br>  Em geral, o Aipo Flor √© adequado apenas para ver como tudo funciona em pequenas configura√ß√µes.  Al√©m disso, ele suporta a API HTTP, o que √© conveniente se voc√™ estiver escrevendo automa√ß√£o. <br><br>  Mas decidimos <strong>por Prometeu.</strong>  Eles pegaram o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exportador</a> atual: vazamentos fixos de mem√≥ria;  m√©tricas adicionadas para tipos de exce√ß√£o;  m√©tricas adicionadas para o n√∫mero de mensagens nas filas;  Integrado com alertas no Grafana e se alegrar.  Tamb√©m est√° publicado no GitHub, voc√™ pode v√™-lo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h4>  Exemplos em Grafana <br></h4><br><img src="https://habrastorage.org/webt/wa/i3/yt/wai3ytvm4ewoiumfrlvn2gzq9eg.png"><br>  Estat√≠sticas acima para todas as exce√ß√µes: quais exce√ß√µes para quais tarefas.  Abaixo est√° o tempo para concluir as tarefas. <br><img src="https://habrastorage.org/webt/ae/l3/sf/ael3sfmjeve51s5jtui9fh_7ydq.png"><br><h2>  O que falta no aipo? <br></h2><br>  Esta √© uma estrutura frondosa, tem muitas coisas, mas estamos perdendo!  N√£o h√° recursos pequenos suficientes, como: <br><br><ul><li>  <strong>Recarregar automaticamente o c√≥digo durante o desenvolvimento</strong> - n√£o suporta este aipo - reinicie. </li><li>  <strong>As m√©tricas para Prometheus est√£o prontas</strong> para uso, mas Dramatiq pode. </li><li>  <strong>Suporte para</strong> <strong>bloqueio de tarefas</strong> - para que apenas uma tarefa seja executada por vez.  Voc√™ pode fazer isso sozinho, mas Dramatiq e Tasktiger t√™m um decorador conveniente que garante que todas as outras tarefas do mesmo tipo sejam bloqueadas. </li><li>  <strong>Limite de taxa para uma tarefa</strong> - n√£o para o trabalhador. </li></ul><br><h2>  Conclus√µes <br></h2><br>  Apesar do Celery ser um framework que muitos usam na produ√ß√£o, ele consiste em 3 bibliotecas - Celery, Kombu e Billiard.  Todas essas tr√™s bibliotecas s√£o desenvolvidas por co-desenvolvedores e podem liberar uma depend√™ncia e interromper seu assembly. <br><img src="https://habrastorage.org/webt/dv/np/52/dvnp52xxgjcwsbdwr3c15a86-ac.png"><br>  Portanto, espero que voc√™ j√° tenha resolvido de alguma forma e tenha tornado suas assembl√©ias determin√≠sticas. <br><br>  De fato, as conclus√µes n√£o s√£o t√£o tristes.  <strong>O aipo lida com suas tarefas</strong> em nosso projeto fintech sob nossa carga.  Adquirimos experi√™ncia que compartilhei com voc√™, e voc√™ pode aplicar nossas solu√ß√µes ou refin√°-las e tamb√©m superar todas as suas dificuldades. <br><br>  N√£o esque√ßa que o <strong>monitoramento deve ser uma parte essencial do seu projeto</strong> .  Somente atrav√©s do monitoramento voc√™ pode descobrir onde h√° algo errado, o que precisa ser corrigido, adicionado, corrigido. <br><br>  <strong>Orador de contato Oleg Churkin</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Bahusss</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">facebook</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> . <br><br><blockquote>  O pr√≥ximo grande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moscow Python Conf ++</a> ser√° realizado em Moscou <b>no dia 5 de abril</b> .  Este ano, tentaremos ajustar todos os benef√≠cios em um dia em um modo experimental.  N√£o haver√° menos relat√≥rios; alocaremos um fluxo inteiro para desenvolvedores estrangeiros de bibliotecas e produtos conhecidos.  Al√©m disso, sexta-feira √© um dia ideal para festas depois, o que, como voc√™ sabe, √© parte integrante da confer√™ncia sobre comunica√ß√£o. <br><br>  Participe da nossa confer√™ncia profissional em Python - envie seu relat√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , reserve seu ingresso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Enquanto isso, os preparativos est√£o em andamento, artigos sobre o Moscow Python Conf ++ 2018 aparecer√£o aqui. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433476/">https://habr.com/ru/post/pt433476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433456/index.html">Como convencer um cliente ou empresa a usar o Flutter</a></li>
<li><a href="../pt433458/index.html">Alguns benef√≠cios n√£o √≥bvios do Serverless for DevOps</a></li>
<li><a href="../pt433462/index.html">Verifica√ß√µes de sa√∫de e degrada√ß√£o gradual de sistemas distribu√≠dos</a></li>
<li><a href="../pt433472/index.html">Lan√ßamento do Unity 2018.3</a></li>
<li><a href="../pt433474/index.html">Pil√£o de dentro para fora. Como ele faz isso</a></li>
<li><a href="../pt433478/index.html">Por que o Django √© escolhido na Revista Tinkoff</a></li>
<li><a href="../pt433480/index.html">Hist√≥ria de Holivarny sobre linter</a></li>
<li><a href="../pt433482/index.html">Django sob microsc√≥pio</a></li>
<li><a href="../pt433486/index.html">O que de novo? A recupera√ß√£o de cart√µes de d√©bito n√£o banc√°rios</a></li>
<li><a href="../pt433488/index.html">Christmas Scrum Meetup Transmiss√£o UPD mitap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>