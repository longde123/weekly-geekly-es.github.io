<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’” ğŸ¥™ ğŸš‹ å¼‚å›½æ•°æ®ç»“æ„ï¼šä¿®æ”¹åçš„Merkle Patricia Trie ğŸ¬ ğŸ•¶ï¸ ğŸ„</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="â€œæˆ‘åº”è¯¥ç‰¢è®°æ‰€æœ‰è¿™äº›è¯¥æ­»çš„ç®—æ³•å’Œæ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„é­”é¬¼ï¼Ÿâ€ 


 å…³äºè¿™ä¸€ç‚¹ï¼Œå¯ä»¥å½’ç»“ä¸ºå¤§å¤šæ•°æœ‰å…³æŠ€æœ¯é‡‡è®¿é€šè¿‡çš„æ–‡ç« çš„è¯„è®ºã€‚ é€šå¸¸ï¼Œä¸»è¦çš„è®ºç‚¹æ˜¯ï¼Œä»¥ä¸€ç§æˆ–å¦ä¸€ç§æ–¹å¼ä½¿ç”¨çš„æ‰€æœ‰ä¸œè¥¿éƒ½å·²ç»è¢«å®æ–½äº†åæ¬¡ï¼Œå¹¶ä¸”è¿™ä½æ™®é€šç¨‹åºå‘˜ä¸å¤ªå¯èƒ½å¿…é¡»å¤„ç†ã€‚ å¥½å§ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šè¿™æ˜¯äº‹å®ã€‚ ä½†æ˜¯ï¼Œäº‹å®è¯æ˜ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¼‚å›½æ•°æ®ç»“æ„ï¼šä¿®æ”¹åçš„Merkle Patricia Trie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446558/"><p>  <em>â€œæˆ‘åº”è¯¥ç‰¢è®°æ‰€æœ‰è¿™äº›è¯¥æ­»çš„ç®—æ³•å’Œæ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„é­”é¬¼ï¼Ÿâ€</em> </p><br><p> å…³äºè¿™ä¸€ç‚¹ï¼Œå¯ä»¥å½’ç»“ä¸ºå¤§å¤šæ•°æœ‰å…³æŠ€æœ¯é‡‡è®¿é€šè¿‡çš„æ–‡ç« çš„è¯„è®ºã€‚ é€šå¸¸ï¼Œä¸»è¦çš„è®ºç‚¹æ˜¯ï¼Œä»¥ä¸€ç§æˆ–å¦ä¸€ç§æ–¹å¼ä½¿ç”¨çš„æ‰€æœ‰ä¸œè¥¿éƒ½å·²ç»è¢«å®æ–½äº†åæ¬¡ï¼Œå¹¶ä¸”è¿™ä½æ™®é€šç¨‹åºå‘˜ä¸å¤ªå¯èƒ½å¿…é¡»å¤„ç†ã€‚ å¥½å§ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šè¿™æ˜¯äº‹å®ã€‚ ä½†æ˜¯ï¼Œäº‹å®è¯æ˜ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½å¾—åˆ°äº†å®ç°ï¼Œä¸å¹¸çš„æ˜¯ï¼ˆæˆ–è€…å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ï¼‰ä»ç„¶å¿…é¡»åˆ›å»ºä¸€ä¸ªæ•°æ®ç»“æ„ã€‚ </p><br><p> ç¥ç§˜ä¿®é¥°çš„é»˜å…‹å°”Â·å¸•ç‰¹é‡Œå¤Â·ç‰¹é‡Œã€‚ </p><br><p> ç”±äºåœ¨å“ˆå‹ƒå°”æ ‘ä¸Šä»¥åŠåœ¨åª’ä»‹ä¸Šæ ¹æœ¬æ²¡æœ‰å…³äºè¿™æ£µæ ‘çš„ä¿¡æ¯-è¿˜æœ‰ä¸€ç‚¹ï¼Œæˆ‘æƒ³å‘Šè¯‰ä½ å®ƒæ˜¯å“ªç§åŠ¨ç‰©ï¼Œä»¥åŠå®ƒæ˜¯æ€ä¹ˆåƒçš„ã€‚ </p><br><p><img src="https://habrastorage.org/webt/mc/ar/6q/mcar6qnrhs1vh6noextlta_dpfo.png" alt="KDPV"></p><a name="habracut"></a><br><h2 id="chto-eto"> è¿™æ˜¯ä»€ä¹ˆ </h2><br><p>  <em>å…è´£å£°æ˜ï¼šå¯¹æˆ‘æ¥è¯´ï¼Œå®æ–½çš„ä¸»è¦ä¿¡æ¯æ¥æºæ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é»„çš®ä¹¦</a> ï¼Œä»¥åŠæºä»£ç <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">parity-ethereum</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">go-ethereum</a> ã€‚</em>  <em>å…³äºæŸäº›å†³å®šçš„åˆç†æ€§çš„ç†è®ºä¿¡æ¯å¾ˆå°‘ï¼Œå› æ­¤ï¼Œåšå‡ºæŸäº›å†³å®šçš„åŸå› çš„æ‰€æœ‰ç»“è®ºéƒ½æ˜¯æˆ‘ä¸ªäººçš„ã€‚</em>  <em>ä¸‡ä¸€æˆ‘åœ¨æŸä»¶äº‹ä¸Šå¼„é”™äº†ï¼Œæˆ‘ä¼šå¾ˆé«˜å…´åœ¨è¯„è®ºä¸­æ›´æ­£ã€‚</em> </p><br><p>  <em>æ ‘</em>æ˜¯ä½œä¸ºè¿æ¥çš„éå¾ªç¯å›¾çš„æ•°æ®ç»“æ„ã€‚ è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œæ¯ä¸ªäººéƒ½å¯¹æ­¤å¾ˆç†Ÿæ‚‰ã€‚ </p><br><p>  <em>å‰ç¼€æ ‘</em>æ˜¯æ ¹æ ‘ï¼Œå¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨é”®-å€¼å¯¹ï¼Œè¿™æ˜¯å› ä¸ºèŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šåŒ…å«è·¯å¾„ä¸€éƒ¨åˆ†ï¼ˆå‰ç¼€ï¼‰çš„èŠ‚ç‚¹å’ŒåŒ…å«å­˜å‚¨å€¼çš„å¶èŠ‚ç‚¹ã€‚ å½“ä¸”ä»…å½“ä½¿ç”¨é”®ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ ‘çš„æ ¹éƒ¨ä¸€ç›´èµ°åˆ°æœ€åæ‰¾åˆ°ä¸€ä¸ªå…·æœ‰å€¼çš„èŠ‚ç‚¹æ—¶ï¼Œæ ‘ä¸­æ‰ä¼šå­˜åœ¨ä¸€ä¸ªå€¼ã€‚ </p><br><p>  <em>PATRICIAæ ‘</em>æ˜¯ä¸€ä¸ªå‰ç¼€æ ‘ï¼Œå…¶ä¸­çš„å‰ç¼€æ˜¯äºŒè¿›åˆ¶çš„-ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½å­˜å‚¨æœ‰å…³ä¸€ä½çš„ä¿¡æ¯ã€‚ </p><br><p>  <em>Merkle</em>æ ‘æ˜¯åŸºäºæŸç§æ•°æ®é“¾æ„å»ºçš„å“ˆå¸Œæ ‘ï¼Œå°†è¿™äº›ç›¸åŒçš„å“ˆå¸Œè¡¨èšåˆä¸ºä¸€ä¸ªï¼ˆæ ¹ï¼‰ï¼Œå­˜å‚¨æœ‰å…³æ‰€æœ‰æ•°æ®å—çŠ¶æ€çš„ä¿¡æ¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹å“ˆå¸Œæ˜¯ä¸€ç§åŒºå—é“¾çŠ¶æ€çš„â€œæ•°å­—ç­¾åâ€ã€‚ è¿™ä¸ªä¸œè¥¿åœ¨åŒºå—é“¾ä¸­è¢«ç§¯æä½¿ç”¨ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ui/x4/nr/uix4nregm5i_dcxm5cgxsv27hjg.png" alt="åŠªåŠ›æ˜¯..."></p><br><p> æ€»è®¡ï¼šä¿®æ”¹è¿‡çš„Merkle Patricia Trieï¼ˆä»¥ä¸‹ç®€ç§°MPTï¼‰æ˜¯ä¸€ç§æ•£åˆ—æ ‘ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå¹¶ä¸”é”®ä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºã€‚ åˆ°åº•æ˜¯â€œä¿®æ”¹â€çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨ç¨åè®¨è®ºå®ç°æ—¶ä¼šå‘ç°ä¸€ç‚¹ã€‚ </p><br><h2 id="zachem-eto"> æ€ä¹ˆä¼šè¿™æ · </h2><br><p> åœ¨ä»¥å¤ªåŠé¡¹ç›®ä¸­ä½¿ç”¨MPTæ¥å­˜å‚¨æœ‰å…³å¸æˆ·ï¼Œäº¤æ˜“ï¼Œå…¶æ‰§è¡Œç»“æœä»¥åŠç³»ç»ŸåŠŸèƒ½æ‰€éœ€çš„å…¶ä»–æ•°æ®çš„æ•°æ®ã€‚ <br> ä¸åƒæ¯”ç‰¹å¸é‚£æ ·ï¼ŒçŠ¶æ€æ˜¯éšå¼çš„ï¼Œå¹¶ä¸”æ˜¯ç”±æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹è®¡ç®—çš„ï¼Œæ¯ä¸ªè´¦æˆ·çš„ä½™é¢ï¼ˆä»¥åŠä¸ä¹‹å…³è”çš„æ•°æ®ï¼‰ç›´æ¥å­˜å‚¨åœ¨ç©ºä¸­çš„åŒºå—é“¾ä¸Šã€‚ æ­¤å¤–ï¼Œå¿…é¡»ä»¥å¯†ç æ–¹å¼æä¾›æ•°æ®çš„ä½ç½®å’Œä¸å˜æ€§-å¾ˆå°‘æœ‰äººä¼šä½¿ç”¨å…¶ä¸­æ— éœ€å®¢è§‚åŸå› å³å¯æ›´æ”¹éšæœºè´¦æˆ·ä½™é¢çš„åŠ å¯†è´§å¸ã€‚ </p><br><p> ä»¥å¤ªåŠå¼€å‘äººå‘˜é¢ä¸´çš„ä¸»è¦é—®é¢˜æ˜¯åˆ›å»ºä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„å¯ä»¥æœ‰æ•ˆåœ°å­˜å‚¨é”®å€¼å¯¹ï¼ŒåŒæ—¶æä¾›å¯¹æ‰€å­˜å‚¨æ•°æ®çš„éªŒè¯ã€‚ äºæ˜¯MPTå‡ºç°äº†ã€‚ </p><br><h2 id="kak-eto"> æ€ä¹ˆäº† </h2><br><p>  MPTæ˜¯å‰ç¼€PATRICIAæ ‘ï¼Œå…¶ä¸­çš„é”®æ˜¯å­—èŠ‚åºåˆ—ã€‚ </p><br><p> è¿™æ£µæ ‘çš„è¾¹ç¼˜æ˜¯åŠå­—èŠ‚åºåˆ—ï¼ˆåŠå­—èŠ‚ï¼‰ã€‚ å› æ­¤ï¼Œä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šå¯å…·æœ‰åå…­ä¸ªåä»£ï¼ˆå¯¹åº”äºä»0x0åˆ°0xFçš„åˆ†æ”¯ï¼‰ã€‚ </p><br><p> èŠ‚ç‚¹åˆ†ä¸º3ç§ç±»å‹ï¼š </p><br><ul><li> åˆ†æ”¯èŠ‚ç‚¹ã€‚ ç”¨äºåˆ†æ”¯çš„èŠ‚ç‚¹ã€‚ æœ€å¤šåŒ…å«1åˆ°16ä¸ªåˆ°å­èŠ‚ç‚¹çš„é“¾æ¥ã€‚ ä¹Ÿå¯èƒ½åŒ…å«ä¸€ä¸ªå€¼ã€‚ </li><li> æ‰©å±•èŠ‚ç‚¹ã€‚ ä¸€ä¸ªè¾…åŠ©èŠ‚ç‚¹ï¼Œå­˜å‚¨ä¸€äº›å­èŠ‚ç‚¹å…±æœ‰çš„è·¯å¾„çš„æŸäº›éƒ¨åˆ†ï¼Œä»¥åŠä½äºä¸‹é¢çš„åˆ†æ”¯èŠ‚ç‚¹çš„é“¾æ¥ã€‚ </li><li> å¶èŠ‚ç‚¹ã€‚ åŒ…å«è·¯å¾„çš„ä¸€éƒ¨åˆ†å’Œå­˜å‚¨å€¼çš„èŠ‚ç‚¹ã€‚ è¿™æ˜¯é“¾ä¸­çš„ç»ˆç‚¹ã€‚ </li></ul><br><p>å¦‚å‰æ‰€è¿°ï¼ŒMPTå»ºç«‹åœ¨å¦ä¸€ä¸ªkvå­˜å‚¨åº“çš„é¡¶éƒ¨ï¼Œè¯¥å­˜å‚¨åº“ä»¥â€œé“¾æ¥â€ =&gt;â€œ <code>RLP</code>ç¼–ç èŠ‚ç‚¹â€çš„å½¢å¼å­˜å‚¨èŠ‚ç‚¹ã€‚ </p><br><p>  <em>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªæ–°æ¦‚å¿µï¼šRLPã€‚</em>  <em>ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€ç§å¯¹è¡¨ç¤ºåˆ—è¡¨æˆ–å­—èŠ‚åºåˆ—çš„æ•°æ®è¿›è¡Œç¼–ç çš„æ–¹æ³•ã€‚</em>  <em>ç¤ºä¾‹ï¼š <code>[ "cat", "dog" ] = [ 0xc8, 0x83, 'c', 'a', 't', 0x83, 'd', 'o', 'g' ]</code> ã€‚</em>  <em>æˆ‘ä¸ä¼šç‰¹åˆ«è¯¦ç»†ï¼Œåœ¨å®ç°ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ç°æˆçš„åº“ï¼Œå› ä¸ºå¯¹è¯¥ä¸»é¢˜çš„è¦†ç›–ä¹Ÿä¼šä½¿æœ¬æ¥å·²ç»å¾ˆå¤§çš„æ–‡ç« å……å®ã€‚</em>  <em>å¦‚æœæ‚¨ä»ç„¶æ„Ÿå…´è¶£ï¼Œå¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æ›´å¤šå†…å®¹ã€‚</em>  <em>æˆ‘ä»¬å°†è‡ªå·±é™åˆ¶åœ¨å¯ä»¥åœ¨<code>RLP</code>ç¼–ç æ•°æ®å¹¶å°†å…¶è§£ç å›æ¥çš„äº‹å®ã€‚</em> </p><br><p> åˆ°èŠ‚ç‚¹çš„é“¾æ¥å®šä¹‰å¦‚ä¸‹ï¼šå¦‚æœ<code>RLP</code>ç¼–ç èŠ‚ç‚¹çš„é•¿åº¦ä¸º32ä¸ªå­—èŠ‚æˆ–æ›´å¤šå­—èŠ‚ï¼Œåˆ™è¯¥é“¾æ¥æ˜¯è¯¥èŠ‚ç‚¹çš„<code>RLP</code>è¡¨ç¤ºå½¢å¼çš„<code>keccak</code>å“ˆå¸Œã€‚ å¦‚æœé•¿åº¦å°äº32ä¸ªå­—èŠ‚ï¼Œåˆ™é“¾æ¥æ˜¯èŠ‚ç‚¹æœ¬èº«çš„<code>RLP</code>è¡¨ç¤ºå½¢å¼ã€‚ </p><br><p> æ˜¾ç„¶ï¼Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œæ— éœ€å°†èŠ‚ç‚¹ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå› ä¸º å®ƒå°†å®Œå…¨ä¿å­˜åœ¨çˆ¶èŠ‚ç‚¹ä¸­ã€‚ </p><br><p><img src="https://habrastorage.org/webt/rs/vz/0j/rsvz0j-fmp0f3p35phzmkxzbzlw.png" alt="å®˜å‘˜ä¸åŒ"></p><br><p> ä¸‰ç§ç±»å‹çš„èŠ‚ç‚¹çš„ç»„åˆä½¿æ‚¨å¯ä»¥åœ¨é”®å¾ˆå°‘çš„æƒ…å†µä¸‹æœ‰æ•ˆåœ°å­˜å‚¨æ•°æ®ï¼ˆç„¶åå¤§å¤šæ•°è·¯å¾„å°†å­˜å‚¨åœ¨æ‰©å±•èŠ‚ç‚¹å’Œå¶èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”åˆ†æ”¯èŠ‚ç‚¹å°†å¾ˆå°‘ï¼‰ï¼Œå¹¶ä¸”åœ¨èŠ‚ç‚¹å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼ˆè·¯å¾„å°†ä¸ä¼šæ˜¾å¼å­˜å‚¨ï¼‰ä½†å®ƒä»¬ä¼šåœ¨é€šè¿‡åˆ†æ”¯èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­â€œèšé›†â€ã€‚ </p><br><p> ä½¿ç”¨å„ç§èŠ‚ç‚¹çš„æ ‘çš„å®Œæ•´ç¤ºä¾‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/tm/8y/_p/tm8y_p43ggyutxiw5a7murovrpa.png" alt="æ ‘å·²æ»¡ä½†ä¸åš"></p><br><p> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œè·¯å¾„çš„å­˜å‚¨éƒ¨åˆ†å¸¦æœ‰å‰ç¼€ã€‚ å‡ºäºå¤šç§ç›®çš„éœ€è¦å‰ç¼€ï¼š </p><br><ol><li> åŒºåˆ†æ‰©å±•èŠ‚ç‚¹å’Œå¶èŠ‚ç‚¹ã€‚ </li><li> å¯¹é½å¥‡æ•°ä¸ªåŠå­—èŠ‚çš„åºåˆ—ã€‚ </li></ol><br><p> åˆ›å»ºå‰ç¼€çš„è§„åˆ™éå¸¸ç®€å•ï¼š </p><br><ul><li> å‰ç¼€å ç”¨1ä¸ªåŠå­—èŠ‚ã€‚ å¦‚æœè·¯å¾„é•¿åº¦ï¼ˆä¸åŒ…æ‹¬å‰ç¼€ï¼‰ä¸ºå¥‡æ•°ï¼Œåˆ™è·¯å¾„åœ¨å‰ç¼€ä¹‹åç«‹å³å¼€å§‹ã€‚ å¦‚æœè·¯å¾„é•¿åº¦æ˜¯å¶æ•°ï¼Œè¦åœ¨å‰ç¼€åå¯¹é½ï¼Œè¯·å…ˆæ·»åŠ åŠå­—èŠ‚0x0ã€‚ </li><li> å‰ç¼€åˆå§‹ä¸º0x0ã€‚ </li><li> å¦‚æœè·¯å¾„é•¿åº¦ä¸ºå¥‡æ•°ï¼Œåˆ™å°†0x1æ·»åŠ åˆ°å‰ç¼€ï¼ˆå³ä½¿ä¸º-0x0ï¼‰ã€‚ </li><li> å¦‚æœè·¯å¾„é€šå‘å¶èŠ‚ç‚¹ï¼Œåˆ™å°†0x2æ·»åŠ åˆ°å‰ç¼€ï¼Œå¦‚æœå°†0x0æ·»åŠ åˆ°ExtensionèŠ‚ç‚¹ã€‚ </li></ul><br><p> æˆ‘è®¤ä¸ºåœ¨Beatiksä¸Šä¼šæ›´æ¸…æ¥šï¼š </p><br><pre> <code class="plaintext hljs">0b0000 =&gt;  , Extension  0b0001 =&gt;  , Extension  0b0010 =&gt;  , Leaf  0b0011 =&gt;  , Leaf </code> </pre> <br><h3 id="udalenie-kotoroe-ne-udalenie"> å»é™¤ä¸æ˜¯å»é™¤ </h3><br><p> å°½ç®¡æ ‘å…·æœ‰åˆ é™¤èŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œä½†å®é™…ä¸Šï¼Œä¸€æ—¦æ·»åŠ çš„æ‰€æœ‰å†…å®¹å°†æ°¸è¿œä¿ç•™åœ¨æ ‘ä¸­ã€‚ </p><br><p> ä¸ºäº†ä¸ä¸ºæ¯ä¸ªå—åˆ›å»ºå®Œæ•´çš„æ ‘ï¼Œè€Œæ˜¯ä»…å­˜å‚¨æ ‘çš„æ–°æ—§ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚ï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚ </p><br><p> å› æ­¤ï¼Œä½¿ç”¨ä¸åŒçš„æ ¹å“ˆå¸Œä½œä¸ºå…¥å£ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ ‘æ›¾ç»å¤„äºçš„ä»»ä½•çŠ¶æ€ã€‚ </p><br><p><img src="https://habrastorage.org/webt/lv/-e/mr/lv-emrvfxac4ccdfi38ps6ajvfs.png" alt="ç”¨ç¬”å†™çš„æ˜¯ä»€ä¹ˆ..."></p><br><p> è¿™äº›å¹¶ä¸æ˜¯å…¨éƒ¨ä¼˜åŒ–ã€‚ è¿˜æœ‰æ›´å¤šï¼Œä½†æˆ‘ä»¬ä¸å†èµ˜è¿°-å› æ­¤æ–‡ç« å¾ˆå¤§ã€‚ ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥è‡ªå·±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é˜…è¯»</a> ã€‚ </p><br><h2 id="realizaciya"> å®ä½œ </h2><br><p> ç†è®ºå·²ç»ç»“æŸï¼Œè®©æˆ‘ä»¬ç»§ç»­å®è·µã€‚ æˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ªITé¢†åŸŸçš„lingua francaï¼Œå³<code>python</code> ã€‚ </p><br><p> ç”±äºå°†æœ‰å¾ˆå¤šä»£ç ï¼Œå¹¶ä¸”å¯¹äºæœ¬æ–‡çš„æ ¼å¼ï¼Œå°†ä¸å¾—ä¸å‡å°‘å’Œåˆ’åˆ†å¾ˆå¤šå·¥ä½œï¼Œæˆ‘å°†ç«‹å³ç•™ä¸‹æŒ‡å‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a>çš„é“¾æ¥ã€‚ <br> å¦‚æœ‰å¿…è¦ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡Œçœ‹åˆ°æ•´ä¸ªå›¾ç‰‡ã€‚ </p><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰è¦ä½œä¸ºç»“æœçš„æ ‘æ¥å£ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, storage, root=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">root</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key, encoded_value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p> ç•Œé¢éå¸¸ç®€å•ã€‚ å¯ç”¨çš„æ“ä½œåŒ…æ‹¬è·å–ï¼Œåˆ é™¤ï¼Œæ’å…¥å’Œæ›´æ”¹ï¼ˆä¸æ›´æ–°ç»“åˆï¼‰ï¼Œä»¥åŠè·å–æ ¹å“ˆå¸Œã€‚ </p><br><p> å­˜å‚¨å°†è¢«è½¬ç§»åˆ°<code>__init__</code>æ–¹æ³•-ä¸€ç§ç±»ä¼¼<code>dict</code>çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å­˜å‚¨èŠ‚ç‚¹ä»¥åŠ<code>root</code> -æ ‘çš„â€œé¡¶éƒ¨â€ã€‚ å¦‚æœ<code>None</code>ä½œä¸º<code>root</code>ä¼ é€’ï¼Œæˆ‘ä»¬å‡å®šæ ‘ä¸ºç©ºï¼Œå¹¶ä¸”ä»å¤´å¼€å§‹å·¥ä½œã€‚ </p><br><p>  _Remarkï¼šæ‚¨å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæ–¹æ³•ä¸­çš„å˜é‡è¢«å‘½åä¸º<code>encoded_key</code>å’Œ<code>encoded_value</code> ï¼Œè€Œä¸ä»…ä»…æ˜¯<code>key</code> / <code>value</code> ã€‚ ç­”æ¡ˆå¾ˆç®€å•ï¼šæ ¹æ®è§„èŒƒï¼Œæ‰€æœ‰é”®å’Œå€¼éƒ½å¿…é¡»ä»¥<code>RLP</code>ç¼–ç ã€‚ æˆ‘ä»¬ä¸ä¼šä¸ºæ­¤çƒ¦æ¼ï¼Œè€Œå°†è¿™ä¸€èŒä¸šç•™ç»™å›¾ä¹¦é¦†ç”¨æˆ·ã€‚ </p><br><p> ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬å¼€å§‹å®ç°æ ‘æœ¬èº«ä¹‹å‰ï¼Œå¿…é¡»å®Œæˆä¸¤ä¸ªé‡è¦çš„å·¥ä½œï¼š </p><br><ol><li> å®ç°<code>NibblePath</code>ç±»ï¼Œè¯¥ç±»æ˜¯<code>NibblePath</code>åŠå­—èŠ‚ï¼Œä»¥å…å¯¹å…¶è¿›è¡Œæ‰‹åŠ¨ç¼–ç ã€‚ </li><li> åœ¨æ­¤ç±»çš„æ¡†æ¶å†…å®ç°<code>Node</code>ç±»<code>Extension</code> ï¼Œ <code>Leaf</code>å’Œ<code>Branch</code> ã€‚ </li></ol><br><h3 id="nibblepath"> åŠè·¯ </h3><br><p> å› æ­¤ï¼Œ <code>NibblePath</code> ã€‚ ç”±äºæˆ‘ä»¬å°†åœ¨æ ‘ä¸Šå››å¤„ç§»åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬ç­çº§åŠŸèƒ½çš„åŸºç¡€åº”è¯¥æ˜¯èƒ½å¤Ÿä»è·¯å¾„çš„å¼€å¤´è®¾ç½®â€œåç§»â€ï¼Œä»¥åŠæ¥æ”¶ç‰¹å®šçš„åŠå­—èŠ‚ã€‚ çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å®šä¹‰äº†ç±»çš„åŸºç¡€ï¼ˆä»¥åŠä¸‹é¢ç”¨äºå¤„ç†å‰ç¼€çš„å‡ ä¸ªæœ‰ç”¨çš„å¸¸é‡ï¼‰ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NibblePath</span></span></span><span class="hljs-class">:</span></span> ODD_FLAG = <span class="hljs-number"><span class="hljs-number">0x10</span></span> LEAF_FLAG = <span class="hljs-number"><span class="hljs-number">0x20</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data, offset=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self._data = data <span class="hljs-comment"><span class="hljs-comment"># ,   . self._offset = offset #      def consume(self, amount): # "" N      . self._offset += amount return self def at(self, idx): #      idx = idx + self._offset #    ,   ,    , #   ,    -      . byte_idx = idx // 2 nibble_idx = idx % 2 #   . byte = self._data[byte_idx] #      . nibble = byte &gt;&gt; 4 if nibble_idx == 0 else byte &amp; 0x0F return nibble</span></span></code> </pre> <br><p> å¾ˆç®€å•ï¼Œä¸æ˜¯å—ï¼Ÿ </p><br><p> ä»ç„¶ä»…ç¼–å†™ç”¨äºå¯¹åŠå­—èŠ‚åºåˆ—è¿›è¡Œç¼–ç å’Œè§£ç çš„åŠŸèƒ½ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NibblePath</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def decode_with_type(data): #   : # ,     ,    . is_odd_len = data[0] &amp; NibblePath.ODD_FLAG == NibblePath.ODD_FLAG is_leaf = data[0] &amp; NibblePath.LEAF_FLAG == NibblePath.LEAF_FLAG #    ,     #    . offset  , #       "" . offset = 1 if is_odd_len else 2 return NibblePath(data, offset), is_leaf def encode(self, is_leaf): output = [] #    ,       . nibbles_len = len(self._data) * 2 - self._offset is_odd = nibbles_len % 2 == 1 #  . prefix = 0x00 #    ,    . #      (self.at(0))     . #           (0x0). prefix += self.ODD_FLAG + self.at(0) if is_odd else 0x00 #  ,  Leaf node,  . prefix += self.LEAF_FLAG if is_leaf else 0x00 output.append(prefix) # ,      ,  . pos = nibbles_len % 2 #          , #     2 ,    , #     , #    . while pos &lt; nibbles_len: byte = self.at(pos) * 16 + self.at(pos + 1) output.append(byte) pos += 2 return bytes(output)</span></span></code> </pre> <br><p> åŸåˆ™ä¸Šï¼Œè¿™æ˜¯æ–¹ä¾¿è¿›è¡Œè½»å’¬çš„æœ€ä½è¦æ±‚ã€‚ å½“ç„¶ï¼Œåœ¨å½“å‰çš„å®ç°ä¸­ï¼Œä»ç„¶å­˜åœ¨è®¸å¤šè¾…åŠ©æ–¹æ³•ï¼ˆä¾‹å¦‚<code>combine</code> ï¼Œå°†ä¸¤æ¡è·¯å¾„åˆå¹¶ä¸ºä¸€ä¸ªï¼‰ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°éå¸¸ç®€å•ã€‚ å¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>æ‰¾åˆ°å®Œæ•´ç‰ˆæœ¬ã€‚ </p><br><h3 id="node"> ç»“ç‚¹ </h3><br><p> ä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘ä»¬çš„èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šå¶å­ï¼Œæ‰©å±•å’Œåˆ†æ”¯ã€‚ æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥è¿›è¡Œç¼–ç å’Œè§£ç ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å­˜å‚¨åœ¨å†…éƒ¨çš„æ•°æ®ã€‚ è€å®è¯´ï¼Œè¿™å°±æ˜¯è¦æ±‚çš„ä»£æ•°æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ï¼Œåœ¨<code>Rust</code> ï¼Œæˆ‘æœ¬ç€ä¸€ç§ç²¾ç¥å†™äº†ä¸€äº›ä¸œè¥¿ï¼š </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; { Leaf(NibblesSlice&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;, &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>]), Extension(NibblesSlice&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;, NodeReference), Branch([<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;NodeReference&gt;; <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;&amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>]&gt;), }</code> </pre> <br><p> ä½†æ˜¯ï¼Œpythonä¸­æ²¡æœ‰è¿™æ ·çš„ADTï¼Œå› æ­¤æˆ‘ä»¬å°†å®šä¹‰<code>Node</code>ç±»ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­æœ‰ä¸‰ä¸ªä¸èŠ‚ç‚¹ç±»å‹ç›¸å¯¹åº”çš„ç±»ã€‚ æˆ‘ä»¬ç›´æ¥åœ¨èŠ‚ç‚¹ç±»ä¸­å®ç°ç¼–ç ï¼Œå¹¶åœ¨<code>Node</code>ç±»ä¸­å®ç°è§£ç ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå®ç°æ˜¯åŸºæœ¬çš„ï¼š </p><br><p> å¶ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Leaf</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, data)</span></span></span><span class="hljs-function">:</span></span> self.path = path self.data = data <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    --    , #   -  ,   -  . return rlp.encode([self.path.encode(True), self.data])</span></span></code> </pre> <br><p> æ‰©å±•åï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, next_ref)</span></span></span><span class="hljs-function">:</span></span> self.path = path self.next_ref = next_ref <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    --    , #   -  ,   -    . next_ref = _prepare_reference_for_encoding(self.next_ref) return rlp.encode([self.path.encode(False), next_ref])</span></span></code> </pre> <br><p> åˆ†è¡Œï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Branch</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, branches, data=None)</span></span></span><span class="hljs-function">:</span></span> self.branches = branches self.data = data <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    --    ,  #  16 -     (  ), #   -   (  ). branches = list(map(_prepare_reference_for_encoding, self.branches)) return rlp.encode(branches + [self.data])</span></span></code> </pre> <br><p> ä¸€åˆ‡éƒ½éå¸¸ç®€å•ã€‚ å”¯ä¸€å¯èƒ½å¼•èµ·é—®é¢˜çš„æ˜¯<code>_prepare_reference_for_encoding</code>å‡½æ•°ã€‚ </p><br><p>  <em>ç„¶åæˆ‘æ‰¿è®¤ï¼Œæˆ‘ä¸å¾—ä¸ä½¿ç”¨ä¸€ä¸ªå°æ‹æ–ã€‚</em>  <em>äº‹å®æ˜¯ï¼Œæ‰€<code>rlp</code>çš„<code>rlp</code>åº“ä»¥é€’å½’æ–¹å¼è§£ç æ•°æ®ï¼Œå¹¶ä¸”ä¼—æ‰€å‘¨çŸ¥ï¼Œåˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹çš„é“¾æ¥å¯ä»¥æ˜¯<code>rlp</code>æ•°æ®ï¼ˆå¦‚æœç¼–ç èŠ‚ç‚¹çš„é•¿åº¦å°‘äº32ä¸ªå­—ç¬¦ï¼‰ã€‚</em>  <em>ä½¿ç”¨ä¸¤ç§æ ¼å¼çš„é“¾æ¥ï¼ˆå“ˆå¸Œå­—èŠ‚å’Œè§£ç çš„èŠ‚ç‚¹ï¼‰éå¸¸ä¸æ–¹ä¾¿ã€‚</em>  <em>å› æ­¤ï¼Œæˆ‘ç¼–å†™äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™äº›å‡½æ•°åœ¨è§£ç èŠ‚ç‚¹ä¹‹åä»¥å­—èŠ‚æ ¼å¼è¿”å›é“¾æ¥ï¼Œå¹¶åœ¨ä¿å­˜ä¹‹å‰æ ¹æ®éœ€è¦å¯¹å…¶è¿›è¡Œè§£ç ã€‚</em>  <em>è¿™äº›åŠŸèƒ½æ˜¯ï¼š</em> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_prepare_reference_for_encoding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ref)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ( ,   ) --  . #       :) if 0 &lt; len(ref) &lt; 32: return rlp.decode(ref) return ref def _prepare_reference_for_usage(ref): #     -   . #          . if isinstance(ref, list): return rlp.encode(ref) return ref</span></span></code> </pre> <br><p> é€šè¿‡ç¼–å†™<code>Node</code>ç±»æ¥å®ŒæˆèŠ‚ç‚¹ã€‚ å…¶ä¸­åªæœ‰2ç§æ–¹æ³•ï¼šè§£ç èŠ‚ç‚¹å¹¶å°†è¯¥èŠ‚ç‚¹è½¬æ¢ä¸ºé“¾æ¥ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># class Leaf(...) # class Extension(...) # class Branch(...) def decode(encoded_data): data = rlp.decode(encoded_data) # 17  -  Branch . if len(data) == 17: branches = list(map(_prepare_reference_for_usage, data[:16])) node_data = data[16] return Node.Branch(branches, node_data) #    17,   2.   - . #      ,     . path, is_leaf = NibblePath.decode_with_type(data[0]) if is_leaf: return Node.Leaf(path, data[1]) else: ref = _prepare_reference_for_usage(data[1]) return Node.Extension(path, ref) def into_reference(node): #    . #      32 , #   -   . #       . encoded_node = node.encode() if len(encoded_node) &lt; 32: return encoded_node else: return keccak_hash(encoded_node)</span></span></code> </pre> <br><h2 id="pereryv"> ä¼‘æ¯ä¸€ä¸‹ </h2><br><p>  ï¼ æœ‰å¾ˆå¤šä¿¡æ¯ã€‚ æˆ‘è®¤ä¸ºæ˜¯æ—¶å€™æ”¾æ¾ä¸€ä¸‹äº†ã€‚ è¿™æ˜¯å¦ä¸€åªä¸ºæ‚¨æœåŠ¡çš„çŒ«ï¼š </p><br><p><img src="https://habrastorage.org/webt/cn/qu/jt/cnqujtdcxdavek8wvwghernczvk.png" alt="ä½ å¯ä»¥åœ¨ä¼‘æ¯æ—¶é—´åƒç‚¹ä¸œè¥¿"></p><br><p> ç±³æ´›å¡”ï¼Œå¯¹ä¸å¯¹ï¼Ÿ å¥½ï¼Œå›åˆ°æˆ‘ä»¬çš„æ ‘ä¸Šã€‚ </p><br><h2 id="merklepatriciatrie"> é»˜å…‹å°”Â·å¸•ç‰¹é‡Œå¤Â·ç‰¹é‡Œ </h2><br><p> åå‹ä¸–çºª-è¾…åŠ©å…ƒç´ å·²ç»å‡†å¤‡å¥½ï¼Œæˆ‘ä»¬ä¼ é€’ç»™æœ€ç¾å‘³çš„ã€‚ ä»¥é˜²ä¸‡ä¸€ï¼Œæˆ‘ä¼šæé†’æˆ‘ä»¬æ ‘çš„ç•Œé¢ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬å®ç°äº†<code>__init__</code>æ–¹æ³•ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, storage, root=None)</span></span></span><span class="hljs-function">:</span></span> self._storage = storage self._root = root <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">root</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key, encoded_value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, encoded_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p> ä½†æ˜¯ï¼Œå¯¹äºå…¶ä½™æ–¹æ³•ï¼Œæˆ‘ä»¬å°†ä¸€ä¸€å¤„ç†ã€‚ </p><br><h3 id="get"> å¾—åˆ° </h3><br><p>  <code>get</code>æ–¹æ³•ï¼ˆåŸåˆ™ä¸Šä¸å…¶ä»–æ–¹æ³•ä¸€æ ·ï¼‰å°†ç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚ è¯¥æ–¹æ³•æœ¬èº«å°†å‡†å¤‡æ•°æ®å¹¶å°†ç»“æœå¸¦å…¥é¢„æœŸçš„å½¢å¼ï¼Œè€Œå®é™…å·¥ä½œå°†åœ¨è¾…åŠ©æ–¹æ³•å†…éƒ¨è¿›è¡Œã€‚ </p><br><p> åŸºæœ¬æ–¹æ³•éå¸¸ç®€å•ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def get(self, encoded_key): if not self._root: raise KeyError path = NibblePath(encoded_key) #       #  ,    ,    . result_node = self._get(self._root, path) if type(result_node) is Node.Extension or len(result_node.data) == 0: raise KeyError return result_node.data</span></span></code> </pre> <br><p> ä½†æ˜¯ï¼Œ <code>_get</code>å¹¶ä¸å¤æ‚ï¼šä¸ºäº†åˆ°è¾¾æ‰€éœ€çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä»æ ¹ç›®å½•è½¬åˆ°æ•´ä¸ªæä¾›çš„è·¯å¾„ã€‚ å¦‚æœæœ€åæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªåŒ…å«æ•°æ®çš„èŠ‚ç‚¹ï¼ˆå¶æˆ–åˆ†æ”¯ï¼‰-æ¬¢å‘¼å£°ï¼Œåˆ™æ¥æ”¶åˆ°æ•°æ®ã€‚ å¦‚æœæ— æ³•é€šè¿‡ï¼Œåˆ™æ ‘ä¸­ç¼ºå°‘å¿…éœ€çš„å¯†é’¥ã€‚ </p><br><p> å®ç°æ–¹å¼ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def _get(self, node_ref, path): #      . node = self._get_node(node_ref) #    --   . #   ,      . if len(path) == 0: return node if type(node) is Node.Leaf: #     Leaf-,     , #      . if node.path == path: return node elif type(node) is Node.Extension: #    -- Extension,    . if path.starts_with(node.path): rest_path = path.consume(len(node.path)) return self._get(node.next_ref, rest_path) elif type(node) is Node.Branch: #    -- Branch,     . #   ,           #  :      . branch = node.branches[path.at(0)] if len(branch) &gt; 0: return self._get(branch, path.consume(1)) #    ,        , #     . raise KeyError</span></span></code> </pre> <br><p> å¥½å§ï¼Œä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å°†ç¼–å†™ç”¨äºä¿å­˜å’ŒåŠ è½½èŠ‚ç‚¹çš„æ–¹æ³•ã€‚ å®ƒä»¬å¾ˆç®€å•ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def _get_node(self, node_ref): raw_node = None if len(node_ref) == 32: raw_node = self._storage[node_ref] else: raw_node = node_ref return Node.decode(raw_node) def _store_node(self, node): reference = Node.into_reference(node) if len(reference) == 32: self._storage[reference] = node.encode() return reference</span></span></code> </pre> <br><h3 id="update"> æ›´æ–° </h3><br><p>  <code>update</code>æ–¹æ³•å·²ç»æ›´åŠ æœ‰è¶£äº†ã€‚ åªéœ€è¿›è¡Œæœ€åæ“ä½œï¼Œç„¶åæ’å…¥â€œå¶å­â€èŠ‚ç‚¹å°±ä¸ä¼šæ€»æ˜¯æˆåŠŸã€‚ å¯†é’¥åˆ†ç¦»ç‚¹å¯èƒ½åœ¨å·²ä¿å­˜çš„Leafæˆ–ExtensionèŠ‚ç‚¹å†…çš„æŸä¸ªä½ç½®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»å°†å®ƒä»¬åˆ†å¼€å¹¶åˆ›å»ºå‡ ä¸ªæ–°èŠ‚ç‚¹ã€‚ </p><br><p> é€šå¸¸ï¼Œæ‰€æœ‰é€»è¾‘éƒ½å¯ä»¥é€šè¿‡ä»¥ä¸‹è§„åˆ™æè¿°ï¼š </p><br><ol><li> å½“è·¯å¾„ä¸ç°æœ‰èŠ‚ç‚¹å®Œå…¨é‡åˆæ—¶ï¼Œæˆ‘ä»¬é€’å½’åœ°ä¸‹é™æ ‘ã€‚ </li><li> å¦‚æœè·¯å¾„å·²å®Œæˆï¼Œå¹¶ä¸”æˆ‘ä»¬ä½äºâ€œåˆ†æ”¯â€æˆ–â€œå¶å­â€èŠ‚ç‚¹ä¸­ï¼Œåˆ™æ„å‘³ç€<code>update</code>åªä¼šæ›´æ–°ä¸æ­¤é”®å¯¹åº”çš„å€¼ã€‚ </li><li> å¦‚æœè·¯å¾„è¢«åˆ†å‰²ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸æ›´æ–°å€¼ï¼Œè€Œæ˜¯æ’å…¥ä¸€ä¸ªæ–°å€¼ï¼‰ï¼Œå¹¶ä¸”ä½äºâ€œåˆ†æ”¯â€èŠ‚ç‚¹ä¸­-åˆ›å»ºä¸€ä¸ªâ€œå¶å­â€èŠ‚ç‚¹å¹¶åœ¨ç›¸åº”çš„åˆ†æ”¯â€œåˆ†æ”¯â€åˆ†æ”¯ä¸­æŒ‡å®šæŒ‡å‘è¯¥èŠ‚ç‚¹çš„é“¾æ¥ã€‚ </li><li> å¦‚æœè·¯å¾„è¢«åˆ’åˆ†å¹¶ä¸”ä½äºâ€œå¶å­â€æˆ–â€œæ‰©å±•â€èŠ‚ç‚¹ä¸­ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªâ€œåˆ†æ”¯â€èŠ‚ç‚¹æ¥åˆ†éš”è·¯å¾„ï¼Œå¹¶åœ¨å¿…è¦æ—¶åˆ›å»ºç”¨äºè·¯å¾„å…¬å…±éƒ¨åˆ†çš„â€œæ‰©å±•â€èŠ‚ç‚¹ã€‚ </li></ol><br><p> è®©æˆ‘ä»¬é€æ­¥ç”¨ä»£ç è¡¨è¾¾è¿™ä¸€ç‚¹ã€‚ ä¸ºä»€ä¹ˆé€æ¸ï¼Ÿ ç”±äºè¯¥æ–¹æ³•å¾ˆå¤§ï¼Œå› æ­¤å¾ˆéš¾å…¨é¢ç†è§£å®ƒã€‚ <br> ä½†æ˜¯ï¼Œæˆ‘å°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>ä¿ç•™å®Œæ•´æ–¹æ³•çš„é“¾æ¥ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def update(self, encoded_key, encoded_value): path = NibblePath(encoded_key) result = self._update(self._root, path, encoded_value) self._root = result def _update(self, node_ref, path, value): #       (,   ), #       . if not node_ref: return self._store_node(Node.Leaf(path, value)) #          #    . node = self._get_node(node_ref) if type(node) == Node.Leaf: ... elif type(node) == Node.Extension: ... elif type(node) == Node.Branch: ...</span></span></code> </pre> <br><p> é€šç”¨é€»è¾‘ä¸å¤Ÿå¤šï¼Œæœ€æœ‰è¶£çš„æ˜¯<code>if</code> så†…éƒ¨ã€‚ </p><br><h5 id="if-typenode--nodeleaf"> <code>if type(node) == Node.Leaf</code> </h5> <br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¤„ç†LeafèŠ‚ç‚¹ã€‚ å®ƒä»¬åªæœ‰ä¸¤ç§æƒ…å†µï¼š </p><br><ol><li><p> æˆ‘ä»¬éµå¾ªçš„å…¶ä½™è·¯å¾„ä¸â€œå¶å­â€èŠ‚ç‚¹ä¸­å­˜å‚¨çš„è·¯å¾„å®Œå…¨ç›¸åŒã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ”¹å€¼ï¼Œä¿å­˜æ–°èŠ‚ç‚¹å¹¶è¿”å›æŒ‡å‘å®ƒçš„é“¾æ¥å³å¯ã€‚ </p><br></li><li><p> è·¯å¾„æ˜¯ä¸åŒçš„ã€‚ <br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªå°†ä¸¤ä¸ªè·¯å¾„åˆ†å¼€çš„åˆ†æ”¯èŠ‚ç‚¹ã€‚ <br> å¦‚æœè·¯å¾„ä¹‹ä¸€ä¸ºç©ºï¼Œåˆ™å…¶å€¼å°†ç›´æ¥ä¼ è¾“åˆ°åˆ†æ”¯èŠ‚ç‚¹ã€‚ <br> å¦åˆ™ï¼Œæˆ‘ä»¬å°†å¿…é¡»åˆ›å»ºä¸¤ä¸ªLeafèŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹çš„é•¿åº¦ç¼©çŸ­äº†è·¯å¾„çš„å…¬å…±éƒ¨åˆ†çš„é•¿åº¦+ 1ä¸ªåŠå­—èŠ‚ï¼ˆæ­¤åŠå­—èŠ‚å°†ç”±BranchèŠ‚ç‚¹ç›¸åº”åˆ†æ”¯çš„ç´¢å¼•æŒ‡ç¤ºï¼‰ã€‚ </p><br></li></ol><br><p> æ‚¨è¿˜éœ€è¦æ£€æŸ¥è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨å…¬å…±éƒ¨åˆ†ï¼Œä»¥äº†è§£æˆ‘ä»¬æ˜¯å¦ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªæ‰©å±•èŠ‚ç‚¹ã€‚ </p><br><p> åœ¨ä»£ç ä¸­ï¼Œå®ƒå°†å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> type(node) == Node.Leaf: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> node.path == path: <span class="hljs-comment"><span class="hljs-comment">#  .       . node.data = value return self._store_node(node) #    . #    . common_prefix = path.common_prefix(node.path) #      . path.consume(len(common_prefix)) node.path.consume(len(common_prefix)) #  Branch . branch_reference = self._create_branch_node(path, value, node.path, node.data) # ,    Extension-. if len(common_prefix) != 0: return self._store_node(Node.Extension(common_prefix, branch_reference)) else: return branch_reference</span></span></code> </pre> <br><p>  <code>_create_branch_node</code>è¿‡ç¨‹å¦‚ä¸‹ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_branch_node</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path_a, value_a, path_b, value_b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    Branch-. branches = [b''] * 16 # ,     Branch- . branch_value = b'' if len(path_a) == 0: branch_value = value_a elif len(path_b) == 0: branch_value = value_b #    Leaf-,  . self._create_branch_leaf(path_a, value_a, branches) self._create_branch_leaf(path_b, value_b, branches) #  Branch-     . return self._store_node(Node.Branch(branches, branch_value)) def _create_branch_leaf(self, path, value, branches): # ,     Leaf-. if len(path) &gt; 0: #    ( ). idx = path.at(0) #  Leaf-   ,     . leaf_ref = self._store_node(Node.Leaf(path.consume(1), value)) branches[idx] = leaf_ref</span></span></code> </pre> <br><h5 id="if-typenode--nodeextension"> <code>if type(node) == Node.Extension</code> </h5> <br><p> åœ¨æ‰©å±•èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å†…å®¹çœ‹èµ·æ¥éƒ½åƒå¶å­èŠ‚ç‚¹ã€‚ </p><br><ol><li><p> å¦‚æœæ¥è‡ªâ€œæ‰©å±•â€èŠ‚ç‚¹çš„è·¯å¾„æ˜¯æˆ‘ä»¬è·¯å¾„çš„å‰ç¼€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€é€’å½’ç»§ç»­ã€‚ </p><br></li><li><p> å¦åˆ™ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨BranchèŠ‚ç‚¹è¿›è¡Œåˆ†ç¦»ã€‚ </p><br></li></ol><br><p> å› æ­¤ï¼Œä»£ç ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> type(node) == Node.Extension: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> path.starts_with(node.path): <span class="hljs-comment"><span class="hljs-comment">#         . new_reference = \ self._update(node.next_ref, path.consume(len(node.path)), value) return self._store_node(Node.Extension(node.path, new_reference)) #  Extension-. #     . common_prefix = path.common_prefix(node.path) #  . path.consume(len(common_prefix)) node.path.consume(len(common_prefix)) #  Branch- ,  ,    . branches = [b''] * 16 branch_value = value if len(path) == 0 else b'' #     Leaf-  Extension- . self._create_branch_leaf(path, value, branches) self._create_branch_extension(node.path, node.next_ref, branches) branch_reference = self._store_node(Node.Branch(branches, branch_value)) # ,    Extension-. if len(common_prefix) != 0: return self._store_node(Node.Extension(common_prefix, branch_reference)) else: return branch_reference</span></span></code> </pre> <br><p>  <code>_create_branch_extension</code>è¿‡ç¨‹<code>_create_branch_extension</code>é€»è¾‘ä¸Šç­‰æ•ˆäº<code>_create_branch_leaf</code>è¿‡ç¨‹ï¼Œä½†å¯ä¸æ‰©å±•èŠ‚ç‚¹ä¸€èµ·ä½¿ç”¨ã€‚ </p><br><h5 id="if-typenode--nodebranch"> <code>if type(node) == Node.Branch</code> </h5> <br><p> ä½†æ˜¯å¯¹äºåˆ†æ”¯èŠ‚ç‚¹ï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ã€‚ å¦‚æœè·¯å¾„ä¸ºç©ºï¼Œåˆ™åªéœ€å°†æ–°å€¼ä¿å­˜åœ¨å½“å‰â€œåˆ†æ”¯â€èŠ‚ç‚¹ä¸­ã€‚ å¦‚æœè·¯å¾„ä¸ä¸ºç©ºï¼Œåˆ™æˆ‘ä»¬ä»è¯¥è·¯å¾„â€œå’¬ä½â€ä¸€ä¸ªåŠå­—èŠ‚ï¼Œç„¶åé€’å½’åœ°å‘ä¸‹ç§»åŠ¨ã€‚ </p><br><p> æˆ‘è®¤ä¸ºè¯¥ä»£ç ä¸éœ€è¦æ³¨é‡Šã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> type(node) == Node.Branch: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(path) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._store_node(Node.Branch(node.branches, value)) idx = path.at(<span class="hljs-number"><span class="hljs-number">0</span></span>) new_reference = self._update(node.branches[idx], path.consume(<span class="hljs-number"><span class="hljs-number">1</span></span>), value) node.branches[idx] = new_reference <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._store_node(node)</code> </pre> <br><h3 id="delete"> åˆ é™¤ </h3><br><p>  ï¼ æœ€åä¸€ç§æ–¹æ³•ä»ç„¶å­˜åœ¨ã€‚ ä»–æ˜¯æœ€å¼€æœ—çš„ã€‚ åˆ é™¤çš„å¤æ‚æ€§åœ¨äºï¼Œå¦‚æœæˆ‘ä»¬å®Œæˆäº†æ•´ä¸ª<code>update</code>é“¾ï¼ˆä¸åŒ…æ‹¬å·²åˆ é™¤çš„é”®ï¼‰ï¼Œåˆ™éœ€è¦å°†ç»“æ„è¿”å›åˆ°è¯¥ç»“æ„æ‰€å¤„çš„çŠ¶æ€ã€‚ </p><br><p>   ,       ,     ,      ,    .   "",   ,      . </p><br><p>         .  ,   N-        ,    N+1 .      enum â€” <code>DeleteAction</code> ,    . </p><br><p>    <code>delete</code>   : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... # Enum, ,         . class _DeleteAction(Enum): #    . #     , #        (_DeleteAction, None). DELETED = 1, #    (,    ). #     ,    #    : (_DeleteAction, ___). UPDATED = 2, #    Branch-  .   -- #    : # (_DeleteAction, (___, ___)) USELESS_BRANCH = 3 def delete(self, encoded_key): if self._root is None: return path = NibblePath(encoded_key) action, info = self._delete(self._root, path) if action == MerklePatriciaTrie._DeleteAction.DELETED: #   . self._root = None elif action == MerklePatriciaTrie._DeleteAction.UPDATED: #   . new_root = info self._root = new_root elif action == MerklePatriciaTrie._DeleteAction.USELESS_BRANCH: #   . _, new_root = info self._root = new_root def _delete(self, node_ref, path): node = self._get_node(node_ref) if type(node) == Node.Leaf: pass elif type(node) == Node.Extension: pass elif type(node) == Node.Branch: pass</span></span></code> </pre> <br><p>      ,      <code>get</code>  <code>update</code> .     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h4 id="if-typenode--nodeleaf-1"> <code>if type(node) == Node.Leaf</code> </h4> <br><p>   .     .      â€”     ,     ,   . </p><br><p>  : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> type(node) == Node.Leaf: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> path == node.path: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MerklePatriciaTrie._DeleteAction.DELETED, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> KeyError</code> </pre> <br><p>    ,  "" â€”    .       ,      .              . </p><br><h4 id="if-typenode--nodeextension-1"> <code>if type(node) == Node.Extension</code> </h4> <br><p> C Extension-   : </p><br><ol><li>  ,     Extension-      .   â€”    . </li><li>   <code>_delete</code> , ""   . </li><li>    .  : </li></ol><br><ul><li>    .         . </li><li>    .      . </li><li>      Branch-.          .      ,  Branch-   .      ,   ,    Leaf-.    â€”   Extension-. </li></ul><br><p>     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> type(node) == Node.Extension: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> path.starts_with(node.path): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> KeyError <span class="hljs-comment"><span class="hljs-comment">#   . #       . action, info = self._delete(node.next_ref, path.consume(len(node.path))) if action == MerklePatriciaTrie._DeleteAction.DELETED: return action, None elif action == MerklePatriciaTrie._DeleteAction.UPDATED: #    ,     . child_ref = info new_ref = self._store_node(Node.Extension(node.path, child_ref)) return action, new_ref elif action == MerklePatriciaTrie._DeleteAction.USELESS_BRANCH: #     Branch-. stored_path, stored_ref = info # ,     Branch-. child = self._get_node(stored_ref) new_node = None if type(child) == Node.Leaf: #  branch-  . #     Leaf-  Extension. path = NibblePath.combine(node.path, child.path) new_node = Node.Leaf(path, child.data) elif type(child) == Node.Extension: #  Branch-  Extension-. #       . path = NibblePath.combine(node.path, child.path) new_node = Node.Extension(path, child.next_ref) elif type(child) == Node.Branch: #  Branch-      Branch-. #    Extension-    . path = NibblePath.combine(node.path, stored_path) new_node = Node.Extension(path, stored_ref) new_reference = self._store_node(new_node) return MerklePatriciaTrie._DeleteAction.UPDATED, new_reference</span></span></code> </pre> <br><h4 id="if-typenode--nodebranch-1"> <code>if type(node) == Node.Branch</code> </h4> <br><p>   . </p><br><p> , .    Branch-,     â€¦ </p><br><p> æ€ä¹ˆäº†   Branch-      Leaf- ( )     Extension- (    ). <br> ,        .      ,    â€”     Leaf-.          â€”      Extension-.         ,    ,    2   â€”  Branch-   . </p><br><p>     ?  : </p><br><p>    : </p><br><ol><li>    ,   . </li><li>    ,  <code>_delete</code>   . </li></ol><br><p>      : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> type(node) == Node.Branch: action = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> idx = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> info = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(path) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> len(node.data) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> KeyError <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(path) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> len(node.data) != <span class="hljs-number"><span class="hljs-number">0</span></span>: node.data = <span class="hljs-string"><span class="hljs-string">b''</span></span> action = MerklePatriciaTrie._DeleteAction.DELETED <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-comment"><span class="hljs-comment">#   ,    . #    . idx = path.at(0) if len(node.branches[idx]) == 0: raise KeyError action, info = self._delete(node.branches[idx], path.consume(1)) #  ,   ,  . #      -    #    . node.branches[idx] = b''</span></span></code> </pre> <br><p>     <code>_DeleteAction</code>       . </p><br><ol><li>       Branch-  ,      (    ,   ).            . </li></ol><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> action == MerklePatriciaTrie._DeleteAction.UPDATED: <span class="hljs-comment"><span class="hljs-comment">#   . next_ref = info node.branches[idx] = next_ref reference = self._store_node(node) return MerklePatriciaTrie._DeleteAction.UPDATED, reference elif action == MerklePatriciaTrie._DeleteAction.USELESS_BRANCH: #    . _, next_ref = info node.branches[idx] = next_ref reference = self._store_node(node) return MerklePatriciaTrie._DeleteAction.UPDATED, reference</span></span></code> </pre> <br><ol><li>     ( ,  ),   ,      . </li></ol><br><p>      .  : </p><br><ul><li>       .  ,   ,    ,       .  ,  . </li><li>   ,   .   Leaf-   .      . </li><li>  ,   .    ,   ,      . </li><li>   , ,  Branch-   .    ,  <code>_DeleteAction</code> â€” <code>UPDATED</code> . </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> action == MerklePatriciaTrie._DeleteAction.DELETED: non_empty_count = sum(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(x) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, node.branches)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> non_empty_count == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> len(node.data) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Branch- ,  . return MerklePatriciaTrie._DeleteAction.DELETED, None elif non_empty_count == 0 and len(node.data) != 0: #  ,   . path = NibblePath([]) reference = self._store_node(Node.Leaf(path, node.data)) return MerklePatriciaTrie._DeleteAction.USELESS_BRANCH, (path, reference) elif non_empty_count == 1 and len(node.data) == 0: #  ,   . return self._build_new_node_from_last_branch(node.branches) else: #  1+   ,  2+ . # Branch-  ,   - UPDATED. reference = self._store_node(node) return MerklePatriciaTrie._DeleteAction.UPDATED, reference</span></span></code> </pre> <br><p>  <code>_build_new_node_from_last_branch</code>           . </p><br><p>    â€” Leaf  Extension,           ,   . </p><br><p>     â€” Branch,      Extension ,        ,      Branch. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_build_new_node_from_last_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, branches)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    . idx = 0 for i in range(len(branches)): if len(branches[i]) &gt; 0: idx = i break #     . prefix_nibble = NibblePath([idx], offset=1) #     child = self._get_node(branches[idx]) path = None node = None #   . if type(child) == Node.Leaf: path = NibblePath.combine(prefix_nibble, child.path) node = Node.Leaf(path, child.data) elif type(child) == Node.Extension: path = NibblePath.combine(prefix_nibble, child.path) node = Node.Extension(path, child.next_ref) elif type(child) == Node.Branch: path = prefix_nibble node = Node.Extension(path, branches[idx]) #  . reference = self._store_node(node) return MerklePatriciaTrie._DeleteAction.USELESS_BRANCH, (path, reference)</span></span></code> </pre> <br><h3 id="ostalnoe"> å…¶ä½™çš„ </h3><br><p>      .  , â€¦    <code>root</code> . </p><br><p> åœ¨è¿™é‡Œï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MerklePatriciaTrie</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... def root(self): return self._root</span></span></code> </pre> <br><p>   ,   . </p><br><p>  â€¦  .  ,   ,      Ethereum         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . ,   , ,   .      ,    :) </p><br><p> ,      ,    <code>pip install -U eth_mpt</code> â€”  . </p><br><p><img src="https://habrastorage.org/webt/qm/wo/fx/qmwofx6jaxe_0t50akn0sdnt-0m.png" alt="æ‰€æœ‰äººï¼"></p><br><h2 id="rezultaty"> ç»“æœ </h2><br><p>      ? </p><br><p> , -,      ,  -       ,      ,   .    â€”  ,       . </p><br><p> -,   ,  ,            â€” .  ,        skip list  interval tree,     â€” , , . </p><br><p> -,     ,            .   ,           -  . </p><br><p> -,     â€”   . </p><br><p>   ,  ,        â€”    ! </p><br><h2 id="arty">  </h2><br><p>      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">3</a> .   !    ,    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN446558/">https://habr.com/ru/post/zh-CN446558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN446546/index.html">Microsofté€šè¿‡Azure IoTåˆ›æ–°è€…å’Œåˆåˆ›å…¬å¸çš„æ–°IPä¼˜åŠ¿æ‰©å±•äº†Azure IPä¼˜åŠ¿</a></li>
<li><a href="../zh-CN446548/index.html">åˆ†æå¹¿å‘Šæ´»åŠ¨çš„ç»Ÿè®¡ä¿¡æ¯-åœ¨DataFrameä¸­åˆ›å»ºä¸€ä¸ªæ–°æŒ‡æ ‡ï¼ˆpythonï¼‰</a></li>
<li><a href="../zh-CN446550/index.html">åè°ƒå™¨æ¨¡å¼é—®é¢˜ä»¥åŠRouteComposerä¸å®ƒæœ‰ä»€ä¹ˆå…³ç³»</a></li>
<li><a href="../zh-CN446552/index.html">ä½¿ç”¨ç¤ºä¾‹ETokenå¤„ç†APDUå‘½ä»¤</a></li>
<li><a href="../zh-CN446554/index.html">Yandexå±…æ°‘è®¡åˆ’ï¼Œæˆ–å¦‚ä½•ä½¿ç»éªŒä¸°å¯Œçš„åç«¯æˆä¸ºMLå·¥ç¨‹å¸ˆ</a></li>
<li><a href="../zh-CN446560/index.html">â€œç¤¼è²Œäº¤æµâ€ï¼šä¸¤å®¶æœ€è‘—åçš„æµåª’ä½“å…¬å¸ä¹‹é—´å†²çªçš„å®è´¨</a></li>
<li><a href="../zh-CN446562/index.html">ç¼–ç¨‹å¼‚æ­¥</a></li>
<li><a href="../zh-CN446566/index.html">é›¶é¡¹ç›®ã€‚ äºšé©¬é€Šå¦‚ä½•åº”å¯¹å‡è´§</a></li>
<li><a href="../zh-CN446568/index.html">Umbraco 8å¤§è§„æ¨¡CMSæ›´æ–°ï¼šæ–°åŠŸèƒ½</a></li>
<li><a href="../zh-CN446570/index.html">ç¬¬ä¸€ä¸ªGPUçš„æ•…äº‹ï¼šRenditionVÃ©ritÃ©1000</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>