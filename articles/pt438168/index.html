<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìá üò† üí¢ Como quebrar uma c√¢mera cara para que sua esposa n√£o o mate üëΩ üçá üåë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Isen√ß√£o de responsabilidade: o estudo come√ßou em 2013, ent√£o se voc√™ acha que alguns m√©todos s√£o est√∫pidos e perigosos - voc√™ est√° certo, foi isso. No...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como quebrar uma c√¢mera cara para que sua esposa n√£o o mate</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438168/"> <i>Isen√ß√£o de responsabilidade: o estudo come√ßou em 2013, ent√£o se voc√™ acha que alguns m√©todos s√£o est√∫pidos e perigosos - voc√™ est√° certo, foi isso.</i>  <i>No entanto, aprendi muito no processo.</i> <br><br>  <b>Entrada</b> <br>  Tudo come√ßou alguns meses antes do nascimento do meu primeiro filho.  Minha esposa e eu sempre quisemos comprar uma c√¢mera Leica legal e de repente percebemos que, se n√£o compr√°ssemos agora, n√£o poder√≠amos fazer isso por um longo tempo.  Por isso, pedimos a c√¢mera M240 e ... boom, fomos colocados na fila por seis meses.  Logo estava cansado de esperar e comecei a estudar o site deles.  Minha aten√ß√£o foi imediatamente atra√≠da para a se√ß√£o de arquivos.  Bem, voc√™ pode adivinhar por que ... Firmware! <br><br>  Vi um arquivo n√£o criptografado e descompactado ( <code>m8-2_005.upd</code> ) que come√ßa com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">magia PWAD</a> .  Voc√™ reconhece?  Sim, est√° certo, este √© o formato Doom Patch WAD.  Caras parecem amar os cl√°ssicos.  O formato est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muito bem documentado</a> , por isso n√£o foi dif√≠cil analis√°-lo. <br><a name="habracut"></a><br><h1>  Arquivos de firmware Leica </h1><br><h3>  Firmware Leica M8 </h3><br>  Isso √© realmente muito engra√ßado, porque quando mais tarde estudei o arquivo de firmware Leica T compactado, decidi primeiro verificar os m√©todos de compacta√ß√£o que o ID usava no passado. <br><br>  A Wikipedia diz que eles usaram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o formato LHA</a> , que √© essencialmente o LZW.  Mas os descompressores LZW comuns n√£o se encaixavam, ent√£o comecei a procurar uma implementa√ß√£o espec√≠fica do software de identifica√ß√£o - e pronto, encontrei o <a href="">Catacomb Armageddon</a> na <a href="">fonte</a> .  Devo admitir, com sorte. <br><br>  De qualquer forma, volte ao M8.  Aqui est√° a estrutura do firmware: <br><br><pre>  REGRAS: 0x0000008C (3036: 0x00000BDC) - descri√ß√£o XML
 LUTS: 0x00000C68 (183274: 0x0002CBEA)
  GAMMA: 0x0000007C (31760: 0x00007C10)
  GANHO: 0x00007C8C (50344: 0x0000C4A8)
  LEICA: 0x00014134 (7000: 0x00001B58)
  BLEMISH: 0x00015C8C (250: 0x000000FA)
  WREF: 0x00015D88 (82480: 0x00014230)
  OBJ: 0x00029FB8 (11268: 0x00002C04)
  VERS√ÉO: 0x0002CBBC (46: 0x0000002E)
 PXA: 0x0002D854 (858384: 0x000D1910)
 BF: 0x000FF164 (134522: 0x00020D7A) - fam√≠lia de processadores Analog Devices Blackfin
 GUI: 0x0011FEE0 (3574180: 0x003689A4)
  TRANS: 0x0000005C (59988: 0x0000EA54) - localiza√ß√£o
  IMAGENS: 0x0000EAB0 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - foto de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - imagem de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - imagem de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - imagem de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - imagem de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - imagem de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - foto de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - imagem de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - imagem de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - imagem de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - foto de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - imagem de JFIF
  FONT1: 0x0004FF5C (1522988: 0x00173D2C)
  FONT2: 0x001C3C88 (1723676: 0x001A4D1C)
  VERS√ÉO: 0x003689A4 (0: 0x00000000)
 M16C: 0x00488884 (130406: 0x0001FD66) - fam√≠lia Renesas M16C (Motorola S-record)
 FPGA: 0x004A85EC (131604: 0x00020214) - Xilinx Spartan 3
 FSL: 0x004C8800 (814: 0x0000032E) - o primeiro carregador de inicializa√ß√£o do est√°gio </pre><br>  O IDA pronto para uso n√£o suporta processadores Blackfin, mas h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in de terceiros</a> . <br><br><h3>  Firmware Leica M9 </h3><br>  O arquivo de firmware Leica M9 ( <code>m9-1_196.upd</code> ) parece criptografado: o histograma mostra uma distribui√ß√£o de cerca de 0,45%. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac1/6fc/17d/ac16fc17df9bfb0c9c63bdefaecc83d9.png"><br><br>  O fim da hist√≥ria?  Talvez n√£o.  O fato √© que a Leica usava processadores bastante fracos nas c√¢meras e, na √©poca, a criptografia XOR era frequentemente usada em eletr√¥nicos de consumo, ent√£o decidi escrever uma ferramenta simples para a opera√ß√£o do XOR para comparar o firmware comigo e calcular algumas estat√≠sticas. <br><br>  O comprimento da chave foi determinado procurando o padr√£o de repeti√ß√£o mais longo.  Isso faz sentido, pois qualquer firmware geralmente inclui grandes blocos de dados repetidos, como um bloco 0x00 / 0xFF ou gr√°ficos com pixels LUT.  A chave em si √© calculada pela frequ√™ncia de bytes dentro do comprimento da chave, onde o byte mais comum vai para o buffer da chave.  O resultado do programa indicou claramente a criptografia XOR.  Ent√£o tive que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modificar um</a> pouco <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a ferramenta</a> para obter a chave potencial e descriptografar o c√≥digo.  Novamente, isso acabou sendo um arquivo PWAD. <br><br>  O conte√∫do do PWAD revelou a seguinte estrutura: <br><br><pre>  REGRAS: 0x0000007C (2788: 0x00000AE4) - descri√ß√£o XML
 LUTS: 0x00000B60 (4060616: 0x003DF5C8)
  PROCESSO: 0x0000004C (3900572: 0x003B849C)
   CREATE: 0x0000004C (20: 0x00000014) - registro de data e hora
   LUTS: 0x00000060 (427744: 0x000686E0)
   GAINMAP: 0x00068740 (20008: 0x00004E28)
   LENTE: 0x0006D568 (3452724: 0x0034AF34)
  CCD: 0x003B84E8 (148662: 0x000244B6)
   CREATE: 0x0000004C (20: 0x00000014) - registro de data e hora
   BLEMISH: 0x00000060 (1092: 0x00000444)
   WREF: 0x000004A4 (147452: 0x00023FFC)
   LIN: 0x000244A0 (22: 0x00000016)
  ICCPROF: 0x003DC9A0 (4304: 0x000010D0)
   ECI-RGB: 0x0000003C (540: 0x0000021C)
   sRGB: 0x00000258 (3144: 0x00000C48)
   A-RGB: 0x00000EA0 (560: 0x00000230)
  WBPARAM: 0x003DDA70 (7000: 0x00001B58)
 BF561: 0x003E0128 (289128: 0x00046968) - fam√≠lia de processadores Analog Devices Blackfin
  bf0: 0x0000004C (117846: 0x0001CC56) - processador principal
  bf1: 0x0001CCA4 (117826: 0x0001CC42) - firmware do subprocessador
  bf0.map: 0x000398E8 (27072: 0x000069C0) - placa de firmware do processador principal com caracteres: D
  bf1.map: 0x000402A8 (26304: 0x000066C0) - placa de firmware do subprocessador com caracteres: D
 CORPO: 0x00426A90 (143280: 0x00022FB0) - fam√≠lia Renesas M16C (Motorola S-record)
 GUI: 0x00449A40 (3647624: 0x0037A888)
  TRANS: 0x0000005C (131656: 0x00020248) - localiza√ß√£o
  IMAGENS: 0x000202A4 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB) - foto de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - imagem de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA) - imagem de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - imagem de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - imagem de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - imagem de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D) - foto de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - imagem de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - imagem de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - imagem de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC) - foto de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - imagem de JFIF
  FONT1: 0x00061750 (1522988: 0x00173D2C)
  USBLOGO: 0x001D547C (1775: 0x000006EF) - foto de JFIF
  FONT2: 0x001D5B6C (1723676: 0x001A4D1C)
 FPGA: 0x007C42C8 (150176: 0x00024AA0) - Xilinx Spartan 3A
 BF547: 0x007E8D68 (937576: 0x000E4E68) - Fam√≠lia de processadores Analog Devices Blackfin (FSL?) </pre><br><br><h3>  Firmware Leica M240 </h3><br>  Eu adquiri o h√°bito de verificar a p√°gina de download com o firmware Leica todas as manh√£s.  Logo apareceu um novo arquivo: <b>FW_M240_1_1_0_2.FW</b> . <br><br>  N√£o parecia criptografado, mas estava compactado ... <br><br><h4>  Compress√£o </h4><br>  O histograma mostra uma enorme explos√£o em 0x9D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cb/025/ef7/6cb025ef734f60b1d4104b7301798cad.png"><br><br>  Talvez isso seja algum tipo de m√°gica de compress√£o.  Uma pesquisa na Internet [compress√£o 9D +] n√£o resultou em nada, exceto que 0x1F9D √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usado como assinatura da compacta√ß√£o LZW</a> .  Se alguma coisa, eu entendo os tipos de compress√£o LZ e decidi olhar para os bytes ap√≥s 0x9D.  E vi quatro op√ß√µes: <br><br><ol><li> <code>9D 70 C4</code> <br> </li><li> <code>9D 00</code> <br> </li><li> <code>9D XX YY</code> <br> </li><li> <code>9D XX 8Y YY</code> </li> </ol><br>  O que mais voc√™ conseguiu notar: <br><br><ul><li>  a primeira op√ß√£o aparece apenas uma vez no endere√ßo 0x30: provavelmente √© usada como um indicador de dados compactados; <br></li><li>  XX nunca excede 0x7F; <br></li><li>  o √∫ltimo byte de YY no terceiro e quarto casos nunca excede 0x7F </li></ul><br>  Pelo que sei sobre LZ, isso √© muito semelhante ao LZ77 ou LZSS, onde YY √© a etapa de recuo e XX √© o n√∫mero de bytes a serem copiados.  E a segunda op√ß√£o √© um caso especial de emiss√£o de 0x9D.  Eu escrevi uma fun√ß√£o C simples que implementa essa l√≥gica.  Ela confirmou que estamos caminhando na dire√ß√£o certa, mas a quarta op√ß√£o ainda n√£o se encaixa no esquema. <br><br>  Eu tentei de todas as maneiras interpret√°-lo, mas nada aconteceu.  Portanto, voltei-me para meus companheiros em busca de conselhos.  Um cara percebeu que, de acordo com minhas pr√≥prias observa√ß√µes, o quarto byte de YY aparece apenas quando o bit mais alto 0x8Y √© definido: essa √© apenas uma dist√¢ncia extra para a etapa de recuo.  Eu tinha vergonha, tudo ficou t√£o √≥bvio ... <br><br>  Finalmente, o descompactador come√ßou a emitir um fluxo v√°lido ... at√© ficar preso no meio do arquivo.  Isso aconteceu devido ao comprimento desconhecido da janela deslizante.  Depura√ß√£o e testes adicionais corrigiram a situa√ß√£o. <br><br>  Portanto, havia uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ferramenta para analisar o firmware M240</a> . <br><br><h4>  Estrutura de firmware </h4><br>  Para trabalhar com um formato desconhecido, n√£o criei nada melhor do que medir alguns desvios e tamanhos de se√ß√µes de c√≥digo - e tentar encontrar os valores mais pr√≥ximos no cabe√ßalho do arquivo.  Por exemplo, este bloco: <br><br> <code>0x00: 1E 1C AF 2E 01 01 00 02 07 E1 EA 5E 00 5C 1A B1 <br> 0x10: 01 29 1A 7E AE 38 73 65 9C 3D 75 B4 34 2F 44 6E <br> 0x20: 13 17 8E 6B 00 00 00 01 00 00 00 30 E1 E3 50 D1</code> <br> <br>  acabou se transformando em: <br><br> <code>1E1CAF2E ‚Äî   "LEICA FILE" <br> 01010002 - 1.1.0.2 <br> 005C1AB1 ‚Äî    (big endian) <br> 01291A7E ‚Äî    (big endian) <br> AE3873659C3D75B4342F446E13178E6B ‚Äî  MD5 <br> 00000001 ‚Äî    <br> 00000030 ‚Äî    </code> <br> <br>  Como entendi a estrutura do firmware, aprimorei minha ferramenta e, no final, ela produziu o seguinte: <br><br> <code>Running with options: <br> + firmware folder: M240_FIRMWARE <br> + verbose enabled <br> <br> Open firmware file: FW_M240_1_1_0_2.FW <br> File size: 6036193 | 0x005C1AE1 <br> <br> Parse container header: <br> version: 1.1.0.2 <br> packed size: 6036145 | 0x005C1AB1 <br> unpacked size: 19470974 | 0x01291A7E <br> body blocks: 1 | 0x00000001 <br> body offset: 48 | 0x00000030 <br> MD5: AE387365 9C3D75B4 342F446E 13178E6B <br> MD5 check: PASSED <br> <br> Uncompress container body: <br> 6036145 -&gt; 19470974 <br> Uncompression: DONE <br> <br> Split container: <br> Number of sections: 9 | 0x00000009 <br> Section table size: 612 | 0x00000264 <br> Section table offset: 36 | 0x00000024 <br> Section 1 <br> Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000 <br> MD5: A8D55AA2 B0ACDB14 0673AD79 707674F3 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG_LOKI-212.bin <br> <br> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ <br> <br> Section 9 <br> Section Name: "[A]IMG-LENSDATA-213" <br> Section offset: 19214844 | 0x012531FC <br> Section size: 255478 | 0x0003E5F6 <br> Section base: 16252928 | 0x00F80000 <br> MD5: 39C2BEC0 27ED23F6 2C1C8513 EEE697B9 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG-LENSDATA-213.bin <br> Splitting container: DONE <br> Extraction COMPLETE!</code> <br> <br>  O firmware M240 inclui um cont√™iner com nove elementos: <br><br> <code>IMG_LOKI-212.bin -    <br> IMG_LOKI-213.bin -    <br> CTRL_SYS-11.bin -   - <br> IMG-FPGA-212.bin -     () <br> IMG-FPGA-213.bin -     () <br> IMG-DSP-212.bin -  DSP <br> IMG-DSP-213.bin -  DSP <br> IMG-LENSDATA-212.bin -    <br> IMG-LENSDATA-213.bin -   </code> <br> <br>  Como voc√™ pode ver, em um firmware, existem dois conjuntos de arquivos.  Mais tarde, soube que 212 √© uma vers√£o do microcircuito de processamento de imagens e duas vers√µes do Leica M240 foram produzidas.  Este estudo √© baseado na vers√£o 212. <br><br><h1>  Gerenciamento do sistema: CTRL_SYS-11.bin </h1><br>  A √∫nica parte comum √© o firmware do chip de controle do sistema.  Este √© um bin√°rio muito grande, e o c√≥digo pode adivinhar com facilidade o que se destina. <br><br> <code>$ strings CTRL_SYS-11.bin | rg SH <br> -&gt; Test SH7216 data flash driver <br> -&gt; Test SH7216 SCI driver <br> -&gt; Test SH7216 I2C driver <br> -&gt; Test SH7216 MTU2 driver <br> -&gt; Test SH7216 ADC functions <br> -&gt; Test SH7216 CMT driver</code> <br> <br>  Portanto, temos o processador Renesas SH7216 (SH-2A), respons√°vel pelo est√°gio inicial de carregamento, testes de E / S e atualiza√ß√µes de firmware.  Pronto para uso O IDA suporta esse tipo de processador.  Restou apenas encontrar o endere√ßo de carga base correto, conhecido pela descri√ß√£o das se√ß√µes de firmware: este √© <code>0x0</code> . <br><br> <code>Section Name: "[A]CTRL_SYS-11" <br> Section offset: 14680064 | 0x00E00000 <br> Section size: 917277 | 0x000DFF1D <br> Section base: 0 | 0x00000000</code> <br> <br>  Carreguei-o no IDA e reconheci todas as fun√ß√µes, mas n√£o o mergulhei especialmente, porque o firmware do processador principal √© muito mais interessante. <br><br>  Aqui tamb√©m √© poss√≠vel notar que o UART desse chip √© aberto na porta de servi√ßo, onde ele exibe o log de download.  Voltaremos a isso mais tarde. <br><br><h1>  Chip principal: IMG_LOKI-212.bin </h1><br>  Para iniciar a engenharia reversa deste firmware, voc√™ deve primeiro responder a algumas perguntas: <br><br><ol><li>  que tipo de processador <br></li><li>  qual √© o endere√ßo de carga base <br></li><li>  em que sistema operacional se baseia, se houver </li></ol><br>  Gra√ßas √† nossa ferramenta, j√° sabemos o endere√ßo da carga base: este √© <code>0x100000</code> . <br><br> <code>Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000</code> <br> <br>  O firmware armazena as respostas restantes em um formato leg√≠vel.  Por exemplo, esta linha: <br><br> <code>$ strings ./IMG_LOKI-212.bin | rg Softune <br> 6Softune REALOS/FR is Realtime OS for FR Family, based on micro-ITRON COPYRIGHT(C) FUJITSU LIMITED 1994-1999 <br> ...</code> <br> <br>  Portanto, estamos lidando com um processador personalizado <b>Fujitsu FR</b> (a Leica chama <b>Maestro</b> ) e o <b>sistema</b> operacional <b>Softune REALOS</b> .  De fato, isso √© muito melhor que o Blackfin, porque o IDA pronto para uso suporta FR. <br><br><h2>  M√≥dulo do processador FR </h2><br>  A realidade n√£o era t√£o clara, porque ap√≥s o download do arquivo de firmware, o programa IDA n√£o mostrou instru√ß√µes, links externos etc. <br><br>  Decidi corrigi-lo, mas no final tive que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reescrever completamente algumas partes do firmware</a> .  Aqui est√° o resultado: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f3/728/c76/9f3728c769d29aa02e2f405c08d8bb9a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a08/2ea/81d/a082ea81d9056b07935398a19d4df294.png"><br><br>  Al√©m das corre√ß√µes em <code>ana</code> , <code>ins</code> e <code>out</code> , um c√≥digo de <code>emu</code> completamente novo pode: <br><br><ul><li>  reconhecer v√°rios tipos de c√≥digo e links externos para dados; <br></li><li>  Reconhecer instru√ß√µes de op√ß√£o <br></li><li>  executar rastreamento de pilha; <br></li><li>  Argumentos de pilha separados e vari√°veis ‚Äã‚Äãlocais <br></li><li>  reconhecer as fun√ß√µes corretamente. </li></ul><br>  Mas a maior mudan√ßa, como voc√™ notou, s√£o letras mai√∫sculas para obter instru√ß√µes :) <br><br>  Deseja ver o conjunto completo de instru√ß√µes?  Aqui est√°: <br><br><pre>  ADD OU BTSTH LSR MOV BN LDRES EXTSH   
 ADD2 ORH MUL LSR2 JMP BP STRES EXTUH   
 ADDC ORB MULU ASR CHAMADA BV COPOP SRCH0   
 ADDN EOR MULH ASR2 RET BNV COPLD SRCH1   
 ADDN2 EORH MULUH LDI INT BLT COPST SRCHC   
 SUB EORB DIV0S LDI INTE BGE COPSV LDM0    
 SUBC BANDL DIV0U LDI RETI BLE NOP LDM1    
 SUBN BANDH DIV1 LD BRA BGT ANDCCR STM0    
 CMP BORL DIV2 LDUH BNO BLS ORCCR STM1    
 CMP2 BORH DIV3 LDUB BEQ BHI STILM ENTER   
 E BEORL DIV4S ST BNE DMOV ADDSP SAIR   
 ANDH BEORH LSL STH BC DMOVH EXTSB XCHB    
 ANDB BTSTL LSL2 STB BNC DMOVB EXTUB </pre><br>  Ent√£o, simples e bonito. <br><br>  A prop√≥sito, voc√™ deve ter notado que algumas instru√ß√µes n√£o est√£o alinhadas: <br><br><pre>  BRA: D loc_xxx
     LDI: 8 # 0x64, R5 </pre><br>  Isso n√£o √© um erro no m√≥dulo do processador, mas de fato um recurso da fam√≠lia Fujitsu FR.  √â chamado de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">slot de atraso</a> e √© bastante t√≠pico para processadores RISC. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">No manual do processador FR80</a> (nota: o link n√£o funciona mais): <br><br><blockquote>  A instru√ß√£o localizada imediatamente ap√≥s a instru√ß√£o da filial (sua localiza√ß√£o √© chamada de "slot de atraso") √© executada antes da filial e a instru√ß√£o no endere√ßo de destino √© executada ap√≥s a filial.  Como a instru√ß√£o no slot de atraso √© executada antes da opera√ß√£o de ramifica√ß√£o, a velocidade de execu√ß√£o aparente √© de 1 ciclo. </blockquote><br>  Portanto, essa √©, em ess√™ncia, a otimiza√ß√£o do pipeline, e √© melhor lembr√°-lo, porque √© usado em qualquer lugar do firmware Leica. <br><br><h2>  Softune REALOS </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Do wiki</a> : <br><br><blockquote>  Softune √© o ambiente de desenvolvimento integrado da Fujitsu para as fam√≠lias de processadores Fujitsu FR, FR-V e F2MC.  Desenvolvido com o kernel em tempo real REALOS ¬µITRON.  Por exemplo, √© usado nas c√¢meras Nikon DSLR (consulte Nikon EXPEED) e em algumas c√¢meras Pentax com K. </blockquote><br>  Portanto, este √© um RTOS decente bastante popular, com tarefas, sem√°foros e outras guloseimas.  Gostaria de saber se √© poss√≠vel reconhecer algumas fun√ß√µes padr√£o da biblioteca no firmware Leica. <br><br>  Eu tenho que chamar a primeira parte do estudo de uma grande perda de tempo, e aqui est√° o porqu√™. <br><br>  O IDE do Softune acabou sendo muito dif√≠cil de encontrar, mas no final consegui obter alguma coisa.  Como esperado, o IDE incluiu bibliotecas.  Havia quatro bin√°rios: <br><br><ul><li>  lib911.lib <br></li><li>  lib911e.lib <br></li><li>  lib911if.lib <br></li><li>  lib911p.lib </li></ul><br>  N√£o sei por que, talvez por in√©rcia, ao cortar tudo relacionado √† Leica, comecei a engenharia reversa do formato novamente.  Sim, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">formato de m√≥dulo de objeto</a> muito bem documentado.  E sim, √© claro, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevi uma ferramenta especial para isso</a> : <br><br> <code>Fujitsu RISC Library Tool v1.0 <br> Usage: FRLibTool [-s start] [-i imagebase] [-o output] [-f index] [-dv] FIRMWARE.BIN LIBRARY.LIB <br> <br> This tool will help you to find Softune REALOS library functions in FR (Fujitsu RISC) firmware. <br> Use following arguments: <br> -f Specify firmware image file <br> -s Specify firmware image scan offset <br> -b Specify firmware imagebase <br> -o Specify output type (exclusively) <br> list - list of functions <br> idc - IDC script <br> py - IDA python script <br> pat - FLAIR pattern file <br> -i xxx Specify index of particular function <br> -d Dump library <br> -v Be verbose</code> <br> <br>  Com ele, voc√™ pode criar arquivos <code>*.pat</code> e us√°-los como entrada no <b>IDA FLAIR</b> para gerar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivos de assinatura</a> . <br><br> <code>$ FRLibTool -o pat lib911.lib <br> $ FRLibTool -o pat lib911e.lib <br> $ FRLibTool -o pat lib911if.lib <br> $ FRLibTool -o pat lib911p.lib <br> ... <br> $ sigmake -n "SOFTUNE C/C++ Library" lib911.pat lib911e.pat lib911if.pat lib911p.pat softune.sig</code> <br> <br>  Depois de aplicar esta assinatura, finalmente vi a correspond√™ncia em <b>IMG_LOKI-212.idb</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/618/145/189618145ab302edfff51fa222ed89b3.png"><br><br><h4>  Layout </h4><br>  O n√∫mero de linhas no firmware atrai imediatamente a aten√ß√£o.  Muitas fun√ß√µes s√£o nomeadas por sua funcionalidade.  Isso √© muito √∫til no processo de engenharia reversa para entender o padr√£o geral. <br><br>  Tamb√©m √© importante observar que algumas partes do arquivo de firmware s√£o copiadas para um endere√ßo diferente no manipulador de redefini√ß√£o.  Por exemplo, o carregador interno em tempo de execu√ß√£o move-se mais alto na RAM. <br><br>  Eu tive que criar manualmente se√ß√µes adicionais, como resultado, obtive o seguinte layout: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/d9d/ca3/70fd9dca36e610c7dea2e1c2fd29090c.png"><br><br><h4>  Interrup√ß√µes </h4><br>  A tabela de vetores de interrup√ß√£o pode ser encontrada acessando o TBR (Table Base Register): <br><br> <code>LDI:32 #int_table, R0 <br> MOV R0, TBR</code> <br> <br>  Geralmente, ocorre no manipulador de redefini√ß√£o de vetor no in√≠cio do firmware. <br><br>  Os endere√ßos dos manipuladores na tabela s√£o armazenados na ordem inversa, de acordo com a f√≥rmula <code>TBR + (0x3FC - 4 √ó inum)</code> , portanto, o vetor de redefini√ß√£o no final da tabela √© compensado em <code>0x3FC</code> . <br><br>  Encontrei a maioria das interrup√ß√µes no manual do FR e sugeri que o Leica Maestro tivesse um layout semelhante.  Em seguida, ele pegou cada manipulador e tentou encontrar uma string ou qualquer outra dica que revelasse o objetivo da interrup√ß√£o. <br><br>  Como resultado, fiz esta lista: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/eb8/c29/bd7eb8c291d5368d44576466400cb34b.png"><br><br>  Muitas interrup√ß√µes s√£o bastante esperadas, como AUDIO / SDIO / VIDEO / JPEG / RAW, mas tentam identificar as mais misteriosas delas?  Estou falando de interromper <code>int_uart_in</code> .  Parece que a c√¢mera suporta algum tipo de UART CLI no modo de console. <br><br><h4>  Chamadas do sistema </h4><br>  Como quase qualquer sistema operacional, o Softline REALOS usa chamadas do sistema.  No assembler, eles ficam assim: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22f/a92/9e3/22fa929e311af81f43be57bf0bbbbc74.png"><br><br>  O endere√ßo real do manipulador de chamadas do sistema √© calculado da seguinte maneira.  Vamos come√ßar procurando o manipulador de interrup√ß√£o <code>INT #0x40</code> .  Como descrito acima, esse <br><br> <code>(0x3FC - 4 √ó inum) = (0x3FC - 4 √ó 0x40) = 0x2FC = int_realos_syscall</code> <br> <br>  No manipulador, √© f√°cil encontrar um link para a parte inferior da tabela de chamadas do sistema com palavras de 16 bits.  O registro espec√≠fico nesta tabela √© calculado pela f√≥rmula <code>syscall_table_bottom + (num * 2)</code> : <br><br> <code>[syscall_table_bottom + (-23 * 2)] = [syscall_table_bottom - 0x2E] = [0x1012EA] = 0xE68</code> <br> <br>  Isso n√£o parece um endere√ßo, porque o endere√ßo real do manipulador de chamadas do sistema √© calculado como <code>syscall_table_bottom + offset</code> .  Todo o processo √© mostrado no diagrama. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5a/240/2bb/c5a2402bb00a171532dabf9ef9aa45ea.png"><br><br>  Todas as chamadas do sistema e suas funcionalidades s√£o indicadas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">manual do kernel da Softline REALOS / FR</a> ; portanto, consegui restaurar todos os manipuladores implementados na tabela e melhorar um pouco mais o BID. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6a/b81/57a/c6ab8157a83a3e00613b4a000de45e54.png"><br><br>  Obviamente, voc√™ pode tornar o c√≥digo ainda mais bonito definindo os tipos de chamadas do sistema no IDA. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e0/75c/099/1e075c099f1bdcb70388427705dd25c0.png"><br><br>  Eu escrevi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um script Python</a> para procurar automaticamente essas chamadas do sistema e muito mais. <br><br><h4>  As tarefas </h4><br>  Na chamada do sistema <code>sta_tsk</code> notei que n√£o a fun√ß√£o principal √© passada como par√¢metro, mas pid.  Isso significa que √© hora de procurar uma grande variedade de descritores de tarefas.  E faz sentido come√ßar com o pr√≥prio <code>sta_tsk</code> . <br><br><pre>  ROM: 102180 sys_sta_tsk:
 ROM: 102180 ST RP, @ -R15
 ROM: 102182 LDUB @ (R14, 0x4F), R3
 ROM: 102184 LDI: 32 # word_100B80, R14 </pre><br>  No in√≠cio, vemos alguns links.  Eu tive que mexer um pouco nos tipos de dados, mas no final as pe√ßas se uniram: <br><br><pre>  ROM: 100B80 word_100B80: .word 0xF;  n√∫mero de tarefas
 ROM: 100B82. Palavra 0x1C;  tamanho do descritor de tarefas<font></font>
<font></font>
 ROM: 100B84. 0x82A09F5C;  tarefa 1 descritor
 ROM: 100B88 .long 0x1000D
 ROM: 100B8C .long 0
 ROM: 100B90 .long 0x40000000
 ROM: 100B94 .long sub_1A7DB2;  tarefa principal
 ROM: 100B98 .long 0x8286EEC0
 ROM: 100B9C .long 0<font></font>
<font></font>
 ROM: 100BA0. 0x82A09F88;  tarefa 2 descritor
 ROM: 100BA4 .long 0x20010
 ROM: 100BA8 .long 0
 ROM: 100BAC .long 0x40000000
 ROM: 100BB0 .long sub_1A6BD2;  tarefa principal
 ROM: 100BB4 .long 0x8287EEC0
 ROM: 100BB8 .long 0
 ... </pre><br>  e assim por diante.  Apenas 15 tarefas.  Era quest√£o de tempo examinar cada fun√ß√£o principal, determinar o nome e o objetivo da tarefa (exceto a √∫ltima).  Aqui est√° a lista completa: <br><br><ol><li>  <b>SubCPU</b> <br>  Essa tarefa √© aparentemente respons√°vel por opera√ß√µes de captura, como exposi√ß√£o, observa√ß√£o na tela etc. <br></li><li>  <b>Keymanager</b> <br>  Provavelmente, esta tarefa est√° associada aos bot√µes de hardware. <br></li><li>  <b>Guimanager</b> <br>  Uma grande tarefa, na qual a m√°quina de estado da interface do usu√°rio e a renderiza√ß√£o da interface s√£o implementadas. <br></li><li>  <b>Gerenciador de Depura√ß√£o</b> <br>  Sim, h√° algo para depurar.  Yum yum. <br></li><li>  <b>Gerenciador de arquivos</b> <br>  Esta tarefa √© sobre opera√ß√µes de arquivo. <br></li><li>  <b>Fammanager</b> <br>  Eu diria que a tarefa √© respons√°vel pelos arquivos e mem√≥ria, porque depende das tarefas do gerenciador de arquivos e do gerenciador de mem√≥ria. <br></li><li>  <b>Gerenciador de mem√≥ria</b> <br>  Sem surpresas: opera√ß√µes de mem√≥ria, gerenciamento de pool, etc. <br></li><li>  <b>Imagemanager</b> <br>  Esta tarefa gerencia os processos de codifica√ß√£o / decodifica√ß√£o e outros processos de processamento de imagem. <br></li><li>  <b>Usbmanager</b> <br>  O desafio atual √© o processamento de comunica√ß√µes USB, que inclui o MassStorage, PTP e o pr√≥prio protocolo da Leica. <br></li><li>  <b>IOManager</b> <br>  Essa tarefa parece estar gerenciando dispositivos de armazenamento, como cart√µes SD e CF (o que? Que outros CFs? Talvez seja do modelo 213). <br></li><li>  <b>Systemmanager</b> <br>  V√°rias tarefas, como opera√ß√µes gerais do sistema, gerenciamento de energia, etc. <br></li><li>  <b>SettingsManager</b> <br>  Lida com o status e as configura√ß√µes da c√¢mera. <br></li><li>  <b>Monitormanager</b> <br>  Rastreia as altera√ß√µes no estado da c√¢mera e informa outras tarefas. <br></li><li>  <b>Gerenciador de perif√©ricos</b> <br>  Esta tarefa controla o GPS, o brilho e alguns outros sensores. <br></li><li>  <b>Desconhecido</b> <br>  Infelizmente, n√£o encontrei nada significativo para ela. </li></ol><br>  √â interessante notar que, ap√≥s a matriz principal, existe outro descritor excelente. <br><br> <code>ROM:100D28 dword_100D28: .long 0x82A0A1F0 <br> ROM:100D2C .long 0x21 <br> ROM:100D30 .long 0 <br> ROM:100D34 .long 0x80000000 <br> ROM:100D38 .long tid16_task <br> ROM:100D3C .long 0x8285EEC0 <br> ROM:100D40 .long 0</code> <br> <br>  E a fun√ß√£o da tarefa √© simplesmente se ramificar. <br><br> <code>ROM:101494 sub_101494: <br> ROM:101494 BRA sub_101494 ; CODE XREF: sub_101494</code> <br> <br>  Esse descritor √© mencionado no final da fun√ß√£o de <code>start</code> , respons√°vel por criar outras tarefas e configurar o firmware.  Portanto, essa √© provavelmente a tarefa da ina√ß√£o do sistema. <br><br><h4>  M√≥dulos e Mensagens </h4><br>  Al√©m das tarefas, voc√™ pode definir alguns objetos l√≥gicos, como E / S e m√≥dulos perif√©ricos.  Os m√≥dulos s√£o apresentados como um grupo de manipuladores de mensagens como parte de uma das tarefas. <br><br>  O grupo de E / S parece incluir: <br><br><ul><li>  Gerente de IO </li><li>  Subprocessador </li><li>  Gerenciador USB </li><li>  PTP USB </li><li>  Protocolo USB Leica </li><li>  Armazenamento em massa USB </li><li>  Button Manager </li><li>  Gerenciador de depura√ß√£o </li><li>  Gerenciador de lentes </li></ul><br>  E no grupo perif√©rico: <br><br><ul><li>  Gerenciador de perif√©ricos </li><li>  Sensor de luz </li><li>  LEDs </li><li>  Orador </li><li>  Sensor de inclina√ß√£o </li><li>  Reconhecimento de fechamento de bon√© </li><li>  M√≥dulo GPS </li><li>  M√≥dulo 3DAxis </li></ul><br>  O pr√≥prio sistema de mensagens usa as estruturas SOFTUNE padr√£o: <br><br><pre> <code class="plaintext hljs">struct RealOS_MsgPayload { uint32_t msgID; // +0x0 uint32_t data[]; // +0x4 } struct RealOS_Message { uint32_t os_reserved1; // +0x0 uint32_t os_reserved2; // +0x4 uint32_t to; // +0x8 uint32_t from; // +0xC RealOS_MsgPayload* payload; // +0x10 }</code> </pre> <br>  Como esperado, o IPC tamb√©m possui v√°rios grupos de mensagens.  Como muitas mensagens s√£o processadas em tarefas e m√≥dulos, consegui recuperar apenas alguns desses grupos: <br><br><pre>  0x1101xxxx - mensagens do sistema global:
              0x11010002 = SYS_UPDATE_BOOTLOADER ou
              0x11010005 = SYS_ERASE_SETTINGS
 0x1102xxxx - mensagens relacionadas √† captura de imagem:
              0x11020001 = CMD_CAP_CAPTURE ou
              0x11020008 = IMAGE_STATUS_CHANGED  
 0x1104xxxx - mensagens sobre eventos relacionados √† reprodu√ß√£o:  <font></font>
             0x11040002 = PLY_DISABLE_PLAY_MODE <font></font>
             0x11040004 = PLY_IMAGE_READY  <font></font>
0x1108xxxx -     PTP  .:<font></font>
             0x11080002 = DBG_CHANGE_LEVEL <font></font>
             0x11080012 = DBG_WRITE_ROM_DUMP_SD  <font></font>
0x2201xxxx -  USB PTP<font></font>
             0x22010108 =    <font></font>
             0x22010118 =  DebugObject  <font></font>
0x2202xxxx -     SUBCPU:<font></font>
             0x22020002 = E_SUBCPU_REQUEST_M_EXPOSURE_REQUEST  <font></font>
             0x22020015 = E_IO_SUBCPU_COMMAND_CLEANING_SENSOR  <font></font>
0x2203xxxx -    :<font></font>
             0x22030001 =   <font></font>
0x2204xxxx -   IO:<font></font>
             0x2204000C = / Mass Storage <font></font>
             0x22040012 =    <font></font>
0x330000xx -     UI:<font></font>
             0x33000001 =  <font></font>
             0x33000007 =  <font></font>
0x440000xx -   ,     <font></font>
             0x44000013 = E_IMG_CMD_CHANGE_PINFO  <font></font>
0x55xxxxxx ‚Äî   FAM:  <font></font>
             0x558800xx = - FAM <font></font>
             0x558888xx =     FAM<font></font>
0x6602xxxx ‚Äî     LED, :<font></font>
             0x66020001 -  LED  X <font></font>
             0x66020002 =   LED  <font></font>
0x6604xxxx -  :<font></font>
             0x66040001 =  <font></font>
             0x66040007 =    <font></font>
0x6611xxxx -  ,   <font></font>
0x6622xxxx -   ,   <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6660xxxx - algumas outras mensagens relacionadas √† mem√≥ria:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600006 = HISTOGRAMA  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600011 = RAWCOMP  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x771100xx e 0x77AA00xx - mensagens relacionadas √† troca de modos da c√¢mera </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Infelizmente, muitos outros posts permanecem desconhecidos. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GUI </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No arquivo de firmware, veremos tamb√©m as seguintes se√ß√µes: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL_SYS-11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-DSP-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-FPGA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LENSDATA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que me surpreendeu foi a completa falta de recursos da GUI. Mas eles devem estar em algum lugar e, provavelmente, est√£o incorporados no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma das minhas abordagens usuais para reverter o desenvolvimento de firmware √© restaurar todas as refer√™ncias cruzadas poss√≠veis. N√£o apenas no c√≥digo, mas tamb√©m na se√ß√£o de dados. Ent√£o eu os olho, tentando encontrar alguns padr√µes ou links para partes conhecidas do c√≥digo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O firmware Leica n√£o foi exce√ß√£o. </font><font style="vertical-align: inherit;">Existem muitas sequ√™ncias de dados semelhantes com endere√ßos para outras sequ√™ncias de dados que v√£o al√©m, etc. Ao escalar a hierarquia de links, finalmente vi uma fun√ß√£o familiar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, encontrei uma estrutura de dados sem links:</font></font><br><br><pre> <code class="plaintext hljs">g_data = { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Outra estrutura abordou: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct1 = { ... , &amp;g_data }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Que por sua vez √© referido por outra estrutura: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct2 = { &amp;g_data, ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Essa estrutura de dados tem um link do c√≥digo e √© passada como par√¢metro para outra fun√ß√£o: </font></font><br><br><pre> <code class="plaintext hljs">func1() ‚ï∞ func2(..., &amp;g_data_struct2, ...)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, </font></font><code>func1()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© chamado diretamente de outra fun√ß√£o, mas √© armazenado em alguma matriz:</font></font><br><br><pre> <code class="plaintext hljs">g_func_list1[] = { ..., func1(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olhando acima, encontrei uma chamada no c√≥digo </font></font><code>g_func_list1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="plaintext hljs">func3() { g_func_list1[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E, novamente, essa fun√ß√£o √© armazenada em uma matriz: </font></font><br><br><pre> <code class="plaintext hljs">g_func_list2[] = { ..., func3(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Algum outro c√≥digo acessa a pr√≥pria matriz: </font></font><br><br><pre> <code class="plaintext hljs">func4() { g_func_list2[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Felizmente, desta vez a fun√ß√£o √© chamada de outra fun√ß√£o e assim por diante </font></font><code>gui_MADE_ApplicationRun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="plaintext hljs">gui_Statemachine_DoStateChange() ‚ï∞ gui_MADE_ApplicationRun() ‚ï∞ func5() ‚ï∞ func4()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas linhas indicam que o subsistema da GUI √© chamado "MADE" e as transi√ß√µes de p√°gina s√£o manipuladas usando </font></font><code>MADE_GetSysTri</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o que isso significa. </font><font style="vertical-align: inherit;">A m√°quina de estado da GUI √© basicamente implementada em uma fun√ß√£o </font></font><code>gui_Statemachine_DoStateChange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ap√≥s coletar informa√ß√µes sobre a GUI, a figura geral se desenvolveu: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d4/33e/3cf/4d433e3cf679dba11141d58d080daf5b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, a principal fun√ß√£o dos recursos da GUI √© </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(embora esse n√£o seja um nome real). </font><font style="vertical-align: inherit;">Ela tem os seguintes argumentos:</font></font><br><br><pre> <code class="plaintext hljs">gui_CopyImageDesc( uint32_t dstAddress; // R4 - destination address UIDescType type; // R5 - description type UITarget target; // R6 - rendering target uint32_t descAddress; // R7 - description address uint8_t always0; // (SP + 0x0) - always 0 uint8_t index1; // (SP + 0x4) - index 1 uint8_t index2; // (SP + 0x8) - index 2 uint16_t x_offset; // (SP + 0xC) - x offset uint16_t y_offset; // (SP + 0x10) - y offset uint16_t unknown2; // (SP + 0x14) - uint32_t language1; // (SP + 0x18) - language id 1 uint32_t language2; // (SP + 0x1C) - language id 2 uint32_t funcAddress; // (SP + 0x20) - function address )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Existem quatro tipos de descri√ß√µes de recursos: </font></font><br><br><pre> <code class="plaintext hljs">struct UIDescType0Header struct UIDescType1Header struct UIDescType2 struct UIDescType3 { { { { uint32_t address; uint32_t address; uint32_t reg; uint16_t x_offset; uint16_t entries; uint16_t entries; uint32_t address; uint16_t y_offset; uint16_t unknown; uint16_t unknown; uint16_t unknown1; uint32_t address; } } uint16_t unknown2; } uint16_t unknown3; struct UIDescType0Entry struct UIDescType1Entry uint16_t tableoff; { { } uint16_t x_offset; uint16_t x_offset; uint16_t y_offset; uint16_t y_offset; uint32_t address; uint32_t address; } uint16_t objects; uint16_t total_w; uint16_t total_h; uint16_t unknown; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro tipo tem um cabe√ßalho com uma refer√™ncia a uma matriz de registros. Cada registro possui coordenadas e um endere√ßo para dados de pixel. O tipo atual parece descrever elementos dependentes do estado, como √≠cones, que podem ficar acinzentados ou desaparecer da interface do usu√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O segundo tipo tamb√©m come√ßa com um cabe√ßalho e √© usado para localizar, descrever linhas ou blocos de texto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O terceiro tipo descreve mapas de caracteres para diferentes idiomas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O √∫ltimo tipo √© respons√°vel por todos os outros recursos est√°ticos, como imagens, planos de fundo etc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, vamos dar uma olhada nos dados das pr√≥prias imagens. </font><font style="vertical-align: inherit;">Os primeiros seis bytes parecem um cabe√ßalho pequeno, seguido por algum tipo de padr√£o repetitivo, em que cada segundo byte √© </font><font style="vertical-align: inherit;">ou </font><font style="vertical-align: inherit;">. √â l√≥gico supor que </font><font style="vertical-align: inherit;">e</font></font><br><br> <code>+0x00: 00 08 00 14 00 01 A2 FF 0A 04 05 FF 0C 04 03 FF <br> +0x10: 0D 04 03 FF 0E 04 02 FF 0E 04 02 FF 04 04 06 FF <br> +0x20: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x30: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x40: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x50: 04 04 02 FF 04 04 06 FF 04 04 02 FF 0E 04 02 FF <br> +0x60: 0E 04 02 FF 0D 04 03 FF 0D 04 03 FF 0C 04 04 FF <br> +0x70: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x80: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x90: 04 04 0D FF 02 04 2D FF 00 06 00 14 00 01 79 FF</code> <br> <br><font style="vertical-align: inherit;"></font><code>0xFF</code><font style="vertical-align: inherit;"></font><code>0x04</code><font style="vertical-align: inherit;"></font><code>0x0008</code><font style="vertical-align: inherit;"></font><code>0x0014</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- largura e altura em uma exibi√ß√£o com ordem direta de bytes (big endian). No final deste despejo, vemos o in√≠cio de outra sequ√™ncia </font></font><code>00 06 00 14 00 01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Provavelmente, este √© o pr√≥ximo recurso (conforme confirmado por um link para ele). Assim, o tamanho dos dados reais da imagem √© 146 bytes. Mas o tamanho da imagem deve ser 0x8 * 0x14 = 0xA0 = 160. √â claro que os dados n√£o s√£o pixels puros e nem mesmo uma LUT de 8 bits, porque s√£o 14 bytes menores.</font></font> Ent√£o o que?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente algum tipo de compress√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olhando para esse despejo hexadecimal, √© dif√≠cil acreditar que algum tipo de esquema complexo seja usado. A GUI da Leica n√£o √© muito colorida, portanto, na minha experi√™ncia, √© melhor usar a tabela LUT aqui. Nesse caso, os recursos da interface do usu√°rio repetir√£o completamente os √≠ndices LUT como </font></font><code>03 03 03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>1 1 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Normalmente, o compressor tenta se livrar da duplica√ß√£o de dados, substituindo-os por um link. Essas matrizes de √≠ndice s√£o ideais para compacta√ß√£o, mesmo com um m√©todo simples como o RLE </font></font><code>[data][number]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um comando simples para escrever </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(valor) </font></font><code>number</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vezes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com tudo isso em mente, sugeri que provavelmente observamos uma imagem simples com duas cores LUT ( </font></font><code>0xFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>0x04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), e o byte na frente da cor √© o n√∫mero de pixels a serem desenhados.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"E ent√£o voc√™ escreveu outro instrumento", voc√™ pensa. Mas n√£o, peguei caneta e papel e comecei a preencher as c√©lulas. √â engra√ßado que eu ainda tenha essa foto. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/743/b4a/1f3/743b4a1f3a65f485760e8a4f0584d2e6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em algum lugar ao longo do caminho, percebi que 160 pixels n√£o s√£o suficientes para esta imagem; portanto, 0x8 e 0x14 precisam ser multiplicados por dois. A terceira palavra 0x0001 indica se a imagem √© um caractere ASCII, portanto a estrutura final do ImageAsset √© a seguinte:</font></font><br><br><pre> <code class="plaintext hljs">struct ImageAsset { uint16_t width; // /2 (big endian) uint16_t height; // /2 (big endian) uint16_t ascii; // 1,   ASCII struct image_data { uint8_t number; //     uint8_t color; //     LUT } data[]; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas ainda falta uma parte: LUT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o foi t√£o dif√≠cil de encontrar, porque muitos links e estruturas j√° foram restaurados manualmente, ent√£o eu rolei lentamente as se√ß√µes de dados, procurando uma matriz de 256 elementos a partir de valores de 16 ou 32 bits, at√© me deparar com isso: </font><font style="vertical-align: inherit;">Mais uma vez, obrigado No meu trabalho com o Blackmagic Design, reconheci imediatamente os pixels YUV (por exemplo, todos os valores com os n√∫meros 8080). </font><font style="vertical-align: inherit;">N√£o sou idiota de desenhar novamente toda a interface do usu√°rio manualmente no papel, ent√£o sim, escrevi outra ferramenta - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">M240UITool</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Al√©m de redefinir todos os recursos de imagem do arquivo de firmware para BMP / PNG, essa ferramenta pode criar scripts IDC no IDA para determinar todos os recursos da interface do usu√°rio.</font></font><br><br> <code>.long 0x7008080, 0x72D8080, 0x73C8080, 0x75A8080, 0x79B8080, 0x71DFF6B, 0x7BE8080, 0x7FF8080 <br> .long 0x77BBD27, 0x75B60E7, 0x7835F4A, 0x7D3089F, 0x7018080, 0x7028080, 0x7038080, 0x7048080 <br> .long 0x7058080, 0x7068080, 0x7078080, 0x7088080, 0x7098080, 0x70A8080, 0x70B8080, 0x70C8080 <br> .long 0x70D8080, 0x70E8080, 0x70F8080, 0x7108080, 0x7118080, 0x7128080, 0x7952B15, 0x7138080 <br> .long 0x7148080, 0x7158080, 0x7168080, 0x7178080, 0x7188080, 0x7198080, 0x71A8080, 0x71C8080 <br> .long 0x71D8080, 0x71E8080, 0x71F8080, 0x7338080, 0x7208080, 0x7218080, 0x7228080, 0x7238080 <br> .long 0x7248080, 0x7248080, 0x7268080, 0x7278080, 0x7288080, 0x7298080, 0x72A8080, 0x72B8080 <br> .long 0x72C8080, 0x75E8080, 0x7608080, 0x7628080, 0x7648080, 0x7678080, 0x7688080, 0x7698080 <br> .long 0x76B8080, 0x76E8080, 0x7708080, 0x7728080, 0x7758080, 0x7778080, 0x7798080, 0x77C8080 <br> .long 0x77E8080, 0x7818080, 0x7838080, 0x7868080, 0x7888080, 0x78B8080, 0x78D8080, 0x7908080 <br> .long 0x7928080, 0x7958080, 0x7978080, 0x7998080, 0x79C8080, 0x79D8080, 0x7668080, 0x79E8080 <br> .long 0x7A18080, 0x7A28080, 0x7A38080, 0x7A68080, 0x7A78080, 0x7A88080, 0x7AB8080, 0x7AC8080 <br> .long 0x7AD8080, 0x7B08080, 0x7B28080, 0x7B58080, 0x7B88080, 0x7B98080, 0x7BC8080, 0x7CC8080 <br> .long 0x7AB3BBB, 0x7E10094, 0x7E4556E, 0x4008080, 0x2922D17, 0x7B2AB00, 0x7C2A262, 0x71DFF6B <br> .long 0x768D4A2, 0x769D4EA, 0x7BD88AE, 0x705997B, 0x70BB377, 0x711CC73, 0x717E66F, 0x7238866 <br> .long 0x729A262, 0x72FBB5E, 0x735D55A, 0x7417751, 0x747914D, 0x74DAA48, 0x753C444, 0x75F663B <br> .long 0x76B9933, 0x7998080, 0x771B32F, 0x77D5526, 0x7836F22, 0x789881E, 0x78FA21A, 0x7159095 <br> .long 0x71AAA91, 0x720C38D, 0x726DD88, 0x7506F6A, 0x7568866, 0x75CA262, 0x762BB5E, 0x76E5E55 <br> .long 0x7747751, 0x77A914D, 0x780AA48, 0x78C4D3F, 0x792663B, 0x7988037, 0x79E9933, 0x7AA3C2A <br> .long 0x7B05526, 0x7B66F22, 0x7BC881E, 0x72488AE, 0x72AA1AA, 0x72FBBA6, 0x735D4A2, 0x7427799 <br> .long 0x7489095, 0x74DAA91, 0x753C38D, 0x77E556E, 0x7836F6A, 0x7898866, 0x78FA262, 0x79C4459 <br> .long 0x7A15E55, 0x7A77751, 0x7AD914D, 0x7BF4D3F, 0x7CC8080, 0x7C5663B, 0x7CB8037, 0x7337FC8 <br> .long 0x73999C4, 0x73FB2C0, 0x745CCBB, 0x7757799, 0x74C54FF, 0x77B9095, 0x780AA91, 0x7AB3C72 <br> .long 0x7B1556E, 0x7B66F6A, 0x7BC8866, 0x74277E1, 0x74890DD, 0x74EAAD9, 0x754C3D5, 0x76066CC <br> .long 0x7667FC8, 0x76C99C4, 0x772B2C0, 0x77E55B7, 0x7846EB3, 0x78A88AE, 0x790A1AA, 0x7526EFB <br> .long 0x75787F7, 0x75DA1F3, 0x763BAEE, 0x76F5DE6, 0x77577E1, 0x77B90DD, 0x781AAD9, 0x78D4CD0 <br> .long 0x79366CC, 0x79F99C4, 0x7E10094, 0x7CF44A1, 0x7DB7799, 0x7E71A90, 0x7ED338C, 0x7FF8080 <br> .long 0x7328080, 0x7DC8080, 0x7C88080, 0x7508080, 0x775CD2C, 0x76944EA, 0x7808080, 0x71A61FF <br> .long 0x7244D40, 0x7242C15, 0xFFF8080, 0xF338080, 0xF668080, 0xF998080, 0xFCC8080, 0xF008080 <br> .long 0xF4C54FF, 0xFAB3BBB, 0xFE10094, 0xFE4556E, 0xF952B15, 0xFDA7751, 0xFB2AB00, 0xFC2A262 <br> .long 0xF1DFF6B, 0xF68D4A2, 0xF69D4EA, 0xFBD88AE, 0xA922D17, 0xC6E4130, 0xE286963, 0x74C55FF <br> .long 0x768D536, 0x7FF8080, 0x7FF8080, 0x7FF8080, 0x2922D17, 0x46E4130, 0x6286963, 0x8080</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br> <code>Leica M (typ 240) UI Tool v1.0 <br> Usage: ./M240UITool [-a address] [-i imagebase] [-s script] [-d dump] [-f folder] [-l LUT] [-rbv] FIRMWARE.BIN <br> <br> This tool will help you to find UI resources in firmware. <br> Use following arguments: <br> -a Specify address of the gui_CopyImageDesc function (ex. 0x2F95E0) <br> -i Specify firmware imagebase <br> -s Specify IDC file name <br> -c Specify container file name <br> -d Specify dump image format <br> png - PNG format <br> bmp - BMP (ARGB) format <br> -f Specify folder for dumped images <br> -l Specify LUT for images (filename of address) <br> -b Specify number of bytes to display in verbose mode <br> -r Try to recover string characters <br> -v Be verbose</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J√° sabemos que, a partir da fun√ß√£o que uma p√°gina da interface do usu√°rio cria, ela √© chamada v√°rias vezes </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu pensei que seria √≥timo criar um navegador de recursos da interface do usu√°rio e definir todos os recursos de renderiza√ß√£o da p√°gina. </font><font style="vertical-align: inherit;">A op√ß√£o </font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">destinada a isso </font><font style="vertical-align: inherit;">- ele cria um cont√™iner especial para visualizar recursos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E quem disse que um navegador de recursos da interface do usu√°rio pode n√£o parecer incomum? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b6/5f7/6c3/8b65f76c30a4d4a037719e805141573a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sendo interativa (bot√µes transl√∫cidos na captura de tela), essa ferramenta permite n√£o apenas rolar pelas p√°ginas do menu EVF / LCD, mas tamb√©m visualizar as etapas de renderiza√ß√£o em uma p√°gina. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, o c√≥digo fonte desta obra-prima foi perdido em algum lugar, mas os arquivos de cabe√ßalho ainda est√£o no c√≥digo M240UITool, portanto, tecnicamente, voc√™ pode recri√°-lo do zero.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu Debug </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que linha procuramos principalmente quando fazemos engenharia reversa? Na minha opini√£o, esta palavra </font></font><code>debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e seus derivados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Havia muitas linhas interessantes no firmware, mas estas s√£o especiais: </font><font style="vertical-align: inherit;">Parece que voc√™ pode entrar no modo de depura√ß√£o usando alguma combina√ß√£o de teclas. Todas essas linhas s√£o chamadas de uma fun√ß√£o gigante </font><font style="vertical-align: inherit;">, que implementa uma m√°quina de estado de verifica√ß√£o de bot√£o. Aqui est√° o que parece na AID:</font></font><br><br> <code>$ strings ./IMG_LOKI-212_1.1.0.2.bin | grep "Debug Mode" <br> GUI: State: %d! Scanning for Debug Mode successful <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> ... <br> GUI: ScanningForDebugWithKeyAndJoyStick(): g_GUI_CheckForDebugWithKeyAndJoyStick = %d</code> <br> <br><font style="vertical-align: inherit;"></font><code>ScanningForDebugWithKeyAndJoyStick</code><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9e/525/cd2/e9e525cd2bc493e7bb8cc4b3710b1334.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o vou mentir, demorou algum tempo para entender como os bot√µes de hardware s√£o processados ‚Äã‚Äãno firmware e depois restaurar os tipos enumerados para os bot√µes e o joystick. Mas quando recebi a combina√ß√£o, descobri com pesar que ela n√£o estava fazendo nada. Provavelmente s√≥ funciona em uma p√°gina espec√≠fica da GUI. Mais algumas noites de rastreamento manual da m√°quina de estado da GUI - e o problema foi resolvido, e tamb√©m conseguimos encontrar a p√°gina de menu Redefinir. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, bem-vindo ao modo de depura√ß√£o. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/526/74d/068/52674d068ae127cc7b90b5b1172de325.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pensei muito em anunciar essa combina√ß√£o, mas decidi me abster. Respeito o trabalho √°rduo que a Leica realiza, liberando seus dispositivos exclusivos, e n√£o quero ser respons√°vel pelo fato de que seus centros de servi√ßo preencher√£o as carca√ßas quebradas das c√¢meras como resultado de alguma curiosidade impensada.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mas, ainda assim, fornecerei alguns tipos enumerados para simplificar a engenharia reversa para aqueles que est√£o prontos para seguir esse caminho. </font></font><br><br><pre> <code class="plaintext hljs">enum ControlActionType { kControlAction_Idle, // 0 kControlAction_Push, // 1 kControlAction_Release, // 2 kControlAction_LongPush // 3 }; enum ControlBtnType { kControlBtn_LV, // 0 kControlBtn_PLAY, // 1 kControlBtn_DEL, // 2 kControlBtn_ISO, // 3 kControlBtn_MENU, // 4 kControlBtn_SET // 5 }; enum ControlJoystickType { kControlJoy_INFO, // 0 kControlJoy_Up, // 1 kControlJoy_Down, // 2 kControlJoy_Left, // 3 kControlJoy_Right // 4 };</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pensando na tarefa USB, defini tr√™s modos (o que tamb√©m √© confirmado no menu de depura√ß√£o): </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSC (Classe de Armazenamento em Massa) </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leica custom </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O PTP √© mais interessante porque est√° bem documentado e permite controlar a c√¢mera. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â bastante f√°cil encontrar manipuladores de PTP no firmware, porque h√° muitas chamadas desse c√≥digo. </font><font style="vertical-align: inherit;">Todas as chamadas de PTP s√£o divididas em tr√™s grupos: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica Extended (LE)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produ√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A depura√ß√£o de mensagens ajudou a estabelecer nomes para quase todo o c√≥digo.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Legado: Leica Extens√£o: Produ√ß√£o:                           </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x1001 - GetDeviceInfo 0x9001 - Definir configura√ß√µes da c√¢mera 0x9100 - Abrir sess√£o de produ√ß√£o      </font></font><font></font>
0x1002 - OpenSession 0x9002 - Get Camera Settings 0x9101 - Close Production Session     <font></font>
0x1003 - CloseSession 0x9003 - Get Lens Parameter 0x9102 - UpdateFirmware               <font></font>
0x1004 - Get Storage ID 0x9004 - Release Stage 0x9103 - Open OSD Session             <font></font>
0x1005 - Get Storage Info 0x9005 - Open LE Session 0x9104 - Close OSD Session            <font></font>
0x1006 - GetNumObjects 0x9006 - Close LE Session 0x9105 - Get OSD Data                 <font></font>
0x1007 - GetObjectHandles 0x9007 - RequestObjectTransferReady 0x9106 - GetFirmwareStruct            <font></font>
0x1008 - GetObjectInfo 0x9008 - GetGeoTackingData 0x910B - GetDebugMenu                 <font></font>
0x1009 - GetObject 0x900A - Open Debug Session 0x910C - SetDebugMenu                 <font></font>
0x100A - Get Thumb 0x900B - Close Debug Session 0x910D - ODIN Message                 <font></font>
0x100B - Delete Object 0x900C - Get Debug Buffer 0x910E - GetDebugObjectHandles        <font></font>
0x100E - Initiate Capture 0x900D - Debug Command String 0x910F - GetDebugObject               <font></font>
0x1014 - GetDevicePropDesc 0x900E - Get Debug Route 0x9110 - DeleteDebugObject            <font></font>
0x1015 - GetDevicePropV 0x900F - SetIPTCData 0x9111 - GetDebugObjectInfo           <font></font>
0x101C - Initiate Open Capture 0x9010 - GetIPTCData 0x9112 - WriteDebugObject             <font></font>
                                   0x9020 - Get3DAxisData 0x9113 - CreateDebugObject            <font></font>
                                   0x9030 - OpenLiveViewSession 0x9114 - Calibrate 3Daxis             <font></font>
                                   0x9031 - CloseLiveViewSession 0x9115 - Magnetic calibration         <font></font>
                                   0x9033 - Unknown 0x9116 - Get Viewfinder Data </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A implementa√ß√£o da interface PTP em si parece padr√£o, mas alguns comandos t√™m limita√ß√µes que eu intencionalmente omito aqui. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De qualquer forma, todas as op√ß√µes acima s√£o bastante emocionantes. </font><font style="vertical-align: inherit;">Voc√™ pode pensar: "Vamos conectar a c√¢mera via USB e come√ßar a pesquisar com a libptp".</font></font> Isso mesmo. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Droga ... O </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica M240 n√£o possui uma porta USB.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lidar com porta </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Leica oferece poucos acess√≥rios para esta c√¢mera, mas h√° um especialmente interessante. </font><font style="vertical-align: inherit;">Estamos falando do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cabo multifuncional Leica M (14495)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele substitui a parte de metal inferior do gabinete, fornece GPS embutido e v√°rios conectores como USB, um terminal flash SCA, DIN / ISO-X e uma tomada. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fab/250/1b6/fab2501b6e69cb6caf3f62528e413bdb.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E voc√™ diz novamente: ‚Äú√ìtimo, agora compre, conecte-o √† c√¢mera, conecte-a via USB e comece a pesquisar usando o libptp.‚Äù</font></font> Isso mesmo. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√≥ que droga ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custa quase 900 d√≥lares. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√£o quase novecentas raz√µes para criar seu pr√≥prio adaptador. </font><font style="vertical-align: inherit;">No entanto, por precau√ß√£o, configurei as notifica√ß√µes do eBay para este acess√≥rio.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conector </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O conector da c√¢mera √© o seguinte: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a29/4f0/388/a294f0388ad2c5ac3d355d0838e01586.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tentei encontr√°-lo na Internet, mas, falando s√©rio, como voc√™ o descreveria no Google? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desesperado, comecei a pensar em algumas coisas malucas, como colar papel alum√≠nio ou agulhas na borracha. Mas, uma vez trabalhando no Blackmagic Design, olhando para a placa de circuito da c√¢mera, notei que um dos conectores tinha um formato muito familiar. No dia seguinte, trouxe meu Leica M240 para trabalhar - e sim, parecia semelhante, por muito mais tempo com muitas almofadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resta perguntar o n√∫mero de pe√ßa do nosso gerenciador de componentes e, em seguida, localiz√°-lo no cat√°logo da Samtec: </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERM8-013-05.0-L-DV-TR</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a60/dc3/d36/a60dc3d36d12216f74690577507fc6db.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m perguntamos √† Samtec se era poss√≠vel obter uma amostra e eles concordaram.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/752/0d6/dda7520d6691fc48f3f1aaa026e49635.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de trabalho com um ferro de solda, papel√£o e fita isolante - e meu pr√≥prio plugue est√° pronto (amostra de 2013). </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/243/fe5/ddd243fe596648709c3f9dccb76f15ea.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cinco anos depois, em 2018, decidi pedir pessoalmente √† Samtec para enviar outra amostra. </font><font style="vertical-align: inherit;">Eu queria fazer algo melhor. </font></font><br><br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERCD-013-05.00-TTR-TTR-1-D</font></font></a></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/e1a/56a/995/e1a56a9958b1dda50aca34f0ecac8863.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais uma vez, muito trabalho com um ferro de soldar, praguejar, cortar arame, praguejar, novamente trabalhar com um ferro de soldar para criar uma op√ß√£o nova e mais atraente:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a5/b78/10d/1a5b7810d3a2ccea73bf4e2d75cad8cd.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pinagem </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem 26 contatos no conector: 13 de cada lado. Mesmo antes de soldar minha pe√ßa, eu testei o conector da c√¢mera com um mult√≠metro e um analisador l√≥gico. A prop√≥sito, voc√™ precisa colocar um √≠m√£ no sensor da tampa inferior para que a c√¢mera considere que a tampa est√° no lugar. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terra (c√¢mera desligada, sem bateria)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu sempre come√ßo do ch√£o porque √© seguro e muito f√°cil de encontrar. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/140/15c/ead14015c97177d6717e198616c9114b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, temos oito linhas de fundo (cinza escuro). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potencial (c√¢mera ligada)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quando a c√¢mera est√° ligada, voc√™ pode medir o potencial em cada pino e ter uma id√©ia dos n√≠veis de l√≥gica e pot√™ncia. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexhude.github.io/assets/2019/2019-01-24-hacking-leica-m240/probe2_potential.png</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O desempenho nos pinos 8‚Äì9 e 11‚Äì13 √© muito alto para os pinos l√≥gicos, ent√£o eu os defini como pot√™ncia (vermelho). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resist√™ncia (c√¢mera desligada, sem bateria)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â √∫til medir a resist√™ncia. Em alguns casos, isso ajuda a identificar as entradas e agrupar algumas linhas. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/fde/1a6/fa7fde1a623a5f13d264a5127a3083d2.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sa√≠das conectadas (c√¢mera desligada, sem bateria)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Decidi verificar todas as almofadas externas no corpo da c√¢mera para verificar se est√£o conectadas √† porta de servi√ßo. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f75/61e/c06/f7561ec060796fa8e39a15d533e3de03.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O contato de sincroniza√ß√£o do flash foi conectado diretamente √† linha 10. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analisador l√≥gico (c√¢mera ligada) Os</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dados de cada linha foram gravados na seguinte sequ√™ncia: ligue-a, a c√¢mera deve estar no modo LV, tirar uma foto e iniciar a grava√ß√£o de v√≠deo.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/494/33c/27c/49433c27cf94be5cb9430e4ba518560c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duas linhas mostram a transmiss√£o de alguns dados: 01 e 21. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmiss√£o de 8 bits, 1 bit de parada, bit de paridade, LSB primeiro. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/3a2/fdf/bf73a2fdfbbfeab571c354f2a6d50c9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A cada 500 ms, ele envia um contador </font></font><code>C3 3C 02 81 00 01 00 82, C3 3C 02 81 01 01 00 83, C3 3C 02 81 02 01 00 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmiss√£o de 8 bits, 1 bit de parada, sem bit de verifica√ß√£o de paridade, primeiro o LSB. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/423/2dd/f004232dd3f1b8c8f0e665fd63f3fa9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele envia o log do carregador de inicializa√ß√£o para o SH7216 (‚ÄúLeica Camera AG‚Äù na captura de tela acima). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos marc√°-los em azul escuro. √â muito triste que o registro do Maestro n√£o saia, mesmo com as configura√ß√µes m√°ximas de depura√ß√£o no menu Debug. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c44/541/bb9/c44541bb98c4388f151bdc3faffa1dfe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesses contatos, a resist√™ncia √© de cerca de 310kOhm.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o sei por que, mas sugeri que outras linhas de dados tenham resist√™ncia semelhante ou que ser√£o fechadas. Portanto, eu defini as linhas ~ 300kOhm, ~ 200kOhm e ~ 100kOhm como linhas de dados (tons de azul na imagem). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, a figura a seguir foi desenhada. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7e/31f/f2c/e7e31ff2cc7da6ae304652488ca9db4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12 candidatos na linha de dados. Mas como verific√°-los? Ap√≥s uma breve conversa com os especialistas em ferro sobre a prote√ß√£o el√©trica de circuitos integrados, comecei a cutucar os contatos atrav√©s de um resistor de 4kOhm, que reduz a corrente a um n√≠vel que as entradas n√£o devem queimar.</font></font><br><br><h4>  UART </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fiz outra suposi√ß√£o de que a linha RX deveria estar perto do TX. </font><font style="vertical-align: inherit;">As linhas 02, 03 e 20 parecem boas candidatas porque ambas t√™m uma tens√£o de 3,3 V como TX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicialmente, tentei explorar essas linhas usando o Bus Pirate. </font><font style="vertical-align: inherit;">Infelizmente, o resultado foi bastante sujo. </font><font style="vertical-align: inherit;">Ent√£o, peguei os cabos baseados em SiLabs como mais confi√°veis ‚Äã‚Äãe n√£o conflitantes no macOS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, conectei o cabo TX ao pino 20 e comecei a digitar </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ap√≥s o carregador de inicializa√ß√£o. </font><font style="vertical-align: inherit;">Como esperado, ap√≥s um pequeno atraso, a c√¢mera repetiu os caracteres. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a16/445/c00/a16445c00b6a22a6b37b74c97fc97ca5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os contatos 02 e 03 foram os pr√≥ximos candidatos √† UART. </font><font style="vertical-align: inherit;">Infelizmente, n√£o havia sinais de que essas linhas estavam sendo tocadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No diagrama, os UARTs conhecidos s√£o indicados por um tom de verde mais escuro.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/733/f68/fa1/733f68fa1950518017ad2c09971ac1f8.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> USB </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo come√ßou com o corte de um cabo USB ao meio, com um cabe√ßalho no meio e resistores de 4kOhm para detec√ß√£o. </font><font style="vertical-align: inherit;">Integridade do sinal de um par diferencial? </font><font style="vertical-align: inherit;">N√£o, ent√£o eu realmente n√£o me importo.</font></font> :) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/891/930/5d3/8919305d35cd2525d420313c2b0e7555.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois, examinei v√°rios dispositivos dom√©sticos USB em casa para ter uma id√©ia de como s√£o as comunica√ß√µes nessa porta. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canon Camera </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c49/f85/cf8/c49f85cf89650352531c83c970eb609c.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pocket Video Blackmagic </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/7e5/bc8/8b77e5bc8c2fa3387083a8e8ec12c3db.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camcorder Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/17f/dd4/67a/17fdd467a6627a4129f38d6e476d4ffc.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camcorder JVC </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/757/80d/4c8/75780d4c8a85c55c04afe5de9209e09d.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keychain </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/ad9/3a6/382/ad93a63828797eaea1f5d906367b792f.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camera Kidizoom</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/32e/d73/13a/32ed7313a12ef1cef1444a87c22f3c77.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eles s√£o todos um pouco diferente, mas o estado inicial de D- D + baixa. </font><font style="vertical-align: inherit;">Bem, vamos saber, e agora vamos verificar se temos:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - improv√°vel, porque D-D + √© um par diferencial e deve estar bem pr√≥ximo;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04/05</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √© improv√°vel por terem resist√™ncia diferente;</font></font><br></li><li> <b>14/15</b> ‚Äî ,      ; <br></li><li> <b>15/16</b> ‚Äî ,        . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conectei o USB D-D + aos pinos 15/16 e o ‚Äã‚ÄãiMac ... </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/777/491/b7f/777491b7f4a3b4b0f8376931db78c6c8.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na tela USB PTP, mas a c√¢mera n√£o apareceu no host. Tentei configurar op√ß√µes diferentes no layout do circuito eletr√¥nico, mas nada funcionou. O Beagle mostrou muitos pacotes danificados e outros erros. No final, desisti e voltei a fazer engenharia reversa do firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa √© a pinagem final, o USB est√° marcado em verde escuro. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ad/07d/289/2ad07d289a684e6db69a02ae9e50c294.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quem pensaria que, alguns anos depois, a mesma notifica√ß√£o do eBay chegaria at√© mim e comprarei muito barato o acess√≥rio desejado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, posso testar minhas suposi√ß√µes sobre PTP. Mas, a princ√≠pio, era muito curioso como o USB PHY fica dentro do dispositivo. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/0b1/afc/afe0b1afc09953f7f9c6dbc451c47c56.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dentro estava o hub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMSC 2512b</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diretamente na estrada, desde o conector do cabo at√© o conector Mini USB. O chip funciona no modo padr√£o porque n√£o h√° pinos EEPROM ou SCL / SDA. A primeira porta a jusante √© roteada para um soquete no corpo da c√¢mera, mas a segunda n√£o est√° conectada a nada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente perdi alguma coisa, mas para mim essa solu√ß√£o n√£o faz muito sentido. O passaporte t√©cnico diz que o chip "possui pinos USB totalmente integrados, al√©m de resistores para aumentar e diminuir a tens√£o". Talvez os engenheiros da Leica tenham decidido n√£o implementar o seu pr√≥prio PHY USB, mas usaram o do hub, que √© bem testado e funciona imediatamente. Na verdade, n√£o posso culp√°-los, porque antes eu tentei fazer isso, e acabou sendo uma tarefa dif√≠cil. Talvez esse seja um recurso de prote√ß√£o contra falsifica√ß√µes, quem sabe.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> De qualquer forma, se voc√™ entende o USB PHY e est√° pronto para ajudar, n√£o hesite em me escrever: deve ser poss√≠vel trabalhar atrav√©s de uma porta USB sem este acess√≥rio de marca :) </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PTP novamente </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como eu disse, √© hora de brincar com a extens√£o PTP da Leica. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Felizmente, encontrei uma biblioteca C ++ bem legal em vez do libptp - √© o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libEasyPTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tamb√©m n√£o demorou muito tempo para escrever uma ferramenta baseada nesta biblioteca: eu j√° conhecia algumas limita√ß√µes na interface Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E embora o M240PTPTool seja bastante problem√°tico, ele √© adequado para o papel de prova de conceito ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo do programa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apenas duas solicita√ß√µes passam pelo PTP: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetDebugBuffer (0x900C)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DebugCommandString (0x900D)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A prop√≥sito, para que os m√≥dulos preencham o log de depura√ß√£o, voc√™ precisa definir o N√≠vel de depura√ß√£o como "Debug" ou "Debug RAW" no menu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem v√°rias op√ß√µes na interface M240PTPTool:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - feche a ferramenta;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flush</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - mescla o buffer de depura√ß√£o da c√¢mera:</font></font></li></ul><br> <code>M240&gt; flush <br> I:[00:11:468]|01| DATE/TIME CORRECTED by 5921 sec <br> D:[00:12:079]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:179]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:282]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:283]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:301]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:402]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:502]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> ...</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualquer outro texto √© enviado para a c√¢mera como um comando de depura√ß√£o. </font><font style="vertical-align: inherit;">Por exemplo, ele </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exibe todos os comandos poss√≠veis com argumentos: A </font><font style="vertical-align: inherit;">lista completa √© bastante grande, mas veja, voc√™ pode enviar mensagens diretas ao Softune para qualquer tarefa! </font><font style="vertical-align: inherit;">O que seria t√£o interessante enviar para l√° ... </font><font style="vertical-align: inherit;">Outra linha popular que √© frequentemente procurada no firmware √© </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vamos ver se temos um. </font><font style="vertical-align: inherit;">Aparentemente, voc√™ pode despejar o firmware no cart√£o SD. </font><font style="vertical-align: inherit;">Usando o link para a linha ‚ÄúDumping files to card‚Äù, √© f√°cil encontrar o c√≥digo respons√°vel por isso. </font><font style="vertical-align: inherit;">Ele est√° localizado no gigantesco bloco Tarefa do Sistema (pid 11, como j√° sabemos) e √© chamado pela mensagem </font><font style="vertical-align: inherit;">sem argumentos. </font><font style="vertical-align: inherit;">Dial </font><font style="vertical-align: inherit;">em </font><b><font style="vertical-align: inherit;">M240PTPTool</font></b><font style="vertical-align: inherit;"> , pressione Enter e olhar para a tela.</font></font><br><br> <code>M240&gt; help <br> ********* debug command description ******** <br> <br> exposure request <br> Description: requests a release from Sub CPU <br> Parameter 1: Exposure Time TV <br> <br> still request <br> Description: simulates the -still request- command flow of Sub CPU <br> Parameter: no <br> <br> ... <br> <br> send Message;[Parameter1];[Parameter2];[Parameter2];...;... <br> Description: Sending Message to Task <br> Parameter 1: Receiver Task ID <br> Parameter 2: Command ID <br> Parameter 3: Command Data[0] (32 Bit) <br> Parameter 4: Command Data[1] (32 Bit) <br> Parameter 5: . <br> Parameter 6: . <br> use maximum 10 Parameter <br> <br> ...</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>dump</code><font style="vertical-align: inherit;"></font><br><br> <code>$ strings IMG_LOKI-212_1.1.0.2.bin | rg -i dump <br> GUI: HEX DUMP: Address: %x, Length: %d <br> HSK: DBG_WRITE_ROM_DUMP_SD: File was properly opened, but it seems to be empty. <br> ROM_DUMP <br> HSK: DBG_WRITE_ROM_DUMP_SD: Flushing Dump to ROM. Size %d <br> SD:\ROM_DUMP.bin <br> HSK: DBG_WRITE_ROM_DUMP_SD Command received! <br> ROM_DUMP.bin <br> HSK: DUMP failed, no cards inserted! <br> HSK: DUMP FlashROM to SD card. <br> HSK: DUMP FlashROM to CF card. <br> Dumping files to card</code> <br> <br><font style="vertical-align: inherit;"></font><code>0x11080006</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>send Message;11;0x11080006</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4de/1cc/e2e/4de1cce2e0ee47a67645df790a7e581c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, remova o cart√£o SD e verifique o que est√° nele. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/209/2a8/25e/2092a825e23cb93c4845b416ea11b0e4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√°, um despejo completo, incluindo firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso abre infinitas possibilidades. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode criar um pequeno dispositivo com um MCU, suporte a um host USB e bot√µes para iniciar sequ√™ncias complexas de mensagens ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E ent√£o tivemos um segundo filho.</font></font> :) <br><br><h1>  Ep√≠logo </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ n√£o deseja quebrar o dispositivo, geralmente h√° uma maneira de examin√°-lo sem abrir a caixa ou os fios de solda na placa de circuito. </font><font style="vertical-align: inherit;">Abaixo est√£o minhas dicas, se voc√™ estiver interessado:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontre todas as informa√ß√µes p√∫blicas sobre o dispositivo: especifica√ß√µes t√©cnicas, dados sobre componentes, fotos do interior, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo da f√°brica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;)</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se voc√™ tiver firmware, mergulhe nele e procure dicas sobre sa√≠das externas; </font></font><br></li><li>        ,     ; <br></li><li>  GND//    ,  ; <br></li><li>     ; <br></li><li>     ,   ; <br></li><li>   ,     (, ); <br></li><li>        ,    Google   (USB/UART/SPI/I2C/1Wire); <br></li><li>      ,      ; <br></li><li>  <s></s>  ,      ; <br></li><li>  ,    . </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/18b/006/166/18b006166a4070202c1be3a9b946c3e9.png"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/alexhude</a> <br><br> <b>  !</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438168/">https://habr.com/ru/post/pt438168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438152/index.html">‚ÄúPosso falar sobre a dor que todo desenvolvedor de iOS tem na bunda‚Äù - 10 perguntas a um desenvolvedor, epis√≥dio 2</a></li>
<li><a href="../pt438158/index.html">Os corretores de dados dos EUA vendem dados de localiza√ß√£o sem o consentimento do usu√°rio - seu trabalho ser√° regulamentado</a></li>
<li><a href="../pt438162/index.html">A tupla de uma pessoa saud√°vel</a></li>
<li><a href="../pt438164/index.html">Gen√©tica e galinhas: prote√≠na CSF1-Fc humana na prote√≠na do ovo</a></li>
<li><a href="../pt438166/index.html">Intera√ß√£o entre um site em um navegador e um programa em execu√ß√£o local</a></li>
<li><a href="../pt438170/index.html">Pr√™mio nomeado ap√≥s Ilya Segalovich. Hist√≥ria sobre Ci√™ncia da Computa√ß√£o e Publica√ß√µes de Lan√ßamento</a></li>
<li><a href="../pt438172/index.html">Apple incapaz de transferir a produ√ß√£o de seus dispositivos para os EUA</a></li>
<li><a href="../pt438174/index.html">Amarelo - V√°cuo - Nuvem</a></li>
<li><a href="../pt438176/index.html">Vis√£o geral do IPSec no Mikrotik</a></li>
<li><a href="../pt438178/index.html">Criando seu primeiro aplicativo ARCore</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>