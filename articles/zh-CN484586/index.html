<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛑 🏘️ 😼 在PHP中使用IPv6 📐 👊🏾 👍🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们最近收到了LIR状态和/ 29 IPv6阻止。 然后，需要跟踪指定的子网。 而且由于我们的帐单是用PHP编写的，所以我不得不从这个问题中得到一些启发，并意识到这种语言并不是使用IPv6时最友好的语言。 削减-我们解决地址和范围问题的解决方案。 也许不是最优雅，但它执行任务。 



 一点理论 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在PHP中使用IPv6</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/484586/"> 我们最近收到了LIR状态和/ 29 IPv6阻止。 然后，需要跟踪指定的子网。 而且由于我们的帐单是用PHP编写的，所以我不得不从这个问题中得到一些启发，并意识到这种语言并不是使用IPv6时最友好的语言。 削减-我们解决地址和范围问题的解决方案。 也许不是最优雅，但它执行任务。 <br><br><img src="https://habrastorage.org/webt/bk/on/p9/bkonp9-y-sxfdqvirte2ehjunr0.jpeg"><a name="habracut"></a><br><br><h3> 一点理论 </h3><br><blockquote>  <b>免责声明</b> 如果您熟悉什么是IPv6以及将其与之搭配使用，那么这部分可能对您来说很无聊。 可能不是。 </blockquote><br> 第一次看到IPv6注释的人可能会灰心。 在优雅的<i>64.233.177.101之后，</i>我们突然遇到<i>2607：f8b0：4002：c08 :: 8b</i>并可能感到困惑。 两者以及另一个-分别是人类可读的32位和128位表示。 任何IP数据包都包含一个标头，每个标头都经过严格标准化的分配。 在不深入了解标头的结构的情况下，我们需要从这里得到一件事：对于具有IP地址和范围的操作，使用二进制数学和按位运算通常很方便。 将它们存储为数据库中的<i>BINARY（4）</i>和IPv6的<i>BINARY（16）</i>也是最方便的。 <br><br> 应解决的另一个重要方面是网络掩码和CIDR表示法。  CIDR是无类域间路由的缩写。 在确定IP地址的哪一部分是网络前缀以及哪一部分是该网络内的网络接口地址的问题上，此概念替代了第一类。 实际上，与前缀相对应的前n位将设置为1，其余为0。 <br><br> 以人类可读的形式，它写为<i>ip.add.re.ss./cidr</i> 。 例如， <i>64.233.177.0/</i> 24表示前24位是指前缀。 最后8位是人类可读条目中的最后一个数字，指的是子网内的地址。 多做几次练习。  <i>64.233.177.101/32</i>和<i>2607：f8b0：4002：c08 :: 8b / 128-</i>一个特定的地址。  <i>2607：f8b0：4002：c08：// 64-</i>前64位（前4组）-前缀，其余64位-本地部分。 顺便说一句，如果有人为条目中的“ ::”感到尴尬，则双冒号替换任意数量的包含0的节。它只能在注释中出现1次。 换句话说， <i>2607：f8b0：4002：c08 :: 8b = 2607：f8b0：4002：c08：0 0：0 0：8b</i> 。 <br><br> 我们需要从这一切中学到什么？ 首先，可以使用二进制“与”和“或”获得二进制形式的掩码，从而获得第一个和最后一个子网地址。 其次，可以通过在二进制表示形式的第<b>n</b>个位置加1来计算下一个大小为子网（即CIDR）的子网。 通过二进制视图，我的意思是使用<i>bind</i>的<i>pack（）</i>和<i>inet_pton（）</i>函数以及进一步使用<a href="https://www.php.net/manual/ru/language.operators.bitwise.php">按位运算符</a>的结果，即<i>binary-</i>二进制系统中的一种表示形式，可以使用<i>base_convert（）获得</i> 。 <br><br><div class="spoiler">  <b class="spoiler_title">历史背景</b> <div class="spoiler_text">无类别<s>隔离是</s>在无类别之前进行的。 在那些遥远的年代，没有人期望会有如此多的子网；它们以大块的形式左右分布：A类-前8位（即第一个数字）被前缀，前导0。  B类-前16个（前两个数字），前10位；  C类-前24位，即110的前导位。这些相同的前导位设置了发出类地址的范围：A类为<i>0.0.0.0-127.255.255.255</i> ，A类为<i>128.0.0.0-191.255.255.255</i> -B类为192.0 .0.0-223.255.255.255-C级。随着互联网在全球范围内的传播，监管机构意识到他们已经错过了，并且在90年代初开发了一种无阶级概念，这使他们不再迷恋领先地位。 比方说，更多的细节可以在<a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">无所不知的世界中找到</a> 。 </div></div><br><br><h3> 让我们继续练习 </h3><br> 实际上，在我看来，我们执行了三个最可能的任务： <br><br><ol><li> 获取范围的第一个和最后一个地址； </li><li> 获得给定大小的下一个范围（CIDR）； </li><li> 检查地址是否属于范围。 </li></ol><br> 该实现将针对IPv6，但如有必要，可以轻松调整逻辑。 我从<a href="https://intsystem.org/coding/kak-rabotat-s-ipv6-v-php/">这里</a>得到了一些想法，但是实现了一些不同。 同样在示例中，也没有检查输入错误。 所以走吧 <br><br> 正如我已经提到的，可以使用按位运算来确定范围的第一个和最后一个地址，知道范围的开始和二进制子网掩码。 因此，我们需要做的第一件事就是将CIDR转换为二进制掩码。 为此，请收集其十六进制表示并将其打包为二进制。 <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cidrToMask</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($cidr)</span></span></span><span class="hljs-function"> </span></span>{ $mask = str_repeat(<span class="hljs-string"><span class="hljs-string">'f'</span></span>, ceil($cidr / <span class="hljs-number"><span class="hljs-number">4</span></span>)); $mask .= dechex(<span class="hljs-number"><span class="hljs-number">4</span></span> * ($cidr % <span class="hljs-number"><span class="hljs-number">4</span></span>)); $mask = str_pad($mask, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>, $mask); }</code> </pre> <br> 调用<i>包（“ H *”，$ mask）</i>以与<i>inet_pton（）</i>相同的方式打包十六进制表示。 唯一的区别是，当您调用<i>pack（）时，</i>与人类可读的条目相反，条目必须全为0，并且条目中不应包含冒号。 <br><br> 下一步是计算范围的开始和结束。 这里有细微差别。 按位操作受处理器容量的限制。 因此，在我有时用于任何测试纵容的32位CubieTruck上，无法一次执行处理地址的所有128位。 但是，没有什么可以阻止我们将其分成32位的组（以防万一，谁知道我们将在哪个处理器上运行）。 <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRangeBoundary</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ip, $cidr, $which, $ipIsBin = false, $returnBin = false)</span></span></span><span class="hljs-function"> </span></span>{ $mask = cidrToMask($cidr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$ipIsBin) { $ip = inet_pton($ip); } $ipParts = str_split($ip, <span class="hljs-number"><span class="hljs-number">4</span></span>); $maskParts = str_split($mask, <span class="hljs-number"><span class="hljs-number">4</span></span>); $rangeParts = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; count($ipParts); $i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($which == <span class="hljs-string"><span class="hljs-string">'start'</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*  &amp;       . */</span></span> $rangeParts[$i] = $ipParts[$i] &amp; $maskParts[$i]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*  |    (~)           1. */</span></span> $rangeParts[$i] = $ipParts[$i] | ~$maskParts[$i]; } } $rangeBoundary = implode($rangeParts); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($returnBin) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $rangeBoundary; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inet_ntop($rangeBoundary); } }</code> </pre> <br> 为了将来使用，我们将提供以二进制和人类可读形式传输IP并获得结果的功能。 这里的<i>$ which</i>参数设置我们是否要获取范围的开始或结束（值分别是<i>'start'</i>或<i>'end'</i> ）。 <br><br> 下一个任务（除了对我们公司最实际的任务）是计算下一个范围。 对于此任务，除了如何将地址分解为二进制字符串并在所需位置加1，然后将所有内容折回外，什么都没有想到。 为了防止工件出现在任何地方，我决定在分解和汇编过程中按字节分割地址。 <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ipStart, $cidr, $ipIsBin = false, $returnBin = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$ipIsBin) { $ipStart = inet_pton($ipStart); } $ipParts = str_split($ipStart, <span class="hljs-number"><span class="hljs-number">1</span></span>); $ipBin = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($ipParts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $ipPart) { $ipBin .= str_pad(base_convert(unpack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>, $ipPart)[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>, STR_PAD_LEFT); } <span class="hljs-comment"><span class="hljs-comment">/*  1       "" :) */</span></span> $i = $cidr - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($ipBin[$i] == <span class="hljs-string"><span class="hljs-string">'0'</span></span>) { $ipBin[$i] = <span class="hljs-string"><span class="hljs-string">'1'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $ipBin[$i] = <span class="hljs-string"><span class="hljs-string">'0'</span></span>; } $i--; } $ipBinParts = str_split($ipBin, <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($ipBinParts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $ipBinPart) { $ipParts[$key] = pack(<span class="hljs-string"><span class="hljs-string">'H*'</span></span>, str_pad(base_convert($ipBinPart, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>), <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>, STR_PAD_LEFT)); } $nextIp = implode($ipParts); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($returnBin) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $nextIp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inet_ntop($nextIp); } }</code> </pre> <br> 输出将是<i>$ cidr中</i>指定的下一个大小范围的前缀。 使用此功能，我们可以为客户分配地址块。 <br><br> 最后，检查地址是否属于该范围。 例如，我们为分配给客户的/ 64个块分配了一个/ 48个块，并且我们需要确保在约会期间我们不会超出分配的块（实际上这会很快发生，但是仍然有机会）。 这里的一切都很简单。 我们以二进制形式获取范围的开始和结束，并检查地址是否在其中。 <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipInRange</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ip, $rangeStart, $cidr)</span></span></span><span class="hljs-function"> </span></span>{ $start = getRangeBoundary($rangeStart, $cidr, <span class="hljs-string"><span class="hljs-string">'start'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $end = getRangeBoundary($rangeStart, $cidr, <span class="hljs-string"><span class="hljs-string">'end'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $ipBin = inet_pton($ip); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ($ipBin &gt;= $start &amp;&amp; $ipBin &lt;= $end); }</code> </pre> <br> 希望对您有所帮助。 您还会发现其他哪些寻址功能有用？ 在评论中热烈欢迎任何添加，评论和代码评论。 <br><br> 如果您已经是我们的客户，或打算成为一个客户，在发布本文时，我们建议您向荷兰销售部门索取免费的Block / 64，以获取所有vps服务或荷兰Equinix Tier IV数据中心内的专用服务器的专用服务器。票中的这篇文章。 优惠有效期至2020年3月。 <br><br><h3> 一点广告：） </h3><br> 感谢您与我们在一起。 你喜欢我们的文章吗？ 想看更多有趣的资料吗？ 通过下订单或向您的朋友推荐给<a href="https://ua-hosting.company/cloudvps/nl">开发人员的基于云的VPS，</a> <a href="https://habr.com/company/ua-hosting/blog/347386/">最低</a> <a href="https://ua-hosting.company/cloudvps/nl">价格为4.99美元</a> ， <b>这是我们为您发明的入门级服务器</b>的<b>独特类似物：</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">关于VPS（KVM）E5-2697 v3（6核）的全部真相10GB DDR4 480GB SSD 1Gbps从$ 19还是如何划分服务器？</a>  （RAID1和RAID10提供选件，最多24个内核和最大40GB DDR4）。 <br><br>  <b>阿姆斯特丹的Equinix Tier IV数据中心的戴尔R730xd便宜2倍吗？</b> 仅<b>在荷兰，</b>我们有<b><a href="https://ua-hosting.company/serversnl">2台Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100电视</a> ！</b>  <b><b>戴尔R420-2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB-$ 99起！</b></b> 阅读有关<a href="https://habr.com/company/ua-hosting/blog/329618/">如何构建基础架构大厦的信息。</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">使用价格为9000欧元的Dell R730xd E5-2650 v4服务器的上等课程？</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484586/">https://habr.com/ru/post/zh-CN484586/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484574/index.html">没有滴答声！ 植物与莱姆病载体</a></li>
<li><a href="../zh-CN484578/index.html">服务水平目标-Google体验（Google SRE图书章节的翻译）</a></li>
<li><a href="../zh-CN484580/index.html">您需要了解的有关内存模拟器的知识</a></li>
<li><a href="../zh-CN484582/index.html">ASP.NET MVC-实体框架，MySQL并使用Dependency Resolver选择存储库</a></li>
<li><a href="../zh-CN484584/index.html">为什么我们在IT项目中需要经理，如果没有经理，会发生什么？</a></li>
<li><a href="../zh-CN484588/index.html">自动化程序管理模型</a></li>
<li><a href="../zh-CN484590/index.html">这样男孩们就不会羞于表现出来</a></li>
<li><a href="../zh-CN484592/index.html">上周第398期（2020年1月13日至19日）来自前端世界的新鲜材料摘要</a></li>
<li><a href="../zh-CN484596/index.html">Blazor客户端在线商店：第1部分-授权oidc（oauth2）+ Identity Server4</a></li>
<li><a href="../zh-CN484600/index.html">Microsoft点燃巡回布拉格技术会议</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>