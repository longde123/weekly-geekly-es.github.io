<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç≤ üçå üíª Ir a ir! C√≥mo el equipo de PHP comenz√≥ a escribir microservicios ‚ò†Ô∏è üöí üë©üèæ‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! Mi nombre es Alexey Skorobogaty, soy arquitecto de sistemas en Lamoda. En febrero de 2019, habl√© en Go Meetup mientras a√∫n estaba en la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ir a ir! C√≥mo el equipo de PHP comenz√≥ a escribir microservicios</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/478740/"><p>  Hola a todos!  Mi nombre es Alexey Skorobogaty, soy arquitecto de sistemas en Lamoda.  En febrero de 2019, habl√© en Go Meetup mientras a√∫n estaba en la posici√≥n de l√≠der del equipo Core.  Hoy quiero presentar una transcripci√≥n de mi informe, que tambi√©n pueden <a href="https://www.youtube.com/watch%3Fv%3DF5IVE0IpGJY%26t%3D4s">ver.</a> </p><br><p>  Nuestro equipo se llama Core por una raz√≥n: el √°rea de responsabilidad incluye todo lo relacionado con los pedidos en la plataforma de comercio electr√≥nico.  El equipo estaba formado por desarrolladores de PHP y especialistas en nuestro procesamiento de pedidos, que en ese momento era un solo monolito.  Est√°bamos comprometidos y continuamos lidiando con su descomposici√≥n en microservicios. </p><br><p><img src="https://habrastorage.org/webt/qu/71/2m/qu712m7duwr6k_fcoworp0io0go.png" alt="imagen"></p><a name="habracut"></a><br><p>  Un pedido en nuestro sistema consta de componentes relacionados: hay una unidad de entrega y una cesta, unidades de descuento y pago, y al final hay un bot√≥n que env√≠a el pedido a recoger en el almac√©n.  Es en este momento que comienza el trabajo del sistema de procesamiento de pedidos, donde se validar√°n todos los datos del pedido y se agregar√° la informaci√≥n. </p><br><p><img src="https://habrastorage.org/webt/pm/va/0h/pmva0huzhbmc7szecb-088cnlz8.png" alt="imagen"></p><br><p>  Dentro de todo esto hay una compleja l√≥gica multicriterio.  Los bloques interact√∫an entre s√≠ e influyen entre s√≠.  Los cambios continuos y constantes del negocio se suman a la complejidad de los criterios.  Adem√°s, tenemos diferentes plataformas a trav√©s de las cuales los clientes pueden crear pedidos: sitio web, aplicaciones, call center, plataforma B2B.  Adem√°s de los estrictos criterios SLA / MTTI / MTTR (m√©tricas de registro y resoluci√≥n de incidentes).  Todo esto requiere una gran flexibilidad y estabilidad del servicio. </p><br><h3 id="arhitekturnoe-nasledie">  Patrimonio arquitectonico </h3><br><p>  Como ya dije, en el momento de la formaci√≥n de nuestro equipo, el sistema de procesamiento de pedidos era un monolito: casi 100 mil l√≠neas de c√≥digo que describ√≠an directamente la l√≥gica empresarial.  La parte principal fue escrita en 2011 usando la arquitectura cl√°sica de MVC multicapa.  Se bas√≥ en PHP (el marco ZF1), que fue gradualmente cubierto de adaptadores y componentes de Symfony para interactuar con varios servicios.  Durante su existencia, el sistema ten√≠a m√°s de 50 contribuyentes, y aunque logramos mantener un estilo unificado de escritura de c√≥digo, esto tambi√©n impuso sus limitaciones.  Adem√°s, surgi√≥ una gran cantidad de contextos mixtos; por diversas razones, se implementaron algunos mecanismos en el sistema que no estaban directamente relacionados con el procesamiento de pedidos.  Todo esto llev√≥ al hecho de que en este momento tenemos una base de datos MySQL mayor de 1 terabyte. </p><br><p> Esquem√°ticamente, la arquitectura inicial se puede representar de la siguiente manera: </p><br><p><img src="https://habrastorage.org/webt/go/cd/ht/gocdht4rqheqf9wgfglpwbfqir4.png" alt="imagen"></p><br><p>  El orden, por supuesto, estaba en cada una de las capas, pero adem√°s del orden, hab√≠a otros contextos.  Comenzamos definiendo el contexto acotado del pedido y llam√°ndolo el pedido del cliente, ya que adem√°s del pedido en s√≠, existen los mismos bloques que mencion√© al principio: entrega, pago, etc.  Dentro del monolito, todo esto fue dif√≠cil de manejar: cualquier cambio condujo a un aumento de las dependencias, el c√≥digo se entreg√≥ al producto durante mucho tiempo y la probabilidad de errores y fallas del sistema aument√≥ todo el tiempo.  Pero estamos hablando de crear un pedido, la m√©trica principal de una tienda en l√≠nea: si los pedidos no se crean, el resto no es tan importante.  La falla del sistema causa una ca√≠da inmediata en las ventas. </p><br><p>  Por lo tanto, decidimos transferir el contexto del Pedido del cliente desde el sistema de Procesamiento de pedidos a un microservicio separado, que se llam√≥ Gesti√≥n de pedidos. </p><br><p><img src="https://habrastorage.org/webt/dh/ce/sc/dhcesca21xejoakcoz4doqe6-qy.png" alt="imagen"></p><br><h3 id="trebovaniya-i-instrumentariy">  Requerimientos y herramientas </h3><br><p>  Despu√©s de determinar el contexto que decidimos eliminar del monolito en primer lugar, formamos los requisitos para nuestro servicio futuro: </p><br><ul><li>  Rendimiento </li><li>  Consistencia de datos </li><li>  Sostenibilidad </li><li>  Previsibilidad </li><li>  Transparencia </li><li>  Incremento de cambio </li></ul><br><p>  Quer√≠amos que el c√≥digo fuera lo m√°s claro y f√°cil de editar posible, para que la pr√≥xima generaci√≥n de desarrolladores pudiera hacer r√°pidamente los cambios necesarios para el negocio. </p><br><p>  Como resultado, llegamos a una cierta estructura que usamos en todos los microservicios nuevos: </p><br><p>  <strong>Contexto acotado</strong> .  Cada nuevo microservicio, comenzando con la Gesti√≥n de pedidos, creamos en funci√≥n de los requisitos comerciales.  Debe haber explicaciones espec√≠ficas de qu√© parte del sistema y por qu√© se requiere colocarlo en un microservicio separado. </p><br><p>  <strong>Infraestructura y herramientas existentes.</strong>  No somos el primer equipo en Lamoda en comenzar a implementar Go; antes de nosotros hab√≠a pioneros, el equipo Go en s√≠, que prepar√≥ la infraestructura y las herramientas: </p><br><ol><li>  Gogi (swagger) es un generador de especificaciones de swagger. </li><li>  Gonkey (prueba): para pruebas funcionales. </li><li>  Usamos Json-rpc y generamos un enlace cliente / servidor mediante swagger.  Tambi√©n implementamos todo esto en Kubernetes, recopilamos m√©tricas en Prometheus, utilizamos ELK / Jaeger para el seguimiento; todo esto est√° incluido en el paquete que Gogi crea para cada nuevo microservicio por especificaci√≥n. </li></ol><br><p>  As√≠ es como se ve nuestro nuevo microservicio de gesti√≥n de pedidos: </p><br><p><img src="https://habrastorage.org/webt/dl/1o/qk/dl1oqkgxhptthhlh-3wgn55q2jm.png" alt="imagen"></p><br><p>  En la entrada, tenemos datos, los agregamos, los validamos, interactuamos con servicios de terceros, tomamos decisiones y transferimos los resultados al procesamiento de pedidos, el mismo monolito que es grande, inestable y requiere recursos.  Esto tambi√©n debe tenerse en cuenta al construir un microservicio. </p><br><h3 id="sdvig-paradigmy">  Cambio de paradigma </h3><br><p>  Al elegir Ir, inmediatamente obtuvimos varias ventajas: </p><br><ul><li>  <strong>La escritura fuerte y est√°tica</strong> corta inmediatamente un cierto rango de posibles errores. </li><li>  <strong>El modelo de concurrencia se</strong> adapta bien a nuestras tareas, ya que necesitamos caminar y sondear simult√°neamente varios servicios. </li><li>  <strong>La composici√≥n y las interfaces tambi√©n</strong> nos ayudan en las pruebas. </li><li>  <strong>La "simplicidad" del estudio</strong> : aqu√≠ se descubrieron no solo ventajas obvias, sino tambi√©n problemas. </li></ul><br><p>  Go language limita la imaginaci√≥n del desarrollador.  Esto se convirti√≥ en un obst√°culo para nuestro equipo, acostumbrado a PHP cuando cambiamos al desarrollo en Go.  Nos enfrentamos a un cambio de paradigma real.  Tuvimos que pasar por varias etapas y entender algunas cosas: </p><br><ol><li>  Ir es dif√≠cil de construir abstracciones. </li><li>  Se puede decir que Go est√° basado en objetos, pero no es un lenguaje orientado a objetos, ya que no hay herencia directa y algunas otras cosas. </li><li>  Ir ayuda a escribir expl√≠citamente, en lugar de esconder objetos detr√°s de abstracciones. </li><li>  Ir tiene tuber√≠a.  Esto nos inspir√≥ a construir cadenas de procesadores de datos. </li></ol><br><p>  Como resultado, llegamos a comprender que <strong>Go es un lenguaje de programaci√≥n procesal.</strong> <br><img src="https://habrastorage.org/webt/i7/yl/hb/i7ylhb2z0jpa2xivzfbwr6vbj-o.png" alt="imagen"></p><br><h3 id="data-first">  Datos primero </h3><br><p>  Estaba pensando c√≥mo visualizar el problema que est√°bamos enfrentando y encontr√© esta imagen: </p><br><p><img src="https://habrastorage.org/webt/7j/4d/i8/7j4di8db5uuv2swuxpwdqg3nalg.png" alt="imagen"></p><br><p>  Esta es una visi√≥n del mundo "orientada a objetos" donde construimos abstracciones y cerramos objetos detr√°s de ellas.  Por ejemplo, aqu√≠ no es solo una puerta, sino un iniciador de sesi√≥n interior.  No el alumno, sino la interfaz de monitor de visitante, y as√≠ sucesivamente. </p><br><p>  Abandonamos este enfoque y colocamos entidades en primer lugar, sin obscurecernos por las abstracciones. </p><br><p>  Razonando de esta manera, ponemos datos en primer lugar, y obtuvimos dicha canalizaci√≥n en el servicio: </p><br><p><img src="https://habrastorage.org/webt/-2/nv/nb/-2nvnbuuplectds4ysnfddoae-c.png" alt="imagen"></p><br><p>  Inicialmente, definimos un modelo de datos que ingresa a la tuber√≠a del controlador.  Los datos son mutables y los cambios pueden ocurrir tanto de forma secuencial como simult√°nea.  Con esto, ganamos en velocidad. </p><br><h3 id="nazad-v-buduschee">  Regreso al futuro </h3><br><p>  De repente, al desarrollar microservicios, llegamos al modelo de programaci√≥n de los a√±os 70.  Despu√©s de los a√±os 70, surgieron grandes monolitos empresariales, donde apareci√≥ la programaci√≥n orientada a objetos, y la programaci√≥n funcional, grandes abstracciones que hicieron posible mantener el c√≥digo en estos monolitos.  En microservicios, no necesitamos todo esto, y podemos usar el excelente modelo de CSP ( <em>comunicaci√≥n de procesos secuenciales</em> ), cuya idea fue <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf">presentada solo en los a√±os 70 por Charles Hor.</a> <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf"><br></a> </p><br><p>  Tambi√©n utilizamos Secuencia / Selecci√≥n / Interaci√≥n, un paradigma de programaci√≥n estructural seg√∫n el cual todo el c√≥digo del programa puede estar compuesto por las estructuras de control correspondientes. </p><br><p>  Bueno, la programaci√≥n de procedimientos, que era la corriente principal en los a√±os 70 :) </p><br><h3 id="struktura-proekta">  Estructura del proyecto </h3><br><p><img src="https://habrastorage.org/webt/oe/xr/kj/oexrkjhvj4sf1zrx_kuyhvytb58.png" alt="imagen"></p><br><p>  Como dije, en primer lugar colocamos los datos.  Adem√°s, reemplazamos la construcci√≥n del proyecto "desde la infraestructura" por una orientada a los negocios.  Para que el desarrollador, al ingresar el c√≥digo del proyecto, vea de inmediato lo que est√° haciendo el servicio: esta es la transparencia que hemos identificado como uno de los requisitos b√°sicos para la estructura de nuestros microservicios. </p><br><p>  Como resultado, tenemos una arquitectura plana: una peque√±a capa API m√°s modelos de datos.  Y toda la l√≥gica (que est√° limitada en nuestro contexto por los requisitos comerciales de un microservicio) se almacena en procesadores (controladores). </p><br><p>  Intentamos no crear nuevos microservicios separados sin una solicitud clara de la empresa: as√≠ es como controlamos la granularidad de todo el sistema.  Si existe una l√≥gica que est√° estrechamente relacionada con el microservicio existente, pero esencialmente se refiere a un contexto diferente, primero lo concluimos en los llamados servicios.  Y solo cuando surge una necesidad comercial constante, la llevamos a un microservicio separado, que luego pasamos a usar una llamada rpc. </p><br><p>  Para controlar la granularidad y no producir microservicios sin pensar, concluimos una l√≥gica que no est√° directamente relacionada con este contexto, sino que est√° estrechamente relacionada con este microservicio, en la capa de servicios.  Y luego, si hay una necesidad comercial, lo llevamos a un microservicio separado, y luego lo usamos con la llamada rpc para acceder a √©l. </p><br><p><img src="https://habrastorage.org/webt/yh/ra/yp/yhraypbd9hd2b6uxu6t83cxgjh4.png" alt="imagen"></p><br><p>  Por lo tanto, para la API interna en los procesadores del servicio, la interacci√≥n no cambia de ninguna manera. </p><br><h3 id="ustoychivost">  Sostenibilidad </h3><br><p>  Decidimos no tomar bibliotecas de terceros por adelantado, ya que los datos con los que trabajamos son bastante confidenciales.  As√≠ que hicimos un ciclo un poco :) Por ejemplo, nosotros mismos implementamos algunos mecanismos cl√°sicos, para Idempotency, Queue-worker, Fault Tolerance, Compensating transacciones.  Nuestro siguiente paso es intentar reutilizarlo.  Envuelva en bibliotecas, tal vez contenedores laterales en vainas Kubernetes.  Pero ahora podemos aplicar estos patrones. </p><br><p>  Implementamos en nuestros sistemas un patr√≥n llamado degradaci√≥n elegante: el servicio debe continuar funcionando, independientemente de las llamadas externas en las que agreguemos informaci√≥n.  En el ejemplo de creaci√≥n de un pedido: si la solicitud entr√≥ en el servicio, crearemos un pedido en cualquier caso.  Incluso si el servicio vecino cae, que es responsable de alguna parte de la informaci√≥n que debemos agregar o validar.  Adem√°s, no perderemos el pedido, incluso si no podemos rechazar a corto plazo el procesamiento del pedido, donde debemos transferirlo.  Este es tambi√©n uno de los criterios por los cuales decidimos si poner la l√≥gica en un servicio separado.  Si un servicio no puede proporcionar su trabajo cuando los siguientes servicios no est√°n disponibles en la red, entonces debe redise√±arlo o pensar si debe eliminarse del monolito. </p><br><h3 id="go-v-go">  Ir a ir! </h3><br><p>  Cuando viene a escribir microservicios de productos orientados a los negocios desde una arquitectura cl√°sica orientada a servicios, en particular PHP, se encuentra con un cambio de paradigma.  Y debe ser aprobado, de lo contrario puede pisar el rastrillo sin cesar.  La estructura del proyecto orientada a los negocios nos permite no complicar el c√≥digo una vez m√°s y controlar la granularidad del servicio. </p><br><p>  Una de nuestras tareas principales era aumentar la estabilidad del servicio.  Por supuesto, Go no proporciona una mayor estabilidad reci√©n sacada de la caja.  Pero, en mi opini√≥n, en el ecosistema Go, result√≥ ser m√°s f√°cil crear todo el kit de confiabilidad necesario, incluso con sus propias manos, sin recurrir a bibliotecas de terceros. </p><br><p>  Otra tarea importante era aumentar la flexibilidad del sistema.  Y aqu√≠ definitivamente puedo decir que la tasa de introducci√≥n de cambios requeridos por el negocio ha crecido significativamente.  Gracias a la arquitectura de los nuevos microservicios, el desarrollador se queda solo con las caracter√≠sticas del negocio; no necesita pensar en crear clientes, enviar monitoreo, enviar seguimiento y configurar el registro.  Dejamos para el desarrollador exactamente la capa de escritura de l√≥gica empresarial, lo que le permite no pensar en todo el paquete de infraestructura. </p><br><p>  ¬øVamos a reescribir completamente todo en Go y abandonar PHP? </p><br><p>  No, dado que nos estamos alejando de las necesidades comerciales, y hay algunos contextos en los que PHP encaja muy bien: no necesita tanta velocidad y todo el kit de herramientas Go-go.  Toda la automatizaci√≥n de las operaciones para la entrega de pedidos y la gesti√≥n del estudio fotogr√°fico se realiza en PHP.  Pero, por ejemplo, en la plataforma de comercio electr√≥nico en el lado del cliente, casi reescribimos todo en Go, ya que est√° justificado. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478740/">https://habr.com/ru/post/478740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478722/index.html">Seis recetas para un l√≠der de equipo principiante: c√≥mo mantenerse al d√≠a con todo y desarrollar un equipo</a></li>
<li><a href="../478726/index.html">OWASP Mosc√∫ Meetup # 9</a></li>
<li><a href="../478728/index.html">Los 9 mejores hallazgos de c√≥digo abierto para noviembre de 2019</a></li>
<li><a href="../478734/index.html">Botones de forma personalizada en la interfaz de usuario de Unity</a></li>
<li><a href="../478736/index.html">El futuro de la inteligencia artificial en el sistema educativo: todo lo que uno debe saber</a></li>
<li><a href="../478748/index.html">Pruebas de fiabilidad SSD: 3dnews vs JEDEC vs sentido com√∫n. ¬øD√≥nde est√° la verdad, hermano?</a></li>
<li><a href="../478750/index.html">Bibliotecas de visualizaci√≥n de datos reales para desarrolladores de reacci√≥n</a></li>
<li><a href="../478752/index.html">Historia de los sistemas de control de versiones</a></li>
<li><a href="../478758/index.html">Gran gu√≠a de etiquetas UTM: c√≥mo averiguar de d√≥nde vienen los usuarios</a></li>
<li><a href="../478760/index.html">Infierno "cero" y c√≥mo salir de √©l</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>