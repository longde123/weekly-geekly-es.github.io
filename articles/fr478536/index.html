<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏽 ♓️ 🐜 WebRTC via Kurento: Expérience de test et d'implémentation 👩🏿‍🤝‍👩🏼 🤔 💧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je partagerai mon expérience avec la technologie WebRTC et le serveur multimédia Kurento pendant la phase de test et d'implémentatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>WebRTC via Kurento: Expérience de test et d'implémentation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inobitec/blog/478536/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gp/n6/4m/gpn64m3nht-yuv6pzbeye6d8zv0.png"></div><br>  Dans cet article, je partagerai mon expérience avec la technologie WebRTC et le serveur multimédia Kurento pendant la phase de test et d'implémentation.  Je vais vous dire quels problèmes j'ai rencontrés et comment je les ai résolus.  Je ne parlerai pas de la façon de développer une application à partir de zéro, mais je donnerai beaucoup de liens utiles.  Je suis sûr que mon histoire sera utile à ceux qui vont travailler avec WebRTC. <br><a name="habracut"></a><br><h3>  Présentation </h3><br>  Le Medical Information System (MIS), qui est développé par notre société, est déjà devenu un énorme projet d'entreprise avec de nombreux microservices, bus de messagerie, clients mobiles, etc.  Certaines parties du système doivent être données pour le développement et le soutien à des organisations tierces, car elles ne sont pas notre profil. <br><br>  Le service de télémédecine est l'un de ces modules MIS.  Il n'y avait aucune expérience dans le développement de la vidéoconférence et l'utilisation de WebRTC et la commande a été déléguée.  Mais après un certain temps, en raison de diverses circonstances, cette entreprise a cessé de prendre en charge la vidéoconférence.  Sans support, ce service a été désactivé et «rassemblait la poussière» dans le référentiel. <br><br>  Et maintenant, il est temps de relancer ce micro service.  Il a été décidé d'essayer de redémarrer la télémédecine par eux-mêmes.  Notre entreprise a grandi, plus de spécialistes sont apparus - il est possible et nécessaire de maîtriser de nouveaux sujets de développement.  Je n'avais jamais été impliqué dans la transmission vidéo auparavant, mais c'était très intéressant de comprendre et d'étudier une technologie aussi prometteuse que WebRTC. <br><br>  Voici quelques liens très utiles sur la technologie WebRTC et le serveur Kurento qui m'ont aidé au départ: <br><br><ul><li>  <a href="https://habr.com/ru/post/435580/">Java, Spring, Kurento et Media Services</a> </li><li>  <a href="https://habr.com/ru/company/Voximplant/blog/344794/">WebRTC: comment deux navigateurs s'accordent sur les appels vocaux et vidéo</a> </li><li>  <a href="https://habr.com/ru/company/flashphoner/blog/324914/">Nous développons un chat vidéo entre le navigateur et l'application mobile</a> </li></ul><br><h3>  Pour commencer </h3><br>  La tâche était simple: restaurer le système de visioconférence existant, faire l'inventaire de ce qui a déjà été fait auparavant et, si nécessaire, le modifier selon les souhaits des utilisateurs.  Les premiers tests sur des machines virtuelles et de vrais ordinateurs ont réussi.  Mais le déploiement du système chez le client a posé beaucoup de problèmes. <br><br>  Permettez-moi de vous rappeler que le client dispose déjà d'un système d'information médicale (SIG) couvrant un grand nombre de tâches: de la file d'attente électronique, du lieu de travail du médecin, de la gestion des documents et des PACS au sous-système de gestion des équipements médicaux. <br><br>  Lorsqu'il est devenu nécessaire de développer la fonctionnalité de vidéoconférence pour la communication entre le personnel médical des centres de diagnostic (ci-après dénommé DC) et les patients distants, deux conditions préalables ont été fixées: <br><br>  Toutes les conférences doivent être enregistrées et stockées sur le serveur. <br><br>  Les patients ne doivent pas installer de programmes supplémentaires sur leurs appareils, à l'exception du navigateur, qui dans la plupart des cas est déjà préinstallé. <br><br>  WebRTC fonctionne à partir d'un navigateur sans programmes ni plugins supplémentaires.  Et Kurento peut enregistrer tout ce qui le traverse.  De plus, ce serveur multimédia dispose d'un bon ensemble de bibliothèques prêtes à l'emploi pour travailler avec son API via Java et JavaScript, ce qui simplifie considérablement le développement. <br><br>  Le développement de la partie serveur, ou plutôt de sa base, avant même que je commence la tâche, a été transféré par le client à une société d'externalisation à une société tierce.  Il y avait donc un «Managing Server» (CSS) - une base de serveurs prête à l'emploi, que j'ai obtenue pour la mise en œuvre. <br><br><h4>  L'idée générale d'interaction ressemblait initialement à ceci: </h4><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ue/y-/qt/uey-qt4cvt81f4clyn6e0kdp4s4.png"></div><br>  Mais au cours de travaux ultérieurs, l'ensemble du système a changé et est devenu plus compliqué. <br><br><h3>  Première expérience de réanimation </h3><br>  Après le déploiement dans un réseau de test sur des machines virtuelles et sur plusieurs ordinateurs «live», de nombreux tests et expériences ont été réalisés - tout a parfaitement fonctionné.  En conséquence, le moment est venu d'introduire dans un véritable réseau de travail. <br><br>  Pour les tests, une victime responsable sous la forme d'un médecin et son lieu de travail a été affecté pour m'aider.  Et le deuxième appel via le microservice de télémédecine s'est écrasé! <br><br>  C'est bien que cela se soit produit pendant le test bêta, et à part moi et un médecin qui était satisfait des aventures, personne n'a vu cela. <br><br>  Ce qui se passe et pourquoi la connexion n'est pas établie était très difficile à comprendre.  WebRTC ne montre aucune panne - il attend juste qu'un signal apparaisse.  Sans le savoir, il a été très difficile de déboguer d'une manière ou d'une autre: la partie serveur fonctionne bien, Kurento est silencieux dans les journaux, les clients attendent le flux, mais rien ne se passe. <br><br>  Habr a aidé (louange à lui): <br><br><ul><li>  <a href="https://habr.com/ru/company/Voximplant/blog/417869/">Comment déboguer WebRTC.</a> </li><li>  <a href="https://habr.com/ru/company/Voximplant/blog/351234/">5 erreurs lors du développement d'appels WebRTC à partir du navigateur</a> </li><li>  <a href="https://habr.com/ru/company/yandex/blog/419951/">Expérience de l'utilisation de WebRTC.</a>  <a href="https://habr.com/ru/company/yandex/blog/419951/">Conférence Yandex</a> </li></ul><br>  Il est regrettable que je ne connaissais pas ces outils auparavant. <br><br>  Après avoir analysé les données du journal et observé l'état des connexions, il est devenu clair que les scripts côté serveur et client manquaient de réaction aux événements dans le système WebRTC.  Et où trouver ces événements? <br><br>  Les développeurs du serveur kurento fournissent une bibliothèque JavaScript très pratique pour travailler avec WebRTC: kurento-utils.js. <br><br>  Pour démarrer rapidement, créez simplement un objet: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options, callback());</code> </pre> <br>  Et pour accéder aux événements, il est nécessaire de redéfinir les méthodes internes de la bibliothèque.  J'ai simplifié le code autant que possible pour le rendre plus clair: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    WebRtcPeerRecvonly var options = { //      peerConnection: getRTCPeerConnection(videoId), remoteVideo: videoElement, // //  ICE  onicecandidate: function (candidate) { onIceCandidate(candidate, videoId, true); }, onerror: onError, //   mediaConstraints: { //  video: true, audio: true} }; //  WebRTC incomeWebRtc[videoId] = new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly( options, function (error) { if (error) { return console.error(error); } this.generateOffer( function (error, sdpOffer) { //  }); }); //      function getRTCPeerConnection( videoId ){ var configuration = { "iceServers": [ {"url": "stun:" + stunServer}, {"url": "turn:" + turnServer, credential: turnCredential, username: turnUsername} ] }; var mypc = new RTCPeerConnection(configuration); //      mypc.oniceconnectionstatechange = function(){ state = this.iceConnectionState; console.info("### iceConnectionState " + videoId + " &gt; " + this.iceConnectionState); }; mypc.onsignalingstatechange = function(){ state = this.signalingState || this.readyState; console.info("### SignalingState " + videoId + " &gt; " + state); }; mypc.onconnectionstatechange = function(){ console.info("### ConnectionState " + videoId + " &gt; " + this.connectionState); }; return mypc; }</span></span></code> </pre><br><h3>  En parlant de certificats </h3><br>  Étant donné que l'article concerne mon expérience, je partagerai des informations selon lesquelles les navigateurs modernes sont devenus très stricts en matière de sécurité.  Si la ressource possède un certificat auto-signé, même avec une autorisation spéciale, le navigateur interdit l'accès aux périphériques de l'ordinateur. <br><br>  Vous pouvez créer un certificat sur des ressources gratuites sur Internet et configurer un réseau local pour son utilisation, ou vous pouvez télécharger Firefox version 65 ou supérieure. Dans cette version, cliquez simplement sur le bouton, que je suis d'accord avec les risques des certificats auto-signés et accéder aux caméras et microphones. <br><br>  Cela me semblait plus facile. <br><br><h3>  Deuxième test (déjà prudent) </h3><br>  Il me semblait que le médecin se présenterait pour du pop-corn quand il me verrait au prochain test.  Il aimait clairement me voir lutter avec la technologie moderne. <br><br>  En fait, cette mise à jour du système n'était pas une version, car je n'ai rien résolu, je ne connaissais même pas la cause des problèmes.  Je répète que tout fonctionnait parfaitement au bureau.  Le code a ajouté des réactions à tous les événements qui ont généré WebRTC et Kurento, que j'ai contactés, et tout cela a été écrit en détail dans les journaux.  J'ai même mis mes journaux dans des fichiers séparés afin qu'ils ne soient pas confondus avec les principaux de l'IIA. <br><br>  En collaboration avec un médecin passionné et un administrateur système client, nous avons essayé le système.  Ils n’ont même pas testé, à savoir «torturé».  Nous avons créé des vidéoconférences dans tous les modes possibles et à partir de tous les appareils disponibles.  D'autres médecins et une partie du personnel du bureau distant ont été impliqués dans ce match. <br><br>  L'essentiel n'était pas de vérifier le système (cela ne fonctionnait pas), mais de collecter autant de données que possible.  En conséquence, il s'est avéré que: <br><br><ol><li>  Environ 80% des tentatives de création d'une vidéoconférence ont réussi. </li><li>  Certaines connexions utilisant des candidats ICE pour IPv6 ne fonctionnent pas. </li><li>  Sur 5 opérateurs mobiles, 2 seulement ont travaillé. </li></ol><br><h3>  Tout s'est avéré simple - vous ne pouvez pas aller loin sur Google seul </h3><br>  L'analyse des informations collectées a montré que la connexion via le serveur TURN de Google est instable.  Soit leur charge est importante, soit ce n'est qu'un serveur de démonstration pour ceux qui commencent tout juste à apprendre la technologie.  Mais en fait: des échecs très fréquents.  Besoin de votre propre serveur TURN / STUN! <br><br>  La deuxième raison des échecs est les adresses IPv6.local.  Le serveur kurento n'accepte pas les candidats ICE avec ces adresses.  C'est bien qu'avant d'envoyer tous les candidats ICE, je passe le code entre mes mains et je filtre simplement IPv6.local. <br><br>  Le problème des opérateurs mobiles est à nouveau résolu avec son serveur TURN / STUN. <br>  Dans trois opérateurs mobiles sur cinq, le NAT est symétrique et WebRTC ne peut pas percer.  Plus de détails peuvent être trouvés ici: <a href="https://habr.com/ru/post/150298/">Le NAT symétrique est-il terrible?</a> <br><br>  C'est dommage que mon téléphone portable personnel fonctionne sur la carte SIM d'un opérateur qui n'a pas pris la peine d'une protection symétrique.  Par conséquent, mes tests initiaux n'ont pas révélé ce problème. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9b/g4/ie/9bg4ieg5oblnd8f24osrtmwetws.png"></div><br><h3>  Serveur TURN / STUN </h3><br>  Le package resiprocate-turn-server a été choisi comme serveur. <br><br>  Ils n'ont pas choisi depuis longtemps - c'est dans le référentiel ubuntu standard - une installation facile et des mises à jour automatiques.  Mais il n'est pas très pratique de travailler avec des comptes pour se connecter: les identifiants et les mots de passe sont uniquement extraits du fichier, c'est pourquoi vous devez créer un utilitaire ou un script supplémentaire pour exporter à partir de la base de données du serveur principal. <br><br>  Pour le moment, ce fichier est généré manuellement et les comptes sont distribués via un simple pool de mots de passe.  L'autorisation est mise en œuvre via le serveur principal MIS, la sécurité n'est donc pas compromise.  Mais la structure globale de l'ensemble du système semble moche.  Les plans pour refaire ce moment. <br><br><h3>  Troisième voyage chez le client </h3><br>  J'ai corrigé le code, installé et configuré mon serveur TURN / STUN, développé un pool de mots de passe et les ai distribués aux clients au début d'une vidéoconférence et, après la mise à jour des serveurs de production, je suis allé voir un médecin que je connaissais déjà. <br><br>  Ça marche!  Hourra!  Tous les débuts de la conférence sont réussis à partir de tous les appareils et dans tous les modes: le patient du compte personnel peut appeler le médecin, le thérapeute pendant la réception peut appeler le diagnosticien fonctionnel pour une consultation supplémentaire, et les médecins eux-mêmes peuvent organiser une vidéoconférence multi-utilisateurs à partir de différentes branches de toute la ville. <br><br>  Déjà enseigné par une expérience amère, nous nous sommes engagés dans des tests minutieux avec la création artificielle de situations d'urgence.  À partir du sujet de cet article, je souligne la nécessité de fixer une limite au temps d'attente de connexion.  WebRTC, avec Kurento, attendent que la diffusion commence infiniment longtemps et espère que les octets vidéo sont sur le point de disparaître.  J'ai dû régler une minuterie pendant 10 secondes, ce qui donne une erreur au serveur de gestion si les octets ne sont jamais arrivés. <br><br><h3>  Après toutes les améliorations </h3><br>  Enfin, le système fonctionne et fonctionne bien.  Les premiers avis ont été envoyés par les utilisateurs sur le terrain.  Et immédiatement un grand nombre de souhaits et de suggestions de conception, de fonctions supplémentaires et d'autres plans de développement ultérieur sont apparus.  Le travail a commencé à bouillir avec une vigueur renouvelée! <br><br>  Maintenant, la topologie du système complet ressemble à ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mr/ev/kn/mrevknsr8bnuhpmsnaowtthxd6m.png"></div><br><h3>  RÉSULTATS: </h3><br>  En conclusion, je veux dire ce qui suit: <br><br>  Premièrement, WebRTC est une excellente technologie avec de grandes perspectives, mais il est très difficile de la tester et de la déboguer.  Avant de commencer le développement, il est impératif de déployer un réseau avec toutes sortes de connexions que le client peut avoir.  Et le débogage via la fenêtre d'informations du navigateur n'est pas un outil très pratique. <br><br>  Deuxièmement, louange à Habru!  En travaillant sur ce projet, j'ai trouvé beaucoup d'informations sur cette ressource.  Tous les liens de cet article y mènent. <br><br>  Il a été décidé de laisser le projet de visioconférence de télémédecine pour le support et le développement de notre organisation, nous ne l'externaliserons pas.  A l'avenir, il reste encore beaucoup de travail: <br><br><ul><li>  Il y a une finalisation du collage des vidéos enregistrées.  Je vais à nouveau me tourner vers Habr, j'ai déjà trouvé un article pour commencer: <a href="https://habr.com/ru/post/277179/">Combiner des fragments vidéo de plusieurs caméras et les synchroniser dans le temps.</a> </li><li>  Il est nécessaire de repenser le système d'enregistrement des utilisateurs sur le serveur de gestion, le serveur MIS principal et le turn-server. </li><li>  Et la question est ouverte avec le débit de l'ensemble du système dans son ensemble.  Des tests de résistance n'ont pas encore été effectués.  Préparez-vous, relisez Habr: <a href="https://habr.com/ru/company/Voximplant/blog/346924/">Combien de participants peuvent participer à un appel WebRTC?</a> </li></ul><br><h3>  TOUT </h3><br>  Je suis sûr que mon expérience sera utile non seulement pour les développeurs sous WebRTC + Kurento, mais aussi pour ceux qui vont commencer à mettre en œuvre des projets tout aussi complexes.  Faites plus attention aux tests dans des conditions aussi proches que possible de la réalité. <br><br>  Et prenez en compte les risques que les équipes de support pour vos microservices puissent soudainement «disparaître» - c'est une corvée très inattendue et désagréable. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr478536/">https://habr.com/ru/post/fr478536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr478526/index.html">Un tas d'OpenVPN sur Windows Server et Mikrotik avec la migration de ce truc vers Linux</a></li>
<li><a href="../fr478528/index.html">Pet (une histoire fantastique)</a></li>
<li><a href="../fr478530/index.html">TechnoText-2019: qui a finalement gagné et à quoi ils servaient</a></li>
<li><a href="../fr478532/index.html">Comment Apple Earnes: les 5 domaines d'activité les plus rentables de l'entreprise et combien ils y apportent</a></li>
<li><a href="../fr478534/index.html">DevFest Siberia 2019: un aperçu des tendances de l'outback</a></li>
<li><a href="../fr478540/index.html">Préparatifs du dixième forum «Positive Hack Days 10: Getting Started»</a></li>
<li><a href="../fr478542/index.html">FigmaGen: Style Automation dans iOS App</a></li>
<li><a href="../fr478544/index.html">Vue Storefront: Importer un répertoire depuis Magento 2</a></li>
<li><a href="../fr478546/index.html">Websockets Expérience en développement et exploitation. Nous modifions le client</a></li>
<li><a href="../fr478550/index.html">Comment gérer une montre? Analyse de la piste front-end du deuxième championnat de programmation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>