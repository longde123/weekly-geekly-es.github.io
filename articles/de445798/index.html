<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶à üïú üë®üèª‚Äçüíº Nashorn in der Katze - F√ºhren Sie die Firmware im Kopycat-Emulator aus ü§¥üèΩ üâë üé∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Rahmen des Treffens 0x0A DC7831 DEF CON Nizhny Novgorod am 16. Februar pr√§sentierten wir einen Bericht √ºber die Grundprinzipien der Bin√§rcode-Emula...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nashorn in der Katze - F√ºhren Sie die Firmware im Kopycat-Emulator aus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/445798/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/pb/7e/gipb7e8ucwinvebjerxy1fk2d-8.jpeg" width="80%"></div><br><p>  Im Rahmen des Treffens 0x0A DC7831 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DEF CON Nizhny Novgorod</a> am 16. Februar pr√§sentierten wir einen Bericht √ºber die Grundprinzipien der Bin√§rcode-Emulation und unsere eigene Entwicklung - einen Emulator der Hardwareplattformen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kopycat</a> . </p><br><p>  In diesem Artikel beschreiben wir den Start der Ger√§te-Firmware im Emulator, demonstrieren die Interaktion mit dem Debugger und f√ºhren eine kleine dynamische Analyse der Firmware durch. </p><a name="habracut"></a><br><h2 id="predystoriya">  Hintergrund </h2><br><p><del>  Vor langer Zeit in einer weit entfernten Galaxie </del></p><br><p>  Vor ein paar Jahren musste in unserem Labor die Firmware des Ger√§ts untersucht werden.  Die Firmware wurde komprimiert und vom Bootloader entpackt.  Er tat dies auf sehr verwirrte Weise und verschob mehrmals Daten im Speicher.  Ja, und die Firmware selbst interagierte dann aktiv mit den Peripherieger√§ten.  Und das alles auf dem MIPS-Kern. </p><br><p> Aus objektiven Gr√ºnden passten die vorhandenen Emulatoren nicht zu uns, aber ich wollte den Code trotzdem ausf√ºhren.  Dann haben wir uns entschlossen, einen eigenen Emulator zu erstellen, der ein Minimum darstellt und das Entpacken der Hauptfirmware erm√∂glicht.  Wir haben es versucht - es stellte sich heraus.  Wir dachten, was ist, wenn wir Peripherieger√§te hinzuf√ºgen, um auch die Hauptfirmware auszuf√ºhren.  Es war nicht sehr schmerzhaft - und es hat auch geklappt.  Wir √ºberlegten noch einmal und beschlossen, einen vollwertigen Emulator zu entwickeln. </p><br><p>  Das Ergebnis war ein Emulator der Computersysteme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kopycat</a> . </p><br><img src="https://habrastorage.org/webt/eb/cx/b6/ebcxb6pxtiypy0s-usvu6i_hdwu.png" align="right"><br><div class="spoiler">  <b class="spoiler_title">Warum Kopycat?</b> <div class="spoiler_text"><p>  Es gibt ein Wortspiel. </p><br><ol><li>  <em>Nachahmer</em> (Englisch, n. [Ààk…íp…™k√¶t]) - Nachahmer, Nachahmer </li><li>  <em>Katze</em> (Englisch, n. [Ààk√¶t]) - eine Katze, eine Katze - ein Lieblingstier eines der Sch√∂pfer des Projekts </li><li>  Buchstabe "K" - aus der Programmiersprache Kotlin </li></ol></div></div><br><h2 id="kopycat">  Kopycat </h2><br><p>  Bei der Erstellung des Emulators wurden absolut spezifische Ziele festgelegt: </p><br><ul><li>  die F√§higkeit, schnell eine neue Peripherie, ein neues Modul und einen neuen Prozessorkern zu erstellen; </li><li>  die F√§higkeit, ein virtuelles Ger√§t aus verschiedenen Modulen zusammenzusetzen; </li><li>  die F√§higkeit, beliebige Bin√§rdaten (Firmware) in den Speicher des virtuellen Ger√§ts zu laden; </li><li>  die F√§higkeit, mit Schnappsch√ºssen zu arbeiten (Schnappsch√ºsse des Systemzustands); </li><li>  die F√§higkeit, √ºber den eingebauten Debugger mit dem Emulator zu interagieren; </li><li>  sch√∂ne moderne Sprache zu entwickeln. </li></ul><br><p>  Aus diesem Grund wurde Kotlin f√ºr die Implementierung, die Busarchitektur (wenn die Module √ºber virtuelle Datenbusse miteinander kommunizieren), JSON als Ger√§tebeschreibungsformat und GDB RSP als Protokoll f√ºr die Interaktion mit dem Debugger ausgew√§hlt. </p><br><p>  Die Entwicklung dauert etwas mehr als zwei Jahre und wird aktiv fortgesetzt.  W√§hrend dieser Zeit wurden MIPS-, x86-, V850ES-, ARM- und PowerPC-Prozessorkerne implementiert. </p><br><p>  Das Projekt w√§chst und es ist Zeit, es der √ñffentlichkeit vorzustellen.  Wir werden das Projekt sp√§ter detailliert beschreiben, aber jetzt konzentrieren wir uns auf die Verwendung von Kopycat. </p><br><p>  F√ºr die Ungeduldigsten - die Promo-Version des Emulators kann hier heruntergeladen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">werden</a> . </p><br><h2 id="nosorog-v-emulyatore">  Nashorn im Emulator </h2><br><p>  Erinnern Sie sich daran, dass fr√ºher f√ºr die SMARTRHINO-2018-Konferenz ein Testger√§t "Rhinoceros" f√ºr die Ausbildung in Reverse Engineering-F√§higkeiten entwickelt wurde.  Der Prozess der statischen Firmware-Analyse wurde in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel beschrieben</a> . </p><br><p>  Versuchen wir nun, "Lautsprecher" hinzuzuf√ºgen und die Firmware im Emulator auszuf√ºhren. </p><br><p>  Wir werden brauchen: <br>  1) Java 1.8 <br>  2) Python und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Jep-</a> Modul zur Verwendung von Python im Emulator.  Die WHL-Assembly des Jep-Moduls f√ºr Windows kann hier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">heruntergeladen werden</a> . </p><br><p>  <strong>F√ºr Windows:</strong> <br>  1) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">com0com</a> <br>  2) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PuTTY</a> </p><br><p>  <strong>F√ºr Linux:</strong> <br>  1) socat </p><br><p>  Sie k√∂nnen Eclipse, IDA Pro oder radare2 als GDB-Client verwenden. </p><br><h2 id="kak-eto-rabotaet">  Wie funktioniert es </h2><br><p>  Um Firmware im Emulator auszuf√ºhren, m√ºssen Sie ein virtuelles Ger√§t "zusammenbauen", das ein Analogon eines realen Ger√§ts ist. </p><br><p>  Das reale Ger√§t ("Nashorn") kann in einem Blockdiagramm dargestellt werden: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nh/ph/ph/nhphph7rjwm3xiv52mvp_uefdq8.jpeg" alt="Echte Ger√§teschaltung" width="60%"></div><br><p>  Der Emulator ist modular aufgebaut und das endg√ºltige virtuelle Ger√§t kann in einer JSON-Datei beschrieben werden. </p><br><div class="spoiler">  <b class="spoiler_title">JSON in 105 Zeilen</b> <div class="spoiler_text"><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"top"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, // Plugin name should be the same as file name (or full path from library start) <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"rhino"</span></span>, // Directory where plugin places <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, // Plugin parameters (constructor parameters if jar-plugin version) <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_dbg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"firmware"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: <span class="hljs-string"><span class="hljs-string">"NUL"</span></span>} ], // Plugin outer ports <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: [ ], // Plugin internal buses <span class="hljs-attr"><span class="hljs-attr">"buses"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS30"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nand"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"4"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"gpio"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS32"</span></span> } ], // Plugin internal components <span class="hljs-attr"><span class="hljs-attr">"modules"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"u1_stm32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"STM32F042"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"firmware:String"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.firmware"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"usart_debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_dbg"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"term_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_bt"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bluetooth"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"BT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_12"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_13"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_14"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_15"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> } ], // Plugin connection between components <span class="hljs-attr"><span class="hljs-attr">"connections"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_0.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x00"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_1.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x01"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_2.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x02"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_3.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x03"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_4.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x04"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_5.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x05"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_6.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x06"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_7.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x07"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_8.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x08"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_9.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x09"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_10.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0A"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_11.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0B"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_12.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0C"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_13.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0D"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_14.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0E"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_15.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0F"</span></span>] ] }</code> </pre> <br><p>  <strong>Beachten Sie</strong> den <em>Firmware-</em> Parameter im Abschnitt <strong>params</strong> - dies ist der Name der Datei, die als Firmware auf das virtuelle Ger√§t heruntergeladen werden kann. </p></div></div><br><p>  Ein virtuelles Ger√§t und seine Interaktion mit dem Hauptbetriebssystem k√∂nnen wie folgt dargestellt werden: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m9/i_/27/m9i_27btauj0onjugttzj3srmfg.jpeg" alt="Schaltungsemuliertes Ger√§t" width="80%"></div><br><p>  Die aktuelle Testinstanz des Emulators beinhaltet die Interaktion mit den COM-Ports des Hauptbetriebssystems (Debuggen von UART und UART f√ºr das Bluetooth-Modul).  Dies k√∂nnen reale Ports sein, an die Ger√§te angeschlossen sind, oder virtuelle COM-Ports ( <em>com0com / socat ist</em> genau daf√ºr <em>)</em> . </p><br><p>  Derzeit gibt es zwei M√∂glichkeiten, von au√üen mit dem Emulator zu interagieren: </p><br><ul><li>  GDB RSP-Protokoll (unterst√ºtzt dieses Protokoll, Tools - Eclipse / IDA / radare2); </li><li>  interne Befehlszeile des Emulators (Argparse oder Python). </li></ul><br><h3 id="virtualnye-com-porty">  Virtuelle COM-Ports </h3><br><p>  Um √ºber das Terminal mit dem UART des virtuellen Ger√§ts auf dem lokalen Computer zu interagieren, m√ºssen Sie mehrere verbundene virtuelle COM-Ports erstellen.  In unserem Fall verwendet ein Port einen Emulator und der zweite ein Terminalprogramm (PuTTY oder Bildschirm): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5d/jr/0w/5djr0wz88dgdaiw1xaasrof2wyk.png" alt="Virtuelle COM-Ports" width="80%"></div><br><h4 id="ispolzovanie-com0com">  Mit com0com </h4><br><p>  Virtuelle COM-Ports werden mit dem Setup-Dienstprogramm aus dem com0com-Kit konfiguriert (die Konsolenversion lautet <em>C: \ Programme (x86) \ com0com \ setup.exe</em> oder die GUI-Version lautet <em>C: \ Programme (x86) \ com0com \ setupg.exe</em> ). :: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/j9/pf/v-j9pfquunpiezqhkcr6cuyq-9k.png" alt="Konfigurieren Sie virtuelle COM-Ports"></div><br><p>  <strong><em>Aktivieren Sie die Kontrollk√§stchen zum Aktivieren des Puffer√ºberlaufs</em></strong> f√ºr alle erstellten virtuellen Ports. Andernfalls wartet der Emulator auf eine Antwort vom COM-Port. </p><br><h4 id="ispolzovanie-socat">  Mit socat </h4><br><p>  Auf UNIX-Systemen werden virtuelle COM-Ports vom Emulator automatisch mit dem Dienstprogramm socat erstellt. Dazu reicht es aus, beim Starten des Emulators das Pr√§fix <code>socat:</code> im <code>socat:</code> anzugeben. </p><br><h3 id="vnutrenniy-interfeys-komandnoy-stroki-argparse-ili-python">  Interne Befehlszeilenschnittstelle (Argparse oder Python) </h3><br><p>  Da Kopycat eine Konsolenanwendung ist, bietet der Emulator zwei Optionen f√ºr die Befehlszeilenschnittstelle, um mit ihren Objekten und Variablen zu interagieren: Argparse und Python. </p><br><p>  Argparse ist die in Kopycat integrierte CLI, die immer f√ºr alle verf√ºgbar ist. </p><br><p>  Eine alternative CLI ist der Python-Interpreter.  Um es zu verwenden, m√ºssen Sie das Jep Python-Modul installieren und den Emulator f√ºr die Arbeit mit Python konfigurieren (der auf dem Hauptsystem des Benutzers installierte Python-Interpreter wird verwendet). </p><br><h4 id="ustanovka-python-modulya-jep">  Installieren Sie das Python Jep-Modul </h4><br><p>  Unter Linux kann Jep √ºber pip installiert werden: </p><br><pre> <code class="bash hljs">pip install jep</code> </pre> <br><p>  Um Jep unter Windows zu installieren, m√ºssen Sie zuerst das Windows SDK und das entsprechende Microsoft Visual Studio installieren.  Wir haben Ihre Aufgabe ein wenig vereinfacht und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WHL-</a> JEP- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Assemblys</a> f√ºr die aktuellen Versionen von Python f√ºr Windows erstellt, damit das Modul aus einer Datei installiert werden kann: </p><br><pre> <code class="bash hljs">pip install jep-3.8.2-cp27-cp27m-win_amd64.whl</code> </pre> <br><p>  Um die Installation von Jep zu √ºberpr√ºfen, m√ºssen Sie die folgende Befehlszeile ausf√ºhren: </p><br><pre> <code class="bash hljs">python -c <span class="hljs-string"><span class="hljs-string">"import jep"</span></span></code> </pre> <br><p>  Als Antwort sollte eine Nachricht empfangen werden: </p><br><pre> <code class="bash hljs">ImportError: Jep is not supported <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> standalone Python, it must be embedded <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Java.</code> </pre> <br><p>  <em>F√ºgen Sie</em> in der Emulator-Batchdatei f√ºr Ihr System ( <em>kopycat.bat</em> f√ºr Windows, <em>kopycat</em> f√ºr Linux) den zus√§tzlichen Parameter <code>Djava.library.path</code> zur Liste der Parameter <code>DEFAULT_JVM_OPTS</code> - er sollte den Pfad zum installierten Jep-Modul enthalten. </p><br><p>  Daher sollten Sie f√ºr Windows eine Zeile wie die folgende erhalten: </p><br><pre> <code class="plaintext hljs">set DEFAULT_JVM_OPTS="-XX:MaxMetaspaceSize=256m" "-XX:+UseParallelGC" "-XX:SurvivorRatio=6" "-XX:-UseGCOverheadLimit" "-Djava.library.path=C:/Python27/Lib/site-packages/jep"</code> </pre> <br><h2 id="zapusk-kopycat">  Kopycat-Start </h2><br><p>  Der Emulator ist eine Konsolen-JVM-Anwendung.  Der Start erfolgt √ºber das Befehlszeilenskript des Betriebssystems (sh / cmd). </p><br><p>  Befehl zum Ausf√ºhren unter Windows: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=firmware\rhino_pass.bin,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><p>  Der Befehl zum Ausf√ºhren unter Linux mit dem Dienstprogramm socat: </p><br><pre> <code class="plaintext hljs">./bin/kopycat -g 23946 -n rhino -l user -y library -p firmware=./firmware/rhino_pass.bin,tty_dbg=socat:./COM26,tty_bt=socat:./COM28</code> </pre> <br><ul><li>  <code>-g 23646</code> - TCP-Port, der f√ºr den Zugriff auf den GDB-Server ge√∂ffnet ist; </li><li>  <code>-n rhino</code> - der Name des Hauptmoduls des Systems (Ger√§tebaugruppe); </li><li>  <code>-l user</code> - der Name der Bibliothek, die nach dem Hauptmodul gesucht werden soll; </li><li>  <code>-y library</code> - der Pfad zum Suchen nach Modulen, die im Ger√§t enthalten sind; </li><li>  <code>firmware\rhino_pass.bin</code> - Pfad zur Firmware-Datei; </li><li>  COM26 und COM28 sind virtuelle COM-Ports. </li></ul><br><p>  Das Ergebnis ist die <code>Argparse &gt;</code> <code>Python &gt;</code> (oder <code>Argparse &gt;</code> ): </p><br><pre> <code class="plaintext hljs">18:07:59 INFO [eFactoryBuilder.create ]: Module top successfully created as top 18:07:59 INFO [ Module.initializeAndRes]: Setup core to top.u1_stm32.cortexm0.arm for top 18:07:59 INFO [ Module.initializeAndRes]: Setup debugger to top.u1_stm32.dbg for top 18:07:59 WARN [ Module.initializeAndRes]: Tracer wasn't found in top... 18:07:59 INFO [ Module.initializeAndRes]: Initializing ports and buses... 18:07:59 WARN [ Module.initializePortsA]: ATTENTION: Some ports has warning use printModulesPortsWarnings to see it... 18:07:59 FINE [ ARMv6CPU.reset ]: Set entry point address to 08006A75 18:07:59 INFO [ Module.initializeAndRes]: Module top is successfully initialized and reset as a top cell! 18:07:59 INFO [ Kopycat.open ]: Starting virtualization of board top[rhino] with arm[ARMv6Core] 18:07:59 INFO [ GDBServer.debuggerModule ]: Set new debugger module top.u1_stm32.dbg for GDB_SERVER(port=23946,alive=true) Python &gt;</code> </pre> <br><h2 id="vzaimodeystvie-s-ida-pro">  Interaktion mit IDA Pro </h2><br><p>  Um das Testen zu vereinfachen, verwenden wir die Rhino-Firmware als <a href="">ELF-Datei</a> (die Metainformationen werden dort gespeichert) als Quelldatei f√ºr die Analyse in IDA. </p><br><p>  Sie k√∂nnen die Hauptfirmware auch ohne Metainformationen verwenden. </p><br><p>  Gehen Sie nach dem Starten von Kopycat in IDA Pro im Men√º <em>Debugger zum</em> Element " <em>Debugger</em> wechseln <em>...</em> " und w√§hlen Sie " <em>Remote GDB-Debugger</em> ".  Konfigurieren Sie als N√§chstes die Verbindung: <em>Debugger-</em> Men√º <em>- Prozessoptionen ...</em> </p><br><p>  Stellen Sie die Werte ein: </p><br><ul><li>  Anwendung - jeder Wert </li><li>  Hostname: 127.0.0.1 (oder die IP-Adresse des Remotecomputers, auf dem Kopycat ausgef√ºhrt wird) </li><li>  Hafen: 23946 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/kw/-l/mxkw-lbzq_igoewovazplw4moho.png" alt="Konfigurieren der Verbindung zum GDB-Server"></div><br><p>  Jetzt ist die Debug-Starttaste verf√ºgbar (Taste F9): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/mu/-q/afmu-qpi0ymfpsga-orunargmas.png"></div><br><p>  Dr√ºcken Sie darauf - es wird eine Verbindung zum Debugger-Modul im Emulator hergestellt.  IDA wechselt in den Debug-Modus, zus√§tzliche Fenster werden verf√ºgbar: Informationen zu Registern, zum Stapel. </p><br><p>  Jetzt k√∂nnen wir alle Standardfunktionen der Arbeit mit dem Debugger verwenden: </p><br><ul><li>  schrittweise Ausf√ºhrung von Anweisungen ( <em>Schritt in</em> und <em>Schritt √ºber</em> - Tasten F7 bzw. F8); </li><li>  Ausf√ºhrung starten und anhalten; </li><li>  Erstellen von Haltepunkten f√ºr Code und Daten (Taste F2). </li></ul><br><p>  Das Herstellen einer Verbindung zum Debugger bedeutet nicht, dass der Firmware-Code gestartet wird.  Die aktuelle Position f√ºr die Ausf√ºhrung muss die Adresse <code>0x08006A74</code> - der Beginn der Funktion <em>Reset_Handler</em> .  Wenn Sie in der folgenden Liste nach unten scrollen, k√∂nnen Sie den Aufruf der Hauptfunktion sehen.  Sie k√∂nnen den Cursor auf diese Zeile setzen (Adresse <code>0x08006ABE</code> ) und die Operation <em>Bis Cursor</em> ausf√ºhren (Taste F4) ausf√ºhren. </p><br><p><img src="https://habrastorage.org/webt/wx/k4/3r/wxk43r-316cpnsdabb9eydkzus4.png" alt="Bild"></p><br><p>  Als n√§chstes k√∂nnen Sie F7 dr√ºcken, um die <em>Hauptfunktion</em> aufzurufen. </p><br><p>  Wenn Sie den Befehl <em>Prozess fortsetzen</em> (Taste F9) ausf√ºhren, wird das Fenster "Bitte warten" mit einer einzigen Schaltfl√§che " <em>Anhalten</em> " <em>angezeigt</em> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9e/78/tg/9e78tgoterc50rqvmosunzp1u5i.png"></div><br><p>  Wenn <em>Suspend</em> gedr√ºckt wird, wird die Ausf√ºhrung des Firmware-Codes angehalten und kann an derselben Adresse im Code fortgesetzt werden, an der er unterbrochen wurde. </p><br><p>  Wenn Sie den Code weiterhin ausf√ºhren, werden in den an die virtuellen COM-Ports angeschlossenen Terminals die folgenden Zeilen angezeigt: </p><br><p><img src="https://habrastorage.org/webt/fi/vi/j-/fivij-hshz3izcxoo0lnewnznc8.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/2m/cn/oq/2mcnoqd__te1i0sq5z28jd29mdg.png" alt="Bild"></p><br><p>  Das Vorhandensein der Zeichenfolge "Statusumgehung" zeigt an, dass das virtuelle Bluetooth-Modul in den Modus zum Empfangen von Daten vom COM-Port des Benutzers gewechselt ist. </p><br><p>  Jetzt k√∂nnen Sie im Bluetooth-Terminal (in der Abbildung - COM29) Befehle gem√§√ü dem Rhino-Protokoll eingeben.  Beispielsweise kehrt die Zeichenfolge "mur-mur" zum Befehl "MEOW" im Bluetooth-Terminal zur√ºck: </p><br><img src="https://habrastorage.org/webt/yq/td/ab/yqtdabgfdd3jlzswsrk3rvbdzds.png"><br><br><h3 id="emuliruy-menya-ne-polnostyu">  Emuliere mich nicht ganz </h3><br><p>  Beim Erstellen eines Emulators k√∂nnen Sie den Detaillierungsgrad / die Emulation eines Ger√§ts ausw√§hlen.  So kann beispielsweise das Bluetooth-Modul auf verschiedene Arten emuliert werden: </p><br><ul><li>  vollst√§ndig emuliertes Ger√§t mit einem vollst√§ndigen Befehlssatz; </li><li>  AT-Befehle werden emuliert und der Datenstrom wird vom COM-Port des Hauptsystems empfangen. </li><li>  Das virtuelle Ger√§t bietet eine vollst√§ndige Datenumleitung zu einem realen Ger√§t. </li><li>  als einfacher Stub, der immer "OK" zur√ºckgibt. </li></ul><br><p>  In der aktuellen Version des Emulators wird der zweite Ansatz verwendet: Das virtuelle Bluetooth-Modul f√ºhrt die Konfiguration durch und wechselt anschlie√üend vom COM-Port des Hauptsystems zum UART-Port des Emulators in den Proxy-Modus f√ºr Daten. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e6/5c/m_/e65cm_tl2bggpbg0-q0azjvdz64.jpeg"></div><br><p>  Erw√§gen Sie die M√∂glichkeit einer einfachen Instrumentierung des Codes, wenn ein Teil der Peripherie nicht implementiert ist.  Wenn beispielsweise kein Timer erstellt wird, der die Daten√ºbertragung in DMA steuert (die √úberpr√ºfung erfolgt in der Funktion <em>ws2812b_wait</em> unter <code>0x08006840</code> ), wartet die Firmware immer auf das <code>0x200004C4</code> unter <code>0x200004C4</code> , um die DMA-Datenleitung zur√ºckzusetzen: </p><br><img src="https://habrastorage.org/webt/pt/jj/su/ptjjsutfya2dkoqdoshkeyeeqzw.png"><br><p>  Wir k√∂nnen diese Situation umgehen, indem wir das <em>Besetztzeichen</em> unmittelbar nach dem Setzen manuell zur√ºcksetzen.  In IDA Pro k√∂nnen Sie eine Python-Funktion erstellen und als Haltepunkt aufrufen. Der Haltepunkt muss im Code festgelegt werden, nachdem der Wert 1 in das <em>Besetzt-</em> Flag geschrieben wurde. </p><br><h4 id="breakpoint-obrabotchik">  Haltepunkt-Handler </h4><br><p>  Erstellen Sie zun√§chst eine Python-Funktion in der IDA.  Men√º <em>Datei - Skriptbefehl ...</em> </p><br><p>  F√ºgen Sie der Liste links ein neues Snippet hinzu, geben Sie ihm einen Namen (z. B. <em>BPT</em> ). <br>  In das Textfeld rechts geben wir den Funktionscode ein: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_dma</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Skipping wait ws2812..."</span></span> value = Byte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value == <span class="hljs-number"><span class="hljs-number">1</span></span>: PatchDbgByte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zi/za/-d/ziza-ddx3arqlqfbd-o6jvdmnjc.png"></div><br><p>  Klicken Sie danach auf <em>Ausf√ºhren</em> und schlie√üen Sie das Skriptfenster. </p><br><p>  Gehen wir nun zum Code unter <code>0x0800688A</code> , setzen den Haltepunkt (F2-Taste), bearbeiten ihn ( <em>Haltepunkt</em> bearbeiten <em>...</em> Kontextmen√º), vergessen Sie nicht, den <code>0x0800688A</code> - Python: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fo/pn/1v/fopn1vb8fbxqrhn6xoia_rgnsau.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h6/yq/b2/h6yqb29r1m9sngr3csfimxcxsew.png"></div><br><p>  Wenn der aktuelle Wert des <em>Besetzt-</em> Flags 1 ist, sollte die Funktion <em>skip_dma in</em> der <em>Skriptzeile ausgef√ºhrt</em> werden: </p><br><img src="https://habrastorage.org/webt/m-/t8/in/m-t8in2th7ei6neigdzgzq17kxy.png"><br><p>  Wenn Sie die Firmware zur Ausf√ºhrung ausf√ºhren, wird der Code f√ºr den Haltepunkt-Handler in der IDA im <em>Ausgabefenster</em> in der Zeile <code>Skipping wait ws2812...</code>  Jetzt wartet die Firmware nicht mehr darauf, das <em>Besetztzeichen zur√ºckzusetzen</em> . </p><br><h4 id="vzaimodeystvie-s-emulyatorom">  Emulator-Interaktion </h4><br><p>  Es ist unwahrscheinlich, dass eine Emulation zum Zwecke der Emulation Freude und Vergn√ºgen hervorruft.  Es ist viel interessanter, wenn der Emulator dem Forscher hilft, die Daten im Speicher zu sehen oder die Interaktion von Fl√ºssen herzustellen. </p><br><p>  Wir zeigen, wie Sie die Interaktion von RTOS-Aufgaben dynamisch herstellen k√∂nnen.  Unterbrechen Sie zun√§chst die Codeausf√ºhrung, wenn sie ausgef√ºhrt wird.  Wenn Sie im Befehlsverarbeitungszweig "LED" (Adresse <code>0x080057B8</code> ) zur Funktion <em>bluetooth_task_entry</em> wechseln, k√∂nnen Sie sehen, was zuerst erstellt wird, und anschlie√üend wird eine Nachricht an die <em>Systemwarteschlange ledControlQueueHandle</em> gesendet. </p><br><p><img src="https://habrastorage.org/webt/po/bk/zm/pobkzmapmust02eaafle7d_pxba.png" alt="Bild"></p><br><p>  Sie sollten einen Haltepunkt festlegen, um auf die Variable <code>0x20000624</code> <em>0x20000624</em> <code>0x20000624</code> und den Code weiter auszuf√ºhren: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/wo/g3/evwog3vrv7ozxlxjozd4itvve0a.png"></div><br><p>  Infolgedessen stoppt es zuerst bei der Adresse <code>0x080057CA</code> bevor die Funktion <em>osMailAlloc aufgerufen</em> wird, dann bei <code>0x08005806</code> bevor die Funktion <em>osMailPut aufgerufen</em> wird, und nach einer Weile bei der Adresse <code>0x08005BD4</code> (vor dem Aufrufen der Funktion <em>osMailGet</em> ), die zur Funktion <em>leds_task_entry</em> geh√∂rt (LED-Aufgabe), d. H. Es gab einen Taskwechsel, und jetzt hat die Steuerung eine LED-Task erhalten. </p><br><p><img src="https://habrastorage.org/webt/th/ni/zh/thnizhzqykfn20l9-btkuqhawlc.png" alt="Bild"></p><br><p>  Auf so einfache Weise k√∂nnen Sie festlegen, wie RTOS-Aufgaben miteinander interagieren. </p><br><p>  In der Realit√§t kann die Interaktion von Aufgaben nat√ºrlich komplizierter sein, aber die Verwendung eines Emulators zur Verfolgung dieser Interaktion wird weniger schwierig. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hier k√∂nnen</a> Sie ein kurzes Video √ºber den Start des Emulators und die Interaktion mit IDA Pro ansehen. </p><br><h2 id="zapusk-s-radare2">  Starten Sie mit Radare2 </h2><br><p>  Sie k√∂nnen ein universelles Tool wie Radare2 nicht ignorieren. </p><br><p>  Um √ºber r2 eine Verbindung zum Emulator herzustellen, sieht der Befehl folgenderma√üen aus: </p><br><pre> <code class="plaintext hljs">radare2 -A -a arm -b 16 -d gdb://localhost:23946 rhino_fw42k6.elf</code> </pre> <br><p>  Jetzt sind Start ( <code>dc</code> ) und Pausenausf√ºhrung (Strg + C) verf√ºgbar. </p><br><p>  Leider gibt es derzeit in r2 Probleme beim Arbeiten mit einem Hardware-GDB-Server und Speicher-Markup. Aus diesem Grund funktionieren Haltepunkte und Schritte (der Befehl <code>ds</code> ) nicht.  Wir hoffen, dass dies in naher Zukunft behoben wird. </p><br><h2 id="zapusk-s-eclipse">  Starten Sie mit Eclipse </h2><br><p>  Eine der Optionen f√ºr die Verwendung des Emulators ist das Debuggen der Firmware des in der Entwicklung befindlichen Ger√§ts.  Aus Gr√ºnden der √úbersichtlichkeit verwenden wir auch die Rhino-Firmware.  Sie k√∂nnen die Firmware-Quellen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> herunterladen. </p><br><p>  Wir werden die Eclipse aus der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">System Workbench f√ºr STM32-</a> Suite als IDE verwenden. </p><br><p>  Damit die direkt in Eclipse kompilierte Firmware in den Emulator geladen werden kann, m√ºssen Sie dem Emulator- <code>firmware=null</code> Parameter <code>firmware=null</code> hinzuf√ºgen: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=null,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><h3 id="nastroyka-debug-konfiguracii">  Debug-Konfiguration </h3><br><p>  W√§hlen Sie in Eclipse das Men√º <em>Ausf√ºhren - Debug-Konfigurationen ... aus.</em> In dem sich √∂ffnenden Fenster im Abschnitt <em>GDB-Hardware-Debugging</em> m√ºssen Sie eine neue Konfiguration hinzuf√ºgen. <em>Geben</em> Sie anschlie√üend auf der Registerkarte "Main" das aktuelle Projekt und die Anwendung zum Debuggen an: </p><br><img src="https://habrastorage.org/webt/f-/yk/eo/f-ykeob2i5vg25qbrz_egbqntou.png"><br><p>  Auf der Registerkarte Debugger m√ºssen Sie den Befehl GDB angeben: <br> <code>${openstm32_compiler_path}\arm-none-eabi-gdb</code> </p> <br><p>  Geben Sie au√üerdem die Parameter f√ºr die Verbindung zum GDB-Server (Host und Port) ein: </p><br><img src="https://habrastorage.org/webt/ef/ud/fo/efudfommb7a9gkr4kcvp0vtnqfm.png"><br><p>  Die folgenden Parameter m√ºssen auf der Registerkarte "Start" angegeben werden: </p><br><ul><li>  Aktivieren Sie das Kontrollk√§stchen <em>Image</em> laden (damit das zusammengestellte Firmware-Image in den Emulator geladen wird). </li><li>  Aktivieren Sie das H√§kchen <em>Symbole</em> laden. </li><li>  <code>set $pc = *0x08000004</code> einen <code>set $pc = *0x08000004</code> hinzu: <code>set $pc = *0x08000004</code> (Setzen Sie den Wert aus dem Speicher auf die Adresse <code>0x08000004</code> im PC-Register - die Adresse des <code>0x08000004</code> wird dort gespeichert). </li></ul><br><p>  <strong>Beachten Sie,</strong> dass Sie, wenn Sie die Firmware-Datei nicht von Eclipse herunterladen m√∂chten, die Parameter " <em>Image</em> laden" und " <em>Befehle ausf√ºhren"</em> nicht angeben m√ºssen. </p><br><img src="https://habrastorage.org/webt/w3/q8/2f/w3q82fvei4c91385rlcipmuiy_i.png"><br><p>  Nachdem Sie auf Debug geklickt haben, k√∂nnen Sie im Debug-Modus arbeiten: </p><br><ul><li>  Schritt-f√ºr-Schritt-Codeausf√ºhrung <br><img src="https://habrastorage.org/webt/1h/6n/ax/1h6nax1gpgcdyrwakdmzzlu6_x8.png"></li><li>  Interaktion mit Haltepunkten <br><img src="https://habrastorage.org/webt/4d/n1/5e/4dn15e4hzaukbif58ggwhy_wg18.png"></li></ul><br><p>  <strong><em>Hinweis</em></strong>  <em>Eclipse hat, hmm ... einige Funktionen ... und man muss damit leben.</em>  <em>Wenn beispielsweise beim Starten des Debuggers die Meldung "Keine Quelle f√ºr" 0x0 "verf√ºgbar" angezeigt wird, f√ºhren Sie den Befehl "Schritt" (F5) aus.</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/uz/ko/rauzko55hgnj1y_uapnqbz8ftrw.png"></div><br><h2 id="vmesto-zaklyucheniya">  Anstelle einer Schlussfolgerung </h2><br><p>  Die Emulation von nativem Code ist eine sehr interessante Sache.  F√ºr einen Ger√§teentwickler wird es m√∂glich, Firmware ohne ein echtes Ger√§t zu debuggen.  F√ºr den Forscher - die F√§higkeit, eine dynamische Code-Analyse durchzuf√ºhren, die selbst mit einem Ger√§t nicht immer m√∂glich ist. </p><br><p>  Wir m√∂chten Spezialisten ein Tool zur Verf√ºgung stellen, das bequem und m√§√üig einfach ist und f√ºr dessen Konfiguration und Start nicht viel Aufwand und Zeit erforderlich ist. </p><br><p>  Schreiben Sie in die Kommentare √ºber Ihre Erfahrungen mit der Verwendung von Hardware-Emulatoren.  Wir laden Sie zu einer Diskussion ein und beantworten gerne Ihre Fragen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de445798/">https://habr.com/ru/post/de445798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de445786/index.html">Kryptographie in Java. KeyStore-Klasse</a></li>
<li><a href="../de445788/index.html">Cloud-Video√ºberwachung zum Selbermachen: Neue Funktionen des Ivideon Web SDK</a></li>
<li><a href="../de445792/index.html">Wie wir Dokumentation in einem offenen Embox-Projekt entwickeln</a></li>
<li><a href="../de445794/index.html">IT-Giganten stellen eine hybride Hybrid-Cloud-Bereitstellungsl√∂sung vor</a></li>
<li><a href="../de445796/index.html">Fintech Digest: Dorsey zahlt mit Bitcoins, Australiens Blockchain-Strategie, Levis B√∂rsengang, B√ºrgermeister von Chicago und der Unvermeidlichkeit von Bitcoin</a></li>
<li><a href="../de445800/index.html">Monaden in 15 Minuten</a></li>
<li><a href="../de445802/index.html">5 Dinge, √ºber die Internet-Trends jeder wissen sollte</a></li>
<li><a href="../de445804/index.html">Kapselung f√ºr echte Samurai oder die Nuancen, die mit dem internen Schl√ºsselwort in C # verbunden sind</a></li>
<li><a href="../de445806/index.html">Wie k√ºnstliche Intelligenz die Wissenschaft ver√§ndert</a></li>
<li><a href="../de445808/index.html">Wir hassen und jagen: das gef√§hrliche Leben eines Virus-Crackers, der sich m√§chtige Feinde macht</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>