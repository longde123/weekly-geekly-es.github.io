<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíî üêÇ üïé Las aventuras de los esquivos Malvari, Parte II: Guiones secretos de VBA ‚åõÔ∏è üí® ‚úåüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo es parte de la serie Fileless Malware. Todas las otras partes de la serie: 



- Las aventuras de los esquivos Malvari, Parte I 
- Las a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Las aventuras de los esquivos Malvari, Parte II: Guiones secretos de VBA</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/458010/"><img src="https://habrastorage.org/webt/3t/ih/b0/3tihb0g1kt7wbjalc_s3xe0xgjo.png"><br><br>  Este art√≠culo es parte de la serie Fileless Malware.  Todas las otras partes de la serie: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Las aventuras de los esquivos Malvari, Parte I</a> </li><li>  Las aventuras de los esquivos Malvari, Parte II: Scripts ocultos de VBA (estamos aqu√≠) </li></ul><br>  Soy fan√°tico del sitio web de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis h√≠brido</a> (HA).  Este es un tipo de zool√≥gico de malware donde puedes ver de forma segura "depredadores" salvajes desde una distancia segura sin ser atacado.  HA lanza malware en entornos seguros, registra llamadas del sistema, archivos generados y tr√°fico de Internet, y muestra todos estos resultados para cada muestra que analice.  Por lo tanto, no puede desperdiciar su tiempo y energ√≠a resolviendo el c√≥digo confuso, sino que comprende de inmediato todas las intenciones de los piratas inform√°ticos. <br><a name="habracut"></a><br>  Los ejemplos de HA que me llamaron la atenci√≥n usan scripts codificados con JavaScript o Visual Basic para Aplicaciones (VBA) que est√°n incrustados como macros en documentos de Word o Excel y se adjuntan a correos electr√≥nicos de phishing.  Cuando se abren, estas macros inician una sesi√≥n de PowerShell en la computadora de la v√≠ctima.  Los hackers suelen enviar secuencias de comandos codificados en Base64 a PowerShell.  Todo esto se hace para dificultar la detecci√≥n del ataque con filtros web y software antivirus que responden a palabras clave espec√≠ficas. <br>  Afortunadamente, HA decodifica autom√°ticamente Base64 e inmediatamente muestra todo de forma legible.  Esencialmente, no necesita centrarse en c√≥mo funcionan estos scripts, porque puede ver la salida completa de los comandos para ejecutar procesos en la secci√≥n de HA correspondiente.  Vea un ejemplo a continuaci√≥n: <br><br><img src="https://habrastorage.org/webt/ew/jp/cw/ewjpcwuesyaeevrw55513pjcxy4.jpeg"><br><br>  El an√°lisis h√≠brido intercepta los comandos codificados en Base64 enviados a PowerShell: <br><br><img src="https://habrastorage.org/webt/yy/j7/wx/yyj7wxyf8ejzrjtbnzgjfpdrucc.jpeg"><br><br>  ... y luego los decodifica por ti.  # m√°gicamente <br><br>  En una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n anterior,</a> cre√© mi propio contenedor de JavaScript ligeramente ofuscado para comenzar una sesi√≥n de PowerShell.  Luego, mi script, como muchos malware basados ‚Äã‚Äãen PowerShell, descarga el siguiente script de PowerShell desde un sitio web remoto.  Luego, como ejemplo, descargu√© una PS inofensiva imprimiendo un mensaje en la pantalla.  Pero los tiempos est√°n cambiando, y ahora propongo complicar el escenario. <br><br><h2>  PowerShell Empire y Reverse Shell </h2><br>  Un objetivo de este ejercicio es mostrar cu√°n (relativamente) f√°cilmente un hacker puede sortear las defensas perimetrales y los antivirus cl√°sicos.  Si un blogger de TI sin habilidades de programaci√≥n como yo puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">crear un malware</a> completamente no detectado (FUD) en un par de noches, ¬°imagine las posibilidades de un joven hacker interesado en esto! <br><br>  Y si usted es una persona que brinda seguridad de TI, pero su gerente no est√° al tanto de las posibles consecuencias de estas amenazas, solo mu√©strele este art√≠culo. <br><br>  Los hackers sue√±an con obtener acceso directo a una computadora port√°til o al servidor de la v√≠ctima.  Es muy simple hacer esto: todo lo que el hacker necesita es obtener algunos archivos confidenciales en la computadora port√°til del CEO. <br><br>  De alguna manera, ya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escrib√≠</a> sobre el tiempo de ejecuci√≥n postoperatorio de PowerShell Empire.  Recordemos de qu√© se trata. <br><br>  En esencia, es una herramienta de prueba de penetraci√≥n basada en PowerShell que, entre muchas otras caracter√≠sticas, facilita la ejecuci√≥n de un shell inverso.  Puede obtener m√°s informaci√≥n al respecto en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la p√°gina principal de PSE</a> . <br><br>  Hagamos un peque√±o experimento.  Configur√© un entorno seguro de prueba de malware en la nube de Amazon Web Services.  Puede seguir mi ejemplo para mostrar de manera r√°pida y segura un ejemplo funcional de esta vulnerabilidad (y no ser despedido por lanzar virus dentro del per√≠metro de la empresa). <br><br>  Si inicia la consola de PowerShell Empire, ver√° algo como lo siguiente: <br><br><img src="https://habrastorage.org/webt/vx/-j/mf/vx-jmf1qyoc8cfo1nmcockocfea.jpeg"><br><br>  Primero, inicia el proceso de escucha en su computadora hacker.  Ingrese el comando "oyente" y especifique la direcci√≥n IP de su sistema usando "establecer host".  Luego, inicie el proceso de escucha con el comando de ejecuci√≥n (a continuaci√≥n).  Por lo tanto, por su parte, comience a esperar una conexi√≥n de red desde el shell remoto: <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  Para el otro lado, deber√° generar el c√≥digo del agente ingresando el comando del iniciador (ver m√°s abajo).  Esto generar√° c√≥digo de PowerShell para el agente remoto.  Tenga en cuenta que est√° codificado en Base64 y representa la segunda fase de la carga √∫til.  En otras palabras, mi c√≥digo JavaScript ahora extraer√° este agente para ejecutar PowerShell en lugar de la salida de texto inofensivo a la pantalla y se conectar√° a nuestro servidor PSE remoto para ejecutar el shell inverso. <br><br><img src="https://habrastorage.org/webt/xh/vs/ig/xhvsigu6puk1rvt0e3ttwh43uyg.jpeg"><br>  <em>La magia del caparaz√≥n inverso.</em>  <em>Este comando codificado de PowerShell se conectar√° a mi escucha e iniciar√° el shell remoto.</em> <br><br>  Para mostrarle este experimento, asum√≠ el papel de una v√≠ctima inocente y abr√≠ Evil.doc, lanzando as√≠ nuestro JavaScript.  ¬øRecuerdas la primera parte?  PowerShell se configur√≥ para que su ventana no aparezca, por lo que la v√≠ctima no notar√° nada inusual.  Sin embargo, si abre el Administrador de tareas de Windows, ver√° el proceso en segundo plano de PowerShell, que todav√≠a no causar√° ninguna alarma para la mayor√≠a.  Porque es PowerShell normal, ¬øno? <br><br><img src="https://habrastorage.org/webt/wz/se/cr/wzsecrznut3tonqek3wteofemiw.jpeg"><br><br>  Ahora, cuando ejecuta Evil.doc, un proceso de fondo oculto se conectar√° al servidor con PowerShell Empire.  Despu√©s de ponerme el sombrero blanco del hacker-pentester, volv√≠ a la consola de PowerShell Empire y ahora veo un mensaje de que mi agente remoto est√° activo. <br><br><img src="https://habrastorage.org/webt/fm/1e/ux/fm1eux-ocyidttp4eqlt9q0qb74.jpeg"><br><br>  Luego ingres√© el comando "interactuar" para abrir el shell en PSE, ¬°y aqu√≠ estoy!  En resumen, pirate√© un servidor de Taco, que yo mismo configur√© una vez. <br><br><img src="https://habrastorage.org/webt/vh/to/0z/vhto0zmky-9wpmxxpf2tnlzze5s.jpeg"><br><br>  Lo que acabo de demostrar no requiere mucho trabajo de su parte.  Puede hacer todo esto de forma segura durante una pausa para el almuerzo durante una o dos horas para mejorar su conocimiento de la seguridad de la informaci√≥n.  Tambi√©n es una excelente manera de comprender c√≥mo los piratas inform√°ticos eluden la protecci√≥n del per√≠metro de seguridad externo y se implementan de forma encubierta en sus sistemas. <br><br>  Los gerentes de TI que creen que han construido una protecci√≥n indestructible contra cualquier penetraci√≥n probablemente tambi√©n lo encuentren informativo, bueno, si, por supuesto, puede convencerlos de que se sienten a su lado durante mucho tiempo. <br><br><h2>  De vuelta a la realidad </h2><br>  Como esperaba, un truco real que no es visible para el usuario promedio es solo una variaci√≥n de lo que acabo de describir.  Para recopilar material para la pr√≥xima publicaci√≥n, comenc√© a buscar una muestra en HA que funciona de la misma manera que mi ejemplo inventado.  Y no tuve que buscarlo durante mucho tiempo: el sitio tiene muchas opciones para tal t√©cnica de ataque. <br><br>  El malware que termin√© encontrando en HA es el script \ VBA que se incorpor√≥ al documento de Word.  Es decir, ni siquiera necesito falsificar la extensi√≥n doc, este malware es realmente el documento de Microsoft Word m√°s com√∫n.  Si est√° interesado, eleg√≠ esta muestra, llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rfq.doc</a> . <br><br>  R√°pidamente descubr√≠ que a menudo no podr√° extraer directamente secuencias de comandos VBA maliciosas de un documento.  Los piratas inform√°ticos los comprimen y los ocultan, y no son visibles en las herramientas de macro integradas de Word.  Necesitar√° una herramienta especial para extraerlo.  Afortunadamente, me encontr√© con el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OfficeMalScanner de</a> Frank Baldwin.  Gracias Frank. <br><br>  Usando esta herramienta, pude extraer un c√≥digo VBA muy confuso.  Se parec√≠a a esto: <br><br><img src="https://habrastorage.org/webt/sd/nc/mo/sdncmon3h_nk5cr_hdgzld3jsns.jpeg"><br>  <em>La ofuscaci√≥n fue realizada por profesionales.</em>  <em>Estaba impresionado!</em> <br><br>  Los atacantes son realmente buenos para desordenar el c√≥digo, no como mis esfuerzos para crear Evil.doc.  Bueno, est√° bien, en la siguiente parte obtendremos nuestros depuradores de VBA, profundizaremos un poco m√°s en este c√≥digo y compararemos nuestro an√°lisis con los resultados de HA. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/458010/">https://habr.com/ru/post/458010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457996/index.html">Confesi√≥n del jefe: c√≥mo trabajar mientras viaja, despedir a la mitad del departamento en Los √Ångeles y por qu√© patrocinar a MeksetnoExp Tyoma Lebedev</a></li>
<li><a href="../458000/index.html">Evaluaci√≥n de pose humana en im√°genes para iOS</a></li>
<li><a href="../458002/index.html">Lo que realmente sucedi√≥ con el desaparecido Boeing de Malasia (parte 1/3)</a></li>
<li><a href="../458004/index.html">Sistema de control de tr√°fico de naves espaciales Soyuz-TM parte 2</a></li>
<li><a href="../458006/index.html">Sitios din√°micos sin servidor en las p√°ginas de Github (para aquellos que no saben, sin servidor usan servidores API de terceros)</a></li>
<li><a href="../458014/index.html">Robot FEDOR: entrenamiento con el nuevo equipo de ISS y las primeras tareas espaciales</a></li>
<li><a href="../458018/index.html">compositor vs npm: desarrollo de m√≥dulos m√∫ltiples</a></li>
<li><a href="../458020/index.html">Resumen de eventos de TI de julio</a></li>
<li><a href="../458022/index.html">¬øHuellas digitales a trav√©s de anuncios publicitarios? Ahora esto es com√∫n</a></li>
<li><a href="../458026/index.html">Comparaci√≥n de formatos de serializaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>