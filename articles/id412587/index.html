<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👙 🏴‍☠️ 💂 Wayang + Hiera. Peras maksimal 👨🏿‍⚕️ 👨🏽‍🎤 👨‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, saya ingin berbicara tentang bagaimana kami menggunakan Wayang dan Hiera untuk mengkonfigurasi server besi dan virtual. Pada dasarny...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wayang + Hiera. Peras maksimal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/412587/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vq/z-/bj/vqz-bjm4yx2wvhzcf-frffyuh04.png"></div><br><p>  Pada artikel ini, saya ingin berbicara tentang bagaimana kami menggunakan <strong>Wayang</strong> dan <strong>Hiera</strong> untuk mengkonfigurasi server besi dan virtual.  Pada dasarnya, ini tentang arsitektur dan hierarki yang kami temukan, yang memfasilitasi dan mensistematisasikan konfigurasi server. </p><br><p>  Saya diminta untuk menulis artikel ini dengan fakta bahwa di internet saya tidak menemukan contoh yang baik dan benar-benar berfungsi tentang bagaimana Anda dapat bekerja dengan hiera dan untuk apa itu.  Pada dasarnya, ini adalah tutorial dengan contoh untuk memasukkan topik.  Tetapi aplikasi praktis sebenarnya dari hiera tidak ditulis di sana.  Mungkin saya tidak terlihat baik, tetapi di sini ada contoh nyata yang mungkin akan membantu Anda meletakkan semua poin di atas saya, seperti yang pernah saya lakukan. </p><br><h3 id="dlya-kogo-byla-by-polezna-dannaya-statya">  Untuk siapa artikel ini akan bermanfaat </h3><br><p>  Jika: </p><br><ul><li>  Anda tahu apa itu Wayang dan Hiera, tetapi Anda tidak benar-benar menggunakannya bersama-sama, karena tidak jelas bagaimana melakukannya dan mengapa </li><li>  Anda memiliki banyak tim di perusahaan Anda dan Anda perlu membedakan konfigurasi server di tingkat perintah </li><li>  Anda menggunakan pappet, dan file simpul Anda telah berkembang ke ukuran luar biasa </li><li>  Apakah Anda suka membaca konfigurasi server dalam format divine yaml :) </li><li>  Anda pada dasarnya tertarik pada topik Manajemen Konfigurasi dan administrasi sistem. </li></ul><br><p>  Artikel ini untuk Anda. </p><a name="habracut"></a><br><h3 id="prezhde-chem-nachat">  Sebelum Anda mulai </h3><br><p>  Saya akan segera memperingatkan Anda, artikelnya ternyata panjang, tapi saya harap bermanfaat.  Selain itu, dipahami bahwa Anda telah menghubungkan hiera ke boneka, dan Anda setidaknya entah bagaimana akrab dengan boneka.  Jika hiera tidak terhubung, tidak sulit untuk melakukannya. </p><br><ul><li>  Baca lebih lanjut tentang apa itu Wayang di sini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Wayang untuk pemula</a> . </li><li>  Bagaimana Hiera Bekerja - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memperkenalkan Hiera</a> . </li></ul><br><h3 id="vvodnye-dannye">  Masukkan data </h3><br><ul><li>  Kami memiliki sekitar 30 tim pengembangan di SEMrush, yang masing-masing memiliki server sendiri </li><li>  Setiap tim bekerja dengan set teknologinya sendiri (PL, DBMS, dll.) </li><li>  Tim dapat dan harus (idealnya) menggunakan konfigurasi umum untuk proyek tertentu (penggunaan kembali kode) </li><li>  Tim sendiri mengelola penyebaran aplikasi ke server mereka (ini tidak dilakukan melalui pappet) </li></ul><br><h3 id="nemnogo-istorii">  Sedikit sejarah </h3><br><p>  Awalnya, kami memiliki semua yang ada di pappet versi 3, kemudian kami memutuskan untuk mengimplementasikan pappet ke-4, dan semua server baru mulai ditempatkan di dalamnya, dan yang lama perlahan-lahan dipindahkan ke porta ke-4. </p><br><p>  Di pappet ketiga, kami biasa menggunakan sistem klasik file dan modul node.  Modul-modul tersebut dibuat dalam kelompok proyek khusus di Gitlab, mereka dikloning ke server pappet (menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">r10k</a> ), kemudian agen pappet datang ke wizard dan menerima direktori untuk menerapkannya ke server. </p><br><p>  Kemudian mereka mulai berusaha untuk tidak melakukan ini dan tidak menggunakan modul lokal, tetapi menaruh tautan ke modul yang diperlukan dan repositori mereka di Puppetfile.  Mengapa  Karena modul-modul itu terus didukung dan ditingkatkan (baik, idealnya) oleh komunitas dan pengembang, dan yang lokal tidak.  Kemudian mereka memperkenalkan hiera dan beralih sepenuhnya ke sana, dan file simpul (seperti nodes.pp) telah tenggelam terlupakan. </p><br><p> Pada pappet keempat, kami mencoba untuk sepenuhnya meninggalkan modul lokal dan hanya menggunakan modul jarak jauh.  Sayangnya, reservasi harus dimasukkan di sini lagi, karena "tidak berhasil sepenuhnya", kadang-kadang Anda masih harus condong dan menyelesaikan sesuatu sendiri.  Tentu saja, hanya ada hiera dan tidak ada file simpul. </p><br><p>  <strong>Ketika Anda memiliki 30 tim dengan kebun binatang teknologi, masalah bagaimana menjaga server ini dengan&gt; 1000 server menjadi sangat akut.</strong>  <strong>Selanjutnya saya akan mengatakan bagaimana hiera membantu kita dalam hal ini.</strong> </p><br><h3 id="ierarhiya">  Hierarki </h3><br><p>  Hiera (sebenarnya, dari mana ia mendapatkan namanya) mengatur hierarki.  Bersama kami, terlihat seperti ini: </p><br><pre><code class="hljs axapta">--- :hierarchy: - <span class="hljs-string"><span class="hljs-string">"nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/nodes/%{::fqdn}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/roles/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"teams/%{::team}_team/%{::team}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}/%{::role}"</span></span> - <span class="hljs-string"><span class="hljs-string">"projects/%{::project}"</span></span> - <span class="hljs-string"><span class="hljs-string">"tiers/%{::tier}"</span></span> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Pertama, mari kita berurusan dengan variabel yang tidak jelas (fakta). </p><br><p>  Setiap server di SEMrush idealnya memiliki 4 fakta terbuka yang menjelaskan afiliasinya: </p><br><ul><li>  fakta <strong><code>team</code></strong> - tim mana yang menjadi bagiannya </li><li>  <strong><code>project</code></strong> fakta - <strong><code>project</code></strong> mana yang berhubungan dengannya </li><li>  fakta <strong><code>role</code></strong> - peran apa yang dimiliki proyek ini </li><li>  <strong><code>tier</code></strong> fact - pementasan seperti apa yang dimilikinya (prod, test, dev) </li></ul><br><p>  Bagaimana cara kerjanya?  Agen Pappet mendatangi master Pappet dan, berdasarkan fakta-fakta ini, mencari file untuk dirinya sendiri, menelusuri folder sesuai dengan hierarki kami.  Tidak perlu menunjukkan file konfigurasi milik server.  Sebaliknya, server sendiri tahu file mana yang menjadi milik mereka, hanya melihat jalur dan fakta mereka. </p><br><p>  Selama pengaturan server, admin menghubungi pengembang dan menentukan parameter ini (seringkali, sebaliknya, orang-orang yang berpengetahuan menghubungi administrator sendiri) untuk membangun hierarki hiera di masa depan, atas dasar yang kemudian menggambarkan konfigurasi server.  Sistem seperti ini membantu menggunakan kembali kode dan menjadi lebih fleksibel dalam hal konfigurasi server. </p><br><p>  Sebagai contoh, kami memiliki proyek <em>khusus</em> .  Dalam proyek ini, mungkin ada beberapa server frontend dengan nginx, server backend dengan python, cluster db dengan mysql, server redis untuk caching.  Semua server ini harus ditempatkan dalam satu proyek yang disebut <strong>spesial</strong> , dan kemudian menetapkan <strong>peran</strong> ke server. </p><br><p>  Dalam file proyek, kami menjelaskan parameter yang umum untuk seluruh proyek.  Hal pertama yang terlintas dalam pikiran adalah penciptaan pada semua server pengguna untuk penyebaran dengan masalah hak yang diperlukan untuknya dan meluncurkan kunci ssh-nya. </p><br><p>  Dalam peran untuk setiap server, layanan ini biasanya dijelaskan dan dikustomisasi - untuk apa server ini dimaksudkan (nginx, python, mysql, dll.) Tingkat dalam hal ini kita pasti perlu jika kita juga perlu menggunakan salinan lingkungan produksi pada platform dev, tetapi ubah sesuatu di dalamnya (kata sandi, misalnya).  Dalam hal ini, dev-server dan prod-server hanya akan berbeda dalam kenyataan bahwa tier diatur ke "posisi" yang diinginkan (prod atau dev).  Dan kemudian sedikit sihir dan hiera akan melakukan trik. </p><br><p>  Jika kita perlu menggunakan dua server identik dalam peran yang sama, tetapi sesuatu di dalamnya harus berbeda, misalnya, beberapa baris dalam konfigurasi, maka bagian lain dari hierarki akan datang untuk menyelamatkan.  Kami meletakkan file dengan nama format <strong><code>{fqdn }.yaml</code></strong> di tempat yang tepat (misalnya, <strong><code>nodes/myserver.domain.net</code></strong> ), mengatur nilai variabel yang diperlukan pada tingkat server tertentu, dan pappet akan menerapkan konfigurasi yang sama untuk kedua server untuk peran, dan unik untuk masing-masing dari server. </p><br><p>  Contoh: dua backends dengan kode php berada dalam peran yang sama dan benar-benar identik.  Jelas bahwa kami tidak ingin membuat cadangan kedua server - tidak masuk akal.  Kita dapat membuat peran untuk mendeskripsikan konfigurasi yang sama untuk kedua server, dan kemudian membuat file <strong><code>nodes/backend1.semrush.net</code></strong> lain untuk menempatkan konfigurasi untuk cadangan. </p><br><p>  File <strong><code>teams/team-name.yaml</code></strong> batch <strong><code>teams/team-name.yaml</code></strong> menunjukkan konfigurasi untuk semua server milik tim.  Paling sering, ini menggambarkan pengguna yang dapat berinteraksi dengan server ini, serta hak akses mereka. </p><br><p>  Berdasarkan variabel-variabel ini, kami telah membangun <strong>hierarki</strong> ini.  Semakin tinggi file yang ditemukan dalam hierarki, semakin tinggi prioritas konfigurasi yang ditentukan di dalamnya. </p><br><p>  Oleh karena itu variabel dapat <strong>menimpa</strong> berdasarkan hierarki ini.  Yaitu, variabel dalam file peran " <strong><code>projects/%{::project}/%{::role}</code></strong> " lebih diutamakan daripada variabel dalam file <strong><code>projects/%{::project}</code></strong> " <strong><code>projects/%{::project}</code></strong> ".  Variabel juga dapat bergabung di semua tingkatan hierarki jika Anda memiliki modul dan / atau profil / peran yang ditulis sedemikian rupa yang memungkinkan Anda untuk melakukan ini.  Dengan menentukan bagian umum dari konfigurasi mysql untuk semua server proyek, Anda dapat menambahkan bagian-bagian khusus yang memiliki bobot untuk peran ini ke variabel yang sama di tingkat hierarki lain (akan ada bagian tambahan dalam konfigurasi untuk slave). </p><br><p>  Ternyata file dari node spesifik yang terletak di sepanjang jalur " <strong><code>hieradata/nodes/%{::fqdn}</code></strong> " memiliki prioritas tertinggi.  Berikutnya adalah file simpul, tetapi sudah di tingkat perintah.  Di bawah ini adalah blok yang menggambarkan fakta lain yang lebih umum: </p><br><pre> <code class="hljs axapta"> - <span class="hljs-string"><span class="hljs-string">"virtual/%{::virtual}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}/%{::operatingsystemmajrelease}"</span></span> - <span class="hljs-string"><span class="hljs-string">"os/%{::operatingsystem}"</span></span> - users - <span class="hljs-keyword"><span class="hljs-keyword">common</span></span></code> </pre> <br><p>  Dengan demikian, dalam file <strong><code>common.yaml</code></strong> kami memiliki konfigurasi yang pasti harus datang ke <strong>semua</strong> server, di file <strong><code>users.yaml</code></strong> semua pengguna dijelaskan (tetapi tentu saja tidak semuanya dibuat di server,) di <strong><code>os/%{::operatingsystem}</code></strong> konfigurasi umum yang tipikal untuk server dengan OS tertentu (fakta <code>::operatingsystem</code> ) dan sebagainya. </p><br><p>  Saya pikir, melihat hierarki ini, semuanya menjadi jelas.  Di bawah ini saya akan mempertimbangkan contoh penggunaan hierarki tersebut.  Tetapi pertama-tama Anda perlu berbicara tentang profil. </p><br><h3 id="profili">  Profil </h3><br><p>  Poin penting dalam mengkonfigurasi server menggunakan modul adalah penggunaan profil.  Mereka terletak di jalur <strong><code>site/profiles</code></strong> dan merupakan titik masuk ke modul.  Berkat mereka, Anda dapat lebih mengonfigurasi modul gantung di server dan membuat sumber daya yang diperlukan. </p><br><p>  Pertimbangkan contoh sederhana.  Ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">modul</a> yang menginstal dan mengkonfigurasi redis.  Dan kami juga ingin mengatur parameter sysctl <code>vm.overcommit_memory</code> menjadi 1 saat menghubungkan modul ini, karena di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> .  Kemudian kami menulis profil kecil yang menyediakan fungsi ini: </p><br><pre> <code class="hljs lua"># standalone redis server class profiles::db::redis ( Hash $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = {}, String $output_buffer_limit_slave = <span class="hljs-string"><span class="hljs-string">'256mb 64mb 60'</span></span>, ) { # https://redis.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/topics/faq#background-saving-fails-with-a-fork-<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>-under-linux-even-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-i-have-a-lot-of-free-ram sysctl { <span class="hljs-string"><span class="hljs-string">'vm.overcommit_memory'</span></span>: ensure =&gt; present, value =&gt; <span class="hljs-string"><span class="hljs-string">'1'</span></span>, } class { <span class="hljs-string"><span class="hljs-string">'::redis'</span></span>: * =&gt; $<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>, } }</code> </pre> <br><p>  Seperti disebutkan di atas, profil adalah alat yang memungkinkan Anda untuk mengubah / meningkatkan perilaku modul, serta mengurangi jumlah konfigurasi di hiera.  Jika Anda menggunakan modul jarak jauh, Anda dapat sering menghadapi masalah yang modul "disetujui" sering tidak memiliki fungsi yang Anda butuhkan, atau memiliki beberapa bug / kekurangan.  Kemudian, pada prinsipnya, Anda dapat mengkloning modul ini dan memperbaiki / menambah fungsionalitas.  Tetapi keputusan yang tepat adalah, jika mungkin, untuk menulis profil yang baik yang dapat "mempersiapkan" modul dengan cara yang Anda butuhkan.  Berikut adalah beberapa contoh profil, dan Anda dapat lebih memahami mengapa itu diperlukan. </p><br><h3 id="sokrytie-sekretov-v-hiera">  Menyembunyikan rahasia di hiera </h3><br><p>  Salah satu keuntungan penting hiera dibandingkan dengan bare pappet adalah kemampuannya untuk menyimpan data sensitif dalam file konfigurasi dalam bentuk terenkripsi dalam repositori.  Kata sandi Anda akan aman. </p><br><p>  Singkatnya, Anda menggunakan kunci publik untuk mengenkripsi informasi yang Anda butuhkan dan menempatkannya dengan garis seperti itu di file hiera.  Bagian pribadi dari kunci disimpan pada master pappet, yang memungkinkan Anda untuk mendekripsi data ini.  Rincian lebih lanjut dapat ditemukan di halaman <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">proyek</a> . </p><br><p>  Pada klien (komputer yang bekerja), alat ini diinstal hanya dengan menggunakan <strong><code>gem install hiera-eyaml</code></strong> .  Selanjutnya, dengan menggunakan perintah dari bentuk <strong><code>eyaml encrypt --pkcs7-public-key=/path/to/public_key.pkcs7.pem -s 'hello'</code></strong> Anda dapat mengenkripsi data dan menempelkannya ke file dengan ekstensi eyaml atau hanya yaml, tergantung pada bagaimana Anda konfigurasikan, dan kemudian pappet akan mengetahuinya.  Anda mendapatkan sesuatu seperti: </p><br><pre> <code class="hljs ruby">roles::postrgresql::<span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T+Lq194Y6QdElMD1XTev5y+VPSHtkPTu6Al6TJaSrXF+7phJIjue+NF4ZVtJCLkHxUR6nJJqks0fcGS1vF2+6mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTewqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv+qnptnZ7pilR2veOCPW2UMm6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV/5lfcL5ajdNBJXkvKqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA+0wjAMblkKgBCR/f9KGXUgLh3/Ok60OIT5]'</span></span></code> </pre> <br><p>  Atau string multi-line: </p><br><pre> <code class="hljs powershell">roles::postgresql::password: &gt; ENC[<span class="hljs-type"><span class="hljs-type">PKCS7</span></span>,<span class="hljs-type"><span class="hljs-type">MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEw</span></span> <span class="hljs-type"><span class="hljs-type">DQYJKoZIhvcNAQEBBQAEggEAbIz1ihQlThMWa9T</span></span>+<span class="hljs-type"><span class="hljs-type">Lq194Y6QdElMD1XTev5y</span></span> +<span class="hljs-type"><span class="hljs-type">VPSHtkPTu6Al6TJaSrXF</span></span>+<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-type"><span class="hljs-type">phJIjue</span></span>+<span class="hljs-type"><span class="hljs-type">NF4ZVtJCLkHxUR6nJJqks0fcGS1vF</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-type"><span class="hljs-type">mmM9cy69sIU1A3HqpOHZLuqHAc7jUqljYxpwWSIGOK6I2FygdAp5FfOTe</span></span> <span class="hljs-type"><span class="hljs-type">wqfcVVmXj97EJdcv3DKrbAlSrIMO2iZRYwQvyv</span></span>+<span class="hljs-type"><span class="hljs-type">qnptnZ7pilR2veOCPW2UM</span></span> <span class="hljs-type"><span class="hljs-type">m6zagDLutX9Ft5vERbdaiCiEfTOpVa9Qx0GqveNRVJLV</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-type"><span class="hljs-type">lfcL5ajdNBJXkv</span></span> <span class="hljs-type"><span class="hljs-type">KqDbx8d3ZBtEVAAqeKlw0LqzScgmCbWQx2kUzukX5LSxbTpT0Th984Vp1sl7</span></span> <span class="hljs-type"><span class="hljs-type">iPk7UTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBCp5GcwidcEMA</span></span>+<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-type"><span class="hljs-type">wjAM</span></span> <span class="hljs-type"><span class="hljs-type">blkKgBCR</span></span>/<span class="hljs-type"><span class="hljs-type">f9KGXUgLh3</span></span>/<span class="hljs-type"><span class="hljs-type">Ok60OIT5</span></span>]</code> </pre> <br><p>  Sepertinya kita sudah selesai dengan persiapan, sekarang kita dapat mempertimbangkan contoh. </p><br><h3 id="primer-na-palcah">  Contoh jari </h3><br><p>  <strong>Spoiler</strong> : <em>akan ada lebih banyak konfigurasi, sehingga mereka yang tertarik pada artikel ini yang murni kepentingan teoretis dapat melewati bagian ini dan pergi ke bagian akhir.</em> </p><br><p>  Sekarang mari kita lihat contoh cara mengkonfigurasi server menggunakan hiera di puppet4.  Saya tidak akan mempublikasikan kode untuk semua profil, karena kalau tidak postingan akan menjadi cukup besar.  Saya akan fokus pada hierarki dan konfigurasi hiera. </p><br><p>  <strong>Tugasnya adalah ini:</strong> kita perlu menggunakan: </p><br><ul><li>  Dua server db identik yang digunakan postgresql </li><li>  Dua server lagi - frontend dengan nginx </li><li>  Server kelima dan keenam - python backends di buruh pelabuhan </li><li>  Semuanya sama pada lingkungan dev, kecuali untuk beberapa konfigurasi server </li></ul><br><p>  Kami akan membuat hierarki kami secara berurutan dan kami akan mulai dengan file proyek. </p><br><h4 id="proekt">  Proyek </h4><br><p>  Buat proyek file <strong><code>projects/kicker.yaml</code></strong> .  Kami memasukkan apa yang umum untuk semua server: kami membutuhkan beberapa repositori dan folder untuk penyebaran, serta pengguna yang menyebarkan sendiri. </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - apt::debian::semrush <span class="hljs-symbol"><span class="hljs-symbol">files:</span></span> <span class="hljs-string"><span class="hljs-string">"/srv/data"</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0755'</span></span> <span class="hljs-string"><span class="hljs-string">'/srv/data/shared_temp'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-string"><span class="hljs-string">'directory'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">owner:</span></span> <span class="hljs-string"><span class="hljs-string">'deploy'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">group:</span></span> <span class="hljs-string"><span class="hljs-string">'www-data'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mode:</span></span> <span class="hljs-string"><span class="hljs-string">'0775'</span></span> user_management::<span class="hljs-symbol"><span class="hljs-symbol">present:</span></span> - deploy</code> </pre> <br><h4 id="rol-db">  Peran db </h4><br><p>  Buat file peran untuk server database <strong><code>projects/kicker/db.yaml</code></strong> .  Sejauh ini, kami akan lakukan tanpa membagi server menjadi lingkungan: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::db::postgresql profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">globals:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">manage_package_repo:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">db_configs:</span></span> <span class="hljs-string"><span class="hljs-string">'listen_addresses'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> <span class="hljs-string"><span class="hljs-string">'*'</span></span> profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">databases:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">kicker:</span></span> {} profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">hba_rules:</span></span> <span class="hljs-string"><span class="hljs-string">'local connect to kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'local'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'001'</span></span> <span class="hljs-string"><span class="hljs-string">'allow connect from 192.168.1.100'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> <span class="hljs-string"><span class="hljs-string">'host'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">database:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">auth_method:</span></span> <span class="hljs-string"><span class="hljs-string">'md5'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">address:</span></span> <span class="hljs-string"><span class="hljs-string">'192.168.1.100/32'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">order:</span></span> <span class="hljs-string"><span class="hljs-string">'002'</span></span></code> </pre> <br><p>  Di sini kami menghubungkan satu profil yang ditulis untuk penggunaan umum oleh semua orang yang ingin menginstal postgres di server mereka.  Profil ini dapat dikonfigurasi dan memungkinkan Anda untuk mengkonfigurasi modul secara fleksibel sebelum menerapkannya. </p><br><p>  Untuk yang paling ingin tahu, di bawah kode cat untuk profil ini: </p><br><div class="spoiler">  <b class="spoiler_title">Profile :: db :: postgresql</b> <div class="spoiler_text"><pre> <code class="hljs mel">class profiles::db::postgresql ( Hash $globals = {}, Hash $params = {}, Hash $recovery = {}, Hash[String, Hash[String, Variant[String, Boolean, Integer]]] $roles = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $db_configs = {}, Hash[String, Hash[String, Variant[String, Boolean]]] $databases = {}, Hash[String, String] $db_grants = {}, Hash[String, Hash[String, String]] $extensions = {}, Hash[String, String] $table_grants = {}, Hash[String, Hash[String, String]] $hba_rules = {}, Hash[String, String] $indent_rules = {}, Optional[String] $role = undef, # <span class="hljs-string"><span class="hljs-string">'master'</span></span>, <span class="hljs-string"><span class="hljs-string">'slave'</span></span> Optional[String] $master_host = undef, Optional[String] $replication_password = undef, Integer $master_port = <span class="hljs-number"><span class="hljs-number">5432</span></span>, String $replication_user = <span class="hljs-string"><span class="hljs-string">'repl'</span></span>, String $trigger_file = <span class="hljs-string"><span class="hljs-string">'/tmp/pg_trigger.file'</span></span>, ){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> $role { <span class="hljs-string"><span class="hljs-string">'slave'</span></span>: { $_params = { manage_recovery_conf =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $globals[<span class="hljs-string"><span class="hljs-string">'datadir'</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"${globals['datadir']}/recovery.done"</span></span>: ensure =&gt; absent, } } $_recovery = { <span class="hljs-string"><span class="hljs-string">'recovery config'</span></span> =&gt; { standby_mode =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, primary_conninfo =&gt; <span class="hljs-string"><span class="hljs-string">"host=${master_host} port=${master_port} user=${replication_user} password=${replication_password}"</span></span>, trigger_file =&gt; $trigger_file, } } $_conf = { <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'on'</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; absent, } } <span class="hljs-string"><span class="hljs-string">'master'</span></span>: { $_conf = { <span class="hljs-string"><span class="hljs-string">'wal_level'</span></span> =&gt; { value =&gt; <span class="hljs-string"><span class="hljs-string">'replica'</span></span>, }, <span class="hljs-string"><span class="hljs-string">'max_wal_senders'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>, }, <span class="hljs-string"><span class="hljs-string">'wal_keep_segments'</span></span> =&gt; { value =&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>, }, } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $trigger_file: ensure =&gt; present, } } <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: { $_params = {} $_recovery = {} $_conf = {} } } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::globals'</span></span>: * =&gt; $globals, } class { <span class="hljs-string"><span class="hljs-string">'::postgresql::server'</span></span>: * =&gt; deep_merge($_params, $params), } create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::config_entry'</span></span>, deep_merge($_conf, $db_configs)) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::role'</span></span>, $roles) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database'</span></span>, $databases) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::database_grant'</span></span>, $db_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::extension'</span></span>, $extensions) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::table_grant'</span></span>, $table_grants) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_hba_rule'</span></span>, $hba_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::pg_indent_rule'</span></span>, $indent_rules) create_resources(<span class="hljs-string"><span class="hljs-string">'::postgresql::server::recovery'</span></span>, deep_merge($_recovery, $recovery)) }</code> </pre> </div></div><br><p>  Jadi, kita menginstal <code>Postgresql 10</code> satu gerakan, mengkonfigurasi konfigurasi ( <code>listen</code> ), membuat database <code>kicker</code> , dan juga menulis dua aturan untuk akses ke database ini di <code>pg_hba.conf</code> .  Keren! </p><br><h4 id="rol-frontend">  Peran frontend </h4><br><p>  Kami mengambil <code>frontend</code> .  Buat file <strong><code>projects/kicker/frontend.yaml</code></strong> dengan konten berikut: </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::webserver::nginx profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Semuanya sederhana di sini.  Kami menghubungkan <strong><code>profiles::webserver::nginx</code></strong> profil <strong><code>profiles::webserver::nginx</code></strong> , yang menyiapkan entri ke modul nginx, dan juga menentukan variabel, khususnya <code>server</code> dan <code>location</code> untuk situs ini. </p><br><p>  Pembaca yang penuh perhatian akan melihat bahwa akan lebih tepat untuk menempatkan deskripsi situs yang lebih tinggi dalam hierarki, karena kita masih akan memiliki lingkungan dev, dan variabel lain ( <code>server_name</code> , <code>proxy</code> ) akan digunakan di sana, tetapi ini tidak terlalu penting.  Menggambarkan peran dengan cara ini, kita dapat melihat bagaimana variabel-variabel ini didefinisikan ulang hanya oleh hierarki. </p><br><h4 id="rol-docker">  Peran buruh pelabuhan </h4><br><p>  Peran <strong><code>projects/kicker/docker.yaml</code></strong> <code>docker</code> <strong><code>projects/kicker/docker.yaml</code></strong> : </p><br><pre> <code class="hljs ruby">--- <span class="hljs-symbol"><span class="hljs-symbol">classes:</span></span> - profiles::docker profiles::docker::<span class="hljs-symbol"><span class="hljs-symbol">params:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'17.05.0~ce-0~debian-stretch'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">packages:</span></span> <span class="hljs-string"><span class="hljs-string">'python3-pip'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> apt <span class="hljs-string"><span class="hljs-string">'Fabric3'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> pip3 <span class="hljs-symbol"><span class="hljs-symbol">ensure:</span></span> <span class="hljs-number"><span class="hljs-number">1.12</span></span>.post1 user_management::<span class="hljs-symbol"><span class="hljs-symbol">users:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">deploy:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">groups:</span></span> - docker</code> </pre> <br><p>  <strong><code>profiles/docker.pp</code></strong> sangat sederhana dan elegan.  Saya akan memberikan kode: </p><br><div class="spoiler">  <b class="spoiler_title">Profil :: buruh pelabuhan</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">profiles</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:docker </span></span></span></span>( Hash $params = {}, <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> $install_kernel = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, ){ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-string"><span class="hljs-string">'docker'</span></span>: * =&gt; $params, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($install_kernel) { include profiles::docker::kernel } }</code> </pre> </div></div><br><p>  Semuanya sudah siap.  Ini sudah cukup untuk menyebarkan produk yang kita butuhkan di banyak server, cukup menugaskan mereka proyek dan peran tertentu (misalnya, meletakkan file dalam format yang diinginkan di direktori facts.d, lokasi yang tergantung pada metode pemasangan boneka). </p><br><p>  Sekarang kita memiliki struktur file berikut: </p><br><pre> <code class="bash hljs">. ├── kicker │ ├── db.yaml │ ├── docker.yaml │ └── frontend.yaml └── kicker.yaml 1 directory, 4 files</code> </pre> <br><p>  Sekarang kita akan berurusan dengan lingkungan dan definisi konfigurasi yang unik untuk peran di situs tertentu. </p><br><h4 id="okruzheniya-i-override">  Lingkungan dan penggantian </h4><br><p>  Mari kita buat konfigurasi umum untuk semua penjualan.  File <strong><code>projects/kicker/tiers/prod.yaml</code></strong> berisi indikasi bahwa kita perlu menghubungkan kelas dengan firewall ke lingkungan ini (well, prod all all same), serta kelas tertentu yang memberikan peningkatan tingkat keamanan: </p><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- classes: - semrush_firewall - strict_security_level</span></span></code> </pre> <br><p>  Untuk lingkungan dev, jika kita perlu menjelaskan sesuatu yang spesifik, file yang sama dibuat dan konfigurasi yang diperlukan dimasukkan ke dalamnya. </p><br><p>  Selanjutnya, Anda masih perlu mendefinisikan ulang variabel untuk konfigurasi nginx dari peran <code>frontend</code> di lingkungan dev.  Untuk melakukan ini, Anda perlu membuat <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> file <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> .  Perhatikan hierarki level baru. </p><br><pre> <code class="hljs ruby">--- profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">servers:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">use_default_location:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-symbol"><span class="hljs-symbol">listen_port:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server_name:</span></span> - <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> profiles::webserver::nginx::<span class="hljs-symbol"><span class="hljs-symbol">locations:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-root'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">server:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy:</span></span> <span class="hljs-string"><span class="hljs-string">'http://kicker-backend-dev.semrush.com:8080'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_set_header:</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Real-IP $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'X-Forwarded-for $remote_addr'</span></span> - <span class="hljs-string"><span class="hljs-string">'Host kicker-dev.semrush.com'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">location_cfg_append:</span></span> <span class="hljs-string"><span class="hljs-string">'proxy_next_upstream'</span></span>: <span class="hljs-string"><span class="hljs-string">'error timeout invalid_header http_500 http_502 http_503 http_504'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">proxy_connect_timeout:</span></span> <span class="hljs-string"><span class="hljs-string">'5'</span></span></code> </pre> <br><p>  Anda tidak perlu lagi menentukan kelas, itu diwarisi dari tingkat hierarki sebelumnya.  Di sini kami telah mengubah <code>proxy_pass</code> dan <code>proxy_pass</code> .  Server yang memiliki peran fakta = frontend dan tier = dev pertama-tama akan menemukan file <strong><code>projects/kicker/frontend.yaml</code></strong> untuk dirinya sendiri, tetapi kemudian variabel dari file ini akan ditimpa oleh file <strong><code>projects/kicker/tiers/dev/frontend.yaml</code></strong> dengan prioritas yang lebih tinggi . </p><br><h4 id="sokrytie-parolya-dlya-postgresql">  Bersembunyi kata sandi untuk PostgreSQL </h4><br><p>  Jadi kami memiliki item terakhir dalam agenda - setel kata sandi untuk PostgreSQL. </p><br><p>  Kata sandi harus bervariasi di lingkungan.  Kami akan menggunakan eyaml untuk menyimpan kata sandi dengan aman.  Buat kata sandi: </p><br><pre> <code class="bash hljs">eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'verysecretpassword'</span></span> eyaml encrypt -s <span class="hljs-string"><span class="hljs-string">'testpassword'</span></span></code> </pre> <br><p>  Kami menempelkan baris yang dihasilkan ke file <code>**projects/kicker/tiers/prod/db.yaml**</code> dan <code>**projects/kicker/tiers/dev/db.yaml**</code> (atau Anda dapat menggunakan ekstensi eyaml, ini dapat disesuaikan), masing-masing.  Berikut ini sebuah contoh: </p><br><pre> <code class="hljs ruby">--- profiles::db::postgresql::<span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">'kicker'</span></span>: <span class="hljs-symbol"><span class="hljs-symbol">password_hash:</span></span> &gt; <span class="hljs-string"><span class="hljs-string">'ENC[PKCS7,MIIBeQYJKoZIhvcNAQcDoIIBajCCAWYCAQAxggEhMIIBHQIBADAFMAACAQEwDQYJKoZIhvcNAQEBBQAEggEAsdpb2P0axUJzyWr2duRKAjh0WooGYUmoQ5gw0nO9Ym5ftv6uZXv25DRMKh7vsbzrrOR5/lLesx/pAVmcs2qbhd/y0Vr1oc2ohHlZBBKtCSEYwem5VN+kTMhWPvlt93x/S9ERoBp8LrrsIvicSYZByNfpS2DXCFbogSXCfEPxTTmCOtlOnxdjidIc9Q1vfAXv7FRQanYIspr2UytScm56H/ueeAc/8RYK51/nXDMtdPOiAP5VARioUKyTDSk8FqNvdUZRqA3cl+hA+xD5PiBHn5T09pnH8HyE/39q09gE0pXRe5+mOnU/4qfqFPc/EvAgAq5mVawlCR6c/cCKln5wJTA8BgkqhkiG9w0BBwEwHQYJYIZIAWUDBAEqBBDNKijGHBLPCth0sfwAjfl/gBAaPsfvzZQ/Umgjy1n+im0s]'</span></span></code> </pre> <br><p>  Selanjutnya, kata sandi untuk peran <code>kicker</code> akan datang, didekripsi dan diterapkan pada server database di PostgreSQL. </p><br><p>  Faktanya, itu saja.  Ya, contohnya ternyata sangat besar, tapi, saya harap, fungsional, tidak meninggalkan pertanyaan, jelas dan bermanfaat.  Hierarki yang dihasilkan dalam hiera adalah ini: </p><br><pre> <code class="bash hljs">. ├── db.yaml ├── docker.yaml ├── frontend.yaml └── tiers ├── dev │ ├── db.yaml │ └── frontend.yaml ├── prod │ └── db.yaml └── prod.yaml 3 directories, 7 files</code> </pre> <br><p>  Anda dapat menonton file-file ini secara langsung dengan mengkloning <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori yang</a> dibuat khusus </p><br><h3 id="zaklyuchenie">  Kesimpulan </h3><br><p>  Wayang bagus dan mudah digunakan dengan hiera.  Saya tidak akan menyebutnya sebagai alat konfigurasi yang ideal di dunia modern, tidak sama sekali, tetapi layak mendapat perhatian.  Dia mengatasi beberapa tugas dengan sangat baik, dan "filosofi" mempertahankan kondisi sumber daya dan konfigurasi yang selalu identik dapat memainkan peran penting dalam memastikan keamanan dan keseragaman konfigurasi. </p><br><p>  Dunia modern secara bertahap bersinergi dan berkembang.  Hanya sedikit orang yang sekarang hanya menggunakan satu sistem konfigurasi, sering kali di gudang para devops dan admin ada beberapa sistem sekaligus.  Dan ini bagus, karena ada banyak pilihan.  Hal utama adalah bahwa semuanya harus logis dan dapat dimengerti, bagaimana dan di mana itu dapat dikonfigurasi. </p><br><p>  Akibatnya, tujuan kami sebagai administrator adalah mengkonfigurasi sendiri tidak ada.  Semua ini idealnya dilakukan oleh tim sendiri.  Dan kita harus memberi mereka alat atau produk yang memungkinkan kita melakukan ini dengan aman, mudah, dan yang paling penting, dengan hasil yang akurat.  Nah, dan bantu selesaikan masalah arsitektural dan yang lebih serius daripada "Anda harus menginstal PostgreSQL di server dan membuat pengguna."  Camon, 2018 ada di halaman! <del>  Jadi melempar boneka dan memungkinkan dan pindah ke masa depan tanpa server. </del></p><br><p>  Dengan pengembangan cloud, containerisasi, dan sistem orkestrasi kontainer, sistem manajemen konfigurasi perlahan-lahan surut ke latar belakang untuk pengguna dan pelanggan.  Anda juga dapat menaikkan sekelompok gagal-wadah yang aman di cloud dan menyimpan aplikasi Anda dalam wadah dengan skelling otomatis, cadangan, replikasi, penemuan otomatis, dll., Tanpa menulis satu baris pun untuk boneka, boneka, koki dll.  Anda tidak perlu mengurus apa pun (well, hampir).  Di sisi lain, ada lebih sedikit server besi karena awan.  Hanya saja Anda tidak perlu lagi mengonfigurasinya, tindakan ini adalah tanggung jawab penyedia cloud.  Tetapi mereka tidak mungkin menggunakan sistem yang sama dengan manusia biasa. </p><br><h4 id="credits">  Kredit </h4><br><p>  Terima kasih: </p><br><ul><li>  Dmitry Tupitsin, Dmitry Loginov, Stepan Fedorov dan seluruh tim administrator sistem atas bantuan mereka dalam mempersiapkan artikel ini </li><li>  Vladimir Legkostupov untuk gambar </li><li>  Yana Tabakova untuk mengatur semua ini dan membantu untuk melewati semua tahap pra-penerbitan </li><li>  Nikita Zakharov untuk bantuan dalam masalah perizinan </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id412587/">https://habr.com/ru/post/id412587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id412573/index.html">Apa yang salah dengan Geektimes kembali ke Habr</a></li>
<li><a href="../id412575/index.html">Setiap tahun, musik pop menjadi semakin monoton, karena orang yang sama mengarangnya</a></li>
<li><a href="../id412579/index.html">Marvel: Infinity War atau Cara mengumpulkan data untuk proyek Anda dalam beberapa menit</a></li>
<li><a href="../id412581/index.html">Dari Zaman Batu ke Perang Dunia II: bagaimana robot digunakan untuk meneliti artefak sejarah</a></li>
<li><a href="../id412583/index.html">Kami membongkar protokol ketel Redmond G200S dan menghubungkannya ke HomeAssistant</a></li>
<li><a href="../id412589/index.html">25 perpustakaan Android menghibur. Musim Semi 2018</a></li>
<li><a href="../id412591/index.html">Membangun jetpack: 29 Mei adalah Hari Peringatan Wendell Moore</a></li>
<li><a href="../id412593/index.html">Produk Baru, Platform, dan All-as-a-Service: HPE Webinar</a></li>
<li><a href="../id412595/index.html">Laporan Club of Rome 2018, Bab 1.1.2: “Pembiayaan”</a></li>
<li><a href="../id412597/index.html">Jeff Bezos akan membangun koloni di permukaan bulan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>