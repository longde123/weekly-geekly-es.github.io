<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîû ‚òéÔ∏è üëàüèª Modelos personalizados no GTM: um exemplo üß• ü•Ñ ‚ô¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No final de maio, o Google introduziu um novo recurso no Gerenciador de tags do Google (GTM): modelos personalizados ou modelos personalizados. Vamos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modelos personalizados no GTM: um exemplo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458788/">  No final de maio, o Google introduziu um novo recurso no Gerenciador de tags do Google (GTM): modelos personalizados ou modelos personalizados.  Vamos ver por que √© necess√°rio, como us√°-lo, quais s√£o as diferen√ßas entre tags HTML e vari√°veis ‚Äã‚ÄãJavaScript. <br><br>  Como exemplo, considere criar um modelo personalizado para um pixel de redirecionamento din√¢mico do VKontakte e personalizar ainda mais as tags GTM por meio dele. <br><br><img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Palavras simples sobre modelos personalizados</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Criando um modelo personalizado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ guia Informa√ß√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ guia Campos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ guia C√≥digo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ guia Permiss√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Personaliza√ß√£o e teste da tag no modelo personalizado criado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ Visualiza√ß√£o de p√°gina</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ AddToCart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Ä¢ teste de minera√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o</a> <br><br><a name="1"></a><h2>  Palavras simples sobre modelos personalizados </h2><br>  Modelos personalizados s√£o modelos pelos quais os usu√°rios podem criar novas tags ou vari√°veis.  O GTM possui modelos prontos (na se√ß√£o Em destaque ou Recomendado), por exemplo, a tag do Google Analytics, o Google Optimize e outros.  Agora podemos complement√°-los com nossos modelos.  Depois de criados, eles aparecer√£o na guia Personalizado: <br><br><img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br><br>  A principal diferen√ßa das tags HTML e vari√°veis ‚Äã‚ÄãJS √© que, quando um usu√°rio cria uma tag ou vari√°vel usando um modelo pronto, ele n√£o interage com o c√≥digo JS. <br><br>  O c√≥digo para o modelo do usu√°rio √© escrito pelo desenvolvedor ou analista da Web no est√°gio de sua cria√ß√£o.  Em seguida, ao criar uma tag ou vari√°vel de acordo com um modelo de usu√°rio, toda a intera√ß√£o √© realizada atrav√©s da interface (que tamb√©m √© configurada ao criar um modelo de usu√°rio): <br><br><img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br><br>  Assim, em compara√ß√£o com a grava√ß√£o de uma tag HTML ou de uma vari√°vel JS, personalizar uma tag ou vari√°vel de acordo com um modelo de usu√°rio se torna uma ordem de magnitude mais f√°cil, pois isso n√£o requer conhecimentos e habilidades para trabalhar com JavaScript. <br><br>  Outra grande vantagem dos modelos personalizados √© que a probabilidade de "colocar" um site √© reduzida em uma ordem de magnitude devido a um erro no c√≥digo JS da tag. <br><br>  Em nosso exemplo, para configurar a tag de redirecionamento din√¢mico "VKontakte", voc√™ n√£o precisa mais entrar em contato com os desenvolvedores - tudo pode ser configurado de forma independente, at√© a transfer√™ncia de dados sobre mercadorias (com o com√©rcio eletr√¥nico avan√ßado do Google configurado no site), tendo apenas experi√™ncia com o GTM. <br><br><a name="2"></a><h2>  Criando um modelo personalizado </h2><br>  Como estamos criando um modelo de tag, precisamos ir para a se√ß√£o Modelos e clicar no bot√£o Novo na se√ß√£o Modelos de tags. <br><br><img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br><br>  Depois disso, o Editor de modelos √© aberto: <br><br><img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br><br>  No lado esquerdo do editor, h√° uma janela de configura√ß√µes, no lado direito, uma janela de visualiza√ß√£o e um console.  Existem quatro guias na janela de configura√ß√µes necess√°rias para criar e trabalhar com o modelo. <br><br><a name="3"></a><h3>  Guia Informa√ß√µes </h3><br>  As informa√ß√µes na tag s√£o preenchidas nesta guia: nome, descri√ß√£o, √≠cone.  Estas s√£o as informa√ß√µes que veremos ao criar uma nova tag na lista de modelos: <br><br><img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br><br>  Existem requisitos para o √≠cone de tag: formato PNG, JPEG ou GIF, uma resolu√ß√£o de pelo menos 64x64 pixels e um tamanho n√£o superior a 50 KB. <br><br><a name="4"></a><h3>  Guia Campos </h3><br>  Esta se√ß√£o cria a interface do nosso modelo.  A interface consiste em v√°rios campos e formul√°rios com os quais o usu√°rio interage no est√°gio de cria√ß√£o de uma nova tag ou vari√°vel. <br><br>  No futuro, as informa√ß√µes que o usu√°rio inseriu ao criar a tag usando a interface s√£o usadas no c√≥digo do modelo. <br><br>  Para adicionar um novo elemento, clique no bot√£o Adicionar campo.  A janela para selecionar o tipo de elemento √© exibida: <br><br><img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br><br>  O GTM permite selecionar os seguintes tipos de elementos de interface: <br><br><ul><li>  <b>caixa de texto</b> </li><li>  <b>menu suspenso</b> </li><li>  <b>caixa de sele√ß√£o</b> ; </li><li>  <b>interruptores</b> </li><li>  <b>tabela simples</b> , aqui voc√™ pode editar cada c√©lula. </li><li>  <b>tabela estendida</b> , voc√™ pode editar apenas uma linha; esse tipo de tabela √© conveniente para criar um dicion√°rio a partir de pares de valores-chave; </li><li>  <b>grupo de elementos</b> , permite agrupar v√°rios tipos em um grupo; </li><li>  <b>o atalho √©</b> usado para adicionar texto √† interface e n√£o requer que o usu√°rio insira nenhum dado. </li></ul><br>  Depois de adicionar um elemento, voc√™ precisa atribuir um nome amig√°vel, que ser√° usado no c√≥digo.  Esse √© um tipo de nome de vari√°vel - deve ser compreens√≠vel e revelar a ess√™ncia do elemento de interface criado.  Por exemplo, o nome "ID" n√£o significa nada espec√≠fico, mas o nome "pixelIDs" j√° mostra que os IDs de pixel inseridos pelo usu√°rio s√£o armazenados neste elemento: <br><br><img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br><br>  Em seguida, v√° para as configura√ß√µes de cada elemento e ative as propriedades necess√°rias. <br>  Em situa√ß√µes diferentes, s√£o necess√°rias propriedades diferentes do elemento da interface; portanto, por padr√£o, elas est√£o todas ocultas e precisamos ativar as que s√£o necess√°rias agora: <br><br><img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br><br>  Para diferentes tipos de elementos, as propriedades dispon√≠veis diferem, indicarei os mais usados, que s√£o quase todos os elementos: <br><br>  <b>1. Nome para exibi√ß√£o</b> .  Este √© o nome que o usu√°rio ver√° na interface ao criar a tag: <br><br><img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br><br>  <b>2. Exemplo de valor</b> .  Esta √© uma dica para o usu√°rio sobre quais valores inserir no campo: <br><br><img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br><br>  <b>3. Texto de ajuda</b> .  Este √© o texto que o usu√°rio ver√° se passar o mouse sobre o √≠cone de ajuda do elemento: <br><br><img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br><br>  <b>4. Regras para verifica√ß√£o de dados</b> .  Nesta propriedade, voc√™ pode definir determinadas regras para verificar os dados inseridos pelo usu√°rio no campo e, se necess√°rio, o texto de erro que aparece quando voc√™ tenta salvar uma tag com dados que n√£o passaram no teste. <br><br>  Por exemplo, voc√™ pode especificar que o campo deve ser preenchido.  O segundo exemplo: voc√™ precisa obter um endere√ßo de email do usu√°rio e verificar se os dados inseridos pelo usu√°rio devem corresponder √† express√£o regular <b>. * @. * \ .. *</b> . <br><br><img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br><br>  Para especificar o texto do erro que aparece se os dados inseridos n√£o cumprirem as regras de verifica√ß√£o, √© necess√°rio ativar as configura√ß√µes avan√ßadas da regra: <br><br><img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br><br><img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br><br>  Al√©m disso, nas configura√ß√µes avan√ßadas, voc√™ pode especificar as condi√ß√µes sob as quais essa regra √© ativada (o campo Ativar Condi√ß√£o). <br><br>  <b>5. Termos de inclus√£o</b> .  Essas s√£o as condi√ß√µes sob as quais o usu√°rio ter√° esse elemento de interface. <br><br>  Por exemplo, para n√£o sobrecarregar o modelo com elementos da interface, voc√™ pode fazer a apar√™ncia dos elementos necess√°rios quando a caixa de sele√ß√£o est√° marcada.  Ou seja, suponha que, se um usu√°rio deseja configurar a transfer√™ncia de dados do produto em um pixel (isso √© poss√≠vel com o site avan√ßado de com√©rcio eletr√¥nico do Google configurado no site), ele seleciona a caixa de sele√ß√£o "Usar o DataLayer para transferir dados do produto" e, depois de marcar a caixa, os elementos aparecem na interface da tag necess√°rio para configurar essa transfer√™ncia.  Se a caixa n√£o estiver marcada, n√£o h√° elementos na interface. <br><br><img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br><br>  Observo que aqui √© necess√°rio indicar o nome do elemento, que deve ser atribu√≠do a ele imediatamente ap√≥s a adi√ß√£o. <br><br>  √Ä medida que voc√™ adiciona configura√ß√µes e cria uma interface, todas as altera√ß√µes podem ser visualizadas e testadas imediatamente na janela de visualiza√ß√£o: <br><br><img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br><br><a name="5"></a><h3>  Guia C√≥digo </h3><br>  Essa guia √© um editor de c√≥digo. <br><br>  O c√≥digo de modelos personalizados do GTM √© gravado no JavaScript ES6 "simplificado" e executado em um ambiente isolado onde toda a comunica√ß√£o com dados globais (ou seja, diretamente com a p√°gina) √© feita por meio da API.  N√£o h√° objetos globais, como janela ou documento, respectivamente, os m√©todos usuais.  Por exemplo, construtores (novo Objeto e similares), setTimeout, parseInt, delete etc.  - tudo isso n√£o funcionar√° no modelo personalizado. <br><br>  Mas h√° uma API para tudo isso.  E, portanto, a cria√ß√£o de c√≥digo para o modelo personalizado deve come√ßar com o fato de definirmos as APIs que usaremos em nosso c√≥digo: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// API //     const copyFromWindow = require('copyFromWindow'); //     const setInWindow = require('setInWindow'); //      const injectScript = require('injectScript'); //    const callInWindow = require('callInWindow'); //  ,     ,    const makeTableMap = require('makeTableMap'); //   URL  const getUrl = require('getUrl'); //    const getQueryParameters = require('getQueryParameters'); //     const makeInteger = require('makeInteger'); //    const makeString = require('makeString'); //  setTimeout const callLater = require('callLater'); //  console.log const logToConsole = require('logToConsole');</span></span></code> </pre> <br>  Consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ajuda do desenvolvedor</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google para obter uma</a> lista completa de APIs com documenta√ß√£o detalhada. <br><br>  Vou mostrar exemplos de como trabalhar com a API: <br><div class="scrollable-table"><table><tbody><tr><th>  Descri√ß√£o da a√ß√£o </th><th>  Js cl√°ssico </th><th>  API de modelo personalizado </th></tr><tr><td>  Sa√≠da do console </td><td>  console.log ('Oi'); </td><td>  logToConsole ('Oi'); </td></tr><tr><td>  Definir temporizador </td><td>  setTimeout (fun√ß√£o, 100); </td><td>  callLater (fun√ß√£o); </td></tr><tr><td>  Converter em string </td><td>  String (1234); </td><td>  makeString (1234); </td></tr><tr><td>  Convers√£o para inteiro </td><td>  parseInt ('1234', 10); </td><td>  makeInteger ('1234'); </td></tr><tr><td>  Host da p√°gina </td><td>  window.location.hostname </td><td>  getUrl ('host'); </td></tr></tbody></table></div><br>  Como voc√™ pode ver na tabela de exemplo, ap√≥s definir a API, voc√™ deve us√°-la em vez das constru√ß√µes JS padr√£o. <br><br>  Ap√≥s definir a API, √© desej√°vel definir um objeto com as configura√ß√µes inseridas pelo usu√°rio.  Isso tamb√©m pode ser feito ap√≥s, por exemplo, durante o c√≥digo execut√°vel, solicitar os dados necess√°rios das configura√ß√µes do usu√°rio.  Mas se definirmos o objeto de configura√ß√µes desde o in√≠cio, o trabalho com o c√≥digo se tornar√° mais f√°cil e compreens√≠vel, pois todas as configura√ß√µes do usu√°rio s√£o armazenadas em um objeto separado. <br><br>  Para obter dados de um elemento da interface, voc√™ deve usar a constru√ß√£o de dados. <br><br>  {{nome do elemento}}: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    const settings = { //  event: data.event, //ID  () pixelIDs: data.pixelIDs, //ID - (  1 -) priceListId: data.priceListId, //   -? fewPriceLists: data.fewPriceLists, //ID - (    ) priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), //  ecommerce   ? ecommerceUse: data.ecommerceUse, // ecommerce   eventEcommerce: data.eventEcommerce, //     siteSearchQueryParam: data.siteSearchQueryParam };</span></span></code> </pre><br>  Nota: se voc√™ passar indefinido para o m√©todo makeTableMap, isso causar√° um erro de script; portanto, utilizo uma constru√ß√£o com um operador tern√°rio (um registro abreviado da constru√ß√£o if-else) para filtrar esses scripts. <br><br><div class="spoiler">  <b class="spoiler_title">Sobre o m√©todo makeTableMap.</b> <div class="spoiler_text">  Se a interface usar uma tabela estendida, os dados nela ser√£o armazenados neste formato: <br><br><pre> <code class="javascript hljs">[ <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>}, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span>} ]</code> </pre><br>  Ap√≥s o processamento com o m√©todo makeTableMap, os dados se tornam um objeto regular com pares de valores-chave: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'k1'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span> }</code> </pre><br></div></div><br>  Outro requisito para o c√≥digo de modelo personalizado: se a tag for executada com √™xito, voc√™ dever√° chamar o m√©todo data.gtmOnSuccess () e, em caso de erro, chamar o m√©todo data.gtmOnFailure (). <br><br>  Por exemplo, no meu c√≥digo, o m√©todo data.gtmOnSuccess () √© chamado ap√≥s o envio da solicita√ß√£o com √™xito e o m√©todo data.gtmOnFailure () √© chamado se o download falhar na p√°gina de script externa VK openapi.js. <br><br>  Depois de definir a API e definir o objeto com as configura√ß√µes, voc√™ pode come√ßar a escrever um algoritmo para calcular o pixel. <br><br>  A principal coisa a lembrar aqui √©: <br><br>  ‚Ä¢ Se voc√™ precisar obter uma vari√°vel global - use o m√©todo da API copyFromWindow. <br><br><pre> <code class="javascript hljs">copyFromWindow(<span class="hljs-string"><span class="hljs-string">'VK'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//VK -   ,    </span></span></code> </pre><br>  ‚Ä¢ Se voc√™ precisar definir uma vari√°vel global, usamos o m√©todo da API setInWindow. <br><br><pre> <code class="javascript hljs">setInWindow(<span class="hljs-string"><span class="hljs-string">'openapiInject'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//openapiInject -   ,    //1 - ,    .</span></span></code> </pre><br>  ‚Ä¢ Se voc√™ precisar executar uma fun√ß√£o global, usamos o m√©todo da API callInWindow. <br><br><pre> <code class="javascript hljs">callInWindow(<span class="hljs-string"><span class="hljs-string">'VK.Retargeting.Init'</span></span>, p); <span class="hljs-comment"><span class="hljs-comment">//VK.Retargeting.Init -   ,    //p - ,     </span></span></code> </pre><br>  ‚Ä¢ Se voc√™ precisar adicionar um script externo √† p√°gina - use o m√©todo da API injectScript. <br><br><pre> <code class="javascript hljs">injectScript(<span class="hljs-string"><span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span></span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string"><span class="hljs-string">'vkPixel'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,      //pixel.setVkAsyncInit() - ,        //data.gtmOnFailure - ,        //vkPixel -  ,  ,   URL  .    ,   JavaScript      </span></span></code> </pre><br>  ‚Ä¢ Se voc√™ precisar obter o URL (ou parte dele) - use o m√©todo da API getUrl. <br><br><pre> <code class="javascript hljs">getUrl(<span class="hljs-string"><span class="hljs-string">'host'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span></span></code> </pre><br>  Como escrevi acima, o Custom Template suporta JS ES6.  √â aconselh√°vel usar essa sintaxe, pois ela reduz o c√≥digo e o torna mais leg√≠vel, e o trabalho do JS √© mais previs√≠vel e semelhante a outras linguagens de programa√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Mais sobre sintaxe JS ES6</b> <div class="spoiler_text">  A principal coisa que √© desej√°vel usar √© as fun√ß√µes de seta e as declara√ß√µes de const e deixar vari√°veis ‚Äã‚Äãem vez de var. <br><br>  Uma vari√°vel declarada via const √© uma constante cujo valor n√£o pode ser alterado. <br><br>  Uma vari√°vel declarada atrav√©s de let difere de uma vari√°vel declarada atrav√©s de var da seguinte maneira: <br><br><ul><li>  let n√£o √© adicionado ao objeto de janela global; </li><li>  a visibilidade √© limitada ao bloco de declara√ß√£o; </li><li>  vari√°veis ‚Äã‚Äãdeclaradas via let n√£o podem ser declaradas novamente. </li></ul><br>  As fun√ß√µes de seta s√£o uma abrevia√ß√£o das fun√ß√µes usuais: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//1.   const func1 = function() { return 'test'; } //    const func1 = () =&gt; 'test'; //2.   const func2 = function(arg) { if (arg &gt; 0) return 'plus'; else return 'minus'; } //    const func2 = arg =&gt; { if (arg &gt; 0) return 'plus'; else return 'minus'; } //3.   const func3 = function(arg1, arg2){ if (arg1 &gt; arg2) return arg1; else return arg2; } //    const func3 = (arg1, arg2) =&gt; { if (arg1 &gt; arg2) return arg1; else return arg2; }</span></span></code> </pre><br></div></div><br>  Agora que entendemos como usar a API de modelo personalizado, podemos escrever o c√≥digo de opera√ß√£o da tag usando a sintaxe JavaScript ES6. <br><br>  Meu c√≥digo cont√©m m√©todos para iniciar um pixel, instalar o VK openapi.js, recuperar dados do produto do dataLayer (com o site de com√©rcio eletr√¥nico avan√ßado do Google configurado), processar esses dados para traz√™-los para o formato necess√°rio para o envio ao pixel de redirecionamento do VKontakte e o m√©todo de envio de eventos. <br><br>  O m√©todo de acionamento de pixel suporta tr√™s cen√°rios: <br><br><ol><li>  O pixel √© executado em uma p√°gina em que o openapi.js est√° ausente. </li><li>  O pixel √© executado na p√°gina em que existe o openapi.js, mas ainda n√£o foi carregado. </li><li>  O pixel √© iniciado na p√°gina com o openapi.js carregado. </li></ol><br><div class="spoiler">  <b class="spoiler_title">O c√≥digo completo do meu modelo GTM personalizado para o pixel de redirecionamento din√¢mico VKontakte</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//api const copyFromWindow = require('copyFromWindow'); const setInWindow = require('setInWindow'); const injectScript = require('injectScript'); const callInWindow = require('callInWindow'); const makeTableMap = require('makeTableMap'); const getUrl = require('getUrl'); const getQueryParameters = require('getQueryParameters'); const makeInteger = require('makeInteger'); const makeString = require('makeString'); const callLater = require('callLater'); //    const settings = { event: data.event, pixelIDs: data.pixelIDs, priceListId: data.priceListId, fewPriceLists: data.fewPriceLists, priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), ecommerceUse: data.ecommerceUse, eventEcommerce: data.eventEcommerce, siteSearchQueryParam: data.siteSearchQueryParam }; //       const pixel = { //    getPageHostname: () =&gt; getUrl('host'), //    VK getVK: () =&gt; copyFromWindow('VK'), //    VK setVkAsyncInit: () =&gt; { setInWindow('vkAsyncInit', pixel.sendEvent); }, //       getSiteSearchPhrase: () =&gt; { if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam); else return undefined; }, //      getEventParams: (products, currencyCode, revenue) =&gt; { let eventParamsClean= {}; let eventParams = { products: eventProducts.getProductParams(products), category_ids: eventProducts.getCategoryString(products), currency_code: currencyCode, total_price: eventProducts.getTotalPrice(products, revenue), search_string: pixel.getSiteSearchPhrase() }; if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products; if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids; if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code; if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price; if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string; return eventParamsClean; }, //  - getPriceListId: hostname =&gt; { if (settings.fewPriceLists) return settings.priceListIds[hostname]; else return settings.priceListId; }, //  openapi.js openapiInit: () =&gt; { injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit(), data.gtmOnFailure, 'vkPixel'); setInWindow('openapiInject', 1); }, //   sendEvent: () =&gt; { if (settings.event === 'hit') { settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.Hit'); }); } else { const pricelist = pixel.getPriceListId(pixel.getPageHostname()); const name = settings.event; let products = []; if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products; else products = undefined; const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined; const revenue = (settings.ecommerceUse &amp;&amp; name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined; const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined; settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams); }); }, //   start: () =&gt; { if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') !== 1) { pixel.openapiInit(); data.gtmOnSuccess(); } else if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') === 1) { if (pixel.count &lt; 50) { callLater(pixel.start); pixel.count++; } else return; } else { pixel.sendEvent(); data.gtmOnSuccess(); }, //   count: 0 }; //       const eventProducts = { //    products   getProductParams: products =&gt; { let arr = []; products.forEach(i =&gt; { let productParamsClean = {}; let productParams = { id: makeString(i.id), group_id: makeString(i.brand), price: makeInteger(i.price * 100) / 100 }; if (productParams.id !== 'undefined') productParamsClean.id = productParams.id; if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id; if (productParams.price !== 0) productParamsClean.price = productParams.price; arr.push(productParamsClean); }); return arr; }, //       'a,b,c'       getCategoryString: products =&gt; { let categoryId = ''; let check = []; products.forEach(i =&gt; { if(check.indexOf(i.category) === -1) { check.push(i.category); categoryId += ',' + i.category; }); return categoryId.slice(1); }, //     getTotalPrice: (products, revenue) =&gt; { let sumPrice = 0; if (revenue !== undefined ) return makeInteger(revenue * 100) / 100; else { products.forEach(i =&gt; { if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity); else sumPrice += makeInteger(i.price * 100) / 100; }); return sumPrice; }; //  pixel.start();</span></span></code> </pre> <br></div></div><br><a name="6"></a><h2>  Guia Permiss√µes </h2><br>  Depois de escrever o c√≥digo da tag, o est√°gio final permanece - para emitir permiss√µes para interagir com os dados globais da p√°gina.  Isso √© feito apenas na guia Permiss√µes. <br><br>  Como o c√≥digo √© executado em um ambiente isolado e a intera√ß√£o com dados globais ocorre por meio da API, para cada m√©todo da API (quando necess√°rio), precisamos especificar manualmente as permiss√µes para determinadas a√ß√µes. <br><br>  Isso √© feito para abordar o trabalho com os dados da p√°gina global da maneira mais cuidadosa poss√≠vel e, assim, minimizar as chances de "colocar" o site em erro no c√≥digo do nosso modelo. <br><br>  Para os m√©todos de API usados ‚Äã‚Äãno meu c√≥digo, tr√™s tipos de permiss√µes devem ser emitidos: <br><br><img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br><br>  <b>1. Acessa vari√°veis ‚Äã‚Äãglobais</b> - leia, escreva, execute o acesso a vari√°veis ‚Äã‚Äãglobais usadas em nosso c√≥digo.  As vari√°veis ‚Äã‚Äãdevem ser adicionadas manualmente e, para cada uma delas, indicar o que permitimos fazer. <br><br><img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br><br>  Por exemplo, a vari√°vel VK pode ser lida apenas, vkAsyncInit pode ser lida e redefinida e o m√©todo VK.Retargeting.Hit pode ser executado apenas. <br><br>  <b>2. L√™ URL</b> .  Aqui voc√™ deve especificar quais partes da URL podem receber.  Eu permito que qualquer parte do URL seja recebida: <br><br><img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br><br>  Mas se desejar, voc√™ pode especificar qualquer espec√≠fico: <br><br><img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br><br>  <b>3. Injeta scripts</b> .  Aqui √© necess√°rio registrar os endere√ßos dos quais voc√™ pode baixar scripts externos.  No meu c√≥digo, apenas um script com o VK openapi.js √© carregado, eu especifico seu endere√ßo: <br><br><img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br><br>  Isso √© tudo, a configura√ß√£o do modelo personalizado est√° conclu√≠da, voc√™ pode salvar o modelo e prosseguir para o teste. <br><br><a name="7"></a><h2>  Personaliza√ß√£o e teste da tag no modelo personalizado criado </h2><br>  Como exemplo, criaremos duas tags de redirecionamento din√¢mico ‚ÄúVKontakte‚Äù usando o modelo personalizado criado: visualiza√ß√£o de p√°gina e addToCart. <br><br><a name="8"></a><h3>  Visualiza√ß√£o de p√°gina </h3><br>  Iremos para o cont√™iner GTM necess√°rio, criaremos uma nova tag, selecionaremos o tipo de tag VK Pixel na se√ß√£o Personalizada: <br><br><img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br><br>  Preencha o nome da tag, selecione o evento a ser rastreado, selecione Hit (esta √© uma visualiza√ß√£o de p√°gina padr√£o), no campo "ID do pixel", indique o ID dos dois pixels para os quais os dados ser√£o enviados e defina o gatilho Todas as p√°ginas: <br><br><img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br><br>  Salve a tag criada. <br><br><a name="9"></a><h3>  AddToCart </h3><br>  Criar uma tag para um evento adicionando um produto ao carrinho ser√° um pouco mais complicado do que uma tag Hit. <br><br>  Primeiro, voc√™ precisa transferir as mercadorias que s√£o adicionadas √† cesta.  Como escrevi acima, isso √© poss√≠vel com o com√©rcio eletr√¥nico avan√ßado do Google configurado no site.  Nesse caso, os dados do produto s√£o obtidos do dataLayer. <br><br>  Para fazer isso, precisamos criar a vari√°vel dataLayer no GTM, que armazenar√° o objeto de com√©rcio eletr√¥nico para o evento addToCart.  As configura√ß√µes vari√°veis ‚Äã‚Äãs√£o assim: <br><br><img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br><br>  Em segundo lugar, voc√™ precisa criar um gatilho que ativar√° a tag quando o evento addToCart de com√©rcio eletr√¥nico ocorrer (o gatilho ativar√° a tag ao pressionar o dataLayer quando o evento addToCart ocorrer): <br><br><img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br><br>  Depois de criar uma vari√°vel com um objeto de com√©rcio eletr√¥nico e um gatilho, voc√™ pode come√ßar a criar a tag: <br><br><img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br><br>  Em ordem: <br><br><ol><li>  Como o evento rastreado, selecione Adicionar ao carrinho. </li><li>  N√≥s preenchemos o ID separado por v√≠rgula de dois pixels para os quais os dados devem ser transferidos. </li><li>  Marque a caixa de sele√ß√£o "Usar v√°rias listas de pre√ßos": para Moscou e S√£o Petersburgo, em nosso exemplo, √© necess√°rio usar diferentes listas de pre√ßos. </li><li>  Preencha a tabela com listas de pre√ßos. </li><li>  Marque a caixa de sele√ß√£o "Usar com√©rcio eletr√¥nico para transferir produtos e par√¢metros". </li><li>  No objeto de com√©rcio eletr√¥nico deste evento, especifique a vari√°vel criada anteriormente. </li><li>  N√≥s definimos o gatilho para o evento monitorado, neste caso - AddToCart. </li><li>  Salve. </li></ol><br><a name="10"></a><h3>  Teste de minera√ß√£o </h3><br>  Para verificar o funcionamento dos pixels do redirecionamento din√¢mico no VKontakte, voc√™ precisa ativar o modo Visualizar no GTM, v√° ao nosso site e abra a se√ß√£o Rede no console do navegador e digite 'rtrg' no campo Filtro: <br><img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br><br>  Depois disso, atualizamos a p√°gina e devemos ter duas solicita√ß√µes - o evento Hit enviado em dois pixels: <br><br><img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br><br>  Status 200 significa que as solicita√ß√µes s√£o enviadas e recebidas pelo servidor com sucesso. <br><br>  Tamb√©m na janela Preview GTM, vemos que nossa tag criada funcionou corretamente para o evento Page View. <br><br>  Para verificar o evento Adicionar ao carrinho, adicione o produto ao carrinho e, no console, temos mais duas solicita√ß√µes: <br><br><img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br><br>  Na janela Visualizar GTM, vemos que a segunda tag funcionou com sucesso.  Os dados do produto do dataLayer foram puxados e processados ‚Äã‚Äãcorretamente; a lista de pre√ßos correta tamb√©m foi substitu√≠da. <br><br>  Para o segundo host, a lista de pre√ßos tamb√©m √© substitu√≠da corretamente: <br><br><img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br><br>  Tags para outros eventos s√£o configuradas e verificadas da mesma maneira. <br><br><a name="11"></a><h2>  Conclus√£o </h2><br>  Modelos personalizados est√£o mudando o paradigma familiar do uso do GTM.  Todo mundo est√° acostumado a tags HTML e vari√°veis ‚Äã‚ÄãJS, mas agora existe uma √≥tima alternativa. <br><br>  Basta criar um modelo personalizado de alta qualidade uma vez e qualquer pessoa familiarizada com o GTM pode us√°-lo. <br><br>  Dada a capacidade de compartilhar os modelos criados, acho que eles devem ganhar popularidade entre os usu√°rios. <br><br>  Voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fazer o download do modelo de</a> pixel de redirecionamento din√¢mico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">personalizado do</a> VKontakte, que examinamos neste artigo. <br><br>  Para importar um modelo, voc√™ precisa criar um novo modelo personalizado e selecionar Importar no menu: <br><br><img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br><br>  <i>Material preparado por mim para ppc.world</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt458788/">https://habr.com/ru/post/pt458788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt458774/index.html">DBMS funcional</a></li>
<li><a href="../pt458778/index.html">Mecanismo de relat√≥rios do Satellite 6.5: o que e por qu√™</a></li>
<li><a href="../pt458782/index.html">Adapta√ß√£o de programas do ZX Spectrum ao TR-DOS por meios modernos. Parte 3</a></li>
<li><a href="../pt458784/index.html">Transmita projetos e bibliotecas do Altium Designer para o PADS Professional</a></li>
<li><a href="../pt458786/index.html">Os mantenedores de videogame mant√™m a cultura do jogo passo a passo</a></li>
<li><a href="../pt458790/index.html">Introdu√ß√£o ao CatBoost. Relat√≥rio Yandex</a></li>
<li><a href="../pt458792/index.html">Funcion√°rios ‚Äúqueimados‚Äù: existe uma sa√≠da?</a></li>
<li><a href="../pt458794/index.html">Reuni√£o de analistas de neg√≥cios na Redmadrobot 18 de julho</a></li>
<li><a href="../pt458796/index.html">Como preparar seu site para cargas de trabalho pesadas: 5 dicas pr√°ticas e ferramentas √∫teis</a></li>
<li><a href="../pt458798/index.html">Bot nutriente ou como eu quero pegar p√£o de instrutores de fitness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>