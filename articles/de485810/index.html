<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèΩ ü¶ó üëèüèΩ Elixir-Hooks zur Kompilierungszeit üé¥ üë®üèΩ‚Äç‚úàÔ∏è üëª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Elixir verf√ºgt √ºber eine ausgefeilte, sehr gut konzipierte Makro-Infrastruktur. Mit Chris McCords leichter Hand gibt es ein ungeschriebenes Gesetz in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Elixir-Hooks zur Kompilierungszeit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485810/"><p>  <em>Elixir</em> verf√ºgt √ºber eine ausgefeilte, sehr gut konzipierte Makro-Infrastruktur.  Mit Chris McCords leichter Hand gibt es ein ungeschriebenes Gesetz in der Community, das unweigerlich ausgesprochen wird, sobald es um Makros geht: "Die erste Regel f√ºr die Verwendung von Makros ist, dass Sie sie nicht verwenden sollten."  Manchmal mit einer subtilen Bemerkung in einer hellgrauen Schrift der vierten Gr√∂√üe: "Nur wenn Sie dies nicht vermeiden k√∂nnen und Sie sehr gut verstehen, was Sie tun und was Sie riskieren."  Dies liegt an der Tatsache, dass Makros Zugriff auf den gesamten <em>AST des</em> Moduls haben, in dem sie verwendet werden, und im Allgemeinen den resultierenden Code bis zur Unkenntlichkeit √§ndern k√∂nnen. </p><br><p> Grunds√§tzlich bin ich damit einverstanden, dass Sie keine Makros verwenden, um sich mit der Sprache vertraut zu machen.  Bisher k√∂nnen Sie nicht die Frage beantworten, ob dieser Code in der Kompilierungsphase oder zur Laufzeit ausgef√ºhrt wird, da Sie um drei Uhr morgens mit einem Kater geweckt werden.  <em>Elixir</em> ist eine kompilierte Sprache, und w√§hrend des Kompilierungsprozesses wird der Code der obersten Ebene ausgef√ºhrt, der Syntaxbaum wird vollst√§ndig erweitert, bis wir uns in einer Situation befinden, in der nichts mehr zu √∂ffnen ist, und dieses Ergebnis wird schlie√ülich in <em>BEAM</em> kompiliert.  Wenn der Compiler im Quellcode auf einen Makroaufruf st√∂√üt, macht er den <em>AST</em> daf√ºr vollst√§ndig <em>verf√ºgbar und stoppt anstelle des eigentlichen Aufrufs</em> .  Es ist unm√∂glich zu verstehen, es kann nur erinnert werden. </p><a name="habracut"></a><br><p>  Sobald wir uns jedoch in der Syntax frei f√ºhlen, werden wir unweigerlich die volle Leistungsf√§higkeit des Toolkits nutzen wollen.  hier ohne Makros - nirgendwo.  Die Hauptsache ist, es nicht zu missbrauchen.  Makros k√∂nnen die Menge des erforderlichen Kesselschild-Codes drastisch (auf negative Werte) reduzieren und bieten eine nat√ºrliche und sehr bequeme M√∂glichkeit, <em>AST</em> zu manipulieren.  <em>Phoenix</em> , <em>Ecto</em> und alle namhaften Bibliotheken verwenden sehr h√§ufig Makros. </p><br><p>  Das oben Gesagte gilt f√ºr alle universellen Bibliotheken / Pakete.  Nach meiner Erfahrung werden normale Projekte wahrscheinlich nicht als Makros oder in einem sehr begrenzten Anwendungsbereich ben√∂tigt.  Im Gegensatz dazu bestehen Bibliotheken h√§ufig aus Makros im Verh√§ltnis 80/20 zu normalem Code. </p><br><p>  Ich werde hier keinen Sandkasten einrichten und Makromuffins f√ºr diejenigen formen, die noch nicht genau wissen, was sie essen.  Wenn es interessant ist, von den Grundlagen zu lernen, zu verstehen, was es im Prinzip ist oder wie und warum sie in <em>Elixir</em> selbst verwendet werden, ist es am besten, diese Seite sofort zu schlie√üen und das brillante Buch <a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">Metaprogramming Elixir von</a> Chris McCord, dem Sch√∂pfer des <a href="https://phoenixframework.org/">Phoenix Framework, zu</a> lesen.  Ich m√∂chte nur einige Tricks demonstrieren, um ein bestehendes Makro-√ñkosystem besser zu machen. </p><br><hr><br><p>  Makros sind absichtlich schlecht dokumentiert.  Dieses Messer ist zu scharf, um f√ºr Kinder zu werben. </p><br><p> Es gibt zwei M√∂glichkeiten, Makros zu verwenden.  Am einfachsten ist es, wenn Sie den Compiler mithilfe der <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html%3F"><code>Kernel.SpecialForms.require/2</code></a> Direktive anweisen, dass dieses Modul Makros von einem anderen verwendet, und anschlie√üend das Makro selbst aufrufen (f√ºr Makros, die in demselben Modul definiert sind, <code>require</code> keine explizite <code>require</code> erforderlich).  In diesem Artikel interessieren wir uns f√ºr eine andere, kompliziertere Art und Weise.  Wenn die externen <code>use MyLib</code> , wird erwartet, dass unser <code>MyLib</code> Modul das Makro <code>__using__/1</code> implementiert, das der Compiler <code>use MyLib</code> wenn er <code>use MyLib</code> .  Syntaktischer Zucker, ja.  Konvention √ºber Konfiguration.  Die Eisenbahnlinie von Jose verlief nicht spurlos. </p><br><p>  <em>Achtung:</em> Wenn der obige Absatz Sie verwirrt und sich alles l√§cherlich anh√∂rt, h√∂ren Sie bitte auf, diesen Kaktus zu essen, und lesen Sie das oben erw√§hnte Buch anstelle meiner Shortbread-Notiz. </p><br><p>  <code>__using__/1</code> ein Argument, sodass der Bibliotheksbesitzer Benutzern erlauben kann, einige Parameter an das Argument zu √ºbergeben.  Hier ist ein Beispiel aus einem meiner internen Projekte, das einen Makroaufruf mit Parametern verwendet: </p><br><pre> <code class="ruby hljs">defmodule User <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use MyApp.ActiveRecord, <span class="hljs-symbol"><span class="hljs-symbol">repo:</span></span> MyApp.Repo, <span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> ~w<span class="hljs-params"><span class="hljs-params">|supervisor client subscriber|</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> ~w<span class="hljs-params"><span class="hljs-params">|setting companies|</span></span>a</code> </pre> <br><p>  Ein Argument vom Typ <code>keyword()</code> wird <code>MyApp.ActiveRecord.__using__/1</code> an <code>MyApp.ActiveRecord.__using__/1</code> und dort verwende ich es, um verschiedene Helfer f√ºr die Arbeit mit diesem Modell zu erstellen.  ( <em>Hinweis:</em> Dieser Code wurde lange Zeit getrunken, da <em>ActiveRecord</em> in jeder Hinsicht auf native <em>Ecto-</em> Aufrufe verliert.) </p><br><hr><br><p>  Manchmal m√∂chten wir die Verwendung von Makros auf eine Untergruppe von Modulen beschr√§nken (z. B. zulassen, dass sie nur in Strukturen verwendet werden).  Eine explizite √úberpr√ºfung innerhalb der <code>__using__/1</code> Implementierung wird nicht funktionieren, wie wir m√∂chten, da wir w√§hrend des Kompilierens des Moduls keinen Zugriff auf dessen <code>__ENV__</code> (und es w√§re - es war noch lange nicht abgeschlossen, als der Compiler auf einen Aufruf stie√ü) <code>__using__/1</code> Es ist ideal, diese Pr√ºfung nach Abschluss der Kompilierung durchzuf√ºhren. </p><br><p>  Kein Problem!  Es gibt zwei <a href="https://hexdocs.pm/elixir/Module.html">Modulattribute,</a> die genau das konfigurieren.  Willkommen bei uns, liebe <a href="https://hexdocs.pm/elixir/Module.html">R√ºckrufe bei der Kompilierungszeit</a> . </p><br><p>  Hier ist ein kurzer Auszug aus der Dokumentation. </p><br><blockquote>  <code>@after_compile</code> Callback wird sofort nach dem √úbersetzen des aktuellen Moduls aufgerufen. <br><br>  Akzeptiert ein Modul oder Tupel <code>{module, function_name}</code> .  Der R√ºckruf selbst muss zwei Argumente annehmen: die Modulumgebung und ihren Bytecode.  Wenn nur ein Modul als Argument √ºbergeben wird, wird davon ausgegangen, dass dieses Modul die Funktion <code>__after_compile__/2</code> exportiert. <br><br>  Zuerst registrierte R√ºckrufe werden zuletzt ausgef√ºhrt. <br><pre> <code class="plaintext hljs">defmodule MyModule do @after_compile __MODULE__ def __after_compile__(env, _bytecode) do IO.inspect env end end</code> </pre> <br></blockquote><p>  Ich empfehle <code>__after_compile__/2</code> direkt in den generierten Code <code>__after_compile__/2</code> , da dies zu Konflikten mit den Absichten der Endbenutzer f√ºhren kann (die m√∂glicherweise ihre eigenen Handler verwenden m√∂chten).  Definieren Sie eine Funktion irgendwo in Ihrer <code>MyLib.Helpers</code> oder so und √ºbergeben Sie das Tupel an <code>@after_compile</code> : </p><br><pre> <code class="ruby hljs">quote <span class="hljs-symbol"><span class="hljs-symbol">location:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:keep</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @after_compile({MyLib.Helpers, <span class="hljs-symbol"><span class="hljs-symbol">:after_mymodule_callback</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><hr><br><p>  Dieser Callback wird sofort nach dem Kompilieren des entsprechenden Moduls, das unsere Bibliothek verwendet, <code>__ENV__</code> und erh√§lt zwei Parameter: die <code>__ENV__</code> Struktur und den Bytecode des kompilierten Moduls.  Letzteres wird nur selten von Sterblichen benutzt;  Das erste bietet alles, was wir brauchen.  Das folgende Beispiel zeigt, wie ich mich <code>use Iteraptable</code> sch√ºtzen kann, <code>use Iteraptable</code> von Modulen <code>use Iteraptable</code> , die keine Strukturen implementieren.  Tats√§chlich ruft der Best√§tigungscode einfach vom __struct__- <code>__struct__</code> des kompilierten Moduls aus auf, und kitschige Delegierte von <em>Elixir haben das</em> Recht, eine Ausnahme mit Klartext auszul√∂sen, in der die Ursache des Problems erl√§utert wird: </p><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">struct_checker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(env, _bytecode)</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">do:</span></span> env.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.__struct_<span class="hljs-number"><span class="hljs-number">_</span></span></code> </pre> <br><p>  Der obige Code l√∂st eine Ausnahme aus, wenn das kompilierte Modul keine Struktur ist.  Nat√ºrlich kann der Best√§tigungscode viel komplizierter sein, aber die Hauptidee ist, ob <em>Ihr verwendetes Modul</em> etwas von dem Modul erwartet <em>, das es verwendet</em> .  In diesem <code>@after_compile</code> ist es sinnvoll, <code>@after_compile</code> nicht zu vergessen und von dort aus zu verfluchen, wenn nicht alle erforderlichen Bedingungen erf√ºllt sind.  Das Ausl√∂sen einer Ausnahme ist in diesem Fall etwas mehr als immer der richtige Ansatz, da dieser Code in der Kompilierungsphase ausgef√ºhrt wird. </p><br><hr><br><p>  Mit <code>@after_callback</code> ist eine lustige Geschichte verbunden, die vollst√§ndig erkl√§rt, warum ich <em>OSS</em> im Allgemeinen und <em>Elixir</em> im Besonderen liebe.  Vor ungef√§hr einem Jahr habe ich einen Fehler beim Kopieren und Einf√ºgen gemacht und irgendwo von <code>@after_callback</code> anstelle von <code>@before_callback</code> .  Der Unterschied zwischen ihnen ist wahrscheinlich offensichtlich: Der zweite wird <em>vor dem Kompilieren</em> aufgerufen, und von dort aus kann jeder den Syntaxbaum bis zur Unkenntlichkeit √§ndern.  Und ich - oh, wie - ich habe es ge√§ndert.  Dies f√ºhrte jedoch zu keinen Ergebnissen im kompilierten Code: Es √§nderte sich √ºberhaupt nicht.  Nach drei Tassen Kaffee bemerkte ich einen Tippfehler, der <code>after</code> vorherigen ersetzt wurde, und alles begann.  Aber die Frage qu√§lte mich: Warum hat der Compiler geschwiegen, wie ein Partisan?  Es stellte sich heraus, dass <code>Module.open?/1</code> von diesem R√ºckruf <code>Module.open?/1</code> zur√ºckgibt (was im Prinzip nicht weit von der Wahrheit entfernt ist - das Modul ist immer noch nicht geschlossen, der Zugriff auf seine Attribute ist nicht geschlossen, und viele Bibliotheken verwenden diesen undokumentierten Fehler). </p><br><p>  Nun, ich skizzierte einen Fix, schickte eine Pull-Anfrage an die Sprachenkruste (an den Compiler, wenn auch absolut streng) und weniger als einen Tag sp√§ter <a href="https://github.com/elixir-lang/elixir/pull/9278/files">landete er im Master</a> . </p><br><p>  So war es, als ich Benutzereinstellungen in <code>IO.inspect/2</code> ben√∂tigte und in einigen F√§llen.  Was w√ºrde passieren, wenn ich in Java darauf sto√üe?  - Es ist be√§ngstigend, sich das vorzustellen. </p><br><hr><br><p>  Hab ein sch√∂nes Makro! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de485810/">https://habr.com/ru/post/de485810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de485794/index.html">Entwickeln Sie auf .NET Core? Gehen wir zu Ubuntu, ich habe alles vorbereitet</a></li>
<li><a href="../de485796/index.html">L√∂se das Unl√∂sbare</a></li>
<li><a href="../de485800/index.html">Digitalisierung vs. Automatisierung</a></li>
<li><a href="../de485804/index.html">Und wieder k√∂nnen CAPTCHA oder Nginx auch sticken</a></li>
<li><a href="../de485806/index.html">Koronaviren: von SARS bis 2019-nCoV</a></li>
<li><a href="../de485812/index.html">7 Stufen der Evolutionstests in einem Unternehmen</a></li>
<li><a href="../de485820/index.html">Sehr angegriffene Person: Finden Sie heraus, wer das Hauptziel von Cyberkriminellen in Ihrem Unternehmen ist.</a></li>
<li><a href="../de485824/index.html">Wie man einen Bot macht, der ein Foto in einen Comic verwandelt. Teil drei. Kostenloses serverloses + GPU-Hosting-Modell</a></li>
<li><a href="../de485836/index.html">Schlie√üen Sie den iRig Pro ohne Kabelb√ºndel an</a></li>
<li><a href="../de485838/index.html">Kubernetes Bug Hunt offiziell er√∂ffnet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>