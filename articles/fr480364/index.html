<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÖ üôéüèº üë©üèΩ‚Äçüî¨ M√©taphysique de l'injection de d√©pendance üë´ üèØ ü§º</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'injection de d√©pendance est une technique couramment utilis√©e dans la programmation orient√©e objet con√ßue pour r√©duire la connectivit√© des composant...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M√©taphysique de l'injection de d√©pendance</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480364/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/bp/ha/dz/bphadz2idyr738uoocd_ykof4zm.png" alt="image"></div><br><br>  L'injection de d√©pendance est une technique couramment utilis√©e dans la programmation orient√©e objet con√ßue pour r√©duire la connectivit√© des composants.  Lorsqu'il est utilis√© correctement, en plus d'atteindre cet objectif, il peut apporter des qualit√©s vraiment magiques √† vos applications.  Comme toute magie, cette technique est per√ßue comme un ensemble de sorts et non comme un trait√© scientifique rigoureux.  Cela conduit √† une mauvaise interpr√©tation des ph√©nom√®nes et, par cons√©quent, √† une mauvaise utilisation des artefacts.  Dans mon mat√©riel d'auteur, je sugg√®re que le lecteur √©tape par √©tape, bri√®vement et essentiellement, emprunte le chemin logique des fondements appropri√©s de la conception orient√©e objet √† la magie m√™me de l'injection automatique de d√©pendances. <br><a name="habracut"></a><br>  Le mat√©riel est bas√© sur le d√©veloppement du <a href="https://github.com/cylon-v/hypo" rel="nofollow">conteneur Hypo IoC</a> , que j'ai mentionn√© dans un <a href="https://habr.com/ru/post/474504/">article pr√©c√©dent</a> .  Dans des exemples de code miniatures, j'utiliserai Ruby comme l'un des langages orient√©s objet les plus concis pour √©crire de courts exemples.  Cela ne devrait pas poser de probl√®mes aux d√©veloppeurs dans d'autres langues. <br><br><h2>  Niveau 1: Principe d'inversion de d√©pendance </h2><br>  Les d√©veloppeurs du paradigme orient√© objet sont quotidiennement confront√©s √† la cr√©ation d'objets qui, √† leur tour, peuvent d√©pendre d'autres objets.  Cela conduit √† un graphique de d√©pendance.  Supposons que nous ayons affaire √† un mod√®le objet de la forme: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ih/b7/vy/ihb7vyogm2d5rt-ugz_udhskzpy.png" alt="image"></div><br>  - un service de facturation (InvoiceProcessor) et un service de notification (NotificationService).  Le service de traitement des factures envoie des notifications lorsque certaines conditions sont remplies, nous sortirons cette logique du champ d'application.  En principe, ce mod√®le est d√©j√† bon en ce sens que les composants individuels sont responsables de diff√©rentes responsabilit√©s.  Le probl√®me r√©side dans la fa√ßon dont nous impl√©mentons ces d√©pendances.  Une erreur courante consiste √† initialiser une d√©pendance o√π cette d√©pendance est utilis√©e: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">process</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#      notificationService = NotificationService.new notificationService.notify(invoice.owner) end end</span></span></span></span></code> </pre> <br>  C'est une erreur compte tenu du fait que nous obtenons une connectivit√© √©lev√©e d'objets logiquement ind√©pendants (High Coupling).  Cela conduit √† une violation du principe de responsabilit√© unique - un objet d√©pendant, en plus de ses responsabilit√©s imm√©diates, doit initialiser ses d√©pendances;  et aussi ¬´conna√Ætre¬ª l'interface du constructeur de d√©pendances, ce qui conduira √† une raison suppl√©mentaire de changement ( <a href="https://blog.cleancoder.com/uncle-bob/2014/05/08/SingleReponsibilityPrinciple.html" rel="nofollow">¬´raison de changer¬ª, R. Martin</a> ).  Il est plus correct de passer ce type de d√©pendance, initialis√© en dehors de l'objet d√©pendant: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">process</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">owner</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotificationService</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoiceProcessor</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">)</span></span></code> </pre><br>  Cette approche est conforme au principe d'inversion de d√©pendance.  Nous transf√©rons maintenant un objet avec une interface d'envoi de messages - il n'est plus n√©cessaire que le service de facturation ¬´sache¬ª comment construire l'objet de service de notification.  Lors de l'√©criture de tests unitaires pour un service de traitement des factures, le d√©veloppeur n'a pas √† se demander comment remplacer l'impl√©mentation de l'interface du service de notification par un talon.  Dans les langues avec typage dynamique, telles que Ruby, vous pouvez remplacer tout objet r√©pondant √† la m√©thode de notification;  avec le typage statique, tel que C # / Java, vous pouvez utiliser l'interface INotificationService, pour laquelle il est facile de cr√©er un Mock.  La question de l'inversion de d√©pendance a √©t√© r√©v√©l√©e en d√©tail par Alexander Byndyu <a href="https://blog.byndyu.ru/2009/12/blog-post.html" rel="nofollow">dans un article</a> qui a r√©cemment c√©l√©br√© son 10e anniversaire! <br><br><h2>  Niveau 2: registre d'objets li√©s </h2><br>  L'utilisation du principe de l'inversion de d√©pendance ne semble pas une pratique compliqu√©e.  Mais au fil du temps, en raison d'une augmentation du nombre d'objets et de relations, de nouveaux d√©fis apparaissent.  NotificationService peut √™tre utilis√© par des services autres que InvoiceProcessor.  En outre, il peut lui-m√™me d√©pendre d'autres services qui, √† leur tour, d√©pendent de tiers, etc.  De plus, certains composants peuvent ne pas toujours √™tre utilis√©s en une seule copie.  La t√¢che principale est de trouver la r√©ponse √† la question - ¬´quand cr√©er des d√©pendances?¬ª. <br>  Pour r√©soudre ce probl√®me, vous pouvez essayer de cr√©er une solution bas√©e sur un tableau associatif de d√©pendances.  Un exemple d'interface de son travail pourrait ressembler √† ceci: <br><br><pre> <code class="ruby hljs">registry.add(InvoiceProcessor) .depends_on(NotificationService) registry.add(NotificationService) .depends_on(ServiceX) invoiceProcessor = registry.resolve(InvoiceProcessor) invoiceProcessor.process(invoice)</code> </pre><br>  Il n'est pas difficile √† mettre en ≈ìuvre dans la pratique: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rd/bj/v4/rdbjv49agcxw3fhhask4uv5ysew.png" alt="image"></div><br>  Chaque fois que container.resolve () est appel√©, nous nous tournons vers la fabrique, qui cr√©era des instances de d√©pendance, contournant r√©cursivement le graphe de d√©pendance d√©crit dans le registre.  Dans le cas de `container.resolve (InvoiceProcessor)`, ce qui suit sera ex√©cut√©: <br><br><ol><li>  factory.resolve (InvoiceProcessor) - l'usine demande les d√©pendances InvoiceProcessor dans le registre, re√ßoit un NotificationService, qui doit √©galement √™tre assembl√©. </li><li>  factory.resolve (NotificationService) - l'usine demande les d√©pendances NotificationService dans le registre, re√ßoit ServiceX, qui doit √©galement √™tre assembl√©. </li><li>  factory.resolve (ServiceX) - n'a pas de d√©pendances, cr√©ez, retournez sur la pile d'appels √† l'√©tape 1, obtenez un objet assembl√© de type InvoiceProcessor. </li></ol><br>  Chaque composant peut d√©pendre de plusieurs autres, donc la question √©vidente est "comment faire correspondre correctement les param√®tres du concepteur avec les instances de d√©pendance r√©sultantes?".  Un exemple: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notificationService</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paymentService</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end</span></span></span></span></code> </pre><br>  Dans les langues avec typage statique, le type de param√®tre peut servir de s√©lecteur: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(notificationService: NotificationService, paymentService: PaymentService) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br>  Dans Ruby, vous pouvez utiliser la convention - utilisez simplement le nom du type au format snake_case, ce sera le nom du param√®tre attendu. <br><br><h2>  Niveau 3: gestion de la dur√©e de vie des d√©pendances </h2><br>  Nous avons d√©j√† une bonne solution de gestion des d√©pendances.  Sa seule limitation est la n√©cessit√© de cr√©er une nouvelle instance de la d√©pendance √† chaque appel.  Mais que faire si nous ne pouvons pas cr√©er plus d'une instance d'un composant?  Par exemple, un pool de connexions √† la base de donn√©es.  Creusez plus profond√©ment et si nous devons fournir une dur√©e de vie contr√¥l√©e des d√©pendances?  Par exemple, fermez la connexion √† la base de donn√©es une fois la requ√™te HTTP termin√©e. <br>  Il devient √©vident que le candidat au remplacement dans la solution d'origine est InstanceFactory.  Graphique mis √† jour: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/ed/xl/hfedxlxxnqjmm22oevtbwqrle2k.png" alt="image"></div><br>  Et la solution logique est d'utiliser un ensemble de strat√©gies ( <a href="https://refactoring.guru/ru/design-patterns/strategy" rel="nofollow">Strat√©gie, GoF</a> ) pour obtenir des instances de composants.  Maintenant, nous ne cr√©ons pas toujours de nouvelles instances lorsque nous appelons Container :: resolver, il est donc appropri√© de renommer Factory en Resolver.  Veuillez noter que la m√©thode Container :: register a un nouveau param√®tre - life_time (lifetime).  Ce param√®tre est facultatif - par d√©faut, sa valeur est ¬´transitoire¬ª (transitoire), ce qui correspond au comportement pr√©c√©demment impl√©ment√©.  La strat√©gie de singleton est √©galement √©vidente - avec son utilisation, une seule instance du composant est cr√©√©e, qui sera renvoy√©e √† chaque fois. <br>  La port√©e est une strat√©gie l√©g√®rement plus complexe.  Au lieu de ¬´chemins transitoires¬ª et de ¬´solitaires¬ª, il est souvent n√©cessaire d'utiliser quelque chose entre les deux - un composant qui existe tout au long de la vie d'un autre composant.  Un exemple similaire peut √™tre un objet de demande d'application Web, qui est le contexte de l'existence d'objets tels que, par exemple, les param√®tres HTTP, la connexion √† la base de donn√©es, les agr√©gats de mod√®le.  Tout au long de la dur√©e de vie de la demande, nous collectons et utilisons ces d√©pendances, et apr√®s sa destruction, nous nous attendons √† ce que toutes soient √©galement d√©truites.  Pour impl√©menter une telle fonctionnalit√©, il sera n√©cessaire de d√©velopper une structure d'objet assez complexe et ferm√©e: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vd/97/hh/vd97hhi_p41keoxph7ku9sdxrdm.png" alt="image"></div><br>  Le diagramme montre un fragment refl√©tant les changements dans les classes Component et LifetimeStrategy dans le contexte de l'impl√©mentation de la dur√©e de vie Scoped.  Le r√©sultat a √©t√© une sorte de ¬´double pont¬ª (similaire au <a href="https://refactoring.guru/ru/design-patterns/bridge" rel="nofollow">Bridge,</a> mod√®le <a href="https://refactoring.guru/ru/design-patterns/bridge" rel="nofollow">GoF</a> ).  En utilisant les subtilit√©s des techniques d'h√©ritage et d'agr√©gation, Component devient le c≈ìur du conteneur.  Soit dit en passant, le diagramme a un h√©ritage multiple.  L√† o√π le langage de programmation et la conscience le permettent, vous pouvez le laisser ainsi.  Dans Ruby, j'utilise des impuret√©s, dans d'autres langues, vous pouvez remplacer l'h√©ritage par un autre pont: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ri/dj/h7/ridjh7shgaolxp_mxujgvkueta4.png" alt="image"></div><br>  Le diagramme de s√©quence montre le cycle de vie du composant de session, qui est li√© √† la dur√©e de vie du composant de demande: <br><br><img src="https://habrastorage.org/webt/-c/im/bt/-cimbtr3sktosriryzoyrtqxht4.png" alt="image"><br><br>  Comme vous pouvez le voir sur le diagramme, √† un certain moment, lorsque le composant de demande termine sa mission, la m√©thode de lib√©ration est appel√©e, ce qui lance le processus de destruction de la port√©e. <br><br><h2>  Niveau 4: Injection de d√©pendance </h2><br>  Jusqu'√† pr√©sent, j'ai expliqu√© comment d√©terminer le registre des d√©pendances, puis comment cr√©er et d√©truire des composants conform√©ment au graphique des relations form√©es.  Et √† quoi √ßa sert?  Supposons que nous l'utilisions dans le cadre de Ruby on Rails: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registry</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resolve</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceRepository</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_processor</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registry</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resolve</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceProcessor</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">find</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">]) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_processor</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Le code qui sera √©crit de cette fa√ßon ne sera pas plus lisible, testable ou flexible.  Nous ne pouvons pas ¬´forcer¬ª Rails √† injecter des d√©pendances de contr√¥leur via son constructeur, ce qui n'est pas fourni par le framework.  Mais, par exemple, dans ASP.NET MVC, cela est impl√©ment√© au niveau de base.  Pour tirer le meilleur parti de l'utilisation du m√©canisme de r√©solution automatique des d√©pendances, vous devez impl√©menter la technique d'inversion de contr√¥le (IoC, inversion de contr√¥le).  Il s'agit d'une approche dans laquelle la responsabilit√© de la r√©solution des d√©pendances d√©passe la port√©e du code d'application et incombe au cadre.  Prenons un exemple. <br>  Imaginez que nous concevons quelque chose comme Rails √† partir de z√©ro.  Nous impl√©mentons le sch√©ma suivant: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/bg/bh/y1bgbh_27yevoryv4ntb58nej9w.png" alt="image"></div><br>  L'application re√ßoit la demande, le routeur r√©cup√®re les param√®tres et demande au contr√¥leur appropri√© de traiter cette demande.  Un tel sch√©ma copie conditionnellement le comportement d'un framework web typique avec seulement une petite diff√©rence - le conteneur IoC est impliqu√© dans la cr√©ation et l'impl√©mentation de d√©pendances.  Mais ici, la question se pose, o√π est le conteneur lui-m√™me cr√©√©?  Afin de couvrir autant d'objets de la future application que possible, notre structure doit cr√©er un conteneur au tout d√©but de son fonctionnement.  De toute √©vidence, il n'y a pas de lieu plus appropri√© que l'application App Builder.  C'est √©galement l'endroit le plus appropri√© pour configurer toutes les d√©pendances: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#   - ,      . def initialize </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Container.new </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(Controller) .using_lifetime(:transient) # ,     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(InvoiceService) .using_lifetime(:singleton) # ,     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> .register(Router) .using_lifetime(:singleton) #  end #     -     , #      . def call(env) router = </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@container</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.resolve(Router) router.handle(env.path, env.method, env.params) end end</span></span></span></span></code> </pre><br>  Toute application poss√®de un point d'entr√©e, par exemple, la m√©thode principale.  Dans cet exemple, le point d'entr√©e est la m√©thode d'appel.  L'objectif de cette m√©thode est d'appeler le routeur pour traiter les requ√™tes entrantes.  Le point d'entr√©e devrait √™tre le seul endroit pour appeler directement le conteneur - √† partir de ce moment, le conteneur devrait passer par le bord du chemin, toute magie subs√©quente devrait se produire ¬´sous le capot¬ª.  L'impl√©mentation du contr√¥leur dans une telle architecture semble vraiment inhabituelle.  Malgr√© le fait que nous ne l'instancions pas explicitement, il a un constructeur avec des param√®tres: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#   . #    . def initialize(invoice_service) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@invoice</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_service = invoice_service end def create_invoice(params) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@invoice</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_service.create(params) end end</span></span></span></span></code> </pre><br>  L'environnement "comprend" comment cr√©er des instances de contr√¥leur.  Cela est possible gr√¢ce au m√©canisme d'injection de d√©pendances fourni par le conteneur IoC int√©gr√© au c≈ìur de l'application Web.  Dans le constructeur du contr√¥leur, vous pouvez d√©sormais r√©pertorier tout ce qui est n√©cessaire √† son fonctionnement.  L'essentiel est que les composants correspondants soient enregistr√©s dans le conteneur.  Passons maintenant √† l'impl√©mentation du routeur: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#         -  #      #     . def initialize(controller) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@controller</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = controller end def handle(path, method, params) #  ""- if path == '/invoices' &amp;&amp; method == 'POST' </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@controller</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.create(params) end end end</span></span></span></span></code> </pre><br>  Notez que le routeur d√©pend du contr√¥leur.  Si nous rappelons les param√®tres de d√©pendance, alors Controller est un composant de courte dur√©e et Router est un solitaire constant.  Comment est-ce possible?  La r√©ponse est que les composants ne sont pas des instances des classes correspondantes, car ils semblent externes.  En fait, ce sont des objets proxy ( <a href="https://refactoring.guru/ru/design-patterns/proxy" rel="nofollow">Proxy, GoF</a> ) avec l'instance de m√©thode d'usine ( <a href="https://refactoring.guru/ru/design-patterns/factory-method" rel="nofollow">Factory Method, GoF</a> );  ils retournent une instance du composant conform√©ment √† la strat√©gie assign√©e.  √âtant donn√© que le contr√¥leur est enregistr√© comme "transitoire", le routeur traitera toujours sa nouvelle instance lors de son acc√®s.  Le diagramme de s√©quence montre un m√©canisme approximatif de travail: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tl/ng/1y/tlng1yrikuvxkenacsx-gy0x7mu.png" alt="image"></div><br>  C'est-√†-dire  En plus de la gestion des d√©pendances, un bon framework bas√© sur un conteneur IoC prend √©galement la responsabilit√© de la bonne gestion des dur√©es de vie des composants. <br><br><h2>  Conclusion </h2><br>  La technique d'injection de d√©pendance peut avoir une impl√©mentation interne assez sophistiqu√©e.  C'est le prix du transfert de la complexit√© de la mise en ≈ìuvre d'applications flexibles au c≈ìur du cadre.  L'utilisateur de tels frameworks ne peut pas se soucier des aspects purement techniques, mais consacrer plus de temps au d√©veloppement confortable de la logique m√©tier des programmes d'application.  √Ä l'aide d'une impl√©mentation DI de haute qualit√©, un programmeur d'application √©crit initialement du code testable et bien pris en charge.  Un bon exemple de la mise en ≈ìuvre de l'injection de d√©pendance est le cadre <a href="https://github.com/cylon-v/dandy" rel="nofollow">Dandy</a> d√©crit dans mon article pr√©c√©dent <a href="https://habr.com/ru/post/474504/">Orthodox Backend</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480364/">https://habr.com/ru/post/fr480364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480352/index.html">Un g√©n√©ticien de Harvard d√©veloppe un prototype d'application de datation pour l'analyse d'ADN</a></li>
<li><a href="../fr480354/index.html">Premiers pas avec les m√©thodes de tableau JavaScript .map (), .filter () et .reduce ()</a></li>
<li><a href="../fr480356/index.html">Conseils Python utiles que vous n'avez pas rencontr√©s</a></li>
<li><a href="../fr480358/index.html">Le prix cach√© des biblioth√®ques CSS-in-JS dans les applications React</a></li>
<li><a href="../fr480362/index.html">Aventures d'hexafluorure d'uranium appauvri allemand en Russie. Partie 1. Histoire et technologies d'enrichissement</a></li>
<li><a href="../fr480368/index.html">Attraper les fuites de m√©moire en C / C ++</a></li>
<li><a href="../fr480370/index.html">Conf√©rence DEFCON 19. Les patrons aiment Excel, les pirates aussi</a></li>
<li><a href="../fr480374/index.html">Le DogBot de React Robotics poursuit sa r√©volution dans l'industrie de la construction</a></li>
<li><a href="../fr480376/index.html">Des jeux vid√©o aux messages secrets: discutez des ≈ìufs de P√¢ques dans les disques vinyle</a></li>
<li><a href="../fr480378/index.html">14 projets open source pour pomper les comp√©tences en science des donn√©es (facile, normal, difficile)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>