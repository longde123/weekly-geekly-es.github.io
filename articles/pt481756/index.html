<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úâÔ∏è üï∫ ü•† Como organizar DDoS para bons prop√≥sitos? üö£üèª üõ∑ üë®üèº‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antes do lan√ßamento de um novo servi√ßo, seria bom garantir que ele funcionasse de acordo com nossas expectativas e estivesse dispon√≠vel, independentem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como organizar DDoS para bons prop√≥sitos?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/481756/"><p><img src="https://habrastorage.org/webt/qa/gk/up/qagkupe_y5cx7thbrqpj4aynn1y.png" alt="imagem"></p><br><p>  Antes do lan√ßamento de um novo servi√ßo, seria bom garantir que ele funcionasse de acordo com nossas expectativas e estivesse dispon√≠vel, independentemente de quantos clientes o usassem ao mesmo tempo. </p><br><p>  E como esse servi√ßo reagir√° se um ataque DoS distribu√≠do for organizado contra ele?  O recurso est√° protegido contra poss√≠veis invasores? </p><br><p>  Para avaliar poss√≠veis riscos e aumentar a seguran√ßa, faz sentido executar a√ß√µes de forma independente, simulando um ataque DDoS enquanto o recurso ainda n√£o foi lan√ßado para uso em massa. </p><br><p>  Neste artigo, falaremos sobre a experi√™ncia de organizar o teste de carga para servi√ßos DNS e HTTP. </p><a name="habracut"></a><br><h1>  Prepara√ß√£o </h1><br><p>  Para provocar a gera√ß√£o de uma enorme quantidade de tr√°fego de rede no recurso monitorado, voc√™ precisa usar muitas m√°quinas virtuais, cada uma das quais enviar√° o n√∫mero m√°ximo de solicita√ß√µes ao servi√ßo.  Se voc√™ n√£o possui um data center poderoso, faz sentido alugar temporariamente m√°quinas virtuais em uma nuvem.  Essa ideia tem um recurso: voc√™ precisa garantir que a nuvem n√£o rastreie, levando sua atividade para as a√ß√µes de um invasor. </p><br><p>  Comparando as pol√≠ticas de v√°rios servi√ßos em nuvem (algu√©m bane impiedosamente a conta com a qual, presumivelmente, foram realizadas as a√ß√µes que levaram √† falha do recurso) em rela√ß√£o √† realiza√ß√£o de testes de carga usando sua funcionalidade, decidimos parar no <a href="https://aws.amazon.com/">Amazon Web Services</a> (AWS).  Seus <a href="https://aws.amazon.com/ru/ec2/testing/">documentos</a> indicam que a AWS permite o teste de carga, mas solicita aprova√ß√£o enviando um email para um endere√ßo espec√≠fico. </p><br><h1>  Harmoniza√ß√£o dos testes de estresse </h1><br><p>  Enviamos uma mensagem onde falamos brevemente sobre nossas inten√ß√µes e recebemos um formul√°rio que deve ser preenchido: </p><br><pre><code class="plaintext hljs">Customer ID: Customer Name: Email Address: AWS Account ID load test will be performed from: Does the customer have an NDA? Target Data EC2 Resources: Cloudfront Distribution: API Gateway / Lambda ID: ELB Names: Non-AWS Target: Region (please list all regions in scope for testing): Source Data: IP Addresses: Source Account ID: Regions involved: Testing Parameters: How much traffic do you plan to generate by region during testing? What is your expected peak load from source by region? (ie xx Gbps) What is your expected peak load at destination? (ie xx Gbps) Are you testing traffic outbound from EC2, inbound into EC2, or both? Are you testing traffic outbound (egress) from EC2, inbound (ingress) into EC2, or both: Egress. What is your expected peak load from source by region? (ie xx Gbps) Ingress. What is your expected peak load from source by region? (ie xx Gbps) Start Date: End Date: Finite testing details including timeline of testing: Summary of Test: Testing Timelines by phase including rps, pps, and Gbps: Peak bandwidth for each source IP: Tools Used for each phase of test: Types of testing to be performed for each phase of the request: What criteria/metrics will you monitor to ensure the success of this test? Who is performing the Load Test? (Please provide contact details): Does the tester have an NDA? Testing Security Do you have a way to monitor the data traffic for the duration of the test to verify bandwidth limits do not exceed approved rates? Do you have a way to immediately stop the traffic if we/you discover any issue? 2 Emergency contact names and phone numbers:</code> </pre> <br><p>  Existem v√°rias nuances: </p><br><ol><li><p>  Eles nos perguntam quem vamos "curtir".  Temos direito a isso?  Dizemos que esse √© o nosso recurso (aparentemente, ningu√©m verifica se √© assim) e que o teste √© totalmente consistente. </p><br></li><li><p>  Precisamos designar quanto tr√°fego criaremos em cada uma das regi√µes.  Durante a correspond√™ncia, descobrimos que cada regi√£o tem seu pr√≥prio limite na quantidade de tr√°fego da rede.  No total, eles podem solicitar 645 Gb / s.  Consideramos quanto √© necess√°rio para o ataque e selecionamos as regi√µes de maneira a obter o valor necess√°rio. </p><br></li><li><p>  √â necess√°rio descrever a que horas o ataque ser√° realizado, quanto tempo durar√° e como seu poder aumentar√°.  De forma livre, mas com detalhes suficientes, falamos sobre nossos planos.  O ataque √© realizado com um aumento gradual de energia; portanto, pintamos quais est√°gios os testes ter√£o e qual a pot√™ncia m√°xima esperada para cada um deles.  A data do ataque pode ser omitida por at√© um dia; √© bem poss√≠vel indicar um intervalo de duas a tr√™s semanas. </p><br></li><li><p>  E, sem falhas, estamos fazendo o poss√≠vel para garantir que nos comportemos bem, monitoremos cuidadosamente o progresso dos testes e paremos na primeira solicita√ß√£o, se necess√°rio. </p><br></li></ol><br><p>  Provavelmente, em resposta ao formul√°rio preenchido, eles solicitar√£o algum esclarecimento. Por isso, correspondemos e respondemos √†s perguntas at√© obtermos permiss√£o para testar. </p><br><p>  Demora cerca de tr√™s dias √∫teis para concluir o processo de aprova√ß√£o, se respondido prontamente. </p><br><h1>  Prepara√ß√£o de infraestrutura </h1><br><p>  Ap√≥s as aprova√ß√µes, somos confrontados com a necessidade de preparar a infraestrutura para testes.  O fato √© que, durante a verifica√ß√£o, precisaremos prontamente: </p><br><p>  Incluir uma inst√¢ncia; </p><br><p>  ‚Ä¢ iniciar um ataque de teste; </p><br><p>  ‚Ä¢ coletar estat√≠sticas sobre o progresso; </p><br><p>  ‚Ä¢ interrompa o ataque de teste; </p><br><p>  Mudar o endere√ßo IP; </p><br><p>  ‚Ä¢ desativar a inst√¢ncia. </p><br><h2>  Criar imagem de inst√¢ncia </h2><br><h3>  Selecione o tipo de inst√¢ncia </h3><br><p>  Primeiro, vamos criar uma imagem da AWS que conter√° as ferramentas e scripts necess√°rios para o gerenciamento.  O primeiro passo √© escolher qual inst√¢ncia alugar.  Estudamos as caracter√≠sticas de diferentes tipos de inst√¢ncias: analisamos o pre√ßo, a quantidade m√°xima de tr√°fego, a pot√™ncia da CPU (a √∫ltima √© importante, porque afinal o tr√°fego √© criado pelas capacidades do processador) e testamos o desempenho real e o n√∫mero m√°ximo de solicita√ß√µes.  De acordo com nossas estimativas, <code>t3.small</code> inst√¢ncias <code>t3.small</code> s√£o as mais convenientes para o teste, mas aqui todo mundo escolhe a seu gosto. </p><br><p>  Caracter√≠sticas de inst√¢ncias podem ser encontradas <a href="https://aws.amazon.com/ec2/instance-types/">aqui</a> .  Voc√™ tamb√©m pode selecionar e comparar inst√¢ncias <a href="https://www.ec2instances.info/">aqui</a> . </p><br><h3>  Solicita√ß√£o de limite </h3><br><p>  Voc√™ precisa pensar com anteced√™ncia sobre quantas inst√¢ncias participar√£o do teste.  O fato √© que a Amazon fornece para cada regi√£o seus limites no n√∫mero de inst√¢ncias.  Se voc√™ achar que precisar√° de mais inst√¢ncias do que o dispon√≠vel por padr√£o, solicite um aumento no limite o mais cedo poss√≠vel.  Para fazer isso, v√° para a se√ß√£o <a href="https://console.aws.amazon.com/support/cases">Suporte</a> , crie uma chamada do tipo Aumento do limite de servi√ßo.  O tempo de processamento de uma solicita√ß√£o pode ser diferente: algu√©m responde no dia seguinte, fornecendo quantas entidades forem solicitadas, algu√©m diz que n√£o permitir√° que mais de N inst√¢ncias sejam executadas.  Houve regi√µes que responderam √† solicita√ß√£o por cerca de um m√™s. </p><br><h3>  Ajuste de desempenho </h3><br><p>  Em seguida, voc√™ precisa criar uma imagem de inst√¢ncia que ser√° iniciada durante o teste.  Para fazer isso, ativamos a inst√¢ncia do tipo selecionado, definimos todas as configura√ß√µes e salve o que aconteceu como uma imagem (no menu A√ß√µes, onde voc√™ pode ativar a inst√¢ncia, bem como a funcionalidade para criar uma imagem Criar imagem). </p><br><p>  Precisamos obter o tr√°fego m√°ximo de sa√≠da de cada inst√¢ncia. Primeiro, otimizamos as configura√ß√µes de rede e mem√≥ria para nossa tarefa na inst√¢ncia. </p><br><p>  Para fazer isso, fa√ßa as configura√ß√µes no arquivo <code>/etc/sysctl.conf</code> : </p><br><p>  ‚Ä¢ Aumente o alcance das portas locais e reduza o tempo gasto pelos soquetes no estado FIN_WAIT: </p><br><pre> <code class="plaintext hljs">net.ipv4.ip_local_port_range = 1024-65535 ( : 32768-61000) net.ipv4.tcp_fin_timeout = 10 ( : 60)</code> </pre> <br><p>  O intervalo de portas locais determina o n√∫mero m√°ximo de soquetes de sa√≠da que um host pode criar a partir de um IP espec√≠fico. </p><br><p>  Com a configura√ß√£o padr√£o (61.000 a 32.768), s√£o obtidos 28.233 soquetes.  Com novas configura√ß√µes - 64 500. </p><br><p>  Fin_timeout define o tempo m√≠nimo em que os soquetes de sa√≠da podem estar no estado FIN_WAIT. </p><br><p>  Se valores padr√£o forem especificados, o sistema poder√° fornecer n√£o mais que (61.000‚Äì32.768) / 60 = 470 soquetes por segundo. </p><br><p>  Ao aumentar o intervalo de portas e diminuir o fin_timeout, podemos afetar a capacidade do sistema de gerar mais conex√µes de sa√≠da. </p><br><p>  ‚Ä¢ Vamos reutilizar soquetes no estado TIME_WAIT quando os livres terminam: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_tw_reuse = 1</code> </pre> <br><p>  A configura√ß√£o da op√ß√£o acima (que est√° desativada por padr√£o) ajuda a minimizar a perda de conex√µes "inativas" j√° preenchidas. </p><br><p>  Muito detalhado sobre TIME_WAIT est√° descrito neste <a href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">artigo</a> . </p><br><p>  ‚Ä¢ Ative a op√ß√£o tcp_timestamps para que a op√ß√£o tcp_tw_reuse acima funcione: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_timestamps = 1 ‚Äì   `tcp_timestamps`     tcp_tw_reuse</code> </pre> <br><p>  ‚Ä¢ Outras op√ß√µes: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_max_tw_buckets = 720000 ‚Äì       TIME_WAIT net.ipv4.tcp_keepalive_time = 600 ‚Äì  - keepalive- net.ipv4.tcp_keepalive_probes = 3 ‚Äì   keepalive- net.ipv4.tcp_keepalive_intvl = 10 ‚Äì     keepalive- net.ipv4.tcp_window_scaling = 1 ‚Äì   TCP- net.ipv4.tcp_mem = 8192 131072 196304 ‚Äì     TCP- net.ipv4.udp_mem = 8192 131072 196304 ‚Äì     udp- net.ipv4.tcp_slow_start_after_idle=0 ‚Äì  Slow-Start Restart net.core.wmem_default = 31457280 ‚Äì         net.core.wmem_max = 33554432 ‚Äì        net.core.somaxconn = 65535 ‚Äì        net.core.netdev_max_backlog = 65535 ‚Äì          vm.swappiness = 30 ‚Äì    vm.dirty_ratio = 50 ‚Äì     50 %  vm.pagecache = 90 ‚Äì    </code> </pre> <br><h3>  Testar scripts de ataque </h3><br><p>  <strong>1. ataque de DNS</strong> </p><br><p>  Uma das principais tarefas do teste √© avaliar o desempenho dos servidores DNS.  Ou seja, os servidores DNS podem se tornar o gargalo da toler√¢ncia a falhas de um site, porque mesmo se o servi√ßo mais est√°vel estiver indispon√≠vel, se houver problemas com o DNS.  Para criar uma carga nos servidores DNS, geraremos muitas consultas DNS diferentes.  As solicita√ß√µes devem ser v√°lidas e exigir a maior resposta poss√≠vel e mais longa do servidor DNS. </p><br><p>  O utilit√°rio <a href="https://www.dns-oarc.net/tools/dnsperf">DNSPerf</a> √© adequado para gerar esse tr√°fego. </p><br><p>  DNSPerf √© uma ferramenta de teste de desempenho DNS simples, flex√≠vel e gratuita.  Ele foi desenvolvido principalmente para servidores DNS autoritativos, mas tamb√©m pode ser usado para medir o desempenho de servidores de cache. </p><br><p>  No nosso caso, s√£o carregados servidores DNS autoritativos que atendem a uma zona - exemplo.com. </p><br><p>  Para DNSPerf, primeiro preparamos um arquivo com as solicita√ß√µes <code>dns_queries.txt</code> (principalmente QUALQUER para aumentar o tempo e o tamanho da resposta do servidor DNS): </p><br><pre> <code class="plaintext hljs">#dns_queries.txt example.com ANY www.example.com ANY test.example.com ANY static.example.com ANY example.com  www.example.com  test.example.com MX</code> </pre> <br><p>  Exemplo de execu√ß√£o do utilit√°rio: </p><br><pre> <code class="plaintext hljs">dnsperf -s TARGET_IP -d dns_queries.txt -c 100 -n 100 -s =  IP- -d =      .   ‚Äì stdin -c =   .         -n =  ¬´¬ª   .</code> </pre> <br><p>  <strong>2. Ataque ao ICMP</strong> </p><br><p>  O pr√≥ximo est√°gio do teste √© avaliar a resist√™ncia a um grande n√∫mero de tr√°fego ICMP.  Como, por raz√µes t√©cnicas, os servidores geralmente precisam responder a solicita√ß√µes de ping, existe a possibilidade de um ataque DDoS usando solicita√ß√µes de ping.  Al√©m de especificar configura√ß√µes que excluam a possibilidade de <code>ping-to-death</code> , voc√™ precisa garantir que os servidores sejam resistentes ao pico de cargas de ICMP.  Para criar essas cargas, √© melhor usar o conhecido utilit√°rio <a href="https://linux.die.net/man/8/hping3">hping3</a> , que permite ajustar o n√∫mero de solicita√ß√µes, o intervalo entre as remessas e o tamanho do pacote. </p><br><p>  Exemplo de execu√ß√£o do utilit√°rio: </p><br><pre> <code class="plaintext hljs">hping3 -i u1000 -d 1500 -c 100000 -1 TARGET_IP -i u100 =     (uX for X microseconds) -d 1500 =    -c 1000000 =     -1 =  ICMP</code> </pre> <br><p>  <strong>3. ataque HTTP</strong> </p><br><p>  Agora, verificamos quanto √† resist√™ncia ao estresse a principal funcionalidade do tr√°fego HTTP (S) de processamento de servi√ßo.  Uma das ferramentas mais flex√≠veis e f√°ceis de gerar tr√°fego HTTP √© o <a href="https://linux.die.net/man/1/siege">cerco</a> .  O Siege √© um utilit√°rio multithread de c√≥digo aberto desenvolvido para testar o desempenho de um recurso da Web. </p><br><p>  Como o DNSPerf, o cerco permite carregar o servidor com solicita√ß√µes de um determinado n√∫mero de usu√°rios virtuais (a emula√ß√£o de usu√°rio √© realizada usando uma porta separada), al√©m de usar um conjunto predefinido de solicita√ß√µes.  Isso √© muito conveniente, pois voc√™ pode incluir as consultas com mais recursos no teste. </p><br><p>  Exemplo de execu√ß√£o do utilit√°rio: </p><br><pre> <code class="plaintext hljs">siege -b -c 100 -f test_urls.txt -b =   ( benchmark) -c =   .         -f =   </code> </pre> <br><p>  Formato do conte√∫do <code>test_urls.txt</code> : </p><br><pre> <code class="plaintext hljs">http://example.com/site/login POST login=username&amp;password=test http://example.com/site/client POST useragent=Mozilla&amp;version=123&amp;date=24May http://example.com/site/order POST user=username&amp;company=ooo&amp;phone=812345678</code> </pre> <br><p>  Como voc√™ pode ver, os testes foram realizados usando principalmente solicita√ß√µes POST que requerem processamento no lado do servidor e ocupam o maior n√∫mero de recursos em compara√ß√£o com outros tipos de solicita√ß√µes. </p><br><p>  Nenhuma das op√ß√µes usa falsifica√ß√£o de IP, pois a Amazon n√£o permite isso.  Qualquer que seja o src_IP especificado no pacote, ele ser√° alterado para o correto ao sair da inst√¢ncia. </p><br><p>  Todas as solicita√ß√µes geradas devem ser leg√≠timas - nenhuma onda de tr√°fego de sa√≠da √© respondida -, pois a pol√≠tica DDoS da Amazon √© bastante rigorosa.  At√© um teste de estresse coordenado leva pelo menos alguns dias para se comunicar com o suporte t√©cnico e, durante as primeiras a√ß√µes "maliciosas", obtemos a proibi√ß√£o da porta da qual o tr√°fego saiu e o requisito a ser explicado imediatamente. </p><br><h3>  Scripts para iniciar ataques </h3><br><p>  Para o gerenciamento de teste remoto, prepararemos scripts bash (dns.sh, ping.sh, http.sh) que iniciam o tipo de ataque desejado e arquivos de carga √∫til (test_urls.txt, valid_dns_queries.txt). </p><br><p>  Quando fazemos upload de tudo isso para a imagem da AWS (a partir da qual todas as inst√¢ncias ser√£o criadas), cada teste pode ser executado remotamente usando o comando do seguinte formato: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo &lt;stress-script&gt;.sh start &lt;params&gt; &amp;&gt;&gt;stress.log &amp;'</code> </pre> <br><p>  O script do tipo requerido √© especificado como stress-script.sh, e params s√£o os par√¢metros correspondentes.  No arquivo stress.log, rastrearemos a sa√≠da do utilit√°rio em execu√ß√£o.  Por conveni√™ncia, usaremos diferentes logs para diferentes utilit√°rios: dns.log, ping.log, http.log. </p><br><p>  Exemplo de script <code>dns.sh</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [[ ! "$1" =~ ^(start|stop|status)$ ]]; then echo "nothing to do: need argument for stop,start or status" exit 1 fi if [[ "$1" = "start" ]]; then shift dnsperf $@ fi if [[ "$1" = "stop" ]]; then kill $(pidof dnsperf) fi if [[ "$1" = "status" ]]; then if [[ ! "$(pidof dnsperf)" = "" ]]; then echo "dnperf is running with PID $(pidof dnsperf)" ps aux | grep dnsperf else echo "dnsperf is not running" fi fi</span></span></code> </pre> <br><p>  Como pode ser visto no c√≥digo, o script pode ser iniciado e interrompido, al√©m de verificar o status (em execu√ß√£o / n√£o em execu√ß√£o). </p><br><p>  Os scripts para testes ICMP e HTTP s√£o constru√≠dos da mesma maneira, iniciando hping3 e siege, respectivamente, com a sequ√™ncia de par√¢metros passada pelo argumento. </p><br><p>  Exemplos de comandos: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo dns.sh start -s TARGET_IP -d valid_dns_queries.txt -c 1 -n 100 &amp;&gt;&gt;dns.log &amp;' ssh instance-amazon 'sudo ping.sh start -i u1000 -d 1500 -c 100000 -1 TARGET_IP &amp;&gt;&gt;ping.log &amp;' ssh instance-amazon 'sudo http.sh start -b -c 100 -f test_urls.txt &amp;&gt;&gt; http.log &amp;'</code> </pre> <br><h3>  Scripts de monitoramento </h3><br><p>  Para avaliar o tr√°fego de sa√≠da e o estado da infraestrutura de teste, precisamos de uma ferramenta de monitoramento.  Por raz√µes de simplicidade e economia de recursos, usamos iptables.  Para fazer isso, escreveremos um script que conte o n√∫mero de MBs enviados e o colocaremos na imagem da AWS: </p><br><pre> <code class="plaintext hljs">#iptables.sh sudo iptables -N TRAFFIC_OUT sudo iptables -A TRAFFIC_OUT -p tcp sudo iptables -A TRAFFIC_OUT -p udp sudo iptables -A TRAFFIC_OUT -p icmp sudo iptables -A OUTPUT -j TRAFFIC_OUT sudo iptables-save</code> </pre> <br><p>  O script cria uma nova cadeia TRAFFIC_OUT e adiciona filtros para os protocolos necess√°rios: tcp, udp, icmp. </p><br><p>  O encaminhamento de pacotes para TRAFFIC_OUT √© adicionado √† cadeia OUTPUT. </p><br><p>  A quantidade de dados transferidos pode ser encontrada pelo comando: </p><br><pre> <code class="plaintext hljs"># iptables -L TRAFFIC_OUT -v -n -x | tail -n 3 | awk '{print $2/1024/1024,"Mb\t\t\t",$3}' : 2.2 Mb tcp 4.4 Mb udp 3.2 Mb icmp</code> </pre> <br><p>  Instale o script como um servi√ßo.  Para fazer isso, crie um arquivo Monitoring.service e mova-o para o diret√≥rio <code>/etc/systemd/system</code> da nossa imagem: </p><br><pre> <code class="plaintext hljs"># /etc/systemd/system/monitoring.service [Unit] After=network.target [Service] ExecStart=/usr/local/bin/monitoring.sh [Install] WantedBy=default.target</code> </pre> <br><p>  Agora voc√™ pode adicionar o servi√ßo √† inicializa√ß√£o: </p><br><pre> <code class="plaintext hljs">systemctl enable monitoring.service systemctl start monitoring.service</code> </pre> <br><h2>  Gerenciamento de inst√¢ncia </h2><br><p>  Agora, vamos lidar com o gerenciamento de inst√¢ncias remotas (o mais automatizado poss√≠vel). </p><br><p>  Para esses fins, voc√™ pode usar o mecanismo da <a href="https://aws.amazon.com/ru/cli/">AWS CLI</a> - gerenciamento do console. </p><br><p>  Crie uma <a href="https://console.aws.amazon.com/iam/home%3Fnc2%3Dh_m_sc">chave secreta</a> (teclas de acesso (ID da chave de acesso e chave de acesso secreta)) e configure o console. </p><br><p>  Agora temos acesso a todos os recursos da conta. </p><br><p>  A peculiaridade de trabalhar com a AWS √© que todas as a√ß√µes s√£o executadas para uma regi√£o espec√≠fica e devem ser repetidas se v√°rias regi√µes estiverem envolvidas. </p><br><p>  Para criar uma nova inst√¢ncia a partir da imagem que criamos acima (presumimos que exista um ami-ID p√∫blico que usamos no script), faremos o seguinte: </p><br><ul><li>  crie uma chave SSH e adicione-a √† AWS: </li></ul><br><pre> <code class="bash hljs">yes n |ssh-keygen -q -t rsa -f <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> -m pem -N <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; /dev/null chmod 400 <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> aws ec2 import-key-pair --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --public-key-material file:///$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/<span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span>.pub</code> </pre> <br><ul><li>  crie um grupo de seguran√ßa que permita o acesso √† m√°quina via SSH.  Caso contr√°rio, as conex√µes SSH recebidas ser√£o negadas: </li></ul><br><pre> <code class="bash hljs">SECURITY=<span class="hljs-string"><span class="hljs-string">"ssh-group"</span></span> aws ec2 create-security-group --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --description <span class="hljs-string"><span class="hljs-string">"Just ssh. Nothing more"</span></span> IP_RANGE=<span class="hljs-string"><span class="hljs-string">"0.0.0.0/24"</span></span> aws ec2 authorize-security-group-ingress --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --protocol tcp --port 22 --cidr <span class="hljs-variable"><span class="hljs-variable">$IP_RANGE</span></span></code> </pre> <br><ul><li>  crie uma inst√¢ncia com a chave e o grupo de seguran√ßa criados anteriormente e especifique o ID da imagem.  O n√∫mero de inst√¢ncias criadas ao mesmo tempo pode ser arbitr√°rio: </li></ul><br><pre> <code class="bash hljs">IMG=<span class="hljs-string"><span class="hljs-string">'ami-0d0eaed20348a3389'</span></span> NUM=1 aws ec2 run-instances --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --image-id <span class="hljs-variable"><span class="hljs-variable">$IMG</span></span> --count <span class="hljs-variable"><span class="hljs-variable">$NUM</span></span> --instance-type t2.micro --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --security-groups default <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> &gt; instances.json</code> </pre> <br><ul><li>  aguarde at√© a m√°quina ser inicializada.  Isso leva algum tempo: primeiro obtemos uma resposta bem-sucedida (instance.json), mas naquele momento a m√°quina foi criada, mas ainda n√£o foi iniciada (por exemplo, ainda n√£o foi atribu√≠do um endere√ßo IP).  √â necess√°rio aguardar a conclus√£o do lan√ßamento (geralmente um minuto √© suficiente para isso). </li></ul><br><p>  Ent√£o voc√™ pode se conectar via SSH se soubermos o endere√ßo IP.  Basta solicitar uma lista de m√°quinas que est√£o em execu√ß√£o no momento.  Entre seus par√¢metros, encontramos PublicDnsName ou PublicIpAddress. </p><br><pre> <code class="bash hljs">aws ec2 describe-instances --region</code> </pre> <br><p>  Em seguida, executamos os comandos SSH, indicando a chave SSH criada acima: </p><br><pre> <code class="plaintext hljs">ssh -I $KEYNAME -oStrictHostKeyChecking=no ubuntu''+ins_dns echo''O''</code> </pre> <br><p>  Os comandos SSH permitem controlar o ataque e obter todas as informa√ß√µes sobre o estado do ataque, pois fornecemos √†s inst√¢ncias todos os scripts e ferramentas necess√°rios. </p><br><p>  Voc√™ precisa entender que a maioria das defesas contra ataques de nega√ß√£o de servi√ßo bloqueiam o endere√ßo IP do qual s√£o recebidas anormalmente muitas solicita√ß√µes.  Portanto, os endere√ßos IP das m√°quinas virtuais devem mudar constantemente para manter o poder de ataque. </p><br><p>  A AWS atribui um novo endere√ßo IP sempre que a m√°quina √© iniciada.  Portanto, para alterar o IP, √© necess√°rio desligar e ligar a m√°quina novamente (n√£o √© necess√°rio remov√™-la!). </p><br><p>  A diferen√ßa entre desligar e excluir √© que enviamos sinais diferentes.  Parar - para desligar, encerrar - para desligar e excluir imediatamente. </p><br><p>  Para monitorar o tr√°fego de entrada de uma inst√¢ncia, usamos o seguinte comando com o ID da inst√¢ncia: quando a medi√ß√£o de tr√°fego come√ßa, quando termina, por qual per√≠odo os valores s√£o somados: </p><br><pre> <code class="bash hljs">aws cloudwatch get-metric-statistics --region REGION --namespace AWS/EC2 \ --statistics Sum --metric-name NetworkIn --start-time <span class="hljs-variable"><span class="hljs-variable">$STARTTIME</span></span> --end-time <span class="hljs-variable"><span class="hljs-variable">$FINISHTIME</span></span> --period <span class="hljs-variable"><span class="hljs-variable">$PERIOD</span></span> --dimensions Name=InstanceId,Value=<span class="hljs-variable"><span class="hljs-variable">$INCTANCEID</span></span></code> </pre> <br><h1>  Monitoramento de disponibilidade de servi√ßo </h1><br><p>  Al√©m disso, para realizar um ataque, voc√™ precisar√° observar se o servi√ßo que estamos testando est√° ativo. </p><br><p>  Criamos e executamos o script "ping" mais simples que monitora a disponibilidade das portas de destino (53 e 80 no nosso caso). </p><br><p>  Exemplo de c√≥digo Python que automatiza a verifica√ß√£o de disponibilidade: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'-w'</span></span>, <span class="hljs-string"><span class="hljs-string">'"%{time_total}"'</span></span>, <span class="hljs-string"><span class="hljs-string">'-o'</span></span>, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, <span class="hljs-string"><span class="hljs-string">'-s'</span></span>, url] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = float(json.loads(result)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result * <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip, domain)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'dig'</span></span>, <span class="hljs-string"><span class="hljs-string">'any'</span></span>, <span class="hljs-string"><span class="hljs-string">'@'</span></span>+ip, domain ] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = int(result.split(<span class="hljs-string"><span class="hljs-string">'Query time:'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'msec'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p>  As informa√ß√µes recebidas s√£o armazenadas em um arquivo de log, com base no qual, com base nos resultados do ataque, ser√° poss√≠vel construir um gr√°fico da disponibilidade de recursos. </p><br><p>  Durante o teste, √© necess√°rio verificar constantemente o log ‚Äúping‚Äù para n√£o matar o recurso de forma completa e irrevog√°vel.  Assim que uma degrada√ß√£o significativa aparecer e a resposta √† solicita√ß√£o demorar muito, o ataque dever√° ser interrompido. </p><br><p>  Se a desacelera√ß√£o for insignificante e o poder de ataque atingir o m√°ximo estabelecido, faz sentido esperar um ou dois minutos e, se o servi√ßo continuar funcionando sem interrup√ß√µes, a verifica√ß√£o ser√° considerada bem-sucedida. </p><br><h1>  Quest√£o financeira </h1><br><p>  Vale a pena discutir outra quest√£o relacionada √† organiza√ß√£o dos testes - o custo de todo esse evento. </p><br><p>  A Amazon fornece informa√ß√µes detalhadas sobre pre√ßos, mas voc√™ precisa entender que precisa pagar por quase tudo.  No entanto, muitos c√°lculos podem ser negligenciados.  Antes de tudo, vale a pena calcular o custo do tr√°fego (depende da regi√£o e de quanto a quantidade total de informa√ß√µes ser√° transmitida) e o custo do aluguel de inst√¢ncias (pagamento por minuto).  Esses itens representam aproximadamente 99% do custo de todo o ataque. </p><br><p>  Portanto, o custo do ataque √© calculado em cada caso separadamente, dependendo do poder m√°ximo de ataque da [escala de hostilidades] e do n√∫mero de lan√ßamentos planejados. </p><br><p>  Do ponto de vista da simplifica√ß√£o dos c√°lculos, √© melhor usar uma conta da Amazon, registrada h√° mais de um ano.  Ent√£o parte das opera√ß√µes ser√° gratuita.  Leia mais sobre os limites de uso gratuito <a href="https://aws.amazon.com/ru/free/%3Fall-free-tier.sort-by%3Ditem.additionalFields.SortRank%26all-free-tier.sort-order%3Dasc">aqui</a> . </p><br><p>  Para ilustrar o c√°lculo do custo da realiza√ß√£o de testes de carga, digamos que queremos verificar a estabilidade do servidor DNS para uma carga de 10 Gb / s. </p><br><p>  Sabemos que as ferramentas usadas e os recursos da inst√¢ncia t3.small lan√ßada em Mumbai permitem emitir 500 Mb / s em uma inst√¢ncia em execu√ß√£o.  O pre√ßo para alugar uma entidade √© de US $ 0,0224 por hora, para tr√°fego - US $ 0,01093 por 1 GB.  Ou seja, o pico do ataque significa a opera√ß√£o simult√¢nea de 20 entidades. </p><br><p>  Aumentaremos o poder de ataque gradualmente; para isso, primeiro lan√ßamos uma entidade e depois adicionamos outra a cada 60 s. </p><br><p>  A f√≥rmula para calcular o custo assume a forma: </p><br><pre> <code class="plaintext hljs">60  * (   ) + 60  * 0,5 /c * (  ) =       60 . 1 * (    ) + 2 * (    ) + ... + 20 * (    ) =   </code> </pre> <br><p>  Acontece que o custo de um ataque com capacidade de 10 Gb / s para um servidor DNS √© de aproximadamente US $ 70.  Observe que essa √© uma estimativa aproximada, pois o volume de tr√°fego n√£o pode ser previsto com precis√£o.      <a href="https://aws.amazon.com/ru/ec2/pricing/on-demand/"></a> .  ,   ‚Äì    ,     . </p><br><p>       .          . </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481756/">https://habr.com/ru/post/pt481756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481746/index.html">Configurando o ambiente na CLI. Terminal WSL / Windows</a></li>
<li><a href="../pt481748/index.html">Pacote de benef√≠cios na Arm√™nia: do seguro e b√¥nus de refer√™ncia √† massagem e empr√©stimos</a></li>
<li><a href="../pt481750/index.html">Tarefa n√∫mero 3. Convers√£o e upload de dados para servi√ßos de terceiros</a></li>
<li><a href="../pt481752/index.html">Resultados da Pesquisa de Idiomas</a></li>
<li><a href="../pt481754/index.html">Me bot e meu furador</a></li>
<li><a href="../pt481758/index.html">Estat√≠sticas de constru√ß√£o, fornecimento e visitas ao ISS</a></li>
<li><a href="../pt481762/index.html">Equa√ß√µes para a cozinha debaixo da √°rvore de Natal</a></li>
<li><a href="../pt481764/index.html">Por que a energia verde tem um futuro dif√≠cil?</a></li>
<li><a href="../pt481768/index.html">Lidamos com o WebKit em 1C, por exemplo, a integra√ß√£o do TinyMCE em um formul√°rio gerenciado no UT 11.4</a></li>
<li><a href="../pt481770/index.html">Tony Brucker, pioneiro em programa√ß√£o de computadores, morre aos 94 anos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>