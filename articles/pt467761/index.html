<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥ üë©‚Äç‚ù§Ô∏è‚Äçüë© üë∏üèø Energia, calor e √°gua, parte tr√™s: v√° ao r√°dio ü§æüèæ üïê üëäüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entrada 
 No processo de escolha de solu√ß√µes para uma casa inteligente, tento ignorar solu√ß√µes in a box que exigem comunica√ß√£o com nuvens externas ou ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Energia, calor e √°gua, parte tr√™s: v√° ao r√°dio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467761/"><h2>  Entrada </h2><br>  No processo de escolha de solu√ß√µes para uma casa inteligente, tento ignorar solu√ß√µes in a box que exigem comunica√ß√£o com nuvens externas ou t√™m seus pr√≥prios aplicativos, especialmente solu√ß√µes sem a capacidade de conectar-se diretamente ao dispositivo.  Todas as m√©tricas dispon√≠veis s√£o reduzidas a uma interface - zabbix, onde um sistema de alerta de partes interessadas √© organizado.  Os bot√µes de controle s√£o implementados em uma interface da web localizada localmente. <br><br><h2>  Artigos anteriores: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte um</a> (temperatura de 1 fio, altos, medidor de √°gua ...) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte dois</a> (rede, gidrolock, sensores de press√£o ...) <br><br><h2>  Tarefas resolvidas neste artigo </h2><br><ul><li>  Prote√ß√£o escal√°vel e flex√≠vel contra vazamentos de √°gua com alerta zabbix </li><li>  Outros dispositivos a 433mhz: campainha, porta aberta, etc. </li><li>  Empurramos 1 fio no MQTT </li></ul><br><h2>  Sistema de prote√ß√£o contra vazamentos </h2><br><h3>  Exig√™ncias do sistema: </h3><br><ul><li>  muitos sensores espalhados pela casa (no meu caso - 6 pe√ßas em locais diferentes) </li><li>  sem fios nos sensores </li><li>  desligamento r√°pido ap√≥s a detec√ß√£o de vazamentos </li><li>  todas as informa√ß√µes de status atuais no zabbix.  Existe um alerta </li></ul><br><h3>  Composi√ß√£o do sistema </h3><br><ul><li>  PI de framboesa </li><li>  Sintonizador USB RTL2832U </li><li>  Sensores de vazamento 433mhz </li><li>  Rede + guindaste gidrolock (consulte o artigo anterior) para desligar o tronco </li></ul><a name="habracut"></a><br><h3>  Sobre ferro </h3><br>  Em um artigo anterior, descrevi a solu√ß√£o de desligar o suprimento de √°gua usando redes.  Eu tenho um sensor com fio para esta solu√ß√£o.  Isso √© conveniente se todos os pontos onde houver vazamento estiverem aproximadamente no mesmo local.  No meu caso, a rede √© instalada diretamente na entrada da rodovia e controla o guindaste eletro-mec√¢nico de gidrolock (veja o artigo anterior).  A dispers√£o de redes + gidrolock + sensor com fio em todos os pontos √© cara e complicada.  Al√©m disso, n√£o tenho mais a oportunidade de arrastar novos fios pela casa.  Ocupar tomadas e respirar guindastes el√©tricos √© uma solu√ß√£o mais ou menos.  A solu√ß√£o esperada - usamos a sobreposi√ß√£o da estrada comum com base nos sinais dos sensores de r√°dio espalhados pelos locais. <br>  Pelo que foi encontrado na Internet - um monte de sensores de r√°dio diferentes de sistemas prontos.  Alguns podem ser comprados separadamente, n√£o comprei controladores para sensores, para n√£o produzir elementos adicionais no circuito. <br><br>  Como posso capturar 433mhz?  Acontece - um sintonizador de TV em um chipset espec√≠fico.  E agora ele vale um centavo (eu assumi o Avito por 300r) assim: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b84/efb/7c8/b84efb7c88ad3e4a89edbb470a653843.png" alt="imagem"><br><br>  Encomendei uma antena separada para ele em 12dbi, porque a atual n√£o cobria toda a casa. <br><br>  Desde que tentei minimizar os componentes de controle do circuito, havia um desejo de apertar o sintonizador no meu roteador dom√©stico com o Openwrt, que at√© agora era o n√∫cleo da solu√ß√£o dom√©stica inteligente para 1wire, modbus, sensores / protocolos wifi, mas, infelizmente, esgotei alguns de seus recursos ( o espa√ßo na unidade flash embutida para o software necess√°rio termina, o processador carrega com alguma coisa - j√° haver√° problemas com a rede e ainda temos 4k para procurar on-line :), + j√° existem muitas coisas penduradas no USB, o que afeta a estabilidade da coleta de dados).  Decidiu-se transferir gradualmente a funcionalidade da casa inteligente para um dispositivo externo - rarpberry pi (uma das primeiras vers√µes estava dispon√≠vel). <br><br><h3>  Sobre o software </h3><br>  Depois de tocar com um sintonizador de TV afiado em um computador desktop com janelas (depois de tentar capturar r√°dios de outras pessoas e negocia√ß√µes de aeronaves), comecei a ver se os pr√≥prios sensores viram o "apito".  Sim, v√™ perfeitamente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37e/68a/4d6/37e68a4d69b575f74e47db6ae45b0d4b.jpg" alt="imagem"><br><br><h4>  Configura√ß√£o de framboesa </h4><br>  Eu escolhi raspbian nativo.  Eu escrevi a √∫ltima imagem na unidade flash USB em mac / linux: <br><br><pre><code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=2019-07-10-raspbian-buster-lite.img of=/dev/disk2 bs=1048576 conv=sync</code> </pre> <br>  Inicialize, configure a rede e o ssh. <br><br>  Em seguida - coloque os pacotes de framboesa rtl-sdr, rtl_433: <br><br><pre> <code class="bash hljs">sudo apt-get install cmake build-essential python-pip libusb-1.0-0-dev libusb-1.0 python-numpy git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/merbanan/rtl_433.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rtl_433/ mkdir build <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build cmake .. make make install</code> </pre> <br>  O rtl_433 possui protocolos internos que descriptografam dados de diferentes dispositivos operando na faixa de 433mhz. <br><br><h4>  Come√ßamos rtl_433 </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6</code> </pre> <br>  Abaixamos os sensores na √°gua e obtemos o valor: <br><br><pre> <code class="bash hljs">time : 2019-09-17 15:04:39 model : Smoke detector GS 558 id : 16919 unit : 1 learn : 0 Raw Code : c842e1</code> </pre><br>  Detector de fuma√ßa?  Ok, vamos colocar a m√∫sica "Smoke on the water" no alerta desses sensores ... :) <br>  Mas, falando s√©rio - temos o ID de cada sensor, de acordo com o qual no futuro entenderemos exatamente onde temos um vazamento (e, em qualquer caso, seremos desligados). <br><br><h4>  Sobre sensores de vazamento </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/47a/255/60d/47a25560dd09554b0749dc171502c71b.png" alt="imagem"><img src="https://habrastorage.org/getpro/habr/post_images/710/dd8/917/710dd891751f85699ed64c30b180c443.png" alt="imagem"><img src="https://habrastorage.org/getpro/habr/post_images/b56/f4b/a31/b56f4ba310bd674da8b16171c5112806.png" alt="imagem"><br><br>  Depois de configurar a parte do software, notei que os sensores com aliexpress (foto √† esquerda) enviam um √∫nico sinal quando a √°gua entra nos contatos.  Mais um sinal se a √°gua parar de fechar os contatos.  Isso n√£o me serve de forma alguma (comportamento esperado: envie constantemente um sinal de alarme quando o sensor detectar √°gua, pois um √∫nico sinal pode ser perdido).  Um comportamento semelhante √© observado se voc√™ fechar os contatos com um fio.  Mas o que √© estranho - o alarme ocorre a cada 2-3 segundos, se voc√™ fechar os contatos com as m√£os (pele).  Aqui ainda tenho duas suposi√ß√µes: ou os chineses estragaram as medi√ß√µes de resist√™ncia, ou os sensores t√™m algum outro modo de opera√ß√£o em que se comportam de maneira diferente (por exemplo, emparelhados com um controlador) ou existem outras frequ√™ncias (at√© que eu encontrei ) <br><br>  <i>A prop√≥sito, escreva nos coment√°rios, talvez algu√©m tenha trabalhado com esses sensores. De alguma forma eles podem ser "ensinados" a enviar um sinal sobre um vazamento constantemente?</i> <br><br>  Coloquei esses sensores de lado, no arsenal havia outro da rubetek (foto √† direita) e comprei na Leroy: GAL SHW-1005 (foto do meio). <br><br>  O comportamento do sensor de rubetek parecia completamente imprevis√≠vel (a rea√ß√£o imprevis√≠vel ‚Äúv√™ √°gua / n√£o v√™‚Äù). <br><br>  Mas o sensor da Leroy em movimento mostrou exatamente o que eu precisava: h√° √°gua - eu spam no ar, n√£o h√° √°gua - estou calada.  Seu √∫nico ponto negativo √© um raio de a√ß√£o menor que outros sensores.  Mas o problema foi resolvido com a compra de uma antena mais sens√≠vel para o receptor. <br><br><h4>  MQTT </h4><br>  Como enviar a sa√≠da rtl_433 para o zabbix?  Alimentar o agente?  Enviar para zabbix_sender, analisando o processo?  Talvez atrav√©s do syslog? <br><br>  Aqui voc√™ precisa se lembrar que meu zabbix est√° em algum lugar nas nuvens.  E certamente n√£o √© necess√°rio bloquear a √°gua com a ajuda de seus gatilhos.  O ch√£o da casa inundar√° at√© que ele tome uma decis√£o (se houver alguma dispon√≠vel). <br><br>  A boa not√≠cia √© que o rtl_433 pode enviar informa√ß√µes no MQTT.  Fora da caixa.  Ao mesmo tempo, os dados s√£o enviados ao broker no formato json. <br><br>  Ent√£o voc√™ precisa: <br><br><ul><li>  Coloque um corretor local de mosquitos (fa√ßa-o na framboesa). </li><li>  Mesclar as informa√ß√µes no broker com o t√≥pico desejado, para que posteriormente possam ser analisadas. </li><li>  Conecte-se ao broker localmente na framboesa e envie comandos para compensa√ß√£o </li><li>  Conecte-se ao broker a partir do local em que o redirecionamento para o zabbix ocorrer√° (o servidor zabbix no meu caso tamb√©m √© um cliente MQTT) </li></ul><br><h4>  Mosquito de instala√ß√£o-configura√ß√£o MQTT: </h4><br><pre> <code class="bash hljs">apt-get install mosquitto mosquitto-clients systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mosquitto systemctl start mosquitto</code> </pre> <br><h4>  Enviamos informa√ß√µes ao corretor indicando o ID do dispositivo: </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.88e6 -F mqtt://127.0.0.1,events=/433/[id]</code> </pre> <br>  No cliente mqtt, obteremos algo como o seguinte: <br><br><pre> <code class="bash hljs">mosquitto_sub -h 127.0.0.1 -t <span class="hljs-string"><span class="hljs-string">'#'</span></span> (   ) /433/16919 {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-18 11:55:29"</span></span>,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:16919,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:1,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"c842e1"</span></span>}</code> </pre> <br><h4>  Script para conectar-se ao broker e enviar o comando para netping </h4><br>  Esbo√ßo um cliente de script MQTT simples que permite executar o script associado ao t√≥pico quando o t√≥pico especificado na configura√ß√£o aparece.  Assim, quando um determinado sensor √© acionado e as informa√ß√µes sobre ele aparecem no ar (por exemplo, / 433/16919), voc√™ pode executar alguma a√ß√£o (no caso de compensa√ß√£o, envie uma solicita√ß√£o de enrolamento para fechar o guindaste, consulte o artigo anterior).  Um link para o script est√° no final do artigo. <br><br><h4>  Redirecionamento no zabbix </h4><br>  Eu usei a solu√ß√£o mqtt-zabbix pronta.  Em seu n√≠vel, entendemos em qual item enviar o valor (por ID). <br><br>  Em keys.cfg, especifique: <br><br><pre> <code class="bash hljs">/433/16919,mqtt.ventilation.waterleak::hostname</code> </pre> <br>  onde hostname √© o nome do host com o tipo de tramp de item no Zabbix. <br><br>  Importante !!!  O nome do host nas configura√ß√µes deve corresponder ao nome a ser enviado no script, o tipo de item (elemento de dados) deve ser adequado para os dados que est√£o sendo enviados (por exemplo, para json - text), caso contr√°rio, voc√™ detectar√° erros no formul√°rio: <br><br><pre> <code class="bash hljs">2019-09-18 14:29:48,749 Got response from Zabbix: {u<span class="hljs-string"><span class="hljs-string">'info'</span></span>: u<span class="hljs-string"><span class="hljs-string">'processed: 0; failed: 1; total: 1; seconds spent: 0.000055'</span></span>, u<span class="hljs-string"><span class="hljs-string">'response'</span></span>: u<span class="hljs-string"><span class="hljs-string">'success'</span></span>}</code> </pre> <br>  Al√©m disso, √© dif√≠cil obter mais depura√ß√£o (e por que falhou) do zabbix. <br><br>  Configuramos /etc/mqtt-zabbix/mqtt-zabbix.cfg (especifique o intermedi√°rio ip mqtt e o endere√ßo do servidor zabbix). <br><br><h3>  O que mais se conectar ao 433? </h3><br>  <i>Sim, qualquer coisa!</i>  <i>:)</i> <br><br><h4>  Sensores de esta√ß√£o meteorol√≥gica </h4><br>  Enquanto mexia em sensores de vazamento sem fio, captei acidentalmente o sinal de um sensor externo de uma esta√ß√£o meteorol√≥gica.  Parecia assim: <br><br><pre> <code class="bash hljs">time : 2019-09-19 10:48:54 Protocol : 56 model : TFA pool temperature sensor Id : 182 Channel : 3 Temperature: 19.3 C Modulation: ASK Freq : 433.9 MHz RSSI : -0.1 dB SNR : 35.0 dB Noise : -35.2 dB time : 2019-09-20 10:57:29 Protocol : 12 brand : OS model : THN132N House Code: 4 Channel : 3 Battery : OK Celsius : 20.00 C Modulation: ASK Freq : 432.9 MHz RSSI : -0.2 dB SNR : 31.5 dB Noise : -31.7 dB</code> </pre><br>  Assim, o b√¥nus foi a capacidade de monitorar a temperatura dos pontos no ar com exibi√ß√£o no zabbix.  Apenas em alguns quartos, n√£o consigo esticar o cabo. <br><br><h4>  Campainha </h4><br>  Muitas chamadas de r√°dio funcionam na mesma faixa de frequ√™ncia ~ 433mhz.  Assim, podemos interceptar o pressionamento do bot√£o de chamada (nem sequer √© necess√°rio ter a chamada em si, apenas o bot√£o √© suficiente).  Porque  Por exemplo, para configurar notifica√ß√µes adicionais via SMS / para telegrama / qualquer que seja ou exibir a imagem da c√¢mera no monitor. <br><br>  Eu comprei uma liga√ß√£o: Evology QA-688-E RU. <br><br>  Para que o bot√£o rtl_433 veja o bot√£o de chamada, √© necess√°rio ativar os protocolos de "teste", por exemplo, executando com a op√ß√£o "G" ou especificando um protocolo adicional espec√≠fico, ao mesmo tempo adicionaremos a sa√≠da de informa√ß√µes sobre o protocolo e a frequ√™ncia: <br><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6 -G -M protocol -M level -F mqtt://127.0.0.1,events=/433/[id] &amp;</code> </pre> <br>  Entre no MQTT: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 10:57:00"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:72,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"RF-tech"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"battery"</span></span>:<span class="hljs-string"><span class="hljs-string">"LOW"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature_C"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"button"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.84822,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.5981,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.77488,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}</code> </pre> <br>  Aqui voc√™ pode ver id = 0.  Ao mesmo tempo, eu tinha v√°rios dispositivos identificados como RF-tech.  Todos eles tinham um ID igual a 0. Como resultado, todos os dispositivos no zabbix s√£o exibidos como um item.  √â poss√≠vel distinguir exatamente qual dispositivo funcionou, apenas por frequ√™ncia. <br><br>  Colocamos a frequ√™ncia em um item dependente separado: mqtt.outside.doorbell.freq com pr√©-processamento JSON em $ .freq (o zabbix pode fazer isso a partir da 4¬™ vers√£o). <br><br>  Neste item, fa√ßa um gatilho com a express√£o: <br><br><pre> <code class="bash hljs">{HOME_PI:mqtt.outside.doorbell.freq.last()}&gt;433.8 and {HOME_PI:mqtt.outside.doorbell.freq.last()}&lt;433.81 and {HOME_PI:mqtt.outside.doorbell.freq.nodata(30)}=0</code> </pre> <br>  I.e.  se de repente um valor aparecer no item geral mqtt.outside.doorbell.freq (nodata) e a frequ√™ncia estiver no intervalo especificado entre 433,8 e 433,81, podemos concluir que eles est√£o nos chamando (e, por exemplo, para duplicar uma chamada para o SMS). <br><br><h4>  Sensores de porta / janela </h4><br>  Eu tenho um sensor de penetra√ß√£o da rubetek.  Envia o seguinte: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:86,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:12262,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:16,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"e5fcd0"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:7,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"close"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:21"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:14,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"open"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85005,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-11.0148,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:25.1088,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-36.1236}</code> </pre> <br>  Assim que o √∫ltimo sensor de r√°dio foi adicionado ao zabbix, eu queria refazer tudo no MQTT.  Cataloga√ß√£o conveniente, voc√™ pode determinar o t√≥pico ah, o posicionamento e os tipos de dispositivos.  Voc√™ recebe a transmiss√£o geral de todos os eventos. <br><br><h2>  1 fio para MQTT </h2><br>  Quero que tudo esteja no MQTT, pelo menos para o mesmo tipo de implementa√ß√£o.  Eu quero obter um "√©ter" geral de eventos e uma abordagem geral em rea√ß√£o a esses eventos.  Obviamente, o zabbix resolve o problema de rea√ß√£o e deixo alertas.  Mas quero tornar a administra√ß√£o mais alegre, pr√≥xima do sistema e do "√©ter". <br><br>  Existem solu√ß√µes prontas para a retransmiss√£o de estados de sensores de uma rede de 1 fio para o MQTT, mas elas n√£o me agradaram.  As solu√ß√µes prontas no n√≥ carregam v√°rias depend√™ncias por tr√°s deles ou consumiram todo o processador de framboesa.  Algumas das solu√ß√µes das 10 principais na pesquisa do Google s√£o abandonadas pelos autores, outras s√£o suportadas apenas por sensores de temperatura.  H√° tamb√©m uma classe de gateways que coletam informa√ß√µes atrav√©s da interface gpio.  Tudo isso n√£o me agradou. <br><br>  Eu tenho um sistema de pseudo-arquivo montado com dispositivos 1wire em / mnt / 1wire, √© a√≠ que eu quero obter todas as informa√ß√µes necess√°rias.  Para fazer isso, basta fazer uma linha simples no bash, enviando dados atrav√©s do mosquitto_pub para cada um dos sensores.  No entanto, existem quest√µes sobre o lan√ßamento desses scripts (sobre a coroa, para entrar em algum tipo de daemon?), Apresenta√ß√£o normal de dados (obten√ß√£o do mesmo json), adi√ß√£o de um novo sensor, etc. Quanto mais o pensamento se desenvolvia, mais muletas nasceram.  Acabou sendo mais f√°cil escrever um gateway para outros owfs no mqtt para esta tarefa. <br><br>  Existe um arquivo de configura√ß√£o no qual precisamos inserir o ID dos sensores e esses arquivos do fuse.OWFS que queremos publicar no mqtt. <br><br>  A sa√≠da no mqtt √© o seguinte json: <br><br><pre> <code class="bash hljs">/1wire/28.0425260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"30"</span></span>} /1wire/28.bf16270a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.9375"</span></span>} /1wire/26.da2f71010000 {<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"25.2812"</span></span>, <span class="hljs-string"><span class="hljs-string">"IAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"CA"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"VAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.91"</span></span>, <span class="hljs-string"><span class="hljs-string">"VDD"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.59"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2438"</span></span>} /1wire/28.48b3010b0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"40.5625"</span></span>} /1wire/1d.6a9306000000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2423"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.B"</span></span>: <span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.A"</span></span>: <span class="hljs-string"><span class="hljs-string">"9219"</span></span>} /1wire/28.61cc260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"12.5"</span></span>}</code> </pre> <br>  Adicionar √† execu√ß√£o autom√°tica, defina o intervalo de pesquisa.  O problema est√° resolvido. <br><br><h3>  Refer√™ncias </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/merbanan/rtl_433</a> - uma ferramenta para decodificar protocolos de r√°dio <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/kylegordon/mqtt-zabbix</a> - MQTT no Zabbix <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/unlo/1wire2mqtt</a> - 1wire no MQTT, cliente MQTT que permite executar scripts quando o t√≥pico aparece </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt467761/">https://habr.com/ru/post/pt467761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt467749/index.html">GCP: Analisando a pilha de computa√ß√£o do Google Cloud Platform</a></li>
<li><a href="../pt467751/index.html">Como um mensageiro descentralizado na blockchain</a></li>
<li><a href="../pt467753/index.html">Recorde mundial de transmiss√£o de dados sem fio: 40 Gb / s por 11 quil√¥metros</a></li>
<li><a href="../pt467755/index.html">Pr√≠ons, c√°lcio, microbiota, horm√¥nios alimentares e Alzheimer</a></li>
<li><a href="../pt467759/index.html">Design de SO semelhante ao Unix - Espa√ßo de Endere√ßo Virtual (6)</a></li>
<li><a href="../pt467763/index.html">Toda a verdade sobre o RTOS. Artigo # 33 Usando o sistema operacional Nucleus SE em tempo real</a></li>
<li><a href="../pt467765/index.html">Wi-Fi e muitas outras abrevia√ß√µes. Como obter dados em n√≥s Wi-Fi em um aplicativo Android e n√£o aumentar</a></li>
<li><a href="../pt467767/index.html">Mais facilidades para seguidores JSON-RPC</a></li>
<li><a href="../pt467769/index.html">Em um √∫nico recurso de informa√ß√£o federal que cont√©m informa√ß√µes da popula√ß√£o</a></li>
<li><a href="../pt467771/index.html">Como um auto-reloader j√∫nior verde, escreveu o seu <s> quente </s>. Parte 2. CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>