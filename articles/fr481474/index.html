<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∑ ü§úüèΩ üëäüèæ Nous venons d'un autre test - nous testons la base de donn√©es sur MSTest üéç üèµÔ∏è üíë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le test comme principe universel 
 Nous c√©l√©brons le mill√©naire depuis pr√®s d'un quart de si√®cle, et les tests ne font que commencer dans nos vies ......">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous venons d'un autre test - nous testons la base de donn√©es sur MSTest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481474/"><h4>  Le test comme principe universel </h4><br>  Nous c√©l√©brons le mill√©naire depuis pr√®s d'un quart de si√®cle, et les tests ne font que commencer dans nos vies ... Il est difficile de convaincre les d√©veloppeurs novices d'utiliser cette technique incroyable dans leur travail ... Que pouvons-nous dire des d√©veloppeurs, de simples mortels, et il n'est pas toujours possible de comprendre que les tests sont la base des syst√®mes durables!  Comme il est difficile de convaincre une vendeuse que tester un nouveau produit ne signifie pas le manger!  M√™me les agents de s√©curit√© exp√©riment√©s travaillent √©videmment √† l'ancienne - ils essaient de rattraper leur retard et de s√©lectionner le test.  Et vous ne leur prouverez pas que si le Seigneur Dieu lui-m√™me ne d√©daigne pas d'utiliser le TDD dans son travail (souvenez-vous du Grand D√©luge), alors, comme on dit, Dieu lui-m√™me a ordonn√© ... <br><br>  Le nombre de divorces augmente - pourquoi?  Oui tout de m√™me!  TDD!  Testez d'abord - puis mariez-vous!  Non, les petits hommes cr√©dules en manteau de peau de mouton ample, avides de publicit√©s exploitant le sexe, mettent une jeune femme en production ... <br><br>  Eh bien, nous sommes avec vous d'un autre test, d'abord des tests - puis tout le reste! <br><br><h4>  Je reconnais le testeur par la d√©marche ... </h4><br>  Donc, quand j'ai commenc√© √† √©crire la premi√®re base de donn√©es de code suivante, j'y ai pens√©, pourquoi ne pas faire des tests automatiques de ma couche DAL directement sur les tests int√©gr√©s dans VisualStudio? <br><br>  Et je l'ai fait!  Transparent pour EntityFramework, sans aucun tour de passe-passe sous les couvertures et fraude avec de faux objets.  Peu importe - d√©couvrez VS, habillez-vous comme des testeurs et partez!  (Je m'habille toujours comme un testeur) <br><br><div class="spoiler">  <b class="spoiler_title">V√™tements de testeur</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tg/pv/kw/tgpvkwgvjzb4zf7tt-navdbcazi.jpeg" alt="image"><br></div></div><a name="habracut"></a><br><h4>  Mentez √† tout le monde, c'est du test! </h4><br><div class="spoiler">  <b class="spoiler_title">Cas de vie:</b> <div class="spoiler_text">  A travaill√© sur un projet avec le code suivant: <br><br><pre><code class="plaintext hljs">ObjectLink link = this.ObjectLinks.ToList().Where(x =&gt; x.SpotCode.ToLowerInvariant() == code.ToLowerInvariant()).SingleOrDefault();</code> </pre> <br>  Ce code n'a pas fait l'objet de tests, car il n'avait pas le temps - il √©tait urgent de lancer de nouvelles fonctionnalit√©s li√©es au marketing.  Tout fonctionnait lors de la v√©rification manuelle, et j'√©tais d√©j√† d√©tendu ... mais Bill Gates se glissa inaper√ßu ... <br><br>  C'√©tait un automne po√©tique de Saint-P√©tersbourg, de la neige et de la pluie qui striaient doucement mon visage, de la salet√© coulait joyeusement des jambes du pantalon et des filles inconnues souriaient √† travers le maquillage √©tal√©, versant des camions en passant ... Je suis d√©j√† all√© chercher mon doigt dans mon nez, quand c'√©tait perfide, sans d√©clarer la guerre, avant √† l'aube, Microsoft a coup√© les barbel√©s et a publi√© la mise √† jour de base 3.0.  L'h√©bergeur a √©t√© mis √† jour, j'ai √©galement mis √† jour, pourquoi aller dans l'ancien - suis-je pire qu'un h√©bergeur?  J'ai tout v√©rifi√© et d√©ploy√© la mise √† jour ... puis j'ai d√©ploy√© mes yeux!  La nouvelle fonctionnalit√© n'a pas fonctionn√©!  il semblerait que je l'ai test√© avant - que pourrait-il arriver? <br><br>  Et c'est arriv√©: le vieux Billy a d√©cid√© de le couper de LINQ ToLowerInvariant ... maintenant vous devez l'appeler √† l'avance et ins√©rer la valeur finie ... si le code √©tait couvert de tests, je le remarquerais tout de suite lors du test.  C'est bien que j'ai tout remarqu√© moi-m√™me, je n'ai pas eu √† jurer le client, car le testeur avait honte de rougir ... J'ai d√ª r√©soudre le probl√®me et faire un nouveau d√©ploiement. <br></div></div><br><h4>  appareils et mat√©riaux: </h4><br>  Microsoft VisualStudio 2019 <br>  asp.net Core 3.1 (je l'ai install√© avec le studio, si quelque chose peut √™tre livr√© via le menu de projet d'installation d'autres frameworks) <br>  SQL Server Express (fourni avec le studio) <br>  Extension Git vers Visual Studio (inclus) <br><br>  En r√®gle g√©n√©rale, dans les tests unitaires, chaque test doit √™tre isol√© et l'√©tat entre eux ne persiste pas.  Nous obtiendrons donc des tests d'int√©gration, mais nous utiliserons MSTest pour cela.  J'esp√®re qu'ils ne nous emm√®nent pas √† la police pour √ßa. <br><br>  Dans plusieurs √©ditions, j'ai rencontr√© l'utilisation d'objets Mock pour tester la base de donn√©es. <br>  √Ä premi√®re vue, l'id√©e est bonne jusqu'√† ce que des interactions complexes entre les tables commencent. <br>  Ensuite, la configuration de la simulation prendra plus que le test lui-m√™me.  Mais en fait c'est - Control + C - Control + V!  nous sommes tous des contraintes de base de donn√©es qui ont d√©j√† √©t√© enregistr√©es dans EF, base de donn√©es, DataAnnotations ou FluentAPI en double dans la couche maquette.  Et copier, c'est un peu comme casser un mod√®le ... ayah, citoyen, casser ... pas bon! <br><br>  Et si la configuration fictive est compliqu√©e, et par exemple, nous avons fait des erreurs dans les restrictions, il s'av√®re que - le test fictif passera, mais y aura-t-il une erreur sur la base r√©elle? <br><br>  Tout cela m'a int√©ress√© et j'ai d√©cid√© de tester une nouvelle approche. <br><br>  L'id√©e est venue, comme toujours, de TRIZ: un <i>syst√®me id√©al est celui qui est absent, mais ses fonctions sont remplies</i> .  Et j'ai pens√© que je devais utiliser la base de donn√©es elle-m√™me dans les tests. <br>  Et √ßa a fonctionn√© pour moi.  Je veux partager cela, j'esp√®re que quelqu'un vous aidera. <br><br>  Inconv√©nients de la simulation: <br><br><ul><li>  de nombreux presets qui testent </li><li>  les tests se salissent, beaucoup de code suppl√©mentaire </li><li>  des migrations difficiles √† tester </li><li>  bien se comporter que sous surveillance, sur une base r√©elle peut produire des erreurs inconnues </li><li>  lorsque vous changez la structure de la base de donn√©es, vous devez constamment monter dans la maquette et tout changer l√† aussi </li></ul><br>  Avantages du test sur une base r√©elle: <br><br><ul><li>  le programme se comporte exactement comme sur un serveur de combat </li><li>  les tests sont plus simples, vous pouvez les construire l'un apr√®s l'autre de la m√™me mani√®re que les donn√©es sont remplies dans la base de donn√©es </li><li>  nous pouvons nous-m√™mes ajuster la propret√© de la base de donn√©es en num√©rotant les tests (dans MSTest ils sont effectu√©s par ordre alphab√©tique) </li><li>  vous pouvez voir le temps pendant lequel le test est effectu√© (sur un vrai serveur, il sera diff√©rent, mais au moins l'ordre est visible - 10 fois plus long, 2 fois, et vous pouvez d√©j√† √©valuer comment le programme fonctionne, efficacement ou non) </li><li>  peut tester les proc√©dures stock√©es </li></ul><br>  Il y a certaines difficult√©s dans cette approche, avec laquelle je creuse depuis plusieurs jours, mais nous allons les r√©soudre avec succ√®s, et que mon backend de pierre soit avec vous! <br><br>  C'est parti! <br><br>  Nous cr√©ons un nouveau projet d'application Web ASP.Net Core 3.1 (Model-View-Controller), changez l'authentification en comptes d'utilisateurs individuels (stockez les comptes d'utilisateurs dans l'application) et cliquez sur cr√©er <br><br><img src="https://habrastorage.org/webt/n1/oq/5c/n1oq5cv0fxxqnuu0sdgdwda7xem.jpeg" alt="image"><br><br>  √Ä partir de maintenant, je vais enregistrer des instantan√©s de projet dans git, vous pouvez le t√©l√©charger et t√©l√©charger chaque branche afin de l'exp√©rimenter <br><br>  <a href="https://github.com/3263927/Habr_1" rel="nofollow">github.com/3263927/Habr_1</a> <br><br>  <b>Instantan√©: Snapshot_0_ProjectCreated</b> <br><br><div class="spoiler">  <b class="spoiler_title">√Ä propos du r√©f√©rentiel</b> <div class="spoiler_text">  M√™me lorsque je travaille seul, j'utilise toujours le r√©f√©rentiel - il est devenu tr√®s pratique, int√©gr√© √† Visual Studio, pas de ligne de commande, tout fonctionne parfaitement directement depuis VS.  Vous pouvez exp√©rimenter et modifier tout ce que vous voulez, puis vous pouvez toujours corriger le rollback de validation ou basculer vers l'ancienne branche.  Gain de temps et d'efforts, je conseille √† tous.  Et s'int√®gre √† github gratuitement.  Il y a quelques ann√©es, il y avait un mec qui a tout supprim√© ... Donc, au cas o√π, je place tous les projets dans Dropbox et les mets √† jour une fois par semaine, ainsi que l'archivage de tous les projets et le t√©l√©chargement manuel des derni√®res versions sur Google Drive.  Eh bien, sur le t√©l√©phone SD, il y a 120 concerts, l√† aussi, en r√©serve, tout d'un coup, tout √† coup ... Un couple de lecteurs flash avec des copies dans leurs poches sont tellement invisibles! <br></div></div><br>  √Ä ce stade, j'ai cr√©√© un r√©f√©rentiel. Je dois donc planifier le travail pour cr√©er de nouvelles branches.  √Ä l'avenir, en utilisant le mot-cl√© Snapshot, il sera possible de trouver des points de r√©cup√©ration en cas de probl√®me. <br><br>  Je vais cr√©er une nouvelle branche dans le r√©f√©rentiel directement √† partir de VisualStudio, et je l'appellerai "Sister of Talent" pour faire court (blague, Snap_1_DataBases). <br><br>  <b>objectif: cr√©er une connexion et une base de travail</b> . <br><br>  Nous commen√ßons √† cr√©er nos bases. <br><br>  Je dois dire tout de suite que nous aurons 3 bases de donn√©es - un test (sur la machine locale), une autre production (sur le serveur distant, fonctionnant) et une autre locale (pour v√©rifier la sant√© du site dans la configuration DEBUG). <br><br>  La logique est la suivante: <br><br><ul><li>  si nous voulons ex√©cuter le site sur la machine locale et voir comment cela fonctionne, alors Habr1_Local fonctionnera pour nous </li><li>  si nous mettons le code en production, Habr1_Production fonctionnera </li><li>  lorsque notre infrastructure de test commence √† tester, elle doit trouver la base Habr1_Test et l'ex√©cuter </li></ul><br>  Cependant, nous avons une contradiction - il n'y a que deux configurations, Debug et Release.  C'est toujours un probl√®me, mais alors il sera r√©solu. <br><br>  Donc, nous cr√©ons un programme fonctionnant au minimum - pour commencer, nous v√©rifions simplement si au moins une base de donn√©es fonctionne pour nous.  Cr√©ons-le ... avec les mains de Visual Studio lui-m√™me! <br><br>  Ouvrez le fichier appsettings.json <br><br>  Il existe de telles lignes: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\mssqllocaldb;Database=aspnet-WebApp-[- ,   ];Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  L√†, vous devrez entrer les noms corrects des cha√Ænes de connexion, le nom du serveur et le nom de la base de donn√©es.  Je dois dire tout de suite que d'autres connexions sont utilis√©es en production, mais maintenant nous n'en avons plus besoin.  Notre t√¢che consiste √† cr√©er deux bases de donn√©es (locale et test, la production n'est qu'un exemple - nous l'utiliserons dans la configuration de la version. Ensuite, elle pourra √™tre remplac√©e par une base de donn√©es distante fonctionnelle). <br><br>  Pourquoi est-ce n√©cessaire? <br><br>  Les configurations de Visual Studio vous permettent de modifier certains param√®tres en changeant la configuration dans le panneau de Visual Studio: <br><br><img src="https://habrastorage.org/webt/qa/8k/nr/qa8knrxqxt8komoewxxf-b-s2qs.jpeg" alt="image"><br><br>  En g√©n√©ral, l'environnement de d√©veloppement d√©clare simplement une constante DEBUG, qui peut ensuite √™tre lue de n'importe o√π dans le code et compris dans quelle configuration nous sommes actuellement, laquelle est active. <br><br>  Le d√©bogueur distant n'est pas toujours disponible, par exemple, sur l'h√©bergement de colocation.  Nous pouvons ex√©cuter notre serveur asp.net localement, et nous connecter √† la base de donn√©es √† distance, et nous pouvons voir toutes les erreurs qui √©taient en production.  Ici, dans la configuration de la version, nous le ferons, et la configuration de d√©bogage fonctionnera avec notre base de donn√©es locale.  Et nous ne ferons pas de test de configuration, pour des raisons de s√©curit√© - afin de ne pas effacer accidentellement des donn√©es, en oubliant de changer de configuration <br><br>  Donc, nous commen√ßons √† changer la cha√Æne de connexion. <br><br>  Nom du serveur - vous pouvez le voir sur l'onglet -&gt; Explorateur d'objets SQL Server <br><br><img src="https://habrastorage.org/webt/mk/-1/tc/mk-1tcplz6dtcpzupszdzpesh84.jpeg" alt="image"><br><br>  (Je vais effacer prudemment le nom de mon ordinateur, sinon vous allez me calculer par IP et taper quelque chose). <br><br>  J'ai donc ceci (localdb) \ ProjectsV13.  Je ne sais pas pourquoi, lors de l'installation, j'ai appel√© mon SQL. <br>  Cela signifie que notre cha√Æne de connexion devient <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local; Trusted_Connection=True;MultipleActiveResultSets=true"</span></span></code> </pre> <br>  Vous pouvez l'avoir diff√©remment, mais uniquement ProjectV13.  Le reste devrait √™tre laiss√© comme √ßa. <br>  Remplacez DefaultConnection par Habr1_Local <br><br>  Il se pr√©sente comme ceci: <br><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  Maintenant, vous devez aller dans le fichier Startup.cs et y remplacer DefaultConnection avec Habr1_Local: <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>)));</code> </pre> <br>  se transforme en <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"Habr1_Local"</span></span>)));</code> </pre><br>  Nous commen√ßons notre projet dans la configuration de d√©bogage, le navigateur s'ouvre, nous voyons la premi√®re page, cliquez sur le bouton Connexion, entrez n'importe quel e-mail valide (il ne vous enverra pas de lettres, il valide simplement le format) et cliquez sur Connexion - et nous voyons cet √©cran: <br><br><img src="https://habrastorage.org/webt/p3/u3/r4/p3u3r4gkdanievaornpxfxwoous.jpeg" alt="image"><br><br>  Cliquez sur Appliquer la migration, nous attendons lorsque la confirmation appara√Æt √† droite du bouton bleu que la migration a r√©ussi et que vous devez actualiser la page, mettre √† jour, cliquer sur confirmer pour renvoyer les donn√©es et obtenir un √©cran indiquant √âchec de la connexion: <br><br><img src="https://habrastorage.org/webt/fc/sw/pc/fcswpc-tqd0gyuhz70cyefi9uls.jpeg" alt="image"><br><br>  Si un tel √©cran est visible, alors tout est OK - une fois que la demande a pass√© et renvoy√© une tentative de connexion invalide, il n'y a pas eu d'erreur de base de donn√©es, mais il n'a tout simplement pas trouv√© un tel utilisateur. <br><br><div class="spoiler">  <b class="spoiler_title">Un peu sur la migration:</b> <div class="spoiler_text">  C'est un outil complexe et il n'est gu√®re n√©cessaire de le toucher dans cet article, mais vous pouvez le toucher un peu. <br>  Par exemple, vous devez changer l'√©tat de la base de donn√©es en un √©tat sp√©cifique - vous pouvez cr√©er un instantan√© de base de donn√©es pour cela, ou cr√©er plusieurs instantan√©s pour chaque √©tat, et activer / d√©sactiver ces images √† la fois par programme et avec des commandes sp√©ciales. <br><br>  Ou lorsque vous d√©veloppez quelque chose sur la machine locale, puis vous devez synchroniser le nouvel √©tat de la base de donn√©es sur le serveur avec le local, mettre √† jour le serveur de production √† l'√©tat de votre base de donn√©es locale et le faire automatiquement - la migration peut √©galement √™tre appliqu√©e.  Il s'agit en fait de ce bouton bleu.  La base sait que son √©tat est diff√©rent de l'√©tat du code et essaie de synchroniser ces √©tats.  Pour ce faire, une table sp√©ciale est cr√©√©e dans la base de donn√©es avec l'√©tat cod√© de la structure de la base de donn√©es. <br><br>  Malheureusement, cet outil est compliqu√© par le fait qu'il n'y a pas d'interface visuelle pour lui, et vous devez travailler avec lui √† partir de la ligne de commande.  Les migrations sont pratiques √† utiliser lorsque vous devez passer des √©tats via Git - simplement en cr√©ant de tels instantan√©s de base de donn√©es sous forme de fichiers C #.  Mais cet outil pr√©sente un danger: s'il est mal configur√©, il peut effacer les donn√©es de la base de donn√©es, vous devez donc l'utiliser avec prudence. <br></div></div><br>  V√©rification de la disponibilit√© de la base de donn√©es - Visual Studio aurait d√ª la cr√©er <br><br><img src="https://habrastorage.org/webt/op/6i/c_/op6ic_e4cdoarqotsmz441fkmkc.jpeg" alt="image"><br><br>  S'il n'y a pas de base de donn√©es, alors quelque chose s'est mal pass√© - soit le serveur SQL n'a pas √©t√© install√©, soit autre chose, en g√©n√©ral, comme dans une blague sur la fa√ßon dont les programmeurs √©taient m√©decins: ¬´docteur, ma jambe me fait mal ... - enfin, pas Je sais, j'ai la m√™me jambe et rien ne fait mal! ¬ª <br><br>  √Ä ce stade, je cr√©e deux cha√Ænes de connexion suppl√©mentaires, appsettings.json prend cette forme: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Test"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Test;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Production"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Production;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre><br>  Je fais un commit et je place l'instantan√© suivant dans le d√©p√¥t: <br><br>  <b>Instantan√©: Snap_1_DataBases</b> <br><br>  Cr√©ez une nouvelle branche, Snap_2_Configurations <br><br>  <b>objectif: cr√©er des configurations de travail</b> <br><br>  Lors du changement de configuration, nous pouvons consid√©rer de n'importe o√π dans le programme quelle configuration est actuelle (en fait, pas depuis n'importe laquelle, cela ne fonctionnera pas depuis View - nous devons cr√©er une fonction sp√©ciale, mais ce n'est pas important pour ce projet): <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG  DEBUG #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta">  RELEASE ( DEBUG   ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Ouvrez le fichier Startup.cs et convertissez la m√©thode ConfigureServices en ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre><br>  Comme vous pouvez le voir, nous avons remplac√© Habr1_Local par une variable, et maintenant selon la configuration, connectionstring sera soit Habr1_Local ou Habr1_Production <br><br>  Vous pouvez maintenant d√©marrer le projet et v√©rifier comment les bases de donn√©es sont cr√©√©es en fonction de la configuration <br><br>  Nous s√©lectionnons DEBUG sur le panneau, d√©marrons, connectez-vous, appliquez la migration, v√©rifiez que la base de donn√©es a √©t√© cr√©√©e (Habr1_Local) <br><br>  Nous arr√™tons le projet, s√©lectionnons la configuration Release, d√©marrons, connectons-nous, appliquons la migration, v√©rifions que la base de donn√©es a √©t√© cr√©√©e - nous avons 2 bases. <br><br>  C'est fait! <br><br>  <b>Instantan√©: Snap_3_HabrDB</b> <br><br>  <b>Objectif: cr√©er un projet de base de donn√©es distinct, qui peut ensuite √™tre utilis√© dans diff√©rents projets</b> <br><br>  Pourquoi un projet s√©par√©? <br><br>  Les projets individuels pr√©sentent plusieurs avantages: <br><br><ul><li>  Ils peuvent √™tre utilis√©s dans d'autres projets. </li><li>  Ils ne recompilent pas s'il n'y a aucun changement, ce qui signifie que le temps de compilation total est r√©duit </li><li>  Les projets individuels sont plus faciles √† tester. </li></ul><br>  Donc, le bouton droit de la solution - ajouter -&gt; nouveau dossier de solution, nommez-le DB. <br>  Ensuite, acc√©dez directement au dossier cr√©√© - ajoutez un nouveau projet -&gt; .net standard, nom HabrDB. <br>  Pour une raison quelconque, je l'ai cr√©√© en tant que .net standard 2.0, je dois le changer en 2.1 <br>  (lors de la cr√©ation, il offre un chemin physique, laissez-le se trouver dans le dossier DB et physiquement aussi). <br><br>  Cela ressemble √† ceci pour moi: <br><br><img src="https://habrastorage.org/webt/g4/kb/wu/g4kbwu45mu92my9ucaanuldtuhs.jpeg" alt="image"><br><br>  Donc, nous avons un ApplicationDBContext dans le projet, et nous en avons cr√©√© un autre?  Vont-ils entrer en conflit les uns avec les autres?  Nous allons maintenant nous lier d'amiti√© avec eux.  Nous aurons deux contextes diff√©rents pour la m√™me base de donn√©es, qui ne se recouperont pas via Entity Framework.  Nous leur donnerons un nom de sch√©ma diff√©rent: l'un restera dbo par d√©faut, et l'autre sera ¬´habr¬ª. <br><br>  Si vous connectez de tels contextes √† la racine de la composition, ils peuvent √™tre recycl√©s dans d'autres projets de mani√®re presque transparente.  (Par exemple, le contexte de l'entrep√¥t et le contexte de l'employ√©) <br><br>  Et encore un moment architectural, parfois vous devez ajouter certaines de vos propri√©t√©s √† l'utilisateur, cela ne s'applique pas directement au sujet de l'article, mais nous le ferons juste pour savoir comment le faire.  De plus, nous pourrons cr√©er et supprimer des contextes ind√©pendamment les uns des autres.  Une bonne id√©e est de s√©parer la table de s√©curit√© des donn√©es personnelles et de la crypter au niveau de la base de donn√©es (nous ne le ferons pas dans ce projet, mais en g√©n√©ral, cela est parfois requis, y compris par la loi). <br><br>  Oui, et il est plus facile de tester de cette fa√ßon, vous ne pouvez pas cr√©er toutes les tables √† la fois, mais uniquement celles qui sont n√©cessaires pour tester le contexte donn√©. <br><br>  Je cr√©e un nouveau clich√© de projet - √©tape 4. <br><br>  <b>Les objectifs de cette phase sont:</b> <br><br><ul><li>  changer l'utilisateur standard en avanc√© </li><li>  changer d'utilisateur dans le fichier Srartup.cs </li><li>  changer d'utilisateur dans LoginPartial et ViewImports </li><li>  cr√©er une nouvelle migration pour cr√©er automatiquement une base de donn√©es dans un nouveau format </li></ul><br>  Ainsi, nous transf√©rons la classe ApplicationDBContext du projet WebApp vers HabrDB. <br><br>  Ce n'est pas portable, juste copi√©.  Nous le supprimons de WebApp, l'ouvrons du projet HabrDB et changeons son espace de noms en HabrDB, beaucoup d'erreurs apparaissent. <br><br>  Oui, dans ce projet, il n'y a pas de packages n√©cessaires, maintenant nous les livrerons. <br><br>  Gr√¢ce √† nuget, dans le projet HabrDB, vous devez installer Microsoft.AspNetCore.Identity.EntityFrameworkCore. <br><br><img src="https://habrastorage.org/webt/wj/-d/q4/wj-dq4ldm5nx32fs9hvzdiya5ys.jpeg" alt="image"><br><br>  On clique sur l'ampoule et elle nous propose d'installer les derni√®res versions. <br><br>  Le fichier final SecurityDBContext (il doit √©galement √™tre renomm√©) prend cette forme: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SecurityDBContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptions&lt;SecurityDBContext&gt; options</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)</span></span> { } } }</code> </pre> <br>  Apr√®s l'assemblage, nous <s>traitons soigneusement le fichier</s> avec des erreurs, et √† juste titre - nous avons supprim√© ApplicationDBContext et l'avons remplac√© par SecurityDBContext.  Vous devez maintenant remplacer tous les liens vers ApplicationDBContext dans l'ensemble du projet par SecurityDBContext. <br><br>  Apr√®s cela, des triangles jaunes sont apparus dans mon projet sur les r√©f√©rences de WebApp, ce qui indique que certains liens ne fonctionnent pas correctement.  J'ai nettoy√© le projet (build -&gt; solution propre), ferm√© le projet, supprim√© tous les r√©pertoires Debug, Release, Obj et Bin du dossier du projet, apr√®s quoi j'ai rouvert le projet, pendant un certain temps j'ai cherch√© les liens n√©cessaires sur Internet et les ai charg√©s, ainsi que des triangles disparu - alors tout va bien. <br><br>  Supprimez maintenant le dossier Data du projet WebApp, supprimez nos bases de donn√©es (Habr1_Local et Habr1_Production) dans la fen√™tre SQL Server Object Explorer et ex√©cutez le projet.  Nous essayons de nous connecter - et maintenant, au lieu de l'offre d'appliquer la migration, une erreur se produit. <br><br><img src="https://habrastorage.org/webt/z_/ex/ca/z_excar1pqk18n8pdmyvf3eobog.jpeg" alt="image"><br><br>  C'est vrai, nous avons supprim√© le dossier Data o√π se trouvaient toutes les migrations et maintenant le framework ne sait plus quoi faire.  Mais c'√©tait tellement cool?!  Pourquoi?!  Ensuite, ce que nous allons maintenant d√©velopper la classe d'utilisateurs. <br><br>  Ajoutez un nouveau fichier au projet HabrDB: <br>  ApplicationUser.cs <br><br>  Nous h√©ritons de IdentityUser <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>:<span class="hljs-title"><span class="hljs-title">IdentityUser</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String NickName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime BirthDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String PassportNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>  Dans le fichier SecurityDBContext de l'en-t√™te de classe, ajoutez: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>&gt;</code> </pre> <br>  Cela est n√©cessaire pour qu'EntityFramework sache que maintenant, lors de la cr√©ation de la base de donn√©es, vous devez utiliser le mod√®le utilisateur avanc√© de la classe AppllicationUser au lieu du mod√®le standard. <br><br>  La m√©thode ConfigureServices du fichier Startup.cs prend la forme: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;SecurityDBContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;ApplicationUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;SecurityDBContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre> <br>  (Remplacez IdentityUser par ApplicationUser) <br><br>  Dans le fichier _ViewImports.cshtml, ajoutez la ligne <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">en utilisant</a> HabrDB <br><br>  Maintenant, toutes les vues verront notre projet avec la base et vous n'aurez pas besoin d'√©crire en <a href="https://habr.com/ru/users/using/" class="user_link">utilisant</a> HabrDB au d√©but des vues. <br><br>  Dans le fichier _LoginPartial.cshtml, remplacez tous IdentityUser par ApplicationUser. <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">√† l'aide de</a> Microsoft.AspNetCore.Identity <br>  <a href="https://habr.com/ru/users/inject/" class="user_link">injecter</a> SignInManager SignInManager <br>  <a href="https://habr.com/ru/users/inject/" class="user_link">injecter</a> UserManager UserManager <br><br>  Juste au cas o√π, nous compilons le projet afin de savoir que nous n'avons aucune erreur et que nous n'avons oubli√© de remplacer quoi que ce soit. <br><br>  Faites maintenant la migration. <br><br>  Vous devez ouvrir la console du gestionnaire de packages, s√©lectionner le projet DB / HabrDB et y √©crire <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-migration initial</code> </pre> <br>  Voici ce que j'ai obtenu: <br><br><img src="https://habrastorage.org/webt/95/zv/aj/95zvaj1nj3d42hnzq2rk_bvncvo.jpeg" alt="image"><br><br>  Le papa Migrations est apparu dans le projet HabrDB et il contient des fichiers qui nous permettront de cr√©er notre base de donn√©es automatiquement, mais maintenant avec nos champs suppl√©mentaires - NickName, BirthDate, PassportNumber. <br><br>  Essayons comment cela fonctionne - ex√©cutons et essayons de nous connecter (ne vous enregistrez pas, vous devrez y saisir des mots de passe complexes): <br><br><img src="https://habrastorage.org/webt/01/ib/0u/01ib0ufzxz_bds3n2scb5pqgyoi.jpeg" alt="image"><br><br>  On m'a propos√© de faire une migration et j'ai accept√© - c'est notre base: <br><br><img src="https://habrastorage.org/webt/qg/af/js/qgafjs_fgtlnj39nlru_bxb9a2a.jpeg" alt="image"><br><br>  Avec cette √©tape, tout <br><br>  <b>Instantan√©: Snap_4_Security est</b> pr√™t <br><br>  Cr√©ez le cinqui√®me plan. <br><br>  <b>Objectifs:</b> <br><br><ul><li>  faire fonctionner la cha√Æne de connexion de test </li><li>  cr√©er un projet de test de base de donn√©es </li><li>  faire le projet de test cr√©er une base et tester quelque chose d'utile </li></ul><br>  Nous faisons un clic droit sur le papa DB, cr√©ons un nouveau projet - MSTest .net core. <br>  Renommez le seul fichier de ce projet en DBTest et pensez ... <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> De plus, ce sera difficile. </font></font><br><br>  Le probl√®me <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment pouvons-nous cr√©er un contexte qui est garanti pour communiquer avec la base de donn√©es de test, c'est-√†-dire utiliser ConnectionString non seulement √† partir d'un autre projet (WebApp), mais aussi se connecter d'une mani√®re ou d'une autre avec les configurations Release / Debug? .. Peut cr√©er une nouvelle configuration, Test par exemple ? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non, c'est une perte de donn√©es potentielle - nous oublions en quelque sorte que nous avons oubli√© de passer de la configuration de test, cliquez sur le bouton Ex√©cuter tous les tests - et l√†, la suppression de la base de donn√©es enti√®re ... non, cette option ne fonctionne pas ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons donc clairement cr√©er un contexte de test! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrez le fichier HabrDBContext et changez son contenu en:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String ConnectionString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IConfigurationRoot Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HabrDBContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateTestContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { DirectoryInfo info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(Directory.GetCurrentDirectory()); DirectoryInfo temp = info.Parent.Parent.Parent.Parent; String CurDir = Path.Combine(temp.ToString(), <span class="hljs-string"><span class="hljs-string">"WebApp"</span></span>); String ConnStr = <span class="hljs-string"><span class="hljs-string">"Habr1_Test"</span></span>; Configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder().SetBasePath(CurDir).AddJsonFile(<span class="hljs-string"><span class="hljs-string">"appsettings.json"</span></span>).Build(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbContextOptionsBuilder&lt;HabrDBContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = Configuration.GetConnectionString(ConnStr); builder.UseSqlServer(connectionString); ConnectionString = connectionString; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Via Nuget, ajoutez les biblioth√®ques suivantes √† la base de donn√©es: </font></font><br><br><pre> <code class="plaintext hljs">Microsoft.AspNetCore.Identity.EntityFrameworkCore Microsoft.EntityFrameworkCore Microsoft.EntityFrameworkCore.SqlServer Microsoft.Extensions.Configuration.FileExtensions Microsoft.Extensions.Configuration.Json</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La m√©thode CreateTestContext ne peut tout simplement renvoyer qu'une cha√Æne de connexion nomm√©e Habr1_Test. Vous devez le prendre dans un autre projet. Afin de ne pas connecter le projet par r√©f√©rence car nous n'avons besoin que d'un seul param√®tre, nous demandons au constructeur de cr√©er des options bas√©es sur la cha√Æne de connexion donn√©e, pour cela, nous parcourons la cha√Æne de r√©pertoires du r√©pertoire o√π le projet de test est compil√© jusqu'au r√©pertoire racine du projet, collectons le chemin d'acc√®s au projet WebApp √† partir des pi√®ces, veuillez ajouter pour nous le fichier de configuration appsettings.json o√π nos param√®tres sont stock√©s, et compilez-le dans la configuration. Plus loin de cette configuration, nous prenons connectionString et nous nous en souvenons (nous en aurons besoin plus tard).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les grands projets, vous pouvez d√©placer les param√®tres vers un projet distinct avec des cha√Ænes, une DLL ou un objet pour acc√©der aux donn√©es de param√®tres avec la mise en cache. Pour l'instant, une approche plus simple suffira.</font></font><br><br>  Pourquoi <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez mettre un ConnectionString de test directement dans le projet de test et initialiser la base de donn√©es avec lui, vous pouvez cr√©er un ConnectionString de test dans la base de donn√©es. </font><font style="vertical-align: inherit;">Mais alors il y aura une chose d√©sagr√©able: toutes les cha√Ænes de connexion seront stock√©es √† diff√©rents endroits. </font><font style="vertical-align: inherit;">Et par moi-m√™me, je sais que ma t√™te est pleine de trous et je peux oublier de changer quelque chose lorsque, par exemple, le nom de la base de donn√©es ou du serveur change, et que j'ai toutes les cha√Ænes de connexion en un seul endroit, je le fais. </font><font style="vertical-align: inherit;">Maintenant, en modifiant le fichier de configuration appsettings.json, vous pouvez g√©rer toutes les connexions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons maintenant de faire quelque chose d'utile avec la base, par exemple, de cr√©er quelque chose. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le projet HabrDB, j'ai cr√©√© le dossier DBClasses, il n'y aura que des classes de table de base de donn√©es. </font><font style="vertical-align: inherit;">Nous travaillons d'abord sur le code, si je peux imaginer ce que je fais, c'est g√©n√©ralement plus pratique pour moi.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ez un tableau comme celui-ci: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations.Schema; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB.DBClasses</span></span> { [Table(<span class="hljs-string"><span class="hljs-string">"Phones"</span></span>, Schema =<span class="hljs-string"><span class="hljs-string">"Habr"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Phone</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Model { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime DayZero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la beaut√©, que ma classe soit appel√©e ¬´t√©l√©phone¬ª et la table de la base de donn√©es au pluriel - ¬´t√©l√©phones¬ª. </font><font style="vertical-align: inherit;">Par cons√©quent, j'indique dans l'attribut Table comment nommer ma table et dans quel espace de noms elle doit se trouver dans la base de donn√©es (en SQL, cela s'appelle Sch√©ma). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, il y a une autre question d'esth√©tique: ici, nous aurons un tas de m√©thodes d'infrastructure diff√©rentes dans la classe de base de donn√©es, puis d'autres tables diff√©rentes et tout cela dans un tas - vous pouvez cr√©er des classes partielles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez le mot partiel apr√®s la classe de mots dans le fichier HabrDBContext.cs - comme ceci:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez une copie du fichier HabrDBContext.cs - simplement CTRL + C - CTRL + V sur le fichier, cr√©ez-en une copie, changez le nom du fichier source en HabrDBContext_Infrastructure.cs et le nouveau en HabrDBContext_Data.cs </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le nouveau, √©crivez:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Phone&gt; Phones { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, c'est beau - nous travaillons avec des donn√©es √† un endroit, avec des infrastructures √† un autre. </font><font style="vertical-align: inherit;">Les fichiers sont diff√©rents, mais la classe est la m√™me - l'environnement lui-m√™me les assemblera de plusieurs en un lors de la construction du projet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, essayez-le! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remplacez le code dans notre seule classe de test par:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.Phones.ToList(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.Phones.Add(ph); db.SaveChanges(); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliquez sur le bouton de lecture dans l'onglet Explorateur de tests (ou Test -&gt; Ex√©cuter tous les tests) et ... </font></font><br><br><img src="https://habrastorage.org/webt/9w/qe/68/9wqe686vdpg6jet-epu30oakdou.jpeg" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreur! </font><font style="vertical-align: inherit;">voici ceux dessus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous lisons ce qu'ils nous √©crivent:</font></font><br><br><pre> <code class="plaintext hljs">Message: Test method DBTest.DBTest.TestMethod1 threw exception: System.InvalidOperationException: No database provider has been configured for this DbContext. A provider can be configured by overriding the DbContext.OnConfiguring method or by using AddDbContext on the application service provider. If AddDbContext is used, then also ensure that your DbContext type accepts a DbContextOptions&lt;TContext&gt; object in its constructor and passes it to the base constructor for DbContext.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une sorte de merde en anglais ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'accord, nous allons agir au hasard! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette fonction peut-elle √™tre copi√©e dans le fichier HabrDBContext_Infrastructure.cs? </font><font style="vertical-align: inherit;">Essayons!</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfiguring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Configuration == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr= "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> Configuration = new ConfigurationBuilder() .SetBasePath(Directory.GetCurrentDirectory()) .AddJsonFile("appsettings.json").Build(); ConnectionString = Configuration.GetConnectionString(ConnStr); } optionsBuilder.UseSqlServer(ConnectionString); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous commen√ßons ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'√©tait de la chance !!! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une nouvelle base a √©t√© cr√©√©e et en elle - notre table! </font></font><br><br><img src="https://habrastorage.org/webt/an/cv/1a/ancv1ahppxwymetpwayqqwdtlzg.jpeg" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous placez quelques points d'arr√™t sur les fonctions OnConfiguring et CreateTestContext, vous verrez que la m√©thode CreateTestContext est appel√©e en premier et enregistre la cha√Æne de connexion dans l'objet ConnectionString. Tout semblerait OK. Mais alors quelqu'un essaie d'appeler OnConfiguring ... qui est-ce? Voyons la pile des appels - oui, c'est la ligne db.Database.EnsureCreated () du test! le fait est que nous n'avons pas encore de base en tant que telle - sa m√©thode EnsureCreated la cr√©e. Mais cette m√©thode ne prend plus de param√®tres et le contexte doit en quelque sorte √™tre pr√©serv√© entre les appels au constructeur et EnsureCreated. De plus, lorsque nous utilisons ce contexte √† partir du projet lui-m√™me (pas dans les tests, mais sur le site Web par exemple), toutes sortes de middlware, DI et autres m√©canismes accrocheurs essaieront √©galement de l'appeler, nous allons donc tout pr√©voir √† l'avance - celui qui appelle notre base de donn√©es ,s'il veut appeler OnConfiguring - il aura une telle opportunit√©. Nous avons tout pr√©vu.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relancez le test - et ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encore une fois, une erreur? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La base de donn√©es est d√©j√† l√†, les donn√©es sont ... qu'est-ce qui ne va pas? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une base est un objet persistant qui reste, m√™me si nous red√©marrons notre projet ... et maintenant la partie vraiment difficile commence. Comment supprimer tous ces tableaux? Comment supprimer des donn√©es, r√©initialiser tous les index? </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snapshot: Snap_5_ContextCrafting est pr√™t.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tout d'abord, √©crivez DAL - Data Access Layer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez une copie du fichier HabrDBContext_Data.cs, ‚Äã‚Äãappelez-le HabrDBContext_DAL.cs </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et √©crivez-le:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Phone ph</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.Add(ph); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SaveChangesAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;List&lt;Phone&gt;&gt; GetAllPhones() { List&lt;Phone&gt; phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> phones; } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un wrapper sur nos donn√©es. Je ne voudrais pas, si je change quelque chose dans les interfaces pour acc√©der √† la base de donn√©es, g√©rer la recherche tout au long du projet o√π je l'ai appel√©e. Par cons√©quent, nous allons cr√©er une couche d'abstraction - Data Access Layer. Il sera l'interm√©diaire entre les m√©canismes de base et MVC du site ou d'autres m√©canismes. Et - une co√Øncidence? - nous avons imm√©diatement des objets de test! Une autre raison d'utiliser des tests est qu'ils provoquent des solutions √† faible connectivit√©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changez le code de fonction dans les tests - et pour un, changez son nom. Maintenant, nous savons ce que nous testons! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout d'un t√©l√©phone! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne ferons pas le r√©f√©rentiel, pour un projet de d√©monstration c'est une solution redondante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Normalement, vous pouvez tout connecter via DI dans startup.cs, mais pour le projet de d√©monstration, cela est trop d√©routant, alors laissons-le comme √ßa</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nouveau code de fonction de test: </font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.GetAllPhones().Result; Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons supprimer la ligne avec le t√©l√©phone de la base de donn√©es de test et relancer le test - cela devrait fonctionner. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cela ne fonctionne pas, vous avez toujours une jambe diff√©rente. </font><font style="vertical-align: inherit;">Tout est vert avec moi: </font></font><br><br><img src="https://habrastorage.org/webt/kc/vz/ea/kcvzeaiyug4owclncwblblpqoaw.jpeg" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'est-ce que db.GetAllPhones (). R√©sultat? </font><font style="vertical-align: inherit;">Le fait est que nos fonctions DAL sont asynchrones. </font><font style="vertical-align: inherit;">Mais la m√©thode de test elle-m√™me est ordinaire, et donc attendre ne peut pas y √™tre appel√©. </font><font style="vertical-align: inherit;">Essayons de supprimer les donn√©es, de rendre la m√©thode asynchrone et de voir ce qui se passe. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre fonction est devenue une t√¢che asynchrone - sinon le test ne d√©marre tout simplement pas, et partout o√π il y a un appel √† des m√©thodes asynchrones - vous devez attendre avant elles</font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est important que toutes les fonctions de test dans lesquelles il y a des appels asynchrones renvoient Task et non nulles - sinon les tests ne d√©marreront pas ou n'attendront pas le retour des donn√©es asynchrones et continueront et il y aura une erreur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donc, √ßa marche plus ou moins. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snapshot: Snap_6_Dal</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et quoi, est-il </font><b><font style="vertical-align: inherit;">n√©cessaire de</font></b><font style="vertical-align: inherit;"> supprimer les donn√©es manuellement? Bien s√ªr que non! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons besoin d'une fonction pour supprimer des tables de la base de donn√©es ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce serait cool d'utiliser db.Database.EnsureDeleted ... et c'est vraiment possible!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais mieux n'est pas n√©cessaire ... le fait est que dans ce projet nos bases ne sont pas connect√©es avec des mots de passe. Et si la base de donn√©es est associ√©e √† un mot de passe, vous devrez le cr√©er s√©par√©ment - via SQL Management Studio, et lorsque vous le supprimerez de db.Database.EnsureDeleted, il sera supprim√© avec tous les mots de passe, acc√®s, droits d'utilisateur et lorsque le framework essaiera de le cr√©er la prochaine fois, alors il n'y aura tout simplement pas acc√®s √† la base de donn√©es, vous devrez tout configurer √† nouveau. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est le premier. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La seconde est qu'il vaut mieux ne pas faire trop de travail, et donc les tests de base de donn√©es prendront plus de temps que les fonctions habituelles qui ne sont pas li√©es √† des m√©canismes externes, et il est pr√©f√©rable d'optimiser le temps d'ex√©cution des tests de toutes les mani√®res possibles.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et le troisi√®me: peut-√™tre dans un test, nous devrons supprimer une table ou plusieurs fois et la recr√©er, tout en laissant les autres tables intactes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons d'appeler la fonction db.Database.EnsureDeleted, appuyez sur le crochet et voyons ce qu'il accepte, et s'il a des surcharges ... </font></font><br><br><img src="https://habrastorage.org/webt/uh/by/ti/uhbytib40xtjnbwfapd26iqtrus.jpeg" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oui, pas beaucoup ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eh bien, ok, √©crivons la n√¥tre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez imm√©diatement un nouveau projet √† la solution (dans la solution elle-m√™me) sur la solution avec le bouton droit, ajoutez -&gt; .net standard C # et appelez-le Extensions. V√©rifiez qu'il s'agissait de la version 2.1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, vous devez renommer le seul fichier du projet Extensions en DBContextExtensions.cs et y mettre le code suivant:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore.Infrastructure; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Extensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBContextExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { TableDescription Table = GetTableName(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = db.ExecuteSqlRaw(<span class="hljs-string"><span class="hljs-string">$"DROP TABLE [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.Schema}</span></span></span><span class="hljs-string">].[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.TableName}</span></span></span><span class="hljs-string">];"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TableDescription GetTableName&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = dbSet.GetDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = dbContext.Model; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityTypes = model.GetEntityTypes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityType = entityTypes.First(t =&gt; t.ClrType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableNameAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:TableName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableSchemaAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:Schema"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableName = tableNameAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schemaName = tableSchemaAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TableDescription { Schema = schemaName, TableName = tableName }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> infrastructure = dbSet <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IInfrastructure&lt;IServiceProvider&gt;; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceProvider = infrastructure.Instance; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentDbContext = serviceProvider.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ICurrentDbContext)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ICurrentDbContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentDbContext.Context; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TableDescription</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Schema { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String TableName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez Microsoft.EntityFrameworkCore √† partir de Nuget. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et un autre package, Microsoft.EntityFrameworkCore.Relational </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extensions, est un m√©canisme tr√®s pratique. En l'utilisant, vous pouvez ajouter des fonctionnalit√©s suppl√©mentaires √† l'objet de classe, ce que nous avons fait - le mot-cl√© this avant le type du premier param√®tre</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indique un type extensible. Cela signifie qu'apr√®s avoir √©crit cela, l'objet DatabaseFacade aura une nouvelle m√©thode - EnsureDeleted avec un param√®tre, qui sera notre fonction que nous venons d'√©crire! o√π TEntity: classe √† la fin signifie que TEntity a une contrainte - une restriction d'utilisation, et si nous essayons de la g√©n√©raliser non pas par une classe, mais par autre chose, alors il y aura une erreur de compilation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je pr√©vois votre question logique - pourquoi est-ce? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, la fonction GetTableName qui est appel√©e √† partir d'EnsureDeleted a besoin de cette restriction. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi a-t-elle besoin de cette restriction? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors, quelle fonction GetDbContext, qui est appel√©e √† partir de GetTableName, a √©galement besoin de cette restriction ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et pourquoi a-t-elle </font><font style="vertical-align: inherit;">besoin de </font><font style="vertical-align: inherit;">cette restriction ??? !!! vous demandez dans des tons √©lev√©s et vous aurez raison ...</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le dbSet que nous essayons d'√©tendre avec la m√©thode GetDbContext dans la ligne</font></font><br><br><pre> <code class="cs hljs">Public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, n√©cessite que T soit un type de r√©f√©rence, et la classe n'est que l'un d'entre eux ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, toutes ces difficult√©s - pour une petite mais tr√®s utile fonctionnalit√© - ne transmettent pas de valeurs de cha√Æne en tant que param√®tre √† la m√©thode EnsureDeleted. Parce que j'ai une mauvaise m√©moire. Je veux que DBContext me dise quelles tables il a, et √† partir de cet ensemble de donn√©es, il calcule d√©j√† le contexte, l'am√®ne au contexte actuel via le fournisseur de services, puis il prend le mod√®le de ce contexte, en saisit des types, puis il recherche le type avec ces types le m√™me que l'ensemble de donn√©es (c'est d√©j√† dans GetTableName), puis √† travers des annotations, il prend le nom de la table et du sch√©ma, le transmet d√©j√† √† EnsureDeleted et l√† - bon sang! encore une fois, il n'y a pas de fonction comme removetable ou quelque chose comme √ßa, vous devez construire du syrniki SQL √† partir de cha√Ænes ... enfin, au moins, √ßa a fonctionn√©!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et l'exception se trouve dans la fonction EnsureDeleted afin que vous ne puissiez pas penser √† la proc√©dure de suppression des tables, s'il y a des donn√©es connexes, juste apr√®s la suppression des tables li√©es, essayez de supprimer √† nouveau la table et ne vous emb√™tez pas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajouter la m√©thode aux tests (√† la fin)</font></font><br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Courez, v√©rifiez, expirez ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Courez √† nouveau - devrait fonctionner. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©sormais, chaque fois que vous ex√©cutez des tests, les tables n√©cessaires sont cr√©√©es, puis supprim√©es. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instantan√©: Snap_7_Extensions</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† de nouveaux </font><font style="vertical-align: inherit;">horizons </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h√©morro√Ødes</font></font></s><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais il y a un probl√®me - l'objet HabrDBContext n'est pas persistant avec nous (il est cr√©√© dans chaque m√©thode de test). </font><font style="vertical-align: inherit;">(Eh bien, oui, l'id√©e Kagbe des tests unitaires doit √™tre isol√©e. Et nous essayons de la casser! C'est bien que la police ne voie pas ...) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autrement dit, dans chaque m√©thode de test, le contexte est recr√©√©, et nous ne pouvons pas partager cet objet entre les fonctions afin qu'il soit commun √† tous et cr√©√© une fois pour toutes les √©preuves. </font><font style="vertical-align: inherit;">N'est-ce pas? </font><font style="vertical-align: inherit;">Eh bien, nous allons √©crire dans chaque fonction.</font></font><br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et appeler la derni√®re m√©thode </font></font><br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et quelques autres tableaux ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce n'est pas tr√®s beau, alors nous allons r√©fl√©chir √† la fa√ßon de r√©soudre ce probl√®me ... puisque nous nous habillons comme des testeurs, nous devons faire correspondre l'image - nous chercherons une solution! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les classes ont une fonctionnalit√© int√©ressante: les membres statiques. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est comme si vous imaginez un dessin et un objet cr√©√© √† partir de ce dessin, il s'av√®re qu'un membre statique est un membre qui n'est pas inh√©rent √† l'objet cr√©√© √† partir du dessin, mais √† ce dessin lui-m√™me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est d√©j√† int√©ressant ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons maintenant! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre classe de test s'appelle DBTest, cr√©ez un objet statique pour cela - db</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db; [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AA0_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√áa marche! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais quelque chose est stupide de num√©roter des m√©thodes comme √ßa. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a une solution! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attributs de test sp√©ciaux! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le projet de test, cr√©ez une nouvelle classe appel√©e DBTestBase et h√©ritez de notre classe DBTest. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De DBTest, vous devez tout supprimer sauf:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span>:<span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [ClassCleanup] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le contenu de la classe DBTestBase: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once before the test run. (Optional) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [AssemblyInitialize] public static void AssemblyInit(TestContext context) { db = new HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes before this class creation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [ClassInitialize] public static void TestFixtureSetup(TestContext context) { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes Before each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestInitialize] public void Setup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once after the test run </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [AssemblyCleanup] public static void AssemblyCleanup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Runs once after all tests in this class are executed. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Not guaranteed that it executes instantly after all tests from the class. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [ClassCleanup] public static void TestFixtureTearDown() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes after each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestCleanup] public void TearDown() { //db.Database.EnsureDeleted();//don`t call! delete database instead of tables! } } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, tout est clair! </font><font style="vertical-align: inherit;">Notre base de donn√©es est cr√©√©e en tant que partie statique de la classe DBTestBase, et est donc accessible √† toutes les classes h√©rit√©es d'elle. </font><font style="vertical-align: inherit;">Cela signifie que la base de donn√©es n'est cr√©√©e qu'une seule fois - lors du d√©marrage des tests. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez l'attribut [ClassCleanup] √† n'importe quelle m√©thode de n'importe quelle classe - et obtenez un test "plus propre" - une telle fonction qui fera quelque chose une fois tous les tests de cette classe termin√©s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, il supprimera toutes les tables cr√©√©es dans ce test sans toucher √† la base de donn√©es elle-m√™me.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtant donn√© que toutes ces fonctions sp√©ciales sont exclues des m√©triques, nous pouvons voir le temps de nettoyage pour lequel nos fonctions fonctionnent - nous ajoutons quelques objets √† gauche et nous constatons une forte augmentation du temps de travail de la fonction de s√©lection - cela signifie que quelque chose ne va pas avec nos fonctions DAL, et si vous testez une fonction dans une m√©thode de test, il sera imm√©diatement clair o√π se trouve le probl√®me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez √©galement cr√©er des listes de lecture √† partir de fonctions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela est n√©cessaire pour, par exemple, appeler la fonction de pr√©paration des donn√©es (uniquement √† des fins de test). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, la fonction DAL met √† jour ces donn√©es, puis une autre fonction DAL, qui, par exemple, r√©fl√©chit ou affiche un rapport √† partir de ces donn√©es, puis supprime ces donn√©es. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainsi, nous pouvons imiter certaines actions des utilisateurs √† partir de processus m√©tier r√©els.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La principale chose √† retenir est qu'en dehors de ces attributs de test, les tests sont appel√©s par ordre alphab√©tique. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, si vous avez besoin d'une sorte de s√©quence statique, vous devez l'appeler ainsi: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T1_AddPhone_Test, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T2_RemovePhone_Test, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc. ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, maintenant, vous ne pouvez pas vous soucier de notre base de donn√©es - tout sera test√© dans son int√©gralit√©! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et maintenant il est temps de dormir! J'y ai encore une fille non test√©e ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test r√©ussi! Salut tout le monde! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet de r√©f√©rentiel git: </font></font><a href="https://github.com/3263927/Habr_1" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/3263927/Habr_1</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcrivez dans les commentaires si ce sujet est int√©ressant, je r√©digerai un article sur le test d'identit√©, les r√¥les, les revendications, l'authentification 3D et l'√©criture de mon TypeFilterAttribute (car le standard met en cache et si vous supprimez une personne du r√¥le, il aura toujours ce r√¥le jusqu'√† ce qu'il se marie. Et LE MARIAGE NE SERA PAS AVANT D'√äTRE TEST√â!: /) </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je peux d√©j√†, j'ai r√©ussi le test</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ek/8u/bl/ek8ublhenuarw7809onfz2l_nx4.jpeg" alt="image"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481474/">https://habr.com/ru/post/fr481474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481460/index.html">Messagerie -> PubSub dans OTP</a></li>
<li><a href="../fr481462/index.html">L'histoire des logiciels √©ducatifs: le d√©veloppement des ordinateurs personnels et des enseignants virtuels</a></li>
<li><a href="../fr481466/index.html">Comment construire des projets dans Jenkins, si vous avez besoin de beaucoup d'environnements diff√©rents</a></li>
<li><a href="../fr481470/index.html">Guirlande intelligente pour toute l'ann√©e</a></li>
<li><a href="../fr481472/index.html">Historique DNS: quand les noms de domaine sont pay√©s</a></li>
<li><a href="../fr481476/index.html">Comment j'ai commenc√© √† parler lors de conf√©rences et je ne peux pas m'arr√™ter</a></li>
<li><a href="../fr481478/index.html">STM32 + CMSIS + STM32CubeIDE</a></li>
<li><a href="../fr481480/index.html">C'est la norme: quelles sont les cartes normales et comment fonctionnent-elles</a></li>
<li><a href="../fr481482/index.html">Publication crois√©e sur une page Facebook √† l'aide du SDK PHP</a></li>
<li><a href="../fr481484/index.html">L'IA essayant d'√©viter les probl√®mes a appris un comportement complexe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>