<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇🏻 🥞 🧤 使用DBMS_SQL的SQL至CSV 🧚 ⛪️ 🖖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="通常，在解决系统集成问题时，有必要以一种或另一种格式显示一定数量的数据。 同时，任何人都可以成为数据使用者，但源几乎总是公司数据库。 例如，制造商可能要求供应商以XLSX或XML格式等定期报告其货物的移动。 

 有许多用于将数据转换为各种格式的工具，其使用的可能性取决于企业采用的技术堆栈和软件体系...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用DBMS_SQL的SQL至CSV</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448774/"> 通常，在解决系统集成问题时，有必要以一种或另一种格式显示一定数量的数据。 同时，任何人都可以成为数据使用者，但源几乎总是公司数据库。 例如，制造商可能要求供应商以XLSX或XML格式等定期报告其货物的移动。 <br><br> 有许多用于将数据转换为各种格式的工具，其使用的可能性取决于企业采用的技术堆栈和软件体系结构。 同时，您始终希望由用于转换源数据的各种库，框架和系统层组成的链尽可能短。 这将减少开发解决方案所花费的时间并提高其生产效率。 <br><br> 如果实际上我们假设SQL查询位于数据选择过程的根源，那么理想的情况是希望使用转换链来查看此情况： <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup><mo>=</mo><mi>f</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF08;</mo></mrow><mi>S</mi><mi>Q</mi><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF08;</mo></mrow><mi>d</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF09;</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF09;</mo></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.127ex" height="2.66ex" viewBox="0 -883.9 8665.7 1145.2" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-66" x="2153" y="0"></use><g transform="translate(2703,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">（</text></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-53" x="3533" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-51" x="4179" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-4C" x="4970" y="0"></use><g transform="translate(5652,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">（</text></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-64" x="6482" y="0"></use><g transform="translate(7005,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">）</text></g><g transform="translate(7835,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">）</text></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>d</mi><mo>′</mo></msup><mo>=</mo><mi>f</mi><mrow class="MJX-TeXAtom-ORD"><mo>（</mo></mrow><mi>S</mi><mi>Q</mi><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mo>（</mo></mrow><mi>d</mi><mrow class="MJX-TeXAtom-ORD"><mo>）</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo>）</mo></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d'= f（SQL（d））</script></p><br> 在哪里 <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.057ex" viewBox="0 -780.1 523.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-64" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> d </script>  -源数据， <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi><mi>Q</mi><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF08;</mo></mrow><mi>d</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>&amp;#xFF09;</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.992ex" height="2.419ex" viewBox="0 -780.1 4302 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-51" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-4C" x="1437" y="0"></use><g transform="translate(2118,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">（</text></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-64" x="2948" y="0"></use><g transform="translate(3471,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(51.874) matrix(1 0 0 -1 0 0)">）</text></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi><mi>Q</mi><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mo>（</mo></mrow><mi>d</mi><mrow class="MJX-TeXAtom-ORD"><mo>）</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-3"> SQL（d）</script>  -SQL查询以检索数据， <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.419ex" viewBox="0 -780.1 550.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-66" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> f </script>  -将选择内容转换为所需格式的功能， <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhgkY7hwp0VOD9OQ_jMiR7xFm6MkCw#MJMAIN-2032" x="741" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>d</mi><mo>′</mo></msup></math></span></span><script type="math/tex" id="MathJax-Element-5"> d'</script>  -所需格式的数据。 <br><br> 对于Oracle PL / SQL，有许多内置的和第三方的软件包可以实现此功能。 这些是DBMS_XMLGEN，DBMS_XMLQUERY，AS_XLSX，PL / JSON等。 <br><br> 但是，由于某种原因出现了将数据转换为CSV格式的问题时，没有现成的解决方案。 我必须自己做，然后将演示如何操作。 <a name="habracut"></a><br><br> 问题陈述 <br><br> 创建一个工具（PL / SQL程序包），该工具在输入端接收任意SELECT查询作为字符串或光标变量，然后在输出处返回CLOB类型的对象，该对象将数据封装为CSV格式。 如有任何错误，应返回NULL。  CSV格式本身不需要表示-这些是字符串，其元素由某些字符（通常为“;”）分隔，但是在一般情况下，任意字符都可以充当分隔符。 假定使用字符0x0D + 0x0A分隔字符串。  CSV文件中的第一行通常是标题，并定义列名称。 <br><br> 定义包接口 <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br> 有两个重载过程，它们之间的区别在于，其中一个重载过程以字符串形式接收请求，而另一个重载为指向游标的链接。 第二个参数是输出；这是CLOB对象中所需的结果。 最后，第三个参数是CSV分隔符。 <br><br> 在执行这些过程时，内置的DBMS_SQL包将为我们提供帮助，这使得我们可以在事先不知道（在编译阶段）确切涉及选择多少列的情况下使用动态游标。 <br><br>  DBMS_SQL功能允许您动态解析和执行任意查询。 对于将请求接受为字符串的过程，将发生以下情况： <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br> 对于使用游标变量的过程，一切都变得更加简单-从Oracle的第11版开始，“游标变量→SQL游标编号”转换已可用。 <br><br>  DBMS_SQL.TO_CURSOR_NUMBER函数将REFCURSOR变量（强类型或弱类型）转换为SQL游标号，然后可以将其传递给DBMS_SQL例程。 在这种情况下，游标变量必须先打开，然后再传递给DBMS_SQL.TO_CURSOR_NUMBER函数。 <br><br><pre> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br> 因此，这两个版本的调用都归结为获得动态光标和相关数据集的编号。 下一步是获取有关此集合列的信息，并提取数据本身。 <br><br>  DMBS_SQL包允许您描述动态游标的列，返回有关记录关联数组中每一列的信息。 <br><br> 为此，必须基于集合类型DBMS_SQL.DESC_TAB（如果查询可以返回长度超过30个字符的列，则为DESC_TAB2）声明PL / SQL集合。 之后，您可以使用收集方法遍历表并检索游标信息。 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br> 接下来，必须使用动态查询将所选的每一列的类型通知DBMS_SQL包。 这是通过调用DEFINE_COLUMN来完成的。 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br> 在第二个参数DEFINE_COLUMN中，传递了一个数字-列在列表中的顺序位置。 第三个参数设置游标列的数据类型。 它传递适当类型的表达式。 换句话说，不传递DBMS_SQL.DEFINE_COLUMN类型名称（例如“ VARCHAR2”）的字符串，而是传递类型VARCHAR2定义的变量。 <br><br> 在第四个参数中定义字符类型列时，必须指定可以加载到游标中的值的最大长度。 <br><br> 准备工作已完成，现在您可以创建标题行并开始提取数据。 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br> 使用DBMS_SQL.FETCH_ROWS以及随后对DBMS_SQL.COLUMN_VALUE的调用逐行检索数据，以获取各个列的值。 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br> 然后它仅用于收集生成的CSV <br><br><pre> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br> 处理错误 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br> 并关闭游标 <br><br><pre> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br> 套餐使用选项 <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br> 实际上，就是所有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">附带</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">源代码</a> 。 <br><br> 这本书对发展有帮助 <br>  Feuerstein S.，到达B。-Oracle PL / SQL。 对于专业人士。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN448774/">https://habr.com/ru/post/zh-CN448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN448762/index.html">Picaba暴动。 用户大量前往Reddit</a></li>
<li><a href="../zh-CN448764/index.html">在ATtiny13上观看</a></li>
<li><a href="../zh-CN448766/index.html">使用lerna＆yarn工作区创建一个单一存储库</a></li>
<li><a href="../zh-CN448768/index.html">多级照明控制：解决方案和产品的弹性</a></li>
<li><a href="../zh-CN448770/index.html">更新了Visual Studio Code中的Razor支持。 现在有了烈焰</a></li>
<li><a href="../zh-CN448776/index.html">RxVMS-适用于Flutter应用程序的实用架构</a></li>
<li><a href="../zh-CN448778/index.html">为Visual Studio Enterprise 2019引入时间旅行调试</a></li>
<li><a href="../zh-CN448780/index.html">什么使软件可以赚钱</a></li>
<li><a href="../zh-CN448782/index.html">使用pytest进行Python测试。 pytest入门，第1章</a></li>
<li><a href="../zh-CN448786/index.html">使用pytest进行Python测试。 第3章pytest固定装置</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>