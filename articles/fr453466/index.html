<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêΩ üå©Ô∏è üë©üèæ‚Äçüî¨ HolyJS 2019: d√©briefing de SEMrush (Partie 2) ü§±üèΩ üë®üèø üßëüèæ‚Äçü§ù‚Äçüßëüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit de la deuxi√®me partie de l'analyse des t√¢ches de notre stand lors de la conf√©rence HolyJS , tenue √† Saint-P√©tersbourg du 24 au 25 mai. Pour ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HolyJS 2019: d√©briefing de SEMrush (Partie 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/453466/"><img src="https://habrastorage.org/webt/lu/af/0g/luaf0gd14raqav4knnokeboltkk.jpeg"><br><br>  Il s'agit de la deuxi√®me partie de l'analyse des t√¢ches de notre stand lors de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HolyJS</a> , tenue √† Saint-P√©tersbourg du 24 au 25 mai.  Pour plus de contexte, il est recommand√© de lire d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">abord</a> la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re partie de</a> ce document.  Et si l' <i>expression du</i> compte √† <i>rebours</i> est d√©j√† termin√©e, bienvenue √† l'√©tape suivante. <br><a name="habracut"></a><br>  Contrairement √† l'obscurantisme dans la premi√®re t√¢che, les deux suivantes ont d√©j√† une id√©e de l'applicabilit√© des applications normales dans la vie.  JavaScript se d√©veloppe encore assez rapidement et les solutions aux probl√®mes sugg√©r√©s mettent en √©vidence certaines des nouvelles fonctionnalit√©s du langage. <br><br><h2>  T√¢che 2 ~ effectu√©e par les uns </h2><br>  Il a √©t√© suppos√© que le code s'ex√©cuterait et imprimerait les r√©ponses √† la console en r√©ponse √† trois demandes, puis ¬´termin√©¬ª.  Mais quelque chose s'est mal pass√© ... Corrigez la situation. <br><br><pre><code class="javascript hljs">;(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iter = { [<span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>.iterator]: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fs = [<span class="hljs-string"><span class="hljs-string">'/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'/3'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> fetch(req); } } }; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iter) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(res); } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>); })();</code> </pre> <br><h4>  Probl√®me de recherche </h4><br>  Qu'avons-nous ici?  Il s'agit d'un objet <i>iter</i> <i>it√©rable</i> qui a un symbole <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>Symbol.iterator</i></a> <i>bien connu</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>d√©fini</i></a> par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une fonction de g√©n√©rateur</a> .  Un tableau <i>fs est</i> d√©clar√© dans le corps de la fonction, dont les √©l√©ments tombent dans la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>fetch</i></a> √† leur tour pour envoyer une requ√™te et le r√©sultat de chaque appel de fonction est retourn√© via <i>yield</i> .  Quelles demandes la fonction d' <i>extraction</i> envoie-t-elle?  Tous les √©l√©ments du tableau <i>fs</i> sont des chemins relatifs vers les ressources avec les nombres 1, 2 et 3, respectivement.  Ainsi, l'URL compl√®te sera obtenue en concat√©nant <i>location.origin</i> avec le num√©ro suivant, par exemple: <br><br> <code>GET https://www.example.com/1 <br></code> <br>  Ensuite, nous voulons it√©rer l'objet <i>iter √†</i> travers <i>for-of</i> , afin d'ex√©cuter chaque demande tour √† tour avec la sortie du r√©sultat, apr√®s tout - imprimer ¬´done¬ª.  Mais √ßa ne marche pas!  Le probl√®me est que l' <i>extraction</i> est une chose asynchrone et renvoie une promesse, pas une r√©ponse.  Par cons√©quent, dans la console, nous verrons quelque chose comme ceci: <br><br> <code>Promise {pending} <br> Promise {pending} <br> Promise {pending} <br> done <br></code> <br>  En fait, la t√¢che se r√©sume √† la r√©alisation de ces m√™mes promesses. <br><br><h4>  Nous avons asynchrone / attend </h4><br>  La premi√®re pens√©e peut √™tre de jouer avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>Promise.all</i></a> : donnez-lui notre objet <i>it√©rable</i> , <i>puis la</i> sortie vers la console est ¬´termin√©e¬ª.  Mais il ne nous fournira pas l'ex√©cution s√©quentielle des demandes (comme l'exige la condition), mais les enverra simplement toutes et attendra la derni√®re r√©ponse avant la r√©solution g√©n√©rale. <br><br>  La solution la plus simple ici serait d' <i>attendre</i> dans le <i>for-of</i> body d'attendre la r√©solution de la prochaine promesse avant de sortir sur la console: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iter) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> res); }</code> </pre><br>  Pour <i>attendre que cela</i> fonctionne et que "done" soit affich√© √† la fin, vous devez rendre la fonction principale asynchrone via <i>async</i> : <br><br><pre> <code class="javascript hljs">;(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iter = { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iter) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> res); } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>); })();</code> </pre><br>  Dans ce cas, le probl√®me a d√©j√† √©t√© r√©solu (presque): <br><br> <code>GET 1st <br> Response 1st <br> GET 2nd <br> Response 2nd <br> GET 3rd <br> Response 3rd <br> done <br></code> <br><h4>  It√©rateur et g√©n√©rateur asynchrones </h4><br>  Nous laisserons la fonction principale asynchrone, mais pour <i>wait</i> il y a une place plus √©l√©gante dans cette t√¢che que dans le corps <i>for-of</i> : c'est l'utilisation de l'it√©ration asynchrone via <a href=""><i>for-wait-of</i></a> , √† savoir: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iter) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(res); }</code> </pre><br>  Tout fonctionnera!  Mais si vous passez √† la description de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette <i>proposition</i></a> sur l'it√©ration asynchrone, voici ce qui est int√©ressant: <br><br><blockquote>  Nous introduisons une variation de l'instruction d'it√©ration for-of qui it√®re sur les objets it√©rables asynchrones.  Les instructions for-of asynchrones ne sont autoris√©es que dans les fonctions asynchrones et les fonctions du g√©n√©rateur asynchrone </blockquote><br>  Autrement dit, notre objet doit √™tre non seulement <i>it√©rable</i> , mais <i>¬´asyncIterable¬ª</i> via le nouveau symbole <i>bien connu</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>Symbol.asyncIterator</i></a> et, dans notre cas, d√©j√† une fonction de g√©n√©rateur asynchrone: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iter = { [<span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>.asyncIterator]: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fs = [<span class="hljs-string"><span class="hljs-string">'/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'/3'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(req); } } };</code> </pre><br>  Comment cela fonctionne-t-il alors sur un it√©rateur et un g√©n√©rateur r√©guliers?  Oui, juste implicitement, comme beaucoup plus dans cette langue.  Cette <i>attente</i> est d√©licate: si l'objet est seulement <i>it√©rable</i> , alors pendant l'it√©ration asynchrone, il "convertit" l'objet en <i>asyncIterable</i> en <i>encapsulant</i> les √©l√©ments (si n√©cessaire) dans <i>Promise</i> avec l'attente de r√©solution.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©crit</a> plus en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans l'article</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Axel Rauschmayer</a> . <br><br>  Probablement, gr√¢ce √† <i>Symbol.asyncIterator,</i> ce sera toujours plus correct, car nous avons explicitement cr√©√© l'objet <i>asyncIterable</i> pour notre it√©ration asynchrone via <i>for-wait-of</i> , tout en laissant la possibilit√© de compl√©ter l'objet avec un it√©rateur r√©gulier pour <i>for</i> <i>of</i> , si n√©cessaire.  Si vous voulez lire quelque chose d'utile et suffisant dans un article sur les it√©rations asynchrones en JavaScript, alors le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici</a> ! <br><br>  Le <i>for-of</i> asynchrone est encore partiellement en projet, mais il est d√©j√† pris en charge par les navigateurs modernes (sauf Edge) et Node.js √† partir de 10.x.  Si cela d√©range quelqu'un, vous pouvez toujours √©crire votre propre petit polyphile pour une cha√Æne de promesses, par exemple, pour un objet <i>it√©rable</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chain = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promises, callback</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">it</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = it.next(); i.done ? resolve() : i.value.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> { callback(res); next(it); }); }(promises[<span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>.iterator]()) ); ;(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iter = { <span class="hljs-comment"><span class="hljs-comment">/* iterable */</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> chain(iter, <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>); })();</code> </pre><br>  De cette mani√®re et de ces fa√ßons, nous avons compris l'envoi des demandes et le traitement des r√©ponses √† leur tour.  Mais dans ce probl√®me, il y a un autre probl√®me petit mais ennuyeux ... <br><br><h4>  Test de pleine conscience </h4><br>  Nous √©tions tellement emport√©s par tout cet asynchronisme que, comme cela arrive souvent, nous avons perdu de vue un petit d√©tail.  Ces demandes sont-elles envoy√©es par notre script?  Voyons le <i>r√©seau</i> : <br><br> <code>GET https://www.example.com/0 <br> GET https://www.example.com/1 <br> GET https://www.example.com/2 <br></code> <br>  Mais nos nombres sont 1, 2, 3. Comme si une d√©cr√©mentation s'√©tait produite.  Pourquoi  Juste dans le code source de la t√¢che, il y a un autre probl√®me avec l'it√©ration, ici: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fs = [<span class="hljs-string"><span class="hljs-string">'/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'/3'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> fetch(req); }</code> </pre><br>  Ici, un <i>for-in est utilis√©</i> , qui au lieu des valeurs de tableau contourne ses propri√©t√©s √©num√©r√©es: et ce sont les indices des √©l√©ments de 0 √† 2. La fonction <i>fetch</i> les m√®ne toujours √† des cha√Ænes et, malgr√© l'absence de barre oblique avant (ce n'est plus un <i>chemin</i> ), elle r√©sout relativement URL de la page actuelle.  Il est beaucoup plus facile de r√©parer que de remarquer.  Deux options: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fs = [<span class="hljs-string"><span class="hljs-string">'/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'/3'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> fs) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> fetch(req); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fs = [<span class="hljs-string"><span class="hljs-string">'/1'</span></span>, <span class="hljs-string"><span class="hljs-string">'/2'</span></span>, <span class="hljs-string"><span class="hljs-string">'/3'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> req <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> fetch(fs[req]); }</code> </pre><br>  Dans le premier, nous avons utilis√© le m√™me <i>for-of</i> pour parcourir les valeurs du tableau, dans le second - acc√®s √† l'√©l√©ment du tableau par index. <br><br><h4>  La motivation </h4><br>  Nous avons envisag√© 3 solutions: 1) par <i>attente</i> dans le corps <i>de for</i> , 2) par <i>attente de,</i> et 3) par le biais de notre polyfichier (fonction r√©cursive, <i>pipeline de</i> canalisation, etc.).  Il est curieux que ces options aient divis√© les participants √† la conf√©rence √† peu pr√®s √©galement et aucun favori √©vident n'a √©t√© r√©v√©l√©.  Dans les grands projets, pour de telles t√¢ches r√©elles, une biblioth√®que r√©active (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxJS</a> ) est g√©n√©ralement utilis√©e, mais il convient de se rappeler des fonctionnalit√©s natives modernes d'un langage √† caract√®re asynchrone. <br><br>  Environ la moiti√© des participants n'ont pas remarqu√© d'erreurs dans l'it√©ration de la liste des ressources, ce qui est √©galement une observation int√©ressante.  En nous concentrant sur un probl√®me non trivial mais √©vident, nous pouvons facilement ignorer cette apparence insignifiante, mais avec de graves cons√©quences potentielles. <br><br><h2>  Probl√®me 3 ~ Facteur 19 </h2><br>  Combien de fois dans le record du nombre 2019!  (factorielle √† partir de 2019) le nombre 19 se produit-il?  Avec la r√©ponse, fournissez une solution JavaScript. <br><br><h4>  Probl√®me de recherche </h4><br>  Le probl√®me est en surface: nous avons besoin d'un enregistrement d'un tr√®s grand nombre pour y trouver le nombre de toutes les occurrences de la sous-cha√Æne ¬´19¬ª.  R√©solvant le probl√®me sur les <i>nombres</i> , nous avons tr√®s rapidement rencontr√© <i>Infinity</i> (apr√®s 170) et n'avons rien obtenu.  De plus, le format de repr√©sentation des nombres <i>float64</i> garantit l'exactitude de seulement 15-17 caract√®res, et nous devons obtenir non seulement un enregistrement complet, mais aussi pr√©cis du nombre.  La principale difficult√© est donc de d√©terminer la structure d'accumulation de ce grand nombre. <br><br><h4>  Grands entiers </h4><br>  Si vous suivez les innovations du langage, la t√¢che est r√©solue simplement: au lieu du <i>num√©ro de</i> type <i>,</i> vous pouvez utiliser le nouveau type <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>BigInt</i> (√©tape 3)</a> , qui vous permet de travailler avec des nombres de pr√©cision arbitraires.  Avec la fonction r√©cursive classique pour le calcul factoriel et la recherche de correspondances via <i>String.prototype.split, la</i> premi√®re solution ressemble √† ceci: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fn = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function"> =&gt;</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>n ? n * fn(n - <span class="hljs-number"><span class="hljs-number">1</span></span>n) : <span class="hljs-number"><span class="hljs-number">1</span></span>n; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(fn(<span class="hljs-number"><span class="hljs-number">2019</span></span>n).toString().split(<span class="hljs-string"><span class="hljs-string">'19'</span></span>).length - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 50</span></span></code> </pre><br>  Cependant, deux mille appels de fonction sur la pile peuvent d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√™tre dangereux</a> .  M√™me si vous apportez la solution √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©cursivit√© de la queue</a> , l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>optimisation des appels de queue</i></a> ne prend toujours en charge que Safari.  Le probl√®me factoriel est ici plus agr√©able √† r√©soudre √† travers un cycle arithm√©tique ou <i>Array.prototype.reduce</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log([...Array(<span class="hljs-number"><span class="hljs-number">2019</span></span>)].reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p, _, i</span></span></span><span class="hljs-function">) =&gt;</span></span> p * BigInt(i + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>n).toString().match(<span class="hljs-regexp"><span class="hljs-regexp">/19/g</span></span>).length); <span class="hljs-comment"><span class="hljs-comment">// 50</span></span></code> </pre><br>  Cela peut sembler une proc√©dure incroyablement longue.  Mais cette impression est trompeuse.  Si vous estimez, nous avons juste besoin de d√©penser un peu plus de deux mille multiplications.  √Ä i5-4590 3,30 GHz en chrome, le probl√®me est r√©solu en moyenne en 4-5 ms (!). <br><br>  Une autre option pour rechercher des correspondances dans une cha√Æne avec le r√©sultat d'un calcul est <i>String.prototype.match</i> par expression r√©guli√®re avec l'indicateur de recherche globale: <i>/ 19 / g</i> . <br><br><h4>  Grande arithm√©tique </h4><br>  Mais que se passe-t-il si nous n'avons pas encore ce <i>BigInt</i> (et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®ques</a> aussi)?  Dans ce cas, vous pouvez faire vous-m√™me la longue arithm√©tique.  Pour r√©soudre le probl√®me, il nous suffit d'impl√©menter uniquement la fonction de multiplier grand par petit (nous multiplions par des nombres de 1 √† 2019).  Nous pouvons contenir un grand nombre et le r√©sultat de la multiplication, par exemple, dans la ligne: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @param {string} big * @param {number} int * @returns {string} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mult = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">big, int</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = <span class="hljs-string"><span class="hljs-string">''</span></span>, carry = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = big.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i -= <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> prod = big[i] * int + carry; res = prod % <span class="hljs-number"><span class="hljs-number">10</span></span> + res; carry = prod / <span class="hljs-number"><span class="hljs-number">10</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">carry || </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span></span><span class="hljs-function">) + </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">console</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">log</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[...</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2019</span></span></span></span></span><span class="hljs-function">)].</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reduce</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, _, i</span></span></span><span class="hljs-function">) =&gt;</span></span> mult(p, i + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">'1'</span></span>).match(<span class="hljs-regexp"><span class="hljs-regexp">/19/g</span></span>).length); <span class="hljs-comment"><span class="hljs-comment">// 50</span></span></code> </pre><br>  Ici, nous multiplions simplement la colonne en bits de la fin de la ligne au d√©but, comme on nous l'a enseign√© √† l'√©cole.  Mais la solution n√©cessite d√©j√† environ 170 ms. <br><br>  Nous pouvons quelque peu am√©liorer l'algorithme en traitant plus d'un chiffre dans un enregistrement num√©rique √† la fois.  Pour ce faire, nous modifions la fonction et en m√™me temps allons dans les tableaux, afin de ne pas d√©ranger les lignes √† chaque fois: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @param {Array&lt;number&gt;} big * @param {number} int * @param {number} digits * @returns {Array&lt;number&gt;} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mult = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">big, int, digits = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = [], carry = <span class="hljs-number"><span class="hljs-number">0</span></span>, div = <span class="hljs-number"><span class="hljs-number">10</span></span> ** digits; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = big.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> || carry; i -= <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> prod = (i &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : big[i] * int) + carry; res.push(prod % div); carry = prod / div | <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.reverse(); }</code> </pre><br>  Ici, les grands nombres sont repr√©sent√©s par un tableau, dont chaque √©l√©ment stocke des informations sur les <i>chiffres</i> chiffres de l'enregistrement num√©rique, √† l'aide de <i>nombre</i> .  Par exemple, le nombre 2016201720182019 avec <i>chiffres</i> = 3 sera repr√©sent√© comme: <br><br> <code>'2|016|201|720|182|019' =&gt; [2,16,201,720,182,19] <br></code> <br>  Lors de la conversion en ligne avant une jointure, vous devez vous souvenir des z√©ros non significatifs.  La fonction <i>facteur</i> renvoie la factorielle calcul√©e par une cha√Æne, en utilisant la fonction <i>mult</i> avec le nombre sp√©cifi√© de chiffres trait√©s √† la fois dans la repr√©sentation "massive" du nombre lors du calcul: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> factor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n, digits = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">) =&gt;</span></span> [...Array(n)].reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p, _, i</span></span></span><span class="hljs-function">) =&gt;</span></span> mult(p, i + <span class="hljs-number"><span class="hljs-number">1</span></span>, digits), [<span class="hljs-number"><span class="hljs-number">1</span></span>]) .map(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">el</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>.repeat(digits - el.length) + el) .join(<span class="hljs-string"><span class="hljs-string">''</span></span>) .replace(<span class="hljs-regexp"><span class="hljs-regexp">/^0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(factor(<span class="hljs-number"><span class="hljs-number">2019</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>).match(<span class="hljs-regexp"><span class="hljs-regexp">/19/g</span></span>).length); <span class="hljs-comment"><span class="hljs-comment">// 50</span></span></code> </pre><br>  L'impl√©mentation ¬´√† longueur de genou¬ª via des tableaux s'est av√©r√©e plus rapide que via des cha√Ænes, et avec des <i>chiffres</i> = 1, il calcule la r√©ponse d√©j√† en moyenne en 90 ms, <i>chiffres</i> = 3 en 35 ms, <i>chiffres</i> = 6 en seulement 20 ms.  Cependant, rappelez-vous qu'en augmentant le nombre de chiffres, nous approchons d'une situation o√π la multiplication de <i>nombre</i> par <i>nombre</i> "sous le capot" peut √™tre en dehors du coffre-fort <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i>MAX_SAFE_INTEGER</i></a> .  Vous pouvez jouer avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Quelle est la valeur maximale de <i>chiffres</i> que nous pouvons nous permettre pour cette t√¢che? <br><br>  Les r√©sultats sont d√©j√† assez indicatifs, <i>BigInt</i> est vraiment assez rapide: <br><br><img src="https://habrastorage.org/webt/qq/wb/-j/qqwb-jhmypgogtk94bg-pqnrxhy.png"><br><br><h4>  La motivation </h4><br>  C'est cool que 2/3 des participants √† la conf√©rence <i>aient</i> utilis√© le nouveau type <i>BigInt</i> dans la solution (quelqu'un a admis que c'√©tait la premi√®re exp√©rience).  Le tiers restant des solutions contenait leurs propres impl√©mentations d'arithm√©tique longue sur des cha√Ænes ou des tableaux.  La plupart des fonctions impl√©ment√©es multipliaient de grands nombres par de grandes, alors que pour une solution, il suffisait de se multiplier par un "petit" <i>nombre</i> et de passer un peu moins de temps.  D'accord, utilisez-vous d√©j√† <i>BigInt</i> dans vos projets? <br><br><h2>  Remerciements </h2><br>  Ces deux jours de conf√©rence ont √©t√© tr√®s charg√©s de discussions et d'apprentissage de quelque chose de nouveau.  Je remercie le comit√© de programme pour la prochaine conf√©rence inoubliable et tous les participants pour leur r√©seautage unique et leur bonne humeur. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453466/">https://habr.com/ru/post/fr453466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453454/index.html">Radio d√©finie par logiciel - comment √ßa marche? Partie 5</a></li>
<li><a href="../fr453456/index.html">Fonctionnement de la localisation dans Netflix - traduction</a></li>
<li><a href="../fr453458/index.html">V√©ritable programmation r√©active dans Svelte 3.0</a></li>
<li><a href="../fr453460/index.html">Quand je suis fatigu√© du virtuel</a></li>
<li><a href="../fr453464/index.html">Futur quantique (suite)</a></li>
<li><a href="../fr453468/index.html">L'√©volution des applications Web Java</a></li>
<li><a href="../fr453470/index.html">Vos monolithes distribu√©s complotent derri√®re vous</a></li>
<li><a href="../fr453472/index.html">V√©lo √† partir du moniteur d'√©nergie PZEM004T et ESP8266, avec People's Monitoring</a></li>
<li><a href="../fr453474/index.html">Contr√¥lez un ordinateur via la t√©l√©commande d'un amplificateur √† l'aide d'Arduino et de Node.js</a></li>
<li><a href="../fr453478/index.html">Nous √©tudions la sant√© des satellites Starlink Ilona Mask</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>