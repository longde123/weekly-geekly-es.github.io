<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ–Šï¸ ğŸ¤ âœ‹ TabPy pour travailler avec des donnÃ©es dans ClickHouse de Tableau ğŸ˜¿ âš—ï¸ ğŸ¤º</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DÃ©velopper la communication entre les marques et les gens est ce que nous faisons quotidiennement chez Dentsu Aegis Network, et l'analyse des donnÃ©es ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TabPy pour travailler avec des donnÃ©es dans ClickHouse de Tableau</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dentsuaegisnetworkrussia/blog/477864/">  DÃ©velopper la communication entre les marques et les gens est ce que nous faisons quotidiennement chez Dentsu Aegis Network, et l'analyse des donnÃ©es fait partie intÃ©grante de ce travail.  Dans certains cas, ce processus ne nÃ©cessite pas de science des donnÃ©es (bien que nous en ayons un), nous utilisons alors la plateforme <a href="https://en.wikipedia.org/wiki/Tableau_Software">Tableau</a> BI.  Son objectif principal est de fournir Ã  nos employÃ©s et clients une interface pratique pour la consommation de donnÃ©es sans Ã©crire de scripts, de requÃªtes SQL, etc. <br><br>  Dans cet article, nous dÃ©crirons comment nous avons rÃ©ussi Ã  rÃ©soudre le problÃ¨me d'interaction de Tableau avec <a href="https://ru.wikipedia.org/wiki/ClickHouse">ClickHouse</a> . <br><a name="habracut"></a><br><h3>  Ã‰noncÃ© gÃ©nÃ©ral du problÃ¨me </h3><br>  Nous avons fait face Ã  un dÃ©fi classique.  Nous avons des gens.  Ils aiment les fruits.  Certaines personnes aiment un fruit, d'autres comme tous les fruits, et les autres peuvent aimer n'importe quelle combinaison de fruits. <br><img src="https://habrastorage.org/webt/lb/wp/om/lbwpomzrluk4hed_uihmxiko_xy.png" alt="image"><br>  Il est donc nÃ©cessaire de permettre Ã  l'utilisateur du tableau de bord intÃ©grÃ© Ã  Tableau de sÃ©lectionner arbitrairement plusieurs fruits et de voir combien de personnes aiment au moins un fruit de l'ensemble.  Bien sÃ»r, nous n'avions pas de fruits, mais les gens Ã©taient rÃ©els, c'est juste que sur les Â«fruitsÂ», il est plus facile de comprendre le problÃ¨me. <br><br>  La quantitÃ© de donnÃ©es dans notre cas est assez importante.  Il y avait 13 mille Â«fruitsÂ» diffÃ©rents.  Le Â«fruitÂ» le plus populaire comptait prÃ¨s de 34 millions de fans.  En moyenne, 450 000 personnes aiment chaque Â«fruitÂ».  Total des amateurs de fruits - 282 millions. <br><br><h3>  PremiÃ¨re solution frontale </h3><br>  Il se trouve que les donnÃ©es de cette tÃ¢che que nous avions dans <a href="https://ru.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> (PG) et ClickHouse (CH).  En PG, il y avait un tableau de rÃ©fÃ©rence sur les Â«fruitsÂ», en CH - un grand tableau avec une structure: l'identifiant du Â«fruitÂ» et l'identifiant de la personne qui aime ce Â«fruitÂ».  Il n'y a pas de connecteur natif pour CH dans Tableau, et je ne voulais toujours pas transfÃ©rer les donnÃ©es quelque part, car cela nÃ©cessiterait une refonte sÃ©rieuse du systÃ¨me existant. <br><br>  Nous avons essayÃ© de connecter Tableau Ã  CH Ã  l'aide du pilote ODBC et de voir ce qui se passe. <br><br><ul><li>  Tous les pilotes ODBC ne sont pas Ã©galement utiles.  Nous avons besoin d'une certaine version dans laquelle fonctionne la partie nÃ©cessaire de la fonctionnalitÃ©, mais rien ne garantit que le reste fonctionnera si vous en avez soudainement besoin. </li><li>  Nous n'avons pas pu extraire toutes les donnÃ©es dans l'extrait de Tableau, car il s'agit de 13 000 * 450 000 = 5 850 000 000 d'enregistrements. </li></ul><br>  Ensuite, nous avons dÃ©cidÃ© d'utiliser l'Ã©chantillonnage Ã  l'intÃ©rieur de la requÃªte vers la base de donnÃ©es CH, c'est-Ã -dire pour faire notre estimation du nombre d'amoureux de la combinaison de Â«fruitsÂ» sÃ©lectionnÃ©e non pas sur toutes les personnes, mais sur un Ã©chantillon de cinq pour cent pour rÃ©duire l'extrait.  De plus, nous avons immÃ©diatement effectuÃ© une extraction de jointure interne Ã  partir de CH avec un rÃ©pertoire PG Â«fruitÂ» pour obtenir les noms Â«fruitÂ».  Cela a aidÃ© - notre extrait a pu Ãªtre gÃ©nÃ©rÃ© en 5 heures. <br><br>  Nous devions mettre Ã  jour les donnÃ©es dans le tableau de bord une fois par jour, donc 5 heures de mise Ã  jour de l'extrait semblent Ãªtre correctes - nous mettrons Ã  jour la nuit.  Mais Ã  l'avenir, nous aurions besoin de capacitÃ©s supplÃ©mentaires: il devrait y avoir plus de Â«fruitsÂ»; en consÃ©quence, le nombre et la taille des groupes de personnes dont nous devions calculer l'intersection devrait Ã©galement augmenter.  Par consÃ©quent, une longue mise Ã  jour de l'extrait n'est pas du tout notre option. <br><br>  De plus, il y avait un autre problÃ¨me dÃ» Ã  l'Ã©chantillonnage.  Il se trouve que dans diffÃ©rentes parties du tableau de bord, les chiffres, qui devraient Ãªtre censÃ©s coÃ¯ncider, Ã©taient diffÃ©rents dans notre pays.  Cela Ã©tait dÃ» au fait qu'en un seul endroit, nous avons comptÃ© le nombre d'amoureux d'un fruit avec prÃ©cision, et en partie avec une combinaison de fruits - inexact.  Ni nous ni nos utilisateurs n'avons aimÃ© ce rÃ©sultat. <br><br>  Ensuite, nous avons dÃ©cidÃ© de ne pas crÃ©er d'extrait du tout.  Pour Ã©viter de charger une Ã©norme quantitÃ© de donnÃ©es, nous avons divisÃ© les ensembles de donnÃ©es et utilisÃ© la connexion en direct pour CH.  Entre les jeux de donnÃ©es, une connexion a Ã©tÃ© Ã©tablie Ã  l'aide de la fonctionnalitÃ© de relation Tableau Edit intÃ©grÃ©e.  La source de donnÃ©es PG a Ã©tÃ© rendue principale et liÃ©e Ã  CH comme secondaire, en utilisant l'identifiant Â«fruitÂ» qui Ã©tait dans les deux tableaux. <br><br>  Ainsi, nous avons pu filtrer la source de donnÃ©es secondaire en utilisant le primaire (mÃ©lange de donnÃ©es).  Mais nous nous attendions Ã  un Ã©chec, car aprÃ¨s avoir lancÃ© le filtre d'une source de donnÃ©es Ã  une autre, nous avons dÃ» utiliser la fonction de comptage des personnes dans le sous-ensemble rÃ©sultant (COUNTD), et le mÃ©lange de donnÃ©es a une limitation qui ne permet tout simplement pas de le faire.  Une telle fonction directement avec une telle connexion de donnÃ©es ne fonctionne pas en principe. <br><br>  Il existe une solution de contournement qui permet de contourner cette limitation de Tableau, mais elle peut Ãªtre utilisÃ©e sur des ensembles de donnÃ©es relativement petits, ce qui n'est clairement pas le cas dans notre cas. <br><br>  AprÃ¨s cela, nous avons essayÃ© une autre option.  Les ensembles de donnÃ©es Ã©taient toujours divisÃ©s et utilisaient une connexion en direct pour CH.  Ici, le filtre de l'ensemble de donnÃ©es avec la description de Â«fruitsÂ» Ã  l'ensemble de donnÃ©es avec des fans de Â«fruitsÂ» a Ã©tÃ© lancÃ© dans Tableau Ã  l'aide de l'action set.  Mais cette option ne convenait finalement pas en raison de l'interface utilisateur peu pratique.  Au lieu du filtre familier Ã  l'utilisateur, l'utilisateur devrait regarder la liste entiÃ¨re et sÃ©lectionner "fruits" via cntrl + clic, tandis que la fonction d'application Ã©tait absente lorsque toutes les valeurs sÃ©lectionnÃ©es sont appliquÃ©es en mÃªme temps. <br><br>  En consÃ©quence, aprÃ¨s toutes nos tentatives, nous avons dÃ» revenir Ã  l'option avec extrait et Ã©chantillonnage, terriblement lente et ne donnant qu'une rÃ©ponse approximative. <br><br><img src="https://habrastorage.org/webt/uh/5a/ie/uh5aiemfrjzz8f1wmeu54eg-flm.png" alt="image"><br><br><h3>  Solution trouvÃ©e </h3><br>  De toute Ã©vidence, nous n'avons pas besoin d'extraire toutes les donnÃ©es dans l'extrait de Tableau.  L'utilisateur est mal Ã  l'aise de voir toutes les donnÃ©es Ã  la fois - le nombre de personnes qui aiment tous les Â«fruitsÂ».  Il a besoin d'un ensemble d'une moyenne de 10 Â«fruitsÂ».  Il est dommage que Tableau ne sache pas comment procÃ©der. <br><br>  Il y a des gars dans notre Ã©quipe qui Ã©crivent en Python.  Par consÃ©quent, nous avons dÃ©cidÃ© dans notre recherche d'aller dans cette direction et <a href="https://github.com/tableau/TabPy">avons</a> trouvÃ© <a href="https://github.com/tableau/TabPy">TabPy</a> . <br><br>  TabPy est un service Web qui vous permet d'obtenir le rÃ©sultat de l'exÃ©cution de scripts Python dans Costing dans Tableau. <br><br>  Comment Ã§a marche: <br><br><ol><li>  Tableau interagit avec TabPy et, Ã  son tour, avec Python en utilisant les soi-disant fonctions de script.  Les fonctions de script contiennent le script Python lui-mÃªme, le type de donnÃ©es requis du rÃ©sultat et les arguments que nous transmettons Ã  cette fonction.  Dans notre cas, les arguments Ã©taient des identifiants de Â«fruitsÂ», le nombre d'amants dont nous voulions compter. </li><li>  TabPy convertit le texte reÃ§u des fonctions de script en script et le transmet Ã  l'interprÃ©teur.  La connexion Ã  la base CH a Ã©tÃ© enregistrÃ©e par nous dans le script. </li><li>  Ensuite, TabPy renvoie le rÃ©sultat du script exÃ©cutÃ© Ã  Tableau. </li></ol><br><br><img src="https://habrastorage.org/webt/a9/me/qi/a9meqia3hjlrx1niaje_fb5lfww.png" alt="image"><br><br>  Dans les fonctions de script, les arguments sont toujours transmis sous forme de tableaux; le rÃ©sultat est Ã©galement renvoyÃ© par un tableau. <br><br>  Tout n'a pas fonctionnÃ© tout de suite.  La principale chose que nous avons comprise: Ã©crire un script Python directement dans un champ calculÃ© dans Tableau n'est pas une bonne idÃ©e.  Pour deux raisons: <br><br><ol><li>  Dans les fonctions de script, il est parfois difficile d'utiliser la syntaxe Python familiÃ¨re.  Par exemple, plusieurs devis ne sont pas acceptÃ©s. </li><li>  En pensant Ã  la prise en charge future du tableau de bord, nous avons rÃ©alisÃ© que si nous devons changer le script d'une maniÃ¨re ou d'une autre, nous devrons Ã  chaque fois le changer dans le livre Tableau lui-mÃªme.  Et ce n'est clairement pas la meilleure faÃ§on, car nous faisons de notre mieux pour Ã©viter la prise en charge manuelle des tableaux de bord. </li></ol><br>  Par consÃ©quent, nous avons utilisÃ© une autre chose - <a href="">TabPy Client</a> . <br><br>  TabPy Client est une bibliothÃ¨que qui vous permet de publier des scripts Python sur le serveur TabPy, puis de les appeler dans Tableau.  Lorsque vous l'utilisez, au lieu d'Ã©crire un script dans Tableau, nous appelons le fichier .py se trouvant sur le serveur TabPy en utilisant les paramÃ¨tres qui y sont spÃ©cifiÃ©s, lui transmettons des arguments et l'exÃ©cutons. <br><br>  Cette approche a rÃ©solu nos problÃ¨mes en utilisant TabPy et Tableau.  Le script est Ã©crit et testÃ© dans l'environnement de dÃ©veloppement familier et stockÃ© sÃ©parÃ©ment du livre, qui ne nÃ©cessite dÃ©sormais plus de prise en charge manuelle. <br><br>  Pour rÃ©soudre notre problÃ¨me spÃ©cifique, nous avons dÃ» procÃ©der comme suit. <br>  Au dÃ©but, nous avons essayÃ© de le rÃ©soudre sans utiliser le client TabPy.  Dans ce cas, un champ de calcul du formulaire suivant a Ã©tÃ© crÃ©Ã© dans Tableau: <br><div class="scrollable-table"><table><tbody><tr><td>  SI PREMIER () == 0 <br>  ALORS <br>  SCRIPT_INT (" <br>  depuis le client d'importation clickhouse_driver <br>  client = Client (hÃ´te = nom_hÃ´te, base de donnÃ©es = nom_base de donnÃ©es, utilisateur = nom_utilisateur, mot de passe = mot de passe) <br><br>  ----- script_text ----- <br><br>  ", SUM ([people]), ATTR ([fruits_id])) <br>  Fin </td></tr></tbody></table></div>  Cela a fonctionnÃ©, mais il y avait des problÃ¨mes qui ont Ã©tÃ© dÃ©crits ci-dessus.  Lorsque nous avons compris le client TabPy, nous avons rÃ©alisÃ© qu'en divisant le champ Calcul et le script lui-mÃªme, nous obtenons un systÃ¨me plus pratique et correct.  Voici Ã  quoi ressemblaient le champ Calcul et le fichier .py avec le script: <br><div class="scrollable-table"><table><tbody><tr><td>  Champ de calcul </td><td>  SCRIPT_INT (" <br>  return tabpy.query ('people_count_test', _ arg1, _arg2) ['response'] <br>  ", SUM ([people]), ATTR ([fruits_id])) </td></tr><tr><td>  Fichier .py </td><td>  depuis le client d'importation clickhouse_driver <br>  importer tabpy_client <br>  connection = tabpy_client.Client ('http: // localhost: 9004 /') <br>  def unique_people_count (people, fruits_id): <br>  client = Client (hÃ´te = nom_hÃ´te, base de donnÃ©es = nom_base de donnÃ©es, utilisateur = nom_utilisateur, mot de passe = mot de passe) <br><br>  ----- script_text ----- <br><br>  connection.deploy ('people_count_test', unique_people_count, 'comment', override = True) </td></tr></tbody></table></div>  Ici, vous pouvez voir que 'people_count_test' est l'identifiant du client TabPy, grÃ¢ce auquel il est clair quel script exÃ©cuter dans ce champ de calcul. <br><br>  Et au final, c'est cette approche qui nous a totalement satisfaits. <br><br><img src="https://habrastorage.org/webt/ef/_k/g3/ef_kg3lc57jwo3zktnbxivckhro.png" alt="image"><br><br><h3>  RÃ©sumÃ© </h3><br>  Les utilisateurs sont satisfaits car ils peuvent choisir arbitrairement une combinaison de Â«fruitsÂ» et obtenir rapidement le nombre de fans d'au moins l'un d'entre eux, et les chiffres dans les diffÃ©rentes parties du tableau de bord sont les mÃªmes. <br><br>  Les dÃ©veloppeurs BI sont heureux que vous puissiez travailler avec ClickHouse de Tableau, sans avoir Ã  vous y connecter directement. <br><br>  Notre Tableau Server est heureux que vous n'ayez pas besoin de faire un Ã©norme extrait la nuit. <br><br>  En gÃ©nÃ©ral, TabPy donne aux dÃ©veloppeurs BI plus de libertÃ© pour travailler avec des donnÃ©es lorsque Tableau ne dispose pas d'une solution appropriÃ©e prÃªte Ã  l'emploi.  Par exemple, pour intÃ©grer des modÃ¨les de science des donnÃ©es directement dans Tableau, mais c'est une toute autre histoire ... <br><br>  L'article a Ã©tÃ© rÃ©digÃ© conjointement avec mes collÃ¨gues Dimitri Shcherbenko ( <a href="https://habr.com/ru/users/dima_vs/" class="user_link">dima_vs</a> ) et Sukhoveev Ivan ( <a href="https://habr.com/ru/users/suho_v/" class="user_link">suho_v</a> ) R&amp;D Dentsu Aegis Network Russia. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477864/">https://habr.com/ru/post/fr477864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477852/index.html">Hypocrisie non toxique</a></li>
<li><a href="../fr477854/index.html">Que se passe-t-il lors de la connexion Ã  l'intÃ©rieur et Ã  l'extÃ©rieur d'un tunnel VPN</a></li>
<li><a href="../fr477856/index.html">AccÃ©lÃ©rateurs flash PCI-E de 800 Go Ã  6,4 To: de l'aube Ã  la vie sur un PC / serveur classique</a></li>
<li><a href="../fr477858/index.html">Travail hors table: quels projets sont vraiment apparus aprÃ¨s la prÃ©-accÃ©lÃ©ration?</a></li>
<li><a href="../fr477860/index.html">Comment les services de base de donnÃ©es gÃ©rÃ©s sont-ils organisÃ©s dans Yandex?</a></li>
<li><a href="../fr477870/index.html">Tableau de bord Grafana pour systÃ¨me de biÃ¨re BeerTender</a></li>
<li><a href="../fr477874/index.html">CDN dynamique pour le streaming WebRTC avec faible latence et transcodage</a></li>
<li><a href="../fr477878/index.html">Comment les jeux compÃ©titifs vous aident Ã  mieux travailler</a></li>
<li><a href="../fr477882/index.html">40 canaux et chats pour les personnes intÃ©ressÃ©es par DevOps</a></li>
<li><a href="../fr477892/index.html">DevOps: rÃ©sultats 2019 et prochaine prÃ©diction de la communautÃ© DevOps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>