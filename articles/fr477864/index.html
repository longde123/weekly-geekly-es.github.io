<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖊️ 🤐 ✋ TabPy pour travailler avec des données dans ClickHouse de Tableau 😿 ⚗️ 🤺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Développer la communication entre les marques et les gens est ce que nous faisons quotidiennement chez Dentsu Aegis Network, et l'analyse des données ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TabPy pour travailler avec des données dans ClickHouse de Tableau</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dentsuaegisnetworkrussia/blog/477864/">  Développer la communication entre les marques et les gens est ce que nous faisons quotidiennement chez Dentsu Aegis Network, et l'analyse des données fait partie intégrante de ce travail.  Dans certains cas, ce processus ne nécessite pas de science des données (bien que nous en ayons un), nous utilisons alors la plateforme <a href="https://en.wikipedia.org/wiki/Tableau_Software">Tableau</a> BI.  Son objectif principal est de fournir à nos employés et clients une interface pratique pour la consommation de données sans écrire de scripts, de requêtes SQL, etc. <br><br>  Dans cet article, nous décrirons comment nous avons réussi à résoudre le problème d'interaction de Tableau avec <a href="https://ru.wikipedia.org/wiki/ClickHouse">ClickHouse</a> . <br><a name="habracut"></a><br><h3>  Énoncé général du problème </h3><br>  Nous avons fait face à un défi classique.  Nous avons des gens.  Ils aiment les fruits.  Certaines personnes aiment un fruit, d'autres comme tous les fruits, et les autres peuvent aimer n'importe quelle combinaison de fruits. <br><img src="https://habrastorage.org/webt/lb/wp/om/lbwpomzrluk4hed_uihmxiko_xy.png" alt="image"><br>  Il est donc nécessaire de permettre à l'utilisateur du tableau de bord intégré à Tableau de sélectionner arbitrairement plusieurs fruits et de voir combien de personnes aiment au moins un fruit de l'ensemble.  Bien sûr, nous n'avions pas de fruits, mais les gens étaient réels, c'est juste que sur les «fruits», il est plus facile de comprendre le problème. <br><br>  La quantité de données dans notre cas est assez importante.  Il y avait 13 mille «fruits» différents.  Le «fruit» le plus populaire comptait près de 34 millions de fans.  En moyenne, 450 000 personnes aiment chaque «fruit».  Total des amateurs de fruits - 282 millions. <br><br><h3>  Première solution frontale </h3><br>  Il se trouve que les données de cette tâche que nous avions dans <a href="https://ru.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> (PG) et ClickHouse (CH).  En PG, il y avait un tableau de référence sur les «fruits», en CH - un grand tableau avec une structure: l'identifiant du «fruit» et l'identifiant de la personne qui aime ce «fruit».  Il n'y a pas de connecteur natif pour CH dans Tableau, et je ne voulais toujours pas transférer les données quelque part, car cela nécessiterait une refonte sérieuse du système existant. <br><br>  Nous avons essayé de connecter Tableau à CH à l'aide du pilote ODBC et de voir ce qui se passe. <br><br><ul><li>  Tous les pilotes ODBC ne sont pas également utiles.  Nous avons besoin d'une certaine version dans laquelle fonctionne la partie nécessaire de la fonctionnalité, mais rien ne garantit que le reste fonctionnera si vous en avez soudainement besoin. </li><li>  Nous n'avons pas pu extraire toutes les données dans l'extrait de Tableau, car il s'agit de 13 000 * 450 000 = 5 850 000 000 d'enregistrements. </li></ul><br>  Ensuite, nous avons décidé d'utiliser l'échantillonnage à l'intérieur de la requête vers la base de données CH, c'est-à-dire pour faire notre estimation du nombre d'amoureux de la combinaison de «fruits» sélectionnée non pas sur toutes les personnes, mais sur un échantillon de cinq pour cent pour réduire l'extrait.  De plus, nous avons immédiatement effectué une extraction de jointure interne à partir de CH avec un répertoire PG «fruit» pour obtenir les noms «fruit».  Cela a aidé - notre extrait a pu être généré en 5 heures. <br><br>  Nous devions mettre à jour les données dans le tableau de bord une fois par jour, donc 5 heures de mise à jour de l'extrait semblent être correctes - nous mettrons à jour la nuit.  Mais à l'avenir, nous aurions besoin de capacités supplémentaires: il devrait y avoir plus de «fruits»; en conséquence, le nombre et la taille des groupes de personnes dont nous devions calculer l'intersection devrait également augmenter.  Par conséquent, une longue mise à jour de l'extrait n'est pas du tout notre option. <br><br>  De plus, il y avait un autre problème dû à l'échantillonnage.  Il se trouve que dans différentes parties du tableau de bord, les chiffres, qui devraient être censés coïncider, étaient différents dans notre pays.  Cela était dû au fait qu'en un seul endroit, nous avons compté le nombre d'amoureux d'un fruit avec précision, et en partie avec une combinaison de fruits - inexact.  Ni nous ni nos utilisateurs n'avons aimé ce résultat. <br><br>  Ensuite, nous avons décidé de ne pas créer d'extrait du tout.  Pour éviter de charger une énorme quantité de données, nous avons divisé les ensembles de données et utilisé la connexion en direct pour CH.  Entre les jeux de données, une connexion a été établie à l'aide de la fonctionnalité de relation Tableau Edit intégrée.  La source de données PG a été rendue principale et liée à CH comme secondaire, en utilisant l'identifiant «fruit» qui était dans les deux tableaux. <br><br>  Ainsi, nous avons pu filtrer la source de données secondaire en utilisant le primaire (mélange de données).  Mais nous nous attendions à un échec, car après avoir lancé le filtre d'une source de données à une autre, nous avons dû utiliser la fonction de comptage des personnes dans le sous-ensemble résultant (COUNTD), et le mélange de données a une limitation qui ne permet tout simplement pas de le faire.  Une telle fonction directement avec une telle connexion de données ne fonctionne pas en principe. <br><br>  Il existe une solution de contournement qui permet de contourner cette limitation de Tableau, mais elle peut être utilisée sur des ensembles de données relativement petits, ce qui n'est clairement pas le cas dans notre cas. <br><br>  Après cela, nous avons essayé une autre option.  Les ensembles de données étaient toujours divisés et utilisaient une connexion en direct pour CH.  Ici, le filtre de l'ensemble de données avec la description de «fruits» à l'ensemble de données avec des fans de «fruits» a été lancé dans Tableau à l'aide de l'action set.  Mais cette option ne convenait finalement pas en raison de l'interface utilisateur peu pratique.  Au lieu du filtre familier à l'utilisateur, l'utilisateur devrait regarder la liste entière et sélectionner "fruits" via cntrl + clic, tandis que la fonction d'application était absente lorsque toutes les valeurs sélectionnées sont appliquées en même temps. <br><br>  En conséquence, après toutes nos tentatives, nous avons dû revenir à l'option avec extrait et échantillonnage, terriblement lente et ne donnant qu'une réponse approximative. <br><br><img src="https://habrastorage.org/webt/uh/5a/ie/uh5aiemfrjzz8f1wmeu54eg-flm.png" alt="image"><br><br><h3>  Solution trouvée </h3><br>  De toute évidence, nous n'avons pas besoin d'extraire toutes les données dans l'extrait de Tableau.  L'utilisateur est mal à l'aise de voir toutes les données à la fois - le nombre de personnes qui aiment tous les «fruits».  Il a besoin d'un ensemble d'une moyenne de 10 «fruits».  Il est dommage que Tableau ne sache pas comment procéder. <br><br>  Il y a des gars dans notre équipe qui écrivent en Python.  Par conséquent, nous avons décidé dans notre recherche d'aller dans cette direction et <a href="https://github.com/tableau/TabPy">avons</a> trouvé <a href="https://github.com/tableau/TabPy">TabPy</a> . <br><br>  TabPy est un service Web qui vous permet d'obtenir le résultat de l'exécution de scripts Python dans Costing dans Tableau. <br><br>  Comment ça marche: <br><br><ol><li>  Tableau interagit avec TabPy et, à son tour, avec Python en utilisant les soi-disant fonctions de script.  Les fonctions de script contiennent le script Python lui-même, le type de données requis du résultat et les arguments que nous transmettons à cette fonction.  Dans notre cas, les arguments étaient des identifiants de «fruits», le nombre d'amants dont nous voulions compter. </li><li>  TabPy convertit le texte reçu des fonctions de script en script et le transmet à l'interpréteur.  La connexion à la base CH a été enregistrée par nous dans le script. </li><li>  Ensuite, TabPy renvoie le résultat du script exécuté à Tableau. </li></ol><br><br><img src="https://habrastorage.org/webt/a9/me/qi/a9meqia3hjlrx1niaje_fb5lfww.png" alt="image"><br><br>  Dans les fonctions de script, les arguments sont toujours transmis sous forme de tableaux; le résultat est également renvoyé par un tableau. <br><br>  Tout n'a pas fonctionné tout de suite.  La principale chose que nous avons comprise: écrire un script Python directement dans un champ calculé dans Tableau n'est pas une bonne idée.  Pour deux raisons: <br><br><ol><li>  Dans les fonctions de script, il est parfois difficile d'utiliser la syntaxe Python familière.  Par exemple, plusieurs devis ne sont pas acceptés. </li><li>  En pensant à la prise en charge future du tableau de bord, nous avons réalisé que si nous devons changer le script d'une manière ou d'une autre, nous devrons à chaque fois le changer dans le livre Tableau lui-même.  Et ce n'est clairement pas la meilleure façon, car nous faisons de notre mieux pour éviter la prise en charge manuelle des tableaux de bord. </li></ol><br>  Par conséquent, nous avons utilisé une autre chose - <a href="">TabPy Client</a> . <br><br>  TabPy Client est une bibliothèque qui vous permet de publier des scripts Python sur le serveur TabPy, puis de les appeler dans Tableau.  Lorsque vous l'utilisez, au lieu d'écrire un script dans Tableau, nous appelons le fichier .py se trouvant sur le serveur TabPy en utilisant les paramètres qui y sont spécifiés, lui transmettons des arguments et l'exécutons. <br><br>  Cette approche a résolu nos problèmes en utilisant TabPy et Tableau.  Le script est écrit et testé dans l'environnement de développement familier et stocké séparément du livre, qui ne nécessite désormais plus de prise en charge manuelle. <br><br>  Pour résoudre notre problème spécifique, nous avons dû procéder comme suit. <br>  Au début, nous avons essayé de le résoudre sans utiliser le client TabPy.  Dans ce cas, un champ de calcul du formulaire suivant a été créé dans Tableau: <br><div class="scrollable-table"><table><tbody><tr><td>  SI PREMIER () == 0 <br>  ALORS <br>  SCRIPT_INT (" <br>  depuis le client d'importation clickhouse_driver <br>  client = Client (hôte = nom_hôte, base de données = nom_base de données, utilisateur = nom_utilisateur, mot de passe = mot de passe) <br><br>  ----- script_text ----- <br><br>  ", SUM ([people]), ATTR ([fruits_id])) <br>  Fin </td></tr></tbody></table></div>  Cela a fonctionné, mais il y avait des problèmes qui ont été décrits ci-dessus.  Lorsque nous avons compris le client TabPy, nous avons réalisé qu'en divisant le champ Calcul et le script lui-même, nous obtenons un système plus pratique et correct.  Voici à quoi ressemblaient le champ Calcul et le fichier .py avec le script: <br><div class="scrollable-table"><table><tbody><tr><td>  Champ de calcul </td><td>  SCRIPT_INT (" <br>  return tabpy.query ('people_count_test', _ arg1, _arg2) ['response'] <br>  ", SUM ([people]), ATTR ([fruits_id])) </td></tr><tr><td>  Fichier .py </td><td>  depuis le client d'importation clickhouse_driver <br>  importer tabpy_client <br>  connection = tabpy_client.Client ('http: // localhost: 9004 /') <br>  def unique_people_count (people, fruits_id): <br>  client = Client (hôte = nom_hôte, base de données = nom_base de données, utilisateur = nom_utilisateur, mot de passe = mot de passe) <br><br>  ----- script_text ----- <br><br>  connection.deploy ('people_count_test', unique_people_count, 'comment', override = True) </td></tr></tbody></table></div>  Ici, vous pouvez voir que 'people_count_test' est l'identifiant du client TabPy, grâce auquel il est clair quel script exécuter dans ce champ de calcul. <br><br>  Et au final, c'est cette approche qui nous a totalement satisfaits. <br><br><img src="https://habrastorage.org/webt/ef/_k/g3/ef_kg3lc57jwo3zktnbxivckhro.png" alt="image"><br><br><h3>  Résumé </h3><br>  Les utilisateurs sont satisfaits car ils peuvent choisir arbitrairement une combinaison de «fruits» et obtenir rapidement le nombre de fans d'au moins l'un d'entre eux, et les chiffres dans les différentes parties du tableau de bord sont les mêmes. <br><br>  Les développeurs BI sont heureux que vous puissiez travailler avec ClickHouse de Tableau, sans avoir à vous y connecter directement. <br><br>  Notre Tableau Server est heureux que vous n'ayez pas besoin de faire un énorme extrait la nuit. <br><br>  En général, TabPy donne aux développeurs BI plus de liberté pour travailler avec des données lorsque Tableau ne dispose pas d'une solution appropriée prête à l'emploi.  Par exemple, pour intégrer des modèles de science des données directement dans Tableau, mais c'est une toute autre histoire ... <br><br>  L'article a été rédigé conjointement avec mes collègues Dimitri Shcherbenko ( <a href="https://habr.com/ru/users/dima_vs/" class="user_link">dima_vs</a> ) et Sukhoveev Ivan ( <a href="https://habr.com/ru/users/suho_v/" class="user_link">suho_v</a> ) R&amp;D Dentsu Aegis Network Russia. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477864/">https://habr.com/ru/post/fr477864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477852/index.html">Hypocrisie non toxique</a></li>
<li><a href="../fr477854/index.html">Que se passe-t-il lors de la connexion à l'intérieur et à l'extérieur d'un tunnel VPN</a></li>
<li><a href="../fr477856/index.html">Accélérateurs flash PCI-E de 800 Go à 6,4 To: de l'aube à la vie sur un PC / serveur classique</a></li>
<li><a href="../fr477858/index.html">Travail hors table: quels projets sont vraiment apparus après la pré-accélération?</a></li>
<li><a href="../fr477860/index.html">Comment les services de base de données gérés sont-ils organisés dans Yandex?</a></li>
<li><a href="../fr477870/index.html">Tableau de bord Grafana pour système de bière BeerTender</a></li>
<li><a href="../fr477874/index.html">CDN dynamique pour le streaming WebRTC avec faible latence et transcodage</a></li>
<li><a href="../fr477878/index.html">Comment les jeux compétitifs vous aident à mieux travailler</a></li>
<li><a href="../fr477882/index.html">40 canaux et chats pour les personnes intéressées par DevOps</a></li>
<li><a href="../fr477892/index.html">DevOps: résultats 2019 et prochaine prédiction de la communauté DevOps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>