<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè£ üë®üèª‚Äçüíª üöà RBKmoney Zahlungen unter der Haube - Microservices, Protokolle und Plattformkonfiguration ü§Ωüèæ üòõ üßúüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! RBKmoney meldet sich erneut und setzt eine Reihe von Artikeln zum Schreiben der Do-it-yourself-Zahlungsabwicklung fort. 





 Ich wollte ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RBKmoney Zahlungen unter der Haube - Microservices, Protokolle und Plattformkonfiguration</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rbkmoney/blog/443518/"><p>  Hallo Habr!  RBKmoney meldet sich erneut und setzt eine Reihe von Artikeln zum Schreiben der Do-it-yourself-Zahlungsabwicklung fort. </p><br><p><img src="https://habrastorage.org/webt/nc/w-/dh/ncw-dhwzrbb-b84-afrgy1syhri.jpeg"></p><br><p>  Ich wollte sofort in die Details der Beschreibung der Implementierung eines Zahlungsgesch√§ftsprozesses als Zustandsmaschine eintauchen, Beispiele f√ºr eine solche Maschine mit einer Reihe von Ereignissen und Implementierungsfunktionen zeigen ... Aber es scheint, dass Sie nicht auf ein paar weitere √úbersichtsartikel verzichten k√∂nnen.  Der Themenbereich erwies sich als zu gro√ü.  In diesem Beitrag werden die Nuancen der Arbeit und Interaktion zwischen den Microservices unserer Plattform, die Interaktion mit externen Systemen und die Verwaltung der Gesch√§ftskonfiguration erl√§utert. <a name="habracut"></a></p><br><h3 id="makroservis">  Makrodienst </h3><br><p>  Unser System besteht aus vielen Mikrodiensten, die jeden ihrer fertigen Teile der Gesch√§ftslogik implementieren, miteinander interagieren und zusammen einen Makrodienst bilden.  Tats√§chlich ist der im Rechenzentrum bereitgestellte Makrodienst, der mit Banken und anderen Zahlungssystemen verbunden ist, unsere Zahlungsverarbeitung. </p><br><h4 id="shablon-mikroservisa">  Microservice-Vorlage </h4><br><p>  Wir verwenden einen einheitlichen Ansatz f√ºr die Entwicklung eines Mikrodienstes in einer beliebigen Sprache.  Jeder Microservice ist ein Docker-Container, der Folgendes enth√§lt: </p><br><ul><li>  die Anwendung selbst, die in Erlang oder Java geschriebene Gesch√§ftslogik implementiert; </li><li>  RPClib - eine Bibliothek, die die Kommunikation zwischen Microservices implementiert; <br><ul><li>  Wir verwenden Apache Thrift. Die Hauptvorteile sind vorgefertigte Client-Server-Bibliotheken und die M√∂glichkeit, die Beschreibung aller √∂ffentlichen Methoden, die jeder Microservice bietet, genau zu typisieren. </li><li> Das zweite Merkmal der Bibliothek ist die Implementierung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google Dapper</a> , mit der wir Anfragen mit einer einfachen Suche in Elasticsearch schnell verfolgen k√∂nnen.  Der erste <code>trace_id</code> , der eine Anforderung von einem externen System erhalten hat, generiert eine eindeutige <code>trace_id</code> , die von jeder nachfolgenden Anforderungskette gespeichert wird.  Au√üerdem generieren und speichern wir <code>parent_id</code> und <code>span_id</code> , mit denen Sie einen <code>span_id</code> <code>parent_id</code> und die gesamte Kette von <code>span_id</code> , die an der Verarbeitung der Anforderung beteiligt sind, visuell √ºberwachen k√∂nnen. </li><li>  Das dritte Merkmal: Wir nutzen die √úbertragung verschiedener Informationen √ºber den Kontext der Anfrage auf Transportebene aktiv.  Zum Beispiel Fristen (die erwartete Lebensdauer der auf dem Client festgelegten Anforderung) oder in deren Auftrag wir eine Methode aufrufen; </li></ul></li><li>  Die Consul-Vorlage ist ein Service Discovery Agent, der Informationen zu Standort, Verf√ºgbarkeit und Status eines Microservices verwaltet.  Microservices finden sich anhand von DNS-Namen, die Zone TTL ist Null, der Dienst, der gestorben ist oder den Healthcheck nicht bestanden hat, wird nicht mehr aufgel√∂st und empf√§ngt somit Datenverkehr. </li><li>  Von der Anwendung geschriebene Protokolle in einem f√ºr Elasticsearch verst√§ndlichen Format in die lokale Containerdatei und <code>filebeat</code> , die auf dem <code>filebeat</code> relativ zum Container ausgef√ºhrt werden, nehmen diese Protokolle auf und senden sie an den Elasticsearch-Cluster. <br><ul><li>  Da wir die Plattform gem√§√ü dem Event-Sourcing-Modell implementieren, werden die resultierenden Protokollketten auch zur Visualisierung in Form verschiedener Grafana-Dashboards verwendet, wodurch wir die Zeit f√ºr die Implementierung verschiedener Metriken verk√ºrzen k√∂nnen (wir verwenden auch separate Metriken). </li></ul></li></ul><br><p><img src="https://habrastorage.org/webt/2v/ac/a2/2vaca2u7qtih8_1iqtl0h_2ywoq.jpeg"></p><br><p>  Bei der Entwicklung von Microservices verwenden wir die speziell erfundenen Einschr√§nkungen, mit denen das Problem der hohen Verf√ºgbarkeit der Plattform und ihrer Fehlertoleranz gel√∂st werden soll: </p><br><ul><li>  Strenge Speichergrenzen f√ºr jeden Container, wenn Sie die Grenzen √ºberschreiten - OOM, die meisten Microservices leben innerhalb von 256-512 MB.  Dies macht die Implementierung der Gesch√§ftslogik feiner fragmentiert, sch√ºtzt vor Abdrift zum Monolithen, senkt die Kosten der Fehlerstelle und bietet einen zus√§tzlichen Vorteil bei der Arbeit mit billiger Hardware (die Plattform wird bereitgestellt und l√§uft auf kosteng√ºnstigen Einzelprozessor-Servern). </li><li>  so wenig Stateful Microservices wie m√∂glich und so viele zustandslose Implementierungen wie m√∂glich.  Dies erm√∂glicht es uns, die Probleme der Fehlertoleranz, der Geschwindigkeit der Wiederherstellung und im Allgemeinen der Minimierung von Orten mit m√∂glicherweise unverst√§ndlichem Verhalten zu l√∂sen.  Dies wird besonders wichtig, wenn die Lebensdauer des Systems verl√§ngert wird, wenn sich ein gro√ües Erbe ansammelt. </li><li>  lass es abst√ºrzen und "es wird definitiv brechen" n√§hert sich.  Wir wissen, dass ein Teil unseres Systems notwendigerweise ausfallen wird, daher gestalten wir es so, dass die allgemeine Richtigkeit der auf der Plattform gesammelten Informationen nicht beeintr√§chtigt wird.  Hilft bei der Minimierung der Anzahl undefinierter Zust√§nde im System. </li></ul><br><p>  <em>Sicher vertraut vielen, die sich mit Dritten integrieren, die Situation.</em>  <em>Wir erwarteten eine Antwort eines Dritten auf die Aufforderung, Geld gem√§√ü dem Protokoll abzuschreiben, und es kam eine v√∂llig andere Antwort, die in keiner Spezifikation beschrieben wurde und deren Interpretation unbekannt ist.</em> </p><br><p>  In dieser Situation t√∂ten wir die Zustandsmaschine, die diese Zahlung bedient. Alle Aktionen von au√üen erhalten einen Fehler von 500. Im Inneren ermitteln wir den aktuellen Status der Zahlung, bringen den Zustand der Maschine in Einklang mit der Realit√§t und beleben die Zustandsmaschine wieder. </p><br><h2 id="protocol-oriented-development">  Protokollorientierte Entwicklung </h2><br><p><img src="https://habrastorage.org/webt/my/8p/o1/my8po16kkxanpoanxnzrea_i7gg.jpeg"></p><br><p>  Zum Zeitpunkt des Schreibens waren in unserer Service Discovery 636 verschiedene Pr√ºfungen f√ºr Services registriert, die das Funktionieren der Plattform sicherstellen.  Selbst wenn man ber√ºcksichtigt, dass mehrere √úberpr√ºfungen f√ºr einen Dienst durchgef√ºhrt werden und die meisten zustandslosen Dienste in mindestens einer dreifachen Instanz funktionieren, k√∂nnen Sie immer noch f√ºnfzig Anwendungen erhalten, die in der Lage sein m√ºssen, irgendwie miteinander verbunden zu werden und nicht fehlzuschlagen in der RPC-H√∂lle. </p><br><p>  Die Situation wird durch die Tatsache kompliziert, dass wir drei Entwicklungssprachen auf dem Stapel haben - Erlang, Java, JS, und alle m√ºssen in der Lage sein, transparent miteinander zu kommunizieren. </p><br><p>  Die erste Aufgabe, die gel√∂st werden musste, bestand darin, die richtige Architektur f√ºr den Datenaustausch zwischen Mikrodiensten zu entwerfen.  Als Basis haben wir Apache Thrift genommen.  Alle Microservices tauschen Trift-Bin√§rdateien aus, wir verwenden HTTP als Transportmittel. </p><br><p>  Wir platzieren die Schriftartenspezifikationen in Form von separaten Repositorys in unserem Github, sodass sie jedem Entwickler zur Verf√ºgung stehen, der Zugriff darauf hat.  Anfangs verwendeten sie ein gemeinsames Repository f√ºr alle Protokolle, kamen jedoch im Laufe der Zeit zu dem Schluss, dass dies unpraktisch ist - die gemeinsame parallele Arbeit an den Protokollen f√ºhrte zu st√§ndigen Kopfschmerzen.  Verschiedene Teams und sogar verschiedene Entwickler waren gezwungen, sich auf den Namen der Variablen zu einigen. Ein Versuch, sich in einen Namespace aufzuteilen, half ebenfalls nicht. </p><br><p>  Im Allgemeinen k√∂nnen wir sagen, dass wir eine protokollgesteuerte Entwicklung haben.  Bevor wir mit der Implementierung beginnen, entwickeln wir das zuk√ºnftige Microservice-Protokoll in Form einer Lift-Spezifikation, durchlaufen 7 √úberpr√ºfungskreise, um zuk√ºnftige Kunden dieses Microservices anzulocken, und erhalten die M√∂glichkeit, gleichzeitig mehrere Microservices parallel zu entwickeln, da wir alle zuk√ºnftigen Methoden kennen und bereits ihre Handler schreiben k√∂nnen. optional mit moki. </p><br><p>  Ein separater Schritt im Protokollentwicklungsprozess ist eine Sicherheits√ºberpr√ºfung, bei der die Jungs aus ihrer Pentester-Sicht die Nuancen der zu entwickelnden Spezifikation betrachten. </p><br><p>  Wir hielten es auch f√ºr angemessen, eine separate Rolle des Protokollbesitzers im Team hervorzuheben.  Die Aufgabe ist schwierig, eine Person muss die Besonderheiten aller Mikrodienste ber√ºcksichtigen, aber sie zahlt sich in gro√üem Umfang aus und es gibt nur einen einzigen Eskalationspunkt. </p><br><p>  Ohne die endg√ºltige Genehmigung der Pull-Anforderung durch diese Mitarbeiter kann das Protokoll nicht in einer Hauptniederlassung zusammengef√ºhrt werden.  Hierf√ºr gibt es im Github eine sehr praktische Funktion - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Codebesitzer</a> , die wir gerne nutzen. </p><br><p>  So haben wir das Problem der Kommunikation zwischen Mikrodiensten gel√∂st, m√∂gliche Probleme des Missverst√§ndnisses, welche Art von Mikrodienst auf der Plattform angezeigt wurde und warum er ben√∂tigt wird.  Dieser Satz von Protokollen ist vielleicht der einzige Teil der Plattform, auf dem wir Qualit√§t bedingungslos gegen die Kosten und die Geschwindigkeit der Entwicklung w√§hlen, da die Implementierung eines Mikrodienstes relativ schmerzlos umgeschrieben werden kann und das Protokoll, auf dem mehrere Dutzend bereits teuer und schmerzhaft sind. </p><br><p>  Auf dem Weg hilft eine genaue Protokollierung bei der L√∂sung des Dokumentationsproblems.  Vern√ºnftigerweise ausgew√§hlte Namen von Methoden und Parametern, einige Kommentare und eine selbst dokumentierte Spezifikation sparen viel Zeit! </p><br><p>  So sieht beispielsweise die Spezifikation der Methode eines unserer Microservices aus, sodass Sie eine Liste der Ereignisse abrufen k√∂nnen, die auf der Plattform aufgetreten sind: </p><br><pre> <code class="plaintext hljs">/**    */ typedef i64 EventID /* Event sink service definitions */ service EventSink { /** *       ,   *    ,  ,  `range`.  *      `0`  `range.limit` . * *   `range.after`    ,   * ,        , *   `EventNotFound`. */ Events GetEvents (1: EventRange range) throws (1: EventNotFound ex1, 2: base.InvalidRequest ex2) /** *         *  . */ base.EventID GetLastEventID () throws (1: NoLastEvent ex1) } /* Events */ typedef list&lt;Event&gt; Events /** * ,    -,  . */ struct Event { /** *  . *    ,     *      (total order). */ 1: required base.EventID id /** *   . */ 2: required base.Timestamp created_at /** *  -,  . */ 3: required EventSource source /** *  ,    ( ) *   -,  . */ 4: required EventPayload payload /** *      . *    . */ 5: optional base.SequenceID sequence } // Exceptions exception EventNotFound {} exception NoLastEvent {} /** * ,       -   */ exception InvalidRequest { /**          */ 1: required list&lt;string&gt; errors }</code> </pre> <br><h3 id="thrift-console-client">  Thrift Console Client </h3><br><p>  Manchmal stehen wir vor der Aufgabe, bestimmte Methoden des notwendigen Mikrodienstes direkt aufzurufen, beispielsweise mit unseren H√§nden vom Terminal aus.  Dies kann n√ºtzlich sein, um Fehler zu beheben, einen Rohdatensatz zu erhalten oder wenn die Aufgabe so selten ist, dass die Entwicklung einer separaten Benutzeroberfl√§che unpraktisch ist. </p><br><p>  Aus diesem Grund haben wir ein Tool f√ºr uns entwickelt, das <code>curl</code> Funktionen kombiniert, es Ihnen jedoch erm√∂glicht, Trift-Anforderungen in Form von JSON-Strukturen zu stellen.  Wir haben ihn entsprechend <code>woorl</code> - <code>woorl</code> .  Das Dienstprogramm ist universell einsetzbar. Es reicht aus, den Speicherort einer Aufzugsspezifikation mithilfe des Befehlszeilenparameters zu √ºbertragen. Den Rest erledigt es selbst.  Als sehr praktisches Dienstprogramm k√∂nnen Sie beispielsweise eine Zahlung direkt vom Terminal aus starten. </p><br><p>  So sieht der Appell direkt auf den Microservice der Plattform aus, der f√ºr die Verwaltung von Anwendungen verantwortlich ist (z. B. zum Erstellen eines Gesch√§fts).  Ich habe Daten auf meinem Testkonto angefordert: </p><br><p><img src="https://habrastorage.org/webt/zk/9f/zy/zk9fzypaopdlugw06vwkso2qt0q.jpeg"></p><br><p>  <em>Das Beobachten der Leser bemerkte wahrscheinlich eine Funktion im Screenshot.</em>  <em>Das gef√§llt uns auch nicht.</em>  <em>Es ist notwendig, die Autorisierung von Trift-Anrufen zwischen Microservices zu befestigen, es ist notwendig, TLS auf eine gute Weise zu kleben.</em>  <em>Aber w√§hrend Ressourcen wie immer nicht ausreichen.</em>  <em>Wir haben uns auf die gesamte Umschlie√üung des Perimeters beschr√§nkt, in dem verarbeitende Mikrodienste leben.</em> </p><br><h2 id="protokoly-obscheniya-s-vneshnimi-sistemami">  Protokolle f√ºr die Kommunikation mit externen Systemen </h2><br><p>  Um externe Lift-Spezifikationen zu ver√∂ffentlichen und unsere H√§ndler zur Kommunikation mit dem Bin√§rprotokoll zu zwingen, hielten wir es f√ºr zu grausam f√ºr sie.  Es war notwendig, ein f√ºr Menschen lesbares Protokoll zu w√§hlen, das es uns erm√∂glicht, bequem in uns zu integrieren, zu debuggen und bequem zu dokumentieren.  Wir haben uns f√ºr den Open API-Standard entschieden, der auch als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Swagger bekannt ist</a> . </p><br><p>  Zur√ºck zum Problem der Dokumentation von Protokollen: Mit Swagger k√∂nnen Sie dieses Problem schnell und kosteng√ºnstig l√∂sen.  Das Netzwerk verf√ºgt √ºber viele Implementierungen des sch√∂nen Designs der Swagger-Spezifikation in Form einer Entwicklerdokumentation.  Wir haben uns alles angesehen, was wir finden konnten, und uns schlie√ülich f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ReDoc</a> entschieden, eine JS-Bibliothek, die swagger.json als Eingabe akzeptiert, und eine solche dreispaltige Dokumentation an der Ausgabe generiert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://developer.rbk.money/api/</a> . </p><br><p>  Die Ans√§tze zur Entwicklung beider Protokolle, Internal Thrift und External Swagger, sind f√ºr uns absolut identisch.  Dies verl√§ngert die Entwicklungszeit, zahlt sich aber langfristig aus. </p><br><p>  Wir mussten auch ein weiteres wichtiges Problem l√∂sen - wir akzeptieren nicht nur Anfragen, Geld abzuschreiben, sondern senden sie auch weiter - an Banken und Zahlungssysteme. </p><br><p>  Sie zu zwingen, unseren Lift zu implementieren, w√§re eine noch unpraktikablere Aufgabe, als ihn an √∂ffentliche APIs zu senden. </p><br><p>  Aus diesem Grund haben wir das Konzept der Protokolladapter entwickelt und implementiert.  Dies ist nur ein weiterer Mikrodienst, der unsere interne Aufzugsspezifikation auf einer Seite implementiert, die f√ºr die gesamte Plattform gleich ist, und die zweite ist ein externes Protokoll, das f√ºr eine bestimmte Bank oder PS spezifisch ist. </p><br><p>  <em>Die Probleme, die beim Schreiben solcher Adapter auftreten, wenn Sie mit Dritten interagieren m√ºssen, sind ein Thema, das reich an verschiedenen Geschichten ist.</em>  <em>In unserer Praxis haben wir verschiedene Dinge getroffen, Antworten der Form: ‚ÄûSie k√∂nnen diese Funktion nat√ºrlich wie in dem Protokoll beschrieben implementieren, das wir Ihnen gegeben haben, aber ich gebe keine Garantien. Hier kommt unser Patient, der wird all diese Antworten, und Sie bitten ihn um Best√§tigung. "</em>  <em>Solche Situationen sind auch nicht ungew√∂hnlich: "Hier ist der Benutzername und das Passwort von unserem Server. Gehen Sie dorthin und konfigurieren Sie alles selbst."</em> </p><br><p>  <em>Ich finde es besonders interessant, wenn wir uns in einen Zahlungspartner integriert haben, der sich zuvor in unsere Plattform integriert und erfolgreich Zahlungen √ºber uns get√§tigt hat (dies geschieht h√§ufig aufgrund der gesch√§ftlichen Besonderheiten der Zahlungsbranche).</em>  <em>Als Antwort auf unsere Anfrage nach einer Testumgebung antwortete der Partner, dass er keine Testumgebung als solche habe, aber er k√∂nnte Datenverkehr f√ºr die Integration mit RBC erhalten, dh mit unserer Plattform, auf der wir uns beteiligen k√∂nnten.</em>  <em>So haben wir uns √ºber einen Partner einmal in uns integriert.</em> </p><br><p>  Damit haben wir ganz einfach das Problem der Implementierung einer Massenparallelverbindung verschiedener Zahlungssysteme und anderer Dritter gel√∂st.  In den allermeisten F√§llen m√ºssen Sie dazu nicht den Plattformcode ber√ºhren, sondern nur die Adapter schreiben und der Aufz√§hlung weitere Zahlungsinstrumente hinzuf√ºgen. </p><br><p>  Als Ergebnis haben wir ein solches Arbeitsschema erhalten - wir schauen au√üerhalb der RBKmoney API-Microservices (wir nennen sie Common API oder capi *, Sie haben sie im Konsul oben gesehen), die die Eingabedaten gem√§√ü der √∂ffentlichen Swagger-Spezifikation validieren, Clients autorisieren, senden Diese Methoden werden an unsere internen Liftanrufe weitergeleitet und Anfragen in der gesamten Kette an den n√§chsten Microservice gesendet.  Dar√ºber hinaus implementieren diese Dienste eine weitere Plattformanforderung, deren technische Spezifikation wie folgt formuliert wurde: "Das System sollte immer die M√∂glichkeit haben, eine Katze zu bekommen." </p><br><p>  Wenn wir ein externes System anrufen m√ºssen, ziehen interne Mikrodienste die Lift-Methoden des entsprechenden Protokolladapters, √ºbersetzen sie in die Sprache einer bestimmten Bank oder eines bestimmten Zahlungssystems und senden sie aus. </p><br><h3 id="trudnosti-obratnoy-sovmestimosti-protokolov">  Schwierigkeiten bei der Abw√§rtskompatibilit√§t des Protokolls </h3><br><p>  Die Plattform entwickelt sich st√§ndig weiter, neue Funktionen werden hinzugef√ºgt, alte werden ge√§ndert.  Unter solchen Umst√§nden m√ºssen Sie entweder in die Unterst√ºtzung der Abw√§rtskompatibilit√§t investieren oder abh√§ngige Microservices st√§ndig aktualisieren.  Und wenn die Situation, in der das erforderliche Feld optional wird, einfach ist, k√∂nnen Sie √ºberhaupt nichts tun, und im umgekehrten Fall m√ºssen Sie zus√§tzliche Ressourcen aufwenden. </p><br><p>  Mit einer Reihe interner Protokolle wird es einfacher.  Die Zahlungsbranche √§ndert sich selten, so dass einige grundlegend neue Interaktionsmethoden auftauchen.  Nehmen wir zum Beispiel eine gemeinsame Aufgabe f√ºr uns - einen neuen Anbieter mit einem neuen Zahlungsinstrument zu verbinden.  Zum Beispiel die lokale Brieftaschenverarbeitung, mit der Sie Zahlungen in Kasachstan in Tenge verarbeiten k√∂nnen.  Dies ist eine neue Brieftasche f√ºr unsere Plattform, die sich jedoch im Prinzip nicht von derselben Qiwi-Brieftasche unterscheidet. Sie verf√ºgt immer √ºber eine eindeutige Kennung und Methoden, mit denen Sie die Belastung belasten / stornieren k√∂nnen. </p><br><p>  Dementsprechend sieht unsere Aufzugsspezifikation f√ºr alle Brieftaschenanbieter folgenderma√üen aus: </p><br><pre> <code class="plaintext hljs">typedef string DigitalWalletID struct DigitalWallet { 1: required DigitalWalletProvider provider 2: required DigitalWalletID id } enum DigitalWalletProvider { qiwi rbkmoney }</code> </pre> <br><p>  und das Hinzuf√ºgen eines neuen Zahlungsmittels in Form einer neuen Brieftasche erg√§nzt einfach enum: </p><br><pre> <code class="plaintext hljs">enum DigitalWalletProvider { qiwi rbkmoney newwallet }</code> </pre> <br><p>  Jetzt m√ºssen alle Microservices mit dieser Spezifikation erweitert, mit dem Repository-Assistenten mit der Spezifikation synchronisiert und √ºber CI / CD bereitgestellt werden. </p><br><p>  Externe Protokolle sind komplizierter.  Es ist fast unm√∂glich, jedes Update der Swagger-Spezifikation, insbesondere ohne Abw√§rtskompatibilit√§t, innerhalb eines angemessenen Zeitrahmens anzuwenden. Es ist unwahrscheinlich, dass unsere Partner kostenlose Entwicklerressourcen speziell f√ºr die Aktualisierung unserer Plattform behalten. </p><br><p>  <em>Und manchmal ist dies einfach unm√∂glich. Gelegentlich sto√üen wir auf Situationen wie: "Der Programmierer hat uns geschrieben und ist gegangen, hat den Quellcode mitgenommen, wie wir arbeiten, wir wissen nicht, es funktioniert und ber√ºhren ihn nicht."</em> </p><br><p>  Daher investieren wir in die Unterst√ºtzung der Abw√§rtskompatibilit√§t mit externen Protokollen.  Dies ist in unserer Architektur etwas einfacher. Da wir f√ºr jede spezifische Version der Common API separate Protokolladapter verwenden, lassen wir nur die alten Capi-Microservices funktionieren und √§ndern bei Bedarf nur den Teil, der wie ein Trift innerhalb der Plattform aussieht.  So erscheinen und bleiben Microservices <code>capi-v1</code> , <code>capi-v2</code> , <code>capi-v3</code> usw. f√ºr immer bei uns. </p><br><p>  Was passiert, wenn <code>capi-v33</code> wir wahrscheinlich einige alte Versionen verwerfen. </p><br><p>  <em>An diesem Punkt fange ich normalerweise an, Unternehmen wie Microsoft und all ihre Schwierigkeiten bei der Unterst√ºtzung der Abw√§rtskompatibilit√§t von L√∂sungen, die seit Jahrzehnten funktionieren, sehr gut zu verstehen.</em> </p><br><h2 id="nastraivaem-sistemu">  Passen Sie das System an </h2><br><p>  Zum Abschluss des Themas erfahren Sie, wie wir die gesch√§ftsspezifischen Plattformeinstellungen verwalten. </p><br><p>  Nur eine Zahlung zu leisten ist nicht so einfach, wie es scheint.  F√ºr jede Zahlung m√∂chte der Gesch√§ftskunde eine Vielzahl von Bedingungen festlegen - von der Provision bis zur prinzipiellen M√∂glichkeit einer erfolgreichen Implementierung je nach Tageszeit.  Wir haben uns die Aufgabe gestellt, alle Bedingungen, die ein Gesch√§ftskunde jetzt und in Zukunft haben kann, zu digitalisieren und auf jede neu gestartete Zahlung anzuwenden. </p><br><p>  Aus diesem Grund haben wir uns entschlossen, ein eigenes DSL zu entwickeln, mit dem wir Tools f√ºr eine bequeme Verwaltung vermasselt haben, mit denen wir das Gesch√§ftsmodell richtig beschreiben k√∂nnen: die Auswahl der Protokolladapter, eine Beschreibung des Buchungsplans, nach der das Geld auf die Konten innerhalb des Systems verteilt wird, Grenzwerte, Provisionen, Kategorien und andere Dinge, die f√ºr das Zahlungssystem spezifisch sind. </p><br><p>  Wenn wir beispielsweise eine Provision von 1% f√ºr den Erwerb von Karten des Maestro und der MS auf Konten im System verteilen m√∂chten, konfigurieren wir die Domain folgenderma√üen: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"cash_flow"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"decisions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"if_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"any_of"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"maestro"</span></span> } } } } }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_tool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bank_card"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"definition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"payment_system_is"</span></span>: <span class="hljs-string"><span class="hljs-string">"mastercard"</span></span> } } } } } ] }, <span class="hljs-attr"><span class="hljs-attr">"then_"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"system"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"destination"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"provider"</span></span>: <span class="hljs-string"><span class="hljs-string">"settlement"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"volume"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"share"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"parts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"p"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"q"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"of"</span></span>: <span class="hljs-string"><span class="hljs-string">"operation_amount"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"details"</span></span>: <span class="hljs-string"><span class="hljs-string">"1% processing fee"</span></span> } ] } } ] } }</code> </pre> <br><p>  Einfach ausgedr√ºckt haben wir alle Plattformeinstellungen oder die Dom√§nenkonfiguration an einem Ort.     ,             JSON.    ,    ,    ,  .        ,  ,     .  ,  CVS/SVN-. </p><br><p>    "               ". , ,     ,     1%,   ,    ,    .    ,        ,   .         ,         . </p><br><p> <em> cvs-like        ,       .   ,    ‚Äî  stateless, ,               .         .         .</em> </p><br><p> <em>    -     .            ,      ,   .     ,    ,                   .</em> </p><br><p> <em>             .     ,   10   ,     ,           .</em> </p><br><p>     , ,    ,   -,       woorl-.    -        JSON-  .    -  JS,       ,      UX: </p><br><p><img src="https://habrastorage.org/webt/c0/ni/ge/c0nigeglg1reebztmvml6svc7ia.jpeg"></p><br><p>           ,    ,         ,          . </p><br><p>     , , . </p><br><p>        ,     ,       SaltStack. </p><br><p> ,    ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de443518/">https://habr.com/ru/post/de443518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de443508/index.html">P√§dagogische Brettspiele f√ºr Programmierer</a></li>
<li><a href="../de443510/index.html">Compaq Armada 7700 Notebook - als Weiterentwicklung der Compaq LTE-Linie</a></li>
<li><a href="../de443512/index.html">Datenanalyse-Hackathon in Nischni Nowgorod</a></li>
<li><a href="../de443514/index.html">Schreiben Sie Ihre Netzwerkschicht in Swift: Protokollorientierter Ansatz</a></li>
<li><a href="../de443516/index.html">Hacker Geohot hat beschlossen, Menschen von der KI-Simulation zu befreien</a></li>
<li><a href="../de443520/index.html">W√§hlen Sie ein Auto f√ºr einen IT-Spezialisten oder Tipps f√ºr Teekannen aus einer Teekanne</a></li>
<li><a href="../de443522/index.html">Hosting: Optionen, Vergleiche, Benutzerstatistiken</a></li>
<li><a href="../de443524/index.html">Do-it-yourself-Flash-Animationen in Unity3D. Erster Teil, Lyrisch</a></li>
<li><a href="../de443526/index.html">Von Algorithmen zu Krebs: Vorlesungen an der School of Bioinformatics</a></li>
<li><a href="../de443528/index.html">Amazon hat Open Distro f√ºr Elasticsearch ver√∂ffentlicht</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>