<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíù üñêÔ∏è üßóüèª Bataille de MERGE. Chronique avec conclusions et morale üë∏ üàØÔ∏è üé¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quelques semaines avant l'important festival de commit - le dernier avant la version feature freeze de PostgreSQL 11 - les newsletters des hackers , c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bataille de MERGE. Chronique avec conclusions et morale</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/412605/"> Quelques semaines avant l'important <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">festival de commit</a> - le dernier avant la version <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>feature freeze</code></a> de <b>PostgreSQL 11</b> - les newsletters des <b>hackers</b> , compressant le chipset dans le package de gauche, ont regard√© le thriller <b>MERGE</b> .  Le directeur du thriller et PDG de <b>2ndQuadrant, <i>Simon Riggs</i></b> , a essay√© de pousser un patch qui impl√©mente la syntaxe de la commande MERGE avec une pers√©v√©rance et une ing√©niosit√© impressionnantes.  Riggs est com√©dien depuis 2009, et avec le statut de com√©dien, vous pouvez approuver les correctifs vous-m√™me.  Il a √©t√© combattu par des comit√©s et des v√©t√©rans de PostgreSQL non moins respect√©s.  Les passions bouillonnaient clairement et implicitement, il ne s'agissait m√™me pas d'insultes directes - un fait surprenant pour les habitu√©s de nombreux forums nationaux.  Cependant, une certaine tension est rest√©e jusqu'√† pr√©sent lorsque la question a √©t√© r√©gl√©e, et il n'y a rien √† discuter. <a name="habracut"></a><br><br>  Mais les passions sont des passions (elles seront discut√©es plus loin), et je voudrais trier sans passion l'essence de ce probl√®me compl√®tement farfelu. <br><br><img src="https://habrastorage.org/webt/t5/zc/ra/t5zcramwnjffszncwjkkkl9xt2g.jpeg"><br><h3>  MERGE dehors </h3><br>  Si cela simplifie compl√®tement, alors la chose est la suivante: nous avons 2 tables avec les m√™mes champs et des donn√©es diff√©rentes.  Supposons le nom et l'√¢ge.  Nous devons les combiner en un seul.  Mais il serait n√©cessaire de d√©cider quoi faire avec ces personnalit√©s qui sont dans les deux tableaux.  Tr√®s probablement, nous voudrons tout dans la table finale et mettre √† jour les informations pour les individus correspondants.  Il est clair que m√™me dans ce contexte, c'est une t√¢che tr√®s courante.  Il peut √™tre r√©solu sans <code>MERGE</code> , ce qui rend une demande complexe, vous pouvez utiliser des d√©clencheurs et ainsi de suite.  Mais c'est g√™nant.  Cependant, la version non canonique de MERGE, appel√©e UPSERT (UPdate + inSERT), r√©sout ce probl√®me. <br><br>  L'op√©rateur MERGE est dans la norme SQL-2003 et d√©j√† dans toute sa splendeur dans SQL-2008.  Il est impl√©ment√© dans Oracle, DB2 et MS SQL, ce qui signifie que le manque de MERGE d√©rangera ceux qui envisagent de passer de ces SGBD √† PostgreSQL.  Le d√©sir ardent de Simon Riggs le plus rapidement possible, d√©j√† dans PostgreSQL 11, a √©t√© aliment√© par les souhaits des clients 2ndQuadrant, et non par l'ambition ou la querelle. <br><br>  En fait, MERGE a des capacit√©s riches, les donn√©es ne doivent pas √™tre extraites de tables, en particulier de structures similaires. <br><br>  La syntaxe de la commande est la suivante: <br><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tablename <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> table_reference <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (condition) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> column1 = value1 [, column2 = value2 ...] <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (column1 [, column2 ...]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (value1 [, value2 ...]);</code> </pre> <br>  Vous pouvez cependant comme ceci: <br><br><pre> <code class="hljs powershell">MERGE <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">hint</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">INTO</span></span></span></span> <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">schema</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">.</span></span></span><span class="hljs-function">] {</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">table</span></span></span></span> | view} <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">table_alias</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USING</span></span></span></span> { subquery | <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">schema</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">.</span></span></span><span class="hljs-function">] { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">table</span></span></span></span> | view}} <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">table_alias</span></span></span><span class="hljs-function">] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ON</span></span></span></span> ( condition ) [ <span class="hljs-type"><span class="hljs-type">merge_update_clause</span></span> ] [ <span class="hljs-type"><span class="hljs-type">merge_insert_clause</span></span> ] [ <span class="hljs-type"><span class="hljs-type">error_logging_clause</span></span> ] ;</code> </pre> <br>  Cette syntaxe est impl√©ment√©e dans Oracle.  En d'autres termes, MERGE effectue des actions qui modifient les enregistrements dans la table cible target_table_name √† l'aide de data_source dans une seule commande SQL, qui peut, selon les conditions, faire INSERT, UPDATE ou DELETE par rapport aux enregistrements dans target_table_name.  Dans ce cas, target_table_name peut √™tre une vue et data_source peut √™tre un ensemble de <b>tables ou de vues, le r√©sultat d'une sous-requ√™te</b> . <br><br>  Premi√®rement, l' <code>MERGE</code> effectue une <code>left outer join</code> sur la <code>data_source</code> de <code>data_source</code> avec <code>target_table_name</code> , sugg√©rant 0 ou plusieurs enregistrements de changement de candidat;  <code>WHEN</code> clauses sont calcul√©es dans l'ordre sp√©cifi√©;  d√®s que la condition est remplie, l'action correspondante est ex√©cut√©e.  Mots cl√©s <code>WHEN [NOT] MATCH THEN</code> n'est pas tr√®s courant en <code>SQL</code> , nous vous rappelons donc qu'il s'agit d'une construction de contr√¥le comme <code>if-else</code> dans d'autres langages.  <code>MERGE</code> agit de la m√™me mani√®re que <code>UPDATE, INSERT</code> ou <code>DELETE</code> qui concerne <code>target_table_name</code> , seule la syntaxe de la commande enti√®re est diff√©rente. <br><br>  Une clause avec <code>ON</code> doit √©tablir une connexion sur toutes les colonnes de la cl√© primaire ou, si d'autres colonnes sont sp√©cifi√©es, alors un index unique doit √™tre utilis√© pour que les conditions <code>[NOT] MATCHED</code> d√©terminent imm√©diatement les actions pour l'enregistrement candidat afin d'exclure l'interaction avec d'autres transactions. <br><br>  Commande d√©terministe <code>MERGE</code> : vous ne pouvez pas mettre √† jour plusieurs fois le m√™me enregistrement dans la m√™me commande MERGE. <br>  Un exemple: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> CustomerAccount CA <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> RecentTransactions T <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> T.CustomerId = CA.CustomerId <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> Balance = Balance + TransactionValue <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (CustomerId, Balance) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (T.CustomerId, T.TransactionValue);</code> </pre> <br>  ou avec une sous-requ√™te: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> bonuses D <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> employee_id, salary, department_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employees <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> department_id = <span class="hljs-number"><span class="hljs-number">80</span></span>) S <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (D.employee_id = S.employee_id) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> D.bonus = D.bonus + S.salary*<span class="hljs-number"><span class="hljs-number">.01</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (S.salary &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (D.employee_id, D.bonus) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (S.employee_id, S.salary*<span class="hljs-number"><span class="hljs-number">.01</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (S.salary &lt;= <span class="hljs-number"><span class="hljs-number">8000</span></span>);</code> </pre> <br>  Dans <b>IBM DB2, la</b> syntaxe fonctionnera √©galement.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comme on dit</a> , "sous le capot", cela se fera de la m√™me mani√®re que la construction <code>UPDATE FROM</code> . <br>  Depuis 2008, <b>MS SQL</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">poss√®de √©galement</a> <code>MERGE</code> . <br><br>  Mais m√™me derri√®re une seule syntaxe standard, le probl√®me du choix parmi un nombre consid√©rable de m√©canismes et de m√©thodes de mise en ≈ìuvre commence.  L'√©quipe doit travailler √† diff√©rents niveaux d'isolement des transactions, avec diff√©rents algorithmes de verrouillage, en se concentrant sur un mode de fonctionnement hautement comp√©titif ou pas si bon.  Et, comme vous pouvez le deviner, pour impl√©menter cette logique compliqu√©e, vous devez toucher √† de nombreux composants SGBD. <br><br><h3>  UPSERT, pseudo-MERGE </h3><br>  Il est clair que les d√©veloppeurs de SGBD recherchaient des solutions de compromis, refusant de reproduire litt√©ralement la syntaxe standard.  Le plus de cette approche est la libert√©.  Vous pouvez utiliser des m√©canismes organiques pour un SGBD particulier, vous pouvez optimiser la mise en ≈ìuvre pour les t√¢ches que vous jugez les plus pertinentes pour vos utilisateurs. <br><br>  Par exemple, dans <b>MySQL,</b> il existe une commande <code>REPLACE</code> qui fonctionne comme <code>INSERT</code> , mais si les nouvelles et anciennes lignes ont les m√™mes valeurs dans l'index <code>PRIMARY KEY</code> ou <code>UNIQUE</code> , alors l'ancienne ligne est supprim√©e avant l'insertion de la nouvelle.  Mais il y a aussi <code>INSERT ... ON DUPLICATE KEY UPDATE</code> o√π <code>INSERT</code> et <code>UPDATE</code> se produisent (au lieu de <code>DELETE</code> dans <code>REPLACE</code> ).  Voici <code>UPSERT</code> .  Et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il y a</a> <code>INSERT IGNORE</code> , qui n'effectue simplement pas l'insertion, sans lancer d'erreur (mais d'avertissement) sous certaines restrictions sur la table cible. <br><br><h3>  Chroniques de PG MERGE </h3><br>  Dans la communaut√© PostgreSQL, parler de MERGE a commenc√© en 2005 lorsque Jaime Casanova a demand√© <i>si quelqu'un dans la communaut√© avait commenc√© √† d√©velopper</i> <code>MERGE</code> .  <i>Peter Eisentraut a</i> <a href="">sugg√©r√© de discuter</a> <i>si PostgreSQL devrait d√©velopper l'une des options MERGE: similaire √† l'impl√©mentation MySQL, ou mieux pour diriger l'effort vers une version fonctionnellement l√©g√®re du type <code>MERGE</code> d'Oracle.</i>  <i>Mais vaut-il la peine de faire des efforts dans ce sens?</i> <br><br>  Au milieu d'une courte discussion, le protagoniste de ce r√©cit <i>Simon Riggs</i> appara√Æt avec les mots: <br>  <i>MERGE est utile √† la fois pour les syst√®mes OLTP et pour DW (Data Warehouse - les entrep√¥ts de donn√©es, c'est-√†-dire les applications analytiques o√π les requ√™tes complexes, mais les environnements et les donn√©es pas trop comp√©titifs sont rarement mis √† jour, et s'ils sont mis √† jour, g√©n√©ralement en gros morceaux. &lt;...&gt; Nous pouvons impl√©menter MERGE comme une variante de COPY FROM, ce sera tr√®s cool.</i> <br><br>  Tout le monde est d'accord: oui, cool.  Plus pr√©cis√©ment, presque tout: <i>Stephen Frost</i> : <i>Je pense que je ne suis pas le seul √† dire que j'ai besoin d'une norme MERGE √† part enti√®re et conforme.</i> <br><br>  Bruce Momjian a une proposition diff√©rente et plus pragmatique: <i>il me semble que nous devons impl√©menter dans</i> <code>MERGE</code> <i>quelques options que nous pouvons impl√©menter, et dans le reste nous donnerons une erreur (et dans les cas o√π il sera n√©cessaire de bloquer la table enti√®re).</i>  <i>Et apr√®s avoir re√ßu les commentaires des utilisateurs et nous r√©fl√©chirons √† la suite.</i> <br><br>  Mais jusqu'√† pr√©sent, rien ne se passe. <br><br><h3>  La glace s'est bris√©e </h3><br>  En <b>2008,</b> <i>Simon Riggs a de</i> nouveau exhort√© √† traiter avec MERGE - laquelle des fa√ßons de choisir (d'ici l√†, une nouvelle version de MERGE dans la norme SQL-2008, qui est encore en √©bauche, est d√©j√† en train d'appara√Ætre).  Il peint en d√©tail √† ce moment l'impl√©mentation d'Oracle, IBM et MS SQL et la syntaxe alternative de MySQL et Teradata.  Et un peu plus tard, il mentionne d√©j√† le <b>d√©but des travaux dans 2ndQuadrant</b> dans ce sens. <br><br>  Peter Eisentraut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit sur son blog</a> : <i>Bien s√ªr, Riggs est l'un des sp√©cialistes les plus qualifi√©s, il peut diriger les travaux sur la mise en ≈ìuvre de MERGE.</i> <br><br>  Mais voici le premier virage inattendu: un <b>√©tudiant</b> est impliqu√© dans le probl√®me - un participant au d√©veloppement du programme <b>GSoC</b> , c'est-√†-dire Google Summer of Code.  Son nom est <i>Boxuan Bxzhai</i> - je ne pr√©tends pas transcrire le nom de famille.  Bient√¥t, il √©crit que le travail est presque termin√©. <br><br>  Mais presque ne compte pas.  <i>Greg Smith</i> de 2ndQuadrant (c'est-√†-dire l'alli√© de Simon Riggs) √©crit: <br>  <i>Nous avons donc un correctif dans le code dont une demi-douzaine de probl√®mes graves non r√©solus.</i>  <i>Je me tais sur les petits.</i>  <i>Les probl√®mes sont trop profonds pour finaliser le code du commitfest.</i>  <i>Pendant ce temps, rien n'a √©t√© entendu de Boxuan depuis longtemps.</i>  <i>Nous pourrions l'aider, mais o√π est-il?</i>  <i>Qui est au courant?</i> <br><br>  Une discussion sur les chemins d'impl√©mentation refait surface en <b>2014</b> , mais l√† encore rien ne se passe: il n'y a pas de code. <br><br>  Enfin, d√®s <b>2017,</b> <i>Simon Riggs</i> √©crit: <br>  <i>Je travaille sur du code pour valider <code>MERGE</code> dans <b>PostgreSQL</b> version <b>11</b> .</i>  <i>Nous utilisons les m√™mes m√©canismes qui sous-tendent le <code>INSERT ON CONFLICT</code> , qui fonctionne d√©j√†, afin qu'aucune modification d'infrastructure ne soit n√©cessaire, en impl√©mentant simplement la syntaxe en plus de ce qui est disponible.</i>  <i>Mais j'√©cris mon code √† partir de z√©ro, je n'utilise pas les d√©veloppements pr√©c√©dents.</i> <br><br>  Nous parlons de Peter Geoghegan ( <b>VMware</b> ) impl√©ment√© √† cette √©poque d√©j√† dans la syntaxe alternative <code>INSERT .. ON CONFLICT UPDATE</code> 9.5 <code>INSERT .. ON CONFLICT UPDATE</code> , diff√©rent du standard SQL, mais toujours li√© √† <code>MERGE</code> et <code>REPLACE</code> dans MySQL. <br><br>  Au d√©but, le travail de Simon a rencontr√© des exclamations du travail de Nice!  Cependant, <i>Robert Haas</i> , bien que favorable, met en garde contre d'√©ventuelles anomalies de s√©rialisation.  Par exemple, pour g√©rer <code>INSERT .. ON CONFLICT UPDATE</code> , sans MERGE √† sa base, c'est en quelque sorte plus calme. <br><br>  <code>UPSERT</code> auteur de PostgreSQL <code>UPSERT</code> lui-m√™me: <br>  <i>Je ne m√©langerais pas le <code>MERGE</code> <code>ON CONFLICT DO UPDATE</code> et <code>MERGE</code> .</i>  <i>&lt;...&gt; Pour charger de gros morceaux de donn√©es ( <code>bulk load</code> ), j'utiliserais, par exemple, l'algorithme de <code>merge join</code> .</i>  <i>&lt;...&gt; En g√©n√©ral, les avantages de <code>MERGE</code> seraient li√©s au fait que les connexions normales y fonctionneraient de la mani√®re habituelle: <code>nested loop, hash, merge</code> .</i>  <i>Et dans <code>INSERT ‚Ä¶ ON CONFLICT</code> il n'y a aucune jointure.</i> <br><br>  Haas: <i>Comme Peter, je pense que si cela est fait de cette fa√ßon, alors un tel verrou fort lors de l'ex√©cution d'une demande <code>DML</code> semble moyen.</i>  <i>Il est peu probable que quiconque soit satisfait qu'une seule personne puisse travailler avec <code>MERGE</code> √† la fois.</i> <br><br>  Pour ceux qui sont curieux: Geigan analyse les subtilit√©s et les diff√©rences <code>UPSERT</code> entre <code>MERGE</code> et <code>MERGE</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> (nous stockons la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">correspondance archiv√©e de</a> PostgreSQL sur notre site Web). <br><br>  Simon r√©siste.  Il fait appel √† l'histoire r√©cente.  Par exemple, √† propos de la section, ils ont √©galement dit "une nouvelle syntaxe, rien de plus".  Mais cela s'est av√©r√© √™tre une chose tr√®s utile.  <i>Mais je ne propose pas de r√©aliser tout de suite tout ce qu'il y a dans MERGE.</i>  <i>Nous ferons la m√™me chose qu'avec le partitionnement - nous divisons le d√©veloppement en phases.</i> <br><br>  Et un autre argument, √† mon avis, est tr√®s convaincant: <i>bien.</i>  <i>Mais choisissons.</i>  <i>Je propose une option pratique.</i>  <i><b>10 ans viendront bient√¥t</b> de la premi√®re tentative s√©rieuse de d√©velopper <code>MERGE</code> .</i>  <i>N'est-il pas temps de commencer √† faire quelque chose, d'obtenir une solution utile, au lieu d'attendre encore 10 ans de la solution parfaite?</i>  <i>En supposant que cela existe.</i> <br><br>  Enfin, le patch arrive dans la communaut√©.  Quelle date?  Imaginez s'il vous pla√Æt.  Non, ils n'ont pas devin√©: Simon l'envoie le 30 d√©cembre 2017.  Et stipule qu'il s'agit d'un correctif WIP, c'est-√†-dire Work in Progress - un correctif en cours. <br><br>  Simon, janvier: <br>  <i>Le patch est termin√© sans aucun bogue sp√©cial.</i>  <i><b>1200 lignes de code</b> plus tests et documentation.</i>  <i>Je vais le confier √† ce commitfest, et nous compl√©terons le RLS (Row Level Security - protection au niveau de l'enregistrement) et le support de partitionnement plus tard.</i> <br><br><h3>  Caste des commissions </h3><br>  Ici, nous devons prendre un pas de c√¥t√© et expliquer le r√¥le du commissaire dans la communaut√©.  Les fonctions du commissaire, c'est-√†-dire celui qui est autoris√© √† accepter le patch dans la prochaine version, ont historiquement chang√©.  Il √©tait une fois, quand il y avait peu de d√©veloppeurs, le droit de s'engager √©tait g√©n√©reusement distribu√©.  Par exemple, le c√©l√®bre (dans un domaine compl√®tement diff√©rent) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>Julian Assange a</b></a> re√ßu le titre de commandant, √©tant l'auteur de seulement six patchs.  Maintenant, ce n'est pas facile de devenir commissaire, il n'y a pas de parvenus sur la liste de quelques dizaines de personnes.  Boyus Momdjan ( <b>EnterpriseDB</b> ) a 13 363 commits, Tom Lane (Tom Lane, <b>Crunchy Data</b> ) 13127, Robert Haas ( <b>EnterpriseDB</b> ) - 2074. Soit dit en passant, le <b>seul committer de Russie</b> est <i>Fedor Sigaev</i> ( <b>Postgres Professional</b> ) avec ses 383 commits .  Simon Riggs en a lui-m√™me 449. Je le r√©p√®te: en tant que commissaire, il a suffisamment d'autorit√© pour prendre et commettre des correctifs - lui et ses employ√©s.  Une autre chose est que cela ne vaut gu√®re la peine de le faire, n√©gligeant franchement les opinions des autres principaux comit√©s de sommit√©s.  Ils peuvent √©galement priver le statut de commissaire, mais au moins ils <code>revert</code> patch. <br><br><h3>  Fracture au combat </h3><br>  Bien s√ªr, dans le patch "d√©sesp√©r√©", fait, en g√©n√©ral, √† la h√¢te, ils trouvent de nouvelles erreurs.  Les nouvelles versions roulent en r√©ponse. <br><br>  Fin janvier, un nouveau personnage appara√Æt: le d√©veloppeur de 2ndQuadrant <i>Pavan</i> (son nom est tout le monde par son nom; compl√®tement Pavan Deolasee).  Maintenant, la communaut√© a affaire √† un tandem: Pavan envoie de nouvelles versions et merci pour les critiques, et Simon les brise avec une pression marketing remarquable. <br><br>  Haas: <i>Je ne pense pas que cela vaut la peine de prendre des d√©cisions unilat√©rales sur l'exclusion des fonctionnalit√©s qui fonctionnent partout.</i>  <i>Si nous convenons que certaines fonctionnalit√©s ne seront pas incluses dans ce patch - c'est une chose.</i>  <i>Et c'est compl√®tement diff√©rent que dans les commentaires √† cette occasion, tout le monde ait exprim√© son d√©saccord.</i>  <i>Et nous n'avons en fait pas entendu les raisons pour lesquelles ces fonctionnalit√©s devraient √™tre exclues.</i> <br><br>  La logique a √©t√© pr√©sent√©e comme suit: <br><br><ul><li>  a priori, il y a de s√©rieux probl√®mes car ils ne peuvent qu'√™tre dans les √©volutions du style ¬´attaque de cavalerie¬ª. </li><li>  La prise en charge de fonctionnalit√©s m√™me importantes telles que le nouveau partitionnement dans les versions 10-11, CTE (Common Table Expressions = WITH queries) ou RLS (Row Level Security) peut √™tre termin√©e m√™me apr√®s l'acceptation du correctif dans la version actuelle, mais uniquement si l'architecture propos√©e convient pour la construction par le haut sa fonctionnalit√© souhait√©e. </li></ul><br>  Le deuxi√®me Peter Geigan formule ceci: <br>  <i>Habituellement, je fais attention au <b>support de diverses fonctionnalit√©s, car si c'est le cas, cela renforce la croyance g√©n√©rale que le design est fait comme il se doit</b> .</i>  <i>Et si de tels probl√®mes sont caus√©s par la prise en charge des expressions <code>WITH</code> [c'est-√†-dire <code>CTE</code> ], j'ai alors l'id√©e que l'architecture sous-jacente est telle qu'elle causera des probl√®mes ici et l√†.</i> <br><br>  Pendant ce temps, l'heure X (le dernier comit√©) approche et les nuages ‚Äã‚Äãau-dessus de MERGE se rassemblent.  Ce n'est pas que les p√®res fondateurs aient sp√©cifiquement recherch√© de s√©rieux probl√®mes dans l'architecture des patchs r√©alis√©s par Simon puis Pavan.  Je n'ai pas eu √† chercher de probl√®mes, ils se sont volontairement ouverts. <br><br><h3>  Le d√©nouement approche </h3><br>  L'intrigue s'acc√©l√®re.  Malgr√© l'attitude cool des autres comit√©s envers son entreprise, <b>le 2 avril,</b> Simon d√©cide de valider la <b>commande SQL SQL 2016</b> , ajoute les fichiers, Depesz (Hubert Lubachevsky) parvient √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annoncer</a> sur son blog, mais le m√™me jour, Simon annule tout parce que des erreurs. <br><br>  Le lendemain, engagez-vous √† nouveau en ajoutant <code>WITH</code> support. <br><br>  En r√©ponse, les all√©gations sont vraiment graves.  <i>Andres Freund</i> ( <b>EnterpriseDB</b> ) √©crit: <br>  <i>L'architecture de MERGE dans l'analyseur et l'ex√©cuteur testamentaire ne m'a pas impressionn√© de mani√®re fiable.</i>  <i>La cr√©ation de jointures cach√©es lors de l'analyse syntaxique est une tr√®s mauvaise id√©e.</i>  <i>Cette structure de l'ex√©cuteur doit √™tre compl√®tement modifi√©e.</i> <br><br>  Tom Lane: <br>  <i>La conception de l'arbre d'analyse est faible.</i> <br><br><br><br>  <i>Vous surchargez la fonction <code>InsertStmt</code> , poursuit-il, elle ne fait pas du tout <code>INSERT</code> , mais elle a al√©atoirement les m√™mes champs que celui d'origine.</i>  <i>Et pas tous, mais certains.</i>  <i>C'est mauvais, cela m√®ne √† la confusion.</i> <br><br>  Ajoutons des observations de <i>Fedor Sigayev</i> : <br>  <i>Dans l'analyseur, des n≈ìuds <code>INSERT</code> li√©s √† <code>MERGE</code> sont apparus, accroch√©s √† un tas de champs suppl√©mentaires.</i>  <i>Si vous regardez le plan d'ex√©cution dans <code>ANALIZE</code> , vous ne comprendrez pas imm√©diatement si vous avez affaire √† un <code>INSERT</code> r√©gulier ou √† <code>MERGE</code> : pour comprendre, vous devez regarder des champs suppl√©mentaires.</i> <br><br><br>  Simon, calmement: <i>OK, nous allons changer cela et envoyer un nouveau fichier demain</i> . <br>  Haas: <i>Je suis d'accord avec Peter.</i>  <i>Le choix de l'architecture est infructueux.</i> <br><br>  Simon n'abandonne pas.  <b>Le 6 avril,</b> en r√©ponse aux critiques de Tom Lane, commet un nouveau patch tel que modifi√© dans l'analyseur. <br><br><h3>  N√©gociation et remise </h3><br>  Bruce Momjan <b>6 avril</b> : <br>  <i>Je veux noter que les gens ne vous ont pas demand√© de travailler dur pour r√©parer quelque chose de toute urgence.</i>  <i>Ils vous ont demand√© de retirer le patch.</i>  <i>Vous pouvez bien s√ªr travailler dur, en esp√©rant qu'ils changeront d'avis, mais - encore une fois - ils ne vous ont pas pos√© de questions √† ce sujet.</i> <br><br>  Simon: <i>Si Tom [Lane] et Andres [Freund] pour les quelques jours restants estiment toujours que leurs craintes n'ont pas √©t√© dissip√©es, je <b>serai heureux de faire reculer le patch</b> sans plus tarder.</i> <br><br>  Tom Lane: <i>Je vote toujours pour que le patch soit annul√©.</i>  <i>M√™me s'il √©tait parfait maintenant, les gens n'ont plus le temps d'en √™tre convaincus - √† la gorge d'autres questions urgentes.</i> <br><br>  C‚Äôest tout. <br><br>  Simon a dit OK, et la bataille de <code>MERGE</code> termin√©e.  Tous les correctifs sont pomp√©s, le sujet a √©t√© d√©plac√© vers le prochain commitfest avec le statut "En attente de la fin de l'auteur".  Les participants au spectacle ont fait la paix. <br><br><img src="https://habrastorage.org/webt/ad/zw/ry/adzwryarovhxoldwxewpneljyms.jpeg"><br>  Cependant, √† en juger par la correspondance des derni√®res semaines, une certaine tension semble persister. <br><br><h3>  Moralit√© promise </h3><br><ul><li>  Heureusement, la communaut√© PostgreSQL dispose de m√©canismes naturels et formels pour le filtrage (presque) sans conflit des tentatives de solutions immatures.  M√™me s'ils sont poin√ßonn√©s par des d√©veloppeurs respect√©s au rang de chef d'entreprise, dont la contribution au d√©veloppement de PostgreSQL est √©norme.  Et les clients qui manquent de fonctionnalit√©s poussent √† investir. </li><li>  Malheureusement, la communaut√© cale souvent.  Elle est inertielle dans l'adoption d'√©volutions pertinentes, m√™me sans ambigu√Øt√©.  Parfois, le perfectionnisme irrationnel est inclus.  L'exp√©rience de Postgres Professional, o√π je travaille, le confirme.  Nous avons perfor√© un patch important et important d' <b>indices INCLUDE</b> pendant 3 ans.  Une s√©rie de correctifs utiles pour travailler avec <b>JSON / JSONB</b> attend toujours.  L'expression "donnez votre d√©veloppement √† la communaut√©" ne signifie <b>pas vraiment donner, mais donner des coups de poing</b> : l'invit√© est accueilli √† bras ouverts et escort√© en quarantaine. </li></ul><br>  PS: <i>Avis de non-responsabilit√© de l'auteur</i> : nous voulions simplement montrer un morceau de vie communautaire.  Toutes les correspondances de noms sont al√©atoires :) <br>  PPS: Samurai <i>Natalia Levshina</i> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412605/">https://habr.com/ru/post/fr412605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412591/index.html">Construire un jetpack: le 29 mai est le Memorial Day de Wendell Moore</a></li>
<li><a href="../fr412593/index.html">Nouveaux produits, plates-formes et tout-en-un: Webinaires HPE</a></li>
<li><a href="../fr412595/index.html">Rapport 2018 du Club de Rome, chapitre 1.1.2: ¬´Financement¬ª</a></li>
<li><a href="../fr412597/index.html">Jeff Bezos va construire une colonie √† la surface de la lune</a></li>
<li><a href="../fr412603/index.html">√âtranges d√©clarations PHP</a></li>
<li><a href="../fr412607/index.html">Station de soudage r√©versible classe HI-END</a></li>
<li><a href="../fr412609/index.html">10 conseils pour la productivit√© dans CLion, un IDE C / C ++ multiplateforme</a></li>
<li><a href="../fr412611/index.html">Qu'ont en commun l'efficacit√© de l'exploitation mini√®re et de la th√©orie des jeux</a></li>
<li><a href="../fr412613/index.html">Arithm√©tique enti√®re. Divisez en arrondissant le r√©sultat. Partie 1</a></li>
<li><a href="../fr412615/index.html">Pr√©sence d'un objectif de route dans les annonces BGP entre PE et CE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>