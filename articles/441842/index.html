<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé§ üôáüèø üìµ Pr√°ctica: consejos para escribir programas compatibles en el mundo real üîö üöû üíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo se centra en las mejores pr√°cticas para escribir el c√≥digo Go. Est√° compuesto en el estilo de presentaci√≥n, pero sin las diapositivas ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√°ctica: consejos para escribir programas compatibles en el mundo real</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441842/">  Este art√≠culo se centra en las mejores pr√°cticas para escribir el c√≥digo Go.  Est√° compuesto en el estilo de presentaci√≥n, pero sin las diapositivas habituales.  Intentaremos revisar breve y claramente cada elemento. <br><br>  Primero debe acordar qu√© significan las <i>mejores</i> pr√°cticas para un lenguaje de programaci√≥n.  Aqu√≠ puede recordar las palabras de Russ Cox, director t√©cnico de Go: <br><br><blockquote>  La ingenier√≠a de software es lo que sucede con la programaci√≥n, si agrega el factor tiempo y otros programadores. </blockquote><br>  Por lo tanto, Russ distingue entre los conceptos de <i>programaci√≥n</i> e <i>ingenier√≠a de software</i> .  En el primer caso, usted escribe un programa para usted, en el segundo crea un producto en el que otros programadores trabajar√°n con el tiempo.  Los ingenieros van y vienen.  Los equipos crecen o se reducen.  Se agregan nuevas funciones y se corrigen errores.  Esta es la naturaleza del desarrollo de software. <br><a name="habracut"></a><br><a name="0"></a><h1>  Contenido </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Contenido</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1. Principios fundamentales</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Simplicidad</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Legibilidad</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Productividad</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2. Identificadores</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Identificadores de nombre basados ‚Äã‚Äãen la claridad en lugar de la brevedad</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ID longitud</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">No nombrar variables por tipo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Use un solo estilo de nomenclatura</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Use un estilo de declaraci√≥n √∫nico</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2.6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Trabajar para el equipo</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3. Comentarios</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los comentarios en variables y constantes deben describir su contenido, no su prop√≥sito</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">3.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Siempre documente personajes disponibles p√∫blicamente</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4. estructura del paquete</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Un buen paquete comienza con un buen nombre</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Evite nombres como base, com√∫n o util</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Regresa r√°pidamente sin zambullirte profundamente</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hacer que el valor nulo sea √∫til</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4.5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Evitar estado de nivel de paquete</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">5. Estructura del proyecto</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">5.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Menos paquetes pero m√°s grandes</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">5.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El paquete principal m√°s peque√±o</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">6. estructura API</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">6.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API de dise√±o que son dif√≠ciles de abusar por dise√±o</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">6.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dise√±ar una API para un caso de uso b√°sico</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">6.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Deje que las funciones determinen el comportamiento deseado.</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7. Manejo de errores</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Elimine la necesidad de manejar errores eliminando los errores mismos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Manejar el error solo una vez</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">8. Concurrencia</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">8.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Haz algo de trabajo todo el tiempo.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">8.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Deja paralelismo a la persona que llama</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">8.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nunca ejecute goroutine sin saber cu√°ndo se detendr√°</a> </li></ul></li></ul><br><a name="1"></a><h1>  1. Principios fundamentales </h1><br>  Puedo ser uno de los primeros usuarios de Go entre ustedes, pero esta no es mi opini√≥n personal.  Estos principios b√°sicos son la base del propio Go: <br><br><ol><li>  Simplicidad </li><li>  Legibilidad </li><li>  Productividad </li></ol><br>  <i>Nota</i>  <i>Tenga en cuenta que no mencion√© "rendimiento" o "concurrencia".</i>  <i>Hay idiomas m√°s r√°pidos que Go, pero ciertamente no se pueden comparar en simplicidad.</i>  <i>Hay lenguajes que priorizan el paralelismo, pero no se pueden comparar en t√©rminos de legibilidad o productividad de programaci√≥n.</i> <i><br><br></i>  <i>El rendimiento y la concurrencia son atributos importantes, pero no tan importantes como la simplicidad, la legibilidad y la productividad.</i> <br><br><a name="1_1"></a><h2>  Simplicidad </h2><br><blockquote>  <i>"La simplicidad es un requisito previo para la fiabilidad"</i> - Edsger Dijkstra </blockquote><br>  ¬øPor qu√© luchar por la simplicidad?  ¬øPor qu√© es importante que los programas Go sean simples? <br><br>  Cada uno de nosotros se encontr√≥ con un c√≥digo incomprensible, ¬øverdad?  Cuando tiene miedo de hacer un cambio porque romper√° otra parte del programa que no comprende y no sabe c√≥mo solucionar.  Esta es la dificultad. <br><br><blockquote>  <i>‚ÄúHay dos formas de dise√±ar software: la primera es hacerla tan simple que no haya fallas obvias, y la segunda es hacerla tan compleja que no haya fallas obvias.</i>  <i>El primero es mucho m√°s dif√≠cil ‚Äù.</i> - C.E. R. Hoar </blockquote><br>  La complejidad convierte el software confiable en poco confiable.  La complejidad es lo que mata los proyectos de software.  Por lo tanto, la simplicidad es el objetivo final de Go.  Cualesquiera que sean los programas que escribamos, deber√≠an ser simples. <br><br><a name="1_2"></a><h2>  1.2.  Legibilidad </h2><br><blockquote>  <i>"La legibilidad es una parte integral de la mantenibilidad"</i> - Mark Reinhold, Conferencia JVM, 2018 </blockquote><br>  ¬øPor qu√© es importante que el c√≥digo sea legible?  ¬øPor qu√© debemos luchar por la legibilidad? <br><br><blockquote>  <i>"Los programas deben estar escritos para personas, y las m√°quinas simplemente los ejecutan"</i> - Hal Abelson y Gerald Sassman, "Estructura e interpretaci√≥n de programas de computadora" </blockquote><br>  No solo los programas Go, sino que generalmente todo el software est√° escrito por personas para personas.  El hecho de que las m√°quinas tambi√©n procesen c√≥digo es secundario. <br><br>  Una vez que el c√≥digo escrito sea le√≠do repetidamente por la gente: cientos, si no miles de veces. <br><br><blockquote>  <i>"La habilidad m√°s importante para un programador es la capacidad de comunicar ideas de manera efectiva".</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gaston Horker</a> </blockquote><br>  La legibilidad es la clave para comprender lo que hace un programa.  Si no puede entender el c√≥digo, ¬øc√≥mo mantenerlo?  Si el software no puede ser soportado, ser√° reescrito;  y esta puede ser la √∫ltima vez que su empresa usa Go. <br><br>  Si est√° escribiendo un programa para usted, haga lo que funcione para usted.  Pero si esto es parte de un proyecto conjunto o si el programa se utilizar√° el tiempo suficiente para cambiar los requisitos, las funciones o el entorno en el que funciona, su objetivo es hacer que el programa sea sostenible. <br><br>  El primer paso para escribir software compatible es asegurarse de que el c√≥digo sea claro. <br><br><a name="1_3"></a><h2>  1.3.  Productividad </h2><br><blockquote>  <i>"El dise√±o es el arte de organizar el c√≥digo para que funcione hoy, pero siempre apoya el cambio".</i> - Sandy Mets </blockquote><br>  Como √∫ltimo principio b√°sico, quiero nombrar la productividad del desarrollador.  Este es un gran tema, pero se reduce a la proporci√≥n: cu√°nto tiempo pasas en un trabajo √∫til y cu√°nto, esperando una respuesta de las herramientas o deambulaciones desesperadas en una base de c√≥digo incomprensible.  Los programadores de Go deber√≠an sentir que pueden manejar mucho trabajo. <br><br>  Es una broma que el lenguaje Go se desarroll√≥ mientras se compilaba el programa C ++.  La compilaci√≥n r√°pida es una caracter√≠stica clave de Go y un factor clave para atraer nuevos desarrolladores.  Aunque se est√°n mejorando los compiladores, en general, la compilaci√≥n de minutos en otros idiomas lleva unos segundos en Go.  Entonces, los desarrolladores de Go se sienten tan productivos como los programadores en lenguajes din√°micos, pero sin ning√∫n problema con la confiabilidad de esos lenguajes. <br><br>  Si hablamos fundamentalmente sobre la productividad de los desarrolladores, entonces los programadores de Go comprenden que leer el c√≥digo es esencialmente m√°s importante que escribirlo.  En esta l√≥gica, Go incluso llega a usar las herramientas para formatear todo el c√≥digo en un estilo determinado.  Esto elimina la m√°s m√≠nima dificultad para aprender el dialecto espec√≠fico de un proyecto en particular y ayuda a identificar errores porque simplemente se <i>ven</i> mal en comparaci√≥n con el c√≥digo normal. <br><br>  Los programadores de Go no pasan d√≠as depurando errores de compilaci√≥n extra√±os, scripts de compilaci√≥n complejos o implementando c√≥digo en un entorno de producci√≥n.  Y lo m√°s importante, no pierden el tiempo tratando de entender lo que escribi√≥ un colega. <br><br>  Cuando los desarrolladores de Go hablan de <i>escalabilidad</i> , se refieren a la productividad. <br><br><a name="2"></a><h1>  2. Identificadores </h1><br>  El primer tema que discutiremos: <i>identificadores</i> , es sin√≥nimo de <i>nombres</i> : nombres de variables, funciones, m√©todos, tipos, paquetes, etc. <br><br><blockquote>  <i>"El mal nombre es un s√≠ntoma de mal dise√±o"</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dave Cheney</a> </blockquote><br>  Dada la sintaxis limitada de Go, los nombres de los objetos tienen un gran impacto en la legibilidad del programa.  La legibilidad es un factor clave en un buen c√≥digo, por lo que elegir buenos nombres es crucial. <br><br><a name="2_1"></a><h2>  2.1.  Identificadores de nombre basados ‚Äã‚Äãen la claridad en lugar de la brevedad </h2><br><blockquote>  <i>‚ÄúEs importante que el c√≥digo sea obvio.</i>  <i>Lo que puedes hacer en una l√≠nea, debes hacerlo en tres. ‚Äù</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ukia Smith</a> </blockquote><br>  Go no est√° optimizado para frases complicadas o el n√∫mero m√≠nimo de l√≠neas en un programa.  No optimizamos el tama√±o del c√≥digo fuente en el disco, ni el tiempo requerido para escribir el programa en el editor. <br><br><blockquote>  <i>‚ÄúUn buen nombre es como un buen chiste.</i>  <i>Si necesita explicarlo, ya no es divertido ".</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dave Cheney</a> </blockquote><br>  La clave para la m√°xima claridad son los nombres que elegimos para identificar los programas.  ¬øQu√© cualidades son inherentes a un buen nombre? <br><br><ul><li>  <b>Un buen nombre es conciso</b> .  No tiene que ser el m√°s corto, pero no contiene exceso.  Tiene una alta relaci√≥n se√±al / ruido. </li><li>  <b>Un buen nombre es descriptivo</b> .  Describe el uso de una variable o constante, <i>no los</i> contenidos.  Un buen nombre describe el resultado de una funci√≥n o el comportamiento de un m√©todo, <i>no una</i> implementaci√≥n.  El prop√≥sito del paquete, <i>no</i> su contenido.  Cuanto m√°s exactamente el nombre describa lo que identifica, mejor. </li><li>  <b>Un buen nombre es predecible</b> .  Por un nombre debes entender c√≥mo se usar√° el objeto.  Los nombres deben ser descriptivos, pero tambi√©n es importante seguir la tradici√≥n.  A eso se refieren los programadores de Go cuando dicen <i>"idiom√°tico"</i> . </li></ul><br>  Consideremos con m√°s detalle cada una de estas propiedades. <br><br><a name="2_2"></a><h2>  2.2.  ID longitud </h2><br>  A veces, el estilo de Go es criticado por nombres cortos de variables.  Como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dijo</a> Rob Pike, "los programadores de Go quieren identificadores de la longitud <i>correcta</i> ". <br><br>  Andrew Gerrand ofrece identificadores m√°s largos para indicar importancia. <br><br><blockquote>  <i>"Cuanto mayor sea la distancia entre la declaraci√≥n de un nombre y el uso de un objeto, m√°s largo debe ser el nombre"</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Andrew Gerrand</a> </blockquote><br>  Por lo tanto, se pueden hacer algunas recomendaciones: <br><br><ul><li>  Los nombres cortos de variables son buenos si la distancia entre la declaraci√≥n y el <i>√∫ltimo</i> uso es peque√±a. <br></li><li>  Los nombres largos de variables deben justificarse a s√≠ mismos;  cuanto m√°s largos sean, m√°s importantes deber√≠an ser.  Los t√≠tulos detallados contienen poca se√±al en relaci√≥n con su peso en la p√°gina. <br></li><li>  No incluya el nombre del tipo en el nombre de la variable. <br></li><li>  Los nombres constantes deben describir el valor interno, no c√≥mo se usa el valor. <br></li><li>  Prefiera variables de una sola letra para bucles y ramas, palabras separadas para par√°metros y valores de retorno, palabras m√∫ltiples para funciones y declaraciones a nivel de paquete. <br></li><li>  Prefiere palabras simples para m√©todos, interfaces y paquetes. <br></li><li>  Recuerde que el nombre del paquete es parte del nombre que usa la persona que llama como referencia. </li></ul><br>  Considera un ejemplo. <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Person <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Name <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Age <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> } <span class="hljs-comment"><span class="hljs-comment">// AverageAge returns the average age of people. func AverageAge(people []Person) int { if len(people) == 0 { return 0 } var count, sum int for _, p := range people { sum += p.Age count += 1 } return sum / count }</span></span></code> </pre> <br>  En la d√©cima l√≠nea, <code>p</code> declara una variable de rango <code>p</code> , y se llama solo una vez desde la siguiente l√≠nea.  Es decir, la variable vive en la p√°gina durante muy poco tiempo.  Si el lector est√° interesado en el papel de <code>p</code> en el programa, solo necesita leer dos l√≠neas. <br><br>  A modo de comparaci√≥n, las <code>people</code> declaran en los par√°metros de la funci√≥n y viven siete l√≠neas.  Lo mismo ocurre con la <code>sum</code> y el <code>count</code> , por lo que justifican sus nombres m√°s largos.  El lector necesita escanear m√°s c√≥digo para encontrarlos: esto justifica los nombres m√°s distinguidos. <br><br>  Puede elegir <code>s</code> para <code>sum</code> <code>c</code> (o <code>n</code> ) para <code>count</code> , pero esto reduce la importancia de todas las variables en el programa al mismo nivel.  Puede reemplazar <code>people</code> con <code>p</code> , pero habr√° un problema, c√≥mo llamar a la variable de iteraci√≥n <code>for ... range</code> .  Una sola <code>person</code> se ver√° extra√±a, porque una variable de iteraci√≥n de corta duraci√≥n obtiene un nombre m√°s largo que varios valores de los que se deriva. <br><br><blockquote>  <b>Consejo</b>  Separe la secuencia de funciones con l√≠neas vac√≠as, ya que las l√≠neas vac√≠as entre p√°rrafos interrumpen el flujo de texto.  En <code>AverageAge</code> , tenemos tres operaciones consecutivas.  Primero, verificando la divisi√≥n por cero, luego la conclusi√≥n de la edad total y el n√∫mero de personas, y el √∫ltimo: el c√°lculo de la edad promedio. </blockquote><br><h3>  2.2.1.  Lo principal es el contexto. </h3><br>  Es importante comprender que la mayor√≠a de los consejos de nombres son espec√≠ficos del contexto.  Me gusta decir que este es un principio, no una regla. <br><br>  ¬øCu√°l es la diferencia entre <code>i</code> e <code>index</code> ?  Por ejemplo, no puede decir con certeza que dicho c√≥digo <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> index := <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s); index++ { <span class="hljs-comment"><span class="hljs-comment">// }</span></span></code> </pre> <br>  fundamentalmente m√°s legible que <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s); i++ { <span class="hljs-comment"><span class="hljs-comment">// }</span></span></code> </pre> <br>  Creo que la segunda opci√≥n no es peor, porque en este caso la regi√≥n <code>i</code> o <code>index</code> limitada por el cuerpo del ciclo <code>for</code> , y la verbosidad adicional agrega poco a la comprensi√≥n del programa. <br><br>  Pero, ¬øcu√°l de estas funciones es m√°s legible? <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *SNMP)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oid []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, index </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span></code> </pre> <br>  o <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *SNMP)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(o []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, i </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span></code> </pre> <br>  En este ejemplo, <code>oid</code> es una abreviatura de ID de objeto SNMP, y la abreviatura adicional <code>o</code> obliga a cambiar de una notaci√≥n documentada a una m√°s corta en el c√≥digo al leer el c√≥digo.  Del mismo modo, reducir el <code>index</code> a <code>i</code> hace que sea m√°s dif√≠cil de entender, porque en los mensajes SNMP, el subvalor de cada OID se denomina √≠ndice. <br><br><blockquote>  <b>Consejo</b>  No combine par√°metros formales largos y cortos en un anuncio. </blockquote><br><a name="2_3"></a><h2>  2.3.  No nombrar variables por tipo </h2><br>  No llamas a tus mascotas "perro" y "gato", ¬øverdad?  Por la misma raz√≥n, no debe incluir el nombre del tipo en el nombre de la variable.  Debe describir el contenido, no su tipo.  Considere un ejemplo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usersMap <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]*User</code> </pre> <br>  ¬øDe qu√© sirve este anuncio?  Vemos que este es un mapa, y tiene algo que ver con el <code>*User</code> Tipo de <code>*User</code> : probablemente sea bueno.  Pero <code>usersMap</code> es <i>realmente un</i> mapa, y Go, como lenguaje est√°ticamente tipado, no permitir√° usar accidentalmente dicho nombre cuando se requiera una variable escalar, por lo que el sufijo <code>Map</code> es redundante. <br><br>  Considere una situaci√≥n en la que se agregan otras variables: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( companiesMap <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]*Company productsMap <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]*Products )</code> </pre> <br>  Ahora tenemos tres variables de tipo de mapa: <code>usersMap</code> , <code>companiesMap</code> y <code>productsMap</code> , y todas las l√≠neas se asignan a diferentes tipos.  Sabemos que estos son mapas, y tambi√©n sabemos que el compilador arrojar√° un error si tratamos de usar <code>companiesMap</code> donde el c√≥digo espera <code>map[string]*User</code> .  En esta situaci√≥n, est√° claro que el sufijo <code>Map</code> no mejora la claridad del c√≥digo, estos son solo caracteres adicionales. <br><br>  Sugiero evitar cualquier sufijo que se parezca al tipo de una variable. <br><br><blockquote>  <b>Consejo</b>  Si el nombre <code>users</code> no describe la esencia con suficiente claridad, entonces <code>usersMap</code> tambi√©n. </blockquote><br>  Este consejo tambi√©n se aplica a los par√°metros de la funci√≥n.  Por ejemplo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Config <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { <span class="hljs-comment"><span class="hljs-comment">// } func WriteConfig(w io.Writer, config *Config)</span></span></code> </pre> <br>  El nombre de <code>config</code> para el par√°metro <code>*Config</code> es redundante.  Ya sabemos que esto es <code>*Config</code> , se escribe inmediatamente al lado. <br><br>  En este caso, considere <code>conf</code> o <code>c</code> si la vida √∫til de la variable es lo suficientemente corta. <br><br>  Si en alg√∫n punto de nuestra √°rea hay m√°s de una <code>*Config</code> , los nombres <code>conf1</code> y <code>conf2</code> menos significativos que los <code>original</code> y <code>updated</code> , ya que estos √∫ltimos son m√°s dif√≠ciles de mezclar. <br><br><blockquote>  <b>Nota</b>  No permita que los nombres de paquetes roben buenos nombres de variables. <br><br>  El nombre del identificador importado contiene el nombre del paquete.  Por ejemplo, el tipo de <code>Context</code> en el paquete de <code>context</code> se llamar√° <code>context.Context</code> .  Esto hace que sea imposible usar una variable o tipo de <code>context</code> en su paquete. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context context.Context, message </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br>  Esto no se compilar√°.  Es por eso que al declarar el <code>context.Context</code> tipos de <code>context.Context</code> localmente, por ejemplo, nombres como <code>ctx</code> se usan tradicionalmente. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, message </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> </blockquote><br><a name="2_4"></a><h2>  2.4.  Use un solo estilo de nomenclatura </h2><br>  Otra propiedad de un buen nombre es que debe ser predecible.  El lector debe entenderlo de inmediato.  Si este es un nombre <i>com√∫n</i> , entonces el lector tiene el derecho de asumir que no ha cambiado el significado del tiempo anterior. <br><br>  Por ejemplo, si el c√≥digo va alrededor del descriptor de la base de datos, cada vez que se muestra el par√°metro, debe tener el mismo nombre.  En lugar de todo tipo de combinaciones como <code>d *sql.DB</code> , <code>d *sql.DB</code> <code>dbase *sql.DB</code> , <code>DB *sql.DB</code> y la <code>database *sql.DB</code> , es mejor usar una cosa: <br><br><pre> <code class="go hljs">db *sql.DB</code> </pre> <br>  Es m√°s f√°cil entender el c√≥digo.  Si ve <code>db</code> , entonces sabe que es <code>*sql.DB</code> y que la persona que llama la declara localmente. <br><br>  Consejos similares con respecto a los destinatarios de un m√©todo;  use el mismo nombre de destinatario para cada m√©todo de este tipo.  Por lo tanto, ser√° m√°s f√°cil para el lector aprender el uso del destinatario entre los diversos m√©todos de este tipo. <br><br><blockquote>  <b>Nota</b>  El acuerdo de nombre corto de destinatario Go contradice las recomendaciones expresadas anteriormente.  Este es uno de esos casos donde la elecci√≥n realizada en una etapa temprana se convierte en el estilo est√°ndar, como usar <code>CamelCase</code> lugar de <code>snake_case</code> . </blockquote><br><blockquote>  <b>Consejo</b>  El estilo Ir apunta a nombres de una sola letra o abreviaturas para destinatarios derivados de su tipo.  Puede resultar que el nombre del destinatario a veces entra en conflicto con el nombre del par√°metro en el m√©todo.  En este caso, se recomienda hacer que el nombre del par√°metro sea un poco m√°s largo y no olvide usarlo secuencialmente. </blockquote><br>  Finalmente, algunas variables de una letra se asocian tradicionalmente con bucles y recuento.  Por ejemplo, <code>i</code> , <code>j</code> y <code>k</code> suelen ser variables inductivas en bucles <code>for</code> , <code>n</code> suele asociarse con un contador o sumador acumulativo, <code>v</code> es una abreviatura t√≠pica de valor en una funci√≥n de codificaci√≥n, <code>k</code> suele utilizarse para una clave de mapa y <code>s</code> menudo se utiliza como abreviatura para par√°metros de tipo <code>string</code> . <br><br>  Al igual que con el ejemplo <code>db</code> anterior, los programadores <i>esperan que</i> <code>i</code> sea ‚Äã‚Äãuna variable inductiva.  Si lo ven en c√≥digo, esperan ver un bucle pronto. <br><br><blockquote>  <b>Consejo</b>  Si tiene tantos bucles anidados que se ha quedado sin variables <code>i</code> , <code>j</code> y <code>k</code> , es posible que desee dividir la funci√≥n en unidades m√°s peque√±as. </blockquote><br><a name="2_5"></a><h2>  2.5.  Use un estilo de declaraci√≥n √∫nico </h2><br>  Go tiene al menos seis formas diferentes de declarar una variable. <br><br><ul><li><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li><li><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li><li><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>; x = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li><li><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> </li><li><pre> <code class="go hljs">x := <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li></ul><br>  Estoy seguro de que a√∫n no lo recuerdo todo.  Los desarrolladores de Go probablemente consideran esto un error, pero es demasiado tarde para cambiar algo.  Con esta elecci√≥n, ¬øc√≥mo garantizar un estilo uniforme? <br><br>  Quiero proponer un estilo de declaraci√≥n de variables que yo mismo trato de usar siempre que sea posible. <br><br><ul><li>  <b>Al declarar una variable sin inicializaci√≥n, use <code>var</code></b> . <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> players <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-comment"><span class="hljs-comment">// 0 var things []Thing // an empty slice of Things var thing Thing // empty Thing struct json.Unmarshall(reader, &amp;thing)</span></span></code> </pre> <br>  <code>var</code> act√∫a como una pista de que esta variable se declara <i>intencionalmente</i> como un valor nulo del tipo especificado.  Esto es coherente con el requisito de declarar variables a nivel de paquete con <code>var</code> en oposici√≥n a la sintaxis de declaraci√≥n corta, aunque argumentar√© m√°s adelante que las variables de nivel de paquete no deber√≠an usarse en absoluto. </li><li>  <b>Al declarar con inicializaci√≥n, use <code>:=</code></b> .  Esto deja en claro al lector que la variable a la izquierda de <code>:=</code> inicializa intencionalmente. <br><br>  Para explicar por qu√©, veamos el ejemplo anterior, pero esta vez inicializamos especialmente cada variable: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> players <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> things []Thing = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thing *Thing = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(Thing) json.Unmarshall(reader, thing)</code> </pre> </li></ul><br>  Como Go no tiene conversiones autom√°ticas de un tipo a otro, en el primer y tercer ejemplo, el tipo en el lado izquierdo del operador de asignaci√≥n debe ser id√©ntico al tipo en el lado derecho.  El compilador puede inferir el tipo de la variable declarada del tipo de la derecha, por lo que el ejemplo se puede escribir de manera m√°s concisa: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> players = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> things []Thing = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thing = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(Thing) json.Unmarshall(reader, thing)</code> </pre> <br>  Aqu√≠, los <code>players</code> inicializan expl√≠citamente a <code>0</code> , lo cual es redundante, porque el valor inicial de los <code>players</code> es cero en cualquier caso.  Por lo tanto, es mejor dejar en claro que queremos usar un valor nulo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> players <span class="hljs-keyword"><span class="hljs-keyword">int</span></span></code> </pre> <br>  ¬øQu√© pasa con el segundo operador?  No podemos determinar el tipo y escribir <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> things = <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre> <br>  Porque <code>nil</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no</a> <code>nil</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tipo</a> .  En cambio, tenemos una opci√≥n: o usamos un valor cero para cortar ... <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> things []Thing</code> </pre> <br>  ... o crear un segmento con cero elementos? <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> things = <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]Thing, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  En el segundo caso, el valor para el segmento <i>no</i> es cero, y lo dejamos claro para el lector usando una forma corta de declaraci√≥n: <br><br><pre> <code class="go hljs">things := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]Thing, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  Esto le dice al lector que decidimos inicializar <code>things</code> expl√≠citamente. <br><br>  Entonces llegamos a la tercera declaraci√≥n: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thing = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(Thing)</code> </pre> <br>  Aqu√≠, tanto la inicializaci√≥n expl√≠cita de la variable como la introducci√≥n de la palabra clave "√∫nica" <code>new</code> , que a algunos programadores de Go no les gusta.  Usando los rendimientos recomendados de sintaxis corta <br><br><pre> <code class="go hljs">thing := <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(Thing)</code> </pre> <br>  Esto deja en claro que la <code>thing</code> inicializa expl√≠citamente al resultado de <code>new(Thing)</code> , pero a√∫n deja una <code>new</code> at√≠pica.  El problema podr√≠a resolverse usando un literal: <br><br><pre> <code class="go hljs">thing := &amp;Thing{}</code> </pre> <br>  Lo cual es similar a <code>new(Thing)</code> , y esa duplicaci√≥n molesta a algunos programadores de Go.  Sin embargo, esto significa que inicializamos expl√≠citamente la <code>thing</code> con un puntero a <code>Thing{}</code> y un valor de <code>Thing</code> de cero. <br><br>  Pero es mejor tener en cuenta el hecho de que la <code>thing</code> declara con un valor cero, y usar la direcci√≥n del operador para pasar la direcci√≥n de la <code>thing</code> en <code>json.Unmarshall</code> . <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thing Thing json.Unmarshall(reader, &amp;thing)</code> </pre> <br><blockquote>  <b>Nota</b>  Por supuesto, hay excepciones a cualquier regla.  Por ejemplo, a veces dos variables est√°n estrechamente relacionadas, por lo que ser√° extra√±o escribir <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> min <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> max := <span class="hljs-number"><span class="hljs-number">1000</span></span></code> </pre> <br>  Declaraci√≥n m√°s legible: <br><br><pre> <code class="go hljs">min, max := <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span></code> </pre> </blockquote><br>  Para resumir: <br><br><ul><li>  Al declarar una variable sin inicializaci√≥n, use la sintaxis <code>var</code> . <br></li><li>  Al declarar e inicializar expl√≠citamente una variable, use <code>:=</code> . </li></ul><br><blockquote>  <b>Consejo</b>  Se√±ale expl√≠citamente cosas complejas. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span> = <span class="hljs-number"><span class="hljs-number">0x80</span></span></code> </pre> <br>  Aqu√≠, la <code>length</code> se puede usar con la biblioteca, que requiere un tipo num√©rico espec√≠fico, y esta opci√≥n indica m√°s claramente que la longitud del tipo se elige espec√≠ficamente como uint32 que en la declaraci√≥n breve: <br><br><pre> <code class="go hljs">length := <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(<span class="hljs-number"><span class="hljs-number">0x80</span></span>)</code> </pre> <br>  En el primer ejemplo, rompo intencionalmente mi regla al usar la declaraci√≥n var con inicializaci√≥n expl√≠cita.  Una desviaci√≥n del est√°ndar hace que el lector entienda que algo inusual est√° sucediendo. </blockquote><br><a name="2_6"></a><h2>  2.6.  Trabajar para el equipo </h2><br>  Ya he dicho que la esencia del desarrollo de software es la creaci√≥n de c√≥digo legible y compatible.  La mayor parte de su carrera probablemente trabajar√° en proyectos conjuntos.  Mi consejo en esta situaci√≥n: sigue el estilo adoptado en el equipo. <br><br>  Cambiar estilos en el medio del archivo es molesto.  La consistencia es importante, aunque en detrimento de la preferencia personal.  Mi regla de oro es: si el c√≥digo se ajusta a trav√©s de <code>gofmt</code> , entonces el problema generalmente no merece la discusi√≥n. <br><br><blockquote>  <b>Consejo</b>  Si desea cambiar el nombre en toda la base de c√≥digo, no mezcle esto con otros cambios.  Si alguien usa git bisect, no le gustar√° buscar miles de cambios de nombre para encontrar otro c√≥digo modificado. </blockquote><br><h1>  3. Comentarios </h1><br>  Antes de pasar a puntos m√°s importantes, quiero tomarme un par de minutos para comentar. <br><br><blockquote>  <i>"Un buen c√≥digo tiene muchos comentarios, y un c√≥digo malo necesita muchos comentarios".</i> - Dave Thomas y Andrew Hunt, Programador pragm√°tico </blockquote><br>  Los comentarios son muy importantes para la legibilidad del programa.  Cada comentario debe hacer una, y solo una, de tres cosas: <br><br><ol><li>  Explica <i>qu√© hace el</i> c√≥digo. </li><li>  Explica <i>c√≥mo</i> lo hace. </li><li>  Explica <i>por qu√©</i> . </li></ol><br>  La primera forma es ideal para comentar sobre personajes p√∫blicos: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Open     . //           .</span></span></code> </pre> <br>  El segundo es ideal para comentarios dentro de un m√©todo: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//     var results []chan error for _, dep := range a.Deps { results = append(results, execute(seen, dep)) }</span></span></code> </pre> <br>  La tercera forma ("por qu√©") es √∫nica en el sentido de que no reemplaza ni reemplaza las dos primeras.  Dichos comentarios explican los factores externos que llevaron a la escritura del c√≥digo en su forma actual.  A menudo, sin este contexto, es dif√≠cil entender por qu√© el c√≥digo est√° escrito de esta manera. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;v2.Cluster_CommonLbConfig{ <span class="hljs-comment"><span class="hljs-comment">//  HealthyPanicThreshold HealthyPanicThreshold: &amp;envoy_type.Percent{ Value: 0, }, }</span></span></code> </pre> <br>  En este ejemplo, puede que no est√© claro de inmediato qu√© sucede cuando HealthyPanicThreshold se establece en cero por ciento.  El comentario pretende aclarar que un valor de 0 deshabilita el umbral de p√°nico. <br><br><a name="3_1"></a><h2>  3.1.  Los comentarios en variables y constantes deben describir su contenido, no su prop√≥sito </h2><br>  Anteriormente dije que el nombre de una variable o constante deber√≠a describir su prop√≥sito.  Pero un comentario sobre una variable o constante debe describir exactamente el <i>contenido</i> , no el <i>prop√≥sito</i> . <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> randomNumber = <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br>  En este ejemplo, un comentario describe <i>por qu√©</i> <code>randomNumber</code> en 6 y de d√≥nde proviene.  El comentario no describe d√≥nde se <code>randomNumber</code> .  Aqu√≠ hay algunos ejemplos m√°s: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ( StatusContinue = <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-comment"><span class="hljs-comment">// RFC 7231, 6.2.1 StatusSwitchingProtocols = 101 // RFC 7231, 6.2.2 StatusProcessing = 102 // RFC 2518, 10.1 StatusOK = 200 // RFC 7231, 6.3.1</span></span></code> </pre> <br>  <i>En el contexto de HTTP, el</i> n√∫mero <code>100</code> conoce como <code>StatusContinue</code> , como se define en RFC 7231, secci√≥n 6.2.1. <br><br><blockquote>  <b>Consejo</b>  Para las variables sin un valor inicial, el comentario debe describir qui√©n es responsable de inicializar esta variable. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// sizeCalculationDisabled ,   //     . . dowidth. var sizeCalculationDisabled bool</span></span></code> </pre> <br>  Aqu√≠ un comentario le dice al lector que la funci√≥n <code>dowidth</code> responsable de mantener el estado de <code>sizeCalculationDisabled</code> . </blockquote><br><blockquote>  <b>Consejo</b>  Esconderse a la vista.  Este es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">consejo de Kate Gregory</a> .  A veces, el mejor nombre para una variable est√° oculto en los comentarios. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//   SQL var registry = make(map[string]*sql.Driver)</span></span></code> </pre> <br>  El autor agreg√≥ un comentario porque el <code>registry</code> nombres no explica suficientemente su prop√≥sito: este es un registro, pero ¬øcu√°l es el registro? <br><br>  Si cambia el nombre de una variable a sqlDrivers, queda claro que contiene controladores SQL. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqlDrivers = <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]*sql.Driver)</code> </pre> <br>  Ahora el comentario se ha vuelto redundante y se puede eliminar. </blockquote><br><a name="3_2"></a><h2>  3.2.  Siempre documente personajes disponibles p√∫blicamente </h2><br>  Godoc genera la documentaci√≥n de su paquete, por lo que debe agregar un comentario a cada car√°cter p√∫blico declarado en el paquete: una variable, constante, funci√≥n y m√©todo. <br><br>  Aqu√≠ hay dos pautas de la Gu√≠a de estilo de Google: <br><br><ul><li>  Cualquier funci√≥n p√∫blica que no sea obvia y concisa debe ser comentada. <br></li><li>  Cualquier funci√≥n en la biblioteca debe comentarse, independientemente de su longitud o complejidad. </li></ul><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ioutil <span class="hljs-comment"><span class="hljs-comment">// ReadAll   r      (EOF)   // ..    err == nil, not err == EOF. //  ReadAll     ,     //  . func ReadAll(r io.Reader) ([]byte, error)</span></span></code> </pre> <br>  Hay una excepci√≥n a esta regla: no necesita documentar los m√©todos que implementan la interfaz.  Espec√≠ficamente, no hagas esto: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Read   io.Reader func (r *FileReader) Read(buf []byte) (int, error)</span></span></code> </pre> <br>  Este comentario no significa nada.  No dice qu√© hace el m√©todo: peor, env√≠a a alg√∫n lado a buscar documentaci√≥n.  En esta situaci√≥n, propongo eliminar completamente el comentario. <br><br>  Aqu√≠ hay un ejemplo del paquete <code>io</code> . <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// LimitReader  Reader,    r, //    EOF  n . //   *LimitedReader. func LimitReader(r Reader, n int64) Reader { return &amp;LimitedReader{r, n} } // LimitedReader   R,     //   N .   Read  N  //    . // Read  EOF,  N &lt;= 0    R  EOF. type LimitedReader struct { R Reader // underlying reader N int64 // max bytes remaining } func (l *LimitedReader) Read(p []byte) (n int, err error) { if lN &lt;= 0 { return 0, EOF } if int64(len(p)) &gt; lN { p = p[0:lN] } n, err = lRRead(p) lN -= int64(n) return }</span></span></code> </pre> <br>  Tenga en cuenta que la declaraci√≥n de <code>LimitedReader</code> est√° precedida inmediatamente por la funci√≥n que la utiliza, y la declaraci√≥n de <code>LimitedReader.Read</code> sigue a la declaraci√≥n de <code>LimitedReader</code> .  Aunque <code>LimitedReader.Read</code> s√≠ no est√° documentado, se puede entender que se trata de una implementaci√≥n de <code>io.Reader</code> . <br><br><blockquote>  <b>Consejo</b>  Antes de escribir una funci√≥n, escriba un comentario describi√©ndola.  Si le resulta dif√≠cil escribir un comentario, entonces esta es una se√±al de que el c√≥digo que est√° a punto de escribir ser√° dif√≠cil de entender. </blockquote><br><h3>  3.2.1.  No comente sobre el c√≥digo incorrecto, vuelva a escribirlo </h3><br><blockquote>  <i>"No comente el c√≥digo incorrecto - Reescr√≠balo"</i> - Brian Kernighan </blockquote><br>  No es suficiente indicar en los comentarios la dificultad del fragmento de c√≥digo.  Si encuentra alguno de estos comentarios, debe comenzar un ticket con un recordatorio de refactorizaci√≥n.  Puede vivir con deudas t√©cnicas siempre que se conozca su monto. <br><br>  En la biblioteca est√°ndar, se acostumbra dejar comentarios en el estilo TODO con el nombre del usuario que not√≥ el problema. <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// TODO(dfc)  O(N^2),     .</span></span></code> </pre> <br>  Esto no es una obligaci√≥n para solucionar el problema, pero el usuario indicado puede ser la mejor persona para hacer una pregunta.  Otros proyectos acompa√±an a TODO con una fecha o n√∫mero de boleto. <br><br><h3>  3.2.2.  En lugar de comentar el c√≥digo, refactorizarlo </h3><br><blockquote>  <i>‚ÄúUn buen c√≥digo es la mejor documentaci√≥n.</i>  <i>Cuando est√© a punto de agregar un comentario, h√°gase la pregunta: "¬øC√≥mo mejorar el c√≥digo para que este comentario no sea necesario?"</i>  <i>Refactorice y deje un comentario para hacerlo a√∫n m√°s claro. ‚Äù</i> - Steve McConnell </blockquote><br>  Las funciones deben realizar solo una tarea.  Si desea escribir un comentario porque alg√∫n fragmento no est√° relacionado con el resto de la funci√≥n, considere extraerlo en una funci√≥n separada. <br><br>  Las funciones m√°s peque√±as no solo son m√°s claras, sino tambi√©n m√°s f√°ciles de probar por separado.  Cuando aisl√≥ el c√≥digo en una funci√≥n separada, su nombre puede reemplazar un comentario. <br><br><a name="4"></a><h1>  4. estructura del paquete </h1><br><blockquote>  <i>"Escriba un c√≥digo modesto: m√≥dulos que no muestran nada superfluo a otros m√≥dulos y que no dependen de la implementaci√≥n de otros m√≥dulos"</i> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dave Thomas</a> </blockquote><br>  Cada paquete es esencialmente un peque√±o programa Go separado.  As√≠ como la implementaci√≥n de una funci√≥n o m√©todo no es importante para la persona que llama, la implementaci√≥n de las funciones, m√©todos y tipos que conforman la API p√∫blica de su paquete tampoco es importante. <br><br>  Un buen paquete Go se esfuerza por una conectividad m√≠nima con otros paquetes en el nivel del c√≥digo fuente, de modo que a medida que el proyecto crece, los cambios en un paquete no se conectan en cascada en toda la base del c√≥digo.  Tales situaciones inhiben en gran medida a los programadores que trabajan en esta base de c√≥digo. <br><br>  En esta secci√≥n, hablaremos sobre el dise√±o del paquete, incluido su nombre y consejos para escribir m√©todos y funciones. <br><br><a name="4_1"></a><h2>  4.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un buen paquete comienza con un buen nombre </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un buen paquete Go comienza con un nombre de calidad. </font><font style="vertical-align: inherit;">Piense en ello como una breve presentaci√≥n limitada a una sola palabra. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al igual que los nombres de variables en la secci√≥n anterior, el nombre del paquete es muy importante. </font><font style="vertical-align: inherit;">No es necesario pensar en los tipos de datos en este paquete, es mejor hacer la pregunta: "¬øQu√© servicio proporciona este paquete?" </font><font style="vertical-align: inherit;">Por lo general, la respuesta no es "Este paquete proporciona el tipo X", sino "Este paquete le permite conectarse a trav√©s de HTTP".</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Elija un nombre de paquete por su funcionalidad, no por su contenido.</font></font></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.1 </font><font style="vertical-align: inherit;">Los buenos nombres de paquetes deben ser √∫nicos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada paquete tiene un nombre √∫nico en el proyecto. </font><font style="vertical-align: inherit;">No hay dificultad si seguiste el consejo de dar nombres para el prop√≥sito de los paquetes. </font><font style="vertical-align: inherit;">Si resulta que los dos paquetes tienen el mismo nombre, lo m√°s probable:</font></font><br><br><ol><li>     . </li><li>       .       ,     . </li></ol><br><a name="4_2"></a><h2>  4.2.    <code>base</code> , <code>common</code>  <code>util</code> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una raz√≥n com√∫n para los malos nombres son los llamados </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquetes de servicio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donde con el tiempo se acumulan varios ayudantes y c√≥digos de servicio. Dado que es dif√≠cil encontrar un nombre √∫nico all√≠. Esto a menudo lleva al hecho de que el nombre del paquete se deriva de lo que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : utilidades. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los nombres como </font></font><code>utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>helpers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generalmente se encuentran en proyectos grandes, en los que se arraiga una jerarqu√≠a profunda de paquetes, y se comparten funciones auxiliares. Si extrae alguna funci√≥n en un nuevo paquete, la importaci√≥n se descompone. En este caso, el nombre del paquete no refleja el prop√≥sito del paquete, sino solo el hecho de que la funci√≥n de importaci√≥n fall√≥ debido a una organizaci√≥n incorrecta del proyecto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tales situaciones, recomiendo analizar desde d√≥nde se llaman los paquetes.</font></font><code>utils</code> <code>helpers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y, si es posible, mueva las funciones correspondientes al paquete de llamada. </font><font style="vertical-align: inherit;">Incluso si esto implica la duplicaci√≥n de alg√∫n c√≥digo auxiliar, es mejor que introducir una dependencia de importaci√≥n entre dos paquetes.</font></font><br><br><blockquote> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"[Una peque√±a] duplicaci√≥n es mucho m√°s barata que una abstracci√≥n incorrecta"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Sandy Mets</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si las funciones de utilidad se utilizan en muchos lugares, en lugar de un paquete monol√≠tico con funciones de utilidad, es mejor hacer varios paquetes, cada uno de los cuales se centra en un aspecto. </font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Use el plural para paquetes de servicios. </font><font style="vertical-align: inherit;">Por ejemplo, </font></font><code>strings</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para las utilidades de procesamiento de cadenas.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los paquetes con nombres como </font></font><code>base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o a </font></font><code>common</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menudo se encuentran cuando una cierta funcionalidad com√∫n de dos o m√°s implementaciones o tipos comunes para un cliente y un servidor se fusiona en un paquete separado. </font><font style="vertical-align: inherit;">Creo que en tales casos es necesario reducir la cantidad de paquetes combinando el cliente, el servidor y el c√≥digo com√∫n en un paquete con un nombre que corresponda a su funci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, para </font></font><code>net/http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hacer los paquetes individuales </font></font><code>client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en cambio, hay archivos </font></font><code>client.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>server.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con los tipos de datos correspondientes, as√≠ como </font></font><code>transport.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para el transporte global.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es importante recordar que el nombre del identificador incluye el nombre del paquete.</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una funci√≥n </font></font><code>Get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de un paquete se </font></font><code>net/http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convierte en un </font></font><code>http.Get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace desde otro paquete.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tipo </font></font><code>Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de un paquete se </font></font><code>strings</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transforma cuando se importa a otros paquetes </font></font><code>strings.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interfaz </font></font><code>Error</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del paquete est√° </font></font><code>net</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">claramente asociada con errores de red.</font></font></li></ul></blockquote><br><a name="4_3"></a><h2>  4.3.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Regresa r√°pidamente sin zambullirte profundamente </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde Go utiliza excepciones en el flujo de control no es necesario cortar profundamente en el c√≥digo para proporcionar una estructura de nivel superior para las unidades </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>catch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En lugar de una jerarqu√≠a de niveles m√∫ltiples, el c√≥digo Go baja la pantalla a medida que avanza la funci√≥n. </font><font style="vertical-align: inherit;">Mi amigo Matt Ryer llama a esta pr√°ctica una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"l√≠nea de visi√≥n"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto se logra utilizando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operadores de l√≠mite</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : bloques condicionales con una condici√≥n previa en la entrada a la funci√≥n. </font><font style="vertical-align: inherit;">Aqu√≠ hay un ejemplo del paquete </font></font><code>bytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *Buffer)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnreadRune</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.lastRead &lt;= opInvalid { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errors.New(<span class="hljs-string"><span class="hljs-string">"bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.off &gt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(b.lastRead) { b.off -= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(b.lastRead) } b.lastRead = opInvalid <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al ingresar a la funci√≥n </font></font><code>UnreadRune</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se verifica el estado </font></font><code>b.lastRead</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y si la operaci√≥n anterior no fue as√≠ </font></font><code>ReadRune</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces se devuelve un error inmediatamente. El resto de la funci√≥n funciona en funci√≥n de lo que es </font></font><code>b.lastRead</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mayor que </font></font><code>opInvalid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare con la misma funci√≥n, pero sin el operador de l√≠mite:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *Buffer)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnreadRune</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.lastRead &gt; opInvalid { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b.off &gt;= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(b.lastRead) { b.off -= <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(b.lastRead) } b.lastRead = opInvalid <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> errors.New(<span class="hljs-string"><span class="hljs-string">"bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune"</span></span>) }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El cuerpo de una rama exitosa m√°s probable est√° incrustado en la primera condici√≥n </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y la condici√≥n para una salida exitosa </font></font><code>return nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe descubrirse haciendo coincidir cuidadosamente los </font><font style="vertical-align: inherit;">corchetes de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cierre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La √∫ltima l√≠nea de la funci√≥n ahora devuelve un error, y debe rastrear la ejecuci√≥n de la funci√≥n hasta el </font><font style="vertical-align: inherit;">corchete de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apertura</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correspondiente </font><font style="vertical-align: inherit;">para averiguar c√≥mo llegar a este punto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta opci√≥n es m√°s dif√≠cil de leer, lo que degrada la calidad de la programaci√≥n y el soporte de c√≥digo, por lo que Go prefiere usar operadores de l√≠mite y devolver errores en una etapa temprana.</font></font><br><br><a name="4_4"></a><h2>  4.4.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hacer que el valor nulo sea √∫til </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada declaraci√≥n de variable, suponiendo la ausencia de un inicializador expl√≠cito, se inicializar√° autom√°ticamente con un valor correspondiente al contenido de la memoria puesta a cero, es decir, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cero</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El tipo de valor est√° determinado por una de las opciones: para tipos num√©ricos: cero, para tipos de puntero: nulo, lo mismo para sectores, mapas y canales. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La capacidad de establecer siempre un valor predeterminado conocido es importante para la seguridad y correcci√≥n de su programa y puede hacer que sus programas Go sean m√°s f√°ciles y compactos. Esto es lo que los programadores de Go tienen en mente cuando dicen: "Dale a las estructuras un valor cero √∫til". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Considere un tipo </font></font><code>sync.Mutex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que contiene dos campos enteros que representan el estado interno del mutex. Estos campos son autom√°ticamente nulos en cualquier declaraci√≥n.</font></font><code>sync.Mutex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este hecho se tiene en cuenta en el c√≥digo, por lo que el tipo es adecuado para su uso sin una inicializaci√≥n expl√≠cita.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> MyInt <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { mu sync.Mutex val <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i MyInt <span class="hljs-comment"><span class="hljs-comment">// i.mu is usable without explicit initialisation. i.mu.Lock() i.val++ i.mu.Unlock() }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otro ejemplo de un tipo con un valor nulo √∫til es </font></font><code>bytes.Buffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Puede declarar y comenzar a escribir en √©l sin una inicializaci√≥n expl√≠cita.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b bytes.Buffer b.WriteString(<span class="hljs-string"><span class="hljs-string">"Hello, world!\n"</span></span>) io.Copy(os.Stdout, &amp;b) }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El valor cero de esta estructura significa que </font></font><code>len</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ambos </font></font><code>cap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">son iguales </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e y </font></font><code>array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el puntero a la memoria con el contenido de la matriz de segmentos de respaldo, valor </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto significa que no necesita cortar expl√≠citamente, simplemente puede declararlo.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// s := make([]string, 0) // s := []string{} var s []string s = append(s, "Hello") s = append(s, "world") fmt.Println(strings.Join(s, " ")) }</span></span></code> </pre> <br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><code>var s []string</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">similar a las dos l√≠neas comentadas en la parte superior, pero no id√©nticas a ellas. </font><font style="vertical-align: inherit;">Hay una diferencia entre un valor de corte de cero y un valor de corte de longitud cero. </font><font style="vertical-align: inherit;">El siguiente c√≥digo se imprimir√° falso.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s1 = []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s2 []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fmt.Println(reflect.DeepEqual(s1, s2)) }</code> </pre> </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una propiedad √∫til, aunque inesperada, de las variables de puntero no inicializadas (punteros nulos) es la capacidad de invocar m√©todos en tipos que son nulos. </font><font style="vertical-align: inherit;">Esto se puede usar para proporcionar f√°cilmente valores predeterminados.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Config <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { path <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Config)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"/usr/home"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.path } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c1 *Config <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c2 = &amp;Config{ path: <span class="hljs-string"><span class="hljs-string">"/export"</span></span>, } fmt.Println(c1.Path(), c2.Path()) }</code> </pre> <br><a name="4_5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.5. </font><font style="vertical-align: inherit;">Evitar estado de nivel de paquete</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La clave para escribir programas f√°ciles de soportar que est√°n d√©bilmente conectados es que cambiar un paquete deber√≠a tener una baja probabilidad de afectar a otro paquete que no depende directamente del primero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay dos excelentes maneras de lograr una conectividad d√©bil en Go:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilice interfaces para describir el comportamiento requerido por funciones o m√©todos. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Evitar el estado global. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En Go, podemos declarar variables en el alcance de una funci√≥n o m√©todo, as√≠ como en el alcance de un paquete. </font><font style="vertical-align: inherit;">Cuando una variable est√° disponible p√∫blicamente, con un identificador con una letra may√∫scula, su alcance es realmente global para todo el programa: cualquier paquete </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en cualquier momento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ve el tipo y el contenido de esta variable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado global mutable proporciona una estrecha relaci√≥n entre las partes independientes del programa, ya que las variables globales se convierten en un par√°metro invisible para cada funci√≥n en el programa. </font><font style="vertical-align: inherit;">Cualquier funci√≥n que se base en una variable global se puede violar cuando cambia el tipo de esta variable. </font><font style="vertical-align: inherit;">Cualquier funci√≥n que dependa del estado de una variable global puede ser violada si otra parte del programa cambia esta variable.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C√≥mo reducir la conectividad que crea una variable global: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mueva las variables correspondientes como campos a las estructuras que las necesitan. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilice interfaces para reducir la conexi√≥n entre el comportamiento y la implementaci√≥n de este comportamiento. </font></font></li></ol><br><a name="5"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. Estructura del proyecto </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hablemos de c√≥mo se combinan los paquetes en un proyecto. </font><font style="vertical-align: inherit;">Este suele ser un √∫nico repositorio de Git. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al igual que el paquete, cada proyecto debe tener un objetivo claro. </font><font style="vertical-align: inherit;">Si es una biblioteca, debe hacer una cosa, por ejemplo, an√°lisis XML o registro en diario. </font><font style="vertical-align: inherit;">No debe combinar varios objetivos en un proyecto, esto ayudar√° a evitar una biblioteca aterradora </font></font><code>common</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En mi experiencia, el repositorio en </font></font><code>common</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√∫ltima instancia est√° estrechamente relacionado con el consumidor m√°s grande, y esto hace que sea dif√≠cil hacer correcciones a versiones anteriores (correcciones de puerto posterior) sin actualizar tanto </font></font><code>common</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el consumidor como el consumidor en la etapa de bloqueo, lo que conduce a muchos cambios no relacionados, adem√°s de que se rompen en el camino API</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tiene una aplicaci√≥n (aplicaci√≥n web, controlador Kubernetes, etc.), el proyecto puede tener uno o m√°s paquetes principales. </font><font style="vertical-align: inherit;">Por ejemplo, en mi controlador Kubernetes hay un paquete </font></font><code>cmd/contour</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que sirve como servidor implementado en un cl√∫ster de Kubernetes y como cliente de depuraci√≥n.</font></font><br><br><a name="5_1"></a><h2>  5.1.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menos paquetes pero m√°s grandes </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la revisi√≥n del c√≥digo, not√© uno de los errores t√≠picos de los programadores que cambiaron a Go desde otros idiomas: tienden a abusar de los paquetes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go no proporciona el elaborado sistema de visibilidad: el idioma no es suficiente modificadores de acceso como en el de Java ( </font></font><code>public</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>protected</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e impl√≠cito </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">No existe un an√°logo de clases amigables de C ++. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En Go, solo tenemos dos modificadores de acceso: estos son identificadores p√∫blicos y privados, que se indican mediante la primera letra del identificador (may√∫sculas / min√∫sculas). </font><font style="vertical-align: inherit;">Si el identificador es p√∫blico, su nombre comienza con una letra may√∫scula, puede ser referenciado por cualquier otro paquete Go.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pod√≠a escuchar las palabras "exportado" o "no exportado" como sin√≥nimos de p√∫blico y privado.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dadas las funciones de control de acceso limitado, ¬øqu√© m√©todos se pueden usar para evitar jerarqu√≠as de paquetes demasiado complejas? </font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En cada paquete, adem√°s de </font></font><code>cmd/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>internal/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe estar presente el c√≥digo fuente.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He dicho repetidamente que es mejor preferir menos paquetes m√°s grandes. </font><font style="vertical-align: inherit;">Su posici√≥n predeterminada debe ser no crear un nuevo paquete. </font><font style="vertical-align: inherit;">Esto hace que demasiados tipos se hagan p√∫blicos, creando un amplio y peque√±o alcance de API disponible. </font><font style="vertical-align: inherit;">A continuaci√≥n consideramos esta tesis con m√°s detalle.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vino de Java? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vienes del mundo de Java o C #, recuerda la regla t√°cita: un paquete de Java es equivalente a un √∫nico archivo fuente </font></font><code>.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El paquete Go es equivalente a todo el m√≥dulo Maven o ensamblado .NET.</font></font></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1.1 </font><font style="vertical-align: inherit;">Ordenar c√≥digo por archivo usando las instrucciones de importaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si organiza paquetes por servicio, ¬ødeber√≠a hacer lo mismo con los archivos del paquete? </font><font style="vertical-align: inherit;">¬øC√≥mo saber cu√°ndo dividir un archivo </font></font><code>.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en varios? </font><font style="vertical-align: inherit;">¬øC√≥mo sabe si ha ido demasiado lejos y necesita pensar en fusionar archivos? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ est√°n las recomendaciones que uso:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comience cada paquete con un archivo </font></font><code>.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">D√© a este archivo el mismo nombre que el directorio. </font><font style="vertical-align: inherit;">Por ejemplo, el paquete </font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe estar en un archivo </font></font><code>http.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un directorio </font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A medida que crece el paquete, puede dividir las diversas funciones en varios archivos. </font><font style="vertical-align: inherit;">Por ejemplo, el archivo </font></font><code>messages.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contendr√° tipos </font></font><code>Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>client.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tipo de </font></font><code>Client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archivo </font></font><code>server.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, servidor de tipo de </font><font style="vertical-align: inherit;">archivo </font><font style="vertical-align: inherit;">.</font></font><br></li><li>       ,    .  ,       . <br></li><li>        . , <code>messages.go</code>     HTTP-       , <code>http.go</code>      , <code>client.go</code>  <code>server.go</code> ‚Äî    HTTP     . </li></ul><br><blockquote> <b></b> .      . </blockquote><br><blockquote> <b></b> .  Go    .      <i></i> ( ‚Äî      Go).           . </blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1.2. </font><font style="vertical-align: inherit;">Prefiero pruebas internas a externas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La herramienta </font></font><code>go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">admite el paquete </font></font><code>testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en dos lugares. </font><font style="vertical-align: inherit;">Si tiene un paquete </font></font><code>http2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puede escribir un archivo </font></font><code>http2_test.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y usar la declaraci√≥n del paquete </font></font><code>http2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se compila el c√≥digo </font></font><code>http2_test.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es parte del paquete </font></font><code>http2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En el habla coloquial, tal prueba se llama interna. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La herramienta </font></font><code>go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambi√©n admite una declaraci√≥n de paquete especial que termina con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir </font></font><code>http_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto permite que los archivos de prueba vivan en el mismo paquete con el c√≥digo, pero cuando se compilan tales pruebas, no forman parte del c√≥digo de su paquete, sino que viven en su propio paquete. </font><font style="vertical-align: inherit;">Esto le permite escribir pruebas como si otro paquete estuviera invocando su c√≥digo. </font><font style="vertical-align: inherit;">Tales pruebas se llaman externas.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomiendo el uso de pruebas internas para pruebas unitarias unitarias. Esto le permite probar cada funci√≥n o m√©todo directamente, evitando la burocracia de las pruebas externas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necesario</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> colocar ejemplos de funciones de prueba ( </font></font><code>Example</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">en un archivo de prueba externo </font><font style="vertical-align: inherit;">. Esto asegura que cuando se ve en godoc, los ejemplos recibir√°n el prefijo de paquete apropiado y se pueden copiar f√°cilmente.</font></font><br><br><blockquote> <b></b> .    ,     . <br><br>   ,    ,   Go      <code>go</code> . ,  <code>net/http</code>       <code>net</code> . <br><br>           <code>.go</code> , ,    . </blockquote><br><h3> 5.1.3.   ,     API </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si su proyecto tiene m√∫ltiples paquetes, puede encontrar funciones exportadas que est√°n destinadas a ser utilizadas por otros paquetes, pero no para la API p√∫blica. </font><font style="vertical-align: inherit;">En tal situaci√≥n, la herramienta </font></font><code>go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconoce un nombre de carpeta especial </font></font><code>internal/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que se puede usar para colocar el c√≥digo que est√° abierto para su proyecto, pero cerrado para otros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para crear dicho paquete, col√≥quelo en un directorio con un nombre </font></font><code>internal/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o en su subdirectorio. </font><font style="vertical-align: inherit;">Cuando el equipo </font></font><code>go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ve la importaci√≥n del paquete con la ruta </font></font><code>internal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, verifica la ubicaci√≥n del paquete de llamada en un directorio o subdirectorio </font></font><code>internal/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, un paquete </font></font><code>.../a/b/c/internal/d/e/f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede importar solo un paquete desde un √°rbol de directorios </font></font><code>.../a/b/c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero no puede hacerlo en absoluto </font></font><code>.../a/b/g</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o en cualquier otro repositorio (consulte</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br><br><a name="5_2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2. </font><font style="vertical-align: inherit;">El paquete principal m√°s peque√±o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una funci√≥n </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y un paquete </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deben tener una funcionalidad m√≠nima, porque </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">act√∫a como un singleton: un programa solo puede tener una funci√≥n </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, incluidas las pruebas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es un singleton, existen muchas restricciones sobre los objetos llamados: se llaman solo durante </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>main.init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y solo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una vez</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esto dificulta la escritura de pruebas de c√≥digo </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por lo tanto, debe esforzarse por obtener la mayor l√≥gica posible de la funci√≥n principal e, idealmente, del paquete principal.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><code>func main()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe analizar indicadores, abrir conexiones a bases de datos, registradores, etc., y luego transferir la ejecuci√≥n a un objeto de alto nivel.</font></font></blockquote><br><a name="6"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. estructura API </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El √∫ltimo consejo de dise√±o para el proyecto lo considero el m√°s importante. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todas las oraciones anteriores son, en principio, no vinculantes. </font><font style="vertical-align: inherit;">Estas son solo recomendaciones basadas en la experiencia personal. </font><font style="vertical-align: inherit;">No inserto demasiado estas recomendaciones en una revisi√≥n de c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La API es otro asunto, aqu√≠ tomamos los errores m√°s en serio, porque todo lo dem√°s se puede arreglar sin romper la compatibilidad con versiones anteriores: en su mayor parte, estos son solo detalles de implementaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se trata de API p√∫blicas, vale la pena considerar seriamente la estructura desde el principio, porque los cambios posteriores ser√°n destructivos para los usuarios.</font></font><br><br><a name="6_1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.1. </font><font style="vertical-align: inherit;">API de dise√±o que son dif√≠ciles de abusar por dise√±o</font></font></h2><br><blockquote> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Las API deben ser simples para un uso adecuado y dif√≠ciles para incorrectas"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Bloch</font></font></a> </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El consejo de Josh Bloch es quiz√°s el m√°s valioso en este art√≠culo. </font><font style="vertical-align: inherit;">Si la API es dif√≠cil de usar para cosas simples, entonces cada llamada a la API es m√°s complicada de lo necesario. </font><font style="vertical-align: inherit;">Cuando una llamada API es compleja y no obvia, es probable que se pase por alto.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.1.1. </font><font style="vertical-align: inherit;">Tenga cuidado con las funciones que aceptan m√∫ltiples par√°metros del mismo tipo.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un buen ejemplo de una API simple a primera vista, pero dif√≠cil de usar es cuando requiere dos o m√°s par√°metros del mismo tipo. </font><font style="vertical-align: inherit;">Compare dos firmas de funciones:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Max</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to, from </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°l es la diferencia entre estas dos funciones? </font><font style="vertical-align: inherit;">Obviamente, uno devuelve un m√°ximo de dos n√∫meros y el otro copia el archivo. </font><font style="vertical-align: inherit;">Pero este no es el punto.</font></font><br><br><pre> <code class="go hljs">Max(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 10 Max(10, 8) // 10</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Max es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conmutativo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el orden de los par√°metros no importa. </font><font style="vertical-align: inherit;">Un m√°ximo de ocho y diez es diez, independientemente de si se comparan ocho y diez o diez y ocho. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero en el caso de CopyFile, esto no es as√≠.</font></font><br><br><pre> <code class="go hljs">CopyFile(<span class="hljs-string"><span class="hljs-string">"/tmp/backup"</span></span>, <span class="hljs-string"><span class="hljs-string">"presentation.md"</span></span>) CopyFile(<span class="hljs-string"><span class="hljs-string">"presentation.md"</span></span>, <span class="hljs-string"><span class="hljs-string">"/tmp/backup"</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°l de estos operadores respaldar√° su presentaci√≥n y cu√°l la sobrescribir√° con la versi√≥n de la semana pasada? </font><font style="vertical-align: inherit;">No puede saberlo hasta que verifique la documentaci√≥n. </font><font style="vertical-align: inherit;">En el curso de la revisi√≥n del c√≥digo, no est√° claro si el orden de los argumentos es correcto o no. </font><font style="vertical-align: inherit;">Nuevamente, mira la documentaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una posible soluci√≥n es introducir un tipo auxiliar que sea responsable de la llamada correcta </font></font><code>CopyFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Source <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(src Source)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dest </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CopyFile(dest, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(src)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> from Source = <span class="hljs-string"><span class="hljs-string">"presentation.md"</span></span> from.CopyTo(<span class="hljs-string"><span class="hljs-string">"/tmp/backup"</span></span>) }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No </font></font><code>CopyFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siempre se llama correctamente - se puede argumentar por una prueba de unidad - y se puede hacer en privado, lo que reduce a√∫n m√°s la probabilidad de mal uso.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Una API con m√∫ltiples par√°metros del mismo tipo es dif√≠cil de usar correctamente.</font></font></blockquote><br><a name="6_2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2. </font><font style="vertical-align: inherit;">Dise√±ar una API para un caso de uso b√°sico</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hace unos a√±os, hice una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre el uso de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opciones funcionales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para facilitar la API por defecto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La esencia de la presentaci√≥n fue que debe desarrollar una API para el caso de uso principal. </font><font style="vertical-align: inherit;">En otras palabras, la API no deber√≠a requerir que el usuario proporcione par√°metros adicionales que no le interesen.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2.1. </font><font style="vertical-align: inherit;">No se recomienda usar nil como par√°metro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenc√© diciendo que no debe forzar al usuario a proporcionar par√°metros de API que no le interesen. </font><font style="vertical-align: inherit;">Esto significa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dise√±ar las API para el caso de uso principal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (opci√≥n predeterminada). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un ejemplo del paquete net / http.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> http <span class="hljs-comment"><span class="hljs-comment">// ListenAndServe listens on the TCP network address addr and then calls // Serve with handler to handle requests on incoming connections. // Accepted connections are configured to enable TCP keep-alives. // // The handler is typically nil, in which case the DefaultServeMux is used. // // ListenAndServe always returns a non-nil error. func ListenAndServe(addr string, handler Handler) error {</span></span></code> </pre> <br> <code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acepta dos par√°metros: una direcci√≥n TCP para escuchar las conexiones entrantes y </font></font><code>http.Handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para procesar una solicitud HTTP entrante. </font></font><code>Serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite que el segundo par√°metro sea </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Las notas de comentario que normalmente la persona que llama </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realmente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que indica un deseo de utilizar </font></font><code>http.DefaultServeMux</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como un par√°metro impl√≠cito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora la persona que llama </font></font><code>Serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene dos formas de hacer lo mismo.</font></font><br><br><pre> <code class="go hljs">http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, http.DefaultServeMux)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ambas opciones hacen lo mismo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta aplicaci√≥n se </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propaga como un virus. </font><font style="vertical-align: inherit;">El paquete tambi√©n </font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene un ayudante </font></font><code>http.Serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por lo que puede imaginar la estructura de la funci√≥n </font></font><code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ListenAndServe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(addr </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, handler Handler)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { l, err := net.Listen(<span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> l.Close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Serve(l, handler) }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como </font></font><code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite que la persona que llama pase </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el segundo par√°metro, </font></font><code>http.Serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambi√©n admite este comportamiento. </font><font style="vertical-align: inherit;">De hecho, est√° en la </font></font><code>http.Serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√≥gica implementada "si el manejador es igual </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, use </font></font><code>DefaultServeMux</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">". </font><font style="vertical-align: inherit;">La aceptaci√≥n </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de un par√°metro puede hacer que la persona que llama piense que se puede pasar </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para ambos par√°metros. </font><font style="vertical-align: inherit;">Pero tal</font></font><code>Serve</code> <br><br><pre> <code class="go hljs">http.Serve(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conduce a un p√°nico terrible. </font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No mezcle par√°metros en la misma firma de funci√≥n </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y no </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El autor </font></font><code>http.ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intent√≥ simplificar la vida de los usuarios de API para el caso predeterminado, pero la seguridad se vio afectada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En presencia, </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hay diferencia en el n√∫mero de l√≠neas entre el uso expl√≠cito e indirecto </font></font><code>DefaultServeMux</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> root = http.Dir(<span class="hljs-string"><span class="hljs-string">"/htdocs"</span></span>) http.Handle(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, http.FileServer(root)) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comparado con </font></font><br><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> root = http.Dir(<span class="hljs-string"><span class="hljs-string">"/htdocs"</span></span>) http.Handle(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, http.FileServer(root)) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, http.DefaultServeMux)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øVali√≥ la pena mantener una l√≠nea? </font></font><br><br><pre> <code class="go hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> root = http.Dir(<span class="hljs-string"><span class="hljs-string">"/htdocs"</span></span>) mux := http.NewServeMux() mux.Handle(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, http.FileServer(root)) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, mux)</code> </pre> <br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Piense seriamente en cu√°nto tiempo las funciones de ayuda ahorrar√°n al programador. </font><font style="vertical-align: inherit;">La claridad es mejor que la brevedad.</font></font></blockquote><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Evite las API p√∫blicas con par√°metros que solo las pruebas necesitan. </font><font style="vertical-align: inherit;">Evite exportar API con par√°metros cuyos valores difieran solo durante las pruebas. </font><font style="vertical-align: inherit;">En cambio, exporte las funciones de contenedor que ocultan la transferencia de dichos par√°metros, y en las pruebas utilice funciones auxiliares similares que pasen los valores necesarios para la prueba.</font></font></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2.2. </font><font style="vertical-align: inherit;">Utilice argumentos de longitud variable en lugar de [] T</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Muy a menudo, una funci√≥n o m√©todo toma una porci√≥n de valores. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShutdownVMs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es solo un ejemplo inventado, pero es muy com√∫n. El problema es que estas firmas suponen que se llamar√°n con m√°s de un registro. Como muestra la experiencia, a menudo se les llama con un solo argumento, que debe "empaquetarse" dentro del segmento para cumplir con los requisitos de la firma de la funci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, dado que el par√°metro </font></font><code>ids</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es un segmento, puede pasar un segmento vac√≠o o cero a la funci√≥n, y el compilador estar√° contento. Esto agrega una carga de prueba adicional ya que las pruebas deber√≠an cubrir tales casos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para dar un ejemplo de dicha clase de API, recientemente refactor√© la l√≥gica que requer√≠a la instalaci√≥n de algunos campos adicionales si al menos uno de los par√°metros no era cero. La l√≥gica se parec√≠a a esto:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> svc.MaxConnections &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> || svc.MaxPendingRequests &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> || svc.MaxRequests &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> || svc.MaxRetries &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-comment"><span class="hljs-comment">// apply the non zero parameters }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como el operador se estaba </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alargando mucho, quer√≠a incorporar la l√≥gica de validaci√≥n a una funci√≥n separada. </font><font style="vertical-align: inherit;">Esto es lo que se me ocurri√≥:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// anyPostive indicates if any value is greater than zero. func anyPositive(values ...int) bool { for _, v := range values { if v &gt; 0 { return true } } return false }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esto permiti√≥ establecer claramente la condici√≥n bajo la cual se ejecutar√° la unidad interior: </font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> anyPositive(svc.MaxConnections, svc.MaxPendingRequests, svc.MaxRequests, svc.MaxRetries) { <span class="hljs-comment"><span class="hljs-comment">// apply the non zero parameters }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, hay un problema con </font></font><code>anyPositive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alguien que accidentalmente podr√≠a llamarlo as√≠:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> anyPositive() { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En ese caso, </font></font><code>anyPositive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">volveremos </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esta no es la peor opci√≥n. </font><font style="vertical-align: inherit;">Peor si se </font></font><code>anyPositive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en ausencia de argumentos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, ser√≠a mejor poder cambiar la firma de anyPositive para garantizar que se pase al menos un argumento a la persona que llama. </font><font style="vertical-align: inherit;">Esto se puede hacer combinando par√°metros para argumentos normales y argumentos de longitud variable (varargs):</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// anyPostive indicates if any value is greater than zero. func anyPositive(first int, rest ...int) bool { if first &gt; 0 { return true } for _, v := range rest { if v &gt; 0 { return true } } return false }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora </font></font><code>anyPositive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no puede llamar con menos de un argumento.</font></font><br><br><a name="6_3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3. </font><font style="vertical-align: inherit;">Deje que las funciones determinen el comportamiento deseado.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supongamos que se me encomend√≥ la tarea de escribir una funci√≥n que conserve la estructura </font></font><code>Document</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el disco.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Save      f. func Save(f *os.File, doc *Document) error</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podr√≠a escribir una funci√≥n </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que escriba </font></font><code>Document</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un archivo </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pero hay algunos problemas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La firma </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elimina la posibilidad de registrar datos a trav√©s de la red. Si tal requisito aparece en el futuro, la firma de la funci√≥n tendr√° que cambiarse, lo que afectar√° a todos los objetos que llaman. </font></font><br><br> <code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n es desagradable probarlo, ya que funciona directamente con archivos en el disco. Por lo tanto, para verificar su funcionamiento, la prueba debe leer el contenido del archivo despu√©s de la escritura. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y tengo que asegurarme de que est√© </font></font><code>f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escrito en una carpeta temporal y posteriormente eliminado. </font></font><br><br> <code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tambi√©n define muchos m√©todos que no est√°n relacionados con </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por ejemplo, leer directorios y verificar si una ruta es un enlace simb√≥lico. Bueno, si la firma</font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describe solo las partes relevantes </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que se puede hacer</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Save      // ReadWriterCloser. func Save(rwc io.ReadWriteCloser, doc *Document) error</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con la ayuda de </font></font><code>io.ReadWriteCloser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este, puede aplicar el principio de separaci√≥n de interfaz y redefinirlo </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en una interfaz que describa las propiedades m√°s generales del archivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de tal cambio, cualquier tipo que implemente la interfaz </font></font><code>io.ReadWriteCloser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede ser reemplazado por el anterior </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto ampl√≠a simult√°neamente el alcance </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y aclara al llamante qu√© m√©todos de tipo </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√°n relacionados con su funcionamiento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y el autor </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ya no puede llamar a estos m√©todos no relacionados </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, porque est√° oculto detr√°s de la interfaz </font></font><code>io.ReadWriteCloser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero podemos extender el principio de separaci√≥n de la interfaz a√∫n m√°s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar si</font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sigue el principio de responsabilidad √∫nica, es poco probable que lea el archivo que acaba de escribir para verificar su contenido; otro c√≥digo deber√≠a hacerlo. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Save      // WriteCloser. func Save(wc io.WriteCloser, doc *Document) error</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, puede reducir las especificaciones de la interfaz para </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribir y cerrar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar, el mecanismo de cierre de subprocesos y </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es un legado de la √©poca en que funcionaba con el archivo. </font><font style="vertical-align: inherit;">La pregunta es, ¬øbajo qu√© circunstancias </font></font><code>wc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se cerrar√°? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">causa </font></font><code>Close</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sin condiciones, ya sea en el caso de √©xito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto presenta un problema para la persona que llama porque puede querer agregar datos a la secuencia despu√©s de escribir el documento.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Save      // Writer. func Save(w io.Writer, doc *Document) error</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mejor opci√≥n es redefinir Guardar para trabajar solo </font></font><code>io.Writer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, salvando al operador de todas las dem√°s funciones, excepto para escribir datos en la transmisi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de aplicar el principio de separaci√≥n de interfaz, la funci√≥n al mismo tiempo se volvi√≥ m√°s espec√≠fica en t√©rminos de requisitos (solo necesita un objeto donde se pueda escribir) y m√°s general en t√©rminos de funcionalidad, ya que ahora podemos usarla </font></font><code>Save</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para guardar datos en cualquier lugar donde se implemente </font></font><code>io.Writer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><a name="7"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. Manejo de errores </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">varias presentaciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">escrib√≠ </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mucho</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre este tema en el blog, as√≠ que no lo repetir√©. </font><font style="vertical-align: inherit;">En cambio, quiero cubrir otras dos √°reas relacionadas con el manejo de errores.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><a name="7_1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1. </font><font style="vertical-align: inherit;">Elimine la necesidad de manejar errores eliminando los errores mismos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hice muchas sugerencias para mejorar la sintaxis de manejo de errores, pero la mejor opci√≥n es no manejarlas en absoluto. </font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No digo "eliminar el manejo de errores". </font><font style="vertical-align: inherit;">Sugiero cambiar el c√≥digo para que no haya errores de procesamiento.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El reciente libro de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filosof√≠a de desarrollo de software de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> John Osterhout me inspir√≥ a hacer esta sugerencia </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Uno de los cap√≠tulos se titula "Eliminar errores de la realidad". </font><font style="vertical-align: inherit;">Intentemos aplicar este consejo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1.1 </font><font style="vertical-align: inherit;">Recuento de filas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Escribiremos una funci√≥n para contar el n√∫mero de l√≠neas en un archivo. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountLines</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( br = bufio.NewReader(r) lines <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err error ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { _, err = br.ReadString(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) lines++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != io.EOF { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lines, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A medida que seguimos los consejos de las secciones anteriores, </font></font><code>CountLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acepta </font></font><code>io.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no </font></font><code>*os.File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; ya es tarea de la persona que llama proporcionar el </font></font><code>io.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenido de qui√©n queremos contar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creamos </font></font><code>bufio.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y luego llamamos al m√©todo en un bucle </font></font><code>ReadString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aumentando el contador, hasta llegar al final del archivo, luego devolvemos el n√∫mero de l√≠neas le√≠das. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al menos queremos escribir dicho c√≥digo, pero la funci√≥n est√° cargada de manejo de errores. Por ejemplo, hay una construcci√≥n tan extra√±a:</font></font><br><br><pre> <code class="go hljs"> _, err = br.ReadString(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) lines++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aumentamos el n√∫mero de l√≠neas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> buscar errores, esto parece extra√±o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La raz√≥n por la que deber√≠amos escribirlo de esta manera es porque </font></font><code>ReadString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devolver√° un error si encuentra el final del archivo antes que el car√°cter de nueva l√≠nea. </font><font style="vertical-align: inherit;">Esto puede suceder si no hay una nueva l√≠nea al final del archivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para intentar solucionar esto, cambie la l√≥gica del contador de filas y luego vea si necesitamos salir del bucle.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esta l√≥gica a√∫n no es perfecta, ¬øpuedes encontrar un error?</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero no hemos terminado de buscar errores. </font></font><code>ReadString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresar√° </font></font><code>io.EOF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando encuentre el final del archivo. </font><font style="vertical-align: inherit;">Esta es la situaci√≥n esperada, por lo </font></font><code>ReadString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que debe hacer alguna forma de decir "detente, no hay nada m√°s que leer". </font><font style="vertical-align: inherit;">Por lo tanto, antes de devolver el error al objeto que realiza la llamada </font></font><code>CountLine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, debe verificar que el error no est√© relacionado </font></font><code>io.EOF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego transmitirlo; de lo contrario, volveremos </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y diremos que todo est√° bien. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creo que este es un buen ejemplo de la tesis de Russ Cox sobre c√≥mo el manejo de errores puede ocultar la funci√≥n. </font><font style="vertical-align: inherit;">Veamos la versi√≥n mejorada.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountLines</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { sc := bufio.NewScanner(r) lines := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sc.Scan() { lines++ } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lines, sc.Err() }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta versi√≥n mejorada utiliza en su </font></font><code>bufio.Scanner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lugar </font></font><code>bufio.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Under the hood </font></font><code>bufio.Scanner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa </font></font><code>bufio.Reader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero agrega un buen nivel de abstracci√≥n, lo que ayuda a eliminar el manejo de errores.</font></font><br><br><blockquote> <b></b> . <code>bufio.Scanner</code>    ,      . </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El m√©todo </font></font><code>sc.Scan()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve un valor </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el esc√°ner encontr√≥ una cadena y no encontr√≥ un error. Por lo tanto, el cuerpo del bucle se </font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llama solo si hay una l√≠nea de texto en el b√∫fer del esc√°ner. Esto significa que el nuevo </font></font><code>CountLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maneja casos cuando no hay una nueva l√≠nea o cuando el archivo est√° vac√≠o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar, dado que </font></font><code>sc.Scan</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresa </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando se detecta un error, el ciclo </font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finaliza cuando llega al final del archivo o se detecta un error. El tipo </font></font><code>bufio.Scanner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recuerda el primer error que encontr√≥ y, utilizando el m√©todo </font></font><code>sc.Err()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, podemos restaurar ese error tan pronto como salgamos del ciclo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, se </font></font><code>sc.Err()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encarga del procesamiento </font></font><code>io.EOF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y lo convierte </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si se </font><font style="vertical-align: inherit;">llega al </font><font style="vertical-align: inherit;">final del archivo sin errores.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si encuentra un manejo excesivo de errores, intente extraer algunas operaciones en un tipo auxiliar.</font></font></blockquote><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1.2. </font><font style="vertical-align: inherit;">Escribir respuesta</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mi segundo ejemplo est√° inspirado en la publicaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Los errores son valores"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anteriormente vimos ejemplos de c√≥mo se abre, escribe y cierra un archivo. </font><font style="vertical-align: inherit;">Hay manejo de errores, pero no es demasiado, porque las operaciones se pueden encapsular en ayudantes, como </font></font><code>ioutil.ReadFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>ioutil.WriteFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pero cuando se trabaja con protocolos de red de bajo nivel, es necesario crear una respuesta directamente utilizando primitivas de E / S. </font><font style="vertical-align: inherit;">En este caso, el manejo de errores puede volverse intrusivo. </font><font style="vertical-align: inherit;">Considere un fragmento de un servidor HTTP que crea una respuesta HTTP.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Header <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Key, Value <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Status <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Code <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Reason <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, st Status, headers []Header, body io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { _, err := fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 %d %s\r\n"</span></span>, st.Code, st.Reason) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, h := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> headers { _, err := fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">"%s: %s\r\n"</span></span>, h.Key, h.Value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err := fmt.Fprint(w, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } _, err = io.Copy(w, body) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero, construya la barra de estado con </font></font><code>fmt.Fprintf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y verifique el error. Luego, para cada encabezado, escribimos una clave y un valor de encabezado, cada vez que verificamos un error. Finalmente, completamos la secci√≥n del encabezado con una adicional </font></font><code>\r\n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, verificamos el error y copiamos el cuerpo de la respuesta al cliente. Finalmente, aunque no necesitamos verificar el error </font></font><code>io.Copy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, debemos traducirlo de dos valores devueltos al √∫nico que retorna </font></font><code>WriteResponse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un trabajo mon√≥tono. Pero puede facilitar su tarea aplicando un peque√±o tipo de envoltorio </font></font><code>errWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>errWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satisface el contrato </font></font><code>io.Writer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por lo que puede usarse como envoltorio. </font></font><code>errWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pasa registros a trav√©s de la funci√≥n hasta que se detecta un error. En este caso, rechaza las entradas y devuelve el error anterior.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> errWriter <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { io.Writer err error } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *errWriter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e.err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, e.err } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, e.err = e.Writer.Write(buf) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, st Status, headers []Header, body io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { ew := &amp;errWriter{Writer: w} fmt.Fprintf(ew, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 %d %s\r\n"</span></span>, st.Code, st.Reason) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, h := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> headers { fmt.Fprintf(ew, <span class="hljs-string"><span class="hljs-string">"%s: %s\r\n"</span></span>, h.Key, h.Value) } fmt.Fprint(ew, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) io.Copy(ew, body) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ew.err }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si se aplica </font></font><code>errWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font><code>WriteResponse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la claridad del c√≥digo mejor√≥ significativamente. </font><font style="vertical-align: inherit;">Ya no necesita verificar errores en cada operaci√≥n individual. </font><font style="vertical-align: inherit;">El mensaje de error se mueve al final de la funci√≥n como una comprobaci√≥n de campo </font></font><code>ew.err</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, evitando la molesta traducci√≥n de los valores devueltos de io.Copy.</font></font><br><br><a name="7_2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2. </font><font style="vertical-align: inherit;">Manejar el error solo una vez</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, quiero se√±alar que los errores deben manejarse solo una vez. </font><font style="vertical-align: inherit;">Procesar significa verificar el significado del error y tomar una </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sola</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decisi√≥n.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// WriteAll writes the contents of buf to the supplied writer. func WriteAll(w io.Writer, buf []byte) { w.Write(buf) }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si toma menos de una decisi√≥n, ignora el error. </font><font style="vertical-align: inherit;">Como vemos aqu√≠, se </font></font><code>w.WriteAll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ignora </font><font style="vertical-align: inherit;">el error de </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero tomar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√°s de una</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decisi√≥n en respuesta a un error tambi√©n est√° mal. </font><font style="vertical-align: inherit;">A continuaci√≥n se muestra el c√≥digo que a menudo encuentro.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, buf []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { _, err := w.Write(buf) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Println(<span class="hljs-string"><span class="hljs-string">"unable to write:"</span></span>, err) <span class="hljs-comment"><span class="hljs-comment">// annotated error goes to log file return err // unannotated error returned to caller } return nil }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este ejemplo, si se produce un error durante el tiempo </font></font><code>w.Write</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la l√≠nea se escribe en el registro y tambi√©n se devuelve a la persona que llama, que tambi√©n puede registrarlo y pasarlo al nivel superior del programa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo m√°s probable es que la persona que llama haga lo mismo:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, conf *Config)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { buf, err := json.Marshal(conf) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"could not marshal config: %v"</span></span>, err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := WriteAll(w, buf); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Println(<span class="hljs-string"><span class="hljs-string">"could not write config: %v"</span></span>, err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por lo tanto, se crea una pila de l√≠neas repetidas en el registro. </font></font><br><br><pre> <code class="go hljs">unable to write: io.EOF could not write config: io.EOF</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero en la parte superior del programa obtienes un error original sin ning√∫n contexto. </font></font><br><br><pre> <code class="go hljs">err := WriteConfig(f, &amp;conf) fmt.Println(err) <span class="hljs-comment"><span class="hljs-comment">// io.EOF</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quiero analizar este tema con m√°s detalle, porque no considero el problema de devolver simult√°neamente un error y registrar mis preferencias personales. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, conf *Config)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { buf, err := json.Marshal(conf) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"could not marshal config: %v"</span></span>, err) <span class="hljs-comment"><span class="hljs-comment">// oops, forgot to return } if err := WriteAll(w, buf); err != nil { log.Println("could not write config: %v", err) return err } return nil }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A menudo encuentro un problema que un programador olvida regresar de un error. Como dijimos anteriormente, el estilo de Go es usar operadores de l√≠mites, verificar los requisitos previos a medida que se ejecuta la funci√≥n y regresar temprano. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este ejemplo, el autor verific√≥ el error, lo registr√≥, pero </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">olvid√≥</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regresar. Debido a esto, surge un problema sutil. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El contrato de manejo de errores de Go dice que en presencia de un error, no se pueden hacer suposiciones sobre el contenido de otros valores de retorno. Dado que el c√°lculo de referencias JSON fall√≥, el contenido es </font></font><code>buf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desconocido: puede no contener nada, pero lo que es peor, puede contener un fragmento JSON medio escrito.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como el programador olvid√≥ regresar despu√©s de verificar y registrar el error, se transferir√° el b√∫fer da√±ado </font></font><code>WriteAll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es probable que la operaci√≥n tenga √©xito y, por lo tanto, el archivo de configuraci√≥n no se escribir√° correctamente. </font><font style="vertical-align: inherit;">Sin embargo, la funci√≥n se completa normalmente, y la √∫nica se√±al de que se ha producido un problema es una l√≠nea en el registro donde fall√≥ el c√°lculo de referencias JSON, y no un error de registro de configuraci√≥n.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2.1 </font><font style="vertical-align: inherit;">Agregar contexto a los errores</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se produjo un error porque el autor intentaba agregar contexto al mensaje de error. </font><font style="vertical-align: inherit;">Trat√≥ de dejar una marca para indicar la fuente del error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos otra forma de hacer lo mismo </font></font><code>fmt.Errorf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, conf *Config)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { buf, err := json.Marshal(conf) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"could not marshal config: %v"</span></span>, err) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := WriteAll(w, buf); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"could not write config: %v"</span></span>, err) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, buf []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { _, err := w.Write(buf) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Errorf(<span class="hljs-string"><span class="hljs-string">"write failed: %v"</span></span>, err) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si combina el registro de error con el retorno en una l√≠nea, es m√°s dif√≠cil olvidar regresar y evitar la continuaci√≥n accidental. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si se produce un error de E / S al escribir el archivo, el m√©todo </font></font><code>Error()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">producir√° algo como esto:</font></font><br><br><pre> <code class="go hljs">could not write config: write failed: input/output error</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2.2 </font><font style="vertical-align: inherit;">Error al envolver con github.com/pkg/errors</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El patr√≥n </font></font><code>fmt.Errorf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona bien para grabar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensajes de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> error, pero el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tipo de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> error se deja de lado. </font><font style="vertical-align: inherit;">Argument√© que manejar los errores como valores opacos es importante para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proyectos </font><i><font style="vertical-align: inherit;">acoplados libremente</font></i><font style="vertical-align: inherit;"> , por lo que el tipo de error de origen no deber√≠a importar si solo necesitamos trabajar con su valor:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aseg√∫rese de que no sea cero. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Visual√≠zalo en la pantalla o reg√≠stralo. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, sucede que necesita restaurar el error original. </font><font style="vertical-align: inherit;">Para anotar tales errores, puede usar algo como mi paquete </font></font><code>errors</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { f, err := os.Open(path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.Wrap(err, <span class="hljs-string"><span class="hljs-string">"open failed"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> f.Close() buf, err := ioutil.ReadAll(f) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.Wrap(err, <span class="hljs-string"><span class="hljs-string">"read failed"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { home := os.Getenv(<span class="hljs-string"><span class="hljs-string">"HOME"</span></span>) config, err := ReadFile(filepath.Join(home, <span class="hljs-string"><span class="hljs-string">".settings.xml"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config, errors.WithMessage(err, <span class="hljs-string"><span class="hljs-string">"could not read config"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { _, err := ReadConfig() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Println(err) os.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ahora el mensaje se convierte en un buen error de estilo K&amp;D: </font></font><br><br><pre> <code class="go hljs">could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y su valor contiene un enlace al motivo original. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { _, err := ReadConfig() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"original error: %T %v\n"</span></span>, errors.Cause(err), errors.Cause(err)) fmt.Printf(<span class="hljs-string"><span class="hljs-string">"stack trace:\n%+v\n"</span></span>, err) os.Exit(<span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por lo tanto, puede restaurar el error original y mostrar el seguimiento de la pila: </font></font><br><br><pre> <code class="plaintext hljs">original error: *os.PathError open /Users/dfc/.settings.xml: no such file or directory stack trace: open /Users/dfc/.settings.xml: no such file or directory open failed main.ReadFile /Users/dfc/devel/practical-go/src/errors/readfile2.go:16 main.ReadConfig /Users/dfc/devel/practical-go/src/errors/readfile2.go:29 main.main /Users/dfc/devel/practical-go/src/errors/readfile2.go:35 runtime.main /Users/dfc/go/src/runtime/proc.go:201 runtime.goexit /Users/dfc/go/src/runtime/asm_amd64.s:1333 could not read config</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El paquete le </font></font><code>errors</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite agregar contexto a los valores de error en un formato conveniente tanto para una persona como para una m√°quina. </font><font style="vertical-align: inherit;">En una presentaci√≥n reciente, les dije que en la pr√≥xima versi√≥n de Go, tal contenedor aparecer√° en la biblioteca est√°ndar.</font></font><br><br><a name="8"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 8. Concurrencia </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go a menudo se elige debido a sus capacidades de concurrencia. Los desarrolladores han hecho mucho para aumentar su eficiencia (en t√©rminos de recursos de hardware) y rendimiento, pero las funciones de paralelismo de Go se pueden usar para escribir c√≥digo que no sea productivo ni confiable. Al final del art√≠culo, quiero dar un par de consejos sobre c√≥mo evitar algunas de las dificultades de las funciones de concurrencia de Go. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El soporte de concurrencia de primer nivel de Go es proporcionado por canales, as√≠ como instrucciones </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si estudiaste la teor√≠a de Go en libros de texto o en una universidad, es posible que hayas notado que la secci√≥n de paralelismo siempre es una de las √∫ltimas del curso. </font><font style="vertical-align: inherit;">Nuestro art√≠culo no es diferente: decid√≠ hablar sobre paralelismo al final, como algo adicional a las habilidades habituales que el programador Go deber√≠a aprender. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay una cierta dicotom√≠a, porque la caracter√≠stica principal de Go es nuestro modelo de paralelismo simple y f√°cil. </font><font style="vertical-align: inherit;">Como producto, nuestro lenguaje se vende a expensas de casi esta funci√≥n. </font><font style="vertical-align: inherit;">Por otro lado, la concurrencia en realidad no es tan f√°cil de usar, de lo contrario los autores no lo habr√≠an convertido en el √∫ltimo cap√≠tulo de sus libros, y no habr√≠amos mirado con pesar nuestro c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta secci√≥n se analizan algunas de las trampas del uso ingenuo de las funciones de concurrencia de Go.</font></font><br><br><a name="8_1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.1. </font><font style="vertical-align: inherit;">Haz algo de trabajo todo el tiempo.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øCu√°l es el problema con este programa? </font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { fmt.Fprintln(w, <span class="hljs-string"><span class="hljs-string">"Hello, GopherCon SG"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } }() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El programa hace lo que pretend√≠amos: sirve un servidor web simple. </font><font style="vertical-align: inherit;">Al mismo tiempo, pasa el tiempo de la CPU en un bucle infinito, porque </font></font><code>for{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la √∫ltima l√≠nea </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloquea gorutin main, sin realizar ninguna E / S, no hay que esperar para bloquear, enviar o recibir mensajes, o alg√∫n tipo de conexi√≥n con el programador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que el tiempo de ejecuci√≥n de Go generalmente es atendido por un programador, este programa se ejecutar√° sin sentido en el procesador y puede terminar en un bloqueo activo (bloqueo en vivo). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo arreglarlo? </font><font style="vertical-align: inherit;">Aqu√≠ hay una opci√≥n.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> <span class="hljs-string"><span class="hljs-string">"runtime"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { fmt.Fprintln(w, <span class="hljs-string"><span class="hljs-string">"Hello, GopherCon SG"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } }() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { runtime.Gosched() } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede parecer una tonter√≠a, pero esta es una soluci√≥n com√∫n que se me ocurre en la vida real. </font><font style="vertical-align: inherit;">Este es un s√≠ntoma de un malentendido del problema subyacente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si tienes un poco m√°s de experiencia con Go, puedes escribir algo como esto.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { fmt.Fprintln(w, <span class="hljs-string"><span class="hljs-string">"Hello, GopherCon SG"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } }() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> {} }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una declaraci√≥n vac√≠a se </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloquea para siempre. </font><font style="vertical-align: inherit;">Esto es √∫til, porque ahora no hacemos girar todo el procesador solo por una llamada </font></font><code>runtime.GoSched()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sin embargo, tratamos solo el s√≠ntoma, no la causa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiero mostrarte otra soluci√≥n que, espero, ya se te haya ocurrido. </font><font style="vertical-align: inherit;">En lugar de correr </font></font><code>http.ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en goroutine, dejando el problema principal de goroutine, solo corre </font></font><code>http.ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la goroutine principal.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si sale de la funci√≥n </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el programa Go finaliza incondicionalmente, independientemente de lo que hagan otras rutinas que se ejecuten durante la ejecuci√≥n del programa.</font></font></blockquote><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"log"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { fmt.Fprintln(w, <span class="hljs-string"><span class="hljs-string">"Hello, GopherCon SG"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":8080"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As√≠ que este es mi primer consejo: si goroutine no puede avanzar hasta que reciba un resultado de otro, entonces a menudo es m√°s f√°cil hacer el trabajo usted mismo, en lugar de delegarlo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto a menudo elimina una gran cantidad de rastreo de estado y manipulaci√≥n de canales necesarios para transferir el resultado de la rutina al iniciador del proceso.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Muchos programadores de Go abusan de las gorutinas, especialmente al principio. </font><font style="vertical-align: inherit;">Como todo lo dem√°s en la vida, la clave del √©xito es la moderaci√≥n.</font></font></blockquote><br><a name="8_2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.2. </font><font style="vertical-align: inherit;">Deja paralelismo a la persona que llama</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øCu√°l es la diferencia entre las dos API? </font></font><br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// ListDirectory returns the contents of dir. func ListDirectory(dir string) ([]string, error)</span></span></code> </pre> <br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// ListDirectory returns a channel over which // directory entries will be published. When the list // of entries is exhausted, the channel will be closed. func ListDirectory(dir string) chan string</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mencionamos las diferencias obvias: el primer ejemplo lee el directorio en un segmento y luego devuelve todo el segmento o error si algo sali√≥ mal. Esto ocurre sincr√≥nicamente, la persona que llama se bloquea </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hasta que se hayan le√≠do todas las entradas del directorio. Dependiendo de qu√© tan grande sea el directorio, puede llevar mucho tiempo y potencialmente mucha memoria. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Considere el segundo ejemplo. Es un poco m√°s como la programaci√≥n cl√°sica de Go, aqu√≠ </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve el canal a trav√©s del cual se transmitir√°n las entradas del directorio. Cuando el canal est√° cerrado, esto es una se√±al de que no hay m√°s entradas de cat√°logo. Como el llenado del canal ocurre despu√©s del regreso </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se puede suponer que las gorutinas comienzan a llenar el canal.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En la segunda opci√≥n, no es necesario usar goroutine: puede seleccionar un canal suficiente para almacenar todas las entradas del directorio sin bloquear, completarlo, cerrarlo y luego devolver el canal a la persona que llama. </font><font style="vertical-align: inherit;">Pero esto es poco probable, ya que en este caso surgir√°n los mismos problemas al usar una gran cantidad de memoria para almacenar todos los resultados en el canal.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La versi√≥n del </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">canal tiene dos problemas m√°s:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El uso de un canal cerrado como se√±al de que no hay m√°s elementos para procesar, </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no puede informar al llamador de un conjunto incompleto de elementos debido a un error. </font><font style="vertical-align: inherit;">La persona que llama no tiene forma de transmitir la diferencia entre un directorio vac√≠o y un error. </font><font style="vertical-align: inherit;">En ambos casos, parece que el canal se cerrar√° inmediatamente.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La persona que llama debe continuar leyendo desde el canal cuando est√° cerrado, porque esta es la √∫nica manera de entender que el canal que llena la rutina ha dejado de funcionar. </font><font style="vertical-align: inherit;">Esta es una restricci√≥n seria de uso </font></font><code>ListDirectory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: la persona que llama pasa tiempo leyendo el canal, incluso si recibi√≥ todos los datos necesarios. </font><font style="vertical-align: inherit;">Esto es probablemente m√°s eficiente en t√©rminos de uso de memoria para directorios medianos y grandes, pero el m√©todo no es m√°s r√°pido que el m√©todo original basado en el segmento.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En ambos casos, la soluci√≥n es usar una devoluci√≥n de llamada: una funci√≥n que se llama en el contexto de cada entrada de directorio a medida que se ejecuta. </font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ListDirectory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dir </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, fn </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">func</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como era de esperar, la funci√≥n </font></font><code>filepath.WalkDir</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona de esa manera.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si su funci√≥n inicia goroutine, debe proporcionar a la persona que llama una forma de detener expl√≠citamente esta rutina. </font><font style="vertical-align: inherit;">A menudo es m√°s f√°cil dejar el modo de ejecuci√≥n as√≠ncrono en la persona que llama.</font></font></blockquote><br><a name="8_3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.3. </font><font style="vertical-align: inherit;">Nunca ejecute goroutine sin saber cu√°ndo se detendr√°</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el ejemplo anterior, la gorutina se us√≥ innecesariamente. </font><font style="vertical-align: inherit;">Pero una de las principales fortalezas de Go es su capacidad de concurrencia de primera clase. </font><font style="vertical-align: inherit;">De hecho, en muchos casos el trabajo paralelo es bastante apropiado, y luego es necesario usar gorutinas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta sencilla aplicaci√≥n sirve el tr√°fico http en dos puertos diferentes: el puerto 8080 para el tr√°fico de la aplicaci√≥n y el puerto 8001 para acceder al punto final </font></font><code>/debug/pprof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"net/http"</span></span> _ <span class="hljs-string"><span class="hljs-string">"net/http/pprof"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { mux := http.NewServeMux() mux.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resp http.ResponseWriter, req *http.Request)</span></span></span></span> { fmt.Fprintln(resp, <span class="hljs-string"><span class="hljs-string">"Hello, QCon!"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8001"</span></span>, http.DefaultServeMux) <span class="hljs-comment"><span class="hljs-comment">// debug http.ListenAndServe("0.0.0.0:8080", mux) // app traffic }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aunque el programa no es complicado, es la base de una aplicaci√≥n real. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La aplicaci√≥n en su forma actual tiene varios problemas que aparecer√°n a medida que crecen, as√≠ que veamos de inmediato algunos de ellos.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { mux := http.NewServeMux() mux.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resp http.ResponseWriter, req *http.Request)</span></span></span></span> { fmt.Fprintln(resp, <span class="hljs-string"><span class="hljs-string">"Hello, QCon!"</span></span>) }) http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, mux) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveDebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8001"</span></span>, http.DefaultServeMux) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> serveDebug() serveApp() }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manipuladores de ruptura </font></font><code>serveApp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>serveDebug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de funciones separadas, hemos separado de ellos </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tambi√©n seguimos el consejo anterior y nos aseguramos </font></font><code>serveApp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>serveDebug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dejamos la tarea de asegurar el paralelismo de la persona que llama. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero hay algunos problemas con el rendimiento de dicho programa. </font><font style="vertical-align: inherit;">Si salimos </font></font><code>serveApp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego </font><font style="vertical-align: inherit;">salimos </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el programa termina y el administrador de procesos lo reiniciar√°.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As√≠ como las funciones en Go dejan paralelismo a la persona que llama, las aplicaciones deber√≠an dejar de monitorear su estado y reiniciar el programa que las llam√≥. </font><font style="vertical-align: inherit;">No responsabilice a sus aplicaciones de reiniciarse: este procedimiento se maneja mejor desde fuera de la aplicaci√≥n.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, </font></font><code>serveDebug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comienza en una rutina diferente, y en caso de su lanzamiento, la rutina termina, mientras que el resto del programa contin√∫a. </font><font style="vertical-align: inherit;">A sus desarrolladores no les gustar√° el hecho de que no puedan obtener estad√≠sticas de la aplicaci√≥n porque el controlador </font></font><code>/debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha dejado de funcionar por mucho tiempo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necesitamos asegurarnos de que la aplicaci√≥n est√© cerrada si </font><font style="vertical-align: inherit;">se </font><font style="vertical-align: inherit;">detiene </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cualquier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rutina que la atienda.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { mux := http.NewServeMux() mux.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resp http.ResponseWriter, req *http.Request)</span></span></span></span> { fmt.Fprintln(resp, <span class="hljs-string"><span class="hljs-string">"Hello, QCon!"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, mux); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveDebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8001"</span></span>, http.DefaultServeMux); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(err) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> serveDebug() <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> serveApp() <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> {} }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora </font></font><code>serverApp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>serveDebug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">errores de comprobaci√≥n de </font></font><code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y si es causa necesaria </font></font><code>log.Fatal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dado que ambos manejadores trabajan en goroutines, elaboramos la rutina principal en </font></font><code>select{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este enfoque tiene varios problemas:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si </font></font><code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regresa con un error </font></font><code>nil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no habr√° llamada </font></font><code>log.Fatal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el servicio HTTP en este puerto se cerrar√° sin detener la aplicaci√≥n.</font></font><br></li><li> <code>log.Fatal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llamadas </font></font><code>os.Exit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que salen incondicionalmente del programa; </font><font style="vertical-align: inherit;">las llamadas diferidas no funcionar√°n, otras gorutinas no ser√°n notificadas del cierre, el programa simplemente se detendr√°. </font><font style="vertical-align: inherit;">Esto hace que sea dif√≠cil escribir pruebas para estas funciones.</font></font></li></ol><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Usar solo </font></font><code>log.Fatal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en funciones </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, queremos transmitir cualquier error que ocurra al creador de la gorutina, para que pueda descubrir por qu√© se detuvo y complet√≥ limpiamente el proceso.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { mux := http.NewServeMux() mux.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(resp http.ResponseWriter, req *http.Request)</span></span></span></span> { fmt.Fprintln(resp, <span class="hljs-string"><span class="hljs-string">"Hello, QCon!"</span></span>) }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span>, mux) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serveDebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">"127.0.0.1:8001"</span></span>, http.DefaultServeMux) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { done := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> error, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { done &lt;- serveDebug() }() <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { done &lt;- serveApp() }() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>(done); i++ { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := &lt;-done; err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"error: %v"</span></span>, err) } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado de devoluci√≥n de Goroutine se puede obtener a trav√©s del canal. El tama√±o del canal es igual a la cantidad de gorutinas que queremos controlar, por lo que el env√≠o al canal </font></font><code>done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se bloquear√°, ya que esto bloquear√° el cierre de las gorutinas y provocar√° una fuga. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como el canal </font></font><code>done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no puede cerrarse de manera segura, no podemos usar el idioma para el ciclo del canal </font></font><code>for range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hasta que todas las gorutinas hayan informado. En cambio, ejecutamos todas las goroutines en ejecuci√≥n en un ciclo, que es igual a la capacidad del canal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora tenemos una manera de salir limpiamente de cada rutina y corregir todos los errores que encuentren. Solo queda enviar una se√±al para completar el trabajo desde la primera gorutina a todos los dem√°s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El llamamiento a</font></font><code>http.Server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre la finalizaci√≥n, as√≠ que envolv√≠ esta l√≥gica en una funci√≥n auxiliar. </font><font style="vertical-align: inherit;">El ayudante </font></font><code>serve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acepta la direcci√≥n y </font></font><code>http.Handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, del mismo modo </font></font><code>http.ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el canal </font></font><code>stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que usamos para ejecutar el m√©todo </font></font><code>Shutdown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(addr </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, handler http.Handler, stop &lt;-</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">struct</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { s := http.Server{ Addr: addr, Handler: handler, } <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { &lt;-stop <span class="hljs-comment"><span class="hljs-comment">// wait for stop signal s.Shutdown(context.Background()) }() return s.ListenAndServe() } func serveApp(stop &lt;-chan struct{}) error { mux := http.NewServeMux() mux.HandleFunc("/", func(resp http.ResponseWriter, req *http.Request) { fmt.Fprintln(resp, "Hello, QCon!") }) return serve("0.0.0.0:8080", mux, stop) } func serveDebug(stop &lt;-chan struct{}) error { return serve("127.0.0.1:8001", http.DefaultServeMux, stop) } func main() { done := make(chan error, 2) stop := make(chan struct{}) go func() { done &lt;- serveDebug(stop) }() go func() { done &lt;- serveApp(stop) }() var stopped bool for i := 0; i &lt; cap(done); i++ { if err := &lt;-done; err != nil { fmt.Println("error: %v", err) } if !stopped { stopped = true close(stop) } } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora, para cada valor en el canal </font><font style="vertical-align: inherit;">, cerramos </font></font><code>done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el canal </font></font><code>stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que hace que cada gorutina en este canal cierre por su cuenta </font></font><code>http.Server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A su vez, esto lleva a un retorno de todas las goroutinas restantes </font></font><code>ListenAndServe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cuando todas las gorutinas en ejecuci√≥n se han detenido, </font></font><code>main.main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finaliza y el proceso se detiene limpiamente.</font></font><br><br><blockquote> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Escribir esa l√≥gica por su cuenta es un trabajo repetitivo y el riesgo de errores. </font><font style="vertical-align: inherit;">Mire algo como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este paquete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que har√° la mayor parte del trabajo por usted.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441842/">https://habr.com/ru/post/441842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441826/index.html">Lo que est√° sucediendo en el mercado de transmisi√≥n de audio: discutiendo el desarrollo de plataformas de transmisi√≥n</a></li>
<li><a href="../441830/index.html">Gu√≠a del usuario de Kibana. Visualizaci√≥n. Parte 4</a></li>
<li><a href="../441832/index.html">¬øQui√©n es el gerente del proyecto en opini√≥n del propietario del negocio y c√≥mo tratarlo?</a></li>
<li><a href="../441834/index.html">No llevar a trabajar. Pero, ¬øy si el problema est√° en ti?</a></li>
<li><a href="../441836/index.html">One Cloud Story: Huawei + 3data = Cloud</a></li>
<li><a href="../441844/index.html">iRobot Scooba: experiencia y soluciones a problemas comunes de un robot limpiador de lavado</a></li>
<li><a href="../441848/index.html">Pasant√≠as para desarrolladores en Avito: misiones de combate y trabajo con mentores experimentados</a></li>
<li><a href="../441850/index.html">Adivinaci√≥n en redes neuronales: si el propio autor se√±al√≥ en los comentarios en la publicaci√≥n</a></li>
<li><a href="../441852/index.html">42 Silicon Valley: c√≥mo ser seleccionado</a></li>
<li><a href="../441854/index.html">DESCANSO? Toma un tonto JSON-RPC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>