<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏üèæ üï¢ üë©üèª‚Äçüíº Experi√™ncia com impressoras de cart√µes, parte 1 üê£ üë©‚Äçüî¨ üëâüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo ser√° √∫til para quem come√ßa a trabalhar com impressoras de cart√µes ( Evolis Primacy e Smart-51 ) e cart√µes codificados por NFC, como o Mifa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experi√™ncia com impressoras de cart√µes, parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481734/"><p>  Este artigo ser√° √∫til para quem come√ßa a trabalhar com impressoras de cart√µes ( <strong>Evolis Primacy</strong> e <strong>Smart-51</strong> ) e cart√µes codificados por NFC, como o <strong>Mifare Classic</strong> e o <strong>Mifare DESFire EV2</strong> .  Na primeira parte, descreveremos a impress√£o geral de trabalhar com impressoras de cart√µes, bem como os problemas que tivemos que enfrentar.  Na segunda parte, est√° planejado mostrar partes mais pr√°ticas: c√≥digo, dicas de opera√ß√£o. </p><br><h3 id="1-kak-poyavilas-zadacha">  1. Como a tarefa apareceu </h3><br><p>  Estamos desenvolvendo um sistema de bilhetagem eletr√¥nica, que inclui o trabalho com cart√µes NFC.  Cada cart√£o NFC possui um n√∫mero f√°cil de usar e um <strong>ID</strong> individual.  <strong>O n√∫mero</strong> deve ser impresso no cart√£o e o <strong>ID est√°</strong> escrito no chip NFC.  Uma das tarefas era estabelecer uma produ√ß√£o est√°vel de cart√µes de transporte. </p><br><p>  Na primeira etapa, o problema foi resolvido da maneira mais simples - as impress√µes com <strong>Numbers</strong> s√£o impressas pelo fornecedor do cart√£o NFC e as IDs s√£o gravadas por n√≥s usando leitores de mesa, software especial e uma pessoa.  Ap√≥s receber os cart√µes do fornecedor, √© necess√°rio registrar o cart√£o no sistema e associar o <strong>ID</strong> e o <strong>N√∫mero</strong> um ao outro.  Como leitor de mesa, usamos o Z-2 Reader [1]. </p><br><p>  O processo ficou mais ou menos assim: </p><br><ul><li>  O operador pega um cart√£o.  O n√∫mero do cart√£o j√° est√° impresso no cart√£o, mas o registro do cart√£o no sistema e a grava√ß√£o do <strong>ID</strong> no chip NFC </li><li>  O operador coloca o cart√£o no leitor Z-2 e registra o <strong>n√∫mero</strong> no sistema de bilhetes eletr√¥nicos, inserindo manualmente o <strong>n√∫mero</strong> do cart√£o.  Para empacotamento e registro, √© feita uma chamada da API HTTPS </li><li>  O operador pega o pr√≥ximo cart√£o e faz de novo. </li></ul><br><p>  Uma solu√ß√£o simples e r√°pida com uma <em>pequena</em> desvantagem.  A influ√™ncia do fator humano gera cart√µes fantasmas para os quais o <strong>N√∫mero</strong> impresso no cart√£o n√£o corresponde ao <strong>ID</strong> - <strong>N√∫mero</strong> do link no banco de dados do sistema. </p><a name="habracut"></a><br><p>  Assim, nasceu a seguinte declara√ß√£o do problema: √â necess√°rio imprimir o <strong>n√∫mero</strong> , anotar o <strong>ID</strong> e registrar os cart√µes NFC no sistema <strong>atomicamente</strong> e com o m√≠nimo envolvimento humano. </p><br><p>  Neste artigo, descreveremos todos os equipamentos com os quais trabalhamos e todas as armadilhas.  No final, tentaremos dizer qual equipamento nos parece melhor. </p><br><h3 id="11-nfc-karty">  1.1  Cart√µes NFC </h3><br><p>  Analisamos os cart√µes NFC MIFARE Classic 1K e MIFARE DESFire EV2.  O MIFARE Classic √© o mais comum e mais vulner√°vel a c√≥pia.  No entanto, eles continuam a ser populares em lugares como universidades e transporte p√∫blico.  Ao lidar com fluxos de caixa, √© necess√°ria uma solu√ß√£o mais confi√°vel.  Portanto, os cart√µes MIFARE DESFire EV2 se tornaram uma alternativa.  Este √© um dos √∫ltimos tipos de cart√µes que usam algoritmos de criptografia DES, TDES (2KTDES, 3KTDES), AES [2, 3].  Brevemente sobre cada mapa: </p><br><p>  <em>MIFARE Classic</em> </p><br><p>  O cart√£o de mem√≥ria √© um setor e bloqueia.  A primeira unidade de mem√≥ria √© um setor.  Existem 16 setores no mapa, cada um com 4 blocos de dados.  A mem√≥ria de cada bloco √© de 16 bytes.  Para ler e / ou gravar dados, o leitor deve efetuar login no setor.  Um bloco especial em cada setor, o bloco de reboque, foi projetado para armazenar chaves.  Primeiro de tudo, para trabalhar com o setor, √© necess√°rio fazer login no bloco de reboque.  O bloco de reboque tamb√©m armazena 16 bytes: 6 bytes por tipo de chave A, 4 bytes por direitos de acesso, 6 bytes por tipo de chave B. </p><br><p>  A figura 1 [4] mostra claramente os setores, blocos e chaves. </p><br><br><p><img src="https://habrastorage.org/webt/lj/mr/as/ljmrasis1ncssiee0chfn8ougie.png"><br>  Figura 1 - Dispositivo de mem√≥ria no Mifare Classic </p><br><p>  <em>MIFARE DESFire</em> </p><br><p>  O dispositivo do cart√£o se parece com um sistema de arquivos.  O cart√£o consiste em aplicativos e arquivos.  No mapa, h√° um aplicativo principal (aplicativo) com o ID - 000000 (0x00, 0x00, 0x00).  Dentro do aplicativo principal, voc√™ pode criar um novo aplicativo e criar arquivos de dados dentro dele. <br>  As caracter√≠sticas dos cart√µes DESFire s√£o apresentadas na Figura 2 [5].  Cada aplicativo recebe suas pr√≥prias chaves de acesso nos arquivos do aplicativo. </p><br><p><img src="https://habrastorage.org/webt/6q/xc/6f/6qxc6fkpk9i2jjpocy9v6iwgf0c.png"><br>  Figura 2 - Caracter√≠sticas dos cart√µes Mifare DESFire </p><br><h3 id="12-printery-kak-reshenie">  1.2  Impressoras como solu√ß√£o </h3><br><p>  Para realizar essa tarefa, impressoras de cart√µes especiais s√£o usadas.  No momento, existem muitas empresas diferentes fornecendo essas impressoras.  Por exemplo: Evolis, Smart, Zebra, Datacard, etc. Usamos as impressoras <strong>Evolis Primacy</strong> e <strong>Smart-51</strong> .  Essas impressoras t√™m muito em comum no centro do trabalho: ambas usam cartuchos de fita para impress√£o e t√™m um princ√≠pio de limpeza semelhante.  Tamb√©m existem diferen√ßas - codificadores NFC diferentes.  Ambas as impressoras podem ser complementadas ou substitu√≠das, dependendo das necessidades do cliente. </p><br><p>  Os programadores para cart√µes NFC s√£o baseados nos padr√µes ISO / IEC 14443A e ISO / IEC 7816-4 para DESFire, ISO / IEC 14443 Tipo A para Classic.  No entanto, dependendo do fabricante, os programadores podem aceitar comandos nativos de acordo com os padr√µes ou agrupar os comandos nativos em espec√≠fico para um programador espec√≠fico.  Estamos diante de um e de outro. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis primacy </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Impress√£o </td><td>  A fita √© usada para impress√£o (colorida ou monocrom√°tica).  Uma fita cassete inteira √© fornecida. </td><td>  A fita √© usada para impress√£o (colorida ou monocrom√°tica).  Somente a fita √© fornecida, um cartucho e vem com a pr√≥pria impressora.  Um rolo de limpeza est√° inclu√≠do com a fita. </td></tr><tr><td>  Codificador </td><td>  Codificador Elyctis.  F√°cil de usar porque  suporta intera√ß√£o com bibliotecas padr√£o do Windows para comunica√ß√£o com placas NFC, winscard. </td><td>  Codificador DUALi.  O suporte t√©cnico fornece um SDK especial para trabalhar com o codificador. </td></tr><tr><td>  Limpeza </td><td>  Para manter a impressora em condi√ß√µes de funcionamento, √© necess√°rio limpeza constante.  Existem dois tipos de limpeza: peri√≥dica (ap√≥s cada 1000 cart√µes) e estendida (ap√≥s 5000 cart√µes).  A conformidade com o cronograma de limpeza √© um pr√©-requisito no contrato de garantia. </td><td>  A limpeza √© necess√°ria ap√≥s o uso da fita impressa.  Dependendo do tipo de fita e do tamanho da imagem para impress√£o, a limpeza ser√° necess√°ria ap√≥s 2 a 4 mil cart√µes. </td></tr><tr><td>  Habita√ß√£o </td><td>  A caixa de pl√°stico permite que a impressora seja bastante leve.  Os interiores podem ser facilmente alcan√ßados, porque as paredes da impressora se abrem dos dois lados. </td><td>  A caixa de metal torna a impressora confi√°vel para opera√ß√£o.  Algumas entranhas s√≥ podem ser vistas abrindo a tampa superior. </td></tr><tr><td>  De software </td><td>  Vem com o software especial ‚ÄúEvolis Print Center‚Äù e CardPresso.  O primeiro √© necess√°rio para as configura√ß√µes da impressora, equipadas com v√°rios auxiliares.  O segundo software permite testar rapidamente os recursos da impressora para impress√£o e codifica√ß√£o. </td><td>  N√£o √© necess√°rio software separado para controlar a impressora.  Propriedades de impressora suficientes na lista de dispositivos Windows.  Vem com o software SmartID para impress√£o e codifica√ß√£o. </td></tr></tbody></table></div><br>  Tabela 1 - Compara√ß√£o entre Evolis Primacy e Smart-51 <br><h3 id="2-eksperimenty">  2. Experi√™ncias </h3><br><p>  Em geral, o trabalho com impressoras pode ser dividido em v√°rias partes: comunica√ß√£o com suporte t√©cnico, estudo da intera√ß√£o de cart√µes e codificadores, impress√£o. </p><br><h3 id="21-vpechatlenie-ot-tehnicheskoy-podderzhki">  2.1  Impress√£o de suporte t√©cnico </h3><br><p>  O trabalho com impressoras inclu√≠a comunica√ß√£o constante com suporte t√©cnico, pois precis√°vamos escrever nosso pr√≥prio software.  Nos dois casos, conversamos mais com distribuidores de empresas em nosso pa√≠s e nos pa√≠ses vizinhos. </p><br><p>  Os distribuidores da Evolis sempre estiveram sempre em contato.  No entanto, quase imediatamente as especificidades das quest√µes mostraram a necessidade de comunica√ß√£o com os representantes da Evolis.  Infelizmente, eles n√£o nos deram seus contatos e tiveram que trocar mensagens atrav√©s de um distribuidor.  No entanto, isso dizia respeito apenas a quest√µes de impress√£o; em quest√µes de codifica√ß√£o, recebemos o correio de um representante da Elyctis.  A comunica√ß√£o direta com a Elyctis simplificou bastante o processo de codifica√ß√£o.  Puramente tecnicamente, n√≥s imediatamente nos entendemos e n√£o houve mal-entendidos.  No caso de exemplos de impress√£o e c√≥digo para o Evolis Primacy, a comunica√ß√£o em algum momento parou.  Basicamente, a impress√£o negativa foi causada pelos momentos em que exemplos de impress√£o em frente e verso n√£o funcionaram para n√≥s e demorou muito tempo para provar isso.  Cheguei √†s grava√ß√µes dos processos de impress√£o em v√≠deo, depois das dicas mais produtivas da Evolis. </p><br><p>  Uma das mais recentes quest√µes de suporte t√©cnico da Evolis foi como conectar a impressora via Ethernet.  No momento, estamos conectando a impressora via USB ao laptop, o que √© toler√°vel na presen√ßa de 1-2 impressoras.  As respostas ainda est√£o esperando.  No entanto, uma resposta j√° foi recebida da Elyctis de que o codificador da impressora Evolis Primacy n√£o fornece uma conex√£o de rede. </p><br><p>  A comunica√ß√£o com o suporte t√©cnico do Smart-51 tamb√©m se reduziu √† comunica√ß√£o com os representantes da empresa por meio de um distribuidor.  No in√≠cio, tudo correu bem.  Quando se tratava de cart√µes de codifica√ß√£o como o Mifare DESFire, os problemas come√ßaram.  As dificuldades foram causadas por equipes espec√≠ficas que voc√™ n√£o encontrar√° na Internet.  Por esse motivo, basta copiar algumas partes do c√≥digo de trabalho fornecido pelo fabricante como exemplo.  No entanto, a c√≥pia impensada n√£o leva ao bem.  Como resultado, duas semanas foram gastas explicando o erro ao fabricante, do lado do qual o homem estava claramente sentado, n√£o muito pr√≥ximo dos meandros do sistema, mas mantendo a documenta√ß√£o geral com ele.  Um precipitado desagrad√°vel permaneceu, mas come√ßou muito bem. </p><br><p>  A comunica√ß√£o atrav√©s de um distribuidor n√£o possui vantagens, desvantagens s√≥lidas.  Por exemplo: </p><br><ol><li>  Respostas atrasadas, porque a pessoa respons√°vel do lado do distribuidor pode estar ocupada com outras coisas ou sair de f√©rias. </li><li>  Quando o distribuidor est√° em outro pa√≠s, s√£o feriados adicionais, portanto, n√£o dias √∫teis.  No caso do Smart-51, a comunica√ß√£o ocorreu com a participa√ß√£o de pessoas de 3 pa√≠ses. </li><li>  As respostas n√£o s√£o encaminhadas.  O texto da resposta √© inserido em uma nova carta do distribuidor.  Por esse motivo, √†s vezes os arquivos anexados s√£o perdidos e n√£o chegam imediatamente. </li><li>  N√£o h√° uma clara certeza de que sua mensagem chegou ao fabricante inalterada. </li></ol><br><p>  Abaixo est√° uma tabela com o n√∫mero de letras que compunham a comunica√ß√£o com o suporte t√©cnico.  Basicamente, as perguntas para Evolis e Smart eram praticamente as mesmas.  Por exemplo, "Por que a impress√£o n√£o √© uma cor uniforme? Voc√™ tem exemplos de c√≥digo em C # ou Java?"  e perguntas mais espec√≠ficas sobre por que algo n√£o funciona conforme o esperado. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis </th><th>  Elyctis </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  N√∫mero de letras </td><td>  97 </td><td>  37. </td><td>  61 </td></tr></tbody></table></div><br>  Tabela 2 - Compara√ß√£o do n√∫mero de emails com suporte t√©cnico <br><h3 id="22-kodirovka">  2.2  Codifica√ß√£o </h3><br><p>  A comunica√ß√£o com o leitor ocorre atrav√©s de comandos APDU.  APDU (Application Protocol Data Unit) √© um formato padr√£o para comunica√ß√£o entre um cart√£o e um leitor.  Este artigo descreve as equipes b√°sicas da APDU para o MIFARE Classic e o MIFARE DESFire. </p><br><div class="scrollable-table"><table><thead><tr><th>  T√≠tulo </th><th>  Tamanho </th><th>  Descri√ß√£o do produto </th></tr></thead><tbody><tr><td>  CLA </td><td>  1 byte </td><td>  Bytes de classe </td></tr><tr><td>  Ins </td><td>  1 byte </td><td>  Byte de instru√ß√£o </td></tr><tr><td>  P1 </td><td>  1 byte </td><td>  Par√¢metro 1 </td></tr><tr><td>  P2 </td><td>  1 byte </td><td>  Par√¢metro 2 </td></tr><tr><td>  Comprimento dos dados </td><td>  1 byte </td><td>  Tamanho dos dados transmitidos </td></tr><tr><td>  Dados </td><td>  ... </td><td>  Dados transmitidos </td></tr><tr><td>  Comprimento esperado dos dados </td><td>  1 byte </td><td>  O tamanho dos dados esperados na resposta </td></tr></tbody></table></div><br>  Tabela 3 - Formato dos comandos do APDU <br><div class="scrollable-table"><table><thead><tr><th>  T√≠tulo </th><th>  Tamanho </th><th>  Descri√ß√£o do produto </th></tr></thead><tbody><tr><td>  SW1 </td><td>  1 byte </td><td>  C√≥digo comum de sucesso ou erro </td></tr><tr><td>  SW2 </td><td>  1 byte </td><td>  C√≥digo de erro detalhado </td></tr><tr><td>  Dados </td><td>  ... </td><td>  Retornar dados </td></tr></tbody></table></div><br>  Tabela 4 - Formato de resposta do APDU <br><p>  Uma descri√ß√£o de todos os c√≥digos de resposta poss√≠veis pode ser encontrada aqui [6].  Um dispositivo para comunicar cart√µes com um leitor pode ser encontrado em [7]. </p><br><p>  Um breve algoritmo de codifica√ß√£o √© o seguinte: </p><br><ol><li>  Obtenha o UID do cart√£o.  Este √© um n√∫mero √∫nico, √© exibido pelo fornecedor e n√£o √© alterado. </li><li>  Leia os dados de cada setor: <br>  2.1 Fa√ßa logon no setor usando a chave padr√£o (0x00 ou 0xFF) <br>  2.2 Ler dados de tr√™s blocos de dados </li><li>  Se os dados lidos estiverem vazios, v√° para o registro de dados <br>  3.1 Efetue login no setor usando a chave padr√£o (0x00 ou 0xFF) <br>  3.2 Gravar dados em tr√™s blocos de dados do setor <br>  3.3 Crie uma nova chave com base no UID do cart√£o <br>  3.4 Substitua a chave de autoriza√ß√£o no bloco de reboque por uma nova chave. </li></ol><br><h3 id="221-elyctis">  2.2.1  Elyctis </h3><br><p>  A impressora Evolis usa um <strong>leitor ELYCTIS CL</strong> .  Usando a biblioteca <strong>WinSCard</strong> (C ++ e C #) e jnasmartcardio (java), voc√™ pode interagir facilmente com o leitor.  Para criar rapidamente software com uma interface bastante simples, foi decidido escrever c√≥digo em <strong>C #</strong> .  Principalmente, nossa equipe escreve c√≥digo em Java, o que tornou a transi√ß√£o para o C # menos dolorosa.  Tamb√©m a favor do C # foi o fato de o Windows ser mais adequado para trabalhar com impressoras. </p><br><p>  A tabela abaixo mostra exemplos de comandos APDU nativos que s√£o aceitos pelo leitor Elyctis. </p><br><div class="scrollable-table"><table><thead><tr><th>  Descri√ß√£o do produto </th><th>  Dados </th><th>  APDU </th></tr></thead><tbody><tr><td>  Obtendo um cart√£o UID </td><td>  - </td><td>  <strong>0xFF 0xCA 0x00 0x00 0x00</strong> </td></tr><tr><td>  Carregando chave de autoriza√ß√£o na mem√≥ria do leitor </td><td>  Chave de 6 bytes </td><td>  Um exemplo de carregamento de uma chave padr√£o.  <strong>0xFF 0x82 0x20 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00</strong> </td></tr><tr><td>  Entrar </td><td>  N√∫mero do bloco de autoriza√ß√£o do setor (bloco do terceiro setor) e tipo de chave (A - 0x60 ou B - 0x61) </td><td>  Um exemplo de autoriza√ß√£o para o setor 1. Os n√∫meros de bloco desse setor s√£o 4-7, o bloco de reboque √© o n√∫mero 7. <strong>0xFF 0x86 0x00 0x00 0X05 0x01 0x00 0x07 0X60 0x00 0x00</strong> </td></tr><tr><td>  Lendo dados de um bloco </td><td>  - </td><td>  Um exemplo de leitura de dados do bloco 4 (1¬∫ bloco do setor 1).  O n√∫mero do setor √© inserido no par√¢metro 2. 0xFF 0xB0 0x00 0x04 0x00 0x10 </td></tr><tr><td>  Gravando dados no bloco </td><td>  16 bytes de dados </td><td>  Um exemplo de grava√ß√£o de dados no bloco 4. <strong>0xFF 0xD6 0x00 0x04 0x10 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x11 0x22 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x00</strong> </td></tr></tbody></table></div><br>  Tabela 5 - Exemplos de comandos APDU para o Mifare Classic <br><p>  Depois de garantir que a codifica√ß√£o de cart√µes como o Mifare Classic fosse bem-sucedida, mudamos para os <strong>comandos do DESFire</strong> .  Por refer√™ncia [8], voc√™ pode encontrar exemplos simples de comandos com explica√ß√µes.  No entanto, j√° na equipe de autoriza√ß√£o, encontramos um comportamento interessante do leitor.  Em suma, o leitor fez a pr√≥pria autoriza√ß√£o completa.  Verificou-se que o suporte t√©cnico da Elyctis nos forneceu um firmware especial que inclu√≠a a <em>intelig√™ncia easyDESFire</em> .  √â necess√°rio apenas determinar qual algoritmo de criptografia o leitor usa.  No nosso caso, foi o 3DES. </p><br><p>  Em casos normais, a autoriza√ß√£o √© realizada trocando v√°rias mensagens. </p><br><ol><li>  Enviamos o comando APDU para autoriza√ß√£o: <strong>0x90 0x0A 0x00 0x00 0x00 0x00</strong> . </li><li>  Dependendo do algoritmo, uma matriz de 8 bytes aleat√≥rios codificados pela chave do cart√£o vem em resposta ao comando, que √© <strong>designado</strong> por <strong>RandBEnc</strong> . </li><li>  <strong>Descriptografamos RandBEnc</strong> e fazemos um desvio de byte para a esquerda.  Indique o resultado por <strong>RandBLeft</strong> . </li><li>  <strong>Geramos do</strong> nosso lado uma matriz de 8 bytes aleat√≥rios, <strong>RandA</strong> . </li><li>  <strong>Agrupamos RandA</strong> e <strong>RandBLeft</strong> , criptografamos com a chave do cart√£o e enviamos a matriz resultante de 16 bytes. </li><li>  Recebemos a chave da sess√£o em resposta, efetuando login no aplicativo no mapa. </li></ol><br><p>  Mais detalhes sobre o processo de autoriza√ß√£o podem ser encontrados aqui [9].  O c√≥digo do github tamb√©m √© muito √∫til [10]. </p><br><p>  Durante a codifica√ß√£o, surgiram problemas com o uso de comandos da fonte [8].  Com a ajuda do suporte t√©cnico da Elyctis, recebemos os comandos necess√°rios para a <em>intelig√™ncia easyDESFire</em> . </p><br><p>  Durante a codifica√ß√£o em Elyctis, um grande <strong>problema do</strong> leitor foi revelado - <strong>atraso na comunica√ß√£o</strong> .  Muitas vezes, os sinais n√£o chegam ao leitor, portanto, o mesmo comando √†s vezes precisa ser enviado v√°rias vezes.  Esse comportamento √© menos comum, mas ainda √© percebido ao enviar comandos para impress√£o.  Como resultado, o envio de todos os comandos ocorre em um loop, at√© a execu√ß√£o bem-sucedida. </p><br><h3 id="222-duali">  2.2.2  DUALi </h3><br><p>  O fabricante fornece seu SDK para trabalhar com um codificador DUALi.  No est√°gio de trabalho com o Mifare Classic, os comandos de leitura e grava√ß√£o podem ser obtidos a partir do c√≥digo do modelo que os distribuidores nos deram.  Exemplos foram em C ++, Visual Basic, Java.  No entanto, foi poss√≠vel compilar completamente o c√≥digo apenas em C ++.  A primeira solicita√ß√£o de um exemplo de c√≥digo C #, fomos recusados, ou melhor, o distribuidor n√£o possui um.  N√£o h√° programadores C ++ confiantes em nossa equipe, portanto, escrever todo o c√≥digo foi muito complicado por coisas bastante simples.  Por exemplo: </p><br><ol><li>  Trabalhar com matrizes <br>  Ao passar um array como par√¢metro para uma fun√ß√£o, n√£o passamos o tamanho do array.  Para determinar o comprimento da matriz, a fun√ß√£o sizeOf () foi usada.  No entanto, a fun√ß√£o retornava constantemente um tamanho de 4, independentemente do tamanho real da matriz.  Esse comportamento n√£o foi registrado imediatamente, porque algumas matrizes eram realmente de tamanho 4. </li><li>  Configurar todas as bibliotecas <br>  Muita dor foi sentida ao instalar todo o ambiente necess√°rio.  Estamos muito acostumados a coisas como maven e apt (no Ubuntu).  Nosso programa deveria chamar a API de back-end por meio de solicita√ß√µes HTTP e criptografar os dados em Base64.  Para isso, foi decidido usar as bibliotecas libcurl e openssl.  A grava√ß√£o do pr√≥prio programa ocorreu no ambiente Microsoft Visual Studio.  O maior problema com a instala√ß√£o do libcurl. </li></ol><br><p>  O SDK em si √© uma biblioteca DLL escrita em C ++.  Gra√ßas ao exemplo de c√≥digo, escrevemos relativamente r√°pido um programa para interagir com o cart√£o Mifare Classic.  Como mencionado acima, os comandos APDU para o DUALi eram muito espec√≠ficos, ou seja, os dois primeiros bytes n√£o correspondiam aos que podem ser encontrados na Internet.  Por causa disso, tive que copi√°-los cegamente, porque, em princ√≠pio, tudo funciona como esperado.  Os problemas come√ßam com os testes com cart√µes DESFire. </p><br><p>  O princ√≠pio dos comandos APDU para <strong>DESFire</strong> no DUALi √© pelo menos compreens√≠vel.  Existem dois bytes para <strong>{CLA, INS}</strong> , eles n√£o mudam e, na verdade, eles dizem que o comando √© destinado a cart√µes como DESFire.  Os par√¢metros 1 e 2 tamb√©m n√£o s√£o alterados.  Os dados transmitidos j√° cont√™m parte do comando DESFire nativo, a saber, os bytes <strong>{INS, Data}</strong> .  Por cerca de uma semana, n√£o conseguimos obter as respostas esperadas para comandos simples, por exemplo, o comando "selecionar aplicativo".  No in√≠cio do c√≥digo, deixamos a execu√ß√£o de APDU do comando GetCardStatus, que n√£o era um formato de comando para o DESFire.  No entanto, ela trabalhou e emitiu cart√µes UID.  Como se viu, depois que a execu√ß√£o das equipes GetCardStatus DESFire parou de funcionar.  Essa omiss√£o foi determinada por nossas for√ßas, ap√≥s um di√°logo de uma semana com o fornecedor, que n√£o levou a nada. </p><br><p>  Ap√≥s um m√™s de opera√ß√£o est√°vel de nosso programa, chegamos √† necessidade de reescrever o programa em C #.  O principal motivo foi a cria√ß√£o do IC.  O programa C ++ foi compilado usando o Microsoft Visual Studio.  Todos os nossos servidores s√£o executados no Linux, portanto, n√£o foi poss√≠vel iniciar a janela de encaixe com o Windows e o Visual Studio ToolKit necess√°rio.  Claro, voc√™ pode criar uma m√°quina virtual com o Windows e ainda configurar tudo para C ++, mas eu realmente n√£o queria.  Depois de solicitar repetidamente um exemplo de c√≥digo C # do fabricante, fomos fornecidos com um exemplo.  Voc√™ mesmo pode escrever, com base nas defini√ß√µes de m√©todo no exemplo da interface C ++, mas descobriu-se que nem todas as fun√ß√µes foram descritas.  O exemplo ajudou muito e, no final, reescrevemos o programa em C # e configuramos o CI. </p><br><h3 id="23-pechat">  2.3  Impress√£o </h3><br><p>  √Ä primeira vista, parece que a impress√£o n√£o deve causar problemas, porque em primeiro lugar usamos impressoras.       ,    ,            . </p><br><p>       .       ,       ,   . </p><br><h3 id="231-pechat-na-evolis-primacy"> 2.3.1.   Evolis Primacy </h3><br><p>     JSON ,   HTTP .    Evolis Services Provider,          .      8 : </p><br><ol><li>      </li><li>   </li><li>   :  ,   ,  . . </li><li>    </li><li>     </li><li>    </li><li>   </li><li>    </li></ol><br><p>     -  4-6, . .               .      .         SDK,       .     . <br>      : </p><br><ol><li>   <br>       . </li><li>   <br>      . </li></ol><br><p>                    .          ,      .           .    ,   .          .         .      ,   ,         ,  3. </p><br><img src="https://habrastorage.org/webt/pa/4_/i8/pa4_i8xhdbhicczzxejgvzayzne.jpeg" alt="desenho" width="300"><br><p>  3 ‚Äî    </p><br><p>     3         . </p><br><p>             , . .    QR-.      ,        QR-  .     ,     ,  4  6 . </p><br><p>   , Evolis ,   Evolis Print Center,     ,    ,              .            . </p><br><h3 id="232-pechat-na-smart-51"> 2.3.2.   Smart-51 </h3><br><p>     ,     SmartID,     .      ,      Evolis.        : </p><br><ol><li>   ,        . </li><li>     ,     . </li></ol><br><p>          ,     .       Smart-51.   : </p><br><ol><li>      </li><li>    ,  . </li><li>   </li><li>   </li><li>    ,   QR- </li><li>   </li><li>   </li><li>    </li></ol><br><p>    ,     User Manuals .      ,         ,        . </p><br><h3 id="233-obschie-problemy-s-pechatyu"> 2.3.3.     </h3><br><p>    ,        .      ,      ,         .           .        .      ,    . </p><br><p>      Evolis Primacy    100 ,   0,76 .      ,  86 .   Smart-51    100 ,          .   ,      . </p><br><h3 id="3-rezultaty"> 3.  </h3><br><p>         .        .        .     17 .        . </p><br><div class="scrollable-table"><table><thead><tr><th>  </th><th>  ,  </th><th>  ,  </th><th>  Total </th></tr></thead><tbody><tr><td> Evolis Primacy </td><td> ‚âà 10 </td><td> ‚âà 10 </td><td> ‚âà 20 </td></tr><tr><td> Smart-51 </td><td> ‚âà 17 </td><td> ‚âà 6 </td><td> ‚âà 23 </td></tr></tbody></table></div><br><img src="https://habrastorage.org/webt/aa/tu/r2/aatur26peetmxaj2ynj4jxwxshm.jpeg" alt="desenho" width="400"><br><p> ) </p><br><img src="https://habrastorage.org/webt/ll/y1/ed/lly1edhu6n42rdbybxn4-gwvniu.jpeg" alt="desenho" width="400"><br><p> ) <br>  4 ‚Äî  :  ‚Äî  ,  ‚Äî   </p><br><h3 id="4-zaklyuchenie"> 4.  </h3><br><p>         NFC   -.      , ..      .   Smart-51   Evolis Primacy.    Evolis       ,     . Smart-51             .       Smart-51      Evolis.              ,   .  Evolis Primacy   ,     .      .  Smart-51    .   ,          . </p><br><p>       , ..         .              ,         . </p><br><h3 id="spisok-literatury">  Refer√™ncias </h3><br><ol><li> <a href="https://ironlogic.ru/il.nsf/htm/ru_z2usb">https://ironlogic.ru/il.nsf/htm/ru_z2usb</a> </li><li> <a href="https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K">https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/">https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/</a> </li><li> Advanced Card Systems Guide <a href="http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf">http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf</a> </li><li> Mifare Desfire communication example <a href="https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/">https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/</a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folha de dados Mifare DESFire </font></font><a href="http://neteril.org/files/M075031_desfire.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://neteril.org/files/M075031_desfire.pdf</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto GitHub para DESFire </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/EsupPortail/esup-nfc-tag-server/blob/master/src/main/java/nfcjlib/core/DESFireEV1.java</font></font></a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481734/">https://habr.com/ru/post/pt481734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481716/index.html">Programa√ß√£o reativa, vale a pena largar tudo e correr em dire√ß√£o ao sonho</a></li>
<li><a href="../pt481718/index.html">11 fatores e hacks que aumentam sua efic√°cia</a></li>
<li><a href="../pt481726/index.html">Laravel Roteamento localizado</a></li>
<li><a href="../pt481728/index.html">Pry -> REPL para Ruby, que vale a pena</a></li>
<li><a href="../pt481730/index.html">Ouviu MPow T6 - √≥timos fones de ouvido TWS com controles convenientes</a></li>
<li><a href="../pt481736/index.html">Em que construir a infraestrutura Wi-Fi 6?</a></li>
<li><a href="../pt481738/index.html">Tarefas de programa√ß√£o - uma maneira ruim de avaliar as qualifica√ß√µes de desenvolvedor s√™nior</a></li>
<li><a href="../pt481740/index.html">A luz azul perturba o biorritmo humano?</a></li>
<li><a href="../pt481742/index.html">Estrat√©gia da Apple. Vinculando o SO ao hardware - vantagem ou desvantagem competitiva?</a></li>
<li><a href="../pt481746/index.html">Configurando o ambiente na CLI. Terminal WSL / Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>