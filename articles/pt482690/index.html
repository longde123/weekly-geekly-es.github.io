<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö± üëáüèæ üÉè Crie seu editor em Combine üï¥Ô∏è ‚òùüèº ‚ÑπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje, gostaria de mostrar como criar seu pr√≥prio editor na nova estrutura Combine da Apple. 


 E, portanto, para iniciantes, precisamos lembrar breve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crie seu editor em Combine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482690/"><p><img src="https://habrastorage.org/webt/yu/vm/d7/yuvmd7t0eg1ws5pi_ahqklv9bba.png"></p><br><p>  Hoje, gostaria de mostrar como criar seu pr√≥prio editor na nova estrutura Combine da Apple. </p><a name="habracut"></a><br><p>  E, portanto, para iniciantes, precisamos lembrar brevemente como as partes fundamentais do Combine interagem entre si, ou seja, Publicador, Assinatura, Assinante. </p><br><ul><li>  O assinante ingressa no Publisher </li><li>  O editor envia o Assinante da Assinatura </li><li>  O assinante solicita N valores da assinatura </li><li>  O editor envia N valores ou menos </li><li>  O editor envia um sinal de conclus√£o </li></ul><br><h1 id="publisher">  Publisher </h1><br><p>  Ent√£o, vamos come√ßar a criar nosso Publicador.  Voltando √† documenta√ß√£o da Apple, veremos que o <a href="https://developer.apple.com/documentation/combine/publisher">Publisher</a> √© um protocolo. </p><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> : <span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> }</code> </pre> <br><p>  Onde Sa√≠da √© o tipo de valores transmitidos por este Publicador, Falha √© o tipo de erro que deve seguir o protocolo de Erro. </p><br><p>  E a fun√ß√£o de recebimento (_: Assinante), que ser√° chamada para adicionar Assinante a este Publicador usando a assinatura (_ :). </p><br><p>  Como exemplo, implementamos o Publisher, que ir√° gerar <a href="https://en.wikipedia.org/wiki/Fibonacci_number">n√∫meros de Fibonacci</a> para n√≥s. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> }</code> </pre> <br><p>  Como a sequ√™ncia consiste em n√∫meros, o tipo de sa√≠da ser√° Sa√≠da do tipo Int e Failure ser√° um tipo especial de Never, indicando que este Publicador nunca falhar√°. </p><br><p>  Para flexibilidade, especificamos o limite do n√∫mero de elementos que queremos receber e agrupamos esse valor em algum objeto de configura√ß√£o do nosso Publicador. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">UInt</span></span> }</code> </pre> <br><p>  Vamos dar uma olhada mais de perto neste c√≥digo, var count: UInt parece uma boa op√ß√£o, mas seu uso nos limita ao intervalo de valores v√°lidos do tipo UInt, e tamb√©m n√£o est√° claro o que indicar se ainda queremos ter uma sequ√™ncia ilimitada. </p><br><p>  Em vez do UInt, usaremos o tipo Subscribers.Demand, definido em Combine, onde tamb√©m √© descrito como o tipo enviado do Assinante para o Publisher atrav√©s da Assinatura.  Em termos simples, mostra a <em>necessidade</em> de elementos, quantos elementos s√£o solicitados pelo Assinante.  ilimitado - n√£o limitado, nenhum - nem um pouco, m√°ximo (N) - n√£o mais que N vezes. </p><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demand</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Codable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStringConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unlimited: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-comment"><span class="hljs-comment">///  Demand.max(0) @inlinable public static func max(_ value: Int) -&gt; Subscribers.Demand .... }</span></span></code> </pre> <br><p>  Reescrevemos FibonacciConfiguration alterando o tipo para um novo para contagem. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> }</code> </pre> <br><p>  Vamos voltar ao Publisher e implementar o m√©todo receive (_: Subscriber), como lembramos, esse m√©todo √© necess√°rio para adicionar o Subscriber ao Publisher.  E ele faz isso com uma assinatura, o Publisher deve criar uma assinatura e transferir a assinatura para o assinante. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) }</code> </pre> <br><p>  Essa √© uma fun√ß√£o gen√©rica que usa o Assinante como par√¢metro e os valores de sa√≠da do Publicador devem corresponder aos valores de entrada do Assinante (Sa√≠da == S.Input), o mesmo para erros.  Isso √© necess√°rio para "conectar" Publisher'a e Subscriber'a. </p><br><p>  Na pr√≥pria fun√ß√£o, crie uma assinatura FibonacciSubscription, no construtor transferimos o assinante e a configura√ß√£o.  Depois disso, a assinatura √© transferida para o assinante. </p><br><p>  Nosso editor est√° pronto, e no final temos: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } }</code> </pre> <br><p>  Como voc√™ pode ver, o pr√≥prio Publisher n√£o cont√©m nenhuma l√≥gica para gerar uma sequ√™ncia de Fibonacci; toda a l√≥gica estar√° na classe de assinatura - FibonacciSubscription. </p><br><p>  Como voc√™ j√° deve adivinhar, a classe FibonacciSubscription seguir√° o protocolo Subscription, vejamos a defini√ß√£o desse protocolo. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> }</code> </pre> <br><p>  A fun√ß√£o de solicita√ß√£o (_: Subscribers.Demand) informa ao Publisher que ele pode enviar mais valores ao assinante.  √â neste m√©todo que ser√° a l√≥gica do envio de n√∫meros de Fibonacci. <br>  Tamb√©m precisamos implementar seguindo o protocolo Cancellable e implementar a fun√ß√£o cancel (). </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p>  E basta seguir o protocolo CustomCombineIdentifierConvertible e definir a vari√°vel somente leitura combineIdentifier. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  H√° um esclarecimento aqui, se voc√™ rolar logo abaixo da defini√ß√£o do protocolo CustomCombineIdentifierConvertible no Combine, poder√° ver que o Combine fornece uma extens√£o para esse protocolo, que tem o formato - </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Self</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  O que nos diz que a defini√ß√£o da vari√°vel combineIdentifier: CombineIdentifier √© fornecida por padr√£o se o tipo que segue este protocolo tamb√©m seguir o protocolo AnyObject, ou seja, se esse tipo for uma classe.  FibonacciSubscription √© uma classe, ent√£o obtemos a defini√ß√£o de vari√°vel padr√£o. </p><br><h1 id="subscription">  Assinatura </h1><br><p>  E assim come√ßaremos a implementar nossa FibonacciSubscription. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } ... }</code> </pre> <br><p>  Como voc√™ pode ver, o FibonacciConfiguration cont√©m um forte v√≠nculo com o Assinante, em outras palavras, √© o propriet√°rio do Assinante.  <strong>Este √© um ponto importante, a assinatura √© respons√°vel pela reten√ß√£o do assinante e deve mant√™-la at√© que termine o trabalho, termine com um erro ou cancele.</strong> </p><br><p>  Em seguida, implementamos o m√©todo cancel () do protocolo Cancellable. </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Definir assinante como nulo torna inacess√≠vel a assinatura. </p><br><p>  Agora estamos prontos para come√ßar a implementa√ß√£o do envio de n√∫meros de Fibonacci. <br>  implementamos o m√©todo de solicita√ß√£o (_: Subscribers.Demand). </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  1) Desde o in√≠cio, verificamos quantos elementos o Publisher pode nos fornecer, se n√£o houver, em seguida, conclu√≠mos o envio e enviamos um sinal ao Assinante para concluir o envio dos n√∫meros. <br>  2) Se houver necessidade, reduza o n√∫mero total de n√∫meros solicitados em um, envie o primeiro elemento da sequ√™ncia de Fibonacci para o Assinante, ou seja, 0 e verifique novamente quantos outros elementos o Publisher pode nos fornecer, caso contr√°rio, envie um sinal ao Assinante para concluir . <br>  3) A mesma abordagem que no 2) par√°grafo, mas apenas para o segundo elemento na sequ√™ncia de Fibonacci. <br>  4) Se forem necess√°rios mais de 2 elementos, implementamos um algoritmo iterativo para encontrar n√∫meros de Fibonacci, onde a cada passo transferiremos o pr√≥ximo n√∫mero da sequ√™ncia de Fibonacci para o Assinante e tamb√©m verificaremos quantos elementos o Publisher ainda pode fornecer.  Se o Publisher n√£o fornecer mais novos n√∫meros, envie ao Assinante um sinal de conclus√£o. </p><br><div class="spoiler">  <b class="spoiler_title">No momento, escrevemos esse c√≥digo</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } } }</span></span></code> </pre> </div></div><br><h3 id="pervoe-testirovanie">  Primeiro teste </h3><br><p>  Agora vamos testar o que temos, temos nosso editor e assinatura, n√£o temos Sibscriber suficiente, a Combine fornece 2 Sibscriber da caixa: afundar e atribuir. </p><br><ul><li>  coletor - esse m√©todo cria um assinante e solicita imediatamente <strong>um</strong> n√∫mero <strong>ilimitado</strong> de valores. </li><li>  atribuir - define cada elemento do Publisher para uma propriedade de objeto. </li></ul><br><p>  pia √© adequada para o nosso prop√≥sito, aten√ß√£o especial deve ser dada ao fato de solicitar um n√∫mero ilimitado de valores. </p><br><p>  E aqui precisamos fazer uma distin√ß√£o importante, nosso Publicador na vari√°vel count determina o n√∫mero de elementos que nosso Publicador pode fornecer e essas condi√ß√µes s√£o determinadas por n√≥s mesmos.  Em princ√≠pio, poder√≠amos ficar sem essa vari√°vel e n√£o estarmos limitados na transmiss√£o de n√∫meros de Fibonacci, mas logo ir√≠amos al√©m da faixa de valores admiss√≠veis do tipo Int. <br>  O caso com coletor √© diferente, cada Assinante determina quantos valores deseja receber, coletor solicita um n√∫mero ilimitado de valores, o que significa que receber√° valores at√© receber um sinal de conclus√£o, erro ou cancelamento. </p><br><p>  Para a conveni√™ncia de usar nosso Publicador, adicionamos sua cria√ß√£o √† extens√£o de protocolo do Publicador. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publishers</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration: FibonacciConfiguration)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: configuration) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">count</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Subscribers.Demand = .</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">max</span></span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>)) } }</code> </pre> <br><p>  E ent√£o experimente nosso editor </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// print 0 1 1 2 3 5 8 13 21 34 - OK</span></span></code> </pre> <br><p>  E agora os casos de fronteira </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prinst 0 - OK Publishers.fibonacci(count: .max(2)) .sink { value in print(value, terminator: " ") } // prints 0 1 - OK Publishers.fibonacci(count: .none) .print() //    publisher'a .sink { value in print(value, terminator: " ") } // prints receive finished - OK</span></span></code> </pre> <br><p>  Mas o que acontece se voc√™ especificar .unlimited? </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 5 8 13 21 ...   ,     Int.</span></span></code> </pre> <br><p>  Como voc√™ pode usar .unlimited, mas conseguir gerar v√°rios n√∫meros?  Para fazer isso, precisamos do operador .prefix (_), que funciona da mesma maneira que o .prefix (_) das cole√ß√µes, ou seja, ele deixa apenas os primeiros N elementos. </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel   ,       Int.</span></span></code> </pre> <br><p>  Qual √© o problema?  Talvez em .prefix (_)?  Vamos fazer um pequeno experimento na sequ√™ncia padr√£o da Foundation. </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">//   1 2 3 4 5 6 7 8 ... 1... .publisher .print() .prefix(5) .sink { _ in } // prints 1 2 3 4 5 cancel - </span></span></code> </pre> <br><p>  Como podemos ver, o c√≥digo acima funcionou corretamente e o problema est√° em nossa implementa√ß√£o do Publisher. <br>  Observamos os logs de .print () e vemos que, depois de N solicita√ß√µes, de .prefix (_), chamamos cancel () em nossa FibonacciSubscription, onde definimos o assinante como nulo. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Se voc√™ abrir a pilha de chamadas, poder√° ver que cancel () √© chamado a partir da solicita√ß√£o (_ :), ou seja, durante a chamada para o assinante? .Receber (_).  A partir do qual podemos concluir que em algum momento da solicita√ß√£o (_ :) o assinante pode se tornar nulo e, em seguida, precisamos interromper o trabalho de gerar novos n√∫meros.  Adicione esta condi√ß√£o ao nosso c√≥digo. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber { // new temp = prev prev = current current += temp subscriber.receive(current) count -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  Agora execute nosso c√≥digo de teste. </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel - </span></span></code> </pre> <br><p>  Tem o comportamento esperado. </p><br><h1 id="subscriber">  Assinante </h1><br><p>  E assim est√° pronta a nossa assinatura Fibonacci?  Na verdade, em nossos testes, usamos apenas um assinante de coletor que solicita um n√∫mero ilimitado de n√∫meros, mas e se usarmos um assinante que esperar√° um determinado n√∫mero limitado de n√∫meros.  A Combine n√£o fornece esse assinante, mas o que nos impede de escrever nossos pr√≥prios?  Abaixo est√° a implementa√ß√£o do nosso FibonacciSubscriber. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscriber</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Input</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.limit = limit } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscription: Subscription)</span></span></span></span> { subscription.request(limit) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input: Input)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> { .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscriber's completion: \(completion)"</span></span>) } }</code> </pre> <br><p>  Portanto, nosso FibonacciSubscriber possui uma propriedade limit, que determina quantos elementos esse Assinante deseja receber.  E isso √© feito no m√©todo receive (_: Subscription), onde dizemos √† assinatura quantos elementos precisamos.  Tamb√©m √© importante notar a fun√ß√£o Receive (_: Input) -&gt; Subscribers.Demand, essa fun√ß√£o √© chamada quando um novo valor √© recebido, como o valor de retorno, indicamos quantos elementos adicionais queremos receber: .none - de jeito nenhum, .max (N) N pieces , no total, o n√∫mero total de elementos recebidos ser√° igual √† soma do valor da assinatura enviada em Receive (_: Subscription) e todos os valores de retorno de Receive (_: Input) -&gt; Subscribers.Demand. </p><br><h3 id="vtoroe-testirovanie">  Segundo teste </h3><br><p>  Vamos tentar usar o FibonacciSubscriber. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 -     0 1 1</span></span></code> </pre> <br><p>  Como vemos, nosso editor enviou 5 valores, em vez de 3. Por que?  Como o m√©todo request (_: Subscribers.Demand) de FibonacciSubscription'a n√£o leva em considera√ß√£o as necessidades do assinante, vamos corrigi-lo. Para isso, adicionaremos uma propriedade adicional solicitada, atrav√©s da qual rastrearemos as necessidades do assinante. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requested: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> = .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-comment"><span class="hljs-comment">// new init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand // new count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(0) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(1) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { // new temp = prev prev = current current += temp requested += subscriber.receive(current) // new count -= .max(1) requested -= .max(1) // new if count == .none { subscriber.receive(completion: .finished) return } } } }</span></span></code> </pre> <br><h3 id="trete-testirovanie">  Terceiro teste </h3><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 - OK</span></span></code> </pre> <br><p>  O Publisher agora est√° funcionando corretamente. </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo final</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Combine struct FibonacciConfiguration { var count: Subscribers.Demand } struct FibonacciPublisher: Publisher { typealias Output = Int typealias Failure = Never var configuration: FibonacciConfiguration func receive&lt;S&gt;(subscriber: S) where S : Subscriber, Failure == S.Failure, Output == S.Input { let subscription = FibonacciSubscription(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } private final class FibonacciSubscription&lt;S: Subscriber&gt;: Subscription where S.Input == Int { var subscriber: S? var configuration: FibonacciConfiguration var count: Subscribers.Demand var requested: Subscribers.Demand = .none init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand count -= .max(1) requested -= .max(1) requested += subscriber?.receive(0) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) requested += subscriber?.receive(1) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { temp = prev prev = current current += temp requested += subscriber.receive(current) count -= .max(1) requested -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } } } extension Publishers { private static func fibonacci(configuration: FibonacciConfiguration) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: configuration) } static func fibonacci(count: Subscribers.Demand = .max(6)) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: FibonacciConfiguration(count: count)) } } class FibonacciSubscriber: Subscriber { typealias Input = Int typealias Failure = Never var limit: Subscribers.Demand init(limit: Subscribers.Demand) { self.limit = limit } func receive(subscription: Subscription) { subscription.request(limit) } func receive(_ input: Input) -&gt; Subscribers.Demand { .none } func receive(completion: Subscribers.Completion&lt;Failure&gt;) { print("Subscriber's completion: \(completion)") } } Publishers.fibonacci(count: .max(4)) .print() .sink { _ in } let subscriber = FibonacciSubscriber(limit: .max(3)) Publishers.fibonacci(count: .max(5)) .print() .subscribe(subscriber)</code> </pre></div></div><br><h1 id="rezultat">  Resultado </h1><br><p>  Espero que este artigo tenha lhe proporcionado uma melhor compreens√£o do que s√£o Publisher, Subscription e Subscriber, como eles interagem entre si e em quais pontos voc√™ precisa prestar aten√ß√£o ao decidir implementar o Publisher.  Quaisquer coment√°rios, esclarecimentos ao artigo s√£o bem-vindos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482690/">https://habr.com/ru/post/pt482690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482676/index.html">Classifica√ß√£o eficaz dos dados do tipo Struct</a></li>
<li><a href="../pt482678/index.html">Como eu decidi fazer uma busca de texto para iOS e o que veio dela</a></li>
<li><a href="../pt482680/index.html">Crypt, XOR, hackers ZIP e PRSP n√£o criptografados. Solu√ß√£o de problemas com o r0ot-mi Crypto. Parte 2</a></li>
<li><a href="../pt482684/index.html">Criei meu pr√≥prio dipfake em duas semanas e US $ 552</a></li>
<li><a href="../pt482686/index.html">Cientistas automatizam pesquisa de comportamento animal para decodificar a fun√ß√£o cerebral</a></li>
<li><a href="../pt482698/index.html">[Ensaio] Dedicado ao pl√¢ncton do Office. Eu n√£o sou inspirado pelo meu trabalho</a></li>
<li><a href="../pt482700/index.html">Como "foder" o Google e o Yandex: promo√ß√£o de sites em preto e branco de SEO. Shestakov Pessoas PRO # 74</a></li>
<li><a href="../pt482702/index.html">Realmente precisamos do TypeScript em 2020?</a></li>
<li><a href="../pt482704/index.html">Sincroniza√ß√£o de cache Redis para o servi√ßo Go</a></li>
<li><a href="../pt482706/index.html">Recomenda√ß√µes para a implementa√ß√£o do RAS cont√°bil paralelo + IFRS na plataforma 1C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>