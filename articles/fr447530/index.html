<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õîÔ∏è üë¶üèæ ‚ùå OceanLotus: mise √† jour Malvari pour macOS üëºüèø üë®üèº‚Äçüç≥ üåç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En mars 2019, VirusTotal, un service d'analyse en ligne populaire, a t√©l√©charg√© un nouvel exemple de malware pour macOS du cybergroupe OceanLotus. Le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: mise √† jour Malvari pour macOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/447530/"> En mars 2019, VirusTotal, un service d'analyse en ligne populaire, a t√©l√©charg√© un nouvel exemple de malware pour macOS du cybergroupe OceanLotus.  Le fichier ex√©cutable de porte d√©rob√©e a les m√™mes capacit√©s que la version pr√©c√©dente de malvari pour macOS que nous avons √©tudi√©e, mais sa structure a chang√© et il est devenu plus difficile √† d√©tecter.  Malheureusement, nous n'avons pas pu trouver le compte-gouttes associ√© √† cet √©chantillon, nous ne connaissons donc pas encore le vecteur d'infection. <br><br>  R√©cemment, nous avons publi√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article sur OceanLotus</a> et comment les op√©rateurs tentent d'assurer la persistance, d'acc√©l√©rer l'ex√©cution du code et de minimiser les traces de pr√©sence sur les syst√®mes Windows.  Il est √©galement connu que ce cyber-groupe a un composant pour macOS.  Cet article d√©crit en d√©tail les changements dans la derni√®re version de Malware pour macOS par rapport √† la version pr√©c√©dente ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©crite par Trend Micro</a> ), ainsi que la fa√ßon dont l'analyse peut automatiser le d√©chiffrement des cha√Ænes √† l'aide de l'API IDA Hex-Rays. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b9/2i/bc/b92ibc95cbufdprulqgxtcrrh2q.jpeg"></div><a name="habracut"></a><br><h2>  Analyse </h2><br>  Les trois parties suivantes d√©crivent l'analyse d'√©chantillons avec le hachage SHA-1 <code>E615632C9998E4D3E5ACD8851864ED09B02C77D2</code> .  Le fichier est appel√© <b>flashlightd</b> , les produits antivirus ESET le d√©tectent comme OSX / OceanLotus.D. <br><br><h4>  Protection anti-d√©bogage et sandbox </h4><br>  Comme tous les binaires macOS d'OceanLotus, l'exemple est fourni avec UPX, mais la plupart des outils d'identification de packer ne le reconnaissent pas comme tel.  Probablement parce qu'elles contiennent principalement une signature, selon la pr√©sence de la cha√Æne ¬´UPX¬ª, de plus, les signatures Mach-O sont moins courantes et ne sont pas mises √† jour aussi souvent.  Cette fonction rend la d√©tection statique difficile.  Fait int√©ressant, apr√®s le d√©ballage, le point d'entr√©e se trouve au d√©but de la section <code>__cfstring</code> dans le segment <code>.TEXT</code> .  Il existe des attributs d'indicateur dans cette section, comme indiqu√© dans l'image ci-dessous. <br><br><img src="https://habrastorage.org/webt/9f/-e/nv/9f-envxqfnhv8qxtp-gjeitht1q.png"><br>  <i>Figure 1. Attributs de la section MACH-O __cfstring</i> <br><br>  Comme le montre la figure 2, l'emplacement du code dans la section <code>__cfstring</code> permet de tromper certains outils de d√©montage en affichant le code sous forme de cha√Ænes. <br><br><img src="https://habrastorage.org/webt/qw/q0/s3/qwq0s3-lc2tj86cb3wtcx91y8d0.png"><br>  <i>Figure 2. Le code de porte d√©rob√©e est d√©fini par l'IDA comme des donn√©es</i> <br><br>  Apr√®s le d√©marrage du fichier binaire cr√©e un flux comme moyen de protection contre le d√©bogage, dont le seul but est de v√©rifier en permanence la pr√©sence d'un d√©bogueur.  Pour ce fil: <br><br><ul><li>  Tente de d√©crocher tout d√©bogueur en appelant <code>ptrace</code> avec <code>PT_DENY_ATTACH</code> comme param√®tre de requ√™te </li><li>  V√©rifie si certains ports d'exception sont ouverts en appelant <code>task_get_exception_ports</code> </li><li>  V√©rifie si le d√©bogueur est connect√©, comme illustr√© dans la figure ci-dessous, en v√©rifiant la pr√©sence de l'indicateur <code>P_TRACED</code> dans le processus en cours </li></ul><br><img src="https://habrastorage.org/webt/hi/cz/hd/hiczhdrsr9kgk9kkhfr72fv_xsg.png"><br>  <i>Figure 3. V√©rification de la connexion du d√©bogueur √† l'aide de la fonction sysctl</i> <br><br>  Si le chien de garde d√©tecte la pr√©sence d'un d√©bogueur, la fonction de <code>exit</code> est appel√©e.  En outre, l'exemple v√©rifie ensuite l'environnement en ex√©cutant deux commandes: <br><br> <code>ioreg -l | grep -e "Manufacturer"  sysctl hw.model</code> <br> <br>  Apr√®s cela, l'exemple v√©rifie la valeur de retour par rapport √† une liste cod√©e en dur de cha√Ænes de syst√®mes de virtualisation connus: <b>acle</b> , <b>vmware</b> , <b>virtualbox</b> ou <b>parallels</b> .  Enfin, la commande suivante v√©rifie si la machine fait partie des ¬´MBP¬ª, ¬´MBA¬ª, ¬´MB¬ª, ¬´MM¬ª, ¬´IM¬ª, ¬´MP¬ª et ¬´XS¬ª.  Ce sont des codes de mod√®le de syst√®me, par exemple, "MBP" signifie MacBook Pro, "MBA" signifie MacBook Air, etc. <br><br> <code>system_profiler SPHardwareDataType 2&gt;/dev/null | awk '/Boot ROM Version/ {split($0, line, ":");printf("%s", line[2]);}</code> <br> <br><h4>  Ajouts cl√©s </h4><br>  Malgr√© le fait que les √©quipes de portes d√©rob√©es n'ont pas chang√© depuis l'√©tude Trend Micro, nous avons remarqu√© plusieurs autres modifications.  Les serveurs C&amp;C utilis√©s dans cet exemple sont assez r√©cents, la date de leur cr√©ation est le 22/10/2018. <br><br><ul><li>  <b>daff.faybilodeau [.] com</b> </li><li>  <b>sarc.onteagleroad [.] com</b> </li><li>  <b>au.charlineopkesston [.] com</b> </li></ul><br>  L'URL de la ressource a √©t√© remplac√©e par <code>/dp/B074WC4NHW/ref=gbps_img_m-9_62c3_750e6b35</code> . <br>  Le premier paquet envoy√© au serveur C&amp;C contient plus d'informations sur la machine h√¥te, y compris toutes les donn√©es collect√©es par les commandes du tableau ci-dessous. <br><br><img src="https://habrastorage.org/webt/xb/9k/xo/xb9kxohiu-1pdfbxnxbcrmnewqq.png"><br><br>  Outre cette modification de configuration, l'exemple n'utilise pas la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">libcurl</a> pour le filtrage r√©seau, mais une biblioth√®que externe.  Pour le trouver, la porte d√©rob√©e essaie de d√©crypter chaque fichier du r√©pertoire en cours en utilisant AES-256-CBC avec la cl√© <code>gFjMXBgyXWULmVVVzyxy</code> de z√©ros.  Chaque fichier est d√©crypt√© et enregistr√© sous <code>/tmp/store</code> , et une tentative de chargement en tant que biblioth√®que a √©t√© effectu√©e √† l'aide de la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dlopen</a> .  Lorsqu'une tentative de d√©chiffrement aboutit √† un appel <code>dlopen</code> r√©ussi, la porte d√©rob√©e r√©cup√®re les <code>ChadylonV</code> <code>Boriry</code> et <code>ChadylonV</code> export√©es, qui semblent √™tre responsables de la communication r√©seau avec le serveur.  Nous n'avons pas de compte-gouttes ni d'autres fichiers de l'emplacement source de l'√©chantillon, nous ne pouvons donc pas analyser cette biblioth√®que.  De plus, puisque le composant est crypt√©, la r√®gle YARA bas√©e sur ces lignes ne correspondra pas au fichier trouv√© sur le disque. <br><br>  Comme d√©crit dans l'article ci-dessus, <i>cliendID</i> est cr√©√©.  Cet identifiant est un hachage MD5 de la valeur de retour de l'une des commandes suivantes: <br><br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformSerialNumber/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <code>ioreg -rd1 -c IOPlatformExpertDevice | awk '/IOPlatformUUID/ { split($0, line, "\""); printf("%s", line[4]); }'</code> <br>  - <code>ifconfig en0 | awk \'/ether /{print $2}\'</code>  <code>ifconfig en0 | awk \'/ether /{print $2}\'</code> (obtenir l'adresse MAC) <br>  - commande inconnue (" <code>\x1e\x72\x0a</code> "), utilis√©e dans les exemples pr√©c√©dents <br><br>  Avant le hachage, le caract√®re "0" ou "1" est ajout√© √† la valeur renvoy√©e, indiquant la pr√©sence de privil√®ges root.  Cet <i>ID client</i> est stock√© dans <code>/Library/Storage/File System/HFS/25cf5d02-e50b-4288-870a-528d56c3cf6e/pivtoken.appex</code> si le code s'ex√©cute en tant que root ou dans ~ / Library / SmartCardsServices / Technology / PlugIns / drivers / snippets.ecgML dans tous les autres cas.  Un fichier est g√©n√©ralement masqu√© √† l'aide de la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">_chflags</a> , son horodatage est modifi√© √† l'aide de la commande <code>touch ‚Äìt</code> avec une valeur al√©atoire. <br><br><h4>  D√©codage des cha√Ænes </h4><br>  Comme dans les versions pr√©c√©dentes, les cha√Ænes sont chiffr√©es √† l'aide de AES-256-CBC (cl√© hexad√©cimale: <code>9D7274AD7BCEF0DED29BDBB428C251DF8B350B92</code> de z√©ros et IV est rempli de z√©ros) √† l'aide de la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CCCrypt</a> .  La cl√© a √©t√© modifi√©e par rapport aux versions pr√©c√©dentes, mais comme le groupe utilise toujours le m√™me algorithme de chiffrement de cha√Æne, le d√©chiffrement peut √™tre automatis√©.  En plus de cet article, nous publions un script IDA qui utilise l'API Hex-Rays pour d√©crypter les cha√Ænes pr√©sentes dans un fichier binaire.  Ce script peut aider √† l'analyse future d'OceanLotus et √† l'analyse d'√©chantillons existants que nous n'avons pas encore pu obtenir.  Le script est bas√© sur une m√©thode universelle pour recevoir des arguments pass√©s √† une fonction.  Il recherche √©galement des param√®tres de destination.  La m√©thode peut √™tre r√©utilis√©e pour obtenir une liste d'arguments de fonction, puis la transmettre √† un rappel. <br><br>  Connaissant le prototype de la fonction de <i>d√©cryptage</i> , le script trouve toutes les r√©f√©rences crois√©es √† cette fonction, tous les arguments, puis d√©crypte les donn√©es et place du texte brut √† l'int√©rieur du commentaire √† l'adresse de la r√©f√©rence crois√©e.  Pour que le script fonctionne correctement, il doit avoir l'alphabet d√©fini par l'utilisateur utilis√© par la fonction de d√©codage base64 et une variable globale contenant la longueur de cl√© doit √™tre d√©finie (dans ce cas, DWORD, voir figure 4). <br><br><img src="https://habrastorage.org/webt/eh/24/ci/eh24cifpohyeyx3jvtsyodn6v8s.png"><br>  <i>Figure 4. D√©finition de la variable globale key_len</i> <br><br>  Dans la fen√™tre Fonction, vous pouvez cliquer avec le bouton droit sur la fonction de d√©chiffrement et cliquer sur "Extraire et d√©chiffrer les arguments".  Le script doit mettre les lignes d√©chiffr√©es dans les commentaires, comme le montre la figure 5. <br><br><img src="https://habrastorage.org/webt/sy/or/e5/syore5rq9pnlbtdp_f4l4bq0aoe.png"><br>  <i>Figure 5. Le texte d√©chiffr√© est plac√© dans le commentaire</i> <br><br>  Ainsi, les lignes d√©chiffr√©es sont commod√©ment plac√©es ensemble dans la fen√™tre des <i>xr√©fs</i> IDA pour cette fonction, comme le montre la figure 6. <br><br><img src="https://habrastorage.org/webt/sl/v8/ok/slv8okoh1m44vxl1wpcv8hxqleo.png"><br>  <i>Figure 6. Xr√©fs √† la fonction f_decrypt</i> <br><br>  Le script final peut √™tre trouv√© sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©p√¥t Github</a> . <br><br><h2>  Conclusion </h2><br>  Comme d√©j√† mentionn√©, OceanLotus am√©liore et met constamment √† jour son ensemble d'outils.  Cette fois, le cyber-groupe a am√©lior√© les logiciels malveillants pour travailler avec les utilisateurs de Mac.  Le code n'a pas beaucoup chang√©, mais comme de nombreux utilisateurs de Mac ignorent les produits de s√©curit√©, la protection des logiciels malveillants contre la d√©tection est d'une importance secondaire. <br><br>  Les produits ESET avaient d√©j√† d√©tect√© ce fichier au moment de l'√©tude.  √âtant donn√© que la biblioth√®que r√©seau utilis√©e pour la communication C&amp;C est d√©sormais chiffr√©e sur le disque, le protocole r√©seau exact utilis√© par les attaquants n'est pas encore connu. <br><br><h2>  Indicateurs de compromis </h2><br>  Les indicateurs de compromis ainsi que les attributs MITRE ATT &amp; CK sont √©galement disponibles sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447530/">https://habr.com/ru/post/fr447530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447516/index.html">Comment nous avons overclock√© CAD COMPASS-3D ‚Üí Partie 2</a></li>
<li><a href="../fr447520/index.html">Fonctionnalit√©s de hi√©rarchisation automatique dans le stockage Qsan XCubeSAN</a></li>
<li><a href="../fr447522/index.html">Quelles choses utiles peuvent √™tre extraites des journaux d'un poste de travail Windows</a></li>
<li><a href="../fr447526/index.html">Propre v√©lo pour synchroniser MariaDB et Sphinx</a></li>
<li><a href="../fr447528/index.html">Qui est responsable de la qualit√©?</a></li>
<li><a href="../fr447532/index.html">Splunk Universal Forwarder dans le Docker en tant que rassembleur de journaux syst√®me</a></li>
<li><a href="../fr447534/index.html">Le cosmonaute Aleksandr Laveykin sur le meilleur film spatial, la force G de 20g et l'atterrissage en douceur</a></li>
<li><a href="../fr447536/index.html">Impl√©mentez IdM. Pr√©paration √† la mise en ≈ìuvre par le client</a></li>
<li><a href="../fr447538/index.html">CUBA 7: quoi de neuf?</a></li>
<li><a href="../fr447540/index.html">Atelier RHEL 8 Beta: Cr√©ation d'applications Web en direct</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>