<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФо ЁЯзСЁЯП┐тАНЁЯдЭтАНЁЯзСЁЯП╛ ЁЯСйЁЯП╗тАНЁЯдЭтАНЁЯСиЁЯП╝ рдХреИрд╕реЗ рд╣рдо Nginx рдФрд░ рджреБрдирд┐рдпрд╛ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ 54 рд╣рд░ рджрд┐рди рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИ ЁЯСХ ЁЯЫНя╕П тЬКЁЯП╗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="тАЬ@Cloudflare рдЯреАрдо рдиреЗ рдЕрднреА-рдЕрднреА рдкрд░рд┐рд╡рд░реНрддрди рдХрд┐рдП рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ рд╣рдорд╛рд░реЗ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдХрд╛рдлреА рд╕реБрдзрд╛рд░ рд╣реБрдЖ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕рдмрд╕реЗ рдзреАрдореА рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдПред рдХрд┐рддрдирд╛ рддреЗрдЬ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдХреИрд╕реЗ рд╣рдо Nginx рдФрд░ рджреБрдирд┐рдпрд╛ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ 54 рд╣рд░ рджрд┐рди рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419023/">  <i>тАЬ@Cloudflare рдЯреАрдо рдиреЗ рдЕрднреА-рдЕрднреА рдкрд░рд┐рд╡рд░реНрддрди рдХрд┐рдП рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ рд╣рдорд╛рд░реЗ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдХрд╛рдлреА рд╕реБрдзрд╛рд░ рд╣реБрдЖ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕рдмрд╕реЗ рдзреАрдореА рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдПред</i>  <i>рдХрд┐рддрдирд╛ рддреЗрдЬ рд╣реИ?</i>  <i>рд╣рдо рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо <b>рдкреНрд░рддрд┐ рджрд┐рди</b> рд▓рдЧрднрдЧ 54 рд╡рд░реНрд╖реЛрдВ рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░рдиреЗрдЯ рдХреА рдмрдЪрдд рдХрд░ рд░рд╣реЗ <b>рд╣реИрдВ</b> рдЬреЛ рдЕрдиреНрдпрдерд╛ рд╕рд╛рдЗрдЯреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣реЗ рд╣реИрдВ</i> ред <i>тАЭ</i>  - рдореИрдереНрдпреВ рдкреНрд░рд┐рдВрд╕ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЯреНрд╡реАрдЯ</a> , 28 рдЬреВрди 2018 <br><br>  10 рдорд┐рд▓рд┐рдпрди рд╕рд╛рдЗрдЯ, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдПрдкреАрдЖрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдордЧреНрд░реА рдбрд╛рдЙрдирд▓реЛрдб рдХреЛ рдЧрддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЙрдбрдлреЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред  рдЪрд░рдо рдкрд░, рд╣рдо 151 рдбреЗрдЯрд╛ рдХреЗрдВрджреНрд░реЛрдВ рдореЗрдВ рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб 10 рдорд┐рд▓рд┐рдпрди рд╕реЗ рдЕрдзрд┐рдХ рдЕрдиреБрд░реЛрдз рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдкрд┐рдЫрд▓реЗ рдХреБрдЫ рд╡рд░реНрд╖реЛрдВ рдореЗрдВ, рд╣рдордиреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд╕рд╛рде рд╕рд╛рдордирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Nginx рдХреЗ рдЕрдкрдиреЗ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдХрдИ рдмрджрд▓рд╛рд╡ рдХрд┐рдП рд╣реИрдВред  рдпрд╣ рд▓реЗрдЦ рдЗрди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИред <br><a name="habracut"></a><br><h1>  рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ </h1><br>  Nginx рдЙрди рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреЛ C10K рд╕рдорд╕реНрдпрд╛</a> рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рд▓реВрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИ</a> ред  рдЬрдм рднреА рдХреЛрдИ рдиреЗрдЯрд╡рд░реНрдХ рдИрд╡реЗрдВрдЯ рдЖрддрд╛ рд╣реИ (рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдХрдиреЗрдХреНрд╢рди, рдЕрдиреБрд░реЛрдз рдпрд╛ рдЕрдзрд┐рд╕реВрдЪрдирд╛), рдирдЧреНрдиреЗрдХреНрд╕ рдЙрдарддрд╛ рд╣реИ, рдИрд╡реЗрдВрдЯ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рджреВрд╕рд░реА рдиреМрдХрд░реА рдкрд░ рд▓реМрдЯрддрд╛ рд╣реИ (рдпрд╣ рдЕрдиреНрдп рдИрд╡реЗрдВрдЯ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ)ред  рдЬрдм рдХреЛрдИ рдШрдЯрдирд╛ рдЖрддреА рд╣реИ, рддреЛ рдЗрд╕рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рддреИрдпрд╛рд░ рд╣реИ, рдЬреЛ рдЖрдкрдХреЛ рдбрд╛рдЙрдирдЯрд╛рдЗрдо рдХреЗ рдмрд┐рдирд╛ рдПрдХ рд╕рд╛рде рдХрдИ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдХреБрд╢рд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред <br><br><pre><code class="hljs pgsql">num_events = epoll_wait(epfd, <span class="hljs-comment"><span class="hljs-comment">/*returned=*/</span></span>events, events_len, <span class="hljs-comment"><span class="hljs-comment">/*timeout=*/</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>); // events <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> active events // handle event[<span class="hljs-number"><span class="hljs-number">0</span></span>]: incoming request <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> http://example.com/ // handle event[<span class="hljs-number"><span class="hljs-number">1</span></span>]: send <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> response <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> http://cloudflare.com/</code> </pre> <br>  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╣рд╛рдБ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛрдб рд╕реЗ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдХрд╛ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдХреИрд╕рд╛ рджрд┐рдЦ рд╕рдХрддрд╛ рд╣реИ: <br><br><pre> <code class="hljs pgsql">// we got a <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> fd <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (buf_len &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { ssize_t n = <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(fd, buf, buf_len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errno == EWOULDBLOCK || errno == EAGAIN) { // try later <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> we <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> event again } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errno == EINTR) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> total; } buf_len -= n; buf += n; total += n; }</code> </pre> <br>  рдпрджрд┐ fd рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЙрдХреЗрдЯ рд╣реИ, рддреЛ рдкрд╣рд▓реЗ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдмрд╛рдЗрдЯреНрд╕ рд╡рд╛рдкрд╕ рдЖ рдЬрд╛рдПрдВрдЧреЗред  рдЖрдЦрд┐рд░реА рдХреЙрд▓ <code>EWOULDBLOCK</code> ред  рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╕реНрдерд╛рдиреАрдп рд░реАрдб рдмрдлрд░ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕ рд╕реЙрдХреЗрдЯ рд╕реЗ рдбреЗрдЯрд╛ рдкрдврд╝рдиреЗ рддрдХ рджрд┐рдЦрд╛рдИ рдирд╣реАрдВ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br><h1>  рдбрд┐рд╕реНрдХ I / O рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдЕрд▓рдЧ рд╣реИ </h1><br>  рдпрджрд┐ fd рд▓рд┐рдирдХреНрд╕ рдкрд░ рдПрдХ рдирд┐рдпрдорд┐рдд рдлрд╝рд╛рдЗрд▓ рд╣реИ, рддреЛ <code>EWOULDBLOCK</code> рдФрд░ <code>EAGAIN</code> рдХрднреА рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ, рдФрд░ рд░реАрдб рдСрдкрд░реЗрд╢рди рд╣рдореЗрд╢рд╛ рдкреВрд░реЗ рдмрдлрд░ рдХреЛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрддрдЬрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рднрд▓реЗ рд╣реА рдлрд╝рд╛рдЗрд▓ <code>O_NONBLOCK</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЦреЛрд▓реА <code>O_NONBLOCK</code> ред  рдЬреИрд╕рд╛ рдХрд┐ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЦреБрд▓реЗ</a> рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">(2)</a> рдореИрдиреБрдЕрд▓: <br><br><blockquote>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдзреНрд╡рдЬ рдирд┐рдпрдорд┐рдд рдлрд╝рд╛рдЗрд▓реЛрдВ рдФрд░ рдмреНрд▓реЙрдХ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИред </blockquote><br>  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдЙрдкрд░реЛрдХреНрдд рдХреЛрдб рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реВрдк рд╕реЗ рдЗрд╕рдХреЗ рд▓рд┐рдП рдХрдо рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(fd, buf, buf_len) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf_len; }</code> </pre> <br>  рдпрджрд┐ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдбрд┐рд╕реНрдХ рд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЗрд╡реЗрдВрдЯ рд▓реВрдк рдХреЛ рддрдм рддрдХ рдмреНрд▓реЙрдХ рдХрд░рддрд╛ рд╣реИ рдЬрдм рддрдХ рд░реАрдб рдкреВрд░рд╛ рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдмрд╛рдж рдореЗрдВ рдИрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВред <br><br>  рдпрд╣ рдЕрдзрд┐рдХрд╛рдВрд╢ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рд╕реНрдХ рд╕реЗ рдкрдврд╝рдирд╛ рдЖрдорддреМрд░ рдкрд░ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдПрдХ рдкреИрдХреЗрдЯ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрд╛рдлреА рддреЗрдЬ рдФрд░ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЕрдиреБрдорд╛рдирд┐рдд рд╣реИред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЕрдм рдЬрдм рд╕рднреА рдХреЗ рдкрд╛рд╕ рдПрд╕рдПрд╕рдбреА рд╣реИ, рдФрд░ рд╣рдорд╛рд░реЗ рд╕рднреА рдХреИрд╢ рдПрд╕рдПрд╕рдбреА рдкрд░ рд╣реИрдВред  рдЖрдзреБрдирд┐рдХ рдПрд╕рдПрд╕рдбреА рдореЗрдВ, рдмрд╣реБрдд рдХрдо рджреЗрд░реА, рдЖрдорддреМрд░ рдкрд░ рджрд╕рд┐рдпреЛрдВ рдорд╛рдЗрдХреНрд░реЛрд╕реЗрдХрдВрдб рдореЗрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк Nginx рдХреЛ рдХрдИ рд╡рд░реНрдХрдлрд╝реНрд▓реЛрдЬрд╝ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдПрдХ рдзреАрдорд╛ рдИрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЕрд╡рд░реБрджреНрдз рди рдХрд░реЗред  рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рдордп рдЖрдк Nginx рдкрд░ рдЬрд▓реНрджреА рдФрд░ рдХреБрд╢рд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрдиреБрд░реЛрдзреЛрдВ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br><h1>  рдПрд╕рдПрд╕рдбреА рдкреНрд░рджрд░реНрд╢рди: рд╣рдореЗрд╢рд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд╛рджрд╛ рдирд╣реАрдВ рдХрд┐рдпрд╛ </h1><br>  рдЬреИрд╕рд╛ рдХрд┐ рдЖрдкрдиреЗ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдпрд╛ рд╣реЛрдЧрд╛, рдпреЗ рд░рд╕реАрд▓реА рдзрд╛рд░рдгрд╛рдПрдВ рд╣рдореЗрд╢рд╛ рд╕рдЪ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВред  рдпрджрд┐ рдкреНрд░рддреНрдпреЗрдХ рд░реАрдбрд┐рдВрдЧ рдореЗрдВ рд╣рдореЗрд╢рд╛ 50 ╬╝s рд▓рдЧрддреЗ рд╣реИрдВ, рддреЛ 4 рдХреЗрдмреА рдХреЗ рдмреНрд▓реЙрдХ рдореЗрдВ 0.19 рдПрдордмреА (рдФрд░ рд╣рдо рдмрдбрд╝реЗ рдмреНрд▓реЙрдХреЛрдВ рдореЗрдВ рднреА рдкрдврд╝рддреЗ рд╣реИрдВ) рдХреЛ рдкрдврд╝рдиреЗ рдореЗрдВ 2 рдПрдордПрд╕ рд▓рдЧреЗрдЧрд╛ред  рд▓реЗрдХрд┐рди рдкрд░реАрдХреНрд╖рдгреЛрдВ рд╕реЗ рдкрддрд╛ рдЪрд▓рд╛ рдХрд┐ рдкрд╣рд▓реА рдмрд╛рдЗрдЯ рдХреЗ рд▓рд┐рдП рд╕рдордп рдХрднреА-рдХрднреА рдмрд╣реБрдд рдЦрд░рд╛рдм рд╣реЛрддрд╛ рд╣реИ, рдЦрд╛рд╕рдХрд░ 99 рд╡реЗрдВ рдФрд░ 999 рд╡реЗрдВ рдкреНрд░рддрд┐рд╢рдд рдореЗрдВред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдкреНрд░рддреНрдпреЗрдХ 100 (рдпрд╛ 1000) рд░реАрдбрд┐рдВрдЧ рдореЗрдВ рд╕реЗ рд╕рдмрд╕реЗ рдзреАрдорд╛ рдкрдврд╝рдиреЗ рдореЗрдВ рдЕрдХреНрд╕рд░ рдЕрдзрд┐рдХ рд╕рдордп рд▓рдЧрддрд╛ рд╣реИред <br><br>  рдареЛрд╕ рд░рд╛рдЬреНрдп рдбреНрд░рд╛рдЗрд╡ рдмрд╣реБрдд рддреЗрдЬ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЙрдирдХреА рдЬрдЯрд┐рд▓рддрд╛ рдХреЗ рд▓рд┐рдП рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЙрдирдХреЗ рдкрд╛рд╕ рдЙрд╕ рдХрддрд╛рд░ рдХреЗ рдЕрдВрджрд░ рдХрдВрдкреНрдпреВрдЯрд░ рд╣реИрдВ рдФрд░ I / O рдХреЛ рдкреБрди: рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рд╡рд┐рднрд┐рдиреНрди рдкреГрд╖реНрдарднреВрдорд┐ рдХрд╛рд░реНрдп рднреА рдХрд░рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрдЪрд░рд╛ рд╕рдВрдЧреНрд░рд╣ рдФрд░ рдбреАрдлрд╝реНрд░реИрдЧреНрдореЗрдиреНрдЯреЗрд╢рдиред  рд╕рдордп-рд╕рдордп рдкрд░, рдЕрдиреБрд░реЛрдз рдзреАрд░реЗ-рдзреАрд░реЗ рдХрдо рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред  рдореЗрд░реЗ рд╕рд╣рдХрд░реНрдореА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЗрд╡рд╛рди рдмреЛрдмреНрд░реЛрд╡</a> рдиреЗ рдХрдИ I / O рдмреЗрдВрдЪрдорд╛рд░реНрдХ рд▓реЙрдиреНрдЪ рдХрд┐рдП рдФрд░ 1 рд╕реЗрдХрдВрдб рддрдХ рдХреА рд░реАрдб рдХреА рджреЗрд░реА рджрд░реНрдЬ рдХреАред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдорд╛рд░реЗ рдХреБрдЫ SSD рдХреЗ рдкрд╛рд╕ рдЕрдиреНрдп рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрдзрд┐рдХ рдРрд╕реЗ рдкреНрд░рджрд░реНрд╢рди рд╕реНрдкрд╛рдЗрдХреНрд╕ рд╣реИрдВред  рднрд╡рд┐рд╖реНрдп рдореЗрдВ рд╣рдо рдПрд╕рдПрд╕рдбреА рдЦрд░реАрджрддреЗ рд╕рдордп рдЗрд╕ рд╕рдВрдХреЗрддрдХ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрдм рд╣рдореЗрдВ рдореМрдЬреВрджрд╛ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдорд╛рдзрд╛рди рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br><br><h1>  <code>SO_REUSEPORT</code> рд╕рд╛рде рд╕рдорд╛рди рд▓реЛрдб рд╡рд┐рддрд░рдг </h1><br>  рдкреНрд░рддрд┐ 1000 рдЕрдиреБрд░реЛрдзреЛрдВ рдкрд░ рдПрдХ рдзреАрдореА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдмрдЪрдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рдЬреЛ рд╣рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдирд╣реАрдВ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рд╡рд╣ рд╢реЗрд╖ 1000 рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдПрдХ рджреВрд╕рд░реЗ рдХреЗ рд▓рд┐рдП рд░реЛрдХрдирд╛ рд╣реИред  рд╡реИрдЪрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ, Nginx рд╕рдорд╛рдирд╛рдВрддрд░ рдореЗрдВ рдХрдИ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рд╕рдордп рдореЗрдВ 1 рдИрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдореАрдЯреНрд░рд┐рдХ рдЬреЛрдбрд╝реА: <br><br><pre> <code class="hljs pgsql">gettimeofday(&amp;<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); num_events = epoll_wait(epfd, <span class="hljs-comment"><span class="hljs-comment">/*returned=*/</span></span>events, events_len, <span class="hljs-comment"><span class="hljs-comment">/*timeout=*/</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>); // events <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> list <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> active events // handle event[<span class="hljs-number"><span class="hljs-number">0</span></span>]: incoming request <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> http://example.com/ gettimeofday(&amp;event_start_handle, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); // handle event[<span class="hljs-number"><span class="hljs-number">1</span></span>]: send <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> response <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> http://cloudflare.com/ timersub(&amp;event_start_handle, &amp;<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>, &amp;event_loop_blocked);</code> </pre> <br>  99 рд╡рд╛рдБ рдкреНрд░рддрд┐рд╢рддрдХ (p99) <code>event_loop_blocked</code> рд╣рдорд╛рд░реЗ TTFB рдХреЗ 50% рд╕реЗ рдЕрдзрд┐рдХ рд╣реИред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдЕрдиреБрд░реЛрдз рдХреА рд╕реЗрд╡рд╛ рдХрд░рддреЗ рд╕рдордп рдЖрдзрд╛ рд╕рдордп рдЕрдиреНрдп рдЕрдиреБрд░реЛрдзреЛрдВ рджреНрд╡рд╛рд░рд╛ рдШрдЯрдирд╛ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдЪрдХреНрд░ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдиреЗ рдХрд╛ рдкрд░рд┐рдгрд╛рдо рд╣реИред  <code>event_loop_blocked</code> рдХреЗрд╡рд▓ рдЖрдзреЗ рд▓реЙрдХ рдХреЛ рдорд╛рдкрддрд╛ рд╣реИ (рдХреНрдпреЛрдВрдХрд┐ рд▓рдВрдмрд┐рдд рдХреЙрд▓ <code>epoll_wait()</code> рдорд╛рдкрд╛ рдирд╣реАрдВ рдЬрд╛рддрд╛ рд╣реИ), рдЗрд╕рд▓рд┐рдП рдЕрд╡рд░реБрджреНрдз рд╕рдордп рдХрд╛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЕрдиреБрдкрд╛рдд рдмрд╣реБрдд рдЕрдзрд┐рдХ рд╣реИред <br><br>  рд╣рдорд╛рд░реА рдкреНрд░рддреНрдпреЗрдХ рдорд╢реАрди 15 рд╡рд░реНрдХрдлрд╝реНрд▓реЛрдЬрд╝ рдХреЗ рд╕рд╛рде рдирдЧреНрдиреЗрдХреНрд╕ рдЪрд▓рд╛рддреА рд╣реИ, рдпрд╛рдиреА рдПрдХ рдзреАрдорд╛ I / O рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ 6% рд╕реЗ рдЕрдзрд┐рдХ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред  рд▓реЗрдХрд┐рди рдШрдЯрдирд╛рдУрдВ рдХреЛ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рд╡рд┐рддрд░рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХрд░реНрддрд╛ рдЕрдиреБрд░реЛрдзреЛрдВ рдХрд╛ 11% рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред <br><br>  <code>SO_REUSEPORT</code> рдЕрд╕рдорд╛рди рд╡рд┐рддрд░рдг рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред  рдорд╛рд░реЗрдХ рдорд╛рдпрдХреЛрд╡рд╕реНрдХреА рдиреЗ рдкрд╣рд▓реЗ рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЛ рдЕрдиреНрдп рдирдЧреНрдиреЗрдХреНрд╕ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрдорд┐рдпрд╛рдВ рдХреЗ</a> рдмрд╛рд░реЗ рдореЗрдВ рд▓рд┐рдЦрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдВ рдЖрдк рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЗрд╕реЗ рдЕрдирджреЗрдЦрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: рдХреИрд╢ рдореЗрдВ рдЕрдкрд╕реНрдЯреНрд░реАрдо рдХрдиреЗрдХреНрд╢рди рдЯрд┐рдХрд╛рдК рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдХрдиреЗрдХреНрд╢рди рдЦреЛрд▓рддреЗ рд╕рдордп рджреЗрд░реА рдореЗрдВ рдереЛрдбрд╝реА рд╡реГрджреНрдзрд┐ рдХреА рдЙрдкреЗрдХреНрд╖рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрд╣ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди <code>SO_REUSEPORT</code> рд╕реБрдзрд╛рд░ рдХреЗ рд╕рд╛рде рдЕрдХреЗрд▓реЗ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ p99 33% рдмреЗрд╣рддрд░ рд╣реЛ рдЧрдпрд╛ рд╣реИред <br><br><h1>  рдереНрд░реЗрдб рдкреВрд▓ рдХреЗ рд▓рд┐рдП рдкрдврд╝рдирд╛ () рдЪрд▓рдирд╛: рдЪрд╛рдВрджреА рдХреА рдЧреЛрд▓реА рдирд╣реАрдВ </h1><br>  рд╕рдорд╛рдзрд╛рди рдХреЛ рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рдмрдирд╛рдирд╛ рд╣реИред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╕рд╛рдорд╛рдиреНрдп рдирдЧреНрдиреЗрдХреНрд╕ рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ</a> !  рдирд┐рдореНрди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдереНрд░реЗрдб рдкреВрд▓ рдореЗрдВ рдкрдврд╝реЗрдВ () рдФрд░ рд▓рд┐рдЦреЗрдВ () рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдИрд╡реЗрдВрдЯ рд▓реВрдк рдХреЛ рдмреНрд▓реЙрдХ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">aio</span></span> threads; <span class="hljs-attribute"><span class="hljs-attribute">aio_write</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br>  рд▓реЗрдХрд┐рди рд╣рдордиреЗ рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдФрд░ 33 рдмрд╛рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдордп рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рд╣рдордиреЗ p99 рдореЗрдВ рдХреЗрд╡рд▓ рдПрдХ рдЫреЛрдЯреЗ рд╕реЗ рдмрджрд▓рд╛рд╡ рдкрд░ рдзреНрдпрд╛рди рджрд┐рдпрд╛, рдЕрдВрддрд░ рддреНрд░реБрдЯрд┐ рдХреЗ рдорд╛рд░реНрдЬрд┐рди рдХреЗ рднреАрддрд░ рд╣реИред  рдкрд░рд┐рдгрд╛рдо рдмрд╣реБрдд рд╣рддреЛрддреНрд╕рд╛рд╣рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рд╣рдордиреЗ рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдХреЛ рд╕реНрдердЧрд┐рдд рдХрд░ рджрд┐рдпрд╛ред <br><br>  рдРрд╕реЗ рдХрдИ рдХрд╛рд░рдг рд╣реИрдВ рдХрд┐ рд╣рдордиреЗ Nginx рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреА рддрд░рд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрдзрд╛рд░ рдирд╣реАрдВ рдХрд┐рдП рд╣реИрдВред  рдкрд░реАрдХреНрд╖рдг рдореЗрдВ рдЙрдиреНрд╣реЛрдВрдиреЗ рдПрдЪрдбреАрдбреА рдХреЗ рд▓рд┐рдП 4 рдПрдордмреА рдХреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 200 рдПрдХ рд╕рд╛рде рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред  Winchesters рдореЗрдВ I / O рд╡рд┐рд▓рдВрдмрддрд╛ рдЕрдзрд┐рдХ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдиреБрдХреВрд▓рди рдХрд╛ рдЕрдзрд┐рдХ рдкреНрд░рднрд╛рд╡ рдкрдбрд╝рддрд╛ рд╣реИред <br><br>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдо рдореБрдЦреНрдп рд░реВрдк рд╕реЗ p99 (рдФрд░ p999) рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЪрд┐рдВрддрд┐рдд рд╣реИрдВред  рдФрд╕рдд рджреЗрд░реА рдХрд╛ рдЕрдиреБрдХреВрд▓рди рдЬрд░реВрд░реА рдирд╣реАрдВ рдХрд┐ рдЪреЛрдЯреА рдХреЗ рдЙрддреНрд╕рд░реНрдЬрди рдХреА рд╕рдорд╕реНрдпрд╛ рдХрд╛ рд╕рдорд╛рдзрд╛рди рд╣реЛред <br><br>  рдЕрдВрдд рдореЗрдВ, рд╣рдорд╛рд░реЗ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ, рд╡рд┐рд╢рд┐рд╖реНрдЯ рдлрд╝рд╛рдЗрд▓ рдЖрдХрд╛рд░ рдмрд╣реБрдд рдЫреЛрдЯреЗ рд╣реИрдВред  рд╣рдорд╛рд░реЗ рдХреИрд╢ рд╣рд┐рдЯ рдХрд╛ 90% 60KB рд╕реЗ рдХрдо рд╣реИред  рдлрд╝рд╛рдЗрд▓реЗрдВ рдЬрд┐рддрдиреА рдЫреЛрдЯреА рд╣реЛрдВрдЧреА, рдЕрд╡рд░реБрджреНрдз рд╣реЛрдиреЗ рдХреЗ рдХрдо рдорд╛рдорд▓реЗ (рдЖрдорддреМрд░ рдкрд░ рд╣рдо рдкреВрд░реА рдлрд╛рдЗрд▓ рдХреЛ рджреЛ рд░реАрдб рдореЗрдВ рдкрдврд╝рддреЗ рд╣реИрдВ)ред <br><br>  рдЖрдЗрдП рдХреИрд╢ рдореЗрдВ рд╣рд┐рдЯ рд╣реЛрдиреЗ рдкрд░ рдбрд┐рд╕реНрдХ I / O рджреЗрдЦреЗрдВ: <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/example.com    0xCAFEBEEF fd = open("/cache</span></span><span class="hljs-regexp"><span class="hljs-regexp">/prefix/dir</span></span><span class="hljs-regexp"><span class="hljs-regexp">/EF/</span></span>BE/CAFEBEEF<span class="hljs-string"><span class="hljs-string">", O_RDONLY); //    32    //    ,  "</span></span>aio threads<span class="hljs-string"><span class="hljs-string">"  read(fd, buf, 32*1024);</span></span></code> </pre> <br>  32K рд╣рдореЗрд╢рд╛ рдкрдврд╝рд╛ рдирд╣реАрдВ рдЬрд╛рддрд╛ рд╣реИред  рдпрджрд┐ рд╣реЗрдбрд░ рдЫреЛрдЯреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдХреЗрд╡рд▓ 4 рдХреЗрдмреА рдкрдврд╝рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ (рд╣рдо рд╕реАрдзреЗ рдЖрдИ / рдУ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдХрд░реНрдиреЗрд▓ 4 рдХреЗрдмреА рдХреЗ рдЪрдХреНрдХрд░ рд▓рдЧрд╛рддрд╛ рд╣реИ)ред  <code>open()</code> рд╣рд╛рдирд┐рд░рд╣рд┐рдд рд▓рдЧрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╕рдВрд╕рд╛рдзрди рд▓реЗрддрд╛ рд╣реИред  рдХрдо рд╕реЗ рдХрдо, рдХрд░реНрдиреЗрд▓ рдХреЛ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдХреНрдпрд╛ рдлрд╝рд╛рдЗрд▓ рдореМрдЬреВрдж рд╣реИ рдФрд░ рдХреНрдпрд╛ рдХреЙрд▓рд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЗрд╕реЗ рдЦреЛрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рдпрд╛ рдирд╣реАрдВред  рдЙрд╕реЗ <code>/cache/prefix/dir/EF/BE/CAFEBEEF</code> рд▓рд┐рдП <code>/cache/prefix/dir/EF/BE/CAFEBEEF</code> , рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдП рдЙрд╕реЗ <code>CAFEBEEF</code> <code>/cache/prefix/dir/EF/BE/</code> рдореЗрдВ рджреЗрдЦрдирд╛ рд╣реЛрдЧрд╛ред  рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рд╕рдмрд╕реЗ рдмреБрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдХрд░реНрдиреЗрд▓ рдЗрд╕ рдЦреЛрдЬ рдХреЛ рдХрд░рддрд╛ рд╣реИ: <br><br><pre> <code class="hljs pgsql">/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/prefix /<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/prefix/dir /<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/prefix/dir/EF /<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/prefix/dir/EF/BE /<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/prefix/dir/EF/BE/CAFEBEEF</code> </pre> <br>  рдпреЗ 6 рдЕрд▓рдЧ-рдЕрд▓рдЧ рд░реАрдб рд╣реИрдВ рдЬреЛ 1 <code>read()</code> рдХреА рддреБрд▓рдирд╛ рдореЗрдВ <code>open()</code> рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ <code>read()</code> !  рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рдЬреНрдпрд╛рджрд╛рддрд░ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЦреЛрдЬ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреЗрдВрдЯреНрд░реА рдХреИрд╢</a> рдореЗрдВ рдЧрд┐рд░ рдЬрд╛рддреА рд╣реИ рдФрд░ рдПрд╕рдПрд╕рдбреА рддрдХ рдирд╣реАрдВ рдкрд╣реБрдВрдЪрддреА рд╣реИред  рд▓реЗрдХрд┐рди рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдПрдХ рдереНрд░реЗрдб рдкреВрд▓ рдореЗрдВ <code>read()</code> рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг <code>read()</code> рдХреЗрд╡рд▓ рдЖрдзреА рддрд╕реНрд╡реАрд░ рд╣реИред <br><br><h1>  рдЕрдВрддрд┐рдо рд░рд╛рдЧ: рдереНрд░реЗрдб рдкреВрд▓ рдореЗрдВ рдиреЙрди-рдмреНрд▓реЙрдХрд┐рдВрдЧ рдУрдкрди () </h1><br>  рдЗрд╕рд▓рд┐рдП, рд╣рдордиреЗ Nginx рдореЗрдВ рдПрдХ рдмрджрд▓рд╛рд╡ рдХрд┐рдпрд╛ рддрд╛рдХрд┐ <code>open()</code> рдЬреНрдпрд╛рджрд╛рддрд░ рдереНрд░реЗрдб рдкреВрд▓ рдХреЗ рдЕрдВрджрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рдФрд░ рдЗрд╡реЗрдВрдЯ рд▓реВрдк рдХреЛ рдмреНрд▓реЙрдХ рди рдХрд░реЗрдВред  рдФрд░ рдпрд╣рд╛рдБ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз рдЦреБрд▓рд╛ () рдФрд░ рдкрдврд╝рдиреЗ () рд╕реЗ рдкрд░рд┐рдгрд╛рдо рд╣реИ: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d70/b1a/84b/d70b1a84b46934921ffd5a1fd7e7182a.png"><br><br>  26 рдЬреВрди рдХреЛ, рд╣рдордиреЗ 5 рд╡реНрдпрд╕реНрддрддрдо рдбреЗрдЯрд╛ рдХреЗрдВрджреНрд░реЛрдВ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдХрд┐рдпрд╛, рдФрд░ рдЕрдЧрд▓реЗ рджрд┐рди - рджреБрдирд┐рдпрд╛ рднрд░ рдХреЗ рдЕрдиреНрдп рд╕рднреА 146 рдбреЗрдЯрд╛ рдХреЗрдВрджреНрд░реЛрдВ рдкрд░ред  рдХреБрд▓ рд╢рд┐рдЦрд░ p99 TTFB 6 рдЧреБрдирд╛ рдШрдЯ рдЧрдпрд╛ред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрджрд┐ рд╣рдо рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб 8 рдорд┐рд▓рд┐рдпрди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рд╕реЗ рд╣рд░ рд╕рдордп рд╕рд╛рд░рд╛рдВрд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рд╣рд░ рджрд┐рди рдЗрдВрдЯрд░рдиреЗрдЯ рдХреЗ 54 рд╡рд░реНрд╖реЛрдВ рдХреЗ рдЗрдВрддрдЬрд╛рд░ рдХреЛ рдмрдЪрд╛рддреЗ рд╣реИрдВред <br><br>  рдШрдЯрдирд╛рдУрдВ рдХреА рд╣рдорд╛рд░реА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЛ рдЕрднреА рддрдХ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рддрд╛рд▓реЗ рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ рд╣реИред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдмреНрд▓реЙрдХрд┐рдВрдЧ рддрдм рднреА рд╣реЛрддреА рд╣реИ рдЬрдм рдлрд╝рд╛рдЗрд▓ рдХреИрд╢реНрдб рд╣реЛрддреА рд╣реИ (рджреЛрдиреЛрдВ <code>open(O_CREAT)</code> рдФрд░ <code>rename()</code> ) рдпрд╛ <code>open(O_CREAT)</code> рдЕрдкрдбреЗрдЯ рдХрд░рддреЗ рд╕рдордпред  рд▓реЗрдХрд┐рди рдРрд╕реЗ рдорд╛рдорд▓реЗ рдХреИрд╢ рдПрдХреНрд╕реЗрд╕ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рджреБрд░реНрд▓рдн рд╣реИрдВред  рднрд╡рд┐рд╖реНрдп рдореЗрдВ, рд╣рдо рдЗрди рдХрд╛рд░рдХреЛрдВ рдХреЛ рдЗрд╡реЗрдВрдЯ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рд▓реВрдк рдХреЗ рдмрд╛рд╣рд░ рд▓реЗ рдЬрд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВрдЧреЗ рддрд╛рдХрд┐ рд╡рд┐рд▓рдВрдм рдХрд╛рд░рдХ p99 рдХреЛ рдФрд░ рдмреЗрд╣рддрд░ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред <br><br><h1>  рдирд┐рд╖реНрдХрд░реНрд╖ </h1><br>  Nginx рдПрдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд╣реИ, рд▓реЗрдХрд┐рди рдЕрддреНрдпрдзрд┐рдХ рдЙрдЪреНрдЪ рд▓рд┐рдирдХреНрд╕ I / O рднрд╛рд░ рдХреЛ рд╕реНрдХреЗрд▓ рдХрд░рдирд╛ рдПрдХ рдХрдард┐рди рдХрд╛рдо рд╣реЛ рд╕рдХрддрд╛ рд╣реИред  рд╕реНрдЯреИрдВрдбрд░реНрдб рдирдЧреНрдиреЗрдХреНрд╕ рдЕрд▓рдЧ рдереНрд░реЗрдбреНрд╕ рдореЗрдВ рдкрдврд╝рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рд╣рдореЗрдВ рдЕрдХреНрд╕рд░ рдПрдХ рдХрджрдо рдЖрдЧреЗ рдЬрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi419023/">https://habr.com/ru/post/hi419023/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi419011/index.html">рдЬрд┐рдирдЬрд╛ 2 рд╕реА ++ рджреБрдирд┐рдпрд╛ рдореЗрдВ, рднрд╛рдЧ рджреЛред рдкреНрд░рддрд┐рдкрд╛рджрди</a></li>
<li><a href="../hi419013/index.html">SaaS B2B рд╡реНрдпрд╡рд╕рд╛рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдлрд╝рдирд▓-рдЖрдзрд╛рд░рд┐рдд рд░реЛрдкрдг - рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рд╕рднреА рд╡рд┐рдкрдгрди рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЗ рдореВрд▓реНрдп рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд┐рдпрд╛</a></li>
<li><a href="../hi419017/index.html">рдирдпрд╛ рдХреНрдпрд╛ рд╣реИ рдХрд╛рдВрд╕реНрдЯреНрд░реЗрдиреНрдерд▓рд╛рдИрдЯ 1.1</a></li>
<li><a href="../hi419019/index.html">рдСрд▓реНрдЯрд░рдПрдЧреЛ: рдПрдХ рдЙрдкрдХрд░рдг рдЬреЛ рд╡рд┐рдЪрд╛рд░реЛрдВ (рдХреБрдЫ) рдХреЛ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ</a></li>
<li><a href="../hi419021/index.html">рдореБрджреНрд░рдг рдХреЗ рдореБрдЦреНрдп рдкреНрд░рдХрд╛рд░ рдФрд░ рдЙрдирдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ</a></li>
<li><a href="../hi419025/index.html">@Pythonetc рд╕рдВрдХрд▓рди, рдЬреБрд▓рд╛рдИ 2018</a></li>
<li><a href="../hi419027/index.html">рдмреИрдВрдХ рдХреИрд╢рд▓реЗрд╕ рднреБрдЧрддрд╛рди рдХреА рд╕реВрдЪрдирд╛ рд╕реБрд░рдХреНрд╖рд╛ред рднрд╛рдЧ 6 - рдмреИрдВрдХрд┐рдВрдЧ рдЕрдкрд░рд╛рдз рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
<li><a href="../hi419029/index.html">Fortnite рдПрдХ рд╕рд╛рдорд╛рдЬрд┐рдХ рдШрдЯрдирд╛ рдмрди рдЧрдИ рд╣реИред рдорд╛рддрд╛-рдкрд┐рддрд╛ рддреЗрдЬреА рд╕реЗ рдЕрдкрдиреЗ рдмрдЪреНрдЪреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд┐рдХреНрд╖рдХреЛрдВ рдХреЛ рдХрд╛рдо рдкрд░ рд░рдЦ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреЗ рд╕рд╛рде рдЦреЗрд▓ рд░рд╣реЗ рд╣реИрдВ</a></li>
<li><a href="../hi419033/index.html">рдХреБрдмреЗрд░рдиреЗрдЯ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ vue.js рдЪрд▓рд╛рдиреЗ рдХреЗ рд╡рд┐рд╖рдп рдкрд░ рдПрдХ рдЫреЛрдЯрд╛ рдиреЛрдЯ</a></li>
<li><a href="../hi419035/index.html">рдкреБрд╕реНрддрдХ тАЬрд╣реЗрдб рдлрд░реНрд╕реНрдЯ рдПрдЬрд╛рдЗрд▓ред рд▓рдЪреАрд▓реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдкреНрд░рдмрдВрдзрди тАЭ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>