<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚭 👿 📷 PostgreSQL中的FIAS Homes 🥊 😟 👨🏽‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="上一篇文章介绍了FIAS地址和在PostgreSQL环境中使用它们的功能，引起了一小部分读者的兴趣。 

 因此，在PL / pgSQL中描述类似的功能以处理加载到运行PostgreSQL的数据库中的FIAS房屋列表是有意义的。 


 本文的前半部分提供了有关功能实现的评论。 在第二篇中，介绍了功...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL中的FIAS Homes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425287/"> 上一篇文章介绍了FIAS地址和在PostgreSQL环境中使用它们的功能，引起了一小部分读者的兴趣。 <br><br> 因此，在PL / pgSQL中描述类似的功能以处理加载到运行PostgreSQL的数据库中的FIAS房屋列表是有意义的。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/94a/cb7/fbc/94acb7fbc32a4cf18fd15e854b62360c.png"></div><br> 本文的前半部分提供了有关功能实现的评论。 在第二篇中，介绍了功能的源代码以及用于创建带有FIAS内部记录的表的脚本，以及用于将数据从CSV格式的文件加载到该表中的脚本。 对于只对源文本感兴趣的读者，我们建议立即继续阅读附录。 <br><a name="habracut"></a><br> 本文与“ PostgreSQL环境中的FIAS地址”系列文章的材料（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">开始</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">继续1</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">继续2</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">结束</a> ）密切相关。 <br><a name="tfHousesAOT_def"></a><h3> 家里的家谱 </h3><br><p> 让我们从一个例子开始。 <br></p><p> 调用f函数<b>stf_Houses_AddressObjectTree</b> （'42301ab8-9ead-4f8e-8281-e64f2769a254'）将产生以下条目列表。 </p><br>  <b>表1.函数的结果。</b> <br><br><img src="https://habrastorage.org/webt/3n/2w/ir/3n2wirseekn4w0oz6kcnzhazl4o.png"><br><br><p> 在仔细检查时，您可能会注意到元素标识符（ <b>HOUSEGUID</b> ）“ d。  1，建筑物。  2，第26页，因此收到了六条记录： </p><br><ul><li> 三个具有地址形成元素的父记录：关于区域，城市和街道的信息； </li><li> 三个具有门牌特征的记录：门牌号，门牌号和门牌号。 </li></ul><br><p> 该函数还有另一个可选参数-记录的到期日期（ <b>EndDate</b> ），通过该参数，您不仅可以查看关于房屋的当前记录的谱系，还可以查看已经过时的记录的谱系。 <br><br> 该函数的全文在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建函数fstf_Houses_AddressObjectTree</a>的附录中<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">给出</a> 。 </p><br><h4> 从一开始 </h4><br><p> 如果您知道FIAS房屋表的布置方式，则可以跳过此部分。 <br>  FIAS房屋（ <b>HOUSES</b> ）是FIAS（ <b>ADDROBJ</b> ）的地址生成元素列表的子列表。 每个房屋列表条目均通过<b>AOGUID</b>字段的值引用FIAS地址生成元素。 为了确定房屋位于哪条街道和哪个位置，您需要<b>通过HOUSES</b>记录<b>的AOGUID</b>值找到具有相同列表标识符<b>ADDROBJ</b>的对应记录。 </p><br><p> 尽管房屋清单和其交互中的地址形成元素清单之间的相互作用机制在表面上很简单，但功能使<b>房屋</b>功能的实现复杂化。 </p><br><p> 首先，标识符<b>AOGUID</b>记录的房屋清单中的每个记录<b>都</b>涉及一组地址形成元素，其中一个是相关的。 </p><br><p> 其次，FIAS列表中有几个条目具有相同的门牌特征集：门牌号，门牌号，门牌号。 </p><br><p> 第三，房屋的记录并不总是从村庄街道的记录中继承的。 </p><br> 但是，首先是第一件事。 <br><p> 为了进一步考虑FIAS中房屋信息的存储，将自己限制为4个表（DBF文件）就足够了： </p><br><img src="https://habrastorage.org/webt/ba/zn/e3/bazne3xtr_fqhud7hgzdxzjgl-8.png"><br><br><ul><li>  <b>ADDROBJ-</b>地址形成元素列表； </li><li>  <b>房屋</b> - <b>房屋</b>清单； </li><li>  <b>STRSTAT-</b>结构特征目录； </li><li>  <b>ESTSTAT-</b>所有权标志目录。 </li></ul><br><p> 在以前的出版物<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“ PostgreSQL中的FIAS地址”</a>中详细讨论了ADDROBJ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，</a>因此这里将充分描述它的功能以描述房屋的特征。 </p><br>  <b>表2。房屋的历史“克拉斯诺亚尔斯克地区，泰米尔米尔Dolgan-Nenetsky区，Dudinka，ul。</b>  <b>杜丁斯卡亚1</b> <b><br></b> <br><br><img src="https://habrastorage.org/webt/5b/vu/8k/5bvu8k8v5lriarnghwlo7n5lmk8.png"><br><br><p> 从表中可以看出，与地址形成对象相反，房屋历史记录没有特殊的相关标志。 该期间的最早结束日期大于当前日期的记录是相关的。 到目前为止，当前房屋记录的日期标记为06.06.2079。 关于房屋的所有其他记录均被视为历史记录，并且开始日期和结束日期描述了每个记录的相关时间段。 </p><br><p>  FIAS房屋列表不包含指向房屋的上一个和下一个记录的指针。 因此，从实际开始到房屋历史的记录顺序由递减的结束日期确定，超出该日期的开始日期分别为<b>EndDate</b>和<b>StartDate</b> 。 </p><br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=<span class="hljs-string"><span class="hljs-string">'2fd64ecd-4b4b-4fc8-bd15-4a4a2f310b21'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>,h.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p> 细心的读者看图。  1，我可能会问自己一个问题：为什么提到结构和所有权标志的参考书？  FIAS使用了超过10种此类目录，那么为什么要突出显示这两个目录？ </p><br><p> 答案将使很多人感到惊讶-从“ FIAS逻辑”的角度来看，房屋的地址不能完全由街道地址，房屋，建筑物和建筑物编号完全识别。 联邦税务局的一名雇员回答了我的问题，为什么在克拉斯诺亚尔斯克地区的房屋清单中有超过250个成对的房屋地址，因此使用了“ FIAS逻辑”一词。 相同的答案表示，记录的唯一性由值AOGUID，HOUSENUM，BUILDNUM，STRUCNUM，STRSTATUS，ESTSTATUS提供。 </p><br><br><img src="https://habrastorage.org/webt/xi/13/1l/xi131l6giem5x7mcbj4f-vpxfli.png"><br><br><p> 换句话说，要找到一个对象，仅仅知道位置，街道，门牌号码是不够的。 您还必须知道： </p><br><ul><li>  “财产”是或“房屋所有权”； </li><li> 该对象的状态已定义或未定义； </li><li> 等 </li></ul><br><img src="https://habrastorage.org/webt/np/9i/6n/np9i6n0cehorqtwgf6fzwyqm4mu.png"><br><br><p> 这就是FIAS房屋总列表中地址重复的样本的样子。 <br> 不同对象具有相同地址的事实不足为奇。 建筑物及其下面的土地； 一位业主的房屋，车库，浴室。 他们都有相同的地址。 但是FIAS是地址寄存器，即 地址列表。 因此，很自然地期望地址在其中是唯一的，而不是建筑物，结构，结构。 </p><br><p> 即 房屋地址列表中的FIAS房屋列表开始向地面建筑物列表发展。  FIAS用户需要考虑这一点。 </p><br><p> 每个人都可以通过执行类似于以下内容的SELECT语句来检查是否存在地址重复的房屋。 同时，无法使用函数fsfn_Houses_TreeActualName，因为 它仅用于减少结果中的列数。 不必使用fias_StructureStatus（STRSTAT的类似物）和fias_EstateStatus（类似于ESTSTAT）目录，例如 明显的效果也可以追溯到结构和占有标志的代码上。 </p><br><img src="https://habrastorage.org/webt/ch/d_/gr/chd_grqqzvzh7u_z058i-qxjkmk.png"><br><br><div class="spoiler">  <b class="spoiler_title">操作员源代码</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fsfn_Houses_TreeActualName(h.AOGUID,h.HOUSEGUID),h.HOUSEGUID,str.StructureStatusName,est.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM,COUNT(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> COUNT(*)&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>) hg <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=hg.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSENUM=hg.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_StructureStatus str <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.STRSTATUS=str.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_EstateStatus est <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.ESTSTATUS=est.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID,h.HOUSENUM,h.BUILDNUM,h.STRUCNUM,h.STRSTATUS,h.ESTSTATUS;</code> </pre><br></div></div><br><p> 最后，FIAS主页列表的另一个功能。 该列表的每个房屋记录均包含指向地址形成元素的链接，该地址形成元素的列表是此类元素的层次结构。 在层次结构的每个级别上，都有属于不同类型的地址形成元素。 因此，根本要素是地区（在我们的例子中为克拉斯诺亚尔斯克地区），在下一级是自治的直辖市，地区或地区从属城市。 依此类推。  （有关详细信息，请参见“ PostgreSQL中的FIAS地址”）。 </p><br><p> 正式地，房屋记录允许您在任何级别引用层次结构的元素。 幸运的是，在克拉斯诺亚尔斯克地区的数据中，没有房屋提到一个地区或地区。 然而，并非所有房屋都指村庄的街道： </p><br><ul><li>  FIAS 98％的房屋与人口稠密地区的街道相连； </li><li>  1.2％的房屋-在园艺协会中有街道； </li><li>  0.3％的房屋属于定居点； </li><li> 有其他可寻址元素的房屋的0.5％。 </li></ul><br><img src="https://habrastorage.org/webt/mh/xq/3u/mhxq3ukmrzmjlboytqt2q4fsxno.png"><br>  <b>图</b>  <b>2。</b> <br><br><h4> 业主传播房屋地址（FIAS与地图） </h4><br><p> 这里描述的一个问题导致对家谱的模棱两可的解释。  （克拉斯诺亚尔斯克Aigeo LLC的GIS专家Igor Leonidovich Timoshchenkov提请我注意这个问题。） </p><br><p> 上面显示了几个记录如何在家里包含相同的地址。 税务监察机构不仅要保留私人房屋的记录，而且还要保留周围建筑物的记录：车库，谷仓等，这可以解释。 但是，当多个建筑物（fias_Houses）对应于一栋具有不同编号的建筑物（house）时，有相反的例子。 </p><br><br><img src="https://habrastorage.org/webt/5-/u6/cs/5-u6csqwbyl14t6fwhnix-r3nue.png"><br><br><p> 看看这张照片。 左侧是屏幕快照，其中包含两个所有者的房屋所在村庄的地图。 这些是带有两个入口的普通一层房屋。 一个家庭住在右边，另一个家庭住在左边。 仍然可以将它们想象成来自两个公寓的房屋。 </p><br><p> 现在看右边的表。 在其中，几乎每个有两个所有者的房子都对应3个条目。 即  FIAS房屋表显示单个房屋的地址（“ d。1”）和属于一个所有者的房屋部分的地址（“ d。1/1”，“ d。1/2”）。 </p><br><h4> 如何运作 </h4><br><p>  <b>fstf_Houses_AddressObjectTree</b>函数具有两个版本：具有四个或具有两个参数。 在具有两个参数的函数版本中，将<b>传输</b>房屋标识符（ <b>HouseGUID</b> ）和记录的到期日期<b>（EndDate</b> ）。 具有四个参数的版本还需要用于地址生成元素（ <b>AOGUID</b> ）和当前状态（ <b>CurrStatus</b> ）的<b>标识符</b> 。 </p><br><img src="https://habrastorage.org/webt/f9/9k/mv/f99kmvqqmijnjjs14z0vmakvrmq.png"><br><br><div class="spoiler">  <b class="spoiler_title">操作员源代码</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_AOGUID,v_CurrStatus h.AOGUID,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> iao.currstatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MAX(iao.currstatus) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><p> 参数较少的函数将计算缺少的参数的值，然后调用具有大量参数的函数。 为此，只需从房屋表的相应字段（f <b>ias_Houses</b> ）中检索地址形成元素的标识符。 并且根据以下规则计算当前状态的值（ <b>CurrStatus</b> ）： </p><br><ul><li> 如果地址形成元素的历史记录在CurrStatus字段中都不包含0，则为v_CurrStatus变量分配此地址形成元素的最大字段值； </li><li> 否则，将为该变量分配值0。 </li></ul><br><p> 具有大量参数的函数首先调用函数<b>fstf_AddressObjects_AddressObjectTree</b> ，该函数返回房屋的父地址形成元素。 您可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在PostgreSQL的FIAS地址</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">地址形成元素</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">谱系</a>部分中了解有关fstf_AddressObjects_AddressObjectTree函数的更多信息 </p>  。 <br><p> 然后，有关地址形成元素的条目由有关房屋，建筑物，结构编号的条目补充（请参见表1），这些条目是针对有关房屋，建筑物和结构编号的每个非空字段创建的。 </p><br><p> 为了使所有输出记录具有相同的结构，并且没有某种程度的泛滥，在功能主体中人工创建了字段代码级别（ <b>AOLevel</b> ），当前状态（ <b>CurrStatus</b> ）和关联状态（ <b>ActStatus</b> ）的值。 </p><br><p> 房屋（建筑物，构筑物）级别的代码始终设置为8，请参阅《 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FIAS信息构成文档</a> 》中的参考书“可寻址对象的级别”。 </p><br><p> 如果记录（ <b>EndDate</b> ）的到期日期是<b>06.06.2079</b> ，则关联状态设置为<b>1，</b>否则设置为0。 </p><br><p>  <b>CurrStatus</b>字段<b>值</b>更加复杂。 使用其值，可以同时解决两个任务：设置有关地址形成元素的记录的每个版本的标识符，并分配记录相关性的符号。 因此，有关元素的最后一条当前记录在该字段中的值为<b>0</b> ，并且所有历史记录均按出现顺序编号-“ 1”是最早的记录，在时间上紧随其后-“ 2”，依此类推。 将值分配给CurrStatus字段的顺序<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在PostgreSQL的FIAS地址中有</a>更详细的描述。 </p><br><img src="https://habrastorage.org/webt/8t/13/og/8t13ogvul4asrek6okocveb8frq.png"><br><br><div class="spoiler">  <b class="spoiler_title">扰流板方向</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> h.AOGUID, h.HOUSEGUID, h.HOUSENUM, h.BUILDNUM, h.STRUCNUM, h.ENDDATE, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE(h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> RANK() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID, h.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseCurrStatus, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE (h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseActStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.AOGUID=a_AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><h3> 满屋地址 </h3><br><p>  <b>fsfn_Houses_TreeActualName</b>函数的主要思想是返回在一行中连接的房屋编号及其所有祖先的名称-地址形成元素。 </p><br><p> 例如，让族树函数（fstf_Houses_AddressObjectTree）返回以下值列表。 </p><br>  <b>表4.函数fstf_Houses_AddressObjectTree（'0c0d670f-097c-4e1d-bcac-9e9b22fb1b99'）的结果</b> <br><br><img src="https://habrastorage.org/webt/5s/iu/ks/5siuksa7hfbicjmqsdt-fiqu1z0.png"><br><br><p> 然后<b>fsfn_Houses_TreeActualName</b> （'0c0d670f-097c-4e1d-bcac-9e9b22fb1b99'）应该返回：“ <b>Krasnoyarsk先生，位于</b> Bld <b>St. Lazo，34A。</b>  <b>6，p。17</b> ”。 </p><br><p> 可以将函数<b>fsfn_Houses_TreeActualName</b>简化为集合函数<b>STRING_AGG</b> ，而不是将函数返回家中的树的结果。 </p><br><p> 有问题的函数还有另一个可选参数-掩码数组（ <b>a_MaskArray</b> ），您可以在掩码中包含所有元素名称，而不是所有元素名称。 </p><br>  <b>表5.功能掩码列表。</b> <br><br><img src="https://habrastorage.org/webt/6e/dl/q5/6edlq5zop1sqnwemc1s2zmbmgme.png"><br><br><div class="spoiler">  <b class="spoiler_title">表格的文字版本</b> <div class="spoiler_text"><table><tbody><tr><th> 价值 </th><th> 注意事项 </th></tr><tr><td>  {HS} </td><td> 面具-门牌号码 </td></tr><tr><td>  {BY} </td><td> 口罩-盒号 </td></tr><tr><td>  {BG} </td><td> 面罩-门牌号 </td></tr><tr><td>  {ST} </td><td> 面具-街道 </td></tr><tr><td>  {ZC} </td><td> 面具-邮编 </td></tr><tr><td>  {DT} </td><td> 面具-市区 </td></tr><tr><td>  {LP} </td><td> 面具-下属镇 </td></tr><tr><td>  {LM} </td><td> 口罩-主要解决方案 </td></tr><tr><td>  {TP} </td><td> 遮罩-联盟主题的区域 </td></tr><tr><td>  {TM} </td><td> 遮罩-联盟的主题（区域） </td></tr><tr><td>  {CY} </td><td> 面具-国家 </td></tr></tbody></table><br></div></div><br> 另请参见<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">出版物“ PostgreSQL中的FIAS地址”的“地址形成元素的全名</a> ”部分。 <br> 函数文本在“应用程序”部分“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建fsfn_Houses_TreeActualName函数</a> ”中给出。 <br><br><h3>  FIAS主页搜索 </h3><br><p>  <b>fstf_Houses_SearchByName</b>函数用于按编号和地址形成元素的名称搜索FIAS房屋的地址。 而且，不仅可以通过当前元素的名称和类型来进行搜索，还可以通过其最接近祖先中的一两个的名称和类型来进行搜索。 </p><br><p> 让我们看几个例子。 首先，我们将找到所有编号为“ 220”的房屋。 </p><br>  <b>表6.函数fstf_Houses_SearchByName（'220'）的结果</b> <br><br><img src="https://habrastorage.org/webt/lk/82/od/lk82odn1sragk7w8oudjxihuqye.png"><br><br><p> 与搜索地址形成元素（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">fstf_AddressObjects_SearchByName</a> ）的功能不同，此函数的结果不包含在地址形成元素的各个级别进行“游动”的效果。 该函数的第一个参数始终包含房屋编号的搜索模式，第二个-建筑物编号，第三个建筑物编号。 </p><br><p> 现在更改请求。 我们发现所有地址形成元素的房子，其地址包含数字“ 1”，并且名称中出现单词“ Krasnoyarsk”。 </p><br>  <b>表7.函数fstf_Houses_SearchByName的结果（“ 1”，NULL，NULL，“ Krasnoyarsk”）</b> <br><br><img src="https://habrastorage.org/webt/bi/jm/as/bijmasrtluarib2trzq_f4m-jf8.png"><br><br><p> 其余参数的用途与地址生成元素（fstf_AddressObjects_SearchByName）的搜索功能的参数用途完全一致。 <br> 该函数的文本在应用程序部分“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">创建fstf_Houses_SearchByName函数</a> ”中给出 </p>  。 <br><h4> 如何运作 </h4><br><p>  <b>fstf_Houses_SearchByName</b>的实现在许多方面类似于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">地址生成元素（fstf_AddressObjects_SearchByName）</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">搜索</a>功能的实现。 主要区别在于搜索是在两个相关的表<b>fias_Houses</b>和<b>fias_AddressObjects中执行的</b> 。 </p><br><p> 该函数有9个参数。 其中的前三个是<b>门牌号</b> （ <b>a_HouseNum</b> ），建筑物<b>（a_BuildNum</b> ）和建筑物（ <b>a_StrucNum</b> ）。 其余6个（ <b>a_FormalName</b> ， <b>a_ShortName</b> ， <b>a_ParentFormalName</b> ， <b>a_ParentShortName</b> ， <b>a_GrandParentFormalName</b> ， <b>a_GrandParentShortName</b> ）与函数参数完全一致。 <br><br> 如果仅设置“门牌号”参数的值，则该函数将返回门牌号中指定序列与符号相遇的所有地址。 如果传递NULL或空字符串（“”）作为门牌号，则将返回其地址元素由一组其他参数指定的所有房子的地址。 <br><br><img src="https://habrastorage.org/webt/bo/sh/ht/boshhtjrbef92owia3wp2j2_6sm.png"><br><br></p><h3> 结语 </h3><br><p> 本节包含有关如何将FIAS房屋列表加载到<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">fias_Houses</a></b>表中的建议。 </p><br><p> 将数据加载到房屋表中的方式与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">将数据加载到地址形成元素表中的</a>方式几乎相同。 仅源文件将是<b>HOUSE99.DBF</b> ，而不是<b>ADDROB99.DBF</b> 。 这里的<b>99</b>是地区编号（共和国，州，地区）。 例如，对于克拉斯诺亚尔斯克地区，源文件是<b>HOUSE24.DBF</b>文件。 </p><br><p> 首先，从FIAS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">更新</a>页面下载具有更新的下一个存档。  <b>HOUSE99.DBF</b>文件是从中提取的<b>。</b> </p><p>  。 <br></p><p> 然后将<b>HOUSE99.DBF</b>文件转换为<b>CSV</b>格式并已转换，然后通过COPY语句将其加载到临时表<b>fias_Houses_Temp中</b> 。 </p><br><p> 最后，临时数据用于更新主表，即 添加了fias_Houses中不存在的内容，并替换了现有的内容。 <br>  “将<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FIAS房屋更新下载到fias_Houses表</a> ”部分中提供了用于更新房屋表的脚本示例。 </p><br><h3> 应用程式 </h3><br><a name="tfHousesAOT"></a><h3> 创建fstf_Houses_AddressObjectTree函数 </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关函数源代码的注释，请参见此处</a> 。 <br><br><div class="spoiler">  <b class="spoiler_title">功能码</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_AddressObjectTree(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   (  )   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_AddressObjectTree( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*    4: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 0 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1-50 - , ..  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 51 -  */</span></span> a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'2079-06-06'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_GUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ShortTypeName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_AddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseAOLevel <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">8</span></span>; c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StatusActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_StatusNotActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_MAXENDDATE <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>:=to_timestamp(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>); v_HouseActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HouseCurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************ --************************************************************ BEGIN RETURN QUERY SELECT * FROM fstf_AddressObjects_AddressObjectTree (a_AOGUID,a_CurrStatus); IF a_ENDDATE IS NULL THEN SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; ELSE v_ENDDATE:=a_ENDDATE; END IF; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM, v_ENDDATE,v_HouseCurrStatus h.HOUSENUM,h.BUILDNUM,h.STRUCNUM, h.ENDDATE,ah.HouseCurrStatus FROM fias_Houses h INNER JOIN (SELECT AOGUID,HOUSEGUID,ENDDATE, RANK() OVER (PARTITION BY AOGUID, HOUSEGUID ORDER BY ENDDATE ASC) AS HouseCurrStatus FROM fias_Houses insh WHERE insh.AOGUID=a_AOGUID AND insh.HOUSEGUID=a_HOUSEGUID) as ah ON h.AOGUID=ah.AOGUID AND h.HOUSEGUID=ah.HOUSEGUID AND h.ENDDATE=ah.ENDDATE WHERE h.ENDDATE=v_ENDDATE; v_HouseActStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN c_StatusActual ELSE c_StatusNotActual END; v_HouseCurrStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN 0 ELSE v_HouseCurrStatus END; IF v_HOUSENUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_HouseShortTypeName,v_HOUSENUM; END IF; IF v_BUILDNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_BuildShortTypeName,v_BUILDNUM; END IF; IF v_STRUCNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_StructShortTypeName,v_STRUCNUM; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_AOGUID VARCHAR(36), a_HOUSEGUID VARCHAR(36),a_CurrStatus INTEGER,a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP); /******************************************************************/ /*   (  )   */ /*      */ /******************************************************************/ CREATE OR REPLACE FUNCTION fstf_Houses_AddressObjectTree( a_HOUSEGUID VARCHAR(36),/*     */ a_ENDDATE TIMESTAMP default '2079-06-06'/*     */ ) RETURNS TABLE (rtf_GUID VARCHAR(36), rtf_CurrStatus INTEGER,rtf_ActStatus INTEGER, rtf_AOLevel INTEGER,rtf_ShortTypeName VARCHAR(10),rtf_AddressObjectName VARCHAR(100)) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); c_ActualStatusCode CONSTANT INTEGER :=1; /*      */ c_NotActualStatusCode CONSTANT INTEGER :=0; /*     */ v_AOGUID VARCHAR(36); /*   */ /*   */ v_CurrStatus INTEGER; /*    4: */ /* 0 - , */ /* 1-50 - , */ /* ..   , */ /*     */ /*     , */ /* 51 - */ v_Return_Error Integer :=0; /*   */ --******************************************************************* --******************************************************************* BEGIN SELECT INTO v_AOGUID,v_CurrStatus h.AOGUID, CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) ELSE 0 END FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=COALESCE(a_ENDDATE,c_MaxEndDate) ORDER BY h.ENDDATE DESC; RETURN QUERY SELECT * FROM fstf_Houses_AddressObjectTree( v_AOGUID,a_HOUSEGUID, v_CurrStatus,a_ENDDATE); END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM fstf_Houses_AddressObjectTree('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel; SELECT * FROM fstf_Houses_AddressObjectTree('42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel;</span></span></code> </pre><br></div></div><br><a name="fnHousesTAN"></a><br><h3> 创建fsfn_Houses_TreeActualName函数 </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关函数源代码的注释，请参见此处</a> 。 <br><div class="spoiler">  <b class="spoiler_title">功能码</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fsfn_Houses_TreeActualName(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fsfn_Houses_TreeActualName( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'{TP,LM,LP,ST,HS,BY,BG}'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseMaskArray <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">3</span></span>]:=<span class="hljs-string"><span class="hljs-string">'{HS,BY,BG}'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_HouseNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{HS}'</span></span>; c_BodyNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BY}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_BuildingNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BG}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TreeAddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************* --******************************************************* BEGIN v_TreeAddressObjectName:=fsfn_AddressObjects_TreeActualName (a_AOGUID,a_MaskArray); SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM HOUSENUM, BUILDNUM,STRUCNUM FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID AND ENDDATE=v_ENDDATE; IF c_HouseNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_HOUSENUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' ||c_HouseShortTypeName||' '||v_HOUSENUM END; END IF; IF c_BodyNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_BUILDNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_BuildShortTypeName||' '||v_BUILDNUM END; END IF; IF c_BuildingNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_STRUCNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_StructShortTypeName||' '||v_STRUCNUM END; END IF; RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_AOGUID VARCHAR(36),a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) CASCADE; /*****************************************************************/ /*           */ /*****************************************************************/ CREATE OR REPLACE FUNCTION fsfn_Houses_TreeActualName( a_HOUSEGUID VARCHAR(36), /*     */ a_MaskArray VARCHAR(2)[10] default '{TP,LM,LP,ST,HS,BY,BG}' /*  ,   */ /*    */ ) RETURNS VARCHAR(1000) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); v_AOGUID VARCHAR(36); /*    */ v_TreeAddressObjectName VARCHAR(1000); /*     */ v_Return_Error Integer :=0; /*   */ --********************************************************** --********************************************************** BEGIN SELECT INTO v_AOGUID h.AOGUID FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=c_MaxEndDate ORDER BY h.ENDDATE DESC; v_TreeAddressObjectName:=fsfn_Houses_TreeActualName (v_AOGUID,a_HOUSEGUID,a_MaskArray); RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT fsfn_Houses_TreeActualName('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254'); SELECT fsfn_Houses_TreeActualName('42301ab8-9ead-4f8e-8281-e64f2769a254');</span></span></code> </pre><br></div></div><br><a name="tfHousesSBN"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建fstf_Houses_SearchByName函数 </font></font></h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关函数源代码的注释，请参见此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能码</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_SearchByName(a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_SearchByName( a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_HousesFullName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>),rtf_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_EndDate <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>,rtf_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),rtf_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_BlankChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">' '</span></span>; v_HouseNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_BuildNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_StrucNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_GrandParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_GrandParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*************************************************************** --*************************************************************** BEGIN v_ShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_FormalNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_FormalName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_HouseNumTemplate:= CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END || CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END; v_HouseNumTemplate:=v_HouseNumTemplate||c_WildChar; v_HouseNumTemplate:=CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_BuildNumTemplate:=CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_StrucNumTemplate:=CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END||c_WildChar; IF a_FormalName IS NOT NULL AND a_ParentFormalName IS NULL AND a_ParentShortName IS NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSIF a_FormalName IS NOT NULL AND a_ParentFormalName IS NOT NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN v_ParentShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_ParentFormalNameTemplate:=UPPER(c_WildChar ||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus, cfa.Actstatus,pfa.ShortName,pfa.FORMALNAME, NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum,TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum,TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSE v_GrandParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_GrandParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_GrandParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar ||REPLACE(TRIM(a_GrandParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_ParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_ParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; END IF; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_SearchByName(a_HouseNum VARCHAR(20),a_BuildNum VARCHAR(10),a_StrucNum VARCHAR(10),a_FormalName VARCHAR(150),a_ShortName VARCHAR(20),a_ParentFormalName VARCHAR(150),a_ParentShortName VARCHAR(20), a_GrandParentFormalName VARCHAR(150),a_GrandParentShortName VARCHAR(20)) IS '            '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; --SELECT * FROM fstf_Houses_SearchByName('220'); --SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,'220'); SELECT * FROM fstf_Houses_SearchByName('1',NULL,NULL,''); SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,NULL,'','','',NULL,'');</span></span></code> </pre><br></div></div><br><a name="HousesCreate"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建FIAS房屋表fias_Houses </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本代码</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses( HOUSEID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, POSTALCODE <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKATO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKTMO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ESTSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STATSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STARTDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, UPDATEDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, NORMDOC <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, COUNTER <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, CADNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, DIVTYPE <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_Houses <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> ( HOUSEID )) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE1fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE2fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE3fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID,HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE4fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM,BUILDNUM,STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE5fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE6fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(BUILDNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE7fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'HOUSE         ,     .'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'      (, ,    ..)'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.BUILDNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.POSTALCODE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKATO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKTMO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ESTSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STATSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.UPDATEDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  () '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.NORMDOC <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.COUNTER <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'     4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.CADNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.DIVTYPE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' : 0 –   1 –  2 – '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus( EstateStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (EstateStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 –  ,1 – ,2 – ,3 – '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus( StructureStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (StructureStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 –  ,1 – ,2 – ,3 – '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACk TRANSACTION; COMMIT TRANSACTION;</span></span></code> </pre><br></div></div><br><a name="HousesFilling"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将FIAS主页更新下载到fias_Houses表 </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本源代码</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">BEGIN</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_Houses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_DeletedHouses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_EstateStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_StructureStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_EstateStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_EstateStatus_temp(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\ESTSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* " "     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_EstateStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> EstateStatusNAME=t.EstateStatusNAME, EstateStatusShortName=t.EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.EstateStatusID=t.EstateStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.EstateStatusID=s.EstateStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_EstateStatus(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> EstateStatusID,EstateStatusNAME,EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.EstateStatusID=os.EstateStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_StructureStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_StructureStatus_temp(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\STRSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_StructureStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> StructureStatusNAME=t.StructureStatusNAME, StructureStatusShortName=t.StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.StructureStatusID=t.StructureStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.StructureStatusID=s.StructureStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_StructureStatus(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> StructureStatusID,StructureStatusNAME,StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.StructureStatusID=os.StructureStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_Houses_temp     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/**********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_Houses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\HOUSE24_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_DeletedHouses_temp , */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  DHOUSE24      . */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*         */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* COPY fias_DeletedHouses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) FROM 'W:\Projects\Enisey GIS\DB\SourceData\DHOUSE24_20180827.csv' WITH (FORMAT csv,DELIMITER ';', ENCODING 'UTF8'); */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> AOGUID=t.AOGUID, BUILDNUM=t.BUILDNUM, ENDDATE=t.ENDDATE, ESTSTATUS=t.ESTSTATUS, HOUSEGUID=t.HOUSEGUID, HOUSENUM=t.HOUSENUM, STATSTATUS=t.STATSTATUS, IFNSFL=t.IFNSFL, IFNSUL=t.IFNSUL, OKATO=t.OKATO, OKTMO=t.OKTMO, POSTALCODE=t.POSTALCODE, STARTDATE=t.STARTDATE, STRUCNUM=t.STRUCNUM, STRSTATUS=t.STRSTATUS, TERRIFNSFL=t.TERRIFNSFL, TERRIFNSUL=t.TERRIFNSUL, UPDATEDATE=t.UPDATEDATE, NORMDOC=t.NORMDOC, COUNTER=t.COUNTER, CADNUM=t.CADNUM, DIVTYPE=t.DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses dh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> t.HOUSEID=dh.HOUSEID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> h.HOUSEID=dh.HOUSEID; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* fias_DeletedHouses_temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp delh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> delh.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  fias_Houses,  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    fias_Houses_Temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_Houses(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql">; $$</span><span class="undefined"></span></span><span class="hljs-keyword"><span class="pgsql"><span class="undefined"></span></span><span class="hljs-keyword">LANGUAGE</span></span> plpgsql; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT (SELECT COUNT(*) FROM fias_Houses) AS HouseCount, (SELECT COUNT(*) FROM fias_EstateStatus) AS EStatusCount, (SELECT COUNT(*) FROM fias_StructureStatus) AS SStatusCount;</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425287/">https://habr.com/ru/post/zh-CN425287/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425275/index.html">扩展Node.js的12条技巧</a></li>
<li><a href="../zh-CN425279/index.html">如何面试Google：成为什么样，不该成为什么样</a></li>
<li><a href="../zh-CN425281/index.html">“使”流行的中国迷你路由器Hame A15（也称为“无品牌A5-V11”）克隆的准则</a></li>
<li><a href="../zh-CN425283/index.html">无限的本地化，或者我们如何实时翻译地图</a></li>
<li><a href="../zh-CN425285/index.html">如果您不雇用琼斯，那您就不配得到领主</a></li>
<li><a href="../zh-CN425289/index.html">公司重点</a></li>
<li><a href="../zh-CN425291/index.html">2018年夏季实习的结果：他们席卷了五百个皮塔饼沙瓦玛。 并幸存下来</a></li>
<li><a href="../zh-CN425293/index.html">移动中档开发人员的理想（可能）采访</a></li>
<li><a href="../zh-CN425295/index.html">KotlinConf 2018 Live-我们正在直播</a></li>
<li><a href="../zh-CN425297/index.html">三款运动耳机或我对骨骼传导的热爱</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>