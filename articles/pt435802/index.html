<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèº ü§æüèø üèñÔ∏è OpenVPN, sobre o qual voc√™ sabia t√£o pouco üëñ üí≠ üßòüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OpenVPN, quanto nesta palavra. Um servidor VPN de c√≥digo aberto gratuito, com v√°rias plataformas, configur√°vel de maneira flex√≠vel e flex√≠vel, que na ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenVPN, sobre o qual voc√™ sabia t√£o pouco</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435802/"><p>  OpenVPN, quanto nesta palavra.  Um servidor VPN de c√≥digo aberto gratuito, com v√°rias plataformas, configur√°vel de maneira flex√≠vel e flex√≠vel, que na verdade √© o padr√£o padr√£o para organizar o acesso a redes corporativas internas.  A maioria dos administradores o usa com configura√ß√µes padr√£o ou com configura√ß√µes t√≠picas amplamente descritas em diferentes HOW-TOs.  Mas o OpenVPN √© t√£o simples quanto parece √† primeira vista?  Neste artigo, consideraremos os mecanismos internos do OpenVPN, ocultos aos olhos, que alteram drasticamente a ideia de suas capacidades. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O</a> servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenVPN</a> √© distribu√≠do na forma de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo-fonte</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pacotes compilados</a> prontos para instalar para v√°rios sistemas operacionais.  O OpenSSL √© usado como uma biblioteca que fornece criptografia. </p><br><p>  A maioria das configura√ß√µes para conectar clientes ao servidor, bem como entre servidores, envolve o uso de v√°rias chaves privadas ou privadas / p√∫blicas para garantir a seguran√ßa do tr√°fego interno.  Para redes corporativas no modo MultiPoint-para-SinglePoint, geralmente √© usada uma autoridade de certifica√ß√£o PKI, f√°cil de construir usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">easy-rsa</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XCA</a> .  Para comunica√ß√£o entre servidores ponto a ponto, uma configura√ß√£o de chave compartilhada √© usada principalmente.  Lembre-se dos mecanismos e recursos b√°sicos e conhecidos. </p><br><h1 id="osnovnye-mehanizmy-i-vozmozhnosti">  Principais mecanismos e capacidades </h1><br><ul><li><h3 id="sertifikatnaya-autentifikaciya">  Autentica√ß√£o de certificado </h3><br><p>  Uma enorme quantidade de documenta√ß√£o foi escrita sobre isso.  O ponto √© simples.  Est√° sendo criada uma autoridade de certifica√ß√£o que emite certificados de usu√°rio.  Com a ajuda de uma autoridade de certifica√ß√£o, √© fornecido controle para conectar usu√°rios ao servidor OpenVPN.  Quando o certificado expira ou √© revogado, o acesso do usu√°rio √© bloqueado.  As chaves privadas com uma senha definida nelas, emitida em conjunto com o certificado, fornecem seguran√ßa contra conex√µes n√£o autorizadas a recursos internos. </p><br></li><li><h3 id="privatnye-point-to-point-klyuchi">  Chaves ponto a ponto privadas </h3><br><p>  Do ponto de vista de conectar apenas um usu√°rio / servidor aos recursos da empresa, um esquema com chaves privadas √© usado.  Uma chave √© gerada em um dos hosts, que √© compartilhado entre o servidor e o cliente. </p><br></li></ul><br><p>  Em todos os casos de conex√£o para seguran√ßa do handshake "handshake" entre o cliente e o servidor, o protocolo Diffie-Hellmann √© usado. </p><br><ul><li><h3 id="vneshnyaya-autentifikaciya-polzovateley">  Autentica√ß√£o de usu√°rio externo </h3><br><p>  Para simplificar o controle sobre as conex√µes do usu√°rio, em vez de um esquema com sua pr√≥pria PKI, voc√™ pode usar um esquema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com autentica√ß√£o de usu√°rio externo por login / senha</a> .  Esse esquema √© conveniente para autenticar usu√°rios por, digamos, um login / senha de dom√≠nio.  Para conectar-se ao servidor, o certificado do servidor e a chave de assinatura do pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HARDENING OPENVPN SECURITY</a> s√£o adicionados ao arquivo de configura√ß√£o do cliente. <br>  exemplo de configura√ß√£o do cliente </p><br><pre><code class="plaintext hljs">dev tun proto udp #  IP  OpenVPN remote 172.16.111.166 # Port  port 1200 client resolv-retry infinite tls-client key-direction 1 auth SHA1 cipher BF-CBC #comp-lzo persist-key persist-tun # auth-user-pass c:/temp/pass.txt # # just create a file with name pass.txt # and put to it two lines # ------------- #username #password # ------------- #auth-user-pass verb 3 &lt;ca&gt; -----BEGIN CERTIFICATE----- MIIE5jCCA86gAwIBAgIJAOt3kFH7PxA0MA0GCSqGSIb3DQEBCwUAMIGjMQswCQYD .... -----END CERTIFICATE----- &lt;/ca&gt; &lt;tls-auth&gt; -----BEGIN OpenVPN Static key V1----- 83ddd29fa82212f3059d85a41490134c .... a4f2c7df3a22364a49093bca102dedeb -----END OpenVPN Static key V1----- &lt;/tls-auth&gt;</code> </pre> <br><p>  Parte da configura√ß√£o do servidor para autentica√ß√£o do cliente via arquivo <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando m√©todos de autentica√ß√£o alternativos</a> </p><br><pre> <code class="plaintext hljs">verify-client-cert none #client-cert-not-required username-as-common-name tls-server tls-auth /usr/local/etc/openvpn/ssl/tlsauth.key key-direction 0 tls-timeout 120 auth SHA1 cipher BF-CBC auth-user-pass-verify /usr/local/etc/openvpn/auth/auth-static-file.pl via-file</code> </pre> <br><p>  Esse esquema √© conveniente, mas muito inseguro. </p><br></li><li><h3 id="pam">  PAM </h3><br><p>  Para aumentar a seguran√ßa, voc√™ pode usar plug-ins que fornecem verifica√ß√£o de login / senha em sistemas externos.  O m√©todo mais comum √© o PAM do sistema (M√≥dulos de autentica√ß√£o conect√°veis). <br>  Adicione a linha ao arquivo de configura√ß√£o OpenVPN </p><br><pre> <code class="plaintext hljs">plugin /usr/share/openvpn/plugin/lib/openvpn-auth-pam.so login</code> </pre> <br></li><li><h3 id="marshrutizaciya">  Encaminhamento </h3><br><p>  Porque  A principal tarefa do servidor √© fornecer aos usu√°rios / servidores remotos acesso a recursos internos; o servidor permite determinar o roteamento est√°tico dos clientes para o servidor e do servidor para os clientes.  Do ponto de vista do acesso do cliente aos recursos internos, o servidor que usa DHCP e as diretivas "rota" ou "rota de envio" permitem transferir rotas de rede internas para o cliente.  Para notificar o pr√≥prio servidor sobre redes remotas no lado do cliente, √© usado "dir de configura√ß√£o do cliente" (ccd), um mecanismo que permite usar a diretiva "iroute" para descrever a lista de redes internas do cliente que devem estar na tabela de roteamento do servidor para trafegar o tr√°fego para elas. </p><br></li></ul><br><p>  Nesse recurso "comum", amplamente utilizado, termina a personaliza√ß√£o local e final para cada caso espec√≠fico. </p><br><h1 id="dopolnitelnye-vozmozhnosti-openvpn">  Recursos adicionais do OpenVPN </h1><br><p>  Considere os recursos adicionais do OpenVPN, dos quais algu√©m j√° deve ter ouvido falar, mas, na realidade, n√£o viu ou usou. </p><br><ul><li><h3 id="bezopasnost-seteypacket-filtering">  Seguran√ßa de rede / filtragem de pacotes </h3><br><p>  Porque  O OpenVPN direciona o tr√°fego, possui dois modos de opera√ß√£o regulares mutuamente exclusivos.  O primeiro modo √© o roteamento dentro do servidor OpenVPN, o segundo modo √© o roteamento nuclear entre interfaces.  No primeiro caso, o OpenVPN √© respons√°vel por alternar e filtrar pacotes entre clientes / redes; no segundo caso, qualquer filtro de pacote do sistema suportado no host (pf, iptables, etc). <br>  Poucas pessoas sabem que o OpenVPN possui um filtro de pacotes interno que permite permitir ou isolar conex√µes entre usu√°rios e redes. <br>  Sim sim  Voc√™ leu certo.  O OpenVPN possui seu pr√≥prio filtro de pacotes embutido.  A capacidade de filtrar o tr√°fego foi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementada em 2010</a> . <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O filtro de pacotes OpenVPN √©</a> controlado pela interface de gerenciamento ou por plug-ins conectados ao OpenVPN. <br>  As regras de tr√°fego s√£o gerenciadas atrav√©s de um arquivo.  O formato do arquivo √© simples. </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP|ACCEPT] {+|-}common_name1 {+|-}common_name2 . . . [SUBNETS DROP|ACCEPT] {+|-}subnet1 {+|-}subnet2 . . . [END]</code> </pre> <br><p>  As diretivas de bloco (ACCEPT / DENY) definem a a√ß√£o padr√£o para todos os clientes n√£o especificados dentro do bloco. <br>  Por exemplo, arquivo para o usu√°rio user2 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 [SUBNETS DROP] [END]</code> </pre> <br><p>  bloquear√° o tr√°fego para todos os usu√°rios e redes, mas permitir√° o tr√°fego para o cliente1.  Se o usu√°rio1 n√£o descrever explicitamente a permiss√£o para transferir tr√°fego para o usu√°rio2, o tr√°fego seguir√° apenas em uma dire√ß√£o user2-&gt; user1. </p><br></li></ul><br><p>  Ou outro exemplo. <br>  Desative tudo, exceto o acesso entre usu√°rios e o servidor DNS localizado na rede local e o circuito de teste na rede 192.168.0.0/24 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 +user2 [SUBNETS DROP] +10.150.0.1 +10.150.1.1 +192.168.0.0/24 [END]</code> </pre> <br><p>  O mecanismo de filtragem √© ativado por meio do arquivo de configura√ß√£o ou ao conectar o plug-in que "define" o sinalizador "OPENVPN_PLUGIN_ENABLE_PF". <br>  Discutiremos essa oportunidade mais tarde. <br>  O segundo modo de filtragem de tr√°fego √© o filtro de pacotes embutido no sistema.  Para ativ√°-lo, a configura√ß√£o n√£o deve ter uma diretiva "cliente para cliente".  Do ponto de vista da automa√ß√£o da ativa√ß√£o / desativa√ß√£o das regras necess√°rias ao conectar / desconectar clientes, √© mais conveniente usar inser√ß√µes separadas na lista de regras, implementadas por meio de CHAINS in Iptables (Linux) ou em Anchors in PF (FreeBSD).  A ativa√ß√£o / desativa√ß√£o de regras geralmente √© feita por meio das diretivas de conex√£o / desconex√£o do cliente no arquivo de configura√ß√£o do servidor, que chamam os scripts correspondentes quando o usu√°rio se conecta / desconecta. </p><br><ul><li><h3 id="rasshirennaya-pam-autentifikaciya">  Autentica√ß√£o avan√ßada de PAM </h3><br><p>  A autentica√ß√£o estendida do PAM significa alterar a l√≥gica do login do usu√°rio e da verifica√ß√£o de senha.  Isso √© obtido instalando os plug-ins apropriados para o OpenVPN, que fornecem leitura e verifica√ß√£o de dados em fontes externas, ou conectando bibliotecas ao sistema que permitem que qualquer l√≥gica seja script.  Uma dessas bibliotecas √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pam_python</a> , que ajuda a criar scripts para qualquer l√≥gica de verifica√ß√£o de login / senha por meio de scripts Python. <br>  Se for usada, a sequ√™ncia de verifica√ß√£o do usu√°rio ser√° alterada da seguinte maneira. </p><br><pre> <code class="plaintext hljs">plugin openvpn-plugin-auth-pam.so pam_python login USERNAME password PASSWORD domain mydomain.com</code> </pre> <br><p>  Como o ‚Äúunder the hood‚Äù do PAM s√£o os algoritmos de di√°logo do sistema com o usu√°rio ou as bibliotecas externas, esses di√°logos podem ser controlados.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conecte tokens OTP ao sistema</a> .  A biblioteca LinOTP √© tomada simplesmente como exemplo, porque  Perdi minha pr√≥pria biblioteca auto-escrita durante os testes em algum lugar ¬Ø \ <em>(„ÉÑ)</em> / ¬Ø <br>  Al√©m disso, os exemplos s√£o facilmente pesquisados ‚Äã‚Äãpela palavra "pam_python". <br>  O principal problema ao trabalhar com m√≥dulos PAM externos √© a incapacidade de obter o ambiente de sess√£o do OpenVPN dentro do Python chamado ou qualquer outro script chamado atrav√©s do pam do sistema.  I.e.  o script fornece apenas as fun√ß√µes para verificar o login / senha atribu√≠dos a ele. </p><br></li><li><h3 id="otlozhennaya-autentifikaciya">  Autentica√ß√£o Adiada </h3><br><p>  O servidor OpenVPN suporta a chamada autentica√ß√£o "atrasada".  A autentica√ß√£o "atrasada" √© usada nos casos em que o servi√ßo de autentica√ß√£o n√£o pode atender √† solicita√ß√£o de verifica√ß√£o de login / senha em tempo real. </p><br></li><li><h3 id="plaginy-openvpn">  Plugins OpenVPN </h3><br><p>  Este √© um universo paralelo separado, sobre o qual pode ser conhecido, mas, devido a alguma confus√£o, eles n√£o conseguem ou t√™m medo de usar.  De fato, escrever um plug-in funcional para o OpenVPN requer programa√ß√£o em C com tudo o que isso implica.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Exemplos de plugins simples est√£o inclu√≠dos na √°rvore de c√≥digo-fonte do OpenVPN</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">,</a> por exemplo, existe um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in para demonstrar as chamadas de m√©todo do OpenVPN</a> . </p><br></li></ul><br><p>  Vamos tentar descobrir como os plugins funcionam no OpenVPN. <br>  Fun√ß√µes e par√¢metros usados ‚Äã‚Äãpara trabalhar com plugins s√£o descritos em um <a href="">arquivo</a> separado <br>  A principal tarefa do plug-in, quando √© inicializada pelo servidor OpenVPN, √© transferir a lista de fun√ß√µes suportadas pelo plug-in e, ao chamar qualquer uma das fun√ß√µes, retornar o c√≥digo de resposta correto, que ficar√° claro para o servidor. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  Vamos nos aprofundar mais em cada grupo.  Vamos considerar a l√≥gica do trabalho com base na autentica√ß√£o de senha do usu√°rio. <br>  Quando o servidor inicia, ap√≥s a leitura do arquivo de configura√ß√£o, o servidor chama as fun√ß√µes OPENVPN_PLUGIN_UP e OPENVPN_PLUGIN_ROUTE_UP.  No ambiente vari√°vel das fun√ß√µes chamadas, os principais par√¢metros do servidor em execu√ß√£o s√£o transferidos. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><pre> <code class="json hljs">OPENVPN_PLUGIN_ROUTE_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Essas fun√ß√µes podem ser usadas para alertas na inicializa√ß√£o do servidor ou altera√ß√µes na configura√ß√£o. <br>  Ao conectar um cliente, o OpenVPN solicita a capacidade de ativar um filtro de pacotes interno. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_ENABLE_PF { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Como voc√™ pode ver no dump, a vari√°vel pf_file apareceu.  Este arquivo deve conter as regras do filtro de pacotes interno para a sess√£o atual que est√° sendo processada. <br>  Em seguida, o nome de usu√°rio e a senha do usu√°rio s√£o verificados na fun√ß√£o OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"12312312312312"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Este √© o √∫nico local em que a senha no ambiente vari√°vel est√° presente de forma clara. <br>  O resultado desta fun√ß√£o deve ser tr√™s respostas poss√≠veis. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  Se o servidor receber uma resposta OPENVPN_PLUGIN_FUNC_DEFERRED, o mecanismo de autentica√ß√£o "atrasada" entra em opera√ß√£o.  Como vemos, a vari√°vel "auth_control_file" apareceu no ambiente da vari√°vel, o conte√∫do dessa vari√°vel cont√©m o nome do arquivo no qual uma resposta do sistema de autentica√ß√£o ser√° esperada.  A resposta √© o s√≠mbolo 0 (para permitir acesso), 1 (para negar acesso) colocado no arquivo especificado.  O par√¢metro do servidor "janela manual" determina o tempo limite em segundos, durante os quais o servidor aguardar√° uma resposta.  Enquanto aguarda, o tr√°fego de outros clientes n√£o √© interrompido. </p><br><p>  Como trabalhamos com autentica√ß√£o de senha, a fun√ß√£o de verifica√ß√£o de certificado OPENVPN_PLUGIN_TLS_VERIFY n√£o √© chamada.  Em vez disso, OPENVPN_PLUGIN_TLS_FINAL √© chamado imediatamente, confirmando o estabelecimento da sess√£o. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_TLS_FINAL { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Em seguida, √© chamada a chamada OPENVPN_PLUGIN_IPCHANGE, que √© chamada antes de alterar o endere√ßo IP do cliente. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_IPCHANGE { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  A fun√ß√£o OPENVPN_PLUGIN_CLIENT_CONNECT_V2 √© chamada quando o endere√ßo IP √© definido pelo servidor DHCP interno. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_CONNECT_V<span class="hljs-number"><span class="hljs-number">2</span></span> { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Em um ambiente vari√°vel, as vari√°veis ‚Äã‚Äãaparecem contendo os par√¢metros do t√∫nel "ifconfig_pool_local_ip" e "ifconfig_pool_remote_ip". </p><br><p>  A fun√ß√£o OPENVPN_PLUGIN_LEARN_ADDRESS √© chamada quando o servidor OpenVPN aprende a conex√£o de endere√ßos IP e as rotas para eles.  Depois de sair dessa fun√ß√£o, o procedimento para aplicar as configura√ß√µes do filtro de pacotes do arquivo √© ativado.  A vari√°vel de ambiente OPENVPN_PLUGIN_LEARN_ADDRESS nesse caso corresponde √† fase OPENVPN_PLUGIN_CLIENT_CONNECT_V2. </p><br><pre> <code class="plaintext hljs">fa56bf61-.../172.16.111.168:1200 ----- pf_check_reload : struct pf_context ----- fa56bf61-.../172.16.111.168:1200 enabled=1 fa56bf61-.../172.16.111.168:1200 filename='/tmp/openvpn_pf_343330698e4acdea34c8a8c7fb87d861.tmp' fa56bf61-.../172.16.111.168:1200 file_last_mod=1547319124 fa56bf61-.../172.16.111.168:1200 n_check_reload=1 fa56bf61-.../172.16.111.168:1200 reload=[1,15,1547319125] fa56bf61-.../172.16.111.168:1200 ----- struct pf_set ----- fa56bf61-.../172.16.111.168:1200 kill=0 fa56bf61-.../172.16.111.168:1200 ----- struct pf_subnet_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=ACCEPT fa56bf61-.../172.16.111.168:1200 ----- struct pf_cn_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=DROP fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 ---------- fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 --------------------</code> </pre> <br><p>  Quando um cliente √© desconectado, a fun√ß√£o OPENVPN_PLUGIN_CLIENT_DISCONNECT √© chamada. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_DISCONNECT { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_received"</span></span>:<span class="hljs-string"><span class="hljs-string">"30893"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_4bdddbada2885cde42cd3cb1b85d77e5.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_duration"</span></span>:<span class="hljs-string"><span class="hljs-string">"3781"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_sent"</span></span>:<span class="hljs-string"><span class="hljs-string">"22684"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Em um ambiente vari√°vel, a dura√ß√£o da conex√£o e o tr√°fego do usu√°rio s√£o adicionados. </p><br><p>  Como voc√™ pode ver, devido √† abund√¢ncia de dados em diferentes chamadas, escrever e depurar um plug-in na linguagem de programa√ß√£o C (C ++) ser√° uma tarefa bastante demorada. <br>  Para expandir a funcionalidade, decidiu-se fazer um "milagre" primeiro para o projeto interno e depois public√°-lo :) <br>  Ap√≥s uma longa leitura dos c√≥digos fonte do OpenVPN e v√°rios exemplos de plugins altamente especializados, foi criado um projeto que usa o Python como a linguagem de programa√ß√£o para a l√≥gica de processamento da sess√£o.  O c√≥digo √© um plug-in na linguagem C que se conecta ao OpenVPN, que envia todas as solicita√ß√µes ao plug-in, envia o m√≥dulo para Python atrav√©s da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">refer√™ncia c-api</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenVPN plugin proxy python</a> </p><br><h2 id="pochemu-python-modul-">  Por que o m√≥dulo Python? </h2><br><p>  A refer√™ncia c-api do Python, trabalhando diretamente com arquivos python, n√£o funciona corretamente com o carregamento de bibliotecas python. </p><br><h2 id="kak-eto-rabotaet-">  Como isso funciona? </h2><br><p>  Quando o plugin √© inicializado no OpenVPN, ele retorna uma lista mascarada de todas as fun√ß√µes que ele pode servir.  Quando a pr√≥xima fase da conex√£o ou evento interno ocorrer, o OpenVPN chama as fun√ß√µes correspondentes do plug-in.  O plug-in converte a vari√°vel de ambiente e os par√¢metros passados ‚Äã‚Äãpara a fun√ß√£o em uma estrutura, inicializa o python e passa a estrutura para o procedimento correspondente do m√≥dulo python.  O procedimento retorna uma das tr√™s respostas ao plug-in (0 - Sucesso, 1 - Erro, 2 - Adiado).  A resposta √© transformada e retornada pelo OpenVPN. </p><br><p>  Observe que todas as chamadas do m√≥dulo s√£o "sem estado", o que significa que os procedimentos n√£o se lembram e n√£o sabem o que aconteceu anteriormente em outras chamadas.  Voc√™ pode focar apenas no ambiente vari√°vel passado para o plug-in do OpenVPN. </p><br><p>  Dentro do m√≥dulo python, voc√™ pode implementar qualquer l√≥gica conectando as bibliotecas e os recursos necess√°rios.  Se voc√™ n√£o tiver certeza da velocidade das verifica√ß√µes, use as confirma√ß√µes "pendentes". </p><br><p>  Usando o agrupamento de usu√°rios conectados ao servi√ßo, atrav√©s do pf_file, voc√™ pode ajustar bastante a intera√ß√£o da rede entre usu√°rios e outros recursos.  Por sua vez, conectando o plug-in para monitoramento, sempre ser√° poss√≠vel gerenciar sess√µes do cliente por meio da interface de gerenciamento OpenVPN. </p><br><p>  Durante o teste do projeto, um mecanismo de gera√ß√£o de senha foi desenvolvido, semelhante aos tokens jwt, mas com um tamanho menor. </p><br><p>  O ponto √© simples.  O token cont√©m o identificador do cliente e a data de validade do acesso.  Para assinar o token, √© utilizado o HMAC_SHA1 com uma chave privada.  Ap√≥s a assinatura do token, o conte√∫do do texto √© corrompido pela assinatura e convertido em base64.  Assim, a "veda√ß√£o" do token √© obtida.  Um token selado √© usado como senha do usu√°rio.  Se ocorrer uma altera√ß√£o n√£o autorizada de um bloco de dados, xor interrompe, se xor interrompe, a verifica√ß√£o de assinatura √© interrompida.  Sem uma chave privada, a assinatura n√£o pode ser alterada. </p><br><p>  Se voc√™ n√£o deseja controlar manualmente o hor√°rio da senha, gere esse token e verifique a validade dentro do plug-in sem chamar servi√ßos externos.  Esse esquema √© muito conveniente para a gera√ß√£o de senha da sess√£o por um determinado per√≠odo.  Ao mesmo tempo, voc√™ pode transferir o conte√∫do do token para um sistema de controle externo e ele se configurar√° para desconectar o usu√°rio ap√≥s a expira√ß√£o do token. </p><br><p>  Espero que as informa√ß√µes neste artigo tenham sido √∫teis para voc√™. <br>  Obrigado por reservar um tempo para l√™-lo. <br>  Se voc√™ tiver alguma d√∫vida, tentarei responder o que puder. </p><br><p>  ¬© Aborche 2019 <br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/e49/ede/7c5e49ede95e47e91424dbb9bafbb7bb.jpg" alt="Aborche"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435802/">https://habr.com/ru/post/pt435802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435792/index.html">Esses caras t√≥xicos: envenenam projetos</a></li>
<li><a href="../pt435794/index.html">‚ÄúPor que voc√™ precisa se fingir rapidamente‚Äù: Steve Cotton, da Bungie, sobre o processo criativo da empresa</a></li>
<li><a href="../pt435796/index.html">Sobre como mudei de C # para Elixir / Phoenix</a></li>
<li><a href="../pt435798/index.html">Sony WH-1000XM3 - os melhores fones de ouvido sem fio?</a></li>
<li><a href="../pt435800/index.html">Carta dezembrista 11</a></li>
<li><a href="../pt435804/index.html">O Intel Cyclone n√£o salva a configura√ß√£o ap√≥s a reinicializa√ß√£o</a></li>
<li><a href="../pt435806/index.html">An√°lises cl√≠nicas de retalhos de bioengenharia no cora√ß√£o anunciadas no Jap√£o</a></li>
<li><a href="../pt435810/index.html">JOIN cole√ß√£o local e DbSet no Entity Framework</a></li>
<li><a href="../pt435812/index.html">Teoria da felicidade. A estat√≠stica como forma cient√≠fica de n√£o saber nada</a></li>
<li><a href="../pt435814/index.html">[The Old New Thing] Posso usar minha pilha como quiser?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>