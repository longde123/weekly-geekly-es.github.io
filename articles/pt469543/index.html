<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÅ üéÉ üë©‚Äçüë©‚Äçüëß Redis Scaling e Failover para Servi√ßos DirectumRX üíÇüèº ü§æüèº üíö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Redis √© um sistema de gerenciamento de banco de dados da classe NoSQL (DBMSs n√£o relacionais) colocado inteiramente na RAM. Para acessar os dados, √© u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Redis Scaling e Failover para Servi√ßos DirectumRX</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/469543/">  Redis √© um sistema de gerenciamento de banco de dados da classe NoSQL (DBMSs n√£o relacionais) colocado inteiramente na RAM.  Para acessar os dados, √© usado o modelo ‚Äúchave‚Äù - ‚Äúvalor‚Äù.  Esse DBMS √© frequentemente usado para armazenar caches em servi√ßos escalon√°veis, para armazenar imagens e dados pequenos. <br><br>  O Redis DBMS √© amplamente utilizado devido a: <br><br><ul><li>  alta velocidade, porque  todos os dados s√£o armazenados na RAM; </li><li>  multiplataforma; </li><li>  distribui√ß√£o sob a licen√ßa BSD (aplica-se ao software de c√≥digo aberto). </li></ul><br>  A amplitude da distribui√ß√£o e aplicabilidade do Redis pode ser estimada pela enorme quantidade de documenta√ß√£o com todos os tipos de casos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site oficial do projeto</a> . <br><br>  Se voc√™ usar o dimensionamento horizontal dos servi√ßos DirectumRX, dever√° usar a instala√ß√£o √† prova de falhas do Redis para funcionar corretamente com o servi√ßo de armazenamento DirectumRX e o servi√ßo de acesso √† web DirectumRX. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/740/12b/060/74012b060e74628af35c33d4fa96b3bb.jpg" alt="imagem"><br><br>  O Redis armazenar√° dados operacionais, caches e outras informa√ß√µes necess√°rias para a opera√ß√£o dos servi√ßos no modo de escala, para que o processo de intera√ß√£o do usu√°rio com o sistema n√£o dependa da instala√ß√£o com a qual ele est√° trabalhando atualmente. <br><br>  O Redis n√£o armazenar√° dados confidenciais e n√£o estar√° sob carga pesada.  Por√©m, no caso de uma falha do Redis, os usu√°rios sofrer√£o muitos erros ao alternar entre instala√ß√µes. <br><br>  No site oficial da Redis, existem duas maneiras de garantir escala horizontal e toler√¢ncia a falhas: <br><br><ol><li>  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redis Sentiel</a> . </li><li>  Usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redis Cluster</a> . </li></ol><br>  Considere personalizar essas op√ß√µes. <br><br><h2>  Configurar Redis Sentiel </h2><br>  A op√ß√£o usando o Redis Sentiel (Redis Tracking Node) foi implementada no Redis 2.4 e consiste em usar o servi√ßo Redis Sentiel adicional para monitorar a disponibilidade do assistente.  Ele tamb√©m executa a configura√ß√£o de n√≥s de r√©plica em caso de falha do assistente.  Determina qual dos n√≥s SLAVE se tornar√° MASTER e executar√° a reconfigura√ß√£o em movimento. <br><br>  Implementa o esquema cl√°ssico: <br><br><img width="467" src="https://habrastorage.org/getpro/habr/post_images/093/10e/efb/09310eefbd3eb3c05d23b9e227bb5d7a.jpg" alt="imagem"><br><br>  Pode haver muitos n√≥s SLAVE (at√© 1000, de acordo com o site oficial). Para um trabalho produtivo, √© recomend√°vel usar pelo menos dois n√≥s SLAVE. <br><br>  Normalmente, o esquema √© configurado de forma que o servi√ßo Redis Sentiel seja configurado nos n√≥s MASTER e SLAVE e, se o n√≥ MASTER falhar, os n√≥s de monitoramento restantes decidir√£o introduzir um novo MASTER. <br><br>  A vers√£o atual do Redis est√° dispon√≠vel para download no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site oficial do desenvolvedor do produto</a> .  No entanto, o site de distribui√ß√£o est√° dispon√≠vel apenas para Linux.  Ao mesmo tempo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o projeto da</a> Microsoft para portar o Redis para Windows estava em desenvolvimento, mas no momento o projeto parou de ser desenvolvido na vers√£o 3.2.100, portanto, neste artigo, consideraremos a op√ß√£o de implanta√ß√£o mais relevante - no Linux. <br><br>  Como n√≥s de teste, usaremos dois hosts virtuais redis1 e redis2 com a distribui√ß√£o Linux instalada do Debian 10. <br><br>  Primeiro, atualize as listas de pacotes do reposit√≥rio padr√£o e instale o Redis: <br><br><pre><code class="bash hljs">apt-get update &amp;&amp; apt-get upgrade apt install redis-server</code> </pre> <br>  Verifique a vers√£o: <br><br><pre> <code class="bash hljs">root@redis1:/home/user<span class="hljs-comment"><span class="hljs-comment"># redis-server -v Redis server v=5.0.3 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=afa0decbb6de285f</span></span></code> </pre> <br>  Permita que redis1 atue como um n√≥ MASTER e redis2 atue como um n√≥ ESCRAVO. <br><br>  Para isso, escrevemos nos arquivos de configura√ß√£o Redis os par√¢metros necess√°rios que permitir√£o criar uma r√©plica (ainda n√£o tolerante a falhas). <br><br>  Para redis1 no arquivo de configura√ß√£o /etc/redis/redis.conf, especifique: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ,   MASTER     . requirepass TestPass</span></span></code> </pre> <br>  Para redis2 no arquivo de configura√ß√£o /etc/redis/redis.conf, especifique: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   MASTER  . slaveof redis1 6379 #      . masterauth TestPass #   ,         . requirepass TestPass</span></span></code> </pre> <br>  Reinicie os servi√ßos redis-server nos dois n√≥s: <br><br><pre> <code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/redis-server stop [ ok ] Stopping redis-server (via systemctl): redis-server.service. root@redis1:/etc/redis# /etc/init.d/redis-server start [ ok ] Starting redis-server (via systemctl): redis-server.service. root@redis2:/etc/redis# /etc/init.d/redis-server stop [ ok ] Stopping redis-server (via systemctl): redis-server.service. root@redis2:/etc/redis# /etc/init.d/redis-server start [ ok ] Starting redis-server (via systemctl): redis-server.service.</span></span></code> </pre> <br>  Verificamos, no lado MASTER, que os n√≥s se tornaram r√©plicas e receberam as fun√ß√µes necess√°rias: <br><br><pre> <code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -a TestPass info replication Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. # Replication role:master connected_slaves:1 slave0:ip=192.168.9.96,port=6379,state=online,offset=28,lag=0 master_replid:56b0a702d5823d107b0ca1ca2c80f8ef650a4b28 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:28 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:28</span></span></code> </pre> <br>  No lado ESCRAVO, vemos a mesma situa√ß√£o: <br><pre> <code class="bash hljs">root@redis2:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -a TestPass info replication Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. # Replication role:slave master_host:redis1 master_port:6379 master_link_status:up master_last_io_seconds_ago:4 master_sync_in_progress:0 slave_repl_offset:14 slave_priority:100 slave_read_only:1 connected_slaves:0 master_replid:56b0a702d5823d107b0ca1ca2c80f8ef650a4b28 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:14 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:14</span></span></code> </pre> <br>  Agora voc√™ precisa configurar a r√©plica para que ela seja restaurada automaticamente em caso de falha de um dos n√≥s.  Para isso, precisamos do servi√ßo de rastreamento Redis Sentinel. <br><br>  Com base na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> , o servi√ßo de monitoramento Redis Sentinel pode executar as seguintes opera√ß√µes: <br><br><ol><li>  Verifica a disponibilidade dos n√≥s MASTER e SLAVE e pode enviar alertas sobre a inacessibilidade dos n√≥s. </li><li>  Se o n√≥ MASTER falhar, o n√≥ testemunha poder√° colocar o n√≥ SLAVE no modo MASTER, reconfigurar os n√≥s restantes do SLAVE e eles come√ßar√£o a trabalhar com o novo MASTER. </li><li>  Faz altera√ß√µes nos arquivos de configura√ß√£o dos n√≥s MASTER e SLAVE. </li></ol><br>  Para a pureza do experimento, colocaremos um servi√ßo de testemunha em uma VM redis3 separada. <br><br>  Conectamos o reposit√≥rio Redis da mesma maneira e instalamos o pacote redis-sentinel: <br><br><pre> <code class="bash hljs">apt install redis-sentinel</code> </pre> <br>  Ap√≥s a instala√ß√£o, √© necess√°rio fazer as configura√ß√µes no arquivo de configura√ß√£o do n√≥ de monitoramento /etc/redis/sentinel.conf: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    redis1   6379. #   1 -      , #        MASTER-. #       , #     MASTER-. sentinel monitor master01 redis1 6379 1 #  3 ,       . sentinel down-after-milliseconds master01 3000 #    MASTER- sentinel failover-timeout master01 6000 # ,  SLAVE-   . #    ,    , #      . sentinel parallel-syncs master01 1 #    . bind 192.168.9.97 127.0.0.1 ::1 #    MASTER-. sentinel auth-pass master01 TestPass</span></span></code> </pre><br>  Reinicie o servi√ßo depois de fazer as configura√ß√µes: <br><br><pre> <code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/redis-sentinel restart [ ok ] Restarting redis-sentinel (via systemctl): redis-sentinel.service.</span></span></code> </pre> <br>  Verifique se o servi√ßo de rastreamento viu MASTER e SLAVE: <br><br><pre> <code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -p 26379 info sentinel # Sentinel sentinel_masters:1 sentinel_tilt:0 sentinel_running_scripts:0 sentinel_scripts_queue_length:0 sentinel_simulate_failure_flags:0 master0:name=master01,status=ok,address=192.168.9.95:6379,slaves=1,sentinels=1</span></span></code> </pre> <br>  Come√ßamos os experimentos. <br><br>  Simulamos uma falha, paramos o servi√ßo redis-server no n√≥ redis1 e obtemos as informa√ß√µes atuais do n√≥ testemunha: <br><br><pre> <code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -p 26379 info sentinel # Sentinel sentinel_masters:1 sentinel_tilt:0 sentinel_running_scripts:0 sentinel_scripts_queue_length:0 sentinel_simulate_failure_flags:0 master0:name=master01,status=ok,address=192.168.9.96:6379,slaves=1,sentinels=1</span></span></code> </pre> <br>  Vemos que o MASTER mudou. <br><br>  Vamos restaurar a opera√ß√£o do n√≥ redis1 e verificar seu estado: <br><br><pre> <code class="bash hljs">root@redis3:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -h redis1 -p 6379 -a TestPass info replication Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. # Replication role:slave master_host:192.168.9.96 master_port:6379 master_link_status:up master_last_io_seconds_ago:1 master_sync_in_progress:0 slave_repl_offset:15977 slave_priority:100 slave_read_only:1 connected_slaves:0 master_replid:6c0c7d0eedccede56f211f2db74a98c4d0ff6d56 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:15977 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:15977</span></span></code> </pre> <br>  Vemos que o n√≥ recebeu a fun√ß√£o SLAVE e o n√≥ redis2 √© um n√≥ MASTER. <br><br>  Simule a falha do n√≥ redis2 e verifique o status do n√≥ testemunha: <br><br><pre> <code class="bash hljs">root@redis3:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -p 26379 info sentinel # Sentinel sentinel_masters:1 sentinel_tilt:0 sentinel_running_scripts:0 sentinel_scripts_queue_length:0 sentinel_simulate_failure_flags:0 master0:name=master01,status=ok,address=192.168.9.95:6379,slaves=1,sentinels=1</span></span></code> </pre> <br>  E o estado do n√≥ redis1: <br><br><pre> <code class="bash hljs">root@redis3:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/redis<span class="hljs-comment"><span class="hljs-comment"># redis-cli -h redis1 -p 6379 -a TestPass info replication Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. # Replication role:master connected_slaves:0 master_replid:6e9d67d6460815b925319c2bafb58bf2c435cffb master_replid2:6c0c7d0eedccede56f211f2db74a98c4d0ff6d56 master_repl_offset:33610 second_repl_offset:26483 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:33610</span></span></code> </pre> <br>  √ìtimo, o mecanismo funciona.  Mas agora surgiu a quest√£o de como conectaremos nossos servi√ßos DirectumRX, porque eles precisam de um endere√ßo de n√≥ √∫nico.  Resolveremos a situa√ß√£o usando o servi√ßo HAProxy. <br><br><h2>  Proxying de N√≥ Redis </h2><br>  Qualquer servi√ßo de proxy tcp pode atuar como um proxy reverso para n√≥s Redis.  Neste artigo, consideraremos o uso do HAProxy, pois √© uma ferramenta especializada projetada para fornecer alta disponibilidade e balanceamento de carga e √© usada por servi√ßos online universalmente conhecidos.  Leia mais sobre o HAProxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">na p√°gina do desenvolvedor</a> . <br><br>  Instale o HAProxy no n√≥ redis3: <br><br><pre> <code class="bash hljs">root@redis3:/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/redis<span class="hljs-comment"><span class="hljs-comment"># apt install haproxy</span></span></code> </pre> <br>  No arquivo de configura√ß√£o HAProxy /etc/haproxy/haproxy.cfg, adicione as configura√ß√µes para solicita√ß√µes de proxy nos n√≥s Redis: <br><br><pre> <code class="bash hljs">‚Ä¶ frontend ft_redis <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> *:6379 name redis mode tcp default_backend bk_redis backend bk_redis mode tcp option tcp-check tcp-check connect <span class="hljs-comment"><span class="hljs-comment">#  ,         . tcp-check send AUTH\ TestPass\r\n tcp-check expect string +OK tcp-check send PING\r\n tcp-check expect string +PONG tcp-check send info\ replication\r\n #    MASTER, .. SLAVE      . tcp-check expect string role:master tcp-check send QUIT\r\n tcp-check expect string +OK server Redis1 redis1:6379 check inter 3s server Redis2 redis2:6379 check inter 3s</span></span></code> </pre><br>  Nesta configura√ß√£o, √© indicado que iremos proxy todos os pedidos que chegarem a todas as interfaces da m√°quina virtual atual no endere√ßo na porta 6379. Transferiremos pedidos para o n√≥ que responder√° que possui a fun√ß√£o MASTER. <br><br>  Reinicie o servi√ßo haproxy: <br><br><pre> <code class="bash hljs">root@redis3:/etc/haproxy<span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/haproxy restart</span></span></code> </pre> <br>  Vamos tentar conectar usando o cliente redis-cli e criar uma chave de teste: <br><br><pre> <code class="bash hljs">root@redis3:/etc/haproxy<span class="hljs-comment"><span class="hljs-comment"># redis-cli -p 6379 -a TestPass Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe. 127.0.0.1:6379&gt; SET TestKey "Some test string" OK 127.0.0.1:6379&gt; GET TestKey "Some test string" 127.0.0.1:6379&gt; info keyspace # Keyspace db0:keys=1,expires=0,avg_ttl=0</span></span></code> </pre> <br>  Pare o n√≥ redis1 e consulte novamente a lista de chaves: <br><br><pre> <code class="bash hljs">127.0.0.1:6379&gt; info keyspace Error: Server closed the connection (3.01s) 127.0.0.1:6379&gt; info keyspace <span class="hljs-comment"><span class="hljs-comment"># Keyspace db0:keys=1,expires=0,avg_ttl=0 (2.01s) 127.0.0.1:6379&gt; GET TestKey "Some test string"</span></span></code> </pre><br>  Vimos que por algum tempo a conex√£o foi desconectada, mas a conex√£o foi restaurada novamente e todos os dados permaneceram no local. <br><br>  Agora √© suficiente registrar o endere√ßo do proxy reverso nos arquivos de configura√ß√£o dos servi√ßos DirectumRX para conectar-se ao Redis. <br><br><h2>  Configurar Redis Cluster </h2><br>  A op√ß√£o de cluster do Redis Cluster, implementada para a vers√£o redis 3.0 e superior, √© uma solu√ß√£o para criar e gerenciar um cluster com segmenta√ß√£o e replica√ß√£o de dados.  Executa tarefas de gerenciamento de n√≥, replica√ß√£o, sincroniza√ß√£o de dados nos n√≥s e garante o acesso do aplicativo cliente ao n√≥ MASTER no caso de falha de um dos v√°rios n√≥s MASTER. <br><br><img width="500" src="https://habrastorage.org/getpro/habr/post_images/86e/5c6/e56/86e5c6e56fe5541c36297e978c4c34d4.png" alt="imagem"><br><br>  O Redis Cluster funciona no modo multimaster, cada n√≥ MASTER pode ter um ou mais n√≥s SLAVE (at√© 1000). <br><br>  A escala √© a principal fun√ß√£o do cluster.  Al√©m disso, o cluster pode garantir a toler√¢ncia a falhas do servi√ßo Redis: <br><br><ul><li>  se alguns n√≥s n√£o funcionarem, o cluster redistribuir√° a carga deles para outros n√≥s; </li><li>  se os n√≥s principais n√£o funcionarem, o cluster inteiro ser√° encerrado. </li></ul><br>  Uma situa√ß√£o pode surgir quando o Cliente 2 grava no n√≥ M2.  M2 responde "OK" e tenta escrever para S2.  Ao mesmo tempo, o M2 n√£o espera a conclus√£o correta da troca de dados com o S2, mas responde ao cliente imediatamente.  Nesse caso, a r√©plica S2 pode n√£o ter todos os dados.  Portanto, √© recomend√°vel usar v√°rias r√©plicas SLAVE. <br><br>  Uma situa√ß√£o tamb√©m pode surgir quando M1, M3 deixam de "ver" M2 e o cliente ainda continua a gravar dados em M2.  Se a indisponibilidade continuar por algum tempo (o par√¢metro cluster-node-timeout), nesse caso, o S2 ser√° colocado no modo MASTER e o M2 deixar√° de funcionar por conta pr√≥pria. <br><br>  A documenta√ß√£o oficial recomenda o uso de 6 n√≥s - uma inst√¢ncia do Redis por n√≥, o que permite maior confiabilidade, mas ningu√©m pro√≠be o uso de tr√™s n√≥s com a seguinte topologia de conex√£o: <br><br><img width="573" src="https://habrastorage.org/getpro/habr/post_images/3c1/56a/860/3c156a860e5728015e9631b3bb5854a1.jpg" alt="imagem"><br><br>  Se um dos n√≥s f√≠sicos falhar, as r√©plicas correspondentes do SLAVE entrar√£o no modo MASTER e a opera√ß√£o n√£o ser√° interrompida. <br><br>  Implementamos 3 m√°quinas virtuais (redis1, redis2 e redis3) na bancada de testes, cada uma das quais executar√° 2 inst√¢ncias Redis. <br><br>  O aplicativo cliente se conectar√° a uma porta espec√≠fica especificada no arquivo de configura√ß√£o do cliente; portanto, os pares MASTER - SLAVE devem funcionar nas mesmas portas. <br><br>  Para o par M1 - S1, usaremos a porta 6381 <br>  Para o par M2 - S2, usaremos a porta 6382 <br>  Para o par M3 - S3, usaremos a porta 6383 <br><br>  Prepare os arquivos de configura√ß√£o <br><br>  Em redis1: <br><br><pre> <code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m1_redis.conf cp /etc/redis/redis.conf /etc/redis/s2_redis.conf mv /etc/redis/redis.conf /etc/redis/redis.bak</code> </pre> <br>  Em redis2: <br><br><pre> <code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m2_redis.conf cp /etc/redis/redis.conf /etc/redis/s3_redis.conf mv /etc/redis/redis.conf /etc/redis/redis.bak</code> </pre> <br>  Em redis3: <br><br><pre> <code class="bash hljs">cp /etc/redis/redis.conf /etc/redis/m3_redis.conf cp /etc/redis/redis.conf /etc/redis/s1_redis.conf mv /etc/redis/redis.conf /etc/redis/redis.bak</code> </pre> <br>  Preencha os arquivos de configura√ß√£o de acordo com o modelo: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> &lt;IP- &gt; protected-mode no <span class="hljs-comment"><span class="hljs-comment">#      ,    . port &lt;&gt; pidfile /var/run/redis_&lt;&gt;.pid # &lt;yes/no&gt; -   Redis Cluster cluster-enabled yes # ,      : #  ,  ,    . #         . cluster-config-file nodes-&lt;&gt;.conf #  ,  master-   , #          slaves #    . cluster-node-timeout 15000</span></span></code> </pre> <br>  Vamos lan√ßar os n√≥s Redis: <br><br>  N√≥ redis1: <br><br><pre> <code class="bash hljs">root@redis1:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-server /etc/redis/m1_redis.conf root@redis1:/etc/redis# redis-server /etc/redis/s2_redis.conf</span></span></code> </pre> <br>  N√≥ Redis2: <br><br><pre> <code class="bash hljs">root@redis2:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-server /etc/redis/m2_redis.conf root@redis2:/etc/redis# redis-server /etc/redis/s3_redis.conf</span></span></code> </pre> <br>  N√≥ Redis3: <br><br><pre> <code class="bash hljs">root@redis3:/etc/redis<span class="hljs-comment"><span class="hljs-comment"># redis-server /etc/redis/m3_redis.conf root@redis3:/etc/redis# redis-server /etc/redis/s1_redis.conf</span></span></code> </pre> <br>  Para configurar o cluster, voc√™ deve usar o utilit√°rio cliente redis-cli, passando uma lista de pares de servidores ip: port que desempenhar√£o as fun√ß√µes de MASTER e SLAVE: <br><br><pre> <code class="bash hljs">redis-cli --cluster create redis1-ip:6381 redis2-ip:6382 redis3-ip:6383 redis1-ip:6382 redis2-ip:6383 redis3-ip:6381 --cluster-replicas 1</code> </pre> <br>  , onde a op√ß√£o --cluster-replicas 1 informa quantos ESCRAVOS cada mestre ter√° e eles s√£o selecionados automaticamente na lista de r√©plicas transferidas. <br><br><pre> <code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"><span class="hljs-comment"># redis-cli --cluster create 192.168.9.51:6381 192.168.9.52:6382 192.168.9.53:6383 192.168.9.51:6382 192.168.9.52:6383 192.168.9.53:6381 --cluster-replicas 1 &gt;&gt;&gt; Performing hash slots allocation on 6 nodes... Master[0] -&gt; Slots 0 - 5460 Master[1] -&gt; Slots 5461 - 10922 Master[2] -&gt; Slots 10923 - 16383 Adding replica 192.168.9.52:6383 to 192.168.9.51:6381 Adding replica 192.168.9.51:6382 to 192.168.9.52:6382 Adding replica 192.168.9.53:6381 to 192.168.9.53:6383 &gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity [OK] Perfect anti-affinity obtained! M: e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381 slots:[0-5460] (5461 slots) master M: d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382 slots:[5461-10922] (5462 slots) master M: 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383 slots:[10923-16383] (5461 slots) master S: 182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382 replicates d499af3672b3063c7239572ec311ad3160f280ae S: 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383 replicates 3a41475e1613519c3ecdec695736a898262a24a5 S: 485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381 replicates e92cb96fd6c20db7509662a248902e3751ebe95f Can I set the above configuration? (type 'yes' to accept): yes &gt;&gt;&gt; Nodes configuration updated &gt;&gt;&gt; Assign a different config epoch to each node &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster Waiting for the cluster to join ..... &gt;&gt;&gt; Performing Cluster Check (using node 192.168.9.51:6381) M: e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381 slots:[0-5460] (5461 slots) master 1 additional replica(s) M: d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382 slots:[5461-10922] (5462 slots) master 1 additional replica(s) S: 485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381 slots: (0 slots) slave replicates e92cb96fd6c20db7509662a248902e3751ebe95f S: 182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382 slots: (0 slots) slave replicates d499af3672b3063c7239572ec311ad3160f280ae S: 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383 slots: (0 slots) slave replicates 3a41475e1613519c3ecdec695736a898262a24a5 M: 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383 slots:[10923-16383] (5461 slots) master 1 additional replica(s) [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered.</span></span></code> </pre> <br>  O cluster est√° constru√≠do corretamente.  Vamos exibir informa√ß√µes sobre o cluster: <br><br><pre> <code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"><span class="hljs-comment"># redis-cli -c -h 192.168.9.51 -p 6381 192.168.9.51:6381&gt; CLUSTER INFO cluster_state:ok cluster_slots_assigned:16384 cluster_slots_ok:16384 cluster_slots_pfail:0 cluster_slots_fail:0 cluster_known_nodes:6 cluster_size:3 cluster_current_epoch:6 cluster_my_epoch:1 cluster_stats_messages_ping_sent:1254 cluster_stats_messages_pong_sent:1243 cluster_stats_messages_sent:2497 cluster_stats_messages_ping_received:1238 cluster_stats_messages_pong_received:1254 cluster_stats_messages_meet_received:5 cluster_stats_messages_received:2497 192.168.9.51:6381&gt;</span></span></code> </pre> <br>  Para testar uma r√©plica espec√≠fica, como no Redis Sentiel, voc√™ pode usar o comando de replica√ß√£o INFO: <br><br><pre> <code class="bash hljs">root@redis1:~/redis/src<span class="hljs-comment"><span class="hljs-comment"># redis-cli -c -h 192.168.9.51 -p 6381 192.168.9.51:6381&gt; INFO replication # Replication role:master connected_slaves:1 slave0:ip=192.168.9.53,port=6381,state=online,offset=1946,lag=0 master_replid:59cd95d394dad9d0e49042637fdfd5290db4abfe master_replid2:0000000000000000000000000000000000000000 master_repl_offset:1946 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:1946 192.168.9.51:6381&gt;</span></span></code> </pre> <br>  Vamos tentar criar v√°rias chaves e verificar se essas chaves apareceram nas r√©plicas: <br><br><pre> <code class="bash hljs">192.168.9.51:6381&gt; SET key1 test1 -&gt; Redirected to slot [9189] located at 192.168.9.52:6382 OK 192.168.9.52:6382&gt; SET key2 test2 -&gt; Redirected to slot [4998] located at 192.168.9.51:6381 OK 192.168.9.51:6381&gt; SET key3 test3 OK 192.168.9.51:6381&gt;</code> </pre> <br>  Verifique no M2: <br><br><pre> <code class="bash hljs">root@redis2:/home/user<span class="hljs-comment"><span class="hljs-comment"># redis-cli -c -h 192.168.9.52 -p 6382 192.168.9.52:6382&gt; GET key1 "test1" 192.168.9.52:6382&gt; GET key2 -&gt; Redirected to slot [4998] located at 192.168.9.51:6381 "test2" 192.168.9.51:6381&gt; GET key3 "test3" 192.168.9.51:6381&gt;</span></span></code> </pre> <br>  E no M3: <br><br><pre> <code class="bash hljs">root@redis3:/home/user<span class="hljs-comment"><span class="hljs-comment"># redis-cli -c -h 192.168.9.53 -p 6383 192.168.9.53:6383&gt; GET key1 -&gt; Redirected to slot [9189] located at 192.168.9.52:6382 "test1" 192.168.9.52:6382&gt; GET key2 -&gt; Redirected to slot [4998] located at 192.168.9.51:6381 "test2" 192.168.9.51:6381&gt; GET key3 "test3" 192.168.9.51:6381&gt;</span></span></code> </pre> <br>  Desabilitaremos o n√≥ redis1 e verificaremos como o S1 funciona: <br><br><pre> <code class="bash hljs">192.168.9.52:6382&gt; CLUSTER NODES &lt;b&gt;182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382@16382 slave,fail d499af3672b3063c7239572ec311ad3160f280ae 1569509904727 1569509900000 4 connected&lt;/b&gt; 485ffb786e9763955e6f10ffc59247690ad9bc11 &lt;i&gt;192.168.9.53:6381@16381 master&lt;/i&gt; - 0 1569510017272 7 connected 0-5460 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383@16383 slave 3a41475e1613519c3ecdec695736a898262a24a5 0 1569510018274 5 connected &lt;b&gt;e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381@16381 master,fail - 1569509906731 1569509901721 1 connected&lt;/b&gt; 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383@16383 master - 0 1569510019275 3 connected 10923-16383 d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382@16382 myself,master - 0 1569510017000 2 connected 5461-10922</code> </pre> <br>  Vemos informa√ß√µes sobre a falha de M1 e S2 e que o S3 mudou para o modo MASTER. <br><br>  Verifique onde as chaves est√£o armazenadas: <br><br><pre> <code class="bash hljs">192.168.9.52:6382&gt; GET key1 <span class="hljs-string"><span class="hljs-string">"test1"</span></span> 192.168.9.52:6382&gt; GET key2 -&gt; Redirected to slot [4998] located at 192.168.9.53:6381 <span class="hljs-string"><span class="hljs-string">"test2"</span></span> 192.168.9.53:6381&gt; GET key3 <span class="hljs-string"><span class="hljs-string">"test3"</span></span> 192.168.9.53:6381&gt;</code> </pre><br>  As chaves que foram armazenadas anteriormente no redis1 agora est√£o dispon√≠veis no redis3. <br><br>  Restaure a opera√ß√£o do n√≥ redis1 e verifique o estado dos n√≥s M1 e S2: <br><br><pre> <code class="bash hljs">192.168.9.53:6381&gt; CLUSTER NODES &lt;i&gt;e92cb96fd6c20db7509662a248902e3751ebe95f 192.168.9.51:6381@16381 slave 485ffb786e9763955e6f10ffc59247690ad9bc11 0 1569511658217 7 connected 182e5cffc9c31c231de69ddbaf507ec1fe17bb09 192.168.9.51:6382@16382 slave d499af3672b3063c7239572ec311ad3160f280ae 0 1569511657000 4 connected&lt;/i&gt; d499af3672b3063c7239572ec311ad3160f280ae 192.168.9.52:6382@16382 master - 0 1569511656000 2 connected 5461-10922 3a41475e1613519c3ecdec695736a898262a24a5 192.168.9.53:6383@16383 master - 0 1569511656000 3 connected 10923-16383 485ffb786e9763955e6f10ffc59247690ad9bc11 192.168.9.53:6381@16381 myself,master - 0 1569511656000 7 connected 0-5460 44f656062259005adea58bc5ad024071a050e192 192.168.9.52:6383@16383 slave 3a41475e1613519c3ecdec695736a898262a24a5 0 1569511657216 5 connected</code> </pre> <br>  A sa√∫de de M1 e S2 se recuperou, mas agora M1 est√° no modo ESCRAVO. <br><br>  E as chaves tamb√©m est√£o no n√≥ redis3: <br><br><pre> <code class="bash hljs">192.168.9.53:6383&gt; GET key1 -&gt; Redirected to slot [9189] located at 192.168.9.52:6382 <span class="hljs-string"><span class="hljs-string">"test1"</span></span> 192.168.9.52:6382&gt; GET key2 -&gt; Redirected to slot [4998] located at 192.168.9.53:6381 <span class="hljs-string"><span class="hljs-string">"test2"</span></span> 192.168.9.53:6383&gt; GET key3 -&gt; Redirected to slot [935] located at 192.168.9.53:6381 <span class="hljs-string"><span class="hljs-string">"test3"</span></span></code> </pre> <br>  O cluster est√° configurado e a recupera√ß√£o Redis √© testada. <br><br>  Para acessar os servi√ßos do DirectumRX, voc√™ tamb√©m precisar√° configurar proxies reversos, como no caso do Redis Sentiel. <br><br><h2>  Em vez de uma conclus√£o </h2><br>  Este artigo n√£o considerou ainda outra maneira de aumentar a toler√¢ncia a falhas do Redis - usando um gerenciador de recursos de cluster de terceiros, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pacemaker</a> .  Nesse caso, ser√° poss√≠vel conviver com dois n√≥s, mas h√° uma alta probabilidade de perda de dados em caso de emerg√™ncia. <br><br>  Para um proxy reverso (neste caso, HAProxy), tamb√©m √© desej√°vel fornecer toler√¢ncia a falhas, mas esse problema tamb√©m estava al√©m do escopo deste artigo.  Se voc√™ estiver interessado no t√≥pico, essas op√ß√µes de implanta√ß√£o tamb√©m poder√£o ser consideradas em artigos separados com o ajuste passo a passo e o teste dos resultados. <br><br>  Voc√™ pode encontrar os links abaixo para saber mais sobre o t√≥pico: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tutorial do cluster Redis</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o do Redis Sentinel</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Manual de configura√ß√£o HAProxy</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt469543/">https://habr.com/ru/post/pt469543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt469529/index.html">A renderiza√ß√£o de texto odeia voc√™</a></li>
<li><a href="../pt469531/index.html">"Comparar linguagens de programa√ß√£o em uma base de pior a pior √© uma ocupa√ß√£o completamente idiota."</a></li>
<li><a href="../pt469533/index.html">Problemas e amea√ßas da identifica√ß√£o biom√©trica</a></li>
<li><a href="../pt469537/index.html">Conhecendo Swift com Snake</a></li>
<li><a href="../pt469541/index.html">Montagem e implanta√ß√£o dos mesmos microsservi√ßos com o werf e o GitLab CI</a></li>
<li><a href="../pt469545/index.html">O que h√° de novo no kernel do Linux 5.3 - Drivers gr√°ficos, virtualiza√ß√£o e modifica√ß√µes no subsistema de rede</a></li>
<li><a href="../pt469549/index.html">Como fizemos a tarifa do Windows VPS por 99 rublos</a></li>
<li><a href="../pt469551/index.html">VDS com uma placa de v√≠deo - sabemos muito sobre pervers√µes</a></li>
<li><a href="../pt469555/index.html">Transmiss√£o: Moscow Kubernetes Meetup # 6</a></li>
<li><a href="../pt469557/index.html">Visualiza√ß√£o do Reciclador Gen√©rico ou como n√£o escrever c√≥digo padr√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>