<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游똁游낗 游뛒 游닀 Gu칤a Discovery.js: Inicio r치pido 游볨 游딮 游깵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta y las siguientes gu칤as lo guiar치n a trav칠s del proceso de creaci칩n de una soluci칩n basada en el proyecto Discovery.js . Nuestro objetivo es crear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gu칤a Discovery.js: Inicio r치pido</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/469115/"><p> Esta y las siguientes gu칤as lo guiar치n a trav칠s del proceso de creaci칩n de una soluci칩n basada en el proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Discovery.js</a> .  Nuestro objetivo es crear un inspector para las dependencias de NPM, es decir, una interfaz para examinar la estructura de <code>node_modules</code> . </p><br><p><img src="https://habrastorage.org/webt/ih/d_/sc/ihd_schofzsmx1xbptuvltrxmu8.png"></p><br><blockquote>  Nota: Discovery.js se encuentra en una etapa temprana de desarrollo, por lo que con el tiempo, algo se simplificar치 y se volver치 m치s 칰til.  Si tiene ideas sobre c칩mo mejorar algo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escr칤banos</a> . </blockquote><br><h2 id="annotaciya">  Anotaci칩n </h2><br><p>  A continuaci칩n encontrar치 una descripci칩n general de los conceptos clave de Discovery.js.  Puede aprender el c칩digo manual completo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el repositorio en GitHub</a> , o puede probar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c칩mo funciona en l칤nea</a> . </p><a name="habracut"></a><br><h2 id="nachalnye-usloviya">  Condiciones iniciales </h2><br><p>  En primer lugar, debemos elegir un proyecto para el an치lisis.  Este puede ser un proyecto reci칠n creado o uno existente, lo principal es que contiene <code>node_modules</code> (el objeto de nuestro an치lisis). </p><br><p>  Primero, instale el paquete core <code>discoveryjs</code> y sus herramientas de consola: </p><br><pre> <code class="bash hljs">npm install @discoveryjs/discovery @discoveryjs/cli</code> </pre> <br><p>  A continuaci칩n, inicie el servidor Discovery.js: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery No config is used Models are not defined (model free mode is enabled) Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Si abre <code>http://localhost:8123</code> en el navegador, puede ver lo siguiente: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4e6/fc9/228/4e6fc922872955e6a2f3355e2856b3d1.png" alt="Descubrimiento sin configuraci칩n"></p><br><p>  Este es un modo sin modelo, es decir, un modo cuando no hay nada configurado.  Pero ahora, usando el bot칩n "Cargar datos", puede seleccionar cualquier archivo JSON, o simplemente arrastrarlo a la p치gina e iniciar el an치lisis. </p><br><p>  Sin embargo, necesitamos algo espec칤fico.  En particular, necesitamos obtener una vista de la estructura <code>node_modules</code> .  Para hacer esto, agregue la configuraci칩n. </p><br><h2 id="dobavlyaem-konfiguraciyu">  Agregar configuraci칩n </h2><br><p>  Como habr치 notado, el mensaje <code>No config is used</code> mostr칩 cuando se inici칩 el servidor.  <code>.discoveryrc.js</code> un archivo de configuraci칩n <code>.discoveryrc.js</code> con el siguiente contenido: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, data() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span> }; } };</code> </pre> <br><p>  Nota: si crea un archivo en el directorio de trabajo actual (es decir, en la ra칤z del proyecto), no se requiere nada m치s.  De lo contrario, debe pasar la ruta al archivo de configuraci칩n utilizando la opci칩n <code>--config</code> , o establecer la ruta en <code>package.json</code> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"discovery"</span></span>: <span class="hljs-string"><span class="hljs-string">"path/to/discovery/config.js"</span></span>, ... }</code> </pre> <br><p>  Reinicie el servidor para que se aplique la configuraci칩n: </p><br><pre> <code class="plaintext hljs">&gt; npx discovery Load config from .discoveryrc.js Init single model default Define default routes ... OK Cache: DISABLED Init common routes ... OK Server listen on http://localhost:8123</code> </pre> <br><p>  Como puede ver, ahora se utiliza el archivo que creamos.  Y se aplica el modelo predeterminado descrito por nosotros (Discovery puede funcionar en el modo de muchos modelos, hablaremos sobre esta caracter칤stica en los siguientes manuales).  Veamos qu칠 ha cambiado en el navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/16f/f45/ac8/16ff45ac8eef467b6ccd0ff5624c9652.png" alt="Con configuraci칩n b치sica"></p><br><p>  Lo que se puede ver aqu칤: </p><br><ul><li>  <code>name</code> usa como t칤tulo de la p치gina; </li><li>  El resultado de llamar al m칠todo de <code>data</code> se muestra como el contenido principal de la p치gina. </li></ul><br><blockquote>  Nota: el m칠todo de <code>data</code> debe devolver datos o Promesa, que se resuelve en datos. </blockquote><p>  Se realizan ajustes b치sicos, puede seguir adelante. </p><br><h2 id="kontekst">  Contexto </h2><br><p>  Veamos la p치gina del informe personalizado (haga clic en <code>Make report</code> ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/def/52b/57a/def52b57a6be174730f07fe55273517a.png" alt="P치gina de informe"></p><br><p>  A primera vista, esto no es muy diferente de la p치gina de inicio ... 춰Pero aqu칤 puedes cambiar todo!  Por ejemplo, podemos recrear f치cilmente la apariencia de la p치gina de inicio: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/919/de1/c6c919de17d2fed5bdb0501fe1ff9dae.png" alt="Recreando la p치gina de inicio"></p><br><p>  Observe c칩mo se define el encabezado: <code>"h1:#.name"</code> .  Este es el encabezado de primer nivel con el contenido de <code>#.name</code> , que es una solicitud de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Jora</a> .  <code>#</code> refiere al contexto de la solicitud.  Para ver su contenido, simplemente ingrese <code>#</code> en el editor de consultas y use la pantalla predeterminada: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/524/7a6/2cc/5247a62cc6194ab9bd4797c21ab084b9.png" alt="Valores de contexto"></p><br><p>  Ahora ya sabe c칩mo obtener la ID de la p치gina actual, sus par치metros y otros valores 칰tiles. </p><br><h2 id="sbor-dannyh">  Recogida de datos </h2><br><p>  Ahora usamos un trozo en el proyecto en lugar de datos reales, pero necesitamos datos reales.  Para hacer esto, cree un m칩dulo y cambie el valor de los <code>data</code> en la configuraci칩n (por cierto, despu칠s de estos cambios no es necesario reiniciar el servidor): </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>) };</code> </pre> <br><p>  El contenido de <code>collect-node-modules-data.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> scanFs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/scan-fs'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packages = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scanFs({ <span class="hljs-attr"><span class="hljs-attr">include</span></span>: [<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>], <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\/package.json$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">extract</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file, content</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pkg = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(content); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pkg.name &amp;&amp; pkg.version) { packages.push({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: pkg.name, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: pkg.version, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.dirname(file.filename), <span class="hljs-attr"><span class="hljs-attr">dependencies</span></span>: pkg.dependencies }); } } }] }).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> packages); };</code> </pre> <br><p>  <code>@discoveryjs/scan-fs</code> paquete <code>@discoveryjs/scan-fs</code> , que simplifica el escaneo del sistema de archivos.  Un ejemplo de uso del paquete se describe en su archivo L칠ame, tom칠 este ejemplo como base y lo finalic칠 seg칰n fue necesario.  Ahora tenemos informaci칩n sobre el contenido de <code>node_modules</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d0c/f24/64c/d0cf2464cadda8a8bc0433871200ae9b.png" alt="Datos recogidos"></p><br><p>  Lo que necesitas!  Y a pesar del hecho de que este es JSON ordinario, ya podemos analizarlo y sacar algunas conclusiones.  Por ejemplo, utilizando la ventana emergente de la estructura de datos, puede averiguar la cantidad de paquetes y determinar cu치ntos de ellos tienen m치s de una instancia f칤sica (debido a diferencias de versi칩n o problemas con su deduplicaci칩n). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f3/93e/5e0/8f393e5e05a1385aa11aad92d8ad15a0.png" alt="Investigaci칩n de estructura de datos"></p><br><p>  A pesar de que ya tenemos algunos datos, necesitamos m치s detalles.  Por ejemplo, ser칤a bueno saber qu칠 instancia f칤sica resuelve cada una de las dependencias declaradas de un m칩dulo en particular.  Sin embargo, el trabajo para mejorar la extracci칩n de datos est치 m치s all치 del alcance de esta gu칤a.  Por lo tanto, lo reemplazaremos con el paquete <code>@discoveryjs/node-modules</code> (que tambi칠n se basa en <code>@discoveryjs/scan-fs</code> ) para recuperar los datos y obtener los detalles necesarios sobre los paquetes.  Como resultado, <code>collect-node-modules-data.js</code> simplifica enormemente: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fetchNodeModules = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@discoveryjs/node-modules'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fetchNodeModules(); };</code> </pre> <br><p>  Ahora la informaci칩n sobre <code>node_modules</code> ve as칤: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1f5/1c2/187/1f51c2187d527694cbf71089e8d74ba8.png" alt="Nueva estructura de datos"></p><br><h2 id="skript-podgotovki">  Guion de preparacion </h2><br><p>  Como habr치s notado, algunos objetos que describen paquetes contienen <code>deps</code> , una lista de dependencias.  Cada dependencia tiene un campo <code>resolved</code> cuyo valor es una referencia a una instancia f칤sica del paquete.  Tal enlace es el valor de <code>path</code> de uno de los paquetes, es 칰nico.  Para resolver el enlace al paquete, debe usar c칩digo adicional (por ejemplo, <code>#.data.pick(&lt;path=resolved&gt;)</code> ).  Y, por supuesto, ser칤a mucho m치s conveniente si dichos enlaces ya se resolvieran en referencias a objetos. </p><br><p>  Desafortunadamente, en la etapa de recopilaci칩n de datos, no podemos resolver los enlaces, ya que esto conducir치 a conexiones circulares, lo que crear치 el problema de transferir dichos datos en forma de JSON.  Sin embargo, hay una soluci칩n: este es un script de <code>prepare</code> especial.  Se define en la configuraci칩n y se llama cada vez que se asigna un nuevo dato a la instancia de Discovery.  Comencemos con la configuraci칩n: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... prepare: __dirname + <span class="hljs-string"><span class="hljs-string">'/prepare.js'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// :   ,    ... };</span></span></code> </pre> <br><p>  Definir <code>prepare.js</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -  data /   discovery });</span></span></code> </pre> <br><p>  En este m칩dulo, definimos la funci칩n de <code>prepare</code> para la instancia Discovery.  Esta funci칩n se llama cada vez antes de aplicar datos a la instancia de Discovery.  Este es un buen lugar para permitir valores en referencias de objeto: </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> packageIndex = data.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, pkg</span></span></span><span class="hljs-function">) =&gt;</span></span> map.set(pkg.path, pkg), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); data.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pkg</span></span></span><span class="hljs-function"> =&gt;</span></span> pkg.deps.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dep</span></span></span><span class="hljs-function"> =&gt;</span></span> dep.resolved = packageIndex.get(dep.resolved) ) ); });</code> </pre> <br><p>  Aqu칤 hemos creado un 칤ndice de paquete en el que la clave es el valor de la <code>path</code> del paquete (칰nico).  Luego revisamos todos los paquetes y sus dependencias, y en las dependencias reemplazamos el valor <code>resolved</code> con una referencia al objeto del paquete.  Resultado: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95b/277/dd6/95b277dd63dc3aff1fdf3716c6881356.png" alt="Dep칩sitos convertidos resueltos"></p><br><p>  Ahora es mucho m치s f치cil hacer consultas de gr치ficos de dependencia.  As칤 es como puede obtener un grupo de dependencias (es decir, dependencias, dependencias de dependencia, etc.) para un paquete espec칤fico: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c64/793/a78/c64793a78d40961af1b234fc111e4dc2.png" alt="Ejemplo de cl칰ster de dependencia"></p><br><blockquote>  Una historia de 칠xito inesperada: mientras estudiaba los datos durante la redacci칩n del manual, encontr칠 un problema en <code>@discoveryjs/cli</code> (usando la consulta <code>.[deps.[not resolved]]</code> ), que ten칤a un error tipogr치fico en las dependencias de pares.  El problema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se solucion칩 de</a> inmediato.  El caso es un buen ejemplo de c칩mo ayudan estas herramientas. </blockquote><p>  Quiz치s ha llegado el momento de mostrar en la p치gina de inicio varios n칰meros y paquetes con tomas. </p><br><h2 id="nastraivaem-startovuyu-stranicu">  Personalizar p치gina de inicio </h2><br><p>  Primero, necesitamos crear un m칩dulo de p치gina, por ejemplo, <code>pages/default.js</code> .  Usamos el <code>default</code> , porque este es el identificador de la p치gina de inicio, que podemos anular (en Discovery.js, puede anular mucho).  Comencemos con algo simple, por ejemplo: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, <span class="hljs-string"><span class="hljs-string">'text:"Hello world!"'</span></span> ]);</code> </pre> <br><p>  Ahora en la configuraci칩n necesita conectar el m칩dulo de p치gina: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Node modules structure'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collect-node-modules-data'</span></span>), <span class="hljs-attr"><span class="hljs-attr">view</span></span>: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ] } };</span></span></code> </pre> <br><p>  Comprobar en el navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e0c/d07/8d5/e0cd078d55637ef62a697809544909b9.png" alt="P치gina de inicio anulada"></p><br><p>  Funciona! </p><br><p>  Ahora consigamos algunos contadores.  Para hacer esto, realice cambios en <code>pages/default.js</code> : </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'indicator'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`[ { label: 'Package entries', value: size() }, { label: 'Unique packages', value: name.size() }, { label: 'Dup packages', value: group(&lt;name&gt;).[value.size() &gt; 1].size() } ]`</span></span> } ]);</code> </pre> <br><p>  Aqu칤 definimos una lista en l칤nea de indicadores.  El valor de los <code>data</code> es una consulta de Jora que crea una matriz de registros.  La lista de paquetes (ra칤z de datos) se utiliza como base para las consultas, por lo que obtenemos la longitud de la lista ( <code>size()</code> ), la cantidad de nombres de paquetes 칰nicos ( <code>name.size()</code> ) y la cantidad de nombres de paquetes que tienen duplicados ( <code>group(&lt;name&gt;).[value.size() &gt; 1].size()</code> ). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebf/c97/8a2/ebfc978a2b2da44214a99a8382e17107.png" alt="Agregar indicadores a la p치gina de inicio"></p><br><p>  No esta mal.  Sin embargo, ser칤a mejor tener, adem치s de n칰meros, enlaces a las muestras correspondientes: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'h1:#.name'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'inline-list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Package entries'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Unique packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">'Dup packages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'group(&lt;name&gt;).[value.size() &gt; 1]'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">`indicator:{ label, value: value.query(#.data, #).size(), href: pageLink('report', { query: value, title: label }) }`</span></span> } ]);</code> </pre> <br><p>  En primer lugar, cambiamos el valor de los <code>data</code> , ahora es una matriz regular con algunos objetos.  Adem치s, el m칠todo <code>size()</code> se ha eliminado de las solicitudes de valor. </p><br><p>  Adem치s, se ha agregado una subconsulta a la vista del <code>indicator</code> .  Estos tipos de consultas crean un nuevo objeto para cada elemento en el que se calculan el <code>value</code> y <code>href</code> .  Por <code>value</code> , una consulta se ejecuta utilizando el m칠todo <code>query()</code> , al que se transfieren datos del contexto, y luego el m칠todo <code>size()</code> se aplica al resultado de la consulta.  Para <code>href</code> , se utiliza el m칠todo <code>pageLink()</code> , que genera un enlace a la p치gina del informe con una solicitud y un encabezado espec칤ficos.  Despu칠s de todos estos cambios, los indicadores se hicieron clic (tenga en cuenta que sus valores se han vuelto azules) y m치s funcionales. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e72/104/33c/e7210433ca45798701f34c6625cae050.gif" alt="Indicadores clicables"></p><br><p>  Para que la p치gina de inicio sea m치s 칰til, agregue una tabla con paquetes que tengan duplicados. </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'default'</span></span>, [ <span class="hljs-comment"><span class="hljs-comment">// ...      'h2:"Packages with more than one physical instance"', { view: 'table', data: ` group(&lt;name&gt;) .[value.size() &gt; 1] .sort(&lt;value.size()&gt;) .reverse() `, cols: [ { header: 'Name', content: 'text:key' }, { header: 'Version &amp; Location', content: { view: 'list', data: 'value.sort(&lt;version&gt;)', item: [ 'badge:version', 'text:path' ] } } ] } ]);</span></span></code> </pre> <br><p>  La tabla utiliza los mismos datos que el indicador de <code>Dup packages</code> .  La lista de paquetes se orden칩 por tama침o de grupo en orden inverso.  El resto de la configuraci칩n est치 relacionada con las columnas (por cierto, por lo general, no es necesario configurarlas).  Para la columna <code>Version &amp; Location</code> , definimos una lista anidada (ordenada por versi칩n), en la que cada elemento es un par del n칰mero de versi칩n y la ruta a la instancia. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a50/5fd/4ab/a505fd4aba48f6a0d025fc5cd4b84b24.png" alt="Tabla agregada con paquetes que tienen m치s de una instancia f칤sica"></p><br><h2 id="stranica-paketov">  P치gina del paquete </h2><br><p>  Ahora solo tenemos una descripci칩n general de los paquetes.  Pero ser칤a 칰til tener una p치gina con detalles sobre un paquete en particular.  Para hacer esto, cree un nuevo m칩dulo de <code>pages/package.js</code> y defina una nueva p치gina: </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'context'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">`{ name: #.id, instances: .[name = #.id] }`</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: [ <span class="hljs-string"><span class="hljs-string">'h1:name'</span></span>, <span class="hljs-string"><span class="hljs-string">'table:instances'</span></span> ] });</code> </pre> <br><p>  En este m칩dulo, definimos la p치gina con el <code>package</code> identificador.  El componente de <code>context</code> se utiliz칩 como representaci칩n inicial.  Este es un componente no visual que le ayuda a definir datos para asignaciones anidadas.  Tenga en cuenta que utilizamos <code>#.id</code> para obtener el nombre del paquete, que se recupera de una URL como esta <code>http://localhost:8123/#package:{id}</code> . </p><br><p>  No olvide incluir el nuevo m칩dulo en la configuraci칩n: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ <span class="hljs-string"><span class="hljs-string">'pages/default.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'pages/package.js'</span></span> <span class="hljs-comment"><span class="hljs-comment">//   ] } };</span></span></code> </pre> <br><p>  Resultado en el navegador: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ee/698/da0/3ee698da0907aebaa1ace032942c0575.png" alt="Ejemplo de p치gina de paquete"></p><br><p>  No es demasiado impresionante, pero por ahora.  Crearemos mapeos m치s complejos en manuales posteriores. </p><br><h2 id="bokovaya-panel">  Panel lateral </h2><br><p>  Como ya tenemos una p치gina de paquetes, ser칤a bueno tener una lista de todos los paquetes.  Para hacer esto, puede definir una vista especial: <code>sidebar</code> , que se muestra si est치 definida (no est치 definida de manera predeterminada).  Cree un nuevo m칩dulo <code>views/sidebar.js</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: <span class="hljs-string"><span class="hljs-string">'link:{ text: $, href: pageLink("package") }'</span></span> });</code> </pre> <br><p>  Ahora tenemos una lista de todos los paquetes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/503/326/a02/503326a020869af76a3b2076c5df2394.png" alt="Barra lateral agregada"></p><br><p>  Se ve bien  Pero con un filtro ser칤a a칰n mejor.  Ampliamos la definici칩n de <code>sidebar</code> : </p><br><pre> <code class="javascript hljs">discovery.view.define(<span class="hljs-string"><span class="hljs-string">'sidebar'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'content-filter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'name.[no #.filter or $~=#.filter].sort()'</span></span>, <span class="hljs-attr"><span class="hljs-attr">item</span></span>: { <span class="hljs-attr"><span class="hljs-attr">view</span></span>: <span class="hljs-string"><span class="hljs-string">'link'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-string"><span class="hljs-string">'{ text: $, href: pageLink("package"), match: #.filter }'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'text-match'</span></span> } } });</code> </pre> <br><p>  Aqu칤 ajustamos la lista en un componente de <code>content-filter</code> que convierte el valor de entrada en el campo de entrada a expresiones regulares (o <code>null</code> si el campo est치 vac칤o) y lo guarda como un valor de <code>filter</code> en el contexto (el nombre se puede cambiar con la opci칩n de <code>name</code> ).  Adem치s, para filtrar los datos de la lista, utilizamos <code>#.filter</code> .  Finalmente, aplicamos mapeo de enlaces para resaltar partes coincidentes con <code>text-match</code>  Resultado: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d55/74f/67e/d5574f67e7a2dd222194c66f5ecf0673.png" alt="Lista de filtros"></p><br><p>  En caso de que no le guste el dise침o predeterminado, puede personalizar los estilos como desee.  Supongamos que desea cambiar el ancho de la barra lateral, para esto necesita crear un archivo de estilo (por ejemplo, <code>views/sidebar.css</code> ): </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.discovery-sidebar</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">300px</span></span>; }</code> </pre> <br><p>  Y agregue un enlace a este archivo en la configuraci칩n, as칤 como a los m칩dulos de JavaScript: </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { ... view: { <span class="hljs-attr"><span class="hljs-attr">assets</span></span>: [ ... <span class="hljs-string"><span class="hljs-string">'views/sidebar.css'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  assets    *.css  'views/sidebar.js' ] } };</span></span></code> </pre> <br><h2 id="avtossylki">  Enlaces autom치ticos </h2><br><p>  El cap칤tulo final de esta gu칤a est치 dedicado a los enlaces.  Anteriormente, utilizando el m칠todo <code>pageLink()</code> , hicimos un enlace a la p치gina del paquete.  Pero adem치s del enlace, tambi칠n debe establecer el texto del enlace.  쯇ero c칩mo lo har칤amos m치s f치cil? </p><br><p>  Para simplificar el trabajo de los enlaces, necesitamos definir una regla para generar enlaces.  Esto se hace mejor en el script de <code>prepare</code> : </p><br><pre> <code class="javascript hljs">discovery.setPrepare(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ ... const packageIndex = data.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map, item</span></span></span><span class="hljs-function">) =&gt;</span></span> map .set(item, item) <span class="hljs-comment"><span class="hljs-comment">// key is item itself .set(item.name, item), // and `name` value new Map() ); discovery.addEntityResolver(value =&gt; { value = packageIndex.get(value) || packageIndex.get(value.name); if (value) { return { type: 'package', id: value.name, name: value.name }; } }); });</span></span></code> </pre> <br><p>  Agregamos un nuevo mapa (칤ndice) de paquetes y lo usamos para resolver entidades.  El solucionador de entidades intenta, si es posible, convertir el valor que se le pasa en un descriptor de entidad.  El descriptor contiene: </p><br><ul><li>  <code>type</code> - tipo de entidad </li><li>  <code>id</code> : una referencia 칰nica a una instancia de entidad utilizada en enlaces como ID </li><li>  <code>name</code> : se usa como texto de enlace </li></ul><br><p>  Finalmente, debe asignar este tipo a una p치gina espec칤fica (el enlace debe llevar a alguna parte, 쯨erdad?). </p><br><pre> <code class="javascript hljs">discovery.page.define(<span class="hljs-string"><span class="hljs-string">'package'</span></span>, { ... }, { <span class="hljs-attr"><span class="hljs-attr">resolveLink</span></span>: <span class="hljs-string"><span class="hljs-string">'package'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    `package`    });</span></span></code> </pre> <br><p>  La primera consecuencia de estos cambios es que algunos valores en la vista de <code>struct</code> ahora est치n marcados con un enlace a la p치gina del paquete: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eb2/dcd/502/eb2dcd5024f589a3ba8180f2b1ec538f.png" alt="Enlaces autom치ticos en estructura"></p><br><p>  Y ahora tambi칠n puede aplicar el componente de <code>auto-link</code> a un objeto o nombre de paquete: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/64d/3c2/f24/64d3c2f244164a22c55ff433409f6e22.png" alt="Usar el enlace autom치tico"></p><br><p>  Y, como ejemplo, puede modificar ligeramente la barra lateral: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   item: { view: 'link', data: '{ text: $, href: pageLink("package"), match: #.filter }', content: 'text-match' }, //   `auto-link` item: { view: 'auto-link', content: 'text-match:{ text, match: #.filter }' }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclusi칩n </h2><br><p>  Ahora tiene una comprensi칩n b치sica de los conceptos clave de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Discovery.js</a> .  En las siguientes gu칤as, veremos m치s de cerca los temas tratados. </p><br><p>  Puede ver el c칩digo fuente completo de la gu칤a en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio en GitHub</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probar c칩mo funciona en l칤nea</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">춰Sigue a @js_discovery</a> en Twitter para estar al d칤a de las 칰ltimas noticias! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/469115/">https://habr.com/ru/post/469115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../469097/index.html">Servidor web CentOS 8 con php7, node.js y redis</a></li>
<li><a href="../469099/index.html">Tareas de prueba en la entrevista del desarrollador: 쯦iene sentido?</a></li>
<li><a href="../469101/index.html">Aprender ingl칠s: c칩mo aprender a hablar como hablante nativo</a></li>
<li><a href="../469109/index.html">Juguetes de madera, tercera parte - 1989</a></li>
<li><a href="../469111/index.html">Reemplazar objeto con var: 쯤u칠 podr칤a salir mal?</a></li>
<li><a href="../469117/index.html">Programaci칩n bajo BC 0010 en 2019</a></li>
<li><a href="../469119/index.html">Las direcciones IPv4 en RIPE han terminado. Completamente terminado ...</a></li>
<li><a href="../469125/index.html">Tema oscuro de Thunderbird como raz칩n para ejecutar un analizador de c칩digo</a></li>
<li><a href="../469127/index.html">Optimizaci칩n o c칩mo no dispararte en el pie</a></li>
<li><a href="../469129/index.html">Debido al tema oscuro, Thunderbird tuvo que ejecutar un analizador de c칩digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>