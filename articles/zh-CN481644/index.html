<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌒 🛸 💇🏿 如何在21世纪的SQL数据库中生存：云，Kubernetes和PostgreSQL多主机 👨🏽‍🚀 🏡 🚇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="嗨哈布罗夫斯克 今天，课程将从PostgreSQL课程的第一组开始。 在这方面，我们想告诉您本课程的公开网络研讨会是如何进行的。 



 在下一堂公开课中，我们讨论了在云和Kubernetes时代SQL数据库面临的挑战。 同时，我们研究了SQL数据库在这些调用的影响下如何适应和变异。 

 该网络...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何在21世纪的SQL数据库中生存：云，Kubernetes和PostgreSQL多主机</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/481644/">  <i>嗨哈布罗夫斯克</i>  <i>今天，课程将从<a href="https://otus.pw/nwhU/">PostgreSQL</a>课程的第一组开始。</i>  <i>在这方面，我们想告诉您本课程的公开网络研讨会是如何进行的。</i> <br><br><img src="https://habrastorage.org/webt/bk/dg/wb/bkdgwboms19lihcydjxhd_do6is.jpeg"><br><hr><br> 在<a href="https://www.youtube.com/watch%3Fv%3DyiXP8ihL2eA">下一</a>堂<a href="https://www.youtube.com/watch%3Fv%3DyiXP8ihL2eA">公开课中，我们</a>讨论了在云和Kubernetes时代SQL数据库面临的挑战。 同时，我们研究了SQL数据库在这些调用的影响下如何适应和变异。 <br><br> 该网络研讨会由EPAM Systems的Google Cloud Practice Delivery Manager <a href="https://otus.pw/IVe0/">Valery Bezrukov</a>主持。 <a name="habracut"></a><br><br><h3> 当树木很小的时候... </h3><br> 首先，让我们回想一下DBMS的选择是如何在上世纪末开始的。 但是，这并不困难，因为在那时，选择DBMS始于<b>Oracle</b> 。 <br><br><img src="https://habrastorage.org/webt/za/ro/ub/zaroubp-wzhpvdvm8umssbidsde.png"><br><br> 实际上，在90年代后期-上世纪90年代初期，如果我们谈论工业可扩展数据库，则没有特别的选择。 是的，有IBM DB2，Sybase和一些其他数据库出现和消失了，但是总的来说，它们对Oracle的影响并不那么明显。 因此，当时工程师的技能以某种方式与现有的唯一选择联系在一起。 <br><br>  Oracle DBA应该能够： <br><br><ul><li> 从发行版安装Oracle Server </li><li> 配置Oracle Server： </li></ul><br><ul><li>  init.ora; </li><li>  listener.ora; </li></ul><br>  -创建： <br><br><ul><li> 表空间 </li><li> 方案 </li><li> 使用者 </li></ul><br><br>  -备份和还原； <br>  -进行监测； <br>  -处理次优请求。 <br><br> 同时，不是特别需要Oracle DBA： <br><br><ul><li> 能够选择最佳的DBMS或其他数据存储和处理技术； </li><li> 提供高可用性和水平可伸缩性（这并不总是DBA问题）； </li><li> 对主题领域，基础架构，应用架构，操作系统有很好的了解； </li><li> 执行数据的加载和卸载，以及在不同DBMS之间的数据迁移。 </li></ul><br><br> 总的来说，如果我们谈论当时的选择，那么它类似于80年代后期在苏联商店中的选择： <br><br><img src="https://habrastorage.org/webt/u-/ue/hx/u-uehxpuynbhmzgj78jqebims2o.png"><br><br><h3> 我们的时间 </h3><br> 从那以后，当然，树木长大了，世界变了，它变得像这样： <br><br><img src="https://habrastorage.org/webt/l_/-p/0a/l_-p0anmxny8o64hqnymm3jlow4.png"><br><br>  DBMS市场也发生了变化，从最新的Gartner报告中可以清楚地看出： <br><br><img src="https://habrastorage.org/webt/mr/r9/xv/mrr9xvkcwao2s8uf3oukwzdfiz4.png"><br><br> 在这里应该注意的是，云占据了它们的利基市场，其普及度正在增长。 如果您阅读了同一份Gartner报告，我们将看到以下结论： <br><br><ol><li> 许多客户正在将应用程序迁移到云。 </li><li> 新技术首先出现在云中，而不是它们将永远迁移到无云基础设施的事实。 </li><li> 随用随付的定价模型已经很熟悉。 每个人都只想为自己使用的东西付费，这甚至不是趋势，而只是事实的陈述。 </li></ol><br><h3> 现在呢 </h3><br> 今天，我们都在云中。 我们遇到的那些问题是选择的问题。 即使我们只谈论本地格式的DBMS技术选择，它也非常庞大。 我们还提供托管服务和SaaS。 因此，选择每年变得越来越复杂。 <br><br> 除选择问题外， <b>限制因素</b>也适用： <br><br><ul><li>  <b>价格</b> 。 许多技术仍然需要花钱。 </li><li>  <b>技能</b> 。 如果我们谈论的是自由软件，那么就会出现技能问题，因为自由软件需要具有足够能力的人进行部署和操作。 </li><li>  <b>功能的</b> 。 并不是说，即使基于相同的Postgres，在云中可用并构建的所有服务都没有与Postgres On-premises相同的功能。 这是您需要了解和理解的基本因素。 而且，此因素比了解单个DBMS的某些隐藏功能变得更加重要。 </li></ul><br>  <b>DA / DE正在等待什么：</b> <br><br><ul><li> 对主题领域和应用架构有很好的了解； </li><li> 考虑到任务选择正确的DBMS技术的能力； </li><li> 在现有限制的情况下选择最佳方法来实施所选技术的能力； </li><li> 执行数据迁移和迁移的能力； </li><li> 实施和操作所选解决方案的能力。 </li></ul><br> 以下<b>基于GCP的</b>示例演示了如何根据数据的结构来安排处理数据的特定技术的选择： <br><br><img src="https://habrastorage.org/webt/yx/pp/dh/yxppdhmwfv2mz70myzv_lht2ni4.png"><br><br> 请注意，架构中缺少PostgreSQL，所有都是因为它隐藏在<b>Cloud SQL</b>术语下。 当我们进入Cloud SQL时，我们需要再次做出选择： <br><br><img src="https://habrastorage.org/webt/ck/qr/hx/ckqrhx_1ckivxigooielk8zwwf4.png"><br><br> 应该注意的是，这种选择并不总是很清楚，因此应用程序开发人员通常会凭直觉进行指导。 <br><br>  <b>总计：</b> <br><br><ol><li> 距离越远，选择问题就越相关。 即使仅查看GCP，托管服务和SaaS，也只有在第4步才会提到RDBMS（并且附近有Spanner）。 另外，第5步通常显示PostgreSQL的选择，并且它旁边还有MySQL和SQL Server，也就是说，有<b>很多，但是您需要选择</b> 。 </li><li> 我们决不能忘记诱惑背景的限制。 通常每个人都想要一个扳手，但是价格昂贵。 结果，一个典型的查询看起来像这样： <i>“请为我们做Spanner，但是就Cloud SQL的价格而言，您是专业人士！”</i> </li></ol><br><img src="https://habrastorage.org/webt/lr/ea/fn/lreafntu62cx39itddembcwmdak.jpeg"><br><br><h3> 怎么办 </h3><br> 在不假装成最终真理的情况下，让我们说以下几点： <br><br>  <b>需要改变学习方式：</b> <br><br><ul><li> 像在DBA之前教过的那样学习是没有意义的； </li><li> 对一种产品的知识不再足够； </li><li> 但是要了解一个级别的数十个对象是不可能的。 </li></ul><br> 您不仅需要知道多少产品，还需要知道： <br><br><ul><li> 其应用的用例； </li><li> 不同的部署方法； </li><li> 每种方法的优缺点； </li><li> 类似和替代产品，以便做出明智的最佳选择，但并不总是偏向于熟悉的产品。 </li></ul><br> 您还需要能够迁移数据并了解与ETL集成的基本原理。 <br><br><h3> 真实案例 </h3><br> 在最近的过去，您必须为移动应用程序做一个后端。 在开始进行工作时，已经开发了后端并且可以实施了，开发团队在此项目上花费了大约两年的时间。 设置了以下任务： <br><br><ul><li> 制作CI / CD； </li><li> 审查架构； </li><li> 全部投入运作。 </li></ul><br> 该应用程序本身是微服务，并且从零开始并立即在GCP中开发了Python / Django代码。 对于目标受众，假设将有两个区域-美国和欧盟，并且流量是通过全球负载均衡器分配的。 所有工作负载和计算工作负载都在Google Kubernetes Engine中工作。 <br><br> 至于数据，有3种结构： <br><br><ul><li> 云存储 </li><li> 资料储存库； </li><li>  Cloud SQL（PostgreSQL）。 </li></ul><br><img src="https://habrastorage.org/webt/9c/n8/xn/9cn8xnhmpxyfxzoqvh86nqle8bo.png"><br><br> 您可能想知道为什么选择了Cloud SQL？ 说实话，近年来这样的问题引起了一些尴尬的停顿-感觉人们开始避开关系数据库，但是尽管如此，他们仍然继续积极地使用它们;-)。 <br><br> 对于我们的情况，选择Cloud SQL是出于以下原因： <br><br><ol><li> 如前所述，该应用程序是使用Django开发的，并且具有用于将持久性数据从SQL数据库映射到Python对象（Django ORM）的模型。 </li><li> 框架本身支持相当有限的DBMS列表： </li></ol><br><ul><li>  PostgreSQL的 </li><li>  MariaDB; </li><li> 的MySQL </li><li> 甲骨文 </li><li>  SQLite的 </li></ul><br> 因此，从该列表中直观地选择了PostgreSQL（事实上，它不是Oracle）。 <br><br>  <b>缺少的是：</b> <br><br><ul><li> 该应用程序仅在两个地区部署，并且计划出现在第三名（亚洲）； </li><li> 该数据库位于北美地区（爱荷华州）； </li><li> 对于客户而言，担心<b>由于</b> DBMS停机而导致欧洲和亚洲的<b>访问延迟</b>以及<b>服务</b>中断。 </li></ul><br> 尽管Django本身可以并行处理多个数据库并通过读写来划分它们，但应用程序中的记录却很少（超过90％-读取）。 总的来说，如果您可以对<b>欧洲和亚洲的主要基地进行复制</b> ，这将是一个折衷的解决方案。 好吧，有什么复杂的？ <br><br> 困难在于客户不想拒绝使用托管服务和Cloud SQL。 目前，Cloud SQL的可能性是有限的。  Cloud SQL支持高可用性（HA）和只读副本（RR），但仅在一个区域中支持相同的RR。 在美洲地区创建数据库后，尽管Postgres本身不会造成干扰，但无法使用Cloud SQL在欧洲地区进行只读副本。 与Google员工的通信并没有带来任何结果，并以“我们知道问题并正在努力解决问题，总有一天解决问题”的承诺结束。 <br><br> 如果列出Cloud SQL的论文可能性，它将看起来像这样： <br><br>  <b>1.高可用性（HA）：</b> <br><br><ul><li> 在一个区域内； </li><li> 通过磁盘复制 </li><li> 不使用PostgreSQL机制； </li><li> 可以进行自动和手动控制-故障转移/故障回复； </li><li> 切换时，DBMS在几分钟内不可用。 </li></ul><br>  <b>2.只读副本（RR）：</b> <br><br><ul><li> 在一个区域内； </li><li> 热备用 </li><li>  PostgreSQL流复制。 </li></ul><br> 另外，按照惯例，在选择技术时，您总是会遇到一些<b>限制</b> ： <br><br><ul><li> 除通过GKE之外，客户不想生产实体并使用IaaS； </li><li> 客户不想部署自助服务PostgreSQL / MySQL； </li><li> 好吧，总的来说，如果不是价格合理的话，Google Spanner会非常适合，但是Django ORM无法使用它，所以事情很好。 </li></ul><br> 在这种情况下，客户收到一个回填问题： <i>“您可以做些类似的事情来使其像Google Spanner一样，但它也可以与Django ORM一起使用吗？”</i> <br><br><h3> 选件编号0 </h3><br> 我想到的第一件事： <br><br><ul><li> 留在CloudSQL中 </li><li> 区域之间不会以任何形式进行集成复制； </li><li> 尝试通过PostgreSQL将副本固定到现有的Cloud SQL； </li><li> 在某个地方以某种方式启动PostgreSQL实例，但至少master不会碰。 </li></ul><br>  las，事实证明这是无法完成的，因为无法访问主机（通常在另一个项目中），例如pg_hba等，并且在超级用户下仍然没有访问权限。 <br><br><h3> 选项1 </h3><br> 经过进一步思考并考虑到以前的情况，思路发生了一些变化： <br><br><ul><li> 我们仍然试图将其保留在CloudSQL的范围之内，但我们正在切换到MySQL，因为MySQL的Cloud SQL具有一个外部主服务器，该主服务器： </li></ul><br>  -是外部MySQL的代理； <br>  -看起来像一个MySQL实例； <br>  -发明用于从其他云或本地迁移数据。 <br><br> 由于设置MySQL复制不需要访问主机，因此基本上一切正常，但是非常不稳定且不便。 而且，当我们走得更远时，它变得完全令人恐惧，因为我们将整个结构部署为terraform，突然发现外部主设备不受terraform的支持。 是的，Google有一个CLI，但是由于某种原因，所有内容偶尔都会工作-它是创建的，不是创建的。 也许是因为CLI的发明是为了向外部进行数据迁移，而不是为副本进行数据迁移。 <br><br> 实际上，这清楚表明Cloud SQL根本不适合这个词。 正如他们所说，我们竭尽所能。 <br><br><h3> 选项2 </h3><br> 由于无法将其保留在Cloud SQL中，因此我们尝试制定妥协解决方案的要求。 要求如下： <br><br><ul><li> 在Kubernetes中工作，最大程度地利用Kubernetes（DCS，...）和GCP（LB，...）的资源和功能; </li><li> 云中像HA代理这样一堆不必要的东西所带来的镇流器不足； </li><li> 能够在主要区域中运行HA PostgreSQL或MySQL； 在其他区域-主区域RR的HA及其副本（出于可靠性考虑）； </li><li> 多大师（不想与他联系，但这不是很重要） </li></ul>  。 <br> 由于这些要求，最终出现了<b>合适的DBMS选项和绑定</b> ： <br><br><ul><li>  MySQL Galera; </li><li>  CockroachDB; </li><li>  PostgreSQL工具 </li></ul>  ： <br>  -pgpool-II; <br>  -帕特罗尼。 <br><br><h3>  MySQL Galera </h3><br>  MySQL Galera技术由Codership开发，是InnoDB的插件。 特点： <br><br><ul><li> 多主 </li><li> 同步复制 </li><li> 从任何节点读取； </li><li> 记录到任何节点； </li><li> 整合的HA机制 </li><li> 有一个来自Bitnami的Helm图表。 </li></ul><br><h3> 蟑螂 </h3><br> 根据描述，这东西完全是夸张的，是用Go编写的一个开源项目。 主要参与者是蟑螂实验室（由Google的移民创立）。 此关系DBMS最初是为了分布式（即开即用的水平缩放）和容错而创建的。 该公司的作者概述了“将SQL功能的丰富性与NoSQL解决方案熟悉的水平可用性相结合”的目标。 <br><br> 不错的好处是支持postgres连接协议。 <br><br><h3>  pool池 </h3><br> 这是PostgreSQL的附加组件，实际上是一个接管所有连接并处理它们的新实体。 它拥有自己的加载程序平衡器和解析器，并已获得BSD许可。 它提供了足够的机会，但看起来有些令人恐惧，因为新实体的存在可能会成为其他冒险活动的来源。 <br><br><h3> 帕特罗尼 </h3><br> 这是最后一件事，而且事实证明，这并非徒劳。  Patroni是一个开源实用程序，从本质上讲，它是一个Python守护程序，可让您使用各种类型的复制和自动角色切换自动为PostgreSQL集群提供服务。 事实证明这很有趣，因为它与多维数据集很好地集成在一起，并且没有任何新实体。 <br><br><h3> 最终选择了什么 </h3><br> 选择并不容易： <br><br><ol><li>  <b>CockroachDB-</b>火，但愚蠢； </li><li>  <b>MySQL Galera</b>也不错，它在很多地方都使用过，但是MySQL; </li><li>  <b>Pgpool-</b>很多额外的实体，通常与云和K8s集成； </li><li>  Patroni-与K8完美集成，无需额外实体，与GCP LB集成良好。 </li></ol><br> 因此，选择权落在了帕特罗尼身上。 <br><br><h3> 结论 </h3><br> 现在该总结一下了。 是的，IT基础架构的世界已经发生了巨大变化，这仅仅是开始。 如果以前的云只是另一种基础架构，那么现在一切都将有所不同。 此外，云中的创新不断出现，它们将会出现，也许它们只会出现在云中，然后才通过初创公司的力量将其转移到本地。 <br><br> 至于SQL，SQL将继续存在。 这意味着必须知道PostgreSQL和MySQL，并且您需要能够使用它们，但更重要的是，要能够正确地应用它们。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481644/">https://habr.com/ru/post/zh-CN481644/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481630/index.html">最佳有用的工具和资源，以使2019年的初创企业变得更聪明</a></li>
<li><a href="../zh-CN481632/index.html">云提供商：谁是市场上最好的？</a></li>
<li><a href="../zh-CN481634/index.html">食品设计文摘，2019年11月</a></li>
<li><a href="../zh-CN481638/index.html">为什么复杂生产的3D模型有用</a></li>
<li><a href="../zh-CN481640/index.html">发布新版本的DevOpsProdigy KubeGraf插件</a></li>
<li><a href="../zh-CN481648/index.html">在Junos PyEZ上找到免费的ipv4子网的任务示例</a></li>
<li><a href="../zh-CN481652/index.html">在BlackBerry Android智能手机上的后门（？）</a></li>
<li><a href="../zh-CN481654/index.html">质量保证工程师如何使用Bot Framework在Test IT的帮助下使您的生活更轻松的故事</a></li>
<li><a href="../zh-CN481656/index.html">PagerDuty，或者为什么运营部门晚上无法入睡</a></li>
<li><a href="../zh-CN481662/index.html">尝试在Kubernetes中构建和自动化部署的新工具</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>