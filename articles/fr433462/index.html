<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèø üôçüèø üëçüèº Contr√¥les d'int√©grit√© et d√©gradation progressive des syst√®mes distribu√©s üíì üíÜüèº ‚ôèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme toujours, merci √† Fred Hebert et Sargun Dhillon d' avoir lu un brouillon de cet article et d'avoir offert de pr√©cieux conseils. 


 Dans son exp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contr√¥les d'int√©grit√© et d√©gradation progressive des syst√®mes distribu√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/433462/"><img src="https://habrastorage.org/webt/nv/bv/x0/nvbvx0meh2jzpwpvwzgvtpni1jk.png"><br><p>  <i>Comme toujours, merci √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fred Hebert</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sargun Dhillon d'</a> avoir lu un brouillon de cet article et d'avoir offert de pr√©cieux conseils.</i> </p><br><p>  Dans son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expos√© sur la vitesse,</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tamar Berkovichi</a> de Box a soulign√© l'importance des contr√¥les de performances pour le basculement automatique de la base de donn√©es.  En particulier, elle a not√© que la surveillance du temps d'ex√©cution des requ√™tes de bout en bout, en tant que m√©thode pour d√©terminer l'int√©grit√© d'une base de donn√©es, est meilleure que le simple ping (ping). </p><br><blockquote>  ... en transf√©rant le trafic vers un autre n≈ìud (r√©plique) afin d'√©liminer l'inaction, il est n√©cessaire de cr√©er une protection contre les rebonds et autres situations frontali√®res.  Ce n'est pas difficile.  L'objectif de l'organisation d'un travail efficace est de savoir <strong>quand</strong> mettre la base de donn√©es en premi√®re position, c'est-√†-dire  Vous devez √™tre en mesure d'√©valuer correctement l'int√©grit√© de la base de donn√©es.  Maintenant, de nombreux param√®tres auxquels nous sommes habitu√©s - par exemple, la charge du processeur, la latence, le taux d'erreur - sont des signaux secondaires.  Aucun de ces param√®tres ne fait √©tat de la capacit√© de la base de donn√©es √† traiter le trafic client.  Par cons√©quent, si vous les utilisez pour prendre une d√©cision concernant le changement, vous pouvez obtenir des r√©sultats faux positifs et faux n√©gatifs.  Notre v√©rificateur d'int√©grit√© effectue en fait des requ√™tes simples sur les n≈ìuds de la base de donn√©es et utilise les donn√©es sur les requ√™tes termin√©es et √©chou√©es pour √©valuer plus pr√©cis√©ment la sant√© de la base de donn√©es. </blockquote><p>  J‚Äôen ai discut√© avec un ami et il a sugg√©r√© que les contr√¥les de sant√© soient extr√™mement simples et que le trafic r√©el soit le meilleur crit√®re pour √©valuer la sant√© d‚Äôun processus. </p><a name="habracut"></a><br><p>  Souvent, les discussions relatives √† la mise en ≈ìuvre des bilans de sant√© s'articulent autour de deux options oppos√©es: des tests de communication / signal simples ou des tests complexes de bout en bout.  Dans cet article, je tiens √† souligner le probl√®me associ√© √† l'utilisation de la forme susmentionn√©e de contr√¥les d'int√©grit√© pour certains types de solutions d'√©quilibrage de charge, ainsi que la n√©cessit√© d'une approche plus d√©taill√©e pour √©valuer la sant√© d'un processus. </p><br><h3 id="dva-tipa-proverok-rabotosposobnosti">  Deux types de bilans de sant√© </h3><br><p>  Les contr√¥les d'int√©grit√©, m√™me dans de nombreux syst√®mes modernes, se r√©partissent g√©n√©ralement en deux cat√©gories: les contr√¥les au niveau du n≈ìud et au niveau du service. </p><br><p> Par exemple, Kubernetes impl√©mente la validation en analysant l'√©tat de <em>pr√©paration</em> et la <em>capacit√© de survie</em> .  Le contr√¥le de disponibilit√© est utilis√© pour d√©terminer la capacit√© du foyer √† desservir le trafic.  Si la v√©rification de l'√©tat de pr√©paration n'est pas effectu√©e, elle est supprim√©e des points d'extr√©mit√© qui composent le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service</a> , et pour cette raison, dans l'√¢tre, jusqu'√† la fin de la v√©rification, aucun trafic n'est achemin√©.  D'un autre c√¥t√©, un contr√¥le de survie est utilis√© pour d√©terminer si <em>un</em> service <em>r√©pond</em> √† un blocage ou √† un verrou.  En cas d'√©chec, le conteneur individuel dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kubelet est red√©marr√©</a> .  De m√™me, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Consul</a> autorise plusieurs formes de <code>checks</code> : bas√©s sur des <code>script</code> bas√©s sur HTTP et dirig√©s vers une URL sp√©cifique, bas√©s sur TTL ou m√™me des alias. </p><br><p>  La m√©thode la plus courante pour impl√©menter un contr√¥le d'int√©grit√© au niveau du <em>service</em> consiste √† d√©terminer le point final du contr√¥le d'int√©grit√©.  Par exemple, dans gRPC, un bilan de sant√© devient lui-m√™me un appel RPC.  gRPC permet √©galement des v√©rifications de l' <em>int√©grit√© du</em> niveau de service et des v√©rifications g√©n√©rales de l' <em>int√©grit√© du serveur gRPC</em> . </p><br><p>  Dans le pass√©, les contr√¥les de sant√© au niveau de l'h√¥te √©taient utilis√©s comme signal pour d√©clencher une alerte.  Par exemple, une alerte avec une charge moyenne du processeur (actuellement consid√©r√©e comme un mod√®le anti-conception).  M√™me si le bilan de sant√© n'est pas utilis√© directement pour la notification, il sert toujours de base √† un certain nombre d'autres d√©cisions automatiques d'infrastructure, par exemple, concernant l'√©quilibrage de charge et (parfois) le circuit ouvert.  Dans les sch√©mas de donn√©es de grille de services tels qu'Envoy, <em>les</em> donn√©es de <em>contr√¥le d'</em> int√©grit√©, lorsqu'il s'agit de d√©terminer le routage du trafic vers une instance, vont de l'avant en ce qui concerne les donn√©es de d√©couverte de service. </p><br><h3 id="rabotosposobnost--eto-spektr-a-ne-binarnaya-taksonomiya">  L'efficacit√© est un spectre, pas une taxonomie binaire </h3><br><p>  Une demande d'√©cho, ou ping, peut uniquement √©tablir si le service <em>fonctionne</em> , tandis que les tests de bout en bout sont des proxys pour √©tablir si le syst√®me est capable d'ex√©cuter une <em>unit√© de travail</em> sp√©cifique, o√π l'unit√© de travail peut √™tre une <em>requ√™te de base de donn√©es</em> ou un <em>calcul sp√©cifique</em> .  Quelle que soit la forme d'un bilan de sant√©, son <em>r√©sultat est</em> consid√©r√© comme purement binaire: ¬´r√©ussi¬ª ou ¬´√©chou√©¬ª. </p><br><p>  Dans les options d'infrastructure dynamiques et souvent ¬´automatiquement √©volutives¬ª d'aujourd'hui, un processus unique qui ¬´fonctionne¬ª n'a pas d'importance s'il ne peut pas effectuer une unit√© de travail sp√©cifique.  Il s'av√®re que les contr√¥les simplifi√©s, tels que les tests d'√©cho, sont presque inutiles. </p><br><p>  Il est facile de d√©terminer quand un service est compl√®tement <em>d√©connect√©</em> , mais il est beaucoup plus difficile d'√©tablir le degr√© d' <em>op√©rabilit√© d'un</em> service en cours d'ex√©cution.  Il est tout √† fait possible que le processus soit en cours (c'est-√†-dire que le bilan de sant√© passe) et que le trafic soit achemin√©, mais pour effectuer une certaine unit√© de travail, par exemple, pendant la p√©riode de retard du service p99, cela ne suffit pas. </p><br><p>  Souvent, le travail ne peut pas √™tre termin√© car le processus est surcharg√©.  Dans les services hautement comp√©titifs, la ¬´congestion¬ª est parfaitement corr√©l√©e avec le nombre de demandes simultan√©es trait√©es par un seul processus avec une file d'attente excessive, ce qui peut entra√Æner une augmentation du d√©lai pour un appel RPC (bien que le plus souvent, le service de niveau inf√©rieur met simplement la demande en attente et r√©essaye sur d√©lai d'attente).  Cela est particuli√®rement vrai si le point de terminaison du contr√¥le d'int√©grit√© est configur√© pour revenir automatiquement au code d'√©tat HTTP 200, tandis que l'op√©ration r√©elle effectu√©e par le service implique des E / S r√©seau ou des calculs. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/420/7bf/d6b/4207bfd6ba6f7c4afd6892c8f643112d.png" alt="image"></p><br><p>  La performance du processus est un spectre.  Tout d'abord, nous nous int√©ressons √† la <em>qualit√© de service</em> , par exemple, le temps n√©cessaire au processus de restauration du r√©sultat d'une unit√© de travail sp√©cifique, et la pr√©cision du r√©sultat. </p><br><p>  Il est possible que le processus oscille entre diff√©rents degr√©s de <em>capacit√©</em> de <em>travail au</em> cours de sa dur√©e de vie: de la pleine <em>capacit√© de travail</em> (par exemple, la capacit√© de fonctionner au niveau de parall√©lisme attendu) au point d'inop√©rabilit√© (lorsque les files d'attente commencent √† se remplir) et le point o√π le processus entre compl√®tement dans une zone inop√©rante (ressenti qualit√© de service r√©duite).  Seuls les services les plus triviaux peuvent √™tre construits sur l'hypoth√®se qu'il n'y a pas de degr√© d'√©chec partiel dans une p√©riode o√π un √©chec partiel implique que certaines fonctions fonctionnent et d'autres sont d√©sactiv√©es, et pas seulement ¬´certaines demandes sont ex√©cut√©es, d'autres ne sont pas ex√©cut√©es¬ª.  Si l'architecture de service ne permet pas de corriger correctement une d√©faillance partielle, le <em>client</em> corrige automatiquement la t√¢che de correction d'erreur. </p><br><p>  Une infrastructure adaptative et auto-r√©paratrice doit √™tre construite en sachant que de telles fluctuations sont parfaitement <em>normales</em> .  Il est √©galement important de se rappeler que cette diff√©rence n'a d'importance qu'en ce qui concerne l'√©quilibrage de charge - pour l'orchestrateur, par exemple, cela n'a aucun sens de red√©marrer le processus simplement parce que le processus est au bord de la surcharge. </p><br><p>  En d'autres termes, pour le niveau d'orchestration, il est tout √† fait raisonnable de consid√©rer l'op√©rabilit√© du processus comme un √©tat binaire et de red√©marrer le processus uniquement apr√®s une panne ou un gel.  Mais dans la couche d' <em>√©quilibrage de charge</em> (qu'il s'agisse d'un proxy externe, par exemple, Envoy ou d'une biblioth√®que interne c√¥t√© client), il est extr√™mement important qu'il agisse sur la base d'informations plus d√©taill√©es sur l'op√©rabilit√© du processus - lorsqu'il prend les d√©cisions appropri√©es concernant la coupure du circuit et le d√©chargement de la charge.  La d√©gradation progressive du service est impossible s'il est impossible de d√©terminer avec pr√©cision le niveau de performance du service √† tout moment. </p><br><p>  Laissez-moi vous dire par exp√©rience: la concurrence illimit√©e est souvent le principal facteur conduisant √† la d√©gradation du service ou √† une baisse permanente de la productivit√©.  L'√©quilibrage de charge (et, par cons√©quent, le d√©lestage) se r√©sume souvent √† une gestion efficace de la concurrence et √† l'application d'une contre-pression, emp√™chant le syst√®me de surcharger. </p><br><h3 id="neobhodimost-obratnoy-svyazi-pri-primenenii-protivodavleniya">  Le besoin de r√©troaction lors de l'application de la contre-pression </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Matt Ranney a</a> √©crit un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article ph√©nom√©nal</a> sur la concurrence illimit√©e et le besoin de contre-pression dans Node.js.  Tout l'article est curieux, mais la principale conclusion (du moins pour moi) √©tait la n√©cessit√© d'un retour d'informations entre le processus et son unit√© de sortie (g√©n√©ralement un √©quilibreur de charge, mais parfois un autre service). </p><br><blockquote>  L'astuce est que lorsque les ressources sont √©puis√©es, quelque chose doit √™tre donn√© quelque part.  La demande augmente et la productivit√© ne peut pas augmenter comme par magie.  Pour limiter les t√¢ches entrantes, la premi√®re chose √† faire est de d√©finir une limite de vitesse au niveau du site, par adresse IP, utilisateur, session ou, au mieux, par un √©l√©ment important pour l'application.  De nombreux √©quilibreurs de charge peuvent limiter la vitesse d'une mani√®re plus compliqu√©e que de limiter le serveur Node.js entrant, mais ils ne remarquent g√©n√©ralement pas de probl√®mes tant que le processus n'est pas dans une situation difficile. </blockquote><p>  Les limites de vitesse et les circuits ouverts bas√©s sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des seuils et des limites statiques peuvent √™tre peu fiables et instables</a> en termes d'exactitude et d'√©volutivit√©.  Certains √©quilibreurs de charge (en particulier HAProxy) fournissent de nombreuses statistiques sur la longueur des files d'attente internes pour <em>chaque serveur</em> et <em>chaque</em> <em>partie de serveur</em> .  De plus, HAProxy permet l'ex√©cution d'un <code>agent-check</code> ( <code>agent-check</code> auxiliaire ind√©pendant du contr√¥le d'int√©grit√© normal), ce qui permet au processus de fournir au serveur proxy un retour d'informations d'int√©grit√© plus pr√©cis et dynamique.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien vers les documents</a> : </p><br><blockquote>  La v√©rification de l'int√©grit√© de l'agent est effectu√©e par une connexion TCP au port en fonction du param√®tre de <code>agent-port</code> sp√©cifi√© et en lisant la cha√Æne ASCII.  Une ligne se compose d'une s√©rie de mots s√©par√©s par des espaces, des tabulations ou des virgules dans n'importe quel ordre, se terminant √©ventuellement par <code>/r</code> et / ou <code>/n</code> et comprenant les √©l√©ments suivants: <br><br>  - Repr√©sentation d'un pourcentage entier positif de ASCII, par exemple <code>75%</code> .  Les valeurs de ce format d√©terminent le poids proportionnellement √† la valeur initiale <br>  La valeur de serveur pond√©r√©e configur√©e au d√©marrage de HAProxy.  Veuillez noter qu'une valeur de poids z√©ro est indiqu√©e sur la page des statistiques comme <code>DRAIN</code> partir du moment d'un impact similaire sur le serveur (elle est supprim√©e de la batterie LB). <br><br>  - Param√®tre de cha√Æne <code>maxconn</code> : suivi d'un entier (pas d'espace).  Valeurs dans <br>  Ce format d√©finit le <code>maxconn</code> serveur <code>maxconn</code> .  Nombre maximum <br>  les connexions d√©clar√©es doivent √™tre multipli√©es par le nombre d'√©quilibreurs de charge et les diff√©rentes parties du serveur √† l'aide de ce contr√¥le d'int√©grit√© pour obtenir le nombre total de connexions que le serveur peut √©tablir.  Par exemple: <code>maxconn:30</code> <br><br>  - Le mot est <code>ready</code> .  Cela traduit l'√©tat administratif du serveur en <br>  Mode <code>READY</code> , annulant l'√©tat <code>DRAIN</code> ou <code>MAINT</code> . <br><br>  - Le mot <code>drain</code> .  Cela traduit l'√©tat administratif du serveur en <br>  Mode <code>DRAIN</code> ("drain"), apr√®s quoi le serveur n'acceptera pas de nouvelles connexions, √† l'exception des connexions accept√©es via la base de donn√©es. <br><br>  - Le mot <code>maint</code> .  Cela traduit l'√©tat administratif du serveur en <br>  Mode <code>MAINT</code> (¬´maintenance¬ª), apr√®s quoi le serveur n'acceptera aucune nouvelle connexion et les contr√¥les de sant√© s'arr√™teront. <br><br>  - Les mots <code>down</code> , <code>failed</code> ou <code>stopped</code> , qui peuvent √™tre suivis d'une ligne de description apr√®s le symbole pointu (#).  Tous indiquent l'√©tat de fonctionnement du serveur <code>DOWN</code> (¬´off¬ª), mais puisque le mot lui-m√™me est affich√© sur la page des statistiques, la diff√©rence permet √† l'administrateur de d√©terminer si la situation √©tait attendue: le service peut √™tre intentionnellement arr√™t√©, certains tests de confirmation peuvent appara√Ætre, mais √©chouer, ou √™tre consid√©r√© comme d√©sactiv√© (aucun processus, aucune r√©ponse du port). <br><br>  - Le mot up indique l'√©tat de fonctionnement du serveur <code>UP</code> (¬´on¬ª) si les contr√¥les d'int√©grit√© confirment √©galement la disponibilit√© du service. <br><br>  Les param√®tres non revendiqu√©s par l'agent ne sont pas modifi√©s.  Par exemple, un agent ne peut √™tre con√ßu que pour surveiller l'utilisation du processeur et signaler uniquement une valeur de poids relatif sans interagir avec l'√©tat de fonctionnement.  De m√™me, le programme agent peut √™tre con√ßu comme une interface utilisateur final avec 3 commutateurs permettant √† l'administrateur de modifier uniquement l'√©tat administratif. <br><br>  <strong>Cependant, il convient de garder √† l'esprit que seul l'agent peut annuler ses propres actions.Par cons√©quent, si le serveur est d√©fini sur DRAIN ou DOWN √† l'aide de l'agent, l'agent doit effectuer d'autres actions √©quivalentes pour red√©marrer le service.</strong> <br><br>  L'√©chec de la connexion √† l'agent n'est pas consid√©r√© comme une erreur, car la capacit√© de connexion est test√©e en effectuant r√©guli√®rement une v√©rification de l'√©tat, qui est d√©marr√©e √† l'aide du param√®tre de v√©rification.  Cependant, si un message d'arr√™t arrive, un avertissement n'est pas une bonne id√©e d'arr√™ter l'agent, car seul l'agent signalant l'arr√™t peut r√©activer le serveur. </blockquote><p>  Ce sch√©ma de communication dynamique du service avec l'unit√© de sortie est extr√™mement important pour cr√©er une infrastructure auto-adaptative.  Un exemple serait l'architecture avec laquelle j'ai travaill√© √† un emploi pr√©c√©dent. </p><br><p>  J'ai travaill√© chez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">imgix</a> , une start-up de traitement d'images en temps r√©el.  √Ä l'aide d'une simple URL API, les images sont r√©cup√©r√©es et converties en temps r√©el, puis utilis√©es n'importe o√π dans le monde via CDN.  Notre pile √©tait assez complexe ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comme d√©crit ci-dessus</a> ), mais en bref, notre infrastructure comprenait un niveau d'√©quilibrage et d'√©quilibrage de charge (en tandem avec le niveau de r√©ception des donn√©es de la source), le niveau de mise en cache source, le niveau de traitement d'image et le niveau de livraison de contenu. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f58/98a/d1e/f5898ad1e33db764d7551e29d0a7e5dc.png" alt="image"></p><br><p>  Le niveau d'√©quilibrage de charge √©tait bas√© sur le service Spillway, qui faisait office de proxy inverse et de courtier de demandes.  C'√©tait un service purement interne;  au bord du gouffre, nous avons d√©marr√© nginx et HAProxy et Spillway, il n'a donc pas √©t√© con√ßu pour compl√©ter TLS ou ex√©cuter d'autres fonctions √† partir de cet ensemble innombrable qui est g√©n√©ralement de la comp√©tence du proxy de fronti√®re. </p><br><p>  Spillway √©tait compos√© de deux composants: la partie client (Spillway FE) et le courtier.  Bien qu'au d√©part, les deux composants se trouvaient dans le m√™me fichier binaire, √† un moment donn√©, nous avons d√©cid√© de les s√©parer en fichiers binaires distincts qui √©taient d√©ploy√©s simultan√©ment sur le m√™me h√¥te.  Principalement parce que ces deux composants avaient des profils de performances diff√©rents et que la partie client √©tait presque enti√®rement connect√©e au processeur.  La t√¢che de la partie client √©tait d'effectuer un traitement pr√©liminaire de chaque demande, y compris une v√©rification pr√©liminaire au niveau de la mise en cache source, pour s'assurer que l'image √©tait mise en cache dans notre centre de donn√©es avant d'envoyer la demande de conversion d'image √† l'ex√©cuteur testamentaire. </p><br><p>  √Ä tout moment, nous avions un pool fixe (une douzaine, si ma m√©moire est bonne) d'artistes qui pouvaient √™tre connect√©s au m√™me courtier Spillway.  Les artistes √©taient responsables de la conversion r√©elle de l'image (recadrage, redimensionnement, traitement PDF, rendu GIF, etc.).  Ils ont tout trait√©, des PDF de centaines de pages et des GIF avec des centaines de cadres aux simples fichiers d'images.  Une autre caract√©ristique de l'entrepreneur √©tait que, bien que tous les r√©seaux soient compl√®tement asynchrones, il n'y avait aucune conversion r√©elle sur le GPU lui-m√™me.  √âtant donn√© que nous travaillions en temps r√©el, il √©tait impossible de pr√©dire √† quoi ressemblerait notre trafic √† un moment donn√©.  Notre infrastructure a d√ª s'adapter aux diff√©rentes formes de trafic entrant - sans intervention manuelle de l'op√©rateur. </p><br><p>  Compte tenu des sch√©mas de trafic disparates et h√©t√©rog√®nes que nous avons souvent rencontr√©s, il est devenu n√©cessaire que les artistes interpr√®tes ou ex√©cutants refusent d'accepter les demandes entrantes (m√™me lorsqu'ils sont pleinement op√©rationnels) si l'acceptation de la connexion mena√ßait de surcharger l'artiste.  Chaque demande adress√©e √† l'intervenant contenait un certain ensemble de m√©tadonn√©es sur la nature de la demande, ce qui permettait √† l'interpr√®te de d√©terminer s'il √©tait en mesure de r√©pondre √† cette demande.  Chaque ex√©cuteur avait son propre ensemble de donn√©es statistiques sur les demandes avec lesquelles il travaillait actuellement.  L'employ√© a utilis√© ces statistiques conjointement avec les m√©tadonn√©es de la demande et d'autres donn√©es heuristiques, telles que les donn√©es de taille de tampon de socket, pour d√©terminer s'il a re√ßu correctement la demande entrante.  Si l'employ√© a d√©termin√© qu'il ne pouvait pas accepter la demande, il a cr√©√© une r√©ponse qui ne diff√©rait pas de la v√©rification de l'agent HAProxy informant son √©vacuateur de crues sur son fonctionnement. </p><br><p>  Spillway a surveill√© la performance de tous les artistes de la piscine.  Au d√©but, j'ai essay√© d'envoyer une demande trois fois de suite √† diff√©rents ex√©cuteurs (la pr√©f√©rence √©tait donn√©e √† ceux qui avaient l'image d'origine dans les bases de donn√©es locales et qui n'√©taient pas surcharg√©s), et si les trois ex√©cuteurs refusaient d'accepter la demande, la demande √©tait mise en file d'attente dans le courtier √† l'int√©rieur de la m√©moire.  Le courtier a pris en charge trois formes de files d'attente: la file d'attente LIFO, la file d'attente FIFO et la file d'attente prioritaire.  Si les trois files d'attente ont √©t√© remplies, le courtier a simplement rejet√© la demande, permettant au client (HAProxy) de r√©essayer apr√®s la p√©riode de retard.  Lorsqu'une demande √©tait plac√©e dans l'une des trois files d'attente, tout ex√©cuteur libre pouvait la supprimer de l√† et la traiter.  Il y a certaines difficult√©s associ√©es √† l'attribution d'une priorit√© √† une demande et √† la d√©cision laquelle des trois files d'attente (LIFO, FIFO, files d'attente bas√©es sur la priorit√©) doit √™tre plac√©e, mais c'est un sujet pour un article s√©par√©. </p><br><p>  Pour le bon fonctionnement du service, nous n'avons pas eu besoin de discuter de cette forme de retour dynamique.  Nous avons soigneusement surveill√© la taille de la file d'attente du courtier (les trois files d'attente) et Prometheus a √©mis l'un des principaux avertissements lorsque la taille de la file d'attente d√©passait un certain seuil (ce qui √©tait assez rare). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f83/768/88c/f8376888c479f9dbcbadbee1c3e9539e.png" alt="image"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Image de ma pr√©sentation sur le syst√®me de surveillance Prometheus au Google NYC en novembre 2016</a> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a19/7b7/57c/a197b757cbe5660023612137e3c780d4.png" alt="image"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'avertissement est tir√© de ma pr√©sentation sur le syst√®me de surveillance Prometheus lors de la conf√©rence OSCON en mai 2017.</a> </p><br><p>  Au d√©but de cette ann√©e, Uber a publi√© un article int√©ressant dans lequel il a mis en lumi√®re son approche de la mise en ≈ìuvre d'un niveau de d√©lestage bas√© sur la qualit√© de service. </p><br><blockquote>  En analysant les √©checs au cours des six derniers mois, nous avons constat√© que 28% d'entre eux pouvaient √™tre att√©nu√©s ou √©vit√©s par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une d√©gradation en douceur</a> . <br><br>  Les trois types de d√©faillances les plus courants √©taient associ√©s aux facteurs suivants: <br><br>  - Modifications du sch√©ma de la demande entrante, y compris l'encombrement et les mauvais n≈ìuds d'op√©rateur. <br>  - √âpuisement des ressources telles que processeur, m√©moire, circuit d'entr√©e / sortie ou ressources r√©seau. <br>  - D√©faillances de d√©pendance, y compris l'infrastructure, l'entrep√¥t de donn√©es et les services en aval. <br><br>  Nous avons impl√©ment√© un d√©tecteur de surcharge bas√© sur l'algorithme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CoDel</a> .  Pour chaque point de terminaison activ√©, un tampon de requ√™te l√©ger (impl√©ment√© sur la base de gourutin et de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">canaux</a> ) est ajout√© pour suivre les d√©lais entre le moment de la r√©ception de la requ√™te de la source de l'appel et le d√©but du traitement de la requ√™te dans le gestionnaire.         ,   ,      . </blockquote><p>   ,  ,         ,  -      .   2013  Google     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´The Tail at Scale¬ª</a> ,               (   ),        (   )    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8ff/2b5/379/8ff2b5379239a40c0b193f483a85fa86.jpg" alt="image"></p><br><p>             ,           .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">      </a> ,         . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6fd/068/1fb/6fd0681fb86c70cff833ae170f53ce5c.png" alt="image"></p><br><p> (       ) </p><br><p> ,              ,       : </p><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> , QCon London 2018. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   :    -</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ,  LISA 2017. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   ‚Äì   </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> , Strangeloop 2017. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  : ,    </a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> , Strangeloop 2017. </li><li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´   ¬ª</a> . </li></ol><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>           ,  TCP/IP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>    ), IP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ECN</a> ( IP     )  Ethernet,    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </p><br><p>        ,             .               .    ,           .             . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433462/">https://habr.com/ru/post/fr433462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433446/index.html">Security Week 51: bug dans WordPress 5.0 et Logitech, vuln√©rabilit√© de photo Facebook</a></li>
<li><a href="../fr433448/index.html">Analyse comparative des march√©s utilis√©s Voitures allemandes et fran√ßaises dans le segment B et C</a></li>
<li><a href="../fr433450/index.html">Grandir et enseigner. Comment nous nous sommes li√©s d'amiti√© avec PEGA</a></li>
<li><a href="../fr433456/index.html">Comment convaincre un client ou une entreprise d'utiliser Flutter</a></li>
<li><a href="../fr433458/index.html">Quelques avantages √©vidents de Serverless pour DevOps</a></li>
<li><a href="../fr433466/index.html">Comparez les pages. Plugin simple pour Atlassian Confluence</a></li>
<li><a href="../fr433472/index.html">Unity 2018.3 est sorti</a></li>
<li><a href="../fr433474/index.html">Pylint de l'int√©rieur vers l'ext√©rieur. Comment fait-il</a></li>
<li><a href="../fr433476/index.html">50 nuances de c√©leri</a></li>
<li><a href="../fr433478/index.html">Pourquoi Django est choisi dans Tinkoff Magazine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>