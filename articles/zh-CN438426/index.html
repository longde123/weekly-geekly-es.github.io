<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏪ 🐴 ✍🏽 回到Istio的微服务。 第一部分 🍓 🐶 🚱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注意事项 佩雷夫 服务网格在遵循微服务架构的应用程序的现代基础架构中无疑已经成为一个重要的解决方案。 尽管许多DevOps工程师可能会听到Istio，但它是一个相当新的产品，就提供的功能而言，它是全面的，可能需要花费大量时间才能彼此了解。 德国工程师Rinor Maloku在电信公司Orange N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>回到Istio的微服务。 第一部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/438426/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>注意事项</b></i>  <i><b>佩雷夫</b></i>  <i>服务网格在遵循微服务架构的应用程序的现代基础架构中无疑已经成为一个重要的解决方案。</i>  <i>尽管许多DevOps工程师可能会听到Istio，但它是一个相当新的产品，就提供的功能而言，它是全面的，可能需要花费大量时间才能彼此了解。</i>  <i>德国工程师Rinor Maloku在电信公司Orange Networks负责大客户的云计算，他撰写了一系列精彩的材料，使您可以快速而深入地研究Istio。</i>  <i>他从Istio可以做什么以及如何用自己的眼睛快速看到它开始他的故事。</i> <br><br>  <b>Istio</b>是与Google，IBM和Lyft的团队合作开发的一个开源项目。 它解决了基于微服务的应用程序中出现的困难，例如： <a name="habracut"></a><br><br><ul><li>  <b>流量管理</b> ：超时，重试，负载均衡； </li><li>  <b>安全性</b> ：最终用户的认证和授权； </li><li>  <b>可观察性</b> ：跟踪，监视，记录。 </li></ul><br> 所有这些都可以在应用程序级别解决，但是之后您的服务将不再是“微型”的。 解决这些问题的所有额外努力都是对公司资源的额外浪费，这些资源可以直接用于商业价值。 考虑一个例子： <br><blockquote>项目经理：添加反馈需要多长时间？ <br> 开发人员：两个冲刺。 <br><br>  MP：什么？..只是CRUD！ <br>  R：制作CRUD是一项简单的任务，但是我们仍然需要对用户和服务进行身份验证和授权。 由于网络不可靠，因此您将需要实施重复的请求以及客户端中的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">断路器模式</a> 。 不过，要确保整个系统都不会崩溃，您将需要超时和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">隔离墙</a> <i>（有关上述两种模式的更多详细信息，请参见文章中的大约Transl。）</i> ，以及为了检测问题，进行监视，跟踪，[...] <br><br>  MP：哦，那就让我们将此功能插入产品服务中。 </blockquote> 我认为这个主意很明确：添加一项服务所需的步骤和工作量很大。 在本文中，我们将研究Istio如何从服务中消除上述所有困难（并非针对业务逻辑）。 <br><br><img src="https://habrastorage.org/webt/l4/js/7o/l4js7omne2rslxitn0zr_lgusee.png"><br><br>  <b>注意</b> ：本文假定您具有Kubernetes的实践知识。 否则，我建议阅读<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我对Kubernetes的介绍，然后</a>再继续阅读本材料。 <br><br><h2> 想法伊斯蒂奥 </h2><br> 在没有Istio的世界中，一项服务会直接向另一项服务发出请求，如果发生故障，该服务必须自行处理：进行新的尝试，提供超时，打开断路器等。 <br><br><img src="https://habrastorage.org/webt/ov/uv/g5/ovuvg5sepxqvj7wduhnl3uiixyi.png"><br>  <i>Kubernetes中的网络流量</i> <br><br>  Istio还提供了一种专门的解决方案，它与服务完全独立，并且通过干扰网络交互来起作用。 因此，它实现了： <br><br><ul><li>  <b>容错</b> ：根据响应中的状态代码，它可以了解请求是否失败，然后再次运行。 </li><li>  <b>Canary推出</b> ：仅将请求数量的固定百分比重定向到服务的新版本。 </li><li>  <b>监控和指标</b> ：服务响应了多长时间？ </li><li>  <b>跟踪和可观察性</b> ：向每个请求添加特殊的标头，并在集群中跟踪它们。 </li><li>  <b>安全性</b> ：提取JWT令牌，对用户进行身份验证和授权。 </li></ul><br> 这些只是少数可能性（真的只有少数几种！）吸引您。 现在，让我们深入了解技术细节！ <br><br><h2> 建筑Istio </h2><br>  Istio会拦截所有网络流量并对其应用一组规则，并以边车集装箱的形式将智能代理插入每个吊舱。 激活所有功能的代理形成一个<b>数据平面</b> ，可以使用<b>控制平面</b>动态配置它们。 <br><br><h2> 数据平面 </h2><br> 插入到吊舱中的代理使Istio可以轻松满足我们的需求。 例如，检查重试和断路器功能。 <br><br><img src="https://habrastorage.org/webt/8t/7x/xn/8t7xxntkiuakkk5sbn41b4rualg.gif"><br>  <i>Envoy如何实现重试和断路</i> <br><br> 总结一下： <br><br><ol><li>  Envoy <i>（谈论位于作为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">单独产品</a>分发的Sidecar容器中的代理-大约Transl。）</i>将请求发送到服务B的第一个实例，并且发生故障。 </li><li> 特使塞德卡<i>重试</i> 。  <i>（1）</i> </li><li> 失败的请求将返回给调用它的代理。 </li><li> 这将打开断路器，并为下一个请求调用下一个服务。  <i>（2）</i> </li></ol><br> 这意味着您不必使用下一个Retry库，也不必使用编程语言X，Y或Z来实现自己的Circuit Breaking和Service Discovery实施。所有这些以及更多内容都可以在Istio中直接使用，并且不需要对代码进行<b>任何</b>更改。 <br><br> 太好了！ 现在，您可能想和Istio一起航行，但是仍然存在一些疑问和开放性问题。 如果这是一种适用于生活中所有场合的通用解决方案，那么您就有合理的怀疑：毕竟，实际上所有此类决定都不适用于任何场合。 <br><br> 最后，您问：“它可定制吗？” <br><br> 现在您已准备好进行海上航行-让我们熟悉控制飞机。 <br><br><h2> 控制平面 </h2><br> 它由三个部分组成： <b>Pilot</b> ， <b>Mixer</b>和<b>Citadel</b> ，它们一起工作以配置Envoy以路由流量，应用策略以及收集遥测数据。 从示意图上看，这一切看起来像这样： <br><br><img src="https://habrastorage.org/webt/dw/p6/hh/dwp6hh6y5g41oinfxccixuutkyo.png"><br>  <i>控制平面与数据平面的交互</i> <br><br> 特使（即数据平面）使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Istio</a>定义的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes CRD</a> （自定义资源定义）进行配置，并专门为此目的而设计。 对您来说，这意味着它们似乎是使用熟悉的语法在Kubernetes中的下一个资源。 创建后，此资源将由控制平面提取并应用于特使。 <br><br><h2>  Istio的服务比率 </h2><br> 我们描述了Istio对服务的态度，但并非相反：服务与Istio有何关系？ <br><br> 老实说，当他们问自己：“什么是水？”时，Istio知道服务和鱼类的存在-关于水。 <br><br><img src="https://habrastorage.org/webt/re/oi/ff/reoiffespub6tknffwssilkgu7c.jpeg"><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Victoria Dimitrakopoulos的</a>插图：-您喜欢水吗？</i>  <i>-什么是水？</i> <br><br> 因此，您可以使用工作群集，并在部署Istio组件之后，位于其中的服务将继续工作，并且在删除这些组件之后，一切都会恢复正常。 显然，这样做会失去Istio提供的机会。 <br><br> 足够的理论-让我们将这些知识付诸实践！ <br><br><h2> 实践中的Istio </h2><br>  Istio需要Kubernetes集群，其中至少有4个vCPU和8 GB RAM。 为了快速启动集群并按照文章中的说明进行操作，我建议使用Google Cloud Platform，该平台向新用户<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">免费提供300美元</a> 。 <br><br> 创建集群并通过控制台实用程序配置对Kubernetes的访问后，可以通过Helm软件包管理器安装Istio。 <br><br><h2> 头盔安装 </h2><br> 如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方文档</a>中所述，在您的计算机上安装Helm客户端。 在下一部分中，我们将使用它来生成用于安装Istio的模板。 <br><br><h2> 安装Istio </h2><br> 从<a href="">最新版本</a>下载Istio资源<i>（原始作者到版本1.0.5的链接已更改为当前版本，即1.0.6-大约翻译）</i> ，将内容提取到一个目录中，以后我将其称为<code>[istio-resources]</code> 。 <br><br> 为了便于识别Istio资源，请在K8s集群中创建<code>istio-system</code>命名空间： <br><br><pre> <code class="bash hljs">$ kubectl create namespace istio-system</code> </pre> <br> 通过转到<code>[istio-resources]</code>目录并运行以下命令来完成安装： <br><br><pre> <code class="bash hljs">$ helm template install/kubernetes/helm/istio \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global.mtls.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tracing.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> kiali.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> grafana.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --namespace istio-system &gt; istio.yaml</code> </pre> <br> 此命令会将Istio的关键组件输出到<code>istio.yaml</code>文件。 我们为自己更改了标准模板，并指定了以下参数： <br><br><ul><li>  <code>global.mtls.enabled</code>设置为<code>false</code> <i>（即，禁用了mTLS身份验证-大约翻译），</i>以简化我们的约会过程； </li><li>  <code>tracing.enabled</code>启用使用Jaeger的查询跟踪； </li><li>  <code>kiali.enabled</code>将<code>kiali.enabled</code>安装在集群中以可视化服务和流量； </li><li>  <code>grafana.enabled</code>设置Grafana以可视化收集的指标。 </li></ul><br> 我们通过以下命令应用生成的资源： <br><br><pre> <code class="bash hljs">$ kubectl apply -f istio.yaml</code> </pre> <br> 在群集中安装Istio已完成！ 通过运行以下命令，等待<code>istio-system</code>命名空间中的所有Pod <code>Running</code>或<code>Completed</code> ： <br><br><pre> <code class="bash hljs">$ kubectl get pods -n istio-system</code> </pre> <br> 现在，我们准备在下一部分继续，我们将在其中启动和启动该应用程序。 <br><br><h2> 情感分析应用架构 </h2><br> 让我们举一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在Kubernetes中</a>已经提到的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">介绍文章中</a>使用的微服务应用程序Sentiment Analysis的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">示例</a> 。 它足够复杂，可以在实践中展示Istio的功能。 <br><br> 该应用程序包含四个微服务： <br><br><ol><li> 服务<b>SA-Frontend</b> ，在Reactjs上服务于前端应用程序； </li><li>  <b>SA-WebApp</b>服务，用于服务于情感分析请求； </li><li> 服务<b>SA-Logic</b> ，执行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">情感分析</a> ； </li><li> 服务<b>SA反馈</b> ，从用户那里收到有关分析准确性的反馈。 </li></ol><br><img src="https://habrastorage.org/webt/hi/jv/oc/hijvoc4y7ercttsbopo4jzbo4w4.png"><br><br> 在该图中，除了服务之外，我们还看到了入口控制器，它在Kubernetes中将传入的请求路由到相应的服务。  Istio在Ingress网关中使用了类似的概念，下面将详细介绍。 <br><br><h2> 使用Istio的代理启动应用程序 </h2><br> 对于本文中提到的进一步操作，请克隆<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">istio-mastery</a>存储库。 它包含应用程序和Kubernetes和Istio的清单。 <br><br><h3> 边车插件 </h3><br> 插入可以<b>自动</b>或<b>手动</b>完成。 要自动插入<code>istio-injection=enabled</code>容器，需要将<code>istio-injection=enabled</code>标签设置为<code>istio-injection=enabled</code> ，这是通过以下命令完成的： <br><br><pre> <code class="bash hljs">$ kubectl label namespace default istio-injection=enabled namespace/default labeled</code> </pre> <br> 现在，将在默认名称空间中部署的每个Pod将收到其Sidecar容器。 为了验证这一点，让我们通过转到<code>[istio-mastery]</code>存储库的根目录并运行以下命令来安装测试应用程序： <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube persistentvolumeclaim/sqlite-pvc created deployment.extensions/sa-feedback created service/sa-feedback created deployment.extensions/sa-frontend created service/sa-frontend created deployment.extensions/sa-logic created service/sa-logic created deployment.extensions/sa-web-app created service/sa-web-app created</code> </pre> <br> 扩展服务之后，我们将通过执行<code>kubectl get pods</code>命令并确保在<code>READY</code>列下指示值<code>2/2</code>表示Pod有两个容器（带有服务本身及其附带的容器），这表明两个容器都在运行： <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE sa-feedback-55f5dc4d9c-c9wfv 2/2 Running 0 12m sa-frontend-558f8986-hhkj9 2/2 Running 0 12m sa-logic-568498cb4d-2sjwj 2/2 Running 0 12m sa-logic-568498cb4d-p4f8c 2/2 Running 0 12m sa-web-app-599cf47c7c-s7cvd 2/2 Running 0 12m</code> </pre> <br> 看起来像这样： <br><br><img src="https://habrastorage.org/webt/x9/kt/lu/x9ktluxxjopen7rn9tchuyvvioi.png"><br>  <i>在其中一个吊舱中的特使代理</i> <br><br> 现在，应用程序已启动并运行，我们需要允许传入流量进入应用程序。 <br><br><h2> 入口网关 </h2><br> 达到此目的（允许群集中的流量）的最佳实践是通过Istio中的<b>Ingress网关</b> ，该<b>网关</b>位于群集的“边界”，并允许您启用Istio功能，例如路由，负载平衡，安全性以及对传入流量的监视。 <br><br> 在安装Istio的过程中，将Ingress Gateway组件和将其转发到外部的服务已安装到群集中。 要找出服务的外部IP地址，请执行以下操作： <br><br><pre> <code class="bash hljs">$ kubectl get svc -n istio-system -l istio=ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP istio-ingressgateway LoadBalancer 10.0.132.127 13.93.30.120</code> </pre> <br> 我们将继续通过此IP访问应用程序（我将其称为EXTERNAL-IP），因此为了方便起见，我们将值写入变量： <br><br><pre> <code class="bash hljs">$ EXTERNAL_IP=$(kubectl get svc -n istio-system \ -l app=istio-ingressgateway \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span></span>)</code> </pre> <br> 如果您现在尝试通过浏览器访问此IP，则会收到“服务不可用”错误，因为  <b>默认情况下，Istio会阻止所有传入流量，</b>直到定义了网关为止。 <br><br><h2> 网关资源 </h2><br> 网关是Kubernetes中的CRD（自定义资源定义），在群集中安装Istio并激活指定端口，协议和我们要允许传入流量的主机的功能后定义。 <br><br> 在我们的情况下，我们希望允许所有主机的HTTP流量进入端口80。 该任务通过以下定义<i>（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://gist.github.com/rinormaloku/577d0e23590f7a8dfbe56fe2a1f853d7&amp;usg=ALkJrhh9RgZUkTLtmgWtR_OYwldwWuhGIA#file-">http-gateway.yaml</a> ）实现</i> ： <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: http-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br> 除了<code>istio: ingressgateway</code>之外，此配置不需要任何说明。 使用此选择器，我们可以指示将配置应用于哪个Ingress Gateway。 在我们的示例中，这是Ingress Gateway控制器，默认情况下已安装在Istio中。 <br><br> 通过调用以下命令来应用配置： <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/http-gateway.yaml gateway.networking.istio.io/http-gateway created</code> </pre> <br> 现在，网关允许访问端口80，但不知道将请求路由到何处。 这将需要<b>虚拟服务</b> 。 <br><br><h2> 虚拟服务资源 </h2><br>  VirtualService告诉Ingress Gateway如何路由群集中允许的请求。 <br><br> 通过http-gateway对我们的应用程序的请求必须发送到sa-frontend，sa-web-app和sa-feedback服务： <br><br><img src="https://habrastorage.org/webt/zi/il/7_/ziil7_-9gfy5ejkhkzzn1wpxkxe.png"><br>  <i>使用VirtualServices配置的路由</i> <br><br> 考虑应发送到SA-Frontend的请求： <br><br><ul><li>  <code>/</code>路径上的完全匹配项应发送到SA-Frontend以获取index.html; </li><li> 带有<code>/static/*</code>前缀的路径必须发送到SA-Frontend才能接收前端使用的静态文件，例如CSS和JavaScript； </li><li> 属于正则表达式<code>'^.*\.(ico|png|jpg)$'</code>路径必须发送到SA-Frontend，因为 这些是页面上显示的图像。 </li></ul><br> 通过以下配置<i>（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">sa-virtualservice-external.yaml</a> ）</i>实现实现<i>：</i> <br><br><pre> <code class="plaintext hljs">kind: VirtualService metadata: name: sa-external-services spec: hosts: - "*" gateways: - http-gateway # 1 http: - match: - uri: exact: / - uri: exact: /callback - uri: prefix: /static - uri: regex: '^.*\.(ico|png|jpg)$' route: - destination: host: sa-frontend # 2 port: number: 80</code> </pre> <br> 重要事项： <br><br><ol><li> 这个VirtualService引用通过<b>http-gateway</b>发出的请求； </li><li>  <code>destination</code>定义了将请求发送到的服务。 </li></ol><br>  <b>注意</b> ：上面的配置存储在<code>sa-virtualservice-external.yaml</code>文件中，该文件还包含SA-WebApp和SA-Feedback中的路由设置，但为简洁起见，本文中对此进行了缩短。 <br><br> 通过调用以下命令应用VirtualService： <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml virtualservice.networking.istio.io/sa-external-services created</code> </pre> <br>  <b>注意</b> ：当我们使用Istio资源时，Kubernetes API Server会引发一个接收Istio控制平面的事件，然后将新配置应用于每个Pod的Envoy代理。 而且Ingress Gateway控制器似乎是Control Plane中配置的下一个Envoy。 图表上的所有内容如下所示： <br><br><img src="https://habrastorage.org/webt/dz/nz/4b/dznz4bh_wpzcv7tx8jkykkiad9q.png"><br>  <i>用于查询路由的Istio-IngressGateway配置</i> <br><br> 情感分析已在<code>http://{EXTERNAL-IP}/</code> 。 如果您的状态为“未找到”，请不要担心： <i>有时配置会花一点时间才能生效，并且Envoy缓存也会更新</i> 。 <br><br> 在继续之前，请与该应用程序进行一些合作以产生流量<i>（为了清晰起见，在下一步中需要它的存在-大约Transl。）</i> 。 <br><br><h2>  Kiali：可观察性 </h2><br> 要进入Kiali管理界面，请运行以下命令： <br><br><pre> <code class="bash hljs">$ kubectl port-forward \ $(kubectl get pod -n istio-system -l app=kiali \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) \ -n istio-system 20001</code> </pre> <br>  ...并打开<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：//本地主机：20001 /</a> ，以admin / admin登录。 在这里，您会发现许多有用的功能，例如，检查Istio组件的配置，基于在拦截网络请求时收集的信息来可视化服务，以及获得以下问题的答案：“谁与谁联系谁？”，“哪个版本的服务崩溃了？” 等 通常，在继续使用Grafana可视化指标之前，探索Kiali的可能性。 <br><br><img src="https://habrastorage.org/webt/ix/pd/wr/ixpdwrppiekv0dbk3xcbceasft8.png"><br><br><h2>  Grafana：指标可视化 </h2><br>  Istio中收集的度量标准进入Prometheus，并通过Grafana进行可视化。 要进入Grafana管理界面，请运行以下命令，然后打开<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：// localhost：3000 /</a> ： <br><br><pre> <code class="bash hljs">$ kubectl -n istio-system port-forward \ $(kubectl -n istio-system get pod -l app=grafana \ -o jsonpath={.items[0].metadata.name}) 3000</code> </pre> <br> 通过单击左上角的“ <b>主页”</b>菜单并选择<b>左上角的Istio服务仪表板</b> ，从<b>sa-web-app服务</b>开始查看收集的指标： <br><br><img src="https://habrastorage.org/webt/wb/vz/4t/wbvz4tkgi3qgoitxhhwhppk9pu8.png"><br><br> 在这里，我们正在等待一个空洞且完全无聊的性能-管理层永远不会批准这一点。 让我们使用以下命令创建一个小的负载： <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br> 现在，我们有了更好的图表，此外，还有出色的Prometheus监控工具和Grafana可视化指标，这将使我们能够了解服务的性能，运行状况，改进/降级情况。 <br><br> 最后，让我们看一下服务中请求的踪迹。 <br><br><h2>  Jaeger：追踪 </h2><br> 我们将需要跟踪，因为我们拥有的服务越多，找到失败原因的难度就越大。 让我们从下面的图片中看一个简单的情况： <br><br><img src="https://habrastorage.org/webt/dv/8w/iv/dv8wivmvfn20fvmaebzk8wl6h68.png"><br>  <i>随机失败请求的典型示例</i> <br><br> 请求来了，跌倒了- <i>原因是什么？</i>  <i>第一次服务？</i>  <i>还是第二个？</i> 两者都有例外-让我们看看它们的日志。 您多久发现自己这样做一次？ 我们的工作更像是软件侦探，而不是开发人员…… <br><br> 这是微服务中一个普遍存在的问题，通过分布式跟踪系统解决了该问题，在分布式跟踪系统中，服务相互传递一个唯一的标头，然后将此信息重定向到跟踪系统，然后将其映射到请求数据。 这是一个例子： <br><br><img src="https://habrastorage.org/webt/an/_h/tz/an_htzqnc3b4xxhgkzdqi5my-ki.png"><br>  <i>TraceId用于标识请求。</i> <br><br>  Istio使用Jaeger Tracer，它实现了独立于供应商的OpenTracing API框架。 您可以使用以下命令访问Jaeger用户界面： <br><br><pre> <code class="bash hljs">$ kubectl port-forward -n istio-system \ $(kubectl get pod -n istio-system -l app=jaeger \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) 16686</code> </pre> <br> 现在转到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http：// localhost：16686 /</a>并选择<b>sa-web-app服务</b> 。 如果该服务未在下拉菜单中显示，请在页面上显示/生成活动并更新界面。 之后，单击“ <b>查找跟踪”</b>按钮，它将显示最新的跟踪-选择任何-所有跟踪的详细信息将出现： <br><br><img src="https://habrastorage.org/webt/r8/zx/1q/r8zx1qjxc2a316-4a803l4vmzv4.png"><br><br> 此跟踪显示： <br><br><ol><li> 该请求到达<b>istio-ingressgateway</b> （这是与其中一个服务的首次交互，并且为该请求生成跟踪ID），然后网关将请求发送到<b>sa-web-app服务</b> 。 </li><li> 在<b>sa-web-app服务中，</b>请求由Envoy sidecar接收，在跨度中创建了一个“子”（因此我们在跟踪中看到了它），并将其重定向到<b>sa-web-app</b>容器。  <i>（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">跨度</a>是Jaeger中的逻辑工作单元，具有名称，操作开始的时间及其持续时间。跨度可以嵌套和排序。跨度的定向无环图形成迹线。-大约翻译。）</i> </li><li> 在这里，请求由<b>sentimentAnalysis</b>方法处理。 这些跟踪已由应用程序生成，即 他们需要更改代码。 </li><li> 从这一刻起，开始向<b>sa-logic</b>发送POST请求。 跟踪ID必须从<b>sa-web-app</b>转发。 </li><li>  ... </li></ol><br>  <b>注意</b> ：在第4步中，应用程序应查看Istio生成的标头，并将其传递给后续请求，如下图所示： <br><br><img src="https://habrastorage.org/webt/qg/a9/ai/qga9aibwkynfogbcxfo2cnwqxfm.png"><br>  <i>（A）Istio负责转发标头；</i>  <i><b>（B）服务负责标题。</b></i> <br><br>  Istio负责大部分工作，因为 生成用于传入请求的标头，在每个sidecare中创建新的跨度并将其转发。 但是，如果不使用服务内部的标头，则请求跟踪的完整路径将丢失。 <br><br> 应考虑以下标题（转发）： <br><br><pre> <code class="plaintext hljs">x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context</code> </pre> <br> 这是一项简单的任务，但是，为了简化其实现，已经存在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">许多库</a> -例如，在sa-web-app服务中，如果仅根据<a href="">它</a>添加Jaeger和OpenTracing库，则RestTemplate客户端会转发这些标头。 <br><br>  <i>请注意，“情感分析”应用程序演示了Flask，Spring和ASP.NET Core的实现。</i> <br><br> 现在，我们已经清楚了开箱即用（或者几乎是“开箱即用”）的内容，请考虑微调路由，网络流量管理，安全性等问题！ <br><br>  <i><b>注意事项</b></i>  <i><b>佩雷夫</b></i>  <i>：请在下一期Rinor Maloku的Istio中了解此信息，该信息将在不久的将来在我们的博客中提供。</i>  <i><b>更新</b> （3月14日）： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第二部分</a>已经发布。</i> <br><br><h2> 译者的PS </h2><br> 另请参阅我们的博客： <br><br><ul><li>  “使用Istio返回微服务”： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分（路由，流量控制）</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分（认证和授权）</a> ； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">导管-Kubernetes的轻量级服务网格</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">什么是服务网格？为什么（对于带有微服务的云应用程序）需要它？</a>  “; </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes的网络插图指南。”</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分和第2部分</a> ”； </li><li>  “ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这个杂物箱是如何（在Kubernetes）到达这里的？”</a>  ”。 </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN438426/">https://habr.com/ru/post/zh-CN438426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN438412/index.html">2019年程序员劳动力市场中的112654个测试任务和趋势分析</a></li>
<li><a href="../zh-CN438414/index.html">春季文明，3/5</a></li>
<li><a href="../zh-CN438416/index.html">关于激素</a></li>
<li><a href="../zh-CN438420/index.html">2019年的AI：现状</a></li>
<li><a href="../zh-CN438422/index.html">选择性伤害程序（第二部分）：急救和复苏长距离骑术</a></li>
<li><a href="../zh-CN438428/index.html">政府机构找到破坏家庭软件的方法</a></li>
<li><a href="../zh-CN438430/index.html">我被卡住了！ 或者如何克服英语学习的高原效应</a></li>
<li><a href="../zh-CN438434/index.html">黑客实验室：P1。 Libssh身份验证绕过</a></li>
<li><a href="../zh-CN438436/index.html">如何为员工提供临时访问客户资源而又无需再次发出密码的想法</a></li>
<li><a href="../zh-CN438438/index.html">Bitrix鹦鹉的食物。 我们测试性能，选择铁</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>