<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♨️ ✨ 🥠 PHP, ¿cuánta abstracción para la gente? 👩‍🚒 👨🏿‍🤝‍👨🏽 👨‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alegría: ¿Qué está pasando? 
 Tristeza: ¡Estamos abstrayendo! Hay cuatro etapas. Este es el primero. ¡Fragmentación no objetiva! 
 Bing Bong: Muy bien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP, ¿cuánta abstracción para la gente?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/468021/"><img src="https://habrastorage.org/webt/wx/in/ae/wxinae8d5pdleez3sa9w1odeaw0.jpeg"><br>  <i>Alegría: ¿Qué está pasando?</i> <i><br></i>  <i>Tristeza: ¡Estamos abstrayendo!</i>  <i>Hay cuatro etapas.</i>  <i>Este es el primero.</i>  <i>¡Fragmentación no objetiva!</i> <i><br></i>  <i>Bing Bong: Muy bien, no entres en pánico.</i>  <i>Lo importante es que todos estemos juntos.</i>  <i>[de repente su brazo abstracto se cae]</i> <i><br></i>  <i>Alegría: ¡Oh!</i>  <i>[La tristeza y la alegría comienzan a desmoronarse también]</i> <i><br></i>  <i>Tristeza: estamos en la segunda etapa.</i>  <i>Estamos deconstruyendo!</i>  <i>[como Bing Bong se cae a pedazos]</i> <i><br></i>  <i>Bing Bong: ¡No puedo sentir mis piernas!</i>  <i>[levanta una pierna] Oh, ahí están.</i> <i><br></i>  <i><b>© Cartoon Inside Out</b></i> <br><br>  A todos les encanta escribir código hermoso.  A abstracciones, lambdas, SÓLIDAS, SECAS, DI, etc.  etc.  En este artículo, quiero explorar cuánto cuesta en términos de rendimiento y por qué. <br><br>  Para hacer esto, tome una tarea simple que esté divorciada de la realidad y que gradualmente le aportará belleza, midiendo el rendimiento y mirando debajo del capó. <br><a name="habracut"></a><br>  <b>Descargo de responsabilidad:</b> este artículo no debe interpretarse de ninguna manera como una llamada para escribir un código incorrecto.  Es mejor si sintoniza con anticipación para decir después de leer "¡Genial!  Ahora sé cómo es por dentro.  Pero, por supuesto, no lo usaré ".  :) <br><br>  Desafío: <br><br><ol><li>  Dan archivo de texto. </li><li>  Lo dividimos en líneas. </li><li>  Recorta los espacios a izquierda y derecha </li><li>  Deseche todas las líneas en blanco. </li><li>  Reemplazamos todos los espacios que no sean individuales con espacios individuales ("ABC" -&gt; "ABC"). </li><li>  Las líneas con más de 10 palabras, de acuerdo con las palabras, se vuelven hacia atrás ("An Bn Cn" -&gt; "Cn Bn An"). </li><li>  Contamos cuántas veces ocurre cada fila. </li><li>  Imprima todas las líneas que ocurren más de N veces. </li></ol><br>  Como un archivo de entrada, por tradición tomamos php-src / Zend / zend_vm_execute.h por ~ 70 mil líneas. <br><br>  Como tiempo de ejecución, tome PHP 7.3.6. <br>  Veamos los códigos de operación compilados aquí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://3v4l.org</a> . <br><br>  Las mediciones se realizarán de la siguiente manera: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     $start = microtime(true); ob_start(); for ($i = 0; $i &lt; 10; $i++) { //    } ob_clean(); echo "Time: " . (microtime(true) - $start) / 10;</span></span></code> </pre> <br><h3>  Primer acercamiento ingenuo </h3><br>  Escribamos un código imperativo simple: <br><br><pre> <code class="php hljs">$array = explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>)); $cache = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($array <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($row)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($words) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $words = array_reverse($words); } $row = implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cache[$row])) { $cache[$row]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $cache[$row] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cache <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } }</code> </pre> <br>  Tiempo de ejecución ~ 0.148 s. <br><br>  Todo es simple y no hay nada de qué hablar. <br><br><h3>  El segundo enfoque, procesal </h3><br>  Refactorizamos nuestro código y sacamos las acciones elementales en la función. <br>  Intentaremos adherirnos al principio de responsabilidad exclusiva. <br><br><div class="spoiler">  <b class="spoiler_title">Paño debajo del alerón.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContentFromFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $fileName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents($fileName)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reverseWordsIfNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$input)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($input) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $input = array_reverse($input); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($input)); reverseWordsIfNeeded($words); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printIfSuitable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $input, int $threshold)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($input <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; $threshold) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$cache, string $line)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cache[$line])) { $cache[$line]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $cache[$line] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ $cache = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($input <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; addToCache($cache, prepareString($row)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $cache; } printIfSuitable( processContent( getContentFromFile(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>) ), <span class="hljs-number"><span class="hljs-number">1000</span></span> );</code> </pre> <br></div></div><br>  Tiempo de ejecución ~ 0.275s ... ¿WTF?  ¡La diferencia es casi 2 veces! <br><br>  Veamos qué es una función PHP desde el punto de vista de una máquina virtual. <br><br>  Código: <br><br><pre> <code class="php hljs">$a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">2</span></span>; $c = $a + $b;</code> </pre> <br>  Compila a: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 2 0 E &gt; ASSIGN !0, 1 3 1 ASSIGN !1, 2 4 2 ADD ~5 !0, !1 3 ASSIGN !2, ~5</span></span></code> </pre><br>  Pongamos la adición en una función: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $a + $b; } $a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">1</span></span>; $c = sum($a, $b);</code> </pre> <br>  Dicho código se compila en dos conjuntos de códigos de operación: uno para el espacio de nombres raíz y el segundo para la función. <br><br>  Raíz: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 2 0 E &gt; ASSIGN !0, 1 3 1 ASSIGN !1, 1 5 2 NOP 9 3 INIT_FCALL 'sum' 4 SEND_VAR !0 5 SEND_VAR !1 6 DO_FCALL 0 $5 7 ASSIGN !2, $5</span></span></code> </pre> <br>  Función: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 5 0 E &gt; RECV !0 1 RECV !1 6 2 ADD ~2 !0, !1 3 &gt; RETURN ~2</span></span></code> </pre> <br>  Es decir  incluso si solo cuenta por códigos de operación, cada llamada de función agrega 3 + 2N códigos de operación, donde N es el número de argumentos pasados. <br><br>  Y si profundizas un poco más, aquí también cambiamos el contexto de ejecución. <br><br>  Una estimación aproximada de nuestro código refactorizado da tales números (recuerde unas 70,000 iteraciones). <br>  El número de códigos de operación ejecutados "adicionales": ~ 17,000,000. <br>  Número de cambios de contexto: ~ 280,000. <br><br><h3>  El tercer enfoque, clásico </h3><br>  Especialmente sin filosofar, envolvemos todas estas funciones con una clase. <br><br><div class="spoiler">  <b class="spoiler_title">Sábana debajo del alerón</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessFile</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $content; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cache = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $fileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;content = explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents($fileName)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reverseWordsIfNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$input)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($input) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $input = array_reverse($input); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($input)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;reverseWordsIfNeeded($words); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printIfSuitable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $threshold)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; $threshold) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $line)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;content <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addToCache( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prepareString($row)); } } } $processFile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProcessFile(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>); $processFile-&gt;processContent(); $processFile-&gt;printIfSuitable(<span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br></div></div><br>  Plazo de ejecución: 0.297.  Se puso peor.  No mucho, pero notable.  ¿La creación de un objeto (10 veces en nuestro caso) es tan costosa?  Nuuu ... No solo eso. <br><br>  Veamos cómo funciona una máquina virtual con una clase. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Adder</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a = $a; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b = $b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b; } } $a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">1</span></span>; $adder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Adder($a, $b); $c = $adder-&gt;sum();</code> </pre> <br>  Habrá tres conjuntos de códigos de operación, lo cual es lógico: la raíz y dos métodos. <br><br>  Raíz: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 2 0 E &gt; NOP 16 1 ASSIGN !0, 1 17 2 ASSIGN !1, 1 18 3 NEW $7 :15 4 SEND_VAR_EX !0 5 SEND_VAR_EX !1 6 DO_FCALL 0 7 ASSIGN !2, $7 19 8 INIT_METHOD_CALL !2, 'sum' 9 DO_FCALL 0 $10 10 ASSIGN !3, $10</span></span></code> </pre> <br>  Constructor: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 6 0 E &gt; RECV !0 1 RECV !1 7 2 ASSIGN_OBJ 'a' 3 OP_DATA !0 8 4 ASSIGN_OBJ 'b' 5 OP_DATA !1 9 6 &gt; RETURN null</span></span></code> </pre> <br>  Método de <b>suma</b> : <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 11 0 E &gt; FETCH_OBJ_R ~0 'a' 1 FETCH_OBJ_R ~1 'b' 2 ADD ~2 ~0, ~1 3 &gt; RETURN ~2</span></span></code> </pre> <br>  La <b>nueva</b> palabra clave se convierte realmente en una llamada de función (líneas 3-6). <br>  Crea una instancia de la clase y llama al constructor con los parámetros pasados. <br><br>  En el código de métodos, nos interesará trabajar con campos de clase.  Tenga en cuenta que si asigna un código de operación <b>ASSIGN</b> simple con variables ordinarias para la asignación, entonces, para los campos de clase, todo es algo diferente. <br><br>  Asignación - 2 códigos de operación <br><br><pre> <code class="php hljs"> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ASSIGN_OBJ <span class="hljs-string"><span class="hljs-string">'a'</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> OP_DATA !<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Leer - 1 código de operación <br><br><pre> <code class="php hljs"> <span class="hljs-number"><span class="hljs-number">1</span></span> FETCH_OBJ_R ~<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'b'</span></span></code> </pre> <br>  Aquí debe saber que <b>ASSIGN_OBJ</b> y <b>FETCH_OBJ_R son</b> mucho más complicados y, en consecuencia, <b>requieren</b> más recursos que un simple <b>ASSIGN</b> , que, en términos generales, simplemente copia <b>zval</b> de una pieza de memoria a otra. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Opcode </th><th>  El número de líneas del manejador (código C) </th></tr><tr><td>  ASSIGN_OBJ </td><td>  149 </td></tr><tr><td>  OP_DATA </td><td>  30 </td></tr><tr><td>  FETCH_OBJ_R </td><td>  112 </td></tr><tr><td>  ASIGNAR </td><td>  26 </td></tr></tbody></table></div><br>  Está claro que tal comparación está muy lejos de ser correcta, pero aún da alguna idea.  Un poco más adelante haré mediciones. <br><br>  Ahora veamos lo caro que es crear una instancia de un objeto.  Midamos en un millón de iteraciones: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueObject</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a = $a; } } $start = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $i++){ <span class="hljs-comment"><span class="hljs-comment">// $a = $i; // $a = new ValueObject($i); } echo "Time: " . (microtime(true) - $start);</span></span></code> </pre> <br>  Asignación variable: 0.092. <br>  Objeto de instancia: 0.889. <br><br>  Algo como esto  No es completamente gratis, especialmente si muchas veces. <br><br>  Bueno, para no levantarse dos veces, midamos la diferencia entre trabajar con propiedades y variables locales.  Para hacer esto, cambie nuestro código de esta manera: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueObject</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    // $this-&gt;b = $a; // $c = $this-&gt;b; //    // $b = $a; // $c = $b; return $c; } } $a = new ValueObject(); $start = microtime(true); for($i = 0; $i &lt; 1000000; $i++){ $b = $a-&gt;try($i); } echo "Simple. Time: " . (microtime(true) - $start);</span></span></code> </pre> <br><br>  Intercambio mediante asignación: 0.830. <br>  Intercambio a través de propiedad: 0.862. <br><br>  Solo un poco, pero por más tiempo.  Justo el mismo orden de diferencia que obtuviste después de ajustar las funciones en una clase. <br><br><h3>  Conclusiones banales </h3><br><ol><li>  La próxima vez que desee crear una instancia de un millón de objetos, piense si realmente lo necesita.  Tal vez solo una serie, ¿eh? </li><li>  Escribir un código de espagueti para ahorrar un milisegundo, bueno, eso.  El escape es barato y los colegas pueden vencerlos más tarde. </li><li>  Pero en aras de ahorrar 500 milisegundos, tal vez a veces tenga sentido.  Lo principal es no ir demasiado lejos y recordar que estos 500 milisegundos tienen más probabilidades de ser guardados solo por una pequeña sección de código muy activo, y no convertir todo el proyecto en un vacío de tristeza. </li></ol><br>  PD: sobre lambdas la próxima vez.  Es interesante allí.  :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468021/">https://habr.com/ru/post/468021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468011/index.html">La historia de un robot hipotético.</a></li>
<li><a href="../468013/index.html">Una forma fácil y segura de automatizar las implementaciones canarias con Helm</a></li>
<li><a href="../468015/index.html">Lo que se sabe sobre ITIL 4 en este momento y quién ya está usando la nueva biblioteca</a></li>
<li><a href="../468017/index.html">The Maybe Monad a través de async / wait en C # (¡sin Task ov!)</a></li>
<li><a href="../468019/index.html">Desarrollo de sitios web en WebAssembly usando NetCore 3 y Blazor</a></li>
<li><a href="../468023/index.html">Inteligencia artificial en el juego de lucha Shadow Fight 3</a></li>
<li><a href="../468025/index.html">¿Cómo configurar SNI en Zimbra OSE?</a></li>
<li><a href="../468027/index.html">Métodos de optimización de código para Redd. Parte 2: memoria no almacenable en caché y operación de bus paralelo</a></li>
<li><a href="../468031/index.html">Llevamos un juego multijugador de C ++ a la web con Cheerp, WebRTC y Firebase</a></li>
<li><a href="../468035/index.html">Descargue la prensa con un controlador de juego u 8 patentes inusuales para dispositivos de entrada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>