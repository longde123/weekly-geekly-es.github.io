<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🎨 👨🏻‍🔧 🧝🏻 操作TA505，第四部分。 双胞胎 🍲 🚺 🌏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们继续谈论黑客组织TA505的活动。 众所周知的短语“新的是被遗忘的旧”最适合作为TA505小组故事下一章的标题。 没错，这一次“旧”并没有被“遗忘”，而是对其进行了重新设计和改进。 

 在9月初，我们发现了几个带有特殊分组PE-packer的恶意下载程序，我们先前对此进行了介绍 。 乍一看，它...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>操作TA505，第四部分。 双胞胎</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br> 我们继续谈论黑客组织TA505的活动。 众所周知的短语“新的是被遗忘的旧”最适合作为TA505小组故事下一章的标题。 没错，这一次“旧”并没有被“遗忘”，而是对其进行了重新设计和改进。 <br><br> 在9月初，我们发现了几个带有特殊分组PE-packer的恶意下载程序，我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">先前</a>对此进行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">了介绍</a> 。 乍一看，它们看起来像是著名的FlawedAmmyy后门舞台表演者。 但是更深入的分析表明事实并非如此。 就执行质量而言，并不是最先进的代码编写技术带给我们根本上相反的负载。 <br><br> 在本文中，我们将仔细研究找到的工具，并与已知的工具进行比较。 <a name="habracut"></a><br><br><h2> 引导加载程序 </h2><br> 首先，以下内容令人感到好奇：在我们设法收集的所有引导加载程序样本中，只有一个具有数字签名： <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>图</i>  <i>1.引导加载程序的数字签名</i> <br><br> 以PEAR SOLUTIONS LTD名义发行的证书。 顺便说一句，这并不是团体首次签署其工具，并将其作为虚拟组织的合法软件进行伪造。 以下是将TA505用于其他恶意软件家族的其他一些名称： <br><br><ul><li>  ET HOMES LTD， </li><li> 丰和有限公司 </li><li>  MISHA LONDON LTD， </li><li> 柴田聪司MB， </li><li> 非常电视有限公司。 </li></ul><br> 由于检测到的引导加载程序之间没有区别，因此我们选择上述已签名的引导加载程序并对其进行详细介绍。 <br><br> 在整个恶意软件的工作过程中，几乎每个动作都伴随着写入日志文件并调试所有发生的事情的输出： <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>图</i>  <i>2.调试输出和记录</i> <br><br> 这种跟踪不仅简化了文件的静态分析，而且还有助于找出动态分析系统中存在的问题： <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>图</i>  <i>3.在ANY.RUN在线分析器中调试输出</i> <br><br>  Troyan检查键盘的语言布局-不适用于俄罗斯和邻国： <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>图</i>  <i>4.检查键盘的语言布局</i> <br> 然后，它创建<code>Global\system32_mutant_service</code>互斥量，并使用对google.com的HTTP GET请求检查Internet可用性。 之后，它将通过服务myexternalip.com，ipecho.net和ifconfig.me确定外部IP地址，并将获得的值与系统的网络参数中指定的值进行比较，从而确定访问网络（专用地址或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NAT</a> ）的方式： <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>图</i>  <i>5.内部和外部IP地址的比较</i> <br><br> 接下来，恶意软件确定库<code>%SystemRoot%\system32\crypt32.dll</code>的版本，如果内部版本号和修订号分别小于<code>7601</code>和<code>18741</code> <code>KB3033929</code>根据操作系统版本下载并安装更新<code>KB3033929</code> ： <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>图</i>  <i>6.下载并安装系统更新</i> <br><br>  TA505攻击者照顾受害者并根据需要修补系统吗？ 一点也不。 安装此更新与终止对使用SHA-1签名的代码安全证书的支持有关，并且放弃使用SHA-2算法。 最有可能的是，黑客已经很难在未更新的系统上运行签名的有效负载。 有趣的是，安装更新后，该木马会将生成的操作日志发送到管理服务器，停止其工作并清除自身，清除留下的痕迹。 <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>图</i>  <i>7.安装系统更新后关闭</i> <br><br> 如果不需要更新安装，则引导加载程序会收集以下信息并将其发送到管理服务器： <br><br><ul><li> 系统信息 </li><li> 有关已安装软件的信息， </li><li>  ％ProgramFiles％和％ProgramFiles（x86）％目录（如果有）中有关已签名软件的信息， </li><li>  ％SystemRoot％\ drivers目录中有关已签名驱动程序的信息。 </li></ul><br> 请注意，使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">合法代码</a>来获取有关签名的信息。 <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>图</i>  <i>8.获取证书信息</i> <br><br> 之后，引导程序将创建<code>C:\Windows\Logs\diag</code>目录，并启动一个流，在其中跟踪目录中的更改，并将通知发送到管理服务器： <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>图</i>  <i>9.监视目录更改</i> <br><br> 然后，它准备有关系统的现有和缺少的信息（用户名，系统版本，域，IP地址，有关视频卡的信息，网络连接-NAT或非NAT），并生成以下类型的JSON文件： <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br> 稍后，这些数据将使用RC4加密（ <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code>加密密钥在Trojan主体中进行了加密），并使用Base64编码，并通过HTTP POST请求发送到管理服务器： <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>图</i>  <i>10.对管理服务器的HTTP POST请求</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>图</i>  <i>11.引导程序中的控制服务器列表</i> <br><br> 来自服务器的响应由RC4解密（加密密钥与用于发送数据的密钥相同）并进行检查：前两个字节必须与MZ行相对应，这是PE文件的标志。 我们在分析另一台提供FlawedAmmyy RAT的装载机时，已经较早地遇到了这个序列： <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>图</i>  <i>12.类似的代码，用于解密和检查所涉及的引导程序（左）和FlawedAmmyy RAT引导程序（右）的下载文件</i> <br><br> 有效负载加载不仅发生在主线程中，而且还发生在单独创建的线程中。 换句话说，有两个有效载荷。 在一种情况下，将预先检查Global \ system32_host_service互斥量，如果不存在，则将加载组件，该组件在调试信息中称为有效负载或自动程序。 有趣的是，在收到服务器的响应之后，PE文件不会以任何方式启动。 而是将其身体写入注册表项<code>0x228028</code>的<code>HKEY_LOCAL_MACHINE\SYSTEM</code>部分中。 然后，引导加载程序使用<code>Wow64DisableWow64FsRedirection</code>为32位应用程序禁用WoW64文件系统的重定向，并使用<code>Wow64DisableWow64FsRedirection</code>启动<code>%SystemRoot%\System32\services.exe</code>进程。 使用此参数没有任何意义，但这可以完成生成的有效负载的安装链。 <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>图</i>  <i>13.设置有效载荷</i> <br><br> 稍后我们将讨论第二个有效负载。 <br><br><h2>  Twein插件 </h2><br> 检查上面讨论的木马程序，我们注意到一个从<code>%SystemRoot%</code>目录中删除两个文件的函数<code>twein_32.dll</code>和<code>twein_64.dll</code> ： <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>图</i>  <i>14.删除twein_32.dll和twein_64.dll文件</i> <br><br> 这些文件在其他任何地方都找不到，它们也不会出现在引导加载程序的逻辑中。 但是，这些库的名称使我们想起了另一组恶意软件，现在我们将对其进行考虑。 <br> 两个月前，我们发现了TA505组的木马，大小约为9 MB。 该文件由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">UPX</a>打包。 该木马作为<code>WMDICToss</code>服务安装到系统中。 资源包含三个文件： <code>systemdiron.bat</code> ， <code>twein__32.dll</code>和<code>twein__64.dll</code> ，这些文件已使用线性XOR加密。 <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>图</i>  <i>15.解密dropper的资源之一</i> <br><br> 请注意，这两个文件的名称几乎与前面已经提到的名称一致：区别仅在于下划线的数量。 <br><br> 解密后的名称为<code>systemdiron.bat</code>资源<code>systemdiron.bat</code>应该是一个命令脚本，该脚本可根据系统的容量启动其他组件： <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br> 两个twein库的行为类似。 装有TA505组的特征性封隔器。 原始库名称： <code>av_block.dll</code> 。 使用混淆器会使分析变得非常复杂，混淆代码的比例约为80％。 结果，程序执行充满了众多的过渡，下一个代码步骤的解码，非线性函数调用。 <br><br> 库中包含大量令人印象深刻的类似Base64的字符串，这些字符串按以下方式解密： <br><br>  1.输入字符串分为4个字节的块； <br>  2.使用替换和移位算法对每个块进行解码： <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3）块被收集在一行中； <br>  4）结果由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">eexec</a>算法使用双字节密钥解密，并作为参数传递： <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>图</i>  <i>16. eexec算法的实现</i> <br><br> 大多数行是防病毒产品文件的名称和路径，但是其中一些根本不属于安全工具：MS Exchange Server，MySQL Server，SAP，Apache，PostgreSQL，Elasticsearch等。甚至还有这样的独特路径： <br><br><ul><li>  C：\ Users \ tislam \ Desktop \ salik app \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C：\ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C：\ Users \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C：\ Users \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  D：\附加组件\ IMI_CREDIT_POLICY测试v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br> 如果从列表中找到系统中的软件，则文件和目录将被删除。 <br><br> 为了确保自己在系统中的安全，这些库将自己设置为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Windows套接字</a>服务提供程序（SPI）接口，称为Intel和IntelFiltr。 此外，它们将协议链中处理程序的顺序更改为第一个处理客户端请求的SPI。 <br><br>  2015年，我们的FireEye同事介绍了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">LatentBot</a>机器人<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">分析程序</a> 。 奇怪的是，LatentBot中的字符串加密算法和所审查的twein库完全相同。 另外，LatentBot使用安全模块作为插件之一，尽管它仅限于检查可用性，但它使用指定的路径和产品名称在系统中搜索安全工具。 <br><br><h2>  Rootkit粗花呢 </h2><br> 回到引导加载程序，即第二个有效负载。 从尝试打开rootkit ...的调试行中，并安装了Driver％S，很容易猜测下一个有效负载的格式。 成功加载后，驱动程序将使用与其他合法文件的名称以伪随机方式形成的名称一起写入<code>%SystemRoot%\System32\drivers</code>目录。 然后将创建并启动该服务： <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>图</i>  <i>17.安装和启动服务</i> <br><br> 在其工作的最后阶段，引导加载程序将配置驱动程序以在注册表项中列入黑名单：数字文件签名中的防病毒进程，分析工具和保护供应商的名称将输入到<code>HKEY_LOCAL_MACHINE\SYSTEM</code>分支的键的指定数字值中： <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>图</i>  <i>18.黑名单驱动程序配置</i> <br><br> 在研究引导加载程序的过程中，我们无法从管理服务器获取驱动程序样本。 但是，我们发现<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">提到</a>了另一个类似的引导加载程序抽出<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的rootkit</a> 。 <br><br> 该驱动程序以<code>Lizas Limited</code>的名义进行数字签名，并通过<code>Lizas Limited</code> ： <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>图</i>  <i>19.数​​字签名的驱动程序</i> <br><br> 在研究过程中，我们发现与Necurs僵尸网络的著名rootkit有很多<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">共同之处</a> ，TA505小组正积极使用它来发送垃圾邮件和传播恶意软件。 让我们更详细地考虑他的作品最有趣的特征。 <br><br> 驱动程序注册事件处理程序，以使用<code>PsSetCreateProcessNotifyRoutine</code>和<code>PsSetLoadImageNotifyRoutine</code>启动进程并加载PE图像。 换句话说，这使驱动程序可以控制所有新进程和服务的启动。 使用我们前面提到的黑名单，rootkit使用ZwTerminateProcess终止不需要的进程，并防止其他可能对其加载有危险的驱动程序，覆盖指令上的入口点值： <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br> 结果，该服务将因<code>STATUS_UNSUCCESSFULL</code>错误而被卸载。 <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>图</i>  <i>20.流程完成</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>图</i>  <i>21.覆盖驱动程序入口点</i> <br><br> 通过CmRegisterCallback，驱动程序可以拦截系统注册表访问事件。 特别是，他的进一步工作是通过在拦截的事件中访问的键的数值来参数化的。 <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>图</i>  <i>22.注册表项访问的Rootkit管理</i> <br><br> 有趣的是，在某些版本的Necurs Rootkit中，相同的数值用作ioctl请求代码。 <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>图</i>  <i>23.使用ioctl查询管理Necurs Rootkit</i> <br><br> 此技巧可被视为迈向更高机密的一步：与对DeviceObject的ioctl请求相比，对注册表的访问引起的怀疑更少。 <br><br>  rootkit的主体包含一个用单字节XOR加密的辅助DLL库。 创建新进程时，驱动程序将库与另一个PE文件一起注入，该文件从注册表中提取出来，并再次用单字节XOR解密。 <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>图</i>  <i>24.解密并将辅助库注入到创建的进程中</i> <br><br> 辅助组件是一个定制的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">反射式加载器</a> ，它可以将第二个PE文件正确地放置在内存中，作为有效负载，并将控制权转移给该文件。 现在，可以很清楚地看到，从本文的第一部分开始，由引导加载程序写入注册表的有效负载是如何开始工作的。 <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>图</i>  <i>25.用辅助库填充导入表</i> <br><br><h2> 结论 </h2><br> 在本文中，我们熟悉了许多双木马的工作特点。 为什么是双胞胎？ 我们开始研究的恶意引导加载程序在代码编写和实现细节的质量方面与著名的FlawedAmmyy后门引导加载程序非常相似。 他尝试从系统中删除的Twein库很可能是我们接下来要查找的库。 库与LatentBot安全插件非常相似。 引导加载程序的有效载荷之一是驱动程序，它是流行的Necurs Rootkit的派生产品。 <br><br> 一些恶意软件家族已有5年以上的历史，但是，攻击者会考虑到操作系统和安全工具的开发，继续对其进行更新和改进。 <br><br>  <b>作者</b> ：积极技术公司的Alexey Vishnyakov和Daniil Koloskov <br><br><div class="spoiler">  <b class="spoiler_title">国际奥委会</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287-Twein引导程序 <br>  f6b6526b8d494dce14568e3703368432-twein插件删除器 <br>  983dd279722154a12093410067fe070e-Rootkit Twein <br></div></div><br><h2> 该系列中的先前文章： </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TA505行动：我们如何分析Trojan Dridex，勒索软件Locky和Neutrino僵尸网络创建者的新工具。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">操作TA505：通过NetSupport RAT学习ServHelper后门。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第二部分</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">操作TA505：对网络基础结构进行分组。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第三部分</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN475328/">https://habr.com/ru/post/zh-CN475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN475308/index.html">如何通过优秀的程序员</a></li>
<li><a href="../zh-CN475314/index.html">保护地球的生态幻想</a></li>
<li><a href="../zh-CN475322/index.html">下一代骨声音-Aftershokz Aeropex评测</a></li>
<li><a href="../zh-CN475324/index.html">从EcmaScript角度进行功能编程。 组成，咖喱，部分涂抹</a></li>
<li><a href="../zh-CN475326/index.html">骗子如何做到这一点。 作弊工具</a></li>
<li><a href="../zh-CN475332/index.html">3.极限交换机上的企业网络设计</a></li>
<li><a href="../zh-CN475336/index.html">如何正确退出（说明）</a></li>
<li><a href="../zh-CN475338/index.html">如果您没有Python，但是有Keras模型和Java</a></li>
<li><a href="../zh-CN475340/index.html">AMD推出了Threadripper处理器-最快的台式机CPU</a></li>
<li><a href="../zh-CN475342/index.html">Andrey Sebrant（Yandex）：人工智能时代的企业</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>