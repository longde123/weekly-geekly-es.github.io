<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😔 🎤 🧖 Smart home in container (ioBroker + Zigbee in Docker) 💢 👨‍👧 🥑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entri 
 Untuk beberapa waktu saya menggunakan beberapa relay Sonoff standar yang mengontrol cahaya melalui Google Home Mini. Tetapi pada akhirnya saya...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Smart home in container (ioBroker + Zigbee in Docker)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474354/"><h2>  Entri </h2><br>  Untuk beberapa waktu saya menggunakan beberapa relay Sonoff standar yang mengontrol cahaya melalui Google Home Mini.  Tetapi pada akhirnya saya menginginkan lebih.  Fungsionalitas standar tidak cukup, saya memutuskan untuk secara bertahap membuat sistem sesuatu yang lebih fleksibel.  Saya memilih ioBroker. <br><br>  Pada awalnya, seperti biasa, saya melihat, memilih, memeriksa bagian-bagian fungsionalitas.  Ketika, secara terpisah, kebutuhan pokok bekerja, ia mulai mengumpulkan.  Dan, tentu saja, saya mengalami masalah. <br><br>  Kesulitan utama: <br><br><ul><li>  Apa tepatnya yang harus dipilih?  Bagaimanapun, ada banyak cara untuk mengimplementasikan rencana kami.  Dan bahkan dalam solusi yang dipilih ada banyak pilihan ... </li><li>  Tidak ada petunjuk siap pakai tentang cara menyatukan set solusi yang tepat yang saya pilih dan tepatnya dalam konfigurasi saya. </li></ul><br>  Apa yang saya pilih, mengapa, kesulitan apa yang saya temui dan bagaimana menyelesaikannya, dan itu akan dibahas. <br><br>  Ke depan, saya akan menjelaskan bagaimana ioBroker diluncurkan di docker pada laptop lama dan melemparkan Zigbee ke dalamnya untuk berinteraksi dengan sensor Xiaomi secara langsung, tanpa gateway.  Saya tidak memberikan instruksi standar, hanya "benjolan" saya. <a name="habracut"></a><br><br>  Karena belum produktif, sangat mungkin untuk mengubah sesuatu.  Jadi saya akan berterima kasih atas saran dan koreksi :) <br><br><h2>  Wishlist dan kereta pikiran saya </h2><br>  Ada gulungan Sonoff (berakhir di eWeLink), semacam kabel ekstensi (Tuya SmartLife), gerbang Xiaomi dengan beberapa sensor (Mi Home), kolom Google Home Mini. <br><br>  eWeLink dan SmartLife biasanya mengambil di Google Home, mendengarkan perintah suara seperti "Nyalakan lampu di atas meja."  Mi Home tidak dimulai (ada beberapa perangkat Xiaomi yang didukung di Google Home). <br><br>  Saya menempatkan ioBroker, mengambil Xiaomi Gateway, pada prinsipnya, semuanya bekerja.  Semuanya indah, saya memeriksa skrip, mereka ditulis (saya memilih Node-Red), saya memutuskan untuk melakukan semuanya pada ini. <br><br>  Namun, saya bukan admin profesional, saya bisa memikirkan cara menyiapkannya, tetapi saya tidak tahu seluk-beluk seperti apa perpustakaan dan komponen yang dimasukkan (dan saya tidak ingin mempelajari lebih dalam).  Oleh karena itu, agak mengganggu saya bahwa ioBroker membutuhkan nodejs, beberapa npm yang saya tidak punya bisnis dengan sebelumnya.  Ada kesulitan dengan versi (seperti yum standar dari repositori, terlalu lama menempatkan nodejs, dll.). <br><br>  Baik i.e.  Saya memulai semuanya, tetapi rasa takut tetap ada di hati saya bahwa meskipun itu bekerja, saya tidak mengerti caranya.  Dan jika, misalnya, ada sesuatu yang rusak selama peningkatan, saya tidak akan tahu bagaimana cara memperbaikinya.  Tapi selain ioBroker, saya juga ingin menumpuk sistem lain di laptop. <br><br>  Saya akan memberikan, misalnya, pembaruan tentang sesuatu yang tampaknya berfungsi.  Dan setelah beberapa waktu ternyata bekerja buruk.  Kami harus memutar kembali cadangan sebulan yang lalu.  Selain itu, cadangan tidak hanya dari sistem ini, tetapi semua yang lain, karena saya tidak mengerti sampai akhir dari mana sistem file yang dapat dieksekusi, di mana file konfigurasi, di mana data itu sendiri ... <br><br>  Itu sangat mengganggu saya, jadi saya memutuskan untuk menggunakan Docker.  Kode dalam wadah.  Data secara terpisah, direktori dipasang pada host.  Mudah dicadangkan. <br><br>  Apakah ada versi baru?  Ya, bahkan di mesin virtual lain, mudah untuk memeriksa bagaimana versi baru wadah dengan data dari direktori ini akan berfungsi.  Sistem yang berbeda tidak saling mengganggu.  Mudah untuk memutar kembali binari dari beberapa sistem kembali.  Sekali lagi, mudah untuk mentransfer ke hal lain (ioBroker dalam wadah berfungsi baik pada Synology dan pada papan tunggal).  Cantik! <br><br>  Akan ada lebih banyak persyaratan (untuk menyediakan melalui Internet, tetapi tidak tersedia untuk keamanan), mereka akan mempengaruhi lebih lanjut ketika memilih konfigurasi. <br><br><h2>  Instalasi </h2><br>  OS host tidak kritis, saya mengunduh CentOS (dari memori lama saya ingat bahwa untuk semua tugas jaringan itu bekerja cukup stabil dan tanpa bug).  Versi saat ini adalah Cent OS 8. <br><br>  Taruh itu.  Saya membuat pengaturan dasar seperti hostname, fail2ban (hanya kebiasaan, meskipun host hanya di LAN).  Pasang Docker.  Saya tidak akan memikirkan hal ini.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Instruksi contoh</a> . <br><br>  Saatnya untuk meluncurkan ioBroker.  Tetapi jaringan mana yang harus dipilih?  Tuan rumah atau Macvlan? <br><br>  Pertama, Macvlan ingin setiap wadah mendapatkan alamat IP-nya dari router.  Tapi kemudian dia memutuskan untuk meninggalkan usaha ini: <br><br><ul><li>  Dengan Host, tentu saja, Anda perlu secara eksplisit menunjukkan port mana yang akan diteruskan, pastikan port tersebut tidak bersinggungan dengan kontainer lain.  Tapi </li><li>  iptables harus dikonfigurasi di dalam setiap wadah.  Termasuk setelah setiap restart dengan parameter lain, upgrade / penggantian.  Dan dalam mode Host, ini adalah satu titik manajemen keamanan. </li><li>  Saya masih berencana untuk membuatnya tidak hanya dari WiFi di rumah.  Dan dalam hal ini, lebih mudah untuk membuat satu host dapat diakses dari luar (dan a la port-mapping di atasnya) daripada mengkonfigurasinya untuk beberapa host. </li></ul><br>  <i>Saat ini memeriksa ZeroTier One.</i>  <i>Dipasang hanya di host.</i>  <i>Mengakses alamat IP host ini (bukan lokal, tetapi dikeluarkan oleh ZeroTier) dan port 8082 dari ponsel melalui GPRS ketika klien ZeroTier berjalan, dengan sempurna membuka antarmuka vis.</i> <br><br>  Sangat standar <br><br><pre><code class="plaintext hljs">docker run -d --name ioBroker -p 8081:8081 -p 8082:8082 -v /opt/iobroker/:/opt/iobroker/ --device=/dev/ttyACM0 --env-file /opt/ioBroker_env.list --restart=always buanet/iobroker:latest</code> </pre> <br>  Ups  Ada yang salah. <br><br>  <code>docker logs ioBroker</code> menunjukkan bahwa pada langkah terakhir tidak ada koneksi ke sumber daya eksternal.  Saya tidak bisa mendapatkan nama pisau cukur. <br><br>  <code>docker exec -it ioBroker bash</code> menunjukkan bahwa ping over IP baik-baik saja dari itu, tetapi tidak dengan nama. <br><br>  Google, saya menemukan banyak tautan tentang bagaimana buruh pelabuhan secara salah mengganti server DNS, aturan /etc/docker/daemon.json, saya mengerti dnsmasq - tidak ada yang membantu. <br><br>  Suatu pemikiran merayap masuk, tiba-tiba sesuatu diblokir di tingkat jaringan.  Tapi tidak ada telnet atau ikal di wadah, saya tidak bisa memeriksa.  Instalasi juga tidak mudah - instal yum tidak berfungsi.  Anda tentu saja dapat secara manual menentukan host yang diperlukan di / etc / hosts, tetapi ini terlalu memakan waktu, saya akan lebih baik memeriksa versi lain. <br><br>  Sebagai contoh, saya dengan bodohnya menghentikan firewalld pada host dengan harapan semuanya akan terbuka.  Tapi tidak. <br><br>  Saya ingat bahwa ketersediaan port masih dapat diperiksa dengan wget.  Dan dia ada di wadah!  Dan tidak dapat mengunduh apa pun bahkan dengan IP.  Bahkan antarmuka web dari router rumah tidak dapat terhubung.  Nah, itu berarti masalahnya jelas bukan di DNS, tetapi di iptables. <br><br>  Akibatnya, semuanya berfungsi setelah menambahkan antarmuka buruh pelabuhan ke zona tepercaya: <br><br><pre> <code class="plaintext hljs">sudo firewall-cmd --permanent --zone=trusted --change-interface=docker0 sudo firewall-cmd --reload</code> </pre> <br>  Itu bahkan menarik, apakah saya mengabaikan instruksi? <br><br>  Atau saya tidak akan mengambil CentOS 8, tetapi sesuatu yang lain, tidak akan ada masalah (di OS lain itu tidak firewall secara default)? <br><br>  Atau begitu jelas bagi semua orang bahwa mereka tidak menulis dalam instruksi, saya sudah bodoh untuk waktu yang lama sendirian? <br><br><h2>  Zigbee </h2><br>  Jadi, ioBroker saya ada di dalam wadah, dan hanya memiliki beberapa port yang diterbitkan.  Sekarang ini adalah admin 8081 dan vis 8082, maka mqtt 1883 akan ditambahkan dan, mungkin, sesuatu untuk mendukung Tuya (saya melihat driver seperti itu, tetapi belum mengetahuinya). <br><br>  Sayangnya, untuk berinteraksi dengan perangkat Xiaomi melalui gateway-nya, multicast diperlukan, dan dengan ini dalam konfigurasi kompleksitas ini.  Karena itu, saya memutuskan untuk melempar wadah USB stick.  Juga operasi normal. <br><br>  Di baris perintah, Anda telah melihat <code>--device=/dev/ttyACM0</code> untuk ini.  Perangkat dalam wadah muncul.  Di ioBroker, saya mengaktifkan driver standar "Zigbee untuk Xiaomi dan perangkat lain", tetapi tidak berhasil. <br><br>  Google menyarankan agar untuk mengakses port serial Anda perlu menambahkan pengguna ke grup dialout.  Saya masuk ke dalam wadah, tambahkan iobroker ke grup ini - itu tidak membantu. <br><br>  Saya melihat petunjuk bahwa Anda perlu menginstal paket serialport melalui npm. <br><br>  Saya tidak bisa, tidak punya hak.  Google lebih jauh. <br><br>  Bluefox sendiri memberi tahu seseorang bahwa direktori ini harus dilakukan dari direktori /opt/iobroker/node_modules/iobroker.javascript/ - Saya tidak punya satu, dan saya masih tidak punya hak instalasi (yah, yaitu instalasi dimulai, lalu crash). <br><br>  Akhirnya, saya sadar bahwa saya perlu secara eksplisit menentukan dalam baris perintah di mana direktori harus diletakkan. <br><br><pre> <code class="plaintext hljs">npm install -g serialport --production --save --prefix "/opt/iobroker"</code> </pre> <br>  Sudah diinstal, tetapi tidak membantu. <br><br>  Saya mulai curiga bahwa Anda masih harus berurusan dengan hak akses.  Memeriksa (dari dalam wadah, tentu saja): <br><br><pre> <code class="plaintext hljs">test -w /dev/ttyACM0 &amp;&amp; echo success || echo failure</code> </pre> <br>  Sukses  Yaitu  Tetap saja, buruh pelabuhan melempar perangkat dengan benar. <br><br><pre> <code class="plaintext hljs">sudo -H -u iobroker test -w /dev/ttyACM0 &amp;&amp; echo success || echo failure</code> </pre> <br>  Gufi!  Kegagalan <br><br>  bash di dalam wadah berjalan di bawah root, Tapi dari pengguna iobroker tidak ada akses ke port.  Meskipun telah menambahkannya ke grup dialout. <br><br>  <code>ls -l /dev/ttyACM0</code> memberi <br><br><pre> <code class="plaintext hljs">crw-rw----. 1 root 18 166, 0 Nov 3 18:14 /dev/ttyACM0</code> </pre> <br>  Ha!  Apa yang 18 bukan nama grup? <br><br>  Semuanya benar pada host utama: <code>crw-rw----. 1 root dialout 166, 0 Nov 3 15:15 /dev/ttyACM0</code> <code>crw-rw----. 1 root dialout 166, 0 Nov 3 15:15 /dev/ttyACM0</code> <br><br>  Ternyata pada host utama di / etc / group <code>dialout:x:18</code> , dan di <code>dialout:x:20</code> container <code>dialout:x:20</code> <br><br>  Meskipun saya menambahkan pengguna ke grup dengan nama itu, tidak masuk akal, jumlahnya tidak sama.  Jadi saya membuat grup lain dengan pengidentifikasi 18, dan sudah menambahkan pengguna ke dalamnya: <br><br><pre> <code class="plaintext hljs">groupadd -g 18 serial usermod -a -G serial iobroker</code> </pre> <br>  Saya memulai kembali semuanya untuk kepastian yang lebih besar.  Dan ini pertikaian saya berakhir :) <br><br>  Dengan tenang dia melepaskan ikatan semua sensor dari gerbang Xiaomi, mengikatnya ke ioBroker. <br><br>  Saya melihatnya sebagai objek di ioBroker itu sendiri: <br><br><img src="https://habrastorage.org/webt/p9/0w/em/p90wem95eieewuuow1fuofngsdw.png"><br><br>  Bacaan Vis dibaca: <br><br><img src="https://habrastorage.org/webt/k7/fb/x2/k7fbx2cnulyb2zyrcjmtr4hzrtg.png"><br><br>  Ketika kontak pada sensor kebocoran ditutup, data diterima.  Dan gambar berubah: <br><br><img src="https://habrastorage.org/webt/2l/qp/z9/2lqpz9rduv_p7am-g-rny-zbdba.png"><br><br>  Dan di Node-Red, sinyalnya datang.  Karenanya, meskipun email atau sesuatu lainnya sedang dikirim, file suara atau MP3 dikirim ke kolom GH Mini: <br><br><img src="https://habrastorage.org/webt/vq/mx/0e/vqmx0eq0tbyf_biq_vpbvkj6lgk.png"><br><br>  Ngomong-ngomong, ketika melihat benda-benda, sebuah kejutan menunggu saya: <br><br><img src="https://habrastorage.org/webt/ny/sk/2a/nysk2aaoyr3nv_zlcf87qqhctya.png"><br><br>  Saya memutar Xiaomi Cube ke sisi lain.  Perubahan terbaru ditampilkan dalam warna hijau. <br>  Flip90 telah berubah - ini bisa dimengerti.  Sinyal ini ditangkap untuk kontrol.  Tapi, ternyata, masih ada flip90_from dan flip90_to - dengan sisi mana dia berbalik. <br><br>  Ternyata, secara teori, Anda bisa mendapatkan lebih banyak sinyal kontrol dari kubus.  Misalnya, jika Anda menggambar panah pada wajah (seolah-olah dalam lingkaran), Anda dapat melacak tidak hanya "putar 90", tetapi juga ke arah mana (dari diri sendiri atau diri Anda sendiri, kiri atau kanan). <br><br>  Untuk flip180 juga berfungsi.  Dan untuk gerakan lain ada informasi tambahan yang serupa (Sisi atas pada flip 180 °, Sisi atas pada slide, Sisi atas pada keran) <br><br>  Bukannya itu sangat dibutuhkan.  Tetapi di Mi Home standar tidak ada informasi tentang wajah.  Tampaknya dengan koneksi sebelumnya melalui Xiaomi Gateway, saya juga tidak melihatnya, saya tidak tahu bahwa setiap wajah memiliki nomor.  Sebelumnya, saya hanya tahu tentang tindakan tambahan jatuh (jatuh bebas), yang, tetapi mereka diusir dari Mi Home (tampaknya, mereka menjatuhkannya terlalu sering). <br><br><h2>  Terakhir </h2><br>  Yang saya butuhkan adalah bekerja.  Maka Anda dapat membawa keindahan, menulis skrip, menghubungkan Tuya, meluncurkan wadah dengan Blynk untuk proyek lain ... <br><br>  Dan, mungkin, untuk mengulang sesuatu berdasarkan komentar Anda :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id474354/">https://habr.com/ru/post/id474354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id474338/index.html">Sinopsis tentang Pembelajaran Mesin. Analisis matematis. Keturunan gradien</a></li>
<li><a href="../id474342/index.html">Mempercepat adegan dalam video menggunakan tampilan tabel</a></li>
<li><a href="../id474344/index.html">Internet Benda di Industri: Bagaimana Cara Kerja Pabrik Cerdas?</a></li>
<li><a href="../id474346/index.html">Pengembangan Docker di Windows Subsystem for Linux (WSL)</a></li>
<li><a href="../id474352/index.html">Penghancuran musuh dengan melompat, seperti dalam "Mario" Unity 2D</a></li>
<li><a href="../id474356/index.html">ThingJS v1.0-alpha</a></li>
<li><a href="../id474358/index.html">Tidur cukup di akhir pekan: bagaimana white noise membantu orang dewasa untuk rileks dan memantau kualitas tidur anak-anak</a></li>
<li><a href="../id474360/index.html">Tingkatkan CSS Anda dengan 5 prinsip ini.</a></li>
<li><a href="../id474364/index.html">Pengembangan elektronik. Ulasan subjektif dari sensor terintegrasi yang paling berguna</a></li>
<li><a href="../id474366/index.html">Acara digital di Moskow dari 4 hingga 10 November</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>