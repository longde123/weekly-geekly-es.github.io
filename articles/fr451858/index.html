<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐶 🐩 🤺 Faire un simple disjoncteur basé sur le cache au printemps 🎶 🏂🏻 🤙🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est destiné à ceux qui utilisent un cache efficace dans leur application et souhaitent ajouter de la stabilité non seulement à l'applicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Faire un simple disjoncteur basé sur le cache au printemps</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451858/">  Cet article est destiné à ceux qui utilisent un cache efficace dans leur application et souhaitent ajouter de la stabilité non seulement à l'application, mais à l'environnement entier en ajoutant simplement 1 classe au projet. <br><br>  Si vous vous reconnaissez, lisez la suite. <br><br><h2>  Qu'est-ce qu'un disjoncteur? </h2><br><img src="https://habrastorage.org/webt/w-/bn/xj/w-bnxjrhl9n7nnjby9grw571koa.png" alt="Image du film Retour vers le futur"><br><a name="habracut"></a><br>  Le thème est galvaudé comme le monde et je ne vous ennuierai pas, augmentant l'entropie et répétant la même chose.  De mon point de vue, Martin Fowler a parlé le mieux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , mais je vais essayer de rentrer la définition dans une phrase: <br>  <i>fonctionnalité qui empêche les demandes sciemment vouées à un service indisponible, lui permettant de «se lever de ses genoux» et de continuer à fonctionner normalement</i> . <br><br>  Idéalement, pour éviter les demandes condamnées, le disjoncteur (ci-après CB) ne devrait pas casser votre application.  Au lieu de cela, il est recommandé de renvoyer, sinon les données les plus récentes, mais toujours pertinentes («pas fautes»), ou, si cela n'est pas possible, une valeur par défaut. <br><br><h2>  Buts </h2><br>  Nous distinguons l'essentiel: <br><br><ol><li>  Il est nécessaire de permettre à la source de données de récupérer, en arrêtant les requêtes pendant un certain temps </li><li>  En cas d'arrêt des demandes au service cible, vous devez fournir, sinon les données les plus récentes mais toujours pertinentes </li><li>  Si le service cible n'est pas disponible et qu'il n'y a pas de données pertinentes, fournissez une stratégie de comportement (renvoyant la valeur par défaut ou une autre stratégie adaptée à un cas particulier) </li></ol><br><h2>  Mécanisme de mise en œuvre </h2><br><h3>  Cas: le service est disponible (première demande) </h3><br><ol><li>  Allons dans le cache.  Par clé (CRT voir ci-dessous).  On voit qu'il n'y a rien dans le cache </li><li>  Nous allons au service cible.  Nous obtenons la valeur </li><li>  Nous stockons la valeur dans le cache, la définissons sur un tel TTL qui couvrira le temps maximum possible pendant lequel le service cible n'est pas disponible, mais en même temps, il ne devrait pas dépasser la période de pertinence des données que vous êtes prêt à fournir au client en cas de perte de connexion avec le service cible </li><li>  Le temps de rafraîchissement du cache (CRT) est stocké dans le cache pour la valeur de la clause 3 - le temps après lequel vous devez essayer d'accéder au service cible et mettre à jour la valeur </li><li>  Renvoyer la valeur de l'élément 2 à l'utilisateur </li></ol><br><h3>  Cas: CRT n'a pas expiré </h3><br><ol><li>  Allons dans le cache.  Par la clé, nous trouvons CRT.  On voit que c'est pertinent </li><li>  Obtenez-en la valeur dans le cache. </li><li>  Renvoyez la valeur à l'utilisateur. </li></ol><br><h3>  Cas: CRT a expiré, le service cible est disponible </h3><br><ol><li>  Allons dans le cache.  Par la clé, nous trouvons CRT.  Nous voyons que ce n'est pas pertinent </li><li>  Nous allons au service cible.  Nous obtenons la valeur </li><li>  Mise à jour de la valeur dans le cache et son TTL </li><li>  Mettre à jour le CRT pour cela, en ajoutant la période de rafraîchissement du cache (CRP) - c'est la valeur qui doit être ajoutée au CRT pour obtenir le prochain CRT </li><li>  Renvoyez la valeur à l'utilisateur. </li></ol><br><h3>  Cas: CRT expiré, service cible non disponible </h3><br><ol><li>  Allons dans le cache.  Par la clé, nous trouvons CRT.  Nous voyons que ce n'est pas pertinent </li><li>  Nous allons au service cible.  Il n'est pas disponible </li><li>  Obtenez la valeur du cache.  Pas le plus récent (avec un CRT pourri), mais toujours pertinent, car son TTL n'a pas encore expiré </li><li>  Nous le renvoyons à l'utilisateur </li></ol><br><h3>  Cas: CRT expiré, service cible indisponible, rien dans le cache </h3><br><ol><li>  Allons dans le cache.  Par la clé, nous trouvons CRT.  Nous voyons que ce n'est pas pertinent </li><li>  Nous allons au service cible.  Il n'est pas disponible </li><li>  Obtenez la valeur du cache.  Il n'est pas </li><li>  Nous essayons d'appliquer une stratégie spéciale pour de tels cas.  Par exemple, renvoyer une valeur par défaut pour un champ spécifié ou une valeur spéciale du type «Ces informations ne sont pas actuellement disponibles».  En général, si cela est possible, il est préférable de renvoyer quelque chose et de ne pas casser l'application.  Si cela n'est pas possible, vous devez appliquer la stratégie de levée d'exceptions et la réponse rapide à l'utilisateur d'exception. </li></ol><br><h2>  Ce que nous utiliserons </h2><br>  J'utilise Spring Boot 1.5 dans mon projet, je n'ai toujours pas trouvé le temps de passer à la deuxième version. <br><br>  Que l'article ne s'est pas avéré 2 fois plus long, j'utiliserai Lombok. <br><br>  En tant que stockage de valeur-clé (ci-après simplement appelé KV), j'utilise Redis 5.0.3, mais je suis sûr que Hazelcast ou un analogue fera l'affaire.  L'essentiel est qu'il existe une implémentation de l'interface CacheManager.  Dans mon cas, il s'agit de RedisCacheManager de spring-boot-starter-data-redis. <br><br><h2>  Implémentation </h2><br>  Ci-dessus, dans la section «Mécanisme de mise en œuvre», deux définitions importantes ont été faites: CRT et CRP.  Je vais les réécrire plus en détail, car  ils sont très importants pour comprendre le code qui suit: <br><br>  Le temps de rafraîchissement du cache ( <b>CRT</b> ) est une entrée distincte en KV (clé + suffixe «_crt»), qui indique l'heure à laquelle il est temps d'aller au service cible pour de nouvelles données.  Contrairement à TTL, l'apparition de CRT ne signifie pas que vos données sont «pourries», mais seulement qu'elles sont susceptibles d'être plus récentes dans le service cible.  Je suis frais - enfin, sinon, et le courant descendra. <br><br>  La période de rafraîchissement du cache ( <b>CRP</b> ) est une valeur qui est ajoutée au CRT après l'interrogation du service cible (peu importe qu'elle réussisse ou non).  Grâce à elle, un service à distance a la capacité de «reprendre son souffle» et de restaurer son travail en cas de chute. <br><br>  Donc, traditionnellement, nous commençons par concevoir l'interface principale.  C'est à travers lui que vous devrez travailler avec le cache si vous avez besoin de la logique CB.  Cela devrait être aussi simple que possible: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CircuitBreakerService</span></span></span><span class="hljs-class"> </span></span>{ &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStableValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StableValueParameter parameter)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evictValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EvictValueParameter parameter)</span></span></span></span>; }</code> </pre> <br>  Paramètres d'interface: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StableValueParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String cachePrefix; <span class="hljs-comment"><span class="hljs-comment">//    private String objectCacheKey; private long crpInSeconds; // Cache Refresh Period private Supplier&lt;T&gt; targetServiceAction; //      private DisasterStrategy disasterStrategy; //   : CRT ,   ,     public StableValueParameter( String cachePrefix, String objectCacheKey, long crpInSeconds, Supplier&lt;T&gt; targetServiceAction ) { this.cachePrefix = cachePrefix; this.objectCacheKey = objectCacheKey; this.crpInSeconds = crpInSeconds; this.targetServiceAction = targetServiceAction; this.disasterStrategy = new ThrowExceptionDisasterStrategy(); } }</span></span></code> </pre><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EvictValueParameter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String cachePrefix; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String objectCacheKey; }</code> </pre><br>  Voici comment nous allons l'utiliser: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AccountDataResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String accountId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StableValueParameter&lt;?&gt; parameter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StableValueParameter&lt;&gt;( ACCOUNT_CACHE_PREFIX, accountId, properties.getCrpInSeconds(), () -&gt; bankClient.findById(accountId) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> circuitBreakerService.getStableValue(parameter); }</code> </pre><br>  Si vous devez vider le cache, alors: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evictAccount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String accountId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EvictValueParameter parameter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EvictValueParameter( ACCOUNT_CACHE_PREFIX, accountId ); circuitBreakerService.evictValue(parameter); }</code> </pre><br>  Maintenant, la chose la plus intéressante est l'implémentation (expliquée dans les commentaires dans le code): <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStableValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StableValueParameter parameter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cache cache = cacheManager.getCache(parameter.getCachePrefix()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> logAndThrowUnexpectedCacheMissing(parameter.getCachePrefix(), parameter.getObjectCacheKey()); } <span class="hljs-comment"><span class="hljs-comment">//   .   CRT final String crtKey = parameter.getObjectCacheKey() + CRT_CACHE_POSTFIX; //  CRT  ,    final LocalDateTime crt = Optional.ofNullable(cache.get(crtKey, LocalDateTime.class)) .orElseGet(() -&gt; DateTimeUtils.now().minusSeconds(1)); if (DateTimeUtils.now().isBefore(crt)) { //  CRT   ,     final Optional&lt;T&gt; valueFromCache = getFromCache(parameter, cache); if (valueFromCache.isPresent()) { return valueFromCache.get(); } } //  CRT  ,        return getFromTargetServiceAndUpdateCache(parameter, cache, crtKey, crt); } private static &lt;T&gt; Optional&lt;T&gt; getFromCache(StableValueParameter parameter, Cache cache) { return (Optional&lt;T&gt;) Optional.ofNullable(cache.get(parameter.getObjectCacheKey())) .map(Cache.ValueWrapper::get); }</span></span></code> </pre><br>  Si le service cible n'est pas disponible, essayez d'obtenir les données toujours pertinentes du cache: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromTargetServiceAndUpdateCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( StableValueParameter parameter, Cache cache, String crtKey, LocalDateTime crt )</span></span></span><span class="hljs-function"> </span></span>{ T result; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { result = getFromTargetService(parameter); } <span class="hljs-comment"><span class="hljs-comment">/* Circuit breaker exceptions */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (WebServiceIOException ex) { log.warn( <span class="hljs-string"><span class="hljs-string">"[CircuitBreaker] Service responded with error: {}. Try get from cache {}: {}"</span></span>, ex.getMessage(), parameter.getCachePrefix(), parameter.getObjectCacheKey()); result = getFromCacheOrDisasterStrategy(parameter, cache); } cache.put(parameter.getObjectCacheKey(), result); cache.put(crtKey, crt.plusSeconds(parameter.getCrpInSeconds())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromTargetService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StableValueParameter parameter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T) parameter.getTargetServiceAction().get(); }</code> </pre><br>  S'il n'y avait pas de données réelles dans le cache (elles ont été supprimées par TTL et le service cible n'est toujours pas disponible), alors nous utilisons DisasterStrategy: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromCacheOrDisasterStrategy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StableValueParameter parameter, Cache cache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T) getFromCache(parameter, cache).orElseGet(() -&gt; parameter.getDisasterStrategy().getValue()); }</code> </pre><br>  Supprimer du cache n'a rien d'intéressant, je ne le donnerai ici que pour être complet: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromCacheOrDisasterStrategy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StableValueParameter parameter, Cache cache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T) getFromCache(parameter, cache).orElseGet(() -&gt; parameter.getDisasterStrategy().getValue()); }</code> </pre><br>  Supprimer du cache n'a rien d'intéressant, je ne le donnerai ici que pour être complet: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evictValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EvictValueParameter parameter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cache cache = cacheManager.getCache(parameter.getCachePrefix()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { logAndThrowUnexpectedCacheMissing(parameter.getCachePrefix(), parameter.getObjectCacheKey()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String crtKey = parameter.getObjectCacheKey() + CRT_CACHE_POSTFIX; cache.evict(crtKey); }</code> </pre><br><h2>  Stratégie en cas de catastrophe </h2><br><img src="https://habrastorage.org/webt/ka/fw/_0/kafw_0jvueyuguwcdbjz4eksnz8.png" alt="Image du film Retour vers le futur"><br><br>  C'est, en fait, la logique qui se produit si le CRT expire, le service cible n'est pas disponible et il n'y a rien dans le cache. <br><br>  Je voulais décrire cette logique séparément, car  beaucoup n'arrivent pas à réfléchir à la manière de le mettre en œuvre.  Mais c'est en fait ce qui rend notre système vraiment stable. <br><br>  Ne voulez-vous pas ressentir ce sentiment de fierté dans votre idée lorsque tout ce qui ne peut qu'échouer est refusé et que votre système fonctionne toujours?  Même en dépit du fait que, par exemple, dans le champ «prix», non pas le coût réel des marchandises sera affiché, mais l'inscription: «en cours de spécification», mais combien est-ce mieux que la réponse «le service 500 n'est pas disponible».  Après tout, par exemple, les 10 champs restants: description du produit, etc.  tu es revenu.  Dans quelle mesure la qualité d'un tel service change-t-elle? .. Mon appel est de prêter plus d'attention aux détails, en les améliorant. <br><br>  Fin de la digression lyrique.  Ainsi, l'interface de stratégie sera la suivante: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DisasterStrategy</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  Vous devez choisir l'implémentation en fonction du cas spécifique.  Par exemple, si vous pouvez renvoyer une valeur par défaut, vous pouvez faire quelque chose comme ceci: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultValueDisasterStrategy</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DisasterStrategy</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"   "</span></span>; } }</code> </pre><br>  Ou, si dans un cas particulier vous n'avez rien à retourner du tout, vous pouvez lever une exception: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThrowExceptionDisasterStrategy</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DisasterStrategy</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CircuitBreakerNullValueException(<span class="hljs-string"><span class="hljs-string">"Ops! Service is down and there's null value in cache"</span></span>); } }</code> </pre><br>  Dans ce cas, le CRT ne sera pas incrémenté et la prochaine demande sera de nouveau envoyée au service cible. <br><br><h2>  Conclusion </h2><br>  J'adhère au point de vue suivant - si vous avez la possibilité d'utiliser une solution toute faite, et de ne pas faire d'histoires, en fait, bien que simple, mais toujours vélo dans cet article, faites-le.  Utilisez cet article pour comprendre comment il fonctionne et non pas comme guide d'action. <br><br>  Il existe de nombreuses solutions prêtes à l'emploi, surtout si vous utilisez Spring Boot 2, comme Hystrix. <br><br>  La chose la plus importante à comprendre est que cette solution est basée sur le cache et que son efficacité est égale à l'efficacité du cache.  Si le cache est inefficace (quelques hits, beaucoup de ratés), alors ce disjoncteur sera tout aussi inefficace: chaque cache raté sera accompagné d'un voyage vers le service cible, qui, peut-être, est à l'agonie et à l'angoisse en ce moment, essayant de s'élever. <br><br>  Assurez-vous de mesurer l'efficacité de votre cache avant d'appliquer cette approche.  Cela peut être fait par "Cache Hit Rate" = hits / (hits + misses), il devrait avoir tendance à 1, pas à 0. <br><br>  Et oui, personne ne vous dérange pour conserver plusieurs variétés de CB à la fois dans votre projet, en utilisant celle qui résout le mieux le problème spécifique. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451858/">https://habr.com/ru/post/fr451858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451842/index.html">Se retrouver</a></li>
<li><a href="../fr451848/index.html">Automatisation de la gestion des certificats SSL de Let's Encrypt à l'aide du défi DNS-01 et d'AWS</a></li>
<li><a href="../fr451852/index.html">Exécution de code arbitraire à distance dans RDP</a></li>
<li><a href="../fr451854/index.html">Interview - 10 questions sur Swift. Partie 1</a></li>
<li><a href="../fr451856/index.html">Installez openmeetings 5.0.0-M1. Conférences WEB sans Flash</a></li>
<li><a href="../fr451860/index.html">Les mathématiciens ont découvert le moyen idéal pour multiplier les nombres</a></li>
<li><a href="../fr451862/index.html">Musical Lightning de Joe Diprim: un ingénieur autodidacte fabrique des bobines Tesla pour le divertissement et le gain</a></li>
<li><a href="../fr451864/index.html">Vulnérabilité RCE critique du niveau EternalBlue détectée dans le système d'exploitation Windows</a></li>
<li><a href="../fr451866/index.html">Choisissez les nœuds les plus proches du réseau</a></li>
<li><a href="../fr451870/index.html">Fonctionnalités C ++ modernes que tous les programmeurs doivent connaître</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>