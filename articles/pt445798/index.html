<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèø ü§õüèø üë®üèª‚Äçüç≥ Rinoceronte dentro do gato - execute o firmware no emulador Kopycat üë®üèø‚Äçüè´ ‚ñ™Ô∏è ü•Ñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante a reuni√£o 0x0A DC7831 DEF CON Nizhny Novgorod, em 16 de fevereiro, apresentamos um relat√≥rio sobre os princ√≠pios b√°sicos da emula√ß√£o de c√≥digo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rinoceronte dentro do gato - execute o firmware no emulador Kopycat</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/445798/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/pb/7e/gipb7e8ucwinvebjerxy1fk2d-8.jpeg" width="80%"></div><br><p>  Durante a reuni√£o 0x0A DC7831 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DEF CON Nizhny Novgorod,</a> em 16 de fevereiro, apresentamos um relat√≥rio sobre os princ√≠pios b√°sicos da emula√ß√£o de c√≥digo bin√°rio e nosso pr√≥prio desenvolvimento - um emulador de plataformas de hardware <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kopycat</a> . </p><br><p>  No artigo, descreveremos o lan√ßamento do firmware do dispositivo no emulador, demonstraremos a intera√ß√£o com o depurador e faremos uma pequena an√°lise din√¢mica do firmware. </p><a name="habracut"></a><br><h2 id="predystoriya">  Antecedentes </h2><br><p><del>  H√° muito tempo, em uma gal√°xia muito distante </del></p><br><p>  H√° alguns anos, em nosso laborat√≥rio, havia a necessidade de estudar o firmware do dispositivo.  O firmware foi compactado, descompactado pelo gerenciador de inicializa√ß√£o.  Ele fez isso de uma maneira muito confusa, v√°rias vezes deslocando dados na mem√≥ria.  Sim, e o pr√≥prio firmware interagiu ativamente com os perif√©ricos.  E tudo isso no n√∫cleo do MIPS. </p><br><p> Por raz√µes objetivas, os emuladores existentes n√£o eram adequados para n√≥s, mas eu ainda queria executar o c√≥digo.  Decidimos ent√£o criar nosso pr√≥prio emulador, o que reduzir√° ao m√≠nimo e permitir√° descompactar o firmware principal.  Tentamos - acabou.  N√≥s pensamos, e se adicionarmos perif√©ricos para tamb√©m executar o firmware principal.  N√£o foi muito doloroso - e funcionou tamb√©m.  Pensamos novamente e decidimos criar um emulador completo. </p><br><p>  O resultado foi um emulador de sistemas de computa√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kopycat</a> . </p><br><img src="https://habrastorage.org/webt/eb/cx/b6/ebcxb6pxtiypy0s-usvu6i_hdwu.png" align="right"><br><div class="spoiler">  <b class="spoiler_title">Porqu√™ o Kopycat?</b> <div class="spoiler_text"><p>  H√° um jogo de palavras. </p><br><ol><li>  <em>copycat</em> (ingl√™s, n. [Ààk…íp…™k√¶t]) - copycat, imitador </li><li>  <em>cat</em> (ingl√™s, n. [Ààk√¶t]) - um gato, um gato - um animal favorito de um dos criadores do projeto </li><li>  Letra "K" - da linguagem de programa√ß√£o Kotlin </li></ol></div></div><br><h2 id="kopycat">  Kopycat </h2><br><p>  Ao criar o emulador, objetivos absolutamente espec√≠ficos foram definidos: </p><br><ul><li>  a capacidade de criar rapidamente uma nova periferia, m√≥dulo, n√∫cleo do processador; </li><li>  a capacidade de montar um dispositivo virtual a partir de v√°rios m√≥dulos; </li><li>  a capacidade de carregar quaisquer dados bin√°rios (firmware) na mem√≥ria do dispositivo virtual; </li><li>  a capacidade de trabalhar com instant√¢neos (instant√¢neos do estado do sistema); </li><li>  a capacidade de interagir com o emulador atrav√©s do depurador embutido; </li><li>  bela linguagem moderna para se desenvolver. </li></ul><br><p>  Como resultado, o Kotlin foi escolhido para implementa√ß√£o, arquitetura de barramento (isto √©, quando os m√≥dulos se comunicam atrav√©s de barramentos de dados virtuais), JSON como formato de descri√ß√£o do dispositivo e GDB RSP como protocolo para interagir com o depurador. </p><br><p>  O desenvolvimento est√° em andamento h√° pouco mais de dois anos e est√° em andamento.  Durante esse per√≠odo, os n√∫cleos dos processadores MIPS, x86, V850ES, ARM, PowerPC foram implementados. </p><br><p>  O projeto est√° crescendo e √© hora de apresent√°-lo ao p√∫blico em geral.  Faremos uma descri√ß√£o detalhada do projeto posteriormente, mas agora vamos nos concentrar no uso do Kopycat. </p><br><p>  Para os mais impacientes - a vers√£o promocional do emulador pode ser baixada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><h2 id="nosorog-v-emulyatore">  Rhino no emulador </h2><br><p>  Lembre-se que anteriormente para a confer√™ncia SMARTRHINO-2018, um dispositivo de teste "Rhinoceros" foi criado para treinamento em habilidades de engenharia reversa.  O processo de an√°lise de firmware est√°tico foi descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neste artigo</a> . </p><br><p>  Agora vamos tentar adicionar "alto-falantes" e executar o firmware no emulador. </p><br><p>  Vamos precisar de: <br>  1) Java 1.8 <br>  2) Python e o m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Jep</a> para usar o Python dentro do emulador.  O assembly WHL do m√≥dulo Jep para Windows pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">baixado aqui</a> . </p><br><p>  <strong>Para Windows:</strong> <br>  1) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com0com</a> <br>  2) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PuTTY</a> </p><br><p>  <strong>Para Linux:</strong> <br>  1) socat </p><br><p>  Voc√™ pode usar Eclipse, IDA Pro ou radare2 como um cliente GDB. </p><br><h2 id="kak-eto-rabotaet">  Como isso funciona? </h2><br><p>  Para executar o firmware no emulador, voc√™ deve "montar" um dispositivo virtual, que √© an√°logo a um dispositivo real. </p><br><p>  O dispositivo real ("rhino") pode ser mostrado em um diagrama de blocos: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nh/ph/ph/nhphph7rjwm3xiv52mvp_uefdq8.jpeg" alt="Circuito de dispositivo real" width="60%"></div><br><p>  O emulador tem uma estrutura modular e o dispositivo virtual final pode ser descrito em um arquivo JSON. </p><br><div class="spoiler">  <b class="spoiler_title">JSON em 105 linhas</b> <div class="spoiler_text"><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"top"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, // Plugin name should be the same as file name (or full path from library start) <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"rhino"</span></span>, // Directory where plugin places <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, // Plugin parameters (constructor parameters if jar-plugin version) <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_dbg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"tty_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"firmware"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default"</span></span>: <span class="hljs-string"><span class="hljs-string">"NUL"</span></span>} ], // Plugin outer ports <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: [ ], // Plugin internal buses <span class="hljs-attr"><span class="hljs-attr">"buses"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mem"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS30"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nand"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"4"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"gpio"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-string"><span class="hljs-string">"BUS32"</span></span> } ], // Plugin internal components <span class="hljs-attr"><span class="hljs-attr">"modules"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"u1_stm32"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"STM32F042"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"firmware:String"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.firmware"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"usart_debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_dbg"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"term_bt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"UartSerialTerminal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"terminals"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"tty"</span></span>: <span class="hljs-string"><span class="hljs-string">"params.tty_bt"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"bluetooth"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"BT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_12"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_13"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_14"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"led_15"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"plugin"</span></span>: <span class="hljs-string"><span class="hljs-string">"LED"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"library"</span></span>: <span class="hljs-string"><span class="hljs-string">"mcu"</span></span> } ], // Plugin connection between components <span class="hljs-attr"><span class="hljs-attr">"connections"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart1_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"usart_debug.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"u1_stm32.ports.usart2_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.usart_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_s"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_m"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"bluetooth.ports.bt_m"</span></span>, <span class="hljs-string"><span class="hljs-string">"term_bt.ports.term_s"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_0.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x00"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_1.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x01"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_2.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x02"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_3.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x03"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_4.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x04"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_5.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x05"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_6.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x06"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_7.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x07"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_8.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x08"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_9.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x09"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_10.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0A"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_11.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0B"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_12.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0C"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_13.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0D"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_14.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0E"</span></span>], [ <span class="hljs-string"><span class="hljs-string">"led_15.ports.pin"</span></span>, <span class="hljs-string"><span class="hljs-string">"u1_stm32.buses.pin_output_a"</span></span>, <span class="hljs-string"><span class="hljs-string">"0x0F"</span></span>] ] }</code> </pre> <br><p>  Preste aten√ß√£o no par√¢metro <em>firmware</em> na se√ß√£o <strong>params</strong> - este √© o nome do arquivo que pode ser baixado no dispositivo virtual como firmware. </p></div></div><br><p>  Um dispositivo virtual e sua intera√ß√£o com o sistema operacional principal podem ser representados da seguinte maneira: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m9/i_/27/m9i_27btauj0onjugttzj3srmfg.jpeg" alt="Dispositivo emulado por circuito" width="80%"></div><br><p>  A inst√¢ncia de teste atual do emulador envolve intera√ß√£o com as portas COM do sistema operacional principal (depurar UART e UART para o m√≥dulo Bluetooth).  Podem ser portas reais √†s quais os dispositivos est√£o conectados ou portas COM virtuais ( <em>com0com / socat √©</em> apenas para isso <em>)</em> . </p><br><p>  Atualmente, existem duas maneiras principais de interagir com o emulador de fora: </p><br><ul><li>  Protocolo GDB RSP (respectivamente, suportando este protocolo, ferramentas - Eclipse / IDA / radare2); </li><li>  linha de comando interna do emulador (Argparse ou Python). </li></ul><br><h3 id="virtualnye-com-porty">  Portas COM virtuais </h3><br><p>  Para interagir com o UART do dispositivo virtual na m√°quina local atrav√©s do terminal, voc√™ precisa criar algumas portas COM virtuais conectadas.  No nosso caso, uma porta usa um emulador e a segunda um programa de terminal (PuTTY ou tela): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5d/jr/0w/5djr0wz88dgdaiw1xaasrof2wyk.png" alt="Portas COM virtuais" width="80%"></div><br><h4 id="ispolzovanie-com0com">  Usando com0com </h4><br><p>  As portas COM virtuais s√£o configuradas com o utilit√°rio de instala√ß√£o do kit com0com (a vers√£o do console √© <em>C: \ Arquivos de Programas (x86) \ com0com \ setup.exe</em> ou a vers√£o da GUI √© <em>C: \ Arquivos de Programas (x86) \ com0com \ setupg.exe</em> ) : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/j9/pf/v-j9pfquunpiezqhkcr6cuyq-9k.png" alt="Configurar portas COM virtuais"></div><br><p>  <strong><em>Marque as caixas</em></strong> de <strong><em>sele√ß√£o Ativar satura√ß√£o do buffer</em></strong> para todas as portas virtuais criadas, caso contr√°rio, o emulador aguardar√° uma resposta da porta COM. </p><br><h4 id="ispolzovanie-socat">  Usando socat </h4><br><p>  Nos sistemas UNIX, as portas COM virtuais s√£o criadas automaticamente pelo emulador usando o utilit√°rio socat, para isso basta especificar o prefixo <code>socat:</code> no nome da porta ao iniciar o emulador. </p><br><h3 id="vnutrenniy-interfeys-komandnoy-stroki-argparse-ili-python">  Interface de linha de comando interna (Argparse ou Python) </h3><br><p>  Como o Kopycat √© um aplicativo de console, o emulador fornece duas op√ß√µes para a interface da linha de comandos interagir com seus objetos e vari√°veis: Argparse e Python. </p><br><p>  Argparse √© a CLI embutida no Kopycat, est√° sempre dispon√≠vel para todos. </p><br><p>  Uma CLI alternativa √© o interpretador Python.  Para us√°-lo, voc√™ precisa instalar o m√≥dulo Jep Python e configurar o emulador para trabalhar com Python (o interpretador Python instalado no sistema principal do usu√°rio ser√° usado). </p><br><h4 id="ustanovka-python-modulya-jep">  Instale o m√≥dulo Python Jep </h4><br><p>  No Linux, o Jep pode ser instalado via pip: </p><br><pre> <code class="bash hljs">pip install jep</code> </pre> <br><p>  Para instalar o Jep no Windows, voc√™ deve primeiro instalar o Windows SDK e o Microsoft Visual Studio correspondente.  Simplificamos um pouco sua tarefa e fizemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">assemblies WHL</a> JEP para as vers√µes atuais do Python para Windows, para que o m√≥dulo possa ser instalado a partir de um arquivo: </p><br><pre> <code class="bash hljs">pip install jep-3.8.2-cp27-cp27m-win_amd64.whl</code> </pre> <br><p>  Para verificar a instala√ß√£o do Jep, voc√™ deve executar a linha de comando: </p><br><pre> <code class="bash hljs">python -c <span class="hljs-string"><span class="hljs-string">"import jep"</span></span></code> </pre> <br><p>  Em resposta, uma mensagem deve ser recebida: </p><br><pre> <code class="bash hljs">ImportError: Jep is not supported <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> standalone Python, it must be embedded <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Java.</code> </pre> <br><p>  No arquivo em lotes do emulador para o seu sistema ( <em>kopycat.bat</em> para Windows, <em>kopycat</em> para Linux), inclua o par√¢metro adicional <code>Djava.library.path</code> na lista de par√¢metros <code>DEFAULT_JVM_OPTS</code> - ele deve conter o caminho para o m√≥dulo Jep instalado. </p><br><p>  Como resultado, no Windows, voc√™ deve obter uma linha como esta: </p><br><pre> <code class="plaintext hljs">set DEFAULT_JVM_OPTS="-XX:MaxMetaspaceSize=256m" "-XX:+UseParallelGC" "-XX:SurvivorRatio=6" "-XX:-UseGCOverheadLimit" "-Djava.library.path=C:/Python27/Lib/site-packages/jep"</code> </pre> <br><h2 id="zapusk-kopycat">  Lan√ßamento do Kopycat </h2><br><p>  O emulador √© um aplicativo JVM do console.  O lan√ßamento √© realizado atrav√©s do script de linha de comando do sistema operacional (sh / cmd). </p><br><p>  Comando a ser executado no Windows: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=firmware\rhino_pass.bin,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><p>  O comando para executar no Linux usando o utilit√°rio socat: </p><br><pre> <code class="plaintext hljs">./bin/kopycat -g 23946 -n rhino -l user -y library -p firmware=./firmware/rhino_pass.bin,tty_dbg=socat:./COM26,tty_bt=socat:./COM28</code> </pre> <br><ul><li>  <code>-g 23646</code> - porta TCP que ser√° aberta para acesso ao servidor GDB; </li><li>  <code>-n rhino</code> - o nome do m√≥dulo principal do sistema (montagem do dispositivo); </li><li>  <code>-l user</code> - o nome da biblioteca para procurar o m√≥dulo principal; </li><li>  <code>-y library</code> - o caminho para procurar m√≥dulos inclu√≠dos no dispositivo; </li><li>  <code>firmware\rhino_pass.bin</code> - caminho para o arquivo de firmware; </li><li>  COM26 e COM28 s√£o portas COM virtuais. </li></ul><br><p>  O resultado ser√° o <code>Argparse &gt;</code> do <code>Python &gt;</code> (ou <code>Argparse &gt;</code> ): </p><br><pre> <code class="plaintext hljs">18:07:59 INFO [eFactoryBuilder.create ]: Module top successfully created as top 18:07:59 INFO [ Module.initializeAndRes]: Setup core to top.u1_stm32.cortexm0.arm for top 18:07:59 INFO [ Module.initializeAndRes]: Setup debugger to top.u1_stm32.dbg for top 18:07:59 WARN [ Module.initializeAndRes]: Tracer wasn't found in top... 18:07:59 INFO [ Module.initializeAndRes]: Initializing ports and buses... 18:07:59 WARN [ Module.initializePortsA]: ATTENTION: Some ports has warning use printModulesPortsWarnings to see it... 18:07:59 FINE [ ARMv6CPU.reset ]: Set entry point address to 08006A75 18:07:59 INFO [ Module.initializeAndRes]: Module top is successfully initialized and reset as a top cell! 18:07:59 INFO [ Kopycat.open ]: Starting virtualization of board top[rhino] with arm[ARMv6Core] 18:07:59 INFO [ GDBServer.debuggerModule ]: Set new debugger module top.u1_stm32.dbg for GDB_SERVER(port=23946,alive=true) Python &gt;</code> </pre> <br><h2 id="vzaimodeystvie-s-ida-pro">  Intera√ß√£o com o IDA Pro </h2><br><p>  Para simplificar o teste, usamos o firmware Rhino como um <a href="">arquivo ELF</a> (as meta-informa√ß√µes s√£o salvas l√°) como o arquivo de origem para an√°lise na IDA. </p><br><p>  Voc√™ tamb√©m pode usar o firmware principal sem meta-informa√ß√£o. </p><br><p>  Ap√≥s iniciar o Kopycat no IDA Pro, no menu Debugger, v√° para o item " <em>Switch debugger ...</em> " e selecione " <em>Remote GDB debugger</em> ".  Em seguida, configure a conex√£o: Menu <em>Debugger - Process options ...</em> </p><br><p>  Defina os valores: </p><br><ul><li>  Aplica√ß√£o - qualquer valor </li><li>  Nome do host: 127.0.0.1 (ou o endere√ßo IP da m√°quina remota em que o Kopycat est√° sendo executado) </li><li>  Porto: 23946 </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/kw/-l/mxkw-lbzq_igoewovazplw4moho.png" alt="Configurando a conex√£o com o servidor GDB"></div><br><p>  Agora, o bot√£o Iniciar depura√ß√£o est√° dispon√≠vel (tecla F9): </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/mu/-q/afmu-qpi0ymfpsga-orunargmas.png"></div><br><p>  Pressione - ele se conecta ao m√≥dulo depurador no emulador.  A IDA entra no modo de depura√ß√£o, janelas adicionais ficam dispon√≠veis: informa√ß√µes sobre registros, sobre a pilha. </p><br><p>  Agora podemos usar todos os recursos padr√£o do trabalho com o depurador: </p><br><ul><li>  execu√ß√£o passo a passo das instru√ß√µes ( <em>passo a</em> <em>passo</em> e <em>passo a passo</em> - teclas F7 e F8, respectivamente); </li><li>  iniciar e pausar a execu√ß√£o; </li><li>  criando pontos de interrup√ß√£o no c√≥digo e nos dados (tecla F2). </li></ul><br><p>  Conectar-se ao depurador n√£o significa iniciar o c√≥digo do firmware.  A posi√ß√£o atual para execu√ß√£o deve ser o endere√ßo <code>0x08006A74</code> - o in√≠cio da fun√ß√£o <em>Reset_Handler</em> .  Se voc√™ rolar a lista abaixo, poder√° ver a chamada para a fun√ß√£o <em>principal</em> .  Voc√™ pode colocar o cursor nesta linha (endere√ßo <code>0x08006ABE</code> ) e executar a opera√ß√£o <em>Executar at√© o cursor</em> (tecla F4). </p><br><p><img src="https://habrastorage.org/webt/wx/k4/3r/wxk43r-316cpnsdabb9eydkzus4.png" alt="imagem"></p><br><p>  Em seguida, voc√™ pode pressionar F7 para entrar na fun√ß√£o <em>principal</em> . </p><br><p>  Se voc√™ executar o comando <em>Continuar processo</em> (tecla F9), a janela "Aguarde" ser√° exibida com um √∫nico bot√£o <em>Suspender</em> : </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9e/78/tg/9e78tgoterc50rqvmosunzp1u5i.png"></div><br><p>  Quando <em>Suspender √©</em> pressionado, a execu√ß√£o do c√≥digo do firmware √© suspensa e pode ser continuada a partir do mesmo endere√ßo no c√≥digo em que foi interrompido. </p><br><p>  Se voc√™ continuar executando o c√≥digo, nos terminais conectados √†s portas COM virtuais, poder√° ver as seguintes linhas: </p><br><p><img src="https://habrastorage.org/webt/fi/vi/j-/fivij-hshz3izcxoo0lnewnznc8.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/2m/cn/oq/2mcnoqd__te1i0sq5z28jd29mdg.png" alt="imagem"></p><br><p>  A presen√ßa da sequ√™ncia "desvio de estado" indica que o m√≥dulo Bluetooth virtual mudou para o modo de recebimento de dados da porta COM do usu√°rio. </p><br><p>  Agora, no terminal Bluetooth (na figura - COM29), voc√™ pode inserir comandos de acordo com o protocolo Rhino.  Por exemplo, a sequ√™ncia "mur-mur" retorna ao comando "MEOW" no terminal Bluetooth: </p><br><img src="https://habrastorage.org/webt/yq/td/ab/yqtdabgfdd3jlzswsrk3rvbdzds.png"><br><br><h3 id="emuliruy-menya-ne-polnostyu">  Emule-me n√£o completamente </h3><br><p>  Ao criar um emulador, voc√™ pode escolher o grau de detalhe / emula√ß√£o de um dispositivo.  Assim, por exemplo, o m√≥dulo Bluetooth pode ser emulado de diferentes maneiras: </p><br><ul><li>  dispositivo totalmente emulado com um conjunto completo de comandos; </li><li>  Os comandos AT s√£o emulados e o fluxo de dados √© recebido da porta COM do sistema principal; </li><li>  dispositivo virtual fornece redirecionamento completo de dados para um dispositivo real; </li><li>  como um esbo√ßo simples que sempre retorna "OK". </li></ul><br><p>  Na vers√£o atual do emulador, a segunda abordagem √© usada - o m√≥dulo Bluetooth virtual executa a configura√ß√£o, ap√≥s o que alterna para o modo "proxy" de dados da porta COM do sistema principal para a porta UART do emulador. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e6/5c/m_/e65cm_tl2bggpbg0-q0azjvdz64.jpeg"></div><br><p>  Considere a possibilidade de instrumenta√ß√£o simples do c√≥digo se alguma parte da periferia n√£o estiver implementada.  Por exemplo, se n√£o for criado um timer que controle a transfer√™ncia de dados no DMA (a verifica√ß√£o √© realizada na fun√ß√£o <em>ws2812b_wait</em> localizada em <code>0x08006840</code> ), o firmware sempre aguardar√° o sinalizador de <em>ocupado</em> localizado em <code>0x200004C4</code> para redefinir a linha de dados do DMA: </p><br><img src="https://habrastorage.org/webt/pt/jj/su/ptjjsutfya2dkoqdoshkeyeeqzw.png"><br><p>  Podemos contornar essa situa√ß√£o redefinindo manualmente o sinalizador de <em>ocupado</em> imediatamente ap√≥s defini-lo.  No IDA Pro, voc√™ pode criar uma fun√ß√£o Python e cham√°-la no ponto de interrup√ß√£o, e o ponto de interrup√ß√£o deve ser definido no c√≥digo ap√≥s gravar o valor 1 no sinalizador de <em>ocupado</em> . </p><br><h4 id="breakpoint-obrabotchik">  Manipulador de ponto de interrup√ß√£o </h4><br><p>  Primeiro, crie uma fun√ß√£o Python no IDA.  Menu <em>Arquivo - comando Script ...</em> </p><br><p>  Adicione um novo trecho na lista √† esquerda, d√™ um nome (por exemplo, <em>BPT</em> ), <br>  na caixa de texto √† direita, inserimos o c√≥digo da fun√ß√£o: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_dma</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Skipping wait ws2812..."</span></span> value = Byte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value == <span class="hljs-number"><span class="hljs-number">1</span></span>: PatchDbgByte(<span class="hljs-number"><span class="hljs-number">0x200004C4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zi/za/-d/ziza-ddx3arqlqfbd-o6jvdmnjc.png"></div><br><p>  Depois disso, clique em <em>Executar</em> e feche a janela de script. </p><br><p>  Agora vamos ao c√≥digo em <code>0x0800688A</code> , defina o ponto de interrup√ß√£o (tecla F2), edite-o ( <em>Editar ponto de interrup√ß√£o ...</em> menu de contexto), n√£o se esque√ßa de definir o tipo de script - Python: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fo/pn/1v/fopn1vb8fbxqrhn6xoia_rgnsau.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h6/yq/b2/h6yqb29r1m9sngr3csfimxcxsew.png"></div><br><p>  Se o valor atual do sinalizador de <em>ocupado</em> for 1, a fun√ß√£o <em>skip_dma</em> deve ser <em>executada</em> na linha de script: </p><br><img src="https://habrastorage.org/webt/m-/t8/in/m-t8in2th7ei6neigdzgzq17kxy.png"><br><p>  Se voc√™ executar o firmware para execu√ß√£o, o c√≥digo do manipulador de ponto de interrup√ß√£o poder√° ser visto no IDA na janela <em>Sa√≠da</em> na linha <code>Skipping wait ws2812...</code>  Agora o firmware n√£o esperar√° para redefinir o sinalizador de <em>ocupado</em> . </p><br><h4 id="vzaimodeystvie-s-emulyatorom">  Intera√ß√£o do emulador </h4><br><p>  √â improv√°vel que a emula√ß√£o por causa da emula√ß√£o cause prazer e alegria.  √â muito mais interessante se o emulador ajudar o pesquisador a ver os dados na mem√≥ria ou a estabelecer a intera√ß√£o dos fluxos. </p><br><p>  Mostramos como estabelecer dinamicamente a intera√ß√£o das tarefas RTOS.  Primeiro, pause a execu√ß√£o do c√≥digo, se estiver em execu√ß√£o.  Se voc√™ alternar para a fun√ß√£o <em>bluetooth_task_entry</em> na ramifica√ß√£o de processamento de comando "LED" (endere√ßo <code>0x080057B8</code> ), poder√° ver o que foi criado pela primeira vez e, em seguida, uma mensagem ser√° enviada para a fila do sistema <em>ledControlQueueHandle</em> . </p><br><p><img src="https://habrastorage.org/webt/po/bk/zm/pobkzmapmust02eaafle7d_pxba.png" alt="imagem"></p><br><p>  Voc√™ deve definir o ponto de interrup√ß√£o para acessar a vari√°vel <em>ledControlQueueHandle</em> localizada em <code>0x20000624</code> e continuar executando o c√≥digo: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ev/wo/g3/evwog3vrv7ozxlxjozd4itvve0a.png"></div><br><p>  Como resultado, primeiro ele para no endere√ßo <code>0x080057CA</code> antes de chamar a fun√ß√£o <em>osMailAlloc</em> , depois em <code>0x08005806</code> antes de chamar a fun√ß√£o <em>osMailPut</em> e depois de um tempo no endere√ßo <code>0x08005BD4</code> (antes de chamar a fun√ß√£o <em>osMailGet</em> ), que pertence √† fun√ß√£o <em>leds_task_entry</em> (tarefa LED), ou seja. houve uma troca de tarefas e agora o controle recebeu a tarefa de LED. </p><br><p><img src="https://habrastorage.org/webt/th/ni/zh/thnizhzqykfn20l9-btkuqhawlc.png" alt="imagem"></p><br><p>  De uma maneira t√£o simples, voc√™ pode estabelecer como as tarefas do RTOS interagem entre si. </p><br><p>  Obviamente, na realidade, a intera√ß√£o de tarefas pode ser mais complicada, mas usar um emulador para rastrear essa intera√ß√£o se torna menos dif√≠cil. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ pode assistir a um pequeno v√≠deo de lan√ßamento e intera√ß√£o do emulador com o IDA Pro. </p><br><h2 id="zapusk-s-radare2">  Iniciar com Radare2 </h2><br><p>  Voc√™ n√£o pode ignorar uma ferramenta universal como o Radare2. </p><br><p>  Para conectar-se ao emulador usando r2, o comando ser√° semelhante a este: </p><br><pre> <code class="plaintext hljs">radare2 -A -a arm -b 16 -d gdb://localhost:23946 rhino_fw42k6.elf</code> </pre> <br><p>  Agora iniciar ( <code>dc</code> ) e pausar a execu√ß√£o (Ctrl + C) est√£o dispon√≠veis. </p><br><p>  Infelizmente, no momento em r2, h√° problemas ao trabalhar com um servidor gdb de hardware e marca√ß√£o de mem√≥ria, por isso, pontos de interrup√ß√£o e etapas (o comando <code>ds</code> ) n√£o funcionam.  Esperamos que isso seja corrigido em um futuro pr√≥ximo. </p><br><h2 id="zapusk-s-eclipse">  Iniciar com o Eclipse </h2><br><p>  Uma das op√ß√µes para usar o emulador √© depurar o firmware do dispositivo em desenvolvimento.  Para maior clareza, tamb√©m usaremos o firmware Rhino.  Voc√™ pode baixar as fontes de firmware <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Usaremos o Eclipse do conjunto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">System Workbench for STM32</a> como o IDE. </p><br><p>  Para que o firmware compilado diretamente no Eclipse seja carregado no emulador, voc√™ precisa adicionar o par√¢metro <code>firmware=null</code> ao comando start do emulador: </p><br><pre> <code class="plaintext hljs">bin\kopycat -g 23946 -n rhino -l user -y library -p firmware=null,tty_dbg=COM26,tty_bt=COM28</code> </pre> <br><h3 id="nastroyka-debug-konfiguracii">  Configura√ß√£o de depura√ß√£o </h3><br><p>  No Eclipse, selecione o menu <em>Executar - Configura√ß√µes de depura√ß√£o ....</em> Na janela que √© aberta, na se√ß√£o <em>Depura√ß√£o de hardware</em> do <em>GDB</em> , voc√™ precisa adicionar uma nova configura√ß√£o e especificar o projeto e aplicativo atuais para depura√ß√£o na guia "Principal": </p><br><img src="https://habrastorage.org/webt/f-/yk/eo/f-ykeob2i5vg25qbrz_egbqntou.png"><br><p>  Na guia Depurador, voc√™ deve especificar o comando GDB: <br> <code>${openstm32_compiler_path}\arm-none-eabi-gdb</code> </p> <br><p>  E tamb√©m insira os par√¢metros para conectar ao servidor GDB (host e porta): </p><br><img src="https://habrastorage.org/webt/ef/ud/fo/efudfommb7a9gkr4kcvp0vtnqfm.png"><br><p>  Os seguintes par√¢metros devem ser especificados na guia "Inicializa√ß√£o": </p><br><ul><li>  ative a caixa de sele√ß√£o <em>Carregar imagem</em> (para que a imagem do firmware montada seja carregada no emulador); </li><li>  ative a marca de sele√ß√£o <em>Carregar s√≠mbolos</em> ; </li><li>  adicione um comando de in√≠cio: <code>set $pc = *0x08000004</code> (defina o valor da mem√≥ria para o endere√ßo <code>0x08000004</code> no registro do PC - o endere√ßo do <code>0x08000004</code> √© armazenado l√°). </li></ul><br><p>  <strong>Observe</strong> que, se voc√™ n√£o deseja fazer o download do arquivo de firmware do Eclipse, n√£o precisa especificar os par√¢metros <em>Carregar imagem</em> e <em>Executar comandos</em> . </p><br><img src="https://habrastorage.org/webt/w3/q8/2f/w3q82fvei4c91385rlcipmuiy_i.png"><br><p>  Depois de clicar em Debug, voc√™ pode trabalhar no modo de depura√ß√£o: </p><br><ul><li>  execu√ß√£o de c√≥digo passo a passo <br><img src="https://habrastorage.org/webt/1h/6n/ax/1h6nax1gpgcdyrwakdmzzlu6_x8.png"></li><li>  intera√ß√£o com pontos de interrup√ß√£o <br><img src="https://habrastorage.org/webt/4d/n1/5e/4dn15e4hzaukbif58ggwhy_wg18.png"></li></ul><br><p>  <strong><em>Nota</em></strong>  <em>O Eclipse tem, hmm ... alguns recursos ... e voc√™ tem que conviver com eles.</em>  <em>Por exemplo, se a mensagem "Nenhuma fonte dispon√≠vel para" 0x0 "" aparecer ao iniciar o depurador, execute o comando Etapa (F5)</em> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ra/uz/ko/rauzko55hgnj1y_uapnqbz8ftrw.png"></div><br><h2 id="vmesto-zaklyucheniya">  Em vez de uma conclus√£o </h2><br><p>  A emula√ß√£o de c√≥digo nativo √© uma coisa muito interessante.  Para um desenvolvedor de dispositivos, torna-se poss√≠vel depurar o firmware sem um dispositivo real.  Para o pesquisador - a capacidade de realizar an√°lise din√¢mica de c√≥digo, o que nem sempre √© poss√≠vel, mesmo com um dispositivo. </p><br><p>  Queremos fornecer aos especialistas uma ferramenta que fosse conveniente, moderadamente simples e n√£o demorasse muito tempo e esfor√ßo para configurar e iniciar. </p><br><p>  Escreva nos coment√°rios sobre sua experi√™ncia com o uso de emuladores de hardware.  Convidamos voc√™ para uma discuss√£o e teremos prazer em responder a perguntas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445798/">https://habr.com/ru/post/pt445798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445786/index.html">Criptografia em Java. Classe KeyStore</a></li>
<li><a href="../pt445788/index.html">Vigil√¢ncia por v√≠deo em nuvem fa√ßa voc√™ mesmo: novos recursos do Ivideon Web SDK</a></li>
<li><a href="../pt445792/index.html">Como desenvolvemos a documenta√ß√£o em um projeto aberto da Embox</a></li>
<li><a href="../pt445794/index.html">Gigantes de TI revelam uma solu√ß√£o h√≠brida de implanta√ß√£o de nuvem h√≠brida</a></li>
<li><a href="../pt445796/index.html">Fintech Digest: Dorsey paga com bitcoins, estrat√©gia de blockchain da Austr√°lia, IPO da Levi, prefeito de Chicago e a inevitabilidade do bitcoin</a></li>
<li><a href="../pt445800/index.html">M√¥nadas em 15 minutos</a></li>
<li><a href="../pt445802/index.html">5 coisas que tend√™ncias da Internet que todos deveriam conhecer</a></li>
<li><a href="../pt445804/index.html">Encapsulamento para samurais reais ou as nuances associadas √† palavra-chave interna em C #</a></li>
<li><a href="../pt445806/index.html">Como a intelig√™ncia artificial est√° mudando a ci√™ncia</a></li>
<li><a href="../pt445808/index.html">N√≥s odiamos e ca√ßamos: a vida perigosa de um cracker de v√≠rus que est√° fazendo inimigos poderosos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>