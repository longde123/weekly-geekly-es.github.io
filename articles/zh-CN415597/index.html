<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏄 👔 💎 Postfix-在没有本地主机或邮件服务器的情况下以新方式进行的amavisd-new 🕵🏿 🤔 🎰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="关于如何在一堆postfix-amavisd-new-dovecot上提高邮件服务器有很多说明。 他们中的绝大多数人几乎都是逐字重复，包括错误和不准确之处。 

 我似乎无所顾忌地按了按钮，所以我决定优化标准配置：如果我不是通过localhost，而是在unix套接字上构建postfix和amavi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Postfix-在没有本地主机或邮件服务器的情况下以新方式进行的amavisd-new</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415597/"> 关于如何在一堆postfix-amavisd-new-dovecot上提高邮件服务器有很多说明。 他们中的绝大多数人几乎都是逐字重复，包括错误和不准确之处。 <br><br> 我似乎无所顾忌地按了按钮，所以我决定优化标准配置：如果我不是通过localhost，而是在unix套接字上构建postfix和amavisd-new的交互，该怎么办？ <br><br> 事实证明，一切并不是那么简单，但是我做到了！ 说明书和补丁下切。 <br><a name="habracut"></a><br> 老实说，我通常不喜欢在同一台计算机上通过本地主机进行交互。 如果要组织两个应用程序之间的数据交换，那么通过文件系统上的unix套接字执行此操作更正确，更安全且资源占用更少。 此外，即使在应用程序或协议级别上缺少保护，也可以通过文件系统上的权限来组织保护。 <br><br> 因此，讨论的束中的邮件路径如下所示： <br><br><img src="https://habrastorage.org/webt/2a/yj/lx/2ayjlxnatjoqpaofqg3trbsi9sc.png"><br><br> 事实证明，我们需要组织两个连接：转移到筛选时和返回MTA时。 由于套接字是由侦听器创建的，因此在第一种情况下将被修改，而在第二种情况下-后缀。 <br><br> 让我们从第二个开始，因为它更简单并且描述得更好。 为了使postfix创建一个监听套接字，您只需要在master.cf的第二列（类型列）中指定unix，而不是inet。 在这种情况下，第一列定义套接字的路径和文件名。 <br><br> 由于postfix进程在chroot中工作（可以为特定进程禁用，但不值得），因此您需要在postfix主目录内创建一个文件夹：/ var / spool / postfix。 它将具有两个套接字： <br><br><pre><code class="bash hljs">mkdir /var/spool/postfix/amavis chown amavis:postfix /var/spool/postfix/amavis chmod 770 /var/spool/postfix/amavis</code> </pre> <br> 以及后缀配置： <br><br><pre> <code class="hljs powershell">amavis/postfix<span class="hljs-operator"><span class="hljs-operator">-in</span></span> unix y - y - - smtpd <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_client_restrictions=<span class="hljs-variable"><span class="hljs-variable">$local_clients_only</span></span> <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_helo_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_sender_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_recipient_restrictions= <span class="hljs-literal"><span class="hljs-literal">-o</span></span> smtpd_milters=</code> </pre><br> 具体选项取决于您的设置，这是我的选择。 <br><br> 有两个麻烦： <br><br><ol><li> 该路径是相对于/ var / spool / postfix / private的，该路径必须具有非常严格的权限。 </li><li> 不确定在所有发行版中是否都适用，但是可以肯定在Ubuntu上。 最好不要触摸文件夹的权限（所有postfix服务的套接字都在其中），最好仅创建符号链接。 </li><li> 除套接字外，postfix还为该进程创建了一个pid文件，其名称由$ type的掩码自动生成。 其中type等于unix，名称取自master.cf的第一列。 原来是unux.amavis / postfix-in 文件放在子文件夹中。 他本人将不会创建它，并且会出错。 </li></ol><br> 因此，我们用拐杖代替： <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/spool/postfix/private ln -s ../amavis . mkdir /var/spool/postfix/pid/unix.amavis</code> </pre><br> 不是很好，但对包的常规文件夹结构没有破坏性。 <br><br> 我们重新启动后缀，并确保套接字文件出现在amavis文件夹中，并且pid文件出现在pid / unix.amavis中。 不幸的是，套接字的权限为666，但是您之前创建的文件夹的权限将保护文件免受不必要的注意。 <br><br> 您可以使用以下命令检查工作： <br><br><pre> <code class="bash hljs">netcat -U /var/spool/postfix/amavis/postfix-in 220 mail.example.ru ESMTP Postfix</code> </pre><br> 好吧，他们做到了。 现在建议。 <br><br> 首先，通过postfix拥有的unix套接字配置邮件返回路径。 开箱即用： <br><br><pre> <code class="perl hljs">$forward_method = <span class="hljs-string"><span class="hljs-string">'smtp:/var/spool/postfix/amavis/postfix-in'</span></span>; $notify_method = \$forward_method;</code> </pre><br> 好吧，现在最困难的部分是在amavisd中设置套接字。 该解决方案可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Internet</a>上找到，但是建议使用$ unix_socketname参数指定的单个套接字。 我还想要自己的改良协议（AM.PDP）和通过套接字接收邮件。 <br><br> 默认配置文件包含对@listen_sockets指令的引用，但没有描述。 但是它在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">发行说明中</a> ，甚至带有示例！ 是的，只有一个套接字，但是什么阻止了您尝试呢？ <br><br> 好的，但是如何设置套接字的协议（在策略库中指定）？ 在所有示例中，他们只是写SOCK。 类似于inet套接字（您可以在此处指定主机端口），我建议您需要指定套接字文件的完整路径。 这是发生了什么： <br><br><pre> <code class="perl hljs">$unix_socketname = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_bind = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; $inet_socket_port = <span class="hljs-keyword"><span class="hljs-keyword">undef</span></span>; @listen_sockets = (<span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span>); $unix_socket_mode = <span class="hljs-number"><span class="hljs-number">0660</span></span>; %interface_policy = ( <span class="hljs-string"><span class="hljs-string">'/var/lib/amavis/amavisd.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>, <span class="hljs-string"><span class="hljs-string">'/var/spool/postfix/amavis/amavis-in.sock'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span> ); $policy_bank{<span class="hljs-string"><span class="hljs-string">'LMTP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'LMTP'</span></span> }; $policy_bank{<span class="hljs-string"><span class="hljs-string">'AM.PDP-SOCK'</span></span>} = { <span class="hljs-string"><span class="hljs-string">protocol =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'AM.PDP'</span></span>, <span class="hljs-string"><span class="hljs-string">auth_required_release =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment"># don't require secret-id for release };</span></span></code> </pre><br> 重新启动，检查-实际上，两个套接字都已创建！ 胜利的 并非如此，当您尝试连接到套接字时，什么也没有发生，并且将错误写入协议未为其定义的日志。 事实证明，保单行不适用于他们。 <br><br> 怎么会这样 我不得不去看代码。 <br><br> 这场运动带来了两个消息-和往常一样，好坏。 好的一面是，关于％interface_policy的假设是正确的： <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment"># load policy banks according to my socket (destination), # then check for allowed access from the peer (client/source) # sub access_is_allowed($;$$$$) { my($unix_socket_path, $src_addr, $src_port, $dst_addr, $dst_port) = @_; my(@bank_names); if (defined $unix_socket_path) { push(@bank_names, $interface_policy{"SOCK"}); push(@bank_names, $interface_policy{$unix_socket_path}); } elsif (defined $dst_addr &amp;&amp; defined $dst_port) { $dst_addr = '['.lc($dst_addr).']' if $dst_addr =~ /:[0-9a-f]*:/i; # IPv6? push(@bank_names, $interface_policy{$dst_port}); push(@bank_names, $interface_policy{"$dst_addr:$dst_port"}); } load_policy_bank($_) for @bank_names;</span></span></code> </pre><br> 不好的是，$ unix_socket_path进入此函数为空。 填写如下： <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $is_ux = $sock &amp;&amp; $sock-&gt;UNIVERSAL::can(<span class="hljs-string"><span class="hljs-string">'NS_proto'</span></span>) &amp;&amp; $sock-&gt;NS_proto eq <span class="hljs-string"><span class="hljs-string">'UNIX'</span></span>;</code> </pre><br> 并且两个属性在那都是空的。 <br><br> 对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a>的研究建议使用此选项： <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $unix_socket_path = $sock-&gt;hostpath();</code> </pre><br> 而且有效！ 准备好了.patch可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>说。 <br><br> 最后一点。 由于amavisd创建了自己的仅具有自身权限的套接字，并且我们拒绝了对其余套接字的访问（这是正确的），因此我们需要在amavis组中添加后缀，以便它可以写入套接字： <br><br><pre> <code class="bash hljs">gpasswd -a postfix amavis</code> </pre><br> 做完了 <br><br>  PS：我通过电子邮件发送了Mark Martinec的补丁和问题描述，因为我在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网站</a>上未发现任何有关bug跟踪器的信息。 我仍然没有得到答案，但是我真的没有指望它-该项目看起来已经被放弃（两年多以前的最新版本）。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN415597/">https://habr.com/ru/post/zh-CN415597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN415587/index.html">StereoPi-我们用于研究计算机视觉，无人机和机器人的硬件</a></li>
<li><a href="../zh-CN415589/index.html">“关于PD的更多信息”：美国电视公司将停止出售客户地理数据</a></li>
<li><a href="../zh-CN415591/index.html">苹果工程师陷阱MacBook Pro键盘陷阱</a></li>
<li><a href="../zh-CN415593/index.html">6年后，传奇的崩溃发行版Hiren's BootCD的新版本</a></li>
<li><a href="../zh-CN415595/index.html">以SLOT游戏为例，提高玩家保留率的方法：第1部分</a></li>
<li><a href="../zh-CN415599/index.html">印度也想得到氦3</a></li>
<li><a href="../zh-CN415601/index.html">Kubernetes HA集群与容器化 还是没有docker的生活？</a></li>
<li><a href="../zh-CN415605/index.html">我们如何使用Exadata保存卡处理</a></li>
<li><a href="../zh-CN415611/index.html">PKI：GCrypt和KSBA库是对OpenSSL的替代，具有对俄罗斯密码的支持。 延续性</a></li>
<li><a href="../zh-CN415613/index.html">为什么不应该购买LED吊灯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>