<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úñÔ∏è üë©üèΩ‚Äçüé® ü§∏üèº D√©composer les principes fondamentaux de C #: allouer de la m√©moire pour un type de r√©f√©rence sur la pile üåø ‚åõÔ∏è ü§πüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article vous montrera les bases des types internes, comme bien s√ªr un exemple dans lequel la m√©moire pour le type de r√©f√©rence sera allou√©e compl√®...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©composer les principes fondamentaux de C #: allouer de la m√©moire pour un type de r√©f√©rence sur la pile</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448338/">  Cet article vous montrera les bases des types internes, comme bien s√ªr un exemple dans lequel la m√©moire pour le type de r√©f√©rence sera allou√©e compl√®tement sur la pile (c'est parce que je suis un programmeur √† pile compl√®te). <br><br><img src="https://habrastorage.org/webt/xn/xh/rl/xnxhrlrmdifxe8o2pwopy-y-xhw.jpeg"><br><br><h3>  Clause de non-responsabilit√© </h3><br>  Cet article ne contient pas de mat√©riel qui devrait √™tre utilis√© dans des projets r√©els.  Il s'agit simplement d'une extension des fronti√®res dans lesquelles un langage de programmation est per√ßu. <br><br>  Avant de poursuivre avec l'histoire, je vous recommande fortement de lire le premier post sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StructLayout</a> , car il y a un exemple qui sera utilis√© dans cet article (Cependant, comme toujours). <br><a name="habracut"></a><br><h3>  Pr√©histoire </h3><br>  Commen√ßant √† √©crire du code pour cet article, je voulais faire quelque chose d'int√©ressant en utilisant le langage d'assemblage.  Je voulais en quelque sorte casser le mod√®le d'ex√©cution standard et obtenir un r√©sultat vraiment inhabituel.  Et en me souvenant de la fr√©quence √† laquelle les gens disent que le type de r√©f√©rence diff√®re des types de valeur en ce que les premiers sont situ√©s sur le tas et les seconds sur la pile, j'ai d√©cid√© d'utiliser un assembleur pour montrer que le type de r√©f√©rence peut vivre sur le pile.  Cependant, j'ai commenc√© √† rencontrer toutes sortes de probl√®mes, par exemple en renvoyant l'adresse et sa pr√©sentation sous forme de lien g√©r√© (j'y travaille toujours).  J'ai donc commenc√© √† tricher et √† faire quelque chose qui ne fonctionne pas en langage assembleur, en C #.  Et √† la fin, il n'y avait pas du tout d'assembleur. <br>  Lisez √©galement la recommandation - si vous √™tes familier avec la disposition des types de r√©f√©rence, je vous recommande de sauter la th√©orie √† leur sujet (seules les bases seront donn√©es, rien d'int√©ressant). <br><br><h3>  Un peu sur les internes des types (pour l'ancien framework, maintenant certains d√©calages sont modifi√©s, mais le sch√©ma global est le m√™me) </h3><br>  Je voudrais rappeler que la division de la m√©moire en une pile et un tas se produit au niveau .NET, et cette division est purement logique;  il n'y a physiquement aucune diff√©rence entre les zones de m√©moire sous le tas et la pile.  La diff√©rence de productivit√© n'est fournie que par diff√©rents algorithmes de travail avec ces deux domaines. <br><br>  Alors, comment allouer de la m√©moire sur la pile?  Pour commencer, comprenons comment ce myst√©rieux type de r√©f√©rence est organis√© et ce qu'il a, ce type de valeur n'a pas. <br><br>  Consid√©rez donc l'exemple le plus simple avec la classe Employee. <br><br><div class="spoiler">  <b class="spoiler_title">Code employ√©</b> <div class="spoiler_text"><pre><code class="plaintext hljs">public class Employee { private int _id; private string _name; public virtual void Work() { Console.WriteLine(‚ÄúZzzz...‚Äù); } public void TakeVacation(int days) { Console.WriteLine(‚ÄúZzzz...‚Äù); } public static void SetCompanyPolicy(CompanyPolicy policy) { Console.WriteLine("Zzzz..."); } }</code> </pre> <br></div></div><br>  Et voyons comment il est pr√©sent√© en m√©moire. <br>  Cette classe est consid√©r√©e sur l'exemple d'un syst√®me 32 bits. <br><br><img src="https://habrastorage.org/webt/vr/p9/pz/vrp9pzrp7gclrthnistslmvxnfg.png"><br><br>  Ainsi, en plus de la m√©moire des champs, nous avons deux autres champs cach√©s - l'index du bloc de synchronisation (titre du mot d'en-t√™te d'objet dans l'image) et l'adresse de la table de m√©thode. <br><br>  Le premier champ (l'index du bloc de synchronisation) ne nous int√©resse pas vraiment.  En pla√ßant le type, j'ai d√©cid√© de le sauter.  Je l'ai fait pour deux raisons: <br><br><ol><li>  Je suis tr√®s paresseux (je n'ai pas dit que les raisons seraient raisonnables) </li><li>  Pour le fonctionnement de base de l'objet, ce champ n'est pas obligatoire. </li></ol><br>  Mais comme nous avons d√©j√† commenc√© √† parler, je pense qu'il est juste de dire quelques mots sur ce domaine.  Il est utilis√© √† diff√©rentes fins (code de hachage, synchronisation).  Au contraire, le champ lui-m√™me est simplement un index de l'un des blocs de synchronisation associ√©s √† l'objet donn√©.  Les blocs eux-m√™mes sont situ√©s dans la table des blocs de synchronisation (quelque chose comme un tableau global).  La cr√©ation d'un tel bloc est une op√©ration assez importante, donc il n'est pas cr√©√© s'il n'est pas n√©cessaire.  De plus, lors de l'utilisation de verrous fins, l'identifiant du thread qui a re√ßu le verrou (au lieu de l'index) y sera √©crit. <br><br>  Le deuxi√®me domaine est beaucoup plus important pour nous.  Gr√¢ce √† la table des m√©thodes de types, un outil aussi puissant que le polymorphisme est possible (qui, soit dit en passant, les structures, empilent les rois, ne poss√®dent pas). <br>  Supposons que la classe Employee impl√©mente en outre trois interfaces: IComparable, IDisposable et ICloneable. <br><br>  Ensuite, le tableau des m√©thodes ressemblera √† ceci. <br><br><img src="https://habrastorage.org/webt/x3/e9/wn/x3e9wne2jnil20fke6-gj2ovdv4.png"><br><br>  L'image est tr√®s cool, tout est montr√© et tout est net.  Pour r√©sumer, la m√©thode virtuelle n'est pas appel√©e directement par adresse, mais par le d√©calage dans la table des m√©thodes.  Dans la hi√©rarchie, les m√™mes m√©thodes virtuelles seront situ√©es au m√™me d√©calage dans la table des m√©thodes.  Autrement dit, sur la classe de base, nous appelons la m√©thode par d√©calage, ne sachant pas quel type de table de m√©thodes sera utilis√©, mais sachant que ce d√©calage sera la m√©thode la plus pertinente pour le type d'ex√©cution. <br><br>  Il convient √©galement de se rappeler que la r√©f√©rence d'objet pointe uniquement vers le pointeur de la table des m√©thodes. <br><br><h3>  Exemple tant attendu </h3><br>  Commen√ßons par des cours qui nous aideront dans notre objectif.  En utilisant StructLayout (j'ai vraiment essay√© sans, mais cela n'a pas fonctionn√©), j'ai √©crit des mappeurs simples - des pointeurs vers des types g√©r√©s et inversement.  Obtenir un pointeur √† partir d'un lien g√©r√© est assez facile, mais la transformation inverse m'a caus√© des difficult√©s et, sans y r√©fl√©chir √† deux fois, j'ai appliqu√© mon attribut pr√©f√©r√©.  Pour garder le code dans une cl√©, faite dans 2 directions dans un sens. <br><br><div class="spoiler">  <b class="spoiler_title">Code des cartographes</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">// Provides the signatures we need public class PointerCasterFacade { public virtual unsafe T GetManagedReferenceByPointer&lt;T&gt;(int* pointer) =&gt; default(T); public virtual unsafe int* GetPointerByManagedReference&lt;T&gt;(T managedReference) =&gt; (int*)0; } // Provides the logic we need public class PointerCasterUnderground { public virtual T GetManagedReferenceByPointer&lt;T&gt;(T reference) =&gt; reference; public virtual unsafe int* GetPointerByManagedReference&lt;T&gt;(int* pointer) =&gt; pointer; } [StructLayout(LayoutKind.Explicit)] public class PointerCaster { public PointerCaster() { pointerCaster= new PointerCasterUnderground(); } [FieldOffset(0)] private PointerCasterUnderground pointerCaster; [FieldOffset(0)] public PointerCasterFacade Caster; }</code> </pre><br></div></div><br><br>  Tout d'abord, nous √©crivons une m√©thode qui prend un pointeur vers une certaine m√©moire (pas n√©cessairement sur la pile, soit dit en passant) et configure le type. <br><br>  Pour la simplicit√© de trouver l'adresse de la table de m√©thode, je cr√©e un type sur le tas.  Je suis s√ªr que le tableau des m√©thodes peut √™tre trouv√© autrement, mais je ne me suis pas fix√© pour objectif d'optimiser ce code, il √©tait plus int√©ressant pour moi de le rendre compr√©hensible.  De plus, en utilisant les convertisseurs d√©crits pr√©c√©demment, nous obtenons un pointeur sur le type cr√©√©. <br><br>  Ce pointeur pointe exactement vers la table des m√©thodes.  Par cons√©quent, il suffit d'obtenir simplement le contenu de la m√©moire vers laquelle il pointe.  Ce sera l'adresse de la table des m√©thodes. <br>  Et puisque le pointeur qui nous est transmis est une sorte de r√©f√©rence d'objet, nous devons √©galement √©crire l'adresse de la table de m√©thode exactement l√† o√π elle pointe. <br><br>  En fait, c'est tout.  Soudain, non?  Maintenant, notre type est pr√™t.  Pinocchio, qui nous a attribu√© de la m√©moire, se chargera lui-m√™me de l'initialisation des champs. <br><br>  Il ne reste plus qu'√† utiliser notre roulette ultra-m√©ga pour convertir le pointeur en lien g√©r√©. <br><pre> <code class="plaintext hljs">public class StackInitializer { public static unsafe T InitializeOnStack&lt;T&gt;(int* pointer) where T : new() { T r = new T(); var caster = new PointerCaster().Caster; int* ptr = caster.GetPointerByManagedReference(r); pointer[0] = ptr[0]; T reference = caster.GetManagedReferenceByPointer&lt;T&gt;(pointer); return reference; } }</code> </pre><br>  Nous avons maintenant un lien sur la pile qui pointe vers la m√™me pile, o√π selon toutes les lois des types de r√©f√©rence (enfin, presque) se trouve un objet construit √† partir de terre noire et de b√¢tons.  Le polymorphisme est disponible. <br><br>  Il faut comprendre que si vous passez ce lien en dehors de la m√©thode, puis apr√®s son retour, nous obtiendrons quelque chose de peu clair.  √Ä propos des appels de m√©thodes virtuelles et de la parole ne peut pas √™tre, l'exception se produira.  Les m√©thodes normales sont appel√©es directement, le code n'aura que des adresses pour les m√©thodes r√©elles, donc elles fonctionneront.  Et √† la place des champs seront ... et personne ne sait ce qui sera l√†. <br><br>  Puisqu'il est impossible d'utiliser une m√©thode distincte pour l'initialisation sur la pile (puisque le cadre de pile sera √©cras√© apr√®s son retour de la m√©thode), la m√©thode qui veut appliquer le type sur la pile doit allouer de la m√©moire.  √Ä strictement parler, il existe plusieurs fa√ßons de proc√©der.  Mais le plus appropri√© pour nous est <b>stackalloc</b> .  Juste le mot-cl√© parfait pour nos besoins.  Malheureusement, cela apporte le <i>dangereux</i> dans le code.  Avant cela, il y avait une id√©e d'utiliser Span √† ces fins et de se passer de code dangereux.  Dans le code dangereux, il n'y a rien de mal, mais comme partout, ce n'est pas une solution miracle et a ses propres domaines d'application. <br><br>  Ensuite, apr√®s avoir re√ßu le pointeur vers la m√©moire de la pile actuelle, nous passons ce pointeur √† la m√©thode qui compose le type en plusieurs parties.  C'est tout ce qui a √©cout√© - bravo. <br><br><pre> <code class="plaintext hljs">unsafe class Program { public static void Main() { int* pointer = stackalloc int[2]; var a = StackInitializer.InitializeOnStack&lt;StackReferenceType&gt;(pointer); a.StubMethod(); Console.WriteLine(a.Field); Console.WriteLine(a); Console.Read(); } }</code> </pre><br>  Vous ne devez pas l'utiliser dans des projets r√©els, la m√©thode d'allocation de m√©moire sur la pile utilise un nouveau T (), qui √† son tour utilise la r√©flexion pour cr√©er un type sur le tas!  Cette m√©thode sera donc plus lente que la cr√©ation habituelle du type de fois bien, en 40-50.  De plus ce n'est pas multiplateforme. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici</a> vous pouvez trouver l'ensemble du projet. <br><br>  Source: dans le guide th√©orique, des exemples du livre Sasha Goldstein - Pro .NET Performace ont √©t√© utilis√©s </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr448338/">https://habr.com/ru/post/fr448338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr448328/index.html">√Ä Moscou montrera une imprimante qui imprime des organes et des tissus</a></li>
<li><a href="../fr448330/index.html">Nombres al√©atoires et r√©seaux d√©centralis√©s: une application pratique</a></li>
<li><a href="../fr448332/index.html">Initier les adeptes de l'informatique: montrez votre force sur un r√©cif</a></li>
<li><a href="../fr448334/index.html">Quand la productivit√© d'une personne suscite l'int√©r√™t</a></li>
<li><a href="../fr448336/index.html">S√©minaire ¬´Nuages ‚Äã‚Äãhybrides - avantages et inconv√©nients: quoi pr√©parer pour les affaires et l'informatique¬ª - 25 avril, Moscou</a></li>
<li><a href="../fr448340/index.html">Cr√©ation du jeu 35MM. Apr√®s l'apocalypse en Russie</a></li>
<li><a href="../fr448342/index.html">MyDrops - TWS √† faible co√ªt avec un bon son et Bluetooth fiable</a></li>
<li><a href="../fr448346/index.html">De GNU √† Doom: TechTrain 2019 annonc√©</a></li>
<li><a href="../fr448350/index.html">Impl√©mentation de dictionnaire en Python</a></li>
<li><a href="../fr448352/index.html">Boring Company va creuser un tunnel √† Las Vegas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>