<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ค๐ฟ ๐บ ๐ ุตูุน ุชุทุจูู ููุจ ุญุฏูุซ ูู ุงูุตูุฑ ๐ถ๏ธ ๐ง๐พ ๐จ๐ฟโ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุฐูู ุ ูุฑุฑุช ุฃู ุชุฌุนู ูุดุฑูุน ุฌุฏูุฏ. ููุฐุง ุงููุดุฑูุน ูู ุชุทุจูู ููุจ. ูู ูู ุงูููุช ุณูุณุชุบุฑู ุฅูุดุงุก ูููุฐุฌ ุฃููู ุฃุณุงุณูุ ูุง ูุฏู ุตุนูุจุฉ ุฐููุ ูุง ุงูุฐู ูุฌุจ ุฃู ูููู ูููุน ุงููู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุตูุน ุชุทุจูู ููุจ ุญุฏูุซ ูู ุงูุตูุฑ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444446/" style=";text-align:right;direction:rtl"> ูุฐูู ุ ูุฑุฑุช ุฃู ุชุฌุนู ูุดุฑูุน ุฌุฏูุฏ.  ููุฐุง ุงููุดุฑูุน ูู ุชุทุจูู ููุจ.  ูู ูู ุงูููุช ุณูุณุชุบุฑู ุฅูุดุงุก ูููุฐุฌ ุฃููู ุฃุณุงุณูุ  ูุง ูุฏู ุตุนูุจุฉ ุฐููุ  ูุง ุงูุฐู ูุฌุจ ุฃู ูููู ูููุน ุงูููุจ ุงูุญุฏูุซ ูุงุฏุฑูุง ุนูู ุงูููุงู ุจู ูู ุงูุจุฏุงูุฉุ <br><br>  ูู ูุฐู ุงูููุงูุฉ ุ ุณูุญุงูู ุชุญุฏูุฏ ูุฎุทุท ุชุทุจูู ุงูููุจ ุงูุจุณูุท ูุน ุงูุจููุฉ ุงูุชุงููุฉ: <br><br><div style="text-align:center;;text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><img src="https://habrastorage.org/webt/ul/ne/9v/ulne9vljujdrtxnf-qeqrrux7da.png"></a> </div><br>  ูุง ุณูู ูุบุทู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุจูุฆุฉ ุฏูู ูู ุชุฃููู ุนุงูู ูููุงุก. </li><li style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุงูุฎูููุฉ ุนูู ูุงุฑูุฑุฉ. </li><li style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ุนูู Express. </li><li style=";text-align:right;direction:rtl">  ุจูุงุก JS ุจุงุณุชุฎุฏุงู Webpack. </li><li style=";text-align:right;direction:rtl">  ุงูุฑุฏ ุ ูุงูุงุณุชุฑุฌุงุน ุ ูุชูุฏูู ุฌุงูุจ ุงูุฎุงุฏู. </li><li style=";text-align:right;direction:rtl">  ุทูุงุจูุฑ ุงููููุฉ ูุน RQ. </li></ul><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  ููุฏูุฉ </h2><br>  ูุจู ุงูุชุทููุฑ ุ ุจุงูุทุจุน ุ ุนููู ุฃููุงู ุฃู ุชูุฑุฑ ูุง ุงูุฐู ูููู ุจุชุทููุฑู!  ูุชุทุจูู ูููุฐุฌู ููุฐู ุงูููุงูุฉ ุ ูุฑุฑุช ุฅูุดุงุก ูุญุฑู ูููู ุจุฏุงุฆู.  ุณูููู ูุฏููุง ุงูุจุทุงูุงุช ุงูุตุงุฏุฑุฉ ูู ุชุฎููุถ ุงูุณุนุฑ.  ูููู ูุดุงูุฏุชูุง ู (ูู ููุช ูุง ูู ุงููุณุชูุจู) ุชูุฏู ุชุนุฏููุงุช.  ูู ูุฐุง ุณูู ูุฑุชุจ ูุชุทุจูู ูู ุตูุญุฉ ูุงุญุฏุฉ ูุน ุชูุฏูู ุฌุงูุจ ุงูุฎุงุฏู (ููู ุฃูุฑ ุถุฑูุฑู ููุบุงูุฉ ูููุฑุณุฉ ุชูุฑุงุจุงูุชูุง ุงููุณุชูุจููุฉ ูู ุงููุญุชูู). <br><br>  ุฏุนููุง ูููู ูุธุฑุฉ ุฃูุซุฑ ุชูุตููุง ุนูู ุงูููููุงุช ุงูุชู ูุญุชุงุฌูุง ููุฐุง: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <b>ุงูุนููู.</b>  ุฏุนููุง ููุดุฆ ุชุทุจูููุง ูู ุตูุญุฉ ูุงุญุฏุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ูุน ุงูุชูุงูุงุช ุงูุตูุญุฉ ุจุงุณุชุฎุฏุงู AJAX) ุนูู ุญุฒูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">React</a> + <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Redux</a> ุ ููู ุฃูุฑ ุดุงุฆุน ุฌุฏูุง ูู ุนุงูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. </li><li style=";text-align:right;direction:rtl">  <b>ุงููุงุฌูุฉ ุงูุฃูุงููุฉ</b> .  ูููู ุจุฅูุดุงุก ุฎุงุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Express</a> ุจุณูุท ูู ุดุฃูู ุชูุฏูู ุชุทุจูู React (ุทูุจ ุฌููุน ุงูุจูุงูุงุช ุงููุงุฒูุฉ ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ุจุดูู ุบูุฑ ูุชุฒุงูู) ูุฅุตุฏุงุฑู ูููุณุชุฎุฏู. </li><li style=";text-align:right;direction:rtl">  <b>ุงูุฎูููุฉ</b> .  ูุงุฌุณุชูุฑ ูู ููุทู ุงูุฃุนูุงู ุ ุณูููู ูุฏููุง ุงูุฎูููุฉ ุชุทุจูู ูุงุฑูุฑุฉ ุตุบูุฑ.  ุณูููู ุจุชุฎุฒูู ุงูุจูุงูุงุช (ุงูุจุทุงูุงุช ุงูุฎุงุตุฉ ุจูุง) ูู ูุณุชูุฏุน ูุซุงุฆู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">MongoDB</a> ุงูุดููุฑ ุ ููู ูุงุฆูุฉ ุงูุชุธุงุฑ ุงูููุงู ุ ูุฑุจูุง ูู ุงููุณุชูุจู ุ ุงูุชุฎุฒูู ุงููุคูุช ุ ุณูู ูุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Redis</a> . </li><li style=";text-align:right;direction:rtl">  <b>ุงูุนุงูู</b> .  ุณูุชู ุฅุทูุงู ุญุงููุฉ ูููุตูุฉ ููููุงู ุงูุซูููุฉ ูู ูุจู ููุชุจุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RQ</a> . </li></ul><br><h2 style=";text-align:right;direction:rtl">  ุงูุจููุฉ ุงูุชุญุชูุฉ: ุจูุงุจุฉ </h2><br>  ุฑุจูุง ุ ูู ูุชููู ูู ุงูุชุญุฏุซ ุนู ูุฐุง ุ ูููู ุ ุจุงูุทุจุน ุ ุณูููู ุจุฅุฌุฑุงุก ุงูุชูููุฉ ูู ูุณุชูุฏุน ุจูุงุจุฉ. <br><br><pre style=";text-align:right;direction:rtl"><code class="bash hljs">git init git remote add origin git@github.com:Saluev/habr-app-demo.git git commit --allow-empty -m <span class="hljs-string"><span class="hljs-string">"Initial commit"</span></span> git push</code> </pre> <br>  (ููุง ูุฌุจ ุฃู ุชููุฃ ุนูู ุงูููุฑ. <code>.gitignore</code> .) <br><br>  ูููู ุงูุงุทูุงุน <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู</a> ุงููุณูุฏุฉ ุงูููุงุฆูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู ุฌูุซุจ</a> .  ูุชูุงูู ูู ูุณู ูู ุงูููุงูุฉ ูุน ุงูุชุฒุงู ูุงุญุฏ (ููุช ุจุชุฌุฏูุฏ ุงููุซูุฑ ูุชุญููู ุฐูู!). <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุจููุฉ ุงูุชุญุชูุฉ: ุนุงูู ูููุงุก ูุคูู </h2><br>  ููุจุฏุฃ ุจุฅุนุฏุงุฏ ุงูุจูุฆุฉ.  ูุน ููุฑุฉ ุงูููููุงุช ุงูุชู ูุฏููุง ุ ุณูููู ุญู ุงูุชุทููุฑ ุงูููุทูู ููุบุงูุฉ ูู ุงุณุชุฎุฏุงู ุนุงูู ุงูุฅุฑุณุงุก. <br><br>  ุฃุถู ููู <code>docker-compose.yml</code> ุฅูู ุงููุณุชูุฏุน ุจุงููุญุชูู ุงูุชุงูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">version: '3' services: mongo: image: "mongo:latest" redis: image: "redis:alpine" backend: build: context: . dockerfile: ./docker/backend/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis ports: - "40001:40001" volumes: - .:/code frontend: build: context: . dockerfile: ./docker/frontend/Dockerfile environment: - APP_ENV=dev - APP_BACKEND_URL=backend:40001 - APP_FRONTEND_PORT=40002 depends_on: - backend ports: - "40002:40002" volumes: - ./frontend:/app/src worker: build: context: . dockerfile: ./docker/worker/Dockerfile environment: - APP_ENV=dev depends_on: - mongo - redis volumes: - .:/code</code> </pre><br>  ุฏุนูุง ูููู ูุธุฑุฉ ุณุฑูุนุฉ ุนูู ูุง ูุญุฏุซ ููุง. <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชู ุฅูุดุงุก ุญุงููุฉ MongoDB ูุญุงููุฉ Redis. </li><li style=";text-align:right;direction:rtl">  ูุชู ุฅูุดุงุก ุญุงููุฉ ูููุงุฌูุฉ ุงูุฎูููุฉ ูุฏููุง (ูุงูุชู ููุถุญูุง ุฃุฏูุงู).  ูุชุบูุฑ ุงูุจูุฆุฉ APP_ENV = ูุชู ุชูุฑูุฑ dev ุฅููู (ุณููุธุฑ ุฅููู ูููู ุฅุนุฏุงุฏุงุช Flask ุงููุฑุงุฏ ุชุญููููุง) ุ ูุณูุชู ูุชุญ ุงููููุฐ 40001 ุงูุฎุงุต ุจู ูู ุงูุฎุงุฑุฌ (ูู ุฎูุงูู ุณููุชูู ุนููู ุงููุณุชุนุฑุถ ุงูุฎุงุต ุจูุง ุฅูู API). </li><li style=";text-align:right;direction:rtl">  ูุชู ุฅูุดุงุก ุญุงููุฉ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุฏููุง.  ูุชู ุฃูุถูุง ุทุฑุญ ูุฌููุนุฉ ูุชููุนุฉ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุ ูุงูุชู ุณุชููู ูููุฏุฉ ููุง ูู ููุช ูุงุญู ุ ูุณูุชู ูุชุญ ุงููููุฐ 4000. ูุฐุง ูู ุงููููุฐ ุงูุฑุฆูุณู ูุชุทุจูู ุงูููุจ ุงูุฎุงุต ุจูุง: ูู ุงููุชุตูุญ ุณูู ูุฐูุจ ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">http: // localhost: 40002</a> . </li><li style=";text-align:right;direction:rtl">  ูุชู ุฅูุดุงุก ุญุงููุฉ ุนุงูููุง.  ุฅูู ูุง ูุญุชุงุฌ ุฅูู ููุงูุฐ ุฎุงุฑุฌูุฉ ุ ูุงููุตูู ููุท ูุทููุจ ูู MongoDB ู Redis. </li></ul><br>  ุงูุขู ูููู ุจุฅูุดุงุก ุฃุฑุตูุฉ  ูู ุงูููุช ุงูุญุงูู ุ ุชุฃุชู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุณูุณูุฉ ูู</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุชุฑุฌูุงุช</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููููุงูุงุช</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุชุงุฒุฉ</a> ุญูู Docker ุฅูู Habrรฉ - ููููู ุงูุฐูุงุจ ุฅูู ููุงู ุจูู ุฃูุงู. <br><br>  ููุจุฏุฃ ูุน ุงูุฎูููุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># docker/backend/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD gunicorn -w 1 -b 0.0.0.0:40001 --worker-class gevent backend.server:app</code> </pre><br>  ูู ุงููุนููู ุฃููุง ูููุฐ ูู ุฎูุงู ุชุทุจูู gunicorn Flask ุ ูุฎุชุจุฆูู ุชุญุช ุงุณู <code>app</code> ูู ูุญุฏุฉ <code>backend.server</code> . <br><br>  ูุง ุชูู ุฃูููุฉ <code>docker/backend/.dockerignore</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">.git .idea .logs .pytest_cache frontend tests venv *.pyc *.pyo</code> </pre><br>  ูุดุจู ุงูุนุงูู ุนููููุง ุงูุฎูููุฉ ุ ููุท ุจุฏูุงู ูู gunicorn ูุฏููุง ุงูุฅุทูุงู ุงููุนุชุงุฏ ููุญุฏุฉ ุงูุญูุฑุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># docker/worker/Dockerfile FROM python:stretch COPY requirements.txt /tmp/ RUN pip install -r /tmp/requirements.txt ADD . /code WORKDIR /code CMD python -m worker</code> </pre><br>  ุณููุนู ูู ุงูุนูู ูู <code>worker/__main__.py</code> . <br><br>  <code>.dockerignore</code> ุงูุนุงูู <code>.dockerignore</code> ุชูุงููุง ุงููุงุฌูุฉ ุงูุฎูููุฉ <code>.dockerignore</code> . <br><br>  ูุฃุฎูุฑุง ุ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ.  ููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงูุฉ ูููุตูุฉ ูุงููุฉ</a> ุนูู ุญูู ุญุจุฑู ุ ูููู ุฅุฐุง ูุธุฑูุง ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุงุด ุงููุณุชููุถ ุญูู StackOverflow</a> ูุงูุชุนูููุงุช ุจุฑูุญ "ุงูุฑุฌุงู ุ ูู ูู ุจุงููุนู 2018 ุ ูู ูุง ููุฌุฏ ุญู ุทุจูุนู ุจุนุฏุ"  ูู ุดูุก ููุณ ุจูุฐู ุงูุจุณุงุทุฉ ููุงู.  ุฃูุง ุงุณุชูุฑ ุนูู ูุฐุง ุงูุฅุตุฏุงุฑ ูู ููู ุนุงูู ูููุงุก. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># docker/frontend/Dockerfile FROM node:carbon WORKDIR /app #  package.json  package-lock.json   npm install,   . COPY frontend/package*.json ./ RUN npm install #       , #     PATH. ENV PATH /app/node_modules/.bin:$PATH #      . ADD frontend /app/src WORKDIR /app/src RUN npm run build CMD npm run start</code> </pre><br>  ุงูุงูุฌุงุจูุงุช: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุชู ุชุฎุฒูู ูู ุดูุก ููุง ูู ูุชููุน (ูู ุงูุทุจูุฉ ุงูุณูููุฉ - ุงูุชุจุนูุงุช ุ ูู ุงูุฌุฒุก ุงูุนููู - ุจูุงุก ุชุทุจูููุง) ุ </li><li style=";text-align:right;direction:rtl">  <code>docker-compose exec frontend npm install --save newDependency</code> ูุนูู ููุง ูุฌุจ ูุชุนุฏูู <code>package.json</code> ูู <code>docker-compose exec frontend npm install --save newDependency</code> (ูุงูุฐู ูู ูููู ูุฐูู ุฅุฐุง ุงุณุชุฎุฏููุง COPY ุ ููุง ูุดูุฑ ูุซูุฑ ูู ุงููุงุณ).  ูู ูููู ูู ุงููุณุชุญุณู ุชุดุบูู <code>npm install --save newDependency</code> ุฎุงุฑุฌ ุงูุญุงููุฉ ุนูู ุฃู ุญุงู ุ ูุฃู ุจุนุถ ุชุจุนูุงุช ุงูุญุฒูุฉ ุงูุฌุฏูุฏุฉ ูุฏ ุชููู ููุฌูุฏุฉ ุจุงููุนู ููุชู ุฅูุดุงุคูุง ุชุญุช ูุธุงู ุฃุณุงุณู ูุฎุชูู (ุชุญุช ุงููุธุงู ุงูููุฌูุฏ ุฏุงุฎู ุนุงูู ุงููููุงุก ุ ูููุณ ุชุญุช macbook ุงูุนูู ูุฏููุง ุ ุนูู ุณุจูู ุงููุซุงู ) ุ ููุน ุฐูู ููุญู ุนููููุง ูุง ูุฑูุฏ ุทูุจ ูุฌูุฏ Node ุนูู ุฌูุงุฒ ุงูุชุทููุฑ.  ุนุงูู ูุงุญุฏ ููุญูู ุนูููู ุฌููุนุง! </li></ul><br>  ุญุณูุง ูุจุงูุทุจุน <code>docker/frontend/.dockerignore</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">.git .idea .logs .pytest_cache backend worker tools node_modules npm-debug tests venv</code> </pre><br>  ูุฐูู ุ ุฅุทุงุฑ ุงูุญุงููุฉ ุงูุฎุงุต ุจูุง ุฌุงูุฒ ูููููู ุชุนุจุฆุชู ุจุงููุญุชููุงุช! <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุฎูููุฉ: ุฅุทุงุฑ ูุงุฑูุฑุฉ </h2><br>  ุฃุถู <code>flask</code> ุ <code>flask-cors</code> ุ <code>gunicorn</code> ู <code>gunicorn</code> <code>requirements.txt</code> <code>gunicorn</code> ููู ุจุฅูุดุงุก ุชุทุจูู Flask ุจุณูุท ูู <code>backend/server.py</code> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) # CORS        #    ,      # (  Access-Control-Origin  ). #   - . flask_cors.CORS(self) app = HabrAppDemo("habr-app-demo") env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br>  ุฃุฎุจุฑูุง Flask ุจุณุญุจ ุงูุฅุนุฏุงุฏุงุช ูู ููู <code>backend.{env}_settings</code> ุ ููุง ูุนูู ุฃููุง ุณูุญุชุงุฌ ุฃูุถูุง ุฅูู ุฅูุดุงุก <code>backend/dev_settings.py</code> ูููู (ุนูู ุงูุฃูู ูุงุฑุบ) <code>backend/dev_settings.py</code> ูู ุดูุก. <br><br>  ุงูุขู ูููููุง ุฃู ูุฒูุฏ ุฑุณููุง ูุฏููุง ุงูุฎูููุฉ! <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">habr-app-demo$ docker-compose up backend ... backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Starting gunicorn 19.9.0 backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Listening at: http://0.0.0.0:40001 (6) backend_1 | [2019-02-23 10:09:03 +0000] [6] [INFO] Using worker: gevent backend_1 | [2019-02-23 10:09:03 +0000] [9] [INFO] Booting worker with pid: 9</code> </pre><br>  ูุญู ููุถู ูุฏูุง. <br><br><h2 style=";text-align:right;direction:rtl">  ุงููุงุฌูุฉ ุงูุฃูุงููุฉ: ุงูุฅุทุงุฑ ุงูุณุฑูุน </h2><br>  ููุจุฏุฃ ุจุฅูุดุงุก ุญุฒูุฉ.  ุจุนุฏ ุฅูุดุงุก ูุฌูุฏ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุชุดุบูู <code>npm init</code> ููู ุ ุจุนุฏ ุจุนุถ ุงูุฃุณุฆูุฉ ุบูุฑ <code>npm init</code> ุ ูุญุตู ุนูู ุงูุญุฒูุฉ ุงูููุงุฆูุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"habr-app-demo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"This is an app demo for Habr article."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"index.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"git"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"git+https://github.com/Saluev/habr-app-demo.git"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tigran Saluev &lt;tigran@saluev.com&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bugs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo/issues"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"homepage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/Saluev/habr-app-demo#readme"</span></span> }</code> </pre><br>  ูู ุงููุณุชูุจู ุ ูุณูุง ุจุญุงุฌุฉ ุฅูู Node.js ุนูู ุงูุฅุทูุงู ุนูู ุฌูุงุฒ ุงููุทูุฑ (ุนูู ุงูุฑุบู ูู ุฃูู ูุง ูุฒุงู ุจุฅููุงููุง ุชูุงุฏู ูุจุฏุก ุชุดุบูู <code>npm init</code> ุนุจุฑ Docker ุ ูููู ุฌูุฏูุง). <br><br>  ูู <code>Dockerfile</code> ุฐูุฑูุง <code>npm run build</code> ู <code>npm run start</code> - ุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ุงูุฃูุงูุฑ ุงูููุงุณุจุฉ ุฅูู <code>package.json</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -4,6 +4,8 @@ "description": "This is an app demo for Habr article.", "main": "index.js", "scripts": { + "build": "echo 'build'", + "start": "node index.js", "test": "echo \"Error: no test specified\" &amp;&amp; exit 1" }, "repository": {</span></span></code> </pre><br>  ุฃูุฑ <code>build</code> ูุง ููุนู ุดูุฆูุง ุจุนุฏ ุ ูููู ุณูุธู ูููุฏูุง ููุง. <br><br>  ุฃุถู ุชุจุนูุงุช <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Express</a> ููู ุจุฅูุดุงุก ุชุทุจูู ุจุณูุท ูู <code>index.js</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/package.json +++ b/frontend/package.json @@ -17,5 +17,8 @@ "bugs": { "url": "https://github.com/Saluev/habr-app-demo/issues" }, - "homepage": "https://github.com/Saluev/habr-app-demo#readme" + "homepage": "https://github.com/Saluev/habr-app-demo#readme", + "dependencies": { + "express": "^4.16.3" + } }</span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js const express = require("express"); app = express(); app.listen(process.env.APP_FRONTEND_PORT); app.get("*", (req, res) =&gt; { res.send("Hello, world!") });</span></span></code> </pre><br>  ุงูุขู <code>docker-compose up frontend</code> ูุซูุฑ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุฏููุง!  ุนูุงูุฉ ุนูู ุฐูู ุ ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">http: // localhost: 40002</a> ุ ูุฌุจ ุฃู ูุธูุฑ "Helloุ world" ุงูููุงุณููู ุจุงููุนู. <br><br><h2 style=";text-align:right;direction:rtl">  Frontend: ุจูุงุก ูุน ุชุทุจูู webpack ู React </h2><br>  ุญุงู ุงูููุช ูุชุตููุฑ ุดูุก ุฃูุซุฑ ูู ูุต ุนุงุฏู ูู ุทูุจูุง.  ูู ูุฐุง ุงููุณู ุ ุณูุถูู ุฃุจุณุท ูููู React ูู <code>App</code> ููููู ุจุชูููู ุงูุชุฌููุน. <br><br>  ุนูุฏ ุงูุจุฑูุฌุฉ ูู React ุ ูู ุงููุฑูุญ ุฌุฏูุง ุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">JSX</a> ุ ููู ููุฌุฉ ูู ุฌุงูุง ุณูุฑูุจุช ููุชุฏุฉ ุนุจุฑ ุงูุฅูุดุงุกุงุช ุงููุญููุฉ ูููููุฐุฌ <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"blue"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{this.props.caption}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MyButton</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; }</code> </pre><br>  ููุน ุฐูู ุ ูุง ุชููู ูุญุฑูุงุช JavaScript ุฐูู ุ ูุฐูู ุนุงุฏุฉู ูุง ุชุชู ุฅุถุงูุฉ ูุฑุญูุฉ ุงูุฅูุดุงุก ุฅูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ.  ูููู ุจุฑูุงูุฌ ุงูุชุญููู ุงูุจุฑูุฌู ูุฌุงูุง ุณูุฑูุจุช ุงูุฎุงุต (ูุนู ุ ูุนู) ุจุชุญููู ุงูุณูุฑ ุงููุญูู ุฅูู ุฌุงูุง ุณูุฑูุจุช ููุงุณูููุฉ <s>ูุจูุญุฉ</s> ุ ูุงูุชุนุงูู ูุน ุงููุงุฑุฏุงุช ุ ูุงูุชูููู ุ ูููู ุฌุฑุง. <br><br><img src="https://habrastorage.org/webt/f1/rl/0j/f1rl0jer0cxs_ll69yagvwm_0gc.jpeg"><br><br>  <i>2014 ุณูุฉ.</i>  <i>apt-cache search java</i> <br><br>  ูุฐูู ุ ูุจุฏู ุฃุจุณุท ูููู React ุจุณูุทูุง ุฌุฏูุง. <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' class App extends Component { render() { return &lt;h1&gt;Hello, world!&lt;/h1&gt; } } export default App</span></span></code> </pre><br>  ููุงู ุงูู ุจุจุณุงุทุฉ ุนุฑุถ ุชุญูุฉ ูุฏููุง ูุน ุฏุจูุณ ุฃูุซุฑ ุฅููุงุนุง. <br><br>  ุฃุถู ุงูููู <code>frontend/src/template.js</code> ูุญุชูู ุนูู ุงูุญุฏ ุงูุฃุฏูู ูุฅุทุงุฑ HTML ูุชุทุจูููุง ูู ุงููุณุชูุจู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js export default function template(title) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;&lt;/div&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; }</span></span></code> </pre><br>  ุฃุถู ููุทุฉ ุฏุฎูู ุงูุนููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import App from './components/app' render( &lt;App/&gt;, document.querySelector('#app') );</span></span></code> </pre><br>  ูุจูุงุก ูู ูุฐุง ุงูุฌูุงู ุ ูุญุชุงุฌ ุฅูู: <br><br>  ููุนุฏ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">webpack ููุดุฆูุง ุดุจุงุจููุง</a> ุนุตุฑููุง ูู JS (ุนูู ุงูุฑุบู ูู ุฃููู ูู ุฃูุฑุฃ ููุงูุงุช ุนูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ููุฏุฉ ุซูุงุซ ุณุงุนุงุช ุ ูุฐูู ูุณุช ูุชุฃูุฏูุง ูู ุงูููุถุฉ) ุ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุงุจู</a> ูู ูุชุฑุฌู ูุฌููุน ุฃููุงุน ุงููุณุชุญุถุฑุงุช ูุซู JSX ุ ููู ุงูููุช ููุณู ูุฒูุฏ polyfill ูุฌููุน ุญุงูุงุช IE. <br><br>  ุฅุฐุง ูุงู ุงูุชูุฑุงุฑ ุงูุณุงุจู ูููุงุฌูุฉ ุงูุฃูุงููุฉ ูุง ูุฒุงู ููุฏ ุงูุชุดุบูู ุ ูู ูุง ุนููู ูุนูู ูู <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ react \ react-dom docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save-dev \ webpack \ webpack-cli \ babel-loader \ @babel/core \ @babel/polyfill \ @babel/preset-env \ @babel/preset-react</code> </pre><br>  ูุชุซุจูุช ุชุจุนูุงุช ุฌุฏูุฏุฉ.  ุงูุขู ูู ุจุชูููู webpack: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/webpack.config.js const path = require("path"); //  . clientConfig = { mode: "development", entry: { client: ["./src/client.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, "../dist"), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; //  .     : // 1. target: "node" -      import path. // 2.   ..,    ../dist --   //    ,   ! serverConfig = { mode: "development", target: "node", entry: { server: ["./index.js", "@babel/polyfill"] }, output: { path: path.resolve(__dirname, ".."), filename: "[name].js" }, module: { rules: [ { test: /\.js$/, exclude: /node_modules/, loader: "babel-loader" } ] } }; module.exports = [clientConfig, serverConfig];</span></span></code> </pre><br>  ูุฌุนู ุจุงุจู ุงูุนูู ุ ุชุญุชุงุฌ ุฅูู ุชูููู <code>frontend/.babelrc</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"presets"</span></span>: [<span class="hljs-string"><span class="hljs-string">"@babel/env"</span></span>, <span class="hljs-string"><span class="hljs-string">"@babel/react"</span></span>] }</code> </pre><br>  ุฃุฎูุฑูุง ุ ุงุฌุนู ุงูุฃูุฑ <code>npm run build</code> ูุนูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs">// frontend/package.json ... <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: <span class="hljs-string"><span class="hljs-string">"webpack"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node /app/server.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, ...</code> </pre><br>  ุงูุขู ุนููููุง ุ ุฌูุจุง ุฅูู ุฌูุจ ูุน ูุฌููุนุฉ ูู polyfills ูุฌููุน ุงูุชุจุนูุงุช ุ ููุฑ ุนุจุฑ ุจุงุจู ุ ููุฌูุน ููุทูู ูู ููู ูุตุบูุฑ ูุชุฌุงูุณุฉ <code>../dist/client.js</code> .  ุฃุถู ุงููุฏุฑุฉ ุนูู ุชุญูููู ูููู ุซุงุจุช ุฅูู ุชุทุจูู Express ุงูุฎุงุต ุจูุง ุ ููู ุงููุณุงุฑ ุงูุงูุชุฑุงุถู ุณูุจุฏุฃ ูู ุฅุฑุฌุงุน HTML ุงูุฎุงุต ุจูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js // ,    , //  - . import express from 'express' import template from './src/template' let app = express(); app.use('/dist', express.static('../dist')); app.get("*", (req, res) =&gt; { res.send(template("Habr demo app")); }); app.listen(process.env.APP_FRONTEND_PORT);</span></span></code> </pre><br>  ุงููุฌุงุญ!  ุงูุขู ุ ุฅุฐุง <code>docker-compose up --build frontend</code> ุ <code>docker-compose up --build frontend</code> "ูุฑุญุจูุง ุฃููุง ุงูุนุงูู!"  ูู ุบูุงู ุฌุฏูุฏ ูุงูุนุฉ ุ ูุฅุฐุง ูุงู ูุฏูู ููุญู React Developer Tools ูุซุจุชูุง ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Chrome</a> ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Firefox</a> ) ุ ูููุงู ุฃูุถูุง ุดุฌุฑุฉ ูููู React ูู ุฃุฏูุงุช ุงููุทูุฑ: <br><br><img src="https://habrastorage.org/webt/q1/it/gu/q1itgukw2k0ko60pghlwwkfqfn0.png"><br><br><h2 style=";text-align:right;direction:rtl">  ุงูุฎูููุฉ: ุงูุจูุงูุงุช ูู MongoDB </h2><br>  ูุจู ุงูุงูุชูุงู ูุชููุณ ุงูุญูุงุฉ ูู ุชุทุจูููุง ุ ูุฌุจ ุฃููุงู ุฃู ุชุชููุณู ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ.  ูุจุฏู ุฃููุง ุณูููู ุจุชุฎุฒูู ุงูุจุทุงูุงุช ุงูุชู ุชู ุชุฑููุฒูุง ูู ุชุฎููุถ ุงูุณุนุฑ - ุญุงู ุงูููุช ููููุงู ุจุฐูู. <br><br>  ุจูููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุฌุฏ ORMs ูู MongoDB ูู ุงูุซุนุจุงู</a> ุ ูุฃูุง ุฃุนุชุจุฑ ุงุณุชุฎุฏุงู ORMs ููุฑูุบูุง ููู ูุฃุชุฑู โโุฏุฑุงุณุฉ ุงูุญููู ุงูููุงุณุจุฉ ูู.  ุจุฏูุงู ูู ุฐูู ุ ุณูููู ุจุฅูุดุงุก ูุตู ุจุณูุท ููุจุทุงูุฉ ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">DAO</a> ุงููุตุงุญุจ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card.py import abc from typing import Iterable class Card(object): def __init__(self, id: str = None, slug: str = None, name: str = None, markdown: str = None, html: str = None): self.id = id self.slug = slug #    self.name = name self.markdown = markdown self.html = html class CardDAO(object, metaclass=abc.ABCMeta): @abc.abstractmethod def create(self, card: Card) -&gt; Card: pass @abc.abstractmethod def update(self, card: Card) -&gt; Card: pass @abc.abstractmethod def get_all(self) -&gt; Iterable[Card]: pass @abc.abstractmethod def get_by_id(self, card_id: str) -&gt; Card: pass @abc.abstractmethod def get_by_slug(self, slug: str) -&gt; Card: pass class CardNotFound(Exception): pass</span></span></code> </pre><br>  (ุฅุฐุง ููุช ูุง ุชุฒุงู ูุง ุชุณุชุฎุฏู ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ ูู Python ุ ูุชุฃูุฏ ูู ูุฑุงุฌุนุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฐู</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุงูุงุช</a> !) <br><br>  ุงูุขู ูููู ุจุฅูุดุงุก ุชุทุจูู ููุงุฌูุฉ <code>CardDAO</code> ุงูุชู ุชุฃุฎุฐ ูุงุฆู <code>Database</code> ูู <code>pymongo</code> (ูุนู ุ ููุช ูุฅุถุงูุฉ <code>pymongo</code> ุฅูู <code>requirements.txt</code> ): <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/storage/card_impl.py from typing import Iterable import bson import bson.errors from pymongo.collection import Collection from pymongo.database import Database from backend.storage.card import Card, CardDAO, CardNotFound class MongoCardDAO(CardDAO): def __init__(self, mongo_database: Database): self.mongo_database = mongo_database # , slug   . self.collection.create_index("slug", unique=True) @property def collection(self) -&gt; Collection: return self.mongo_database["cards"] @classmethod def to_bson(cls, card: Card): # MongoDB     BSON.  #       BSON- #  ,      . result = { k: v for k, v in card.__dict__.items() if v is not None } if "id" in result: result["_id"] = bson.ObjectId(result.pop("id")) return result @classmethod def from_bson(cls, document) -&gt; Card: #   ,     #     ,     #  .    id    # ,   -   . document["id"] = str(document.pop("_id")) return Card(**document) def create(self, card: Card) -&gt; Card: card.id = str(self.collection.insert_one(self.to_bson(card)).inserted_id) return card def update(self, card: Card) -&gt; Card: card_id = bson.ObjectId(card.id) self.collection.update_one({"_id": card_id}, {"$set": self.to_bson(card)}) return card def get_all(self) -&gt; Iterable[Card]: for document in self.collection.find(): yield self.from_bson(document) def get_by_id(self, card_id: str) -&gt; Card: return self._get_by_query({"_id": bson.ObjectId(card_id)}) def get_by_slug(self, slug: str) -&gt; Card: return self._get_by_query({"slug": slug}) def _get_by_query(self, query) -&gt; Card: document = self.collection.find_one(query) if document is None: raise CardNotFound() return self.from_bson(document)</span></span></code> </pre><br>  ุงูููุช ูุชุณุฌูู ุงูุชูููู Monga ูู ุฅุนุฏุงุฏุงุช ุงูุฎูููุฉ.  ููุฏ ูููุง ุจุจุณุงุทุฉ ุจุชุณููุฉ <code>MONGO_HOST = "mongo"</code> ุจุงุณู mongo <code>mongo</code> ุ ูุฐูู <code>MONGO_HOST = "mongo"</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -0,0 +1,3 @@ +MONGO_HOST = "mongo" +MONGO_PORT = 27017 +MONGO_DATABASE = "core"</span></span></code> </pre><br>  ุงูุขู ูุญู ุจุญุงุฌุฉ ุฅูู ุฅูุดุงุก <code>MongoCardDAO</code> ูููุญ ุงูุชุทุจูู Flask ุงููุตูู ุฅููู.  ุนูู ุงูุฑุบู ูู ุฃู ูุฏููุง ุงูุขู ุชุณูุณู ูุฑูู ุจุณูุท ูููุงุฆูุงุช (ุงูุฅุนุฏุงุฏุงุช โ ุนููู pymongo โ ูุงุนุฏุฉ ุจูุงูุงุช pymongo โ <code>MongoCardDAO</code> ) ุ ููููู ุนูู ุงูููุฑ ุจุฅูุดุงุก ูููู ููู ูุฑูุฒู ูุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู ุญูู ุงูุชุจุนูุฉ</a> (ุณูุฃุชู ูููุฏูุง ูุฑุฉ ุฃุฎุฑู ุนูุฏูุง ูููุฐ ุงูุนุงูู ูุงูุฃุฏูุงุช). <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/wiring.py import os from pymongo import MongoClient from pymongo.database import Database import backend.dev_settings from backend.storage.card import CardDAO from backend.storage.card_impl import MongoCardDAO class Wiring(object): def __init__(self, env=None): if env is None: env = os.environ.get("APP_ENV", "dev") self.settings = { "dev": backend.dev_settings, # (    # ,   !) }[env] #        . #        DI,  . self.mongo_client: MongoClient = MongoClient( host=self.settings.MONGO_HOST, port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database)</span></span></code> </pre><br><br>  ุญุงู ุงูููุช ูุฅุถุงูุฉ ูุณุงุฑ ุฌุฏูุฏ ุฅูู ุชุทุจูู Flask ูุงูุงุณุชูุชุงุน ุจุงูููุธุฑ! <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/server.py import os.path import flask import flask_cors from backend.storage.card import CardNotFound from backend.wiring import Wiring env = os.environ.get("APP_ENV", "dev") print(f"Starting application in {env} mode") class HabrAppDemo(flask.Flask): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) flask_cors.CORS(self) self.wiring = Wiring(env) self.route("/api/v1/card/&lt;card_id_or_slug&gt;")(self.card) def card(self, card_id_or_slug): try: card = self.wiring.card_dao.get_by_slug(card_id_or_slug) except CardNotFound: try: card = self.wiring.card_dao.get_by_id(card_id_or_slug) except (CardNotFound, ValueError): return flask.abort(404) return flask.jsonify({ k: v for k, v in card.__dict__.items() if v is not None }) app = HabrAppDemo("habr-app-demo") app.config.from_object(f"backend.{env}_settings")</span></span></code> </pre><br>  ุฃุนุฏ ุงูุชุดุบูู ุจุงุณุชุฎุฏุงู <code>docker-compose up --build backend</code> : <br><br><img src="https://habrastorage.org/webt/ts/_a/1l/ts_a1ljldp9jztjvlupm4z6f29i.png"><br><br>  ุนูููุง ... ุฃูู ุ ุชูุงููุง.  ูุญู ุจุญุงุฌุฉ ุฅูู ุฅุถุงูุฉ ูุญุชูู!  ุณููุชุญ ูุฌูุฏ ุงูุฃุฏูุงุช ููุถูู ูุตูุง ุฅููู ูุถูู ุจุทุงูุฉ ุงุฎุชุจุงุฑ ูุงุญุฏุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card from backend.wiring import Wiring wiring = Wiring() wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """))</span></span></code> </pre><br>  <code>docker-compose exec backend python -m tools.add_test_content</code> ุจููุก <code>docker-compose exec backend python -m tools.add_test_content</code> ุจูุญุชูู ูู ุฏุงุฎู ุญุงููุฉ <code>docker-compose exec backend python -m tools.add_test_content</code> . <br><br><img src="https://habrastorage.org/webt/em/n2/la/emn2laspljezpnoc66oeccj42l4.png"><br><br>  ุงููุฌุงุญ!  ุงูุขู ูู ุงูููุช ุงูููุงุณุจ ูุฏุนู ูุฐุง ุนูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ุงููุงุฌูุฉ ุงูุฃูุงููุฉ: ูุณุชุฑุฌุน </h2><br>  ุงูุขู ูุฑูุฏ ุฃู ูุฌุนู ุงููุณุงุฑ <code>/card/:id_or_slug</code> ุ ูุงูุฐู ุณูุชู ูู ุฎูุงูู ูุชุญ ุชุทุจูู <code>/card/:id_or_slug</code> ุ ุชุญููู ุจูุงูุงุช ุงูุจุทุงูุฉ ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช <code>/card/:id_or_slug</code> ููุง ุจุทุฑููุฉ ุฃู ุจุฃุฎุฑู.  ูููุง ุ ุฑุจูุง ูุจุฏุฃ ุงูุฌุฒุก ุงูุฃูุซุฑ ุตุนูุจุฉ ุ ูุฃููุง ูุฑูุฏ ูู ุงูุฎุงุฏู ุฃู ูุนุทููุง HTML ุนูู ุงูููุฑ ุจูุญุชููุงุช ุงูุจุทุงูุฉ ุ ููู ููุงุณุจ ููููุฑุณุฉ ุ ูููู ูู ุงูููุช ููุณู ุ ุนูุฏูุง ูุชููู ุงูุชุทุจูู ุจูู ุงูุจุทุงูุงุช ุ ูุชููู ุฌููุน ุงูุจูุงูุงุช ูู ุดูู JSON ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุ ููุง ูุชู ุชุญููู ุงูุตูุญุฉ ุจุดูู ุฒุงุฆุฏ.  ูููุฐุง ูู ูุฐุง - ุฏูู ูุณุฎ ููุตู! <br><br>  ููุจุฏุฃ ุจุฅุถุงูุฉ Redux.  Redux ูู ููุชุจุฉ JavaScript ูุชุฎุฒูู ุงูุญุงูุฉ.  ุชููู ุงูููุฑุฉ ูู ุฃูู ุจุฏูุงู ูู ุงูุขูุงู ูู ุงูุญุงูุงุช ุงูุถูููุฉ ุงูุชู ุชุชุบูุฑ ููููุงุชู ุฃุซูุงุก ุชุตุฑูุงุช ุงููุณุชุฎุฏู ูุงูุฃุญุฏุงุซ ุงูุฃุฎุฑู ุงููุซูุฑุฉ ููุงูุชูุงู ุ ูุฅู ูุฏููู ุญุงูุฉ ูุฑูุฒูุฉ ูุงุญุฏุฉ ุ ููููููู ุจุฅุฌุฑุงุก ุฃู ุชุบููุฑ ูู ุฎูุงู ุขููุฉ ูุฑูุฒูุฉ ููุฅุฌุฑุงุกุงุช.  ูุฐูู ุ ุฅุฐุง ูููุง ูู ููุช ุณุงุจู ูู ุฃุฌู ุงูุชุตูุญ ุจุชุดุบูู ุชุทุจูู GIF ุฃููุงู ุ ููุฏููุง โโุทูุจูุง ูู ุฎูุงู AJAX ุ ูุฃุฎูุฑุงู ูู ุฑุฏ ุงูุงุชุตุงู ุงููุงุฌุญ ุ ูููุง ุจุชุญุฏูุซ ุงูุฃุฌุฒุงุก ุงูุถุฑูุฑูุฉ ูู ุงูุตูุญุฉ ุ ุซู ูู ูููุฐุฌ Redux ุ ูุญู ูุฏุนููู ูุฅุฑุณุงู ุงูุฅุฌุฑุงุก "ุชุบููุฑ ุงููุญุชูู ุฅูู gif ูุน ุงูุฑุณูู ุงููุชุญุฑูุฉ" ุ ูุงูุฐู ุณูุคุฏู ุฅูู ุชุบููุฑ ุงูุญุงูุฉ ุงูุนุงูุฉ ุจุญูุซ ูุทุฑุฏ ุฃุญุฏ ููููุงุชู ุงููุญุชูู ุงูุณุงุจู ููุถุน ุงูุฑุณูู ุงููุชุญุฑูุฉ ุ ุซู ููุฏู ุทูุจูุง ุ ููุฑุณู ุฅุฌุฑุงุกู ุขุฎุฑ ูู ุฑุฏ ุงูุงุชุตุงู ุงููุงุฌุญ ุ "ูู ุจุชุบููุฑ ุงููุญุชูู ููุชู ุชุญูููู".  ุจุดูู ุนุงู ุ ุงูุขู ุณูู ูุฑู ุฐูู ุจุฃููุณูุง. <br><br>  ููุจุฏุฃ ุจุชุซุจูุช ุชุจุนูุงุช ุฌุฏูุฏุฉ ูู ุญุงููุงุชูุง. <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> frontend npm install --save \ redux \ react-redux \ redux-thunk \ redux-devtools-extension</code> </pre><br>  ุงูุฃูู ูู ุ ูู ุงููุงูุน ุ Redux ุ ูุงูุซุงูู ูู ููุชุจุฉ ุฎุงุตุฉ ูุนุจูุฑ React ู Redux (ูุชุจูุง ุฎุจุฑุงุก ุงูุชุฒุงูุฌ) ุ ูุงูุซุงูุซ ูู ุดูุก ุถุฑูุฑู ููุบุงูุฉ ุ ูุงูุญุงุฌุฉ ุงูุชู ุชู ุฅุซุจุงุชูุง ุจุดูู ุฌูุฏ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">README ููุง</a> ุ ูุฃุฎูุฑุง ุ ุงูุฑุงุจุนุฉ ูู ุงูููุชุจุฉ ุงููุงุฒูุฉ ู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Redux DevTools</a> ููุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชูุฏูุฏ</a> . <br><br>  ุฏุนูุง ูุจุฏุฃ ุจุฑูุฒ redux ุงููุชุฏุงูู: ุฅูุดุงุก ุงููุฎูุถ ุงูุฐู ูุง ููุนู ุดูุฆูุง ุ ูุชููุฆุฉ ุงูุญุงูุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { return state; }</span></span></code> </pre><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/configureStore.js import {createStore, applyMiddleware} from "redux"; import thunkMiddleware from "redux-thunk"; import {composeWithDevTools} from "redux-devtools-extension"; import rootReducer from "./reducers"; export default function configureStore(initialState) { return createStore( rootReducer, initialState, composeWithDevTools(applyMiddleware(thunkMiddleware)), ); }</span></span></code> </pre><br>  ูุชุบูุฑ ุนููููุง ููููุงู ุ ููุณุชุนุฏ ุนูููุงู ููุนูู ูุน Redux: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' //      ... const store = configureStore(); render( // ...      , //     &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br>  ุงูุขู ูููููุง ุชุดุบูู ุนุงูู ุงูุฅุฑุณุงุก - ุฅูุดุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ููุชุฃูุฏ ูู ุนุฏู ูุณุฑ ุฃู ุดูุก ุ ูุธูุฑุช ุญุงูุชูุง ุงูุจุฏุงุฆูุฉ ูู Redux DevTools: <br><br><img src="https://habrastorage.org/webt/x0/hr/_e/x0hr_empfso4poji4s8egshlcye.png"><br><br><h2 style=";text-align:right;direction:rtl">  ุงููุงุฌูุฉ ุงูุฃูุงููุฉ: ุตูุญุฉ ุงูุจุทุงูุฉ </h2><br>  ูุจู ุฃู ุชุชููู ูู ุฅูุดุงุก ุตูุญุงุช ุจุงุณุชุฎุฏุงู SSR ุ ุชุญุชุงุฌ ุฅูู ุฅูุดุงุก ุตูุญุงุช ุจุฏูู SSR!  ุฏุนูุง ูุณุชุฎุฏู ุฃุฎูุฑูุง ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ุงูุฎุงุตุฉ ุจูุง ูููุตูู ุฅูู ุงูุจุทุงูุงุช ูุชุดููู ุตูุญุฉ ุงูุจุทุงูุฉ ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ. <br><br>  ุงูููุช ููุงุณุชูุงุฏุฉ ูู ุงูุฐูุงุก ูุฅุนุงุฏุฉ ุชุตููู ูููู ุฏููุชูุง.  ููุงู <a href="">ุงููุซูุฑ ูู</a> ุงูููุงุฏ ุญูู ูุฐุง ุงูููุถูุน ุ ูุฐูู ุฃูุชุฑุญ ุนุฏู ุฅุณุงุกุฉ ุงุณุชุฎุฏุงู ุงูุงุณุชุฎุจุงุฑุงุช ูุณูู ุฃุฑูุฒ ุนูู ุงูููุถูุน ุงูุจุณูุท.  ุนูู ุณุจูู ุงููุซุงู ุ ูุซู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"card"</span></span>, //     //       type=card: <span class="hljs-string"><span class="hljs-string">"cardSlug"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, //     <span class="hljs-attr"><span class="hljs-attr">"isFetching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, //      API <span class="hljs-attr"><span class="hljs-attr">"cardData"</span></span>: {...}, //   (  ) // ... }, // ... }</code> </pre><br>  ุฏุนูุง ูุญุตู ุนูู ูููู "ุงูุจุทุงูุฉ" ุ ุงูุฐู ูุฃุฎุฐ ูุญุชููุงุช cardData ูุฏุนุงุฆู (ุฅููุง ูู ุงููุงูุน ูุญุชููุงุช ุจุทุงูุชูุง ูู mongo): <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js import React, {Component} from 'react'; class Card extends Component { componentDidMount() { document.title = this.props.name } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;!---,  HTML  React  - !--&gt; &lt;div dangerouslySetInnerHTML={{__html: html}}/&gt; &lt;/div&gt; ); } } export default Card;</span></span></code> </pre><br>  ุงูุขู ููุญุตู ุนูู ูููู ููุตูุญุฉ ุจุฃููููุง ูุน ุงูุจุทุงูุฉ.  ุณูููู ูุณุคููุงู ุนู ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงููุงุฒูุฉ ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ูููููุง ุฅูู ุงูุจุทุงูุฉ.  ูุณููุนู ุฌูุจ ุงูุจูุงูุงุช ุจุทุฑููุฉ React-Redux. <br><br>  ุฃููุงู ุ ุฃูุดุฆ ููู <code>frontend/src/redux/actions.js</code> ููู ุจุฅูุดุงุก ุฅุฌุฑุงุก ูุณุชุฎุฑุฌ ูุญุชููุงุช ุงูุจุทุงูุฉ ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุ ุฅู ูู ููู ุจุงููุนู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCardIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = getState().page; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.cardData === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || state.cardData.slug !== state.cardSlug) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dispatch(fetchCard()); } }; }</code> </pre><br>  ุฅุฌุฑุงุก <code>fetchCard</code> ุ ุงูุฐู ูุฌุนู ุนูููุฉ ุฌูุจ ุงููุนูููุงุช ูู ุงููุงูุน ุฃูุซุฑ ุชุนููุฏูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchCard</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dispatch, getState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    ,    . //     , , //    . dispatch(startFetchingCard()); //    API. let url = apiPath() + "/card/" + getState().page.cardSlug; // , ,   ,  //    . , ,  //    . return fetch(url) .then(response =&gt; response.json()) .then(json =&gt; dispatch(finishFetchingCard(json))); }; // ,  redux-thunk   //     . } function startFetchingCard() { return { type: START_FETCHING_CARD }; } function finishFetchingCard(json) { return { type: FINISH_FETCHING_CARD, cardData: json }; } function apiPath() { //    .    server-side // rendering,   API     -  //         localhost, //   backend. return "http://localhost:40001/api/v1"; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃูู ุ ููุฏ ุญุตููุง ุนูู ุดูุก ููุนูู! </font><font style="vertical-align: inherit;">ูุฌุจ ุฏุนู ูุฐุง ูู ุงููุฎูุถ:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD } from "./actions"; export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } } } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ุงูุชุจู ุฅูู ุจูุงุก ุงูุฌููุฉ ุงูุนุตุฑู ูุงุณุชูุณุงุฎ ูุงุฆู ูุน ุชุบููุฑ ุงูุญููู ุงููุฑุฏูุฉ.) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ูุจุนุฏ ุชูููุฐ ูู ุงูููุทู ูู ุฅุฌุฑุงุกุงุช Redux ุ </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูุจุฏู </font><font style="vertical-align: inherit;">ุงููููู ููุณู </font><font style="vertical-align: inherit;">ุจุณูุทูุง ูุณุจููุง:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/cardPage.js import React, {Component} from 'react'; import {connect} from 'react-redux' import {fetchCardIfNeeded} from '../redux/actions' import Card from './card' class CardPage extends Component { componentWillMount() { //   ,  React  //   .      //   ,    " // "   ,    //  - .    -   //       HTML  // renderToString,      SSR. this.props.dispatch(fetchCardIfNeeded()) } render() { const {isFetching, cardData} = this.props; return ( &lt;div&gt; {isFetching &amp;&amp; &lt;h2&gt;Loading...&lt;/h2&gt;} {cardData &amp;&amp; &lt;Card {...cardData}/&gt;} &lt;/div&gt; ); } } //       ,   //  .        //  react-redux.   page    //  dispatch,   . function mapStateToProps(state) { const {page} = state; return page; } export default connect(mapStateToProps)(CardPage);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฃุถู ูุนุงูุฌุฉ page.type ุจุณูุทุฉ ุฅูู ูููู ุงูุชุทุจูู ุงูุฌุฐุฑ: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js import React, {Component} from 'react' import {connect} from "react-redux"; import CardPage from "./cardPage" class App extends Component { render() { const {pageType} = this.props; return ( &lt;div&gt; {pageType === "card" &amp;&amp; &lt;CardPage/&gt;} &lt;/div&gt; ); } } function mapStateToProps(state) { const {page} = state; const {type} = page; return { pageType: type }; } export default connect(mapStateToProps)(App);</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุงูุขูุ ูุงุญุฏ ุงูููุทุฉ ุงูุฃุฎูุฑุฉ - ูุง ุจุฏ ูู ุชููุฆุฉ </font></font><code>page.type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ู </font></font><code>page.cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุจุนุง ูURL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ูุง ูุฒุงู ููุงู ุงูุนุฏูุฏ ูู ุงูุฃูุณุงู ูู ูุฐู ุงูููุงูุฉ ุ ููู ูุง ูููููุง ุฃู ูุฌุนู ุญูุงู ุนุงูู ุงูุฌูุฏุฉ ูู ุงูููุช ุงูุญุงูู. </font><font style="vertical-align: inherit;">ุฏุนููุง ููุนู ุฐูู ุบุจู ุงูุขู. </font><font style="vertical-align: inherit;">ูุฐุง ูุฌุฑุฏ ุบุจุงุก ุชูุงููุง. </font><font style="vertical-align: inherit;">ุนูู ุณุจูู ุงููุซุงู ุ ููุชุธู ุนูุฏ ุชููุฆุฉ ุงูุชุทุจูู!</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' let initialState = { page: { type: "home" } }; const m = /^\/card\/([^\/]+)$/.exec(location.pathname); if (m !== null) { initialState = { page: { type: "card", cardSlug: m[1] }, } } const store = configureStore(initialState); render( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ูููููุง ุฅุนุงุฏุฉ ุจูุงุก ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูููุณุงุนุฏุฉ </font></font><code>docker-compose up --build frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุงูุงุณุชูุชุงุน ุจุจุทุงูุชูุง </font></font><code>helloworld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... </font></font><br><br><img src="https://habrastorage.org/webt/vj/qi/iu/vjqiiu9iu3c0ieigltqbu35smfw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุฐุง ุ ุงูุชุธุฑ ุซุงููุฉ ... ูุฃูู ุงููุญุชูู ุงูุฎุงุต ุจูุงุ </font><font style="vertical-align: inherit;">ุฃูู ุ ููุฏ ูุณููุง ุชุญููู Markdown!</font></font><br><br><h2 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุนุงูู: RQ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุนุฏ ุชุญููู ุชุฎููุถ ุงูุณุนุฑ ูุฅูุดุงุก HTML ูุจุทุงูุฉ ุฐุงุช ุญุฌู ุบูุฑ ูุญุฏูุฏ ูููุฉ "ุซูููุฉ" ูููุฐุฌูุฉ ุ ูุงูุชู ุจุฏูุงู ูู ุญููุง ูุจุงุดุฑุฉ ุนูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ูุน ุญูุธ ุงูุชุบููุฑุงุช ุ ูุชู ูุถุนูุง ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูุชูููุฐูุง ุนูู ุฃุฌูุฒุฉ ุนูู ูููุตูุฉ. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงู ุงูุนุฏูุฏ ูู ุงูุชุทุจููุงุช ููุชูุญุฉ ุงููุตุฏุฑ ูููุงุฆู ุงูููุงู ุ </font><font style="vertical-align: inherit;">ุณูุฃุฎุฐ Redis ูููุชุจุฉ ุจุณูุทุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ูุงุฆูุฉ ุงูุชุธุงุฑ Redis) ุ ูุงูุชู ุชููู ูุนููุงุช ุงููููุฉ ูู ุชูุณูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุฎูู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุชูุธู ุนูููุงุช ุงูุชูุฑูุฎ ุงูุฎุงุตุฉ ุจูุง ููุนุงูุฌุชูุง. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูููุช ูุฅุถุงูุฉ ุงููุฌู ุงุนุชูุงุฏุง ุนูู ุงูุฅุนุฏุงุฏุงุช ูุงูุฃุณูุงู!</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/requirements.txt +++ b/requirements.txt @@ -3,3 +3,5 @@ flask-cors gevent gunicorn pymongo +redis +rq --- a/backend/dev_settings.py +++ b/backend/dev_settings.py @@ -1,3 +1,7 @@ MONGO_HOST = "mongo" MONGO_PORT = 27017 MONGO_DATABASE = "core" +REDIS_HOST = "redis" +REDIS_PORT = 6379 +REDIS_DB = 0 +TASK_QUEUE_NAME = "tasks" --- a/backend/wiring.py +++ b/backend/wiring.py @@ -2,6 +2,8 @@ import os from pymongo import MongoClient from pymongo.database import Database +import redis +import rq import backend.dev_settings from backend.storage.card import CardDAO @@ -21,3 +23,11 @@ class Wiring(object): port=self.settings.MONGO_PORT) self.mongo_database: Database = self.mongo_client[self.settings.MONGO_DATABASE] self.card_dao: CardDAO = MongoCardDAO(self.mongo_database) + + self.redis: redis.Redis = redis.StrictRedis( + host=self.settings.REDIS_HOST, + port=self.settings.REDIS_PORT, + db=self.settings.REDIS_DB) + self.task_queue: rq.Queue = rq.Queue( + name=self.settings.TASK_QUEUE_NAME, + connection=self.redis)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูููุงู ุงููููู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ููุนุงูู. </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># worker/__main__.py import argparse import uuid import rq import backend.wiring parser = argparse.ArgumentParser(description="Run worker.") #   ,      #  .  ,       rq. parser.add_argument( "--burst", action="store_const", const=True, default=False, help="enable burst mode") args = parser.parse_args() #       Redis. wiring = backend.wiring.Wiring() with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], #         # ,    . name=uuid.uuid4().hex) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุชุญููู ููุณู ุ ูู ุจุชูุตูู ููุชุจุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุฎุงุทุฆุฉ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุชุงุจุฉ ูุธููุฉ ุจุณูุทุฉ:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/parse.py import mistune from backend.storage.card import CardDAO def parse_card_markup(card_dao: CardDAO, card_id: str): card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=True, hard_wrap=False)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุทููุง: ูุญุชุงุฌ </font></font><code>CardDAO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅูู ุงูุญุตูู ุนูู ุงูููุฏ ุงููุตุฏุฑู ููุจุทุงูุฉ ูุญูุธ ุงููุชูุฌุฉ. </font><font style="vertical-align: inherit;">ูููู ูุง ูููู ุฅุฌุฑุงุก ุชุณูุณู ูููุงุฆู ุงูุฐู ูุญุชูู ุนูู ุงูุงุชุตุงู ุจูุญุฏุฉ ุงูุชุฎุฒูู ุงูุฎุงุฑุฌูุฉ ุนุจุฑ ุงููุฎูู - ููุง ูุนูู ุฃูู ูุง ูููู ุฃุฎุฐ ูุฐู ุงููููุฉ ุนูู ุงูููุฑ ูู ูุงุฆูุฉ ุงูุชุธุงุฑ RQ. </font><font style="vertical-align: inherit;">ุจุทุฑููุฉ ุฌูุฏุฉ ุ ูุญุชุงุฌ ุฅูู ุฅูุดุงุก </font></font><code>Wiring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุนุงูู ุนูู ุงูุฌุงูุจ ูุฑูููุง ุจุฌููุน ุฃููุงุนูุง ... ุฏุนููุง ููุนู ุฐูู:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/worker/__main__.py +++ b/worker/__main__.py @@ -2,6 +2,7 @@ import argparse import uuid import rq +from rq.job import Job import backend.wiring @@ -16,8 +17,23 @@ args = parser.parse_args() wiring = backend.wiring.Wiring() + +class JobWithWiring(Job): + + @property + def kwargs(self): + result = dict(super().kwargs) + result["wiring"] = backend.wiring.Wiring() + return result + + @kwargs.setter + def kwargs(self, value): + super().kwargs = value + + with rq.Connection(wiring.redis): w = rq.Worker( queues=[wiring.settings.TASK_QUEUE_NAME], - name=uuid.uuid4().hex) + name=uuid.uuid4().hex, + job_class=JobWithWiring) w.work(burst=args.burst)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃุนููุง ูุฆุฉ ุงููุธุงุฆู ูุฏููุง ุ ูุฑูู ุงูุฃุณูุงู ูุญุฌุฉ kwargs ุฅุถุงููุฉ ูู ุฌููุน ุงููุดุงูู. </font><font style="vertical-align: inherit;">(ูุงุญุธ ุฃูู ููุดุฆ ุฃุณูุงููุง ุฌุฏูุฏุฉ ูู ูู ูุฑุฉ ุ ูุฃูู ูุง ูููู ุฅูุดุงุก ุจุนุถ ุงูุนููุงุก ูุจู ุฃู ูุญุฏุซ ุงูุดููุฉ ุฏุงุฎู RQ ูุจู ุฃู ุชุจุฏุฃ ุงููููุฉ ูู ุงููุนุงูุฌุฉ.) ุญุชู ูุง ุชุนุชูุฏ ุฌููุน ููุงููุง ุนูู ุงูุฃุณูุงู - ุฃู ุนูู ูู ุงููุงุฆูุงุช - ุฏุนูุง ููุตูุน ุฏูููุฑูุง ูู ูุญุตู ุฅูุง ุนูู ุงูุฃุณูุงู ุงูุถุฑูุฑูุฉ:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># backend/tasks/task.py import functools from typing import Callable from backend.wiring import Wiring def task(func: Callable): #    : varnames = func.__code__.co_varnames @functools.wraps(func) def result(*args, **kwargs): #  .  .pop(),     # ,        . wiring: Wiring = kwargs.pop("wiring") wired_objects_by_name = wiring.__dict__ for arg_name in varnames: if arg_name in wired_objects_by_name: kwargs[arg_name] = wired_objects_by_name[arg_name] #          #   ,  -   . return func(*args, **kwargs) return result</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฃุถู ุฏูููุฑูุง ุฅูู ูููุชูุง ูุงุณุชูุชุน ุจุงูุญูุงุฉ: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mistune <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.storage.card <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CardDAO <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> backend.tasks.task <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> task @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_card_markup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(card_dao: CardDAO, card_id: str)</span></span></span><span class="hljs-function">:</span></span> card = card_dao.get_by_id(card_id) card.html = _parse_markdown(card.markdown) card_dao.update(card) _parse_markdown = mistune.Markdown(escape=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, hard_wrap=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุณุชูุชุน ุจุงูุญูุงุฉุ </font><font style="vertical-align: inherit;">ุขู ุ ุฃุฑุฏุช ุฃู ุฃููู ุ ูุจุฏุฃ ุงูุนุงูู:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ docker-compose up worker ... Creating habr-app-demo_worker_1 ... done Attaching to habr-app-demo_worker_1 worker_1 | 17:21:03 RQ worker 'rq:worker:49a25686acc34cdfa322feb88a780f00' started, version 0.13.0 worker_1 | 17:21:03 *** Listening on tasks... worker_1 | 17:21:03 Cleaning registries for queue: tasks</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุซุงูุซุง ... ูุง ููุนู ุดูุฆุง! </font><font style="vertical-align: inherit;">ุจุงูุทุจุน ุ ูุฃููุง ูู ูุญุฏุฏ ูููุฉ ูุงุญุฏุฉ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฏุนูุง ูุนูุฏ ูุชุงุจุฉ ุฃุฏุงุชูุง ุ ุงูุชู ุชูุดุฆ ุจุทุงูุฉ ุงุฎุชุจุงุฑ ุ ุจุญูุซ: (ุฃ) ูุง ุชุณูุท ุฅุฐุง ุชู ุฅูุดุงุก ุงูุจุทุงูุฉ ุจุงููุนู (ููุง ูู ุญุงูุชูุง) ุ </font><font style="vertical-align: inherit;">ุจ) ูุถุน ูููุฉ ุนูู ุชุญููู marqdown.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py from backend.storage.card import Card, CardNotFound from backend.tasks.parse import parse_card_markup from backend.wiring import Wiring wiring = Wiring() try: card = wiring.card_dao.get_by_slug("helloworld") except CardNotFound: card = wiring.card_dao.create(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. """)) # ,   card_dao.get_or_create,  #      ! wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id})</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ุงูุขู ุชุดุบูู ุงูุฃุฏูุงุช ููุณ ููุท ุนูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ุ ูููู ุฃูุถูุง ุนูู ุงูุนุงูู. </font><font style="vertical-align: inherit;">ูู ุญูุซ ุงููุจุฏุฃ ุ ุงูุขู ูุญู ูุง ููุชู. </font><font style="vertical-align: inherit;">ูุทูููุง </font></font><code>docker-compose exec worker python -m tools.add_test_content</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููู ุนูุงูุฉ ุชุจููุจ ูุฌุงูุฑุฉ ูููุญุทุฉ ูุฑู ูุนุฌุฒุฉ - ูุงู ุงูุนุงูู ุจุดูุก ูุง!</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">worker_1 | 17:34:26 tasks: backend.tasks.parse.parse_card_markup(card_id='5c715dd1e201ce000c6a89fa') (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 tasks: Job OK (613b53b1-726b-47a4-9c7b-97cad26da1a5) worker_1 | 17:34:27 Result is kept for 500 seconds</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุจุนุฏ ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุญุงููุฉ ุจุงุณุชุฎุฏุงู ุงููุงุฌูุฉ ุงูุฎูููุฉ ุ ูููููุง ูู ุงูููุงูุฉ ุฑุคูุฉ ูุญุชููุงุช ุจุทุงูุชูุง ูู ุงููุชุตูุญ: </font></font><br><br><img src="https://habrastorage.org/webt/ii/5f/zb/ii5fzb_nh2p4-hbv7obhjmxr5kk.png"><br><br><h2 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ููููุงุญุฉ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุจู ุฃู ููุชูู ุฅูู SSR ุ ูุญุชุงุฌ ุฅูู ุฌุนู ูู ูุง ูุฏููุง ูู ุถุฌุฉ ูุน React ุฐุง ูุนูู ุฅูู ุญุฏ ูุง ุนูู ุงูุฃูู ูุฌุนู ุชุทุจูู ุตูุญุฉ ูุงุญุฏุฉ ุตูุญุฉ ูุงุญุฏุฉ ุญููุง. </font><font style="vertical-align: inherit;">ุฏุนูุง ูููู ุจุชุญุฏูุซ ุฃุฏุงุชูุง ูุฅูุดุงุก ุจุทุงูุชูู (ููุณ ุฃุญุฏููุง ุ ูุงุซูุงู! ุฃู ุ ูุฃูุง ุงูุขู ุฃุถุทุฑ ุฅูู DATE DELELOPER!) ุจุทุงูุงุช ุชุฑุชุจุท ุจุจุนุถูุง ุงูุจุนุถ ุ ุซู ุณูุชุนุงูู ูุน ุงูุชููู ุจููููุง.</font></font><br><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุต ุงููุฎูู</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># tools/add_test_content.py def create_or_update(card): try: card.id = wiring.card_dao.get_by_slug(card.slug).id card = wiring.card_dao.update(card) except CardNotFound: card = wiring.card_dao.create(card) wiring.task_queue.enqueue_call( parse_card_markup, kwargs={"card_id": card.id}) create_or_update(Card( slug="helloworld", name="Hello, world!", markdown=""" This is a hello-world page. It can't really compete with the [demo page](demo). """)) create_or_update(Card( slug="demo", name="Demo Card!", markdown=""" Hi there, habrovchanin. You've probably got here from the awkward ["Hello, world" card](helloworld). Well, **good news**! Finally you are looking at a **really cool card**! """ ))</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ูููููุง ุงุชุจุงุน ุงูุฑูุงุจุท ูุงูุชูููุฑ ูู ูู ูุฑุฉ ูุชู ูููุง ุฅุนุงุฏุฉ ุชุดุบูู ุชุทุจูููุง ุงูุฑุงุฆุน. </font><font style="vertical-align: inherit;">ุชููู ุนู ุฐูู! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃููุงู ุ ุถุน ุงููุนุงูุฌ ุนูู ููุฑุงุช ุนูู ุงูุฑูุงุจุท. </font><font style="vertical-align: inherit;">ูุธุฑูุง ูุฃู HTML ูุน ุงูุฑูุงุจุท ูุฃุชู ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ุ ูุงูุชุทุจูู ูู ูุน React ุ ูุฅููุง ูุญุชุงุฌ ุฅูู ุงููููู ูู ุงูุชุฑููุฒ ุนูู React.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/card.js class Card extends Component { componentDidMount() { document.title = this.props.name } navigate(event) { //       .  //      ,    . if (event.target.tagName === 'A' &amp;&amp; event.target.hostname === window.location.hostname) { //     event.preventDefault(); //      this.props.dispatch(navigate(event.target)); } } render() { const {name, html} = this.props; return ( &lt;div&gt; &lt;h1&gt;{name}&lt;/h1&gt; &lt;div dangerouslySetInnerHTML={{__html: html}} onClick={event =&gt; this.navigate(event)} /&gt; &lt;/div&gt; ); } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุธุฑูุง ูุฃู ูู ุงูููุทู ูุน ุชุญููู ุงูุจุทุงูุงุช ูู ูููููุง </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุ ูู ุงูุฅุฌุฑุงุก ููุณู (ูุฐูู!) ุ ูุง ููุฒู ุงุชุฎุงุฐ ุฃู ุฅุฌุฑุงุก:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฅุถุงูุฉ ุงููุฎูุถ ุณุฎููุฉ ููุฐู ุงูุญุงูุฉ: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js import { START_FETCHING_CARD, FINISH_FETCHING_CARD, NAVIGATE } from "./actions"; function navigate(state, path) { //     react-router,    ! // (       SSR.) let m = /^\/card\/([^/]+)$/.exec(path); if (m !== null) { return { ...state, page: { type: "card", cardSlug: m[1], isFetching: true } }; } return state } export default function root(state = {}, action) { switch (action.type) { case START_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: true } }; case FINISH_FETCHING_CARD: return { ...state, page: { ...state.page, isFetching: false, cardData: action.cardData } }; case NAVIGATE: return navigate(state, action.path) } return state; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฐ ุงูุขู ูููู ุฃู ุชุชุบูุฑ ุญุงูุฉ ุชุทุจูููุง ุ </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ุทุฑููุฉ </font></font><code>componentDidUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงุซูุฉ ูุชูู ุงูุชู ุฃุถููุงูุง ุจุงููุนู </font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ุงูุขู ุ ุจุนุฏ ุชุญุฏูุซ ุงูุฎุตุงุฆุต </font></font><code>CardPage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ุนูู ุณุจูู ุงููุซุงู ุ ุงูุฎุตุงุฆุต </font></font><code>cardSlug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃุซูุงุก ุงูุชููู) ุ ุณูุชู ุฃูุถูุง ุทูุจ ูุญุชูู ุงูุจุทุงูุฉ ูู ุงููุงุฌูุฉ ุงูุฎูููุฉ ( </font></font><code>componentWillMount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ูุญุฏุซ ุฐูู ุฅูุง ุนูุฏ ุชููุฆุฉ ุงููููู). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญุณูุง ุ </font></font><code>docker-compose up --build frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฏููุง ุงูููุงุญุฉ ุงูุนูู! </font></font><br><br><img src="https://habrastorage.org/webt/4l/ov/b_/4lovb_vai0fxv0tjx6zfcmwb8y8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูู ููุงุญุธ ุงููุงุฑุฆ ุงูููุธ ุฃู ุนููุงู URL ููุตูุญุฉ ูู ูุชุบูุฑ ุนูุฏ ุงูุชููู ุจูู ุงูุจุทุงูุงุช - ุญุชู ูู ููุทุฉ ุงูุดุงุดุฉ ุงูุชู ูุฑุงูุง Hello ุ ุงูุจุทุงูุฉ ุงูุนุงูููุฉ ุนูู ุนููุงู ุงูุจุทุงูุฉ ุงูุชุฌุฑูุจูุฉ. </font><font style="vertical-align: inherit;">ุชุจุนุง ูุฐูู ุ ุงูุฎูุถ ุฃูุถุง ุฅูู ุงูุฃูุงู ุฅูู ุงููุฑุงุก ุงูููุงุญุฉ. </font><font style="vertical-align: inherit;">ุฏุนููุง ูุถูู ุจุนุถ ุงูุณุญุฑ ุงูุฃุณูุฏ ูุน ุงูุชุงุฑูุฎ ุนูู ุงูููุฑ ูุฅุตูุงุญู! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃุจุณุท ุดูุก ููููู ุงูููุงู ุจู ูู ุฅุถุงูุฉ ุฅูู ุงูุนูู.</font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุญุฏูุง </font></font><code>history.pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">navigate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">link</span></span></span><span class="hljs-function">) </span></span>{ history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, link.href); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: NAVIGATE, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: link.pathname } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ุ ุนูุฏ ุงูููุฑ ููู ุงูุงุฑุชุจุงุทุงุช ุ ุณูุชุบูุฑ ุนููุงู URL ูู ุดุฑูุท ุนููุงู ุงููุชุตูุญ. </font><font style="vertical-align: inherit;">ููุน ุฐูู ุ ูุฅู ุฒุฑ ุงูุธูุฑ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุณุฑ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุฌุนูู ูุนูู ุ ูุญู ุจุญุงุฌุฉ ุฅูู ุงูุงุณุชูุงุน ุฅูู ุงูุญุฏุซ </font></font><code>popstate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุงุฆู </font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ุนูุงูุฉ ุนูู ุฐูู ุ ุฅุฐุง ููุง ูุฑูุฏ ูู ูุฐุง ุงูุญุฏุซ ุงูููุงู ุจุงูุชููู ููุฎูู ููุฐูู ููุฃูุงู (ุฃู ุ ุฎูุงู </font></font><code>dispatch(navigate(...))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ุ ูุนูููุง </font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุถุงูุฉ ุฅุดุงุฑุฉ "ุนุฏู </font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" ุฎุงุตุฉ </font><font style="vertical-align: inherit;">ุฅูู ุงููุธููุฉ </font><font style="vertical-align: inherit;">(ูุฅูุง ูุณูุชู ูุณุฑ ูู ุดูุก ุฃูุซุฑ!). </font><font style="vertical-align: inherit;">ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ููุชูููุฒ ุจูู ุญุงูุงุช "ุฏูููุง" ุ ูุฌุจ ุฃู ูุณุชุฎุฏู ุงููุฏุฑุฉ </font></font><code>pushState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุนูู ุญูุธ ุงูุจูุงูุงุช ุงููุตููุฉ. </font><font style="vertical-align: inherit;">ููุงู ุงููุซูุฑ ูู ุงูุณุญุฑ ูุงูุชุตุญูุญ ุ ูุฐูู ุฏุนููุง ูุตู ุฅูู ุงูุดูุฑุฉ! </font><font style="vertical-align: inherit;">ุฅููู ูุง ุณูุจุฏู ุนููู ุงูุชุทุจูู:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/components/app.js class App extends Component { componentDidMount() { //     --   //      "". history.replaceState({ pathname: location.pathname, href: location.href }, ""); //     . window.addEventListener("popstate", event =&gt; this.navigate(event)); } navigate(event) { //    "" ,   //        ,    //   (or is it a good thing?..) if (event.state &amp;&amp; event.state.pathname) { event.preventDefault(); event.stopPropagation(); //      "  pushState". this.props.dispatch(navigate(event.state, true)); } } render() { // ... } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุฅููู ุงูุฅุฌุฑุงุก ุงูุชููู: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js export function navigate(link, dontPushState) { if (!dontPushState) { history.pushState({ pathname: link.pathname, href: link.href }, "", link.href); } return { type: NAVIGATE, path: link.pathname } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ุณุชูุฌุญ ุงููุตุฉ. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญุณููุง ุ ุงูููุณุฉ ุงูุฃุฎูุฑุฉ: ูุธุฑูุง ูุฃู ูุฏููุง ุงูุขู ุฅุฌุฑุงุก </font></font><code>navigate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุ ูููุงุฐุง ูุง ูุชุฎูู ุนู ุงูููุฏ ุงูุฅุถุงูู ูู ุงูุนููู ุงูุฐู ูุญุณุจ ุงูุญุงูุฉ ุงูุฃูููุฉุ </font><font style="vertical-align: inherit;">ูููููุง ููุท ุงูุงุชุตุงู ุงูุชูู ุฅูู ุงููููุน ุงูุญุงูู:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/frontend/src/client.js +++ b/frontend/src/client.js @@ -3,23 +3,16 @@ import {render} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' +import {navigate} from "./redux/actions"; let initialState = { page: { type: "home" } }; -const m = /^\/card\/([^\/]+)$/.exec(location.pathname); -if (m !== null) { - initialState = { - page: { - type: "card", - cardSlug: m[1] - }, - } -} const store = configureStore(initialState); +store.dispatch(navigate(location));</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุณุฎ ูุตู ุฏูุฑุช! </font></font><br><br><h2 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงููุงุฌูุฉ ุงูุฃูุงููุฉ: ุงูุชูุฏูู ูู ุฌุงูุจ ุงูุฎุงุฏู </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญุงู ุงูููุช ูุฏููุง ุฑูุงุฆู (ูู ุฑุฃูู) ุงูุฑุฆูุณูุฉ - ุณูููุฉ ูุจุงุฑ ุงููุณุฆูููู ุงูุงูุชุตุงุฏููู. ุญุชู ุชุชููู ูุญุฑูุงุช ุงูุจุญุซ ูู ููุฑุณุฉ ุงููุญุชูู ุงูุฎุงุต ุจูุง ุ ูุงูุฐู ุชู ุฅูุดุงุคู ุฏููุงูููููุง ุจุงููุงูู ูู ููููุงุช React ุ ูุญุชุงุฌ ุฅูู ุฃู ูููู ูุงุฏุฑูู ุนูู ููุญูู ูุชูุฌุฉ ุชูุฏูู React ุ ููุฐูู ุชุนูู ููููุฉ ุฌุนู ูุฐู ุงููุชูุฌุฉ ุชูุงุนููุฉ ูุฑุฉ ุฃุฎุฑู. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุฎุทุท ุงูุนุงู ุจุณูุท. ุฃููุงู: ูุญุชุงุฌ ุฅูู ุฅุฏุฑุงุฌ HTML ุงูุฐู ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ ูููู React ูู ูุงูุจ HTML ุงูุฎุงุต ุจูุง </font></font><code>App</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. ุณูุชู ุนุฑุถ HTML ูุฐุง ุจูุงุณุทุฉ ูุญุฑูุงุช ุงูุจุญุซ (ูุงููุชุตูุญ ูุน JS ูุชููู ุ hehe). ุซุงููุงู: ุฅุถุงูุฉ ุนูุงูุฉ ุฅูู ุงููุงูุจ </font></font><code>&lt;script&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุฐู ูุญูุธ ูู ููุงู ูุง (ุนูู ุณุจูู ุงููุซุงู ุ ูุงุฆู </font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ุชูุฑูุบ ุญุงูุฉ ุชู ุชูุฏูู HTML ููู. ุซู ูููููุง ุนูู ุงูููุฑ ุชููุฆุฉ ุทูุจูุง ุนูู ุฌุงูุจ ุงูุนููู ูุน ูุฐู ุงูุญุงูุฉ ูุฅุธูุงุฑ ูุง ูู ูุทููุจ (ูููููุง ุญุชู ุงุณุชุฎุฏุงู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูููุฏุฑุงุช</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅูู HTML ุงูุฐู ุชู ุฅูุดุงุคู ุ ุญุชู ูุง ุชุนูุฏ ุฅูุดุงุก ุดุฌุฑุฉ DOM ููุชุทุจูู). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุจุฏุฃ ุจูุชุงุจุฉ ุฏุงูุฉ ุชูุฑุฌุน HTML ุงูููุฏู ูุงูุญุงูุฉ ุงูููุงุฆูุฉ.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js import "@babel/polyfill" import React from 'react' import {renderToString} from 'react-dom/server' import {Provider} from 'react-redux' import App from './components/app' import {navigate} from "./redux/actions"; import configureStore from "./redux/configureStore"; export default function render(initialState, url) { //  store,    . const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); // ,        ! // ,         ? let content = renderToString(app); let preloadedState = store.getState(); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฃุถู ูุณูุทุงุช ูููุทููุง ุฌุฏูุฏูุง ุฅูู ุงููููุฐุฌ ุงูุฐู ุชุญุฏุซูุง ุนูู ุฃุนูุงู: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/template.js function template(title, initialState, content) { let page = ` &lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="utf-8"&gt; &lt;title&gt;${title}&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="app"&gt;${content}&lt;/div&gt; &lt;script&gt; window.__STATE__ = ${JSON.stringify(initialState)} &lt;/script&gt; &lt;script src="/dist/client.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt; `; return page; } module.exports = template;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุตุจุญ ุฎุงุฏู Express ุฃูุซุฑ ุชุนููุฏูุง: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" } }; const {content, preloadedState} = render(initialState, {pathname: req.url}); res.send(template("Habr demo app", preloadedState, content)); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููู ุงูุนููู ุฃุณูู: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/client.js import React from 'react' import {hydrate} from 'react-dom' import {Provider} from 'react-redux' import App from './components/app' import configureStore from './redux/configureStore' import {navigate} from "./redux/actions"; //         ! const store = configureStore(window.__STATE__); // render   hydrate. hydrate    // DOM tree,       . hydrate( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt;, document.querySelector('#app') );</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุจุนุฏ ุฐูู ุ ุชุญุชุงุฌ ุฅูู ุชูุธูู ุฃุฎุทุงุก ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ ูุซู "ูู ูุชู ุชุนุฑูู ุงูุณุฌู". </font><font style="vertical-align: inherit;">ููููุงู ุจุฐูู ุ ุฃุถู ูุธููุฉ ุจุณูุทุฉ (ุญุชู ุงูุขู) ูู ููุงู ูุง </font></font><code>utility.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/utility.js export function isServerSide() { //   ,      process, //     -   . return process.env.APP_ENV !== undefined; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุจุนุฏ ุฐูู ุ ุณูููู ููุงู ุนุฏุฏ ูุนูู ูู ุงูุชุบููุฑุงุช ุงูุฑูุชูููุฉ ุงูุชู ูู ุฃุญูููุง ููุง (ูููู ูููู ุงูุนุซูุฑ ุนูููุง ูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุงูุชุฒุงู ุงูููุงุจู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">ูุชูุฌุฉ ูุฐูู ุ ุณูุชููู ุชุทุจูู React ุงูุฎุงุต ุจูุง ูู ุงูุนุฑุถ ูู ุงููุณุชุนุฑุถ ูุนูู ุงูุฎุงุฏู.</font></font><br><br>  ุฅูู ูุนูู!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ููุงู ุ ููุง ูููููู ุ ุชุญุฐูุฑ ูุงุญุฏ ... </font></font><br><br><img src="https://habrastorage.org/webt/gd/ac/ut/gdacut18knqjvzftjhkkuhnzxgk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุชุญูููุ ูู ูุง ุชุฑุงู Google ุนูู ุฎุฏูุฉ ุงูุฃุฒูุงุก ุงูุฑุงุฆุนุฉ ูุฏู ูู LOADINGุ! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญุณููุง ุ ูุจุฏู ุฃู ูู ุชุฒุงูููุง ูุฏ ูุนุจ ุถุฏูุง. ูุญุชุงุฌ ุงูุขู ุฅูู ุทุฑููุฉ ููุณูุงุญ ููุฎุงุฏู ุจููู ุฃู ุงูุงุณุชุฌุงุจุฉ ูู ุงูุฎูููุฉ ูุน ูุญุชูู ุงูุจุทุงูุฉ ุชุญุชุงุฌ ุฅูู ุงูุงูุชุธุงุฑ ูุจู ุชูุฏูู ุชุทุจูู React ุฅูู ุณูุณูุฉ ูุฅุฑุณุงููุง ุฅูู ุงูุนููู. ููู ุงููุฑุบูุจ ููู ุฃู ุชููู ูุฐู ุงูุทุฑููุฉ ุนุงูุฉ ุฅูู ุญุฏ ูุง. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ุฃู ูููู ููุงู ุงูุนุฏูุฏ ูู ุงูุญููู. ุชุชูุซู ุฅุญุฏู ุงูุทุฑู ูู ูุตู ููู ูููุตู ูููุณุงุฑุงุช ุงูุชู ูุฌุจ ุชุฃููู ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจูุง ุ ูุงูููุงู ุจุฐูู ูุจู ุชูุฏูู ุงูุชุทุจูู ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงูุฉ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). ูุฐุง ุงูุญู ูู ุงูุนุฏูุฏ ูู ุงููุฒุงูุง. ุฅูู ุจุณูุท ูุตุฑูุญ ููุนูู.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุชุฌุฑุจุฉ (ูุฌุจ ุฃู ูููู ุงููุญุชูู ุงูุฃุตูู ูู ุงูููุงูุฉ ุนูู ุงูุฃูู ูู ููุงู ูุง!) ุฃูุชุฑุญ ูุฎุทุทูุง ุขุฎุฑ. </font><font style="vertical-align: inherit;">ุฏุนููุง ูู ูู ูุฑุฉ ูููู ูููุง ุจุชุดุบูู ุดูุก ุบูุฑ ูุชุฒุงูู ุ ูุฌุจ ุฃู ููุชุธุฑู ุ ุฃุถู ุงููุนุฏ ุงูููุงุณุจ (ุนูู ุณุจูู ุงููุซุงู ุ ุงููุนุฏ ุงูุฐู ูุนูุฏ ุฌูุจู) ูู ููุงู ูุง ูู ููุงูุชูุง. </font><font style="vertical-align: inherit;">ูุฐูู ุณูููู ูุฏููุง ููุงู ุญูุซ ููููู ุฏุงุฆููุง ุงูุชุญูู ููุง ุฅุฐุง ูุงู ูู ุดูุก ูุฏ ุชู ุชูุฒููู ุฃู ูุง. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุถุงูุฉ ุงุซููู ูู ุงูุฅุฌุฑุงุกุงุช ุงูุฌุฏูุฏุฉ.</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function addPromise(promise) { return { type: ADD_PROMISE, promise: promise }; } function removePromise(promise) { return { type: REMOVE_PROMISE, promise: promise, }; }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูุชู ุงุณุชุฏุนุงุก ุงูุฃูู ุนูุฏูุง ูุชู ุชุดุบูู ุงูุฌูุจ ุ ูุงูุซุงูู - ูู ููุงูุชู </font></font><code>.then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ุฅุถุงูุฉ ูุนุงูุฌุชูุง ุฅูู ุงููุฎูุถ:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/reducers.js export default function root(state = {}, action) { switch (action.type) { case ADD_PROMISE: return { ...state, promises: [...state.promises, action.promise] }; case REMOVE_PROMISE: return { ...state, promises: state.promises.filter(p =&gt; p !== action.promise) }; ...</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ุณูููู ุจุชุญุณูู ุงูุนูู </font></font><code>fetchCard</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/redux/actions.js function fetchCard() { return (dispatch, getState) =&gt; { dispatch(startFetchingCard()); let url = apiPath() + "/card/" + getState().page.cardSlug; let promise = fetch(url) .then(response =&gt; response.json()) .then(json =&gt; { dispatch(finishFetchingCard(json)); // " ,  " dispatch(removePromise(promise)); }); // "  ,  " return dispatch(addPromise(promise)); }; }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุจูู ูุฅุถุงูุฉ </font></font><code>initialState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุนูุฏ </font><font style="vertical-align: inherit;">ุฅูู </font><font style="vertical-align: inherit;">ูุฌููุนุฉ ูุงุฑุบุฉ ูุฌุนู ุงูุฎุงุฏู ููุชุธุฑ ูููู ุฌููุนุง! </font><font style="vertical-align: inherit;">ุชุตุจุญ ูุธููุฉ ุงูุชุฌุณูุฏ ุบูุฑ ูุชุฒุงููุฉ ูุชุฃุฎุฐ ุงูุดูู ุงูุชุงูู:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/src/server.js function hasPromises(state) { return state.promises.length &gt; 0 } export default async function render(initialState, url) { const store = configureStore(initialState); store.dispatch(navigate(url)); let app = ( &lt;Provider store={store}&gt; &lt;App/&gt; &lt;/Provider&gt; ); //  renderToString     // (  ). CardPage     . renderToString(app); // ,   !    - //    (  // , ),     //    . let preloadedState = store.getState(); while (hasPromises(preloadedState)) { await preloadedState.promises[0]; preloadedState = store.getState() } //  renderToString.    HTML. let content = renderToString(app); return {content, preloadedState}; };</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุจุณุจุจ ุนุฏู </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุชุฒุงูู </font><font style="vertical-align: inherit;">ุงูููุชุณุจ </font><font style="vertical-align: inherit;">ุ ูููู ูุนุงูุฌ ุงูุทูุจ ุฃูุซุฑ ุชุนููุฏูุง ุฃูุถูุง:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// frontend/index.js app.get("*", (req, res) =&gt; { const initialState = { page: { type: "home" }, promises: [] }; render(initialState, {pathname: req.url}).then(result =&gt; { const {content, preloadedState} = result; const response = template("Habr demo app", preloadedState, content); res.send(response); }, (reason) =&gt; { console.log(reason); res.status(500).send("Server side rendering failed!"); }); });</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฅุช ููููุง! </font></font><br><br><img src="https://habrastorage.org/webt/vt/ed/uj/vteduj-6tnshnodaw0setd3b0wu.png"><br><br><h2 style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุง ุชุฑูู ุ ูุฅู ุฅูุดุงุก ุชุทุจูู ุนุงูู ุงูุชูููุฉ ููุณ ุจูุฐู ุงูุจุณุงุทุฉ. </font><font style="vertical-align: inherit;">ูููู ููุณ ูู ุงูุตุนุจ ุฌุฏุง! </font><font style="vertical-align: inherit;">ููุฌุฏ ุงูุชุทุจูู ุงูููุงุฆู ูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุณุชูุฏุน ุนูู Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ููู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ูุฃูุช ุจุญุงุฌุฉ ููุท ุฅูู Docker ูุชุดุบููู. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฐุง ูุงู ุงูููุงู ูุทููุจูุง ุ ููู ูุชู ุงูุชุฎูู ุนู ูุฐุง ุงููุณุชูุฏุน! </font><font style="vertical-align: inherit;">ุณูููู ูุงุฏุฑูู ุนูู ุงููุธุฑ ุฅููู ุจุดูุก ูู ุงููุนุฑูุฉ ุงูุฃุฎุฑู ุงูุถุฑูุฑูุฉ:</font></font><br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุชุณุฌูู ุ ุฑุตุฏ ุ ุงุฎุชุจุงุฑ ุงูุญูู. </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงุฎุชุจุงุฑ ุ CI ุ CD. </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุฒุงุช ุฃูุซุฑ ุจุฑูุฏุฉ ูุซู ุงูุชูููุถ ุฃู ุงูุจุญุซ ุนู ุงููุต ุงููุงูู. </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฅุนุฏุงุฏ ูุชุทููุฑ ุจูุฆุฉ ุงูุฅูุชุงุฌ. </font></font></li></ul><br>  ุดูุฑุง ูุงูุชูุงููู! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar444446/">https://habr.com/ru/post/ar444446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar444434/index.html">ููุฏ ุญุงู ุงูููุช ูุฌุงูุง 12! ุงุณุชุนุฑุงุถ JEPs ุงูุณุงุฎูุฉ</a></li>
<li><a href="../ar444436/index.html">ูุง ูู ุงูุฑูุจูุชุงุช Mirai ุ ูููู ูููููู ุญูุงูุฉ ุฃุฌูุฒุชูุ</a></li>
<li><a href="../ar444438/index.html">ุชุงุฑูุฎ ููุฌุฒ ูููุตุฏุฑ ุงูููุชูุญ - ููู ูุงุชู ุงูุจุฑูุฌูุงุช ุงูุญุฑุฉ ูุน ุงูููููุฉ</a></li>
<li><a href="../ar444442/index.html">Jetson Nano: ูููุฏูุง ุชุนูู ุขูุฉ ูุงุญุฏุฉ ุงููุฌูุณ</a></li>
<li><a href="../ar444444/index.html">ุงูุฃูุถู ูู ูุคุชูุฑุงุชูุง (Joker ู JPoint ู DotNext ู Mobius ู TechTrain ููุง ุฅูู ุฐูู)</a></li>
<li><a href="../ar444448/index.html">ููุฑุงู ูููู ุชุถูู ุนุดุฑุฉ ุนูููุงุช ุงุณุชุบูุงู ุฌุฏูุฏุฉ ููุฃุฌูุฒุฉ ุงููุณุชูุฏูุฉ ูุฅูุชุฑูุช ุงูุฃุดูุงุก</a></li>
<li><a href="../ar444456/index.html">Atari 65XE - ููุญุฉ ููุงุชูุญ USB</a></li>
<li><a href="../ar444460/index.html">ูู ุงููุญูู ุงููุบูู ูููุตู ูุณุฑุญ ุจูุซูู ุฅูู ุฑูุจูุช Telegram. ุงูุฌุฒุก 1</a></li>
<li><a href="../ar444462/index.html">ุงุฎุชุจุงุฑ Samsung Galaxy S10 - ูุชู ุณุชูุญู ุงูููุงุชู ุงูุฐููุฉ ุจุงููุงููุฑุงุชุ</a></li>
<li><a href="../ar444464/index.html">ุทุฑููุฉ ุฃุฎุฑู ูุฅุทูุงู ุงููุงุฑ ุนูู ุณุงูู ุจุงุณุชุฎุฏุงู std :: thread</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>