<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüî¨ üçá üöä Uma cobra na caixa de correio e o que faz F # üß¶ üó®Ô∏è üëÇüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que √© isso tudo? 


 √â tudo sobre a cobra. Todo mundo se lembra do que √© uma cobra: uma cobra se move em um campo retangular. Encontra comida - cres...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uma cobra na caixa de correio e o que faz F #</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424861/"><h4 id="o-chem-eto-vse">  O que √© isso tudo? </h4><br><p>  √â tudo sobre a cobra.  Todo mundo se lembra do que √© uma cobra: uma cobra se move em um campo retangular.  Encontra comida - cresce em comprimento, encontra-se ou √† beira do campo - morre.  E o usu√°rio pode enviar apenas comandos: esquerda, direita, cima, baixo. <br>  Decidi acrescentar alguma a√ß√£o aqui e fazer a cobra fugir do pacman.  E tudo isso nos atores! </p><br><p> Portanto, hoje usarei o exemplo de uma cobra para falar sobre como construir um modelo de ator usando o <code>MailboxProcessor</code> da biblioteca padr√£o, quais pontos procurar e quais armadilhas voc√™ pode esperar. </p><br><p>  O c√≥digo escrito aqui n√£o √© perfeito, pode violar alguns princ√≠pios e pode ser melhor escrito.  Mas se voc√™ √© iniciante e deseja lidar com caixas de correio - espero que este artigo o ajude. <br>  Se voc√™ sabe tudo sobre caixas de correio sem mim, pode estar entediado aqui. </p><br><h4 id="pochemu-aktory">  Por que atores? </h4><br><p>  Por uma quest√£o de pr√°tica.  Eu li sobre o modelo de atores, assisti ao v√≠deo, gostei de tudo, mas n√£o tentei.  Agora eu tentei. <br>  Apesar de, de fato, ter escolhido a tecnologia em prol da tecnologia, o conceito recaiu com muito sucesso nessa tarefa. </p><br><h4 id="pochemu-mailboxprocessor-a-ne-naprimer-akkanet">  Por que MailboxProcessor, e n√£o, por exemplo, Akka.net? </h4><br><p>  Para minha tarefa, o <code>MailboxProcessor</code> √© da esta√ß√£o orbital por pardais, o <code>MailboxProcessor</code> muito mais simples e faz parte da biblioteca padr√£o, portanto, voc√™ n√£o precisa conectar nenhum pacote. </p><a name="habracut"></a><br><h4 id="o-meylboks-processorah-i-soputsvuyuschem-boylerpleyte">  Sobre processadores de caixa de correio e clich√™ relacionado </h4><br><p>  O ponto √© simples.  A caixa de correio interna possui um loop de mensagens e algum estado.  Seu loop de mensagens atualizar√° esse estado de acordo com a nova mensagem que chegar. </p><br><pre> <code class="hljs kotlin">let actor = MailboxProcessor.Start(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> inbox -&gt; // ,    //   . inbox --    MailboxProcessor let rec messageLoop oldState = async { //   let! msg = inbox.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">//    let newState = updateState oldState msg //      return! messageLoop newState } //       .    --     messageLoop (0,0) )</span></span></code> </pre> <br><p>  Observe que <code>messageLoop</code> recursivo e, no final, deve ser chamado novamente, caso contr√°rio, apenas uma mensagem ser√° processada, ap√≥s a qual esse ator morrer√°.  <code>messageLoop</code> tamb√©m <code>messageLoop</code> ass√≠ncrono e cada itera√ß√£o subsequente √© executada quando uma nova mensagem √© recebida: <code>let! msg = inbox.Receive()</code>  <code>let! msg = inbox.Receive()</code> . <br>  Assim, toda a carga l√≥gica vai para a fun√ß√£o <code>updateState</code> , o que significa que, para criar a caixa de correio do processador, podemos criar uma fun√ß√£o construtora que aceite uma fun√ß√£o de atualiza√ß√£o de estado e um estado zero: </p><br><pre> <code class="hljs haskell">//   applyMessage       //      (fun inbox -&gt; ...) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> buildActor applyMessage zeroState = <span class="hljs-type"><span class="hljs-type">MailboxProcessor</span></span>.<span class="hljs-type"><span class="hljs-type">Start</span></span>(fun inbox -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rec</span></span> loop state = async{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span>! msg = inbox.<span class="hljs-type"><span class="hljs-type">Receive</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> newState = applyMessage state msg return! loop newState } loop zeroState )</code> </pre><br><p>  Legal!  Agora n√£o precisamos monitorar constantemente para n√£o esquecer o <code>return! loop newState</code>  <code>return! loop newState</code> .  Como voc√™ sabe, um ator armazena um estado, mas agora n√£o est√° completamente claro como obter esse estado de fora.  A caixa de correio do processador possui um m√©todo <code>PostAndReply</code> , que <code>AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg</code> a fun√ß√£o <code>AsyncReplyChannel&lt;'Reply&gt; -&gt; 'Msg</code> como entrada.  No come√ßo, ele me levou a um estupor - n√£o √© totalmente claro de onde obter essa fun√ß√£o.  Mas, na realidade, tudo ficou mais simples: todas as mensagens devem ser agrupadas em um inv√≥lucro de DU, j√° que agora temos duas opera√ß√µes em nosso ator: envie a pr√≥pria mensagem e solicite o estado atual.  Aqui est√° o que parece: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Mail&lt;_,_&gt;   ,  Post &amp; Get --  . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ F#       , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   compare &amp; equals . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/         --   . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   [&lt;Struct&gt;] .       type Mail&lt;'msg, 'state&gt; = | Post of 'msg | Get of AsyncReplyChannel&lt;'state&gt;</span></span></code> </pre> <br><p>  Nossa fun√ß√£o construtora agora se parece com isso: </p><br><pre> <code class="hljs erlang-repl">let buildActor applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec loop state = async{ let! msg = inbox.Receive() //    ,     // .    -- ,     //     . //     --      //    .      ! match msg with | Post msg -&gt; let newState = applyMessage state msg return! loop newState | Get channel -&gt; channel.Reply state return! loop state } loop zeroState )</code> </pre><br><p>  Agora, para trabalhar com a caixa de correio, precisamos <code>Mail.Post</code> todas as nossas mensagens neste <code>Mail.Post</code> .  Para n√£o escrever isso toda vez, √© melhor envolv√™-lo em um aplicativo pequeno: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span> Mailbox = let buildAgent applyMessage zeroState = MailboxProcessor.Start(fun inbox -&gt; let rec <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state = async{ let! msg = inbox.Receive() match msg with | Post msg -&gt; let newState = applyMessage state msg <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> newState | Get channel -&gt; channel.Reply state <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>! <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> state } <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> zeroState ) let post (agent: MailboxProcessor&lt;_&gt;) msg = Post msg |&gt; agent.Post let getState (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndReply Get let getStateAsync (agent: MailboxProcessor&lt;_&gt;) = agent.PostAndAsyncReply Get <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   Single Case Discriminated Union. <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> MailboxProcessor   API.      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  ,  ,      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   .       ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        . type MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt; = MailAgent <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> address:string * mailbox:MailboxProcessor&lt;Mail&lt;<span class="hljs-string"><span class="hljs-string">'msg, '</span></span>state&gt;&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.post <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> msg member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetState() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getState <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetStateAsync() = let (MailAgent (address,<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Mailbox.getStateAsync <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Address = let (MailAgent (address, _)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> address member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = let (MailAgent (_, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> (this:&gt;IDisposable).Dispose() interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose()</code> </pre> <br><p>  Vou lhe dizer qual <code>address:string</code> pouco mais tarde, mas, por enquanto, nosso padr√£o est√° pronto. </p><br><h4 id="sobstvenno-zmeyka">  Na verdade, a cobra </h4><br><p>  Na cobra h√° uma cobra, um usu√°rio com seus comandos, um campo e uma transi√ß√£o regular para o pr√≥ximo quadro. <br>  Aqui est√° tudo isso junto e precisa ser manchado por nossos atores. <br>  Meu layout inicial era o seguinte: </p><br><ul><li>  Ator com um temporizador.  Aceita iniciar / parar / pausar mensagens.  A cada n milissegundos, envia uma mensagem <code>Flush</code> ao ator de <code>Flush</code> .  Armazena <code>System.Timers.Timer</code> como um estado </li><li>  Equipes de atores.  Recebe mensagens do usu√°rio <code>Move Up/Down/Left/Right</code> , <code>AddPerk Speed/Attack</code> (sim, minha cobra pode rastejar e atacar vil√µes rapidamente) e <code>Flush</code> o timer.  Ele armazena uma lista de comandos como um estado e, com um flush, essa lista √© redefinida. </li><li>  O ator √© uma cobra.  Ele armazena o estado da cobra - vantagens, comprimento, dire√ß√£o, curvas e coordenadas. <br>  Ele aceita uma lista de mensagens do ator dos comandos, uma mensagem <code>Tick</code> (para mover a c√©lula cobra 1 para frente) e uma mensagem <code>GrowUp</code> do ator do campo quando encontra comida. </li><li>  Ator de campo.  Ele armazena um mapa de c√©lulas, pega o estado de uma cobra em uma mensagem e desenha coordenadas em uma imagem existente.  Ele tamb√©m envia o <code>GrowUp</code> ator snake e o comando <code>Stop</code> ao cron√¥metro, se o jogo terminar. </li></ul><br><p>  Como voc√™ pode ver, mesmo com um n√∫mero t√£o pequeno de entidades, o mapa de mensagens j√° n√£o √© trivial.  E j√° nesse est√°gio surgiram dificuldades: o fato √© que, por padr√£o, o F # n√£o permite depend√™ncias c√≠clicas.  Na linha de c√≥digo atual, voc√™ pode usar apenas o c√≥digo escrito acima, e o mesmo se aplica aos arquivos no projeto.  Isso n√£o √© um bug, mas um recurso, e eu amo muito isso, porque ajuda a manter o c√≥digo limpo, mas o que fazer quando os links c√≠clicos s√£o necess√°rios pelo design?  Claro, voc√™ pode usar o <code>rec namespace</code> - e, em um arquivo, voc√™ pode se referir a tudo o que est√° nesse arquivo, que eu usei. <br>  Espera-se que o c√≥digo atrapalhe, mas parecia a √∫nica op√ß√£o.  E funcionou. </p><br><h4 id="problema-vneshnego-mira">  O problema do mundo exterior </h4><br><p>  Tudo funcionou desde que todo o sistema de atores estivesse isolado do mundo exterior, e eu apenas estraguei e exibi linhas no console.  Quando chegou a hora de implementar a depend√™ncia na forma da fun√ß√£o <code>updateUI</code> , que deveria redesenhar para cada marca, n√£o consegui resolver esse problema na implementa√ß√£o atual.  Nem feio nem bonito - de jeito nenhum.  E ent√£o me lembrei de akku - afinal, l√° voc√™ pode gerar atores ao longo do caminho, e eu tenho todos os meus atores descritos na fase de compila√ß√£o. <br>  A solu√ß√£o √© √≥bvia - use akku!  N√£o, √© claro que Akka ainda √© um exagero, mas decidi lamber alguns pontos a partir da√≠ - a saber, criar um sistema de atores no qual voc√™ possa adicionar dinamicamente novos atores e consultar os atores existentes no endere√ßo. <br>  Como os atores agora s√£o adicionados e exclu√≠dos em tempo de execu√ß√£o, mas obtidos pelo endere√ßo e n√£o pelo link direto, √© necess√°rio fornecer um cen√°rio em que o endere√ßo n√£o pare√ßa estar em lugar nenhum e o ator n√£o esteja l√°.  Seguindo o exemplo da mesma acca, adicionei uma caixa para cartas mortas e a projetei nas minhas DUs favoritas: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Agent&lt;_,_&gt; --  ,   ,     <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ,      . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      ,    --    Box (mailagent), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   ,   , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       Deadbox.      MailAgent,  . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>           . <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    --    . type Agent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; = | Box <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message,'</span></span>state&gt; | DeadBox <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> string * MailAgent&lt;string * obj, Map&lt;string,obj list&gt;&gt; with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Post msg = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box box -&gt; box.Post msg | DeadBox (address, deadbox) -&gt; (address, box msg) |&gt; deadbox.Post interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = match <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> with | Box agent -&gt; agent.Dispose() | DeadBox (_,agent) -&gt; agent.Dispose()</code> </pre> <br><p>  E o pr√≥prio sistema se parece com isso: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .     --    . type MailboxNetwork() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> = <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      .   ! [&lt;DefaultValue&gt;] val mutable agentRegister: ConcurrentDictionary&lt;string, obj&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister &lt;- ConcurrentDictionary&lt;string, obj&gt;() <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    Map --     let deadLettersFn deadLetters (address:string, msg:obj) = printfn <span class="hljs-string"><span class="hljs-string">"Deadletter: %s-%A"</span></span> address msg match Map.tryFind address deadLetters with <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   | None -&gt; Map.add address [msg] deadLetters <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   --   | Some letters -&gt; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --      Map.remove address deadLetters |&gt; Map.add address (msg::letters) let deadLettersAgent() = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"deadLetters"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Map.empty |&gt; Mailbox.buildAgent deadLettersFn)</span></span></span><span class="hljs-function"> |&gt; MailAgent member this.DeadLetters = deadLettersAgent</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> // -     ,      member this.Box&lt;'message,'state&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address)</span></span></span><span class="hljs-function"> = match this.agentRegister.TryGetValue address with | </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, agent)</span></span></span><span class="hljs-function"> when </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(agent :? MailAgent&lt;</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'message,'</span></span></span></span><span class="hljs-function"><span class="hljs-params">state&gt;)</span></span></span><span class="hljs-function"> -&gt;</span></span> <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       ,   let agent = agent :?&gt; MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'message, '</span></span>state&gt; Box agent | _ -&gt; DeadBox (address, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DeadLetters) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  --    member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox address = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryRemove(address) |&gt; ignore member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.RespawnBox (agent: MailAgent&lt;<span class="hljs-string"><span class="hljs-string">'a,'</span></span>b&gt;) = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.KillBox agent.Address <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.TryAdd (agent.Address, agent) |&gt; ignore interface IDisposable with member <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose() = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> agent <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.agentRegister.Values <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match agent with | :? IDisposable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> agent -&gt; agent.Dispose() | _ -&gt; ()</code> </pre> <br><p>  √â aqui que o mesmo <code>address:string</code> , sobre o qual escrevi acima, foi √∫til.  E, novamente, funcionou, agora era f√°cil chegar √† depend√™ncia externa de onde voc√™ precisa.  As fun√ß√µes construtoras dos atores agora aceitaram o sistema de atores como argumentos e obtiveram os endere√ßos necess√°rios a partir da√≠: </p><br><pre> <code class="hljs haskell"> //    - (  )   - <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) //    message loop           <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> []</code> </pre><br><h4 id="medlenno">  Lentamente </h4><br><p>  Por raz√µes √≥bvias, durante a depura√ß√£o, configurei o jogo para uma velocidade baixa: o atraso entre os ticks era superior a 500 milissegundos.  Se voc√™ reduzir o atraso para 200, as mensagens come√ßar√£o a chegar tarde, e as equipes do usu√°rio trabalhar√£o com um atraso, o que estragar√° todo o jogo.  Uma mosca adicional na pomada foi o fato de o temporizador receber o comando de parada em caso de perda v√°rias vezes.  Para o usu√°rio, isso n√£o apareceu de forma alguma, mas, no entanto, houve algum tipo de bug. <br>  A verdade desagrad√°vel era que os atores s√£o, obviamente, √≥timos, mas as chamadas de m√©todo diretas s√£o muito mais r√°pidas.  Portanto, apesar do fato de que armazenar a cobra em um ator separado era conveniente do ponto de vista da organiza√ß√£o do c√≥digo, tive que abandonar essa ideia em nome da velocidade, porque, para 1 rel√≥gio do jogo, as mensagens eram muito intensas: </p><br><ol><li>  O usu√°rio envia um n√∫mero arbitr√°rio de comandos diretamente ao ator de comandos. </li><li>  O cron√¥metro envia um tiquetaque para o ator da equipe e, em uma implementa√ß√£o inicial, tamb√©m para o ator da cobra, para que ele a mova para a pr√≥xima c√©lula </li><li>  O ator do comando envia uma lista de comandos para a cobra quando a mensagem correspondente vem do timer. </li><li>  O ator cobra, tendo atualizado seu estado de acordo com as duas mensagens superiores, envia o estado ao ator de campo. </li><li>  O ator de campo redesenha tudo.  Se a cobra encontrou comida, envia uma mensagem de <code>GrowUp</code> ao ator, ap√≥s o qual ele envia o novo estado de volta ao ator de campo. </li></ol><br><p>  E por tudo isso, h√° 1 ciclo de rel√≥gio, o que n√£o √© suficiente, levando em considera√ß√£o a sincroniza√ß√£o nas entranhas do <code>MailboxProcessor</code> .  Al√©m disso, na implementa√ß√£o atual, o timer envia a pr√≥xima mensagem a cada n milissegundo, independentemente de qualquer coisa; portanto, se n√£o entrarmos na medida 1 vez, as mensagens come√ßam a se acumular e a situa√ß√£o piora.  Seria muito melhor ‚Äúesticar‚Äù essa medida espec√≠fica, processar tudo o que acumulou e seguir em frente. </p><br><h4 id="finalnaya-versiya">  Vers√£o final </h4><br><p>  Obviamente, o esquema de mensagens precisa ser simplificado, embora seja muito desej√°vel deixar o c√≥digo o mais simples e acess√≠vel poss√≠vel - relativamente falando, eu n√£o quero colocar tudo em um ator divino, e ent√£o n√£o h√° muito sentido nos atores. <br>  Portanto, olhando para a minha lista de atores, percebi que √© melhor sacrificar um ator-cobra primeiro.  Um temporizador √© necess√°rio, um buffer de comandos do usu√°rio tamb√©m √© necess√°rio para acumul√°-los em tempo real, mas despeje-o apenas uma vez por batida, e n√£o h√° necessidade objetiva de manter a cobra em um ator separado, isso foi feito apenas por conveni√™ncia.  Al√©m disso, mantendo-o com o ator de campo, ser√° poss√≠vel processar o script <code>GrowUp</code> sem demora.  <code>Tick</code> mensagem de <code>Tick</code> para a cobra tamb√©m n√£o faz muito sentido, porque quando recebemos uma mensagem do ator da equipe, isso j√° significa que uma nova batida aconteceu.  Adicionando a isso o alongamento da batida em caso de atraso, temos as seguintes altera√ß√µes: </p><br><ol><li>  <code>GrowUp</code> mensagens <code>Tick</code> &amp; <code>GrowUp</code> . </li><li>  Mantemos o ator cobra no ator de campo - ele agora armazenar√° o "tapla" desses estados. </li><li>  <code>System.Timers.Timer</code> do ator de timer.  Em vez disso, o esquema de trabalho ser√° o seguinte: ap√≥s receber o comando <code>Start</code> , ele envia <code>Flush</code> ator de comando.  Ele envia uma lista de comandos para o ator field + snake, o √∫ltimo ator processa tudo isso e envia uma mensagem <code>Next</code> para o timer, solicitando um novo tick dele.  O cron√¥metro, que recebeu <code>Next</code> espera por <code>Thread.Sleep(delay)</code> e inicia o c√≠rculo inteiro novamente.  Tudo √© simples. </li></ol><br><p>  Para resumir. </p><br><ul><li>  Na implementa√ß√£o anterior, 500 ms era o atraso m√≠nimo permitido.  No atraso atual, voc√™ pode remov√™-lo completamente - o ator de campo exigir√° uma nova batida quando estiver pronto.  A coleta de mensagens brutas de medidas anteriores n√£o √© mais poss√≠vel. </li><li>  O mapa de mensagens √© bastante simplificado - em vez de um gr√°fico complexo, temos o loop mais simples. </li><li>  Esta simplifica√ß√£o resolveu o erro quando o cron√¥metro <code>Stop</code> v√°rias vezes em caso de perda. </li><li>  A lista de mensagens foi reduzida.  Menos c√≥digo - menos mal! </li></ul><br><p>  √â assim: </p><br><pre> <code class="hljs haskell"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] commandAddress = <span class="hljs-string"><span class="hljs-string">"command"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] timerAddress = <span class="hljs-string"><span class="hljs-string">"timer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> [&lt;<span class="hljs-type"><span class="hljs-type">Literal</span></span>&gt;] gameAddress = <span class="hljs-string"><span class="hljs-string">"game"</span></span> // -     <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">CommandMessage</span></span>, <span class="hljs-type"><span class="hljs-type">Command</span></span> list&gt;(commandAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">TimerCommand</span></span>, <span class="hljs-type"><span class="hljs-type">TimerState</span></span>&gt;(timerAddress) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) = mailboxNetwork.<span class="hljs-type"><span class="hljs-type">Box</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Command</span></span> list, <span class="hljs-type"><span class="hljs-type">GameState</span></span>&gt;(gameAddress) // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) updateUi gameState cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgent = timerAgent mailboxNetwork //    match gameState.gameFrame with //     | <span class="hljs-type"><span class="hljs-type">Frame</span></span> field -&gt; //       <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameState = <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Next</span></span> //    updateUi gameState //     gameState // ! | <span class="hljs-type"><span class="hljs-type">End</span></span> (<span class="hljs-type"><span class="hljs-type">Win</span></span> _) -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> <span class="hljs-type"><span class="hljs-type">Game</span></span>.updateGameState gameState cmd //        | _ -&gt; timerAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Stop</span></span> //     gameState // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) commands msg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameAgent = gameAgent mailboxNetwork match msg with | <span class="hljs-type"><span class="hljs-type">Cmd</span></span> cmd -&gt; cmd::commands //       | <span class="hljs-type"><span class="hljs-type">Flush</span></span> -&gt; commands |&gt; gameAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> //     [] // message loop   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> timerAgentFn (mailboxNetwork: <span class="hljs-type"><span class="hljs-type">MailboxNetwork</span></span>) (state: <span class="hljs-type"><span class="hljs-type">TimerState</span></span>) cmd = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> commandAgent = commandAgent mailboxNetwork match cmd with | <span class="hljs-type"><span class="hljs-type">Start</span></span> -&gt; commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; {state with active = true} | <span class="hljs-type"><span class="hljs-type">Next</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //    ,     <span class="hljs-type"><span class="hljs-type">Threading</span></span>.<span class="hljs-type"><span class="hljs-type">Thread</span></span>.<span class="hljs-type"><span class="hljs-type">Sleep</span></span>(state.delay) commandAgent.<span class="hljs-type"><span class="hljs-type">Post</span></span> <span class="hljs-type"><span class="hljs-type">Flush</span></span>; state | <span class="hljs-type"><span class="hljs-type">Stop</span></span> -&gt; printfn <span class="hljs-string"><span class="hljs-string">"Stop received"</span></span>; { state with active = false } | <span class="hljs-type"><span class="hljs-type">PauseOrResume</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not state.active <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> //     <span class="hljs-comment"><span class="hljs-comment">--   commandAgent.Post Flush { state with active = not state.active } | SetDelay delay -&gt; Threading.Thread.Sleep(delay) if state.active then commandAgent.Post Flush {state with delay = delay}</span></span></code> </pre> <br><h4 id="ssylki">  Refer√™ncias </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o √†s caixas de correio</a> </li><li>  <a href="">Fontes de caixa de correio para os mais curiosos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digos-fonte para o modelo de ator</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424861/">https://habr.com/ru/post/pt424861/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424851/index.html">O que h√° de errado com a contrata√ß√£o de TI?</a></li>
<li><a href="../pt424853/index.html">A hist√≥ria de um √∫nico controlador de exibi√ß√£o que queria mostrar-se bem</a></li>
<li><a href="../pt424855/index.html">Machine Learning: embaralhe-se com um quarto de elefante</a></li>
<li><a href="../pt424857/index.html">CloudFlare implementou suporte a SNI criptografado</a></li>
<li><a href="../pt424859/index.html">O jogo mais simples do Arduino com uma tela 1602 - Parte # 1</a></li>
<li><a href="../pt424865/index.html">Descobertas part√≠culas elementares de design</a></li>
<li><a href="../pt424867/index.html">Desenvolvimento hexapod do zero (parte 1) - design</a></li>
<li><a href="../pt424869/index.html">Como o novo recurso do iOS 12 me lembrou que √© hora de curar</a></li>
<li><a href="../pt424871/index.html">Elon Musk e Tesla resolvem lit√≠gios com a Comiss√£o de Valores Mobili√°rios dos EUA</a></li>
<li><a href="../pt424873/index.html">Armadilhas do HttpClient no .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>