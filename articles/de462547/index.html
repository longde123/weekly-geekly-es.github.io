<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙅🏻 🚓 👨🏼‍⚕️ SGX Malvar: Wie Bösewichte die neue Technologie von Intel für die falschen Zwecke nutzen 🎛️ 👨🏾 🏷️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wie Sie wissen, ist der in der Enklave ausgeführte Code in seiner Funktionalität stark eingeschränkt. Er kann keine Systemaufrufe tätigen. Es können k...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SGX Malvar: Wie Bösewichte die neue Technologie von Intel für die falschen Zwecke nutzen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462547/"><p> Wie Sie wissen, ist der in der Enklave ausgeführte Code in seiner Funktionalität stark eingeschränkt.  Er kann keine Systemaufrufe tätigen.  Es können keine E / A-Operationen ausgeführt werden.  Er kennt die Basisadresse des Host-Codesegments nicht.  Es kann nicht jmp und Host-Code aufrufen.  Er hat keine Ahnung von der Struktur des Adressraums, der die Hostanwendung steuert (z. B. welche Seiten beworben werden oder welche Art von Daten auf diesen Seiten platziert werden).  Er kann das Betriebssystem nicht auffordern, ein Stück Speicher an die Hostanwendung anzuhängen (z. B. über / proc / pid / maps).  Naive Versuche, einen blinden beliebigen Speicherbereich einer Host-Anwendung zu lesen - ganz zu schweigen von Schreibversuchen - führen früher oder später (eher der erste) zur erzwungenen Beendigung des Enklavenprogramms.  Dies geschieht immer dann, wenn der von der Enklave angeforderte virtuelle Adressraumbereich für die Hostanwendung nicht zugänglich ist. </p><br><p>  Wird der Virenschreiber in solch harten Realitäten in der Lage sein, SGX-Enklaven zu verwenden, um seine böswilligen Ziele zu verwirklichen? </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">- Hack, um Adressen auf die Möglichkeit zu prüfen, sie zu lesen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">- Hack zum Prüfen von Adressen auf Beschreibbarkeit</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">- Hack, um den Kontrollfluss umzuleiten</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">- Was gibt dem Bösewicht die drei oben aufgeführten Hacks?</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">- Wie der Bösewicht diese Hacks benutzt, um Ranzomvari zu erstellen</a> </p><br><p><img src="https://habrastorage.org/webt/jw/ak/c1/jwakc1r2ic_hbeu3zaklnkev6po.jpeg"></p><a name="habracut"></a><br><p>  Auf der Grundlage all dieser Punkte wird allgemein angenommen, dass die Enklave nur die Hostanwendung bedienen kann und dass die Enklave keine eigene Initiative ergreifen kann, auch nicht böswillig.  Dies bedeutet, dass Enklaven für Virenschreiber keinen praktischen Wert darstellen.  Diese voreilige Annahme ist einer der Gründe, warum der SGX-Schutz asymmetrisch ist: Der Hostanwendungscode kann nicht auf den Enklavenspeicher zugreifen, während der Enklavencode jede Speicheradresse der Hostanwendung lesen und schreiben kann. </p><br><p>  Wenn es dem böswilligen Enklavencode gelingt, im Namen der Hostanwendung beliebige Systemaufrufe auszuführen, in ihrem Namen beliebigen Code auszuführen, den Speicher der Hostanwendung zu scannen und die für den Missbrauch geeigneten ROP-Ketten zu finden, kann er die vollständige Kontrolle übernehmen Host-Anwendung im Stealth-Modus.  Es kann nicht nur Benutzerdateien stehlen und verschlüsseln, sondern auch im Namen des Benutzers handeln.  Senden Sie beispielsweise Phishing-E-Mails in seinem Namen oder führen Sie DoS-Angriffe durch.  Gleichzeitig haben Sie keine Angst vor den modernsten Schutzmechanismen wie Stapelkanarien und Bereinigung von Adressen. </p><br><p>  Wir werden einige Hacks zeigen, durch die die Bösewichte die oben genannten Einschränkungen überwinden und versuchen, die Vorteile von SGX für ihre böswilligen Zwecke zu nutzen: bei der Durchführung von ROP-Angriffen.  Entweder um beliebigen Code auszuführen, der als Host-Sawing-Prozess getarnt ist (ähnlich dem häufig von Malware verwendeten Prozessaushöhlungsprozess), oder um eine bereits vorbereitete Malware zu maskieren (um ihre Malware vor der Verfolgung durch Virenschutzprogramme und andere Schutzmechanismen zu schützen). </p><br><a name="a1"></a><br><h1 id="hak-dlya-zondirovaniya-adresov-na-predmet-vozmozhnosti-ih-schityvaniya">  Hack, um Adressen auf die Möglichkeit zu prüfen, sie zu lesen </h1><br><p>  Da die Enklave nicht weiß, welche Bereiche des virtuellen Adressraums für die Hostanwendung verfügbar sind, und wenn Sie versuchen, eine unzugängliche Adresse zu lesen, die Enklave beendet werden muss, muss der Bösewicht einen Weg finden, um den Adressraum ausfallsicher zu scannen.  Finden Sie eine Möglichkeit, verfügbare virtuelle Adressen zuzuordnen.  Der Bösewicht löst dieses Problem, indem er die TSX-Technologie von Intel missbraucht.  Es nutzt eine der Nebenwirkungen von TSX: Wenn die Speicherzugriffsfunktion in einer TSX-Transaktion platziert ist, werden Ausnahmen, die sich aus dem Zugriff auf ungültige Adressen ergeben, von TSX unterdrückt, bevor das Betriebssystem erreicht wird.  Wenn Sie versuchen, auf eine ungültige Speicheradresse zuzugreifen, wird nur die aktuelle Transaktion unterbrochen und nicht das gesamte Enklavenprogramm.  T.O.  Mit TSX kann die Enklave innerhalb der Transaktion sicher auf jede Adresse zugreifen - ohne das Risiko eines Zusammenbruchs. </p><br><p>  Wenn die <em>angegebene Adresse für die</em> Hostanwendung <em>verfügbar ist</em> , ist die TSX-Transaktion am häufigsten erfolgreich.  In seltenen Fällen kann dies aufgrund externer Einflüsse wie Interrupts (z. B. Scheduler-Unterbrechungen), Verdrängung des Caches oder gleichzeitiger Änderung der Speicherzelle durch mehrere Prozesse fehlschlagen.  In diesen seltenen Fällen gibt TSX einen Fehlercode zurück, der angibt, dass der aufgetretene Fehler nur vorübergehend ist.  In diesen Fällen müssen Sie nur die Transaktion neu starten. </p><br><p>  Wenn die <em>angegebene Adresse</em> der <em>Hostanwendung nicht zur Verfügung steht</em> , unterdrückt TSX die Ausnahme (das Betriebssystem wird nicht benachrichtigt) und bricht die Transaktion ab.  Ein Fehlercode wird an den Enklavencode zurückgegeben, damit er auf die Tatsache reagieren kann, dass die Transaktion abgebrochen wurde.  Diese Fehlercodes zeigen an, dass die betreffende Adresse der Hostanwendung nicht zur Verfügung steht. </p><br><p><img src="https://habrastorage.org/webt/ws/56/5m/ws565mbicysq6wpxoadwankb-6a.png"></p><br><p><img src="https://habrastorage.org/webt/uv/mw/jg/uvmwjgnn9ygxbaaof_cq0v0jdau.png"></p><br><p>  Eine solche Manipulation von TSX aus dem Inneren der Enklave hat eine nette Eigenschaft für den Bösewicht: Da zum Zeitpunkt der Ausführung des Enklavencodes die meisten Hardware-Leistungsindikatoren nicht aktualisiert werden, ist es unmöglich, TSX-Transaktionen zu verfolgen, die innerhalb der Enklave mit ihnen ausgeführt werden.  Somit bleibt böswilliger Betrug mit TSX'om für das Betriebssystem völlig unsichtbar. </p><br><p>  Da der oben beschriebene Hack nicht auf Systemaufrufen beruht, kann er nicht durch einfaches Blockieren von Systemaufrufen erkannt oder verhindert werden.  was normalerweise ein positives Ergebnis im Kampf gegen die "Eiersuche" ergibt. </p><br><p>  Der Bösewicht verwendet den oben beschriebenen Hack, um im Host-Anwendungscode nach Gadgets zu suchen, die zum Bilden einer ROP-Kette geeignet sind.  Er muss jedoch nicht jede Adresse prüfen.  Es reicht aus, eine Adresse von jeder Seite des virtuellen Adressraums zu prüfen.  Das Testen aller 16 Gigabyte Speicher dauert ungefähr 45 Minuten (auf Intel i7-6700K).  Als Ergebnis erhält der Bösewicht eine Liste ausführbarer Seiten, die zum Aufbau einer ROP-Kette geeignet sind. </p><br><a name="a2"></a><br><h1 id="hak-dlya-zondirovaniya-adresov-na-predmet-vozmozhnosti-zapisi">  Hack zum Prüfen von Adressen auf Beschreibbarkeit </h1><br><p>  Um eine Enklavenversion eines ROP-Angriffs zu implementieren, muss der Bösewicht nach beschreibbaren, nicht verwendeten Teilen des Speichers der Hostanwendung suchen können.  Der Bösewicht verwendet diese Speicherabschnitte, um einen gefälschten Stapelrahmen und eine Nutzlast (Shellcode) zu injizieren.  Das Fazit ist, dass eine böswillige Enklave nicht von der Host-Anwendung verlangen kann, Speicher für sich selbst zuzuweisen, sondern den von der Host-Anwendung zugewiesenen Speicher für andere Zwecke verwenden kann.  Es sei denn natürlich, er schafft es, solche Orte zu finden, ohne die Enklave zusammenzubrechen. </p><br><p>  Der Bösewicht führt diese Suche durch, indem er eine weitere Nebenwirkung von TSX ausnutzt.  Zunächst prüft er wie im vorherigen Fall die Adresse auf ihre Existenz und prüft dann, ob die dieser Adresse entsprechende Seite zum Schreiben zugänglich ist.  Zu diesem Zweck verwendet der Bösewicht den folgenden Hack: Setzt die Schreibfunktion in die TSX-Transaktion ein und bricht die Transaktion nach Abschluss, jedoch vor Abschluss, gewaltsam ab (expliziter Abbruch). </p><br><p>  Wenn der Bösewicht den Rückkehrcode einer TSX-Transaktion betrachtet, erkennt er, ob er beschreibbar ist.  Wenn es sich um einen „expliziten Abbruch“ handelt, erkennt der Bösewicht, dass die Aufnahme erfolgreich wäre, wenn er sie zu Ende bringen würde.  Wenn die Seite schreibgeschützt ist, schlägt die Transaktion mit einem anderen Fehler als "expliziter Abbruch" fehl. </p><br><p><img src="https://habrastorage.org/webt/yo/pg/iy/yopgiyrkws5wdk-nin_q2e3wpvy.png"></p><br><p>  Eine solche Manipulation von TSX hat eine weitere Funktion, die für den Bösewicht angenehm ist (zusätzlich zu der Unfähigkeit, Hardware-Leistungsindikatoren zu verfolgen): Da alle Schreibbefehle in den Speicher nur aufgezeichnet werden, wenn die Transaktion erfolgreich war, wird durch Erzwingen des Abschlusses der Transaktion sichergestellt, dass die untersuchte Speicherzelle unverändert bleibt. </p><br><a name="a3"></a><br><h1 id="hak-dlya-perenapravleniya-potoka-upravleniya">  Kontrollfluss-Umleitungs-Hack </h1><br><p>  Wenn ein Bösewicht einen ROP-Angriff von einer Enklave aus ausführt - im Gegensatz zu herkömmlichen ROP-Angriffen - kann der Bösewicht die Kontrolle über das RIP-Register erlangen, ohne Fehler im angegriffenen Programm auszunutzen (Pufferüberlauf oder ähnliches).  Der Bösewicht kann den Wert des auf dem Stapel gespeicherten RIP-Registers direkt überschreiben.  Insbesondere kann es den Wert dieses Registers durch seine ROP-Kette ersetzen. </p><br><p>  Wenn die ROP-Kette jedoch lang ist, kann das Umschreiben eines großen Teils des Host-Anwendungsstapels zu Datenbeschädigung und unerwartetem Programmverhalten führen.  Als Bösewicht, der versucht, seinen Angriff heimlich durchzuführen, passt dieser Zustand nicht.  Daher erstellt er einen gefälschten temporären Stapelrahmen für sich selbst und speichert seine ROP-Kette darin.  Ein gefälschter Stapelrahmen wird an einer beliebigen Stelle im Speicher platziert, die beschreibbar ist, so dass der wahre Stapel unberührt bleibt. </p><br><p><img src="https://habrastorage.org/webt/w_/s-/qn/w_s-qnrj9fscjgiiz1q_xu6tz6m.png"></p><br><a name="a4"></a><br><h1 id="chto-dayut-zlodeyu-tri-perechislennye-vyshe-haka">  Was gibt dem Bösewicht die drei oben aufgeführten Hacks </h1><br><p>  (1) Zunächst durchsucht eine böswillige Enklave die Host-Anwendung durch einen <em>Hack, um Adressen auf die Möglichkeit des Lesens zu untersuchen</em> , nach ROP-Gadgets, die missbraucht werden können. </p><br><p><img src="https://habrastorage.org/webt/9a/2z/p9/9a2zp9bhjuor86g3njvlsxetwcg.png"></p><br><p>  (2) Anschließend wird die böswillige Enklave mithilfe eines <em>Hacks zum Überprüfen der Adressen auf Beschreibbarkeit</em> in den Speicherbereichen der <em>Hostanwendung</em> identifiziert, die zum Injizieren der Nutzdaten geeignet sind. </p><br><p><img src="https://habrastorage.org/webt/es/t5/-2/est5-2k5ycrnhrgw_ma_2tkf6wi.png"></p><br><p>  (3) Als nächstes erstellt die Enklave eine ROP-Kette aus den in Schritt (1) gefundenen Gadgets und fügt diese Kette in den Host-Anwendungsstapel ein. </p><br><p><img src="https://habrastorage.org/webt/do/54/bz/do54bzlimfouln6hun33s6k1aqg.png"></p><br><p>  (4) Wenn die Hostanwendung schließlich auf die im vorherigen Schritt erstellte ROP-Kette stößt, beginnt die Ausführung der böswilligen Nutzdaten mit den Berechtigungen der Hostanwendung und der Fähigkeit, Systemaufrufe zu tätigen. </p><br><a name="a5"></a><br><h1 id="kak-zlodey-zadeystvuet-eti-haki-dlya-sozdaniya-ranzomvari">  Wie der Bösewicht diese Hacks benutzt, um Ranzomvari zu erstellen </h1><br><p>  Nachdem die Hostanwendung die Kontrolle über eine der ECALLs an die Enklave übertragen hat (ohne zu vermuten, dass diese Enklave böswillig ist), sucht die böswillige Enklave nach freiem Speicherplatz im Speicher der Hostanwendung für die Code-Injektion (für die Stellen, an denen diese Zellsequenzen benötigt werden) gefüllt mit Nullen).  Anschließend sucht die Enklave mithilfe eines <em>Hacks nach</em> ausführbaren Seiten in der Hostanwendung und generiert eine ROP-Kette, die im aktuellen Verzeichnis eine neue Datei mit dem Namen „RANSOM“ erstellt (bei einem echten Angriff verschlüsselt die Enklave vorhandene Benutzerdateien) und Zeigt eine Lösegeldanforderungsnachricht an.  Gleichzeitig glaubt die Host-Anwendung naiv, dass die Enklave einfach zwei Zahlen addiert.  Wie sieht es im Code aus? </p><br><p>  Zur Erleichterung der Wahrnehmung führen wir einige Mnemoniken durch folgende Definitionen ein: </p><br><p><img src="https://habrastorage.org/webt/uu/fo/v_/uufov_dqhtly23sabyj6a4k8jik.png"></p><br><p>  Wir behalten die Anfangswerte der RSP- und RBP-Register bei, um den normalen Betrieb der Hostanwendung nach dem Ausführen der Nutzdaten wiederherzustellen: </p><br><p><img src="https://habrastorage.org/webt/h1/nx/1x/h1nx1xpue_tb2tew4z0-kytjgr4.png"></p><br><p>  Wir suchen nach einem geeigneten Stapelrahmen (siehe den Code im Abschnitt „Hack zum Umleiten des Kontrollflusses“). </p><br><p>  Finden Sie geeignete ROP-Gadgets: </p><br><p><img src="https://habrastorage.org/webt/r0/we/cf/r0wecfpdydx94xqv5zkkwmbgt4q.png"></p><br><p>  Suchen Sie einen Ort zum Einspritzen der Nutzlast: </p><br><p><img src="https://habrastorage.org/webt/0e/zk/7y/0ezk7yfmzak5oobrhqivpzd3jbe.png"></p><br><p>  Aufbau einer ROP-Kette: </p><br><p><img src="https://habrastorage.org/webt/jh/2-/k9/jh2-k9yyt_2rts1oexzaore2qoc.png"></p><br><p>  Auf diese Weise wird die SGX-Technologie von Intel, die schädlichen Programmen standhält, von Bösewichten genutzt, um gegnerische Ziele zu erreichen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462547/">https://habr.com/ru/post/de462547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462537/index.html">Cloud-Migration</a></li>
<li><a href="../de462539/index.html">Trigonometrie vermeiden</a></li>
<li><a href="../de462541/index.html">Verwenden von Conditional im Frühjahr</a></li>
<li><a href="../de462543/index.html">Java-Treffen bei der Raiffeisenbank</a></li>
<li><a href="../de462545/index.html">Telegrammblockierung, Hetzner Subnetz / 16, Erfahrung mit ILV</a></li>
<li><a href="../de462549/index.html">Quorum Blockchain: Integration in Java-Code</a></li>
<li><a href="../de462551/index.html">Beliebte Entwicklerfragen zum Testen</a></li>
<li><a href="../de462553/index.html">Ein bisschen über einfach. Testdesign. Teil 1</a></li>
<li><a href="../de462555/index.html">Diskussion: Was ist, wenn Sie ohne Cookies arbeiten? Wir sagen Ihnen, welche Alternativen es gibt</a></li>
<li><a href="../de462563/index.html">Webinar „Wie man Compliance überlebt?“ Der beste Ansatz zur Erfüllung regulatorischer Anforderungen “</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>