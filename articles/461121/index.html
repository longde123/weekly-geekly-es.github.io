<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游뱓 游끯 游뱄 Peque침os experimentos multitarea en un microcontrolador 游 游꼨 游똁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En una de las notas anteriores, el autor trat칩 de argumentar que al programar el microcontrolador, un simple cambio de tarea ser치 칰til en situaciones ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Peque침os experimentos multitarea en un microcontrolador</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461121/"><p>  En una de las notas anteriores, el autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trat칩 de</a> argumentar que al programar el microcontrolador, un simple cambio de tarea ser치 칰til en situaciones en las que usar el sistema operativo en tiempo real es demasiado, y el bucle integral para todas las acciones requeridas es demasiado peque침o ( 칄l dijo, al igual que el Conde de La Fer).  M치s precisamente, no muy poco, pero demasiado confundido. </p><br><p>  En una nota posterior, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se plane칩</a> optimizar el acceso a los recursos compartidos por varias tareas usando colas basadas en buffers de anillo (FIFO) y una tarea separada especialmente asignada para esto.  Habiendo dispersado para diferentes tareas aquellas acciones que no est치n relacionadas entre s칤, tenemos derecho a esperar un c칩digo m치s visible.  Y si al mismo tiempo obtenemos algo de comodidad y simplicidad, 쯣or qu칠 no probarlo? </p><br><p>  Obviamente, el microcontrolador no est치 dise침ado para resolver ninguna tarea concebible del usuario.  Entonces, tal vez, un conmutador de tareas de este tipo ser치 suficiente en muchas situaciones.  En resumen, es poco probable que un peque침o experimento duela.  Por lo tanto, para no ser infundado, su humilde servidor decidi칩 escribir algo y probar sus garabatos. </p><a name="habracut"></a><br><p>  En los microcontroladores, debo decir que el requisito de contar con el tiempo como algo importante y r칤gido es m치s com칰n que en las computadoras de uso general.  Ir m치s all치 del marco en el primer caso es equivalente a la inoperancia, y en el segundo caso, solo conduce a un aumento en el tiempo de espera, que es bastante aceptable si los nervios est치n en orden.  Incluso hay dos t칠rminos "tiempo real suave" y "tiempo real duro". </p><br><p>  Perm칤tame recordarle que est치bamos hablando de controladores con el n칰cleo Cortex-M3,4,7.  Hoy es una familia muy com칰n.  En los ejemplos a continuaci칩n, utilizamos el microcontrolador STM32F303, que forma parte de la placa STM32F3DISCOVERY. </p><br><p>  El conmutador es un archivo de ensamblador 칰nico. <br>  El ensamblador no le tiene miedo al autor, pero, por el contrario, inspira esperanza de que se alcance la velocidad m치xima. </p><br><p>  Inicialmente, se planific칩 la l칩gica m치s simple de la operaci칩n del interruptor, que se presenta en la Figura 1 para ocho tareas. </p><br><p><img src="https://habrastorage.org/webt/ul/ot/pm/ulotpmeuad4zcxqcgroa_t92al0.jpeg"></p><br><p>  En este esquema, las tareas toman su porci칩n de tiempo una por una y solo pueden dar el resto de su tic y, si es necesario, omitir algunas de ellas.  Esta l칩gica demostr칩 ser buena, porque el tama침o cu치ntico puede hacerse peque침o.  Y esto es precisamente lo que se requiere para no plantear urgentemente una tarea para la que acaba de ocurrir una interrupci칩n, y tambi칠n para plantear, y luego reducir su prioridad.  El paquete que se acaba de recibir esperar치 silenciosamente 200-300 microsegundos hasta que su tarea reciba su tic.  Y si tenemos un Cortex-M7 operando a una frecuencia de 216 MHz, entonces 20 microsegundos para un tic es bastante razonable, ya que tomar치 menos de medio microsegundo para cambiar.  Y cualquier tarea del ejemplo anterior nunca tardar치 m치s de 140 microsegundos. </p><br><p>  Sin embargo, con un aumento en el n칰mero de tareas, incluso con un tama침o extremadamente peque침o del tiempo cu치ntico, la demora en el inicio de la actividad de la tarea requerida puede dejar de ser agradable.  En base a esto, y tambi칠n teniendo en cuenta que solo una peque침a parte de las tareas realmente requieren un tiempo real dif칤cil, se decidi칩 modificar ligeramente la l칩gica del interruptor.  Se muestra en la Figura 2. </p><br><p><img src="https://habrastorage.org/webt/iq/gs/qi/iqgsqiqf4zigukr5vvrfi2sbgki.jpeg"></p><br><p>  Ahora seleccionamos solo una parte de las tareas que reciben un cuanto completo, y seleccionamos solo una marca para el resto, en el que se turnan en el juego.  En este caso, la subrutina de inicializaci칩n recibe un par치metro de entrada, a saber, el n칰mero de posici칩n, a partir del cual todas las tareas se ver치n afectadas en los derechos y compartir치n una marca.  Al mismo tiempo, el antiguo esquema permaneci칩 disponible, para esto es suficiente establecer el valor del par치metro en cero o el n칰mero total de tareas.  Los costos de cambio aumentaron con solo unas pocas instrucciones del ensamblador. </p><br><p>  Se utilizan dos esquemas similares para permitir el acceso a recursos compartidos.  El primero, que se mencion칩 en una nota anterior, utiliza varios FIFO (o b칰feres circulares por el n칰mero de productores de mensajes) y una tarea de correspondencia separada.  Est치 dise침ado para comunicarse con el mundo exterior y no requiere expectativas de tareas que generan mensajes.  Solo es necesario asegurarse de que las colas no est칠n llenas. </p><br><p>  El segundo esquema tambi칠n utiliza una tarea separada para permitir el acceso, pero introduce expectativas porque administra el recurso interno en ambas direcciones.  Estas acciones no pueden estar vinculadas al tiempo.  La figura 3 muestra los componentes del segundo circuito. </p><br><p><img src="https://habrastorage.org/webt/-m/fb/4r/-mfb4rum70winng8agin4yqbf3e.jpeg"></p><br><p>  Los elementos principales que contiene son un b칰fer de solicitudes, de acuerdo con el n칰mero de tareas deseadas, y un indicador de acceso.  El funcionamiento de este dise침o es bastante simple.  La tarea de la izquierda env칤a una solicitud de acceso a un lugar especialmente asignado para ello (por ejemplo, la tarea 2 escribe 1 en la Solicitud 2).  Tarea: el despachador selecciona a qui칠n permitir y escribe el n칰mero de la tarea seleccionada en el indicador de resoluci칩n.  La tarea que recibi칩 permiso realiza sus acciones y escribe el signo del final del acceso a la solicitud, el valor 0xFF.  El planificador, al ver que la solicitud se borra, restablece el indicador de permiso, restablece la solicitud anterior y restablece la solicitud de otra tarea. </p><br><p>  Aqu칤 se pueden ver dos proyectos de prueba bajo IAR y una descripci칩n de la placa STM32F3DISCOVERY utilizada.  En el primer proyecto, el ATS303 simplemente verific칩 su rendimiento y lo depur칩.  Todos los LED instalados en esta placa fueron 칰tiles.  Nadie result칩 herido. </p><br><p>  El segundo borrador de BTS303 prob칩 las dos opciones de asignaci칩n de recursos mencionadas.  En 칠l, las tareas 1 y 2 generan mensajes de prueba que son recibidos por el operador.  Para comunicarme con el operador, tuve que agregar una bufanda con un puerto COM TTL, como se muestra en la foto a continuaci칩n. </p><br><p><img src="https://habrastorage.org/webt/za/hh/_c/zahh_cdcuabvgg-o92ukph_feji.jpeg"></p><br><p>  El operador usa un emulador de terminal.  Creo que el lector disculpar치 al autor por el color suave del tubo.  Se ve as칤. </p><br><p><img src="https://habrastorage.org/webt/1r/wa/aj/1rwaajjm2zx_ue2tglhquc7suw4.jpeg"></p><br><p>  Para iniciar todo el sistema, antes de resolver las interrupciones, se requieren pasos preliminares en el cuerpo de la tarea cero main (), que se presentan a continuaci칩n. </p><br><pre><code class="plaintext hljs">void main_start_task_switcher(U8 border); U8 task_run_and_return_task_number((U32)t1_task); U8 task_run_and_return_task_number((U32)t2_task); U8 task_run_and_return_task_number((U32)t3_human_link); U8 task_run_and_return_task_number((U32)t4_human_answer); U8 task_run_and_return_task_number((U32)task_5); U8 task_run_and_return_task_number((U32)task_6); U8 task_run_and_return_task_number((U32)task_7);</code> </pre> <br><p>  En estas l칤neas, el interruptor comienza primero y luego, a su vez, las siete tareas restantes. </p><br><p>  Aqu칤 est치 el conjunto m칤nimo de llamadas necesarias para el trabajo. </p><br><pre> <code class="plaintext hljs"> void task_wake_up_action(U8 taskNumber);</code> </pre> <br><p>  Esta llamada se utiliza en una interrupci칩n de un temporizador de hardware del usuario.  Los desaf칤os de las tareas mismas hablan por s칤 mismos. </p><br><pre> <code class="plaintext hljs"> void release_me_and_set_sleep_steps(U32 ticks); U8 get_my_number(void);</code> </pre><br><p>  Todas estas funciones est치n en el archivo del conmutador ensamblador.  Hay varias funciones m치s que son 칰tiles para las pruebas, pero que no son necesarias. </p><br><p>  En el proyecto BTS303, la tarea 3 recibe comandos del operador desde el exterior y le env칤a las respuestas que provienen de la tarea 4. La tarea 4 recibe los comandos del operador de la tarea 3 y los ejecuta con posibles respuestas.  La tarea 3 tambi칠n recibe mensajes de las tareas 1 y 2 y la env칤a a trav칠s de UART al emulador de terminal (por ejemplo, masilla). </p><br><p>  La tarea 0 (principal) realiza un trabajo auxiliar, por ejemplo, verifica el n칰mero de palabras que no se ven afectadas en el 치rea apilada de cada tarea.  El operador puede solicitar esta informaci칩n y tener una idea del uso de la pila.  Inicialmente, para cada tarea, se asigna un 치rea de pila de 512 bytes (128 palabras) y es necesario monitorear (al menos en la etapa de depuraci칩n) que estas 치reas no se acercan al desbordamiento. </p><br><p>  Las tareas 5 y 6 hacen c치lculos en alguna variable de coma flotante com칰n.  Para hacer esto, solicitan acceso desde la tarea 7. </p><br><p>  Hay otra caracter칤stica adicional que se puede ver en los proyectos de prueba.  Est치 dise침ado para que pueda despertar la tarea no despu칠s de que haya expirado el n칰mero de tics, sino despu칠s de un tiempo espec칤fico, y se ve as칤. </p><br><pre> <code class="plaintext hljs"> void wake_me_up_after_milliSeconds(U32 timeMS);</code> </pre> <br><p>  Para su implementaci칩n, tambi칠n se requiere un temporizador de hardware adicional, que tambi칠n se implementa en casos de prueba. </p><br><p>  Como puede ver, la lista de todas las llamadas necesarias cabe en una p치gina. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461121/">https://habr.com/ru/post/461121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461099/index.html">Juego AirAttack! - nuestra primera experiencia de desarrollo de realidad virtual</a></li>
<li><a href="../461101/index.html">Android Jetpack Compose Primera impresi칩n</a></li>
<li><a href="../461105/index.html">5 complementos 칰tiles para webpack</a></li>
<li><a href="../461107/index.html">Dos칤metro para Seryozha. Parte II Tubos centenarios vs 치tomo pac칤fico</a></li>
<li><a href="../461113/index.html">Cinco a침os de uso de C ++ para proyectos de microcontroladores en producci칩n</a></li>
<li><a href="../461125/index.html">La tarea de crear c칩digos num칠ricos secuenciales para numerar mensajes en el c칩digo fuente en Visual Studio (ej. C #)</a></li>
<li><a href="../461127/index.html">An치lisis de rendimiento de VM en VMware vSphere. Parte 3: Almacenamiento</a></li>
<li><a href="../461129/index.html">Sobre kote, esposa, dos hijos, la idea ... y no solo. Historia con continuaci칩n</a></li>
<li><a href="../461131/index.html">Carro carro ROS Parte 2. Software</a></li>
<li><a href="../461133/index.html">Probar el c칩digo de SQL Server con tSQLt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>