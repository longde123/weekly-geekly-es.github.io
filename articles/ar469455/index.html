<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛠️ 👨🏻‍🚀 😐 الترحيل من Nginx إلى مبعوث Proxy 🚶🏿 🔊 💅🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="مرحبا يا هبر! أوجه انتباهكم إلى ترجمة المنشور : الترحيل من Nginx إلى Envoy Proxy . 


 Envoy هو خادم وكيل موزع عالي الأداء (مكتوب في C ++) مصمم للخدما...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>الترحيل من Nginx إلى مبعوث Proxy</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469455/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  مرحبا يا هبر!  أوجه انتباهكم إلى ترجمة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">المنشور</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الترحيل من Nginx إلى Envoy Proxy</a> . </p><br><p style=";text-align:right;direction:rtl">  Envoy هو خادم وكيل موزع عالي الأداء (مكتوب في C ++) مصمم للخدمات والتطبيقات الفردية ، كما أنه ناقل اتصال و "طائرة بيانات عالمية" تم تصميمها لبنيات "شبكة الخدمة" الكبيرة التي تقدمها خدمات microservice.  عند إنشائه ، تم الأخذ في الاعتبار حلول المشكلات التي نشأت أثناء تطوير خوادم مثل NGINX و HAProxy وموازنات تحميل الأجهزة وموازنات تحميل السحابة.  يعمل Envoy مع كل تطبيق ويلخص الشبكة ، ويوفر وظائف مشتركة بغض النظر عن النظام الأساسي.  عندما تمر جميع حركات المكاتب في البنية التحتية عبر شبكة Envoy ، يصبح من السهل تصور مناطق المشكلات التي تتميز بالملاحظة المتسقة ، وضبط الأداء الكلي ، وإضافة الوظائف الأساسية في موقع معين. </p><br><h2 id="vozmozhnosti" style=";text-align:right;direction:rtl">  الاحتمالات </h2><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> خارج بنية العملية: المبعوث هو خادم مستقل وعالي الأداء يستهلك كمية صغيرة من ذاكرة الوصول العشوائي.  وهو يعمل جنبا إلى جنب مع أي لغة التطبيق أو الإطار. </li><li style=";text-align:right;direction:rtl">  دعم http / 2 و grpc: لدى المبعوث دعم من الدرجة الأولى لـ http / 2 و grpc للاتصالات الواردة والصادرة.  هذا وكيل شفاف من http / 1.1 إلى http / 2. </li><li style=";text-align:right;direction:rtl">  موازنة الحمل المحسّنة: يدعم المبعوث ميزات موازنة التحميل المتقدمة ، بما في ذلك المحاولات التلقائية والدائرة المفتوحة والحد الأقصى للسرعة العالمية وطلبات التظليل وموازنة تحميل المنطقة المحلية وما إلى ذلك. </li><li style=";text-align:right;direction:rtl">  واجهة برمجة تطبيقات إدارة التكوين: يوفر envoy واجهة برمجة تطبيقات قوية لإدارة التكوين الخاص به ديناميكيًا. </li><li style=";text-align:right;direction:rtl">  قابلية الملاحظة: ملاحظة عميقة لحركة مرور L7 ، دعم مدمج للتتبع الموزع وملاحظة mongodb و dynamodb والعديد من التطبيقات الأخرى. </li></ul><a name="habracut"></a><br><h2 id="shag-1---primer-konfiga-nginx" style=";text-align:right;direction:rtl">  الخطوة 1 - مثال NGINX Config </h2><br><p style=";text-align:right;direction:rtl">  يستخدم هذا البرنامج النصي ملف <em>nginx.conf</em> تم إنشاؤه خصيصًا ، استنادًا إلى مثال كامل من <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">NGINX Wiki</a> .  يمكنك عرض التكوين في المحرر عن طريق فتح <em>nginx.conf</em> </p><br><p style=";text-align:right;direction:rtl">  مصدر التكوين nginx </p><br><pre style=";text-align:right;direction:rtl"><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> www www; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">gzip</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_min_length</span></span> <span class="hljs-number"><span class="hljs-number">1100</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_buffers</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">8k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_types</span></span> text/plain; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$gzip_ratio</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> download <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_range</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sent_http_content_range</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx.access_log main; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx.error_log <span class="hljs-literal"><span class="hljs-literal">info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; } } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  عادة ما تحتوي تكوينات NGINX على ثلاثة عناصر رئيسية: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  تكوين خادم NGINX وهيكل السجل ووظائف Gzip.  يتم تحديد هذا على الصعيد العالمي في جميع الحالات. </li><li style=";text-align:right;direction:rtl">  تهيئة NGINX لقبول الطلبات الخاصة <em>بمضيف one.example.com</em> على المنفذ 8080. </li><li style=";text-align:right;direction:rtl">  تحديد موقع وجهتك ، وكيفية التعامل مع حركة المرور لأجزاء مختلفة من URL. </li></ol><br><p style=";text-align:right;direction:rtl">  لن يتم تطبيق كل التهيئة على Envoy Proxy ، ولن تحتاج إلى تكوين بعض الإعدادات.  يحتوي Envoy Proxy على <strong>أربعة أنواع رئيسية</strong> تدعم البنية التحتية الأساسية التي تقدمها NGINX.  جوهر هو: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>المستمعون:</strong> يقررون كيف يقبل Envoy Proxy الطلبات الواردة.  يدعم Envoy Proxy حاليًا المستمعين المعتمدين على TCP فقط.  بمجرد إنشاء الاتصال ، يتم نقله إلى مجموعة من المرشحات للمعالجة. </li><li style=";text-align:right;direction:rtl">  <strong>عوامل التصفية:</strong> هي جزء من بنية خطوط أنابيب يمكنها معالجة البيانات الواردة والصادرة.  تتضمن هذه الوظيفة عوامل تصفية ، مثل Gzip ، التي تضغط البيانات قبل إرسالها إلى العميل. </li><li style=";text-align:right;direction:rtl">  <strong>أجهزة التوجيه:</strong> يقومون بإعادة توجيه حركة المرور إلى الوجهة المطلوبة ، والمعروفة على أنها كتلة. </li><li style=";text-align:right;direction:rtl">  <strong>الكتل:</strong> وهي تحدد نقطة النهاية لإعدادات المرور والتكوين. </li></ul><br><p style=";text-align:right;direction:rtl">  سوف نستخدم هذه المكونات الأربعة لإنشاء تكوين Envoy Proxy لمطابقة تكوين NGINX المحدد.  هدف Envoy هو العمل مع API والتكوين الديناميكي.  في هذه الحالة ، سيستخدم التكوين الأساسي معلمات ثابتة مشفرة من NGINX. </p><br><h2 id="shag-2---konfiguraciya-nginx" style=";text-align:right;direction:rtl">  الخطوة 2 - تكوين NGINX </h2><br><p style=";text-align:right;direction:rtl">  يحدد الجزء الأول من <em>nginx.conf</em> بعض مكونات NGINX الداخلية التي تحتاج إلى تكوين. </p><br><h4 id="worker-connections-rabochie-soedineniya" style=";text-align:right;direction:rtl">  اتصالات العمال </h4><br><p style=";text-align:right;direction:rtl">  يحدد التكوين أدناه عدد عمليات العمل والاتصالات.  يشير هذا إلى كيفية تحجيم NGINX لتلبية الطلب. </p><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يقوم Envoy Proxy بإدارة مهام سير العمل والاتصالات بشكل مختلف. </p><br><p style=";text-align:right;direction:rtl">  ينشئ المبعوث سير عمل لكل مؤشر ترابط الأجهزة في النظام.  يعمل كل مؤشر ترابط عامل حلقة حدث غير حظر مسؤولاً عن </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  الاستماع إلى كل مستمع </li><li style=";text-align:right;direction:rtl">  قبول اتصالات جديدة </li><li style=";text-align:right;direction:rtl">  إنشاء مجموعة مرشح للاتصال </li><li style=";text-align:right;direction:rtl">  معالجة جميع عمليات الإدخال / الإخراج على مدى عمر الاتصال. </li></ol><br><p style=";text-align:right;direction:rtl">  تتم معالجة معالجة الاتصال الإضافية بالكامل في سير العمل ، بما في ذلك أي سلوك إعادة توجيه. </p><br><p style=";text-align:right;direction:rtl">  لكل سير عمل في Envoy ، يوجد اتصال في التجمع.  وبالتالي ، تنشئ تجمعات اتصال HTTP / 2 اتصالًا واحدًا لكل مضيف خارجي في كل مرة ؛ وإذا كان هناك أربعة مؤشرات ترابط تابعة ، فسيكون هناك أربعة اتصالات HTTP / 2 لكل مضيف خارجي في حالة مستقرة.  من خلال تخزين كل شيء في سير عمل واحد ، يمكن كتابة جميع الشفرات تقريبًا دون قفل ، كما لو كانت مترابطة.  إذا تم تخصيص أكثر من سير العمل الضروري ، فقد يؤدي ذلك إلى استخدام غير منطقي للذاكرة ، وإنشاء عدد كبير من الاتصالات الخاملة وتقليل عدد الاتصالات التي تم إرجاعها إلى التجمع. </p><br><p style=";text-align:right;direction:rtl">  لمزيد من المعلومات ، تفضل بزيارة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مدونة Envoy Proxy</a> . </p><br><h4 id="konfiguraciya-http" style=";text-align:right;direction:rtl">  تكوين HTTP </h4><br><p style=";text-align:right;direction:rtl">  تعرّف كتلة تكوين NGINX التالية إعدادات HTTP ، مثل: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ما أنواع التمثيل الصامت المدعومة </li><li style=";text-align:right;direction:rtl">  المهلات الافتراضية </li><li style=";text-align:right;direction:rtl">  تكوين Gzip </li></ul><br><p style=";text-align:right;direction:rtl">  يمكنك تكوين هذه الجوانب باستخدام المرشحات في Envoy Proxy ، والتي سنناقشها لاحقًا. </p><br><h2 id="shag-3---konfiguraciya-server" style=";text-align:right;direction:rtl">  الخطوة 3 - تكوين الخادم </h2><br><p style=";text-align:right;direction:rtl">  في كتلة تكوين HTTP ، يرشدك تكوين NGINX إلى الاستماع على المنفذ 8080 والرد على الطلبات الواردة <em>للنطاقين one.example.com</em> و <em>www.one.example.com</em> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com;</code> </pre> <br><p style=";text-align:right;direction:rtl">  داخل المبعوث ، المستمعون السيطرة عليه. </p><br><h4 id="slushateli-envoy" style=";text-align:right;direction:rtl">  المستمعين المبعوث </h4><br><p style=";text-align:right;direction:rtl">  يتمثل الجانب الأكثر أهمية في بدء استخدام Envoy Proxy في تحديد المستمعين.  تحتاج إلى إنشاء ملف تكوين يصف كيف تريد تشغيل مثيل Envoy. </p><br><p style=";text-align:right;direction:rtl">  سينشئ المقتطف الموجود أدناه مستمعًا جديدًا ويربطه بالمنفذ 8080. يخبر التكوين Envoy Proxy بالمنافذ التي يجب ربطها بالطلبات الواردة. </p><br><p style=";text-align:right;direction:rtl">  يستخدم Envoy Proxy تدوين YAML لتكوينه.  للتعرف على هذا الترميز ، راجع <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الرابط</a> هنا. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Copy to Editorstatic_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ليست هناك حاجة لتعريف <em>server_name</em> ، حيث يمكن لعوامل التصفية Envoy Proxy معالجة ذلك. </p><br><h2 id="shag-4---konfiguraciya-mestopolozheniya" style=";text-align:right;direction:rtl">  الخطوة 4 - تكوين الموقع </h2><br><p style=";text-align:right;direction:rtl">  عندما يصل طلب إلى NGINX ، تحدد كتلة الموقع كيفية معالجة ومكان توجيه حركة المرور.  في الجزء التالي ، يتم نقل كل حركة المرور إلى الموقع إلى كتلة upstream (ملاحظة المترجم: upstream عادة ما تكون خادم تطبيقات) تسمى <em>targetCluster</em> .  تعرّف الكتلة upstream العقد التي يجب معالجة الطلب.  سنناقش هذا في الخطوة التالية. </p><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  في المبعوث ، فلاتر يفعل هذا. </p><br><h4 id="envoy-filters" style=";text-align:right;direction:rtl">  مرشحات المبعوث </h4><br><p style=";text-align:right;direction:rtl">  بالنسبة للتكوين الثابت ، تحدد المرشحات كيفية التعامل مع الطلبات الواردة.  في هذه الحالة ، قمنا بتعيين عوامل تصفية تتطابق مع <em>اسم الخادم</em> في الخطوة السابقة.  عند وصول الطلبات الواردة التي تتوافق مع مجالات ومسارات محددة ، يتم توجيه حركة المرور إلى الكتلة.  هذا هو ما يعادل التكوين المنبع NGINX. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Copy to Editor filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router</code> </pre> <br><p style=";text-align:right;direction:rtl">  اسم <em>envoy.http_connection_manager</em> هو عامل تصفية مضمن في وكيل Envoy.  وتشمل المرشحات الأخرى <em>Redis</em> ، <em>Mongo</em> ، <em>TCP</em> .  يمكنك العثور على القائمة الكاملة في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الوثائق</a> . </p><br><p style=";text-align:right;direction:rtl">  لمزيد من المعلومات حول سياسات موازنة التحميل الأخرى ، تفضل بزيارة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وثائق المبعوث</a> . </p><br><h2 id="step-5---proxy-and-upstream-configuration" style=";text-align:right;direction:rtl">  الخطوة 5 - تكوين الوكيل والباقي </h2><br><p style=";text-align:right;direction:rtl">  في NGINX ، يحدد التكوين الأساسي مجموعة الخوادم الهدف التي ستتعامل مع حركة المرور.  في هذه الحالة ، تم تعيين مجموعتين. </p><br><pre style=";text-align:right;direction:rtl"> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  في المبعوث ، يتم إدارة الكتلة. </p><br><h4 id="envoy-clusters" style=";text-align:right;direction:rtl">  مجموعات المبعوثين </h4><br><p style=";text-align:right;direction:rtl">  يتم تعريف المكافئ المنبع كمجموعات.  في هذه الحالة ، تم تحديد المضيفين الذين سيخدمون حركة المرور.  يتم تعريف طريقة الوصول إلى المضيفين ، مثل المهلة ، على أنها تكوين كتلة.  يتيح لك ذلك التحكم بدقة أكبر في جوانب مثل زمن الاستجابة وموازنة التحميل. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Copy to Editor clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ]</code> </pre> <br><p style=";text-align:right;direction:rtl">  عند استخدام <em>اكتشاف</em> خدمة <em>STRICT_DNS ،</em> سيقوم Envoy بحل أهداف DNS المحددة بشكل مستمر وغير متزامن.  سيتم اعتبار كل عنوان IP تم إرجاعه نتيجة DNS مضيفًا صريحًا في نظام المجموعة الأولية.  هذا يعني أنه في حالة إرجاع الطلب لعناوين IP ، سوف يفترض Envoy أن هناك مضيفين في الكتلة ، ويجب أن يكون كلاهما متوازنين في التحميل.  إذا تمت إزالة المضيف من النتيجة ، يفترض Envoy أنه لم يعد موجودًا وسيختار حركة المرور من أي تجمعات اتصال موجودة. </p><br><p style=";text-align:right;direction:rtl">  لمزيد من المعلومات ، راجع <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وثائق وكيل المبعوث</a> . </p><br><h2 id="shag-6---dostup-k-zhurnalu-i-oshibki" style=";text-align:right;direction:rtl">  الخطوة 6 - تسجيل الدخول والأخطاء </h2><br><p style=";text-align:right;direction:rtl">  التكوين النهائي هو التسجيل.  بدلاً من نقل سجلات الأخطاء إلى القرص ، يستخدم Envoy Proxy نهجًا يستند إلى مجموعة النظراء.  يتم عرض جميع سجلات التطبيق في <em>stdout</em> و <em>stderr</em> . </p><br><p style=";text-align:right;direction:rtl">  عندما يقوم المستخدمون بتقديم طلب ، تكون سجلات الوصول اختيارية ويتم تعطيلها افتراضيًا.  لتمكين سجلات الوصول لطلبات HTTP ، قم بتمكين تكوين <em>access_log</em> لـ HTTP Connection Manager.  يمكن أن يكون المسار إما جهازًا ، مثل <em>stdout</em> أو ملفًا على القرص ، وفقًا لمتطلباتك. </p><br><p style=";text-align:right;direction:rtl">  التكوين التالي سيعيد توجيه جميع سجلات الوصول إلى <em>stdout</em> (ملاحظة المترجم - stdout ضرورية لاستخدام المبعوث داخل عامل ميناء. إذا كنت تستخدم دون عامل ميناء ، فاستبدل / dev / stdout بالمسار إلى ملف السجل العادي).  انسخ المقتطف إلى قسم التكوين لمدير الاتصال: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Copy to Clipboardaccess_log: - name: envoy.file_access_log config: path: "/dev/stdout"</code> </pre> <br><p style=";text-align:right;direction:rtl">  يجب أن تبدو النتائج كما يلي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http access_log: - name: envoy.file_access_log config: path: "/dev/stdout" route_config:</code> </pre> <br><p style=";text-align:right;direction:rtl">  بشكل افتراضي ، يحتوي Envoy على سلسلة تنسيق تتضمن تفاصيل طلب HTTP: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n</code> </pre> <br><p style=";text-align:right;direction:rtl">  نتيجة سلسلة التنسيق هذه: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">[2018-11-23T04:51:00.281Z] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 - 0 58 4 1 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"curl/7.47.0"</span></span> <span class="hljs-string"><span class="hljs-string">"f21ebd42-6770-4aa5-88d4-e56118165a7d"</span></span> <span class="hljs-string"><span class="hljs-string">"one.example.com"</span></span> <span class="hljs-string"><span class="hljs-string">"172.18.0.4:80"</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكن تخصيص محتويات الإخراج عن طريق تعيين حقل التنسيق.  على سبيل المثال: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" format: "[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n"</code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكن أيضًا إخراج سلسلة السجل بتنسيق JSON عن طريق تعيين حقل <em>json_format</em> .  على سبيل المثال: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" json_format: {"protocol": "%PROTOCOL%", "duration": "%DURATION%", "request_method": "%REQ(:METHOD)%"}</code> </pre> <br><p style=";text-align:right;direction:rtl">  لمزيد من المعلومات حول تقنيات تسجيل المبعوث ، تفضل بزيارة </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://www.envoyproxy.io/docs/envoy/latest/configuration/access_log#config-access-log-format-dictionaries</a> </p><br><p style=";text-align:right;direction:rtl">  التسجيل ليس هو الطريقة الوحيدة للحصول على فكرة عن العمل مع Envoy Proxy.  يحتوي على ميزات متقدمة مضمّنة للبحث عن المفقودين ومقاييس.  يمكنك معرفة المزيد في <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">وثائق التتبع</a> أو من خلال برنامج <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">التتبع التفاعلي</a> . </p><br><h2 id="shag-7---zapusk" style=";text-align:right;direction:rtl">  الخطوة 7 - إطلاق </h2><br><p style=";text-align:right;direction:rtl">  لقد قمت الآن بنقل التكوين من NGINX إلى Envoy Proxy.  الخطوة الأخيرة هي تشغيل مثيل لـ Envoy Proxy لاختباره. </p><br><h4 id="zapusk-ot-polzovatelya" style=";text-align:right;direction:rtl">  تشغيل من المستخدم </h4><br><p style=";text-align:right;direction:rtl">  في الجزء العلوي من تكوين NGINX ، <em>المستخدم</em> الخط <em>www www؛</em>  يشير إلى أن NGINX تم إطلاقها كمستخدم لديه امتيازات منخفضة لتعزيز الأمان. </p><br><p style=";text-align:right;direction:rtl">  يتخذ Envoy Proxy نهجا يستند إلى مجموعة النظراء لإدارة من يملك العملية.  عندما نقوم بتشغيل Envoy Proxy عبر الحاوية ، يمكننا تحديد مستخدم بمستوى امتياز منخفض. </p><br><h4 id="zapusk-envoy-proxy" style=";text-align:right;direction:rtl">  إطلاق وكيل Envoy </h4><br><p style=";text-align:right;direction:rtl">  سيقوم الأمر أدناه بتشغيل Envoy Proxy عبر حاوية Docker على المضيف.  يوفر هذا الأمر لـ Envoy القدرة على الاستماع للطلبات الواردة عبر المنفذ 80. ومع ذلك ، كما هو موضح في تكوين المستمع ، يستمع Envoy Proxy لحركة المرور الواردة عبر المنفذ 8080. وهذا يسمح للعملية كمستخدم ذي امتيازات منخفضة. </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">docker run --name proxy1 -p 80:8080 --user 1000:1000 -v /root/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy</code> </pre> <br><h4 id="testirovanie" style=";text-align:right;direction:rtl">  تجريب </h4><br><p style=";text-align:right;direction:rtl">  مع تشغيل الوكلاء ، يمكن الآن إجراء الاختبارات ومعالجتها.  يصدر الأمر cURL التالي طلبًا باستخدام رأس المضيف المحدد في تكوين الخادم الوكيل. </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p style=";text-align:right;direction:rtl">  سينتج عن طلب HTTP خطأ <em>503</em> .  هذا يرجع إلى حقيقة أن الاتصالات المنبع لا تعمل وأنها غير متوفرة.  وبالتالي ، لا يحتوي Envoy Proxy على أي وجهات مستهدفة متاحة للطلب.  سيُطلق الأمر التالي سلسلة من خدمات HTTP تتطابق مع التكوين المحدد لـ Envoy. </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">docker run -d katacoda/docker-http-server; docker run -d katacoda/docker-http-server;</code> </pre> <br><p style=";text-align:right;direction:rtl">  مع الخدمات المتاحة ، يمكن لـ Envoy نقل حركة المرور إلى وجهتها بنجاح. </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p style=";text-align:right;direction:rtl">  سترى استجابة تشير إلى أي حاوية Docker عالجت الطلب.  في سجلات Envoy Proxy ، يجب أن تشاهد أيضًا سلسلة الوصول المعروضة. </p><br><h4 id="dopolnitelnye-zagolovki-otveta-http-http-response" style=";text-align:right;direction:rtl">  رؤوس استجابة HTTP إضافية </h4><br><p style=";text-align:right;direction:rtl">  سترى رؤوس HTTP إضافية في رؤوس الاستجابة للطلب الفعلي.  يعرض رأس الوقت الذي يقضيه المضيف upstream معالجة الطلب.  يتم التعبير عنها بالمللي ثانية.  يعد هذا مفيدًا إذا كان العميل يريد تحديد وقت الخدمة مقارنة بوقت انتقال الشبكة. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">x-envoy-upstream-service-time: 0 server: envoy</code> </pre> <br><h2 id="itogovyy-konfig" style=";text-align:right;direction:rtl">  التكوين النهائي </h2><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">static_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 } filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ] admin: access_log_path: /tmp/admin_access.log address: socket_address: { address: 0.0.0.0, port_value: 9090 }</code> </pre> <br><h2 id="dopolnitelnaya-informaciya-ot-perevodchika" style=";text-align:right;direction:rtl">  معلومات إضافية من المترجم </h2><br><p style=";text-align:right;direction:rtl">  يمكن العثور على تعليمات تثبيت وكيل Envoy على <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://www.getenvoy.io/</a> </p><br><p style=";text-align:right;direction:rtl">  بشكل افتراضي في دورة في الدقيقة ، لا يوجد تكوين خدمة systemd. </p><br><p style=";text-align:right;direction:rtl">  أضف تهيئة خدمة systemd /etc/systemd/system/envoy.service: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">[Unit] Description=Envoy Proxy Documentation=https://www.envoyproxy.io/ After=network-online.target Requires=envoy-auth-server.service Wants=nginx.service [Service] User=root Restart=on-failure ExecStart=/usr/bin/envoy --config-path /etc/envoy/config.yaml [Install] WantedBy=multi-user.target</code> </pre> <br><p style=";text-align:right;direction:rtl">  تحتاج إلى إنشاء الدليل / etc / envoy / ووضع config.yaml config هناك. </p><br><p style=";text-align:right;direction:rtl">  بواسطة المبعوث الوكيل هناك دردشة برقية: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://t.me/envoyproxy_ru</a> </p><br><p style=";text-align:right;direction:rtl">  لا يدعم Envoy Proxy توزيع المحتوى الثابت.  من يمكنه التصويت لصالح: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">https://github.com/envoyproxy/envoy/issues/378</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar469455/">https://habr.com/ru/post/ar469455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar469445/index.html">نظرة عامة على AngularConnect 2019. الجزء 2</a></li>
<li><a href="../ar469447/index.html">طريق الذكاء الاصطناعي من فكرة رائعة إلى الصناعة العلمية</a></li>
<li><a href="../ar469449/index.html">شهادات EV SSL: هل هناك حياة بعد الموت؟</a></li>
<li><a href="../ar469451/index.html">فلسفة الصفر</a></li>
<li><a href="../ar469453/index.html">إدارة فريق موزع في وضع المشاريع المتعددة (تقرير المراجعة والفيديو)</a></li>
<li><a href="../ar469457/index.html">حيث يؤدي الروعة</a></li>
<li><a href="../ar469459/index.html">توصيل أجهزة إنترنت الأشياء في المدينة الذكية</a></li>
<li><a href="../ar469461/index.html">"إلى النجوم": معاداة الكونية "نهاية العالم اليوم"</a></li>
<li><a href="../ar469463/index.html">الاتجاهات والتوقعات في معالجة اللغة الطبيعية</a></li>
<li><a href="../ar469465/index.html">التهيئة في C ++ الحديثة</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>