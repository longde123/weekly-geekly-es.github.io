<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛐 😣 👨🏻‍💻 Alles was Sie über Node.js wissen müssen 👧🏾 ♟️ 👫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Ich präsentiere Ihnen die Übersetzung des Artikels "Alles, was Sie über Node.js wissen müssen" von Jorge Ramón. 





 Heutzutage ist die ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Alles was Sie über Node.js wissen müssen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460661/"><p>  Hallo Habr!  Ich präsentiere Ihnen die Übersetzung des Artikels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"Alles, was Sie über Node.js wissen müssen"</a> von Jorge Ramón. </p><br><p><img src="https://habrastorage.org/webt/ua/qz/gr/uaqzgrarpig3cxhjdiuiutbxbms.jpeg"></p><br><p>  Heutzutage ist die Node.js-Plattform eine der beliebtesten Plattformen zum Erstellen effizienter und skalierbarer REST-APIs.  Es eignet sich auch zum Erstellen hybrider mobiler Anwendungen, Desktop-Programme und sogar für IoT. </p><br><p>  Ich arbeite seit über 6 Jahren mit der Node.js-Plattform und ich liebe sie wirklich.  Dieser Beitrag versucht hauptsächlich, eine Anleitung zu geben, wie Node.js tatsächlich funktioniert. </p><a name="habracut"></a><br><p>  Lass uns anfangen !! </p><br><p>  <strong>Was wird diskutiert:</strong> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Welt vor Node.js.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Problem C10K</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Node.js und die Ereignisschleife</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Problem der CPU-intensiven Aufgaben</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arbeiter und ihre Ströme</a> </li></ul><br><a name="p1"></a><br><h3 id="mir-do-nodejs">  Welt vor Node.js. </h3><br><p>  <strong>Multithread-Server</strong> </p><br><p>  Webanwendungen, die gemäß der Client / Server-Architektur geschrieben wurden, funktionieren wie folgt: Der Client fordert die erforderliche Ressource vom Server an und der Server sendet die Ressource als Antwort.  In diesem Schema antwortet der Server auf die Anforderung und beendet die Verbindung. </p><br><p>  Dieses Modell ist effektiv, da jede Anforderung an den Server Ressourcen (Speicher, Prozessorzeit usw.) verbraucht.  Um jede nachfolgende Anforderung vom Client zu verarbeiten, muss der Server die Verarbeitung der vorherigen Anforderung abschließen. </p><br><p>  Bedeutet dies, dass der Server jeweils nur eine Anforderung verarbeiten kann?  Nicht wirklich!  Wenn der Server eine neue Anforderung empfängt, erstellt er einen separaten <strong>Thread</strong> für die Verarbeitung. </p><br><p>  <em>Der Fluss</em> ist in einfachen Worten die Zeit und die Ressourcen, die die CPU für die Ausführung eines kleinen Befehlsblocks bereitstellt.  Trotzdem kann der Server mehrere Anforderungen gleichzeitig verarbeiten, jedoch nur eine pro Thread.  Ein solches Modell wird auch als <strong>Thread-per-Request-Modell bezeichnet</strong> . </p><br><p><img src="https://habrastorage.org/webt/mm/ns/gn/mmnsgnzvz7aptv62xrbo6zxju-w.jpeg"></p><br><p>  Um N Anforderungen zu verarbeiten, benötigt der Server N Threads.  Wenn der Server N + 1-Anforderungen empfängt, muss er warten, bis einer der Threads verfügbar wird. </p><br><p>  In der obigen Abbildung kann der Server bis zu 4 Anforderungen (Threads) gleichzeitig verarbeiten. Wenn er die nächsten 3 Anforderungen empfängt, müssen diese Anforderungen warten, bis einer dieser 4 Threads verfügbar wird. </p><br><p>  Eine Möglichkeit, die Einschränkungen zu beseitigen, besteht darin, dem Server weitere Ressourcen (Speicher, Prozessorkerne usw.) hinzuzufügen. Dies ist jedoch nicht die beste Lösung. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/qz/zl/ybqzzljzkgej-kirqwza-43amcw.gif"></div><br><p>  Und vergessen Sie natürlich nicht die technologischen Einschränkungen. </p><br><p>  <strong>Ein- / Ausgabe blockieren</strong> </p><br><p>  Die begrenzte Anzahl von Threads auf dem Server ist nicht das einzige Problem.  Vielleicht haben Sie sich gefragt, warum ein einzelner Thread nicht mehrere Anforderungen gleichzeitig verarbeiten kann?  Alles aufgrund des <strong>Blockierens von E / A-Vorgängen</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/ao/02/eiao02s-dtpki8au6sybf8-dmbu.gif"></div><br><p>  Angenommen, Sie entwickeln einen Online-Shop und benötigen eine Seite, auf der der Benutzer eine Liste aller Produkte anzeigen kann. </p><br><p>  Der Benutzer klopft an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">http://yourstore.com/products</a> und der Server rendert als Antwort eine HTML-Datei mit allen Produkten aus der Datenbank.  Gar nicht kompliziert, oder? </p><br><p>  Aber was passiert hinter den Kulissen? </p><br><ul><li> Wenn ein Benutzer an <code>/products</code> klopft <code>/products</code> bestimmte Methode oder Funktion ausgeführt werden, um die Anforderung zu verarbeiten.  Ein kleiner Code (Ihr oder Ihr Framework) analysiert die Anforderungs-URL und sucht nach einer geeigneten Methode oder Funktion.  <strong>Der Stream läuft</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Nun wird die gewünschte Methode oder Funktion ausgeführt, wie im ersten Absatz <strong>funktioniert</strong> der <strong>Thread.</strong> <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Da Sie ein guter Entwickler sind, speichern Sie alle Systemprotokolle in einer Datei. Um sicherzustellen, dass der Router die gewünschte Methode / Funktion ausführt, protokollieren Sie natürlich auch die Zeile „Methode X wird ausgeführt !!“, aber alle diese blockieren Vorgänge Eingabe- / Ausgabestream <strong>wartet</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Alle Protokolle werden gespeichert und die folgenden Funktionszeilen ausgeführt.  <strong>Der Thread funktioniert wieder</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Zeit, auf die Datenbank zuzugreifen und alle Produkte <code>SELECT * FROM products</code> - eine einfache Abfrage wie <code>SELECT * FROM products</code> erledigt ihre Aufgabe, aber wissen Sie was?  Ja, dies ist eine blockierende E / A-Operation.  <strong>Der Stream wartet</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Sie haben ein Array oder eine Liste aller Produkte erhalten, stellen jedoch sicher, dass Sie dies alles zugesagt haben.  <strong>Der Stream wartet</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Jetzt haben Sie alle Produkte und es ist Zeit, die Vorlage für die zukünftige Seite zu rendern, aber vorher müssen Sie sie lesen.  <strong>Der Stream wartet</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Die Rendering-Engine erledigt ihre Aufgabe und sendet eine Antwort an den Client.  <strong>Der Thread funktioniert wieder</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Der Fluss ist frei wie ein Vogel am Himmel. <img width="20" src="https://habrastorage.org/webt/wr/vg/0_/wrvg0_hul5qltn9qpyg9fv6beua.png"></li></ul><br><p>  Wie langsam sind E / A-Vorgänge?  Nun, es kommt auf das Spezifische an.  Schauen wir uns die Tabelle an: </p><br><div class="scrollable-table"><table><tbody><tr><th>  <b>Bedienung</b> </th><th>  <b>CPU-Zyklen</b> </th></tr><tr><td>  CPU-Register </td><td>  3 Maßnahmen </td></tr><tr><td>  L1-Cache </td><td>  8 Maßnahmen </td></tr><tr><td>  L2-Cache </td><td>  12 Maßnahmen </td></tr><tr><td>  RAM </td><td>  150 Maßnahmen </td></tr><tr><td>  Festplatte </td><td>  30.000.000 Maßnahmen </td></tr><tr><td>  Netzwerk </td><td>  250.000.000 Maßnahmen </td></tr></tbody></table></div><br><p>  Netzwerk- und Festplattenlesevorgänge sind zu langsam.  Stellen Sie sich vor, wie viele Anforderungen oder Aufrufe an externe APIs Ihr System während dieser Zeit verarbeiten könnte. </p><br><p>  Zusammenfassend lässt sich sagen, dass E / A-Vorgänge den Thread warten lassen und Ressourcen verschwenden. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/qm/k1/bgqmk13cgzyfg7vmynzpkxdxbdc.gif"></div><br><a name="p2"></a><br><h3 id="problema-c10k">  Problem C10K </h3><br><p>  <strong>Das Problem</strong> </p><br><p>  <b>C10k</b> (dt. <i>C10k; 10k Verbindungen</i> - 10 Tausend Verbindungsproblem) </p><br><p>  In den frühen 2000er Jahren waren Server- und Client-Computer langsam.  Das Problem trat auf, wenn 10.000 Clientverbindungen zu demselben Computer parallel verarbeitet wurden. </p><br><p>  Aber warum konnte das herkömmliche Thread-per-Request-Modell (Thread auf Anfrage) dieses Problem nicht lösen?  Nun, lassen Sie uns ein wenig Mathe verwenden. </p><br><p>  Die native Implementierung von Threads weist mehr als 1 MB Arbeitsspeicher pro Stream zu, so dass für 10.000 Threads 10 GB RAM erforderlich sind, und dies gilt nur für den Stream-Stack.  Ja, und vergessen Sie nicht, wir sind in den frühen 2000ern !! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/99/xc/af99xcxnykot0wq-zv20o-6cvps.jpeg"></div><br><p>  Heutzutage arbeiten Server- und Clientcomputer schneller und effizienter, und fast jede Programmiersprache oder jedes Framework kann dieses Problem bewältigen.  Tatsächlich ist das Problem jedoch nicht gelöst.  Bei 10 Millionen Clientverbindungen zu einem Computer tritt das Problem erneut auf (jetzt ist es das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">C10M-Problem</a> ). </p><br><p>  <strong>JavaScript-Rettung?</strong> </p><br><p>  Vorsicht Spoiler <img width="70" src="https://habrastorage.org/webt/vl/iw/8n/vliw8nxrmg8paobiiyvuozjxpdc.png">  !!! <br>  Node.js löst tatsächlich das C10K-Problem ... aber wie ?! </p><br><p>  Serverseitiges JavaScript war in den frühen 2000er Jahren nichts Neues und Ungewöhnliches. Zu dieser Zeit gab es bereits Implementierungen auf der JVM (Java Virtual Machine) - RingoJS und AppEngineJS, die am Thread-per-Request-Modell arbeiteten. </p><br><p>  Aber wenn sie das Problem nicht lösen könnten, wie könnte dann Node.js ?!  Alles nur, weil JavaScript <strong>Single-Threaded ist</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/nx/vh/lpnxvhxjbmqmkzmblpqqmfcxq0s.gif"></div><br><a name="p3"></a><br><h3 id="nodejs-i-cikl-sobytiy">  Node.js und die Ereignisschleife </h3><br><p>  <strong>Node.js</strong> </p><br><p>  Node.js ist eine Serverplattform, die auf der Google Chrome Engine - V8 ausgeführt wird und JavaScript-Code in Maschinencode kompilieren kann. </p><br><p>  Node.js verwendet ein <strong>ereignisgesteuertes</strong> Modell und eine <strong>nicht blockierende E / A-</strong> Architektur, wodurch es leicht und effizient ist.  Dies ist weder ein Framework noch eine Bibliothek, sondern eine JavaScript-Laufzeit. </p><br><p>  Schreiben wir ein kleines Beispiel: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Importing native http module const http = require('http'); // Creating a server instance where every call // the message 'Hello World' is responded to the client const server = http.createServer(function(request, response) { response.write('Hello World'); response.end(); }); // Listening port 8080 server.listen(8080);</span></span></code> </pre> <br><p>  <strong>Nicht blockierende E / A.</strong> </p><br><p>  Node.js verwendet nicht blockierende Eingabe- / Ausgabeoperationen. Was bedeutet das: </p><br><ul><li>  Der Hauptthread wird nicht durch E / A-Vorgänge blockiert. </li><li>  Der Server wird weiterhin Anforderungen bearbeiten. </li><li>  Wir müssen mit <strong>asynchronem Code arbeiten</strong> . </li></ul><br><p>  Schreiben wir ein Beispiel, in dem der Server eine HTML-Seite als Antwort auf eine Anfrage an <code>/home</code> und für alle anderen Anfragen sendet - 'Hello World'.  Um eine HTML-Seite zu senden, müssen Sie sie zuerst aus einer Datei lesen. </p><br><p> <code>home.html</code> </p> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>This is home page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.url === <span class="hljs-string"><span class="hljs-string">'/home'</span></span>) { fs.readFile(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ __dirname }</span></span></span><span class="hljs-string">/home.html`</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>); response.write(content); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'An error has ocurred'</span></span>); } response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.write(<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  Wenn die angeforderte URL <code>/home</code> lautet, wird das native <code>fs</code> Modul zum Lesen der Datei <code>home.html</code> verwendet. </p><br><p>  Funktionen, die als Argumente in <code>http.createServer</code> und <code>fs.readFile</code> fallen, sind <strong>Rückrufe</strong> .  Diese Funktionen werden zu einem späteren Zeitpunkt ausgeführt (die erste, sobald der Server die Anforderung empfängt, und die zweite, wenn die Datei von der Festplatte gelesen und in den Puffer gestellt wird). </p><br><p>  Während die Datei von der Festplatte gelesen wird, kann Node.js andere Anforderungen verarbeiten und sogar die Datei erneut lesen und das alles in einem Stream ... aber wie ?! </p><br><p>  <strong>Ereignisschleife</strong> </p><br><p>  <strong>Die Ereignisschleife</strong> ist die Magie, die in Node.js geschieht.  Dies ist buchstäblich eine Endlosschleife und tatsächlich ein Thread. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/sc/go/f_scgo68j5gpf0xsnzklzdr9cjc.jpeg"></div><br><p>  <strong>Libuv</strong> ist eine C-Bibliothek, die dieses Muster implementiert und Teil des Kernels <strong>Node.js.</strong> ist  Mehr über libuv erfahren Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </p><br><p>  Ein Ereigniszyklus besteht aus 6 Phasen. Jede Ausführung aller 6 Phasen wird als <strong>Tick ​​bezeichnet</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/xy/eq/2kxyeqk7srzdocs9egzl5zlpwhm.png"></div><br><ul><li>  <strong>Zeitgeber</strong> : In dieser Phase werden Rückrufe ausgeführt, die von den <code>setTimeout()</code> und <code>setInterval()</code> wurden. </li><li>  <strong>ausstehende Rückrufe</strong> : Fast alle <strong>Rückrufe</strong> werden ausgeführt, mit Ausnahme von <code>close</code> , Zeitgebern und <code>setImmediate()</code> . </li><li>  <strong>im Leerlauf, vorbereiten</strong> : nur für interne Zwecke verwendet; </li><li>  <strong>Umfrage</strong> : Verantwortlich für den Empfang neuer E / A-Ereignisse.  Node.js kann an dieser Stelle blockieren. </li><li>  <strong>check</strong> : Rückrufe, die durch die <code>setImmediate()</code> -Methode verursacht werden, werden zu diesem Zeitpunkt ausgeführt. </li><li>  <strong>Rückrufe schließen</strong> : zum Beispiel <code>socket.on('close', ...)</code> ; </li></ul><br><p>  Nun, es gibt nur einen Thread, und dieser Thread ist eine Ereignisschleife, aber wer führt dann alle E / A aus? </p><br><p>  beachten Sie <img width="60" src="https://habrastorage.org/webt/92/8i/lj/928iljyzpqhkbczypvvqgkx0zc0.png">  !!! <br>  Wenn eine Ereignisschleife eine E / A-Operation ausführen muss, verwendet sie den Betriebssystem-Thread aus dem Thread-Pool. Wenn die Aufgabe abgeschlossen ist, wird der Rückruf während der Phase <em>ausstehender Rückrufe</em> in die Warteschlange gestellt. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/z7/uw/lzz7uwcdvm1xd1yr6utj7cae36g.png"></div><br><p>  Ist das nicht cool? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/it/yo/bh/ityobhc10qgnkk5m9yk5xp94ble.gif"></div><br><a name="p4"></a><br><h3 id="problema-cpu-yomkih-zadach">  Das Problem der CPU-intensiven Aufgaben </h3><br><p>  Node.js scheint perfekt zu sein!  Sie können erstellen, was Sie wollen. </p><br><p>  Schreiben wir eine API zur Berechnung von Primzahlen. </p><br><p>  Eine Primzahl ist eine ganzzahlige (natürliche) Zahl, die größer als eins ist und nur durch 1 und durch sich selbst teilbar ist. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/kn/7f/nlkn7fwr_kxhtktm-_gt0ci7ask.jpeg"></div><br><p>  Bei einer gegebenen Zahl N sollte die API die ersten N Primzahlen in der Liste (oder im Array) berechnen und zurückgeben. </p><br><p> <code>primes.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { isPrime, nthPrime };</code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> primes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./primes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = primes.nthPrime(query.n || <span class="hljs-number"><span class="hljs-number">0</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  <code>prime.js</code> ist die Implementierung der erforderlichen Berechnungen: Die Funktion <code>isPrime</code> prüft, ob die Zahl prime ist, und nthPrime gibt N solcher Zahlen zurück. </p><br><p>  Die Datei <code>index.js</code> ist für die Erstellung des Servers verantwortlich und verwendet das Modul <code>prime.js</code> , um jede Anforderung für <code>/primes</code> .  Die Nummer N wird durch die Abfragezeichenfolge in der URL geworfen. </p><br><p>  Um die ersten 20 Primzahlen zu erhalten, müssen wir eine Anfrage an <code>http://localhost:8080/primes?n=20</code> . </p><br><p>  Angenommen, wir haben 3 Clients, die an uns klopfen und versuchen, auf unsere nicht blockierende E / A-API zuzugreifen: </p><br><ul><li>  Die erste Abfrage 5 Primzahlen pro Sekunde. </li><li>  Der zweite fragt nach 1000 Primzahlen pro Sekunde </li><li>  Der dritte fordert 10.000.000.000 Primzahlen, aber ... </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pz/rx/bl/pzrxblziplf06w7-kzbyojhafhg.gif"></div><br><p>  Wenn der dritte Client eine Anforderung sendet, wird der Hauptthread blockiert, und dies ist das Hauptsymptom für das Problem <strong>CPU-intensiver Aufgaben</strong> .  Wenn der Hauptthread gerade eine „schwere“ Aufgabe ausführt, kann er nicht mehr auf andere Aufgaben zugreifen. </p><br><p>  Aber was ist mit libuv?  Wenn Sie sich erinnern, hilft diese Bibliothek Node.js bei der Ausführung von Eingabe- / Ausgabeoperationen mit OS-Threads, ohne den Hauptthread zu blockieren. Sie haben absolut Recht. Dies ist die Lösung für unser Problem. Damit dies jedoch möglich ist, muss unser Modul in der Sprache geschrieben sein C ++, damit libuv damit arbeiten kann. </p><br><p>  Glücklicherweise wurde ab Version 10.5 das native <strong>Worker Threads-</strong> Modul zu Node.js hinzugefügt. </p><br><a name="p5"></a><br><h3 id="vorkery-i-ih-potoki">  Arbeiter und ihre Ströme </h3><br><p>  Wie die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> sagt: </p><br><blockquote>  Mitarbeiter sind nützlich, um CPU-intensive JavaScript-Vorgänge auszuführen.  Verwenden Sie sie nicht für Eingabe- / Ausgabeoperationen. Die bereits in Node.js integrierten Mechanismen bewältigen solche Aufgaben effizienter als der Worker-Thread. </blockquote><p>  <strong>Code korrigieren</strong> </p><br><p>  Es ist Zeit, unseren Code neu zu schreiben: </p><br><p> <code>primes-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { workerData, parentPort } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } parentPort.postMessage(nthPrime(workerData.n));</code> </pre> <br><p> <code>index-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Worker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'./primes-workerthreads.js'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">workerData</span></span>: { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: query.n || <span class="hljs-number"><span class="hljs-number">0</span></span> } }); worker.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Oops there was an error...'</span></span>); response.end(); }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; worker.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ result = message; }); worker.on(<span class="hljs-string"><span class="hljs-string">'exit'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  In der <code>index-workerthreads.js</code> jede Anforderung an <code>/primes</code> eine Instanz der <code>Worker</code> Klasse (aus dem nativen Modul <code>worker_threads</code> ), um die <code>primes-workerthreads.js</code> hochzuladen und in den Worker-Thread auszuführen.  Wenn die Liste der Primzahlen berechnet und bereit ist, wird das <code>message</code> ausgelöst. Das Ergebnis fällt in den Hauptstrom, da der Mitarbeiter keine Arbeit mehr hat. Er löst auch das <code>exit</code> Ereignis aus, sodass der Hauptstrom Daten an den Client senden kann. </p><br><p>  <code>primes-workerthreads.js</code> sich etwas geändert.  Es importiert <code>workerData</code> (dies ist eine Kopie der vom Hauptthread übergebenen Parameter) und <code>parentPort</code> über die das Ergebnis der Arbeit des Arbeiters an den Hauptthread zurückgegeben wird. </p><br><p>  Versuchen wir nun noch einmal unser Beispiel und sehen, was passiert: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zu/vk/gh/zuvkghy8dnhjryfdf5b62ped8dw.gif"></div><br><p>  Der Haupt-Thread ist nicht mehr blockiert <img width="115" src="https://habrastorage.org/webt/nn/hs/r3/nnhsr3jiw_4aed53jye8gokutpy.png">  !!!!! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/ij/el/ttijelgt36k_vbengx3qjaaajlc.gif"></div><br><p>  Jetzt funktioniert alles so, wie es sollte, aber es ist immer noch keine gute Praxis, Arbeiter ohne Grund zu produzieren. Das Erstellen von Fäden ist kein billiges Vergnügen.  Stellen Sie sicher, dass Sie zuvor einen Thread-Pool erstellen. </p><br><h4 id="zaklyuchenie">  Fazit </h4><br><p>  Node.js ist eine leistungsstarke Technologie, die nach Möglichkeit untersucht werden sollte. <br>  Meine persönliche Empfehlung - immer neugierig sein!  Wenn Sie von innen wissen, wie etwas funktioniert, können Sie effizienter damit arbeiten. </p><br><p>  Das ist alles für heute Jungs.  Ich hoffe, dieser Beitrag war nützlich für Sie und Sie haben etwas Neues über Node.js gelernt. </p><br><p>  Vielen Dank fürs Lesen und bis in die nächsten Beiträge. <img width="20" src="https://habrastorage.org/webt/bd/lk/kd/bdlkkdf7adtljydvhxyw22y3cfi.png">  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460661/">https://habr.com/ru/post/de460661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460645/index.html">Gutes tun, schlechtes tun: Schlechten Code mit Go schreiben, Teil 1</a></li>
<li><a href="../de460647/index.html">Lösen eines Jobs mit pwnable.kr 05 - Passcode. Schreiben Sie die Prozedur-Link-Tabelle über die Sicherheitsanfälligkeit bezüglich Formatzeichenfolgen neu</a></li>
<li><a href="../de460651/index.html">Treffen der Society of Anonymous Testers: TMS, Überwachung, Überwachung der Bewertung der Suchqualität und native iOS-Tests</a></li>
<li><a href="../de460655/index.html">Wie ich Telegramm gebrochen habe</a></li>
<li><a href="../de460659/index.html">Verwenden von Rohren zum Schwenken</a></li>
<li><a href="../de460665/index.html">Entwurf einer FAQ: Warum erscheinen alle drei Jahre C ++ - Standards?</a></li>
<li><a href="../de460667/index.html">Automatisierung des Testens kostenpflichtiger Dienste unter iOS</a></li>
<li><a href="../de460669/index.html">So gewährleisten Sie die Sicherheit der Entwicklung, sparen Zeit und Nerven</a></li>
<li><a href="../de460671/index.html">Eigentum und Ausleihe in D.</a></li>
<li><a href="../de460673/index.html">Enthülle die Magie von DiffUtil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>