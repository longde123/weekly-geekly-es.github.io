<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚úàÔ∏è ‚ùî üöÆ Theorie und Praxis von Backups mit Borg ü§≤üèº üßöüèΩ ‚ôéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zu unserer gro√üen √úberraschung gab es kein einziges Material √ºber das wunderbare Open Source-Tool zur Datensicherung - Borg (nicht zu verwechseln mit ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Theorie und Praxis von Backups mit Borg</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420055/"><img src="https://habrastorage.org/webt/xx/7w/tn/xx7wtnr5mv7mjndz-uzowsql58o.png"><br><br>  Zu unserer gro√üen √úberraschung gab es kein einziges Material √ºber das wunderbare Open Source-Tool zur Datensicherung - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Borg</a> <i>(nicht zu verwechseln mit dem gleichnamigen Vorfahren Kubernetes!)</i> .  Da wir es seit mehr als einem Jahr in der Produktion verwenden, werde ich in diesem Artikel die ‚ÄûEindr√ºcke‚Äú teilen, die wir √ºber Borg gewonnen haben. <a name="habracut"></a><br><br><h2>  Hintergrund: Erfahrung mit Bacula und Bareos </h2><br>  Im Jahr 2017 hatten wir die Bacula und Bareos satt, die wir von Beginn unserer T√§tigkeit an verwendet haben (d. H. Ungef√§hr 9 Jahre in der Produktion zu diesem Zeitpunkt).  Warum?  W√§hrend des Betriebs haben wir viel Unzufriedenheit angeh√§uft: <br><br><ul><li>  SD (Storage Daemon) friert ein.  Wenn Sie Parallelit√§t konfiguriert haben, wird die SD-Wartung komplizierter, und das Einfrieren blockiert weitere planm√§√üige Sicherungen und die M√∂glichkeit der Wiederherstellung. </li><li>  Es ist notwendig, Konfigurationen sowohl f√ºr den Kunden als auch f√ºr den Direktor zu generieren.  Selbst wenn wir dies automatisieren (in unserem Fall wurden Chef, Ansible und unsere eigene Entwicklung zu unterschiedlichen Zeiten verwendet), m√ºssen wir √ºberwachen, dass der Director nach seinem <i>Neuladen</i> die Konfiguration tats√§chlich √ºbernommen hat.  Dies wird nur in der Ausgabe des Befehls <i>reload</i> und im Aufruf von <i>Nachrichten</i> nachverfolgt (um den Fehlertext selbst zu erhalten). </li><li>  Planen Sie Backups.  Die Entwickler von Bacula haben beschlossen, ihren eigenen Weg zu gehen und ein eigenes Zeitplanformat zu schreiben, das Sie nicht einfach analysieren oder in ein anderes konvertieren k√∂nnen.  Hier sind Beispiele f√ºr Standard-Sicherungspl√§ne in unseren alten Installationen: <ul><li>  T√§glich vollst√§ndige Sicherung mittwochs und schrittweise an anderen Tagen: <br> <code>Run = Level=Full Pool="Foobar-low7" wed at 18:00 <br> Run = Level=Incremental Pool="Foobar-low7" at 18:00</code> </li> <li>  Vollst√§ndige Sicherung der Wal-Dateien zweimal im Monat und st√ºndliche Erh√∂hung: <br> <code>Run = Level=Full FullPool=CustomerWALPool 1st fri at 01:45 <br> Run = Level=Full FullPool=CustomerWALPool 3rd fri at 01:45 <br> Run = Level=Incremental FullPool=CustomerWALPool IncrementalPool=CustomerWALPool on hourly</code> </li> <li>  Der generierte <code>schedule</code> f√ºr alle Gelegenheiten (an verschiedenen Wochentagen alle 2 Stunden) ergab ungef√§hr 1665 ... aufgrund dessen, was Bacula / Bareos regelm√§√üig verr√ºckt machte. </li></ul></li><li>  Bacula-fd (und bareos-fd) haben Verzeichnisse mit vielen Daten (z. B. 40 TB, von denen 35 TB gro√üe Dateien [100+ MB] und die restlichen 5 TB kleine Dateien [1 KB bis 100 MB] enthalten ]) Es beginnt ein langsamer Speicherverlust, was bei der Produktion eine sehr unangenehme Situation darstellt. <br><br><img src="https://habrastorage.org/webt/eu/33/ao/eu33aocunyesaxcwtlyzzim_eha.png"></li><li>  Bei Sicherungen mit einer gro√üen Anzahl von Dateien h√§ngen Bacula und Bareos stark von der Leistung des verwendeten DBMS ab.  Welche Laufwerke hat es?  Wie geschickt wissen Sie, wie Sie sie auf diese spezifischen Bed√ºrfnisse abstimmen k√∂nnen?  √úbrigens wird in der Datenbank eine (!) Nicht partitionierbare Tabelle mit einer Liste aller Dateien in allen Sicherungen und die zweite mit einer Liste aller Pfade in allen Sicherungen erstellt.  Wenn Sie nicht bereit sind, mindestens 8 GB RAM f√ºr die Basis + 40 GB SSD f√ºr Ihren Backup-Server zuzuweisen, machen Sie sich sofort f√ºr die Bremsen bereit. </li><li>  Die Datenbankabh√§ngigkeit verdient einen weiteren Punkt.  Bacula / Bareos fragt den Regisseur f√ºr jede Datei, ob es bereits eine solche Datei gibt.  Der Director kriecht nat√ºrlich in die Datenbank, in diese sehr gro√üen Tabellen ... Es stellt sich heraus, dass die Sicherung einfach dadurch blockiert werden kann, dass mehrere schwere Sicherungen gleichzeitig gestartet wurden - selbst wenn der Unterschied dort mehrere Megabyte betr√§gt. </li></ul><br><img src="https://habrastorage.org/webt/nh/iw/dz/nhiwdzn69dvunjisjzcwcy1fyna.png"><br><br>  Es w√§re unfair zu sagen, dass √ºberhaupt keine Probleme gel√∂st wurden, aber wir kamen zu einem Punkt, an dem wir verschiedene Problemumgehungen wirklich satt hatten und "hier und jetzt" eine zuverl√§ssige L√∂sung wollten. <br><br>  Bacula / Bareos arbeiten hervorragend mit einer kleinen Anzahl (10-30) einheitlicher Jobs.  Ist einmal in der Woche etwas kaputt gegangen?  Es ist in Ordnung: Sie haben die Aufgabe dem diensthabenden Beamten (oder einem anderen Ingenieur) gegeben - sie haben sie repariert.  Wir haben jedoch Projekte, bei denen die Anzahl der Jobs Hunderte und die Anzahl der Dateien Hunderttausende betr√§gt.  Infolgedessen begannen sich 5 Minuten pro Woche, um das Backup zu reparieren (ohne mehrere Stunden Einstellungen zuvor zu z√§hlen), zu vermehren.  All dies f√ºhrte dazu, dass 2 Stunden am Tag Backups in allen Projekten repariert werden mussten, da buchst√§blich √ºberall etwas unbedeutend oder ernsthaft kaputt ging. <br><br>  Dann k√∂nnte jemand denken, dass ein dedizierter Ingenieur, der sich diesem Thema widmet, Backups durchf√ºhren sollte.  Sicherlich wird er so b√§rtig und streng wie m√∂glich sein, und von seinem Aussehen her werden Backups sofort repariert, w√§hrend er ruhig an Kaffee nippt.  Und diese Idee mag irgendwie wahr sein ... Aber es gibt immer ein Aber.  Nicht jeder kann es sich leisten, Backups rund um die Uhr zu reparieren und zu √ºberwachen, und noch mehr - ein Ingenieur, der f√ºr diese Zwecke eingesetzt wird.  Wir sind uns nur sicher, dass es besser ist, diese 2 Stunden am Tag f√ºr etwas Produktiveres und N√ºtzlicheres zu verwenden.  Aus diesem Grund haben wir uns auf die Suche nach alternativen L√∂sungen gemacht, die ‚Äûeinfach funktionieren‚Äú. <br><br><h2>  Borg als neuer Weg </h2><br>  Die Suche nach anderen Open Source-Optionen war √ºber die Zeit verteilt, daher ist es schwierig, die Gesamtkosten abzusch√§tzen. An einem Punkt (letztes Jahr) richtete sich unsere Aufmerksamkeit jedoch auf den ‚Äû <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Helden des</a> Anlasses‚Äú - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BorgBackup</a> (oder einfach Borg).  Zum Teil wurde dies durch die tats√§chliche Erfahrung mit der Verwendung durch einen unserer Ingenieure (am vorherigen Arbeitsplatz) erleichtert. <br><br>  Borg ist in Python geschrieben (Version&gt; = 3.4.0 ist erforderlich) und leistungsintensiver Code (Komprimierung, Verschl√ºsselung usw.) ist in C / Cython implementiert.  Vertrieb unter einer kostenlosen BSD-Lizenz (3-Klausel).  Es unterst√ºtzt viele Plattformen, einschlie√ülich Linux, * BSD, macOS sowie auf experimenteller Ebene Cygwin und Linux Subsystem von Windows 10. Zur Installation von BorgBackup stehen Pakete f√ºr g√§ngige Linux-Distributionen und andere Betriebssysteme sowie Quellcodes zur Verf√ºgung, die auch √ºber pip installiert werden k√∂nnen. - N√§here Informationen hierzu finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projektdokumentation</a> . <br><br>  Warum hat Borg uns so bestochen?  Hier sind die Hauptvorteile: <br><br><ul><li>  <b>Deduplizierung</b> : real und sehr effektiv (Beispiele unten).  Dateien innerhalb eines einzelnen Borg-Repositorys (d. H. Eines speziellen Verzeichnisses in einem Borg-spezifischen Format) werden in Bl√∂cke von n Megabyte unterteilt, und die sich wiederholenden Borg-Bl√∂cke werden dedupliziert.  Die Deduplizierung erfolgt genau vor der Komprimierung. </li><li>  <b>Komprimierung</b> : Nach der Deduplizierung werden auch Daten komprimiert.  Es stehen verschiedene Komprimierungsalgorithmen zur Verf√ºgung: lz4, lzma, zlib, zstd.  Die Standardfunktion jeder Sicherung, aber dies ist nicht weniger n√ºtzlich. </li><li>  <b>Arbeiten an SSH</b> : Borg-Backups auf einem Remote-Server √ºber SSH.  Auf der Serverseite m√ºssen Sie nur Borg installieren und fertig!  Von hier aus ergeben sich unmittelbar Vorteile wie Sicherheit und Verschl√ºsselung.  Sie k√∂nnen den Zugriff nur √ºber Schl√ºssel konfigurieren und au√üerdem Borgs Ausf√ºhrung nur eines seiner Befehle beim Betreten des Servers.  Zum Beispiel so: <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc‚Ä¶</code> </pre> </li><li>  Es wird sowohl in PPA (wir verwenden haupts√§chlich Ubuntu) als auch in einer <b>statischen Bin√§rdatei</b> geliefert.  Borg in Form einer statischen Bin√§rdatei erm√∂glicht es, sie fast √ºberall dort auszuf√ºhren, wo es zumindest einen minimal modernen Glibc gibt.  (Aber nicht √ºberall - zum Beispiel war es nicht m√∂glich, mit CentOS 5 zu starten.) </li><li>  Flexible <b>Reinigung alter Backups</b> .  Sie k√∂nnen den Speicher der letzten n Sicherungen und 2 Sicherungen pro Stunde / Tag / Woche festlegen.  Im letzteren Fall bleibt das letzte Backup am Ende der Woche √ºbrig.  Die Bedingungen k√∂nnen kombiniert werden, indem 7 t√§gliche Backups f√ºr die letzten 7 Tage und 4 w√∂chentliche Backups gespeichert werden. </li></ul><br>  Der √úbergang zu Borg begann langsam bei kleinen Projekten.  Anfangs waren dies einfache Cron-Skripte, die jeden Tag ihre Arbeit erledigten.  Dies dauerte etwa sechs Monate.  W√§hrend dieser Zeit mussten wir viele Male Backups bekommen ... und es stellte sich heraus, dass Borg √ºberhaupt nicht buchst√§blich repariert werden musste!  Warum?  Denn hier funktioniert das einfache Prinzip: "Je einfacher der Mechanismus ist, desto weniger Stellen brechen ihn." <br><br><h2>  √úbung: Wie kann man mit Borg sichern? </h2><br>  Betrachten Sie ein einfaches Beispiel f√ºr die Erstellung eines Backups: <br><br><ol><li>  Laden Sie die neueste Bin√§rversion auf den Sicherungsserver und den Computer herunter, den wir aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offiziellen Repository</a> sichern <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">m√∂chten</a> : <br><br><pre> <code class="bash hljs">sudo wget https://github.com/borgbackup/borg/releases/download/1.1.6/borg-linux64 -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg sudo chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/borg</code> </pre> <br>  <i><b>Hinweis</b> : Wenn Sie einen lokalen Computer f√ºr den Test sowohl als Quelle als auch als Empf√§nger verwenden, liegt der gesamte Unterschied nur in der URI, die wir weitergeben. Wir denken jedoch daran, dass die Sicherung separat und nicht auf demselben Computer gespeichert werden muss.</i> </li><li>  Erstellen Sie auf dem Sicherungsserver den <code>borg</code> Benutzer: <br><br><pre> <code class="bash hljs">sudo useradd -m borg</code> </pre> <br>  Einfach: ohne Gruppen und mit einer Standard-Shell, aber immer mit einem Home-Verzeichnis. </li><li>  Auf dem Client wird ein SSH-Schl√ºssel generiert: <br><br><pre> <code class="bash hljs">ssh-keygen</code> </pre> </li><li>  F√ºgen Sie auf dem Server den generierten Schl√ºssel zum <code>borg</code> Benutzer hinzu: <br><br><pre> <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> local / bin / borg dienen" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf / XmSVWfF7PfjGlbKW00MJ63zal / E / mxm + vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU / JNU0jITLx + vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk / QmteOOclzx684t9d6BhMvFE9w9r + c76aVBIdbEyrkloiYd + vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44 / Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam + 9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y + IQM7fbDR'&gt; ~ borg / .ssh <code class="bash hljs">mkdir ~borg/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'command="/usr/local/bin/borg serve" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNdaDfqUUf/XmSVWfF7PfjGlbKW00MJ63zal/E/mxm+vJIJRBw7GZofe1PeTpKcEUTiBBEsW9XUmTctnWE6p21gU/JNU0jITLx+vg4IlVP62cac71tkx1VJFMYQN6EulT0alYxagNwEs7s5cBlykeKk/QmteOOclzx684t9d6BhMvFE9w9r+c76aVBIdbEyrkloiYd+vzt79nRkFE4CoxkpvptMgrAgbx563fRmNSPH8H5dEad44/Xb5uARiYhdlIl45QuNSpAdcOadp46ftDeQCGLc4CgjMxessam+9ujYcUCjhFDNOoEa4YxVhXF9Tcv8Ttxolece6y+IQM7fbDR'</span></span> &gt; ~borg/.ssh/authorized_keys chown -R borg:borg ~borg/.ssh</code> </pre> </li><li>  Wir initialisieren das <i>Borg-Repo</i> auf dem Server vom Client aus: <br><br><pre> <code class="bash hljs">ssh borg@172.17.0.3 hostname <span class="hljs-comment"><span class="hljs-comment">#     borg init -e none borg@172.17.0.3:MyBorgRepo</span></span></code> </pre> <br>  Mit dem Schalter <code>-e</code> wird die Verschl√ºsselungsmethode f√ºr das Repository ausgew√§hlt (ja, Sie k√∂nnen jedes Repository zus√§tzlich mit Ihrem Passwort verschl√ºsseln!).  In diesem Fall, weil  Dies ist ein Beispiel, wir verwenden keine Verschl√ºsselung.  <code>MyBorgRepo</code> ist der Name des Verzeichnisses, in dem sich das <i>Borg-Repo</i> befindet (Sie m√ºssen es nicht im Voraus erstellen - Borg <code>MyBorgRepo</code> alles selbst). </li><li>  Starten Sie das erste Backup mit Borg: <br><br><pre> <code class="bash hljs">borg create --stats --list borg@172.17.0.3:MyBorgRepo::<span class="hljs-string"><span class="hljs-string">"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</span></span> /etc /root</code> </pre> <br>  √úber die Schl√ºssel: <br><ul><li>  <code>--stats</code> und <code>--list</code> geben uns Statistiken √ºber Backups und Dateien, die darauf <code>--list</code> . </li><li>  <code>borg@172.17.0.3:MyBorgRepo</code> - hier ist alles klar, dies ist unser Server und Verzeichnis.  Und was kommt als n√§chstes f√ºr Magie? </li><li>  <code>::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}"</code> ist der Name des Archivs im Repository.  Es ist willk√ºrlich, aber wir halten uns an das Format <code>_-timestamp</code> (Zeitstempel im Python-Format). </li></ul></li></ol><br>  Was weiter?  Sehen Sie nat√ºrlich, was in unser Backup gelangt ist!  Liste der Archive im Repository: <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg list MyBorgRepo/ Warning: Attempting to access a previously unknown unencrypted repository! Do you want to <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>? [yN] y MyFirstBackup-2018-08-04_16:55:53 Sat, 2018-08-04 16:55:54 [89f7b5bccfb1ed2d72c8b84b1baf477a8220955c72e7fcf0ecc6cd5a9943d78d]</code> </pre> <br>  Wir sehen ein Backup mit einem Zeitstempel und wie Borg uns fragt, ob wir wirklich auf ein unverschl√ºsseltes Repository zugreifen m√∂chten, in dem wir noch nie waren. <br><br>  Wir sehen uns die Liste der Dateien an: <br><br><pre> <code class="bash hljs">borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53</code> </pre> <br>  Wir erhalten die Datei aus dem Backup (Sie k√∂nnen auch das gesamte Verzeichnis): <br><br><pre> <code class="bash hljs">borg@b3e51b9ed2c2:~$ borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname borg@b3e51b9ed2c2:~$ ll etc/hostname -rw-r--r-- 1 borg borg 13 Aug 4 16:27 etc/hostname</code> </pre> <br>  Herzlichen Gl√ºckwunsch, Ihr erstes Borg-Backup ist fertig! <br><br><h2>  √úbung: Automatisieren Sie dies [mit GitLab]! </h2><br>  Nachdem wir all dies in Skripte verpackt haben, haben wir Backups auf √§hnliche Weise auf ungef√§hr 40 Hosts manuell konfiguriert.  Als sie erkannten, dass Borg wirklich funktioniert, begannen sie, mehr und gr√∂√üere Projekte darauf zu √ºbertragen ... <br><br>  Und hier stehen wir vor dem, was in Bareos ist, aber nicht in Borg!  N√§mlich: WebUI oder eine Art zentraler Ort zum Konfigurieren von Backups.  Und wir hoffen wirklich, dass dies ein vor√ºbergehendes Ph√§nomen ist, aber bisher mussten wir etwas l√∂sen.  Nachdem wir die fertigen Werkzeuge gegoogelt und uns in einer Videokonferenz versammelt hatten, machten wir uns an die Arbeit.  Es war eine gro√üartige Idee, Borg wie zuvor bei Bacula in unsere internen Services zu integrieren (Bacula selbst hat die Liste der Jobs von unserer zentralisierten API entfernt, in die wir unsere eigene Schnittstelle in andere Projekteinstellungen integriert hatten).  Wir haben dar√ºber nachgedacht, wie es geht, haben einen Plan entworfen, wie und wo es gebaut werden soll, aber ... Jetzt sind normale Backups erforderlich, aber es gibt keine Orte, an denen man gro√üartige Zeitpl√§ne erstellen kann.  Was zu tun ist? <br><br>  Fragen und Anforderungen waren ungef√§hr wie folgt: <br><br><ul><li>  Was ist als zentrales Backup-Management zu verwenden? </li><li>  Was kann ein Linux-Administrator tun? </li><li>  Was kann selbst ein Manager, der Kunden einen Sicherungsplan anzeigt, verstehen und konfigurieren? </li><li>  Was macht eine geplante Aufgabe jeden Tag auf Ihrem System? </li><li>  Was wird nicht schwer zu konfigurieren sein und wird nicht kaputt gehen? </li></ul><br>  Die Antwort lag auf der Hand: Dies ist der gute alte Crond, der jeden Tag seine Pflicht heldenhaft erf√ºllt.  Einfach.  Es friert nicht ein.  Sogar der Manager, der von Unix zu "Ihnen" wechselt, kann das Problem beheben. <br><br>  Also Crontab, aber wo bewahrst du das alles auf?  Gehen Sie jedes Mal zur Projektmaschine und bearbeiten Sie die Datei mit Ihren H√§nden?  Nat√ºrlich nicht.  Wir k√∂nnen unseren Zeitplan in das Git-Repository stellen und GitLab Runner konfigurieren, der ihn durch Festschreiben auf dem Host aktualisiert. <br><br>  <i><b>Hinweis</b> : Es wurde GitLab als Automatisierungstool ausgew√§hlt, da es f√ºr die Aufgabe praktisch ist und in unserem Fall fast √ºberall.</i>  <i>Aber ich muss sagen, dass er keineswegs eine Notwendigkeit ist.</i> <br><br>  Sie k√∂nnen crontab f√ºr Backups mit einem vertrauten Automatisierungstool oder allgemein manuell (bei kleinen Projekten oder Heiminstallationen) erweitern. <br><br>  Folgendes ben√∂tigen Sie f√ºr eine einfache Automatisierung: <br><br>  1. <b>GitLab und ein Repository</b> , in dem sich zun√§chst zwei Dateien befinden: <br><br><ul><li>  <code>schedule</code> - Sicherungszeitplan </li><li>  <code>borg_backup_files.sh</code> - ein einfaches Skript zum Sichern von Dateien (wie im obigen Beispiel). </li></ul><br>  Beispiel f√ºr einen <code>schedule</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># WARNING! CRONTAB MANAGED FROM GITLAB CI RUNNER IN ${CI_PROJECT_URL} # CI_COMMIT_SHA: ${CI_COMMIT_SHA} # Branch/tag: ${CI_COMMIT_REF_NAME} # Timestamp: ${TIMESTAMP} PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin # MyRemoteHost 0 0 * * * ${CI_PROJECT_DIR}/borg_backup_files.sh 'SYSTEM /etc,/opt'</span></span></code> </pre> <br>  CI-Variablen werden verwendet, um zu √ºberpr√ºfen, ob das Crontab-Update erfolgreich war, und <code>CI_PROJECT_DIR</code> ist das Verzeichnis, in dem sich das Repository nach dem Klonen des <code>CI_PROJECT_DIR</code> befindet.  Die letzte Zeile zeigt an, dass die Sicherung jeden Tag um Mitternacht durchgef√ºhrt wird. <br><br>  Beispiel <code>borg_backup_files.sh</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash BORG_SERVER="borg@10.100.1.1" NAMEOFBACKUP=${1} DIRS=${2} REPOSITORY="${BORG_SERVER}:$(hostname)-${NAMEOFBACKUP}" borg create --list -v --stats \ $REPOSITORY::"files-{now:%Y-%m-%d_%H:%M:%S}" \ $(echo $DIRS | tr ',' ' ') || \ echo "borg create failed"</span></span></code> </pre> <br>  <i>Das erste</i> Argument ist hier der Name der Sicherung und das <i>zweite</i> die Liste der Verzeichnisse f√ºr die Sicherung, die durch Kommas getrennt sind.  Genau genommen kann eine Liste auch aus mehreren separaten Dateien bestehen. <br><br>  2. <b>GitLab Runner</b> , der auf dem Computer ausgef√ºhrt wird, der gesichert werden muss, und nur f√ºr die Jobs dieses Repositorys blockiert wird. <br><br>  3. <b>Das CI-Skript selbst</b> , das von der <code>.gitlab-ci.yml</code> implementiert wird: <br><br><pre> <code class="hljs pgsql">stages: - deploy Deploy: stage: deploy script: - export <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>=$(<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>) - cat schedule | envsubst | crontab - tags: - borg-backup</code> </pre> <br>  4. Der <b>SSH-Schl√ºssel</b> f√ºr den <code>gitlab-runner</code> Benutzer mit Zugriff auf den <code>gitlab-runner</code> (im Beispiel 10.100.1.1).  Standardm√§√üig sollte es sich im <code>.ssh/id_rsa</code> ( <code>gitlab-runner</code> ) befinden. <br><br>  5. <b>Der <code>borg</code> Benutzer</b> auf demselben 10.100.1.1 mit nur Zugriff auf den Befehl <code>borg serve</code> : <br><br><pre> <code class="bash hljs">$ cat .ssh/authorized_keys <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-string"><span class="hljs-string">"/usr/bin/borg serve"</span></span> ssh-rsa AAAAB3NzaC1yc2EAA...</code> </pre> <br>  Wenn Sie sich jetzt f√ºr das Runner-Repository festlegen, wird der Inhalt von crontab gef√ºllt.  Und wenn die Antwortzeit des Cron kommt, wird eine Sicherung der Verzeichnisse <code>/etc</code> und <code>/opt</code> durchgef√ºhrt, die sich auf dem Sicherungsserver im <code>MyHostname-SYSTEM</code> von Server 10.100.1.1 befindet. <br><br><img src="https://habrastorage.org/webt/ud/n7/wb/udn7wbd4vqknfq6cguw5wmi7tcq.png"><br><br><h2>  Anstelle einer Schlussfolgerung: Was k√∂nnen Sie noch tun? </h2><br>  Die Verwendung von Borg endet hier nat√ºrlich nicht.  Hier sind einige Ideen f√ºr die weitere Implementierung, von denen einige bereits zu Hause implementiert wurden: <br><br><ul><li>  <b>F√ºgen Sie universelle Skripte</b> f√ºr verschiedene Sicherungen hinzu, die am Ende der Ausf√ºhrung <code>borg_backup_files.sh</code> und auf das Verzeichnis mit dem Ergebnis ihrer Arbeit abzielen.  Sie k√∂nnen beispielsweise PostgreSQL (pg_basebackup), MySQL (innobackupex) und GitLab (integrierter Rake-Job, Erstellen eines Archivs) sichern. </li><li>  <b>Zentraler Host mit <i>Zeitplan</i> f√ºr die Sicherung</b> .  Nicht auf jedem Host GitLab Runner konfigurieren?  Lassen Sie es auf dem Sicherungsserver allein, und crontab √ºbertr√§gt beim Start das Sicherungsskript auf den Computer und f√ºhrt es dort aus.  Dazu ben√∂tigen Sie nat√ºrlich den <code>borg</code> Benutzer auf dem Client-Computer und den <code>ssh-agent</code> , um den Schl√ºssel f√ºr den Sicherungsserver nicht auf jedem Computer auszulegen. </li><li>  <b>√úberwachung</b>  Wo ohne ihn!  Warnungen √ºber eine falsch abgeschlossene Sicherung m√ºssen sein. </li><li>  <b>Borg-Repository aus alten Archiven l√∂schen.</b>  Trotz guter Deduplizierung m√ºssen alte Backups noch bereinigt werden.  Dazu k√∂nnen Sie am Ende des Sicherungsskripts einen Anruf bei <code>borg prune</code> t√§tigen. </li><li>  <b>Webschnittstelle</b> zum Zeitplan.  Dies ist praktisch, wenn die Bearbeitung von crontab von Hand oder √ºber das Webinterface f√ºr Sie nicht solide / unangenehm erscheint. </li><li>  <b>Kreisdiagramme</b> .  Einige Diagramme zur visuellen Darstellung des Prozentsatzes erfolgreich abgeschlossener Sicherungen, ihrer Ausf√ºhrungszeit und der Breite des "verzehrten" Kanals.  Kein Wunder, dass ich geschrieben habe, dass es nicht genug WebUI gibt, wie in Bareos ... </li><li>  <b>Einfache Aktionen</b> , die ich per Knopfdruck erhalten m√∂chte: Starten eines Backups bei Bedarf, Wiederherstellen auf einem Computer usw. </li></ul><br>  Und am Ende m√∂chte ich ein Beispiel f√ºr die Effektivit√§t der Deduplizierung bei einer wirklich funktionierenden Sicherung von PostgreSQL WAL-Dateien in einer Produktionsumgebung hinzuf√ºgen: <br><br><pre> <code class="bash hljs">borg@backup ~ $ borg info PROJECT-PG-WAL Repository ID: 177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Location: /mnt/borg/PROJECT-PG-WAL Encrypted: No Cache: /mnt/borg/.cache/borg/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 Security dir: /mnt/borg/.config/borg/security/177eeb28056a60487bdfce96cfb33af1c186cb2a337226bc3d5380a78a6aeeb6 ------------------------------------------------------------------------------ Original size Compressed size Deduplicated size All archives: 6.68 TB 6.70 TB 19.74 GB Unique chunks Total chunks Chunk index: 11708 3230099</code> </pre> <br>  Dies sind 65 Tage Backup von WAL-Dateien, die jede Stunde durchgef√ºhrt werden.  Bei Verwendung von Bacula / Bareos, d.h.  Ohne Deduplizierung w√ºrden wir 6,7 TB Daten erhalten.  Denken Sie nur: Wir k√∂nnen es uns leisten, fast 7 Terabyte Daten zu speichern, die √ºber PostgreSQL √ºbertragen werden, nur 20 GB tats√§chlich belegten Speicherplatz. <br><br><h2>  PS </h2><br>  Lesen Sie auch in unserem Blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Theorie und Praxis unbeaufsichtigter Upgrades in Ubuntu</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Junior, der am ersten Arbeitstag die Datenbank aus der Produktion gel√∂scht hat</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschleunigen des Bootstraps gro√üer Datenbanken mit Kubernetes</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de420055/">https://habr.com/ru/post/de420055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de420041/index.html">TypeScript War oder Enum Conquest</a></li>
<li><a href="../de420045/index.html">Bunker f√ºr das Datum: Wie ich im RUVDS-Rechenzentrum auf dem Territorium der Raumfahrtanlage herumlaufen durfte</a></li>
<li><a href="../de420049/index.html">Das Buch "Der Mann spricht. Evolution und Sprache</a></li>
<li><a href="../de420051/index.html">[DotNetBook] Span, Memory und ReadOnlyMemory</a></li>
<li><a href="../de420053/index.html">Veeam Academy f√ºr C # -Entwickler: Neue Saison</a></li>
<li><a href="../de420057/index.html">8 Regeln f√ºr einen erfolgreichen Freiberufler</a></li>
<li><a href="../de420059/index.html">Jetzt bin ich Teamleiter, aber warum bin ich so krank? Praktische Tipps</a></li>
<li><a href="../de420061/index.html">Wir bewerten die Prozesse im Entwicklungsteam anhand objektiver Daten</a></li>
<li><a href="../de420063/index.html">"Heiliger" Timlid und seine Anh√§nger</a></li>
<li><a href="../de420065/index.html">Kommunikation als Leistungszone der Teamarbeit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>