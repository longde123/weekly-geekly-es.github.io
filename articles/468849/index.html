<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèø ‚ôèÔ∏è üë∂üèº Procesador desconocido ingenier√≠a inversa en un solo programa ‚ôèÔ∏è ‚ù£Ô∏è ü§µüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR: realizamos ingenier√≠a inversa de un programa escrito para una arquitectura de CPU completamente desconocida sin ninguna documentaci√≥n en la CP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Procesador desconocido ingenier√≠a inversa en un solo programa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468849/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/1z/aq/mf1zaqnw0lte41iurmzthf-qjbk.png"></div><br>  TL; DR: realizamos ingenier√≠a inversa de un programa escrito para una arquitectura de CPU completamente desconocida sin ninguna documentaci√≥n en la CPU (sin un emulador, sin ISA, sin todo) en solo diez horas.  Del art√≠culo aprender√°s c√≥mo lo hicimos ... <br><br>  El fin de semana pasado, el equipo CMU PPP y yo participamos en el equipo Dragon Sector Teaser CTF 2019 para relajarnos y alejarnos de la dura fecha l√≠mite de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CHI 2020</a> .  Dragon Sector es un equipo polaco respetado con una historia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CTF</a> interesantes, por lo que me preguntaba qu√© tienen en stock. <br><br>  Despu√©s de resolver ‚Äúummmfpu‚Äù, una tarea que inclu√≠a ingenier√≠a inversa de bytecode para el coprocesador de punto flotante uM-FPU de Micromega, decid√≠ participar en una competencia para resolver el problema de CPU Adventure, que en ese momento no fue resuelto por ninguno de los equipos (como resultado fuimos los √∫nicos que completamos la tarea). <br><br>  Aqu√≠ hay una descripci√≥n de la tarea CPU Adventure: <br><br><blockquote> Mi abuelo en los a√±os 60 se dedic√≥ al desarrollo de computadoras.  Al poner las cosas en orden en su √°tico, encontr√© un auto extra√±o.  Al lado de la m√°quina hab√≠a una pila de tarjetas perforadas marcadas como "Dragon Adventure Game".  Despu√©s de un tiempo, logr√© conectarlo a equipos modernos, pero el juego es demasiado complicado y no puedo llegar al final sin hacer trampa.  Me puedes ayudar  Adjunto una transcripci√≥n de tarjetas perforadas utilizadas en la m√°quina.  Se afirma que la m√°quina tiene 4 registros de prop√≥sito general, 1 kibibyte de memoria de datos y 32 kibibyte de memoria de comando.  Para jugar, con√©ctese al servidor de la siguiente manera: <code>socat tcp4-connect:cpuadventure.hackable.software:1234 fd:0,rawer</code> Sugerencia: el procesador de la m√°quina es √∫nico, no intente buscar informaci√≥n de Google en √©l. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">game.bin</a> </blockquote><a name="habracut"></a><br>  Despu√©s de conectarnos al servidor, recibimos la siguiente informaci√≥n: <br><br><blockquote> <code>THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br>  Genial  Este es un juego de aventuras de la vieja escuela.  Despu√©s de jugar un poco, nos dimos cuenta de que puedes luchar contra los enemigos y obtener una bandera de este personaje Valis si lo complacemos: <br><br><blockquote> <code>YOUR CHOICE: T <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> <br> - HEY, I WAS WONDERING IF YOU COULD HELP ME FIND THE FLAG? <br> - THE FLAG? MAYBE, BUT FIRST, I NEED A REDBULL. <br> - I... I DON'T HAVE A REDBULL. <br> - WELL THEN, MAKE YOURSELF USEFUL AND FIND ONE. <br> <br> THERE IS A TAVERN HERE. INSIDE THE TAVERN, YOU SEE VALIS. <br> <br> SELECT AN OPTION: <br> <br> - GO (N)ORTH <br> - GO (E)AST <br> - (T)ALK TO VALIS <br> - (D)RINK <br> - SHOW (I)NVENTORY <br> <br> YOUR CHOICE:</code> </blockquote> <br><h3>  Primeros pasos </h3><br>  No <code>game.bin</code> el juego por mucho tiempo, d√°ndome cuenta de que lo m√°s probable es que sea m√°s importante realizar ingenier√≠a inversa en el archivo <code>game.bin</code> .  Lo abr√≠ en un editor hexadecimal, esperando ver valores binarios.  Imagina mi sorpresa cuando vi esto: <br><br><pre>  110011111101000000111100110010001110000011001101000000000000110010011101010000001101001111100001111111001100111000000011 ... </pre><br><br>  Este <em>es literalmente un</em> archivo binario: un archivo de texto que no contiene nada m√°s que caracteres ASCII 1 y 0. Sabemos que es muy probable que sea el c√≥digo de m√°quina del procesador, pero adem√°s de tener 4 registros, 1 kbyte de memoria de datos y 32 kibibyte de memoria de instrucciones, <em>no se</em> sabe <em>nada al</em> respecto.  Por lo tanto, nuestra primera tarea seria ser√° determinar el tama√±o de la unidad de este archivo binario (por ejemplo, ¬øtiene una dimensi√≥n de 8 bits? ¬øO, tal vez, tiene una dimensi√≥n de 12 bits o 18 bits, como en algunas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">arquitecturas antiguas</a> ?) <br><br>  Para averiguar el tama√±o de un archivo desconocido, utilic√© un viejo truco: cambi√© el tama√±o del cuadro de texto hasta que la longitud del salto de l√≠nea correspondiera a la alineaci√≥n.  Este m√©todo es ideal para cosas como texto cifrado XOR m√∫ltiple, formatos de archivo desconocidos (sin comprimir) y c√≥digo de una CPU desconocida: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b0/264/13d/7b026413d2a0beb1ad79904ab78ffb15.gif"></div><br>  <i>Cambiar el tama√±o del cuadro de texto</i> <br><br>  En esta comprobaci√≥n r√°pida, descubr√≠ que el tama√±o de la unidad de este archivo deber√≠a ser un divisor de 20 (el ancho de la ventana alineada).  Para averiguar el tama√±o exacto, r√°pidamente escrib√≠ un script buscando largas l√≠neas repetidas (suponiendo que cualquier c√≥digo tiene secuencias estereotipadas repetidas).  La l√≠nea de repetici√≥n m√°s larga fue el siguiente bloque de 425 bits, encontrado en 43625 y 44510: <br><br><pre>  10000011111110000001010100011111110100000101100010111000001001000101000100001000100001010001011000101000000001111111111100010000011110010100100001010100111100000110000010100000101000101000011110001111001101111001010100001010000111110100001010000110010011011110011111000000111011101000000001100000110000111101011010111011000100100010100000111000100011100011000000000101010101100010111000001010000001101010010000000011000001100 </pre><br>  Como la distancia entre las repeticiones es de 885, llegamos a la conclusi√≥n de que la dimensi√≥n debe ser de 5 bits, es decir.  una CPU desconocida debe tener bytes de 5 bits.  Progreso! <br><br>  Buscamos codificaciones de tarjetas perforadas de 5 bits y r√°pidamente nos decidimos por la codificaci√≥n anterior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con el c√≥digo Baudot</a> .  Y, de hecho, cuando utilizamos el decodificador en l√≠nea para decodificar algunos fragmentos, ¬°obtuvimos texto legible! <br><br><blockquote>  ‚á©DRAGON‚á©AQU√ç‚áß; ‚áß‚áß‚á©SHE‚á© APARECE‚á©TO‚á©BE‚á©GUARDANDO‚á© ALGUNOS‚á©KIND‚á©OF‚á©A‚á©BOTTLE‚áß; &amp;. &amp;. ‚á©THERE‚á©IS‚á©A‚á©B <br><br>  <i>C√≥digo LSB Baudot ITA mejorado de 425 bits</i> </blockquote><br>  Luego intentamos decodificar todo el archivo usando el c√≥digo Bodo, pero en los primeros 20 mil bits obtuvimos basura, despu√©s de lo cual hab√≠a un texto perfectamente legible.  Esto nos dej√≥ en claro que la primera parte del archivo pertenece a la secci√≥n "c√≥digo", seguida de la secci√≥n "datos", que contiene l√≠neas constantes.  Asumimos que la m√°quina probablemente usa c√≥digo Bodo para E / S y, por lo tanto, tambi√©n almacena l√≠neas constantes en la codificaci√≥n Bodo en la memoria.  Para hacer que el segmento de c√≥digo sea m√°s legible, decid√≠ codificarlo usando una codificaci√≥n de base 32, similar a la codificaci√≥n hexadecimal, pero expandi√©ndola con el alfabeto 0-9a-v.  As√≠ es como se ve el archivo game.bin con la primera parte codificada por base-32 y la segunda parte decodificada por Bodo (el archivo completo se publica aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">game.b32</a> ): <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf1sf24p5f3r9c11qad0f0sf1df26p5f39c21qad0f05f1ff26p5f39c41qad0f08f1df26p5f39c81qad0f0hf1ef26p5f3r1c00qaq15c20qcl0f01f1of27p5f3p3g3psf35c10qal0f02f1nf27p5f3p3g3psf3rf0hf1nf27p5f3f05f16f27p5f3rf84f95101311fl0f510f84907qa40b518447qa40b514f84f95k9m0k9m0k9m0907qa40b511447qa40b512ruougf10f20g0i9g0i910931b320u2u1u0ro9f0o9f0ojh0o9f0o9f0o9f0olj0o9f0o9f0o9f0o9f0o9f0o9f0o9f0o9k1onp0o9f0o9f0o9f0o9f0onf0ot82odi0o9f0o9f0o9f0o9f0o9f0o9f0o9f0olg0o9f0f0gf1df24p5f3r9c11qa835548755 <br> [...] <br> 93e9n59ka8fo87r85g8ui8ml8ed87b9h89u291u82333333333456789abcdb01234567892)%c3BOTTLE OF SOPLICA PIGWOWAENEMY HEALTH: <br> <br> YOU ATTACK <br> <br> YOU APPROACH REDFORD. <br> <br> <br> <br> YOU ENTER THE TAVERN AND APPROACH VALIS. <br> [...]</code> </blockquote> <br>  Para simplificar, llamar√© a las unidades de cinco bits "bytes" a continuaci√≥n.  Entre nosotros en el equipo, se nos ocurrieron otros nombres para ellos, los llam√© croquetas y Zak, hacks. <br><br><h3>  Arquitectura de procesador desconocida ingenier√≠a inversa </h3><br>  Ahora llegamos a la parte dif√≠cil: ingenier√≠a inversa de 4000 bytes de c√≥digo que se ejecuta en una arquitectura de CPU √∫nica completamente desconocida.  Seg√∫n el c√≥digo, es bastante obvio que esto deber√≠a ser un conjunto de instrucciones de <em>longitud variable</em> , porque es imposible encontrar un patr√≥n repetitivo estable notable en √©l.  Pas√© unas horas en esto, luego el miembro de mi equipo Zachary Wade (@ zwad3) comenz√≥ a ayudarme.  En primer lugar, comenc√© a buscar piezas de c√≥digo duplicadas, sugiriendo que a menudo usar√≠an una peque√±a cantidad de instrucciones.  Comenc√© a dividir el c√≥digo en secuencias repetidas m√°s cortas que eran m√°s convenientes para el an√°lisis.  Me gustar√≠a decir que fue un proceso riguroso, pero de hecho, se utiliz√≥ principalmente el siguiente algoritmo vago: <br><br><ul><li>  Revisamos el c√≥digo y buscamos si algo se repite con mucha frecuencia. </li><li>  Realice el procedimiento de b√∫squeda y reemplazo para insertar una nueva l√≠nea junto a esta repetici√≥n </li><li>  Explore las similitudes / diferencias entre las l√≠neas divididas resultantes. </li><li>  Repita este proceso durante aproximadamente una hora ... </li></ul><br>  Por ejemplo, uno de los patrones que descubr√≠ fue "0f0.f", donde "."  indica un personaje desconocido.  Romp√≠ la cadena en este patr√≥n y obtuve lo siguiente: <br><br><blockquote> <code>pv83pi70pk00p7a0qfgvpjg3f0kf13f28p5f3pv10pk40pn60f0sf <br> 1sf24p5f3r9c11qad0f0sf <br> 1df26p5f39c21qad0f05f <br> 1ff26p5f39c41qad0f08f <br> 1df26p5f39c81qad0f0hf <br> 1ef26p5f3r1c00qaq15c20qcl0f01f <br> 1of27p5f3p3g3psf35c10qal0f02f</code> </blockquote> <br>  Muy √∫til!  De la segunda y tercera l√≠nea vemos que hay "... p5f3r9c ..." y "... p5f39c ...", y esto nos sugiere que "r" es un c√≥digo de operaci√≥n de un solo byte, es decir, "... 5f3" es el final de un c√≥digo de operaci√≥n, y " 9c .. "es el comienzo de otro.  En las √∫ltimas dos l√≠neas vemos "p5f3r1c ..." y esto significa que "1c .." es otro c√≥digo de operaci√≥n, y "p3 ..." es tambi√©n otro c√≥digo de operaci√≥n. <br><br>  Continu√© dividiendo las instrucciones una y otra vez de manera similar, usando las similitudes y diferencias de bloques similares para encontrar instrucciones probables.  Al final, obtuve algo como esto: <br><br><blockquote> <code>pv83 <br> pi70 <br> pk00 <br> p7a0 <br> qfgv <br> pjg3 <br> f0k <br> f13 <br> f28 <br> p5f3 <br> pv10 <br> pk40 <br> pn60 <br> f0s <br> f1s <br> f24 <br> p5f3 <br> r <br> 9c11 <br> qad0 <br> f0s <br> f1d <br> f26 <br> p5f3 <br> 9c21 <br> qad0 <br> f05 <br> f1f</code> </blockquote> <br>  Supuse que "p" y "q" eran instrucciones con tres bytes de operandos, "f0", "f1" y "f2" eran instrucciones con un operando, y "9c" era una instrucci√≥n con dos operandos.  Sin embargo, no sab√≠a qu√© es cada una de estas instrucciones. <br><br>  As√≠ que busqu√© en el directorio de todas las instrucciones "p" que resalt√©, y descubr√≠ que en este momento las instrucciones m√°s frecuentes con "p" eran "p5f3".  Adem√°s, al observar los lugares donde ocurre, descubr√≠ que siempre est√° precedido por las instrucciones "f0", "f1" y "f2".  Al observar todos los operandos "f0", "f1" y "f2", not√© que los operandos f2 siempre est√°n en el rango 4-8.  Recordando que la CPU tiene 32 kb de memoria de programa para direccionamiento que requiere 15 bits, supuse que "f0", "f1" y "f2" cargaron alguna direcci√≥n con f2 como el byte alto.  Cuando conect√© algunas de estas direcciones, descubr√≠ que todas apuntan exactamente al comienzo de las l√≠neas constantes en la secci√≥n de datos.  ¬°Encontr√© la funci√≥n de <code>print</code> !  Inmediatamente se dedujo que "p5f3" es en realidad alg√∫n tipo de instrucci√≥n para imprimir una l√≠nea o llamada;  si tiene en cuenta el operando de tres bytes, lo m√°s probable es que sea una "llamada".  Nuevamente, mirando las instrucciones "p", me di cuenta de que los tres bytes del operando indican la direcci√≥n en <em>orden directo (little-endian)</em> , es decir, el √∫ltimo byte del operando es el byte m√°s alto de la direcci√≥n. <br><br>  ¬°Fue un gran avance!  Hemos identificado nuestra primera instrucci√≥n.  Habiendo visto que "f0" y "f1" se usan en otros lugares, supuse que no cargan las direcciones, sino uno de los cuatro registros (por ejemplo, f0 carga el registro 0) con constantes de 5 bits con direccionamiento directo.  Esto es l√≥gico para p5f3: carga tres argumentos de registro para la funci√≥n 3f5 ("print_string"). <br><br>  Comenc√© a escribir un desensamblador que reconoce la expresi√≥n "imprimir" (f0x, f1x, f2x, p5f3), colocando la sustituci√≥n de la l√≠nea impresa en el c√≥digo desensamblado.  Debido a la gran cantidad de l√≠neas en el programa, el c√≥digo desensamblado r√°pidamente se volvi√≥ muy legible, y se hizo m√°s f√°cil encontrar la ubicaci√≥n de los bloques de funciones (el c√≥digo desensamblado completo est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ): <br><br><blockquote> <code>0: call 38v <br> 4: call 7i <br> 8: call k <br> c: call a7 <br> g: q vgf <br> <br> k: call 3gj <br> o: print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> 15: call 1v <br> 19: call 4k <br> 1d: call 6n <br> 1h: print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> 1u: ret <br> <br> 1v: unk 9 <br> 20: unk c <br> 21: unk 1 <br> 22: unk 1 <br> 23: q 0da <br> 27: print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: unk 9 <br> 2l: unk c <br> 2m: unk 2 <br> 2n: unk 1 <br> 2o: q 0da <br> 2s: print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: unk 9 <br> 3a: unk c <br> 3b: unk 4 <br> 3c: unk 1 <br> 3d: q 0da <br> 3h: print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: unk 9 <br> 3v: unk c <br> 40: unk 8 <br> 41: unk 1 <br> 42: q 0da <br> 46: print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret</code> </blockquote> <br>  A partir de este peque√±o fragmento de c√≥digo, logr√© descubrir varios aspectos: la instrucci√≥n "q0" deber√≠a indicar alguna ramificaci√≥n condicional (porque se usa para omitir la impresi√≥n de direcciones innecesarias en la funci√≥n 1v), y las instrucciones "9c11", "9c21", "9c41", " 9c81 "deber√≠a indicar alg√∫n tipo de instrucci√≥n AND: comprueban los bits establecidos para ver si estas direcciones est√°n permitidas (esto se insin√∫a claramente mediante el uso de" 1 "," 2 "," 4 "y" 8 "en estas instrucciones). <br><br>  Durante las siguientes dos horas, Zachary Wade (@ zwad3) y yo resolvimos las diversas instrucciones, formulando y refinando nuestras suposiciones sobre lo que estaban haciendo.  Tener muchas declaraciones impresas legibles hizo nuestro trabajo mucho m√°s f√°cil.  Decidimos que cada uno de nosotros individualmente escribir√≠a su propio desensamblador para poder examinar las instrucciones a nuestro propio ritmo y compartir nuestros hallazgos. <br><br><h3>  C√≥digo de ingenier√≠a inversa </h3><br>  Despu√©s de unas horas, comenc√© a hacer grandes progresos en el desmontaje.  Despu√©s de examinar el c√≥digo que funcionaba con el inventario del usuario (m√°s espec√≠ficamente, la funci√≥n "beber" y cada controlador asociado con √©l), encontramos instrucciones para guardar y cargar desde la memoria (no olvide que la CPU tiene 1 kibibyte de memoria de datos).  Luego descubrimos que algunas instrucciones aritm√©ticas / l√≥gicas (ALU) toman operandos de memoria (por ejemplo, "9c41" significa "ejecutar Y con valor en la direcci√≥n de datos 1 con valor 4").  A partir de esto, pudimos recrear las variables en la memoria de datos, por ejemplo, en [0] el identificador de NPC se almacena en la ubicaci√≥n actual, y en [6,7] se almacena la salud actual del jugador (los 5 bits inferiores en [6], los 5 bits m√°s antiguos en [7] ]).  En esta etapa, pas√© de las instrucciones de ingenier√≠a inversa a anotar mi c√≥digo desmontado e ingenier√≠a inversa del programa en s√≠.  A continuaci√≥n se muestra mi notaci√≥n divertida para valores de 5 bits: <br><br><blockquote> <code>_start: <br> call init <br> <br> L4: <br> call check_moves <br> call print_menu <br> call handle_command <br> br 4 <br> <br> print_menu: <br> call print_itemname <br> print 83k # 'SELECT AN OPTION\x0e:\r\n\r\n\x0f\x00' <br> call print_moves <br> call print_npcmenu <br> call print_itemmenu <br> print 4ss # '\r\nYOUR CHOICE\x0e: \x0f\x00' <br> ret <br> <br> print_moves: <br> and 0y1, [1] <br> brz 2k <br> print 6ds # '\x0e- \x0fGO \x0e(\x0fS\x0e)\x0fOUTH\r\n\x00' <br> 2k: and 0y2, [1] <br> brz 39 <br> print 6f5 # '\x0e- \x0fGO \x0e(\x0fN\x0e)\x0fORTH\r\n\x00' <br> 39: and 0y4, [1] <br> brz 3u <br> print 6d8 # '\x0e- \x0fGO \x0e(\x0fE\x0e)\x0fAST\r\n\x00' <br> 3u: and 0y8, [1] <br> brz 4j <br> print 6eh # '\x0e- \x0fGO \x0e(\x0fW\x0e)\x0fEST\r\n\x00' <br> 4j: ret <br> <br> print_npcmenu: <br> add 0y0, [0] <br> brz 6m <br> sub 0y2, [0] <br> br&lt;c&gt; 5p <br> print 7o1 # '\x0e- (\x0fT\x0e)\x0fALK TO \x00' <br> call print_npcname <br> call print_crlf <br> 5p: sub 0y1, [0] <br> brz 6m <br> print 7n2 # '\x0e- (\x0fF\x0e)\x0fIGHT \x00' <br> call print_npcname <br> call print_crlf <br> 6m: ret <br> <br> print_itemmenu: <br> print 7nh # '\x0e- (\x0fD\x0e)\x0fRINK\r\n\x00' <br> print 765 # '\x0e- \x0fSHOW \x0e(\x0fI\x0e)\x0fNVENTORY\r\n\x00' <br> ret</code> </blockquote> <br>  Todav√≠a tenemos muchos c√≥digos de operaci√≥n desconocidos, por ejemplo, aunque descubrimos que "qa" es una ramificaci√≥n condicional en cero (branch-on-zero, brz), no pudimos entender qu√© es "qc" (indicado anteriormente como br &lt;c&gt;).  Pero eso fue suficiente para comenzar a entender la l√≥gica del programa. <br><br>  De hecho, el juego permite al jugador moverse alrededor de un mapa de 8 √ó 8 en el que se colocan al azar NPC (dragones, toros rojos y humanos).  Puedes luchar con cualquier NPC (incluso Valis, a pesar de la falta de un elemento de men√∫ correspondiente).  Durante la batalla, puedes atacar al enemigo, causando una cantidad aleatoria de da√±o o falla, despu√©s de lo cual el enemigo ataca al jugador, causando tambi√©n una cantidad aleatoria de da√±o o falla.  Tambi√©n puedes elegir un bloqueo de escudo, gracias al cual el enemigo falla o golpea el escudo sin causar da√±o.  Finalmente, puede hacer trampa al aumentar su salud a 1000, pero en este caso, la variable oculta ("enga√±ado", direcci√≥n 10) se establece en 1. Si el jugador mata con √©xito al enemigo, un objeto se cae de √©l, generalmente una botella de algo de alcohol (obviamente, Este juego no es para ni√±os). <br><br>  El NPC Valis principal, del cual el jugador debe recibir la bandera, tiene una m√°quina de estado en la que le pide al jugador varios art√≠culos: un mont√≥n de bebidas Red Bull (obviamente obtenidas al derrotar a los enemigos Red Bull), varias bebidas mixtas (por ejemplo, gin tonic) para obtenerlos, debes derrotar al drag√≥n azul y al drag√≥n gris, y luego mezclar los objetos que se cayeron de ellos), y la tira de poder, que se puede obtener si derrotas a otra persona NPC en el juego (Redford) o lo ayudas.  Si cumple con toda esta larga serie de solicitudes, √©l le dar√° la bandera, pero <em>solo</em> si la variable "enga√±ado" no es igual a 1. Es decir, nuestra tarea es ganar el juego sin hacer trampa.  Como comenzamos con solo 100 HP, como todos los enemigos, con el paso habitual ser√° imposible derrotar a todos los enemigos (para obtener todas las cosas necesarias que necesita para derrotar a unos 20 oponentes).  Es necesario modificar el RNG de alguna manera, para que el enemigo siempre falle. <br><br>  Los n√∫meros aleatorios son generados por una funci√≥n que es similar a alg√∫n tipo de PRNG (direcci√≥n 37a), pero utiliza instrucciones √∫nicas que no se utilizan en ning√∫n otro lugar, por lo que no podemos realizar ingenier√≠a inversa.  Sin embargo, notamos que carga su vector de estado desde tres direcciones en la memoria ([11], [12] y [13]), es decir, su estado completo solo toma 15 bits.  Esto significa que el RNG debe tener un per√≠odo corto, no m√°s de 2 ^ 15 = 32768 de longitud. <br><br>  Mientras (sin √©xito) intentamos revertir la implementaci√≥n de RNG, Jay Bosamia (@ jay_f0xtr0t) y Matthew Savage (@thebluepichu) implementaron un exploit.  Simplemente enviando el comando "escudo" 100,000 veces seguidas, pudimos obtener una secuencia de "golpes" y "fallas" enemigas correspondientes a la salida de bits del RNG.  Nos aseguramos de que esta secuencia se repita con un per√≠odo de 32767. Gracias a esto, pudimos reunir nuestra haza√±a principal: cuando luchamos con el primer enemigo que conocimos, cerramos nuestros escudos 40 veces para recrear la secuencia de golpes y fallos, buscamos esta secuencia en una secuencia peri√≥dica grande y luego descubrimos cu√°ndo proteger y cu√°ndo atacar para que el enemigo siempre falle.  Luego, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recorrimos</a> todo el mapa en modo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">killhobo</a> , matando a todos y recogiendo su bot√≠n.  Al final, volvimos a Valis y cort√©smente pedimos nuestra bandera, que recibimos: <br><br><blockquote> <code>DrgnS{m4kin9-v4lis-happy-w1th-n4t1ve-b4ud0t-cpu}</code> </blockquote> <br>  Fuh!  De hecho, una verdadera aventura.  ¬°Todav√≠a no puedo creer completamente que pasamos de una cadena binaria y una falta total de documentaci√≥n del procesador a dos desensambladores casi completos y un c√≥digo desensamblado limpio en menos de 10 horas!  Todo el c√≥digo est√° disponible en GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mi desensamblador</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el desensamblador de Zachary</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mi c√≥digo desmontado sin procesar</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mi c√≥digo desmontado anotado</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el cliente de Matt's Exploit</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468849/">https://habr.com/ru/post/468849/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468837/index.html">C√≥mo realizar una entrevista t√©cnica: un plan de acci√≥n para principiantes</a></li>
<li><a href="../468841/index.html">Entrega continua para su biblioteca multiplataforma Kotlin</a></li>
<li><a href="../468843/index.html">¬øTienes miedo de implementar un sistema CRM? Tu negocio puede estar enfermo</a></li>
<li><a href="../468845/index.html">Un curso corto de fisiolog√≠a de la ciudad, o partes del cuerpo.</a></li>
<li><a href="../468847/index.html">Contrataci√≥n p√∫blica en otros pa√≠ses: por qu√© las leyes necesitan marcos</a></li>
<li><a href="../468851/index.html">Implementaci√≥n de animaci√≥n en React Native</a></li>
<li><a href="../469399/index.html">Wi-Fi en el Museo-Finca Arkhangelskoye</a></li>
<li><a href="../469401/index.html">Actualizaci√≥n del servicio 3CX WebMeeting, Elastix Online Converter y nuevos videos tutoriales</a></li>
<li><a href="../469403/index.html">Estamos entrevistando a un candidato para el puesto de Desarrollador de Software Senior</a></li>
<li><a href="../469405/index.html">Deep Learning ahora est√° en Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>