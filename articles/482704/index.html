<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíô ü§öüèø üëÜ Redis sincronizaci√≥n de cach√© para el servicio Go ‚ÜôÔ∏è üé£ ‚òùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 


 Durante el refinamiento de un proyecto, se hizo necesario almacenar en cach√© los datos solicitados con frecuencia. La implementaci√≥n ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Redis sincronizaci√≥n de cach√© para el servicio Go</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482704/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wd/5c/31/wd5c31_fbcdgecl9nmma5flqsoy.png" width="300"></div><br><h2 id="vvedenie">  Introduccion </h2><br><p>  Durante el refinamiento de un proyecto, se hizo necesario almacenar en cach√© los datos solicitados con frecuencia.  La implementaci√≥n del almacenamiento en cach√© es posible de diferentes maneras, pero quer√≠a implementarla con cambios m√≠nimos en el proyecto original.  El resultado, sus ventajas y desventajas se describen a continuaci√≥n. </p><a name="habracut"></a><br><h2 id="kak-vsyo-bylo">  Como estuvo todo </h2><br><p>  Inicialmente, para cada consulta que conten√≠a el identificador del objeto solicitado, se ejecut√≥ una consulta en la base de datos PostgreSQL (DB).  M√°s precisamente, varias consultas, ya que para formar una respuesta completa, era necesario aplicar a varias tablas de la base de datos.  Como resultado del procesamiento de solicitudes, se form√≥ un objeto bastante complejo, algunos de cuyos campos est√°n representados por interfaces.  En la memoria, este objeto ocupa unos 250 kB. </p><br><p>  El rendimiento con esta implementaci√≥n no fue excelente, no m√°s de 3500 RPS (solicitud por segundo) al solicitar los mismos datos con 1000 hilos competidores. </p><br><p>  La pregunta surgi√≥ de inmediato, pero ¬øc√≥mo aumentar RPS: cambiar el enrutador, optimizar la base de datos, almacenar en cach√© los datos?  El enrutador se us√≥ bastante bien ( <a href="httprouter" rel="nofollow">github.com/julienschmidt/httprouter</a> ), y reemplazar el enrutador en un proyecto grande requerir√° mucho tiempo y existe un alto riesgo de que algo se rompa.  Para optimizar el trabajo con la base de datos, tambi√©n deber√° volver a escribir una parte sustancial del c√≥digo (ahora usando <a href="http://github.com/jmoiron/sqlx" rel="nofollow">github.com/jmoiron/sqlx</a> ).  Obviamente, el almacenamiento en cach√© es la forma m√°s √≥ptima de aumentar RPS. </p><br><h2 id="prostoe-reshenie">  Soluci√≥n simple </h2><br><p>  Lo m√°s simple que viene a la mente es el uso de un cach√© en memoria.  Cuando se us√≥ tal cach√©, se obtuvieron aproximadamente 20,000 RPS.  El rendimiento de la memoria cach√© en memoria es excelente, pero no puede utilizar dicha memoria cach√© con muchas instancias de servicio.  Nunca se sabe a qu√© instancia del servicio volar√° una solicitud, y puede haber solicitudes no solo para recibir datos, sino tambi√©n para eliminar / actualizar. </p><br><p>  El rendimiento obtenido con el cach√© en memoria se tom√≥ como est√°ndar en una b√∫squeda adicional de una soluci√≥n. </p><br><h2 id="ideya-plohaya-ideya">  Idea, mala idea </h2><br><p>  ¬øEs posible poner el resultado de la consulta como est√° en la base de datos NoSQL Redis?  Esta es una soluci√≥n t√≠pica para almacenar en cach√© las solicitudes de respuesta.  Los datos se almacenan en la memoria, cuando se usan varias instancias del servicio, todos pueden usar una memoria cach√© com√∫n.  Esta soluci√≥n se implement√≥ r√°pidamente.  Y las pruebas mostraron ... Y las pruebas mostraron que el rendimiento no aument√≥ mucho. <br>  La investigaci√≥n adicional mostr√≥ que las principales p√©rdidas de rendimiento est√°n asociadas con la clasificaci√≥n y la desorganizaci√≥n.  La conversi√≥n de una estructura a JSON y viceversa requiere el uso de la reflexi√≥n, que es extremadamente costosa en rendimiento.  Es imposible rechazar la clasificaci√≥n / desorganizaci√≥n, ya que es necesario obtener un objeto completo del cach√© con la capacidad de llamar a m√©todos de estructuras, y no solo obtener los valores de los campos individuales.  El uso de varias bibliotecas con la optimizaci√≥n de clasificaci√≥n / descompresi√≥n tampoco ahorr√≥, hubo crecimiento, pero el cach√© en memoria estaba muy lejos.  Por lo tanto, se decidi√≥ no hacer amigos con el "erizo y la serpiente" y hacer un cach√© h√≠brido. </p><br><h2 id="gibrid-uzha-i-ezha">  H√≠brido "serpiente y erizo" </h2><br><p>  No puede llamarlo un h√≠brido completo (ver. Fig.). De hecho, result√≥ un cach√© en memoria, pero con sincronizaci√≥n a trav√©s de Redis ( <a href="http://github.com/go-redis/redis" rel="nofollow">se utiliz√≥</a> la biblioteca <a href="http://github.com/go-redis/redis" rel="nofollow">github.com/go-redis/redis</a> ).  Solo el identificador √∫nico del objeto solicitado de la base de datos (objeto ID) se almacenar√° en Redis.  Se agregar√° a Redis durante el procesamiento de una solicitud para crear un objeto, o una solicitud para obtener un objeto existente de la base de datos.  La ID del objeto servir√° como la clave para el valor en Redis, y el valor ser√° el UUID generado (identificador universalmente √∫nico, identificador √∫nico universal ").  El UUID se generar√° solo cuando el objeto se agregue a Redis.  Por qu√© se necesita este UUID se describir√° m√°s adelante. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/nr/x7/jhnrx7d01qxmgll-s4jtcz4cc7g.jpeg"></div><br><p>  <b>Diagrama de bloques de la interacci√≥n de componentes para la sincronizaci√≥n de cach√© a trav√©s de Redis</b> </p><br><p>  El cach√© en memoria se implementa en base a sync.Map.  Para los elementos de cach√© h√≠bridos, se establece TTL (tiempo de vida, vida √∫til), y si Redis limpia los elementos "sucios", el temporizador limpia el cach√© en memoria (time.AfterFunc).  Pasa a trav√©s de todos los elementos del cach√© y comprueba si el elemento est√° "podrido".  Si se accede a un elemento de cach√©, su vida √∫til se extiende; una operaci√≥n similar se realiza con claves en Redis. </p><br><p>  Entonces, ahora de acuerdo con el algoritmo.  Si llega una solicitud y necesitamos extraer el objeto, se realiza la siguiente secuencia de acciones: </p><br><ol><li>  Observamos si hay un objeto con un objeto de ID dado en Redis, si es as√≠, podemos tomar el cach√© de instancia de servicio de la memoria: <br><ol><li>  Si el objeto no est√° en el cach√© en memoria, lo tomamos de la base de datos y agregamos el cach√© con el UUID de Redis al cach√© en memoria y actualizamos el TTL de la clave en Redis. </li><li>  Si el objeto est√° en la memoria cach√© en memoria, lo tomamos de la memoria cach√©, verificamos si el UUID en la memoria cach√© y en Redis coinciden, y si es as√≠, actualizamos el TTL en la memoria cach√© y en Redis.  Si el UUID no coincide, elimine el objeto de la memoria cach√© en memoria, t√≥melo de la base de datos, agregue la memoria cach√© con el UUID de Redis a la memoria. </li></ol></li><li>  Si el objeto no est√° en Redis, entonces si el objeto est√° en el cach√©, ret√≠relo del cach√©.  Tome un objeto de la base de datos y agr√©guelo al cach√© y a Redis.  Para eliminar la situaci√≥n cuando actualizar / eliminar una entrada es m√°s r√°pido que agregar al cach√© ( <a href="https://habr.com/ru/post/482704/">comentario de andreyverbin</a> ), agregue un objeto con un UUID cero al cach√©.  Luego, en el primer acceso al cach√©, se revelar√° la diferencia en UUID con Redis, y se solicitar√°n nuevamente los datos de la base de datos. </li></ol><br><p>  Si llega una solicitud para eliminar un objeto, se elimina inmediatamente de la base de datos y luego las operaciones de cach√©: </p><br><ol><li>  Eliminar el objeto en Redis. </li><li>  Elimine el objeto en la memoria cach√© en memoria. </li></ol><br><p>  Ahora, si llega una solicitud similar en otra instancia del servicio, aunque el objeto todav√≠a puede estar en la memoria cach√© en memoria, no se utilizar√°. </p><br><p>  Actualizaci√≥n de objeto, despu√©s de actualizar en la base de datos: </p><br><ol><li>  Eliminar el objeto en Redis. </li><li>  Elimine el objeto en la memoria cach√© en memoria. </li></ol><br><p>  Cuando solicite un objeto en otra instancia del servicio, se revelar√° que no est√° en Redis, por lo que debe tomarlo de la base de datos.  Si hay otra instancia del servicio, y la solicitud vol√≥ hacia ella despu√©s de actualizar el objeto y despu√©s de agregarla por segunda instancia en Redis, entonces, al verificar el UUID, se revelar√° una diferencia, y la tercera instancia del servicio tambi√©n tomar√° el objeto de la base de datos. </p><br><p>  Es decir  de hecho, en cualquier situaci√≥n incomprensible, creemos que nuestro cach√© es incorrecto y necesitamos tomar datos de la base de datos. </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  La soluci√≥n desarrollada tiene ventajas y desventajas. </p><br><h3 id="plyusy">  Pros </h3><br><ul><li>  El esquema de almacenamiento en cach√© desarrollado permiti√≥ alcanzar aproximadamente 19000 RPS, que es casi equivalente a las pruebas con cach√© en memoria. </li><li>  El c√≥digo original del proyecto tiene un n√∫mero m√≠nimo de cambios. </li></ul><br><h3 id="minusy">  Contras </h3><br><ul><li>  Si Redis falla, el servicio disminuye dr√°sticamente el rendimiento y se basa en trabajar con la base de datos. </li><li>  Cada instancia del servicio requerir√° m√°s memoria porque tiene su propia cach√© en memoria. </li></ul><br><p>  Como el alto rendimiento era m√°s importante, no considero que las desventajas sean cr√≠ticas.  En el futuro, existe la idea de escribir una biblioteca para simplificar la implementaci√≥n de la memoria cach√© h√≠brida, ya que es necesario utilizar el almacenamiento en cach√© similar en otros proyectos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482704/">https://habr.com/ru/post/482704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482694/index.html">¬øHay vida despu√©s de Windows o d√≥nde desarrollar un administrador / ingeniero del sistema de Windows en 2020?</a></li>
<li><a href="../482696/index.html">Cifrado de disco completo de los sistemas instalados con Windows Linux. Arranque m√∫ltiple encriptado</a></li>
<li><a href="../482698/index.html">[Ensayo] Dedicado a Office Plankton. No estoy inspirado por mi trabajo</a></li>
<li><a href="../482700/index.html">C√≥mo "joder" Google y Yandex: promoci√≥n de sitios SEO en blanco y negro. Shestakov | Personas PRO # 74</a></li>
<li><a href="../482702/index.html">¬øRealmente necesitamos TypeScript en 2020?</a></li>
<li><a href="../482706/index.html">Recomendaciones para la implementaci√≥n de contabilidad paralela RAS + IFRS en la plataforma 1C</a></li>
<li><a href="../482708/index.html">Una caracter√≠stica de la cultura corporativa necesaria para el bienestar de la base del c√≥digo</a></li>
<li><a href="../482714/index.html">La columna de radio por Internet m√°s simple "Kodi" o el rescate del ladrillo "Frambuesa"</a></li>
<li><a href="../482716/index.html">Desarrollo de una placa de depuraci√≥n para K1986BE1QI (aire)</a></li>
<li><a href="../482718/index.html">Pir√°mide invertida como final de su proyecto.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>