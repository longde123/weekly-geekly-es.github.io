<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏇🏾 👈🏿 🎭 将代码直接部署到docker容器。 或者如何在每次提交后不拖延 👵🏻 🌍 🧑🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="任务来了WEB-12982 
 在存储库中创建一个web-12982分支 
 分支进行时，阅读tz并喝咖啡 
 直接进行开发 

 git commit，git push 
 分支重新组装时 
 git commit，git push 
 重建分支时，翻转Twitter 
 git commit，g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>将代码直接部署到docker容器。 或者如何在每次提交后不拖延</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439262/"><blockquote>  <em>任务来了WEB-12982</em> <br> 在存储库中创建一个web-12982分支 <br>  <em>分支进行时，阅读tz并喝咖啡</em> <br>  <em>直接进行开发</em> <br><br>  <em>git commit，git push</em> <br> 分支重新组装时 <br>  <em>git commit，git push</em> <br> 重建分支时，翻转Twitter <br>  <em>git commit，git push</em> <br>  ... <br>  <em>您将提交50个提交的评论分支</em> <br><br> 您了解50次提交恰好是50分钟的纯时间，因为它是适当的并开始收集，因为1分钟的间隔太短了，无法进行拖延和基本需求以外的任何事情。 </blockquote><p><img src="https://habrastorage.org/webt/wk/fr/gn/wkfrgnyb8_mtcoblzg_hm2fi_9c.png"></p><br><p> 情况熟悉吗？ 在我公司，开发基础结构的组织如下： </p><br><ul><li>  Hitlab有许多项目存储库 </li><li> 为确保在创建新分支时易于开发，码头工人会自动在唯一的地址（具有所有必要环境的父分支的完整副本）上创建自己的沙箱。 </li><li> 您所需的一切都已准备就绪-只需编写代码并在每次提交后测试并查看结果，这<strong>非常方便！</strong> </li></ul><br><p>  <strong>但是，慢慢地...</strong>如果这种情况很接近您，欢迎您的光临。 </p><a name="habracut"></a><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">问题的实质</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解决方案选项</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解决方案实施</a> </li></ul><br><h2 id="sut-problemy--a-nameproblema"> 问题的实质 </h2><br><blockquote>  <strong>tldr：</strong>对代码所做的更改要求重新组装容器并花费时间（一分钟以上，这取决于项目，尤其是如果配置了CI \ CD的话），这实际上并没有用处，但是完全占用了程序员的工作时间。 </blockquote><br><div class="spoiler">  <b class="spoiler_title">类似的问题定期出现在所有</b> <div class="spoiler_text"><p> 例如，很明显地，为前端发明了相同的liveReload </p></div></div><br><p> 我之前曾发表<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">过一篇与相关主题有关的文章</a> ，但与调试过程有关（顺便说一句，感谢您的翔实评论和积极反馈）。 但是，关于剪切的问题基本上没有消失，我们还继续等待直到分支重新组装为止。 </p><br><p> 即使跳过了其他阶段，仅保留了build-dev和deploy-dev，等待时间对于任何有用的操作来说都是微不足道的，但对于总花费的时间来说却是相当可观的，尤其是对于CI \ CD，例如来自Gitlab的情况。 </p><br><p> 当然，如果程序员具有相对强大的计算机，配置了gitlab-runner，配置了与远程服务器上相同的环境，并且将相应的标签添加到gitlab-ci.yml中，则可以通过本地组装项目来加快该过程。在ctrl + s键之后，构建速度将与自动FTP代码部署相同。 </p><br><p> 特别是 <del> 烫伤 </del> 当您在开发过程中犯下通常不会影响应用程序操作的错别字/错误时，这很累人，但是不能像这样留下错误，并且只有在组装后查看结果时才会注意到它们。 </p><br><h2 id="chto-trebuetsya-i-varianty-resheniya-a-namevariantsa"> 需要什么和解决方案选项 </h2><br><blockquote>  <strong>tldr：</strong>找到一种方法，以尽可能简单，快速地查看编辑结果。 为了不每次都提交并且不等待重建分支。 我从本地计算机选择rsync到与容器文件夹一起安装的远程服务器文件夹。 </blockquote><p> 我没有在Internet上找到完整的解决方案，但实际上有几种选择： </p><br><ul><li> 使用代码库直接在容器中配置ftp \ ssh，将其包含在映像中，通过FTP直接连接到容器本身 <br><ul><li> 就我个人而言，这种选择似乎有点复杂，而且过于“拐杖”，尽管这里所有的选择都是拐杖。 </li></ul></li><li>  （供本地使用）使用<strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker cp</a></strong>将代码直接加载到容器中 <br><ul><li> 该选项不适用于远程服务器。 </li><li>  docker cp的功能极为有限，因为不应每次都复制供应商文件夹，并且复制算法本身也会很慢。 </li></ul></li><li>  （供远程\本地使用）将所需的容器文件夹安装到外部主机文件夹。 将本地文件直接下载到已安装的主机文件夹中。 已经有很多实现选项： <br><ul><li> 使用docker-machine特别是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker-machine scp</a> <br><ul><li> 同样，您需要配置环境，配置docker-machine，也许这在您经常使用其他服务器时是有意义的 </li></ul></li><li> 在IDE中，使用所需的主机文件夹配置FTP连接 <br><ul><li> 每个新分支都需要创建一个新连接或更改映射 </li></ul></li><li> 使用scp或rsync将文件上传到所需的主机文件夹，为此，请使用小的bash脚本并将其挂在热键上 <br><ul><li> 起初，它似乎不必要地复杂，但实际上并非如此。 该脚本本身尽可能简单，并且需要自动化该过程，因此您不必每次都重新配置映射 </li></ul></li></ul></li></ul><br><h2 id="samo-reshenie-rsync--volumes-a-namedecisiona"> 解决方案本身：rsync +卷 </h2><br><blockquote>  <strong>tldr：</strong> <br><ul><li> 需要ssh访问远程服务器并在本地计算机上进行rsync </li><li> 远程服务器必须具有可写文件夹 </li><li> 将容器中的项目文件夹安装到外部主机文件夹 </li><li> 将一个小的bash脚本添加到项目的根目录，以与远程服务器同步文件 </li><li> 配置用于执行同步脚本的热键 </li></ul><br></blockquote><p>  <strong>值得注意的是，提供的解决方案不包括在开发和测试环境中</strong> </p><br><p> 在这种情况下，我将研究docker-compose和gitlab-ci环境，其中docker-compose使用gitlab-ci中的环境变量。 </p><br><p> 我们在gitlab-ci中形成目标文件夹的路径，并将此路径导出到docker-compose.yml： </p><br><pre><code class="plaintext hljs">before_script: - export SHARED_DIR_BASE='/var/www/builds' #    ,      - export SHARED_BRANCH_DIR=${SHARED_DIR_BASE}/${PROJECT_GROUP}/${PROJECT_NAME}/${CI_COMMIT_REF_NAME} #     web-123   my_group/my_project,      /var/shared/my_group/my_project/web-123 Deploy dev: stage: deploy_dev script: #   ,         - mkdir -p ${SHARED_BRANCH_DIR} - rsync -r --exclude-from=.gitignore --exclude-from=.dockerignore . ${SHARED_BRANCH_DIR} - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -d -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type f -exec setfacl -mo:rwx {} \; - envsubst &lt; docker-compose.tmpl &gt; docker-compose.yml #     gitlab-ci.yml  docker-compose.yml,   docker-compose.tmpl - docker-compose up -d</code> </pre> <br><p> 接下来，我们需要将项目文件夹安装到docker-compose的外部主机文件夹中，因为我们在docker-compose中使用了变量，所以我们需要docker-compose.tmpl模板，在其中将使用这些变量。 </p><br><pre> <code class="plaintext hljs">version: '2.3' services: web: ... volumes: - ${SHARED_BRANCH_DIR}:/app/:rw #             #        .    ,      ,           .              ,     ,        - /app/protected/vendor/</code> </pre> <br><p> 当前的配置已足够，现在，当您在主机服务器上构建分支时，将创建<strong>/ var / www / builds / GROUP_NAME / PROJECT_NAME / BRANCH_NAME</strong>文件夹，项目将被转移到那里，除了.gitignore和.dockerignore中指定的文件和文件夹之外，然后您可以简单地配置FTP映射，但是我们会做得更远，并使过程更加自动化。 </p><br><p> 实际上，要同步文件，我们需要运行以下命令： </p><br><pre> <code class="bash hljs">rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . <span class="hljs-variable"><span class="hljs-variable">$sshUserName</span></span>@<span class="hljs-variable"><span class="hljs-variable">$sshHost</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sharedBaseDir</span></span></code> </pre> <br><p> 实际上，在中小型项目上，此命令的执行速度比您有时间提交并将编辑内容推送到存储库的速度快。 仍然需要使该脚本具有更完整的外观，并将其执行绑定到热键。 </p><br><div class="spoiler">  <b class="spoiler_title">完整脚本代码：deploy.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash #    while [ -n "$1" ] do case "$1" in --sshUserName=*) sshUserName=${1#*=} ;; --sshHost=*) sshHost=${1#*=} ;; esac shift done #  shared    gitBranch=$(git branch | grep \* | cut -d ' ' -f2) gitProject=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)\.git#\1#p') gitGroup=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)/.*\.git#\1#p') sharedBaseDir=/var/www/builds/$gitGroup/$gitProject/$gitBranch #         rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . $sshUserName@$sshHost:$sharedBaseDir echo "done"</span></span></code> </pre> </div></div><br><p> 应该注意的是，该脚本必须位于存储库的项目文件夹的根目录中，或指示该脚本应在哪个目录中工作。 </p><br><p> 仅保留该脚本到特定热键的执行并设置参数sshUserName和sshHost（可以理解，已经可以通过ssh访问远程服务器）。 我将举一个PHPstorm的例子。 </p><br><ul><li> 转到<strong>文件-&gt;设置</strong> </li><li> 在左侧菜单的设置窗口中，展开<strong>工具</strong> ，然后选择<strong>外部工具</strong> </li><li> 我们编写脚本的路径，并在参数中指定实际的sshUserName和sshHost <br><br><img src="https://habrastorage.org/webt/wv/j6/zq/wvj6zq86jwgy2s4gh01ouqrq7d8.png"></li><li> 接下来，转到<strong>Keymap</strong>并查找我们的外部工具的名称，设置必要的组合 <br><br><img src="https://habrastorage.org/webt/ao/9y/iy/ao9yiyq5zahfsqkeh4lsfgb3wi4.png"></li></ul><br><p> 仅此而已。 现在，当您单击所需的组合时，所有项目文件都将与远程文件夹同步，该远程文件夹随项目文件夹一起安装在容器内。 也就是说，任何更改都将几乎立即可见。 </p><br><p> 我并不假装此解决方案是“理想的”，可能有更好的选择，如果我在评论中了解到它们，我将很高兴。 谢谢你 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN439262/">https://habr.com/ru/post/zh-CN439262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN439248/index.html">艾伦·凯：“古罗马人可以建造一台计算机吗？”</a></li>
<li><a href="../zh-CN439252/index.html">在亚美尼亚发展IT职业的6个理由</a></li>
<li><a href="../zh-CN439254/index.html">我们的一切</a></li>
<li><a href="../zh-CN439258/index.html">Rust中的通用方法：Exonum如何从铁转变为Actix-web</a></li>
<li><a href="../zh-CN439260/index.html">《巫师》的作者仍将获得CD Projekt Red的赔偿。</a></li>
<li><a href="../zh-CN439264/index.html">如何在不聘请PM的情况下管理复杂的技术项目：DataLine经验</a></li>
<li><a href="../zh-CN439266/index.html">从零开始独自为Android创建游戏的体验以及将其记入Google Play的方式</a></li>
<li><a href="../zh-CN439268/index.html">VR，AR和3D打印如何协同工作：VR概念体验</a></li>
<li><a href="../zh-CN439270/index.html">在Python中使用libclang解析C ++代码的示例</a></li>
<li><a href="../zh-CN439272/index.html">Netflix上的Jupyter Notebook</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>