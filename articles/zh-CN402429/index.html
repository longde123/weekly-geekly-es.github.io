<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖥️ 📯 👊 RobotDyn强袭加倍：Mega + ESP8266 🤾🏽 💄 🙍🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="开发人员在罕见的休闲时间里会做什么？ 没错，浏览钢铁商店的价格表。 有一个空闲的时间，我决定浏览一下流行的在线商店的页面-无聊，没什么有趣的，我们已经看到了所有这一切...然后突然我的眼睛落在了下一个Mega上。 ah！ 是的，它不仅是Mega，而且还与每个人都钟爱的ESP8266结合在一起，并精心...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RobotDyn强袭加倍：Mega + ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402429/"><img src="https://habrastorage.org/files/07a/66b/52f/07a66b52ff5d4326bcef6a7fd2749aef.jpg" alt="RobotDyn Mega + ESP8266"><br> 开发人员在罕见的休闲时间里会做什么？ 没错，浏览钢铁商店的价格表。 有一个空闲的时间，我决定浏览一下流行的在线商店的页面-无聊，没什么有趣的，我们已经看到了所有这一切...然后突然我的眼睛落在了下一个Mega上。  ah！ 是的，它不仅是Mega，而且还与每个人都钟爱的ESP8266结合在一起，并精心配备了两个控制器可以协同工作的开关-有线（使用Ethernet Shield）与大量GPIO和Wi-Fi进行无线通信。 <br><br> 还不错！ 我想到并记得关于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AMS的信息</a> -您可以在其中安装两台服务器-有线和无线并将它们连接到一个系统中-ESP8266将接收54个数字和16个模拟引脚，Mega将通过Wi-Fi和所有ESP8266包子进行无线控制。 很久以前，我没有遇到过如此有趣的董事会。 <br><br> 你好 您有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mega + ESP8266开发</a>板吗？ <br>  -是的，但只剩一个了。 <br>  “为什么只有一个？” <br>  -剩下的被拆了。 <br>  “请为我保留她。” <br><a name="habracut"></a><br><h2> 关于公司的几句话 </h2><br> 我喜欢RobotDyn有两点：第一-具有技术解决方案。 无需走太远，一个很好的例子就是正在考虑的Mega + ESP8266开发板。 我在我们的在线商店（不是我们的商店，但我并不是真的在这里寻找）中没有看到这样的内容。 这不是唯一的例子，仍然有Uno + ESP8266选项，该公司显然不会止步于此，显然还有许多有趣的设备在等着我们。 <br><br> 其次是其定价政策。 我不会在这里详细讨论这个问题，但我会说价格令我感到惊喜-公司的座右铭是“价格就像速卖通上的价格一样”。 <br><br> 简而言之，我描述了随后发生的所有事件的背景，现在我们直接进入技术细节，对电路板的描述以及如何使用它。 <br><br><h2> 董事会本身 </h2><br> 总的来说，一块普通的板与许多类似的板没有什么不同，即使不是很小的一部分，也就是集成到板中的ESP8266EX芯片。 这立即将董事会转移到非凡的解决方案类别。 我想提请您注意更多细节-电路板上没有集成ESP-12类型的标准模块，但是芯片和所有布线都在电路板上本身完成，这透明地暗示了开发人员的水平。 我还想指出，该板同时具有印刷天线和用于连接外部天线的连接器，这在许多情况下可能非常有用。 <br><img src="https://habrastorage.org/files/1d1/cee/155/1d1cee155967488581228289df3b6f28.jpg" alt="RobotDyn Mega + ESP8266"><br> 板上有用于连接ESP8266端子和多个开关的引脚连接器，值得一提。 使用开发板的主要思想是使用开关，可以用不同的方式配置其三个组件的交互：Atmega2560芯片，ESP8266EX芯片和CH340G USB-TTL转换器。 单个和复杂连接都可以，这使您可以为电路板各部分的交互组织许多选项。 这为构建各种设备提供了巨大的机会，但稍后会介绍更多。 <br><br><img src="https://habrastorage.org/files/cb4/2f4/819/cb42f4819ba940369ad71818bbc7ff03.jpg" alt="ESP8266前端"><br><br> 我还想指出板子的良好负载能力。 从上面的铭文判断，它能够在5伏通道上提供1.6 A的负载电流，在3.3伏上提供1 A的负载电流。 这非常好，尤其是总体而言。 <br><br> 关于该板没有更多可说的了，我们转向安装软件并对其进行测试。 <br><br><h2> 董事会测试 </h2><br> 由于开发板是集成的，几乎没有可用空间，并且ESP8266EX的高频部分都已在其上进行布线，因此最初引起了人们对整个经济环境的正确且无故障运行的怀疑。 <br><br> 展望未来，我要说的是，尽管有我的担忧，但一切都稳定且符合预期。 我们将Atmega2560板上的开关连接到USB-我们将Arduino Mega连接到我们，将ESP8266EX连接到USB-我们将ESP8266连接到ESP8266EX并切换到Atmega2560的连接模式，然后通过串行接口获得芯片之间的连接。 一切工作均与文档中所述完全相同，并且与直观预期完全相同。 <br><br> 该解决方案的一大优点是，开发人员负责匹配所有系统组件的逻辑信号电平。 手动尝试配置ESP8266模块并正确连接所有上拉电阻的任何人都会了解我。 不会出现此类问题，您可以按照制造商的说明将所有工作简化为单击板上的开关。 <br><br><h2> 负载测试 </h2><br> 如何测试板？ 您可以下载一些标准草图，但这将是一项测试。 该选项可能工作正常，并且在战斗条件下系统将发生故障。 因此，在相应版本的Arduino Mega Server的控制下，两个部分的工作都被选作硬负载测试。 对于Mega-适用于Mega的Arduino Mega Server和ESP8266-适用于M1版本的ESP8266的Arduino Mega Server。 <br><br> 选择M1分发套件是因为板上仅安装了1 MB的ESP8266闪存。 我认为，这几乎是开发人员唯一的错误-在将来的主板修订版中，我建议他们放置4 MB的存储芯片。 价格差异很小，使用4 MB版本的可能性更大。 但是由于有一个用于1 MB系统的AMS版本，因此我对此并没有过多注意，而是继续进行测试。 <br><br> 说什么 我们打开板子，填写软件并获得两个独立的服务器。  1个通过Ethernet Shield有线连接，1个通过Wi-Fi无线连接。 美女！ <br><br> 我还要指出的是，即使在这个已经很复杂的系统中添加带有读卡器的Ethernet Shield，也不会引起任何冲突或故障-一切都按应有的方式进行。 在某些情况下，它甚至比平时还要好-这是ESP8266固件在100％情况下成功通过无线传输的第一块板，在所有其他板和模块上，这种闪烁有时会导致故障。 <br><br> 两台服务器正在旋转，正在加载电路板，履行其职责，仅此而已。 一切正常，甚至无话可说，但这可能是任何技术系统的最佳称赞。 <br><br><h2> 最有趣 </h2><br> 从纯粹的学术角度来看，我在这里描述的内容很有趣：一个有趣的板子，一个有趣的技术解决方案，但是我们当然对它的实际应用感兴趣。 它的实用和应用亮点是什么？ <br><br> 事实是，板上有一个开关，您可以将其两个部分（Mega和ESP）连接到一个单元中，从而首先获得新的质量体系，其次可以弥补每个单独部分的固有缺陷。 <br><br> 让我们从ESP8266开始。 这种普遍出色的解决方案的主要缺点是GPIO引脚严重缺乏。 正如他们所说，一，二和计算错误。 很难说出这款芯片的开发者的想法，但是在ESP32发行之前，他们有更多的时间去思考，他们解决了新芯片中的这一缺点。 但是我们专门处理8266。 <br><br> 该评估板可让您动起来并充分利用Mega的全部功能，其中包括ESP8266中的54个数字输出和16个模拟输出。 也就是说，我们摇摇欲坠的ESP突然获得了与传感器，执行器和其他外围设备一起工作的绝佳机会。 可以这么说，事实证明，婴儿类固醇的ESP。 <br><br> 这只是使用表面上的木板的可能选择之一。 <br><br> 现在让我们看一下兆丰。 她不会干扰无线接口以及与Wi-Fi设备进行交互的能力，这可以使她与系统的ESP部分集成在一起。 同时，仍然有可能通过有线以太网接口进行并行操作。 <br><br> 而且，这也是该板表面上可能的应用之一。 <br><br> 好吧，各种桥接选项：以太网-Wi-Fi，nRF24-以太网，nRF24-Wi-Fi，nRF24（1）-nRF24（2），nooLite-Wi-Fi，nooLite-以太网，nooLite（1）-nooLite（2 ）等到无穷大。 您可以在板的两个部分以及与其相连的接口之间路由来自数十个子系统的信号，Arduino Mega Server可以通过这些子系统工作。 <br><br> 我什至不知道该说些什么。 很酷 <br><br><h2> 技术细节 </h2><br> 现在介绍一些技术细节。 您会看到一个表格，其中列出了板的所有可能的操作模式，并显示了板上所有可能的开关位置。 让我们简要地考虑每种模式。 <br><br><img src="https://habrastorage.org/files/a51/cc7/874/a51cc7874a274215b06fc93c7d7dbd4d.png" alt="RobotDyn板操作模式表"><br><br><h4>  Arduino Mega 2560 </h4><br> 板子最简单的操作模式在表中被指定为模式3。如果将开关3和4设置为ON位置，将其余开关设置为OFF位置，我们将得到普通的Arduino Mega2560。没有什么有趣的，因此，不值得购买此板子，您可以是买平常的兆丰。 <br><br><h4>  ESP8266 </h4><br> 同样不是很有趣的操作模式。 在表中，它分为两个子模式，分别为1（将草图加载到ESP）和2（ESP到USB连接模式）。 这是标准ESP8266的所有功能，因此，不值得购买此板，可以通过常规ESP模块获得。 <br><br><h4> 都是独立的 </h4><br> 我们也不会在第6个位置考虑此选项，因为其中板子各部分之间的所有连接都断开了，对于任何事情它绝对对我们没有用。 <br><br><h4>  Mega与ESP之间的联系 </h4><br> 在此模式下，指定为5，通过串行接口在Mega和ESP之间建立通信，但没有与USB-TTL转换器进行通信。  ESP使用标准的Serial，而Mega使用不少于标准的Serial3。 该连接稳定且无缝地以115200的速度运行。当没有控制器具有USB连接时，这是一种相当特定的操作模式。 所以他对我们也不是很有趣。 <br><br><h4>  Mega和ESP以及Mega和USB同时通信 </h4><br> 但这就是所谓的王牌。 我们立刻获得了一切-Mega USB连接以及能够通过同一USB将草图上传到Mega并控制其操作的功能，Mega与ESP之间进行通讯的可能性以及能够将草图上传到ESP8266并能够在USB接口中控制其操作的功能... Mega！ 也就是说，完全填充，而不是直接离开收银机。 <br><br> 这是表中列出的唯一正确的操作模式。 记住他的中奖号码是四。 在板上的开关配置中，它看起来也很漂亮-1，2，3，4处于ON位置，其余均为OFF。 <br><br> 一个细心的读者会问：如果USB端口正忙于连接系统的Mega部分，如何将草图上传到ESP8266？ 这是正确的问题，答案是没有办法。 那么，为什么要在这种配置中编写我们可以将草图上传到ESP8266呢？ 因为Arduino Mega Server可以通过按几个按钮直接从Arduino IDE空中下载草图，所以没错-我们已经装满东西了，一切都可以立即使用。 <br><br> 但是，那些想在没有Arduino Mega Server的情况下使用开发板的人呢？ 只有两个选项：不断单击开关，或在设计中添加通过空中下载草图的功能。 我个人更喜欢第二种选择。 <br><br><h2>  Arduino IDE设置 </h2><br>  Mega的Arduino IDE设置没有任何问题，所有设置都是标准设置，对于ESP8266，我将给出菜单屏幕截图，其中包含RobotDyn板上ESP部件的特定实现的设置。 您必须为自己设置相同的参数，端口号除外-系统上的端口号很可能会具有不同的值。 <br><br><img src="https://habrastorage.org/files/e1f/d98/bac/e1fd98bacc664b7e931699cb65b1c6ae.png" alt="Arduino IDE中的ESP8266设置"><br><br><h2> 适用于RobotDyn Mega + ESP8266的Arduino Mega Server </h2><br> 对于此板，已发布了特殊的Arduino Mega Server双版本，其中一次包含两台服务器，专门针对此板进行了优化。 这是没有问题的，这两个服务器都包含标准功能，可用于您的任何项目。 <br><br> 您可以在同一块板上独立使用这两个服务器，也可以添加所需的功能，并在两个网络以及连接到服务器的任何接口之间以串联方式和桥接方式使用它们。 <br><br>  RobotDyn Mega + ESP8266板的第一个Arduino Mega Server组件包含一个通过串行接口交互两个控制器的测试示例。 这是技术功能的演示，您可以在此基础上开发自己的解决方案。 <br><br> 现在，我们将更多地讨论通过串行接口（特别是在此板上）用于两个控制器交互的协议的开发。 <br><br><h2> 协议开发 </h2><br> 我们应该建什么房子？ 是否需要通过串行接口开发系统的两个部分之间的交互协议？  -我们将不断发展，主要是清楚，正确地设置任务。 为了演示系统的串联操作，我们在每台服务器的仪表板上显示“伙伴”操作指示器。 <br><br>  <em><strong>关于术语的一些知识。</strong></em>  <em>对于Mega，“伙伴”是ESP8266，对于ESP8266，分别是Mega。</em> <br><br> 当伙伴处于工作状态时，指示灯将呈绿色亮起；不处于工作状态时，指示灯将呈红色和灰色（未定义状态）。 这非常方便-在运行过程中，您将立即看到系统变更自我的状态。 <br><br> 对于这个问题的实际解决方案，正好有上百万种方式，我们将选择以下方式：系统两部分的通信块将是相同的，交互将以全双工模式发生，信息块将具有简单易懂的格式： <br><br><pre><code class="java hljs">?=</code> </pre> <br> 或 <br><br><pre> <code class="java hljs">?</code> </pre><br> 这只是解决任务的测试示例，您可以修改此交互协议或编写适合您任务的自己的交互协议。 但是，在已经实施的协议上，您不仅可以监视伙伴的状态，还可以将其用于许多其他目的，例如，传输控制器引脚的状态，传感器的状态或向伙伴发送控制命令。 <br><br> 具体来说，在我们的系统中，团队将如下所示： <br><br>  <strong>？mega = 1-</strong>兆发送有关其性能的数据。 参数“ mega”，值“ 1”。 <br><br>  <strong>？esp = 1</strong> -ESP8266发送有关其运行状况的数据。 参数为“ esp”，值为“ 1”。 <br><br> 因此，例如，考虑为系统的Mega部分实现协议。 <br><br> 以标准方式，我们以115200的速度初始化AMS模块和Serial3 Mega硬件。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial3.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); modulRobotdyn = MODUL_ENABLE; started(<span class="hljs-string"><span class="hljs-string">"RobotDyn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br> 我们检查Serial3端口的状态，对于来自伙伴的数据，我们形成字符串变量serialReq，其中包含接收到的数据或命令。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSerial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial3.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sFlag) { serialReq = <span class="hljs-string"><span class="hljs-string">""</span></span>; sFlag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = Serial3.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">10</span></span>) { sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; parseSerialStr(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial()</span></span></code> </pre><br> 我们解析命令和数据，并在获得有关伙伴状态的信息的情况下，采取改变esp变量状态的措施。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseSerialCmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String command, parameter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pBegin = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pParam = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command = serialReq.substring(pBegin); parameter = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command != F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { Serial.print(F(<span class="hljs-string"><span class="hljs-string">"command/parameter: "</span></span>)); Serial.print(command); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)); Serial.println(parameter); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } <span class="hljs-comment"><span class="hljs-comment">// if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd()</span></span></code> </pre><br> 您可以通过更改并将其添加到相应的代码部分来轻松地添加其他命令的处理。 <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br> 如果您在自己的项目中使用大量命令和数据进行分析，则此代码段最好以相应功能的形式进行设计。 <br><br> 仅需考虑负责其工作的AMS模块的标准功能。 首先，检查端口状态，然后每四秒钟向伙伴发送一次Mega处于运行状态的命令，并检查自从伙伴接收到最后一个数据以来经过的时间，如果超过8秒，则得出结论说伙伴不起作用。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynWork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkSerial(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle4s) { Serial3.println(F(<span class="hljs-string"><span class="hljs-string">"?mega=1"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - espTimer &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> </pre><br> 太神奇了。 是的，没什么复杂的吗？ <br><br><div class="spoiler">  <b class="spoiler_title">负责Mega 2560和ESP8266之间的系统间通信的模块的完整代码</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul RobotDyn part of Arduino Mega Server project */</span></span> #ifdef ROBOTDYN_FEATURE bool sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> espTimer = millis(); <span class="hljs-comment"><span class="hljs-comment">// Serial request #define MAX_SERIAL_REQ 32 String serialReq = ""; void robotdynInit() { Serial3.begin(115200); modulRobotdyn = MODUL_ENABLE; started("RobotDyn", true); } void printSerialStr() { Serial.print("["); Serial.print(serialReq); Serial.println("]"); } void parseSerialCmd() { String command, parameter; if (serialReq.indexOf(F("?")) &gt;= 0) { int pBegin = serialReq.indexOf(F("?")) + 1; if (serialReq.indexOf(F("=")) &gt;= 0) { int pParam = serialReq.indexOf(F("=")); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + 1); } else { command = serialReq.substring(pBegin); parameter = ""; } // if (command != F("esp")) { Serial.print(F("command/parameter: ")); Serial.print(command); Serial.print(F("/")); Serial.println(parameter); //} if (command == F("esp")) { if (parameter == F("1")) { esp = 1; espTimer = millis(); } else { esp = 0; } } } // if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd() void parseSerialStr() { if (serialReq[0] == '?') { parseSerialCmd(); } else { printSerialStr(); } } void checkSerial() { while (Serial3.available() &gt; 0) { if (sFlag) { serialReq = ""; sFlag = false; } char c = Serial3.read(); if (c == 10) { sFlag = true; parseSerialStr(); } else if (c == 13) { // skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial() void robotdynWork() { checkSerial(); if (cycle4s) { Serial3.println(F("?mega=1")); if (millis() - espTimer &gt; 8000) { esp = 0; } } } #endif // ROBOTDYN_FEATURE</span></span></code> </pre><br></div></div><br><h2> 串行监视器中的输出是什么样的 </h2><br> 在Mega 2560串行监视器中，系统ESP部分的输出，数据和命令看起来完全像它自己的一样。 为了将合作伙伴的输出与Mega的输出区分开来，他的数据用方括号括起来。 在这种情况下，您可以在Mega的串行监视器中看到ESP8266重新启动和AMS启动日志。 <br><br><img src="https://habrastorage.org/files/a03/904/3b8/a039043b86d442d7a54e10bb73b314c7.png" alt="ESP8266输出到Mega 2560系列显示器"><br><br> 以及通过串行接口在系统的两个部分之间实际交换命令的日志。 您会在ESP8266的输出中看到有关在Mega的串行接口中解码Mega状态数据的信息，并用引号引起来。 <br><br><img src="https://habrastorage.org/files/b5f/444/6cf/b5f4446cf54c4c048fa568f1e3418823.png" alt="ESP8266 Mega Command解码输出"><br><h2> 界面美 </h2><br> 现在介绍一下它们在Arduino Mega Server界面中的外观。 首先，我将提供工作中系统两部分的屏幕快照。 <br><br><img src="https://habrastorage.org/files/774/faf/c92/774fafc92eb54ba29905a6ec201501da.png" alt="适用于RobotDyn Mega + ESP8266的Arduino Mega服务器"><br><br> 椭圆形围绕标识控制器和您当前正在使用的系统部分的铭文。 圆圈在显示伙伴状态的指示器周围盘旋。 目前，一切都井井有条，系统的两个部分都正常工作，并通过内部接口正常交互。 如果出了问题，那么最多8秒钟后您就会知道。 <br><br><img src="https://habrastorage.org/files/f49/7ef/a1f/f497efa1ff1f427a860d4e61cdc5e13d.png" alt="出了点问题"><br><br> 出了点问题。  ESP8266通过无线方式接收到固件更新，并且系统的Mega部分记录了重新启动的时间。 几秒钟后，系统的ESP部分将恢复，并且指示灯将熄灭红色。 <br><br> 为方便起见，当您将鼠标悬停在合作伙伴状态指示器上时，会出现提示，并可以单击它，在另一个窗口中，系统第二部分（在本例中为ESP部分）的界面打开。 这样做是为了方便起见，您可以随时单击打开系统第二部分的界面。 <br><br><img src="https://habrastorage.org/files/d00/a61/a28/d00a61a28c6b439086a42e4510e896cb.png" alt="AMS的工具提示"><br><br><h2> 项目构想 </h2><br> 现在，稍微想一下您可以从这一切中得到什么。 乍看之下，通常的面板完全谨慎，可让您执行许多完全不寻常且有趣的事情。 与Arduino Mega Server的结合尤其如此。 <br><br> 因此，首先想到的是： <br><br>  <strong>从控制器之间的传感器转发数据。</strong> 双方，数量不限。 这是一个系统，它具有两个部分的优点，并且可能性不仅会加在一起，而且还会观察到所谓的协同效应。 <br><br>  <strong>接口之间的桥梁。</strong>  Arduino Mega Server可以使用许多接口，并且该系统允许您在任何连接的有线和无线接口之间路由数据和命令。 <br><br> 当Mega通过Ethernet Shield和ESP8266通过Wi-Fi与同一网络上的有线和无线设备通信时，可在同一网络上工作。 <br><br> 当Mega连接到有线以太网，ESP8266通过Wi-Fi连接到另一个网络，并且系统将命令和数据从一个网络路由到另一个网络时，它可以<strong>在不同的网络中工作</strong> 。 <br><br>  <strong>系统的一部分在另一部分的界面中的输出。</strong> 通过使用标准Web订阅源的以太网或内部串行连接。 <br><br>  <strong>侦错</strong> 系统的一部分可以根据您的程序充当系统另一部分的调试器和测试器。 <br><br>  <strong>看门狗定时器。</strong> 每个控制器相对于另一个都可以充当一种看门狗。 <br><br>  <strong>记录失败。</strong> 每个控制器都可以保留其伙伴的工作日志，汇总统计信息并报告警报情况。 <br><br>  <strong>ESP8266的资料库。</strong> 使用此系统，您可以在Mega上为ESP8266组织类似SQL数据库的内容。  ESP可以完成工作，Mega可以充当存储系统（最大32 GB）。 <br><br>  <strong>互相闪烁。</strong> 控制器可以根据嵌入式逻辑或在外部控制命令到达时相互动态刷新。 <br><br>  <strong>连接模块。</strong> 控制器可以连接到各种外围设备，这些外围设备在连接到系统的任何一部分时都遇到问题。 <br><br> 依此类推，等等，我认为一个好奇的读者将​​能够独立提出许多同样有趣的方式来使用该系统。 <br><br><h2> 结论 </h2><br> 在我看来，这是一个非常有趣的解决方案，我们必须非常感谢RobotDyn支付如此高昂的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">费用</a> 。 我至少要真诚地说。 <br><br> 下载适用于RobotDyn Mega + ESP8266的Arduino Mega Server分发套件，并亲自验证此处编写的所有内容的有效性，可以在Arduino Mega Server项目的官方网站的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">下载</a>部分中进行确认。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN402429/">https://habr.com/ru/post/zh-CN402429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN402417/index.html">骑自行车的人被悄悄发现了</a></li>
<li><a href="../zh-CN402419/index.html">解析新的Nintendo交换机</a></li>
<li><a href="../zh-CN402421/index.html">北半球的金星周</a></li>
<li><a href="../zh-CN402423/index.html">离线语言练习</a></li>
<li><a href="../zh-CN402425/index.html">化学家是第一个意识到量子计算机的好处的人</a></li>
<li><a href="../zh-CN402431/index.html">ONYX BOOX Vasco Da Gama：比书更聪明，比平板电脑更简单</a></li>
<li><a href="../zh-CN402433/index.html">摩天大楼的历史</a></li>
<li><a href="../zh-CN402435/index.html">摘要“世界高保真音响”：便携式音频，软件，格式和黑胶唱片</a></li>
<li><a href="../zh-CN402437/index.html">IPTV比人民币薄</a></li>
<li><a href="../zh-CN402439/index.html">商业地理位置：隐私便宜</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>