<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèø üë®üèº‚Äçüç≥ üß† Comment j'ai appris √† l'IA √† jouer √† Tetris pour NES. Partie 1: analyse du code du jeu üé© ü•å üíè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, j'explorerai les m√©canismes d'une simplicit√© trompeuse de Nintendo Tetris, et dans la deuxi√®me partie, j'expliquerai comment j'ai cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai appris √† l'IA √† jouer √† Tetris pour NES. Partie 1: analyse du code du jeu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420725/">  Dans cet article, j'explorerai les m√©canismes d'une simplicit√© trompeuse de Nintendo Tetris, et dans la deuxi√®me partie, j'expliquerai comment j'ai cr√©√© une IA qui exploite ces m√©canismes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48f/1a4/9b8/48f1a49b87860e6139e8d298e1fe6188.png"></div><br><h2>  Essayez-le vous-m√™me </h2><br><h3>  √Ä propos du projet </h3><br>  Pour ceux qui manquent de pers√©v√©rance, de patience et de temps pour ma√Ætriser Nintendo Tetris, j'ai cr√©√© une IA qui peut jouer seule.  Vous pouvez enfin atteindre le niveau 30 et m√™me plus loin.  Vous verrez comment obtenir le nombre maximum de points et observer le changement sans fin des compteurs de lignes, des niveaux et des statistiques.  Vous apprendrez quelles couleurs apparaissent √† des niveaux au-dessus desquels une personne ne peut pas grimper.  Voyez jusqu'o√π vous pouvez aller. <br><a name="habracut"></a><br><h3>  Pr√©requis </h3><br>  Pour ex√©cuter l'IA, vous avez besoin d'un √©mulateur universel NES / Famicom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FCEUX</a> .  L'intelligence artificielle a √©t√© d√©velopp√©e pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FCEUX 2.2.2</a> , la derni√®re version de l'√©mulateur au moment de la r√©daction. <br><br>  Vous aurez √©galement besoin du fichier ROM Nintendo Tetris (version am√©ricaine).  Essayez de le rechercher sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Google</a> . <br><br><h3>  T√©l√©chargez </h3><br>  D√©compressez <code>lua/NintendoTetrisAI.lua</code> de ce <a href="">fichier zip source</a> . <br><br><h3>  Lancement </h3><br>  Lancez FCEUX.  Dans le menu, s√©lectionnez Fichier |  Ouvrir la ROM ... Dans la bo√Æte de dialogue Ouvrir un fichier, s√©lectionnez le fichier ROM Nintendo Tetris et cliquez sur Ouvrir.  Le jeu va commencer. <br><br>  Dans le menu, s√©lectionnez Fichier |  Lua |  Nouvelle fen√™tre de script Lua ... Dans la fen√™tre de script Lua, entrez le chemin d'acc√®s √† <code>NintendoTetrisAI.lua</code> ou cliquez sur le bouton Parcourir pour le trouver.  Apr√®s cela, cliquez sur Ex√©cuter. <br><br>  Le script sur Lua vous redirigera vers le premier √©cran du menu.  Laissez le type de jeu A-Type et vous pouvez choisir n'importe quelle musique.  Sur les ordinateurs lents, la musique peut jouer tr√®s saccad√©e, alors vous devez la d√©sactiver.  Appuyez sur D√©marrer (Entr√©e) pour passer √† l'√©cran de menu suivant.  Dans le deuxi√®me menu, vous pouvez utiliser les touches fl√©ch√©es pour modifier le niveau de d√©marrage.  Cliquez sur D√©marrer pour d√©marrer le jeu.  Et ici, l'IA prendra le contr√¥le. <br><br>  Si apr√®s avoir s√©lectionn√© un niveau sur le deuxi√®me √©cran de menu, maintenez enfonc√© le bouton A de la manette de jeu (vous pouvez changer la disposition du clavier dans le menu Config | Input ...) et appuyez sur D√©marrer, le niveau initial sera 10 de plus que la valeur s√©lectionn√©e.  Le niveau d'entr√©e maximal est le dix-neuvi√®me. <br><br><h3>  La configuration </h3><br>  Pour acc√©l√©rer le jeu, ouvrez le script Lua dans un √©diteur de texte.  Au d√©but du fichier, recherchez la ligne suivante. <br><br> <code>PLAY_FAST = false</code> <br> <br>  Remplacez <code>false</code> par <code>true</code> comme indiqu√© ci-dessous. <br><br> <code>PLAY_FAST = true</code> <br> <br>  Enregistrez le fichier.  Cliquez ensuite sur le bouton Red√©marrer dans la fen√™tre Script Lua. <br><br><h2>  Nintendo Tetris Mechanics </h2><br><h3>  Description de Tetrimino </h3><br>  Chaque figure tetrimino correspond √† un nom √† une seule lettre qui ressemble √† sa forme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/975/440/5ed/9754405ed7b3d83a47181edef3de6913.png"></div><br>  Les concepteurs de Nintendo Tetris ont arbitrairement d√©fini l'ordre du tetrimino indiqu√© ci-dessus.  Les figures sont repr√©sent√©es dans l'orientation dans laquelle elles apparaissent √† l'√©cran, et le circuit cr√©e une image presque sym√©trique (c'est peut-√™tre pour cela que cet ordre est choisi).  L'index de s√©quence donne √† chaque t√©trimino un ID num√©rique unique.  Les identificateurs de s√©quence et de type sont importants au niveau de la programmation;  en outre, ils se manifestent dans l'ordre des chiffres affich√©s dans le champ statistique (voir ci-dessous). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc2/35d/778/dc235d778c47654e1abbc5896581fd6a.png"></div><br>  Les 19 orientations utilis√©es dans le tetrimino de Nintendo Tetris sont encod√©es dans un tableau situ√© √† <code>$8A9C</code> de la m√©moire de la console NES.  Chaque figure est repr√©sent√©e comme une s√©quence de 12 octets qui peut √™tre divis√©e en triplets <code>(Y, tile, X)</code> qui d√©crivent chaque carr√© de la figure.  Les valeurs hexad√©cimales ci-dessus des coordonn√©es sup√©rieures √† <code>$7F</code> d√©signent des entiers n√©gatifs ( <code>$FF= ‚àí1</code> et <code>$FE = ‚àí2</code> ). <br><br> <code>; Y0 T0 X0 Y1 T1 X1 Y2 T2 X2 Y3 T3 X3 <br> <br> 8A9C: 00 7B FF 00 7B 00 00 7B 01 FF 7B 00 ; 00: T up <br> 8AA8: FF 7B 00 00 7B 00 00 7B 01 01 7B 00 ; 01: T right <br> 8AB4: 00 7B FF 00 7B 00 00 7B 01 01 7B 00 ; 02: T down (spawn) <br> 8AC0: FF 7B 00 00 7B FF 00 7B 00 01 7B 00 ; 03: T left <br> <br> 8ACC: FF 7D 00 00 7D 00 01 7D FF 01 7D 00 ; 04: J left <br> 8AD8: FF 7D FF 00 7D FF 00 7D 00 00 7D 01 ; 05: J up <br> 8AE4: FF 7D 00 FF 7D 01 00 7D 00 01 7D 00 ; 06: J right <br> 8AF0: 00 7D FF 00 7D 00 00 7D 01 01 7D 01 ; 07: J down (spawn) <br> <br> 8AFC: 00 7C FF 00 7C 00 01 7C 00 01 7C 01 ; 08: Z horizontal (spawn) <br> 8B08: FF 7C 01 00 7C 00 00 7C 01 01 7C 00 ; 09: Z vertical <br> <br> 8B14: 00 7B FF 00 7B 00 01 7B FF 01 7B 00 ; 0A: O (spawn) <br> <br> 8B20: 00 7D 00 00 7D 01 01 7D FF 01 7D 00 ; 0B: S horizontal (spawn) <br> 8B2C: FF 7D 00 00 7D 00 00 7D 01 01 7D 01 ; 0C: S vertical <br> <br> 8B38: FF 7C 00 00 7C 00 01 7C 00 01 7C 01 ; 0D: L right <br> 8B44: 00 7C FF 00 7C 00 00 7C 01 01 7C FF ; 0E: L down (spawn) <br> 8B50: FF 7C FF FF 7C 00 00 7C 00 01 7C 00 ; 0F: L left <br> 8B5C: FF 7C 01 00 7C FF 00 7C 00 00 7C 01 ; 10: L up <br> <br> 8B68: FE 7B 00 FF 7B 00 00 7B 00 01 7B 00 ; 11: I vertical <br> 8B74: 00 7B FE 00 7B FF 00 7B 00 00 7B 01 ; 12: I horizontal (spawn) <br> <br> 8B80: 00 FF 00 00 FF 00 00 FF 00 00 FF 00 ; 13: Unused</code> <br> <br>  Au bas du tableau, il y a un enregistrement inutilis√©, donnant potentiellement la possibilit√© d'ajouter une autre orientation.  Cependant, dans diverses parties du code, <code>$13</code> indique que l'identificateur d'orientation du t√©trimino actif n'a pas de valeur. <br><br>  Pour faciliter la lecture, les coordonn√©es des carr√©s en d√©cimal sont indiqu√©es ci-dessous. <br><br> <code>-- { { X0, Y0 }, { X1, Y1 }, { X2, Y2 }, { X3, Y3 }, }, <br> <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, -1 }, }, -- 00: T up <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 01: T right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 02: T down (spawn) <br> { { 0, -1 }, { -1, 0 }, { 0, 0 }, { 0, 1 }, }, -- 03: T left <br> <br> { { 0, -1 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 04: J left <br> { { -1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 05: J up <br> { { 0, -1 }, { 1, -1 }, { 0, 0 }, { 0, 1 }, }, -- 06: J right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 07: J down (spawn) <br> <br> { { -1, 0 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 08: Z horizontal (spawn) <br> { { 1, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 09: Z vertical <br> <br> { { -1, 0 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0A: O (spawn) <br> <br> { { 0, 0 }, { 1, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0B: S horizontal (spawn) <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 0C: S vertical <br> <br> { { 0, -1 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 0D: L right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { -1, 1 }, }, -- 0E: L down (spawn) <br> { { -1, -1 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 0F: L left <br> { { 1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 10: L up <br> <br> { { 0, -2 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 11: I vertical <br> { { -2, 0 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 12: I horizontal (spawn)</code> <br> <br>  Toutes les orientations sont plac√©es dans une matrice 5 √ó 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ca/435/322/8ca435322ee85d07cc631640c11a9aee.png"></div><br>  Dans la figure ci-dessus, le carr√© blanc indique le centre de la matrice, le point de r√©f√©rence pour la rotation de la figure. <br><br>  Le tableau d'orientation est pr√©sent√© graphiquement ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b18/4e0/f0e/b184e0f0ea182222b58d151c09217567.png"></div><br>  L'identifiant d'orientation (index du tableau) est affich√© en hexad√©cimal dans le coin sup√©rieur droit de chaque matrice.  Et les mn√©moniques invent√©es pour ce projet sont affich√©es dans le coin sup√©rieur gauche.  <code>u</code> , <code>r</code> , <code>d</code> , <code>l</code> , <code>h</code> et <code>v</code> sont des abr√©viations de ¬´haut, droite, bas, gauche, horizontal et vertical¬ª.  Par exemple, il est plus facile de d√©signer l'orientation de <code>Jd</code> plut√¥t que <code>$07</code> . <br><br>  Les matrices contenant les orientations des figures lors de la cr√©ation sont marqu√©es d'un cadre blanc. <br><br>  Tetrimino I, S et Z pourrait recevoir 4 orientations distinctes, mais les cr√©ateurs de Nintendo Tetris ont d√©cid√© de se limiter √† deux.  De plus, <code>Zv</code> et <code>Sv</code> ne sont pas des images miroir id√©ales l'une de l'autre.  Les deux sont cr√©√©s en tournant dans le sens antihoraire, ce qui conduit √† un d√©s√©quilibre. <br><br>  Le tableau d'orientation contient √©galement des valeurs de tuile pour chaque carr√© de chaque figure orient√©e.  Cependant, avec une √©tude minutieuse, il devient clair que les valeurs pour un type de t√©trimino sont toujours les m√™mes. <br><br><div class="scrollable-table"><table><tbody><tr><th>  T </th><th>  J </th><th>  Z </th><th>  O </th><th>  S </th><th>  L </th><th>  Je </th></tr><tr><td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> </tr></tbody></table></div><br>  Les valeurs de tuile sont les indices de la table (pseudo-couleur) du motif illustr√© ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br>  Les tuiles <code>$7B</code> , <code>$7C</code> <code>$7D</code> et <code>$7D</code> sont situ√©es directement sous ¬´ATIS¬ª du mot ¬´STATISTIQUES¬ª.  Ce sont les trois types de carr√©s √† partir desquels le t√©trimino est fabriqu√©. <br><br>  Pour les curieux, je dirai que les autruches et les pingouins sont utilis√©s √† la fin du mode B-Type.  Ce sujet est trait√© en d√©tail dans la section "Fin". <br><br>  Vous trouverez ci-dessous le r√©sultat de la modification de la ROM apr√®s avoir remplac√© <code>$7B</code> de <code>$29</code> .  Le c≈ìur est la tuile sous le symbole P dans le tableau des motifs pour toutes les orientations T. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fa/551/215/5fa55121523b443f8f3b6daa2bd46ad8.png"></div><br>  Les tuiles C≈ìur restent sur le terrain de jeu m√™me apr√®s que les T modifi√©s soient verrouill√©s en place  Comme indiqu√© ci-dessous dans la section ¬´Cr√©ation de Tetrimino¬ª, cela signifie que le terrain de jeu stocke les valeurs r√©elles des indices de tuile du Tetrimino jou√©. <br><br>  Les programmeurs de jeu ont permis d'utiliser 4 tuiles distinctes pour chaque figure, et pas seulement un type de carr√©s invariable.  Il s'agit d'une fonctionnalit√© utile qui peut √™tre utilis√©e pour modifier l'apparence du jeu.  La table de mod√®le a beaucoup d'espace vide pour de nouvelles tuiles qui peuvent donner √† chaque tetrimino un look unique. <br><br>  Les coordonn√©es des carr√©s sont tr√®s faciles √† manipuler.  Par exemple, une version modifi√©e des quatre premiers triplets de la table d'orientation est pr√©sent√©e ci-dessous. <br><br> <code>8A9C: FE 7B FE FE 7B 02 02 7B FE 02 7B 02 ; 00: T up</code> <br> <br>  Cette modification est similaire √† la suivante: <br><br> <code>{ { -2, -2 }, { 2, -2 }, { -2, 2 }, { 2, 2 }, }, -- 00: T up</code> <br> <br>  Le r√©sultat est un tetrimino divis√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a6/ab5/86d/3a6ab586d06a57b92208bd612b755109.png"></div><br>  Lorsque vous d√©placez un t√©trimino divis√©, ses carr√©s ne peuvent pas d√©passer les limites du terrain de jeu et ne peuvent pas traverser des figures pr√©c√©demment verrouill√©es.  De plus, le jeu interdit la rotation dans cette orientation s'il conduit √† un carr√© tombant en dehors des limites du terrain de jeu ou au fait que le carr√© chevauche un carr√© d√©j√† couch√©. <br><br>  Le t√©trimino fendu est verrouill√© en place lorsqu'il y a un support pour l'un de ses carr√©s.  Si la figure est bloqu√©e, les carr√©s suspendus en l'air continuent de pendre. <br><br>  Le jeu g√®re les tetriminos divis√©s comme n'importe quelle figure normale.  Cela nous fait comprendre qu'il n'y a pas de tableau suppl√©mentaire stockant les m√©tadonn√©es des figures.  Par exemple, il pourrait y avoir un tableau stockant la taille du cadre de d√©limitation de chaque orientation pour v√©rifier les collisions avec le p√©rim√®tre du terrain de jeu.  Mais une telle table n'est pas utilis√©e.  Au lieu de cela, le jeu v√©rifie simplement les quatre carr√©s juste avant de manipuler la forme. <br><br>  De plus, les coordonn√©es des carr√©s peuvent √™tre n'importe quelles valeurs;  ils ne sont pas limit√©s √† l'intervalle <code>[‚àí2, 2]</code> .  Bien s√ªr, des valeurs qui d√©passent largement cet intervalle nous donneront des chiffres inapplicables qui ne peuvent pas tenir sur le terrain.  Plus important encore, comme indiqu√© dans la section ¬´√âtats du jeu et modes de rendu¬ª, lorsqu'une figure est verrouill√©e en place, le m√©canisme de nettoyage des lignes pleines ne scanne que les d√©placements des rang√©es de -2 √† 1 par rapport au carr√© central de la figure;  un carr√© avec une coordonn√©e <code>y</code> dehors de cet intervalle ne sera pas reconnu. <br><br><h3>  Rotation du t√©trimino </h3><br>  Dans une illustration graphique du tableau d'orientation, la rotation consiste √† passer d'une matrice √† l'une des matrices √† gauche ou √† droite avec le transfert de la s√©rie si n√©cessaire.  Ce concept est encod√© dans un tableau √† <code>$88EE</code> . <br><br> <code>; CCW CW <br> 88EE: 03 01 ; Tl Tr <br> 88F0: 00 02 ; Tu Td <br> 88F2: 01 03 ; Tr Tl <br> 88F4: 02 00 ; Td Tu <br> 88F6: 07 05 ; Jd Ju <br> 88F8: 04 06 ; Jl Jr <br> 88FA: 05 07 ; Ju Jd <br> 88FC: 06 04 ; Jr Jl <br> 88FE: 09 09 ; Zv Zv <br> 8900: 08 08 ; Zh Zh <br> 8902: 0A 0A ; OO <br> 8904: 0C 0C ; Sv Sv <br> 8906: 0B 0B ; Sh Sh <br> 8908: 10 0E ; Lu Ld <br> 890A: 0D 0F ; Lr Ll <br> 890C: 0E 10 ; Ld Lu <br> 890E: 0F 0D ; Ll Lr <br> 8910: 12 12 ; Ih Ih <br> 8912: 11 11 ; Iv Iv</code> <br> <br>  Pour le rendre plus clair, nous d√©placerons chaque colonne de ce tableau vers la ligne du tableau ci-dessous. <br><div class="scrollable-table"><table><tbody><tr><th></th><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><th>  Dans le sens antihoraire </th><td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr><tr><th>  Dans le sens des aiguilles d'une montre </th><td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr></tbody></table></div><br>  Les mn√©moniques des en-t√™tes ci-dessus peuvent √™tre interpr√©t√©s comme un index de s√©quence ou une cl√© de distribution.  Par exemple, tourner <code>Tu</code> dans le sens antihoraire nous donne <code>Tl</code> , et tourner <code>Tu</code> dans le sens horaire donne <code>Tr</code> . <br><br>  La table de rotation code les s√©quences cha√Æn√©es d'ID d'orientation;  par cons√©quent, nous pouvons modifier les enregistrements afin que la rotation transforme un type de t√©trimino en un autre.  Cette technique peut potentiellement √™tre utilis√©e pour tirer parti d'une ligne inutilis√©e dans la table d'orientation. <br><br>  Devant la table de rotation se trouve un code pour y acc√©der. <br><br> <code>88AB: LDA $0042 <br> 88AD: STA $00AE ; originalOrientationID = orientationID; <br> <br> 88AF: CLC <br> 88B0: LDA $0042 <br> 88B2: ASL <br> 88B3: TAX ; index = 2 * orientationID; <br> <br> 88B4: LDA $00B5 <br> 88B6: AND #$80 ; if (not just pressed button A) { <br> 88B8: CMP #$80 ; goto aNotPressed; <br> 88BA: BNE $88CF ; } <br> <br> 88BC: INX <br> 88BD: LDA $88EE,X <br> 88C0: STA $0042 ; orientationID = rotationTable[index + 1]; <br> <br> 88C2: JSR $948B ; if (new orientation not valid) { <br> 88C5: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88C7: LDA #$05 <br> 88C9: STA $06F1 ; play rotation sound effect; <br> 88CC: JMP $88ED ; return; <br> <br> aNotPressed: <br> <br> 88CF: LDA $00B5 <br> 88D1: AND #$40 ; if (not just pressed button B) { <br> 88D3: CMP #$40 ; return; <br> 88D5: BNE $88ED ; } <br> <br> 88D7: LDA $88EE,X <br> 88DA: STA $0042 ; orientationID = rotationTable[index]; <br> <br> 88DC: JSR $948B ; if (new orientation not valid) { <br> 88DF: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88E1: LDA #$05 <br> 88E3: STA $06F1 ; play rotation sound effect; <br> 88E6: JMP $88ED ; return; <br> <br> restoreOrientationID: <br> <br> 88E9: LDA $00AE <br> 88EB: STA $0042 ; orientationID = originalOrientationID; <br> <br> 88ED: RTS ; return;</code> <br> <br>  Pour une rotation dans le sens antihoraire, l'indice de la table de rotation est soustrait en doublant l'ID d'orientation.  En y ajoutant 1, nous obtenons l'indice de rotation dans le sens horaire. <br><br>  Les coordonn√©es <code>x</code> , <code>y</code> et l'ID d'orientation du t√©trimino actuel sont stock√©s aux adresses <code>$0040</code> , <code>$0041</code> et <code>$0042</code> respectivement. <br><br>  Le code utilise une variable temporaire pour sauvegarder l'ID d'orientation.  Plus tard, apr√®s avoir chang√© l'orientation, le code v√©rifie que les quatre carr√©s sont dans les limites du terrain de jeu et aucun d'eux ne chevauche les carr√©s d√©j√† couch√©s (le code de v√©rification est situ√© √† <code>$948B</code> , sous le fragment de code illustr√© ci-dessus).  Si la nouvelle orientation est incorrecte, celle d'origine est restaur√©e, ne permettant pas au joueur de faire pivoter la figure. <br><br>  En comptant avec une croix, le contr√¥leur NES a huit boutons, dont l'√©tat est repr√©sent√© par le bit d'adresse <code>$00B6</code> . <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  Un </td><td>  B </td><td>  S√©lectionnez </td><td>  Commencer </td><td>  En haut </td><td>  Vers le bas </td><td>  Vers la gauche </td><td>  √Ä droite </td></tr></tbody></table></div><br>  Par exemple, <code>$00B6</code> contiendra la valeur <code>$81</code> tandis que le joueur d√©tient A et Left. <br><br>  D'un autre c√¥t√©, <code>$00B5</code> signale lorsque les boutons ont √©t√© enfonc√©s;  les bits <code>$00B5</code> sont vrais que pendant une it√©ration de la boucle de jeu (1 image rendue).  Le code utilise <code>$00B5</code> pour r√©pondre aux pressions sur A et B. Chacun d'eux doit √™tre lib√©r√© avant d'√™tre r√©utilis√©. <br><br>  <code>$00B5</code> et <code>$00B6</code> sont des miroirs de <code>$00F5</code> <code>$00F6</code> et <code>$00F6</code> .  Le code des sections suivantes utilise ces adresses de mani√®re interchangeable. <br><br><h3>  Cr√©er Tetrimino </h3><br>  Le terrain de jeu de Nintendo Tetris se compose d'une matrice de 22 lignes et 10 colonnes afin que les deux premi√®res lignes soient cach√©es au joueur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/0dc/33b/6e10dc33b40eaa5dec35bc6e7bf42c5f.png"></div><br>  Comme indiqu√© dans le code ci-dessous, lors de la cr√©ation d'une figure Tetrimino, elle est toujours situ√©e dans les coordonn√©es <code>(5, 0)</code> terrain de jeu. <br><br> <code>98BA: LDA #$00 <br> 98BC: STA $00A4 <br> 98BE: STA $0045 <br> 98C0: STA $0041 ; Tetrimino Y = 0 <br> 98C2: LDA #$01 <br> 98C4: STA $0048 <br> 98C6: LDA #$05 <br> 98C8: STA $0040 ; Tetrimino X = 5</code> <br> <br>  Ci-dessous, une matrice 5 √ó 5 superpos√©e √† ce point. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/d3b/d94/fcfd3bd94514779d6e967770a1f216cb.png"></div><br>  Aucune des matrices de cr√©ation n'a de carr√©s au-dessus du point de d√©part.  Autrement dit, lors de la cr√©ation d'un t√©trimino, ses quatre carr√©s deviennent imm√©diatement visibles pour le joueur.  Cependant, si le joueur tourne rapidement la pi√®ce avant qu'il n'ait le temps de tomber, une partie de la pi√®ce sera temporairement cach√©e dans les deux premi√®res lignes du terrain de jeu. <br><br>  Habituellement, nous pensons que le jeu se termine lorsque le tas atteint le sommet.  Mais en fait, ce n'est pas enti√®rement vrai.  Le jeu se termine lorsqu'il n'est plus possible de cr√©er la pi√®ce suivante.  Autrement dit, avant l'apparition de la figure, les quatre cellules du terrain de jeu correspondant aux positions des carr√©s du t√©trimino cr√©√© doivent √™tre libres.  La figurine peut √™tre verrouill√©e en place de telle mani√®re qu'une partie de ses carr√©s appara√Æt en lignes num√©rot√©es n√©gativement, et le jeu ne se termine pas;  cependant, dans Nintendo Tetris, les lignes n√©gatives sont une abstraction li√©e uniquement au t√©trimino actif.  Une fois que la figure est bloqu√©e (devient couch√©e), seuls les carr√©s dans les lignes de z√©ro et plus sont √©crits dans le champ.  Conceptuellement, il s'av√®re que les lignes num√©rot√©es n√©gativement sont automatiquement effac√©es apr√®s le blocage.  Mais en r√©alit√©, le jeu ne stocke tout simplement pas ces donn√©es, coupant les parties sup√©rieures des chiffres. <br><br>  La zone visible du terrain de jeu 20 √ó 10 est stock√©e √† <code>$0400</code> ligne par ligne, chaque octet contenant la valeur de la tuile d'arri√®re-plan.  Les cellules vides sont d√©sign√©es par la tuile <code>$EF</code> , un carr√© noir uni. <br><br>  Lors de la cr√©ation d'une forme, trois tables de recherche sont utilis√©es.  S'il y a un ID d'orientation arbitraire, le tableau √† <code>$9956</code> nous donne l'ID d'orientation lors de la cr√©ation du type correspondant de tetrimino. <br><br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br>  Il est plus facile de le montrer dans le tableau. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Zh</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sh</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ih</code> </td> <td> <code>Ih</code> </td> </tr></tbody></table></div><br>  Par exemple, toutes les orientations de J sont attach√©es √† <code>Jd</code> . <br><br>  Le tableau √† <code>$993B</code> contient le type Tetrimino pour l'ID d'orientation donn√©. <br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br>  Pour plus de clart√©, je vais tout montrer sous forme de tableau. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>Z</code> </td> <td> <code>Z</code> </td> <td> <code>O</code> </td> <td> <code>S</code> </td> <td> <code>S</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>I</code> </td> <td> <code>I</code> </td> </tr></tbody></table></div><br>  Nous examinerons le troisi√®me tableau de recherche dans la section suivante. <br><br><h3>  S√©lection Tetrimino </h3><br>  Nintendo Tetris utilise un registre √† d√©calage √† r√©troaction lin√©aire 16 bits (LFSR) comme g√©n√©rateur de nombres pseudo-al√©atoires (PRNG) dans sa configuration Fibonacci.  La valeur 16 bits est stock√©e en tant que big-endian aux adresses <code>$0017</code> <code>$0018</code> - <code>$0018</code> .  Un nombre arbitraire de <code>$8988</code> utilis√© comme graine. <br><br> <code>80BC: LDX #$89 <br> 80BE: STX $0017 <br> 80C0: DEX <br> 80C1: STX $0018</code> <br> <br>  Chaque nombre pseudo-al√©atoire suivant est g√©n√©r√© comme suit: la valeur est per√ßue comme un nombre de 17 bits, et le bit le plus significatif est obtenu en effectuant XOR pour les bits 1 et 9. Ensuite, la valeur est d√©cal√©e vers la droite, en √©liminant le bit le moins significatif. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a0/45d/3f2/3a045d3f2d64a94aa272aa15f351ac7a.png"></div><br>  Ce processus se produit √† <code>$AB47</code> . <br><br> <code>AB47: LDA $00,X <br> AB49: AND #$02 <br> AB4B: STA $0000 ; extract bit 1 <br> <br> AB4D: LDA $01,X <br> AB4F: AND #$02 ; extract bit 9 <br> <br> AB51: EOR $0000 <br> AB53: CLC <br> AB54: BEQ $AB57 <br> AB56: SEC ; XOR bits 1 and 9 together <br> <br> AB57: ROR $00,X <br> AB59: INX <br> AB5A: DEY ; right shift <br> AB5B: BNE $AB57 ; shifting in the XORed value <br> <br> AB5D: RTS ; return</code> <br> <br>  Il est int√©ressant de noter que les param√®tres du sous-programme ci-dessus peuvent √™tre d√©finis de sorte que la fonction appelante puisse sp√©cifier la largeur du registre √† d√©calage et l'adresse √† laquelle il peut √™tre trouv√© en m√©moire.  Cependant, les m√™mes param√®tres sont utilis√©s partout, nous pouvons donc supposer que les d√©veloppeurs ont emprunt√© ce code quelque part. <br><br>  Pour ceux qui souhaitent modifier davantage l'algorithme, je l'ai √©crit en Java. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit1 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit9 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> leftmostBit = bit1 ^ bit9; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (leftmostBit &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Et tout ce code peut √™tre compress√© sur une seule ligne. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) ^ ((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Ce PRNG g√©n√®re de fa√ßon continue et d√©terministe 32 767 valeurs uniques, en commen√ßant chaque cycle √† partir de la graine d'origine.  C'est un moins de la moiti√© des nombres possibles qui peuvent tenir dans le registre, et toute valeur de cet ensemble peut √™tre utilis√©e comme graine.  De nombreuses valeurs en dehors de l'ensemble cr√©ent une cha√Æne qui m√®ne finalement √† un nombre de l'ensemble.  Cependant, certains nombres initiaux entra√Ænent une s√©quence infinie de z√©ros. <br><br>  Pour √©valuer grossi√®rement les performances de ce PRNG, j'ai g√©n√©r√© une repr√©sentation graphique des valeurs qu'il cr√©e en fonction d'une phrase avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RANDOM.ORG</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/254/477/bef/254477befbd14f540925a6d3169e5179.png"></div><br>  Lors de la cr√©ation de l'image, PRNG a √©t√© utilis√© comme g√©n√©rateur de nombres pseudo-al√©atoires, plut√¥t que comme entiers 16 bits.  Chaque pixel est color√© en fonction de la valeur du bit 0. L'image a une taille de 128 √ó 256, c'est-√†-dire qu'elle couvre toute la s√©quence. <br><br>  Mis √† part les rayures √† peine perceptibles sur les c√¥t√©s sup√©rieur et gauche, il semble al√©atoire.  Aucun motif √©vident n'appara√Æt. <br><br>  Apr√®s le d√©marrage, le PRNG d√©cale constamment le registre, travaillant au moins une fois par trame.  Cela ne se produit pas seulement sur l'√©cran de d√©marrage et les √©crans de menu, mais aussi lorsque le tetrimino se situe entre les op√©rations de cr√©ation de formes.  Autrement dit, la figure qui appara√Æt ensuite d√©pend du nombre d'images que le joueur prend pour placer la figure.  En fait, le jeu repose sur le caract√®re al√©atoire des actions de la personne qui interagit avec lui. <br><br>  Lors de la cr√©ation de la figure, le code est ex√©cut√© √† l'adresse <code>$9907</code> , qui s√©lectionne le type de la nouvelle figure. <br><br> <code>9907: INC $001A ; spawnCount++; <br> <br> 9909: LDA $0017 ; index = high byte of randomValue; <br> <br> 990B: CLC <br> 990C: ADC $001A ; index += spawnCount; <br> <br> 990E: AND #$07 ; index &amp;= 7; <br> <br> 9910: CMP #$07 ; if (index == 7) { <br> 9912: BEQ $991C ; goto invalidIndex; <br> ; } <br> <br> 9914: TAX <br> 9915: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> 9918: CMP $0019 ; if (newSpawnID != spawnID) { <br> 991A: BNE $9938 ; goto useNewSpawnID; <br> ; } <br> <br> invalidIndex: <br> <br> 991C: LDX #$17 <br> 991E: LDY #$02 <br> 9920: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 9923: LDA $0017 ; index = high byte of randomValue; <br> <br> 9925: AND #$07 ; index &amp;= 7; <br> <br> 9927: CLC <br> 9928: ADC $0019 ; index += spawnID; <br> <br> 992A: CMP #$07 <br> 992C: BCC $9934 <br> 992E: SEC <br> 992F: SBC #$07 <br> 9931: JMP $992A ; index %= 7; <br> <br> 9934: TAX <br> 9935: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> useNewSpawnID: <br> <br> 9938: STA $0019 ; spawnID = newSpawnID; <br> <br> 993A: RTS ; return;</code> <br> <br>  √Ä l'adresse <code>$001A</code> stocke un compteur du nombre de chiffres cr√©√©s lors de la mise sous tension.  L'incr√©mentation du compteur est effectu√©e par la premi√®re ligne du sous-programme, et puisqu'il s'agit d'un compteur √† un octet, apr√®s chaque 256 pi√®ces, il revient √† z√©ro.  √âtant donn√© que le compteur n'est pas r√©initialis√© entre les jeux, l'historique des jeux pr√©c√©dents affecte le processus de s√©lection des figures.  C'est une autre fa√ßon dont le jeu utilise le joueur comme source de hasard. <br><br>  La routine convertit l'octet le plus significatif du nombre pseudo-al√©atoire ( <code>$0017</code> ) en type tetrimino et l'utilise comme index de la table situ√©e √† <code>$994E</code> pour convertir le type en ID d'orientation de cr√©ation de forme. <br><br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br>  Au premier stade de la conversion, le compteur des chiffres cr√©√©s est ajout√© √† l'octet sup√©rieur.  Ensuite, un masque est appliqu√© pour enregistrer uniquement les 3 bits inf√©rieurs.  Si le r√©sultat n'est pas 7, alors c'est le bon type de tetrimino, et s'il n'est pas le m√™me que la figure s√©lectionn√©e pr√©c√©dente, alors le nombre est utilis√© comme index dans le tableau pour cr√©er des figures.  Sinon, le nombre pseudo-al√©atoire suivant est g√©n√©r√© et le masque est appliqu√© pour obtenir les 3 bits inf√©rieurs de l'octet sup√©rieur, puis l'ID d'orientation de cr√©ation de forme pr√©c√©dente est ajout√©.  Enfin, une op√©ration modulo est effectu√©e pour obtenir le type correct de tetrimino, qui est utilis√© comme index dans la table de cr√©ation de forme. <br><br>  √âtant donn√© que le processeur ne prend pas en charge la division avec le reste, cet op√©rateur est √©mul√© en soustrayant √† plusieurs reprises 7 jusqu'√† ce que le r√©sultat devienne inf√©rieur √† 7. La division avec le reste est appliqu√©e √† la somme de l'octet sup√©rieur avec le masque appliqu√© et √† l'ID de cr√©ation d'orientation pr√©c√©dente.  La valeur maximale de cette somme est de 25. Autrement dit, pour la r√©duire au reste de 4, seulement 3 it√©rations sont n√©cessaires. <br><br>  Au d√©but de chaque jeu, l'ID d'orientation de cr√©ation de forme ( <code>$0019</code> ) est initialis√© avec une valeur de <code>Tu</code> ( <code>$00</code> ).  Cette valeur pourrait potentiellement √™tre utilis√©e √† <code>$9928</code> lors de la premi√®re cr√©ation de forme. <br><br>  Lorsque vous utilisez l'ID d'orientation pr√©c√©dent pour cr√©er une figure, plut√¥t que le type pr√©c√©dent, Tetrimino ajoute une distorsion, car les valeurs de l'ID d'orientation ne sont pas r√©parties uniform√©ment.  Ceci est indiqu√© dans le tableau: <br><br><div class="scrollable-table"><table><tbody><tr><th>  00 $ </th><th> <code>$02</code> </th> <th> <code>$07</code> </th> <th> <code>$08</code> </th> <th> <code>$0A</code> </th> <th> <code>$0B</code> </th> <th> <code>$0E</code> </th> <th> <code>$12</code> </th> </tr><tr><th>  0 </th><td>  2 </td><td>  0 </td><td>  1 </td><td>  3 </td><td>  4 </td><td>  0 </td><td>  4 </td></tr><tr><th>  1 </th><td>  3 </td><td>  1 </td><td>  2 </td><td>  4 </td><td>  5 </td><td>  1 </td><td>  5 </td></tr><tr><th>  2 </th><td>  4 </td><td>  2 </td><td>  3 </td><td>  5 </td><td>  6 </td><td>  2 </td><td>  6 </td></tr><tr><th>  3 </th><td>  5 </td><td>  3 </td><td>  4 </td><td>  6 </td><td>  0 </td><td>  3 </td><td>  0 </td></tr><tr><th>  4 </th><td>  6 </td><td>  4 </td><td>  5 </td><td>  0 </td><td>  1 </td><td>  4 </td><td>  1 </td></tr><tr><th>  5 </th><td>  0 </td><td>  5 </td><td>  6 </td><td>  1 </td><td>  2 </td><td>  5 </td><td>  2 </td></tr><tr><th>  6 </th><td>  1 </td><td>  6 </td><td>  0 </td><td>  2 </td><td>  3 </td><td>  6 </td><td>  3 </td></tr><tr><th>  7 </th><td>  2 </td><td>  0 </td><td>  1 </td><td>  3 </td><td>  4 </td><td>  0 </td><td>  4 </td></tr></tbody></table></div><br>  Chaque cellule contient un type tetrimino, calcul√© en ajoutant l'ID d'orientation de la figure (colonne) cr√©√©e √† une valeur de 3 bits (ligne), puis en appliquant le reste de la division par 7 √† la somme. Chaque ligne contient des doublons, car <code>$07</code> et <code>$0E</code> √©galement r√©partis par 7, tandis que 0 <code>$0B</code> et <code>$12</code> ont un √©quilibre commun.  Les lignes 0 et 7 sont identiques car elles sont √† une distance de 7. <br><br>  Il existe 56 combinaisons d'entr√©e possibles, et si les types de t√©trimino r√©sultants sont uniform√©ment r√©partis, alors nous pouvons nous attendre √† ce que dans le tableau ci-dessus, chaque type apparaisse exactement 8 fois.  Mais comme indiqu√© ci-dessous, ce n'est pas le cas. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Tapez </th><th>  La fr√©quence </th></tr><tr><td>  T </td><td>  9 </td></tr><tr><td>  J </td><td>  8 </td></tr><tr><td>  Z </td><td>  8 </td></tr><tr><td>  O </td><td>  8 </td></tr><tr><td>  S </td><td>  9 </td></tr><tr><td>  L </td><td>  7 </td></tr><tr><td>  Je </td><td>  7 </td></tr></tbody></table></div><br>  T et S apparaissent plus souvent, et L et I - moins souvent.  Mais le code biais√© utilisant l'ID d'orientation ne s'ex√©cute pas chaque fois que le sous-programme est appel√©. <br><br>  Supposons que PRNG cr√©e une s√©quence de valeurs statistiques ind√©pendantes uniform√©ment r√©parties.  C'est en fait une hypoth√®se juste, √©tant donn√© la fa√ßon dont le jeu essaie d'obtenir le bon caract√®re al√©atoire des actions du joueur.  L'ajout du nombre de chiffres cr√©√©s √† l'adresse <code>$990C</code> pas la distribution, car le nombre augmente r√©guli√®rement entre les appels.  L'utilisation du masque de bits √† <code>$990E</code> similaire √† l'application de la division par 8 avec le reste, ce qui n'affecte pas non plus la distribution.  Par cons√©quent, la v√©rification √† <code>$9910</code> va √† <code>invalidIndex</code> dans 1/8 de tous les cas.  Et la probabilit√© de frapper lors de la v√©rification √† l'adresse <code>$9918</code> , o√π le chiffre nouvellement s√©lectionn√© est compar√© au chiffre pr√©c√©dent, est de 7/8, avec une probabilit√© de co√Øncidence de 1/7.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela signifie qu'il y a une chance suppl√©mentaire d' </font></font><code>7/8 √ó 1/7 = 1/8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√™tre </font><font style="vertical-align: inherit;">pr√©sent </font></font><code>invalidIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En g√©n√©ral, il existe une probabilit√© de 25% d'utiliser un code asym√©trique et une probabilit√© de 75% d'utiliser un code qui s√©lectionne Tetrimino de mani√®re uniforme. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans un ensemble de 224 tetriminos cr√©√©s, l'attente math√©matique est de 32 instances pour chaque type. </font><font style="vertical-align: inherit;">Mais en fait, le code cr√©e la distribution suivante:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tapez </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La fr√©quence </font></font></th></tr><tr><td>  T </td><td>  33 </td></tr><tr><td>  J </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 32 </font></font></td></tr><tr><td>  Z </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 32 </font></font></td></tr><tr><td>  O </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 32 </font></font></td></tr><tr><td>  S </td><td>  33 </td></tr><tr><td>  L </td><td>  31 </td></tr><tr><td>  Je </td><td>  31 </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autrement dit, en nettoyant 90 lignes et en atteignant le niveau 9, le joueur recevra un T et S suppl√©mentaire et un L et I de moins que ce qui est pr√©vu statistiquement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le t√©trimino est choisi avec les probabilit√©s suivantes:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tapez </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Probabilit√© </font></font></th></tr><tr><td>  T </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td>  J </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td>  Z </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td>  O </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td>  S </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td>  L </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr><tr><td>  Je </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il semble que dans l'affirmation selon laquelle le ¬´long stick¬ª je n'appara√Æt jamais quand il est n√©cessaire, il y a une partie de la v√©rit√© (du moins pour Nintendo Tetris). </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris utilise le d√©calage automatique diff√©r√© (DAS). </font><font style="vertical-align: inherit;">Cliquer sur "Gauche" ou "Droite" d√©place instantan√©ment le tetrimino d'une cellule horizontalement. </font><font style="vertical-align: inherit;">Tout en maintenant l'un de ces boutons de direction, le jeu d√©cale automatiquement le chiffre toutes les 6 images avec un retard initial de 16 images. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce type de mouvement horizontal est contr√¥l√© par le code √† l'adresse </font></font><code>$89AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Comme dans le code de rotation, une variable temporaire est utilis√©e ici pour sauvegarder les coordonn√©es </font><font style="vertical-align: inherit;">au cas o√π la nouvelle position serait incorrecte. </font><font style="vertical-align: inherit;">Notez que la v√©rification vous emp√™che de d√©placer la pi√®ce pendant que le joueur appuie vers le bas.</font></font><br><br> <code>89AE: LDA $0040 <br> 89B0: STA $00AE ; originalX = tetriminoX; <br> <br> 89B2: LDA $00B6 ; if (pressing down) { <br> 89B4: AND #$04 ; return; <br> 89B6: BNE $8A09 ; } <br> <br> 89B8: LDA $00B5 ; if (just pressed left/right) { <br> 89BA: AND #$03 ; goto resetAutorepeatX; <br> 89BC: BNE $89D3 ; } <br> <br> 89BE: LDA $00B6 ; if (not pressing left/right) { <br> 89C0: AND #$03 ; return; <br> 89C2: BEQ $8A09 ; } <br> <br> 89C4: INC $0046 ; autorepeatX++; <br> 89C6: LDA $0046 ; if (autorepeatX &lt; 16) { <br> 89C8: CMP #$10 ; return; <br> 89CA: BMI $8A09 ; } <br> <br> 89CC: LDA #$0A <br> 89CE: STA $0046 ; autorepeatX = 10; <br> 89D0: JMP $89D7 ; goto buttonHeldDown; <br> <br> resetAutorepeatX: <br> <br> 89D3: LDA #$00 <br> 89D5: STA $0046 ; autorepeatX = 0; <br> <br> buttonHeldDown: <br> <br> 89D7: LDA $00B6 ; if (not pressing right) { <br> 89D9: AND #$01 ; goto notPressingRight; <br> 89DB: BEQ $89EC ; } <br> <br> 89DD: INC $0040 ; tetriminoX++; <br> 89DF: JSR $948B ; if (new position not valid) { <br> 89E2: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89E4: LDA #$03 <br> 89E6: STA $06F1 ; play shift sound effect; <br> 89E9: JMP $8A09 ; return; <br> <br> notPressingRight: <br> <br> 89EC: LDA $00B6 ; if (not pressing left) { <br> 89EE: AND #$02 ; return; <br> 89F0: BEQ $8A09 ; } <br> <br> 89F2: DEC $0040 ; tetriminoX--; <br> 89F4: JSR $948B ; if (new position not valid) { <br> 89F7: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89F9: LDA #$03 <br> 89FB: STA $06F1 ; play shift sound effect; <br> 89FE: JMP $8A09 ; return; <br> <br> restoreX: <br> <br> 8A01: LDA $00AE <br> 8A03: STA $0040 ; tetriminoX = originalX; <br> <br> 8A05: LDA #$10 <br> 8A07: STA $0046 ; autorepeatX = 16; <br> <br> 8A09: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>x</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lancer de Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La vitesse de descente automatique du Tetrimino est fonction du nombre de niveaux. </font><font style="vertical-align: inherit;">Les vitesses sont cod√©es comme le nombre d'images rendues pour la descente dans le tableau situ√© √† </font></font><code>$898E</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">√âtant donn√© que NES fonctionne √† 60,0988 images / s, vous pouvez calculer la p√©riode entre les descentes et la vitesse.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Niveau </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cadres de descente </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> P√©riode (s / descente) </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vitesse (cellules / s) </font></font></th></tr><tr><td>  0 </td><td>  48 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .799 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,25 </font></font></td></tr><tr><td>  1 </td><td>  43 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .715 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,40 </font></font></td></tr><tr><td>  2 </td><td>  38 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .632 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,58 </font></font></td></tr><tr><td>  3 </td><td>  33 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .549 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,82 </font></font></td></tr><tr><td>  4 </td><td>  28 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .466 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2.15 </font></font></td></tr><tr><td>  5 </td><td>  23 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .383 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2,61 </font></font></td></tr><tr><td>  6 </td><td>  18 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .300 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3,34 </font></font></td></tr><tr><td>  7 </td><td>  13 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .216 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.62 </font></font></td></tr><tr><td>  8 </td><td>  8 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .133 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7,51 </font></font></td></tr><tr><td>  9 </td><td>  6 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .100 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10-12 </font></font></td><td>  5 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .083 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13-15 </font></font></td><td>  4 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .067 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 15.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16-18 </font></font></td><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .050 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 20/03 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 19-28 </font></font></td><td>  2 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .033 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 29+ </font></font></td><td>  1 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .017 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60.10 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le tableau comprend un total de 30 entr√©es. Apr√®s le niveau 29, la valeur des trames de descente est toujours 1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un nombre entier de trames de descente n'est pas une mani√®re tr√®s d√©taill√©e de d√©crire la vitesse. Comme le montre le graphique ci-dessous, la vitesse augmente de fa√ßon exponentielle avec chaque niveau. En fait, le niveau 29 est deux fois plus rapide que le niveau 28.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddd/18c/a29/ddd18ca2950f9055bd5f82108a4d3ddc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec 1 image / descente, le joueur n'a pas plus d'un tiers de seconde pour positionner la figure, apr√®s quoi elle commencera √† bouger. √Ä cette vitesse de descente, DAS ne permet pas √† la figurine d'atteindre les bords du terrain de jeu jusqu'√† ce qu'elle se verrouille en place, ce qui signifie pour la plupart des gens une fin rapide du jeu. Cependant, certains joueurs, notamment </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thor Akerlund</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ont r√©ussi √† vaincre DAS avec la vibration rapide des boutons crois√©s ( </font></font><code>D-pad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Dans le code de d√©calage illustr√© ci-dessus, on peut voir que tandis que le bouton de direction horizontale est rel√¢ch√© √† travers le cadre, il est possible de d√©caler le tetrimino aux niveaux 29 et sup√©rieurs avec une demi-fr√©quence. Il s'agit d'un maximum th√©orique, mais toute vibration du pouce sup√©rieure √† 3,75 taps / s peut annuler le retard d'origine de 16 images.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la descente automatique et contr√¥l√©e par le joueur (en appuyant sur "Bas") co√Øncide et se produit dans une seule image, l'effet ne s'additionne pas. L'un de ces √©v√©nements, ou les deux, font descendre la forme exactement d'une cellule dans ce cadre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La logique de commande de d√©clenchement se trouve √† </font></font><code>$8914</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La table du cadre de descente est sous l'√©tiquette </font><font style="vertical-align: inherit;">. Comme mentionn√© ci-dessus, au niveau 29 et au-dessus, la vitesse est constamment √©gale √† 1 obturateur / image. </font><font style="vertical-align: inherit;">(adresse </font><font style="vertical-align: inherit;">) commence la descente lorsqu'elle atteint </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">). L'incr√©mentation </font><font style="vertical-align: inherit;">est effectu√©e √† une adresse en </font><font style="vertical-align: inherit;">dehors de ce fragment de code. Lors d'une descente automatique ou contr√¥l√©e, elle est remise √† 0. La </font><font style="vertical-align: inherit;">variable </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) est initialis√©e avec la valeur </font><font style="vertical-align: inherit;">(√† l'adresse</font></font><br><br> <code>8914: LDA $004E ; if (autorepeatY &gt; 0) { <br> 8916: BPL $8922 ; goto autorepeating; <br> ; } else if (autorepeatY == 0) { <br> ; goto playing; <br> ; } <br> <br> ; game just started <br> ; initial Tetrimino hanging at spawn point <br> <br> 8918: LDA $00B5 ; if (not just pressed down) { <br> 891A: AND #$04 ; goto incrementAutorepeatY; <br> 891C: BEQ $8989 ; } <br> <br> ; player just pressed down ending startup delay <br> <br> 891E: LDA #$00 <br> 8920: STA $004E ; autorepeatY = 0; <br> 8922: BNE $8939 <br> <br> playing: <br> <br> 8924: LDA $00B6 ; if (left or right pressed) { <br> 8926: AND #$03 ; goto lookupDropSpeed; <br> 8928: BNE $8973 ; } <br> <br> ; left/right not pressed <br> <br> 892A: LDA $00B5 <br> 892C: AND #$0F ; if (not just pressed only down) { <br> 892E: CMP #$04 ; goto lookupDropSpeed; <br> 8930: BNE $8973 ; } <br> <br> ; player exclusively just presssed down <br> <br> 8932: LDA #$01 <br> 8934: STA $004E ; autorepeatY = 1; <br> <br> 8936: JMP $8973 ; goto lookupDropSpeed; <br> <br> autorepeating: <br> <br> 8939: LDA $00B6 <br> 893B: AND #$0F ; if (down pressed and not left/right) { <br> 893D: CMP #$04 ; goto downPressed; <br> 893F: BEQ $894A ; } <br> <br> ; down released <br> <br> 8941: LDA #$00 <br> 8943: STA $004E ; autorepeatY = 0 <br> 8945: STA $004F ; holdDownPoints = 0 <br> 8947: JMP $8973 ; goto lookupDropSpeed; <br> <br> downPressed: <br> <br> 894A: INC $004E ; autorepeatY++; <br> 894C: LDA $004E <br> 894E: CMP #$03 ; if (autorepeatY &lt; 3) { <br> 8950: BCC $8973 ; goto lookupDropSpeed; <br> ; } <br> <br> 8952: LDA #$01 <br> 8954: STA $004E ; autorepeatY = 1; <br> <br> 8956: INC $004F ; holdDownPoints++; <br> <br> drop: <br> <br> 8958: LDA #$00 <br> 895A: STA $0045 ; fallTimer = 0; <br> <br> 895C: LDA $0041 <br> 895E: STA $00AE ; originalY = tetriminoY; <br> <br> 8960: INC $0041 ; tetriminoY++; <br> 8962: JSR $948B ; if (new position valid) { <br> 8965: BEQ $8972 ; return; <br> ; } <br> <br> ; the piece is locked <br> <br> 8967: LDA $00AE <br> 8969: STA $0041 ; tetriminoY = originalY; <br> <br> 896B: LDA #$02 <br> 896D: STA $0048 ; playState = UPDATE_PLAYFIELD; <br> 896F: JSR $9CAF ; updatePlayfield(); <br> <br> 8972: RTS ; return; <br> <br> lookupDropSpeed: <br> <br> 8973: LDA #$01 ; tempSpeed = 1; <br> <br> 8975: LDX $0044 ; if (level &gt;= 29) { <br> 8977: CPX #$1D ; goto noTableLookup; <br> 8979: BCS $897E ; } <br> <br> 897B: LDA $898E,X ; tempSpeed = framesPerDropTable[level]; <br> <br> noTableLookup: <br> <br> 897E: STA $00AF ; dropSpeed = tempSpeed; <br> <br> 8980: LDA $0045 ; if (fallTimer &gt;= dropSpeed) { <br> 8982: CMP $00AF ; goto drop; <br> 8984: BPL $8958 ; } <br> <br> 8986: JMP $8972 ; return; <br> <br> incrementAutorepeatY: <br> <br> 8989: INC $004E ; autorepeatY++; <br> 898B: JMP $8972 ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>lookupDropSpeed</code><font style="vertical-align: inherit;"></font><br><br> <code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$0045</code><font style="vertical-align: inherit;"></font><code>dropSpeed</code><font style="vertical-align: inherit;"></font><code>$00AF</code><font style="vertical-align: inherit;"></font><code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$8892</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>autorepeatY</code><font style="vertical-align: inherit;"></font><code>$004E</code><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><code>$8739</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), qui est interpr√©t√© comme ‚àí96. Une condition au tout d√©but entra√Æne un retard initial. Le tout premier Tetrimino reste suspendu dans l'air au point de cr√©ation jusqu'√† ce </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'il augmente √† 0, ce qui prend 1,6 seconde. Cependant, lorsque vous appuyez vers le bas dans cette phase, le </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font><font style="vertical-align: inherit;">est </font><font style="vertical-align: inherit;">instantan√©ment attribu√©. Il est int√©ressant de pouvoir d√©placer et faire pivoter la figure dans cette phase du d√©lai initial sans l'annuler. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'incr√©mentation </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est effectu√©e tout en maintenant enfonc√©e. Quand il atteint 3, une descente contr√¥l√©e par l'homme (descente ¬´douce¬ª) se produit et est </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affect√©e √† 1. Par cons√©quent, la descente douce initiale n√©cessite 3 images, mais elle se r√©p√®te ensuite dans chaque image. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, il </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">passe de 0 √† 1 uniquement lorsque le jeu reconna√Æt que le joueur vient de cliquer vers le bas (√†</font></font><code>$00B5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais ne reconna√Æt pas le maintien. Ceci est important car il est </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©initialis√© √† 0 lors de la cr√©ation d'un tetrimino (√† l'adresse </font></font><code>$98E8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), ce qui cr√©e une fonctionnalit√© importante: si le joueur lui-m√™me abaisse la figure et qu'elle est bloqu√©e, et qu'il continue d'appuyer sur ¬´Bas¬ª lors de la cr√©ation de la figure suivante, ce qui se produit souvent √† des niveaux √©lev√©s, puis cela ne conduira pas √† une descente en douceur de la nouvelle figure. Pour cela, le joueur doit rel√¢cher ¬´Down¬ª, puis appuyer √† nouveau sur le bouton. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une descente potentiellement douce peut augmenter les points. </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$004F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) augmente √† chaque descente, mais une fois rel√¢ch√©, ¬´Down¬ª est remis √† 0. Par cons√©quent, pour marquer des points, il est n√©cessaire d'abaisser le tetrimino dans la serrure avec une descente en douceur. Une descente douce √† court terme, qui peut se produire sur le chemin de la figure, n'affecte pas les points. Le compte est mis √† jour √†</font></font><code>$9BFE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais est </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remis √† 0 peu de temps apr√®s, √† l'adresse </font></font><code>$9C2F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contr√¥le qui emp√™che le joueur d'effectuer une descente douce avec un d√©calage horizontal de la figure complique l'ensemble des points. Cela signifie que le dernier mouvement avant de verrouiller la pi√®ce en place doit √™tre ¬´Bas¬ª. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque la descente se produit, </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0041</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) est copi√© dans </font></font><code>originalY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Si la nouvelle position cr√©√©e par l'incr√©ment </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'av√®re incorrecte (c'est-√†-dire que la figure pousse √† travers le sol du terrain de jeu ou est superpos√©e √† des carr√©s d√©j√† couch√©s), le t√©trimino reste √† la position pr√©c√©dente. Dans ce cas, il est restaur√©</font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le chiffre est consid√©r√© comme bloqu√©. </font><font style="vertical-align: inherit;">Cela signifie que le d√©lai avant le verrouillage (le nombre maximal d'images qu'un t√©trimino attend, retenant dans l'air avant le verrouillage) est √©gal au d√©lai de descente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La descente rigide (tombant instantan√©ment) n'est pas prise en charge dans Nintendo Tetris.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Glissement et d√©filement </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le livret du manuel Nintendo Tetris contient un exemple de fiche illustr√©e: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6f/4bb/647/f6f4bb647937094d3d68fae530b0bfd4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le glissement consiste √† se d√©placer le long de la surface d'autres personnages ou le long du terrain de jeu. </font><font style="vertical-align: inherit;">Il est g√©n√©ralement utilis√© pour pousser une figure sous un carr√© en surplomb. </font><font style="vertical-align: inherit;">Le glissement peut √™tre effectu√© jusqu'√† ce que la minuterie de chute atteigne la vitesse de descente, apr√®s quoi la figure sera verrouill√©e en place. </font><font style="vertical-align: inherit;">Un exemple anim√© est illustr√© ci-dessous.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/9f5/022/efe9f502248d4185409fc20db3a47647.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D'un autre c√¥t√©, le d√©filement vous permet de pousser des personnages dans des espaces inaccessibles d'une autre mani√®re (voir ci-dessous). </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/ca5/350/c53ca53509826b9f2c462c0290ffa9c9.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme le glissement, le d√©filement n'est pas possible sans d√©lai de verrouillage. </font><font style="vertical-align: inherit;">Mais au-del√†, le d√©filement exploite la fa√ßon dont le jeu manipule les formes. </font><font style="vertical-align: inherit;">Avant de d√©placer ou de faire pivoter la figurine, le jeu v√©rifie qu'apr√®s avoir chang√© la position, tous les carr√©s tetrimino seront dans des cellules vides √† l'int√©rieur des limites du terrain de jeu. </font><font style="vertical-align: inherit;">Une telle v√©rification, comme illustr√© ci-dessous, n'emp√™che pas la rotation √† travers les blocs remplis √† proximit√©. </font><font style="vertical-align: inherit;">Comme indiqu√© dans la section Description de Tetrimino, chaque ligne du tableau d'orientation contient 12 octets; </font><font style="vertical-align: inherit;">par cons√©quent, l'indice dans ce tableau est calcul√© en multipliant l'ID d'orientation du t√©trimino actif par 12. Comme indiqu√© ci-dessous, toutes les multiplications dans la routine sont effectu√©es en utilisant des d√©calages et des ajouts.</font></font><br><br> <code>948B: LDA $0041 <br> 948D: ASL <br> 948E: STA $00A8 <br> 9490: ASL <br> 9491: ASL <br> 9492: CLC <br> 9493: ADC $00A8 <br> 9495: ADC $0040 <br> 9497: STA $00A8 <br> <br> 9499: LDA $0042 <br> 949B: ASL <br> 949C: ASL <br> 949D: STA $00A9 <br> 949F: ASL <br> 94A0: CLC <br> 94A1: ADC $00A9 <br> 94A3: TAX ; index = 12 * orientationID; <br> 94A4: LDY #$00 <br> <br> 94A6: LDA #$04 <br> 94A8: STA $00AA ; for(i = 0; i &lt; 4; i++) { <br> <br> 94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY &lt; -2 || cellY &gt;= 20) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; } <br> <br> 94B6: LDA $8A9C,X <br> 94B9: ASL <br> 94BA: STA $00AB <br> 94BC: ASL <br> 94BD: ASL <br> 94BE: CLC <br> 94BF: ADC $00AB <br> 94C1: CLC <br> 94C2: ADC $00A8 <br> 94C4: STA $00AD <br> <br> 94C6: INX <br> 94C7: INX ; index += 2; <br> <br> 94C8: LDA $8A9C,X ; squareX = orientationTable[index]; <br> 94CB: CLC <br> 94CC: ADC $00AD <br> 94CE: TAY ; cellX = squareX + tetriminoX; <br> 94CF: LDA ($B8),Y ; if (playfield[10 * cellY + cellX] != EMPTY_TILE) { <br> 94D1: CMP #$EF ; return false; <br> 94D3: BCC $94E9 ; } <br> <br> 94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &lt; 0 || cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; } <br> <br> 94DF: INX ; index++; <br> 94E0: DEC $00AA <br> 94E2: BNE $94AA ; } <br> <br> 94E4: LDA #$00 <br> 94E6: STA $00A8 <br> 94E8: RTS ; return true; <br> <br> 94E9: LDA #$FF <br> 94EB: STA $00A8 <br> 94ED: RTS</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>index = (orientationID &lt;&lt; 3) + (orientationID &lt;&lt; 2); // index = 8 * orientationID + 4 * orientationID; <br> <br> (cellY &lt;&lt; 3) + (cellY &lt;&lt; 1) // 8 * cellY + 2 * cellY</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chaque it√©ration du cycle d√©cale la position du t√©trimino par les coordonn√©es relatives de l'un des carr√©s de la table d'orientation afin d'obtenir l'emplacement de cellule correspondant sur le terrain de jeu. Elle v√©rifie ensuite que les coordonn√©es de la cellule sont dans les limites du terrain de jeu et que la cellule elle-m√™me est vide. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les commentaires d√©crivent plus clairement comment v√©rifier l'espacement des lignes. </font><font style="vertical-align: inherit;">En plus des cellules dans les lignes visibles, le code consid√®re les deux lignes cach√©es au-dessus du terrain de jeu comme les positions l√©gales des carr√©s sans utiliser de condition compos√©e. Cela fonctionne car dans le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">code suppl√©mentaire, les</font></a><font style="vertical-align: inherit;"> nombres n√©gatifs repr√©sent√©s par des variables √† un octet sont √©quivalents √† des valeurs sup√©rieures √† 127. Dans ce cas, la valeur minimale </font><font style="vertical-align: inherit;">est -2, qui est stock√©e sous la forme</font></font><br><br> <code>94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY + 2 &gt;= 22) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>cellY</code><font style="vertical-align: inherit;"></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(254 en notation d√©cimale). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'indice du terrain de jeu est la somme </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multipli√©e par 10 et </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cependant, lorsque </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àí1 ( </font></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 255) ou ‚àí2 ( </font></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 254), le produit donne ‚àí10 ( </font></font><code>$F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 246) et ‚àí20 ( </font></font><code>$EC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 236). √âtant dans l'intervalle, il </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut pas √™tre plus de 9, ce qui donne un indice maximum de 246 + 9 = 255, et c'est bien plus loin que la fin du terrain de jeu. Cependant, le jeu s'initialise </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur </font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(d'une tuile vide), cr√©ant encore 56 octets suppl√©mentaires d'espace vide. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtrange cette v√©rification d'intervalle</font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effectu√© apr√®s avoir examin√© la cellule du terrain de jeu. </font><font style="vertical-align: inherit;">Mais cela fonctionne correctement dans n'importe quel ordre. </font><font style="vertical-align: inherit;">De plus, la v√©rification de l'intervalle √©vite la condition composite, comme indiqu√© dans le commentaire ci-dessous. </font><font style="vertical-align: inherit;">Les exemples de d√©filement ci-dessous sont possibles en raison de la fa√ßon dont ce code v√©rifie les positions.</font></font><br><br> <code>94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45f/c2d/dc0/45fc2ddc0d156d534aad4fd065b86aa4.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15f/185/0db/15f1850dbfca0b491498e8d81ab03877.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comme illustr√© ci-dessous, vous pouvez m√™me effectuer un glissement avec d√©filement. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08f/74c/c78/08f74cc7825cd53d5a8002b8e33c4612.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'IA tire pleinement parti des capacit√©s de d√©placement de la Nintendo Tetris, notamment le glissement et le d√©filement. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Niveau 30 et sup√©rieur </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apr√®s avoir atteint le niveau 30, il semble que le niveau soit remis √† z√©ro. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/feb/fee/b1f/febfeeb1faafda1a70f5da385c2276ac.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais le niveau 31 montre qu'il se passe autre chose: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26e/057/20c/26e05720ca15aa302a0b61e09498e5a0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les valeurs de niveau affich√©es sont situ√©es dans le tableau √† l'adresse </font></font><code>$96B8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>96B8: 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme indiqu√© ci - </font><font style="vertical-align: inherit;">dessous, le tableau de configuration est ordonn√©e de </font><font style="vertical-align: inherit;">telle sorte que les carreaux avec </font></font><code>$00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur </font></font><code>$0F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des symboles pour Glyphes </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur </font></font><code>F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela signifie que lors de l'affichage d'un chiffre d√©cimal ou hexad√©cimal, la valeur du chiffre lui-m√™me est utilis√©e comme index de la table de mod√®le. Dans notre cas, les valeurs de niveau sont stock√©es sous forme d√©cimale cod√©e binaire (BCD); chaque quartet de chaque octet de la s√©quence est une valeur de tuile.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malheureusement, il semble que les concepteurs de jeux aient suppos√© que personne ne passerait le niveau 29 et ont donc d√©cid√© d'ins√©rer seulement 30 entr√©es dans le tableau. Les valeurs affich√©es √©tranges sont des octets diff√©rents apr√®s le tableau. Un seul octet (√† l'adresse </font></font><code>$0044</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) est </font><font style="vertical-align: inherit;">utilis√© pour indiquer le num√©ro de niveau </font><font style="vertical-align: inherit;">, c'est pourquoi le jeu tourne lentement autour des 256 valeurs indiqu√©es ci-dessous.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>00</code> </th> <th> <code>0</code> </th> <th> <code>1</code> </th> <th> <code>2</code> </th> <th> <code>3</code> </th> <th> <code>4</code> </th> <th> <code>5</code> </th> <th> <code>6</code> </th> <th> <code>7</code> </th> <th> <code>8</code> </th> <th> <code>9</code> </th> <th> <code>A</code> </th> <th> <code>B</code> </th> <th> <code>C</code> </th> <th> <code>D</code> </th> <th> <code>E</code> </th> <th> <code>F</code> </th> </tr><tr><th> <code>0</code> </th> <td> <code>00</code> </td> <td> <code>01</code> </td> <td> <code>02</code> </td> <td> <code>03</code> </td> <td> <code>04</code> </td> <td> <code>05</code> </td> <td> <code>06</code> </td> <td> <code>07</code> </td> <td> <code>08</code> </td> <td> <code>09</code> </td> <td> <code>10</code> </td> <td> <code>11</code> </td> <td> <code>12</code> </td> <td> <code>13</code> </td> <td> <code>14</code> </td> <td> <code>15</code> </td> </tr><tr><th> <code>1</code> </th> <td> <code>16</code> </td> <td> <code>17</code> </td> <td> <code>18</code> </td> <td> <code>19</code> </td> <td> <code>20</code> </td> <td> <code>21</code> </td> <td> <code>22</code> </td> <td> <code>23</code> </td> <td> <code>24</code> </td> <td> <code>25</code> </td> <td> <code>26</code> </td> <td> <code>27</code> </td> <td> <code>28</code> </td> <td> <code>29</code> </td> <td> <code>00</code> </td> <td> <code>0A</code> </td> </tr><tr><th> <code>2</code> </th> <td> <code>14</code> </td> <td> <code>1E</code> </td> <td> <code>28</code> </td> <td> <code>32</code> </td> <td> <code>3C</code> </td> <td> <code>46</code> </td> <td> <code>50</code> </td> <td> <code>5A</code> </td> <td> <code>64</code> </td> <td> <code>6E</code> </td> <td> <code>78</code> </td> <td> <code>82</code> </td> <td> <code>8C</code> </td> <td> <code>96</code> </td> <td> <code>A0</code> </td> <td> <code>AA</code> </td> </tr><tr><th> <code>3</code> </th> <td> <code>B4</code> </td> <td> <code>BE</code> </td> <td> <code>C6</code> </td> <td> <code>20</code> </td> <td> <code>E6</code> </td> <td> <code>20</code> </td> <td> <code>06</code> </td> <td> <code>21</code> </td> <td> <code>26</code> </td> <td> <code>21</code> </td> <td> <code>46</code> </td> <td> <code>21</code> </td> <td> <code>66</code> </td> <td> <code>21</code> </td> <td> <code>86</code> </td> <td> <code>21</code> </td> </tr><tr><th> <code>4</code> </th> <td> <code>A6</code> </td> <td> <code>21</code> </td> <td> <code>C6</code> </td> <td> <code>21</code> </td> <td> <code>E6</code> </td> <td> <code>21</code> </td> <td> <code>06</code> </td> <td> <code>22</code> </td> <td> <code>26</code> </td> <td> <code>22</code> </td> <td> <code>46</code> </td> <td> <code>22</code> </td> <td> <code>66</code> </td> <td> <code>22</code> </td> <td> <code>86</code> </td> <td> <code>22</code> </td> </tr><tr><th> <code>5</code> </th> <td> <code>A6</code> </td> <td> <code>22</code> </td> <td> <code>C6</code> </td> <td> <code>22</code> </td> <td> <code>E6</code> </td> <td> <code>22</code> </td> <td> <code>06</code> </td> <td> <code>23</code> </td> <td> <code>26</code> </td> <td> <code>23</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>F0</code> </td> <td> <code>4A</code> </td> <td> <code>4A</code> </td> </tr><tr><th> <code>6</code> </th> <td> <code>4A</code> </td> <td> <code>4A</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>0F</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>60</code> </td> <td> <code>A6</code> </td> <td> <code>49</code> </td> <td> <code>E0</code> </td> </tr><tr><th> <code>7</code> </th> <td> <code>15</code> </td> <td> <code>10</code> </td> <td> <code>53</code> </td> <td> <code>BD</code> </td> <td> <code>D6</code> </td> <td> <code>96</code> </td> <td> <code>A8</code> </td> <td> <code>8A</code> </td> <td> <code>0A</code> </td> <td> <code>AA</code> </td> <td> <code>E8</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> </tr><tr><th> <code>8</code> </th> <td> <code>20</code> </td> <td> <code>CA</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>F0</code> </td> <td> <code>1E</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> <td> <code>C9</code> </td> <td> <code>05</code> </td> <td> <code>F0</code> </td> <td> <code>0C</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> </tr><tr><th> <code>9</code> </th> <td> <code>96</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>0C</code> </td> </tr><tr><th> <code>A</code> </th> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>A2</code> </td> </tr><tr><th> <code>B</code> </th> <td> <code>0A</code> </td> <td> <code>B1</code> </td> <td> <code>B8</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>C8</code> </td> <td> <code>CA</code> </td> <td> <code>D0</code> </td> <td> <code>F7</code> </td> <td> <code>E6</code> </td> <td> <code>49</code> </td> <td> <code>A5</code> </td> <td> <code>49</code> </td> <td> <code>C9</code> </td> <td> <code>14</code> </td> </tr><tr><th> <code>C</code> </th> <td> <code>30</code> </td> <td> <code>04</code> </td> <td> <code>A9</code> </td> <td> <code>20</code> </td> <td> <code>85</code> </td> <td> <code>49</code> </td> <td> <code>60</code> </td> <td> <code>A5</code> </td> <td> <code>B1</code> </td> <td> <code>29</code> </td> <td> <code>03</code> </td> <td> <code>D0</code> </td> <td> <code>78</code> </td> <td> <code>A9</code> </td> <td> <code>00</code> </td> <td> <code>85</code> </td> </tr><tr><th> <code>D</code> </th> <td> <code>AA</code> </td> <td> <code>A6</code> </td> <td> <code>AA</code> </td> <td> <code>B5</code> </td> <td> <code>4A</code> </td> <td> <code>F0</code> </td> <td> <code>5C</code> </td> <td> <code>0A</code> </td> <td> <code>A8</code> </td> <td> <code>B9</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> </tr><tr><th> <code>E</code> </th> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> </tr><tr><th> <code>F</code> </th> <td> <code>C9</code> </td> <td> <code>04</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> </tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 20 premi√®res valeurs ordinales sont en fait une autre table qui stocke les d√©calages sur le terrain de jeu pour chacune des 20 lignes. </font><font style="vertical-align: inherit;">√âtant donn√© que le terrain de jeu commence par </font><font style="vertical-align: inherit;">et que chaque ligne contient 10 cellules, l'adresse d'une cellule arbitraire est: </font><font style="vertical-align: inherit;">√âtant donn√© que le processeur ne prend pas directement en charge la multiplication, cette table de recherche fournit un moyen extr√™mement rapide d'obtenir le produit. </font><font style="vertical-align: inherit;">Le tableau correspondant occupe les 40 octets suivants. </font><font style="vertical-align: inherit;">Il contient 20 adresses en petit format endian pour la table de noms 0 (une zone de m√©moire VRAM contenant les valeurs des tuiles d'arri√®re-plan). </font><font style="vertical-align: inherit;">Ce sont des pointeurs sur les lignes de d√©calage du terrain de jeu </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Les octets restants √† partir desquels les valeurs de niveau affich√©es sont compos√©es sont des instructions.</font></font><br><br> <code>96D6: 00 ; 0 <br> 96D7: 0A ; 10 <br> 96D8: 14 ; 20 <br> 96D9: 1E ; 30 <br> 96DA: 28 ; 40 <br> 96DB: 32 ; 50 <br> 96DC: 3C ; 60 <br> 96DD: 46 ; 70 <br> 96DE: 50 ; 80 <br> 96DF: 5A ; 90 <br> 96E0: 64 ; 100 <br> 96E1: 6E ; 110 <br> 96E2: 78 ; 120 <br> 96E3: 82 ; 130 <br> 96E4: 8C ; 140 <br> 96E5: 96 ; 150 <br> 96E6: A0 ; 160 <br> 96E7: AA ; 170 <br> 96E8: B4 ; 180 <br> 96E9: BE ; 190</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0400</code><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + 10 * y + x</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + [$96D6 + y] + x</code> <br> <br><font style="vertical-align: inherit;"></font><code>$06</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lignes et statistiques </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le nombre de lignes termin√©es et les statistiques tetrimino occupent chacun 2 octets aux adresses suivantes. </font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Adresses </th><th>  La quantit√© </th></tr><tr><td> <code>0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>0051</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rangs </font></font></td></tr><tr><td> <code>03F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F1</code> </td><td>  T </td></tr><tr><td> <code>03F2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F3</code> </td><td>  J </td></tr><tr><td> <code>03F4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F5</code> </td><td>  Z </td></tr><tr><td> <code>03F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F7</code> </td><td>  O </td></tr><tr><td> <code>03F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F9</code> </td><td>  S </td></tr><tr><td> <code>03FA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FB</code> </td><td>  L </td></tr><tr><td> <code>03FC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FD</code> </td><td>  Je </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, ces valeurs sont stock√©es sous forme de petits BCD endian compact√©s sur 16 bits. </font><font style="vertical-align: inherit;">Par exemple, le nombre de lignes est indiqu√© ci-dessous, qui est 123. Les octets sont compt√©s de droite √† gauche afin que les chiffres d√©cimaux se suivent dans l'ordre.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f4/68b/c0e/4f468bc0e6f22afe40d74f1711bad46e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, les concepteurs de jeux ont suppos√© qu'aucune des valeurs ne serait sup√©rieure √† 999. Par cons√©quent, la logique d'affichage traite correctement le premier octet comme un BCD compress√©, o√π chaque quartet est utilis√© comme valeur de tuile. </font><font style="vertical-align: inherit;">Mais le deuxi√®me octet entier est en fait utilis√© comme premier chiffre d√©cimal. </font><font style="vertical-align: inherit;">Lorsque les chiffres inf√©rieurs vont de </font></font><code>99</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† </font></font><code>00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'incr√©ment normal du deuxi√®me octet se produit. </font><font style="vertical-align: inherit;">Par cons√©quent, le deuxi√®me octet parcourt les 256 tuiles. </font><font style="vertical-align: inherit;">Un exemple de ceci est illustr√© ci-dessous.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c7/b4a/d52/6c7b4ad52a59641b8c2e04971415f0df.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s avoir effac√© la ligne, le code suivant est ex√©cut√© pour incr√©menter le nombre de lignes. </font><font style="vertical-align: inherit;">Des v√©rifications sont effectu√©es pour les chiffres du milieu et du bas afin qu'ils restent entre 0 et 9. Mais le chiffre du haut peut √™tre augment√© √† l'infini. </font><font style="vertical-align: inherit;">Si apr√®s l'incr√©ment du nombre de lignes le chiffre inf√©rieur est 0, cela signifie que le joueur vient de terminer un ensemble de 10 lignes et que vous devez augmenter le nombre de niveaux. Comme vous pouvez le voir dans le code ci-dessous, une v√©rification suppl√©mentaire est effectu√©e avant l'incr√©ment de niveau. </font><font style="vertical-align: inherit;">Le deuxi√®me contr√¥le est li√© au niveau d'entr√©e s√©lectionn√©. Pour acc√©der √† un certain niveau </font><font style="vertical-align: inherit;">, quel que soit le niveau initial, le joueur doit effacer</font></font><br><br> <code>9BA8: INC $0050 ; increment middle-lowest digit pair <br> 9BAA: LDA $0050 <br> 9BAC: AND #$0F <br> 9BAE: CMP #$0A ; if (lowest digit &gt; 9) { <br> 9BB0: BMI $9BC7 <br> 9BB2: LDA $0050 <br> 9BB4: CLC <br> 9BB5: ADC #$06 ; set lowest digit to 0, increment middle digit <br> 9BB7: STA $0050 <br> 9BB9: AND #$F0 <br> 9BBB: CMP #$A0 ; if (middle digit &gt; 9) { <br> 9BBD: BCC $9BC7 <br> 9BBF: LDA $0050 <br> 9BC1: AND #$0F <br> 9BC3: STA $0050 ; set middle digit to 0 <br> 9BC5: INC $0051 ; increment highest digit <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9BC7: LDA $0050 <br> 9BC9: AND #$0F <br> 9BCB: BNE $9BFB ; if (lowest digit == 0) { <br> 9BCD: JMP $9BD0 <br> <br> 9BD0: LDA $0051 <br> 9BD2: STA $00A9 <br> 9BD4: LDA $0050 <br> 9BD6: STA $00A8 ; copy digits from $0050-$0051 to $00A8-$00A9 <br> <br> 9BD8: LSR $00A9 <br> 9BDA: ROR $00A8 <br> 9BDC: LSR $00A9 <br> 9BDE: ROR $00A8 <br> 9BE0: LSR $00A9 <br> 9BE2: ROR $00A8 ; treat $00A8-$00A9 as a 16-bit packed BCD value <br> 9BE4: LSR $00A9 ; and right-shift it 4 times <br> 9BE6: ROR $00A8 ; this leaves the highest and middle digits in $00A8 <br> <br> 9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level &lt; [$00A8]) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>X</code><font style="vertical-align: inherit;"></font><code>10X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lignes. Par exemple, si un joueur commence au niveau 5, il y restera jusqu'√† ce qu'il ait effac√© 60 lignes, apr√®s quoi il ira au niveau 6. Apr√®s cela, toutes les 10 lignes suppl√©mentaires entra√Æneront une augmentation du nombre de niveaux. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour effectuer cette v√©rification, la valeur des lignes remplies est copi√©e de </font></font><code>$0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vers </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, la copie est d√©cal√©e de 4 fois vers la droite, ce qui pour un BCD compress√© est similaire √† la division par 10. Le plus petit chiffre d√©cimal est rejet√© et les chiffres le plus √©lev√© et le milieu sont d√©cal√©s d'une position, ce qui entra√Æne des grignotages </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e4/c0b/2e7/8e4c0b2e7d53a33d54cea8717a872a65.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, √† l'adresse, </font></font><code>$9BEA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le num√©ro de niveau est directement compar√© √† la valeur compress√©e du BCD </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il n'y a aucune recherche dans le tableau pour convertir la valeur BCD en d√©cimal, et c'est une erreur claire. </font><font style="vertical-align: inherit;">Par exemple, dans l'image ci-dessus, le num√©ro de niveau doit √™tre compar√© √† </font></font><code>$12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(18 en d√©cimal) et non √† 12. Par cons√©quent, si un joueur d√©cide de commencer au niveau 17, le niveau ira en fait √† 120 lignes, car 18 est plus que 17. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le tableau indique le nombre attendu de lignes requises pour la transition √† chaque niveau initial. </font><font style="vertical-align: inherit;">Il est compar√© √† ce qui se passe r√©ellement en raison d'un bug.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code> </code> </th> <td>  0 </td><td>  1 </td><td>  2 </td><td>  3 </td><td>  4 </td><td>  5 </td><td>  6 </td><td>  7 </td><td>  8 </td><td>  9 </td><td>  10 </td><td>  11 </td><td>  12 </td><td>  13 </td><td>  14 </td><td>  15 </td><td>  16 </td><td>  17 </td><td>  18 </td><td>  19 </td></tr><tr><th> <code>  </code> </th> <td>  10 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 20 </font></font></td><td>  30 </td><td>  40 </td><td>  50 </td><td>  60 </td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td>  110 </td><td>  120 </td><td>  130 </td><td>  140 </td><td>  150 </td><td>  160 </td><td>  170 </td><td>  180 </td><td>  190 </td><td>  200 </td></tr><tr><th> <code>    </code> </th> <td>  10 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 20 </font></font></td><td>  30 </td><td>  40 </td><td>  50 </td><td>  60 </td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  110 </td><td>  120 </td><td>  130 </td><td>  140 </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le montant attendu est identique √† vrai pour les niveaux initiaux 0‚Äì9. </font><font style="vertical-align: inherit;">En fait, la co√Øncidence pour le niveau d'entr√©e 9 est al√©atoire; </font><font style="vertical-align: inherit;">10-15 passe √©galement au niveau suivant avec 100 lignes, car </font></font><code>$10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- c'est 16 sous forme d√©cimale. </font><font style="vertical-align: inherit;">La plus grande diff√©rence entre les pr√©visions et les r√©elles est de 60 lignes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je soup√ßonne que le bogue est d√ª √† des modifications de conception dans les derniers stades de d√©veloppement. </font><font style="vertical-align: inherit;">Regardez l'√©cran du menu, permettant au joueur de choisir un niveau d'entr√©e.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/858/51e/019/85851e019d65bf00d265fa4ea277b8c2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il n'y a aucune explication sur la fa√ßon de commencer √† partir de niveaux sup√©rieurs √† 9. Mais dans le livret Nintendo Tetris, ce secret est r√©v√©l√©: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c20/cee/c3b/c20ceec3b4b30879812be109b6666b79.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il semble que cette fonctionnalit√© cach√©e ait √©t√© invent√©e au dernier moment. Peut-√™tre qu'il a √©t√© ajout√© tr√®s pr√®s de la date de sortie, ce qui n'a pas permis de le tester compl√®tement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, la v√©rification de la s√©rie initiale contient une deuxi√®me erreur li√©e √† la sortie des valeurs de l'intervalle. Vous trouverez ci-dessous des commentaires dans le code qui expliquent mieux ce qui se passe √† un bas niveau. </font><font style="vertical-align: inherit;">La comparaison est effectu√©e en soustrayant et en v√©rifiant le signe du r√©sultat. Mais un nombre sign√© sur un octet est limit√© de ‚àí128 √† 127. Si la diff√©rence est inf√©rieure √† ‚àí128, le nombre est report√© et le r√©sultat devient un nombre positif. Ce principe est expliqu√© dans les commentaires sur le code. </font><font style="vertical-align: inherit;">Lors de la v√©rification que la diff√©rence se situe dans cet intervalle, il faut tenir compte du fait que le num√©ro de niveau, lors de l'incr√©mentation √† des valeurs sup√©rieures √† 255, effectue le transfert √† 0, et</font></font><br><br> <code>9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level - [$00A8] &lt; 0) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9BE8: LDA $0044 ; difference = level - [$00A8]; <br> 9BEA: CMP $00A8 ; if (difference &lt; 0 &amp;&amp; difference &gt;= -128) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">potentiellement, il peut contenir n'importe quelle valeur, car son quartet sup√©rieur est pris </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dont l'incr√©ment peut se produire √† l'infini. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ces effets se chevauchent, cr√©ant des p√©riodes pendant lesquelles le num√©ro de niveau reste par erreur inchang√©. </font><font style="vertical-align: inherit;">Les p√©riodes se produisent √† intervalles r√©guliers de 2 900 lignes, √† partir de 2 190 lignes et durent 800 lignes. </font><font style="vertical-align: inherit;">Par exemple, de 2190 ( </font></font><code>L90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √† 2990 ( </font></font><code>T90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), le niveau reste √©gal √† </font></font><code>$DB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>96</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), comme illustr√© ci-dessous.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/055/e15/8de/055e158de2ecde24e0f052cd325bef32.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La p√©riode suivante se passe de 5090 √† 5890, le niveau est constamment √©gal √† </font></font><code>$AD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">De plus, pendant ces p√©riodes, la palette de couleurs ne change pas non plus.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Coloriage - Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä chaque niveau, les tuiles tetrimino se voient attribuer 4 couleurs uniques. </font><font style="vertical-align: inherit;">Les couleurs sont tir√©es du tableau situ√© √† </font></font><code>$984C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ses enregistrements sont r√©utilis√©s tous les 10 niveaux. </font><font style="vertical-align: inherit;">De gauche √† droite: les colonnes du tableau correspondant aux zones noires, blanches, bleues et rouges de l'image ci-dessous.</font></font><br><br> <code>984C: 0F 30 21 12 ; level 0 <br> 9850: 0F 30 29 1A ; level 1 <br> 9854: 0F 30 24 14 ; level 2 <br> 9858: 0F 30 2A 12 ; level 3 <br> 985C: 0F 30 2B 15 ; level 4 <br> 9860: 0F 30 22 2B ; level 5 <br> 9864: 0F 30 00 16 ; level 6 <br> 9868: 0F 30 05 13 ; level 7 <br> 986C: 0F 30 16 12 ; level 8 <br> 9870: 0F 30 27 16 ; level 9</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68e/fc4/7d7/68efc47d771e9c673b003d76810d74fb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Les valeurs correspondent √† la palette de couleurs NES. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e80/c0a/8b6/e80c0a8b624b90261042d71eb21d50db.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 2 premi√®res couleurs de chaque entr√©e sont toujours en noir et blanc. Cependant, la premi√®re couleur est en fait ignor√©e; quelle que soit la valeur, elle est consid√©r√©e comme une couleur transparente √† travers laquelle un fond noir uni appara√Æt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'acc√®s √† la table des couleurs est effectu√© dans la routine √† </font></font><code>$9808</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'index de la table des couleurs est bas√© sur le nombre de niveaux divis√© par un reste de 10. Le cycle copie l'entr√©e dans les tables de palette dans VRAM. </font><font style="vertical-align: inherit;">La division avec le reste est √©mul√©e par une soustraction constante de 10 jusqu'√† ce que le r√©sultat soit inf√©rieur √† 10. Le d√©but du sous-programme avec commentaires est illustr√© ci-dessous.</font></font><br><br> <code>9808: LDA $0064 <br> 980A: CMP #$0A <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A <br> 9811: JMP $980A ; index = levelNumber % 10; <br> <br> 9814: ASL <br> 9815: ASL <br> 9816: TAX ; index *= 4; <br> <br> 9817: LDA #$00 <br> 9819: STA $00A8 ; for(i = 0; i &lt; 32; i += 16) { <br> <br> 981B: LDA #$3F <br> 981D: STA $2006 <br> 9820: LDA #$08 <br> 9822: CLC <br> 9823: ADC $00A8 <br> 9825: STA $2006 ; palette = $3F00 + i + 8; <br> <br> 9828: LDA $984C,X <br> 982B: STA $2007 ; palette[0] = colorTable[index + 0]; <br> <br> 982E: LDA $984D,X <br> 9831: STA $2007 ; palette[1] = colorTable[index + 1]; <br> <br> 9834: LDA $984E,X <br> 9837: STA $2007 ; palette[2] = colorTable[index + 2]; <br> <br> 983A: LDA $984F,X <br> 983D: STA $2007 ; palette[3] = colorTable[index + 3]; <br> <br> 9840: LDA $00A8 <br> 9842: CLC <br> 9843: ADC #$10 <br> 9845: STA $00A8 <br> 9847: CMP #$20 <br> 9849: BNE $981B ; } <br> <br> 984B: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, comme indiqu√© dans la section pr√©c√©dente, la soustraction et la ramification bas√©es sur le signe de diff√©rence sont utilis√©es en comparaison. </font><font style="vertical-align: inherit;">Un nombre sign√© sur un octet est limit√© de ‚àí128 √† 127. Les commentaires mis √† jour ci-dessous refl√®tent ce principe. </font><font style="vertical-align: inherit;">Les commentaires ci-dessous sont encore simplifi√©s. </font><font style="vertical-align: inherit;">Cette formulation r√©v√®le une erreur dans le code. </font><font style="vertical-align: inherit;">L'op√©ration de division restante est compl√®tement ignor√©e pour les niveaux √† partir de 138 et plus. </font><font style="vertical-align: inherit;">Au lieu de cela, l'index est attribu√© directement au num√©ro de niveau, ce qui permet d'acc√©der aux octets bien au-del√† de la fin de la table des couleurs. </font><font style="vertical-align: inherit;">Comme indiqu√© ci-dessous, cela peut m√™me conduire √† un t√©trimino presque invisible.</font></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> ; difference = index - 10; <br> 980A: CMP #$0A ; while(difference &gt;= 0 &amp;&amp; difference &lt;= 127) { <br> 980C: BMI $9814 <br> 980E: SEC ; index -= 10; <br> 980F: SBC #$0A ; difference = index - 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10 &amp;&amp; index &lt;= 137) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ed/2e5/2c6/6ed2e52c6a20dc9c8c1ffd1bf13d9b37.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous trouverez ci-dessous les couleurs des 256 niveaux. </font><font style="vertical-align: inherit;">Les vignettes sont dispos√©es en 10 colonnes pour souligner l'utilisation cyclique de la table des couleurs, viol√©e au niveau 138. Les lignes et les colonnes dans les en-t√™tes sont indiqu√©es en d√©cimal.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/423/6f0/ed6/4236f0ed6a508633b746d773a530fe90.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s 255, le num√©ro de niveau revient √† 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En outre, comme mentionn√© dans la section pr√©c√©dente, certains niveaux ne changent pas jusqu'√† ce que 800 lignes soient supprim√©es. </font><font style="vertical-align: inherit;">Pendant ces longs niveaux, les couleurs restent inchang√©es.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mode de jeu </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le mode de jeu enregistr√© √† l'adresse </font></font><code>$00C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©termine lequel des divers √©crans et menus est actuellement affich√© pour l'utilisateur.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Valeur </font></font></th><th>  La description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran d'informations l√©gales </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran d'accueil </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu Type de jeu </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu des niveaux et hauteurs </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jeu / meilleur score / fin / pause </font></font></td></tr><tr><td> <code>05</code> </td> <td>  D√©mo </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme indiqu√© ci-dessus, le jeu a une routine intelligemment √©crite qui agit comme une instruction de commutation en utilisant la petite table de navigation endian situ√©e imm√©diatement apr√®s l'appel. </font><font style="vertical-align: inherit;">La liste ci-dessus montre les adresses de tous les modes de jeu. Notez que les modes ¬´Jeu¬ª et ¬´D√©mo¬ª utilisent le m√™me code. </font><font style="vertical-align: inherit;">Cette routine ne revient jamais. Au lieu de cela, le code utilise l'adresse de retour; g√©n√©ralement, il pointe vers l'instruction imm√©diatement apr√®s l'appel au saut vers le sous-programme (moins 1 octet), mais dans ce cas, il pointe vers la table de saut. L'adresse de retour est extraite de la pile et stock√©e dans </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Apr√®s avoir enregistr√© l'adresse de la table de sauts, le code utilise la valeur du registre A comme index et effectue la transition correspondante.</font></font><br><br> <code>8161: LDA $00C0 <br> 8163: JSR $AC82 ; switch(gameMode) { <br> 8166: 00 82 ; case 0: goto 8200; //     <br> 8168: 4F 82 ; case 1: goto 824F; //   <br> 816A: D1 82 ; case 2: goto 82D1; //    <br> 816C: D7 83 ; case 3: goto 83D7; //     <br> 816E: 5D 81 ; case 4: goto 815D; //  /   /  /  <br> 8170: 5D 81 ; case 5: goto 815D; //  <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$0000</code><font style="vertical-align: inherit;"></font><code>$0001</code><font style="vertical-align: inherit;"></font><br><br> <code>AC82: ASL <br> AC83: TAY <br> AC84: INY <br> <br> AC85: PLA <br> AC86: STA $0000 <br> AC88: PLA ; pop return address off of stack <br> AC89: STA $0001 ; and store it at $0000-$0001 <br> <br> AC8B: LDA ($00),Y <br> AC8D: TAX <br> AC8E: INY <br> AC8F: LDA ($00),Y <br> AC91: STA $0001 <br> AC93: STX $0000 <br> AC95: JMP ($0000) ; goto Ath 16-bit address <br> ; in table at [$0000-$0001]</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le code peut utiliser cette routine de commutation tant que les indices sont proches de 0 et qu'il n'y a pas d'espaces ou peu entre les cas possibles. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran d'informations l√©gales </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le jeu d√©marre avec un √©cran affichant un avis l√©gal. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/4e2/d4b/5244e2d4b26989579afaad64838c0962.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au bas de l'√©cran, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aleksey Pazhitnov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est mentionn√© </font><font style="vertical-align: inherit;">comme l'inventeur, le concepteur et le programmeur du premier Tetris. En 1984, en tant que d√©veloppeur informatique au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dorodnitsyn Computing Center</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (un des principaux instituts de recherche de l'Acad√©mie russe des sciences de Moscou), il a d√©velopp√© un prototype du jeu sur l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©lectronique-60</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (clone sovi√©tique DEC </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSI-11</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Un prototype a √©t√© d√©velopp√© pour un mode de texte monochrome vert dans lequel les carr√©s sont indiqu√©s par des paires de crochets </font></font><code>[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Avec l'aide de l'√©colier de 16 ans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vadim Gerasimov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de l'ing√©nieur informatique Dmitry Pavlovsky quelques jours apr√®s l'invention du jeu, le prototype a √©t√© port√© sur un PC IBM avec MS DOS et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turbo Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Au cours de deux ans, ils ont am√©lior√© le jeu ensemble, en ajoutant des fonctionnalit√©s telles que les couleurs tetrimino, des statistiques et, plus important encore, un code temporel et graphique qui a permis au jeu de fonctionner sur une vari√©t√© de mod√®les de PC et de clones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malheureusement, en raison des particularit√©s de l'Union sovi√©tique √† l'√©poque, leurs tentatives de mon√©tiser le jeu ont √©chou√© et, √† la fin, ils ont d√©cid√© de partager la version PC avec leurs amis gratuitement. √Ä partir de ce moment, ¬´Tetris¬ª a commenc√© √† se propager viralement dans tout le pays et au-del√†, copi√© d'un disque √† l'autre. Mais depuis que le jeu a √©t√© d√©velopp√© par des employ√©s d'une agence gouvernementale, l'√âtat en √©tait propri√©taire et, en 1987, l'organisation responsable du commerce international des technologies √©lectroniques a repris la licence du jeu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ELORG)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) L'abr√©viation V / O sur l'√©cran d'informations l√©gales peut √™tre abr√©g√©e pour Version Originale. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La soci√©t√© britannique de logiciels </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andromeda a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tent√© d'obtenir des droits sur Tetris et, avant la conclusion de la transaction, a sous-licenci√© le jeu √† d'autres fournisseurs, par exemple l'√©diteur britannique de jeux informatiques </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mirrorsoft</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mirrorsoft, √† son tour, l'a sous-licenci√© √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une filiale d'Atari Games. Tengen a accord√© √† Bullet-Proof Software les droits de d√©velopper un jeu pour ordinateurs et consoles au Japon, ce qui a donn√© Tetris pour Nintendo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Famicom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voici son √©cran d'informations l√©gales.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/750/b96/6c0/750b966c0d526110e504b409b3f1a1af.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fait int√©ressant, dans cette version, l'√©colier Vadim Gerasimov est appel√© le concepteur et programmeur d'origine. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En essayant de s√©curiser la version portable de la prochaine console Game Boy, Nintendo a utilis√© le logiciel Bullet-Proof pour conclure une affaire r√©ussie directement avec ELORG. Dans le processus de conclusion de l'accord, ELORG a r√©vis√© son contrat avec Andromeda, ajoutant qu'Andromeda n'avait obtenu que les droits sur les jeux pour ordinateurs et machines d'arcade. Pour cette raison, Bullet-Proof Software a d√ª payer des redevances √† ELORG pour toutes les cartouches vendues pour Famicom, car les droits re√ßus de Tengen se sont r√©v√©l√©s √™tre faux. Mais gr√¢ce √† la r√©conciliation avec ELORG, Bullet-Proof Software a finalement r√©ussi √† obtenir des droits de jeu de console mondiaux pour Nintendo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bullet-Proof Software a sous-licenci√© les droits des jeux portables de Nintendo et ensemble, ils ont d√©velopp√© Game Boy Tetris, qui se refl√®te dans l'√©cran d'informations l√©gales ci-dessous.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0dc/d28/e4c/0dcd28e4c4f7b3da1a0259fcdbcf9b70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec les droits mondiaux de jeu sur console, Nintendo a d√©velopp√© la version Tetris pour NES que nous explorons dans cet article. Ensuite, Bullet-Proof Software a sous-licenci√© les droits de Nintendo, ce qui lui a permis de continuer √† vendre des cartouches pour Famicom au Japon. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela a √©t√© suivi d'une bataille juridique complexe. Nintendo et Tengen ont tous deux exig√© que la partie adverse cesse de produire et de vendre leur version du jeu. En cons√©quence, Nintendo a gagn√© et des centaines de milliers de cartouches </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen Tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ont √©t√© d√©truites. Le verdict du tribunal a √©galement interdit √† plusieurs autres soci√©t√©s comme Mirrorsoft de cr√©er des versions de console. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pajitnov n'a jamais re√ßu de d√©ductions d'ELORG ou de l'√âtat sovi√©tique. Cependant, en 1991, il a d√©m√©nag√© aux √âtats-Unis et en 1996 avec le soutien du propri√©taire du logiciel Bullet-Proof</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Henka Rogers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a cofond√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Tetris Company</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ce qui lui a permis de profiter de versions pour appareils mobiles et consoles modernes.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est int√©ressant de regarder l'√©cran d'informations l√©gales comme une fen√™tre donnant une id√©e de l'origine modeste du jeu et des batailles qui s'ensuivent pour les droits de propri√©t√© intellectuelle, car pour la plupart des joueurs, cet √©cran n'est qu'un ennui ennuyeux, dont la disparition semble devoir attendre ind√©finiment. Le retard est d√©fini par deux compteurs, comptant s√©quentiellement de 255 √† 0. La premi√®re phase ne peut pas √™tre ignor√©e et la seconde est ignor√©e en appuyant sur le bouton D√©marrer. Par cons√©quent, l'√©cran d'informations l√©gales s'affiche au moins 4,25 secondes et pas plus de 8,5 secondes. Cependant, je pense que la plupart des joueurs abandonnent, arr√™tant d'appuyer sur Start pendant le premier intervalle, et √† cause de cela, ils attendent la fin compl√®te.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le timing des phases, ainsi que le reste du jeu, est r√©gi par un gestionnaire d'interruption non masqu√© appel√© au d√©but de chaque intervalle de suppression vertical (intervalle de suppression court) - une courte p√©riode de temps entre le rendu des images de t√©l√©vision. Autrement dit, toutes les 16,6393 millisecondes, l'ex√©cution normale du programme est interrompue par le code suivant. </font><font style="vertical-align: inherit;">Le gestionnaire commence par passer les valeurs des registres principaux √† la pile et les r√©cup√©rer apr√®s l'ach√®vement afin de ne pas interf√©rer avec la t√¢che interrompue. L'appel </font><font style="vertical-align: inherit;">met √† jour la VRAM, convertissant la description du mod√®le de m√©moire en ce qui est affich√© √† l'√©cran. En outre, le gestionnaire r√©duit la valeur du compteur de l'√©cran d'informations l√©gales s'il est sup√©rieur √† z√©ro. D√©fi</font></font><br><br> <code>8005: PHA <br> 8006: TXA <br> 8007: PHA <br> 8008: TYA <br> 8009: PHA ; save A, X, Y <br> <br> 800A: LDA #$00 <br> 800C: STA $00B3 <br> 800E: JSR $804B ; render(); <br> <br> 8011: DEC $00C3 ; legalScreenCounter1--; <br> <br> 8013: LDA $00C3 <br> 8015: CMP #$FF ; if (legalScreenCounter1 &lt; 0) { <br> 8017: BNE $801B ; legalScreenCounter1 = 0; <br> 8019: INC $00C3 ; } <br> <br> 801B: JSR $AB5E ; initializeOAM(); <br> <br> 801E: LDA $00B1 <br> 8020: CLC <br> 8021: ADC #$01 <br> 8023: STA $00B1 <br> 8025: LDA #$00 <br> 8027: ADC $00B2 <br> 8029: STA $00B2 ; frameCounter++; <br> <br> 802B: LDX #$17 <br> 802D: LDY #$02 <br> 802F: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 8032: LDA #$00 <br> 8034: STA $00FD <br> 8036: STA $2005 ; scrollX = 0; <br> 8039: STA $00FC <br> 803B: STA $2005 ; scrollY = 0; <br> <br> 803E: LDA #$01 <br> 8040: STA $0033 ; verticalBlankingInterval = true; <br> <br> 8042: JSR $9D51 ; pollControllerButtons(); <br> <br> 8045: PLA <br> 8046: TAY <br> 8047: PLA <br> 8048: TAX <br> 8049: PLA ; restore A, X, Y <br> <br> 804A: RTI ; resume interrupted task</code> <br> <br><font style="vertical-align: inherit;"></font><code>render()</code><font style="vertical-align: inherit;"></font><code>initializeOAM()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effectue l'√©tape requise par l'√©quipement de g√©n√©ration de trame. Le gestionnaire continue de travailler en incr√©mentant le compteur de trames - la petite valeur endian 16 bits stock√©e √† l'adresse </font></font><code>$00B1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'il utilise √† diff√©rents endroits pour un timing contr√¥l√©. Apr√®s cela, le nombre pseudo-al√©atoire suivant est g√©n√©r√©; comme mentionn√© ci-dessus, cela se produit quel que soit le mode au moins une fois par image. L' </font></font><code>$8040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur d'intervalle de suppression verticale est d√©fini </font><font style="vertical-align: inherit;">√† l'adresse </font><font style="vertical-align: inherit;">, ce qui signifie que le gestionnaire vient d'√™tre ex√©cut√©. Enfin, les boutons du contr√¥leur sont interrog√©s; le comportement de cette routine est d√©crit ci-dessous dans la section D√©mo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le drapeau est </font></font><code>verticalBlankingInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilis√© par la routine d√©crite ci-dessus. Il continue jusqu'√† ce que l'ex√©cution du gestionnaire d'interruption commence.</font></font><br><br> <code>AA2F: JSR $E000 ; updateAudio(); <br> <br> AA32: LDA #$00 <br> AA34: STA $0033 ; verticalBlankingInterval = false; <br> <br> AA36: NOP <br> <br> AA37: LDA $0033 <br> AA39: BEQ $AA37 ; while(!verticalBlankingInterval) { } <br> <br> AA3B: LDA #$FF <br> AA3D: LDX #$02 <br> AA3F: LDY #$02 <br> AA41: JSR $AC6A ; fill memory page 2 with all $FF's <br> <br> AA44: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette routine de blocage est utilis√©e par deux √©tapes de synchronisation de l'√©cran d'informations l√©gales, qui sont ex√©cut√©es l'une apr√®s l'autre. </font><font style="vertical-align: inherit;">Le script Lua AI contourne ce d√©lai en mettant les deux compteurs √† 0.</font></font><br><br> <code>8236: LDA #$FF <br> 8238: JSR $A459 <br> <br> ... <br> <br> A459: STA $00C3 ; legalScreenCounter1 = 255; <br> <br> A45B: JSR $AA2F ; do { <br> A45E: LDA $00C3 ; waitForVerticalBlankingInterval(); <br> A460: BNE $A45B ; } while(legalScreenCounter1 &gt; 0); <br> <br> A462: RTS ; return;</code> <br> <br> <code>823B: LDA #$FF <br> 823D: STA $00A8 ; legalScreenCounter2 = 255; <br> <br> ; do { <br> <br> 823F: LDA $00F5 ; if (just pressed Start) { <br> 8241: CMP #$10 ; break; <br> 8243: BEQ $824C ; } <br> <br> 8245: JSR $AA2F ; waitForVerticalBlankingInterval(); <br> <br> 8248: DEC $00A8 ; legalScreenCounter2--; <br> 824A: BNE $823F ; } while(legalScreenCounter2 &gt; 0); <br> <br> 824C: INC $00C0 ; gameMode = TITLE_SCREEN;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><h3>  D√©mo </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La d√©mo montre environ 80 secondes de gameplay pr√©enregistr√©. Il n'affiche pas seulement le fichier vid√©o, mais utilise le m√™me moteur que dans le jeu. Pendant la lecture, deux tables sont utilis√©es. Le premier, situ√© √† l'adresse </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contient la s√©quence suivante de cr√©ation de tetrimino: </font></font><br><br> <code>TJTSZJTSZJSZLZJTTSITO JSZLZLIOLZLIOJTSITOJ</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de la cr√©ation d'une figure, elle est soit s√©lectionn√©e au hasard, soit lue dans le tableau, selon le mode. La commutation a lieu √† l'adresse </font></font><code>$98EB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le type tetrimino est extrait des bits 6, 5 et 4 de chaque octet. De temps en temps, cette op√©ration nous donne une valeur </font><font style="vertical-align: inherit;">- le mauvais type. Cependant, la table en </font><font style="vertical-align: inherit;">cr√©ant des </font><font style="vertical-align: inherit;">formes ( </font><font style="vertical-align: inherit;">) utilis√©e pour une conversion de type en Tetrimino orientation ID est en </font><font style="vertical-align: inherit;">fait situ√© entre les deux tables li√©es: </font><font style="vertical-align: inherit;">Signification</font></font><br><br> <code>98EB: LDA $00C0 <br> 98ED: CMP #$05 <br> 98EF: BNE $9903 ; if (gameMode == DEMO) { <br> <br> 98F1: LDX $00D3 <br> 98F3: INC $00D3 <br> 98F5: LDA $DF00,X ; value = demoTetriminoTypeTable[++demoIndex]; <br> <br> 98F8: LSR <br> 98F9: LSR <br> 98FA: LSR <br> 98FB: LSR <br> 98FC: AND #$07 <br> 98FE: TAX ; tetriminoType = bits 6,5,4 of value; <br> <br> 98FF: LDA $994E,X <br> 9902: RTS ; return spawnTable[tetriminoType]; <br> ; } else { <br> ; pickRandomTetrimino(); <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"></font><code>$994E</code><font style="vertical-align: inherit;"></font><br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'oblige √† lire au-del√† de la fin du tableau, dans le suivant, ce qui donne </font></font><code>Td</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En raison de cet effet, ce sch√©ma peut nous donner une s√©quence illimit√©e mais reproductible d'ID pseudo-al√©atoires de l'orientation des figures cr√©√©es. Le code fonctionnera car toute adresse arbitraire dans une s√©quence d'octets changeante ne nous permet pas de d√©terminer o√π se termine la table. En fait, la s√©quence √† l'adresse </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut faire partie de quelque chose de compl√®tement √©tranger √† cela, surtout si l'on consid√®re que le but des 5 bits non nuls restants n'est pas clair et que la s√©quence g√©n√©r√©e d√©montre une r√©p√©tabilit√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'initialisation du mode d√©mo, l'index de table ( </font></font><code>$00D3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) est r√©initialis√© √† l'adresse </font></font><code>$872B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le deuxi√®me tableau de la d√©mo contient un enregistrement des boutons de la manette de jeu encod√©s en paires d'octets. </font><font style="vertical-align: inherit;">Les bits du premier octet correspondent aux boutons.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  Un </td><td>  B </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S√©lectionnez </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Commencer </font></font></td><td>  En haut </td><td>  Vers le bas </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vers la gauche </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √Ä droite </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le deuxi√®me octet stocke le nombre de trames pendant lesquelles une combinaison de boutons est enfonc√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le tableau prend des adresses </font></font><code>$DD00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$DEFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et se compose de 256 paires. L'acc√®s est effectu√© par le sous-programme √† l'adresse </font></font><code>$9D5B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">√âtant donn√© que la table des boutons de d√©monstration fait 512 octets, un index de deux octets est n√©cessaire pour y acc√©der. L'index est stock√© sous forme de petit endian √† </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Il est initialis√© avec la valeur de l'adresse de la table </font><font style="vertical-align: inherit;">, et son incr√©mentation est effectu√©e par le code suivant. </font><font style="vertical-align: inherit;">Les programmeurs ont laiss√© le traitement d'entr√©e du lecteur dans le code, ce qui nous permet de regarder le processus de d√©veloppement et de remplacer la d√©mo par un autre enregistrement. Le mode d'enregistrement de d√©monstration est activ√© lorsqu'une </font><font style="vertical-align: inherit;">valeur est attribu√©e.</font></font><br><br> <code>9D5B: LDA $00D0 ; if (recording mode) { <br> 9D5D: CMP #$FF ; goto recording; <br> 9D5F: BEQ $9DB0 ; } <br> <br> 9D61: JSR $AB9D ; pollController(); <br> 9D64: LDA $00F5 ; if (start button pressed) { <br> 9D66: CMP #$10 ; goto startButtonPressed; <br> 9D68: BEQ $9DA3 ; } <br> <br> 9D6A: LDA $00CF ; if (repeats == 0) { <br> 9D6C: BEQ $9D73 ; goto finishedMove; <br> ; } else { <br> 9D6E: DEC $00CF ; repeats--; <br> 9D70: JMP $9D9A ; goto moveInProgress; <br> ; } <br> <br> finishedMove: <br> <br> 9D73: LDX #$00 <br> 9D75: LDA ($D1,X) <br> 9D77: STA $00A8 ; buttons = demoButtonsTable[index]; <br> <br> 9D79: JSR $9DE8 ; index++; <br> <br> 9D7C: LDA $00CE <br> 9D7E: EOR $00A8 <br> 9D80: AND $00A8 <br> 9D82: STA $00F5 ; setNewlyPressedButtons(difference between heldButtons and buttons); <br> <br> 9D84: LDA $00A8 <br> 9D86: STA $00CE ; heldButtons = buttons; <br> <br> 9D88: LDX #$00 <br> 9D8A: LDA ($D1,X) <br> 9D8C: STA $00CF ; repeats = demoButtonsTable[index]; <br> <br> 9D8E: JSR $9DE8 ; index++; <br> <br> 9D91: LDA $00D2 ; if (reached end of demo table) { <br> 9D93: CMP #$DF ; return; <br> 9D95: BEQ $9DA2 ; } <br> <br> 9D97: JMP $9D9E ; goto holdButtons; <br> <br> moveInProgress: <br> <br> 9D9A: LDA #$00 <br> 9D9C: STA $00F5 ; clearNewlyPressedButtons(); <br> <br> holdButtons: <br> <br> 9D9E: LDA $00CE <br> 9DA0: STA $00F7 ; setHeldButtons(heldButtons); <br> <br> 9DA2: RTS ; return; <br> <br> startButtonPressed: <br> <br> 9DA3: LDA #$DD <br> 9DA5: STA $00D2 ; reset index; <br> <br> 9DA7: LDA #$00 <br> 9DA9: STA $00B2 ; counter = 0; <br> <br> 9DAB: LDA #$01 <br> 9DAD: STA $00C0 ; gameMode = TITLE_SCREEN; <br> <br> 9DAF: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D1</code><font style="vertical-align: inherit;"></font><code>$00D2</code><font style="vertical-align: inherit;"></font><code>$872D</code><font style="vertical-align: inherit;"></font><br><br> <code>9DE8: LDA $00D1 <br> 9DEA: CLC ; increment [$00D1] <br> 9DEB: ADC #$01 ; possibly causing wrap around to 0 <br> 9DED: STA $00D1 ; which produces a carry <br> <br> 9DEF: LDA #$00 <br> 9DF1: ADC $00D2 <br> 9DF3: STA $00D2 ; add carry to [$00D2] <br> <br> 9DF5: RTS ; return</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D0</code><font style="vertical-align: inherit;"></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans ce cas, le code suivant est lanc√©, destin√© √† l'√©criture dans le tableau des boutons de la d√©mo. </font><font style="vertical-align: inherit;">Cependant, la table est stock√©e dans le PRG-ROM. </font><font style="vertical-align: inherit;">Tenter d'y √©crire n'affectera pas les donn√©es enregistr√©es. </font><font style="vertical-align: inherit;">Au lieu de cela, chaque op√©ration d'√©criture d√©clenche un changement de banque, ce qui entra√Æne l'effet glitch illustr√© ci-dessous.</font></font><br><br> <code>recording: <br> <br> 9DB0: JSR $AB9D ; pollController(); <br> <br> 9DB3: LDA $00C0 ; if (gameMode != DEMO) { <br> 9DB5: CMP #$05 ; return; <br> 9DB7: BNE $9DE7 ; } <br> <br> 9DB9: LDA $00D0 ; if (not recording mode) { <br> 9DBB: CMP #$FF ; return; <br> 9DBD: BNE $9DE7 ; } <br> <br> 9DBF: LDA $00F7 ; if (getHeldButtons() == heldButtons) { <br> 9DC1: CMP $00CE ; goto buttonsNotChanged; <br> 9DC3: BEQ $9DE4 ; } <br> <br> 9DC5: LDX #$00 <br> 9DC7: LDA $00CE <br> 9DC9: STA ($D1,X) ; demoButtonsTable[index] = heldButtons; <br> <br> 9DCB: JSR $9DE8 ; index++; <br> <br> 9DCE: LDA $00CF <br> 9DD0: STA ($D1,X) ; demoButtonsTable[index] = repeats; <br> <br> 9DD2: JSR $9DE8 ; index++; <br> <br> 9DD5: LDA $00D2 ; if (reached end of demo table) { <br> 9DD7: CMP #$DF ; return; <br> 9DD9: BEQ $9DE7 ; } <br> <br> 9DDB: LDA $00F7 <br> 9DDD: STA $00CE ; heldButtons = getHeldButtons(); <br> <br> 9DDF: LDA #$00 <br> 9DE1: STA $00CF ; repeats = 0; <br> <br> 9DE3: RTS ; return; <br> <br> buttonsNotChanged: <br> <br> 9DE4: INC $00CF ; repeats++; <br> <br> 9DE6: RTS <br> 9DE7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a07/66a/261/a0766a261967e1ee2e7d4a61d3367ee6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela sugg√®re que les d√©veloppeurs pourraient ex√©cuter le programme partiellement ou enti√®rement en RAM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour contourner cet obstacle, j'en ai cr√©√© </font></font><code>lua/RecordDemo.lua</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un situ√© dans un </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip avec le code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Apr√®s √™tre pass√© en mode d'enregistrement de d√©monstration, il redirige les op√©rations d'√©criture vers la table dans la console Lua. </font><font style="vertical-align: inherit;">De l√†, les octets peuvent √™tre copi√©s et coll√©s dans la ROM.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour enregistrer votre propre d√©mo, lancez FCEUX et t√©l√©chargez le fichier ROM Nintendo Tetris (Fichier | Ouvrir ROM ...). Ouvrez ensuite la fen√™tre Lua Script (Fichier | Lua | Nouvelle fen√™tre Lua Script ...), recherchez le fichier ou entrez le chemin. Appuyez sur le bouton Ex√©cuter pour d√©marrer le mode d'enregistrement de d√©monstration, puis cliquez sur la fen√™tre FCEUX pour y basculer le focus. Vous pouvez contr√¥ler les formes jusqu'√† ce que la table des boutons soit pleine. Apr√®s cela, le jeu reviendra automatiquement √† l'√©conomiseur d'√©cran. Cliquez sur Arr√™ter dans la fen√™tre Lua Script pour arr√™ter le script. Les donn√©es enregistr√©es appara√Ætront dans la console de sortie, comme illustr√© dans la figure ci-dessous.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f2e/3cd/f61/f2e3cdf61589005f2e1cae0659f66467.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lectionnez tout le contenu et copiez-le dans le presse-papiers (Ctrl + C). </font><font style="vertical-align: inherit;">Ex√©cutez ensuite l'√©diteur Hex (Debug | Hex Editor ...). </font><font style="vertical-align: inherit;">Dans le menu Hex Editor, s√©lectionnez Afficher | </font><font style="vertical-align: inherit;">Fichier ROM puis Fichier | </font><font style="vertical-align: inherit;">Aller √† l'adresse. </font><font style="vertical-align: inherit;">Dans la bo√Æte de dialogue Goto, entrez 5D10 (adresse du tableau des boutons de d√©monstration dans le fichier ROM) et cliquez sur OK. </font><font style="vertical-align: inherit;">Collez ensuite le contenu du presse-papiers (Ctrl + V).</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bef/599/392/bef599392455c773652e850de13f6413.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, dans le menu FCEUX, s√©lectionnez NES | </font><font style="vertical-align: inherit;">R√©initialiser </font><font style="vertical-align: inherit;">Si vous avez r√©ussi √† r√©p√©ter toutes ces √©tapes, la d√©mo devrait √™tre remplac√©e par votre propre version. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous souhaitez enregistrer les modifications, s√©lectionnez Fichier | </font><font style="vertical-align: inherit;">Enregistrez Rom sous ... et entrez le nom du fichier ROM modifi√©, puis cliquez sur Enregistrer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la m√™me mani√®re, vous pouvez ajuster la s√©quence des tetriminos cr√©√©s.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran de d√©c√®s </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme mentionn√© ci-dessus, la plupart des joueurs ne peuvent pas faire face √† la vitesse de descente des chiffres au niveau 29, ce qui conduit rapidement √† la fin du jeu. Par cons√©quent, les joueurs auxquels il est devenu associ√© avec le nom ¬´√©cran de la mort¬ª. Mais d'un point de vue technique, l'√©cran de mort ne permet pas au joueur d'aller plus loin en raison d'un bug dans lequel une descente rapide n'est en fait pas un bug, mais une fonctionnalit√©. Les concepteurs √©taient si gentils qu'ils ont permis au jeu de continuer tandis que le joueur √©tait capable de r√©sister √† une vitesse surhumaine. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un v√©ritable √©cran de mort appara√Æt sur environ 1550 rang√©es r√©tract√©es. Il se manifeste de diff√©rentes mani√®res. Parfois, le jeu red√©marre. Dans d'autres cas, l'√©cran devient noir. G√©n√©ralement, un jeu se bloque (¬´se bloque¬ª) imm√©diatement apr√®s la suppression d'une ligne, comme illustr√© ci-dessous. Ces effets sont souvent pr√©c√©d√©s d'artefacts graphiques al√©atoires.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09d/7fe/4f3/09d7fe4f3ec1e77057c7ee5e252d8d75.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©cran de mort est le r√©sultat d'un bogue dans le code qui ajoute des points lors de la suppression de lignes. Le compte √† six caract√®res est stock√© sous la forme d'un petit BCD endian compress√© de 24 bits et se trouve √† </font></font><code>$0053</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0055</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pour effectuer des conversions entre le nombre de lignes effac√©es et les points obtenus, un tableau est utilis√©; chaque entr√©e est une petite valeur endian BCD compact√©e de 16 bits. </font><font style="vertical-align: inherit;">Apr√®s avoir incr√©ment√© le nombre total de lignes et √©ventuellement le niveau, la valeur de cette liste est multipli√©e par le num√©ro de niveau plus un et le r√©sultat est ajout√© aux points. Cela est clairement d√©montr√© dans le tableau du livret du manuel Nintendo Tetris:</font></font><br><br> <code>9CA5: 00 00 ; 0: 0 <br> 9CA7: 40 00 ; 1: 40 <br> 9CA9: 00 01 ; 2: 100 <br> 9CAB: 00 03 ; 3: 300 <br> 9CAD: 00 12 ; 4: 1200</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34b/a36/7cf/34ba367cfefad47e493306fa6ef8fe3e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme illustr√© ci-dessous, la multiplication est simul√©e par un cycle qui ajoute des points au score. Il est ex√©cut√© apr√®s le verrouillage de la forme, m√™me si aucune ligne n'est effac√©e. </font><font style="vertical-align: inherit;">Malheureusement, le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Ricoh 2A03 n'a</font></a><font style="vertical-align: inherit;"> pas de mode d√©cimal binaire 6502; il pourrait grandement simplifier le corps du cycle. Au lieu de cela, l'addition est effectu√©e par √©tapes en utilisant le mode binaire. Tout chiffre d√©passant 9 apr√®s addition est essentiellement obtenu en soustrayant 10 et en incr√©mentant les chiffres √† gauche. Par exemple, </font><font style="vertical-align: inherit;">cela est converti en </font><font style="vertical-align: inherit;">. Mais un tel sch√©ma n'est pas enti√®rement prot√©g√©. Prendre </font><font style="vertical-align: inherit;">: un ch√®que ne peut pas convertir le r√©sultat en</font></font><br><br> <code>9C31: LDA $0044 <br> 9C33: STA $00A8 <br> 9C35: INC $00A8 ; for(i = 0; i &lt;= level; i++) { <br> <br> 9C37: LDA $0056 <br> 9C39: ASL <br> 9C3A: TAX <br> 9C3B: LDA $9CA5,X ; points[0] = pointsTable[2 * completedLines]; <br> <br> 9C3E: CLC <br> 9C3F: ADC $0053 <br> 9C41: STA $0053 ; score[0] += points[0]; <br> <br> 9C43: CMP #$A0 <br> 9C45: BCC $9C4E ; if (upper digit of score[0] &gt; 9) { <br> <br> 9C47: CLC <br> 9C48: ADC #$60 <br> 9C4A: STA $0053 ; upper digit of score[0] -= 10; <br> 9C4C: INC $0054 ; score[1]++; <br> ; } <br> <br> 9C4E: INX <br> 9C4F: LDA $9CA5,X ; points[1] = pointsTable[2 * completedLines + 1]; <br> <br> 9C52: CLC <br> 9C53: ADC $0054 <br> 9C55: STA $0054 ; score[1] += points[1]; <br> <br> 9C57: AND #$0F <br> 9C59: CMP #$0A <br> 9C5B: BCC $9C64 ; if (lower digit of score[1] &gt; 9) { <br> <br> 9C5D: LDA $0054 <br> 9C5F: CLC ; lower digit of score[1] -= 10; <br> 9C60: ADC #$06 ; increment upper digit of score[1]; <br> 9C62: STA $0054 ; } <br> <br> 9C64: LDA $0054 <br> 9C66: AND #$F0 <br> 9C68: CMP #$A0 <br> 9C6A: BCC $9C75 ; if (upper digit of score[1] &gt; 9) { <br> <br> 9C6C: LDA $0054 <br> 9C6E: CLC <br> 9C6F: ADC #$60 <br> 9C71: STA $0054 ; upper digit of score[1] -= 10; <br> 9C73: INC $0055 ; score[2]++; <br> ; } <br> <br> 9C75: LDA $0055 <br> 9C77: AND #$0F <br> 9C79: CMP #$0A <br> 9C7B: BCC $9C84 ; if (lower digit of score[2] &gt; 9) { <br> <br> 9C7D: LDA $0055 <br> 9C7F: CLC ; lower digit of score[2] -= 10; <br> 9C80: ADC #$06 ; increment upper digit of score[2]; <br> 9C82: STA $0055 ; } <br> <br> 9C84: LDA $0055 <br> 9C86: AND #$F0 <br> 9C88: CMP #$A0 <br> 9C8A: BCC $9C94 ; if (upper digit of score[2] &gt; 9) { <br> <br> 9C8C: LDA #$99 <br> 9C8E: STA $0053 <br> 9C90: STA $0054 <br> 9C92: STA $0055 ; max out score to 999999; <br> ; } <br> <br> 9C94: DEC $00A8 <br> 9C96: BNE $9C37 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>$07 + $07 = $0E</code><font style="vertical-align: inherit;"></font><code>$14</code><font style="vertical-align: inherit;"></font><code>$09 + $09 = $12</code><font style="vertical-align: inherit;"></font><code>$18</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour compenser cela, aucun des chiffres d√©cimaux dans les entr√©es du tableau de bord ne d√©passe 6. De plus, pour pouvoir l'utiliser, le dernier chiffre de tous les enregistrements est toujours 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il faut du temps pour terminer ce cycle long et compliqu√©. </font><font style="vertical-align: inherit;">√Ä des niveaux √©lev√©s, un grand nombre d'it√©rations affecte le timing du jeu, car il faut plus de 1/60 seconde pour g√©n√©rer chaque image. </font><font style="vertical-align: inherit;">Tout cela conduit √† diverses manifestations de ¬´l'√©cran de la mort¬ª. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le script Lua AI limite le nombre d'it√©rations dans une boucle √† 30 - la valeur maximale que les concepteurs pourraient atteindre telle que con√ßue par les concepteurs, ce qui √©limine l'√©cran de mort.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fin </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dans le livret Nintendo Tetris, le jeu A-Type est d√©crit comme suit: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/f16/5ea/c53f165ea675badb06f75f6409f6c836.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le jeu r√©compense les joueurs qui ont marqu√© un nombre suffisamment important de points dans l'une des cinq animations des fins. Le choix de la fin est enti√®rement bas√© sur les deux chiffres les plus √† gauche du score √† six chiffres. Comme indiqu√© ci-dessous, pour obtenir l'une des fins, le joueur doit marquer au moins 30 000 points. </font><font style="vertical-align: inherit;">Il convient de noter que </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">est un miroir des adresses </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Le compte est dupliqu√© aux adresses </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Apr√®s avoir r√©ussi le premier test, l'animation de fin est s√©lectionn√©e par l'instruction switch suivante.</font></font><br><br> <code>9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0060</code><font style="vertical-align: inherit;"></font><code>$007F</code><font style="vertical-align: inherit;"></font><code>$0040</code><font style="vertical-align: inherit;"></font><code>$005F</code><font style="vertical-align: inherit;"></font><code>$0073</code><font style="vertical-align: inherit;"></font><code>$0075</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>A96E: LDA #$00 <br> A970: STA $00C4 <br> A972: LDA $0075 ; if (score[2] &lt; $05) { <br> A974: CMP #$05 ; ending = 0; <br> A976: BCC $A9A5 ; } <br> <br> A978: LDA #$01 <br> A97A: STA $00C4 <br> A97C: LDA $0075 ; else if (score[2] &lt; $07) { <br> A97E: CMP #$07 ; ending = 1; <br> A980: BCC $A9A5 ; } <br> <br> A982: LDA #$02 <br> A984: STA $00C4 <br> A986: LDA $0075 ; else if (score[2] &lt; $10) { <br> A988: CMP #$10 ; ending = 2; <br> A98A: BCC $A9A5 ; } <br> <br> A98C: LDA #$03 <br> A98E: STA $00C4 <br> A990: LDA $0075 ; else if (score[2] &lt; $12) { <br> A992: CMP #$12 ; ending = 3; <br> A994: BCC $A9A5 ; } <br> <br> A996: LDA #$04 ; else { <br> A998: STA $00C4 ; ending = 4; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au final, des fus√©es de taille croissante sont lanc√©es depuis la rampe de lancement √† c√¥t√© de la cath√©drale Saint-Basile. </font><font style="vertical-align: inherit;">Dans la quatri√®me fin, le vaisseau spatial Bourane est montr√© - la version sovi√©tique de la navette spatiale am√©ricaine. </font><font style="vertical-align: inherit;">Dans la meilleure fin, la cath√©drale elle-m√™me s'√©l√®ve dans les airs et un OVNI est suspendu au-dessus de la rampe de lancement. </font><font style="vertical-align: inherit;">Ci-dessous, une image de chaque fin et le score qui lui est associ√©.</font></font><br><div class="scrollable-table"><table><tbody><tr><td> <code>30000‚Äì49999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/0b9/b73/4b4/0b9b734b43dae52eccafaa71e3c1441d.png"></div></td><td> <code>50000‚Äì69999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/ade/f93/f39/adef93f395eb2bef2c1fd71562857c39.png"></div></td><td> <code>70000‚Äì99999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/df3/480/b63/df3480b63de128a70b7c9e4dd7cec81f.png"></div></td></tr><tr><td> <code>100000‚Äì119999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/8e3/91a/658/8e391a6581df6e7ec0c08134b6a6d5bf.png"></div></td><td> <code>120000+</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/3e1/2bd/42f/3e12bd42ffc331742d809325db418f78.png"></div></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En mode de jeu de type B, un autre test est impl√©ment√©, d√©crit dans le livret Nintendo Tetris comme suit: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/929/624/0aa929624f41a68ea1388b6ba9013dd3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le joueur r√©ussit √† effacer 25 lignes, le jeu montre la fin, selon le niveau initial. Les terminaisons des niveaux 0 √† 8 se composent d'animaux et d'objets volant ou courant dans le cadre, passant myst√©rieusement derri√®re la cath√©drale Saint-Basile. L'ovni de la meilleure fin du mode A-Type appara√Æt √† la fin 3. √Ä la fin 4, des pt√©rosaures volants disparus apparaissent, et √† la fin 7 les dragons volants mythiques sont montr√©s. Dans les terminaisons 2 et 6, des oiseaux sans ailes sont repr√©sent√©s: pingouins en cours d'ex√©cution et autruches. √Ä la fin de 5, le ciel est rempli de BONS dirigeables (√† ne pas confondre avec les dirigeables Goodyear). Et √† la fin du 8, beaucoup de ¬´Buranas¬ª balayent l'√©cran, bien qu'en r√©alit√© il n'y en ait qu'un. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La hauteur de d√©part (plus 1) est utilis√©e comme multiplicateur, r√©compensant le joueur avec un grand nombre d'animaux / objets pour une complexit√© accrue.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la meilleure fin du B-Type, un ch√¢teau rempli de personnages de l'univers Nintendo est montr√©: la princesse Peach frappe des mains, Kid Icarus joue du violon, Donkey Kong frappe au gros tambour, Mario et Luigi dansent, Bowser joue de l'accord√©on, Samus joue du violoncelle, Link - sur une fl√ªte, tandis que les coupoles de la cath√©drale Saint-Basile s'√©lancent dans les airs. La quantit√© de ces √©l√©ments indiqu√©e √† la fin d√©pend de la hauteur initiale. Vous trouverez ci-dessous des images des 10 fins.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/c8e/525/5d9c8e525177613cb3fcd59c7c6aa53a.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ade/2fc/f3d/ade2fcf3d389b67e5d4b3d7e8c5c1ea0.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec9/bd3/9dd/ec9bd39dd26529013d7d408f6a4e855b.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fdb/125/132/fdb125132ecaed550966562b5e08f169.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22b/758/028/22b75802841a3b558f8fae476f2d2598.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43e/710/858/43e710858220b08e1860da00a309c665.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dda/332/1d5/dda3321d5e5246d2aa92eafb69f3cf5d.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6f/2d0/843/c6f2d0843995d294393bbbf277b83bdf.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/572/3b8/f29/5723b8f2919ac35746b52923d59dbf41.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/639/938/9df/6399389dfff187a8db7ac92f1dc815e3.png"></div></td><td></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'IA peut rapidement effacer les 25 lignes requises en mode de type B √† n'importe quel niveau et hauteur initiaux, ce qui vous permet de voir n'importe quelle fin. Il vaut √©galement la peine d'√©valuer √† quel point il g√®re de grands tas de blocs al√©atoires. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aux extr√©mit√©s 0 √† 8, jusqu'√† 6 objets peuvent se d√©placer dans le cadre. Les coordonn√©es y des objets sont stock√©es dans une table situ√©e √† en </font></font><code>$A7B7</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Les distances horizontales entre les objets sont stock√©es dans un tableau √† l'adresse </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Une s√©quence de valeurs avec un signe √† l'adresse </font><font style="vertical-align: inherit;">d√©termine la vitesse et la direction des objets. </font><font style="vertical-align: inherit;">Les indices de sprite sont stock√©s √† </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En fait, chaque objet se compose de deux sprites avec des indices adjacents. Pour obtenir le deuxi√®me index, vous devez ajouter 1. Par exemple, un dragon se compose de</font></font><br><br> <code>A7B7: 98 A8 C0 A8 90 B0 ; 0 <br> A7BD: B0 B8 A0 B8 A8 A0 ; 1 <br> A7C3: C8 C8 C8 C8 C8 C8 ; 2 <br> A7C9: 30 20 40 28 A0 80 ; 3 <br> A7CF: A8 88 68 A8 48 78 ; 4 <br> A7D5: 58 68 18 48 78 38 ; 5 <br> A7DB: C8 C8 C8 C8 C8 C8 ; 6 <br> A7E1: 90 58 70 A8 40 38 ; 7 <br> A7E7: 68 88 78 18 48 A8 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A77B</code><font style="vertical-align: inherit;"></font><br><br> <code>A77B: 3A 24 0A 4A 3A FF ; 0 <br> A781: 22 44 12 32 4A FF ; 1 <br> A787: AE 6E 8E 6E 1E 02 ; 2 <br> A78D: 42 42 42 42 42 02 ; 3 <br> A793: 22 0A 1A 04 0A FF ; 4 <br> A799: EE DE FC FC F6 02 ; 5 <br> A79F: 80 80 80 80 80 FF ; 6 <br> A7A5: E8 E8 E8 E8 48 FF ; 7 <br> A7AB: 80 AE 9E 90 80 02 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A771</code><font style="vertical-align: inherit;"></font><br><br> <code>A771: 01 ; 0: 1 <br> A772: 01 ; 1: 1 <br> A773: FF ; 2: -1 <br> A774: FC ; 3: -4 <br> A775: 01 ; 4: 1 <br> A776: FF ; 5: -1 <br> A777: 02 ; 6: 2 <br> A778: 02 ; 7: 2 <br> A779: FE ; 8: -1</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A7F3</code><font style="vertical-align: inherit;"></font><br><br> <code>A7F3: 2C ; 0: dragonfly <br> A7F4: 2E ; 1: dove <br> A7F5: 54 ; 2: penguin <br> A7F6: 32 ; 3: UFO <br> A7F7: 34 ; 4: pterosaur <br> A7F8: 36 ; 5: blimp <br> A7F9: 4B ; 6: ostrich <br> A7FA: 38 ; 7: dragon <br> A7FB: 3A ; 8: Buran</code> <br> <br><font style="vertical-align: inherit;"></font><code>$38</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>$39</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Les tuiles de ces sprites sont contenues dans les tableaux de mod√®les ci-dessous.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/524/373/86d5243738d9c3e34db5318889c4f894.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d82/2d1/229/d822d122984b77a0973f08feac962647.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8a/3c1/9b5/d8a3c19b513fb9f7338e250b97fdeac1.png"></div></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons examin√© le tableau central du motif ci-dessus, il est utilis√© pour afficher le tetrimino et le terrain de jeu. </font><font style="vertical-align: inherit;">Fait int√©ressant, il contient tout l'alphabet, tandis que d'autres n'en contiennent qu'une partie pour √©conomiser de l'espace. </font><font style="vertical-align: inherit;">Mais encore plus int√©ressants sont les sprites d'avion et d'h√©licopt√®re dans le tableau des motifs √† gauche; </font><font style="vertical-align: inherit;">ils n'apparaissent pas dans les fins ou dans d'autres parties du jeu. </font><font style="vertical-align: inherit;">Il est </font><font style="vertical-align: inherit;">av√©r√© que l'avion et l'h√©licopt√®re ont des </font><font style="vertical-align: inherit;">indices sprites </font></font><code>$30</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>$16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez modifier le tableau ci - </font><font style="vertical-align: inherit;">dessus, pour les voir en action.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/04e/2e2/203/04e2e2203b1581876d99736ad9b56fd6.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/153/3b4/4451533b43874485cb5a0cdfd9df0c58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Malheureusement, les supports d'h√©licopt√®re ne sont pas affich√©s, mais les rotors principal et arri√®re sont magnifiquement anim√©s. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2 joueurs contre </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris contient un mode √† deux joueurs incomplet, qui peut √™tre activ√© en changeant le nombre de joueurs ( </font></font><code>$00BE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √† 2. Comme indiqu√© ci-dessous, deux champs de jeu apparaissent √† l'arri√®re-plan du mode solo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/418/6e7/2af/4186e72af40c6c617996ca2f8d39a72c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'y a pas de fronti√®re entre les champs car la r√©gion centrale de l'arri√®re-plan est d'un noir uni. Les valeurs </font></font><code>003</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affich√©es au-dessus des terrains de jeu indiquent le nombre de lignes effac√©es par chaque joueur. La seule figure commune pour deux joueurs appara√Æt au m√™me endroit qu'en mode solo. Malheureusement, il est situ√© sur le bon terrain de jeu. Les carr√©s et autres tuiles sont mal color√©s. Et lorsque le joueur perd, le jeu red√©marre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais si vous ignorez ces probl√®mes, le mode est tout √† fait jouable. Chaque joueur peut contr√¥ler ind√©pendamment les pi√®ces dans le terrain de jeu correspondant. Et lorsqu'un joueur tape Double, Triple ou Tetris (c'est-√†-dire qu'il efface deux, trois ou quatre rang√©es), des rang√©es d'ordures avec un carr√© manquant apparaissent dans la partie inf√©rieure du terrain de jeu de l'adversaire.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un champ suppl√©mentaire est situ√© √† </font></font><code>$0500</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A </font></font><code>$0060</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$007F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √©tant g√©n√©ralement un miroir </font></font><code>$0040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$005F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sont utilis√©s pour le deuxi√®me joueur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablement, ce mode int√©ressant a √©t√© abandonn√© en raison d'un calendrier de d√©veloppement charg√©. Ou peut-√™tre qu'il a √©t√© intentionnellement laiss√© inachev√©. L'une des raisons pour lesquelles Tetris a √©t√© choisi comme jeu fourni avec le Nintendo Game Boy √©tait parce qu'il encourageait l'achat de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Game Link Cable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- un accessoire qui relie deux Game Boys ensemble pour lancer le mode 2 joueurs contre. </font><font style="vertical-align: inherit;">Ce c√¢ble a ajout√© un √©l√©ment de ¬´socialit√©¬ª au syst√®me - il a encourag√© des amis √† acheter un Game Boy pour se joindre au plaisir. </font><font style="vertical-align: inherit;">Peut-√™tre que Nintendo avait peur que si la version console du jeu avait 2 joueurs contre le mode, alors le pouvoir "publicitaire" de Tetris, qui a stimul√© l'achat de Game Boy, pourrait √™tre affaibli.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique et effets sonores </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La musique de fond est activ√©e lorsque l' </font></font><code>$06F5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une des valeurs r√©pertori√©es dans le tableau est affect√©e.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Valeur </font></font></th><th>  La description </th></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique d'√©cran de d√©marrage inutilis√©e </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cible du mode B atteinte </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-1 </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-2 </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-3 </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-1 allegro </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-2 allegro </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musique-3 allegro </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran F√©licitations </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fin </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cible du mode B atteinte </font></font></td></tr></tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez √©couter la musique inutilis√©e de l'√©conomiseur d'√©cran </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans le jeu lui-m√™me, rien ne retentit pendant l'√©cran d'√©conomiseur d'√©cran. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-1 est une version de " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dance of the Dragee Fairy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", musique pour la ballerine du troisi√®me acte de la </font><font style="vertical-align: inherit;">valse </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de deux </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"The Nutcracker" de</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tchaikovsky. La musique finale est une variation des ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vers torero</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª, un air de l'op√©ra </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carmen</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Georges Bizet. Ces compositions sont arrang√©es par le compositeur du reste de la musique d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hirokazu Tanaka</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-2 s'inspire des chansons traditionnelles du folklore russe. Music-3 est myst√©rieux, futuriste et tendre; Pendant un certain temps, c'√©tait la sonnerie du t√©l√©phone du service client de Nintendo of America.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour aider le joueur √† paniquer lorsque la hauteur du tas s'approche du plafond du terrain de jeu, une version de la musique de fond commence √† jouer √† un rythme rapide ( </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fait int√©ressant, parmi les compositions musicales, il n'y a pas de ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª, un th√®me c√©l√®bre qui sonne dans Game Boy Tetris. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les effets sonores sont d√©clench√©s par l'enregistrement dans </font></font><code>$06F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>$06F1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, selon le tableau suivant.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  L'adresse </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Valeur </font></font></th><th>  La description </th></tr><tr><td> <code>06F0</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le rideau de fin de partie </font></font></td></tr><tr><td> <code>06F0</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fus√©e √† la fin </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S√©lection des options de menu </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S√©lection de l'√©cran de menu </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Re√ßu Tetris </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rotation du t√©trimino </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nouveau niveau </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Serrure Tetrimino </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gazouillis </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nettoyage des rang√©es </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ligne remplie </font></font></td></tr></tbody></table></div><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âtats de jeu et modes de rendu </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pendant le jeu, l'√©tat actuel du jeu est repr√©sent√© par un entier √† l'adresse </font></font><code>$0048</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La plupart du temps, il a une signification </font></font><code>$01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui indique que le joueur contr√¥le le tetrimino actif. </font><font style="vertical-align: inherit;">Cependant, lorsque la pi√®ce est verrouill√©e en place, le jeu passe progressivement d'un √©tat </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† l'autre </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comme le montre le tableau.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Condition </font></font></th><th>  La description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ID d'orientation non attribu√© </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le joueur contr√¥le le tetrimino actif </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Serrure Tetrimino sur le terrain de jeu </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V√©rification des lignes remplies </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Afficher l'animation de nettoyage des lignes </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mise √† jour des lignes et des statistiques </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V√©rification de la cible du mode B-Type </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Non utilis√© </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©er le prochain Tetrimino </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Non utilis√© </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mise √† jour du rideau de jeu </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incr√©ment d'√©tat de jeu </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La ramification du code, selon l'√©tat du jeu, se produit √† l'adresse suivante </font></font><code>$81B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">Dans l'√©tat de </font><font style="vertical-align: inherit;">commutation, il passe au code qui attribue une </font><font style="vertical-align: inherit;">valeur </font><font style="vertical-align: inherit;">indiquant que l'orientation n'est pas sp√©cifi√©e. </font><font style="vertical-align: inherit;">Le gestionnaire n'est jamais appel√©; cependant, l'√©tat du jeu </font><font style="vertical-align: inherit;">sert de signal √† d'autres parties du code. </font><font style="vertical-align: inherit;">L'√©tat </font><font style="vertical-align: inherit;">permet au joueur de d√©placer, tourner et abaisser le tetrimino actif: </font><font style="vertical-align: inherit;">Comme indiqu√© dans les sections pr√©c√©dentes, les routines de shift, rotation et d'abaissement de la figure avant d'ex√©cuter le code v√©rifient les nouvelles positions du tetrimino. La seule fa√ßon de bloquer une forme dans la mauvaise position est de la cr√©er au-dessus d'une forme existante. Dans ce cas, le jeu se termine. Comme indiqu√© ci-dessous, le code d'√©tat effectue cette v√©rification.</font></font><br><br> <code>81B2: LDA $0048 <br> 81B4: JSR $AC82 ; switch(playState) { <br> 81B7: 2F 9E ; case 00: goto 9E2F; // Unassign orientationID <br> 81B9: CF 81 ; case 01: goto 81CF; // Player controls active Tetrimino <br> 81BB: A2 99 ; case 02: goto 99A2; // Lock Tetrimino into playfield <br> 81BD: 6B 9A ; case 03: goto 9A6B; // Check for completed rows <br> 81BF: 39 9E ; case 04: goto 9E39; // Display line clearing animation <br> 81C1: 58 9B ; case 05: goto 9B58; // Update lines and statistics <br> 81C3: F2 A3 ; case 06: goto A3F2; // B-Type goal check; Unused frame for A-Type <br> 81C5: 03 9B ; case 07: goto 9B03; // Unused frame; Execute unfinished 2 player mode logic <br> 81C7: 8E 98 ; case 08: goto 988E; // Spawn next Tetrimino <br> 81C9: 39 9E ; case 09: goto 9E39; // Unused <br> 81CB: 11 9A ; case 0A: goto 9A11; // Update game over curtain <br> 81CD: 37 9E ; case 0B: goto 9E37; // Increment play state <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><code>orientationID</code><font style="vertical-align: inherit;"></font><code>$13</code><font style="vertical-align: inherit;"></font><br><br> <code>9E2F: LDA #$13 <br> 9E31: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9E33: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$01</code><font style="vertical-align: inherit;"></font><br><br> <code>81CF: JSR $89AE ; shift Tetrimino; <br> 81D2: JSR $88AB ; rotate Tetrimino; <br> 81D5: JSR $8914 ; drop Tetrimino; <br> <br> 81D8: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si la position verrouill√©e est correcte, elle marque les 4 cellules associ√©es du terrain de jeu comme occup√©es. Sinon, elle fait la transition vers un √©tat </font><font style="vertical-align: inherit;">- le rideau inqui√©tant de la fin du jeu.</font></font><br><br> <code>99A2: JSR $948B ; if (new position valid) { <br> 99A5: BEQ $99B8 ; goto updatePlayfield; <br> ; } <br> <br> 99A7: LDA #$02 <br> 99A9: STA $06F0 ; play curtain sound effect; <br> <br> 99AC: LDA #$0A <br> 99AE: STA $0048 ; playState = UPDATE_GAME_OVER_CURTAIN; <br> <br> 99B0: LDA #$F0 <br> 99B2: STA $0058 ; curtainRow = -16; <br> <br> 99B4: JSR $E003 ; updateAudio(); <br> <br> 99B7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1b/7c0/a46/b1b7c0a4637995c25423a07984bce24e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rideau est tir√© du haut du terrain de jeu vers le bas, en descendant d'une ligne toutes les 4 images. </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0058</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) s'initialise avec une valeur de -16, cr√©ant un d√©lai suppl√©mentaire de 0,27 seconde entre le verrouillage final et le d√©but de l'animation. √Ä l'adresse </font></font><code>$9A21</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans l'√©tat du </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code indiqu√© ci-dessous, on acc√®de √† la table de multiplication, qui est affich√©e par erreur sous forme de num√©ros de niveau. Cela se fait √† l'√©chelle </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de 10. De plus, comme indiqu√© ci-dessus, le code √† l'adresse </font></font><code>$9A51</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©marre l'animation de fin si le score du joueur n'est pas inf√©rieur √† 30 000 points; sinon, il s'attend √† cliquer sur D√©marrer. </font><font style="vertical-align: inherit;">Le code se termine en affectant une valeur √† l'√©tat du jeu </font><font style="vertical-align: inherit;">, mais le gestionnaire correspondant n'est pas appel√© car le jeu est termin√©.</font></font><br><br> <code>9A11: LDA $0058 ; if (curtainRow == 20) { <br> 9A13: CMP #$14 ; goto endGame; <br> 9A15: BEQ $9A47 ; } <br> <br> 9A17: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9A19: AND #$03 ; return; <br> 9A1B: BNE $9A46 ; } <br> <br> 9A1D: LDX $0058 ; if (curtainRow &lt; 0) { <br> 9A1F: BMI $9A3E ; goto incrementCurtainRow; <br> ; } <br> <br> 9A21: LDA $96D6,X <br> 9A24: TAY ; rowIndex = 10 * curtainRow; <br> <br> 9A25: LDA #$00 <br> 9A27: STA $00AA ; i = 0; <br> <br> 9A29: LDA #$13 <br> 9A2B: STA $0042 ; orientationID = NONE; <br> <br> drawCurtainRow: <br> <br> 9A2D: LDA #$4F <br> 9A2F: STA ($B8),Y ; playfield[rowIndex + i] = CURTAIN_TILE; <br> 9A31: INY <br> 9A32: INC $00AA ; i++; <br> 9A34: LDA $00AA <br> 9A36: CMP #$0A ; if (i != 10) { <br> 9A38: BNE $9A2D ; goto drawCurtainRow; <br> ; } <br> <br> 9A3A: LDA $0058 <br> 9A3C: STA $0049 ; vramRow = curtainRow; <br> <br> incrementCurtainRow: <br> <br> 9A3E: INC $0058 ; curtainRow++; <br> <br> 9A40: LDA $0058 ; if (curtainRow != 20) { <br> 9A42: CMP #$14 ; return; <br> 9A44: BNE $9A46 ; } <br> <br> 9A46: RTS ; return; <br> <br> endGame: <br> <br> 9A47: LDA $00BE <br> 9A49: CMP #$02 <br> 9A4B: BEQ $9A64 ; if (numberOfPlayers == 1) { <br> <br> 9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; } <br> <br> 9A5E: LDA $00F5 ; if (not just pressed Start) { <br> 9A60: CMP #$10 ; return; <br> 9A62: BNE $9A6A ; } <br> ; } <br> <br> 9A64: LDA #$00 <br> 9A66: STA $0048 ; playState = INITIALIZE_ORIENTATION_ID; <br> 9A68: STA $00F5 ; clear newly pressed buttons; <br> <br> 9A6A: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les lignes du terrain de jeu sont copi√©es de fa√ßon incr√©mentielle dans la VRAM pour les afficher. </font><font style="vertical-align: inherit;">L'index de la ligne courante √† copier est contenu dans </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0049</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Une </font></font><code>$9A3C</code> <code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeur est affect√©e </font><font style="vertical-align: inherit;">√† l'adresse </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui rend finalement cette ligne visible lors du rendu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les manipulations avec VRAM se produisent pendant un intervalle de suppression vertical, qui est reconnu par le gestionnaire d'interruption d√©crit dans la section ¬´√âcran d'informations l√©gales¬ª. </font><font style="vertical-align: inherit;">Il appelle le sous-programme indiqu√© ci-dessous (marqu√© dans les commentaires du gestionnaire d'interruption comme </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Le mode de rendu est similaire au mode de jeu. </font><font style="vertical-align: inherit;">Il est stock√© √† l'adresse </font><font style="vertical-align: inherit;">et peut avoir l'une des valeurs suivantes:</font></font><br><br> <code>804B: LDA $00BD <br> 804D: JSR $AC82 ; switch(renderMode) { <br> 8050: B1 82 ; case 0: goto 82B1; // Legal and title screens <br> 8052: DA 85 ; case 1: goto 85DA; // Menu screens <br> 8054: 44 A3 ; case 2: goto A344; // Congratulations screen <br> 8056: EE 94 ; case 3: goto 94EE; // Play and demo <br> 8058: 95 9F ; case 4: goto 9F95; // Ending animation <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00BD</code><font style="vertical-align: inherit;"></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Valeur </font></font></th><th>  La description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcran avec l√©gal </font><font style="vertical-align: inherit;">informations et √©conomiseur d'√©cran</font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcrans de menu </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âcran F√©licitations </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jeu et d√©mo </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fin de l'animation </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une partie du mode de rendu est </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">illustr√©e ci-dessous. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir ci-dessous, il </font><font style="vertical-align: inherit;">passe en VRAM une ligne du terrain de jeu avec un index </font><font style="vertical-align: inherit;">. Si elle est </font><font style="vertical-align: inherit;">sup√©rieure √† 20, la routine ne fait rien. </font><font style="vertical-align: inherit;">Le tableau </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) contient les adresses VRAM en petit format endian correspondant aux lignes affich√©es du terrain de jeu d√©cal√©es de 6 en mode normal et de -2 et 12 pour le terrain de jeu en mode inachev√© 2 Player Versus. Les octets de ce tableau font partie de la liste de valeurs qui sont affich√©es par erreur sous forme de num√©ros de niveau apr√®s le niveau 29. Les octets inf√©rieurs et sup√©rieurs adjacents de chaque adresse sont obtenus s√©par√©ment et sont essentiellement combin√©s en une adresse 16 bits qui est utilis√©e dans le cycle de copie. </font><font style="vertical-align: inherit;">Un incr√©ment est ex√©cut√© √† la fin du sous-programme.</font></font><br><br> <code>952A: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 952D: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9530: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9533: JSR $9725 ; copyPlayfieldRowToVRAM();</code> <br> <br><font style="vertical-align: inherit;"></font><code>copyPlayfieldRowToVRAM()</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><br><br> <code>9725: LDX $0049 ; if (vramRow &gt; 20) { <br> 9727: CPX #$15 ; return; <br> 9729: BPL $977E ; } <br> <br> 972B: LDA $96D6,X <br> 972E: TAY ; playfieldAddress = 10 * vramRow; <br> <br> 972F: TXA <br> 9730: ASL <br> 9731: TAX <br> 9732: INX ; high = vramPlayfieldRows[vramRow * 2 + 1]; <br> 9733: LDA $96EA,X <br> 9736: STA $2006 <br> 9739: DEX <br> <br> 973A: LDA $00BE <br> 973C: CMP #$01 <br> 973E: BEQ $975E ; if (numberOfPlayers == 2) { <br> <br> 9740: LDA $00B9 <br> 9742: CMP #$05 <br> 9744: BEQ $9752 ; if (leftPlayfield) { <br> <br> 9746: LDA $96EA,X <br> 9749: SEC <br> 974A: SBC #$02 <br> 974C: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] - 2; <br> <br> 974F: JMP $9767 ; } else { <br> <br> 9752: LDA $96EA,X <br> 9755: CLC <br> 9756: ADC #$0C <br> 9758: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] + 12; <br> <br> 975B: JMP $9767 ; } else { <br> <br> 975E: LDA $96EA,X <br> 9761: CLC <br> 9762: ADC #$06 ; low = vramPlayfieldRows[vramRow * 2] + 6; <br> 9764: STA $2006 ; } <br> <br> ; vramAddress = (high &lt;&lt; 8) | low; <br> <br> 9767: LDX #$0A <br> 9769: LDA ($B8),Y <br> 976B: STA $2007 <br> 976E: INY ; for(i = 0; i &lt; 10; i++) { <br> 976F: DEX ; vram[vramAddress + i] = playfield[playfieldAddress + i]; <br> 9770: BNE $9769 ; } <br> <br> 9772: INC $0049 ; vramRow++; <br> 9774: LDA $0049 ; if (vramRow &lt; 20) { <br> 9776: CMP #$14 ; return; <br> 9778: BMI $977E ; } <br> <br> 977A: LDA #$20 <br> 977C: STA $0049 ; vramRow = 32; <br> <br> 977E: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramPlayfieldRows</code><font style="vertical-align: inherit;"></font><code>$96EA</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si la valeur atteint 20, une valeur de 32 lui est attribu√©e, ce qui signifie que la copie est enti√®rement termin√©e. Comme indiqu√© ci-dessus, seules 4 lignes sont copi√©es par image. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le gestionnaire d'√©tat </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est responsable de reconna√Ætre les lignes termin√©es et de les retirer du terrain de jeu. Pendant 4 appels s√©par√©s, il scanne les d√©calages de ligne </font></font><code>[‚àí2, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√®s du centre du tetrimino (les deux coordonn√©es de tous les carr√©s du tetrimino sont dans cet intervalle). Les index des lignes termin√©es sont stock√©s dans </font></font><code>$004A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$004D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; l'index enregistr√© 0 est utilis√© pour indiquer qu'aucune ligne termin√©e n'a √©t√© trouv√©e dans cette passe. Le gestionnaire est illustr√© ci-dessous. </font><font style="vertical-align: inherit;">La v√©rification </font><font style="vertical-align: inherit;">au d√©but ne permet pas au gestionnaire de s'ex√©cuter lors du transfert des lignes du terrain de jeu vers la VRAM (gestionnaire d'√©tat</font></font><br><br> <code>9A6B: LDA $0049 <br> 9A6D: CMP #$20 ; if (vramRow &lt; 32) { <br> 9A6F: BPL $9A74 ; return; <br> 9A71: JMP $9B02 ; } <br> <br> 9A74: LDA $0041 ; rowY = tetriminoY - 2; <br> 9A76: SEC <br> 9A77: SBC #$02 ; if (rowY &lt; 0) { <br> 9A79: BPL $9A7D ; rowY = 0; <br> 9A7B: LDA #$00 ; } <br> <br> 9A7D: CLC <br> 9A7E: ADC $0057 <br> 9A80: STA $00A9 ; rowY += lineIndex; <br> <br> 9A82: ASL <br> 9A83: STA $00A8 <br> 9A85: ASL <br> 9A86: ASL <br> 9A87: CLC <br> 9A88: ADC $00A8 <br> 9A8A: STA $00A8 ; rowIndex = 10 * rowY; <br> <br> 9A8C: TAY <br> 9A8D: LDX #$0A <br> 9A8F: LDA ($B8),Y <br> 9A91: CMP #$EF ; for(i = 0; i &lt; 10; i++) { <br> 9A93: BEQ $9ACC ; if (playfield[rowIndex + i] == EMPTY_TILE) { <br> 9A95: INY ; goto rowNotComplete; <br> 9A96: DEX ; } <br> 9A97: BNE $9A8F ; } <br> <br> 9A99: LDA #$0A <br> 9A9B: STA $06F1 ; play row completed sound effect; <br> <br> 9A9E: INC $0056 ; completedLines++; <br> <br> 9AA0: LDX $0057 <br> 9AA2: LDA $00A9 <br> 9AA4: STA $4A,X ; lines[lineIndex] = rowY; <br> <br> 9AA6: LDY $00A8 <br> 9AA8: DEY <br> 9AA9: LDA ($B8),Y <br> 9AAB: LDX #$0A <br> 9AAD: STX $00B8 <br> 9AAF: STA ($B8),Y <br> 9AB1: LDA #$00 <br> 9AB3: STA $00B8 <br> 9AB5: DEY ; for(i = rowIndex - 1; i &gt;= 0; i--) { <br> 9AB6: CPY #$FF ; playfield[i + 10] = playfield[i]; <br> 9AB8: BNE $9AA9 ; } <br> <br> 9ABA: LDA #$EF <br> 9ABC: LDY #$00 <br> 9ABE: STA ($B8),Y <br> 9AC0: INY ; for(i = 0; i &lt; 10; i++) { <br> 9AC1: CPY #$0A ; playfield[i] = EMPTY_TILE; <br> 9AC3: BNE $9ABE ; } <br> <br> 9AC5: LDA #$13 <br> 9AC7: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9AC9: JMP $9AD2 ; goto incrementLineIndex; <br> <br> rowNotComplete: <br> <br> 9ACC: LDX $0057 <br> 9ACE: LDA #$00 <br> 9AD0: STA $4A,X ; lines[lineIndex] = 0; <br> <br> incrementLineIndex: <br> <br> 9AD2: INC $0057 ; lineIndex++; <br> <br> 9AD4: LDA $0057 ; if (lineIndex &lt; 4) { <br> 9AD6: CMP #$04 ; return; <br> 9AD8: BMI $9B02 ; } <br> <br> 9ADA: LDY $0056 <br> 9ADC: LDA $9B53,Y <br> 9ADF: CLC <br> 9AE0: ADC $00BC <br> 9AE2: STA $00BC ; totalGarbage += garbageLines[completedLines]; <br> <br> 9AE4: LDA #$00 <br> 9AE6: STA $0049 ; vramRow = 0; <br> 9AE8: STA $0052 ; clearColumnIndex = 0; <br> <br> 9AEA: LDA $0056 <br> 9AEC: CMP #$04 <br> 9AEE: BNE $9AF5 ; if (completedLines == 4) { <br> 9AF0: LDA #$04 ; play Tetris sound effect; <br> 9AF2: STA $06F1 ; } <br> <br> 9AF5: INC $0048 ; if (completedLines &gt; 0) { <br> 9AF7: LDA $0056 ; playState = DISPLAY_LINE_CLEARING_ANIMATION; <br> 9AF9: BNE $9B02 ; return; <br> ; } <br> <br> 9AFB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 9AFD: LDA #$07 <br> 9AFF: STA $06F1 ; play piece locked sound effect; <br> <br> 9B02: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appel√© dans chaque trame). Si des lignes remplies sont d√©tect√©es, elle est </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©initialis√©e √† 0, ce qui force un transfert complet. </font></font><br><br> <code>lineIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) est initialis√© avec une valeur de 0 et son incr√©mentation est effectu√©e √† chaque passage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contrairement √† l'√©tat du jeu </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et √† la routine de copie de champ de jeu, qui utilisent la table de multiplication des adresses </font></font><code>$96D6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, un bloc commen√ßant par </font></font><code>$9A82</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplie </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par 10 en utilisant des d√©calages et des ajouts: </font></font><br><br> <code>rowIndex = (rowY &lt;&lt; 1) + (rowY &lt;&lt; 3); // rowIndex = 2 * rowY + 8 * rowY;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela se fait uniquement parce qu'il est </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limit√© par l'intervalle </font></font><code>[0, 20]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et la table de multiplication ne couvre que </font></font><code>[0, 19]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le balayage des lignes peut s'√©tendre au-del√† de la fin du terrain de jeu. Cependant, comme dit pr√©c√©demment, le jeu s'initialise </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur</font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(tuile vide), cr√©ant plus de 5 lignes cach√©es vides suppl√©mentaires sous le sol du terrain de jeu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un bloc commen√ßant par </font></font><code>$9ADA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fait partie du mode incomplet de 2 joueurs contre. Comme mentionn√© ci-dessus, le nettoyage des rang√©es ajoute des d√©bris au terrain de jeu de l'adversaire. Le nombre de lignes de d√©chets est d√©termin√© par le tableau √† l'adresse </font></font><code>$9B53</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">le cycle √† l'adresse </font><font style="vertical-align: inherit;">d√©place le mat√©riau au-dessus de la ligne remplie d'une ligne vers le bas. Il profite du fait que chaque ligne d'une s√©quence continue est s√©par√©e de l'autre de 10 octets. La boucle suivante efface la ligne sup√©rieure. </font><font style="vertical-align: inherit;">L'animation d'effacement de ligne est effectu√©e pendant l'√©tat de jeu </font><font style="vertical-align: inherit;">, mais comme illustr√© ci-dessous, elle ne se produit pas dans le gestionnaire d'√©tat de jeu, qui est compl√®tement vide.</font></font><br><br> <code>9B53: 00 ; no cleared lines <br> 9B54: 00 ; Single <br> 9B55: 01 ; Double <br> 9B56: 02 ; Triple <br> 9B57: 04 ; Tetris</code> <br> <br><font style="vertical-align: inherit;"></font><code>$9AA6</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$04</code><font style="vertical-align: inherit;"></font><br><br> <code>9E39: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu de cela, pendant l'√©tat du jeu </font></font><code>$04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la prochaine branche du mode de rendu est effectu√©e </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">et des valeurs en miroir sont n√©cessaires pour le mode 2 Player Versus inachev√©. </font><font style="vertical-align: inherit;">Le sous-programme est illustr√© ci-dessous </font><font style="vertical-align: inherit;">. Il est appel√© dans chaque trame, mais la condition au d√©but ne permet de l'ex√©cuter que dans toutes les quatre trames. √Ä chaque passage, il parcourt la liste des index des lignes termin√©es et efface 2 colonnes de ces lignes, se d√©pla√ßant de la colonne centrale vers l'ext√©rieur. </font><font style="vertical-align: inherit;">Une adresse VRAM 16 bits est construite de la m√™me mani√®re que celle illustr√©e dans la routine de champ de copie. Cependant, dans ce cas, il effectue un d√©calage par l'index de colonne obtenu √† partir du tableau ci-dessous.</font></font><br><br> <code>94EE: LDA $0068 <br> 94F0: CMP #$04 <br> 94F2: BNE $9522 ; if (playState == DISPLAY_LINE_CLEARING_ANIMATION) { <br> <br> 94F4: LDA #$04 <br> 94F6: STA $00B9 ; leftPlayfield = true; <br> <br> 94F8: LDA $0072 <br> 94FA: STA $0052 <br> 94FC: LDA $006A <br> 94FE: STA $004A <br> 9500: LDA $006B <br> 9502: STA $004B <br> 9504: LDA $006C <br> 9506: STA $004C <br> 9508: LDA $006D <br> 950A: STA $004D <br> 950C: LDA $0068 <br> 950E: STA $0048 ; mirror values; <br> <br> 9510: JSR $977F ; updateLineClearingAnimation(); <br> <br> ; ... <br> ; }</code> <br> <br> <code>leftPlayfield</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>updateLineClearingAnimation()</code><font style="vertical-align: inherit;"></font><br><br> <code>977F: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9781: AND #$03 ; return; <br> 9783: BNE $97FD ; } <br> <br> 9785: LDA #$00 ; for(i = 0; i &lt; 4; i++) { <br> 9787: STA $00AA ; rowY = lines[i]; <br> 9789: LDX $00AA ; if (rowY == 0) { <br> 978B: LDA $4A,X ; continue; <br> 978D: BEQ $97EB ; } <br> <br> 978F: ASL <br> 9790: TAY <br> 9791: LDA $96EA,Y <br> 9794: STA $00A8 ; low = vramPlayfieldRows[2 * rowY]; <br> <br> 9796: LDA $00BE ; if (numberOfPlayers == 2) { <br> 9798: CMP #$01 ; goto twoPlayers; <br> 979A: BNE $97A6 ; } <br> <br> 979C: LDA $00A8 <br> 979E: CLC <br> 979F: ADC #$06 <br> 97A1: STA $00A8 ; low += 6; <br> <br> 97A3: JMP $97BD ; goto updateVRAM; <br> <br> twoPlayers: <br> <br> 97A6: LDA $00B9 <br> 97A8: CMP #$04 <br> 97AA: BNE $97B6 ; if (leftPlayfield) { <br> <br> 97AC: LDA $00A8 <br> 97AE: SEC <br> 97AF: SBC #$02 <br> 97B1: STA $00A8 ; low -= 2; <br> <br> 97B3: JMP $97BD ; } else { <br> <br> 97B6: LDA $00A8 <br> 97B8: CLC <br> 97B9: ADC #$0C ; low += 12; <br> 97BB: STA $00A8 ; } <br> <br> updateVRAM: <br> <br> 97BD: INY <br> 97BE: LDA $96EA,Y <br> 97C1: STA $00A9 <br> 97C3: STA $2006 <br> 97C6: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97C8: LDA $97FE,X <br> 97CB: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97CC: ADC $00A8 <br> 97CE: STA $2006 ; vramAddress = rowAddress + leftColumns[clearColumnIndex]; <br> 97D1: LDA #$FF <br> 97D3: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97D6: LDA $00A9 <br> 97D8: STA $2006 <br> 97DB: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97DD: LDA $9803,X <br> 97E0: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97E1: ADC $00A8 <br> 97E3: STA $2006 ; vramAddress = rowAddress + rightColumns[clearColumnIndex]; <br> 97E6: LDA #$FF <br> 97E8: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97EB: INC $00AA <br> 97ED: LDA $00AA <br> 97EF: CMP #$04 <br> 97F1: BNE $9789 ; } <br> <br> 97F3: INC $0052 ; clearColumnIndex++; <br> 97F5: LDA $0052 ; if (clearColumnIndex &lt; 5) { <br> 97F7: CMP #$05 ; return; <br> 97F9: BMI $97FD ; } <br> <br> 97FB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 97FD: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>97FE: 04 03 02 01 00 ; left columns <br> 9803: 05 06 07 08 09 ; right columns</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour l'animation de nettoyage, 5 passes sont n√©cessaires. Ensuite, le code passe √† l'√©tat de jeu suivant. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le gestionnaire d'√©tat du jeu </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient le code d√©crit dans la section ¬´Lignes et statistiques¬ª. Le gestionnaire se termine avec ce code: La </font><font style="vertical-align: inherit;">variable n'est </font><font style="vertical-align: inherit;">pas r√©initialis√©e jusqu'√† la fin de l'√©tat du jeu </font><font style="vertical-align: inherit;">, apr√®s quoi elle est utilis√©e pour mettre √† jour le nombre total de lignes et le score. Cette s√©quence permet d'ex√©cuter un bug int√©ressant. En mode d√©mo, vous devez attendre que le jeu recueille la ligne compl√®te, puis appuyer rapidement sur D√©marrer jusqu'√† la fin de l'animation pour effacer la s√©rie. Le jeu reviendra √† l'√©conomiseur d'√©cran, mais si vous choisissez le bon moment, la valeur sera </font><font style="vertical-align: inherit;">enregistr√©e. Vous pouvez maintenant d√©marrer le jeu en mode A-Type. Lorsqu'il est verrouill√© √† la place de la premi√®re figure, le gestionnaire d'√©tat du jeu</font></font><br><br> <code>9C9E: LDA #$00 <br> 9CA0: STA $0056 ; completedLines = 0; <br> <br> 9CA2: INC $0048 ; playState = B_TYPE_GOAL_CHECK; <br> <br> 9CA4: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$05</code><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commence √† analyser les lignes termin√©es. Il ne les trouvera pas, mais les laissera </font></font><code>completedLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inchang√©s. Enfin, lorsque l'√©tat du jeu est atteint, le </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre total de lignes et le score augmenteront, comme si vous les aviez marqu√©s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fa√ßon la plus simple de le faire est d'obtenir le plus gros montant, en attendant que la d√©mo r√©cup√®re Tetris (il y en aura 2 dans la d√©mo). D√®s que vous voyez le scintillement de l'√©cran, cliquez sur D√©marrer.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a8/80a/091/2a880a09173c42fb8c5256f9921a635b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s avoir commenc√© une nouvelle partie, l'√©cran continuera de clignoter. Tout cela gr√¢ce au code suivant appel√© par le gestionnaire d'interruption. </font><font style="vertical-align: inherit;">En fait, si vous laissez le premier chiffre descendre automatiquement sur le terrain de jeu, le score augmentera d'une valeur encore plus grande, car </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) enregistrera √©galement sa valeur dans la d√©mo. Cela est vrai m√™me pour les cas o√π la d√©mo n'a pas rempli une seule ligne. </font><font style="vertical-align: inherit;">Il n'est pas r√©initialis√© tant que le bouton ¬´Down¬ª n'est pas enfonc√©. </font><font style="vertical-align: inherit;">De plus, si vous appuyez sur D√©marrer pendant l'animation d'effacement de la s√©rie de combinaisons Tetris en mode d√©mo, puis attendez que la d√©mo recommence, non seulement les points pour Tetris seront compt√©s dans la d√©mo, mais tout le timing sera m√©lang√©. En cons√©quence, la d√©mo perdra le jeu. Apr√®s avoir boucl√© la fin du jeu, vous pouvez revenir √† l'√©conomiseur d'√©cran en cliquant sur D√©marrer.</font></font><br><br> <code>9673: LDA #$3F <br> 9675: STA $2006 <br> 9678: LDA #$0E <br> 967A: STA $2006 ; prepare to modify background tile color; <br> <br> 967D: LDX #$00 ; color = DARK_GRAY; <br> <br> 967F: LDA $0056 <br> 9681: CMP #$04 <br> 9683: BNE $9698 ; if (completedLines == 4) { <br> <br> 9685: LDA $00B1 <br> 9687: AND #$03 <br> 9689: BNE $9698 ; if (frameCounter divisible by 4) { <br> <br> 968B: LDX #$30 ; color = WHITE; <br> <br> 968D: LDA $00B1 <br> 968F: AND #$07 <br> 9691: BNE $9698 ; if (frameCounter divisible by 8) { <br> <br> 9693: LDA #$09 <br> 9695: STA $06F1 ; play clear sound effect; <br> <br> ; } <br> ; } <br> ; } <br> <br> 9698: STX $2007 ; update background tile color;</code> <br> <br><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><code>$004F</code><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat du jeu </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effectue une v√©rification de cible pour les jeux de type B. </font><font style="vertical-align: inherit;">En mode A, il s'agit essentiellement d'une trame inutilis√©e. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat du jeu </font></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient exclusivement la logique incompl√®te √† 2 joueurs. </font><font style="vertical-align: inherit;">En mode solo, il se comporte comme un cadre inutilis√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat du jeu est </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abord√© dans les sections ¬´Cr√©ation de Tetrimino¬ª et ¬´Choix de Tetrimino¬ª. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat du jeu n'est </font></font><code>$09</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas utilis√©. </font></font><code>$0B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">augmente l'√©tat du jeu, mais semble √©galement inutilis√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et enfin, le cycle principal du jeu:</font></font><br><br> <code>; while(true) { <br> <br> 8138: JSR $8161 ; branchOnGameMode(); <br> <br> 813B: CMP $00A7 ; if (vertical blanking interval wait requested) { <br> 813D: BNE $8142 ; waitForVerticalBlankingInterval(); <br> 813F: JSR $AA2F ; } <br> <br> 8142: LDA $00C0 <br> 8144: CMP #$05 <br> 8146: BNE $815A ; if (gameMode == DEMO) { <br> <br> 8148: LDA $00D2 <br> 814A: CMP #$DF <br> 814C: BNE $815A ; if (reached end of demo table) { <br> <br> 814E: LDA #$DD <br> 8150: STA $00D2 ; reset demo table index; <br> <br> 8152: LDA #$00 <br> 8154: STA $00B2 ; clear upper byte of frame counter; <br> <br> 8156: LDA #$01 <br> 8158: STA $00C0 ; gameMode = TITLE_SCREEN; <br> ; } <br> ; } <br> 815A: JMP $8138 ; }</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420725/">https://habr.com/ru/post/fr420725/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420707/index.html">La startup JITX utilise l'IA pour automatiser le d√©veloppement de cartes de circuits imprim√©s complexes</a></li>
<li><a href="../fr420709/index.html">T2F: un projet de conversion de texte en dessin facial avec deep learning</a></li>
<li><a href="../fr420711/index.html">Moscou Data Science Major: annonce et inscription</a></li>
<li><a href="../fr420713/index.html">Comment Chuck Hull a invent√© l'impression 3D</a></li>
<li><a href="../fr420715/index.html">La dure v√©rit√© sur la gravit√© de l'apprentissage</a></li>
<li><a href="../fr420729/index.html">Webinaire ouvert "Naive Bayes Classifier"</a></li>
<li><a href="../fr420731/index.html">Zabbix sur les st√©ro√Ødes: comment fonctionne la plate-forme de surveillance unifi√©e de Sbertech</a></li>
<li><a href="../fr420735/index.html">Nous vous invitons √† la finale du marathon Find Yourself in Digital au bureau du groupe Mail.Ru</a></li>
<li><a href="../fr420737/index.html">Mini AI Cup 2 ou presque AgarIO - ce qui pourrait √™tre fait pour gagner</a></li>
<li><a href="../fr420739/index.html">La bo√Æte est toujours dans la poign√©e: pourquoi en 2018 vous devez encore apprendre les langues vous-m√™me</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>