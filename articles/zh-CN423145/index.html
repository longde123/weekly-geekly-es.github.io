<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍⚖️ ⛪️ 👩🏽 扩展PHP和Kotlin本机。 第三部分，可能是最终的 🆗 🙀 🚪</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在第一部分中 ，讲述了有关设置工具和一般概念的基本知识。 

 可以说， 第二部分是关于弹丸，思想，计划，计划的第一种方法。 

 在本文中，有关C和K / N互操作，更多的宏，痛苦，绝望和“善良之光”的内容将更加严格。 当然，会有一章讲述有关成就的故事（您不会称赞自己……此外，还有关于史诗般的fa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>扩展PHP和Kotlin本机。 第三部分，可能是最终的</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfa/blog/423145/"><img align="right" src="https://habrastorage.org/webt/o7/db/cw/o7dbcwsbe8kad4jkw84guc_2n4m.png"> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第一部分中</a> ，讲述了有关设置工具和一般概念的基本知识。 <br><br> 可以说， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第二部分是</a>关于弹丸，思想，计划，计划的第一种方法。 <br><br> 在本文中，有关C和K / N互操作，更多的宏，痛苦，绝望和“善良之光”的内容将更加严格。 当然，会有一章讲述有关成就的故事（您不会称赞自己……此外，还有关于史诗般的fakap的故事。 <br><a name="habracut"></a><br>  <b>免责声明：</b>在为PHP编写库的上下文中考虑了以下所有内容。 <br><br><h2> 第一章 天真烂漫 </h2><br> 在循环的第一部分中介绍了如何在C中使用K / N函数。 因此，在这里我将告诉您如何在K ​​/ N中使用C函数。 <br><br>  <a href="">官方文档</a>相当小巧简洁，但是对于简单的项目来说，已经足够了。 <br><br> 简而言之，您需要创建一个扩展名为<b>.def</b>的特殊文件，并在其中指定必要的头文件。 <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">headers</span></span> = php.h</code> </pre> <br> 然后将其提供给名为<b>cinterop</b>的程序。 <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cinterop -def php.def -o php</span></span></code> </pre><br> 在输出中，您将获得包含llvm位代码和各种元信息的<b>libphp.klib</b>库。 <br><br> 然后，您可以安全地使用头文件（ <code>#define</code> ）中描述的函数和宏，而不必忘记在编译阶段连接库。 <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># kotlinc -opt -produce static ${SOURCES} -l libphp.klib -o myLib</span></span></code> </pre><br> 但是有细微差别。 没有一个。 <br><br><h3> 以上述形式，库将不会被组装 </h3><br> 怎么了 但是因为以下行出现在php.h中： <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_version.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_sort.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_compat.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_API.h"</span></span></span></span></code> </pre><br> 在这里应该注意，llvm仍在编译库，它具有<b>-I开关</b> ，而cinterop具有<b>-copt开关</b> 。 好吧，你明白了。 结果，这样的命令足以编译<b>php.h。</b> <br><br><pre> <code class="hljs mel"># cinterop -def my.def -o myLib -I${PHP_LIB_ROOT} -copt -I${PHP_LIB_ROOT} \ -copt -I${PHP_LIB_ROOT}/main \ -copt -I${PHP_LIB_ROOT}/Zend \ -copt -I${PHP_LIB_ROOT}/TSRM</code> </pre><br><h3> 宏。 我爱你，恨你！ 不，我只是讨厌。 </h3><br> 关于C&gt; K / N互操作，您需要了解的<code>#define</code>是 <br><blockquote> 每个扩展为常数的C宏都表示为Kotlin属性。 不支持其他宏。 </blockquote><br> 然后我们回想起PHP扩展是宏上的一个宏，它驱动一个宏，并尽量不要哭泣。 <br><br> 但是，并非一切都那么糟糕。 为了解决这种情况，K / N开发人员提供了一卷蓝色电气胶带，用于粘贴到<b>自定义声明</b> def文件。 看起来像这样（例如，使用宏<code>Z_TYPE_P</code> ） <br><br><pre> <code class="cpp hljs">headers = php.h --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> zend_uchar __zp_get_arg_type(zval *z_value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Z_TYPE_P(z_value); }</code> </pre> <br> 现在在K / N代码中可以使用<code>__zp_get_arg_type</code>函数 <br><br><h2> 第二章  PHP INI设置或子子宏。 </h2><br> 这是对PHP源代码的一种“美好的祝愿”。 <br><br> 有4个宏可用于提取设置： <br><br><pre> <code class="cpp hljs">INI_INT(val) INI_FLT(val) INI_STR(val) INI_BOOL(val)</code> </pre><br> 其中<code>val</code>是带有设置名称的字符串。 <br><br> 现在，让我们看一下<code>INI_STR</code>的示例，以了解如何定义此宏。 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INI_STR(name) zend_ini_string_ex((name), sizeof(name)-1, 0, NULL)</span></span></code> </pre> <br> 已经注意到他的“致命缺陷”了吗？ <br><br> 如果没有，让我告诉您-这是<code>sizeof</code>函数。 当直接使用宏时，一切都很好： <br><br><pre> <code class="cpp hljs">php_printf(<span class="hljs-string"><span class="hljs-string">"The value is : %s"</span></span>, INI_STR(<span class="hljs-string"><span class="hljs-string">"my.ini"</span></span>));</code> </pre> <br> 当您通过<b>.def</b>文件中的代理函数使用它时，笔架变成南瓜，并且<b>sizeof（名称）</b>返回指针的大小。 将军科特林原生。 <br><br> 实际上，规避只有两种选择。 <br><br><ol><li> 不要使用宏，而要使用它们所附加的功能。 </li><li> 每个必需设置的硬包装程序功能。 </li></ol><br> 第一个选项对每个人都比第二个选项更好，除了一点以外-没有人可以保证宏声明不会更改。 因此，对于我的项目，我感到非常不满，选择了第二个选项。 <br><br><h2> 第三章 调试？ 什么行李 </h2><br><h3> 行动1-互操作。 </h3><br> 曾经，在将蓝带附加到20个连续代理功能的def文件之后，我收到了一个奇妙的错误。 <br><br><pre> <code class="hljs powershell">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread <span class="hljs-string"><span class="hljs-string">"main"</span></span> java.lang.Error: /tmp/tmp399964332777824085.c:<span class="hljs-number"><span class="hljs-number">103</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>: error: too many arguments to <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">2</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">have</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UtilsKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ensureNoCompileErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Utils.kt:137)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexDeclarations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:902)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndexImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:892)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeIndexKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeIndex.kt:56)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processCLib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:283)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:38)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InteropCompilerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invokeInterop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InteropCompiler.kt:100)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:29)</span></span></span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/sg/xb/m_sgxb-qifca4cx1tccuvbxa6ra.png"></div><br> 对一半发表评论，然后重新编译，如果对其余一半发表评论，则我们收集...并且鉴于编译标头的过程足够长...（是的，这似乎比十二个源文件的爬取要快，并且用放大镜精心地调和）。 <br><br> 第二个“美好之光”进入了JetBrains。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q0/9u/dd/q09uddpi04rrxoc76xnk5meecow.png"></div><br><h3> 行动2-运行时。 </h3><br> 我遇到运行时<b>分段错误</b> 。 好吧，它发生了。 我正在进入调试器。 嗯... STA？ <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Program</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">received</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">signal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SIGSEGV</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Segmentation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fault</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">kfun</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:kotlinx.cinterop.toKString</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">CPointer</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ByteVarOf</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Byte</span></span>&gt;&gt;.()<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">String</span></span> () at /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt:<span class="hljs-number"><span class="hljs-number">402</span></span> <span class="hljs-number"><span class="hljs-number">402</span></span> /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt: No such file or directory.</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cr/nq/ek/crnqekwr9fheufvuxcc9ixhnsjc.png"></div><br><h2> 第四章 我将茶倒入您的茶中，以便您可以在喝茶的同时喝茶。 </h2><br> 在这里有必要告诉我我所做的那种胡扯。 <br><br> 您编写一个描述未来PHP扩展的DSL，编写包含功能，类和方法的实现的K / N代码，然后运行<code>make</code> ，然后奇迹般地获得可以连接到PHP的现成的库。 <br><br> 组装可分为4个阶段： <br><br><ol><li> 在C和K / N之间创建一个图层（相同的<code>cinterop</code> ） </li><li> 扩展C代码生成 </li><li> 用逻辑编译库 </li><li> 编译目标库 </li></ol><br> 目的是增加以K / N代码创建PHP类实例的功能。 例如，以便该类可以定义<code>getInstance()</code>方法。 我想制造它以便于使用。 <br><br> 在C语言中，此问题解决了一次或两次。 <br><br><pre> <code class="cpp hljs">zval *obj = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zval)); object_init_ex(obj, myClass);</code> </pre> <br> 这看起来很简单-将其转移到K / N，但这是<code>myClass</code> ... <br><br> 但是<code>myClass</code>是<code>zend_class_entry*</code>类型的全局变量，在项目的C代码中声明，并且事先具有未知名称。 <br><br> 小心你的手。 您需要从K / N代码编译该库，其中将有一个函数需要访问<code>myClass</code> ，该函数在生成的但未编译的C代码中定义，然后从该代码中调用该函数。 <br><br> 最终，此功能的实现导致添加了两个新工件：代码生成阶段的<b>.h</b>和<b>.kt</b> ，cinterop阶段的复杂性和史诗般的phakap，我将在最后讨论。 <br><br><h2> 第五章 我叫什么名字？ </h2><br> 为什么的故事： <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ArgumentType</span></span> { PHP_STRING, PHP_LONG, PHP_DOUBLE, PHP_NULL, ... }</code> </pre> <br> 优于： <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArgumentType</span></span></span><span class="hljs-class"> {</span></span> STRING, LONG, DOUBLE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... }</code> </pre> <br> 是的，甚至无需解释。 这是<code>ArgumentType.NULL</code>在Kotlin库的头文件中变成的内容： <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> extension_kt_kref_php_extension_dsl_ArgumentType (*get)(); <span class="hljs-comment"><span class="hljs-comment">/* enum entry for NULL. */</span></span> } <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br> 这就是gcc对此的反应。 <br><br><pre> <code class="hljs pgsql">/root/simpleExtension/phpmodule/extension_kt_api.h:<span class="hljs-number"><span class="hljs-number">113</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: error: expected identifier <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-string"><span class="hljs-string">'void'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; ^</code> </pre><br> 窗帘！ 当心名字。 <br><br><h2> 倒数第二章。 您不会赞美自己-没有人会赞美您。 </h2><br> 总的来说，我已经实现了我的目标。 沉浸在该主题中的“框架”通常就可以在Kotlin Native上编写PHP扩展了。 仍然需要添加一些（而不是最关键的）功能和修饰。 <br><br> 我希望该项目本身以及很好的文档可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在github</a>上查看。 <br><br> 关于K / N我能说些什么？ 很好 在上面写东西是一种享受，而浅浅的沙哑和粗糙可以归因于他甚至还没有爬出摇篮的事实：） <br><br><h2> 最后一章。 光线很好，没有引号。 </h2><br> 现在，我要非常认真并深切地感谢JetBrains的家伙和Kotlin Native松弛频道的居民。 你真厉害！ <br><br> 还要特别感谢<b>Nicholas Igotti</b> 。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tn/gr/px/tngrpxjotuvwziojqifyaxff5-y.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d1/5r/sn/d15rsndzgsxzin-aeglanekvtv4.png"></div><br><h2> 红利 史诗般的Fakap。 </h2><br> 上下文在第四章中进行了描述。 <br><br> 实际上，当将所有内容添加到可以无错误编译的状态时，就会出现问题-在测试期间，PHP从一个完全陌生的角度向我开放。 <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># php -dextension=./phpmodule/modules/extension.so -r </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"var_dump(ExampleClass::getInstance());"</span></span></span><span class="hljs-meta"> *RECURSION* #</span></span></code> </pre><br>  “菲加斯！”  -我想，我进入了PHP源代码，发现了这样的片段。 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_OBJECT: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_IS_RECURSIVE_P(struc)) { PUTS(<span class="hljs-string"><span class="hljs-string">"*RECURSION*\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br> 添加调试： <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%u"</span></span>, Z_IS_RECURSIVE_P(struc))</code> </pre> <br> 导致： <br><br><pre> <code class="hljs pgsql">undefined symbol: Z_IS_RECURSIVE_P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  “菲加斯！” 我又想了。 <br><br> 那时，我猜想看一下Linux主机上实际使用的php.h（7.1.8），而不是从早午餐（7.3.x）的github上拉来的那个。 直as愧。 <br><br> 但是，事实证明，它不是梭芯。 <br><br> 在我控制的对象生命的所有阶段，正确的递归检查代码报告一切正常。 这意味着您应该仔细查看那些我无法控制的地方。 恰好有一件事-将我的对象返回给<code>var_dump</code>函数 <br><br><pre> <code class="cpp hljs">RETURN_OBJ( example_symbols()-&gt;kotlin.root.php.extension.proxy.objectToZval( example_symbols()-&gt;kotlin.root.exampleclass.getInstance(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>) ) )</code> </pre> <br> 将宏RETURN_OBJ打开到最后。 远离监护人紧张和怀孕！ <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>) RETURN_OBJ(r) <span class="hljs-number"><span class="hljs-number">2</span></span>) { RETVAL_OBJ(r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">3</span></span>) { ZVAL_OBJ(return_value, r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ_P(__z) = (r); Z_TYPE_INFO_P(__z) = IS_OBJECT_EX; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">5</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ(*(__z)) = (r); Z_TYPE_INFO(*(__z)) = (IS_OBJECT | (IS_TYPE_REFCOUNTED &lt;&lt; Z_TYPE_FLAGS_SHIFT)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">6</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); (*(__z)).value.obj = (r); (*(__z)).u1.type_info = (<span class="hljs-number"><span class="hljs-number">8</span></span> | ((<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br> 在这里，我第二次感到as愧。 我完全<code>zend_object*</code> ，将<code>zval*</code>推到<code>zend_object*</code>等待的地方，花了将近两天的时间查找错误。 <br><br> 谢谢大家科特林！  :) <br><br>  PS。 如果有一个善良的人能读懂我笨拙的英语并更正文档，那么我的感激之情将无止境。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423145/">https://habr.com/ru/post/zh-CN423145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423135/index.html">程序员快乐日：几位儿童教育机器人设计师</a></li>
<li><a href="../zh-CN423137/index.html">GitHub浏览器扩展可提高您的工作效率</a></li>
<li><a href="../zh-CN423139/index.html">围墙，有效的经理和工程师</a></li>
<li><a href="../zh-CN423141/index.html">克劳德·香农（Claude Shannon）：天才如何解决问题</a></li>
<li><a href="../zh-CN423143/index.html">October Slerm：强化Kubernetes</a></li>
<li><a href="../zh-CN423147/index.html">关于Hadoop时代的存储策略和格式</a></li>
<li><a href="../zh-CN423149/index.html">直接比较激光近视矫正方法或选择ReLEx SMILE时需要支付的费用</a></li>
<li><a href="../zh-CN423151/index.html">PHP中的全局对象</a></li>
<li><a href="../zh-CN423153/index.html">Node.js指南，第2部分：JavaScript，V8，一些开发技巧</a></li>
<li><a href="../zh-CN423155/index.html">麻省理工学院的课程“计算机系统安全”。 讲座8：网络安全模型，第2部分</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>