<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòõ ‚òØÔ∏è ‚ÜñÔ∏è Formatage du code source de ClangFormat sous Linux: probl√®mes et solutions üï≥Ô∏è üßîüèø üëãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="D'accord, c'est agr√©able et utile lorsque le code source du projet est beau et coh√©rent. Cela facilite sa compr√©hension et son soutien. Nous vous mont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Formatage du code source de ClangFormat sous Linux: probl√®mes et solutions</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433832/"><img src="https://habrastorage.org/webt/bo/sx/sk/bosxskxlbpvscptb3sw0tmuhp_u.png"><br><br>  D'accord, c'est agr√©able et utile lorsque le code source du projet est beau et coh√©rent.  Cela facilite sa compr√©hension et son soutien.  Nous vous montrons et vous <em>expliquons</em> comment impl√©menter la mise en forme du code source √† l'aide de <em>clang-format</em> , <em>git</em> et <em>sh</em> . <br><a name="habracut"></a><br><h3>  Formater les probl√®mes et comment les r√©soudre </h3><br><p> Dans la plupart des projets, il existe certaines r√®gles de conception du code.  Comment s'assurer que tous les participants les ex√©cutent?  Des programmes sp√©ciaux viennent √† la rescousse - <em>format clang, astyle, peu cr√©dible</em> - mais ils ont leurs inconv√©nients. <br><br>  Le principal probl√®me avec les formateurs est qu'ils changent des fichiers entiers, pas seulement des lignes modifi√©es.  Nous allons vous expliquer comment nous avons g√©r√© cela, en utilisant ClangFormat dans le cadre de l'un des projets de d√©veloppement de micrologiciels pour l'√©lectronique, o√π C ++ √©tait le langage principal.  Plusieurs personnes travaillaient dans l'√©quipe, il √©tait donc important pour nous de fournir un style de code uniforme.  Notre solution peut convenir non seulement aux programmeurs C ++, mais aussi √† ceux qui √©crivent du code en C, Objective-C, JavaScript, Java, Protobuf. <br><br>  Pour le formatage, nous avons utilis√© <em>clang-format-diff-6.0</em> .  Au d√©but, ils ont commenc√© l'√©quipe <br><br>  <em>git diff -U0 - pas de couleur |</em>  <em>clang-format-diff-6.0 -i -p1</em> , mais il y a eu des probl√®mes: <br></p><br><ol><li>  Le programme a d√©termin√© les types de fichiers uniquement par extension.  Par exemple, les fichiers avec l'extension ts, que nous avions au format xml, ont √©t√© per√ßus comme JavaScript et se sont √©cras√©s lors du formatage.  Puis, pour une raison quelconque, elle a essay√© de corriger les fichiers pro des projets Qt, probablement comme Protobuf. </li><li>  Le programme devait √™tre d√©marr√© manuellement avant d'ajouter des fichiers √† l'index git.  C'√©tait facile de l'oublier. </li></ol><br><h4>  Solution </h4><br>  Le r√©sultat √©tait le sh-script suivant, ex√©cut√© en tant que <em>pr√©-commit</em> - hook pour git: <br><br><pre><code class="cpp hljs">#!/bin/sh CLANG_FORMAT=<span class="hljs-string"><span class="hljs-string">"clang-format-diff-6.0 -p1 -v -sort-includes -style=Chromium -iregex '.*\.(cxx|cpp|hpp|h)$' "</span></span> GIT_DIFF=<span class="hljs-string"><span class="hljs-string">"git diff -U0 --no-color "</span></span> GIT_APPLY=<span class="hljs-string"><span class="hljs-string">"git apply -v -p0 - "</span></span> FORMATTER_DIFF=$(eval ${GIT_DIFF} --staged | eval ${CLANG_FORMAT}) echo <span class="hljs-string"><span class="hljs-string">"\n------Format code hook is called-------"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"Nothing to be formatted"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> echo <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> | eval ${GIT_APPLY} --cached echo <span class="hljs-string"><span class="hljs-string">" ---Format of staged area completed. Begin format unstaged files---"</span></span> eval ${GIT_DIFF} | eval ${CLANG_FORMAT} | eval ${GIT_APPLY} fi echo <span class="hljs-string"><span class="hljs-string">"------Format code hook is completed----\n"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Ce que fait le script: <br>  <b>GIT_DIFF = "git diff -U0 --no-color"</b> - changements dans le code qui sera entr√© dans <i>clang-format-diff-6.0.</i> <br><br><ul><li>  <strong>-U0</strong> : g√©n√©ralement git diff affiche le soi-disant ¬´contexte¬ª: quelques lignes de code inchang√©es autour de celles qui ont √©t√© modifi√©es.  Mais <em>clang-format-diff-6.0 les</em> formate aussi!  Par cons√©quent, le contexte dans ce cas n'est pas n√©cessaire. </li></ul><br>  <b>CLANG_FORMAT = "clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (Cxx | cpp | hpp | h) $'"</b> - une commande de formatage de diff re√ßue via la norme entr√©e. <br><br><ul><li>  <strong>clang-format-diff-6.0</strong> - un script du <em>package clang-format-6.0</em> .  Il existe d'autres versions, mais tous les tests √©taient uniquement sur celle-ci. </li><li>  <strong>-p1</strong> extrait des exemples de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , fournit la compatibilit√© avec la sortie <em>git diff</em> . </li><li>  <strong>-style = Chrome</strong> - pr√©d√©fini de style de format de code pr√™t √† l'emploi.  Autres valeurs possibles: <em>LLVM, Google, Mozilla, WebKit</em> . <br></li><li>  <strong>-sort-includes</strong> - option pour trier alphab√©tiquement les directives <em>#include</em> (facultatif). </li><li>  <strong>-iregex '. * \. (cxx | cpp | hpp | h) $'</strong> est une expression r√©guli√®re qui filtre les noms de fichiers par extension.  Seules les extensions qui doivent √™tre format√©es sont r√©pertori√©es ici.  Cela √©vitera au programme de tomber et de p√©pins inattendus.  Il est fort probable que la liste devra √™tre compl√©t√©e dans de nouveaux projets.  En plus de C ++, vous pouvez formater <em>C / Objective-C / JavaScript / Java / Protobuf</em> .  Bien que nous n'ayons pas test√© ces types de fichiers. </li></ul><br>  <strong>GIT_APPLY = "git apply -v -p0 -"</strong> - applique le correctif √©mis par la commande pr√©c√©dente au code. <br><br><ul><li>  <strong>-p0</strong> : par d√©faut, <em>git apply</em> ignore le premier composant du chemin du fichier, ce n'est pas compatible avec le format produit par <em>clang-format-diff-6.0</em> .  Ce saut est d√©sactiv√© ici. </li></ul><br>  <strong>FORMATTER_DIFF = $ (eval $ {GIT_DIFF} --staged | eval $ {CLANG_FORMAT})</strong> - modifications du formateur pour l'index. <br><br>  <strong>echo "$ {FORMATTER_DIFF}" |</strong>  <strong>eval $ {GIT_APPLY} --cached</strong> formate le code source dans l'index (apr√®s <em>git add</em> ).  Malheureusement, aucun hook ne fonctionne avant d'ajouter des fichiers √† l'index.  Par cons√©quent, la mise en forme est divis√©e en deux parties: la mise en forme de ce qui est dans l'index et s√©par√©ment ce qui n'est pas ajout√© √† l'index. <br><br>  <strong>eval $ {GIT_DIFF} |</strong>  <strong>eval $ {CLANG_FORMAT} |</strong>  <strong>eval $ {GIT_APPLY}</strong> - le formatage du code n'est pas dans l'index (il ne d√©marre que lorsque quelque chose a √©t√© format√© dans l'index).  Formate en g√©n√©ral toutes les modifications en cours dans le projet (sous contr√¥le de version), et pas seulement √† partir de l'√©tape pr√©c√©dente.  Il s'agit d'une d√©cision controvers√©e, √† premi√®re vue.  Mais cela s'est av√©r√© pratique, car  t√¥t ou tard, d'autres modifications doivent √©galement √™tre format√©es.  Vous pouvez remplacer <em>"| eval $ {GIT_APPLY}"</em> par l'option <em>-i</em> , ce qui forcera <em>$ {CLANG_FORMAT}</em> √† modifier les fichiers eux-m√™mes. <br><br><h3>  D√©monstration de travail </h3><br><ol><li>  Installez <em>clang-format-6.0</em> <br></li><li>  <strong>cd / tmp &amp;&amp; mkdir temp_project &amp;&amp; cd temp_project</strong> <br></li><li>  <strong>git init</strong> <br></li><li>  Ajoutez le contr√¥le de version et validez n'importe quel fichier C ++ sous le nom <em>false.cpp</em> .  De pr√©f√©rence&gt; 50 lignes de code non format√©. <br></li><li>  Cr√©ez le <em>script .git / hooks / pre-commit</em> illustr√© ci-dessus. <br></li><li>  Attribuez le droit d'ex√©cuter le script (pour git): <strong>chmod + x .git / hooks / pre-commit</strong> . <br></li><li>  Ex√©cutez le script <strong>.git / hooks / pre-commit</strong> manuellement, il doit √™tre ex√©cut√© avec le message <em>"Rien √† formater"</em> , sans erreurs d'interpr√©teur. <br></li><li>  Cr√©ez <em>file.cpp</em> avec le contenu <em>int main () {for (int i = 0; i &lt;100; ++ i) {std :: cout &lt;&lt; "First case" &lt;&lt; std :: endl;</em>  <em>std :: cout &lt;&lt; "Deuxi√®me cas" &lt;&lt; std :: endl;</em>  <em>std :: cout &lt;&lt; "Troisi√®me cas" &lt;&lt; std :: endl;</em>  <em>}} avec</em> une ligne ou avec une autre mise en forme incorrecte.  Au bout du fil! <br></li><li>  <strong>git add file.cpp &amp;&amp; git commit -m "file.cpp"</strong> devrait √™tre des messages d'un script comme <em>"Patch file.cpp appliqu√© sans erreur"</em> . <br></li><li>  <strong>git log -p -1</strong> devrait montrer l'ajout d'un fichier format√©. <br></li><li>  Si <em>file.cpp est</em> entr√© dans le commit vraiment format√©, vous ne pouvez tester le formatage qu'en diff.  Modifiez la paire de lignes <em>incorrectes.cpp</em> afin que le formateur y <em>r√©ponde</em> .  Par exemple, ajoutez une indentation inad√©quate dans votre code avec d'autres modifications.  <strong>git commit -a -m "Format only diff"</strong> devrait remplir les modifications format√©es, mais n'affecte pas les autres parties du fichier. <br></li></ol><br><h3>  Inconv√©nients et probl√®mes </h3><br>  <em>git diff --staged</em> (qui est ici <em>$ {GIT_DIFF} --staged</em> ) diff√®re uniquement les fichiers qui ont √©t√© ajout√©s √† l'index.  Et <em>clang-format-diff-6.0</em> acc√®de aux versions compl√®tes des fichiers en dehors de celui-ci.  Par cons√©quent, si vous modifiez un fichier, faites <em>git add</em> , puis modifiez le m√™me fichier, alors <em>clang-format-diff-6.0</em> g√©n√©rera un correctif pour formater le code (dans l'index) en fonction d'un fichier diff√©rent.  Ainsi, il est pr√©f√©rable de ne pas modifier le fichier apr√®s <em>git add</em> et avant de valider. <br><br>  Voici un exemple d'une telle erreur: <br><p></p><ol><li>  Ajoutez <em>std :: endl</em> suppl√©mentaire √† <em>file.cpp</em> , <em>"Second case"</em> .  <em>(std :: cout &lt;&lt; "Second case" &lt;&lt; std :: endl &lt;&lt; std :: endl;)</em> et quelques onglets d'indentation suppl√©mentaire avant la ligne. <br></li><li>  <strong>git add file.cpp</strong> </li><li>  Effacez la ligne (dans le m√™me fichier) avec <em>"Premier cas"</em> afin que seul le saut de ligne reste √† sa place (!). </li><li>  <strong>git commit -m "Erreur de formatage lors de la validation"</strong> . </li></ol><br>  Le script doit signaler <em>"erreur: lors de la recherche:"</em> , c'est-√†-dire  <em>git apply</em> n'a pas trouv√© le contexte du patch √©mis par <em>clang-format-diff-6.0</em> .  Si vous ne comprenez pas quel est le probl√®me ici, ne modifiez pas les fichiers apr√®s les avoir <em>ajout√©s par git</em> et avant de les <em>valider</em> .  Si vous devez changer, vous pouvez valider (sans push) puis <em>git commit --amend</em> avec de nouvelles modifications. <br><br><p>  La limitation la plus s√©rieuse est la n√©cessit√© d'avoir un saut de ligne √† la fin de chaque fichier.  Il s'agit d'une ancienne fonctionnalit√© git, donc la plupart des √©diteurs de code prennent en charge l'insertion automatique d'une telle traduction √† la fin du fichier.  Sans cela, le script plantera lors de la validation d'un nouveau fichier, mais il ne fera aucun mal. </p><br><p>  Tr√®s rarement, <em>clang-format-diff-6.0</em> formate le code de mani√®re inappropri√©e.  Dans ce cas, vous pouvez ajouter des √©l√©ments inutiles au code, comme un point-virgule.  Ou, entourez le code probl√©matique de commentaires, <em>/ * format clang d√©sactiv√© * /</em> et <em>/ * format clang activ√© * /</em> . <br></p><br><p>  De plus, <em>clang-format-diff-6.0</em> peut produire un correctif inad√©quat.  Cela finit par <em>git apply</em> ne pas l'accepter, et le code de la partie commit reste non format√©.  La raison en est √† l'int√©rieur de <em>clang-format-diff</em> .  Il n'y a pas de temps pour comprendre toutes les erreurs de programme.  Dans ce cas, vous pouvez consulter le correctif de formatage √† l'aide de la commande <strong>git diff -U0 --no-color HEAD ^ |</strong>  <strong>clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (cxx | cpp | hpp | h) $'</strong> .  La solution la plus simple consiste √† ajouter l'option -i √† la commande pr√©c√©dente.  Dans ce cas, l'utilitaire n'√©mettra pas de correctif, mais formatera le code.  Si cela ne vous aide pas, vous pouvez essayer de formater des fichiers individuels enti√®rement <strong>clang-format-6.0 -i -sort-includes -style = Chromium file.cpp</strong> .  Viennent ensuite <strong>git add file.cpp</strong> et <strong>git commit --amend</strong> . <br><br>  Il est <em>suppos√©</em> que plus votre configuration au <em>format .clang est</em> proche de l'un des pr√©r√©glages, moins vous verrez de telles erreurs.  (Ici, il est remplac√© par l'option <em>-style = Chromium</em> ). <br></p><br><h3>  D√©bogage </h3><br>  Si vous voulez voir quels changements le script apportera sur vos modifications actuelles (pas dans l'index), utilisez <strong>git diff -U0 --no-color |</strong>  <strong>clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (cxx | cpp | hpp | h) $'</strong> Vous pouvez √©galement v√©rifier le fonctionnement du script sur les derni√®res validations, par exemple , √† trente ans: <strong>git filter-branch -f --tree-filter "$ {PWD} /. git / hooks / pre-commit" --prune-empty HEAD ~ 30..HEAD</strong> .  Cette commande devrait avoir format√© les validations pr√©c√©dentes, mais en fait, seul leur identifiant change.  Par cons√©quent, cela vaut la peine de mener de telles exp√©riences dans une copie s√©par√©e du projet!  Apr√®s, elle devient inutilisable. <br><br><h3>  Conclusion </h3><br>  Subjectivement, une telle d√©cision est beaucoup plus bonne que nuisible.  Mais vous devez tester le comportement de <em>clang-format-diff de</em> diff√©rentes versions sur le code de votre projet, avec une configuration pour votre style de code. <br><br>  Malheureusement, nous n'avons pas fait le m√™me git-hook pour Windows.  Sugg√©rez dans les commentaires comment y faire.  Et si vous avez besoin d'un article pour un d√©marrage rapide avec le <em>format clang</em> , nous vous recommandons de consulter la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">description de ClangFormat</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433832/">https://habr.com/ru/post/fr433832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433822/index.html">Guide CMake complet. Troisi√®me partie: essais et emballage</a></li>
<li><a href="../fr433824/index.html">Habro suicide. Pourquoi les programmeurs 1C sauveront le monde</a></li>
<li><a href="../fr433826/index.html">Persimmon 2.0 Instructions d'utilisation</a></li>
<li><a href="../fr433828/index.html">Utilisation de la carte QML pour cr√©er des voies a√©riennes - Partie 1</a></li>
<li><a href="../fr433830/index.html">Nouvelles lampes LED Diall</a></li>
<li><a href="../fr433834/index.html">Comme l'a fait Ivan Metrics DevOps. Commencer</a></li>
<li><a href="../fr433836/index.html">Octet-machine pour le fort (et pas seulement) en am√©rindien (partie 2)</a></li>
<li><a href="../fr433838/index.html">Lettre publique de Joshua Zayner sur le biohacker</a></li>
<li><a href="../fr433842/index.html">[Vendredi] Graffiti ASCII sur moniteurs r√©tro et autres surfaces</a></li>
<li><a href="../fr433844/index.html">√Ä propos des trois composants n√©cessaires au bon fonctionnement de l'informatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>