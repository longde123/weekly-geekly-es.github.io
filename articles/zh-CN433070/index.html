<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⬅️ 🧘 🍟 如何从香菇中区分洗发水，从香槟中区分烤串... Elasticsearch-在商店数据库中搜索产品 🐫 👨‍👨‍👧‍👧 ✡️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="挑战赛 


用于存储和分析购买的应用程序的主要任务之一是在数据库中搜索相同或非常接近的产品，该数据库包含从收据中获得的各种且难以理解的产品名称。 有两种类型的输入请求： 


1. 带缩写的特定名称，只有本地超市的收银员或狂热的买家才能理解。 
2. 用户在搜索字符串中输入的自然语言查询。 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何从香菇中区分洗发水，从香槟中区分烤串... Elasticsearch-在商店数据库中搜索产品</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433070/"><h1 id="zadacha"> 挑战赛 </h1><br><p>用于存储和分析购买的应用程序的主要任务之一是在数据库中搜索相同或非常接近的产品，该数据库包含从收据中获得的各种且难以理解的产品名称。 有两种类型的输入请求： </p><br><ol><li> 带缩写的特定名称，只有本地超市的收银员或狂热的买家才能理解。 </li><li> 用户在搜索字符串中输入的自然语言查询。 </li></ol><br><p> 通常，当用户需要寻找更便宜的产品时，第一类要求来自支票本身的产品。 我们的任务是从附近其他商店的支票中选择最相似的产品类似物。 选择最合适的产品品牌，如果可能的话，数量也很重要。 </p><br><p><img src="https://habrastorage.org/webt/yp/_d/ny/yp_dnyvhrlrrrr6v0pa_6sz_ibk.jpeg"></p><a name="habracut"></a><br><p> 第二类请求是一个简单的用户请求，用于在最近的商店中搜索特定产品。 该请求可以是产品的非常笼统的，非唯一的描述。 可能与要求略有差异。 例如，如果用户搜索3.2％的牛奶，而在我们的数据库中仅搜索2.5％的牛奶，那么我们仍然希望至少显示此结果。 </p><br><p><img src="https://habrastorage.org/webt/ar/0-/03/ar0-03doeo4rgkrbni26iz9rek4.jpeg"></p><br><h1 id="osobennosti-dataseta--problemy-dlya-resheniya"> 要素数据集-要解决的问题 </h1><br><p> 产品收据中的信息远非理想。 它有很多不总是很清楚的缩写，语法错误，错字，各种翻译，西里尔字母中间的拉丁字母和字符集，这些字符仅对特定商店的内部组织有意义。 <br> 例如，可以很容易地在支票上写上一个带有干酪的婴儿苹果香蕉泥： </p><br><p><img src="https://habrastorage.org/webt/kv/gg/23/kvgg23lcyv2h5gulck5k_9x1a-s.jpeg"></p><cut></cut><br><h1 id="o-tehnologii"> 关于技术 </h1><br><p>  Elasticsearch是一种相当流行且价格合理的技术，用于实现搜索。 这是一个使用Lucene并以Java编写的JSON REST API搜索引擎。  Elastic的主要优点是速度，可伸缩性和容错能力。 类似的引擎用于在文档数据库中进行复杂的搜索。 例如，考虑语言形态的搜索或按地理坐标搜索。 </p><br><h1 id="napravleniya-dlya-eksperimentov-i-uluchsheniy"> 实验和改进的方向 </h1><br><p> 要了解如何改进搜索，您需要将搜索系统解析为其组件自定义组件。 对于我们的情况，系统的结构如下所示。 </p><br><ol><li> 用于搜索的输入字符串通过分析器，该分析器以某种方式将字符串分成令牌-搜索单元在也存储为令牌的数据中进行搜索。 </li><li> 然后直接在现有数据库中为每个文档搜索这些标记。 在某个文档中找到令牌（该令牌也作为令牌集在数据库中显示）后，根据所选的相似性模型（我们将其称为相关性模型）计算其相关性。 这可以是简单的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TF / IDF</a> （术语频率-反向文档频率），也可以是其他更复杂或特定的模型。 </li><li> 在下一个阶段，将以某种方式汇总每个单独令牌所获得的分数。 聚合参数由查询语义设置。 此类聚合的示例可以是某些令牌的附加权重（附加值），令牌强制存在的条件等。 该阶段的结果是评分-对数据库中特定文档相对于初始请求的相关性的最终评估。 </li></ol><br><p><img src="https://habrastorage.org/webt/_u/yg/zp/_uygzp1ohyyhtksrfuwbfvmi3r0.jpeg"></p><br><p> 可以从搜索设备中区分出三个可单独配置的组件，您可以在每个组件中突出显示自己的改进方式和方法。 </p><br><ol><li> 分析仪 </li><li> 相似模型 </li><li> 查询时间改进 </li></ol><br><p> 接下来，我们将分别考虑每个组件，并分析特定的参数设置，这些参数设置有助于改进产品名称的搜索。 </p><br><h3 id="query-time-uluchsheniya"> 查询时间改进 </h3><br><p> 为了了解我们可以在请求中进行哪些改进，我们以初始请求为例。 </p><br><pre><code class="sql hljs">{ "query": { "multi_match": { "query": "  105", "type": "most_fields", "fields": ["name"], "minimum_should_match": "70%" } }, “size”: 100, “min_score”: 15 }</code> </pre> <br><p> 因为我们预见到“产品名称”字段需要使用多个分析器的组合，所以我们使用most_fields查询类型。 这种类型的查询使您可以组合搜索结果，以不同方式分析包含相同文本的对象的不同属性。 此方法的替代方法是使用best_fields或cross_fields查询，但它们不适合我们的情况，因为搜索是在对象的各种属性（例如名称和描述）之间进行计算的。 我们面临着一项任务，即要考虑一个属性的各个方面-产品名称。 </p><br><p> 可以配置什么： </p><br><ul><li> 不同分析仪的加权组合。 <br> 最初，所有搜索元素都具有相同的权重-因此具有相同的重要性。 可以通过添加带有数值的参数“ boost”来更改此设置。 如果参数大于1，则搜索元素对结果的影响分别小于1-小于1。 </li><li> 将分析器分为“应该”和“必须”。 <br> 即，某些分析器必须重合，而某些是可选的，即不足。 在我们的案例中，数字分析器可以是这种分离的好处的一个例子。 如果仅数字与请求中的产品名称与数据库中的产品名称匹配，则这不是等效的充分条件。 我们不想看到这样的产品。 同时，如果要求“奶油10％”，那么我们希望所有脂肪含量10％的奶油都比脂肪含量20％的奶油具有更大的优势。 </li><li>  minimum_should_match参数。 请求和数据库中的文档中必须匹配多少个令牌？ 此参数与请求的类型（most_fields）一起使用，并检查每个字段（在本例中是每个分析器）的最小匹配令牌数。 </li><li>  Min_score参数。 阈值筛选文件的分数不足。 问题是没有已知的最大速度。 结果分数取决于特定的请求和特定的文档数据库。 有时可以是150，有时是2，但是这两个值都意味着数据库中的对象与请求有关。 我们无法比较不同查询结果的分数。 <br><ul><li> 不变的 <br> 充分监视不同查询的速度的最终值后，您可以确定一个近似边界，此后对于大多数查询，结果将变得不合适。 这是最简单但也是最愚蠢的决定，从而导致搜索质量低下。 </li><li> 在以最小或零的min_score执行搜索后，尝试分析针对特定请求获得的分数。 <br> 这个想法是，经过一会儿，您可以观察到速度下降方向的急剧跳跃。 剩下的只是确定该跳跃以便及时停止。 这种方法在类似的查询上会很好地工作： <br><img src="https://habrastorage.org/webt/9z/qo/-u/9zqo-uovb_75ytduyti4byhmeyo.png"><br> 可以通过统计方法找到跳跃。 但是，不幸的是，并非所有请求都存在此跳转，并且很容易识别。 </li><li> 计算理想速度，并将min_score设置为理想速度的一部分，这可以通过两种方式完成： <br><ul><li> 根据Elastic自己在设置explain：true参数时提供的计算的详细描述。 这是一项艰巨的任务，需要彻底了解Elastic所使用的查询体系结构和计算算法。 </li><li> 通过一点技巧。 我们收到一个请求，将一个具有相同名称的新产品添加到我们的数据库中，进行搜索并获得最快的速度。 由于名称中将有100％匹配，因此结果值将是理想的。 我们尚未在系统中使用此方法，因为尚未确认此操作相对于时间的高成本。 </li></ul></li></ul></li><li> 更改负责最终相关性值的评分算法。 这可能是在考虑到商店的距离（对靠近的产品给予更多的积分），产品价格（对价格最可能的产品给予更多的积分）等。 </li></ul><br><h3 id="analizatory"> 分析仪 </h3><br><p> 分析器分三个阶段分析输入字符串，并在输出-搜索单元中输出令牌： </p><br><p><img src="https://habrastorage.org/webt/cd/vc/u8/cdvcu8tw-9wsrgelal2ii0waeio.jpeg"></p><br><p> 首先，更改发生在字符串的字符级别。 可以替换，删除字符或将字符添加到字符串。 然后，分词器开始工作，该分词器用于将字符串拆分为令牌。 标准令牌生成器根据标点符号将字符串拆分为令牌。 在最后一步，对接收到的令牌进行过滤和处理。 </p><br><p> 考虑在我们的案例中哪些步骤的变体变得有用。 </p><br><h5 id="char-filters"> 字符过滤器 </h5><br><ul><li> 根据俄语的具体情况，处理诸如th和e之类的字符并将它们分别替换为and和e会很有用。 </li><li> 执行音译-将一个书写字符转换为另一个书写字符。 在我们的案例中，这是对用拉丁字母书写或与两个字母混合的名称的处理。 可以使用插件（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ICU Analysis Plugin</a> ）作为令牌过滤器来实现音译（也就是说，它不处理原始字符串，而是处理最终令牌）。 我们决定编写音译，因为我们对插件中的算法不太满意。 这个想法是首先替换出现的四个字符集（例如“ SHCH =&gt; u”），然后替换出现的三个字符，依此类推。使用符号过滤器的顺序很重要，因为结果将取决于顺序。 </li><li> 用俄语p替换被西里尔字母包围的拉丁字母c。 在分析了数据库中的名称之后，确定了对此的需要-西里尔语中的很多名称都包括拉丁文c，这意味着西里尔文c。 如果名称完全是拉丁文，则拉丁文C表示西里尔字母k或c。 因此，在音译之前，必须替换字符c。 </li><li> 从名称中删除太大的数字。 有时在产品名称中会有一个内部标识号（例如3387522 K.Ts. Maslo podsoln.raf。0.9l），在一般情况下没有任何意义。 </li><li> 用句点代替逗号。 为什么需要这个？ 因此，数字（例如牛奶3.2和3.2的脂肪含量）是等效的 </li></ul><br><h5 id="tokenizer"> 分词器 </h5><br><ul><li> 标准令牌生成器-根据空格和标点符号分隔行（例如，“ twix extra 2”-&gt;“ twix”，“ extra”，“ 2”） </li><li>  EdgeNGram标记器-将每个单词分成给定长度（通常是数字范围）的标记，从第一个字符开始（例如，对于N = [3，6]：“额外增加2个数字”-&gt;“ twee”，“ tweak”， “ Twix”，“ ex”，“ ext”，“ ext”，“ extra”） </li><li> 数字标记器-通过搜索正则表达式从字符串中仅选择数字（例如，“ twix extra 2 4.5”-&gt;“ 2”，“ 4.5”） </li></ul><br><h5 id="token-filter"> 令牌过滤器 </h5><br><ul><li> 小写过滤器 </li><li> 填塞过滤器-为每个令牌执行填塞算法。 词干是确定单词的初始形式（例如，“米”-&gt;“米”） </li><li> 语音分析。 为了最大程度地减少拼写错误和以相同方式写相同单词对搜索结果的影响，这是必要的。 下表显示了用于语音分析的各种可用算法以及在有问题的情况下其工作的结果。 在第一种情况（洗发水/香槟/香菇/香菇）中，成功的产生取决于不同编码的产生，其余情况相同。 </li></ul><br><p><img src="https://habrastorage.org/webt/gi/oi/x6/gioix68jytjyfxexdt3pvjpatze.png"></p><br><h3 id="similarity-model"> 相似模型 </h3><br><p> 需要相关性模型以确定一个令牌的重合在多大程度上影响数据库中对象相对于请求的相关性。 假设请求中的令牌与数据库中的产品相匹配-这当然不错，但是它几乎没有说明产品与请求的一致性。 因此，不同令牌的重合携带不同的值。 为了考虑到这一点，需要相关模型。  Elastic提供了许多不同的模型。 如果您真的了解它们，则可以针对特定情况选择非常具体且合适的模型。 选择可以基于经常使用的单词的数量（例如相同的标记），对长标记的重要性的评估（越长意味着更好？更糟糕？没关系吗？），我们希望最后看到什么结果等。  Elastic中提出的模型的示例可以是TF-IDF（最简单和最容易理解的模型）， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Okapi BM25</a> （增强的TF-IDF，默认模型），随机性发散，独立性发散等。 每个模型还具有可自定义的选项。 在对该模型进行多次实验后，Okapi BM25默认模型显示出最佳结果，但参数与预定义的参数不同。 </p><br><h1 id="ispolzovanie-kategoriy"> 使用类别 </h1><br><p> 在进行搜索的过程中，可以获得有关该产品的非常重要的附加信息-其类别-。 您可以在本文中了解有关我们如何实现分类的更多信息， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">据我了解，我吃了很多糖果，或者通过在应用程序中检查来对商品进行分类</a> 。 在此之前，我们仅基于产品名称的比较进行搜索，现在已经可以在数据库中比较请求和产品的类别。 <br> 使用此信息的可能选项是在类别字段中进行强制匹配（格式为结果过滤器），具有匹配类别的商品以点的形式（如数字）的附加优势以及按类别对结果进行排序（首先进行匹配，然后进行所有其他匹配）。 对于我们的情况，最后一个选项效果最好。 这是因为我们的分类算法太好了，无法使用第二种方法，而又不足以使用第一种方法。 我们对算法有足够的信心，并希望类别匹配是一大优势。 如果在速度上添加其他点（第二种方法），则具有相同类别的商品将排在列表的上方，但仍会输给某些名称更匹配的商品。 但是，第一种方法也不适合我们，因为分类仍然有可能出错。 有时，该请求可能包含的信息不足，无法正确确定类别，或者在用户的直接半径内，该类别中的产品太少。 在这种情况下，我们仍要显示具有不同类别的结果，但仍按产品名称显示。 <br> 第二种方法也很好，因为它不会因搜索而“破坏”产品的速度，并且使您可以继续使用计算出的最小速度而没有障碍。 <br> 在最终查询中可以看到排序的具体实现。 </p><br><h1 id="finalnaya-model"> 最终模型 </h1><br><p> 最终搜索模型的选择包括各种搜索引擎的生成，评估和比较。 通常，比较是基于其中一个参数进行的。 假设在一种特定情况下，我们需要为edgeNgram令牌生成器计算最佳大小（即，选择N的最有效范围）。 为此，我们生成了相同的搜索引擎，但此范围的大小只有一个差异。 之后，可以确定该参数的最佳值。 <br> 使用nDCG（归一化折现累积收益）度量标准评估模型，该度量标准用于评估排名质量。 将预定义的查询发送到每个搜索模型，然后根据接收到的搜索结果计算nDCG指标。 <br> 进入最终模型的分析器： </p><br><p><img src="https://habrastorage.org/webt/nb/-m/ti/nb-mtitufklquryy-5o3m2trrl4.jpeg"></p><br><p><img src="https://habrastorage.org/webt/5n/y3/6g/5ny36gkpfblbdtr5xvu8b4fx_r4.jpeg"></p><br><p><img src="https://habrastorage.org/webt/2r/er/zv/2rerzvbqvsdgezshkhpfeds2mc0.jpeg"></p><br><p><img src="https://habrastorage.org/webt/5h/tv/69/5htv691pabkoks90jq08h6nmdxo.jpeg"></p><br><p> 相关参数选择参数b = 0.5的默认模型（Okapi-BM25）。 默认值为0.75。 此参数显示产品名称的长度在多大程度上标准化了tf（术语频率）变量。 在我们的情况下，较小的数字效果更好，因为长名称通常不会影响单个单词的含义。 也就是说，名称“巧克力”和“碎榛子巧克力装25包”的名称不会因其名称足够长而失去其价值。 </p><br><p> 最终查询如下所示： </p><br><p><img src="https://habrastorage.org/webt/ol/9y/5n/ol9y5nfbppfwyxhqaskziiypuru.jpeg"></p><br><p> 通过实验，揭示了分析仪和砝码的最佳组合。 </p><br><p> 排序的结果是，具有相同类别的产品转到结果的开头，然后转到所有其他内容。 按点数（速度）排序存储在每个子集中。 </p><br><p> 为简单起见，在此请求中将速度阈值设置为15，尽管在我们的系统中我们使用了前面所述的计算参数。 </p><br><h1 id="v-buduschem"> 将来 </h1><br><p> 有一些想法可以解决我们算法中最令人尴尬的问题之一，那就是存在一百万种和一种缩短5个字母的单词的不同方法来改善搜索效果。 可以通过名称的初始处理来解决它，以显示缩写。 解决此问题的一种方法是尝试将数据库中的缩写名称与数据库中具有“正确”全名的名称之一进行比较。 这一决定遇到了明确的障碍，但似乎是一个有希望的改变。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN433070/">https://habr.com/ru/post/zh-CN433070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN433058/index.html">五重奏是描述主题领域的基本实体</a></li>
<li><a href="../zh-CN433060/index.html">为什么我不相信微基准测试</a></li>
<li><a href="../zh-CN433062/index.html">AXIS P1367与IDIS DC-B3303X：比较CCTV摄像机</a></li>
<li><a href="../zh-CN433064/index.html">事件管理：“您不能放弃”或放置逗号的技巧</a></li>
<li><a href="../zh-CN433066/index.html">高负荷杯＃2。 后端开发人员重新投入使用的冠军</a></li>
<li><a href="../zh-CN433072/index.html">如何破解Sega Dreamcast控制台复制保护</a></li>
<li><a href="../zh-CN433074/index.html">在Android项目中切换到Kotlin：提示和技巧</a></li>
<li><a href="../zh-CN433076/index.html">我们如何制作Android Gallery库以查看媒体内容</a></li>
<li><a href="../zh-CN433078/index.html">我们使用StockSharp图形框架编写交易机器人。 第二部分</a></li>
<li><a href="../zh-CN433082/index.html">抽走他人的帐户已成为韩国的刑事犯罪</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>