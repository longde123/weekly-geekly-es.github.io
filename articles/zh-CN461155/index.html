<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤵🏼 💘 👩🏿‍⚕️ 慈善云：迁移指南 🚈 🎫 👩‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="不久前，Mail.Ru云解决方案（MCS）和Welcome Mail.Ru服务启动了Cloud for Charity Foundations项目，这使得非营利组织可以免费获得MCS云平台资源。 善意慈善基金会参与了该项目，并成功部署了基于MCS的部分基础架构。 

 验证之后，NPO可以从MCS接...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>慈善云：迁移指南</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/461155/"><img src="https://habrastorage.org/webt/z_/wc/we/z_wcwe5eqwz8ndq8g4jsdakds_q.jpeg"><br><br> 不久前，Mail.Ru云解决方案（MCS）和Welcome Mail.Ru服务启动了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cloud for Charity Foundations</a>项目，这使得非营利组织可以免费获得MCS云平台资源。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">善意</a>慈善基金会参与了该项目，并成功部署了基于MCS的部分基础架构。 <br><br> 验证之后，NPO可以从MCS接收虚拟电源，但是进一步的调整需要一定的资格。 在本文中，我们希望共享特定的说明，以使用免费的SSL证书为主要基金网站和许多子域设置基于Ubuntu Linux的服务器。 对于许多人来说，这将是一个简单的指南，但是我们希望我们的经验不仅对其他非营利组织有用。 <br><a name="habracut"></a><br><blockquote>  <b>仅供参考</b> ：我可以从MCS那里得到什么？  4个CPU，32 GB RAM，1 TB HDD，Ubuntu Linux OS，500 GB对象存储。 </blockquote><br><h2> 步骤1：启动虚拟服务器 </h2><br> 让我们立即开始工作，并在您的个人MCS帐户中创建我们的虚拟服务器（也称为“实例”）。 在应用程序商店中，您需要选择并安装一个现成的LAMP堆栈，它是服务器软件（LAMP = Linux，Apache，MySQL，PHP）的组合，这是启动大多数网站所必需的。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5d/93d/178/b5d93d1782388ebd587829d84a008aa5.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0eb/ed2/9ab/0ebed29ab326affe50d91d5202d38754.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/662/781/dd9/662781dd94c321c69c9387d1007f744e.png"></div><br> 为服务器选择适当的配置，然后创建一个新的SSH密钥。 单击“安装”按钮后，服务器和LAMP堆栈将开始安装，这将需要一些时间。 系统还将提供将私钥下载到计算机以通过控制台控制虚拟机并将其保存的功能。 <br><br> 安装应用程序后，让我们立即配置防火墙，这也可以在您的个人帐户中完成：转到“云计算-&gt;虚拟机”部分，然后选择“配置防火墙”项： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9b9/2f1/b65/9b92f1b65d57f871e3c02c8d21852982.png"></div><br> 您需要为通过端口80和9997的传入流量添加权限。 将来有必要安装SSL证书并与phpMyAdmin一起使用。 最后，规则集应如下所示： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b88/a71/623/b88a7162366be236441488f4f5e3539d.png"></div><br> 现在，您可以使用SSH协议通过命令行连接到服务器。 为此，请键入以下命令，指向计算机上的SSH密钥和服务器的外部IP地址（您可以在“虚拟机”部分中找到它）： <br><br><pre><code class="bash hljs">$ ssh -i ////key.pem ubuntu@&lt;ip_&gt;</code> </pre> <br> 在第一次连接服务器期间，建议在其上安装所有当前更新并重新启动它。 为此，请运行以下命令： <br><br><pre> <code class="plaintext hljs">$ sudo apt-get update</code> </pre> <br> 系统将收到更新列表，使用此命令安装更新并按照说明进行操作： <br><br><pre> <code class="plaintext hljs">$ sudo apt-get upgrade</code> </pre> <br> 安装更新后，重新启动服务器： <br><br><pre> <code class="plaintext hljs">$ sudo reboot</code> </pre> <br><h2> 步骤2：配置虚拟主机 </h2><br> 许多NPO需要同时包含多个域或子域（例如，主站点和用于促销活动的多个登录页面等）。 通过创建多个虚拟主机，所有这些都可以方便地托管在单个服务器上。 <br><br> 首先，我们需要为将要显示给访问者的网站创建目录结构。 让我们创建一些目录： <br><br><pre> <code class="plaintext hljs">$ sudo mkdir -p /var/www/a-dobra.ru/public_html</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo mkdir -p /var/www/promo.a-dobra.ru/public_html</code> </pre> <br> 并指出当前用户的所有者： <br><br><pre> <code class="plaintext hljs">$ sudo chown -R $USER:$USER /var/www/a-dobra.ru/public_html</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo chown -R $USER:$USER /var/www/promo.a-dobra.ru/public_html</code> </pre> <br>  <code>$USER</code>变量包含当前登录用户的名称（默认情况下，这是<code>ubuntu</code>用户）。 现在，当前用户拥有将在其中存储内容的public_html目录。 <br><br> 我们还需要稍微修改权限，以确保允许对共享Web目录及其中包含的所有文件和文件夹进行读取访问。 为了使站点页面正确显示，这是必需的： <br><br><pre> <code class="plaintext hljs">$ sudo chmod -R 755 /var/www</code> </pre> <br> 您的Web服务器现在应该具有显示内容所必需的权限。 此外，您的用户现在可以在必要的目录中创建内容。 <br><br>  / var / www / html目录中已经有一个index.php文件，让我们将其复制到新目录中-这将是我们现在的内容： <br><br><pre> <code class="plaintext hljs">$ cp /var/www/html/index.php /var/www/a-dobra.ru/public_html/index.php</code> </pre> <br><pre> <code class="plaintext hljs">$ cp /var/www/html/index.php /var/www/promo.a-dobra.ru/public_html/index.php</code> </pre> <br> 现在，您需要确保用户可以进入您的网站。 为此，首先，我们将配置虚拟主机文件，这些文件将确定Apache Web服务器将如何准确响应对不同域的请求。 <br><br> 默认情况下，Apache有一个000-default.conf虚拟主机文件，我们可以以此为起点。 我们将复制它以为我们的每个域创建虚拟主机文件。 我们将从一个域开始，对其进行配置，将其复制到另一个域，然后再次进行必要的编辑。 <br><br>  Ubuntu的默认配置要求每个虚拟主机文件都具有* .conf扩展名。 <br><br> 让我们从复制第一个域的文件开始： <br><br><pre> <code class="plaintext hljs">$ sudo cp /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/a-dobra.ru.conf</code> </pre> <br> 使用root特权在编辑器中打开一个新文件： <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/apache2/sites-available/a-dobra.ru.conf</code> </pre> <br> 如下所示编辑数据，指示端口80，用于<code>ServerAdmin</code> ， <code>ServerName</code> ， <code>ServerAlias</code>数据以及站点根目录的路径，保存文件（按Ctrl + X，然后按Y）： <br><br><pre> <code class="bash hljs">&lt;VirtualHost *:80&gt; ServerAdmin e.valuisky@a-dobra.ru ServerName a-dobra.ru ServerAlias www.a-dobra.ru DocumentRoot /var/www/a-dobra.ru/public_html ErrorLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/error.log CustomLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/access.log combined &lt;Directory /var/www/a-dobra.ru/public_html&gt; Options -Indexes +FollowSymLinks +MultiViews AllowOverride All Require all granted &lt;/Directory&gt; &lt;FilesMatch \.php$&gt; SetHandler <span class="hljs-string"><span class="hljs-string">"proxy:unix:/var/run/php/php7.2-fpm.sock|fcgi://localhost/"</span></span> &lt;/FilesMatch&gt; &lt;/VirtualHost&gt;</code> </pre> <br>  <code>ServerName</code>设置主域，该域必须与虚拟主机的名称匹配。 这必须是您的域名。 第二个名称<code>ServerAlias</code>定义了其他名称，这些名称应被解释为主要域。 这对于使用其他域名（例如，使用www）非常方便。 <br><br> 我们将此配置复制到另一台主机，并以类似的方式对其进行编辑： <br><br><pre> <code class="plaintext hljs">$ sudo cp /etc/apache2/sites-available/a-dobra.ru.conf /etc/apache2/sites-available/promo.a-dobra.ru.conf</code> </pre> <br> 您可以为您的网站创建任意数量的目录和虚拟主机！ 现在我们已经创建了虚拟主机文件，我们需要包括它们。 我们可以使用a2ensite实用程序来启用我们的每个站点，如下所示： <br><br><pre> <code class="plaintext hljs">$ sudo a2ensite a-dobra.ru.conf</code> </pre> <br><pre> <code class="plaintext hljs">$ sudo a2ensite promo.a-dobra.ru.conf</code> </pre> <br> 默认情况下，LAMP中的端口80是关闭的，以后我们将需要它来安装SSL证书。 因此，让我们立即编辑ports.conf文件，然后重新启动Apache： <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/apache2/ports.conf</code> </pre> <br> 添加新行并保存文件，使其如下所示： <br><br><pre> <code class="plaintext hljs">Listen 80 Listen 443 Listen 9997</code> </pre> <br> 完成设置后，必须重新启动Apache才能使所有更改生效： <br><br><pre> <code class="plaintext hljs">$ sudo systemctl reload apache2</code> </pre> <br><h2> 步骤3：设置域名 </h2><br> 接下来，您需要添加指向新服务器的DNS记录。 对于域管理，我们的Good Foundation算术使用dns-master.ru服务，下面以示例进行展示。 <br><br> 主域的A记录设置通常是这样表示的（ <code>@</code>符号）： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22c/823/c72/22c823c7228723207e222f6c63918d2f.png"></div><br> 子域的A记录通常表示如下： <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fb/964/276/6fb964276c962e380244c77f92ba31a4.png"></div><br>  IP地址是我们刚刚创建的Linux服务器的地址。  TTL可以指定= 3600。 <br><br> 一段时间后，已经可以访问您的网站，但是到目前为止只能通过<code>http://</code> 。 在下一步中，我们将添加<code>https://</code>支持。 <br><br><h2> 步骤4：配置免费的SSL证书 </h2><br> 您可以获取主站点和所有子域的“让我们加密”免费的SSL证书。 您还可以配置其自动续订，这非常方便。 要获取SSL证书，请在服务器上安装Certbot： <br><br><pre> <code class="plaintext hljs">$ sudo add-apt-repository ppa:certbot/certbot</code> </pre> <br> 使用<code>apt</code>安装适用于Apache的Certbot软件包： <br><br><pre> <code class="plaintext hljs">$ sudo apt install python-certbot-apache</code> </pre> <br>  Certbot现在可以使用了，我们执行以下命令： <br><br><pre> <code class="plaintext hljs">$ sudo certbot --apache -d a-dobra.ru -d www.a-dobra.ru -d promo.a-dobra.ru</code> </pre> <br> 此命令运行certbot， <code>-d</code>开关指定要为其颁发证书的域名。 <br><br> 如果这是您第一次运行certbot，则系统将要求您输入电子邮件地址并同意服务条款。 之后，certbot将与Let's Encrypt服务器联系，然后确认您确实控制了您申请证书的域。 <br><br> 如果一切顺利，certbot将询问您如何配置HTTPS配置： <br><br><pre> <code class="plaintext hljs">Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 1: No redirect - Make no further changes to the webserver configuration. 2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for new sites, or if you're confident your site works on HTTPS. You can undo this change by editing your web server's configuration. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - Select the appropriate number [1-2] then [enter] (press 'c' to cancel):</code> </pre> <br> 我们建议您选择选项2，然后按Enter。 配置将被更新，Apache重新启动以应用更改。 <br><br> 现在，您的证书已上传，安装并可以使用。 尝试使用https：//重新加载网站，您将在浏览器中看到安全性图标。 如果使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSL Labs服务器测试测试服务器</a> ，则它将获得A级。 <br><br> 让我们加密证书仅可使用90天，但是我们刚刚安装的certbot软件包将自动更新证书。 为了测试升级过程，我们可以制作一个空运行的certbot： <br><br><pre> <code class="plaintext hljs">$ sudo certbot renew --dry-run</code> </pre> <br> 如果您看不到此命令导致的任何错误，则说明一切正常！ <br><br><h2> 第5步：访问MySQL和phpMyAdmin </h2><br> 许多网站使用数据库。 用于数据库管理的phpMyAdmin工具已经安装在我们的服务器上。 要访问它，请在浏览器中单击链接，例如： <br><br><pre> <code class="plaintext hljs">https://&lt;ip- &gt;:9997</code> </pre> <br> 可以在您的个人MCS帐户（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://mcs.mail.ru/app/services/marketplace/apps/</a> ）中获得用于root用户访问的密码。 请勿忘记在首次登录时更改root密码！ <br><br><h2> 第6步：配置通过SFTP上传文件 </h2><br> 开发人员可以通过SFTP为您的网站上传文件，这将很方便。 为此，我们将创建一个新用户，称他为网站管理员： <br><br><pre> <code class="plaintext hljs">$ sudo adduser webmaster</code> </pre> <br> 系统将要求您设置密码并输入其他数据。 <br><br> 用您的网站更改目录的所有者： <br><br><pre> <code class="plaintext hljs">$ sudo chown -R webmaster:webmaster /var/www/a-dobra.ru/public_html</code> </pre> <br> 现在，我们更改SSH配置，以便新用户只能访问SFTP，而不能访问SSH终端： <br><br><pre> <code class="plaintext hljs">$ sudo nano /etc/ssh/sshd_config</code> </pre> <br> 将配置文件滚动到最后，并添加以下块： <br><br><pre> <code class="plaintext hljs">Match User webmaster ForceCommand internal-sftp PasswordAuthentication yes ChrootDirectory /var/www/a-dobra.ru PermitTunnel no AllowAgentForwarding no AllowTcpForwarding no X11Forwarding no</code> </pre> <br> 保存文件并重新加载服务： <br><br><pre> <code class="plaintext hljs">$ sudo systemctl restart sshd</code> </pre> <br> 现在，您可以通过SFTP的任何客户端（例如，通过FileZilla）连接到服务器。 <br><br><h2> 总结 </h2><br><ol><li> 现在，您知道如何在同一服务器上为网站创建新目录并配置虚拟主机。 </li><li> 您可以轻松创建必要的SSL证书-它是免费的，并且将自动更新。 </li><li> 您可以通过通常的phpMyAdmin方便地使用MySQL数据库。 </li><li> 创建新的SFTP帐户和设置访问权限将不需要太多的工作。 可以将此类帐户转移给第三方Web开发人员和站点管理员。 </li><li> 不要忘了定期更新系统，并建议您进行备份-在MCS中，您可以一键拍摄整个系统的“快照”，然后在必要时启动整个映像。 </li></ol><br> 可能有用的资源： <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.digitalocean.com/community/tutorials/apache-ubuntu-14-04-lts-ru</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.digitalocean.com/community/tutorials/apache-let-s-encrypt-ubuntu-18-04-ru</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.digitalocean.com/community/tutorials/how-to-enable-sftp-without-shell-access-on-ubuntu-18-04</a> <br><br> 顺便说一句，您可以在VC上阅读我们的基金会如何基于MCS云启动了一个在线的孤儿在线教育平台。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461155/">https://habr.com/ru/post/zh-CN461155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461145/index.html">团队应该领导什么：角色，责任和技能</a></li>
<li><a href="../zh-CN461147/index.html">如何通过组合PowerPoint中的键来节省64小时</a></li>
<li><a href="../zh-CN461149/index.html">MongoDB顺利迁移到Kubernetes</a></li>
<li><a href="../zh-CN461151/index.html">从构思到生产-物联网项目开发</a></li>
<li><a href="../zh-CN461153/index.html">WebComponents作为框架，组件交互</a></li>
<li><a href="../zh-CN461157/index.html">反馈助手将提供什么-将取代Bug Reporter的开发人员平台</a></li>
<li><a href="../zh-CN461159/index.html">Ivideon Bridge：如何将旧式CCTV系统连接到云</a></li>
<li><a href="../zh-CN461161/index.html">Android首选项委托</a></li>
<li><a href="../zh-CN461163/index.html">生日悖论和电子签名的脆弱性之间有什么联系？</a></li>
<li><a href="../zh-CN461165/index.html">生物识别越来越近</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>