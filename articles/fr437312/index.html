<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöô üë©üèø‚Äçüíª üë©üèº‚Äçü§ù‚Äçüë®üèΩ Impl√©mentation d'un rechargement √† chaud du code C ++ sur Linux et macOS: creuser plus profond√©ment üë®üèæ‚Äçüé§ ‚ö´Ô∏è üëÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* Lien vers la biblioth√®que et la vid√©o de d√©monstration √† la fin de l'article. Pour comprendre ce qui se passe et qui sont toutes ces personnes, je v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Impl√©mentation d'un rechargement √† chaud du code C ++ sur Linux et macOS: creuser plus profond√©ment</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437312/"><p><img src="https://habrastorage.org/webt/cz/hn/wz/czhnwzufandjpr6jf5cwj1j3p48.png"></p><br><p>  * Lien vers la biblioth√®que et la vid√©o de d√©monstration √† la fin de l'article.  Pour comprendre ce qui se passe et qui sont toutes ces personnes, je vous recommande de lire l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> . </p><br><p>  Dans le dernier article, nous nous sommes familiaris√©s avec une approche qui permet un rechargement √† chaud du code c ++.  Dans ce cas, le "code" d√©signe les fonctions, les donn√©es et leur travail coordonn√© les uns avec les autres.  Il n'y a pas de probl√®mes particuliers avec les fonctions, nous redirigeons le flux d'ex√©cution de l'ancienne fonction vers la nouvelle, et tout fonctionne.  Le probl√®me se pose avec les donn√©es (variables statiques et globales), √† savoir avec la strat√©gie de leur synchronisation dans l'ancien et le nouveau code.  Dans la premi√®re impl√©mentation, cette strat√©gie √©tait tr√®s maladroite: nous copions simplement les valeurs de toutes les variables statiques de l'ancien code vers la nouvelle, de sorte que le nouveau code, se r√©f√©rant aux nouvelles variables, fonctionne avec les valeurs de l'ancien code.  Bien s√ªr, ceci est incorrect, et aujourd'hui nous allons essayer de corriger cette faille en r√©solvant simultan√©ment un certain nombre de probl√®mes petits mais int√©ressants. </p><br><p>  L'article omet les d√©tails concernant le travail m√©canique, tels que la lecture des caract√®res et les d√©placements des fichiers elf et mach-o.  L'accent est mis sur les points subtils que j'ai rencontr√©s au cours du processus de mise en ≈ìuvre, et qui peuvent √™tre utiles √† quelqu'un qui, comme moi r√©cemment, cherche des r√©ponses. </p><a name="habracut"></a><br><h3 id="sut">  Essence </h3><br><p>  Imaginons que nous ayons une classe (exemples synth√©tiques, ne cherchez pas de sens en eux, seul le code est important): </p><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Entity.hpp class Entity { public: Entity(const std::string&amp; description); ~Entity(); void printDescription(); static int getLivingEntitiesCount(); private: static int m_livingEntitiesCount; std::string m_description; }; // Entity.cpp int Entity::m_livingEntitiesCount = 0; Entity::Entity(const std::string&amp; description) : m_description(description) { m_livingEntitiesCount++; } Entity::~Entity() { m_livingEntitiesCount--; } int Entity::getLivingEntitiesCount() { return m_livingEntitiesCount; } void Entity::printDesctiption() { std::cout &lt;&lt; m_description &lt;&lt; std::endl; }</span></span></code> </pre> <br><p>  Rien de sp√©cial mais une variable statique.  Imaginez maintenant que nous voulons changer la m√©thode <code>printDescription()</code> en: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Entity::printDescription() { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"DESCRIPTION: "</span></span> &lt;&lt; m_description &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre> <br><p>  Que se passe-t-il apr√®s le rechargement du code?  En plus des m√©thodes de la classe <code>Entity</code> , la variable statique <code>m_livingEntitiesCount</code> √©galement dans la biblioth√®que avec le nouveau code.  Rien de mauvais ne se produira si nous copions simplement la valeur de cette variable de l'ancien code vers la nouvelle et continuons √† utiliser la nouvelle variable, en oubliant l'ancienne, car toutes les m√©thodes qui utilisent directement cette variable sont dans la biblioth√®que avec le nouveau code. </p><br><p>  C ++ est tr√®s flexible et riche.  Et tandis que l'√©l√©gance de r√©soudre certains probl√®mes en c ++ frise le code naus√©abond, j'aime ce langage.  Par exemple, imaginez que votre projet n'utilise pas rtti.  Dans le m√™me temps, vous devez avoir une impl√©mentation de la classe <code>Any</code> avec une interface quelque peu s√©curis√©e: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Any</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T&amp;&amp; value)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">as</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } };</code> </pre> <br><p>  Nous n'entrerons pas dans les d√©tails de l'impl√©mentation de cette classe.  Ce qui est important pour nous, c'est que pour l'impl√©mentation, nous avons besoin d'une sorte de m√©canisme pour le mappage sans ambigu√Øt√© du type (entit√© au moment de la compilation) dans la valeur d'une variable, par exemple, <code>uint64_t</code> (entit√© d'ex√©cution), c'est-√†-dire les types "√©num√©r√©s".  Lors de l'utilisation de rtti, des choses comme <code>type_info</code> et, plus appropri√©es pour nous, <code>type_index</code> sont √† notre disposition.  Mais nous n'avons pas de rtti.  Dans ce cas, un hack assez courant (ou une solution √©l√©gante?) Est-ce que cette fonction: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> typeId() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> someVar; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>&gt;(&amp;someVar); }</code> </pre> <br><p>  L'impl√©mentation de la classe <code>Any</code> ressemblera alors √† ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">explicit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Any</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T&amp;&amp; value)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m_typeId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(typeId&lt;</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::decay&lt;T&gt;::type&gt;())</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// copy or move value somewhere {} template &lt;typename T&gt; bool is() const { return m_typeId == typeId&lt;std::decay&lt;T&gt;::type&gt;(); } template &lt;typename T&gt; T&amp; as() { ... } private: uint64_t m_typeId = 0; };</span></span></span></span></code> </pre> <br><p>  Pour chaque type, la fonction sera instanci√©e exactement 1 fois, respectivement, chaque version de la fonction aura sa propre variable statique, √©videmment avec sa propre adresse unique.  Que se passe-t-il lorsque nous rechargeons le code √† l'aide de cette fonction?  Les appels vers l'ancienne version de la fonction seront redirig√©s vers la nouvelle.  La nouvelle aura sa propre variable statique d√©j√† initialis√©e (nous avons copi√© la variable value et guard).  Mais nous ne sommes pas int√©ress√©s par le sens, nous utilisons uniquement l'adresse.  Et l'adresse de la nouvelle variable sera diff√©rente.  Ainsi, les donn√©es sont devenues incoh√©rentes: dans les instances d√©j√† cr√©√©es de la classe <code>Any</code> , l'adresse de l'ancienne variable statique sera stock√©e, et la m√©thode <code>is()</code> comparera avec l'adresse de la nouvelle, et "cet <code>Any</code> ne <code>Any</code> plus le m√™me <code>Any</code> " ¬©. </p><br><h3 id="plan">  Plan </h3><br><p>  Pour r√©soudre ce probl√®me, vous avez besoin de quelque chose de plus intelligent que la simple copie.  Apr√®s avoir pass√© quelques soir√©es sur Google, lu de la documentation, des codes sources et des API syst√®me, le plan suivant a √©t√© construit dans ma t√™te: </p><br><ol><li>  Apr√®s avoir construit le nouveau code, nous passons par les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©localisations</a> . </li><li>  De ces d√©localisations, nous obtenons tous les emplacements du code qui utilisent des variables statiques (et parfois globales). </li><li>  Au lieu d'adresses vers de nouvelles versions de variables, nous substituons les adresses des anciennes versions au lieu de relocalisation. </li></ol><br><p>  Dans ce cas, il n'y aura aucun lien vers de nouvelles donn√©es, l'application enti√®re continuera de fonctionner avec les anciennes versions des variables jusqu'√† l'adresse.  √áa devrait marcher.  Cela ne peut manquer de fonctionner. </p><br><h3 id="relokacii">  D√©localisations </h3><br><p>  Lorsque le compilateur g√©n√®re du code machine, il ins√®re plusieurs octets suffisants pour √©crire l'adresse r√©elle de la variable ou de la fonction √† cet endroit √† chaque endroit o√π la fonction est appel√©e ou l'adresse de la variable est charg√©e, et g√©n√®re √©galement une relocalisation.  Il ne peut pas enregistrer imm√©diatement l'adresse r√©elle, car √† ce stade, il ne conna√Æt pas cette adresse.  Les fonctions et les variables apr√®s la liaison peuvent √™tre dans diff√©rentes sections, √† diff√©rents endroits des sections, dans les sections finales peuvent √™tre charg√©es √† diff√©rentes adresses au moment de l'ex√©cution. </p><br><p>  La r√©installation contient des informations: </p><br><ul><li>  √Ä quelle adresse devez-vous √©crire l'adresse de la fonction ou de la variable </li><li>  L'adresse de la fonction ou de la variable √† √©crire </li><li>  La formule par laquelle cette adresse doit √™tre calcul√©e </li><li>  Combien d'octets sont r√©serv√©s pour cette adresse </li></ul><br><p>  Dans diff√©rents OS, les d√©localisations sont repr√©sent√©es diff√©remment, mais au final, elles fonctionnent toutes sur le m√™me principe.  Par exemple, dans elf (Linux), les relocalisations sont situ√©es dans des sections sp√©ciales <code>.rela</code> (dans la version 32 bits, c'est <code>.rel</code> ), qui se r√©f√®rent √† la section avec l'adresse qui doit √™tre corrig√©e (par exemple, <code>.rela.text</code> - la section dans laquelle les d√©localisations sont situ√©es, appliqu√© √† la section <code>.text</code> ), et chaque entr√©e stocke des informations sur le symbole dont vous souhaitez ins√©rer l'adresse dans le site de relocalisation.  Dans mach-o (macOS), le contraire est le cas; il n'y a pas de section distincte pour les d√©localisations; √† la place, chaque section contient un pointeur vers une table de d√©localisations qui doit √™tre appliqu√©e √† cette section, et chaque enregistrement de cette table a une r√©f√©rence √† un symbole relationnel. <br>  Par exemple, pour un tel code (avec l'option <code>-fPIC</code> ): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> globalVariable = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">veryUsefulFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> functionLocalVariable = <span class="hljs-number"><span class="hljs-number">0</span></span>; functionLocalVariable++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> globalVariable + functionLocalVariable; }</code> </pre> <br><p>  le compilateur cr√©era une telle section avec des d√©localisations sous Linux: </p><br><pre> <code class="plaintext hljs">Relocation section '.rela.text' at offset 0x1a0 contains 4 entries: Offset Info Type Symbol's Value Symbol's Name + Addend 0000000000000007 0000000600000009 R_X86_64_GOTPCREL 0000000000000000 globalVariable - 4 000000000000000d 0000000400000002 R_X86_64_PC32 0000000000000000 .bss - 4 0000000000000016 0000000400000002 R_X86_64_PC32 0000000000000000 .bss - 4 000000000000001e 0000000400000002 R_X86_64_PC32 0000000000000000 .bss - 4</code> </pre> <br><p>  et une telle table de relocalisation sur macOS: </p><br><pre> <code class="plaintext hljs">RELOCATION RECORDS FOR [__text]: 000000000000001b X86_64_RELOC_SIGNED __ZZ18veryUsefulFunctionvE21functionLocalVariable 0000000000000015 X86_64_RELOC_SIGNED _globalVariable 000000000000000f X86_64_RELOC_SIGNED __ZZ18veryUsefulFunctionvE21functionLocalVariable 0000000000000006 X86_64_RELOC_SIGNED __ZZ18veryUsefulFunctionvE21functionLocalVariable</code> </pre> <br><p>  Et voici la fonction <code>veryUsefulFunction()</code> (sous Linux): </p><br><pre> <code class="plaintext hljs">0000000000000000 &lt;_Z18veryUsefulFunctionv&gt;: 0: 55 push rbp 1: 48 89 e5 mov rbp,rsp 4: 48 8b 05 00 00 00 00 mov rax,QWORD PTR [rip+0x0] b: 8b 0d 00 00 00 00 mov ecx,DWORD PTR [rip+0x0] 11: 83 c1 01 add ecx,0x1 14: 89 0d 00 00 00 00 mov DWORD PTR [rip+0x0],ecx 1a: 8b 08 mov ecx,DWORD PTR [rax] 1c: 03 0d 00 00 00 00 add ecx,DWORD PTR [rip+0x0] 22: 89 c8 mov eax,ecx 24: 5d pop rbp 25: c3 ret</code> </pre> <br><p>  et ainsi apr√®s avoir li√© l'objet √† la biblioth√®que dynamique: </p><br><pre> <code class="plaintext hljs">00000000000010e0 &lt;_Z18veryUsefulFunctionv&gt;: 10e0: 55 push rbp 10e1: 48 89 e5 mov rbp,rsp 10e4: 48 8b 05 05 21 00 00 mov rax,QWORD PTR [rip+0x2105] 10eb: 8b 0d 13 2f 00 00 mov ecx,DWORD PTR [rip+0x2f13] 10f1: 83 c1 01 add ecx,0x1 10f4: 89 0d 0a 2f 00 00 mov DWORD PTR [rip+0x2f0a],ecx 10fa: 8b 08 mov ecx,DWORD PTR [rax] 10fc: 03 0d 02 2f 00 00 add ecx,DWORD PTR [rip+0x2f02] 1102: 89 c8 mov eax,ecx 1104: 5d pop rbp 1105: c3 ret</code> </pre> <br><p>  Il y a 4 emplacements dans lesquels 4 octets sont r√©serv√©s pour l'adresse des variables r√©elles. </p><br><p>  Sur diff√©rents syst√®mes, l'ensemble des d√©localisations possibles est le v√¥tre.  Sous Linux sur x86-64, jusqu'√† <a href="">40 types de d√©localisations</a> .  Il n'y en a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">que 9</a> sur macOS sur x86-64.  Tous les types de d√©localisations peuvent √™tre conditionnellement divis√©s en 2 groupes: </p><br><ol><li>  Relocations au moment de la liaison - relocalisations utilis√©es dans le processus de liaison de fichiers d'objets √† un fichier ex√©cutable ou √† une biblioth√®que dynamique </li><li>  D√©localisations au moment du chargement - d√©localisations appliqu√©es au moment du chargement de la biblioth√®que dynamique dans la m√©moire de processus </li></ol><br><p>  Le deuxi√®me groupe comprend les relocalisations des fonctions et variables export√©es.  Lorsqu'une biblioth√®que dynamique est charg√©e dans la m√©moire de processus, pour toutes les relocalisations dynamiques (y compris les relocalisations de variables globales), l'√©diteur de liens recherche la d√©finition des symboles dans toutes les biblioth√®ques d√©j√† charg√©es, y compris dans le programme lui-m√™me, et l'adresse du premier symbole appropri√© est utilis√©e pour la relocalisation.  Ainsi, rien ne doit √™tre fait avec ces d√©localisations; l'√©diteur de liens trouvera la variable dans notre application elle-m√™me, car elle tombera dans sa liste de biblioth√®ques et de programmes charg√©s plus t√¥t, et remplacera son adresse dans le nouveau code, ignorant la nouvelle version de cette variable. </p><br><p>  Il y a un point subtil associ√© √† macOS et √† son √©diteur de liens dynamique.  MacOS impl√©mente le m√©canisme de l'espace de noms dit √† deux niveaux.  Si c'est grossier, alors lors du chargement d'une biblioth√®que dynamique, l'√©diteur de liens recherchera d'abord les personnages de cette biblioth√®que, et s'il ne le trouve pas, il cherchera dans les autres.  Cela se fait √† des fins de performances, de sorte que les d√©localisations se r√©solvent rapidement, ce qui, en g√©n√©ral, est logique.  Mais cela rompt notre flux concernant les variables globales.  Heureusement, ld sur macOS a un drapeau sp√©cial - <code>-flat_namespace</code> , et si vous construisez une biblioth√®que avec ce drapeau, l'algorithme de recherche de caract√®res sera identique √† celui de Linux. </p><br><p>  Le premier groupe comprend les relocalisations de variables statiques - exactement ce dont nous avons besoin.  Le seul probl√®me est que ces d√©localisations ne sont pas dans la biblioth√®que compil√©e, car elles sont d√©j√† r√©solues par l'√©diteur de liens.  Par cons√©quent, nous les lirons √† partir des fichiers objets √† partir desquels la biblioth√®que a √©t√© assembl√©e. <br>  Les types de d√©localisations possibles sont √©galement limit√©s selon que le code assembl√© d√©pend de la position ou non.  Puisque nous collectons notre code en mode PIC (code ind√©pendant de la position), les d√©localisations ne sont utilis√©es que de mani√®re relative.  Les d√©localisations totales qui nous int√©ressent sont: </p><br><ul><li>  <code>.rela.text</code> depuis la section <code>.rela.text</code> sous Linux et les d√©placements r√©f√©renc√©s par la section <code>__text</code> sous macOS, et </li><li>  Qui utilise des caract√®res des sections <code>.data</code> et <code>.bss</code> sous Linux et <code>__data</code> , <code>__bss</code> et <code>__common</code> sous macOS, et </li><li>  Les d√©localisations sont de type <code>R_X86_64_PC32</code> et <code>R_X86_64_PC64</code> sur Linux et <code>X86_64_RELOC_SIGNED</code> , <code>X86_64_RELOC_SIGNED_1</code> , <code>X86_64_RELOC_SIGNED_2</code> et <code>X86_64_RELOC_SIGNED_4</code> sur macOS </li></ul><br><p>  Le point subtil associ√© √† la section <code>__common</code> .  Linux a √©galement une section <code>*COM*</code> similaire.  Les variables globales peuvent tomber dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette section</a> .  Mais, pendant que je testais et compilais un tas d'extraits de code, sous Linux, les relocalisations de caract√®res des sections <code>*COM*</code> √©taient toujours dynamiques, comme les variables globales r√©guli√®res.  Dans le m√™me temps, sur macOS, ces caract√®res √©taient parfois d√©plac√©s lors de la liaison si la fonction et le personnage se trouvaient dans le m√™me fichier.  Par cons√©quent, sur macOS, il est logique de prendre en compte cette section lors de la lecture des caract√®res et des relocalisations. </p><br><p>  Eh bien, nous avons maintenant un ensemble de toutes les d√©localisations dont nous avons besoin, que faire avec eux?  La logique ici est simple.  Lorsque l'√©diteur de liens relie la biblioth√®que, il √©crit l'adresse du symbole calcul√©e par une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certaine formule</a> √† l'adresse de relocalisation.  Pour nos d√©localisations sur les deux plateformes, cette formule contient l'adresse du symbole en tant que terme.  Ainsi, l'adresse calcul√©e d√©j√† enregistr√©e dans le corps des fonctions a la forme: </p><br><pre> <code class="plaintext hljs">resultAddr = newVarAddr + addend - relocAddr</code> </pre> <br><p>  Dans le m√™me temps, nous connaissons les adresses des deux versions de variables - anciennes, d√©j√† pr√©sentes dans l'application et nouvelles.  Il nous reste √† le changer selon la formule: </p><br><pre> <code class="plaintext hljs">resultAddr = resultAddr - newVarAddr + oldVarAddr</code> </pre> <br><p>  et l'√©crire √† l'adresse de r√©installation.  Apr√®s cela, toutes les fonctions du nouveau code utiliseront les versions existantes des variables, et les nouvelles variables resteront simplement et ne feront rien.  Ce dont vous avez besoin!  Mais il y a un point subtil. </p><br><h3 id="zagruzka-biblioteki-s-novym-kodom">  T√©l√©chargement de la biblioth√®que avec le nouveau code </h3><br><p>  Lorsque le syst√®me charge une biblioth√®que dynamique dans la m√©moire de processus, il est libre de la placer n'importe o√π dans l'espace d'adressage virtuel.  Sur mon Ubuntu 18.04, l'application est charg√©e √† <code>0x00400000</code> , et nos biblioth√®ques dynamiques juste apr√®s <code>ld-2.27.so</code> aux adresses dans la zone <code>0x7fd3829bd000</code> .  La distance entre les adresses de t√©l√©chargement du programme et de la biblioth√®que est beaucoup plus grande que le nombre qui tiendrait dans l'entier 32 bits sign√©.  Et dans les d√©localisations au moment de la liaison, seuls 4 octets sont r√©serv√©s aux adresses des caract√®res cibles. </p><br><p>  Apr√®s avoir fum√© la documentation des compilateurs et des <code>-mcmodel=large</code> liens, j'ai d√©cid√© d'essayer l'option <code>-mcmodel=large</code> .  Il oblige le compilateur √† g√©n√©rer du code sans aucune hypoth√®se sur la distance entre les caract√®res, ainsi toutes les adresses sont suppos√©es √™tre 64 bits.  Mais cette option n'est pas compatible PIC, car si <code>-mcmodel=large</code> ne peut pas √™tre utilis√© avec <code>-fPIC</code> , au moins sur macOS.  Je ne comprends toujours pas quel est le probl√®me, peut-√™tre que sur macOS il n'y a pas de relocalisation appropri√©e pour cette situation. </p><br><p>  Dans la biblioth√®que sous Windows, ce probl√®me est r√©solu comme suit.  Les mains allouent un morceau de m√©moire virtuelle pr√®s de l'emplacement de t√©l√©chargement de l'application, suffisant pour accueillir les sections n√©cessaires de la biblioth√®que.  Ensuite, les sections y sont charg√©es avec les mains, les droits n√©cessaires sont d√©finis sur les pages de m√©moire avec les sections correspondantes, toutes les relocalisations sont d√©compress√©es √† la main et tout le reste est corrig√©.  Je suis paresseux.  Je ne voulais vraiment pas faire tout ce travail avec des d√©localisations de temps de chargement, en particulier sous Linux.  Et pourquoi faire ce qu'un √©diteur de liens dynamique sait d√©j√† faire?  Apr√®s tout, les gens qui l'ont √©crit en savent beaucoup plus que moi. </p><br><p>  Heureusement, la documentation a trouv√© les options n√©cessaires pour indiquer o√π t√©l√©charger notre biblioth√®que dynamique: </p><br><ul><li>  Apple ld: <code>-image_base 0xADDRESS</code> </li><li>  LLVM lld: <code>--image-base=0xADDRESS</code> </li><li>  GNU ld: <code>-Ttext-segment=0xADDRESS</code> </li></ul><br><p>  Ces options doivent √™tre transmises √† l'√©diteur de liens au moment de la liaison de la biblioth√®que dynamique.  Il y a 2 difficult√©s. <br>  Le premier est li√© √† GNU ld.  Pour que ces options fonctionnent, vous devez: </p><br><ul><li>  Au moment du chargement de la biblioth√®que, la zone dans laquelle nous voulons la charger √©tait libre </li><li>  L'adresse sp√©cifi√©e dans l'option doit √™tre un multiple de la taille de la page (sur x86-64 Linux et macOS c'est <code>0x1000</code> ) </li><li>  Au moins sous Linux, l'adresse sp√©cifi√©e dans l'option doit √™tre un multiple de l'alignement du segment <code>PT_LOAD</code> </li></ul><br><p>  Autrement dit, si l'√©diteur de liens d√©finit l'alignement sur <code>0x10000000</code> , cette biblioth√®que ne peut pas √™tre charg√©e √† l'adresse <code>0x10001000</code> , m√™me si l'adresse est align√©e sur la taille de la page.  Si l'une de ces conditions n'est pas remplie, la biblioth√®que se charge ¬´comme d'habitude¬ª.  J'ai GNU ld 2.30 sur mon syst√®me et, contrairement √† LLVM lld, par d√©faut, il d√©finit l'alignement du segment <code>0x20000</code> sur <code>0x20000</code> , ce qui est tr√®s absent.  Pour contourner ce <code>-Ttext-segment=...</code> , en plus de l' <code>-Ttext-segment=...</code> , sp√©cifiez <code>-z max-page-size=0x1000</code> .  J'ai pass√© une journ√©e jusqu'√† ce que je r√©alise pourquoi la biblioth√®que ne se charge pas l√† o√π je dois. </p><br><p>  La deuxi√®me difficult√© - l'adresse de t√©l√©chargement doit √™tre connue au stade de la liaison de la biblioth√®que.  Ce n'est pas tr√®s difficile √† organiser.  Sous Linux, il suffit d'analyser le pseudo-fichier <code>/proc/&lt;pid&gt;/maps</code> , de trouver la pi√®ce inoccup√©e la plus proche du programme, dans laquelle la biblioth√®que s'ins√©rera, et d'utiliser l'adresse du d√©but de cette pi√®ce lors de la liaison.  La taille de la future biblioth√®que peut √™tre estim√©e approximativement en regardant les tailles des fichiers objets, ou en les analysant et en calculant les tailles de toutes les sections.  Au final, nous n'avons pas besoin d'un nombre exact, mais d'une taille approximative avec une marge. </p><br><p>  MacOS n'a pas <code>/proc/*</code> ; √† la place, il est sugg√©r√© d'utiliser l'utilitaire <code>vmmap</code> .  La sortie de la commande <code>vmmap -interleaved &lt;pid&gt;</code> contient les m√™mes informations que <code>proc/&lt;pid&gt;/maps</code> .  Mais ici se pose une autre difficult√©.  Si une application cr√©e un processus enfant qui ex√©cute cette commande et que l'identificateur du processus en cours est sp√©cifi√© comme <code>&lt;pid&gt;</code> , le programme se bloquera.  Si je comprends bien, <code>vmmap</code> arr√™te le processus pour lire ses mappages de m√©moire, et apparemment, si c'est le processus d'appel, alors quelque chose se passe mal.  Dans ce cas, vous devez sp√©cifier l'indicateur suppl√©mentaire <code>-forkCorpse</code> pour que <code>vmmap</code> cr√©e un processus enfant vide de notre processus, supprimez le mappage et tuez-le, n'interrompant ainsi pas le programme. </p><br><p>  C'est essentiellement tout ce que nous devons savoir. </p><br><h3 id="sobiraem-vse-vmeste">  Tout mettre ensemble </h3><br><p>  Avec ces modifications, l'algorithme de rechargement de code final ressemble √† ceci: </p><br><ol><li>  Compilez le nouveau code dans des fichiers objets </li><li>  Pour les fichiers objets, nous estimons la taille de la future biblioth√®que </li><li>  Lecture des fichiers d'objets de relocalisation </li><li>  Nous recherchons un morceau de m√©moire virtuelle gratuit √† c√¥t√© de l'application </li><li>  Nous construisons une biblioth√®que dynamique avec les options n√©cessaires, <code>dlopen</code> via <code>dlopen</code> </li><li>  Code de patch en fonction des d√©localisations de temps de liaison </li><li>  Fonction Patch </li><li>  Copiez les variables statiques qui n'ont pas particip√© √† l'√©tape 6 </li></ol><br><p>  Seules les variables de garde des variables statiques entrent dans l'√©tape 8, afin qu'elles puissent √™tre copi√©es en toute s√©curit√© (pr√©servant ainsi "l'initialisation" des variables statiques elles-m√™mes). </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Comme il s'agit exclusivement d'un outil de d√©veloppement, qui n'est destin√© √† aucune production, la pire chose qui puisse arriver si la prochaine biblioth√®que avec le nouveau code ne tient pas en m√©moire ou se charge accidentellement √† une adresse diff√©rente est un red√©marrage de l'application d√©bogu√©e.  Lors de l'ex√©cution des tests, 31 biblioth√®ques avec du code mis √† jour sont charg√©es √† tour de r√¥le dans la m√©moire. </p><br><p>  Pour √™tre complet, il manque 3 pi√®ces suppl√©mentaires de poids dans la mise en ≈ìuvre: </p><br><ol><li>  Maintenant, la biblioth√®que avec le nouveau code est charg√©e dans la m√©moire √† c√¥t√© du programme, bien que le code d'une autre biblioth√®que dynamique qui a √©t√© charg√©e loin puisse y entrer.  Pour r√©soudre ce probl√®me, vous devez suivre la propri√©t√© des unit√©s de traduction dans l'une ou l'autre biblioth√®que et programme, et diviser la biblioth√®que avec le nouveau code si n√©cessaire. </li><li>  Le rechargement du code dans une application multithread n'est toujours pas fiable (avec certitude, vous ne pouvez recharger que du code qui s'ex√©cute dans le m√™me thread que la biblioth√®que runloop).  Pour la fixation, il est n√©cessaire de d√©placer une partie de l'impl√©mentation dans un programme distinct, et ce programme, avant de patcher, doit arr√™ter le processus avec tous les threads, patcher et le remettre au travail.  Je ne sais pas comment faire cela sans programme externe. </li><li>  Pr√©vention du plantage accidentel de l'application apr√®s le rechargement du code.  Apr√®s avoir corrig√© le code, vous pouvez accidentellement d√©r√©f√©rencer le pointeur non valide dans le nouveau code, apr√®s quoi vous devrez red√©marrer l'application.  Rien de mal, mais quand m√™me.  Cela ressemble √† de la magie noire, je pense toujours. </li></ol><br><p>  Mais d√©j√† la mise en ≈ìuvre actuelle a commenc√© √† me b√©n√©ficier personnellement, elle suffit pour une utilisation dans mon travail principal.  Il faut un peu de temps pour s'y habituer, mais le vol est normal. <br>  Si j'arrive √† ces trois points et que je trouve dans leur mise en ≈ìuvre un nombre suffisant de choses int√©ressantes, je le partagerai certainement. </p><br><h3 id="demo">  D√©mo </h3><br><p>  √âtant donn√© que la mise en ≈ìuvre permet d'ajouter de nouvelles unit√©s de diffusion √† la vol√©e, j'ai d√©cid√© d'enregistrer une courte vid√©o dans laquelle j'√©cris un jeu obsc√®ne simple √† partir de z√©ro sur un vaisseau spatial labourant les √©tendues de l'univers et tirant des ast√©ro√Ødes carr√©s.  J'ai essay√© de ne pas √©crire dans le style de "tout en un fichier", mais, si possible, de tout organiser sur les √©tag√®res, g√©n√©rant ainsi de nombreux petits fichiers (donc, tellement de gribouillis sont sortis).  Bien s√ªr, le cadre est utilis√© pour le dessin, les entr√©es, les fen√™tres et autres choses, mais le code du jeu lui-m√™me a √©t√© √©crit √† partir de z√©ro. <br>  La principale caract√©ristique - je n'ai ex√©cut√© l'application que 3 fois: au tout d√©but, alors qu'elle n'avait qu'une sc√®ne vide, et 2 fois apr√®s la chute √† cause de ma n√©gligence.  L'ensemble du jeu s'est d√©vers√© progressivement dans le processus d'√©criture du code.  Temps r√©el - environ 40 minutes.  En g√©n√©ral, vous √™tes les bienvenus. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5xfgViYchqg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Comme toujours, je serai heureux de toute critique, merci! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien avec la mise en ≈ìuvre</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437312/">https://habr.com/ru/post/fr437312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437300/index.html">10 comp√©tences et connaissances n√©cessaires pour un d√©veloppeur iOS d√©butant</a></li>
<li><a href="../fr437304/index.html">Comment acheter des pommes de terre si vous √™tes daltonien</a></li>
<li><a href="../fr437306/index.html">Comp√©tences non √©videntes requises par le chef de produit</a></li>
<li><a href="../fr437308/index.html">Cycle de le√ßon SDL 2.0: Le√ßon 4 - Gestion des √©v√©nements</a></li>
<li><a href="../fr437310/index.html">Bordures de d√©grad√© CSS</a></li>
<li><a href="../fr437314/index.html">Enigma italienne: machines cryptographiques OMI</a></li>
<li><a href="../fr437316/index.html">L'Internet Development Institute a nomm√© des sites qui pourraient √™tre d√©connect√©s sur RuNet depuis le 1er f√©vrier</a></li>
<li><a href="../fr437318/index.html">Migration transparente (ou presque) entre les principales versions de PostgreSQL √† l'aide de la r√©plication logique</a></li>
<li><a href="../fr437320/index.html">Indice de d√©veloppement de la sph√®re des m√©dias 2018: stagnation de la t√©l√©vision, confiance accrue dans les m√©dias informels</a></li>
<li><a href="../fr437322/index.html">L'√âtat est engag√© dans BigDate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>