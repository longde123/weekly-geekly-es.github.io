<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶î üë©‚Äçüè≠ üòâ Nous overclockons la sauvegarde. Conf√©rence Yandex ü§µüèø üë®üèª üìí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Plusieurs conf√©rences √† venir seront bas√©es sur le premier Y. Subbotnik sur les bases de donn√©es tenues au printemps . Tout d'abord, le d√©veloppeur An...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous overclockons la sauvegarde. Conf√©rence Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/415817/">  Plusieurs conf√©rences √† venir seront bas√©es sur le premier Y. Subbotnik sur les bases de donn√©es tenues <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">au printemps</a> .  Tout d'abord, le d√©veloppeur Andrei Borodin s'est exprim√© √† Y. Subbotnik.  Il a parl√© de WAL-G, un outil simple et efficace pour sauvegarder PostgreSQL dans le cloud, ainsi que des algorithmes et des technologies qui permettent √† WAL-G de cr√©er des sauvegardes plus rapidement.  La principale caract√©ristique de WAL-G est la sauvegarde delta.  Dans la conf√©rence, vous d√©couvrirez leur impl√©mentation et comment le support de cette technologie se d√©veloppe dans PostgreSQL. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/bXuN4Na0cEo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - salut!  Je suis un d√©veloppeur Yandex d'Ekaterinbourg.  √Ä la technologie de sauvegarde rapide.  Nous effectuons des sauvegardes depuis un certain temps; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vladimir Borodin</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Evgeny Dyukov ont fait √©tat</a> de nos recherches et de ce que nous d√©veloppons pour stocker les donn√©es de mani√®re s√ªre, fiable, pratique et efficace.  Cette s√©rie est d√©di√©e aux derniers d√©veloppements dans ce domaine. <br><br>  Parlons en principe des sauvegardes dans PostgreSQL.  L'utilitaire standard de transfert de donn√©es - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pg_dump</a> - est d√©fini comme un utilitaire de console qui cr√©e un fichier avec une repr√©sentation logique de vos donn√©es. <br><a name="habracut"></a><br>  Que ce soit une copie logique est assez pratique.  Vous pouvez toujours transf√©rer des donn√©es entre diff√©rentes versions, vous pouvez couper votre base de donn√©es en morceaux, et c'est un outil standard qui, par exemple, est fourni dans une bo√Æte avec l'utilitaire d'administration PgAdmin. <br><br><img src="https://habrastorage.org/webt/3j/zs/kh/3jzskhrdbobeb5pfvdyebjvv9bi.jpeg"><br>  Tout d'abord, √† propos de pg_dump, vous devez savoir qu'il s'agit d'un outil de d√©veloppement. <br><br>  Ce n'est pas un outil de maintenance de base de donn√©es.  pg_dump n'est pas con√ßu pour fonctionner avec une base de donn√©es tr√®s charg√©e. <br><br><img src="https://habrastorage.org/webt/rb/sk/yf/rbskyfdmcwqb9ctu6-idvcj6ywm.jpeg"><br>  Supposons que tout soit s√©rieux et que vous souhaitiez utiliser la technologie de ¬´r√©cup√©ration ponctuelle¬ª, qui utilise l'API PostgreSQL pour travailler avec les sauvegardes en ligne.  Vous appelez la fonction pg_start_backup et effectuez une copie de fichier de la base de donn√©es.  En fait, pg_start_backup force la base de donn√©es √† faire CHECKPOINT;  et activer les √©critures pleine page dans le journal d'√©criture anticip√©e.  La copie de la base de donn√©es que vous cr√©ez lorsque vous appelez l'API n'est pas une copie coh√©rente des donn√©es.  Vous avez √©galement besoin d'un journal d'√©criture anticip√©e afin de pouvoir restaurer votre base de donn√©es pendant la dur√©e de l'appel pg_stop_backup, c'est-√†-dire √† la fin de la sauvegarde. <br><br><img src="https://habrastorage.org/webt/0a/aw/v1/0aawv1w0gp9okkkbjuja0k-ywg4.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  Apr√®s l'heure de fin de suppression de la sauvegarde et en pr√©sence d'un enregistrement de premier plan, vous pouvez r√©cup√©rer au point souhait√© dans la dur√©e de vie de votre base de donn√©es. <br><br>  L'utilitaire pg_basebackup est fourni dans la bo√Æte, qui impl√©mente toute cette technologie sous une forme canonique et vous permet de sauvegarder avec le minimum de fonctionnalit√©s n√©cessaires. <br><br>  Si vous √™tes encore plus s√©rieux qu'avant, vous utilisez une sorte de logiciel de gestion de sauvegarde, et g√©n√©ralement c'est Barman. <br><br>  Il a plusieurs avantages.  Le principal avantage est un utilitaire tr√®s courant, il a une √©norme communaut√©, un grand nombre de questions sur Stack Overflow. <br><br><img src="https://habrastorage.org/webt/hk/_s/xx/hk_sxxzzua_byoapw4kvxdexymm.jpeg"><br><br>  Il vous suffit de choisir un serveur de sauvegarde et d'y sauvegarder tous vos PostgreSQL.  C'est tr√®s pratique - tant qu'un seul serveur de sauvegarde vous suffit. <br><br>  D√®s que vous disposez d'un grand nombre de serveurs de sauvegarde, vous devez surveiller si l'un d'entre eux est plein.  En cas de panne d'un serveur de sauvegarde, vous devez comprendre lesquelles de vos bases de donn√©es sont d√©sormais en danger.  Vous devez comprendre en principe o√π copier un nouveau cluster de base de donn√©es lors de sa cr√©ation. <br><br>  Il existe un utilitaire de suppression de sauvegarde beaucoup plus simple appel√© WAL-E. <br><br><img src="https://habrastorage.org/webt/jf/l1/a0/jfl1a07ymxdr0luksh1zg_cb7ii.jpeg"><br>  WAL-E ex√©cute quatre commandes principales.  La commande WAL-PUSH envoie un fichier WAL au cloud et le WAL-FETCH prend un fichier WAL si restore_command doit √™tre restaur√©. <br><br>  Il existe √©galement BACKUP-PUSH (impl√©mente la suppression de l'API de sauvegarde) et BACKUP-FETCH (prend toutes les donn√©es du cloud).  Les donn√©es sont stock√©es dans le cloud, vous n'avez donc pas besoin de surveiller quoi que ce soit, c'est d√©j√† un probl√®me de service cloud, comment garantir la disponibilit√© de vos donn√©es quand vous en avez besoin.  C'est probablement le principal avantage du WAL-E. <br><br><img src="https://habrastorage.org/webt/tz/2e/h5/tz2eh51uc_vtsp-oylcltmgep1i.jpeg"><br>  Il y a beaucoup de fonctionnalit√©s.  Il y a une liste de sauvegardes, il y a une politique de r√©tention, c'est-√†-dire que nous voulons stocker des sauvegardes pour les sept derniers jours, par exemple, ou les cinq derni√®res sauvegardes, quelque chose comme √ßa.  Et WAL-E peut sauvegarder sur une grande vari√©t√© de services cloud: S3, Azure, Google, il peut appeler le syst√®me de fichiers local le cloud. <br><br><img src="https://habrastorage.org/webt/n9/wj/uz/n9wjuz9n4tg_w8cvkkbp4g7_imi.jpeg"><br>  Il a plusieurs propri√©t√©s.  Premi√®rement, il est √©crit en Python et utilise activement le pipeline Unix, en partie √† cause de cela, il a des d√©pendances et n'est pas tr√®s productif.  Ceci est normal car WAL-E se concentre sur la facilit√© d'utilisation, la facilit√© de configuration afin que vous ne puissiez pas vous tromper lorsque vous effectuez un plan de sauvegarde.  Et c'est une tr√®s bonne id√©e. <br><br>  Il y a beaucoup de fonctionnalit√©s √©crites en WAL-E, et l√† o√π les auteurs l'ont d√©velopp√©, ce n'√©tait pas tr√®s clair pour les auteurs.  L'id√©e est venue que j'avais besoin d'un nouvel outil. <br><br><img src="https://habrastorage.org/webt/ov/tj/ed/ovtjeduv1bhofpvnrbv2oong4ok.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  Sa principale caract√©ristique est qu'il est r√©√©crit dans Go, il n'a presque pas de d√©pendances externes, si vous n'utilisez pas de cryptage externe, et il est beaucoup plus productif. <br><br><img src="https://habrastorage.org/webt/fl/pl/h2/flplh2x6ugfya5ydixenji9hmxg.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  WAL-G a √©t√© cr√©√© √† l'origine par deux auteurs de Citus Data, et le principal avantage est montr√© dans cet histogramme - la vitesse d'envoi des ¬´arbres¬ª.  On voit que WAL-E est rapide, √ßa peut √™tre n'importe quoi, √ßa peut √™tre une grosse colonne proche de z√©ro. <br><br><img src="https://habrastorage.org/webt/r_/si/dn/r_sidnqgiipagw5sosfzo8ze90e.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  WAL-G a une bande passante assez stable.  Lors de tests chez Citus Data, il a montr√© qu'il envoyait de mani√®re stable environ 800 Mb / s de ¬´puits¬ª. <br><br>  De plus, dans WAL-G, par exemple, j'ai √©crit une fonctionnalit√© qui impl√©mente la sauvegarde √† partir d'une r√©plique.  Vous n'avez pas besoin de charger votre ma√Ætre DB avec une charge de lecture, vous pouvez supprimer la sauvegarde de la r√©plique. <br><br><img src="https://habrastorage.org/webt/ck/bl/jj/ckbljjqa0ujh35rnlmncx5guauw.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  Mais il y a un petit probl√®me.  Au moment o√π vous commencez √† faire la sauvegarde, vous devez nommer la sauvegarde en quelque sorte.  Le nom inclut une chronologie, qui sera modifi√©e si une r√©plique est promue.  Si un basculement se produit dans la cha√Æne de r√©plicas avant le r√©plica avec lequel vous sauvegardez, vous remarquerez certaines des r√©pliques, la chronologie sera modifi√©e.  WAL-G comprend que cette situation n'est pas coh√©rente, car ayant un nom sur l'ancien calendrier, le nom vous promet que vous pouvez continuer le d√©veloppement de l'historique de la base de donn√©es dans n'importe quelle direction existante.  Mais ce n'est pas le cas.  Vous √™tes d√©j√† all√© dans l'une des directions; vous ne pouvez pas passer √† une autre chronologie avec la voiture arri√®re.  Par cons√©quent, WAL-G comprend cette situation et ne t√©l√©charge pas de fichier JSON fiscal dans le cloud.  Vous cr√©ez une copie physique.  Mais une intervention de l'administrateur est requise pour que cette copie puisse √™tre utilis√©e. <br><br><img src="https://habrastorage.org/webt/no/yo/nv/noyonvp7l8d-0myokmscgjts31w.jpeg"><br><br>  Nous avons impl√©ment√© des copies delta dans WAL-G, j'ai √©galement travaill√© sur ce d√©veloppement.  Cela vous permet de prendre moins de donn√©es dans la prochaine sauvegarde de base, vous ne faites pas de copie des pages de donn√©es qui n'ont pas chang√© depuis la sauvegarde pr√©c√©dente. <br><br><img src="https://habrastorage.org/webt/dt/cn/ag/dtcnaglkk_z3i6rsm_hvs56m28o.jpeg"><br>  Lors de la configuration de WAL-G, vous sp√©cifiez le nombre d'√©tapes les plus √©loign√©es de la sauvegarde de base, la sauvegarde delta, et sp√©cifiez la strat√©gie de copie delta.  Soit vous faites une copie √† partir du dernier delta existant, soit vous faites un delta √† partir de la sauvegarde compl√®te d'origine.  Cela est n√©cessaire dans le cas o√π le m√™me composant de base de donn√©es change toujours dans votre base de donn√©es, les m√™mes donn√©es changent constamment. <br><br>  Pourquoi en principe avons-nous besoin de copies delta de la base de donn√©es?  En th√©orie, vous avez un WAL, et vous pouvez donc rouler n'importe o√π. <br><br>  Sur un serveur occup√©, jouer le WAL de cinq secondes physiques du pass√© peut prendre quatre secondes physiques du pr√©sent.  Si vous √™tes invit√© √† rouler le WAL en quatre jours, cela signifie qu'il est possible que la personne qui le demande attende encore trois jours.  Pas toujours une situation acceptable. <br><br>  Vous avez besoin de sauvegardes de base pour chaque jour, mais n√©anmoins, vous ne pouvez pas y conserver 7 ou 14 copies compl√®tes de votre base de donn√©es, m√™me si WAL-G les archivera, elles seront toujours assez volumineuses.  Et dans ce cas, les copies delta aident. <br><br><img src="https://habrastorage.org/webt/xw/aw/-l/xwaw-ll2y9911p6gjynx3dxhfb0.jpeg"><br>  Lors du d√©veloppement de copies delta, plusieurs formats de fichiers de donn√©es possibles ont √©t√© discut√©s.  Tout d'abord, le format a √©t√© propos√©, lorsque nous ne perturbons pas la page, nous l'annulons simplement.  Mais nous sommes arriv√©s √† la conclusion que ce n'est pas un moyen tr√®s efficace, les z√©ros sont alors efficacement compress√©s, mais nous avons ensuite refus√© cette m√©thode de stockage, car il est difficile de la d√©boguer en cas de situations d'urgence. <br><br><img src="https://habrastorage.org/webt/y1/cd/m-/y1cdm-xvhv7sq-4wt8e3y_xzaia.jpeg"><br>  La prochaine technologie qui a √©t√© envisag√©e est d'abord de stocker le num√©ro de bloc, puis le bloc modifi√©.  Mais ici, nous sommes confront√©s √† la particularit√© du stockage dans les fichiers TAR, que nous devons d'abord indiquer la taille des fichiers TAR dans lesquels nous stockons notre copie delta, puis commencer √† l'enregistrer.  Je voulais faire l'impl√©mentation de la technologie avec un minimum de RAM consomm√©e, nous avons donc d√ª utiliser le troisi√®me format dans lequel nous lisons d'abord compl√®tement chaque fichier de donn√©es, recherchons les pages de donn√©es modifi√©es, stockons d'abord les num√©ros des blocs modifi√©s dans le fichier TAR, puis seulement les blocs modifi√©s eux-m√™mes. <br><br><img src="https://habrastorage.org/webt/ew/le/eo/ewleeouqovcrezeke5wv6nndmby.jpeg"><br><img src="https://habrastorage.org/webt/mj/qx/rg/mjqxrg9h-jhu0nlatbxarh1jaaw.jpeg"><br><br>  Cette fonctionnalit√© n'est pas encore impl√©ment√©e.  Je la regarde ou je cherche quelqu'un qui veut faire une demande de pull dans WAL-G.  Lors de la r√©cup√©ration √† partir d'une copie delta, la base de donn√©es survit √† chacune des r√©incarnations de la base de donn√©es √† chaque √©tape de la sauvegarde delta.  Parfois, au milieu de la vie, certains fichiers sont supprim√©s.  Dans le m√™me temps, nous n'aurions pas √† nous soucier de leur √©tat s'ils √©taient supprim√©s de toute fa√ßon, puis recr√©√©s √† partir de la copie delta.  Cela ne semble pas √™tre une fonctionnalit√© tr√®s compliqu√©e, donc si vous √™tes int√©ress√© √† √©crire quelque chose sur Go, jetez un ≈ìil √† cette fonctionnalit√©. <br><br><img src="https://habrastorage.org/webt/g3/fa/7d/g3fa7d6otwscpktvrov045nvmni.jpeg"><br>  Planifier l'utilisation du r√©seau, du CPU et du disque.  Au WAL-E, comme nous pouvons le voir, la sauvegarde ici n'est pas encore termin√©e, elle a commenc√© √† une heure du matin √† Moscou, et elle ne s'est pas termin√©e au dernier rapport que nous voyons.  Le calendrier WAL-G est termin√©, il fonctionne plus rapidement et est beaucoup plus m√™me en termes de consommation de ressources. <br><br>  La chose la plus int√©ressante est le graphique de la consommation de ressources lors d'une copie delta.  Nous voyons que toutes les ressources sont devenues presque nulles.  La charge sur le CPU est presque la charge standard sur la base de donn√©es; la nuit, certaines requ√™tes sont ex√©cut√©es.  Nous voyons une grande partie de la lecture.  Je m'en occupe √©galement, j'aimerais √©galement retirer une demande ou je le ferai moi-m√™me en √©t√©.  L'essentiel est que nous devons encore lire nos donn√©es pour savoir ce qui a chang√© en elles.  Cette lecture aurait pu √™tre √©vit√©e. <br><br><img src="https://habrastorage.org/webt/6g/bz/w7/6gbzw7p2zf7bbczdq3hnc-z1ni8.jpeg"><br><br>  Il y a une suppression dans WAL-G lorsque nous indiquons le nombre de sauvegardes ou la date √† partir de laquelle nous devons stocker tous les WAL et toutes les sauvegardes de base.  Et WAL-G traite d√©j√† de la question de savoir quels WAL et sauvegardes de base sont n√©cessaires.  Jusqu'√† pr√©sent, nous n'avons aucune fonctionnalit√© qui supprimerait tout.  En WAL-E c'est aussi l'occasion d'une pull request.  Une commande DELETE EVERYTHING int√©ressante n'a pas encore √©t√© impl√©ment√©e. <br><br><img src="https://habrastorage.org/webt/5q/1t/aw/5q1tawrrz1gj-l4wu1igxubfd4q.jpeg"><br><br>  Il existe une liste de sauvegardes. <br><br><img src="https://habrastorage.org/webt/kq/gs/mw/kqgsmwqqiezwwifwb8puxmzlugm.jpeg"><br>  Nous d√©finissons la variable d'environnement n√©cessaire au fonctionnement de WAL-G et appelons l'utilitaire de console WAL-G.  Les sauvegardes que nous devons visualiser sont affich√©es. <br><br><img src="https://habrastorage.org/webt/id/uv/rg/iduvrgdmb1nca0nbfcpvs0cxfc8.jpeg"><br>  WAL-G met en ≈ìuvre un grand nombre de technologies pour parall√©liser les sauvegardes et g√©n√©ralement diverses op√©rations.  Par exemple, cette technologie est utilis√©e pour envoyer des ¬´puits¬ª aux archives.  D√®s que PostgreSQL appelle archive_command pour envoyer un fichier, WAL-G recherche s'il y a plus de fichiers √† proximit√© pr√™ts. <br><br>  En g√©n√©ral, ce n'est pas une fonctionnalit√© tr√®s document√©e, elle est tr√®s stable dans les derni√®res versions de PostgreSQL, de nombreuses technologies l'utilisent.  Nous regardons s'il existe des fichiers WAL pr√™ts √† l'emploi dans le statut d'archive, et nous les envoyons √©galement avec celui qui a demand√© d'envoyer la base de donn√©es √† l'archive.  Et quand PostgreSQL leur demande d'envoyer, nous les avons d√©j√† envoy√©s, nous sommes pr√™ts.  Cela acc√©l√®re consid√©rablement l'envoi de WAL sur des bases charg√©es et vous permet de le rendre non monothread.  Normalement, PostgreSQL pr√©pare un fichier, puis attend qu'il disparaisse, pr√©pare le suivant.  Nous parvenons √† √©viter ce travail coh√©rent. <br><br><img src="https://habrastorage.org/webt/pc/3k/5f/pc3k5fkukjj7o5zqxm7hsjr3way.jpeg"><br>  Au cours de WAL-FETCH, lorsque le cluster est restaur√©, nous essayons √©galement de t√©l√©charger les N fichiers suivants qui seront n√©cessaires, et essayons d'√©quilibrer les pauses entre les d√©buts du pr√©r√©glage de nouveaux fichiers WAL afin que nous puissions utiliser toutes les ressources que nous avons autant que possible: soit ex√©cuter sur le r√©seau ou ex√©cuter dans un disque dans de rares cas. <br><br><img src="https://habrastorage.org/webt/pd/v2/mn/pdv2mnfn4_ne1jbp00nhl35n7y4.jpeg"><br>  Tout cela est d√©fini par des variables d'environnement. <br><br><img src="https://habrastorage.org/webt/oe/ro/k5/oerok5u-varh4b3rcwq4dgwarmm.jpeg"><br>  Il y a √©galement simultan√©it√© de faire une copie.  Bien que cette fonctionnalit√© ne soit pas pr√©sente dans diverses versions - A. B. a √©t√© publi√©e dans la version 0.1.10 en juin 2018 - car le parall√©lisme de la lecture √† partir du disque vous garantit d'√™tre ex√©cut√© sur un r√©seau ou un disque.  Ce n'est pas tr√®s bon avec une base de donn√©es charg√©e.  WAL-E avait une fonctionnalit√© permettant la limitation.  Jusqu'√† pr√©sent, nous ne l'avons pas.  Il est n√©cessaire de limiter la vitesse de suppression de la sauvegarde afin que la base puisse vivre sa propre vie et servir la charge. <br><br>  Notre principale caract√©ristique n'est pas vraiment la technologie. <br><br>  Il y a deux ans, Zhenya Dyukov a mis en ≈ìuvre la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">technologie de sauvegarde delta</a> pour Barman, elle n'a pas encore eu lieu, la communaut√© en discute toujours. <br><br>  Il y a presque un an, Zhenya a corrig√© le bogue WAL-E, et nous l'avons envoy√© pendant six mois ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien vers GitHub</a> - environ Ed.).  Tr√®s souvent, dans les solutions open source, il y a un probl√®me avec le fait qu'elles ne sont pas tr√®s bien entretenues. <br><br><img src="https://habrastorage.org/webt/jy/hg/mf/jyhgmfxdz_srayrm8vsxdnq-a3q.jpeg"><br>  Avec WAL-G, tout est assez simple: on l'utilise et je le maintiens.  Si nous ou vous avez besoin de quelque chose, vous signalez simplement que vous avez un probl√®me.  Nous allons essayer de le r√©soudre. <br><br>  La demande standard de la communaut√© est simple - ¬´faisons-le le plus¬ª. <br><br>  Plus de cryptographie, plus de plateformes.  Peut-√™tre pas seulement PostgreSQL, mais MySQL sauvegarde toujours ou autre chose?  Je vois quelques autres choses. <br><br><img src="https://habrastorage.org/webt/yi/sg/ck/yisgckbaa1bhbae-ixrx_u-fetm.jpeg"><br>  Tout d'abord, maintenant lors de l'envoi du ¬´puits¬ª, nous pouvions comprendre quels blocs de base de donn√©es avaient chang√©, analyser ces fichiers WAL et enregistrer des informations sur ce qui avait chang√©. <br><br>  Et lorsque cron arrive avec une autre sauvegarde delta, nous ne pouvions pas analyser la base de donn√©es enti√®re, archiver cette lecture du disque et simplement savoir quelles pages nous devons faire glisser vers le cloud. <br><br>  Nous avons essay√© d'utiliser la technologie de suivi des pages.  Il impl√©mente le suivi des changements de page au niveau du noyau de la base de donn√©es.  La sauvegarde est supprim√©e tr√®s rapidement.  Le principal probl√®me avec PTRACK est qu'il est tr√®s invasif.  Il contient de nombreux changements dans le c≈ìur de PostgreSQL dans des endroits tr√®s sensibles, il est donc peu probable qu'il soit adopt√© bient√¥t. <br><br><img src="https://habrastorage.org/webt/4z/ea/px/4zeapxt_ji4odqmc57wnjpxilik.jpeg"><br>  De plus, ses deltas sont l√©g√®rement diff√©rents des deltas que nous avons maintenant.  Lors de la suppression du delta bas√© sur LSN, nous supprimons toutes les modifications du fichier delta qui se sont produites entre le d√©marrage pr√©c√©dent et l'heure actuelle. <br><br><img src="https://habrastorage.org/webt/ul/oh/pi/ulohpi0sz8mtyz5g018fxactms8.jpeg"><br>  Dans le cas de PTRACK, nous obtenons des modifications dans le fichier delta, √† partir du delta pr√©c√©dent re√ßu.  Nous n'avons pas l'heure delta exacte avant le d√©but de la sauvegarde, avant le d√©but des modifications.  Ce n'est pas le principal probl√®me de PTRACK, en g√©n√©ral, cela fonctionne bien, mais jusqu'√† pr√©sent, il est difficile √† accepter. <br><br><img src="https://habrastorage.org/webt/9-/qv/ou/9-qvouutaphuo35-ag0q_w1nnww.jpeg"><br>  PTRACK n'autorise pas la suppression de delta en mode LATEST_FULL, car il stocke une carte des blocs modifi√©s de la suppression pr√©c√©dente de cette carte.  Oracle a une technologie int√©ressante, il y a 8 cartes pr√©c√©dentes qu'ils enregistrent juste au cas o√π.  Nous pourrions peut-√™tre faire quelque chose de similaire, mais jusqu'√† pr√©sent, nous ne travaillons pas dans cette direction. <br><br><img src="https://habrastorage.org/webt/bx/do/z-/bxdoz-i2yzsnya6y6kzqbc30e3y.jpeg"><br><h5>  <sub><sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sup></sub> </h5><br>  En septembre de l'ann√©e derni√®re, j'ai essay√© d'offrir √† la communaut√© une technologie bas√©e sur le fait que nous ajoutons uniquement les crochets dont nous avons besoin au noyau, et nous impl√©mentons le suivi des pages modifi√©es en extension afin que le patch de suivi de page ne soit pas trop invasif.  Apr√®s avoir discut√© de cette technologie, nous sommes arriv√©s √† la conclusion que nous avons besoin de plusieurs prototypes, et nous ajouterons des crochets lorsqu'il y aura des prototypes.  Nous verrons peut-√™tre comment ils fonctionnent.  Je travaille actuellement sur des prototypes de ces extensions qui pourraient utiliser des crochets du noyau pour suivre les modifications de la base de donn√©es. <br><br>  Il y a une expression dans la communaut√© que chaque postgresista doit avoir son propre outil de sauvegarde.  C'est mauvais.  Chacun fait sa propre chose, qui fait une t√¢che critique.  Il doit y avoir une chose dans laquelle tout sera dans la bo√Æte, tout sera parfait dans un monde id√©al. <br><br>  Que voudrais-je voir dans une bo√Æte de basebackup?  Nous aimerions voir, probablement, l'archivage dans le cloud.  Et des copies delta. <br><br><img src="https://habrastorage.org/webt/6w/ea/zh/6weazhzi3fkxbhvzz2tlrdj4ujg.jpeg"><br>  Je voudrais aussi la compression, la simultan√©it√©, le chiffrement, la limitation, la liste des sauvegardes, la v√©rification, la validation des sauvegardes ... Beaucoup de choses.  Nous comprenons que si tout cela est maintenant offert √† la communaut√©, cela se traduira par plusieurs dizaines de correctifs, qui sont plut√¥t difficiles √† discuter et √† mettre en ≈ìuvre via commitfest.  Par cons√©quent, nous utilisons toujours un outil s√©par√©, mais nous souhaitons consacrer du temps et de la technologie √† la communaut√© pour am√©liorer PostgreSQL. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415817/">https://habr.com/ru/post/fr415817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415805/index.html">Modification du module barri√®re GSM Doorhan pour le contr√¥le Internet</a></li>
<li><a href="../fr415809/index.html">Comment utiliser le soja, requirejs, backbone js dans les plugins pour Atlassian Jira</a></li>
<li><a href="../fr415811/index.html">AI, cours pratique. Vue d'ensemble des r√©seaux de neurones pour la classification d'images</a></li>
<li><a href="../fr415813/index.html">Quelques notes sur l'√©tat actuel du Cloud Gaming</a></li>
<li><a href="../fr415815/index.html">√Ä la pointe de la science: une analyse des articles arxiv.org</a></li>
<li><a href="../fr415819/index.html">Rapport 2018 du Club de Rome, chapitre 3.16: Gouvernement mondial</a></li>
<li><a href="../fr415821/index.html">La fa√ßon d'organiser une maison "intelligente" avec la commande √©lectrique la plus large possible</a></li>
<li><a href="../fr415823/index.html">FindFace ferme pour les simples mortels</a></li>
<li><a href="../fr415829/index.html">Introduction aux classes de donn√©es</a></li>
<li><a href="../fr415831/index.html">Les dix nouveaux commandements de Roskosmos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>