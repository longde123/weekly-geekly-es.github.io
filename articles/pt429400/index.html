<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéé üçµ üöò Seals vs neural network 2. Ou execute o SqueezeNet v.1.1 no Raspberry Zero em tempo real (quase) üë®üèø üë©üèΩ‚Äçü§ù‚Äçüë©üèº üöó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 

 Depois de escrever a primeira parte, que n√£o era muito s√©ria e nem particularmente √∫til em termos pr√°ticos, minha consci√™ncia me engol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seals vs neural network 2. Ou execute o SqueezeNet v.1.1 no Raspberry Zero em tempo real (quase)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429400/">  Ol√° pessoal! <br><br>  Depois de escrever a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte, que</a> n√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">era</a> muito s√©ria e nem particularmente √∫til em termos pr√°ticos, minha consci√™ncia me engoliu um pouco.  E eu decidi terminar o que comecei.  Ou seja, escolher a mesma implementa√ß√£o de uma rede neural para rodar no Rasperry Pi Zero W em tempo real (√© claro, o m√°ximo poss√≠vel nesse hardware).  Para expuls√°-la dos dados da vida real e iluminar os resultados em Habr√©. <br><br>  Cuidado  Existe um c√≥digo vi√°vel e mais alguns gatos sob o corte do que na primeira parte.  Na foto, ber√ßo e bacalhau, respectivamente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/hp/-p/_nhp-pj5btxq5w0yvmwdnd-kguc.jpeg" alt="imagem"></div><a name="habracut"></a><br><h2>  Qual rede escolher? </h2><br>  Lembro-me de que, devido √† fraqueza do ferro framboesa, a escolha das realiza√ß√µes da rede neural √© pequena.  Ou seja: <br><br>  1. SqueezeNet. <br>  2. YOLOv3 min√∫sculo. <br>  3. MobileNet. <br>  4. ShuffleNet. <br><br>  Qu√£o correta foi a escolha a favor do SqueezeNet na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte</a> ? .. Executar cada uma das redes neurais acima mencionadas no seu hardware √© um evento bastante longo.  Portanto, atormentado por vagas d√∫vidas, decidi pesquisar no Google se algu√©m tivesse feito uma pergunta dessas antes de mim.  Aconteceu que ele se perguntou e investigou em detalhes.  Aqueles que desejam podem consultar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fonte</a> .  Vou me limitar a uma √∫nica imagem: <br><br><img src="https://habrastorage.org/webt/gh/qq/_r/ghqq_rgrl9wjl13hsf7mtrbsyj4.png" alt="imagem"><br><br>  A partir da figura, o tempo de processamento de uma imagem para diferentes modelos treinados no conjunto de dados ImageNet √© o m√≠nimo com o SqueezeNet v.1.1.  Tomaremos isso como um guia de a√ß√£o.  O YOLOv3 n√£o foi inclu√≠do na compara√ß√£o, mas, tanto quanto me lembro, o YOLO √© mais caro que o MobileNet.  I.e.  tamb√©m deve ter velocidade inferior ao SqueezeNet. <br><br><h2>  Implementa√ß√£o da rede selecionada </h2><br>  Os pesos e topologia do SqueezeNet treinados no conjunto de dados ImageNet (estrutura Caffe) podem ser encontrados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> .  Apenas para o caso, baixei as duas vers√µes para que depois pudessem ser comparadas.  Por que ImageNet?  Esse conjunto de todos os dispon√≠veis tem o n√∫mero m√°ximo de classes (1000 unid.). Portanto, os resultados da rede neural prometem ser bastante interessantes. <br><br>  Desta vez, veremos como o Raspberry Zero lida com o reconhecimento de quadros da c√¢mera.  Aqui est√° ele, nosso humilde trabalhador do post de hoje: <br><br><img src="https://habrastorage.org/webt/uu/vw/4a/uuvw4axgowtwqs1l-7q6wq94ej4.jpeg" alt="imagem"><br><br>  Peguei o c√≥digo-fonte do blog Adrian Rosebrock mencionado na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte</a> como base do c√≥digo, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">partir daqui</a> .  Mas eu tive que arar significativamente: <br><br>  1. Substitua seu modelo pelo MobileNetSSD no SqueezeNet. <br>  2. A implementa√ß√£o da Cl√°usula 1 levou √† expans√£o do n√∫mero de classes para 1000. Mas, ao mesmo tempo, a fun√ß√£o de destacar objetos com quadros multicoloridos (SSD funcional) foi, infelizmente, removida. <br>  3. Para remover a recep√ß√£o de argumentos pela linha de comando (por algum motivo, essa entrada de par√¢metros me incomoda). <br>  4. Remova o m√©todo VideoStream e, com ele, a biblioteca imutils amada por Adrian.  Inicialmente, o m√©todo foi usado para obter o fluxo de v√≠deo da c√¢mera.  Mas com minha c√¢mera conectada ao Raspberry Zero, estupidamente n√£o funcionou, fornecendo algo como "Instru√ß√µes ilegais". <br>  5. Adicione a taxa de quadros (FPS) √† imagem reconhecida, reescreva o c√°lculo do FPS. <br>  6. Crie quadros salvos para escrever este post. <br><br>  No raspberry com o Rapbian Stretch OS, Python 3.5.3 e instalado atrav√©s do pip3, instale o OpenCV 3.4.1, o seguinte foi iniciado e iniciado: <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo aqui</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> picamera <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> picamera.array <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PiRGBArray <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-comment"><span class="hljs-comment">#    prototxt = 'models/squeezenet_v1.1.prototxt' model = 'models/squeezenet_v1.1.caffemodel' labels = 'models/synset_words.txt' #    rows = open(labels).read().strip().split("\n") classes = [r[r.find(" ") + 1:].split(",")[0] for r in rows] #    print("[INFO] loading model...") net = cv2.dnn.readNetFromCaffe(prototxt, model) print("[INFO] starting video stream...") #   camera = picamera.PiCamera() camera.resolution = (640, 480) camera.framerate = 25 #   camera.start_preview() sleep(1) camera.stop_preview() #     raw rawCapture = PiRGBArray(camera) #   FPS t0 = time.time() #     for frame in camera.capture_continuous(rawCapture, format="bgr", use_video_port=True): #    blob frame = rawCapture.array blob = cv2.dnn.blobFromImage(frame, 1, (224, 224), (104, 117, 124)) #    blob,     net.setInput(blob) preds = net.forward() preds = preds.reshape((1, len(classes))) idxs = int(np.argsort(preds[0])[::-1][:1]) #  FPS FPS = 1/(time.time() - t0) t0 = time.time() #    ,   FPS,    text = "Label: {}, p = {:.2f}%, fps = {:.2f}".format(classes[idxs], preds[0][idxs] * 100, FPS) cv2.putText(frame, text, (5, 25), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255), 2) print(text) cv2.imshow("Frame", frame) #     Raspberry fname = 'pic_' + dt.datetime.now().strftime('%Y-%m-%d_%H-%M-%S') + '.jpg' cv2.imwrite(fname, frame) #    SD  key = cv2.waitKey(1) &amp; 0xFF #    `q`    if key == ord("q"): break #   raw       rawCapture.truncate(0) print("[INFO] video stream is terminated") #    cv2.destroyAllWindows() camera.close()</span></span></code> </pre> <br></div></div><br><h2>  Resultados </h2><br>  O c√≥digo √© exibido na tela do monitor conectado ao Raspberry, o pr√≥ximo quadro reconhecido neste formul√°rio.  Na parte superior do quadro, apenas a classe mais prov√°vel √© exibida. <br><br><img src="https://habrastorage.org/webt/io/65/7s/io657sevsvfzlgnq803buqvv-mo.jpeg" alt="imagem"><br><br>  Portanto, um mouse de computador foi identificado como um mouse com uma probabilidade muito alta.  Ao mesmo tempo, as imagens s√£o atualizadas com uma frequ√™ncia de 0,34 FPS (ou seja, aproximadamente a cada tr√™s segundos).  √â um pouco chato segurar a c√¢mera e esperar que o pr√≥ximo quadro seja processado, mas voc√™ pode viver.  A prop√≥sito, se voc√™ remover o quadro de salvamento no cart√£o SD, a velocidade de processamento aumentar√° para 0,37 ... 0,38 FPS.  Certamente, existem outras maneiras de dispersar.  Vamos esperar e ver, em qualquer caso, deixaremos esta pergunta para os pr√≥ximos posts. <br><br>  Separadamente, pe√ßo desculpas pelo balan√ßo de branco.  O fato √© que a c√¢mera de infravermelho com a luz de fundo ligada estava conectada ao Rapberry; portanto, a maioria dos quadros parece estranha.  Mas quanto mais valioso cada acerto da rede neural.  Obviamente, o balan√ßo de branco no conjunto de treinamento estava mais correto.  Al√©m disso, decidi inserir apenas os quadros brutos, para que o leitor os veja da mesma maneira que v√™em a rede neural. <br><br>  Primeiro, vamos comparar o trabalho das vers√µes 1.0 do SqueezeNet (no quadro esquerdo) e 1.1 (no direito): <br><br><img src="https://habrastorage.org/webt/zc/rs/ao/zcrsaocvvwb7nmdhi3zg6v-fuwe.jpeg" alt="imagem"><br><br>  Pode-se ver que a vers√£o 1.1 funciona duas vezes e quinze vezes mais r√°pido que 1.0 (0,34 FPS versus 0,15).  O ganho de velocidade √© palp√°vel.  N√£o vale a pena tirar conclus√µes sobre a precis√£o do reconhecimento neste exemplo, pois a precis√£o depende muito da posi√ß√£o da c√¢mera em rela√ß√£o ao objeto, ilumina√ß√£o, brilho, sombras etc. <br><br>  Em vista de uma vantagem de velocidade t√£o significativa v1.1 sobre v.1.0 no futuro, apenas o SqueezeNet v.1.1 foi usado.  Para avaliar o desempenho do modelo, apontei a c√¢mera para v√°rios objetos que <s>estavam √† m√£o</s> e recebi os seguintes quadros na sa√≠da: <br><br><img src="https://habrastorage.org/webt/lo/nq/6v/lonq6vrvcdqtyld8eowva01yn6a.jpeg" alt="imagem"><br><br>  Um teclado √© pior que um mouse.  Talvez no conjunto de treinamento, a maioria dos teclados fosse branca. <br><br><img src="https://habrastorage.org/webt/ds/2j/et/ds2jete8bvrzzvq1wtlvhvxad_a.jpeg" alt="imagem"><br><br>  Um telefone celular √© muito bem definido se voc√™ ligar a tela.  Uma c√©lula com uma tela desligada n√£o conta uma rede neural como c√©lula. <br><br><img src="https://habrastorage.org/webt/ke/zy/hs/kezyhs6o4dutrhqyjys0b7axyf0.jpeg" alt="imagem"><br><br>  Uma x√≠cara vazia √© razoavelmente definida como uma x√≠cara de caf√©.  At√© agora, tudo est√° indo muito bem. <br><br><img src="https://habrastorage.org/webt/co/xk/fi/coxkfidvlt1vgcec0rgvcop4yq4.jpeg" alt="imagem"><br><br>  As tesouras est√£o em piores condi√ß√µes: s√£o teimosamente definidas pela rede como um grampo de cabelo.  No entanto, entrar na macieira, se n√£o no alvo) <br><br><h2>  Vamos complicar a tarefa </h2><br>  Vamos tentar colocar algo complicado na rede neural do <s>porco</s> .  Acabei de encontrar um brinquedo infantil caseiro.  Acredito que a maioria dos leitores o reconhe√ßa como um gato de brinquedo.  Eu me pergunto o que ser√° considerado por nossa intelig√™ncia artificial rudimentar. <br><br><img src="https://habrastorage.org/webt/ye/vr/1b/yevr1bf2unalpdxfuta9txi8g3y.jpeg" alt="imagem"><br><br>  No quadro √† esquerda, a luz infravermelha apagou todas as tiras do tecido.  Como resultado, o brinquedo foi definido como uma m√°scara de oxig√™nio com uma probabilidade bastante decente.  Porque n√£o  A forma do brinquedo realmente se assemelha a uma m√°scara de oxig√™nio. <br><br>  Na moldura √† direita, cobri meus dedos com um destaque de infravermelho, para que as listras aparecessem no brinquedo e o balan√ßo de branco se tornasse mais cr√≠vel.  Na verdade, esse √© o √∫nico quadro que parece mais ou menos normal neste post.  Mas a rede neural tem uma abund√¢ncia de detalhes na imagem confusa.  Ela identificou o brinquedo como um moletom.  Devo dizer que isso tamb√©m n√£o parece um "dedo no c√©u".  Bata se n√£o estiver na "macieira", pelo menos no pomar). <br><br>  Bem, abordamos sem problemas o cl√≠max de nossa a√ß√£o.  O vencedor de destaque da batalha, consagrado em detalhes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeiro post,</a> entra no ringue.  E tira facilmente o c√©rebro da nossa rede neural desde os primeiros quadros. <br><br><img src="https://habrastorage.org/webt/8l/po/hz/8lpohzb3ijzpmvljyczip7w8uzq.jpeg" alt="imagem"><br><br>  √â curioso que um gato praticamente n√£o mude de posi√ß√£o, mas cada vez que √© determinado de forma diferente.  E desta perspectiva, √© mais parecido com um gamb√°.  Em segundo lugar, √© a semelhan√ßa com um hamster.  Vamos tentar mudar o √¢ngulo. <br><br><img src="https://habrastorage.org/webt/u_/hj/jc/u_hjjc5yj3fdnnm4msadfl-pzys.jpeg" alt="imagem"><br><br>  Sim, se voc√™ tirar uma foto de um gato de cima, √© determinado corretamente, mas se voc√™ mudar um pouco a posi√ß√£o do corpo do gato no quadro, para a rede neural, ele se torna um cachorro - do husky e malamute siberiano (c√£o de tren√≥ esquim√≥), respectivamente. <br><br><img src="https://habrastorage.org/webt/cd/up/oy/cdupoyl2mai8a6ctxorqtdw12mi.jpeg" alt="imagem"><br><br>  E essa sele√ß√£o √© bonita, pois um c√£o de ra√ßas diferentes √© definido em cada quadro separado de um gato.  E as ra√ßas n√£o se repetem) <br><br><img src="https://habrastorage.org/webt/nx/nj/c4/nxnjc45ke4ieyvyreptl2i0nyzw.jpeg" alt="imagem"><br><br>  A prop√≥sito, h√° poses nas quais as redes neurais se tornam √≥bvias de que ainda √© um gato, n√£o um cachorro.  Ou seja, o SqueezeNet v.1.1 ainda conseguiu provar a si mesmo em um objeto t√£o dif√≠cil de analisar.  Dado o sucesso da rede neural no reconhecimento de objetos no in√≠cio do teste e no reconhecimento de um gato como um gato no final, desta vez declaramos um forte empate de combate) <br><br>  Bem, isso √© tudo.  Convido todos a experimentar o c√≥digo proposto em sua framboesa e em qualquer objeto que tenha sido exibido como objetos animados e inanimados.  Serei especialmente grato √†queles que medem o FPS no Rapberry Pi B +.  Prometo incluir os resultados neste post com refer√™ncia √† pessoa que enviou os dados.  Eu acredito que deve sair significativamente mais do que 1 FPS! <br><br>  Espero que algumas das informa√ß√µes contidas neste post sejam √∫teis para fins educacionais ou de entretenimento, e algu√©m possa at√© ter novas id√©ias. <br><br>  Tenham uma boa semana de trabalho!  E at√© breve) <br><br><img src="https://habrastorage.org/webt/a9/-_/gx/a9-_gxtb2qzdzz5nbtbbet66wlg.jpeg" alt="imagem"><br><br>  UPD1: No Raspberry Pi 3B +, o script acima funciona com uma frequ√™ncia de 2 com um pequeno FPS. <br><br>  UPD2: No RPi 3B + com Movidius NCS, o script √© executado em 6 FPS. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429400/">https://habr.com/ru/post/pt429400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429388/index.html">Como fazer um novo design do site e n√£o causar problemas: 4 etapas importantes</a></li>
<li><a href="../pt429390/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 16: ‚ÄúAtaques de Canal Lateral‚Äù, Parte 1</a></li>
<li><a href="../pt429392/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 16: Ataques pelo canal lateral, parte 2</a></li>
<li><a href="../pt429394/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 16: ‚ÄúAtaques de Canal Lateral‚Äù, Parte 3</a></li>
<li><a href="../pt429396/index.html">Como testar um aplicativo ao interagir com a API usando o SoapUI</a></li>
<li><a href="../pt429402/index.html">ML.NET 0.7 (Machine Learning .NET)</a></li>
<li><a href="../pt429404/index.html">8 seg ¬Ω maneiras de priorizar a funcionalidade</a></li>
<li><a href="../pt429406/index.html">"Monstros em jogos ou como criar medo"</a></li>
<li><a href="../pt429410/index.html">Porta 22 SSH para transportar ou n√£o</a></li>
<li><a href="../pt429414/index.html">O futuro do v√≠deo VR - VR180 do Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>