<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥« ğŸ¶ â›²ï¸ æˆ‘éœ€è¦æå‡Kubernetesé›†ç¾¤ï¼Œä½†æ˜¯æˆ‘åªæ˜¯ä¸€ä¸ªä»£ç ç¨‹åºå‘˜ã€‚ æœ‰å‡ºè·¯ ğŸŒ ğŸ‘³ ğŸš¹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ æ ¹æ®æˆ‘çš„ç»éªŒçš„å¦ä¸€ä¸ªè¯´æ˜ã€‚ è¿™æ¬¡æ˜¯å…³äºåŸºç¡€æ¶æ„çš„æµ…è°ˆï¼Œå¦‚æœéœ€è¦å¸è½½æŸäº›ä¸œè¥¿ï¼Œæˆ‘ä¼šä½¿ç”¨è¯¥åŸºç¡€æ¶æ„ï¼Œä½†æ˜¯é™„è¿‘æ²¡æœ‰devOpsä¸“å®¶ ã€‚ ä½†æ˜¯ï¼Œç›®å‰çš„æŠ€æœ¯æŠ½è±¡æ°´å¹³å…è®¸åœ¨å¤œé—´ä½¿ç”¨äº’è”ç½‘å’Œç°æˆçš„ä¸œè¥¿ä½¿ç”¨è¿™ç§åŸºç¡€æ¶æ„æ¥ä½¿ç”¨å¤§çº¦ä¸€å¹´ã€‚ 

 å…³é”®å­—-AWS + Terraform + kops ã€‚ å¦‚æœè¿™å¯¹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘éœ€è¦æå‡Kubernetesé›†ç¾¤ï¼Œä½†æ˜¯æˆ‘åªæ˜¯ä¸€ä¸ªä»£ç ç¨‹åºå‘˜ã€‚ æœ‰å‡ºè·¯</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423481/"><img src="https://habrastorage.org/webt/j9/qc/fb/j9qcfbdq_raamw7rwyt02ci1an8.png"><br><br> å¤§å®¶å¥½ æ ¹æ®æˆ‘çš„ç»éªŒçš„å¦ä¸€ä¸ªè¯´æ˜ã€‚ è¿™æ¬¡æ˜¯å…³äºåŸºç¡€æ¶æ„çš„æµ…è°ˆï¼Œå¦‚æœéœ€è¦å¸è½½æŸäº›ä¸œè¥¿ï¼Œæˆ‘ä¼šä½¿ç”¨è¯¥åŸºç¡€æ¶æ„ï¼Œä½†æ˜¯<b>é™„è¿‘</b>æ²¡æœ‰<b>devOpsä¸“å®¶</b> ã€‚ ä½†æ˜¯ï¼Œç›®å‰çš„æŠ€æœ¯æŠ½è±¡æ°´å¹³å…è®¸åœ¨å¤œé—´ä½¿ç”¨äº’è”ç½‘å’Œç°æˆçš„ä¸œè¥¿ä½¿ç”¨è¿™ç§åŸºç¡€æ¶æ„æ¥ä½¿ç”¨å¤§çº¦ä¸€å¹´ã€‚ <br><br> å…³é”®å­—<b>-AWS</b> + <b>Terraform</b> + <b>kops</b> ã€‚ å¦‚æœè¿™å¯¹æˆ‘æœ‰ç”¨ï¼Œåˆ™å¯èƒ½å¯¹å…¶ä»–äººæœ‰ç”¨ã€‚ æ¬¢è¿å‘è¡¨è¯„è®ºã€‚ <br><a name="habracut"></a><br><h2>  -1ã€‚ æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„æ˜¯ </h2><br> å…¸å‹çš„æƒ…å†µ-è¯¥é¡¹ç›®å·²å†™åˆ°éœ€è¦å°†å…¶å¸è½½åˆ°æŸä¸ªåœ°æ–¹å¹¶å¼€å§‹ä½¿ç”¨çš„é˜¶æ®µã€‚ è€Œä¸”è¯¥é¡¹ç›®æ¯”ç®€å•çš„htmlé¡µé¢æ›´å¤æ‚ã€‚ æˆ‘å¸Œæœ›æ°´å¹³æ‰©å±•ï¼Œåœ¨æœ¬åœ°ï¼Œæµ‹è¯•ï¼Œäº§å“æ¶ä¸Šæˆ–åœ¨æˆ–å¤šæˆ–å°‘çš„æ­£å¸¸éƒ¨ç½²è¿‡ç¨‹ä¸­ç¡®å®šç¯å¢ƒçš„å¯èƒ½æ€§ã€‚ <br><blockquote> å®ƒæ˜¯å…³äº<b>Laravel</b>ä¸Šçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä»¥æ˜¾ç¤º<b>ä»å¤´åˆ°å°¾</b>çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ ä½†æ˜¯ä»¥ç±»ä¼¼çš„æ–¹å¼ï¼Œæ‚¨å¯ä»¥åœ¨æ—…é€”ä¸­éƒ¨ç½²å„ç§æœåŠ¡ï¼Œpythonåº”ç”¨ç¨‹åºï¼ŒWPä¸Šçš„å°å‹ç«™ç‚¹ï¼Œhtmlé¡µé¢ç­‰ç­‰ã€‚ åœ¨ä¸€å®šç¨‹åº¦ä¸Šï¼Œè¿™å·²ç»è¶³å¤Ÿäº†ï¼Œç„¶åä¸€ä¸ªå•ç‹¬çš„äººå‡ºç°åœ¨å›¢é˜Ÿä¸­ï¼Œä»–å°†å¯¹æ­¤è¿›è¡Œå®Œå–„å’Œè¡¥å……ã€‚ </blockquote> æœ€è¿‘ï¼Œæˆ‘å‘ç°æˆ‘åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šå®‰è£…äº†<b>GoLandï¼ŒPhpStormï¼ŒDockerï¼ŒGit</b> ï¼Œå¹¶ä¸”æˆ‘<b>å·²ç»</b>å®Œå…¨å‡†å¤‡å¥½å·¥ä½œäº†ã€‚ æ˜¯çš„ï¼Œæ‚¨å¯ä»¥åœ¨ä¸€å°é›†ç¾¤ä¸­çš„ä¸€å°è®¡ç®—æœºä¸Šè¿›è¡Œç®¡ç†ï¼Œå› æ­¤æˆ‘å°†åœ¨ä¸è€ƒè™‘æ‚¨ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçš„æƒ…å†µä¸‹æè¿°æ•´ä¸ªè¿‡ç¨‹ï¼Œè€Œæ˜¯å°†æ‰€æœ‰å†…å®¹æ‰“åŒ…åœ¨Dockerå®¹å™¨ä¸­ã€‚ <br><br><h2>  0.å‡†å¤‡å·¥ä½œã€‚ </h2><br> å‡è®¾æˆ‘ä»¬å·²ç»åœ¨<b>AWS</b>ä¸Šæ³¨å†Œäº†ä¸€ä¸ªå¸æˆ·ï¼Œé€šè¿‡æŠ€æœ¯æ”¯æŒè¦æ±‚é€šè¿‡åŒæ—¶è¿è¡Œçš„æœåŠ¡å™¨æ•°é‡æ¥å¢åŠ å¸æˆ·é™åˆ¶ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<b>IAM</b>ç”¨æˆ·ï¼Œç°åœ¨æˆ‘ä»¬æ‹¥æœ‰<b>è®¿é—®å¯†é’¥</b> + <b>ç§˜å¯†å¯†é’¥</b> ã€‚  Zone- <b>us-east-1</b> ã€‚ <br><br> æˆ‘ä»¬åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šéœ€è¦ä»€ä¹ˆï¼Ÿ  <b>AWS CLI</b> ï¼Œç”¨äº<b>AWS</b>å£°æ˜å¼ç®¡ç†çš„<b>Terraform</b> ï¼Œ <b>kubectl</b> ï¼Œç”¨äºé…ç½®é›†ç¾¤çš„<b>kops</b>ä»¥åŠç”¨äºéƒ¨ç½²æŸäº›æœåŠ¡çš„<b>Helm</b> ã€‚ æˆ‘ä»¬æ”¶é›†äº†<b>Dockerfile</b> ï¼ˆæˆ‘å¾ˆä¹…ä»¥å‰å°±åœ¨githubçš„å·¨å¤§åœ°æ–¹æ‰¾åˆ°äº†<b>Dockerfile</b> ï¼Œä½†æ˜¯æˆ‘æ‰¾ä¸åˆ°å®ƒçš„ä½ç½®ï¼‰ã€‚ æˆ‘ä»¬ä¸ºè£…è½½ç›®å½•ç¼–å†™<b>docker-compose.yml</b> ï¼Œä¸ºåˆ«åç¼–å†™<b>Makefile</b> ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">Dockeræ–‡ä»¶</b> <div class="spoiler_text"><pre><code class="plaintext hljs">FROM ubuntu:16.04 ARG AWSCLI_VERSION=1.12.1 ARG HELM_VERSION=2.8.2 ARG ISTIO_VERSION=0.6.0 ARG KOPS_VERSION=1.9.0 ARG KUBECTL_VERSION=1.10.1 ARG TERRAFORM_VERSION=0.11.0 # Install generally useful things RUN apt-get update \ &amp;&amp; apt-get -y --force-yes install --no-install-recommends \ curl \ dnsutils \ git \ jq \ net-tools \ ssh \ telnet \ unzip \ vim \ wget \ &amp;&amp; apt-get clean \ &amp;&amp; apt-get autoclean \ &amp;&amp; apt-get autoremove \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* # Install AWS CLI RUN apt-get update \ &amp;&amp; apt-get -y --force-yes install \ python-pip \ &amp;&amp; pip install awscli==${AWSCLI_VERSION} \ &amp;&amp; apt-get clean \ &amp;&amp; apt-get autoclean \ &amp;&amp; apt-get autoremove \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* # Install Terraform RUN wget -O terraform.zip https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip \ &amp;&amp; unzip terraform.zip \ &amp;&amp; mv terraform /usr/local/bin/terraform \ &amp;&amp; chmod +x /usr/local/bin/terraform \ &amp;&amp; rm terraform.zip # Install kubectl ADD https://storage.googleapis.com/kubernetes-release/release/v${KUBECTL_VERSION}/bin/linux/amd64/kubectl /usr/local/bin/kubectl RUN chmod +x /usr/local/bin/kubectl # Install Kops ADD https://github.com/kubernetes/kops/releases/download/${KOPS_VERSION}/kops-linux-amd64 /usr/local/bin/kops RUN chmod +x /usr/local/bin/kops # Install Helm RUN wget -O helm.tar.gz https://storage.googleapis.com/kubernetes-helm/helm-v${HELM_VERSION}-linux-amd64.tar.gz \ &amp;&amp; tar xfz helm.tar.gz \ &amp;&amp; mv linux-amd64/helm /usr/local/bin/helm \ &amp;&amp; chmod +x /usr/local/bin/helm \ &amp;&amp; rm -Rf linux-amd64 \ &amp;&amp; rm helm.tar.gz # Create default user "kops" RUN useradd -ms /bin/bash kops WORKDIR /home/kops USER kops # Ensure the prompt doesn't break if we don't mount the ~/.kube directory RUN mkdir /home/kops/.kube \ &amp;&amp; touch /home/kops/.kube/config</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: '2.1' services: cluster-main: container_name: cluster.com image: cluster.com user: root stdin_open: true volumes: - ./data:/data - ./.ssh:/root/.ssh - ./.kube:/root/.kube - ./.aws:/root/.aws cluster-proxy: container_name: cluster.com-kubectl-proxy image: cluster.com user: root entrypoint: kubectl proxy --address='0.0.0.0' --port=8001 --accept-hosts='.*' ports: - "8001:8001" stdin_open: true volumes: - ./data:/data - ./.ssh:/root/.ssh - ./.kube:/root/.kube - ./.aws:/root/.aws</code> </pre><br></div></div><div class="spoiler">  <b class="spoiler_title">ç”Ÿæˆæ–‡ä»¶</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">docker.build: docker build -t cluster.com . docker.run: docker-compose up -d docker.bash: docker exec -it cluster.com bash</code> </pre> <br></div></div><br>  <b>Dockerfile-</b>è·å–åŸºæœ¬çš„ubuntuæ˜ åƒå¹¶å®‰è£…æ‰€æœ‰è½¯ä»¶ã€‚  <b>Makefile-</b>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸¸è§„çš„åˆ«åæœºåˆ¶ã€‚  <b>Docker-compose.yml-</b>æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé¢å¤–çš„å®¹å™¨ï¼Œå¦‚æœæ‚¨éœ€è¦ç›´è§‚åœ°çœ‹åˆ°æŸäº›ä¸œè¥¿ï¼Œå®ƒå°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŠŠ</a>æˆ‘ä»¬æ‰”è¿›<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">K8Sä»ªè¡¨æ¿</a>æµè§ˆå™¨ã€‚ <br><br> æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸­åˆ›å»º<b>data</b> ï¼Œ <b>.ssh</b> ï¼Œ <b>.kube</b>å’Œ<b>.awsæ–‡ä»¶å¤¹</b> ï¼Œå¹¶åœ¨å…¶ä¸­æ”¾ç½®awsï¼Œsshå¯†é’¥çš„é…ç½®ï¼Œç„¶åå¯ä»¥é€šè¿‡<b>make docker.buildå’Œmake docker.run</b>æ”¶é›†å¹¶è¿è¡Œå®¹å™¨ã€‚ <br><br> å¥½å§ï¼Œåœ¨<b>data</b>æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨å…¶ä¸­æ”¾ç½®<b>yaml k8s</b>æ–‡ä»¶ï¼Œç„¶ååœ¨ç¬¬äºŒä¸ªæ–‡ä»¶å¤¹æ—è¾¹ï¼Œå­˜å‚¨é›†ç¾¤çš„<b>åœ°å½¢</b>çŠ¶æ€ã€‚ æˆ‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>æŠŠ</b></a>è¿™ä¸ªé˜¶æ®µ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>çš„</b></a>å¤§æ¦‚ç»“æœ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>æ”¾åœ¨githubä¸Š</b></a> ã€‚ <br><br><h2>  1.æå‡é›†ç¾¤ã€‚ </h2><br><blockquote> æ¥ä¸‹æ¥å°†æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤</a>æ³¨é‡Šçš„å…è´¹ç¿»è¯‘ã€‚ æˆ‘å°†çœç•¥è®¸å¤šç†è®ºè¦ç‚¹ï¼Œå°è¯•æè¿°ä¸€ä¸ªç®€çŸ­çš„æŒ¤å‹ã€‚ éƒ½ä¸€æ ·ï¼Œæˆ‘çš„æ³¨é‡Šæ ¼å¼ä¸ºtldrã€‚ </blockquote><br> åœ¨æˆ‘ä»¬çš„<b>data / aws-cluster-init-kops-terraformæ–‡ä»¶å¤¹ä¸­ï¼Œæˆ‘ä»¬</b>å…‹éš†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯¥</a>å­˜å‚¨åº“ä¸­çš„å†…å®¹ï¼Œç„¶åé€šè¿‡<b>make docker.bash</b>è¿›å…¥å®¹å™¨æ§åˆ¶å°ã€‚ æ— èŠçš„å›¢é˜Ÿå¼€å§‹åˆ†æ•£ã€‚ <br><br><h4>  AWS CLI </h4><br> æˆ‘ä»¬åˆ›å»ºç”¨æˆ·<b>kops</b> ï¼Œæ·»åŠ è®¿é—®æƒé™å¹¶åœ¨å…¶ä¸Šé‡æ–°é…ç½®<b>AWS CLI</b> ï¼Œä»¥å…è¿è¡Œè¶…çº§ç”¨æˆ·çš„å‘½ä»¤ã€‚ <br><br><pre> <code class="bash hljs">aws iam create-group --group-name kops <span class="hljs-comment"><span class="hljs-comment">#   aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonRoute53FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/IAMFullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AWSCertificateManagerFullAccess --group-name kops aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonVPCFullAccess --group-name kops aws iam create-user --user-name kops aws iam add-user-to-group --user-name kops --group-name kops aws iam create-access-key --user-name kops</span></span></code> </pre><br><pre> <code class="bash hljs">aws configure</code> </pre><br><h4> åˆå§‹åŒ–Terraform </h4><br> åœ¨æ–‡ä»¶<b>æ•°æ®/aws-cluster-init-kops-terraform/variables.tfä¸­</b> ï¼Œå°†ç¾¤é›†<b>çš„</b>åç§°<b>æ›´æ”¹</b>ä¸ºæ‰€éœ€<b>çš„</b>åç§°ã€‚ ä¸è¦å¿˜è®°ä»<b>update.json</b>æ–‡ä»¶ä¸­è·å–æˆ‘ä»¬çš„dnsæœåŠ¡å™¨ï¼Œå¹¶åœ¨è´­ä¹°åŸŸåçš„åœ°æ–¹å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    cd /data/aws-cluster-init-kops-terraform #    AWS CLI export AWS_ACCESS_KEY_ID=$(aws configure get aws_access_key_id) export AWS_SECRET_ACCESS_KEY=$(aws configure get aws_secret_access_key) #  terraform terraform init terraform get terraform apply #  NS  cat update-zone.json \ | jq ".Changes[].ResourceRecordSet.Name=\"$(terraform output name).\"" \ | jq ".Changes[].ResourceRecordSet.ResourceRecords=$(terraform output -json name_servers | jq '.value|[{"Value": .[]}]')" \ &gt; update-zone.json</span></span></code> </pre><br><h4> ç§‘æ™®æ–¯ </h4><br> æˆ‘ä»¬é€šè¿‡<b>kops</b>åˆ›å»ºé›†ç¾¤ï¼Œå°†é…ç½®å¯¼å‡ºåˆ°<b>.tf</b>æ–‡ä»¶ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> NAME=$(terraform output cluster_name) <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> KOPS_STATE_STORE=$(terraform output state_store) <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ZONES=$(terraform output -json availability_zones | jq -r <span class="hljs-string"><span class="hljs-string">'.value|join(",")'</span></span>) kops create cluster \ --master-zones <span class="hljs-variable"><span class="hljs-variable">$ZONES</span></span> \ --zones <span class="hljs-variable"><span class="hljs-variable">$ZONES</span></span> \ --topology private \ --dns-zone $(terraform output public_zone_id) \ --networking calico \ --vpc $(terraform output vpc_id) \ --target=terraform \ --out=. \ <span class="hljs-variable"><span class="hljs-variable">${NAME}</span></span></code> </pre><br><blockquote> è¿™é‡Œéœ€è¦ä¸€ç‚¹è¯´æ˜ã€‚  <b>Terraform</b>å°†åˆ›å»ºä¸€ä¸ª<b>VPC</b> ï¼Œæˆ‘ä»¬å°†éœ€è¦ç¨å¾®è°ƒæ•´<b>kops</b>å°†ä¸º<b>æˆ‘ä»¬</b>æä¾›çš„é…ç½®ã€‚ é€šè¿‡<b>ryane / gensubnets</b>è¾…åŠ©å›¾åƒéå¸¸ç®€å•åœ°å®Œæˆæ­¤æ“ä½œ<b>ï¼š0.1</b> <br></blockquote><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   terraform output -json &gt; subnets.json</span></span></code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     echo subnets.json | docker run --rm -i ryane/gensubnets:0.1</span></span></code> </pre><br> æ‚¨å¯ä»¥ä¸ºroute53æ·»åŠ ç«‹å³ç­–ç•¥ã€‚ <br><br><pre> <code class="plaintext hljs">additionalPolicies: master: | [ { "Effect": "Allow", "Action": ["route53:ListHostedZonesByName"], "Resource": ["*"] }, { "Effect": "Allow", "Action": ["elasticloadbalancing:DescribeLoadBalancers"], "Resource": ["*"] }, { "Effect": "Allow", "Action": ["route53:ChangeResourceRecordSets"], "Resource": ["*"] } ] node: | [ { "Effect": "Allow", "Action": ["route53:ListHostedZonesByName"], "Resource": ["*"] }, { "Effect": "Allow", "Action": ["elasticloadbalancing:DescribeLoadBalancers"], "Resource": ["*"] }, { "Effect": "Allow", "Action": ["route53:ChangeResourceRecordSets"], "Resource": ["*"] } ]</code> </pre><br> é€šè¿‡<b>kopsç¼–è¾‘ç¼–è¾‘ç¾¤é›†$ {NAME}</b> ã€‚ <br><br><img src="https://habrastorage.org/webt/yw/wg/w4/ywwgw42_afdmr__elg0og_yjruk.png"><br><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥æé«˜é›†ç¾¤æœ¬èº«ã€‚ <br><br><pre> <code class="bash hljs">kops update cluster \ --out=. \ --target=terraform \ <span class="hljs-variable"><span class="hljs-variable">${NAME}</span></span> terraform apply</code> </pre><br> ä¸€åˆ‡éƒ½ä¼šé¡ºåˆ©è¿›è¡Œï¼Œ <b>kubectl</b>çš„ä¸Šä¸‹æ–‡å°†ä¼šæ”¹å˜ã€‚ åœ¨æ–‡ä»¶å¤¹<b>data / aws-cluster-init-kops-terraformä¸­</b> ï¼Œæˆ‘ä»¬å°†å­˜å‚¨é›†ç¾¤çŠ¶æ€ã€‚ æ‚¨å¯ä»¥å°†æ‰€æœ‰å†…å®¹æ”¾å…¥<b>git</b>å¹¶å°†å…¶å‘é€åˆ°ç§æœ‰bitpackå­˜å‚¨åº“ã€‚ <br><br><pre> <code class="bash hljs">$ kubectl get nodes NAME STATUS AGE ip-10-20-101-252.ec2.internal Ready,master 7m ip-10-20-103-232.ec2.internal Ready,master 7m ip-10-20-103-75.ec2.internal Ready 5m ip-10-20-104-127.ec2.internal Ready,master 6m ip-10-20-104-6.ec2.internal Ready 5m</code> </pre><br><h2>  2.æå‡ºç”³è¯· </h2><br> ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é›†ç¾¤ä¸­éƒ¨ç½²æˆ‘ä»¬çš„æœåŠ¡äº†ã€‚ æˆ‘å°†è¿‘ä¼¼çš„é…ç½®æ”¾åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŒä¸€å­˜å‚¨åº“ä¸­</a> ã€‚ å®ƒä»¬å¯ä»¥ä»¥<b>æ•°æ®/ k8sçš„</b>å½¢å¼æ”¾åœ¨æ•°æ®åŒ…ä¸­ã€‚ <br><br><h4> æœåŠ¡ç¬‘è¯ </h4><br> è®©æˆ‘ä»¬ä»æœåŠ¡å†…å®¹å¼€å§‹ã€‚ æˆ‘ä»¬éœ€è¦<b>helm</b> ï¼Œ <b>route53</b> ï¼Œ <b>å­˜å‚¨ç±»ï¼Œ</b>å¹¶éœ€è¦è®¿é—®æˆ‘ä»¬åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Hub.docker.com</a>ä¸Šçš„ç§æœ‰<b>æ³¨å†Œè¡¨</b> ã€‚ å¥½å§ï¼Œæˆ–è€…ä»»ä½•å…¶ä»–ï¼Œå¦‚æœæœ‰è¿™æ ·çš„æ„¿æœ›ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Init helm kubectl create serviceaccount --namespace kube-system tiller kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller kubectl patch deploy --namespace kube-system tiller-deploy -p '{"spec":{"template":{"spec":{"serviceAccount":"tiller"}}}}' helm init</span></span></code> </pre><br><pre> <code class="bash hljs">kubectl apply -f default-namespace.yaml kubectl apply -f storage-classes.yaml kubectl apply -f route53.yaml kubectl apply -f docker-hub-secret.yml kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</code> </pre><br><h4>  PostgreSQL + Redis </h4><br> æˆ‘ä½¿ç”¨dockerçƒ§äº†å¾ˆå¤šéï¼Œè€Œä¸æ˜¯<b>æ— çŠ¶æ€</b>å®¹å™¨ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€åä¸€ç§é…ç½®è¢«è¯æ˜æ˜¯æœ€åˆé€‚çš„ã€‚ æˆ‘ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>Stolon</b></a>æä¾›å¯ä¼¸ç¼©æ€§ã€‚ å¤§çº¦ä¸€å¹´çš„é£è¡Œæ˜¯æ­£å¸¸çš„ã€‚ <br><br> æˆ‘ä»¬éƒ¨ç½²äº†<b>å¤´ç›”å›¾è¡¨</b>å’Œå‡ ä¸ªå¿«é€Ÿçš„<b>Redis</b>é…ç½®ã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  etcd  stolon cd etcd-chart helm install --name global-etcd . #   stolon cd stolon-chart helm dep build helm install --name global-postgres . #  redis kubectl apply -f redis</span></span></code> </pre><br><h4>  Nginx + PHP </h4><br> é€šå¸¸çš„ä¸€å †ã€‚  <b>Nginx</b>å’Œ<b>php-fpm</b> ã€‚ æˆ‘æ²¡æœ‰ç‰¹åˆ«æ¸…ç†é…ç½®ï¼Œä½†æ¯ä¸ªäººéƒ½å¯ä»¥è‡ªè¡Œé…ç½®ã€‚ ç”³è¯·ä¹‹å‰ï¼Œæ‚¨å¿…é¡»æŒ‡å®šè¦ä»ä¸­è·å–ä»£ç çš„å›¾åƒï¼Œç„¶åä»<b>AWS Certificate Manager</b>æ·»åŠ è¯ä¹¦è¡Œã€‚  PHPæœ¬èº«-æ‚¨å¯ä»¥ä»dockerhabä¸­è·å–å®ƒï¼Œä½†æ˜¯æˆ‘é€šè¿‡æ·»åŠ ä¸€äº›åº“æ¥æ„å»ºäº†æˆ‘çš„ç§æœ‰åº“ã€‚ <br><br><pre> <code class="bash hljs">kubectl apply -f nginx kubectl apply -f php</code> </pre><br> åœ¨å¸¦æœ‰ä»£ç çš„æ˜ åƒä¸­ï¼Œæˆ‘ä»¬å°†å…¶å­˜å‚¨åœ¨<b>/ crm-code</b>æ–‡ä»¶å¤¹ä¸­ã€‚ æˆ‘ä»¬ç”¨æ‚¨çš„å›¾ç‰‡æ›¿æ¢äº†å®ƒï¼Œå®ƒå°†å¯ä»¥æ­£å¸¸å·¥ä½œã€‚ è¯¥æ–‡ä»¶æ˜¯<b>nginx / deployment.yml</b> ã€‚ <br><br><img src="https://habrastorage.org/webt/xy/0k/0a/xy0k0axs4muxujs3b-dyp8ncske.png"><br><br> å¸¦å‡ºåŸŸã€‚  <b>Route53</b>æœåŠ¡å°†å¯¹å…¶è¿›è¡Œæå–ï¼Œæ›´æ”¹/æ·»åŠ DNSè®°å½•ï¼Œè¯¥è¯ä¹¦å°†ä»<b>AWS Certificate Manager</b> <b>ä¸Šè½½åˆ°ELB</b> ã€‚ è¯¥æ–‡ä»¶æ˜¯<b>nginx / service.yml</b> ã€‚ <br><br><img src="https://habrastorage.org/webt/aw/nl/ya/awnlyaieynoajtmb_feavw2_qke.png"><br><br> è½¬å‘phpä¸­çš„envå˜é‡ä»¥ä½¿å…¶åŒ…å«åœ¨å…¶ä¸­å¹¶è¿æ¥åˆ°<b>PostgreSQL / Redis</b> ã€‚ è¯¥æ–‡ä»¶ä¸º<b>php / deployment.yml</b> ã€‚ <br><br><img src="https://habrastorage.org/webt/ry/n9/v4/ryn9v42o_jvzafh16vr3m2rcpo4.png"><br><br> ç»“æœï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ª<b>K8S</b>é›†ç¾¤ï¼Œåœ¨åŸºæœ¬çº§åˆ«ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ‰©å±•ï¼Œæ·»åŠ æ–°æœåŠ¡ï¼Œæ–°æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰ï¼Œæ›´æ”¹<b>PostgreSQLï¼ŒPHPï¼ŒNginx</b>å®ä¾‹çš„æ•°é‡å¹¶åœ¨ä¸€ä¸ªå•ç‹¬çš„äººå‡ºç°åœ¨å›¢é˜Ÿä¸­ä¹‹å‰å°†å…¶è¿è¡Œã€‚ <br><br> ä½œä¸ºæœ¬ç®€çŸ­è¯´æ˜çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘å°†ä¸æ¶‰åŠæ‰€æœ‰è¿™äº›å†…å®¹çš„å¤‡ä»½/ç›‘è§†é—®é¢˜ã€‚ åœ¨åˆå§‹é˜¶æ®µï¼Œé€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">K8Sä»ªè¡¨æ¿</a>æœåŠ¡æä¾›<b>localhost</b>å°±è¶³å¤Ÿäº†<b>ï¼š8001 / ui</b> ã€‚ ç¨åï¼Œå¯ä»¥å›ºå®š<b>Prometheus</b> ï¼Œ <b>Grafana</b> ï¼Œ <b>Barman</b>æˆ–ä»»ä½•å…¶ä»–ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆã€‚ <br><br> ä½¿ç”¨ç»ˆç«¯æˆ–<b>Teamcity</b> ï¼Œ <b>Jenkins</b>æ›´æ–°ä»£ç å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚ <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     -      Teamcity docker build -t GROUP/crm-code:latest . docker push GROUP/crm-code:latest #   (  ) kubectl set image deployment/php-fpm php-fpm=GROUP/php-fpm kubectl rollout status deployment/php-fpm kubectl set image deployment/php-fpm php-fpm=GROUP/php-fpm:latest kubectl set image deployment/nginx nginx=danday74/nginx-lua kubectl rollout status deployment/nginx kubectl set image deployment/nginx nginx=danday74/nginx-lua:latest kubectl rollout status deployment/php-fpm kubectl rollout status deployment/nginx</span></span></code> </pre><br> å¦‚æœå¯¹æŸäººæœ‰è¶£ï¼Œæˆ‘ä¼šæ„Ÿåˆ°é«˜å…´ï¼›å¦‚æœå¯¹ä»»ä½•äººæœ‰å¸®åŠ©ï¼Œæˆ‘ä¹Ÿä¼šæ„Ÿåˆ°é«˜å…´ã€‚ è°¢è°¢æ‚¨çš„å…³æ³¨ã€‚ å†æ¬¡ï¼Œæˆ‘å°†é“¾æ¥é™„åŠ åˆ°å­˜å‚¨åº“<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">one</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2</a> ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423481/">https://habr.com/ru/post/zh-CN423481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423467/index.html">ä¿„ç½—æ–¯å¼€å‘å•†å°†å‘å¸ƒäº§å“å…¼å®¹æ€§ç›®å½•</a></li>
<li><a href="../zh-CN423469/index.html">æœ€å¿«çš„ç‹‚é‡è¥¿éƒ¨æµ®ç‚¹æ•°</a></li>
<li><a href="../zh-CN423475/index.html">ç ´è§£è€åŒ–ä»£ç ï¼šæœ‰å…³è€åŒ–åŠå…¶ä¿æŒå¹´è½»çŠ¶æ€çš„æ–°ç§‘å­¦</a></li>
<li><a href="../zh-CN423477/index.html">æˆä¸ºå®‰å…¨å¿è€…ï¼šè¿ˆå…¥IBçš„é«˜å³°</a></li>
<li><a href="../zh-CN423479/index.html">â€œç¬¬ä¸€â€ï¼šæ˜¯å¦é£å¾€ç«æ˜Ÿ</a></li>
<li><a href="../zh-CN423483/index.html">æ‰¾åˆ°ä½¿ç”¨Webpackåˆ†éš”ç½‘ç«™å†…å®¹çš„æ­£ç¡®æ–¹æ³•</a></li>
<li><a href="../zh-CN423485/index.html">ä½¿ç”¨IntersectionObserverå»¶è¿ŸåŠ è½½å›¾åƒ</a></li>
<li><a href="../zh-CN423487/index.html">æ²¡æœ‰node_modulesçš„Node.js</a></li>
<li><a href="../zh-CN423489/index.html">æˆ‘æ˜¯æ€¥è¯ŠåŒ»ç”Ÿï¼Œæˆ‘æƒ³è°ˆè°ˆæ–°çš„Apple Watchå¿ƒç”µå›¾</a></li>
<li><a href="../zh-CN423491/index.html">PHPæ–‡æ‘˜139ï¼ˆ2018å¹´9æœˆ3æ—¥è‡³17æ—¥ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>