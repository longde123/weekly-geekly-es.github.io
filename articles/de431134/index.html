<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêï ‚öæÔ∏è üë∞üèΩ SIP-Telefon auf STM32F7-Discovery ‚òëÔ∏è üñêüèª üö£üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo an alle. 

 Vor einiger Zeit haben wir dar√ºber geschrieben, wie wir es geschafft haben, ein SIP-Telefon auf dem STM32F4-Discovery mit 1 MB ROM u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SIP-Telefon auf STM32F7-Discovery</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/431134/">  Hallo an alle. <br><br>  Vor einiger Zeit haben wir dar√ºber geschrieben, wie wir es geschafft haben, ein SIP-Telefon auf dem STM32F4-Discovery mit 1 MB ROM und 192 KB RAM (basierend auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Embox</a> ) zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">starten</a> .  Hier muss gesagt werden, dass diese Version minimal war und zwei Telefone direkt ohne Server und mit Sprach√ºbertragung nur in eine Richtung verband.  Aus diesem Grund haben wir uns entschlossen, ein vollst√§ndigeres Telefon mit einem Anruf √ºber den Server zu starten, die Sprach√ºbertragung in beide Richtungen, aber gleichzeitig die kleinstm√∂gliche Speichergr√∂√üe beizubehalten. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/W6wuEIZJf8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  F√ºr das Telefon wurde beschlossen, die Anwendung <i>simple_pjsua</i> als Teil der PJSIP-Bibliothek auszuw√§hlen.  Dies ist eine minimale Anwendung, die sich auf dem Server registrieren, Anrufe empfangen und beantworten kann.  Im Folgenden werde ich sofort beschreiben, wie dies auf dem STM32F7-Discovery ausgef√ºhrt wird. <br><br><h3>  Wie man l√§uft </h3><br><ol><li>  Embox konfigurieren <pre><code class="bash hljs">make confload-platform/pjsip/stm32f7cube</code> </pre> </li><li>  Legen Sie in der Datei conf / mods.config das gew√ºnschte SIP-Konto fest. <br><br><pre> <code class="bash hljs">include platform.pjsip.cmd.simple_pjsua_imported( sip_domain=<span class="hljs-string"><span class="hljs-string">"server"</span></span>, sip_user=<span class="hljs-string"><span class="hljs-string">"username"</span></span>, sip_passwd=<span class="hljs-string"><span class="hljs-string">"password"</span></span>)</code> </pre><br>  Wenn <i>Server</i> der SIP-Server ist (z. B. sip.linphone.org), sind <i>Benutzername</i> und <i>Kennwort</i> der Benutzername und das Kennwort des Kontos. <br></li><li>  Erstellen Sie Embox mit dem Befehl <i>make</i> .  √úber die Firmware des Boards haben wir im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wiki</a> und im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> . <br></li><li>  F√ºhren Sie den Befehl "simple_pjsua_imported" in der Embox-Konsole aus <br><br><pre> <code class="bash hljs">00:00:12.870 pjsua_acc.c ....SIP outbound status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0 is not active 00:00:12.884 pjsua_acc.c ....sip:alexk2222@sip.linphone.org: registration success, status=200 (Registration succes 00:00:12.911 pjsua_acc.c ....Keep-alive timer started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0, destination:91.121.209.194:5060, interval:15s</code> </pre><br></li><li>  Schlie√ülich m√ºssen noch Lautsprecher oder Kopfh√∂rer in den Audioausgang eingesetzt und in zwei kleine MEMS-Mikrofone in der N√§he des Displays gesprochen werden.  Wir rufen von Linux √ºber die Anwendung simple_pjsua, pjsua auf.  Nun, oder Sie k√∂nnen jede andere Art von Telefon. <br></li></ol><br>  All dies ist in unserem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wiki beschrieben</a> . <br><br><h3>  Wie sind wir dazu gekommen? </h3><br>  Daher stellte sich zun√§chst die Frage nach der Wahl einer Hardwareplattform.  Da klar war, dass der STM32F4-Discovery nicht in den Speicher passen w√ºrde, wurde der STM32F7-Discovery ausgew√§hlt.  Sie hat ein 1 MB Flash-Laufwerk und 256 KB RAM (+ 64 spezielle schnelle Speicher, die wir auch verwenden werden).  Auch nicht viel f√ºr Anrufe √ºber den Server, aber beschlossen, zu versuchen, einzusteigen. <br><br>  Herk√∂mmlicherweise war die Aufgabe in mehrere Phasen unterteilt: <br><br><ul><li>  Ausf√ºhren von PJSIP auf QEMU.  Es war praktisch zum Debuggen, und wir hatten dort bereits AC97-Codec-Unterst√ºtzung. </li><li>  Sprachaufnahme und -wiedergabe auf QEMU und STM32. </li><li>  Portieren einer <i>simple_pjsua-</i> Anwendung aus PJSIP heraus.  Sie k√∂nnen sich auf dem SIP-Server registrieren und Anrufe t√§tigen. </li><li>  Stellen Sie Ihren eigenen Asterisk-basierten Server bereit und testen Sie ihn. Probieren Sie dann externe Server wie sip.linphone.org aus </li></ul><br>  Sound in Embox funktioniert √ºber Portaudio, das auch in PISIP verwendet wird.  Die ersten Probleme traten bei QEMU auf - WAV spielte bei 44100 Hz gut, aber bei 8000 ging offensichtlich etwas schief.  Es stellte sich heraus, dass es darum ging, die Frequenz einzustellen - standardm√§√üig waren es 44100 in der Ausr√ºstung, und dies √§nderte sich bei uns nicht programmatisch. <br><br>  Hier lohnt es sich wahrscheinlich, ein wenig zu erkl√§ren, wie Sound im Allgemeinen gespielt wird.  Die Soundkarte kann einen Zeiger auf ein Speicherelement setzen, aus dem Sie mit einer vorgegebenen Frequenz abspielen oder aufnehmen m√∂chten.  Nach dem Ende des Puffers wird ein Interrupt generiert und die Ausf√ºhrung ab dem n√§chsten Puffer fortgesetzt.  Tatsache ist, dass diese Puffer im Voraus gef√ºllt werden m√ºssen, bevor der vorherige abgespielt wird.  Dieses Problem wird beim STM32F7 weiter auftreten. <br><br>  Als N√§chstes haben wir einen Server gemietet und Asterisk darauf bereitgestellt.  Da es notwendig war, viel zu debuggen, aber nicht viel in das Mikrofon sprechen wollte, war es notwendig, die automatische Wiedergabe und Aufnahme durchzuf√ºhren.  Zu diesem Zweck haben wir simple_pjsua gepatcht, sodass es m√∂glich war, Dateien anstelle von Audioger√§ten zu verschieben.  In PJSIP geschieht dies ganz einfach, da sie das Konzept eines Ports haben, der entweder ein Ger√§t oder eine Datei sein kann.  Und diese Ports k√∂nnen flexibel mit anderen Ports verbunden werden.  Sie k√∂nnen den Code in unserem pjsip- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository sehen</a> .  Infolgedessen war das Schema wie folgt.  Ich habe zwei Konten auf dem Asterisk-Server erstellt - f√ºr Linux und f√ºr Embox.  Als n√§chstes wird der Befehl <i>simple_pjsua_imported</i> auf Embox ausgef√ºhrt. Embox wird auf dem Server registriert. Danach rufen wir Embox unter Linux auf.  Zum Zeitpunkt der Verbindung √ºberpr√ºfen wir auf dem Asterisk-Server, ob die gesamte Verbindung hergestellt ist, und nach einiger Zeit sollten sie in Embox Sound von Linux h√∂ren, und unter Linux speichern wir die von Embox abgespielte Datei. <br><br>  Nachdem es auf QEMU funktioniert hatte, wechselten wir zur Portierung auf STM32F7-Discovery.  Das erste Problem: Ohne die mitgelieferte Optimierung des Compilers "-Os" in Bezug auf die Bildgr√∂√üe gelangten sie nicht in ein 1-MB-ROM.  Daher enthalten "-Os".  Au√üerdem hat der Patch die C ++ - Unterst√ºtzung deaktiviert, sodass er nur f√ºr pjsua ben√∂tigt wird, und wir verwenden simple_pjsua. <br><br>  Nachdem wir <i>simple_pjsua angepasst hatten</i> , entschieden wir, dass es jetzt Chancen gibt, es zu starten.  Aber zuerst musste man sich mit Sprachaufnahme und -wiedergabe befassen.  Frage - wo schreiben?  Wir haben einen externen Speicher gew√§hlt - SDRAM (128 MB).  Sie k√∂nnen es selbst versuchen: <br><br>  Erstellt Stereo-WAV mit einer Frequenz von 16000 Hz und einer Dauer von 10 Sekunden: <br><br><pre> <code class="bash hljs">record -r 16000 -c 2 -d 10000 -m C0000000</code> </pre><br>  Wir verlieren: <br><br><pre> <code class="bash hljs">play -m C0000000</code> </pre><br>  Es gab zwei Probleme.  Der erste mit einem Codec ist WM8994 und hat ein Konzept wie einen Steckplatz. Diese Steckpl√§tze sind 4. Wenn dies nicht konfiguriert ist, erfolgt die Wiedergabe bei der Audiowiedergabe standardm√§√üig in allen vier Steckpl√§tzen.  Daher haben wir bei einer Frequenz von 16000 Hz 8000 Hz empfangen, aber bei 8000 Hz hat die Wiedergabe einfach nicht funktioniert.  Wenn nur die Steckpl√§tze 0 und 2 ausgew√§hlt wurden, funktionierte es wie es sollte.  Ein weiteres Problem war das Audio-Interface im STM32Cube, bei dem der Audioausgang √ºber SAI (Serial Audio Interface) synchron mit dem Audioeingang arbeitet (die Details wurden nicht verstanden, aber es stellte sich heraus, dass sie eine gemeinsame Uhr haben und das Audio beim Initialisieren des Audioausgangs irgendwie daran angeschlossen ist Eingabe).  Das hei√üt, sie k√∂nnen nicht separat gestartet werden, daher haben sie Folgendes getan: Der Audioeingang und der Audioausgang funktionieren immer (einschlie√ülich Interrupts werden generiert).  Wenn jedoch nichts im System verloren geht, schieben wir einfach einen leeren Puffer in den Audioausgang, und wenn die Wiedergabe beginnt, beginnen wir ehrlich, ihn zu f√ºllen. <br><br>  Au√üerdem stellten sie fest, dass der Ton bei der Sprachaufnahme sehr leise war.  Dies liegt an der Tatsache, dass MEMS-Mikrofone am STM32F7-Discovery bei Frequenzen unter 16000 Hz irgendwie nicht gut funktionieren.  Daher stellen wir 16000 Hz ein, auch wenn 8000 Hz kommen.  Um dies zu tun, war die Wahrheit, eine Software-Konvertierung von einer Frequenz zu einer anderen hinzuzuf√ºgen. <br><br>  Als n√§chstes musste ich den Heap vergr√∂√üern, der sich im RAM befindet.  Nach unseren Sch√§tzungen ben√∂tigte pjsip ungef√§hr 190 Kb, und wir hatten nur ungef√§hr 100 Kb.  Hier musste ich ein bisschen externen Speicher verwenden - SDRAM (ca. 128 Kb). <br><br>  Nach all diesen √Ñnderungen sah ich die ersten Pakete zwischen Linux und Embox und h√∂rte einen Ton!  Aber der Sound war schrecklich, √ºberhaupt nicht wie bei QEMU, nichts konnte erkannt werden.  Dann haben wir dar√ºber nachgedacht, was los sein k√∂nnte.  Das Debuggen hat gezeigt, dass Embox einfach keine Zeit hat, Audiopuffer zu f√ºllen / zu entladen.  W√§hrend pjsip einen Frame verarbeitet, sind vor Abschluss der Pufferverarbeitung zwei Unterbrechungen aufgetreten, was zu viel ist.  Der erste Gedanke zur Beschleunigung war die Optimierung des Compilers, der jedoch bereits in PJSIP enthalten war.  Der zweite ist ein Hardware-Gleitkomma, √ºber den wir im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel gesprochen haben</a> .  Wie die Praxis gezeigt hat, hat die FPU die Geschwindigkeit nicht signifikant erh√∂ht.  Der n√§chste Schritt bestand darin, die Threads zu priorisieren.  Embox hat verschiedene Planungsstrategien, und ich habe eine hinzugef√ºgt, die Priorit√§ten unterst√ºtzt und Audio-Streams auf die h√∂chste Priorit√§t setzt.  Es hat auch nicht geholfen. <br><br>  Das n√§chste war die Idee, dass wir mit externem Speicher arbeiten und es w√§re sch√∂n, Strukturen dorthin zu verschieben, auf die extrem oft zugegriffen wird.  Ich habe eine vorl√§ufige Analyse durchgef√ºhrt, wann und unter was <i>simple_pjsua</i> Speicher <i>zuweist</i> .  Es stellte sich heraus, dass von 190 KB die ersten 90 KB f√ºr die internen Anforderungen von PJSIP reserviert sind und nicht sehr oft darauf zugegriffen wird.  W√§hrend eines eingehenden Aufrufs wird dann die Funktion pjsua_call_answer aufgerufen, in der dann Puffer f√ºr die Arbeit mit eingehenden und ausgehenden Frames zugewiesen werden.  Es war ungef√§hr 100 kb.  Und hier haben wir wie folgt gehandelt.  Vor dem Anruf werden die Daten in einem externen Speicher abgelegt.  Sobald der Aufruf - sofort den Heap durch einen anderen ersetzen - im RAM.  Somit wurden alle "hei√üen" Daten in einen schnelleren und vorhersehbareren Speicher √ºbertragen. <br><br>  Infolgedessen konnte all dies zusammen <i>simple_pjsua</i> starten und √ºber seinen Server einen Anruf t√§tigen.  Und dann √ºber andere Server wie sip.linphone.org. <br><br><h3>  Schlussfolgerungen </h3><br>  Infolgedessen stellte sich heraus, dass <i>simple_pjsua</i> mit Sprach√ºbertragung in beide Richtungen √ºber den Server ausgef√ºhrt wurde.  Das Problem mit dem zus√§tzlich verbrauchten 128-Kb-SDRAM kann mit einem etwas leistungsst√§rkeren Cortex-M7 (z. B. STM32F769NI mit 512 Kb RAM) gel√∂st werden. Gleichzeitig haben wir jedoch keine Hoffnung, in 256 Kb zu passen :) Wir werden uns freuen, wenn jemand interessiert ist und noch besser - versuchen Sie es.  Alle Quellen befinden sich wie gewohnt in unserem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de431134/">https://habr.com/ru/post/de431134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de431124/index.html">"Data Science ist wie Mathematik und Physik eine weitere M√∂glichkeit, die Welt um Sie herum zu erkunden."</a></li>
<li><a href="../de431126/index.html">Warum Sie nicht auf professionelle PM sparen sollten</a></li>
<li><a href="../de431128/index.html">Hacking DDR3 SPD</a></li>
<li><a href="../de431130/index.html">Sicherheitswoche 48: Hack Black Friday</a></li>
<li><a href="../de431132/index.html">Reuters: Russland wird die Geldbu√üen f√ºr Internetunternehmen auf 1% des Jahresumsatzes erh√∂hen</a></li>
<li><a href="../de431136/index.html">Schwerelose Terabyte in der Tasche - ist die Zukunft hier? Erkunden der HyperX SAVAGE EXO-Funktionen</a></li>
<li><a href="../de431138/index.html">Biometrie mit dem Rostelecom-Schl√ºssel: Wie der FSB die russische Kryptographie erstmals in Anwendungsgesch√§ften einf√ºhrte</a></li>
<li><a href="../de431140/index.html">Bericht aus der Go in Production-Metapa: Videos, Fotos, Pr√§sentationen</a></li>
<li><a href="../de431142/index.html">Wie kann SQL Profiler Trace nachts zu einer bestimmten Zeit ausgef√ºhrt werden?</a></li>
<li><a href="../de431144/index.html">Far Fields mic (Mic array) - unauff√§lliger Held in einer intelligenten S√§ule</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>