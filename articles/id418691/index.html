<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏽‍🤝‍🧑🏽 🅾️ 🌿 Peternak: Kubernet dalam 5 menit dengan logam kosong 🧒🏻 🕎 🐂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di persimpangan, orkestra tidak berubah. 

 Setelah saya benar-benar bosan dengan Docker Swarm karena kesederhanaan semu dan penyelesaian yang konstan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Peternak: Kubernet dalam 5 menit dengan logam kosong</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418691/">  Di persimpangan, orkestra <s>tidak</s> berubah. <br><br>  Setelah saya benar-benar bosan dengan Docker Swarm karena kesederhanaan semu dan penyelesaian yang konstan, pekerjaan yang sangat tidak nyaman dengan sistem file terdistribusi, antarmuka web yang sedikit basah dan fungsi yang sempit, serta kurangnya dukungan "di luar kotak" integrasi GitLab, diputuskan untuk menggunakan kluster Kubernet Anda pada perangkat keras Anda sendiri, yaitu, dengan menggunakan Rancher Management Server 2.0. <br><br>  Pengalaman pemasangan, skema toleransi kesalahan, bekerja dengan haProxy dan dua dasbor di bawah kucing: <br><a name="habracut"></a><br>  <strong>Input data:</strong> <br><br>  Server Host HP Proliant DL320e Gen8 - 2 pcs. <br>  VM Ubuntu Server 16.04, 2Gb RAM, 2vCPU, 20Gb HDD - 1 pc.  pada setiap Host (VM-haProxy). <br>  VM Ubuntu Server 16.04, RAM 4Gb, 4vCPU, HDD 40Gb, 20 Gb SSD - 3 pcs.  pada setiap Host (VM - * - Cluster). <br>  VM Ubuntu Server 16.04, RAM 4Gb, 4vCPU, 100Gb HDD - 1 pc.  pada siapa pun Host (VM-NFS). <br><br>  Diagram jaringan: <br><br><div class="spoiler">  <b class="spoiler_title">Fig. 1</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ua/wg/ec/uawgecpkngtalxstr0i1fam-ok4.jpeg"><br></div></div><br>  <strong>Mulai:</strong> <br><br>  <em>VM-haProxy</em> memiliki aturan haProxy, fail2ban, iptables.  Bertindak sebagai gateway untuk semua mesin di belakangnya.  Kami memiliki dua gateway dan semua mesin jika kehilangan komunikasi gateway pada host mereka akan beralih ke yang lain. <br><br>  Tugas utama dari node-node ini (VM-haProxy) adalah untuk mendistribusikan akses ke backend, menyeimbangkan, meneruskan port, dan mengumpulkan statistik. <br><br>  Pilihan saya jatuh pada haProxy, sebagai alat yang lebih sempit tentang penyeimbangan dan pemeriksaan kesehatan.  Untuk semua ini, saya suka sintaks arahan konfigurasi dan bekerja dengan daftar putih dan hitam IP, serta bekerja dengan koneksi SSL multi-domain. <br><br>  Konfigurasi HaProxy: <br><br><div class="spoiler">  <b class="spoiler_title">haproxy.conf dengan komentar</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">########################################################## #Global # ########################################################## global log 127.0.0.1 local0 notice maxconn 2000 user haproxy group haproxy tune.ssl.default-dh-param 2048 defaults log global mode http option httplog option dontlognull retries 3 option redispatch timeout connect 5000 timeout client 10000 timeout server 10000 option forwardfor option http-server-close ########################################################## #TCP # ########################################################## #    API  Kubernetes listen kube-api-tls bind *:6443 mode tcp option tcplog server VM-Master-Cluster Master:6443 ########################################################## #HTTP/HTTPS - Frontend and backend # ########################################################## #      "  ", frontend  backend. frontend http-in bind *:80 acl network_allowed src -f /path/allowed-ip #     IP.     . http-request deny if !network_allowed #       IP  . reqadd X-Forwarded-Proto:\ http mode http option httpclose acl is_haproxy hdr_end(host) -i haproxy.domain.ru acl is_rancher hdr_end(host) -i rancher.domain.ru acl is_kubernetes hdr_end(host) -i kubernetes.domain.ru use_backend kubernetes if is_kubernetes use_backend rancher if is_rancher use_backend haproxy if is_haproxy frontend https-in bind *:443 ssl crt-list /path/crt-list #    .        . acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed reqadd X-Forwarded-Proto:\ https acl is_rancher hdr_end(host) -i rancher.etraction.ru acl is_kubernetes hdr_end(host) -i kubernetes.etraction.ru use_backend kubernetes if is_kubernetes { ssl_fc_sni kubernetes.domain.ru } use_backend rancher if is_rancher { ssl_fc_sni rancher.domain.ru } # Backend  haProxy.    . backend haproxy stats enable stats uri /haproxy?stats stats realm Strictly\ Private stats auth login:passwd cookie SERVERID insert nocache indirect #  , , backend   dashboard rancher  kubernetes. backend rancher acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http redirect scheme https if !{ ssl_fc } server master master:443 check ssl verify none backend kubernetes acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http balance leastconn redirect scheme https if !{ ssl_fc } server master master:9090 check ssl verify none</span></span></code> </pre> <br></div></div><br>  <strong>Penting:</strong> Semua mesin harus “saling mengenal” dengan nama host. <br><br><div class="spoiler">  <b class="spoiler_title">add-host-entry.pp boneka wayang untuk menambahkan nama host di / etc / hosts</b> <div class="spoiler_text"><pre> <code class="bash hljs">class host_entries { host { <span class="hljs-string"><span class="hljs-string">'proxy01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.11'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'proxy02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.12'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'master'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.100'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.101'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.102'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node03'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.103'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node04'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.104'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node05'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.105'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'nfs'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.200'</span></span>, } }</code> </pre><br></div></div><br>  <em>VM-Master-Cluster</em> adalah mesin kontrol utama.  Ini berbeda dari node lain di papan oleh Puppet Master, GlusterFS Server, Rancher Server (container), etcd (container), control manager (container).  Dalam kasus pemutusan host ini, layanan produksi terus bekerja. <br>  <em>VM-Node-Cluster</em> - Nodes, Pekerja.  Mesin kerja yang sumber dayanya akan digabungkan menjadi satu lingkungan yang toleran terhadap kesalahan.  Tidak ada yang menarik. <br><br>  <em>VM-NFS</em> - server NFS (nfs-kernel-server).  Tugas utama adalah menyediakan ruang penyangga.  Menyimpan file konfigurasi dan semua.  Tidak menyimpan sesuatu yang penting.  Jatuhnya bisa diperbaiki perlahan, sambil minum kopi. <br><br>  <strong>Penting:</strong> Semua mesin lingkungan harus ada di papan: docker.io, nfs-common, gluster-server. <br><br><div class="spoiler">  <b class="spoiler_title">must-have-paket.pp boneka wayang untuk menginstal perangkat lunak yang tepat</b> <div class="spoiler_text"><pre> <code class="bash hljs">class musthave { package { <span class="hljs-string"><span class="hljs-string">'docker.io'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'nfs-common'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'gluster-server'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } }</code> </pre><br></div></div><br>  Saya tidak akan menjelaskan instalasi nfs-volume dan konfigurasi GlusterFS, karena ini dijelaskan dengan murah hati dalam jumlah besar. <br><br>  Jika Anda melihat ada disk SSD dalam deskripsi spesifikasi, mereka disiapkan untuk pengoperasian sistem file terdistribusi Gluster.  Buat partisi, dan penyimpanan pada disk berkecepatan tinggi. <br><br>  <em>Catatan</em>  Sebenarnya, menjalankan Peternakan tidak memerlukan lingkungan seperti cermin.  Semua hal di atas adalah visi kluster dan deskripsi praktik apa yang saya ikuti. <br><br>  Untuk menjalankan Rancher, <strong>satu</strong> mesin sudah cukup, dengan 4CPU, 4Gb RAM, 10Gb HDD. <br><br>  5 menit ke Peternakan. <br><br>  Pada VM-Master-Cluster kami melakukan: <br><br><pre> <code class="bash hljs">sudo docker run -d --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher</code> </pre> <br>  Periksa ketersediaan: <br><br><pre> <code class="bash hljs">curl -k https://localhost</code> </pre> <br>  Jika Anda melihat API - saya mengucapkan selamat kepada Anda tepat setengah jalan berlalu. <br><br>  Melihat diagram jaringan lagi, kami ingat bahwa kami akan bekerja dari luar, melalui haProxy, dalam konfigurasi kami telah menerbitkan tautan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">rancher.domain.ru</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">silakan</a> , atur kata sandi Anda. <br><br>  Halaman selanjutnya adalah Halaman Penciptaan Cluster Kubernetes. <br><br><div class="spoiler">  <b class="spoiler_title">Gbr.2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1w/ke/xn/1wkexnv2z_lgd_epga3vx3foyv4.png"><br></div></div><br>  Dari menu Cluster Options, pilih Flannel.  Saya tidak bekerja dengan penyedia jaringan lain.  Saya tidak bisa memberi saran. <br><br>  Perlu memperhatikan fakta bahwa kami memasang kotak centang, dll, dan Control Plane, pekerja kotak centang tidak diinstal, jika Anda tidak berencana menggunakan manajer dalam mode pekerja. <br>  Kami bekerja di dalam jaringan lokal, dengan alamat yang sama pada NIC, jadi di bidang Public dan Internal Address ditunjukkan IP yang sama. <br><br>  Salin kode yang dihasilkan di atas, jalankan di konsol. <br><br>  Setelah beberapa waktu, di antarmuka web Anda akan melihat pesan tentang menambahkan node.  Dan setelah beberapa waktu, Anda akan memulai cluster Kubernetes. <br><br><div class="spoiler">  <b class="spoiler_title">Gbr.3</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lj/sn/kk/ljsnkkwx3eh2w0eg5vysblt8wpm.png"><br></div></div><br>  Untuk menambah pekerja, buka untuk mengedit cluster di antarmuka web Rancher, Anda akan melihat menu yang sama yang menghasilkan perintah koneksi. <br><br>  Setel kotak centang hanya ke posisi pekerja, tentukan IP pekerja masa depan, salin perintah dan jalankan di konsol node yang Anda butuhkan. <br><br>  Setelah beberapa saat, kekuatan cluster akan meningkat, seperti jumlah node. <br><br>  <strong>Instal Kubernetes Dashboard:</strong> <br><br>  Buka menu Projects / Namespaces. <br><br>  Setelah instalasi, Anda akan melihat bahwa ruang nama yang terkait dengan Kubernetes akan dimuat di luar proyek.  Untuk sepenuhnya bekerja dengan ruang nama ini, mereka harus ditempatkan di proyek. <br><br>  Tambahkan proyek, beri nama sesuai keinginan.  Pindahkan ruang nama (sistem ternak, ingress-nginx, sistem kubus publik, sistem kubus) ke proyek yang Anda buat menggunakan menu konteks "Pindahkan".  Seharusnya seperti ini: <br><br><div class="spoiler">  <b class="spoiler_title">Fig. 4</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dz/qv/el/dzqvelzycrlwyj3bkwllq-pndqm.png"><br></div></div><br>  Klik langsung pada nama proyek, Anda akan dibawa ke panel kontrol beban kerja.  Di sinilah kita akan membahas cara membuat layanan sederhana. <br><br><div class="spoiler">  <b class="spoiler_title">Gbr.5</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/q6/lp/5z/q6lp5znqlnhzkudjafjnr172n-g.png"><br></div></div><br>  Klik "Impor YAML" di sudut kanan atas.  Salin dan rekatkan isi <a href="">file ini</a> ke dalam kotak teks dari jendela yang terbuka, pilih namespace "sistem kubus", klik "Impor". <br><br>  Setelah beberapa waktu, pod kubernetes-dashboard akan mulai. <br><br>  Buka pengeditan pod, buka menu port publishing, tetapkan nilai berikut: <br><br><div class="spoiler">  <b class="spoiler_title">Gbr.6</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_p/2b/wk/_p2bwkxifynrhipap0imqddogfi.png"><br></div></div><br>  Periksa akses pada node tempat pod dijalankan. <br><br><pre> <code class="bash hljs">curl -k https://master:9090</code> </pre> <br>  Lihat jawabannya?  Publikasi selesai, masih untuk mencapai bagian administrasi. <br><br>  Di halaman utama manajemen cluster di Rancher, ada alat yang sangat mudah, seperti kubectl - konsol manajemen cluster dan File Kubeconfig - file konfigurasi yang berisi alamat API, ca.crt, dll. <br><br>  Kami masuk ke kubectl dan mengeksekusi: <br><br><pre> <code class="bash hljs">kubectl create serviceaccount cluster-admin-dashboard-sa kubectl create clusterrolebinding cluster-admin-dashboard-sa --clusterrole=cluster-admin --serviceaccount=default:cluster-admin-dashboard-sa</code> </pre><br>  Kami membuat akun layanan dengan hak istimewa tertinggi, sekarang kami membutuhkan token untuk mengakses Dasbor. <br><br>  Temukan rahasia akun yang dibuat: <br><br><pre> <code class="bash hljs">kubectl get secret | grep cluster-admin-dashboard-sa</code> </pre><br>  Kami akan melihat nama akun dengan hash tertentu di akhir, salin dan jalankan: <br><br><pre> <code class="bash hljs">kubectl describe secret cluster-admin-dashboard-sa-$( )</code> </pre><br>  Sekali lagi, kami ingat bahwa semuanya telah berhasil dipublikasikan melalui haProxy. <br><br>  Kami mengikuti tautan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kubernetes.domain.ru</a> .  Masukkan token yang diterima. <br><br>  Bersukacitalah: <br><br><div class="spoiler">  <b class="spoiler_title">Gbr. 7</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ps/1q/iw/ps1qiwgxivruyotas0fcb2slwfy.png"><br></div></div><br>  <em>PS</em> <br>  Hasil keseluruhan saya ingin mengucapkan terima kasih kepada Rancher untuk membuat antarmuka yang intuitif, contoh yang mudah digunakan, dokumentasi sederhana, kemampuan untuk bergerak dengan cepat dan skalabilitas di tingkat cluster.  Mungkin saya berbicara terlalu tajam di awal posting yang membuat Swarm bosan, agaknya, tren perkembangan yang jelas, agak membuat saya menatap ke samping dan tidak menyelesaikan rutinitas yang membosankan.  Docker menciptakan era perkembangan.  Dan untuk menilai proyek ini tentu bukan untuk saya. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id418691/">https://habr.com/ru/post/id418691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id418681/index.html">Hari Persahabatan - Diskon 50% semua IDE JetBrains untuk teman-teman kami</a></li>
<li><a href="../id418683/index.html">Membuat mesin arcade emulator. Bagian 2</a></li>
<li><a href="../id418685/index.html">Generasi Tingkat Prosedural</a></li>
<li><a href="../id418687/index.html">Revolusi 3,5 ": detail ledakan kecil floppy disk dengan uap</a></li>
<li><a href="../id418689/index.html">Cara membuat pustaka komponen di Figma, menghemat anggaran, menggunakan contoh lelang online</a></li>
<li><a href="../id418693/index.html">Mengapa kebahagiaan begitu sulit dideteksi di otak</a></li>
<li><a href="../id418695/index.html">Perang Anti-Pembajakan - The Empire Strikes Back</a></li>
<li><a href="../id418699/index.html">Membuat mesin arcade emulator. Bagian 3</a></li>
<li><a href="../id418701/index.html">Kami mempelajari parser sintaksis untuk bahasa Rusia</a></li>
<li><a href="../id418705/index.html">Dasar-dasar Futex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>