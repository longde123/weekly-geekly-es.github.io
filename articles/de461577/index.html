<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèø üßíüèø üéÄ Teil 5/2 Geb√§ude 1: Kreuzung der RocketChip Avenue und der rutschigen Instrumentierungsspur ‚ú≥Ô∏è üëà üï§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In den vorherigen vier Teilen wurden Vorbereitungen f√ºr Experimente mit dem RISC-V RocketChip-Kern getroffen, n√§mlich die Portierung dieses Kerns auf ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teil 5/2 Geb√§ude 1: Kreuzung der RocketChip Avenue und der rutschigen Instrumentierungsspur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p>  In den vorherigen vier Teilen wurden Vorbereitungen f√ºr Experimente mit dem RISC-V RocketChip-Kern getroffen, n√§mlich die Portierung dieses Kerns auf eine ‚ÄûNicht-Standard‚Äú -Karte mit Altera-FPGAs (jetzt Intel).  Im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">letzten Teil</a> stellte sich schlie√ülich heraus, dass Linux auf diesem Board ausgef√ºhrt wurde.  Wei√üt du, was mich an all dem am√ºsiert hat?  Die Tatsache, dass ich gleichzeitig mit den Assemblern RISC-V, C und Scala arbeiten musste, und von allen war Scala die Sprache der niedrigsten Ebene (weil der Prozessor darauf geschrieben ist). </p><br><p>  Lassen Sie uns C auch in diesem Artikel nicht anst√∂√üig machen.  Wenn das Scala + Chisel-Bundle nur als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dom√§nenspezifische Sprache</a> zur expliziten Beschreibung der Hardware verwendet wurde, lernen wir heute, wie einfache C-Funktionen in Form von Anweisungen in den Prozessor ‚Äûgezogen‚Äú werden. </p><br><p> Das ultimative Ziel ist die triviale Implementierung trivialer AFL-√§hnlicher Instrumente in Analogie zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">QInst</a> , und die Implementierung separater Anweisungen ist nur ein Nebenprodukt. </p><a name="habracut"></a><br><p>  Es ist klar, dass es (und nicht einen) kommerziellen OpenCL-RTL-Konverter gibt.  Ich bin auch auf Informationen √ºber ein bestimmtes COPILOT-Projekt f√ºr RISC-V mit √§hnlichen Zielen gesto√üen (viel weiter fortgeschritten), aber etwas googelt schlecht, und au√üerdem ist es h√∂chstwahrscheinlich auch ein kommerzielles Produkt.  Ich interessiere mich haupts√§chlich f√ºr OpenSource-L√∂sungen, aber selbst wenn dies der Fall ist, macht es immer noch Spa√ü, dies selbst zu implementieren - zumindest als vereinfachtes Schulungsbeispiel, und dann, wie es geht ... </p><br><p>  <strong>Haftungsausschluss</strong> (zus√§tzlich zu der √ºblichen Warnung vor ‚ÄûTanzen mit einem Feuerl√∂scher‚Äú): Ich empfehle dringend nicht, den resultierenden Softwarekern r√ºcksichtslos anzuwenden, insbesondere bei nicht vertrauensw√ºrdigen Daten - bisher habe ich nicht so viel Vertrauen, als dass ich √ºberhaupt verstehe, warum die verarbeiteten Daten nicht k√∂nnen "Flow" in einem Grenzfall zwischen Prozessen und / oder dem Kern.  Nun, √ºber die Tatsache, dass die Daten "schlagen" k√∂nnen, denke ich, und so ist es klar.  Im Allgemeinen gibt es noch Validierung und Validierung ... </p><br><p>  Wie nenne ich eine "einfache Funktion"?  F√ºr die Zwecke dieses Artikels bedeutet dies eine Funktion, bei der alle √úberg√§nge (bedingt und bedingungslos) den Befehlsz√§hler nur um einen konstanten Wert erh√∂hen.  Das hei√üt, der Graph aller m√∂glichen √úberg√§nge ist (gerichtet) azyklisch ohne "dynamische" Kanten.  Das ultimative Ziel im Rahmen dieses Artikels ist es, eine einfache Funktion aus dem Programm zu √ºbernehmen und sie durch ein Assembler-Plug-In zu ersetzen und sie in der Synthesestufe in den Prozessor zu ‚Äûn√§hen‚Äú, wodurch sie optional zu einem Nebeneffekt einer anderen Anweisung wird.  <em>Insbesondere wird die Verzweigung in diesem Artikel nicht gezeigt, aber im einfachsten Fall wird es nicht schwierig sein, sie zu erstellen.</em> </p><br><h2 id="uchimsya-ponimat-c-na-samom-dele-net">  C verstehen lernen (eigentlich nein) </h2><br><p> Zuerst m√ºssen Sie verstehen, wie wir C analysieren werden?  Das ist auf keinen Fall richtig - es war nicht umsonst, dass ich gelernt habe, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ELF-Dateien</a> zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">analysieren</a> : Sie m√ºssen nur unseren Code in C / Rust / etwas anderem in einen eBPF-Bytecode kompilieren und ihn bereits analysieren.  Einige Schwierigkeiten werden durch die Tatsache verursacht, dass Sie in Scala nicht einfach <code>elf.h</code> verbinden und Strukturfelder lesen k√∂nnen.  Sie k√∂nnen nat√ºrlich versuchen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JNAerator zu verwenden</a> - bei Bedarf k√∂nnen sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ordner</a> f√ºr die Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erstellen</a> - nicht nur Strukturen, sondern auch Code f√ºr die Arbeit mit JNA generieren (nicht zu verwechseln mit JNI).  Als echter Programmierer schreibe ich mein Fahrrad und schreibe die Aufz√§hlungs- und Versatzkonstanten sorgf√§ltig aus der Header-Datei.  Das Ergebnis und die Zwischenstrukturen werden durch die folgende Struktur von Fallklassen beschrieben: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegularSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SymtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Header</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> sectionHeaders: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">], sectionStringTableIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Section</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> data: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">, linkIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, infoIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, kind: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SectionKind</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Symbol</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, shndx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, isInstrumenter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Relocation</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> relocatedSection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, symbol: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfInsn</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> opcode: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, dst: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, src: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imm: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Either</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfProg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, insns: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BpfInsn</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  Ich werde den Parsing-Prozess nicht besonders beschreiben - dies ist nur eine langweilige Byte-√úbertragung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>java.nio.ByteBuffer</code></a> - all die interessanten Dinge wurden bereits im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel √ºber das Parsen von ELF-Dateien beschrieben</a> .  Ich kann nur sagen, dass Sie den <code>opcode == 0x18</code> (Laden von 64-Bit- <code>opcode == 0x18</code> in das Register) sorgf√§ltig behandeln m√ºssen, da zwei 8-Byte-W√∂rter gleichzeitig ben√∂tigt werden (m√∂glicherweise gibt es andere solche Opcodes, aber ich bin noch nicht auf sie gesto√üen). , und dies l√§dt nicht immer die Speicheradresse, die mit dem Umzug verbunden ist, wie ich anfangs dachte.  Zum Beispiel verwendet <code>__builtin_popcountl</code> ehrlich die 64-Bit- <strong>Konstante</strong> <code>0x0101010101010101</code> .  Warum mache ich keinen ‚Äûehrlichen‚Äú Umzug mit dem Patchen der heruntergeladenen Datei - weil ich die Zeichen in symbolischer Form sehen m√∂chte (Entschuldigung f√ºr das Wortspiel), damit sp√§ter die Zeichen aus dem Abschnitt <code>COMMON</code> durch Register ersetzt werden k√∂nnen, ohne Kr√ºcken mit spezieller Behandlung von Adressen einer bestimmten Art zu verwenden (und es bedeutet, auch bei T√§nzen mit konstanter / nicht konstanter <code>UInt</code> ). </p><br><h2 id="stroim-hardware-po-naboru-instrukciy">  Wir bauen Hardware nach einer Reihe von Anweisungen </h2><br><p>  Unter der Annahme, dass alle m√∂glichen Ausf√ºhrungspfade ausschlie√ülich in der Liste der Anweisungen aufgef√ºhrt sind, bedeutet dies, dass die Daten entlang eines orientierten azyklischen Graphen flie√üen und alle seine Kanten statisch definiert sind.  Gleichzeitig haben wir eine rein kombinatorische Logik (dh ohne Register auf dem Weg), die aus Operationen an Registern sowie Verz√∂gerungen w√§hrend Lade- / Speicheroperationen mit Speicher erhalten wird.  Daher ist es im allgemeinen Fall m√∂glicherweise nicht m√∂glich, die Operation in einem Taktzyklus abzuschlie√üen.  Wir werden es einfach machen: Wir werden den Wert in Form von <code>UInt</code> , aber wie <code>(UInt, Bool)</code> : Das erste Element des Paares ist der Wert und das zweite ist ein Zeichen f√ºr seine Richtigkeit.  Das hei√üt, es macht wenig Sinn, aus dem Speicher zu lesen, solange die Adresse falsch ist und das Schreiben im Allgemeinen unm√∂glich ist. </p><br><p>  Das eBPF-Bytecode-Ausf√ºhrungsmodell setzt eine Art RAM mit 64-Bit-Adressierung sowie einen Satz von 16 (oder sogar zehn) 64-Bit-Registern voraus.  Ein primitiver rekursiver Algorithmus wird vorgeschlagen: </p><br><ul><li>  Wir beginnen mit dem Kontext, in dem die Operanden des Befehls in <code>r1</code> und <code>r2</code> , in den restlichen Nullen alle g√ºltig (genauer gesagt, die G√ºltigkeit entspricht der ‚ÄûBereitschaft‚Äú des Coprozessorbefehls). </li><li>  Wenn wir einen arithmetisch-logischen Befehl sehen, extrahieren wir seine Operandenregister aus dem Kontext, rufen uns f√ºr das Ende der Liste und den Kontext auf, in dem der Ausgabeoperand durch ein Paar ersetzt wird <code>(data1 op data2, valid1 &amp;&amp; valid2)</code> </li><li>  Wenn wir auf einen Zweig sto√üen, bauen wir einfach beide Zweige rekursiv auf: Wenn der Zweig auftritt und wenn nicht </li><li>  Wenn wir auf das Laden oder Speichern im Speicher sto√üen, kommen wir irgendwie raus: Wir f√ºhren den √ºbertragenen R√ºckruf aus, unter der Annahme, dass die <code>valid</code> Anweisung w√§hrend der Ausf√ºhrung dieser Anweisung nicht mehr abgerufen werden kann.  Die G√ºltigkeit des Speichervorgangs ist UND von uns mit dem Flag <code>globalValid</code> , das gesetzt werden muss, bevor die Kontrolle zur√ºckgegeben wird.  Gleichzeitig m√ºssen wir vorne lesen und schreiben, um Inkremente und andere √Ñnderungen korrekt zu verarbeiten. </li></ul><br><p>  Somit werden die Operationen so parallel wie m√∂glich und nicht schrittweise ausgef√ºhrt.  Gleichzeitig bitte ich Sie, darauf zu achten, dass alle Operationen auf einem bestimmten Speicherbyte nat√ºrlich vollst√§ndig geordnet werden sollten, da sonst das Ergebnis unvorhersehbar ist, UB.  Das hei√üt,  <code>*addr += 1</code> - dies ist normal, das Schreiben beginnt nicht genau, bis das Lesen abgeschlossen ist (kitschig, weil wir immer noch nicht wissen, was wir schreiben sollen), aber <code>*addr += 1; return *addr;</code> <code>*addr += 1; return *addr;</code>  Ich gab im Allgemeinen sicher <strong>Null</strong> oder so etwas aus.  Vielleicht lohnt es sich zu debuggen (vielleicht verbirgt es ein kniffligeres Problem), aber ein solcher Appell an sich ist auf jeden Fall eine mittelm√§√üige Idee, da Sie nachverfolgen m√ºssen, welche Speicheradressen die Arbeit bereits erledigt hat, aber ich habe einen Wunsch √úberpr√ºfen Sie die Werte <code>valid</code> M√∂glichkeit statisch.  Dies ist genau das, was f√ºr globale Variablen mit fester Gr√∂√üe getan wird. </p><br><p>  Das Ergebnis ist eine abstrakte Klasse <code>BpfCircuitConstructor</code> , f√ºr die keine Methoden <code>doMemLoad</code> , <code>doMemStore</code> und <code>resolveSymbol</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... sealed abstract class LdStType(val lgsize: Int) { val byteSize = 1 &lt;&lt; lgsize val bitSize = byteSize * 8 val mask: UInt = if (bitSize == 64) mask64 else ((1l &lt;&lt; bitSize) - 1).U } case object u8 extends LdStType(0) case object u16 extends LdStType(1) case object u32 extends LdStType(2) case object u64 extends LdStType(3) def doMemLoad(addr: UInt, tpe: LdStType, valid: Bool): (UInt, Bool) def doMemStore(addr: UInt, tpe: LdStType, data: UInt, valid: Bool): Bool sealed trait Resolved { def asPlainValue: UInt def load(ctx: Context, offset: Int, tpe: LdStType, valid: Bool): LazyData def store(offset: Int, tpe: LdStType, data: UInt, valid: Bool): Bool } def resolveSymbol(sym: BpfLoader.Symbol): Resolved // ... }</span></span></code> </pre> <br><h2 id="integraciya-s-processornym-yadrom">  CPU-Kernintegration </h2><br><p>  F√ºr den Anfang habe ich mich f√ºr den einfachen Weg entschieden: Stellen Sie mithilfe des Standard-RoCC-Protokolls (Rocket Custom Coprocessor) eine Verbindung zum Prozessorkern her.  Soweit ich wei√ü, ist dies eine regul√§re Erweiterung, nicht f√ºr alle RISC-V-kompatiblen Kernel, sondern nur f√ºr Rocket und BOOM (Berkeley Out-of-Order Machine). Daher wurden beim Ziehen der Upstream-Arbeit auf Compilern die Assembler- <code>custom0</code> Mnemonics aus ihnen herausgeworfen. <code>custom3</code> verantwortlich f√ºr Beschleunigerbefehle. </p><br><p>  Im Allgemeinen k√∂nnen jedem Rocket / BOOM-Prozessorkern bis zu vier RoCC-Beschleuniger √ºber die Konfiguration hinzugef√ºgt werden. Es gibt auch Implementierungsbeispiele: </p><br><p>  <strong>Configs.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithRoccExample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BuildRoCC</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> accumulator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AccumulatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom0, n = <span class="hljs-number"><span class="hljs-number">4</span></span>)(p)) accumulator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> translator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">TranslatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom1)(p)) translator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> counter = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">CharacterCountExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom2)(p)) counter }) })</code> </pre> <br><p>  Die entsprechende Implementierung befindet sich in der Datei <code>LazyRoCC.scala</code> . </p><br><p>  Die Beschleunigerimplementierung stellt zwei Klassen dar, die bereits vom Speichercontroller bekannt sind: Eine davon wird in diesem Fall von <code>LazyRoCC</code> geerbt, die andere von <code>LazyRoCCModuleImp</code> .  Die zweite Klasse verf√ºgt √ºber einen <code>io</code> Port vom Typ <code>RoCCIO</code> , der den <code>cmd</code> Anforderungsport, den Resp-Response-Port, den L1D-Cache-Port f√ºr den Mem-Zugriff, Besetzt- und <code>interrupt</code> Ausg√§nge sowie die <code>exception</code> .  Es gibt auch einen Seitentabellen-Walker-Port und FPUs, die wir anscheinend noch nicht ben√∂tigen (ohnehin gibt es in eBPF keine echte Arithmetik).  Bisher m√∂chte ich versuchen, etwas mit diesem Ansatz zu tun, damit ich <code>interrupt</code> nicht ber√ºhre.  Soweit ich wei√ü, gibt es auch eine TileLink-Schnittstelle f√ºr den nicht zwischengespeicherten Speicherzugriff, aber im Moment werde ich sie auch nicht ber√ºhren. </p><br><h2 id="uporyadochivatel-zaprosov">  Organisator abfragen </h2><br><p>  Wir haben also einen Port f√ºr den Zugriff auf den Cache, aber nur einen.  Gleichzeitig kann eine Funktion beispielsweise eine Variable inkrementieren (die zumindest in eine einzelne atomare Operation umgewandelt werden kann) oder sie sogar irgendwie trivial transformieren, indem sie geladen, aktualisiert und gespeichert wird.  Am Ende kann eine einzelne Anweisung mehrere unabh√§ngige Anforderungen stellen.  Vielleicht ist dies nicht die beste Idee in Bezug auf die Leistung, aber warum nicht beispielsweise drei W√∂rter laden (die sich m√∂glicherweise bereits im Cache befinden), sie irgendwie <strong>parallel</strong> zur kombinatorischen Logik verarbeiten (dann)? einen Schlag haben) und das Ergebnis speichern.  Daher ben√∂tigen wir ein Schema, das Versuche des parallelen Zugriffs auf einen einzelnen Cache-Port effektiv ‚Äûaufl√∂st‚Äú. </p><br><p>  Die Logik <code>funct</code> : Zu Beginn der Generierung der Implementierung einer bestimmten <code>funct</code> (ein 7-Bit- <code>funct</code> in Bezug auf RoCC) wird eine Instanz des Abfrageserialisierers erstellt (eine globale Instanz erscheint mir ziemlich sch√§dlich, da sie eine Reihe zus√§tzlicher Abh√§ngigkeiten zwischen Anforderungen erzeugt, die niemals gleichzeitig ausgef√ºhrt werden k√∂nnen, und verschwenden Fmax wird h√∂chstwahrscheinlich).  Als n√§chstes wird jeder erstellte "Saver" / "Loader" im Serializer registriert.  Sozusagen in einer Live-Warteschlange.  Bei jeder Ma√ünahme wird die erste Anfrage in der Registrierungsreihenfolge ausgew√§hlt - <strong>bei der n√§chsten Ma√ünahme</strong> erh√§lt er die Erlaubnis.  Nat√ºrlich muss eine solche Logik gut mit Tests abgedeckt sein (ich habe wirklich noch nicht viele davon, daher ist dies nicht nur eine √úberpr√ºfung, sondern das Minimum, das erforderlich ist, um zumindest etwas Verst√§ndliches zu erhalten).  Ich habe den Standard- <code>PeekPokeTester</code> einer mehr oder weniger offiziellen Komponente zum Testen von Mei√üelkonstruktionen verwendet.  Ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">habe es schon einmal beschrieben</a> . </p><br><p>  Das Ergebnis war eine solche Erfindung: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">isComputing: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span><span class="hljs-class"><span class="hljs-params">, next: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monotonic</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">WireInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prevRes = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) prevRes := res &amp;&amp; isComputing res := (x || prevRes) &amp;&amp; isComputing res } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noone</span></span></span></span>(bs: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = !bs.foldLeft(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>)(_ || _) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> previousReqs = <span class="hljs-type"><span class="hljs-type">ArrayBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextReq</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> enable = monotonic(x) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retired = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doRetire = result &amp;&amp; next <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reqWon = thisReq &amp;&amp; noone(previousReqs) when (isComputing) { when(reqWon) { result := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } when(doRetire) { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } } otherwise { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } previousReqs += thisReq (result, previousReqs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><p>  Bitte beachten Sie, dass hier beim Erstellen einer digitalen Schaltung der Scala-Code sicher ausgef√ºhrt wird.  Wenn Sie genauer hinschauen, k√∂nnen Sie sogar einen <code>ArrayBuffer</code> bemerken, in den die Teile der Schaltung gestapelt sind ( <code>Boolean</code> ist ein Typ von Scala, <code>Bool</code> ist ein Chisel-Typ, der Live-Ger√§te darstellt, und kein zur Laufzeit bekannter Boolean). </p><br><h2 id="rabota-s-l1d-keshom">  Arbeiten mit L1D Cache </h2><br><p>  Die Arbeit mit dem Cache erfolgt haupts√§chlich √ºber den Anforderungsport <code>io.mem.req</code> und den <code>io.mem.resp</code> .  Gleichzeitig ist der Anforderungsport mit den herk√∂mmlichen <code>ready</code> und <code>valid</code> Signalen ausgestattet: Der erste sagt Ihnen, dass er bereit ist, die Anforderung anzunehmen, der zweite besagt, dass die Anforderung bereit ist und bereits die richtige Struktur hat. Auf der Vorderseite gilt <code>valid &amp;&amp; resp</code> Anforderung wird als angenommen betrachtet.  In einigen solchen Schnittstellen besteht die Anforderung, dass Signale vom Zeitpunkt der Einstellung auf <code>true</code> und bis zur nachfolgenden positiven Flanke von <code>valid &amp;&amp; resp</code> nicht reagieren (dieser Ausdruck kann der <code>valid &amp;&amp; resp</code> mit der <code>fire()</code> -Methode konstruiert werden). </p><br><p>  Der <code>resp</code> Response-Port hat wiederum nur ein <code>valid</code> Vorzeichen, und dies ist das Problem des Prozessors, Antworten in einem Taktzyklus zu rechen: Er ist unter der Annahme "immer bereit", und <code>fire()</code> gibt nur <code>valid</code> . </p><br><p>  Wie ich bereits sagte, k√∂nnen Sie keine Anfragen stellen, wenn es schrecklich ist: Sie k√∂nnen nichts schreiben, ich wei√ü nicht was, und noch einmal lesen, was sp√§ter auf der Grundlage des subtrahierten Werts √ºberschrieben wird, ist auch irgendwie seltsam.  Die <code>Serializer</code> Klasse versteht dies bereits, aber wir geben ihr nur ein Zeichen daf√ºr, dass die aktuelle Anforderung bereits in den Cache <code>next = io.mem.req.fire()</code> : <code>next = io.mem.req.fire()</code> .  Alles, was getan werden kann, ist sicherzustellen, dass im "Leser" die Antwort nur aktualisiert wird, wenn sie wirklich gekommen ist - nicht fr√ºher und nicht sp√§ter.  <code>holdUnless</code> gibt es eine bequeme <code>holdUnless</code> Methode.  Das Ergebnis ist ungef√§hr die folgende Implementierung: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Serializer</span></span>(isComputing, io.mem.req.fire()) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemLoad</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">UInt</span></span>, <span class="hljs-type"><span class="hljs-type">Bool</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doResp = isComputing &amp;&amp; serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp; io.mem.resp.valid &amp;&amp; io.mem.resp.bits.tag === thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> &amp;&amp; io.mem.resp.bits.cmd === <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemStore</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, data: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XWR</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := data io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveSymbol</span></span></span></span>(sym: <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>): <span class="hljs-type"><span class="hljs-type">Resolved</span></span> = sym <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>(symName, _, size, <span class="hljs-type"><span class="hljs-type">ElfConstants</span></span>.<span class="hljs-type"><span class="hljs-type">Elf64_Shdr</span></span>.<span class="hljs-type"><span class="hljs-type">SHN_COMMON</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">RegisterReference</span></span>(regs.getOrElseUpdate(symName, <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)))) } }</code> </pre> <br><p>  F√ºr jede generierte Unteranweisung wird eine Instanz dieser Klasse erstellt. </p><br><h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya">  Nicht alle auf dem Heap sind globale Variablen </h2><br><p>  Hmm, was ist ein Modellbeispiel?  Welche Leistung m√∂chte ich sicherstellen?  Nat√ºrlich AFL Instrumentation!  In der klassischen Version sieht es so aus: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_branch(uint64_t tag) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p>  Wie Sie sehen k√∂nnen, wird mehr oder weniger logisch ein Byte von <code>__afl_area_ptr</code> und <code>__afl_area_ptr</code> (und dazwischen ein Inkrement), aber hier fragt das Register nach der <code>prev</code> Rolle! </p><br><p>  Aus diesem Grund wird die <code>Resolved</code> Schnittstelle ben√∂tigt: Sie kann entweder eine regul√§re Speicheradresse umschlie√üen oder eine Registerreferenz sein.  Gleichzeitig betrachte ich bisher nur skalare Register mit einer Gr√∂√üe von 1, 2, 4 oder 8 Bytes, die immer mit einem Offset von Null gelesen werden. F√ºr Register k√∂nnen Sie die Reihenfolge der Aufrufe daher relativ ruhig implementieren.  In diesem Fall ist es sehr n√ºtzlich zu wissen, dass <code>prev</code> zuerst subtrahiert und zur Berechnung des Index verwendet und erst dann neu geschrieben werden muss. </p><br><h2 id="a-teper-instrumentaciya">  Und jetzt die Instrumentierung </h2><br><p>  Irgendwann haben wir einen separaten und mehr oder weniger funktionierenden Beschleuniger mit der RoCC-Schnittstelle.  Was jetzt?  Trotzdem neu implementieren und die Prozessor-Pipeline durchlaufen?  Es schien mir, dass weniger Kr√ºcken ben√∂tigt w√ºrden, wenn parallel zur angewiesenen Anweisung der Coprozessor mit der automatisch ausgegebenen Nutzwertfunktion einfach aktiviert w√ºrde.  Grunds√§tzlich musste ich mich auch daf√ºr qu√§len: Ich habe sogar gelernt, SignalTap zu benutzen, weil das Debuggen fast blind ist und selbst bei einer f√ºnfmin√ºtigen Neukompilierung nach der geringsten √Ñnderung (mit Ausnahme der √Ñnderung des Bootroms - dort ist alles schnell) - das ist schon zu viel. </p><br><p>  Infolgedessen wurde der Befehlsdecoder optimiert und die Pipeline leicht "aufgerichtet", um der Tatsache Rechnung zu tragen, dass unabh√§ngig davon, was der Decoder √ºber den urspr√ºnglichen Befehl sagte, das pl√∂tzlich aktivierte RoCC selbst nicht bedeutet, dass wie w√§hrend des Teilungsvorgangs eine lange Latenz in das Ausgangsregister geschrieben wird und den Datencache verpassen. </p><br><p>  Im Allgemeinen ist eine Beschreibung eines Befehls ein Paar ([Muster zum Erkennen eines Befehls], [Wertesatz zum Konfigurieren von Datenpfadbl√∂cken des Prozessorkerns]).  Zum Beispiel sieht die <code>default</code> (nicht erkannte Anweisung) folgenderma√üen aus (entnommen aus <code>IDecode.scala</code> , im Desktop-Habr sieht sie ehrlich gesagt h√§sslich aus): </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">default</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// jal renf1 fence.i // val | jalr | renf2 | // | fp_val| | renx2 | | renf3 | // | | rocc| | | renx1 s_alu1 mem_val | | | wfd | // | | | br| | | | s_alu2 | imm dw alu | mem_cmd mem_type| | | | mul | // | | | | | | | | | | | | | | | | | | | | | div | fence // | | | | | | | | | | | | | | | | | | | | | | wxd | | amo // | | | | | | | | scie | | | | | | | | | | | | | | | | | dp List(N,X,X,X,X,X,X,X,X,A2_X, A1_X, IMM_X, DW_X, FN_X, N,M_X, MT_X, X,X,X,X,X,X,X,CSR.X,X,X,X,X)</span></span></code> </pre> <br><p>  ... und eine typische Beschreibung <em>einer der Erweiterungen</em> im Rocket-Kern wird folgenderma√üen implementiert: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDecode</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecodeConstants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> table: <span class="hljs-type"><span class="hljs-type">Array</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">BNE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SNE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BEQ</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SEQ</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLT</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLT</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLTU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLTU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGEU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGEU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  Tatsache ist, dass in RISC-V (nicht nur in RocketChip, sondern in der Architektur von Befehlen im Prinzip) die ISA-Aufteilung in die obligatorische Teilmenge I (ganzzahlige Operationen) sowie optional M (ganzzahlige Multiplikation und Division), A (Atomics) regelm√§√üig unterst√ºtzt wird usw. </p><br><p>  Als Ergebnis die urspr√ºngliche Methode </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs = <span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> <br><p>  wurde ersetzt durch </p><br><div class="spoiler">  <b class="spoiler_title">das gleiche, aber mit einem Decoder zur Instrumentierung und Kl√§rung des Grundes f√ºr die Aktivierung von rocc</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])], handlers: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs=<span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handlers.isEmpty) { handler_rocc := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> handler_rocc_funct := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = handlers.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(funct.<span class="hljs-type"><span class="hljs-type">U</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerDecoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>)), handlerTable) <span class="hljs-type"><span class="hljs-type">Seq</span></span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (s,d) =&gt; s:=d } } rocc := rocc_explicit || handler_rocc <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> </div></div><br><p>  Von den √Ñnderungen in der Prozessor-Pipeline war die vielleicht offensichtlichste folgende: </p><br><pre> <code class="diff hljs"> io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR io.rocc.cmd.bits.status := csr.io.status io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst) + when (wb_ctrl.handler_rocc) { + io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0 + io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct + io.rocc.cmd.bits.inst.xd := false.B + io.rocc.cmd.bits.inst.rd := 0.U + } io.rocc.cmd.bits.rs1 := wb_reg_wdata io.rocc.cmd.bits.rs2 := wb_reg_rs2</code> </pre> <br><p>  Es ist klar, dass einige Parameter der Anforderung an den Beschleuniger korrigiert werden m√ºssen: Es wird keine Antwort in das Register geschrieben, und die <code>funct</code> entspricht der vom Decoder zur√ºckgegebenen.  Es gibt jedoch eine etwas weniger offensichtliche √Ñnderung: Tatsache ist, dass dieser Befehl nicht direkt an den Beschleuniger geht (vier davon - welcher?), Sondern an den Router. Sie m√ºssen also so tun, als h√§tte der Befehl <code>opcode == custom0</code> (yes, Prozess, und es ist genau der Nullbeschleuniger!). </p><br><h2 id="proverka">  √úberpr√ºfen Sie </h2><br><p>  Tats√§chlich geht dieser Artikel von einer Fortsetzung aus, in der versucht wird, diesen Ansatz auf ein mehr oder weniger Produktionsniveau zu bringen.  Sie m√ºssen mindestens lernen, den Kontext (Status der Coprozessorregister) zu speichern und wiederherzustellen, wenn Sie Aufgaben wechseln.  In der Zwischenzeit werde ich √ºberpr√ºfen, ob es unter Gew√§chshausbedingungen funktioniert: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; uint64_t counter; uint64_t funct1(uint64_t x, uint64_t y) { return __builtin_popcountl(x); } uint64_t funct2(uint64_t x, uint64_t y) { return (x + y) * (x - y); } uint64_t instMUL() { counter += 1; *((uint64_t *)0x81005000) = counter; return 0; }</span></span></span></span></code> </pre> <br><p>  <code>bootrom/sdboot/sd.c</code> in der <code>main</code> hinzu </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// ... ////    -   RoCC #define STR1(x) #x #define STR(x) STR1(x) #define EXTRACT(a, size, offset) (((~(~0 &lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset) #define CUSTOMX_OPCODE(x) CUSTOM_##x #define CUSTOM_0 0b0001011 #define CUSTOM_1 0b0101011 #define CUSTOM_2 0b1011011 #define CUSTOM_3 0b1111011 #define CUSTOMX(X, rd, rs1, rs2, funct) \ CUSTOMX_OPCODE(X) | \ (rd &lt;&lt; (7)) | \ (0x7 &lt;&lt; (7+5)) | \ (rs1 &lt;&lt; (7+5+3)) | \ (rs2 &lt;&lt; (7+5+3+5)) | \ (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5)) #define CUSTOMX_R_R_R(X, rd, rs1, rs2, funct) \ asm ("mv a4, %[_rs1]\n\t" \ "mv a5, %[_rs2]\n\t" \ ".word "STR(CUSTOMX(X, 15, 14, 15, funct))"\n\t" \ "mv %[_rd], a5" \ : [_rd] "=r" (rd) \ : [_rs1] "r" (rs1), [_rs2] "r" (rs2) \ : "a4", "a5"); int main(void) { // ... //  RoCC extension write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; 1)); //   bootrom       uint64_t res; CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 2); // ...     uint64_t x = 1; for (int i = 0; i &lt; 123; ++i) x *= *(volatile uint8_t *)0x80000000; kputc('0' + x % 10); //   !!! // ... }</span></span></span></span></code> </pre> <br><p>  <code>write_csr</code> ,     <code>custom0</code> - <code>custom3</code> .      ,   illegal instruction,  ,  , ,   .   <code>define</code> -     - ,   ¬´¬ª binutils  <code>customX</code>      RocketChip,  ,   ,   . </p><br><p>     sdboot  ,       ,      . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000000000 in ?? () (gdb) x/d 0x81005000 0x81005000: 123 (gdb) set variable $pc=0x10000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151 151 crc ^= data; (gdb) x/d 0x81005000 0x81005000: 246</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> funct1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000010194 in main () at sd.c:247 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); (gdb) set variable $a5=0 (gdb) set variable $pc=0x10194 (gdb) set variable $a4=0xaa (gdb) display/10i $pc-10 1: x/10i $pc-10 0x1018a &lt;main+46&gt;: sw a3,124(a3) 0x1018c &lt;main+48&gt;: addiw a0,a0,1110 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 =&gt; 0x10194 &lt;main+56&gt;: 0x2f7778b 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; (gdb) display/x $a5 2: /x $a5 = 0x0 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x4 (gdb) set variable $a4=0xaabc (gdb) set variable $pc=0x10194 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x9</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quellcode</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de461577/">https://habr.com/ru/post/de461577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de461565/index.html">Die 5 Gebote von TypeScript Developer</a></li>
<li><a href="../de461567/index.html">SQL Unterhaltsame R√§tsel</a></li>
<li><a href="../de461569/index.html">Hinweis f√ºr das Frontend: Was ist vor dem Testen zu √ºberpr√ºfen?</a></li>
<li><a href="../de461571/index.html">SVG im wirklichen Leben. Yandex-Bericht</a></li>
<li><a href="../de461575/index.html">Erstellen einer Cloud-basierten 3CX-TK-Anlage auf jedem Openstack-kompatiblen Hosting</a></li>
<li><a href="../de461579/index.html">WebMoney f√ºhrt neue WMP-Geldb√∂rsen ein und √§ndert die Spielregeln</a></li>
<li><a href="../de461583/index.html">Python zum Testen von Strukturprodukten</a></li>
<li><a href="../de461587/index.html">Lokalisierung der Anwendung in 10 Schritten</a></li>
<li><a href="../de461589/index.html">Tic Tac Toe: Inhaltszyklus</a></li>
<li><a href="../de461593/index.html">API auf F #. Zugriff auf rollenbasierte Anwendungsmodule</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>