<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèΩ üêõ üëÜ GitLab para Proyecto de Entrega Continua en Tecnolog√≠as InterSystems: Contenedores üíÄ ü§ôüèæ üë∂üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo es una continuaci√≥n de un art√≠culo sobre la organizaci√≥n de los procesos de Integraci√≥n continua / Entrega continua que automatizan el e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GitLab para Proyecto de Entrega Continua en Tecnolog√≠as InterSystems: Contenedores</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/intersystems/blog/420749/"><p>  Este art√≠culo es una continuaci√≥n de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> sobre la organizaci√≥n de los procesos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Integraci√≥n continua</a> / Entrega continua que automatizan el ensamblaje, las pruebas y la entrega de aplicaciones aplicables a soluciones basadas en la plataforma InterSystems. </p><br><p>  Considere temas como: </p><br><ul><li>  Contenedores 101 </li><li>  Contenedores en diferentes etapas del ciclo de desarrollo de software. </li><li>  Entrega continua con contenedores <a name="habracut"></a></li></ul><br><h1 id="konteynery-101">  Contenedores 101 </h1><br><p>  Se han escrito muchos art√≠culos y libros sobre contenedores y contenedorizaci√≥n, por lo que aqu√≠ har√© una peque√±a introducci√≥n que, sin embargo, no pretende ser final.  Entonces comencemos. </p><br><p>  Los contenedores, t√©cnicamente, son un m√©todo de virtualizaci√≥n en el que el n√∫cleo del sistema operativo admite varias instancias aisladas de espacio de usuario (contenedores), en lugar de uno.  Esto se ve visualmente as√≠: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/114/c21/985/114c21985549c134bf91685e2b15d1d3.jpg" alt="Docker vs VM"></p><br><p>  Es importante tener en cuenta que los contenedores no son m√°quinas virtuales, aqu√≠ hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">buen art√≠culo</a> sobre sus diferencias. </p><br><h2 id="preimuschestva-konteynerov">  Beneficios de contenedores </h2><br><p>  Existen varios beneficios al usar contenedores: </p><br><ul><li>  Portabilidad </li><li>  Efectividad </li><li>  Aislamiento </li><li>  Ligereza </li><li>  Inmutabilidad </li></ul><br><h3 id="portativnost">  Portabilidad </h3><br><p>  El contenedor contiene la aplicaci√≥n junto con todas las dependencias.  Esto facilita la ejecuci√≥n de aplicaciones en diversos entornos, como servidores f√≠sicos, m√°quinas virtuales, entornos de prueba y entornos de productos y nubes. </p><br><p>  Adem√°s, la portabilidad consiste en el hecho de que despu√©s de que la imagen de Docker est√© ensamblada y funcione correctamente, funcionar√° en cualquier lugar si Docker funciona all√≠, es decir.  en servidores Windows, Linux y MacOS. </p><br><h3 id="effektivnost">  Efectividad </h3><br><p>  Al trabajar con aplicaciones de m√°quinas virtuales, ¬ørealmente necesita procesos del sistema operativo, programas del sistema, etc.?  Como regla general, no, solo el proceso de su solicitud es interesante.  Los contenedores proporcionan exactamente esto: solo aquellos procesos que son claramente necesarios se inician en el contenedor, y nada m√°s.  Debido a que los contenedores no requieren un sistema operativo separado, usan menos recursos.  Una m√°quina virtual a menudo ocupa varios gigabytes, mientras que un contenedor puede ser tan peque√±o como unos pocos megabytes, lo que le permite ejecutar muchos m√°s contenedores que m√°quinas virtuales en un solo servidor. </p><br><p> Debido a que los contenedores tienen un mayor nivel de utilizaci√≥n del servidor, se requiere menos hardware, lo que resulta en menores costos. </p><br><h3 id="izolyaciya">  Aislamiento </h3><br><p>  Los contenedores a√≠slan la aplicaci√≥n de todos los dem√°s procesos, y aunque varios contenedores pueden ejecutarse en el mismo servidor, pueden ser completamente independientes entre s√≠.  Cualquier interacci√≥n entre contenedores debe declararse expl√≠citamente.  Si un contenedor falla, no afecta a otros contenedores y puede reiniciarse r√°pidamente.  La seguridad tambi√©n se ve reforzada por este aislamiento.  Por ejemplo, explotar la vulnerabilidad de un servidor web en un host puede dar acceso a un atacante a todo el servidor, pero en el caso de un contenedor, un atacante solo obtendr√° acceso al contenedor del servidor web. </p><br><h3 id="lyogkost">  Ligereza </h3><br><p>  Dado que los contenedores no requieren un sistema operativo separado, se pueden iniciar, detener o reiniciar en cuesti√≥n de segundos, lo que acelerar√° todos los procesos relacionados, incluidos los procesos de integraci√≥n continua.  Puede comenzar a desarrollar m√°s r√°pido y no perder el tiempo configurando su entorno. </p><br><h3 id="neizmennost-immutability">  Inmutabilidad </h3><br><p>  La infraestructura inmutable consta de componentes inmutables que se reemplazan para cada implementaci√≥n y no se actualizan.  La coherencia reduce la inconsistencia y le permite replicar y moverse f√°cil y r√°pidamente entre diferentes estados de su aplicaci√≥n.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√°s sobre inmutabilidad</a> . </p><br><h2 id="novye-vozmozhnosti">  Nuevas caracter√≠sticas </h2><br><p>  Todos estos beneficios le permiten administrar su infraestructura y aplicaciones de una nueva manera. </p><br><h3 id="orkestraciya">  Orquestaci√≥n </h3><br><p>  Las m√°quinas y servidores virtuales con el tiempo a menudo adquieren "personalidad", lo que lleva a muchas sorpresas generalmente desagradables en el futuro.  Una soluci√≥n a este problema es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Infraestructura como C√≥digo</a> (IoC): administraci√≥n de infraestructura que utiliza un modelo descriptivo que utiliza un sistema de control de versiones. </p><br><p>  Cuando se usa IoC, el equipo de implementaci√≥n del entorno siempre trae el entorno de destino a la misma configuraci√≥n, independientemente del estado inicial del entorno.  Esto se logra configurando autom√°ticamente un entorno existente o volviendo a crear el entorno desde cero. </p><br><p>  Con IoC, los desarrolladores realizan cambios en la descripci√≥n del entorno.  Posteriormente, el entorno de destino se modifica a un nuevo estado.  Si necesita hacer cambios el mi√©rcoles, se edita su descripci√≥n. </p><br><p>  Todo esto es mucho m√°s f√°cil de hacer con contenedores.  Cerrar el contenedor e iniciar uno nuevo lleva unos segundos, y asignar una nueva m√°quina virtual lleva unos minutos. </p><br><h3 id="masshtabirovanie">  Escalamiento </h3><br><p>  Las herramientas de orquestaci√≥n tambi√©n pueden proporcionar escala horizontal en funci√≥n de la carga actual.  Es posible ejecutar tantos contenedores como se requiera actualmente y escalar la aplicaci√≥n en consecuencia.  Todo esto tambi√©n reduce el costo de la aplicaci√≥n. </p><br><h1 id="konteynery-na-raznyh-etapah-zhiznennogo-cikla-po">  Contenedores en diferentes etapas del ciclo de vida del software. </h1><br><p>  Considere los beneficios de los contenedores en varias etapas del ciclo de vida del software. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/639/58e/062/63958e06271594a0c8fbe5a8e8785ca7.png" alt="Ciclo de vida del software"></p><br><h2 id="razrabotka">  Desarrollo </h2><br><p> La ventaja m√°s importante es la facilidad de iniciar el desarrollo.  Despu√©s de <a href="">instalar Docker</a> , es suficiente ejecutar dos comandos: <code>docker pull</code> para cargar la imagen y <code>docker run</code> para iniciarla.  Todas las dependencias ya est√°n resueltas en la etapa de compilaci√≥n de la aplicaci√≥n. </p><br><h2 id="otladka">  Depuraci√≥n </h2><br><p>  Todos los entornos son consistentes y sus definiciones existen; adem√°s, es f√°cil implementar el entorno necesario.  Es suficiente para que <code>docker pull</code> el contenedor de inter√©s y lo ejecute. </p><br><h2 id="testirovanie--qa">  Prueba / QA </h2><br><p>  En caso de error, el entorno del problema y las condiciones para reproducir el error se pueden transferir con el contenedor.  Todos los cambios de infraestructura est√°n "documentados".  El n√∫mero de variables est√° disminuyendo: versiones de bibliotecas, marcos, SO ... Es posible ejecutar varios contenedores para paralelizar las pruebas. </p><br><h2 id="dostavka">  La entrega </h2><br><p>  El uso de contenedores le permite construir una vez, adem√°s de usar contenedores, necesita un alto nivel de automatizaci√≥n de los procesos de ensamblaje e implementaci√≥n.  La entrega en contenedor de una aplicaci√≥n puede ser m√°s segura debido al aislamiento adicional. </p><br><h1 id="continuous-delivery">  Entrega continua </h1><br><p>  Pasemos de la teor√≠a a la pr√°ctica.  Aqu√≠ hay una vista general de nuestra soluci√≥n de automatizaci√≥n de ensamblaje y entrega: </p><br><p><img src="https://habrastorage.org/webt/yv/dn/qc/yvdnqcgyrlswgft4-zhnm-2mabc.png" alt="CD"></p><br><p>  Se pueden distinguir tres etapas principales: </p><br><ul><li>  Asamblea </li><li>  La entrega </li><li>  Lanzamiento </li></ul><br><h2 id="sborka">  Asamblea </h2><br><p>  En el art√≠culo anterior, el ensamblaje fue incremental: consideramos la diferencia entre el entorno actual y la nueva base de c√≥digo y cambiamos nuestro entorno para que correspondiera a la nueva base de c√≥digo.  Con contenedores, cada ensamblaje est√° completo.  El resultado de la compilaci√≥n es una imagen de Docker que se puede ejecutar en cualquier lugar. </p><br><h2 id="dostavka-1">  La entrega </h2><br><p>  Despu√©s de que nuestra imagen se compila y se prueba, se carga en el Registro de Docker, una aplicaci√≥n especializada para alojar la imagen de Docker.  All√≠ puede reemplazar la imagen anterior con el mismo nombre (etiqueta).  Por ejemplo, debido a un nuevo compromiso con la rama maestra, hemos reunido una nueva imagen ( <code>MyProject/MyApp:master</code> ), y si se pasan las pruebas, podemos actualizar la imagen en el Docker Registry y todos los que descarguen <code>MyProject/MyApp:master</code> obtendr√°n una nueva versi√≥n. </p><br><h2 id="zapusk">  Lanzamiento </h2><br><p>  Finalmente, la imagen debe iniciarse.  Un sistema de CD, como GitLab, puede administrar esto directamente o con la ayuda de un orquestador especializado, pero el proceso generalmente es el mismo: algunas im√°genes se lanzan, se verifica peri√≥dicamente el rendimiento y se actualiza si hay una nueva versi√≥n disponible. </p><br><p>  Consulte el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">seminario web que</a> explica estos pasos. </p><br><p>  Alternativamente, en t√©rminos de commit: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ced/48d/84c/ced48d84c0a2213b3bd9c2bda109146e.png"></p><br><p>  En nuestra configuraci√≥n de entrega continua, nosotros: </p><br><ul><li>  Confirmar c√≥digo en el repositorio de GitLab </li><li>  Recogemos la imagen </li><li>  Prob√°ndolo </li><li>  Publique una nueva imagen en nuestro Registro Docker </li><li>  Actualice el contenedor anterior a la nueva versi√≥n desde el Registro Docker </li></ul><br><p>  Para esto necesitamos: </p><br><ul><li>  Docker </li><li>  Registro de Docker </li><li>  Dominio registrado (opcional, pero deseable) </li><li>  Herramientas GUI (opcional) </li></ul><br><h3 id="docker">  Docker </h3><br><p>  En primer lugar, necesitamos iniciar Docker.  Recomendar√≠a comenzar con un √∫nico servidor con una versi√≥n com√∫n de Linux, como Ubuntu, RHEL o Suse.  No recomiendo comenzar con distribuciones como CoreOS, RancherOS, etc., no est√°n dirigidas a principiantes.  <a href="">Recuerde cambiar el controlador de almacenamiento a devicemapper</a> . </p><br><p>  Si hablamos de implementaciones a gran escala, utilizando herramientas de orquestaci√≥n como Kubernetes, Rancher o Swarm, puede automatizar la mayor√≠a de las tareas, pero no las discutiremos (al menos en el marco de este art√≠culo). </p><br><h3 id="docker-registry">  Registro de Docker </h3><br><p>  Este es el primer contenedor que necesitamos ejecutar, es una aplicaci√≥n independiente que nos permite almacenar y distribuir im√°genes de Docker.  Debe usar el Registro Docker si desea: </p><br><ul><li>  Controla d√≥nde se almacenan tus im√°genes </li><li>  Poseer un servidor de distribuci√≥n de im√°genes </li><li>  Integre el almacenamiento y la distribuci√≥n de im√°genes en el proceso de desarrollo. </li></ul><br><p>  Aqu√≠ est√° la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> sobre el inicio y la configuraci√≥n de Docker Registry. </p><br><h3 id="podklyuchenie-docker-registry-i-gitlab">  Connect Docker Registry y GitLab </h3><br><p>  Para conectar el Registro Docker a GitLab, debe ejecutar el Registro Docker con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soporte HTTPS</a> .  Utilizo Let's Encrypt para obtener certificados, y segu√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estas instrucciones</a> para obtener un certificado.  Despu√©s de verificar que se puede acceder al Registro de Docker a trav√©s de HTTPS (puede verificarlo en el navegador), siga <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estas instrucciones</a> para conectar el Registro de Docker a GitLab.  Estas instrucciones difieren seg√∫n la instalaci√≥n de GitLab y la configuraci√≥n que necesita.  En mi caso, la configuraci√≥n fue agregar el certificado y la clave del Registro Docker a <code>/etc/gitlab/ssl</code> , y estas l√≠neas a <code>/etc/gitlab/gitlab.rb</code> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">registry_external_url</span></span> <span class="hljs-string"><span class="hljs-string">'https://docker.domain.com'</span></span> gitlab_rails [<span class="hljs-string"><span class="hljs-string">'registry_api_url'</span></span>] = <span class="hljs-string"><span class="hljs-string">"https://docker.domain.com"</span></span></code> </pre> <br><p>  Despu√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reconfigurar GitLab</a> , apareci√≥ una nueva pesta√±a de Registro, que proporciona informaci√≥n sobre c√≥mo nombrar correctamente las im√°genes creadas para que aparezcan aqu√≠. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a54/6b0/f85/a546b0f853ab022249ef03232927461d.png"></p><br><h3 id="domen">  Dominio </h3><br><p>  En nuestra configuraci√≥n de entrega continua, crearemos autom√°ticamente una imagen para cada rama, y ‚Äã‚Äãsi la imagen pasa las pruebas, se publica en el Registro de Docker y se inicia autom√°ticamente, por lo que nuestra aplicaci√≥n se implementar√° autom√°ticamente desde todas las ramas, por ejemplo: </p><br><ul><li>  Varias ramas de <code>&lt;featureName&gt;.docker.domain.com</code> en <code>&lt;featureName&gt;.docker.domain.com</code> </li><li>  Versi√≥n de prueba en <code>master.docker.domain.com</code> </li><li>  Versi√≥n de <code>preprod.docker.domain.com</code> en <code>preprod.docker.domain.com</code> </li><li>  Versi√≥n del producto en <code>prod.docker.domain.com</code> </li></ul><br><p>  Para hacer esto, necesitamos un nombre de dominio y un registro DNS comod√≠n que redirija las solicitudes a <code>* .docker.domain.com</code> a la direcci√≥n IP de <code>docker.domain.com</code> .  Alternativamente, puede usar varios puertos. </p><br><h3 id="nginx">  Nginx </h3><br><p>  Como tenemos varios entornos, necesitamos redirigir autom√°ticamente las solicitudes a subdominios al contenedor correcto.  Para esto, podemos usar Nginx como proxy inverso.  Aqu√≠ hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gu√≠a</a> . </p><br><h3 id="gui-instrumenty">  Herramientas GUI </h3><br><p>  Para comenzar a trabajar con contenedores, puede usar la l√≠nea de comandos o una de las interfaces gr√°ficas.  Hay muchos disponibles, por ejemplo: </p><br><ul><li>  Ranchero </li><li>  Microbadger </li><li>  Portainer </li><li>  Docker simple ui </li><li>  ... </li></ul><br><p>  Le permiten crear contenedores y administrarlos desde la GUI en lugar de la CLI.  As√≠ es como se ve Rancher: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/574/485/d9c/574485d9c01d464510f79097f6b823b4.png" alt="Ranchero"></p><br><h3 id="gitlab-runner">  Corredor de Gitlab </h3><br><p>  Como antes, para ejecutar scripts en otros servidores, necesitamos instalar el corredor GitLab.  Esta pregunta se describe en detalle en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior</a> . </p><br><p>  Tenga en cuenta que debe usar el Shell ejecutor, no el Docker.  Executor Docker se usa cuando necesitas algo dentro de la imagen, por ejemplo, cuando creas una aplicaci√≥n de Android en un contenedor java, y solo necesitas apk.  En nuestro caso, el artefacto es el contenedor completo, y esto requiere el ejecutor Shell. </p><br><h1 id="konfiguraciya-continuous-delivery">  Configuraci√≥n de entrega continua </h1><br><p>  Ahora que todos los componentes necesarios est√°n configurados, puede comenzar a crear una configuraci√≥n de entrega continua. </p><br><h2 id="sborka-1">  Asamblea </h2><br><p>  Primero, necesitamos armar una imagen. </p><br><p>  Nuestro c√≥digo, como siempre, se almacena en el repositorio, la configuraci√≥n del CD en <code>gitlab-ci.yml</code> , pero adem√°s (para mejorar la seguridad) almacenaremos varios archivos relacionados con la imagen en el servidor de compilaci√≥n. </p><br><h3 id="gitlabxml">  Gitlab.xml </h3><br><p>  Contiene c√≥digo de devoluci√≥n de llamada para CD.  Fue desarrollado en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior</a> y est√° disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> .  Esta es una peque√±a biblioteca para descargar c√≥digo, ejecutar varias devoluciones de llamada y c√≥digo de prueba.  Es preferible usar subm√≥dulos git para incluir este proyecto o algo similar en su repositorio.  Los subm√≥dulos son mejores porque es m√°s f√°cil mantenerlos actualizados.  Otra alternativa es crear una versi√≥n en GitLab y descargarla usando el comando ADD ya en el momento de la compilaci√≥n. </p><br><h3 id="iriskey">  iris.key </h3><br><p>  Clave de licencia.  Puede cargarse durante el ensamblaje del contenedor y no almacenarse en el servidor.  No es seguro almacenar la clave en el repositorio.  Puede obtener una clave de prueba <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en WRC</a> o probar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">InterSystems IRIS Experience</a> . </p><br><h3 id="pwdtxt">  pwd.txt </h3><br><p>  Archivo que contiene la contrase√±a predeterminada.  Nuevamente, almacenar la contrase√±a en el repositorio es bastante inseguro. </p><br><h3 id="load_ciscript">  load_ci.script </h3><br><p>  Un gui√≥n que: </p><br><ul><li>  Incluye <a href="">autenticaci√≥n del sistema operativo</a> en InterSystems IRIS </li><li>  Carga GitLab.xml </li><li>  Inicializa la configuraci√≥n de devoluci√≥n de llamada de GitLab </li><li>  C√≥digo de cargas </li></ul><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ##Class(Security.System).Get(<span class="hljs-string"><span class="hljs-string">"SYSTEM"</span></span>,.Properties) write:(<span class="hljs-string"><span class="hljs-string">'sc) $System.Status.GetErrorText(sc) set AutheEnabled = Properties("AutheEnabled") set AutheEnabled = $ZBOOLEAN(+AutheEnabled,16,7) set Properties("AutheEnabled") = AutheEnabled set sc = ##Class(Security.System).Modify("SYSTEM",.Properties) write:('</span></span>sc) $System.Status.GetErrorText(sc) zn <span class="hljs-string"><span class="hljs-string">"USER"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%SYSTEM.OBJ).Load(##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(%File).ManagerDirectory() _ <span class="hljs-string"><span class="hljs-string">"GitLab.xml"</span></span>,<span class="hljs-string"><span class="hljs-string">"cdk"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"hooks"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Hooks/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.Settings).setSetting(<span class="hljs-string"><span class="hljs-string">"tests"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyApp/Tests/"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>(isc.git.GitLab).load() halt</code> </pre> <br><p>  Tenga en cuenta que la primera l√≠nea se deja en blanco intencionalmente.  Si este script inicial es siempre el mismo, puede guardarlo en el repositorio. </p><br><h2 id="gitlab-ciyml">  gitlab-ci.yml </h2><br><p>  Ahora, pasemos a la configuraci√≥n de entrega continua: </p><br><pre> <code class="hljs bash">build image: stage: build tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - cp -r /InterSystems/mount ci - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ci - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt - mv temp.txt load_ci.script - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. - docker build --build-arg CI_PROJECT_DIR=<span class="hljs-variable"><span class="hljs-variable">$CI_PROJECT_DIR</span></span> -t docker.domain.com/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> .</code> </pre> <br><p>  ¬øQu√© est√° pasando aqu√≠? </p><br><p>  En primer lugar, dado que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el proceso de ensamblaje de im√°genes</a> solo puede acceder a subdirectorios del directorio base; en nuestro caso, el directorio ra√≠z del repositorio, debe copiar el directorio "secreto" (que tiene <code>GitLab.xml</code> , <code>iris.key</code> , <code>pwd.txt</code> y <code>load_ci.skript</code> ) a repositorio clonado. </p><br><p>  Adem√°s, se requiere un usuario / contrase√±a para acceder al terminal, por lo que los agregaremos a <code>load_ci.script</code> (para esto necesitamos una l√≠nea vac√≠a al comienzo de <code>load_ci.script</code> ). </p><br><p>  Finalmente, creamos una imagen Docker y la <code>docker.domain.com/test/docker:$CI_COMMIT_REF_NAME</code> : <code>docker.domain.com/test/docker:$CI_COMMIT_REF_NAME</code> </p><br><p>  donde <code>$CI_COMMIT_REF_NAME</code> es el nombre de la sucursal.  Tenga en cuenta que la primera parte de la etiqueta de la imagen debe coincidir con el nombre del repositorio en GitLab para que se pueda ver en la pesta√±a Registro (hay instrucciones m√°s completas para el etiquetado correcto disponibles all√≠). </p><br><h3 id="dockerfile">  Dockerfile </h3><br><p>  Docker Image se crea usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dockerfile</a> , aqu√≠ est√°: </p><br><pre> <code class="hljs mel">FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.613</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> ENV SRC_DIR=/tmp/src ENV CI_DIR=$SRC_DIR/ci ENV CI_PROJECT_DIR=$SRC_DIR COPY ./ $SRC_DIR RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ \ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/<span class="hljs-keyword"><span class="hljs-keyword">pwd</span></span>.txt \ &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME \ &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script \ &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly</code> </pre> <br><p>  Se realizan las siguientes acciones: </p><br><ul><li>  Tomamos la imagen de InterSystems IRIS como base.  Deber√≠a estar en su Registro Docker.  Si no ha trabajado con Docker antes, pruebe <a href="">First Look: Docker</a> , que describe c√≥mo obtener una imagen IRIS de InterSystems, agregarla al Registro de Docker e iniciarla manualmente. </li><li>  En primer lugar, copie nuestro repositorio (y el directorio "secreto") dentro del contenedor. </li><li>  Copie la clave de licencia y <code>GitLab.xml</code> en el directorio <code>mgr</code> . </li><li>  Cambie la contrase√±a al valor de <code>pwd.txt</code> .  Tenga en cuenta que <code>pwd.txt</code> se elimina durante esta operaci√≥n. </li><li>  Inicia InterSystems IRIS. </li><li>  El <code>load_ci.script</code> se <code>load_ci.script</code> . </li><li>  InterSystems IRIS se detiene. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Aqu√≠ hay un registro de compilaci√≥n parcial</b> <div class="spoiler_text"><pre> <code class="hljs perl">Running with gitlab-runner <span class="hljs-number"><span class="hljs-number">10.6</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> (a3543a27) on docker <span class="hljs-number"><span class="hljs-number">7</span></span>b21e0c4 Using Shell executor... Running on docker... Fetching changes... Removing ci/ Removing temp.txt HEAD is now at <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904 Build load_ci.script From http:<span class="hljs-regexp"><span class="hljs-regexp">//gitlab</span></span>.eduard.win/test/docker <span class="hljs-number"><span class="hljs-number">5</span></span>ef9904..<span class="hljs-number"><span class="hljs-number">9753</span></span>a8d master -&gt; origin/master Checking out <span class="hljs-number"><span class="hljs-number">9753</span></span>a8db as master... Skipping Git submodules setup $ cp -r /InterSystems/mount ci $ cd ci $ echo <span class="hljs-string"><span class="hljs-string">'SuperUser'</span></span> | cat - pwd.txt load_ci.script &gt; temp.txt $ mv temp.txt load_ci.script $ cd .. $ docker build --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR -t docker.eduard.win/test/docker:$CI_COMMIT_REF_NAME . Sending build context to Docker daemon <span class="hljs-number"><span class="hljs-number">401.4</span></span>kB Step <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : FROM docker.intersystems.com/intersystems/iris:<span class="hljs-number"><span class="hljs-number">2018.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.613</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> ---&gt; cd2e53e7f85<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV SRC_DIR=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/src</span></span> ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">68</span></span>ba1cb00aff Step <span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_DIR=$SRC_DIR/ci ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">6784</span></span>c34a9ee6 Step <span class="hljs-number"><span class="hljs-number">4</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : ENV CI_PROJECT_DIR=$SRC_DIR ---&gt; Using cache ---&gt; <span class="hljs-number"><span class="hljs-number">3757</span></span>fa88a28a Step <span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : COPY ./ $SRC_DIR ---&gt; <span class="hljs-number"><span class="hljs-number">5515</span></span>e13741b<span class="hljs-number"><span class="hljs-number">0</span></span> Step <span class="hljs-number"><span class="hljs-number">6</span></span>/<span class="hljs-number"><span class="hljs-number">6</span></span> : RUN cp $CI_DIR/iris.key $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; cp $CI_DIR/GitLab.xml $ISC_PACKAGE_INSTALLDIR/mgr/ &amp;&amp; $ISC_PACKAGE_INSTALLDIR/dev/Cloud/ICM/changePassword.sh $CI_DIR/pwd.txt &amp;&amp; iris start $ISC_PACKAGE_INSTANCENAME &amp;&amp; irissession $ISC_PACKAGE_INSTANCENAME -U%SYS &lt; $CI_DIR/load_ci.script &amp;&amp; iris stop $ISC_PACKAGE_INSTANCENAME quietly ---&gt; Running in <span class="hljs-number"><span class="hljs-number">86526183</span></span>cf7c . Waited <span class="hljs-number"><span class="hljs-number">1</span></span> seconds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> InterSystems IRIS to start This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement %SYS&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> %SYS&gt; Using <span class="hljs-string"><span class="hljs-string">'iris.cpf'</span></span> configuration file This copy of InterSystems IRIS has been licensed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> exclusively by: ISC Internal Container Sharding Copyright (c) <span class="hljs-number"><span class="hljs-number">1986</span></span>-<span class="hljs-number"><span class="hljs-number">2018</span></span> by InterSystems Corporation Any other <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> is a violation of your license agreement <span class="hljs-number"><span class="hljs-number">1</span></span> alert(<span class="hljs-keyword"><span class="hljs-keyword">s</span></span>) during startup. See messages.log <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Starting IRIS Node: <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6, Instance: IRIS Username: Password: Load started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> Loading file /usr/irissys/mgr/GitLab.xml as xml Load finished successfully. USER&gt; USER&gt; [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Running init hooks: before [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.017</span></span>] Importing hooks dir /tmp/src/MyApp/Hooks/ [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.374</span></span>] Executing hook class: MyApp.Hooks.Global [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.375</span></span>] Importing dir /tmp/src/ Loading file /tmp/src/MyApp/Tests/TestSuite.cls as udl Compilation started on <span class="hljs-number"><span class="hljs-number">04</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> with qualifiers <span class="hljs-string"><span class="hljs-string">'c'</span></span> Compilation finished successfully in <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">194</span></span>s. Load finished successfully. [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.876</span></span>] Running init hooks: after [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.878</span></span>] Executing hook class: MyApp.Hooks.Local [<span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">04</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">22.921</span></span>] Executing hook class: MyApp.Hooks.Global Removing intermediate container <span class="hljs-number"><span class="hljs-number">39702</span></span>b122ab6 ---&gt; dea6b2123165 [Warning] One <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more build-args [CI_PROJECT_DIR] were <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> consumed Successfully built dea6b2123165 Successfully tagged docker.domain.com/test/docker:master Job succeeded</code> </pre> </div></div><br><h2 id="zapusk-1">  Lanzamiento </h2><br><p>  Tenemos una imagen, ejec√∫tala.  En el caso de las ramas de caracter√≠sticas, simplemente puede destruir el contenedor antiguo y comenzar uno nuevo.  En el caso del entorno del producto, podemos iniciar el contenedor temporal primero y reemplazar el contenedor del medio si las pruebas pasan con √©xito. </p><br><p>  Primero, la secuencia de comandos para eliminar el contenedor anterior. </p><br><pre> <code class="hljs ruby">destroy <span class="hljs-symbol"><span class="hljs-symbol">old:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">stage:</span></span> destroy <span class="hljs-symbol"><span class="hljs-symbol">tags:</span></span> - test <span class="hljs-symbol"><span class="hljs-symbol">script:</span></span> - docker stop iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> - docker rm -f iris-$CI_COMMIT_REF_NAME <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Este script destruye el contenedor en ejecuci√≥n y siempre tiene √©xito (de manera predeterminada, Docker devuelve un error al intentar detener / eliminar un contenedor inexistente). </p><br><p>  Despu√©s de eso, lanzamos un nuevo contenedor y lo registramos como un entorno. </p><br><pre> <code class="hljs powershell">run image: stage: run environment: name: <span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> url: http://<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win/index.html tags: - test script: - docker run <span class="hljs-literal"><span class="hljs-literal">-d</span></span> -<span class="hljs-literal"><span class="hljs-literal">-expose</span></span> <span class="hljs-number"><span class="hljs-number">52773</span></span> -<span class="hljs-literal"><span class="hljs-literal">-volume</span></span> /InterSystems/durable/<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG:</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> -<span class="hljs-literal"><span class="hljs-literal">-env</span></span> ISC_DATA_DIRECTORY=/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/sys -<span class="hljs-literal"><span class="hljs-literal">-env</span></span> VIRTUAL_HOST=<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_SLUG</span></span>.docker.eduard.win -<span class="hljs-literal"><span class="hljs-literal">-name</span></span> iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> docker.eduard.win/test/docker:<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> -<span class="hljs-literal"><span class="hljs-literal">-log</span></span> <span class="hljs-variable"><span class="hljs-variable">$ISC_PACKAGE_INSTALLDIR</span></span>/mgr/messages.log</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El contenedor Nginx</a> redirige autom√°ticamente las solicitudes utilizando la <code>VIRTUAL_HOST</code> entorno <code>VIRTUAL_HOST</code> al puerto especificado, en este caso, 52773. </p><br><p>  Dado que es necesario almacenar algunos datos (contrase√±as,% SYS, datos de la aplicaci√≥n) en el host en InterSystems IRIS, existe una funcionalidad <a href="">Durable% SYS</a> que le permite almacenar datos en el host como: </p><br><ul><li>  <code>iris.cpf</code> es el archivo de configuraci√≥n principal. </li><li>  El <code>/csp</code> con archivos de aplicaciones web. </li><li>  <code>/httpd/httpd.conf</code> con configuraci√≥n privada del servidor Apache. </li><li>  El directorio <code>/mgr</code> en el que est√°n almacenados: <br><ul><li>  Bases de datos <code>IRISSYS</code> , <code>IRISTEMP</code> , <code>IRISAUDIT</code> , <code>IRIS</code> , <code>USER</code> . </li><li>  <code>IRIS.WIJ</code> . </li><li>  Directorio <code>/journal</code> almacenamiento de revistas. </li><li>  El directorio <code>/temp</code> para archivos temporales. </li><li>  Registra <code>messages.log</code> , <code>journal.log</code> , <code>SystemMonitor.log</code> . </li></ul></li></ul><br><p>  Para habilitar Durable% SYS, se especifica el argumento de <code>volume</code> que <code>ISC_DATA_DIRECTORY</code> directorio <code>ISC_DATA_DIRECTORY</code> host y la variable <code>ISC_DATA_DIRECTORY</code> establece el directorio para almacenar archivos Durable% SYS.  Este directorio no deber√≠a existir, se crear√° autom√°ticamente. </p><br><p>  Por lo tanto, la arquitectura de nuestra aplicaci√≥n en contenedores es la siguiente: </p><br><p><img src="https://habrastorage.org/webt/61/0q/ze/610qzezlqdilphfkapj5vac9t84.png" alt="arquitectura de aplicaciones en contenedores"></p><br><p>  Para construir una aplicaci√≥n de este tipo, debemos crear al menos una base de datos adicional (para guardar el c√≥digo de la aplicaci√≥n) y crear su asignaci√≥n en el √°rea de la aplicaci√≥n.  Utilic√© el alcance <code>USER</code> para almacenar datos de la aplicaci√≥n, ya que este alcance se agreg√≥ a Durable% SYS de forma predeterminada.  El c√≥digo de la aplicaci√≥n se almacena en un contenedor para que pueda actualizarse. </p><br><p>  Seg√∫n lo anterior, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">% Installer</a> deber√≠a: </p><br><ul><li>  Crear √°rea de aplicaci√≥n / base de datos </li><li>  Subir c√≥digo al √°rea de la aplicaci√≥n </li><li>  Cree clases de mapeo de nuestra aplicaci√≥n en el √°rea de <code>USER</code> </li><li>  Realizar otra configuraci√≥n (cre√© una aplicaci√≥n web CSP y una aplicaci√≥n web REST) </li></ul><br><div class="spoiler">  <b class="spoiler_title">C√≥digo% instalador</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> { Parameter Namespace = "APP"; /// See <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zsetup+<span class="hljs-number"><span class="hljs-number">1</span></span>^MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Local</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> XData Install [ XMLNamespace = INSTALLER ] { &lt;Manifest&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" Code="${Namespace}" Ensemble="" Data="IRISTEMP"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>="${Namespace}" Dir="/usr/irissys/mgr/${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="yes" MountRequired="true" Resource="%DB_${Namespace}" PublicPermissions="RW" MountAtStartup="true"/&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Import</span></span> File="${Dir}Form" Recurse="1" Flags="cdk" IgnoreErrors="1" /&gt; &lt;/Namespace&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="End Creating namespace ${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping to USER" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;Namespace <span class="hljs-type"><span class="hljs-type">Name</span></span>="USER" <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>="no" Code="USER" Data="USER" Ensemble="0"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-type"><span class="hljs-type">Text</span></span>="Mapping Form package to USER namespace" <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span>="0"/&gt; &lt;ClassMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" Package="Form"/&gt; &lt;RoutineMapping <span class="hljs-keyword"><span class="hljs-keyword">From</span></span>="${Namespace}" <span class="hljs-keyword"><span class="hljs-keyword">Routines</span></span>="Form" /&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>&gt; &lt;CSPApplication Url="/" Directory="${Dir}client" AuthenticationMethods="64" IsNamespaceDefault="false" <span class="hljs-keyword"><span class="hljs-keyword">Grant</span></span>="%ALL" Recurse="1" /&gt; &lt;/Namespace&gt; &lt;/Manifest&gt; } /// This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> generator whose code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> XGL. /// Main setup <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace")="TEMP3" /// <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(MyApp.Hooks.<span class="hljs-keyword"><span class="hljs-keyword">Global</span></span>).setup(.vars) ClassMethod setup(ByRef pVars, pLogLevel <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-type"><span class="hljs-type">Integer</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>, pInstaller <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Installer.Installer) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status [ CodeMode = objectgenerator, <span class="hljs-type"><span class="hljs-type">Internal</span></span> ] { Quit ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(%Installer.Manifest).%Generate(%compiledclass, %code, "Install") } /// Entry <span class="hljs-type"><span class="hljs-type">point</span></span> ClassMethod onAfter() <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { try { <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> "START INSTALLER",! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Namespace") = ..#Namespace <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vars("Dir") = ..getDir() <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..setup(.vars) <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ..createWebApp() } catch ex { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc = ex.AsStatus() <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> !,$<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Status.GetErrorText(sc),! } quit sc } /// Modify web app REST ClassMethod createWebApp(appName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String = "/forms") <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>:$e(appName)<span class="hljs-string"><span class="hljs-string">'="/" appName = "/" _ appName #dim sc As %Status = $$$OK new $namespace set $namespace = "%SYS" if '</span></span>##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Applications).<span class="hljs-keyword"><span class="hljs-keyword">Exists</span></span>(appName) { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("AutheEnabled") = $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AutheUnauthenticated</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"NameSpace"</span></span></span><span class="bash">) = </span><span class="hljs-string"><span class="bash"><span class="hljs-string">"USER"</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> props(</span><span class="hljs-string"><span class="bash"><span class="hljs-string">"IsNameSpaceDefault"</span></span></span><span class="bash">) = $$</span></span>$<span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("DispatchClass") = "Form.REST.Main" <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> props("MatchRoles")=":" _ $$<span class="bash"><span class="hljs-variable"><span class="bash"><span class="hljs-variable">$AllRoleName</span></span></span><span class="bash"> </span><span class="hljs-built_in"><span class="bash"><span class="hljs-built_in">set</span></span></span><span class="bash"> sc = </span><span class="hljs-comment"><span class="bash"><span class="hljs-comment">##class(Security.Applications).Create(appName, .props) } quit sc } ClassMethod getDir() [ CodeMode = expression ] { ##class(%File).NormalizeDirectory($system.Util.GetEnviron("CI_PROJECT_DIR")) } }</span></span></span></span></code> </pre> </div></div><br><p>  Observo que para crear una base de datos que no est√° en el host, uso el directorio <code>/usr/irissys/mgr</code> , ya que la llamada <code>##class(%File).ManagerDirectory()</code> devuelve la ruta al directorio para Durable% SYS. </p><br><h2 id="testy">  Pruebas </h2><br><p>  Ahora ejecuta las pruebas. </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">test</span></span> image: stage: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> tags: - <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> script: - docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> iris-<span class="hljs-variable"><span class="hljs-variable">$CI_COMMIT_REF_NAME</span></span> irissession iris -U USER <span class="hljs-string"><span class="hljs-string">"##class(isc.git.GitLab).test()"</span></span></code> </pre> <br><h2 id="dostavka-2">  La entrega </h2><br><p>  Se pasan las pruebas, publicaremos nuestra imagen en el Registro Docker. </p><br><pre> <code class="hljs pgsql">publish image: stage: publish tags: - test script: - docker <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com -u <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> -p pass - docker push docker.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com/test/docker:$CI_COMMIT_REF_NAME</code> </pre> <br><p>  El inicio de sesi√≥n / contrase√±a se puede pasar usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">variables secretas</a> . </p><br><p>  Ahora la imagen se muestra en GitLab. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/064/0b3/56f/0640b356f33ea72491c91d55399a4670.png"></p><br><p>  Y otros desarrolladores pueden descargarlo del Registro Docker.  En la pesta√±a Entornos, todos nuestros entornos est√°n disponibles para ver: </p><br><h1 id="vyvody">  Conclusiones </h1><br><p>  Esta serie de art√≠culos discute enfoques comunes para la integraci√≥n continua.  La automatizaci√≥n del ensamblaje, las pruebas y la entrega de su aplicaci√≥n en las plataformas InterSystems es posible y f√°cil de implementar. </p><br><p>  El uso de tecnolog√≠as de contenedorizaci√≥n ayudar√° a optimizar el desarrollo de aplicaciones y los procesos de implementaci√≥n.  La eliminaci√≥n de inconsistencias entre entornos facilita las pruebas y la depuraci√≥n.  La orquestaci√≥n le permite crear aplicaciones escalables. </p><br><h1 id="ssylki">  Referencias </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo anterior</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Serie de la comunidad de InterSystems</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥digo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√≥digo Github</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420749/">https://habr.com/ru/post/es420749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420731/index.html">Zabbix con esteroides: c√≥mo funciona la plataforma de monitoreo unificado de Sbertech</a></li>
<li><a href="../es420735/index.html">Te invitamos a la final del marat√≥n Find Yourself in Digital en la oficina de Mail.Ru Group</a></li>
<li><a href="../es420737/index.html">Mini ai cup 2 o casi AgarIO: ¬øqu√© se puede hacer para ganar?</a></li>
<li><a href="../es420739/index.html">La caja todav√≠a est√° en el mango: por qu√© en 2018 todav√≠a necesitas aprender idiomas t√∫ mismo</a></li>
<li><a href="../es420741/index.html">Hoja de trucos para programadores o "buscaremos en Google"</a></li>
<li><a href="../es420753/index.html">Frontend de microservicios: un enfoque moderno para la separaci√≥n del frente</a></li>
<li><a href="../es420757/index.html">Concurso de programaci√≥n: Comercio (Resultados)</a></li>
<li><a href="../es420761/index.html">TypeScript 3.0</a></li>
<li><a href="../es420763/index.html">KDD 2018, d√≠a dos, talleres</a></li>
<li><a href="../es420765/index.html">Impresiones de Gemini PDA. ¬øCosechadora de doble arranque de bolsillo o juguete in√∫til?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>