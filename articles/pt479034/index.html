<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòè ‚úäüèæ üë¶üèæ Como conectar-se a uma VPN corporativa no Linux usando openconnect e vpn-slice üßìüèº üõÅ üë©üèæ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Deseja usar o Linux no trabalho, mas uma VPN corporativa n√£o? Este artigo pode ajudar, embora isso n√£o seja preciso. Quero avisar com anteced√™ncia que...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como conectar-se a uma VPN corporativa no Linux usando openconnect e vpn-slice</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479034/"><p>  Deseja usar o Linux no trabalho, mas uma VPN corporativa n√£o?  Este artigo pode ajudar, embora isso n√£o seja preciso.  Quero avisar com anteced√™ncia que entendo mal os problemas de administra√ß√£o de rede, para que seja poss√≠vel que eu tenha feito tudo errado.  Por outro lado, √© poss√≠vel que eu possa escrever o manual de tal maneira que seja compreens√≠vel para as pessoas comuns, por isso aconselho voc√™ a tentar. </p><br><p>  O artigo tem muitas informa√ß√µes extras, mas sem esse conhecimento, eu n√£o seria capaz de resolver os problemas que de repente tive com a configura√ß√£o de vpn.  Acho que qualquer pessoa que tentar aplicar este manual ter√° problemas que eu n√£o tive e espero que essas informa√ß√µes extras ajudem a resolver esses problemas por conta pr√≥pria. </p><br><p>  A maioria dos comandos usados ‚Äã‚Äãno manual precisa ser executada no sudo, que √© removido por quest√µes de brevidade.  Tenha em mente. </p><br><p>  A maioria dos endere√ßos IP foi ofuscada severamente; portanto, se voc√™ vir um endere√ßo como 435.435.435.435, deve haver algum IP normal espec√≠fico para o seu caso. </p><br><p>  Eu tenho o Ubuntu 18.04, mas acho que com algumas altera√ß√µes o guia pode ser aplicado a outras distribui√ß√µes.  No entanto, neste texto, Linux == Ubuntu. </p><br><h2>  Cisco connect </h2><br><p>  Aqueles que est√£o sentados no Windows ou MacOS podem se conectar √† VPN corporativa atrav√©s do Cisco Connect, que precisa especificar o endere√ßo do gateway e inserir uma senha sempre que conectada, consistindo em uma parte fixa e um c√≥digo gerado pelo Google Authenticator. </p><a name="habracut"></a><br><p>  No caso do Linux, n√£o foi poss√≠vel obter o Cisco Connect, mas a recomenda√ß√£o do Google foi usar o openconnect, feito especificamente para substituir o Cisco Connect. </p><br><h2>  Openconnect </h2><br><p>  Em teoria, no ubunt, existe uma interface gr√°fica especial para o openconnect, mas n√£o funcionou para mim.  Talvez seja o melhor. </p><br><p>  No ubunt, o openconnect √© instalado a partir do gerenciador de pacotes. </p><br><pre><code class="plaintext hljs">apt install openconnect</code> </pre> <br><p>  Imediatamente ap√≥s a instala√ß√£o, voc√™ pode tentar se conectar √† VPN </p><br><pre> <code class="plaintext hljs">openconnect --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  vpn.evilcorp.com √© o endere√ßo VPN fict√≠cio \ <br>  poxvuibr - nome de usu√°rio fict√≠cio </p><br><p>  O openconnect solicitar√° que voc√™ digite uma senha, que, lembro-me, consiste em uma parte e c√≥digo fixos do Google Authenticator e tente conectar-se ao vpn.  Se acabou, parab√©ns, voc√™ pode pular com seguran√ßa o meio, o que √© muito doloroso e ir direto ao ponto sobre a conex√£o aberta em segundo plano.  Se n√£o funcionar, voc√™ pode continuar.  Embora, se ele acabou sendo conectado, por exemplo, a partir de um Wi-Fi convidado no trabalho, √© poss√≠vel se alegrar e cedo, tente repetir o procedimento em casa. </p><br><h2>  Certificado </h2><br><p>  Com alta probabilidade, nada ser√° iniciado e o escape do openconnect ser√° mais ou menos assim: </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Certificate from VPN server "vpn.evilcorp.com" failed verification. Reason: signer not found To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Por um lado, isso √© desagrad√°vel, porque n√£o havia conex√£o com a VPN, mas por outro lado, como corrigir esse problema √©, em princ√≠pio, compreens√≠vel. </p><br><p>  Em seguida, o servidor nos enviou um certificado, segundo o qual pode ser determinado que a conex√£o √© feita com o servidor da empresa nativa, e n√£o com o fraudador malicioso, e esse certificado √© desconhecido para o sistema.  E, portanto, ela n√£o pode verificar se o servidor real √© ou n√£o.  E assim, apenas no caso, ele p√°ra de funcionar. </p><br><p>  Para que o openconnect ainda se conecte ao servidor, voc√™ precisa informar explicitamente qual certificado deve vir do servidor VPN usando a chave --servercert </p><br><p>  E voc√™ pode descobrir qual certificado o servidor nos enviou diretamente a partir do que o openconnect imprimiu.  Aqui a partir desta pe√ßa: </p><br><pre> <code class="plaintext hljs">To trust this server in future, perhaps add this to your command line: --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 Enter 'yes' to accept, 'no' to abort; anything else to view: fgets (stdin): Operation now in progress</code> </pre> <br><p>  Com este comando, voc√™ pode tentar se conectar novamente </p><br><pre> <code class="plaintext hljs">openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com</code> </pre> <br><p>  Talvez esteja funcionando agora, ent√£o voc√™ pode ir at√© o fim.  Mas Ubunta pessoalmente me mostrou um figo nesta forma </p><br><pre> <code class="plaintext hljs">POST https://vpn.evilcorp.com/ Connected to 777.777.777.777:443 SSL negotiation with vpn.evilcorp.com Server certificate verify failed: signer not found Connected to HTTPS on vpn.evilcorp.com XML POST enabled Please enter your username and password. POST https://vpn.evilcorp.com/ Got CONNECT response: HTTP/1.1 200 OK CSTP connected. DPD 300, Keepalive 30 Set up DTLS failed; using SSL instead Connected as 192.168.333.222, using SSL NOSSSSSHHHHHHHDDDDD 3 NOSSSSSHHHHHHHDDDDD 3 RTNETLINK answers: File exists /etc/resolvconf/update.d/libc: Warning: /etc/resolv.conf is not a symbolic link to /run/resolvconf/resolv.conf</code> </pre> <br><p>  /etc/resolv.conf </p><br><pre> <code class="plaintext hljs"># Generated by NetworkManager search gst.evilcorpguest.com nameserver 127.0.0.53</code> </pre> <br><p>  /run/resolvconf/resolv.conf </p><br><pre> <code class="plaintext hljs"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8) # DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN # 127.0.0.53 is the systemd-resolved stub resolver. # run "systemd-resolve --status" to see details about the actual nameservers. nameserver 192.168.430.534 nameserver 127.0.0.53 search evilcorp.com gst.publicevilcorp.com</code> </pre> <br><p>  O habr.com ser√° resolvido, mas n√£o ser√° poss√≠vel entrar l√°.  Endere√ßos como jira.evilcorp.com n√£o s√£o resolvidos. </p><br><p>  O que aconteceu aqui n√£o est√° claro para mim.  Mas o experimento mostra que se voc√™ adicionar a linha ao /etc/resolv.conf </p><br><pre> <code class="plaintext hljs">nameserver 192.168.430.534</code> </pre> <br><p>  os endere√ßos dentro da VPN ser√£o resolvidos magicamente e ser√° poss√≠vel analis√°-los, ou seja, o que o DNS procura para resolver endere√ßos √© visualizado no /etc/resolv.conf e n√£o em outro lugar. </p><br><p>  Se existe uma conex√£o com a VPN e ela funciona, voc√™ pode ter certeza de que, sem altera√ß√µes no /etc/resolv.conf, basta digitar o nome simb√≥lico do recurso de vpn no navegador e seu endere√ßo IP </p><br><p>  O resultado s√£o dois problemas </p><br><ul><li>  na conex√£o com a VPN, o DNS n√£o √© captado </li><li>  todo o tr√°fego passa pela VPN, o que n√£o permite que voc√™ acesse a Internet </li></ul><br><p>  O que vou fazer agora, vou lhe contar, mas primeiro um pouco de automa√ß√£o. </p><br><h2>  Entrada autom√°tica da parte fixa da senha </h2><br><p>  No momento atual, voc√™ provavelmente j√° digitou a senha pelo menos cinco vezes e esse procedimento j√° o cansou bastante.  Em primeiro lugar, porque a senha √© longa e, em segundo lugar, porque, ao entrar, voc√™ precisa se manter dentro de um per√≠odo fixo </p><br><p>  A solu√ß√£o final para o problema n√£o foi inclu√≠da no artigo, mas pode ser feita para que a parte fixa da senha n√£o precise ser inserida v√°rias vezes. </p><br><p>  Suponha que a parte fixa da senha seja FixedPassword e parte do Google Authenticator 567 987. A senha inteira do openconnect pode ser passada atrav√©s da entrada padr√£o usando o argumento --passwd-on-stdin. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr vpn.evilcorp.com --passwd-on-stdin</code> </pre> <br><p>  Agora voc√™ pode retornar constantemente ao √∫ltimo comando inserido e alterar apenas parte do Google Authenticator l√°. </p><br><h2>  A VPN corporativa n√£o permite acesso √† Internet. </h2><br><p>  Em geral, n√£o √© muito inconveniente quando, para acessar um hub, voc√™ precisa usar um computador separado.  A falta da capacidade de copiar e colar com o stackoverfow geralmente paralisa o trabalho, portanto, algo precisa ser feito. </p><br><p>  √â necess√°rio organizar de alguma forma, para que, quando voc√™ precise acessar o recurso da rede interna, o Linux v√° para vpn e, quando voc√™ precise acessar o hub, v√° para a Internet. </p><br><p>  O openconnect ap√≥s iniciar e estabelecer uma conex√£o com o vpn, executa um script especial, localizado em / usr / share / vpnc-scripts / vpnc-script.  Algumas vari√°veis ‚Äã‚Äãs√£o transferidas para o script de entrada e fazem a configura√ß√£o de vpn.  Infelizmente, n√£o consegui descobrir como dividir os fluxos de tr√°fego entre a VPN corporativa e o restante da Internet usando um script nativo. </p><br><p>  Aparentemente, especialmente para pessoas como eu, foi desenvolvido o utilit√°rio vpn-slice, que permite direcionar o tr√°fego por dois canais sem dan√ßar com um pandeiro.  Bem, voc√™ tem que dan√ßar, mas um xam√£ n√£o √© necess√°rio. </p><br><h2>  Dividir o tr√°fego com vpn-slice </h2><br><p>  Primeiramente, o vpn-slice ter√° que ser instalado, voc√™ ter√° que descobrir por si mesmo.  Se houver perguntas nos coment√°rios, escreverei um post separado sobre isso.  Mas este √© um programa python regular, portanto n√£o deve haver dificuldades.  Eu configurei usando virtualenv. </p><br><p>  E ent√£o voc√™ precisa usar o utilit√°rio, usando a tecla --script indicando openconnect que, em vez do script padr√£o, voc√™ precisa usar vpn-slice </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 " vpn.evilcorp.com</code> </pre> <br><p>  Em --script, uma linha √© passada com o comando que precisa ser chamado em vez do script.  ./bin/vpn-slice - caminho para o arquivo execut√°vel vpn-slice 192.168.430.0/24 - m√°scara de endere√ßos a serem visitados na vpn.  Aqui, quero dizer que, se o endere√ßo come√ßar com 192.168.430, o recurso com esse endere√ßo dever√° ser pesquisado dentro de vpn </p><br><p>  Agora a situa√ß√£o deve estar quase normal.  Quase.  Agora voc√™ pode efetuar login no hub e efetuar logon no recurso corporativo interno por ip, mas n√£o pode fazer login no recurso corporativo interno por nome simb√≥lico.  Se voc√™ registrar a correspond√™ncia do nome e endere√ßo simb√≥licos nos hosts, tudo dever√° funcionar.  E trabalhe at√© que o ip mude.  O Linux agora pode acessar a Internet ou a rede corporativa, dependendo do ip.  Mas o DNS n√£o corporativo ainda √© usado para determinar o endere√ßo. </p><br><p>  O problema ainda pode se manifestar desta forma - est√° tudo bem no trabalho e em casa voc√™ pode acessar recursos corporativos internos apenas por IP.  Isso ocorre porque quando voc√™ est√° conectado ao Wi-Fi corporativo, o DNS corporativo tamb√©m √© usado, e nele os endere√ßos simb√≥licos da VPN s√£o resolvidos, embora ainda seja imposs√≠vel acessar um endere√ßo desse tipo sem usar uma VPN. </p><br><h2>  Modifica√ß√£o autom√°tica do arquivo hosts </h2><br><p>  Se voc√™ educadamente pedir ao vpn-slice, depois de aumentar a VPN, ele poder√° acessar o DNS, encontrar os endere√ßos IP dos recursos necess√°rios por seus nomes simb√≥licos e inseri-los nos hosts.  Depois que a VPN √© desativada, esses endere√ßos ser√£o removidos dos hosts.  Para fazer isso, passe nomes simb√≥licos para vpn-slice como argumentos.  L√° vai voc√™. </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Agora tudo deve funcionar tanto no escrit√≥rio quanto na praia. </p><br><h2>  Procure endere√ßos de todos os subdom√≠nios no DNS que a VPN forneceu </h2><br><p>  Se houver poucos endere√ßos na rede, a abordagem para modificar automaticamente o arquivo hosts estar√° funcionando.  Mas se houver muitos recursos na rede, voc√™ precisar√° constantemente adicionar linhas como zoidberg.test.evilcorp.com ao script zoidberg, este √© o nome de uma das bancas de teste. </p><br><p>  Mas agora que temos um pouco de entendimento de por que essa necessidade pode ser eliminada. </p><br><p>  Se, depois de aumentar a VPN, procure em / etc / hosts, voc√™ pode ver, aqui est√° uma linha </p><br><blockquote>  192.168.430.534 dns0.tun0 # vpn-slice-tun0 AUTOCREATED </blockquote><p>  Sim, e uma nova linha foi adicionada ao resolv.conf.  Em resumo, o vpn-slice determinou de alguma forma onde o servidor DNS para vpn est√° localizado. </p><br><p>  Agora precisamos ter certeza de que, para descobrir o endere√ßo IP do nome de dom√≠nio que termina em evilcorp.com, o Linux foi para o DNS corporativo e, se algo mais for necess√°rio, o padr√£o ser√° o padr√£o. </p><br><p>  Pesquisei no Google por um longo tempo e descobri que essa funcionalidade est√° pronta para uso imediato.  Isso se refere √† capacidade de usar o servidor dns dnsmasq local dnsmasq para resolver nomes. </p><br><p>  Ou seja, voc√™ pode fazer com que o Linux sempre v√° para o servidor DNS local para obter endere√ßos IP, que, por sua vez, dependendo do nome do dom√≠nio, procurar√£o IP no servidor DNS externo correspondente. </p><br><p>  Para gerenciar tudo relacionado a redes e conex√µes de rede, o Ubunt usa o NetworkManager, e a interface gr√°fica para selecionar, por exemplo, uma conex√£o Wi-Fi √© apenas a frente para ela. </p><br><p>  Precisamos escalar em sua configura√ß√£o. </p><br><ol><li>  Crie um arquivo no /etc/NetworkManager/dnsmasq.d/evilcorp </li></ol><br><blockquote>  endere√ßo = /. evilcorp.com/192.168.430.534 </blockquote><p>  Preste aten√ß√£o ao ponto antes de evilcorp.  Ele sinaliza ao dnsmasq que todos os subdom√≠nios evilcorp.com devem ser pesquisados ‚Äã‚Äãno dns corporativo. </p><br><ol><li>  Diga ao NetworkManager para usar o dnsmasq para resolver nomes </li></ol><br><p>  A configura√ß√£o do gerenciador de rede est√° localizada em /etc/NetworkManager/NetworkManager.conf. Voc√™ precisa adicionar l√°: </p><br><blockquote>  [principal] <br>  dns = dnsmasq </blockquote><br><ol><li>  Reinicie o NetworkManager </li></ol><br><pre> <code class="plaintext hljs">service network-manager restart</code> </pre> <br><p>  Agora, depois de conectar-se a uma VPN usando um monte de openconnect e vpn-slice, o ip ser√° detectado normalmente, mesmo se voc√™ n√£o adicionar endere√ßos simb√≥licos aos argumentos do vpnslice. </p><br><h2>  Como passar pela VPN para separar servi√ßos </h2><br><p>  Ap√≥s a conex√£o com a VPN, fiquei muito feliz por dois dias e, em seguida, verificou-se que, se voc√™ se conectar √† VPN e n√£o a partir da rede do escrit√≥rio, o correio n√£o funcionar√°.  Um sintoma familiar, n√£o √©? </p><br><p>  Nosso email est√° em mail.publicevilcorp.com, o que significa que ele n√£o se enquadra na regra do dnsmasq e o endere√ßo do servidor de email √© pesquisado atrav√©s do DNS p√∫blico. </p><br><p>  Bem, o escrit√≥rio ainda usa o DNS no qual esse endere√ßo est√°.  Ou seja, eu pensei que sim.  De fato, depois de adicionar uma linha ao dnsmasq </p><br><blockquote>  endere√ßo = / mail.publicevilcorp.com / 192.168.430.534 </blockquote><p>  a situa√ß√£o n√£o mudou.  ip permaneceu o mesmo.  Eu tive que ir trabalhar. </p><br><p>  E s√≥ ent√£o, quando mergulhei na situa√ß√£o e resolvi um pouco o problema, uma pessoa inteligente me disse como resolv√™-lo.  Era necess√°rio conectar-se ao servidor de correio n√£o apenas assim, mas atrav√©s do vpn </p><br><p>  Eu uso o vpn-slice para passar pela VPN para endere√ßos que come√ßam com 192.168.430.  E no servidor de correio, n√£o apenas o endere√ßo simb√≥lico n√£o √© um subdom√≠nio da evilcorp, mas tamb√©m possui um endere√ßo IP que n√£o inicia com 192.168.430.  E √© claro que ele n√£o deixa ningu√©m sair da rede em geral. </p><br><p>  Para que o Linux passe pela VPN e pelo servidor de email, voc√™ precisa adicion√°-lo ao vpn-slice.  Suponha que o endere√ßo do remetente seja 555.555.555.555 </p><br><pre> <code class="plaintext hljs">echo "fixedPassword567987" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin --script "./bin/vpn-slice 555.555.555.555 192.168.430.0/24" vpn.evilcorp.com</code> </pre> <br><h2>  Script para aumentar uma VPN com um argumento </h2><br><p>  Tudo isso, √© claro, n√£o √© muito conveniente.  Sim, voc√™ pode salvar o texto em um arquivo e copi√°-lo e col√°-lo no console, em vez de digitar com as m√£os, mas ainda n√£o √© agrad√°vel o suficiente.  Para facilitar o processo, voc√™ pode agrupar o comando em um script que estar√° localizado no PATH.  E ent√£o voc√™ s√≥ precisa digitar o c√≥digo obtido no Google Authenticator </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 --user poxvuibr --passwd-on-stdin \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Se voc√™ colocar o script em connect ~ evilcorp ~, basta escrever no console </p><br><pre> <code class="plaintext hljs">connect_evil_corp 567987</code> </pre> <br><p>  Mas agora, de qualquer forma, por algum motivo, voc√™ precisa manter o console em que o openconnect est√° sendo aberto </p><br><h2>  Lan√ßamento do Openconnect em segundo plano </h2><br><p>  Felizmente, os autores do openconnect cuidaram de n√≥s e adicionaram uma chave especial - background ao programa, que faz com que o programa funcione em segundo plano ap√≥s o lan√ßamento.  Se voc√™ execut√°-lo assim, ap√≥s o lan√ßamento, voc√™ pode fechar o console </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com</code> </pre> <br><p>  Agora n√£o est√° claro para onde os logs v√£o.  Geralmente, os logs n√£o s√£o realmente necess√°rios para n√≥s, mas voc√™ nunca sabe.  O openconnect pode redirecion√°-los para o syslog, onde eles ser√£o mantidos intactos.  voc√™ precisa adicionar a chave --syslog ao comando </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \</code> </pre> <br><p>  E assim, verifica-se que o openconnect est√° funcionando em algum lugar em segundo plano e n√£o incomoda ningu√©m, mas como parar isso n√£o est√° claro.  Ou seja, voc√™ pode, √© claro, filtrar o escape do ps com um grep e procurar um processo em nome do qual √© openconnect, mas √© de alguma forma sombrio.  Obrigado aos autores que pensaram sobre isso.  O Openconnect possui a chave --pid-file, com a qual voc√™ pode instruir o openconnect para gravar seu ID do processo em um arquivo. </p><br><pre> <code class="plaintext hljs">#!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Agora voc√™ sempre pode definir o processo com o comando </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid)</code> </pre> <br><p>  Se n√£o houver processo, o kill jura, mas n√£o gera um erro.  Se n√£o houver arquivo, nada de ruim tamb√©m acontecer√°, para que voc√™ possa matar o processo com seguran√ßa na primeira linha do script. </p><br><pre> <code class="plaintext hljs">kill $(cat ~/vpn-pid) #!/bin/sh echo "fixedPassword$1" | openconnect --servercert sha256:4444444444444444444444444444444444444444444444444444444444444444 \ --user poxvuibr \ --passwd-on-stdin \ --background \ --syslog \ --script "./bin/vpn-slice 192.168.430.0/24 jira.vpn.evilcorp.com git.vpn.evilcorp.com " vpn.evilcorp.com \ --pid-file ~/vpn-pid</code> </pre> <br><p>  Agora voc√™ pode ligar o computador, abrir o console e executar o comando, passando o c√≥digo do Google Authenticator.  O console pode ser pregado. </p><br><h1>  Sem vpn-slice.  Em vez de um posf√°cio </h1><br><p>  Era muito dif√≠cil entender como viver sem o vpn-slice.  Eu tive que ler muito e google.  Felizmente, quando passei tanto tempo com o problema, os manuais t√©cnicos e at√© o homem openconnect pareciam romances emocionantes. </p><br><p>  Como resultado, descobri que o vpn-slice, como o script nativo, modifica a tabela de roteamento para separar redes. </p><br><h2>  Tabela de roteamento </h2><br><p>  Em termos simples, essa tabela na primeira coluna cont√©m onde o endere√ßo para onde o Linux deseja ir deve come√ßar e na segunda atrav√©s do adaptador de rede para esse endere√ßo.  De fato, existem mais colunas, mas isso n√£o muda a ess√™ncia. </p><br><p>  Para ver a tabela de roteamento, voc√™ precisa executar o comando ip route </p><br><pre> <code class="plaintext hljs">default via 192.168.1.1 dev wlp3s0 proto dhcp metric 600 192.168.430.0/24 dev tun0 scope link 192.168.1.0/24 dev wlp3s0 proto kernel scope link src 192.168.1.534 metric 600 192.168.430.534 dev tun0 scope link</code> </pre> <br><p>  Aqui, cada linha √© respons√°vel por onde ir para enviar uma mensagem para algum endere√ßo.  A primeira √© uma descri√ß√£o de onde o endere√ßo deve come√ßar.  Para entender como determinar que 192.168.0.0/16 significa que o endere√ßo deve come√ßar com 192.168, √© necess√°rio pesquisar no Google qual √© a m√°scara do endere√ßo IP.  After dev √© o nome do adaptador para o qual a mensagem deve ser enviada. </p><br><p>  Para VPN, o Linux criou um adaptador virtual - tun0.  Para que o tr√°fego de todos os endere√ßos come√ßando com 192.168 passe por ele, a linha responde </p><br><pre> <code class="plaintext hljs">192.168.0.0/16 dev tun0 scope link</code> </pre> <br><p>  Voc√™ tamb√©m pode observar o estado atual da tabela de roteamento usando o comando <strong>route -n</strong> (os endere√ßos IP s√£o talentos anonimamente) Este comando produz resultados de uma forma diferente e geralmente √© preterido, mas seu escape geralmente se depara com manuais on-line e voc√™ precisa l√™-lo. </p><br><p>  Onde o endere√ßo IP da rota deve come√ßar pode ser entendido a partir da combina√ß√£o das colunas Destination e Genmask.  As partes do endere√ßo IP √†s quais os n√∫meros 255 correspondem no Genmask s√£o levadas em considera√ß√£o e aquelas onde 0 n√£o √©.  Ou seja, a combina√ß√£o de Destino 192.168.0.0 e Genmask 255.255.255.0 significa que, se o endere√ßo come√ßar com 192.168.0, uma solicita√ß√£o para ele seguir√° essa rota.  E se Destination for 192.168.0.0 mas Genmask for 255.255.0.0, as solicita√ß√µes para endere√ßos que come√ßam com 192.168 seguir√£o essa rota </p><br><p>  Para descobrir o que o vpn-slice realmente faz, decidi examinar o estado das tabelas antes e depois </p><br><h2>  Antes de ligar a VPN, era assim </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0</code> </pre> <br><h2>  Depois de chamar openconnect sem vpn-slice, ficou t√£o </h2><br><pre> <code class="plaintext hljs">route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><h2>  E depois de chamar openconnect em combina√ß√£o com vpn-slice assim </h2><br><pre> <code class="plaintext hljs">Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0 222.222.222.0 0.0.0.0 255.255.255.0 U 600 0 0 wlp3s0 333.333.333.333 222.222.222.1 255.255.255.255 UGH 0 0 0 wlp3s0 192.168.430.0 0.0.0.0 255.255.255.0 U 0 0 0 tun0 192.168.430.534 0.0.0.0 255.255.255.255 UH 0 0 0 tun0</code> </pre> <br><p>  Pode-se observar que, se voc√™ n√£o usar vpn-slice, o openconnect gravar√° explicitamente que voc√™ deve passar pelo vpn em todos os endere√ßos, exceto se indicado separadamente. </p><br><p>  Aqui: </p><br><pre> <code class="plaintext hljs">0.0.0.0 0.0.0.0 0.0.0.0 U 0 0 0 tun0</code> </pre> <br><p>  Nas proximidades, indicava imediatamente outro caminho que deveria ser usado se o endere√ßo que o Linux est√° tentando percorrer n√£o corresponder a nenhuma m√°scara da tabela. </p><br><pre> <code class="plaintext hljs">0.0.0.0 222.222.222.1 0.0.0.0 UG 600 0 0 wlp3s0</code> </pre> <br><p>  J√° foi escrito aqui que, nesse caso, voc√™ precisa passar pelo adaptador Wi-Fi padr√£o. </p><br><p>  Eu acredito que o caminho para a VPN √© usado porque √© o primeiro na tabela de roteamento. </p><br><p>  E, teoricamente, se voc√™ remover esse caminho padr√£o da tabela de roteamento, em conjunto com o dnsmasq openconnect dever√° garantir a opera√ß√£o normal. </p><br><p>  Eu tentei </p><br><pre> <code class="plaintext hljs">route del default</code> </pre> <br><p>  E funcionou. </p><br><h2>  Encaminhando solicita√ß√µes para um servidor de correio sem vpn-slice </h2><br><p>  Mas tamb√©m tenho um servidor de email com o endere√ßo 555.555.555.555, que voc√™ tamb√©m precisa passar por vpn.  A rota para ele tamb√©m deve ser adicionada √† m√£o. </p><br><pre> <code class="plaintext hljs">ip route add 555.555.555.555 via dev tun0</code> </pre> <br><p>  E agora todas as regras.  Ent√£o voc√™ pode fazer sem vpn-slice, mas voc√™ j√° precisa saber bem o que est√° fazendo.  Agora, estou pensando em adicionar a remo√ß√£o da rota padr√£o e adicionar a rota para a mala direta depois de conectar-se ao vpn na √∫ltima linha do script nativo do openconnect, apenas para diminuir o n√∫mero de partes m√≥veis na minha bicicleta. </p><br><p>  Provavelmente, algu√©m para entender como configurar uma VPN teria o suficiente desse posf√°cio.  Mas enquanto eu tentava entender o que e como faz√™-lo, li muitos desses manuais que funcionam para o autor, mas por algum motivo n√£o funciona para mim e decidi adicionar aqui todas as pe√ßas que encontrei.  Eu ficaria muito feliz com algo assim. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479034/">https://habr.com/ru/post/pt479034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479016/index.html">5 etapas para proteger segredos comerciais</a></li>
<li><a href="../pt479018/index.html">Docker para o front-end. Parte 2. O que voc√™ √©?</a></li>
<li><a href="../pt479020/index.html">A hist√≥ria de como o Google Play cruzou dez anos do meu trabalho em uma hora</a></li>
<li><a href="../pt479022/index.html">TVs inteligentes Samsung, LG, Vizio e TCL a cada segundo pegam "impress√µes digitais" da tela e enviam para o servidor</a></li>
<li><a href="../pt479026/index.html">Verdadeiro somat√≥rio de canais da Internet - OpenMPTCPRouter</a></li>
<li><a href="../pt479036/index.html">A Intel n√£o pode lidar com a demanda por processadores. HP e Dell sofrem como resultado</a></li>
<li><a href="../pt479038/index.html">Transforma√ß√£o digital Leroy Merlin: projetando uma interface para trabalhar com chamadas de clientes</a></li>
<li><a href="../pt479040/index.html">Testes de regress√£o visual. Reiniciar</a></li>
<li><a href="../pt479042/index.html">O m√©todo Y √© uma maneira muito f√°cil de construir um cubo de Rubik</a></li>
<li><a href="../pt479044/index.html">Minha implementa√ß√£o de buffer de anel no flash NOR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>