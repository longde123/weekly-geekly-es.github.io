<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¢ üéµ üõÖ Servidor de impress√£o tolerante a falhas do Windows üîâ üßî üçü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um administrador real pode dormir em paz apenas quando tudo √© feito backup, monitorado e duplicado. Ou quando ele trabalha em uma boa equipe, onde voc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor de impress√£o tolerante a falhas do Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414369/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/7x/lk/zl/7xlkzlpjw2oft9qotypwjalwdmy.png"></a> <br>  Um administrador real pode dormir em paz apenas quando tudo √© feito backup, monitorado e duplicado.  <s>Ou quando ele trabalha em uma boa equipe, onde voc√™ sempre pode culpar os outros.</s> <br>  Aconteceu que eu uso principalmente produtos da Microsoft no meu trabalho e posso dizer que a empresa leva a s√©rio o backup de seus servi√ßos: Active Directory, DAG do Exchange, SQL Always On, DFSR etc.  Como em outros lugares, existem implementa√ß√µes muito elegantes e bem-sucedidas, al√©m de obviamente inconvenientes e dif√≠ceis.  H√° tamb√©m uma solu√ß√£o para o servi√ßo de impress√£o, mas requer clustering baseado no Hyper-V.  E eu queria uma solu√ß√£o simples "pronta para uso", que n√£o requer financiamento adicional.  O Windows 2012 R2 foi tomado como base, mas provavelmente o mesmo esquema funcionar√° sem problemas em nenhuma vers√£o de servidor a partir do Windows 2008 e at√© mesmo em sistemas operacionais clientes do Vista e vers√µes superiores (ol√° para os f√£s que est√£o economizando o or√ßamento!).  Quem se importa - pe√ßo um gato. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Isen√ß√£o de responsabilidade</b> <div class="spoiler_text">  <s>Para respeitar o trabalho dos √≠ndios,</s> como o p√∫blico da Habr fala principalmente russo e facilita os administradores iniciantes, os exemplos usam a vers√£o russa da interface do Windows.  Os links, sempre que poss√≠vel, tamb√©m levam a recursos no idioma russo. <br></div></div><br><br><h2>  Pouco de teoria </h2><br>  Qualquer pessoa que n√£o goste de teoria e queira clicar mais rapidamente com um mouse e teclado pode ir diretamente para a pr√≥xima parte. <br>  Como mencionado acima, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recomenda√ß√£o oficial</a> hoje √© uma solu√ß√£o usando cluster e virtualiza√ß√£o Hyper-V.  Al√©m disso, nada impede garantir a toler√¢ncia a falhas do servi√ßo de impress√£o no n√≠vel do sistema de virtualiza√ß√£o, e n√£o necessariamente o Hyper-V, mas essas solu√ß√µes custam dinheiro. <br>  Eu realmente queria algo semelhante ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DHCP Failover</a> , mas para o papel de um servidor de impress√£o. <br>  Nada adequado foi encontrado na Internet em geral e no Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em particular</a> - e eu mesmo tive que inventar. <br><br>  <b>A ess√™ncia da ideia em um par√°grafo</b> <br>  A solu√ß√£o descrita abaixo √© baseada no utilit√°rio BrintBrm, que faz parte da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">distribui√ß√£o</a> padr√£o do Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">e veio substituir o printmig</a> . <br>  O servidor em espera funciona no modo de espera e sincroniza as configura√ß√µes com o servidor principal com a frequ√™ncia especificada usando este utilit√°rio.  Para os clientes, um CNAME com um pequeno TTL foi criado no DNS, referenciando o servidor principal.  No caso de uma falha do servidor principal, o administrador corrige o CNAME alternando os clientes para o servidor de backup.  Isso, de fato, √© tudo. <br>  Se o t√≥pico for interessante e eu quiser me familiarizar com os solavancos que j√° est√£o cheios comigo e com as maneiras de contornar o rake, siga a seguir. <br><br><h2>  Antes de come√ßar ou o que voc√™ precisa saber sobre o PrintBrm </h2><br>  Ent√£o, o que √© esse utilit√°rio PrintBrm, cujo principal objetivo √© atender o servidor de impress√£o? <br><ul><li>  Bem conservado.  Possui uma implementa√ß√£o de GUI chamada <i>Migra√ß√£o de Impress√£o</i> e pode ser iniciada <i>no</i> snap-in <i>Gerenciamento de Impress√£o</i> .  A vers√£o da GUI √© menos funcional e tem problemas com a portabilidade da porta. </li><li>  Atencioso.  Por padr√£o, ele lida com as ACLs da impressora do servidor de impress√£o.  Em outras palavras, se voc√™ permitiu imprimir na impressora \\ servidor de impress√£o \ impressora1 apenas para funcion√°rios que s√£o membros do grupo de <i>Contabilidade</i> AD, essa restri√ß√£o ser√° levada em considera√ß√£o na importa√ß√£o / exporta√ß√£o.  Ou n√£o, se voc√™ colocar a tecla <i>-NOACL</i> .  No entanto, a ACL do pr√≥prio servidor de impress√£o n√£o √© processada, independentemente da chave. </li><li>  Moody.  No momento da importa√ß√£o de par√¢metros de um arquivo, o servidor de destino deve ter pelo menos uma impressora compartilhada, caso contr√°rio, voc√™ receber√° um erro. </li><li>  Gentil.  Perdeu vendo espa√ßos no caminho do arquivo.  √Ä vista das aspas que enquadram esse caminho, ele fica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">chateado</a> e comete um erro 0x8007007b. </li><li>  Modesto.  Se o arquivo especificado j√° existir durante a tentativa de exportar as configura√ß√µes, ele n√£o poder√° sobrescrev√™-lo, √© t√≠mido perguntar e tamb√©m termina com um erro. </li><li>  Misterioso.  Sempre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">retorna um c√≥digo de sa√≠da 0</a> .  Acontece que o programa perfeito. <br></li><li>  Apto para pensar.  Pode congelar na fase de 100% minutos por 5 e, √†s vezes, mais.  Mas ent√£o ele pensa e termina o trabalho (a menos que, √© claro, voc√™ tenha paci√™ncia para n√£o pressionar Ctrl + C). </li><li>  Repentino e contradit√≥rio.  Pode organizar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">essas surpresas</a> . </li><li>  Inteligente.  Pode reatribuir drivers de origem para outras pessoas.  Por exemplo, usando um arquivo XML, voc√™ pode especificar que todos os drivers do HP Universal Printing PCL 5 em um arquivo salvo no servidor de destino devem ser reatribu√≠dos ao HP Universal Printing PCL 6. N√£o o usei na pr√°tica, mas pode ser √∫til para algu√©m. </li><li>  Wayward.  N√£o pude us√°-lo para transferir configura√ß√µes entre dom√≠nios sem confian√ßa, mesmo com a op√ß√£o -NOACL.  Ou ele n√£o pode fazer isso em princ√≠pio, ou minha m√°gica n√£o √© forte o suficiente. </li><li>  Voc√™ pode conhecer melhor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , mas para aqueles corajosos que n√£o hesitam em perguntar diretamente, existe uma chave /? <br></li></ul><br><br>  Eu admito que alguns recursos eu imerecidamente ignorei.  Talvez no Windows 10/2016 ela tenha come√ßado a se comportar de maneira diferente.  Se houver informa√ß√µes, compartilhe. <br><br><h2>  Prepara√ß√£o do ambiente </h2><br>  Sup√µe-se que voc√™ j√° implantou o Active Directory e conhece pelo menos tr√™s maneiras de desabilit√°-lo e pelo menos duas delas foram testadas na pr√°tica. <br><br><div class="spoiler">  <b class="spoiler_title">Algumas letras</b> <div class="spoiler_text">  Partindo do t√≥pico do artigo, observo que gosto do pedido e sou o fato de que toda impressora de rede e MFP possui um adesivo correspondente ao seu nome de rede.  Isso simplifica o trabalho dos funcion√°rios de TI quando eles tentam descobrir pelo usu√°rio sobre quais impressoras <s>fotogr√°ficas de</s> gato importantes relat√≥rios anal√≠ticos importantes s√£o impressos em tons √°cidos t√≥xicos, em vez de delicados pistaches.  <s>√â melhor colar esses adesivos na parte inferior da impressora, para que todos fiquem mais interessados ‚Äã‚Äãe mais divertidos.</s> <br>  Tamb√©m gosto quando cada impressora de rede √© registrada na zona DNS interna.  Um servidor DHCP baseado no Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pode fazer</a> isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">facilmente</a> . <br>  Por exemplo, o nome da impressora pode estar no formato msk-prn001 ou sale-printer023, e os nomes das portas dessas impressoras no servidor de impress√£o s√£o exatamente iguais.  Mas essa √© minha prefer√™ncia pessoal, estou pronto para ouvir obje√ß√µes nos coment√°rios. <br></div></div><br>  Assumiremos que todas as impressoras est√£o em rede e dispon√≠veis para impress√£o nos servidores de impress√£o prim√°rio e de backup.  Permita que esses servidores sejam chamados <i>prn-srv01</i> e <i>prn-srv02,</i> respectivamente. <br>  Servidores de dom√≠nio no Windows Server n√£o inferiores a 2008 s√£o adequados como servidores de impress√£o.Em princ√≠pio, os sistemas operacionais clientes come√ßando com o Vista tamb√©m s√£o adequados, se voc√™ realmente deseja economizar algum dinheiro.  O exemplo usa o Windows 2012 R2.  √â altamente recomend√°vel instalar todas as atualiza√ß√µes necess√°rias do sistema operacional antes de configurar os servidores e as m√°quinas clientes. <br><br>  Voc√™ mesmo, √© claro, entende, mas o limite ainda requer aten√ß√£o: se os servidores de impress√£o forem virtuais, eles dever√£o ser distribu√≠dos para diferentes servidores f√≠sicos; caso contr√°rio, nosso failover simplesmente se transformar√° em falha. <br><br>  Em <i>prn-srv01</i> e <i>prn-srv02</i> , a fun√ß√£o de servidor de impress√£o deve ser adicionada.  √â mais conveniente usar o cmdlet do PowerShell: <br> <code>Install-WindowsFeature Print-Services</code> <br> <br>  Al√©m disso, um ajuste no registro deve ser aplicado nos servidores de impress√£o, o que corrige o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">erro 0 √ó 00000709</a> quando as m√°quinas clientes acessam o servidor de impress√£o via CNAME.  Voc√™ pode fazer isso com o comando do artigo no link acima: <br> <code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Print /v DnsOnWire /t REG_DWORD /d 1</code> <br>  Ap√≥s aplicar o comando, voc√™ deve reiniciar o servi√ßo <i>Gerenciador de Impress√£o</i> . <br>  Eu recomendo que voc√™ aloque uma UO separada para os servidores de impress√£o e distribua essa configura√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usando o GPP</a> . <br><br>  Iniciamos o snap-in DNS no controlador de dom√≠nio e habilitamos a exibi√ß√£o estendida: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t_/sg/w1/t_sgw1pf6fazbhihj-4yjxzivfc.png"><br></div></div><br>  √â necess√°rio mapeamento avan√ßado para poder definir TTL para registros criados. <br>  No DNS, crie um registro de <i>impress√£o</i> CNAME que fa√ßa refer√™ncia a <i>prn-srv01</i> com um valor TTL de 5 minutos: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bx/oe/0y/bxoe0yjyj5pmar4utycfqjfnnba.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/w_/tz/dj/w_tzdj66enutsmeuw5wwajzmrww.png"><br></div></div><br>  Esse nome deve ser usado pelas m√°quinas clientes para conectar-se ao servidor de impress√£o.  I.e.  o cliente se conectar√° aos endere√ßos \\ print \ printer01, \\ print \ printer02, etc. <br>  Quanto menor o valor TTL, mais frequentemente os clientes atualizam o registro e mais cedo ‚Äúentendem‚Äù que precisam mudar para outro servidor de impress√£o.  5 minutos √© suficiente para mim. <br>  Ao definir o valor muito baixo, voc√™ gera tr√°fego DNS na sua rede <s>e, especificando uma ou duas horas, enfatiza sua toler√¢ncia ao estresse e nervos fortes</s> . <br>  Uma maneira alternativa de adicionar um registro CNAME usando o PowerShell: <br> <code>Import-Module DnsServer <br> Add-DnsServerResourceRecordCName -Name "print" -HostNameAlias "prn-srv01.lab.net" -ZoneName "lab.net" -TimeToLive 00:05:00 <br></code> <br>  (√â claro que alteramos lab.net para seu contoso.local ou o que for) <br><br>  Lembre-se de que, se voc√™ tiver v√°rios sites do AD, a atualiza√ß√£o dos registros DNS em todos os locais levar√° mais tempo devido √† replica√ß√£o entre sites.  Voc√™ pode for√ßar o processo com o <i>comando repadmin / syncall</i> . <br><br>  Usando a Diretiva de Grupo, permitimos que usu√°rios comuns instalem drivers a partir do servidor de impress√£o.  Como fazer isso √© descrito em detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Crie uma conta de servi√ßo no AD (chamei-o de svc-printsync) com uma validade ilimitada da senha: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/b8/-i/awb8-irvpqwtgz7_hqh5zziclxu.png"><br></div></div><br>  De acordo com os requisitos do PrintBrm, esta conta deve ter todos os direitos no servidor de impress√£o; portanto, a adicionamos ao <s>dom√≠nio admins para que tudo funcione com certeza e escrevemos a senha no campo de descri√ß√£o para n√£o esquecer o</s> grupo local de <i>Administradores</i> em <i>prn-srv01</i> e <i>prn-srv02</i> ( por exemplo, usando <i>o</i> snap- <i>in Gerenciamento do computador</i> ). <br><br><h2>  Configure o primeiro servidor </h2><br>  Se todas as impressoras necess√°rias na impressora principal j√° tiverem sido adicionadas, voc√™ poder√° prosseguir imediatamente para a se√ß√£o sobre configura√ß√£o do segundo servidor. <br><br>  Usando <i>o</i> snap-in <i>Gerenciamento de Impress√£o</i> , adicionamos drivers para as impressoras necess√°rias no servidor: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c0/_b/fl/c0_bflidme6egcqqpjsu8fmhkay.png"><br></div></div><br>  O assistente de instala√ß√£o do driver √© iniciado.  √â intuitivo, voc√™ pode descobrir por si mesmo.  Prestarei aten√ß√£o apenas ao momento com profundidade de bits. <br>  Porque  Como o Windows 2012R2 est√° dispon√≠vel apenas na vers√£o x64, os drivers tamb√©m devem ser x64.  Se os clientes com vers√µes x86 do Windows se conectarem ao servidor de impress√£o, n√£o se esque√ßa de marcar a caixa correspondente: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kk/1r/be/kk1rbe46et1lxpumhlwjt4dgqvu.png"><br></div></div><br>  Alguns kits de drivers cont√™m um arquivo inf comum para os sistemas x86 e x64, enquanto outros t√™m uma separa√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Some more lyrics</b> <div class="spoiler_text">  Muitos drivers v√™m na forma de um instalador, mas, como esses instaladores colocam muito lixo junto com os drivers, tento seguir o princ√≠pio de "necess√°rio e suficiente" e adiciono drivers manualmente, conforme descrito acima. <br>  Al√©m disso, por uma quest√£o de consist√™ncia, eu me esfor√ßo para usar a vers√£o Universal dos drivers ao m√°ximo (quase todos os fornecedores normais possuem).  Mas, √†s vezes, pode ser um problema.  Assim, quando encontrei um bug em uma das vers√µes do HP Universal Printing PCL 6, na qual um documento PDF atrav√©s do EasyPrint em uma sess√£o RDP era impresso espelhado para a esquerda da direita para a direita. <br>  Voc√™ tamb√©m pode olhar para os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">drivers v4</a> . <br></div></div><br><br>  Quando todos os drivers necess√°rios forem adicionados, lidaremos com portas e impressoras.  Voc√™ pode adicion√°-los manualmente a partir do mesmo snap-in, mas recomendo criar um arquivo CSV no Excel e aliment√°-lo com um script do PowerShell.  Obviamente, nada impede o Excel de usar qualquer outro editor de planilha ou bloco de notas em geral.  O principal √© que o separador e a codifica√ß√£o especificados no script correspondem ao separador e codifica√ß√£o no arquivo CSV. <br>  Observe tamb√©m que o nome do driver no arquivo CSV deve ser exatamente igual ao especificado no snap-in <i>Gerenciamento de</i> impress√£o. <br><div class="spoiler">  <b class="spoiler_title">Copiar e colar para o resgate</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lt/-u/k3/lt-uk31frw4ashg6sqfxptrx6us.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Arquivo CSV de amostra</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/f9/wp/cj/f9wpcjsmlydppavwxh9ed4bn51m.png"><br></div></div><br><br>  Embora eu tenha escrito acima que gosto quando todas as impressoras t√™m nomes de rede unificados, o exemplo (campo de <i>endere√ßo da impressora</i> ) usa um vinagrete de endere√ßos IP e nomes, caso voc√™ <s>n√£o</s> tenha ordem na sua rede um pouco mais tarde. <br><br>  Salve esta tabela no formato CSV: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1e/qq/4i/1eqq4iw3hfbsjfge8mcetyerlfg.png"><br>  <i><b>Nota</b></i>  <i>Apesar de v√≠rgulas serem indicadas como separadores no campo "Tipo de arquivo", o Excel fez um ponto-e-v√≠rgula como separador.</i>  <i>Provavelmente seja mais interessante e mais divertido.</i> <br></div></div><br>  E aqui est√° o pr√≥prio script: <br><div class="spoiler">  <b class="spoiler_title">CreatePrintersFromCsv.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#    $InputFile = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\Printers.csv'</span></span> #      CSV- $Printers = (Import-Csv $InputFile -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -Encoding Default) #          ForEach ($Printer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Printers) { #       $PrinterName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $ShareName = $Printer.<span class="hljs-string"><span class="hljs-string">'  '</span></span> $DriverName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $PrinterAddr = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $Comment = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> $Location = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> #  Add-PrinterPort -Name $PrinterAddr -PrinterHostAddress $PrinterAddr -SNMP <span class="hljs-number"><span class="hljs-number">1</span></span> -SNMPCommunity <span class="hljs-string"><span class="hljs-string">'public'</span></span> #  Add-Printer -Name $PrinterName -DriverName $DriverName -PortName $PrinterAddr -Comment $Comment -Location $Location #   Set-Printer -Name $PrinterName -Shared $True -Published $False -ShareName $ShareName }</code> </pre><br></div></div><br>  Se o caractere de tabula√ß√£o for usado como um delimitador no seu CSV, no script voc√™ precisar√° definir <i>-Delimiter "` t "</i> <br><br>  Observe que, se uma impressora n√£o estiver dispon√≠vel no servidor enquanto o script estiver em execu√ß√£o, adicion√°-la ao servidor de impress√£o levar√° mais tempo (2-3 minutos em vez de alguns segundos) <br><br>  O resultado do script: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fj/jd/-t/fjjd-tcfaowketxq9u7av7yzfzk.png"><br></div></div><br><br>  Para garantir que tudo funcione nesse est√°gio, adicione uma impressora compartilhada a qualquer uma das m√°quinas clientes do servidor de impress√£o principal usando o CNAME criado anteriormente (por exemplo, \\ print \ printer01) e tente imprimir algo nela.  <s>Para esse fim, a frase ‚ÄúPreved, sou um peda√ßo de papel‚Äù, digitada em negrito Arial com tamanho 200, √© mais adequada para esse fim.</s> <br><br><h2>  Configure um segundo servidor </h2><br><blockquote>  Um artista copia, um grande artista roba (Pablo Picasso) </blockquote><br>  Nosso <i>prn-srv02</i> ainda n√£o atingiu o n√≠vel de gran artista, por isso nos limitaremos a copiar.  <s>Embora ... seja poss√≠vel com um movimento do pulso ...</s> <br><br>  Criamos e compartilhamos pelo menos uma impressora, caso contr√°rio, o PrintBrm dar√° um erro.  Voc√™ pode fingir, mas √© importante n√£o escolher o driver ou a porta errada.  Por exemplo, uma impressora com um driver Microsoft XPS Document Writer ou uma porta FILE n√£o pode ser compartilhada. <br><br>  Criamos um script de sincroniza√ß√£o simples.  Prefiro o PowerShell, mas ningu√©m pro√≠be a cria√ß√£o de um arquivo em lotes de tubos quentes. <br><br><div class="spoiler">  <b class="spoiler_title">PrintSync.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#   PrintBrm $ProgramPath = <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\Spool\Tools\PrintBrm.exe'</span></span> #    $SourceServer = <span class="hljs-string"><span class="hljs-string">'prn-srv01'</span></span> $DestServer = <span class="hljs-string"><span class="hljs-string">'prn-srv02'</span></span> #,   .     , ..  PrintBrm       $ConfigFilePath = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\prn-config.printerExport'</span></span> #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $SourceServer -f $ConfigFilePath -b"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $DestServer -f $ConfigFilePath -r -o force"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #   Del $ConfigFilePath</code> </pre><br></div></div><br><br>  Colocamos o script em um local isolado (no exemplo, √© <i>C: \ Scripts</i> ) e criamos uma tarefa no Agendador. <br>  Iremos executar a partir da conta svc-printsync criada anteriormente com as permiss√µes mais altas: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sp/ax/9w/spax9w_u6llu5ekhxh6ezfq8zdi.png"><br></div></div><br>  Determine a frequ√™ncia de execu√ß√£o para si mesmo.  O suficiente para mim uma vez por dia: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m8/a5/hm/m8a5hm3qm5dosyvvd8uivsrdeaq.png"><br></div></div><br>  Na guia A√ß√µes, crie uma nova a√ß√£o de inicializa√ß√£o do PowerShell: <br> <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code> <br>  Como argumentos, definimos o caminho para o script com os seguintes par√¢metros: <br> <code>C:\Scripts\PrintSync.ps1 -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass</code> <br> <div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c2/dw/zi/c2dwzipe2ifr6vstp2qgpvr-cc4.png"><br></div></div><br>  Deixamos o restante dos par√¢metros da tarefa nas guias <i>Condi√ß√µes</i> e <i>Par√¢metros</i> por padr√£o. <br>  Ao salvar a tarefa, uma senha ser√° solicitada para a <i>conta svc-printsync</i> .  Voc√™ n√£o o esqueceu?  Se voc√™ j√° se esqueceu (o artigo √© longo), <s>tudo foi feito em v√£o e a vida n√£o teve</s> √™xito.Refina-o usando o snap-in ADUC ou de outra maneira conveniente <s>e especifique-o j√° no campo de descri√ß√£o para torn√°-lo mais calmo</s> . <br><br><div class="spoiler">  <b class="spoiler_title">Nota</b> <div class="spoiler_text">  O trabalho n√£o precisa ser executado no servidor de impress√£o de backup.  Se voc√™ tiver um servidor separado para executar rotinas, poder√° criar uma tarefa nele.  Nesse caso, a <i>conta svc-printsync</i> deve ter o direito de <i>efetuar</i> login como um trabalho em lotes neste servidor.  Por padr√£o, o grupo local <i>Operadores de Backup</i> tem esse direito e, se isso n√£o for alterado em seu ambiente, inclua a conta de servi√ßo no grupo de operadores de arquivamento do servidor no qual a tarefa ser√° executada. <br></div></div><br><br>  Pela primeira vez, iniciamos a tarefa manualmente e aguardamos sua conclus√£o. <br>  Para o meu zool√≥gico, onde existem cerca de 50 impressoras de tipos diferentes, amea√ßadas de extin√ß√£o e criadas recentemente, o procedimento de sincroniza√ß√£o leva cerca de 10 minutos.  O arquivo, ao mesmo tempo, pesa quase 1 GB. <br>  Para acelerar o processo de importa√ß√£o / exporta√ß√£o, voc√™ pode usar a <i>op√ß√£o -NOBIN</i> , respons√°vel por copiar os drivers.  Faz sentido quando a frota de impressoras consiste nos mesmos modelos e os drivers necess√°rios est√£o instalados em todos os servidores. <br><br>  Ap√≥s a conclus√£o, execute o snap-in <i>Visualizador de Eventos</i> , v√° para a se√ß√£o <i>Logs de Aplicativos e Servi√ßos</i> , abra o <i>log Microsoft \ Microsoft \ PrintBRM \ Administrator</i> e analise-o quanto a erros e avisos.  <s>E se houver muitos deles, √© mais prov√°vel que limpemos a revista para que nossos olhos n√£o fiquem calosos.</s> <br><br>  Me deparei com os c√≥digos 20, 22, 80 e 81. Por exemplo, <br><div class="spoiler">  <b class="spoiler_title">tal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/be/sx/7u/besx7uy6lxapuzrxj3_mrsg9agc.png"><br></div></div><br>  Como est√° claro no texto, houve um problema ao transferir um driver espec√≠fico.  Examinando o log, fazemos uma lista de drivers problem√°ticos e os colocamos no servidor de backup com nossas m√£os, ou substitu√≠-los por outros que n√£o s√£o avessos a viajar.  Eu s√≥ tive problemas com a HP, Kyocera e Konica Minolta, nenhum erro foi detectado para drivers de outros fabricantes (talvez porque sejam melhores ou talvez porque simplesmente n√£o os temos). <br>  Como resultado, voc√™ precisa obter a mesma lista de impressoras nos servidores prim√°rio e de backup e a aus√™ncia de erros e avisos nos logs. <br><br><h2>  Mudar para reserva </h2><br>  <s>Sob a batida dos machados e a tritura√ß√£o dos garfos, barricamos a porta do escrit√≥rio e desligamos o telefone.</s>  Execute o snap-in DNS e edite o registro CNAME para que ele aponte para o servidor de backup: <br><div class="spoiler">  <b class="spoiler_title">clique</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3n/kh/p5/3nkhp5g6apvxj1ejoheth9hlcfu.png"><br></div></div><br>  Depois de um tempo (o que voc√™ colocou no TTL l√°?), Os <s>gritos amea√ßadores desaparecer√£o, as</s> m√°quinas clientes mudar√£o para prn-srv02 <s>e a porta com o telefone poder√° ser destrancada</s> . <br><br><h2>  Volta </h2><br>  Se durante a recupera√ß√£o do servidor principal no backup houve altera√ß√µes na configura√ß√£o que precisam ser salvas, iniciamos a sincroniza√ß√£o na dire√ß√£o oposta.  Para fazer isso, no script <i>PrintSync.ps1</i> acima <i>,</i> trocamos os valores das vari√°veis <i>$ SourceServer</i> e <i>$ DestServer</i> .  Ap√≥s transferir as altera√ß√µes, n√£o se esque√ßa de retornar esses valores, caso contr√°rio, todas as altera√ß√µes na configura√ß√£o da impressora em <i>prn-srv01</i> ser√£o impiedosamente <i>varridas</i> todas as noites pela m√° vontade do destino. <br>  No snap-in DNS, defina <i>print</i> para o registro CNAME como o valor do n√≥ de destino prn-srv01 - e tudo retornar√° √† estaca zero. <br><br><h2>  Qual √© o resultado? </h2><br>  Aplausos tempestuosos da lideran√ßa, jogando o administrador em seus bra√ßos, aumentando o sal√°rio (para o autor do artigo - 10% honestos do aumento) ... <br>  Bem, alguns pensamentos na dire√ß√£o da orienta√ß√£o de mais beleza. <br><br>  Infelizmente, n√£o h√° milagres suficientes para todos, e essa solu√ß√£o n√£o √© um failover completo.  Se, no momento do colapso do servidor de impress√£o principal, houver filas de impress√£o n√£o vazias nele, o conte√∫do provavelmente desaparecer√° no ar e algu√©m precisar√° repetir o envio para impress√£o. <br><br>  Mas ser√° muito conveniente para os usu√°rios realizarem de maneira transparente a manuten√ß√£o de rotina dos servidores de impress√£o. <br><div class="spoiler">  <b class="spoiler_title">Voc√™ segue as recomenda√ß√µes da Microsoft?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s9/dr/bm/s9drbmkdazxkxaswuw4flitnsoi.jpeg"><br></div></div><br><br>  Os f√£s de automa√ß√£o podem ir al√©m e criar um script que receba nomes de servidores com um intervalo de sincroniza√ß√£o na entrada e fa√ßa o restante das pr√≥prias configura√ß√µes: cria uma conta de servi√ßo, se necess√°rio, uma tarefa no agendador etc. <br><br>  Os gurus do monitoramento adicionar√£o o monitoramento da tarefa de sincroniza√ß√£o e os erros nos logs. <br><br>  Os amantes do aprofundamento podem pensar na sincroniza√ß√£o bidirecional, no esp√≠rito da replica√ß√£o do AD, com altera√ß√µes no rastreamento de tempo para cada impressora.  O PrintBrm n√£o ajudar√° aqui, mas ningu√©m cancelou o PowerShell! <br><br>  A cereja no topo do bolo ser√° a instala√ß√£o autom√°tica de impressoras nas m√°quinas clientes usando GPP, visando o grupo AD.  Adicione o usu√°rio ao grupo - e a impressora desejada voar√° para ele.  √â verdade que essa √© outra hist√≥ria que vai al√©m do escopo do artigo. <br><br>  Espero que algu√©m a minha publica√ß√£o seja √∫til.  Desejo a todos menos falhas e aguardo perguntas e sugest√µes nos coment√°rios. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt414369/">https://habr.com/ru/post/pt414369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt414357/index.html">Usamos a API Web Bluetooth para conectar o monitor de freq√º√™ncia card√≠aca e desenvolver o aplicativo usando o Vue.js</a></li>
<li><a href="../pt414359/index.html">Intera√ß√£o com o servidor por meio da API no iOS no Swift 3. Parte 1</a></li>
<li><a href="../pt414361/index.html">Unity3D: Arquitetura de Jogos, Objetos Scriptable, Singletones</a></li>
<li><a href="../pt414363/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 319 (11 a 17 de junho de 2018)</a></li>
<li><a href="../pt414367/index.html">Galopando em tr√™s anos: o que pode ser interessante reler no blog HashFlare</a></li>
<li><a href="../pt414371/index.html">Turma escolar e um pequeno esbo√ßo de engenharia social</a></li>
<li><a href="../pt414373/index.html">Design ass√≠ncrono / aguardado do JavaScript: pontos fortes, armadilhas e padr√µes de uso</a></li>
<li><a href="../pt414375/index.html">Comandos para trabalhar com o console JavaScript em navegadores e aumentar a produtividade do programador</a></li>
<li><a href="../pt414377/index.html">Inova√ß√µes de literais de objetos no JavaScript ES6</a></li>
<li><a href="../pt414379/index.html">‚ÄúOs que est√£o dispostos a trocar liberdade por seguran√ßa n√£o s√£o dignos de liberdade ou seguran√ßa‚Äù (fonte original)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>