<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš° ğŸ›¡ï¸ ğŸ” ä¸€æ¬¡SQLè°ƒæŸ¥çš„å†å²è®°å½• ğŸš¥ ğŸ¤ª ğŸ¤¶ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å»å¹´12æœˆï¼Œæˆ‘æ”¶åˆ°äº†VWOæ”¯æŒå›¢é˜Ÿçš„æœ‰è¶£çš„é”™è¯¯æŠ¥å‘Šã€‚ å¯¹äºå¤§å‹ä¼ä¸šå®¢æˆ·è€Œè¨€ï¼Œä¸€ä»½åˆ†ææŠ¥å‘Šçš„åŠ è½½æ—¶é—´ä¼¼ä¹ä»¤äººæœ›è€Œå´æ­¥ã€‚ ç”±äºè¿™æ˜¯æˆ‘çš„è´£ä»»èŒƒå›´ï¼Œå› æ­¤æˆ‘ç«‹å³ä¸“æ³¨äºè§£å†³é—®é¢˜ã€‚ 
 èƒŒæ™¯çŸ¥è¯† 


 ä¸ºäº†å¼„æ¸…æ¥šæˆ‘åœ¨è¯´ä»€ä¹ˆï¼Œæˆ‘å°†ç®€å•ä»‹ç»ä¸€ä¸‹VWOã€‚ è¿™ä¸ªå¹³å°å¯è®©æ‚¨åœ¨ç½‘ç«™ä¸Šæ‰§è¡Œå„ç§é’ˆå¯¹æ€§çš„å¹¿å‘Šç³»åˆ—ï¼šè¿›è¡ŒA / B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸€æ¬¡SQLè°ƒæŸ¥çš„å†å²è®°å½•</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455832/"><p> å»å¹´12æœˆï¼Œæˆ‘æ”¶åˆ°äº†VWOæ”¯æŒå›¢é˜Ÿçš„æœ‰è¶£çš„é”™è¯¯æŠ¥å‘Šã€‚ å¯¹äºå¤§å‹ä¼ä¸šå®¢æˆ·è€Œè¨€ï¼Œä¸€ä»½åˆ†ææŠ¥å‘Šçš„åŠ è½½æ—¶é—´ä¼¼ä¹ä»¤äººæœ›è€Œå´æ­¥ã€‚ ç”±äºè¿™æ˜¯æˆ‘çš„è´£ä»»èŒƒå›´ï¼Œå› æ­¤æˆ‘ç«‹å³ä¸“æ³¨äºè§£å†³é—®é¢˜ã€‚ </p><br><h2> èƒŒæ™¯çŸ¥è¯† </h2><br><p> ä¸ºäº†å¼„æ¸…æ¥šæˆ‘åœ¨è¯´ä»€ä¹ˆï¼Œæˆ‘å°†ç®€å•ä»‹ç»ä¸€ä¸‹VWOã€‚ è¿™ä¸ªå¹³å°å¯è®©æ‚¨åœ¨ç½‘ç«™ä¸Šæ‰§è¡Œå„ç§é’ˆå¯¹æ€§çš„å¹¿å‘Šç³»åˆ—ï¼šè¿›è¡ŒA / Bå®éªŒï¼Œè·Ÿè¸ªè®¿é—®è€…å’Œè½¬åŒ–ï¼Œåˆ†æé”€å”®æ¸ é“ï¼Œæ˜¾ç¤ºçƒ­å›¾å¹¶æ’­æ”¾è®¿é—®è®°å½•ã€‚ </p><br><p> ä½†æ˜¯å¹³å°ä¸­æœ€é‡è¦çš„æ˜¯æŠ¥å‘Šã€‚ ä»¥ä¸Šæ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯ç›¸äº’å…³è”çš„ã€‚ è€Œå¯¹äºä¼ä¸šå®¢æˆ·è€Œè¨€ï¼Œå¦‚æœæ²¡æœ‰å¼ºå¤§çš„å¹³å°ä»¥åˆ†æçš„å½¢å¼å‘ˆç°å®ƒä»¬ï¼Œé‚£ä¹ˆå¤§é‡ä¿¡æ¯å°†æ¯«æ— ç”¨å¤„ã€‚ </p><br><p>ä½¿ç”¨è¯¥å¹³å°ï¼Œæ‚¨å¯ä»¥å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œä»»æ„è¯·æ±‚ã€‚ è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š </p><br><pre> æ˜¾ç¤ºabc.comä¸Šçš„æ‰€æœ‰ç‚¹å‡»
ä»&lt;æ—¥æœŸd1&gt;åˆ°&lt;æ—¥æœŸd2&gt;
å¯¹äºé‚£äº›è°
äºŒæ‰‹Chromeæˆ–
 ï¼ˆåœ¨æ¬§æ´²ä½¿ç”¨è¿‡iPhoneï¼‰ </pre><br><p> æ³¨æ„å¸ƒå°”è¿ç®—ç¬¦ã€‚ å®¢æˆ·ç«¯å¯åœ¨æŸ¥è¯¢ç•Œé¢ä¸­ä½¿ç”¨å®ƒä»¬æ¥è¿›è¡Œä»»æ„å¤æ‚çš„æŸ¥è¯¢ä»¥æ£€ç´¢æ ·æœ¬ã€‚ </p><br><h2> è¦æ±‚ç¼“æ…¢ </h2><br><p> æœ‰é—®é¢˜çš„å®¢æˆ·æ­£åœ¨å°è¯•åšä¸€äº›ç›´è§‚ä¸Šåº”è¯¥å¯ä»¥å¿«é€Ÿå·¥ä½œçš„äº‹æƒ…ï¼š </p><br><pre> æ˜¾ç¤ºæ‰€æœ‰ä¼šè®®è®°å½•
é€‚ç”¨äºè®¿é—®ä»»ä½•é¡µé¢çš„ç”¨æˆ·
å¸¦æœ‰â€œ / jobâ€çš„URL </pre><br><p> è¿™ä¸ªç½‘ç«™ä¸Šçš„æµé‡å¾ˆå¤§ï¼Œæˆ‘ä»¬ä¸ºæ­¤å­˜å‚¨äº†è¶…è¿‡ä¸€ç™¾ä¸‡ä¸ªå”¯ä¸€URLã€‚ ä»–ä»¬æƒ³æ‰¾åˆ°ä¸€ä¸ªä¸å…¶ä¸šåŠ¡æ¨¡å‹ç›¸å…³çš„éå¸¸ç®€å•çš„urlæ¨¡æ¿ã€‚ </p><br><a name="habracut"></a><h2> åˆæ­¥è°ƒæŸ¥ </h2><br><p> è®©æˆ‘ä»¬çœ‹çœ‹æ•°æ®åº“ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚ ä»¥ä¸‹æ˜¯åŸå§‹çš„æ…¢é€ŸSQLæŸ¥è¯¢ï¼š </p><br><pre><code class="plaintext hljs">SELECT count(*) FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data as recording_data, acc_{account_id}.sessions as sessions WHERE recording_data.usp_id = sessions.usp_id AND sessions.referrer_id = recordings_urls.id AND ( urls &amp;&amp; array(select id from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%')::text[] ) AND r_time &gt; to_timestamp(1542585600) AND r_time &lt; to_timestamp(1545177599) AND recording_data.duration &gt;=5 AND recording_data.num_of_pages &gt; 0 ;</code> </pre> <br><p> ä»¥ä¸‹æ˜¯æ—¶é—´å®‰æ’ï¼š </p><br><pre> è®¡åˆ’çš„æ—¶é—´ï¼š1.480æ¯«ç§’
äº¤è´§æ—¶é—´ï¼š1431924.650 ms </pre><br><p> è¯¥è¯·æ±‚ç»•è¿‡äº†15ä¸‡è¡Œã€‚ æŸ¥è¯¢è®¡åˆ’ç¨‹åºæ˜¾ç¤ºäº†å‡ ä¸ªæœ‰è¶£çš„ç»†èŠ‚ï¼Œä½†æ²¡æœ‰æ˜æ˜¾çš„ç“¶é¢ˆã€‚ </p><br><p> è®©æˆ‘ä»¬è¿›ä¸€æ­¥ç ”ç©¶æŸ¥è¯¢ã€‚ å¦‚æ‚¨æ‰€è§ï¼Œå®ƒå°†åˆ›å»ºä¸‰ä¸ªè¡¨<code>JOIN</code> ï¼š </p><br><ol><li>  <strong>session</strong> ï¼šæ˜¾ç¤ºä¼šè¯ä¿¡æ¯ï¼šæµè§ˆå™¨ï¼Œç”¨æˆ·ä»£ç†ï¼Œå›½å®¶/åœ°åŒºç­‰ã€‚ </li><li>  <strong>recording_data</strong> ï¼šè®°å½•çš„URLï¼Œé¡µé¢ï¼Œè®¿é—®æŒç»­æ—¶é—´ </li><li>  <strong>urls</strong> ï¼šä¸ºé¿å…é‡å¤å¾ˆå¤§çš„urlï¼Œæˆ‘ä»¬å°†å®ƒä»¬å­˜å‚¨åœ¨å•ç‹¬çš„è¡¨ä¸­ã€‚ </li></ol><br><p> å¦è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„è¡¨éƒ½å·²æŒ‰<code>account_id</code>æ‹†åˆ†ã€‚ å› æ­¤ï¼Œå½“ç”±äºä¸€ä¸ªç‰¹åˆ«å¤§çš„å¸æˆ·è€Œå…¶ä»–å¸æˆ·æœ‰é—®é¢˜æ—¶ï¼Œåˆ™æ’é™¤äº†è¿™ç§æƒ…å†µã€‚ </p><br><h2> å¯»æ‰¾è¯æ® </h2><br><p> é€šè¿‡ä»”ç»†æ£€æŸ¥ï¼Œæˆ‘ä»¬å‘ç°ç‰¹å®šè¯·æ±‚ä¸­çš„æŸäº›å†…å®¹ä¸æ­£ç¡®ã€‚ å€¼å¾—ä¸€çœ‹çš„æ˜¯è¿™ä¸€è¡Œï¼š </p><br><pre> <code class="plaintext hljs">urls &amp;&amp; array( select id from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%' )::text[]</code> </pre> <br><p> é¦–å…ˆæƒ³åˆ°çš„æ˜¯ï¼Œä¹Ÿè®¸ç”±äºæ‰€æœ‰è¿™äº›é•¿URLä¸­çš„<code>ILIKE</code> ï¼ˆæˆ‘ä»¬ä¸ºè¯¥å¸æˆ·æ”¶é›†äº†è¶…è¿‡140ä¸‡ä¸ª<strong>å”¯ä¸€</strong> URLï¼‰ï¼Œæ€§èƒ½å¯èƒ½ä¼šä¸‹é™ã€‚ </p><br><p> ä½†æ˜¯ï¼Œä¸-è¿™ä¸æ˜¯é‡ç‚¹ï¼ </p><br><pre> <code class="plaintext hljs">SELECT id FROM urls WHERE url ILIKE '%enterprise_customer.com/jobs%'; id -------- ... (198661 rows) Time: 5231.765 ms</code> </pre> <br><p> æ¨¡æ¿æœç´¢è¯·æ±‚æœ¬èº«ä»…éœ€5ç§’é’Ÿã€‚ åœ¨ç™¾ä¸‡ä¸ªå”¯ä¸€çš„URLä¸Šæœç´¢æ¨¡å¼æ˜¾ç„¶ä¸æ˜¯é—®é¢˜ã€‚ </p><br><p> åˆ—è¡¨ä¸Šçš„ä¸‹ä¸€ä¸ªå¯ç–‘å¯¹è±¡æ˜¯å‡ ä¸ª<code>JOIN</code> ã€‚ ä¹Ÿè®¸ä»–ä»¬çš„è¿‡åº¦ä½¿ç”¨å¯¼è‡´å¢é•¿æ”¾ç¼“ï¼Ÿ  <code>JOIN</code>é€šå¸¸æ˜¯æ€§èƒ½é—®é¢˜æœ€æ˜æ˜¾çš„å€™é€‰è€…ï¼Œä½†æ˜¯æˆ‘ä¸è®¤ä¸ºæˆ‘ä»¬çš„æ¡ˆä¾‹å¾ˆå…¸å‹ã€‚ </p><br><pre> <code class="plaintext hljs">analytics_db=# SELECT count(*) FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data_0 as recording_data, acc_{account_id}.sessions_0 as sessions WHERE recording_data.usp_id = sessions.usp_id AND sessions.referrer_id = recordings_urls.id AND r_time &gt; to_timestamp(1542585600) AND r_time &lt; to_timestamp(1545177599) AND recording_data.duration &gt;=5 AND recording_data.num_of_pages &gt; 0 ; count ------- 8086 (1 row) Time: 147.851 ms</code> </pre> <br><p> è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„æƒ…å†µã€‚ äº‹å®è¯æ˜<code>JOIN</code>çš„é€Ÿåº¦éå¸¸å¿«ã€‚ </p><br><h2> æˆ‘ä»¬ç¼©å°äº†å«Œç–‘äººçš„èŒƒå›´ </h2><br><p> æˆ‘å‡†å¤‡å¼€å§‹æ›´æ”¹æŸ¥è¯¢ä»¥å®ç°ä»»ä½•å¯èƒ½çš„æ€§èƒ½æ”¹è¿›ã€‚ æˆ‘å’Œæˆ‘çš„å›¢é˜Ÿæå‡ºäº†ä¸¤ä¸ªä¸»è¦æƒ³æ³•ï¼š </p><br><ul><li>  <strong>å¯¹å­æŸ¥è¯¢URLä½¿ç”¨EXISTS</strong> ï¼šæˆ‘ä»¬æƒ³å†æ¬¡æ£€æŸ¥<strong>å­æŸ¥è¯¢çš„URL</strong>æ˜¯å¦å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚ å®ç°æ­¤ç›®çš„çš„ä¸€ç§æ–¹æ³•æ˜¯ç®€å•åœ°ä½¿ç”¨<code>EXISTS</code> ã€‚  <code>EXISTS</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯ä»¥</a>æå¤§åœ°æé«˜æ€§èƒ½ï¼Œå› ä¸ºå®ƒä¼šåœ¨æŒ‰æ¡ä»¶æ‰¾åˆ°å•è¡Œåç«‹å³ç»ˆæ­¢ã€‚ </li></ul><br><pre> <code class="plaintext hljs">SELECT count(*) FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data as recording_data, acc_{account_id}.sessions as sessions WHERE recording_data.usp_id = sessions.usp_id AND ( 1 = 1 ) AND sessions.referrer_id = recordings_urls.id AND (exists(select id from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%')) AND r_time &gt; to_timestamp(1547585600) AND r_time &lt; to_timestamp(1549177599) AND recording_data.duration &gt;=5 AND recording_data.num_of_pages &gt; 0 ; count 32519 (1 row) Time: 1636.637 ms</code> </pre> <br><p> å¥½å§ï¼Œæ˜¯çš„ã€‚ å­æŸ¥è¯¢åŒ…è£…åœ¨<code>EXISTS</code> ï¼Œå¯ä½¿æ‰€æœ‰å†…å®¹å˜å¾—è¶…å¿«ã€‚ ä¸‹ä¸€ä¸ªé€»è¾‘é—®é¢˜æ˜¯ä¸ºä»€ä¹ˆå¸¦æœ‰JOINçš„æŸ¥è¯¢å’Œå­æŸ¥è¯¢æœ¬èº«çš„é€Ÿåº¦å¾ˆå¿«ï¼Œä½†åœ¨ä¸€èµ·çš„é€Ÿåº¦å´éå¸¸æ…¢ï¼Ÿ </p><br><ul><li>  <strong>æˆ‘ä»¬å°†å­æŸ¥è¯¢ç§»è‡³CTE</strong> ï¼šå¦‚æœè¯·æ±‚æœ¬èº«å¿«é€Ÿï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å…ˆè®¡ç®—å¿«é€Ÿç»“æœï¼Œç„¶åå°†å…¶æä¾›ç»™ä¸»è¯·æ±‚ </li></ul><br><pre> <code class="plaintext hljs">WITH matching_urls AS ( select id::text from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%' ) SELECT count(*) FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data as recording_data, acc_{account_id}.sessions as sessions, matching_urls WHERE recording_data.usp_id = sessions.usp_id AND ( 1 = 1 ) AND sessions.referrer_id = recordings_urls.id AND (urls &amp;&amp; array(SELECT id from matching_urls)::text[]) AND r_time &gt; to_timestamp(1542585600) AND r_time &lt; to_timestamp(1545107599) AND recording_data.duration &gt;=5 AND recording_data.num_of_pages &gt; 0;</code> </pre> <br><p> ä½†æ˜¯å®ƒä»ç„¶å¾ˆæ…¢ã€‚ </p><br><h2> æ‰¾åˆ°ç½ªé­ç¥¸é¦– </h2><br><p> ä¸€ç›´ä»¥æ¥ï¼Œä¸€ä»¶å°äº‹åœ¨æˆ‘çœ¼å‰é—ªè¿‡ï¼Œæˆ‘ä¸åœåœ°ä»æ—è¾¹æ è¿‡ã€‚ ä½†æ˜¯ï¼Œç”±äºä»€ä¹ˆéƒ½æ²¡æœ‰äº†ï¼Œæˆ‘å†³å®šçœ‹å¥¹ä¸€çœ¼ã€‚ æˆ‘è¯´çš„æ˜¯<code>&amp;&amp;</code>è¿ç®—ç¬¦ã€‚ å°½ç®¡<code>EXISTS</code>åªæ˜¯æé«˜äº†æ€§èƒ½ï¼Œä½†<code>&amp;&amp;</code>æ˜¯æ‰€æœ‰æ…¢é€ŸæŸ¥è¯¢ç‰ˆæœ¬ä¸­å”¯ä¸€å‰©ä¸‹çš„å…±åŒå› ç´ ã€‚ </p><br><p> æŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£</a> ï¼Œæˆ‘ä»¬å‘ç°å½“éœ€è¦æŸ¥æ‰¾ä¸¤ä¸ªæ•°ç»„ä¹‹é—´çš„å…¬å…±å…ƒç´ æ—¶<code>&amp;&amp;</code>ä½¿ç”¨<code>&amp;&amp;</code> ã€‚ </p><br><p> åœ¨åŸå§‹è¯·æ±‚ä¸­ï¼Œè¿™æ˜¯ï¼š </p><br><pre> <code class="plaintext hljs">AND ( urls &amp;&amp; array(select id from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%')::text[] )</code> </pre> <br><p> è¿™æ„å‘³ç€æˆ‘ä»¬å¯¹ç½‘å€è¿›è¡Œæ¨¡æ¿æœç´¢ï¼Œç„¶åæ‰¾åˆ°å…·æœ‰å…±äº«è®°å½•çš„æ‰€æœ‰ç½‘å€çš„äº¤é›†ã€‚ è¿™æœ‰ç‚¹ä»¤äººå›°æƒ‘ï¼Œå› ä¸ºæ­¤å¤„çš„â€œ URLâ€ä¸æ˜¯æŒ‡åŒ…å«æ‰€æœ‰URLçš„è¡¨ï¼Œè€Œæ˜¯æŒ‡<code>recording_data</code>è¡¨ä¸­çš„â€œ URLâ€åˆ—ã€‚ </p><br><p> éšç€å¯¹<code>&amp;&amp;</code>æ€€ç–‘çš„<code>&amp;&amp;</code> ï¼Œæˆ‘è¯•å›¾åœ¨<code>EXPLAIN ANALYZE</code>ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­æ‰¾åˆ°ç¡®è®¤ï¼ˆæˆ‘å·²ç»æœ‰ä¸€ä¸ªä¿å­˜çš„è®¡åˆ’ï¼Œä½†æ˜¯é€šå¸¸æ¯”å°è¯•ç†è§£æŸ¥è¯¢è®¡åˆ’è€…çš„ä¸é€æ˜æ€§æ¥è¿›è¡ŒSQLå®éªŒæ›´æ–¹ä¾¿ï¼‰ã€‚ </p><br><pre> <code class="plaintext hljs">Filter: ((urls &amp;&amp; ($0)::text[]) AND (r_time &gt; '2018-12-17 12:17:23+00'::timestamp with time zone) AND (r_time &lt; '2018-12-18 23:59:59+00'::timestamp with time zone) AND (duration &gt;= '5'::double precision) AND (num_of_pages &gt; 0)) Rows Removed by Filter: 52710</code> </pre> <br><p> ä»…æ¥è‡ª<code>&amp;&amp;</code>çš„å‡ è¡Œè¿‡æ»¤å™¨ã€‚ è¿™æ„å‘³ç€è¯¥æ“ä½œä¸ä»…æ˜‚è´µï¼Œè€Œä¸”æ‰§è¡Œäº†å¤šæ¬¡ã€‚ </p><br><p> æˆ‘é€šè¿‡éš”ç¦»æ¡ä»¶è¿›è¡Œäº†æ£€æŸ¥ </p><br><pre> <code class="plaintext hljs">SELECT 1 FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data_30 as recording_data_30, acc_{account_id}.sessions_30 as sessions_30 WHERE urls &amp;&amp; array(select id from acc_{account_id}.urls where url ILIKE '%enterprise_customer.com/jobs%')::text[]</code> </pre> <br><p> è¯¥è¯·æ±‚å¾ˆæ…¢ã€‚ ç”±äº<code>JOIN</code>å¾ˆå¿«ï¼Œå­æŸ¥è¯¢ä¹Ÿå¾ˆå¿«ï¼Œå› æ­¤ä»…<code>&amp;&amp;</code>è¿ç®—ç¬¦ä¿ç•™ã€‚ </p><br><p> è¿™åªæ˜¯ä¸€ä¸ªå…³é”®æ“ä½œã€‚ æˆ‘ä»¬å§‹ç»ˆéœ€è¦åœ¨URLä¸»è¡¨ä¸­è¿›è¡Œæœç´¢ï¼Œä»¥æŒ‰æ¨¡å¼è¿›è¡Œæœç´¢ï¼Œå¹¶ä¸”å§‹ç»ˆéœ€è¦æ‰¾åˆ°äº¤é›†ã€‚ æˆ‘ä»¬æ— æ³•ç›´æ¥æœç´¢urlæ¡ç›®ï¼Œå› ä¸ºè¿™äº›ä»…ä»…æ˜¯é“¾æ¥åˆ°<code>urls</code>æ ‡è¯†ç¬¦ã€‚ </p><br><h2> å¯»æ±‚è§£å†³æ–¹æ¡ˆ </h2><br><p>  <code>&amp;&amp;</code>æ…¢ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªé›†åˆéƒ½å¾ˆå¤§ã€‚ å¦‚æœæˆ‘å°†<code>urls</code>æ›¿æ¢ä¸º<code>{ "http://google.com/", "http://wingify.com/" }</code>åˆ™è¯¥æ“ä½œå°†ç›¸å¯¹è¾ƒå¿«ã€‚ </p><br><p> æˆ‘å¼€å§‹å¯»æ‰¾ä¸€ç§åœ¨ä¸ä½¿ç”¨<code>&amp;&amp;</code>æƒ…å†µä¸‹åœ¨Postgresä¸­è¿›è¡Œé›†åˆäº¤é›†çš„æ–¹æ³•ï¼Œä½†æ²¡æœ‰å–å¾—å¤ªå¤§çš„æˆåŠŸã€‚ </p><br><p> æœ€åï¼Œæˆ‘ä»¬å†³å®šç®€å•åœ°å•ç‹¬è§£å†³é—®é¢˜ï¼šç»™æˆ‘æ‰€æœ‰ä¸æ¨¡å¼åŒ¹é…çš„urlå­—ç¬¦ä¸²ã€‚ å¦‚æœæ²¡æœ‰å…¶ä»–æ¡ä»¶ï¼Œå®ƒå°†æ˜¯- </p><br><pre> <code class="plaintext hljs">SELECT urls.url FROM acc_{account_id}.urls as urls, (SELECT unnest(recording_data.urls) AS id) AS unrolled_urls WHERE urls.id = unrolled_urls.id AND urls.url ILIKE '%jobs%'</code> </pre> <br><p> ä»£æ›¿<code>JOIN</code>è¯­æ³•ï¼Œæˆ‘åªä½¿ç”¨äº†ä¸€ä¸ªå­æŸ¥è¯¢å¹¶æ‰©å±•äº†<code>recording_data.urls</code>æ•°ç»„ï¼Œä»¥ä¾¿å¯ä»¥å°†æ¡ä»¶ç›´æ¥åº”ç”¨äº<code>WHERE</code> ã€‚ </p><br><p> è¿™é‡Œæœ€é‡è¦çš„æ˜¯<code>&amp;&amp;</code>ç”¨äºæ£€æŸ¥ç»™å®šæ¡ç›®æ˜¯å¦åŒ…å«é€‚å½“çš„URLã€‚ æ–œè§†ä¸€ä¸‹ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æ­¤æ“ä½œåœ¨æ•°ç»„çš„å…ƒç´ ï¼ˆæˆ–è¡¨çš„è¡Œï¼‰ä¸­ç§»åŠ¨ï¼Œå¹¶åœ¨æ»¡è¶³æ¡ä»¶ï¼ˆåŒ¹é…ï¼‰æ—¶åœæ­¢ã€‚ çœ‹èµ·æ¥ä¸ä¸€æ ·å—ï¼Ÿ æ˜¯çš„ï¼Œå­˜åœ¨ã€‚ </p><br><p> ç”±äºå‘ç”Ÿè¿™ç§æƒ…å†µæ—¶å¯ä»¥ä»å­æŸ¥è¯¢çš„ä¸Šä¸‹æ–‡å¤–éƒ¨å¼•ç”¨<code>recording_data.urls</code> ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿”å›æˆ‘ä»¬çš„è€æœ‹å‹<code>EXISTS</code>å¹¶ç”¨å­æŸ¥è¯¢å°†å®ƒä»¬åŒ…è£…èµ·æ¥ã€‚ </p><br><p> å°†æ‰€æœ‰å†…å®¹ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æœ€ç»ˆçš„ä¼˜åŒ–æŸ¥è¯¢ï¼š </p><br><pre> <code class="plaintext hljs">SELECT count(*) FROM acc_{account_id}.urls as recordings_urls, acc_{account_id}.recording_data as recording_data, acc_{account_id}.sessions as sessions WHERE recording_data.usp_id = sessions.usp_id AND ( 1 = 1 ) AND sessions.referrer_id = recordings_urls.id AND r_time &gt; to_timestamp(1542585600) AND r_time &lt; to_timestamp(1545177599) AND recording_data.duration &gt;=5 AND recording_data.num_of_pages &gt; 0 AND EXISTS( SELECT urls.url FROM acc_{account_id}.urls as urls, (SELECT unnest(urls) AS rec_url_id FROM acc_{account_id}.recording_data) AS unrolled_urls WHERE urls.id = unrolled_urls.rec_url_id AND urls.url ILIKE '%enterprise_customer.com/jobs%' );</code> </pre><br><p> æœ€ç»ˆè¿è¡Œ<code>Time: 1898.717 ms</code>ç°åœ¨è¯¥åº†ç¥å—ï¼Ÿ </p><br><p> æ²¡é‚£ä¹ˆå¿«ï¼ é¦–å…ˆï¼Œæ‚¨éœ€è¦æ£€æŸ¥æ­£ç¡®æ€§ã€‚ æˆ‘å¯¹<code>EXISTS</code>ä¼˜åŒ–éå¸¸æ€€ç–‘ï¼Œå› ä¸ºå®ƒä¼šå°†é€»è¾‘æ›´æ”¹åˆ°æ›´æ—©çš„é˜¶æ®µã€‚ æˆ‘ä»¬å¿…é¡»ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰åœ¨è¯·æ±‚ä¸­æ·»åŠ éæ˜¾è€Œæ˜“è§çš„é”™è¯¯ã€‚ </p><br><p> ä¸€ä¸ªç®€å•çš„æ£€æŸ¥å°±æ˜¯å¯¹å¤§é‡ä¸åŒæ•°æ®é›†çš„æ…¢é€ŸæŸ¥è¯¢å’Œå¿«é€ŸæŸ¥è¯¢æ‰§è¡Œ<code>count(*)</code> ã€‚ ç„¶åï¼Œå¯¹äºä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œæˆ‘æ‰‹åŠ¨æ£€æŸ¥äº†æ‰€æœ‰ç»“æœçš„æ­£ç¡®æ€§ã€‚ </p><br><p> æ‰€æœ‰æ£€æŸ¥å‡å¾—å‡ºä¸€è‡´çš„ç§¯æç»“æœã€‚ æˆ‘ä»¬è§£å†³äº†ï¼ </p><br><h2> ç»éªŒæ•™è®­ </h2><br><p> ä»è¿™ä¸ªæ•…äº‹ä¸­å¯ä»¥å¸å–å¾ˆå¤šæ•™è®­ï¼š </p><br><ol><li> æŸ¥è¯¢è®¡åˆ’ä¸èƒ½è¯´æ˜å…¨éƒ¨å†…å®¹ï¼Œä½†å¯ä»¥æä¾›çº¿ç´¢ </li><li> ä¸»è¦å«Œç–‘äººå¹¶ä¸æ€»æ˜¯çœŸæ­£çš„ç½ªé­ç¥¸é¦– </li><li> å¯ä»¥æ‰“ç ´æ…¢æŸ¥è¯¢ä»¥éš”ç¦»ç“¶é¢ˆ </li><li> å¹¶éæ‰€æœ‰çš„ä¼˜åŒ–æœ¬è´¨ä¸Šéƒ½æ˜¯è¿˜åŸæ€§çš„ </li><li> å°½å¯èƒ½ä½¿ç”¨<code>EXIST</code>å¯ä»¥å¤§å¤§æé«˜ç”Ÿäº§ç‡ã€‚ </li></ol><br><h2> ç»“è®º </h2><br><p> æˆ‘ä»¬å°†è¯·æ±‚æ—¶é—´ä»å¤§çº¦24åˆ†é’Ÿç¼©çŸ­åˆ°äº†2ç§’-æå¤§åœ°æé«˜äº†æ€§èƒ½ï¼ å°½ç®¡è¿™ç¯‡æ–‡ç« å¾ˆå¤§ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰€åšçš„æ‰€æœ‰å®éªŒéƒ½æ˜¯åœ¨åŒä¸€å¤©è¿›è¡Œçš„ï¼Œå¹¶ä¸”æ ¹æ®ä¼°ç®—ï¼Œä¼˜åŒ–å’Œæµ‹è¯•éœ€è¦1.5åˆ°2ä¸ªå°æ—¶ã€‚ </p><br><p>  SQLæ˜¯ä¸€ç§å¾ˆæ£’çš„è¯­è¨€ï¼Œå³ä½¿ä¸æ€•å®ƒï¼Œä¹Ÿè¯·å°è¯•å­¦ä¹ å’Œä½¿ç”¨ã€‚ å……åˆ†äº†è§£SQLæŸ¥è¯¢çš„æ‰§è¡Œæ–¹å¼ï¼Œæ•°æ®åº“å¦‚ä½•ç”ŸæˆæŸ¥è¯¢è®¡åˆ’ï¼Œç´¢å¼•å¦‚ä½•å·¥ä½œä»¥åŠä»…å¤„ç†è¦å¤„ç†çš„æ•°æ®å¤§å°ï¼Œæ‚¨å°±å¯ä»¥åœ¨æŸ¥è¯¢ä¼˜åŒ–ä¸­å¤§è·æˆåŠŸã€‚ ä½†æ˜¯ï¼ŒåŒæ ·é‡è¦çš„æ˜¯ï¼Œç»§ç»­å°è¯•ä¸åŒçš„æ–¹æ³•å¹¶æ…¢æ…¢è§£å†³é—®é¢˜ï¼Œæ‰¾åˆ°ç“¶é¢ˆã€‚ </p><br><p> è·å¾—æ­¤ç±»ç»“æœçš„æœ€å¥½çš„éƒ¨åˆ†æ˜¯æ˜æ˜¾çš„é€Ÿåº¦æ”¹è¿›-ä»¥å‰ä»æœªä¸‹è½½è¿‡çš„æŠ¥å‘Šç°åœ¨å‡ ä¹ç«‹å³å¯ä»¥åŠ è½½ã€‚ </p><br><p>  <strong>ç‰¹åˆ«æ„Ÿè°¢</strong>æˆ‘çš„é˜Ÿå‹<em>Aditya Misra</em> ï¼Œ <em>Aditya Gauru</em>å’Œ<em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Varun Malhotra</a></em>çš„é›†æ€å¹¿ç›Šï¼Œä»¥åŠ<em>Dinkar Pandir</em>åœ¨æˆ‘ä»¬æœ€ç»ˆè¦æ±‚ä¸­å‘ç°äº†é‡è¦é”™è¯¯ï¼Œç„¶åæ‰å‘ä»–é“åˆ«ï¼ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN455832/">https://habr.com/ru/post/zh-CN455832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN455816/index.html">å¦‚ä½•ä¸ºGoogle Assistantåˆ›å»ºé…·ç‚«çš„åŠ¨ä½œã€‚ Just AIçš„Lifehacks</a></li>
<li><a href="../zh-CN455820/index.html">VMware vSphereä¸­çš„VMæ€§èƒ½åˆ†æã€‚ ç¬¬2éƒ¨åˆ†ï¼šè®°å¿†</a></li>
<li><a href="../zh-CN455826/index.html">é¥æ§è‡ªåŠ¨æµ‡æ°´</a></li>
<li><a href="../zh-CN455828/index.html">ç§‘å­¦å®¶å‘ç°äº†æ–°çš„å¼‚å›½åŒæ­¥å½¢å¼</a></li>
<li><a href="../zh-CN455830/index.html">çœ‹ä¸€ä¸‹.NETå¼€å‘äººå‘˜çš„çœ¼å…‰ã€‚ ç¬¬ä¸€å‘¨</a></li>
<li><a href="../zh-CN455834/index.html">LinuxæœåŠ¡å™¨åŸºå‡†æµ‹è¯•ï¼š5ä¸ªå¼€æ”¾å·¥å…·</a></li>
<li><a href="../zh-CN455840/index.html">å¦‚ä½•å¤„ç†å¤šä¸ªæŸ¥è¯¢ã€‚ ç»„æˆï¼Œè¿˜åŸå‰‚ï¼ŒFP</a></li>
<li><a href="../zh-CN455842/index.html">ä¼ æ’­ä¸€ä¸ªå•é“¾è¡¨ã€‚ è¿…æ·ç‰ˆ</a></li>
<li><a href="../zh-CN455846/index.html">Juliaä¸­çš„åˆ†å¸ƒå¼è®¡ç®—</a></li>
<li><a href="../zh-CN455848/index.html">è®¿é—®å•ä¾‹æ—¶é¿å…æœªå®šä¹‰è¡Œä¸ºçš„æŠ€æœ¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>