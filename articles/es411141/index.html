<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¢ ‚ñ´Ô∏è üçí "Casa inteligente" en Arduino para una casa de cambio üîã üë®‚Äçüîß üôè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nada fuera de lo com√∫n, solo otro controlador Arduino. Con sensores, carretes y una p√°gina web. Pero con sus propias caracter√≠sticas y una aplicaci√≥n ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Casa inteligente" en Arduino para una casa de cambio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411141/"><img src="https://habrastorage.org/webt/7o/3k/or/7o3kora9koagtgemf_xxr71mlkk.jpeg"><br><br>  Nada fuera de lo com√∫n, solo otro controlador Arduino.  Con sensores, carretes y una p√°gina web.  Pero con sus propias caracter√≠sticas y una aplicaci√≥n pr√°ctica muy espec√≠fica, aunque bastante banal: la inclusi√≥n remota de calefacci√≥n el√©ctrica en el pa√≠s.  Las comillas en el encabezado no son aleatorias, el controlador no es un hogar inteligente en la versi√≥n actual, pero sirve como una buena base para ello.  <i>(nota: esta frase se agreg√≥ el 12/04/18 en funci√≥n de los comentarios).</i> <br><br>  Caracter√≠sticas clave <br><br><ul><li>  Sensor de par√°metros de la red el√©ctrica - medidor el√©ctrico "Neva" seg√∫n RS-485; </li><li>  Modificaci√≥n remota de la p√°gina web de control que se encuentra en la tarjeta SD; </li><li>  Inclusi√≥n confiable de un grupo de sensores de temperatura de Dallas en largas filas; </li><li>  Gr√°ficos de cambios de par√°metros sin involucrar servicios en la nube; </li><li>  Soluciones a prueba de fallas (vigilancia externa, UPS, reinicio autom√°tico del enrutador); </li><li>  Protecci√≥n del escudo de Internet contra la congelaci√≥n durante la interferencia de los rel√©s de potencia; </li><li>  Dise√±o completo en una caja de riel DIN. </li></ul><a name="habracut"></a><br>  Hice este sistema lentamente, como entretenimiento, de vez en cuando lanzando el proyecto durante meses ... Tom√≥ aproximadamente un a√±o y medio desde la idea hasta la implementaci√≥n :) <br><br>  Como antes no ten√≠a nada que ver con los microcontroladores, comenc√© con el kit de inicio con aliexpress, jugu√© con LED, botones y sensores, entend√≠ algo y comenc√© a construir un controlador para control y monitoreo remoto.  Bueno, la "casa inteligente" no es directa, por supuesto, sino algo as√≠. <br><br>  El objetivo pr√°ctico fue establecer primero uno: encender de forma remota la calefacci√≥n en el pa√≠s.  Todav√≠a no he logrado construir una casa (mis manos no llegaron, eh), pero tengo una maravillosa y c√≥moda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">caba√±a de verano</a> en carne picada calentada por convectores el√©ctricos.  Calienta una casa de cambio que se ha enfriado durante la semana el viernes por la noche, una oportunidad muy tentadora en la temporada de fr√≠o. <br><br>  Sin embargo, la tarea de control de carga remota result√≥ ser bastante trivial.  Arduino m√°s el escudo de Internet, un boceto listo para usar de Internet, y los carretes ya hacen clic en las marcas de verificaci√≥n en la p√°gina web.  El objetivo pr√°ctico se logr√≥ de alguna manera muy r√°pida y sencilla.  Y fue aburrido.  Quer√≠a algo m√°s interesante <br><br>  Me propuse un segundo objetivo pr√°ctico: monitorear el consumo actual en la red de caba√±as de verano.  Obtuve sensores de corriente sin pretensiones para las pruebas, jugu√©.  Todo funcion√≥ bien, pero esta opci√≥n no era adecuada para el trabajo de combate.  No pude encontrar sensores m√°s potentes que en 5A, pero necesitaba al menos 25A. <br><br>  Y tuve la idea de usar un medidor de electricidad como sensor de potencia.  ¬°Y fue un gran pensamiento!  ¬°Y cre√© un dispositivo as√≠, y vi que era bueno!  No sin dificultades, pero complet√© esta tarea perfectamente, como resultado, con un sentimiento de profunda satisfacci√≥n, y lo contar√© a continuaci√≥n :). <br><br>  <b>Funcional</b> <br><br>  La primera (y hasta ahora la √∫ltima) versi√≥n de combate del controlador "casa inteligente" tiene esta funcionalidad: <br><br><ul><li>  Control manual remoto de la activaci√≥n del rel√© de potencia a trav√©s de un navegador y monitoreo de su estado actual; </li><li>  Monitoreo remoto de los par√°metros de una red de suministro de energ√≠a trif√°sica (voltaje, corriente, frecuencia y muchos m√°s elementos innecesarios, que luego apagu√©); </li><li>  Monitoreo remoto de las lecturas de un medidor de electricidad de dos tarifas; </li><li>  Monitoreo remoto de un grupo de sensores de temperatura; </li><li>  Registro de datos y grabaci√≥n de eventos en una tarjeta de memoria; </li><li>  Visualice en el navegador los datos de todos los sensores para el d√≠a seleccionado en forma de gr√°ficos. </li></ul><br>  <b>Ideologia</b> <br><br>  El principio de construir todo el sistema, sin usar servicios en la nube de terceros y servidores de recopilaci√≥n y visualizaci√≥n de datos.  Esto no es ni bueno ni malo.  En la etapa inicial de "construcci√≥n inteligente", este esquema es suficiente y simple.  Aunque impone ciertas restricciones de uso. <br><br>  Arduino con un escudo de Internet es el √∫nico servidor web en el sistema.  La p√°gina web con la interfaz de administraci√≥n se almacena en la tarjeta de memoria de Internet y se transmite al navegador cuando se accede mediante la direcci√≥n IP especificada.  La interacci√≥n adicional de la interfaz de usuario con Arduino se lleva a cabo a trav√©s de scripts java, cuyos cuerpos no est√°n incrustados en la p√°gina web, sino que se almacenan en el almacenamiento de archivos de mi casa con acceso a Internet.  Este enfoque reduce el peso de la p√°gina web, lo que acelera su lectura desde la tarjeta SD, y le permite modificar el c√≥digo del script de manera m√°s r√°pida y f√°cil. <br><br>  La lectura del registro de datos para mostrar gr√°ficos se realiza desde la tarjeta de memoria a pedido (presionando un bot√≥n en un navegador).  Los datos se muestran solo en la sesi√≥n actual de la p√°gina del navegador, no se guardan en ning√∫n lugar y, cuando vuelve a cargar la p√°gina, debe volver a leerla.  Esto es una desventaja de la ideolog√≠a, ya que leer desde una tarjeta de memoria es bastante lento, y obtener una cantidad diaria de datos puede tomar uno o dos minutos (hubo una idea de reelaborar el formato de almacenamiento de datos para reducir su tama√±o y acelerar la lectura). <br><br>  Los valores actuales de los sensores se muestran en la p√°gina y se actualizan en tiempo real con la frecuencia del ciclo de bucle, que tengo es aproximadamente 1 Hz. <br><br>  No hay "inteligencia" en el algoritmo ahora.  Si advertir√© el algoritmo en el futuro, no lo s√©, por ahora la versi√≥n actual es completamente satisfactoria para m√≠. <br><br>  <b>Topolog√≠a de red</b> <br><br>  En la caba√±a, Internet m√≥vil Yota (m√≥dem usb + enrutador wifi).  No hay una direcci√≥n IP fija, y tampoco hay forma de obtenerla, ni siquiera por dinero.  E incluso no hay una direcci√≥n IP blanca din√°mica, por lo que DynDNS no es aplicable.  Solo la direcci√≥n IP gris de la red interna de Yota.  IPota Yota no es compatible (al menos para 2017 este es el caso).  Por lo tanto, encontr√© solo una forma de llegar al enrutador del pa√≠s desde el exterior: VPN. <br><br>  En casa (en la ciudad), Internet por cable con una direcci√≥n IP fija blanca.  Enrutador, seguido de almacenamiento en red.  Se ha generado un servidor VPN en este enrutador dom√©stico.  El enrutador del pa√≠s est√° configurado para elevar el t√∫nel VPN PPTP al enrutador dom√©stico. <br><br>  El controlador en Arduino est√° conectado al puerto LAN del enrutador del pa√≠s y se encuentra detr√°s de NAT, el puerto 80 se le reenv√≠a.  Por lo tanto, puedo acceder a Arduino solo desde mi VPN.  En consecuencia, la LAN dom√©stica y la VPN que tengo son dos segmentos de la misma subred, el acceso es directo all√≠.  En su computadora de trabajo y en un tel√©fono inteligente, configur√≥ una conexi√≥n VPN y tambi√©n obtuvo acceso a Arduino.  No es muy conveniente de usar, pero funciona.  S√≠, y se proporciona seguridad relativa: sin autorizaci√≥n en mi VPN, nadie m√°s puede acceder a la p√°gina de administraci√≥n del controlador. <br><br>  El cuello de botella es el t√∫nel VPN al enrutador del pa√≠s.  Cae peri√≥dicamente.  Adem√°s, es la conexi√≥n PPTP la que est√° siendo interrumpida, el acceso a Internet permanece.  Y lo peor es que cuando la conexi√≥n PPTP se interrumpe, ya no se eleva por s√≠ sola.  Incluso reiniciar el enrutador no se guarda.  Solo un reinicio completo de su fuente de alimentaci√≥n con un m√≥dem USB, y luego no de inmediato.  Debe apagarlo, esperar 10 minutos y volver a encenderlo.  Suerte - bueno, no - la pr√≥xima iteraci√≥n.  La raz√≥n, seg√∫n el soporte t√©cnico de Zyxel, es que el operador celular bloquea los paquetes PPTP, ya que un lado env√≠a correctamente, el otro escucha correctamente, pero los datos no llegan (tengo enrutadores Zyxel en ambos extremos del t√∫nel VPN).  Yota parece ser el culpable, pero lograr algo inteligible de ellos es imposible.  O tal vez no Yota. <br><br>  <b>Perro guardi√°n</b> <br><br>  Para garantizar un funcionamiento relativamente fluido de la VPN, utilizo un perro guardi√°n del programa de <strike>muletas</strike> : el enrutador del pa√≠s se alimenta a trav√©s de un rel√© de potencia controlado por Arduina, y tan pronto como el servidor VPN deja de hacer ping (tambi√©n hace ping a Arduina), luego de 10 minutos, se corta la alimentaci√≥n del enrutador durante 10 minutos, luego el enrutador nuevamente Se enciende y se espera que establezca una conexi√≥n PPTP en 5 minutos.  Si no hay conexi√≥n, la siguiente iteraci√≥n.  A veces, este compuesto funciona de manera estable durante semanas e incluso meses, y a veces comienza a romperse casi a diario.  Todav√≠a no se ha visto ninguna otra forma de resolver el problema.  Como ya dije, Yota no es compatible con IPv6, no da ni vende IP blanca a los f√≠sicos, no hay otro proveedor con tarifas normales y ciertamente no hay tr√°fico ilimitado.  Sin embargo, esta decisi√≥n, aunque una muleta, pero realiza su tarea muy bien.  Ahora siempre tengo una conexi√≥n, con muy pocas excepciones, cuando llego al momento de reiniciar. <br><br>  Adem√°s del software, tambi√©n implement√© un watchdog de hardware.  Por si acaso.  El controlador deber√≠a funcionar durante semanas e incluso a veces durante meses en ausencia de m√≠, y no colgarse.  No sab√≠a c√≥mo se comportar√≠a toda esta econom√≠a en grandes desventajas, as√≠ que estaba a salvo.  El perro guardi√°n incorporado en Atmega no funcion√≥ para m√≠ porque no trabajaba en Arduino Mega "fuera de la caja" en absoluto, y para que funcionara tuve que divertirme mucho.  Este problema est√° bien descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Adem√°s, tiene un intervalo m√°ximo de 8 segundos, lo que me pareci√≥ insuficiente.  Por lo tanto, utilic√© un chip temporizador de vigilancia especializado TPL5000DGST, cuyo intervalo se establece mediante una combinaci√≥n de tres pines y puede alcanzar los 64 segundos, lo que me conviene perfectamente.  Para este chip compr√© una peque√±a placa de prueba, la solde y la fije en el conector con los puertos IO de Arduina (la foto estar√° m√°s abajo en la secci√≥n de ensamblaje).  Las pruebas mostraron el funcionamiento confiable de este perro guardi√°n, y me preguntaba con qu√© frecuencia funcionar√° en realidad.  Para hacer esto, agregu√© una variable al c√≥digo del programa donde se almacena la hora y la fecha en que se inici√≥ el programa, y ‚Äã‚Äãesta informaci√≥n se muestra en la p√°gina web de control.  La pr√°ctica ha demostrado que, a diferencia de una VPN, el controlador funciona sin problemas durante mucho tiempo y el temporizador de vigilancia nunca ha sido √∫til (al escribir el art√≠culo, funcion√≥ por primera vez, no fue en vano).  El tiempo de operaci√≥n continua alcanz√≥ m√°s de 3 meses y podr√≠a haber sido m√°s si no tuviera que corregir algo en el c√≥digo de vez en cuando y volver a actualizar el controlador. <br><br>  <b>El sensor de par√°metros de la red de suministro de energ√≠a: el medidor el√©ctrico Neva</b> <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/845/f35/bd5/845f35bd5d12bc60384f1aa0bb1506aa.jpg" width="200"></a> <br><br>  Como mencion√© anteriormente, en mi opini√≥n, nada mejor y m√°s preciso que un medidor de electricidad digital moderno con una interfaz de acceso a datos externos se puede encontrar como un sensor de los par√°metros de red de la fuente de alimentaci√≥n.  Eleg√≠ el mostrador Neva de la compa√±√≠a Taypit de San Petersburgo con la interfaz RS-485. <br><br>  Destaco que un medidor el√©ctrico con cables de la interfaz 485 conectada permanentemente a √©l no est√° oficialmente permitido para usarse como medidor ( <b>actualizaci√≥n</b> : en los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comentarios</a> sugirieron que estaba permitido).  Por lo tanto, en la red el√©ctrica de la caba√±a, puse dos contadores en serie.  El primero es un medidor de electricidad oficial, sellado y registrado, ubicado en el panel de entrada de la calle.  El segundo es mi sensor de fuente de alimentaci√≥n, sin sellar y sin contabilizar, que a la compa√±√≠a de ventas de energ√≠a no le importa, porque no le importa todo lo que se instala despu√©s del dispositivo de medici√≥n.  Este medidor el√©ctrico ya est√° ubicado en el panel dentro de la casa de cambio, y en el mismo panel tambi√©n hay un controlador en Arduino, pero m√°s sobre eso m√°s adelante. <br><br>  En la caba√±a tengo una red de suministro de energ√≠a trif√°sica.  En la ciudad, solo puedo depurar en una sola fase.  Por lo tanto, adquir√≠ dos metros, un Neva MT-324 trif√°sico y un Neva MT-124 monof√°sico.  La depuraci√≥n inicial del controlador se realiz√≥ en la mesa en un medidor trif√°sico con una sola fase conectada, luego se instal√≥ nominalmente en el tablero de la caba√±a en modo de operaci√≥n de combate.  La depuraci√≥n de modificaciones de software posteriores ya se realiz√≥ en un contador monof√°sico m√°s barato en la tabla: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/a5a/5cb/6fb/a5a5cb6fb932dea11badc7f06376e22d.jpg" width="640"></a> <br><br>  Para conectar el medidor a Arduino, se requiere un convertidor de nivel RS-485 a TTL: <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/258/07f/e5a/25807fe5acb55ec27d079d024a24b1f0.jpg" width="200"></a> <br><br>  Adem√°s, para trabajar con el contador, necesita un puerto serie libre en Arduino.  Desafortunadamente, Arduino Uno solo tiene un puerto serie, si lo toma bajo el mostrador, tendr√≠a que perder la salida de depuraci√≥n de la informaci√≥n de texto (monitor de puerto), y sin esto ser√≠a imposible escribir un boceto.  Por lo tanto, uso Arduino Mega, que tiene varios puertos seriales.  Ser√≠a posible implementar el segundo puerto serie softovo a trav√©s de los puertos digitales de Arduino, pero no encontr√© una biblioteca adecuada con la capacidad de cambiar otras configuraciones de puerto, excepto la velocidad.  Y la configuraci√≥n del puerto del contador es diferente de la predeterminada: velocidad de 9600 bits, 7 bits de datos, 1 bit de parada, control de paridad, incluso.  El objeto serial est√°ndar en Arduino, afortunadamente, le permite realizar esta configuraci√≥n. <br><br>  Fue relativamente f√°cil obtener el protocolo de intercambio con el contador: el fabricante del contador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el dominio p√∫blico</a> tiene un programa para leer par√°metros en Windows, que tambi√©n tiene un monitor de puerto.  Para conectar el medidor a una computadora, utilic√© el convertidor de interfaz MOXA 232/432 / 485USB.  Alg√∫n tiempo para el an√°lisis visual de los paquetes, y seleccion√© los comandos principales. <br><br>  Sin embargo, esto no me pareci√≥ suficiente y contact√© al fabricante por correo electr√≥nico.  Despu√©s de un mes de correspondencia con Typit, finalmente logr√© obtener una lista completa de comandos con interpretaci√≥n: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Codificaci√≥n de par√°metros MT3XX E4S</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Codificaci√≥n de par√°metros NEVA MT124 AS OP (E4P)</a> <br><br>  <b>actualizaci√≥n 28.10.2019</b> : explicaciones de los comandos.  Los comandos en la tabla se representan como caracteres de texto.  Es decir, donde cuesta 0 (cero), debe enviar 0x30.  Los puntos y asteriscos son separadores de belleza, no significan nada y no es necesario enviarlos.  Al final del comando, se agrega un byte de suma de comprobaci√≥n, que se calcula teniendo en cuenta el prefijo y el postfix del comando, que no se indican en la tabla.  El prefijo para todos los comandos de lectura es 0x01 0x52 0x31 0x02.  Este postfix es 0x28 0x29 0x03.  Sin embargo, no es necesario enviar un prefijo, y un postfix parece ser obligatorio.  Ejemplo: comando de lectura de fecha 09.09.02 * FF.  En realidad, debe pasar los c√≥digos de caracteres de texto 000902FF.  Es decir, 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46.  Agregue el prefijo y el postfix, obtenemos el conjunto 0x01 0x52 0x31 0x02 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03.  Leemos la suma de comprobaci√≥n como xor de todos los bytes menos 1 y agregamos el byte recibido al final.  El prefijo se descarta como opcional.  Como resultado, lo enviamos al mostrador: 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03 0x68.  El comienzo del ciclo de intercambio debe estar precedido por los comandos de inicializaci√≥n de intercambio, en el siguiente esquema, estos comandos est√°n marcados como // Inicio 1, 2, 3. Una vez que se inicializa el intercambio, puede leer los datos del contador en el ciclo durante un tiempo arbitrariamente largo, pero despu√©s de perder la comunicaci√≥n y quiz√°s despu√©s de una prolongada falta de intercambio por otras razones, se necesita reinicializar. <br><br>  Adem√°s, la cuesti√≥n t√©cnica es escribir un ciclo de sondeo de par√°metros en Arduino y mostrarlos para empezar en el monitor de puerto.  El tiempo de un ciclo fue de aproximadamente un segundo.  Sin embargo, en la versi√≥n final del proyecto con registro de datos en una unidad flash y sensores de temperatura de sondeo, este tiempo aument√≥ a 4 segundos.  Esto no me conven√≠a en absoluto y tuve que sumergirme en la optimizaci√≥n.  Como resultado, nuevamente logr√© un segundo intervalo sin perder funcionalidad.  Por cierto, reescrib√≠ el boceto desde cero dos o tres veces hasta que encontr√© la arquitectura correcta y los algoritmos econ√≥micos. <br><br>  <b>Implementaci√≥n de software de intercambio con un contador</b> <br><br>  El c√≥digo se extrae del contexto de mi gran boceto de trabajo.  Compilado, pero de esta forma, nunca lo ejecut√©.  Lo doy solo como un ejemplo, y no como un programa de trabajo terminado.  Aunque en teor√≠a todo deber√≠a funcionar de esta forma. <br><br>  El c√≥digo est√° escrito para dos tipos de contadores simult√°neamente, el monof√°sico MT-124 y el trif√°sico MT-324.  El tipo de contador se selecciona en el programa autom√°ticamente mediante la palabra de respuesta del comando de inicializaci√≥n. <br><br>  Cito el c√≥digo tal como est√°, sin belleza y sin comentarios adicionales, excepto los que escrib√≠ para m√≠.  Y s√≠, no soy un programador, y ni siquiera estudio para ello, as√≠ que no deber√≠as echarme por la calidad del c√≥digo, pero puedes aprender a codificar: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">EnergyMeterNeva.ino</a> <br><br>  Una gran ventaja adicional del medidor de electricidad es un reloj confiable y preciso en tiempo real.  No tuve que proporcionarle al sistema un m√≥dulo adicional, que a√∫n debe encontrarse no solo de todos modos, sino de alta calidad.  La hora actual precisa al segundo que obtengo del contador, entre otros datos.  S√≠, con respecto al tiempo at√≥mico, el tiempo del contador cambia ligeramente (unos segundos), no s√© con qu√© est√° conectado, una configuraci√≥n de f√°brica de baja calidad u otra cosa, pero la precisi√≥n es excelente, solo con un ligero sesgo. <br><br>  En raros momentos, cuando se apaga la electricidad en la caba√±a y el medidor deja de estar disponible, obtengo la hora actual del temporizador interno de Arduina.  Cuando el medidor el√©ctrico est√° funcionando y sus datos est√°n disponibles, reescribo el temporizador interno de Arduina con el valor del medidor en cada bucle de bucle.  Cuando el contador se cae, la hora actual sigue marcando el temporizador Arduina. <br><br>  Adem√°s de leer los par√°metros, el contador, por supuesto, se puede programar.  Es decir, la interfaz funciona tanto para leer como para escribir.  Sin embargo, con tales dificultades, estaba tratando de obtener un protocolo para leer comandos que ni siquiera insinu√© al fabricante sobre la solicitud de un protocolo de grabaci√≥n.  En primer lugar, no lo necesitaba, excepto tal vez solo un poco de tiempo para moverlo.  En segundo lugar, sospecho que estos datos ya no son p√∫blicos, ya que pueden utilizarse con fines fraudulentos. <br><br>  <b>Sensores de temperatura</b> <br><br>  Ya realic√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una</a> prueba de sensores de temperatura con un ejemplo de boceto por separado anteriormente.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora solo quedaba integrar su encuesta en el proyecto principal. No fue dificil. Los nueve sensores que he trabajado funcionaron sin problemas cuando encend√≠ 1-Wire en paralelo. El rango de lecturas entre ellos fue de aproximadamente 0.5 grados, lo que muestra la inutilidad de usarlos con una precisi√≥n m√°xima de 0.0625 grados. Recog√≠ los sensores para la prueba en un paquete y lo envolv√≠ en varias capas de polietileno adhesivo. Para mayor precisi√≥n, coloqu√© el paquete verticalmente y esper√© un d√≠a para igualar completamente la temperatura. Las lecturas de todos los sensores no resultaron iguales.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, no comenc√© a arruinar la precisi√≥n de convertir la temperatura de los sensores mismos. Es m√°s f√°cil redondear las lecturas mediante programaci√≥n, y no obtendr√≠a los beneficios desde el momento de la encuesta, ya que se me ocurri√≥ un algoritmo en el que el tiempo de espera de conversi√≥n no es un retraso in√∫til vac√≠o (750). La l√≥gica habitual para trabajar con sensores es emitir primero un comando para iniciar la conversi√≥n de temperatura, luego esperar a que termine la conversi√≥n (esos mismos 750 ms como m√≠nimo) y luego leer los datos. Hice lo contrario, lo que me permiti√≥ excluir un intervalo de espera vac√≠o: primero le√≠ los datos de los sensores y luego comenc√© inmediatamente la conversi√≥n. Y aunque todo el resto del c√≥digo en el ciclo LOOP funcionar√°, los datos solo tienen tiempo para prepararse para la lectura en la pr√≥xima ronda. Con el tiempo, obtengo los datos de los sensores en este caso un poco m√°s tarde: el ciclo LOOP dura aproximadamente 1-1.5 segundos, pero esto no es absolutamente cr√≠tico.</font></font><br><br>        ¬´85¬ª  ¬´0¬ª.    ,     ,            .        ‚Äî       .      ,    .      ,      (   )    . <br><br>        -, -     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DS18x20_Temperature.ino</a> <br><br>                    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TempSensors_DS18B20.ino</a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para el correcto funcionamiento de los sensores en el bus de 1 cable, se debe instalar una resistencia pull-up de 4.7 kŒ© entre la l√≠nea de datos y la fuente de alimentaci√≥n. Fue conveniente para m√≠ soldar una resistencia SMD entre los pines del bloque de terminales, pero encontr√© solo 5.1 kOhm en un estuche adecuado y lo puse (es visible en la foto en la secci√≥n de ensamblaje en el lado inferior de la placa). Todo funciona bien</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mis sensores de temperatura est√°n conectados el√©ctricamente en paralelo en una l√≠nea larga (+5, gnd y datos), las 9 piezas, pero complicado. F√≠sicamente, los cables de par trenzado est√°n conectados por una estrella para la conveniencia de cablear sensores alrededor del objeto. Yo uso dos pares en cada brazo de cable. Un par es la potencia del sensor. El segundo par es una l√≠nea de datos que atraviesa un cable hasta el sensor y regresa a trav√©s del segundo cable. Por lo tanto, es posible separar los cables con una estrella del escudo, pero el√©ctricamente es una estrella solo en potencia, y seg√∫n los datos es una l√≠nea. Esta opci√≥n de conexi√≥n result√≥ ser m√°s confiable al trabajar en l√≠neas largas, con una conexi√≥n paralela simple, hubo muchas fallas al leer los datos. Aqu√≠ hay un bosquejo de tal esquema:</font></font><br><br> <a href=""><img height="300" src="https://habrastorage.org/getpro/habr/post_images/84e/1a3/b3d/84e1a3b3d64983af4236a6dad5458a52.jpg" width="640"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No acort√© las colas de medio metro de los cables de tres hilos de los sensores, las conect√© tal como estaban, result√≥ que no era cr√≠tico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En total, hay tres cables para las cabinas, dos para sensores externos, uno para cada uno y uno para los siete restantes internos. Estos siete sensores internos est√°n conectados de la misma manera, pero dentro de un cable largo y con ramas cortas (ver la forma de T inferior en el boceto). En alg√∫n lugar hab√≠a suficiente cola est√°ndar de medio metro del sensor para ramificar, en alg√∫n lugar se ramific√≥ con la ayuda del mismo par trenzado.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Circuito de conmutaci√≥n del sensor de dos hilos, con el llamado No utilic√© energ√≠a parasitaria (cuando los sensores reciben energ√≠a a trav√©s de la l√≠nea de datos) porque ... ¬øpor qu√©? En cualquier caso, tomar√≠a cables de cuatro pares, simplemente porque los ten√≠a. No hay problemas al tender el cable en las cabinas. Y el circuito de suministro de energ√≠a par√°sito es cr√≠tico para la cantidad de corriente consumida en algunos modos de operaci√≥n, podr√≠an surgir problemas innecesarios.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La longitud total del par trenzado en las caba√±as era de aproximadamente 25 metros. Piezas para sensores externos: 5 y 10 metros, y una pieza interna de diez metros con ramas para siete sensores. Todo funciona casi a la perfecci√≥n. Solo ocasionalmente se cruzan guiones en lugar de valores de temperatura. Esto significa que los datos de un sensor en particular no se leyeron correctamente. Pero esto ocurre tan raramente (me doy cuenta una vez al mes tal vez) que no causa ning√∫n problema. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escudo de Ethernet de </font><b><font style="vertical-align: inherit;">acceso remoto</font></b><font style="vertical-align: inherit;"> se compr√≥ para acceso remoto a Arduino. Con una biblioteca incorporada, trabajar con ella, como todo lo dem√°s en Arduino, result√≥ ser bastante simple.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funcionalmente, mi esquema de trabajo es el siguiente. Se ha creado un servidor web en Arduino que, cuando un cliente (navegador) accede a √©l, genera una p√°gina web con informaci√≥n diversa. La actualizaci√≥n autom√°tica de los datos en la p√°gina se implementa mediante el sondeo de JavaScript del servidor por temporizador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La p√°gina tambi√©n tiene un conjunto de controles para controlar los actuadores conectados a Arduino - rel√©s de potencia que cambian la carga - calentadores el√©ctricos e iluminaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No tom√© un ba√±o de vapor con el dise√±o de la p√°gina web, especialmente porque se necesitaba una cantidad m√≠nima de datos de texto para cargarla m√°s r√°pido, por lo tanto, el html m√°s primitivo y eso es todo:</font></font><br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/1e0/2fa/c9e/1e02fac9e6e1e8c5a16d0a7c07667f94.png" width="475"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En lugar de datos, incrust√© etiquetas en el c√≥digo html, que al momento son reemplazadas por datos reales cuando el servidor genera la p√°gina. Cuando los datos se actualizan autom√°ticamente a pedido de javascript, se transfieren al navegador directamente desde el microcontrolador en formato JSON. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo de la p√°gina se encuentra en un archivo en la tarjeta de memoria y se carga al acceder al servidor. Para una modificaci√≥n m√°s r√°pida y conveniente del c√≥digo de la p√°gina, incorpor√© el mecanismo para actualizarlo yo mismo. En la parte inferior, debajo del bloque de controles b√°sicos, hay un cuadro de texto y un bot√≥n Enviar. Copio el nuevo c√≥digo html en el campo de texto, presiono el bot√≥n, despu√©s de lo cual el script java env√≠a datos al servidor web del controlador, que primero lo guarda en un archivo en spool. Si la transferencia se realiz√≥ correctamente, el archivo principal se reemplaza por un b√∫fer y la p√°gina se actualiza autom√°ticamente.</font></font> Eso es todo.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambios aceptados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cito los fragmentos de c√≥digo de mi implementaci√≥n de este mecanismo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la p√°gina html incorporamos el formulario:</font></font><br><br><pre><code class="plaintext hljs">&lt;script type="text/javascript" src="http://domain/send_HTM.js"&gt;&lt;/script&gt;&lt;/pre&gt; &lt;pre style="font-size: 14px;"&gt;&lt;form&gt; &lt;br&gt;&lt;br&gt; CONTROL.HTM:&lt;br&gt; &lt;textarea cols="100" rows="20" wrap="off" id="htm"&gt;&lt;/textarea&gt;&lt;br&gt; &lt;input type="button" value="" onclick="send_HTM();"&gt;&lt;br&gt; &lt;div id="progress" style="display:none"&gt; &lt;div id="label"&gt;  :&lt;/div&gt; &lt;div style="width:800px;border:1px solid #000"&gt; &lt;div id="bar" style="background:#00f;height:10px;width:0px"&gt;&lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/form&gt;</code> </pre> <br>  El bot√≥n "Enviar" inicia el siguiente script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Java</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">send_HTM.js</a> <br><br>  En el boceto en la funci√≥n para procesar solicitudes de servidor web por prefijos en la solicitud 'CONTROL.HTM' (comenzar a enviar el archivo), 'htmlineN' (enviar l√≠nea No.) y 'END_CONTROL.HTM' (finalizar el env√≠o del archivo), determinamos las siguientes acciones: <br><br><pre> <code class="plaintext hljs">File acceptHtmFile; ................ if (fl_accept_htm) //  'CONTROL.HTM' { SD.remove(CTRL_HTM); acceptHtmFile = SD.open(CTRL_HTM, FILE_WRITE); //     if (!acceptHtmFile) //      -    { #ifdef DEBUG_SD Serial.println("SD-card not found"); #endif client.print("FAIL"); client.stop(); } else client.print("OK_OPEN_FILE"); acceptHtmMode = true; break; } if (fl_htmline) //  'htmlineN' { int b = acceptHtmFile.println(tag); if (b == 0) { client.print("FAIL"); acceptHtmMode = false; cntHtmModeIteration = 0; } else { client.print("OK"); } cntHtmModeIteration = 0; break; } if (fl_endhtm) //  'END_CONTROL.HTM' { SD.remove(CONTROL_HTM); acceptHtmFile.close(); File htmlFile = SD.open(CONTROL_HTM, FILE_WRITE); //    acceptHtmFile = SD.open(CTRL_HTM); //    for (int i = 0; i &lt; acceptHtmFile.size(); i++) { digitalWrite(PIN_WATCHDOG_DONE, 1); htmlFile.write(acceptHtmFile.read()); digitalWrite(PIN_WATCHDOG_DONE, 0); } acceptHtmFile.close(); htmlFile.close(); client.print("OK_CLOSE_FILE"); acceptHtmMode = false; cntHtmModeIteration = 0; break; }</code> </pre> <br>  CONTROL_HTM y CTRL_HTM define aqu√≠ los nombres de los archivos html.  El primero es el archivo principal, el segundo es el archivo de b√∫fer.  En la matriz de etiquetas char se encuentra el texto de la cadena recibida, seleccionada de la solicitud.  La l√≥gica es la siguiente: cuando se reciben datos, se escriben en el archivo en spool, al final de la recepci√≥n, el archivo en spool se sobrescribe en el archivo principal.  Todav√≠a no pod√≠a entender c√≥mo simplemente cambiar el nombre de los archivos, la biblioteca est√°ndar SD no tiene esa funci√≥n, por lo que la copia est√∫pida de car√°cter por car√°cter, que lleva mucho tiempo. <br><br>  Ser√≠a conveniente almacenar el c√≥digo de la p√°gina web de control no en la tarjeta de memoria del controlador, sino en la m√°quina del cliente, o descargarlo de alg√∫n recurso externo.  Pero la prohibici√≥n de solicitudes entre dominios no permite esto.  Javascripts pueden enviar sus solicitudes solo al norte desde donde fueron cargadas.  En este caso, los cuerpos de los javascripts se pueden cargar desde cualquier lugar, solo es importante desde d√≥nde se carg√≥ la p√°gina con su llamada. <br><br>  <b>Registro de datos</b> <br><br>  El escudo de Ethernet tiene una ranura para tarjeta micro-SD a bordo.  Fue por su presencia que decid√≠ escribir datos en los archivos de registro.  Para trabajar con una tarjeta de memoria, tambi√©n hay una biblioteca incorporada, y administrar la lectura y escritura de archivos con ella es generalmente elemental. <br><br>  Para guardar la cantidad de datos, constru√≠ el algoritmo de registro para que el registro solo ocurra cuando los datos cambien en m√°s de un umbral predeterminado.  Para temperatura es 0.1 ¬∞, para voltaje es 0.2V.  Los datos de un d√≠a se escriben en un archivo.  A las cero horas, se crea un nuevo archivo.  Eleg√≠ el formato de texto plano, con delimitadores, para que pueda controlar r√°pidamente el contenido de los archivos durante la depuraci√≥n, y habr√≠a una capacidad simple de cargar en Excel. <br><br>  Las restricciones de dise√±o no le permiten insertar / quitar convenientemente una tarjeta de memoria, por lo que utilic√© una tarjeta grande.  Seg√∫n mis c√°lculos, se completar√° durante varios a√±os, despu√©s de lo cual ser√° necesario desmontar la carcasa, quitar la tarjeta de memoria y limpiarla. <br><br>  No veo el punto de registrar el c√≥digo, todo es completamente trivial all√≠: un registro banal de texto en un archivo.  Y este c√≥digo se extiende por todo el boceto (no solo se registran los par√°metros de los sensores, sino tambi√©n una variedad de eventos √∫nicos), es dif√≠cil de aislar. <br><br>  <b>Gr√°ficos</b> <br><br>  Como motor de gr√°ficos, utilizo la biblioteca de visualizaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">java amavart</a> altamente flexible.  La biblioteca es gratuita y est√° disponible para descargar y usar sin conexi√≥n.  Tambi√©n ubiqu√© esta biblioteca en mi NAS con acceso permanente a Internet.  Conectarlo y usarlo con la configuraci√≥n predeterminada no es dif√≠cil, sin embargo, para obtener la vista que necesitaba, tuve que jugar mucho.  Una gran cantidad de ejemplos en el sitio y la disponibilidad de documentaci√≥n detallada ayudaron. <br><br>  Por ejemplo, dar√© el javascript del dibujo de horarios.  En s√≠ mismo, es in√∫til, ya que solo funciona en conjunto con un servidor web y con una p√°gina html, y puede estar vinculado a otros scripts (fue hace mucho tiempo, no recuerdo todos los detalles).  Pero la configuraci√≥n de apariencia de mis gr√°ficos est√° contenida y puede obtenerlos desde all√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">get_log.js</a> <br><br>  La gran ventaja de la biblioteca amchart es que puede dibujar los gr√°ficos correctos a partir de datos desgarrados.  Como mencion√© anteriormente, en el registro guardo datos solo cuando cambian.  Es decir, esto sucede de forma as√≠ncrona y aleatoria.  Es posible que no haya datos nuevos durante varios minutos y luego, en unos segundos, cambiar√°n varias veces.  En consecuencia, las entradas en el registro van con intervalos de tiempo arbitrarios.  Amchart toma esto en cuenta por s√≠ solo cuando renderiza, no tengo que interpolar los datos antes de renderizar.  Acabo de enviar la matriz de datos tal como est√°, y veo un hermoso gr√°fico que es uniforme en el tiempo. <br><br>  Descubr√≠ solo un inconveniente de esta biblioteca: no sabe c√≥mo (bueno, o todav√≠a no entiendo c√≥mo) actualizar humanamente los gr√°ficos en tiempo real.  Puede agregar nuevos datos a los existentes, pero el redise√±o se realiza cada vez por completo de toda la matriz de datos, y esto ralentiza enormemente el navegador.  Sin embargo, la propia ideolog√≠a de leer datos de Arduina para renderizar a pedido desde el navegador es defectuosa por su falta de optimizaci√≥n, por lo que no ten√≠a sentido luchar por una actualizaci√≥n r√°pida en tiempo real. <br><br>  La decisi√≥n correcta ser√≠a organizar un servidor separado para almacenar y visualizar datos, desde donde Arduina en tiempo real los datos caer√≠an un poco y se almacenar√≠an en la base de datos, y desde donde podr√≠an enviarse r√°pidamente al usuario en un navegador para su visualizaci√≥n. <br><br>  Ahora los gr√°ficos se ven as√≠ (en el ejemplo del d√≠a en que no hay nadie en la casa de cambio y, en consecuencia, no hay consumo de energ√≠a).  Cuando se producen los datos actuales, la escala se establece autom√°ticamente para que todo encaje bien y los valores de los niveles actuales aparecen en el eje vertical: <br><br> <a href=""><img height="246" src="https://habrastorage.org/getpro/habr/post_images/12e/6d5/7e5/12e6d57e563012ba95a5407a1f96a88e.png" width="640"></a> <br><br>  Los gr√°ficos se muestran en la misma p√°gina donde tiene lugar el control, directamente debajo del bloque de control principal. <br><br>  No proporciono intencionalmente un conjunto completo de fuentes de proyecto por varias razones: <br><br><ol><li>  No se puede iniciar ya que est√° en cualquier red que no sea la m√≠a, ya que no intent√© hacer que el proyecto sea port√°til, y est√° r√≠gidamente vinculado a mis direcciones y mi topolog√≠a de red. </li><li>  Estoy seguro de que la ideolog√≠a general del proyecto sufre muchos problemas, ya que este es mi primer intento en el √°rea en la que no soy bueno para entender.  Por lo tanto, no propongo a nadie que se repita todo el proyecto de esta forma.  Compart√≠ solo esos momentos en los que tengo menos confianza. </li><li>  El proyecto se ha realizado durante mucho tiempo y durante mucho tiempo, y nunca recordar√© todos los detalles y no podr√© explicar una serie de soluciones.  El volumen del boceto es muy grande (para mis est√°ndares, alrededor de 2 mil l√≠neas), hay m√°s de una docena de scripts Java que sirven, no hice un diagrama esquem√°tico de la plancha.  Es decir, no puedo evitar el asesoramiento sobre la mayor√≠a de los problemas. </li></ol><br>  <b>Asamblea</b> <br><br>  Desde el principio me propuse el objetivo: hacer un dispositivo terminado, y no solo un dise√±o con un mont√≥n de publicaciones en la mesa: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/721/a45/ba3/721a45ba3d536cfbf0d3b302c32cdd3b.jpg" width="640"></a> <br><br>  E inmediatamente decid√≠ que quiero colocar el dispositivo dentro del panel el√©ctrico.  Hay comida y un mostrador, y en general, es conveniente. <br><br>  Para esto, se requer√≠a un caso dinrek.  Al principio pens√© en desarrollarlo e imprimirlo en una impresora 3D.  Pero no tengo mi propia impresora 3D, y lo que mis colegas que trabajan en sus impresiones de impresoras autoensambladas no me convencieron en absoluto en la calidad de su apariencia.  Encontr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cajas listas</a> para usar en un riel DIN (de varios tama√±os) a la venta, se ven bien, son convenientes de usar (plegables) y tambi√©n hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tarjeta ciega</a> lista para usar. <br><br>  Compr√© el estuche m√°s grande, para que no solo Arduino con el escudo de Internet pudiera caber en √©l, sino tambi√©n un rel√© para cambiar la carga: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/674/493/325/6744933251f7abeed45267d51d2c2e59.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/aed/1dc/c27/aed1dcc279af58de00af5e68f30b8aac.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fe1/cbb/ab7/fe1cbbab760347fda7df0edf2b0a9c09.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0f9/13b/250/0f913b2504dcef41d4156e23015f5fef.jpg" width="640"></a> <br><br>  El siguiente fue un proceso largo y fascinante de instalaci√≥n de todos los tripas en el caso.  En este negocio, incluso adquir√≠ un soldador maravilloso con la funci√≥n de sue√±o (los soldadores que ten√≠a todav√≠a eran de la √©poca sovi√©tica): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8f7/cff/613/8f7cff613a071eb2ee93cd09c3286622.jpg" width="640"></a> <br><br>  Para la instalaci√≥n, compr√© un mont√≥n de todo tipo de bastidores, tornillos, arandelas y tuercas.  Primer montaje de montaje: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c28/ff1/ac7/c28ff1ac7b46d25bf58714949091c7d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fd9/c60/001/fd9c6000193beeb0a82cf14d7ca56cda.jpg" width="640"></a> <br><br>  Para conectar los cables a los contactos superiores, era necesario usar pines doblados, de lo contrario no encajaba en la caja: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/47a/8eb/107/47a8eb107e5b12253386f61745103774.jpg" width="640"></a> <br><br>  Las arandelas aislantes tuvieron que cortarse en algunos lugares: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4da/e6f/55f/4dae6f55f161153a1d544c8aae3c883e.jpg" width="640"></a> <br><br>  Y en algunos lugares, se doblar√° m√°s perversamente, levantar√° el tornillo de la manga y recortar√° la manga elaboradamente: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/6ec/226/736/6ec226736d2576706170487958208959.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/f98/c43/fb9/f98c43fb9ddb0da9149193dd92ef465d.jpg" width="640"></a> <br><br>  Para una sola reubicaci√≥n no hab√≠a suficientes puntos de pivote, por lo que colgaba solo en dos puntos: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/398/f46/4b6/398f464b6f08b4372bf8792edb0018b9.jpg" width="640"></a> <br><br>  Ensamblaje ensamblado con bloques de terminales: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/bd8/17d/1cb/bd817d1cbc854ac47c7427c26dc0f0c8.jpg" width="640"></a> <br><br>  Luego, la nave comenz√≥ a convertirse gradualmente en cables.  La placa se us√≥ solo para el cableado de alimentaci√≥n y para la conexi√≥n a bloques de terminales.  Para las conexiones de se√±al, utilic√© el cable MS-16 (me gusta m√°s), para la alimentaci√≥n no pas√≥ a trav√©s del voltaje (hasta 100 V), por lo que MGTF: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/cc3/5ae/01d/cc35ae01d9728523e1edbe1e3d0ae79d.jpg" width="640"></a> <br><br>  Mont√© LED en el panel frontal, solde las resistencias limitadoras de corriente directamente a las patas de los LED y las cerr√© con termocontracci√≥n: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4a3/299/840/4a3299840a442a416396a30c81a25e2e.jpg" width="640"></a> <br><br>  Como resultado, obtuvimos un relleno tan barbudo: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/5c7/042/3e7/5c70423e7c3acdbe8f892054ffe010c5.jpg" width="640"></a> <br><br>  Y aqu√≠ hay una bufanda con un microcircuito de vigilancia, protegida en las entra√±as de mi creaci√≥n, justo encima del convertidor de nivel RS-485-TTL: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/73d/e5b/318/73de5b318ba3e6299168d634cdbaefe2.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/798/c40/61f/798c4061fa2167591312ff1d40adf5a4.jpg" width="640"></a> <br><br>  Toda la estructura es plegable, todo se puede quitar, desconectar y reemplazar sin soldar, a excepci√≥n de una bufanda con un ojo de perro, se suelda a los pines del conector, se viste en varios puertos IO de Arduina. <br><br>  En la caja: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c0b/918/cd8/c0b918cd83cbf30b11bc6b47e150b60f.jpg" width="640"></a> <br><br>  Cort√© aberturas para los conectores de Arduina en la pared de pl√°stico de la caja.  Primero hice los agujeros exactamente de acuerdo con el tama√±o de los conectores, pero el ensamblaje en la caja debe iniciarse en diagonal (de lo contrario, simplemente no funciona) y los conectores no pasaron, tuve que desperdiciar un poco: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7a1/5bd/21c/7a15bd21c6767e24b78a867b95952606.jpg" width="640"></a> <br><br>  Al encender el producto terminado en la mesa, todo funcion√≥ de inmediato: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/262/a25/4f6/262a254f611519e81f429b00b2440758.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4ff/cb6/10c/4ffcb610c648d20fe7c386f821178ad9.jpg" width="640"></a> <br><br>  En el panel frontal trajo: <br><br><ul><li>  Cuatro LED rojos: indicaci√≥n de carga; </li><li>  Dos verdes: comunicaci√≥n con el contador y con el servidor VPN; </li><li>  Dos amarillas son de repuesto; </li><li>  Una amarilla: indicaci√≥n de reinicio del enrutador; </li><li>  Uno rojo es la nutrici√≥n; </li><li>  Y un bot√≥n de reinicio. </li></ul><br>  Para obtener 5 voltios de 220, utilic√© una fuente de alimentaci√≥n dinerey con ajuste de nivel de salida, la energ√≠a se suministr√≥ directamente al microcontrolador, evitando el convertidor de entrada de 7-12 a 5 voltios.  Esto fue conveniente por varias razones.  En primer lugar, la potencia del convertidor incorporado en alg√∫n momento no fue suficiente, la corriente all√≠ es limitada.  En segundo lugar, todav√≠a era necesario suministrar el rel√© con 5 voltios.  En tercer lugar, el tablero es un factor de forma dinrek conveniente en t√©rminos de instalaci√≥n.  Por lo tanto, aqu√≠: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/801/0f7/aad/8010f7aad941e5f4619553fe7433c58e.jpg" width="640"></a> <br><br><br>  <b>Prueba</b> <b><br></b> <br>  Todo estaba puesto sobre la mesa, todo funcionaba como deber√≠a, era hora de instalar el controlador en el escudo y comprobarlo en modo de combate. <br><br>  Pero primero, conect√© todo "en el moco", literalmente empujando todos los callos a otro escudo, de baja corriente para probar los sensores de temperatura en condiciones reales en largas l√≠neas tendidas en un canal de cable con cables de alimentaci√≥n de ~ 220V: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/d3c/3a8/b45/d3c3a8b45a90075449e23e24f4ae37e7.jpg" width="640"></a> <br><br>  Como puede ver en la foto de arriba, hasta ahora intent√© controlar el reinicio del enrutador mediante el uso de la toma Senseit "inteligente".  Sin embargo, este dispositivo con un costo loco de 5 mil (para 2016) result√≥ ser extremadamente defectuoso y de mal humor.  Durante el a√±o de uso, en repetidas ocasiones me oblig√≥ a llegar a la caba√±a de manera imprevista en momentos inoportunos, para eliminar manualmente este milagro de la ingenier√≠a y el pensamiento de marketing desde un profundo inconveniente en t√©rminos de comunicaciones GSM.  Con la transici√≥n a mi controlador Arduino, que result√≥ ser m√°s confiable que un ejemplo, me sent√≠ aliviado de dejar esta basura "profesional" en una hermosa caja en una caja y olvidarme de ella. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/efa/f91/91b/efaf9191b1dffa362e86e302d4858d34.jpg" width="640"></a> <br><br>  La prueba fue exitosa, no hubo fallas y fue posible proceder a la instalaci√≥n final en un lugar regular: <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/887/ac8/320/887ac8320dca67597c4f979806e22b93.jpg" width="472"></a> <br><br>  S√≠, este es el escudo ABB TwinLine 800x300x225 IP55, por valor de 25 mil rublos.  sin relleno (y relleno por otros 15 mil aproximadamente).  Y s√≠, est√° instalado en una casa de cambio de 6x2.  Todos tienen sus propias cucarachas.  S√≠, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recog√≠ todas las el√©ctricas yo mismo</a> .  Y tambi√©n construy√≥ una casa de cambio, s√≠.  No, no soy electricista.  Y no un constructor. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4d4/c1b/3e5/4d4c1b3e5710dfb4a87299bb1f55fbfd.jpg" width="640"></a> <br><br>  En las profundidades del escudo, ubiqu√© una peque√±a fuente de alimentaci√≥n ininterrumpida <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Powercom WOW 300</a> , all√≠ se enciende su LED verde y, a la izquierda y arriba, su enchufe de entrada: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/b6a/991/299/b6a991299668084c3ae8265d064e1910.jpg" width="640"></a> <br><br>  Tiene una duraci√≥n de ~ 40 minutos de duraci√≥n de la bater√≠a del dispositivo Arduino, un enrutador con m√≥dem USB y Wi-Fi, y c√°maras de vigilancia IP Full HD. <br><br>  Y aqu√≠ puede ver los enchufes blancos de dos consumidores ininterrumpidos: la unidad de fuente de alimentaci√≥n Arduino y el escudo de baja corriente, donde se encuentran el enrutador y la unidad de fuente de alimentaci√≥n para la c√°mara de vigilancia exterior.  Esta l√≠nea va con una ruptura a trav√©s del contactor, que es controlado por Arduino, solo para el mismo perro guardi√°n de software que reinicia el enrutador en caso de una ca√≠da de VPN (la c√°mara se reinicia al mismo tiempo, aunque no lo necesita).  Las l√≠neas superiores de pares trenzados de los sensores de temperatura est√°n conectadas al controlador: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0b8/fd7/50b/0b8fd750b2a17afd69eb55b6d56bf709.jpg" width="640"></a> <br><br>  Debo decir que nunca confiar√≠a en el cambio de una carga potente a peque√±os rel√©s chinos azules, a pesar de los par√°metros de estos rel√©s, que parecen permitir que esto se haga.  Por lo tanto, el uso de contactores modulares normales <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Legrand cat. No. 4 125 01</a> con la posibilidad de control manual se estableci√≥ de inmediato.  Es decir, los rel√©s dentro del cuerpo del controlador controlan los contactores, y los contactores ya controlan la carga.  Es confiable  Pero la potencia del enrutador y la c√°mara se lleva a cabo solo a trav√©s de este peque√±o rel√© chino azul, la corriente all√≠ es peque√±a, por lo que es posible. <br><br>  En el primer lanzamiento de combate, estaba muy decepcionado.  Sobre la mesa, experiment√© todo excepto la carga.  Por qu√©  Los contactores hacen clic y queda claro que cambiar√°n la carga.  Pero no, era necesario experimentar.  Potentes electroconvectores introdujeron interferencia en el sistema en el momento de abrir los contactos, lo que condujo a una congelaci√≥n garantizada del escudo de Internet.  Y para sacarlo de la depresi√≥n solo fue posible eliminando el poder, un simple reinicio no ayud√≥.  Busc√≥ en Google: s√≠, este chino tiene ese problema.  Y la biblioteca no maneja esta situaci√≥n.  Es decir, la pieza de hierro es mala y el software no es muy bueno. <br><br>  Ya pens√© que todo se hab√≠a ido.  Incluso orden√© rel√©s de estado s√≥lido, pero ellos, escoria, son m√°s grandes en altura y no encajar√≠an en mi dise√±o.  Pero luego pens√© que a√∫n podr√≠a ser posible suprimir la interferencia.  Busc√≥ en Google nuevamente, encontr√≥ condensadores especiales de supresi√≥n de ruido (los llamados condensadores de tipo X).  Simplemente los conect√© en paralelo al control de bobinado de los contactores, y ¬°he aqu√≠!  Los bloqueos desaparecieron por completo.  Durante el a√±o pasado de operaci√≥n, no se ha registrado un solo caso: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7ae/198/80c/7ae19880c09be755c8421266a4ba29df.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c25/e89/cb2/c25e89cb2e1f8ed607f736bfdfc0cd20.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/6b8/a25/f65/6b8a25f65c6f9de23a3b1ad57a91f97d.jpg" width="472"></a> <br><br>  Pero de esta manera puedes mirar dentro de la caja: <br><br> <a href=""><img height="480" src="https://habrastorage.org/getpro/habr/post_images/776/7c3/7c9/7767c37c908537a36b5bd763a39fc7bc.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/827/6fa/818/8276fa8186818314c5b4ce8516ef6f04.jpg" width="480"></a> <br><br>  Bueno, la vista final de la visera con el plastr√≥n (no se proporcionaron enchufes en el kit): <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/e4c/231/5ac/e4c2315ac67af993ed83151f58896e85.jpg" width="472"></a> <br><br>  Para la depuraci√≥n y el parpadeo, el cable USB se conecta al controlador y se almacena dentro del protector detr√°s de una puerta cerrada (no se conectar√° temporalmente a esta foto): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/e51/1ce/92d/e511ce92de3e8e090aa842ff540034d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8fa/202/f5a/8fa202f5abf1eeb6bbca9192dc82c719.jpg" width="640"></a> <br><br>  El sistema ha estado funcionando durante casi un a√±o, sobrevivi√≥ a las heladas hasta 20 grados sin ning√∫n problema. <br><br>  En general, estoy satisfecho con el resultado.  Sin embargo, para tareas m√°s o menos funcionales, Arduino es claramente d√©bil.  M√°s de una vez me qued√© sin memoria y tuve que cortar y optimizar.  Y la velocidad del trabajo, especialmente con una tarjeta de memoria, no me conviene en absoluto.  Por lo tanto, las implementaciones futuras de tales manualidades, si las hubiera, me gustar√≠a basarme en algo m√°s poderoso.  Los colegas me dan una Raspberry Pi, una buena opci√≥n, creo. <br><br>  Alguien podr√≠a decir: "¬øCu√°ntas dificultades hay en aras de una tarea tan primitiva?", Y probablemente tenga raz√≥n.  Para m√≠, toda esta empresa es un pasatiempo, con poca justificaci√≥n para el significado.  Por lo tanto, estaba buscando entretenimiento en todo lo que pudiera :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es411141/">https://habr.com/ru/post/es411141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es411131/index.html">La primera competencia en rob√≥tica subacu√°tica para estudiantes en grados 1-4</a></li>
<li><a href="../es411133/index.html">Juguetes robot para ni√±os: para el aprendizaje y el entretenimiento.</a></li>
<li><a href="../es411135/index.html">Par√°metros</a></li>
<li><a href="../es411137/index.html">VTC - Centro de comunicaci√≥n satelital (Vladivostok)</a></li>
<li><a href="../es411139/index.html">El misterio con la vida de neutrones se vuelve m√°s complicado, y la materia oscura todav√≠a no es visible</a></li>
<li><a href="../es411143/index.html">Programaci√≥n de microcontroladores modernos: clase 1</a></li>
<li><a href="../es411145/index.html">Mis peque√±os rel√©s: la computadora Brainfuck es una realidad</a></li>
<li><a href="../es411147/index.html">Enormes manchas de planetas gigantes</a></li>
<li><a href="../es411149/index.html">Pron√≥stico TRIZ de sistemas descentralizados y la sociedad ciberf√≠sica de 2035</a></li>
<li><a href="../es411151/index.html">iMX6ULL. Transici√≥n a m√≥dulos de procesador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>