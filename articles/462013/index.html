<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí£ ‚ûñ ‚ôëÔ∏è Historial de problemas de migraci√≥n de Docker Storage (Docker root) üõéÔ∏è üßôüèæ üë¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A m√°s tardar hace un par de d√≠as, se decidi√≥ en uno de los servidores mover el almacenamiento de la ventana acoplable (el directorio donde la ventana ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Historial de problemas de migraci√≥n de Docker Storage (Docker root)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462013/"> A m√°s tardar hace un par de d√≠as, se decidi√≥ en uno de los servidores mover el almacenamiento de la ventana acoplable (el directorio donde la ventana acoplable almacena todos los archivos de contenedores, im√°genes) a una partici√≥n separada, que <br>  Pose√≠a m√°s capacidad.  La tarea, al parecer, es trivial y no presagia problemas ... <br><a name="habracut"></a><br>  Comenzando: <br><br>  1. Pare y elimine todos los contenedores de nuestra aplicaci√≥n: <br><br><pre><code class="bash hljs">docker-compose down</code> </pre> <br>  Si hay muchos contenedores y est√°n en una composici√≥n diferente, puede hacer esto: <br><br><pre> <code class="bash hljs">docker rm -f $(docker ps -q)</code> </pre> <br>  2. Detenga el demonio de docker: <br><br><pre> <code class="bash hljs">systemctl stop docker</code> </pre> <br>  3. Mueva el directorio a la ubicaci√≥n deseada: <br><br><pre> <code class="bash hljs">cp -r /var/lib/docker /docker/data/storage</code> </pre> <br>  4. Informamos al demonio del acoplador para que busque en un nuevo directorio.  Hay varias opciones: usar el indicador -g para apuntar el demonio a una nueva ruta, o las configuraciones de systemd, que usamos.  Bueno, o enlace simb√≥lico.  No lo pintar√© mucho, Internet est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lleno de</a> manuales sobre c√≥mo portar la ra√≠z del acoplador a una nueva ubicaci√≥n. <br><br>  5. Iniciamos el demonio Docker, y vemos que se ve donde deber√≠a estar: <br><br><pre> <code class="bash hljs">systemctl status docker</code> </pre> <br>  En una de las l√≠neas de salida, deber√≠amos ver: <br><pre> <code class="bash hljs">‚îú‚îÄ19493 /usr/bin/dockerd --data-root=/docker/data/storage</code> </pre> <br>  Nos aseguramos de que la opci√≥n se pasara al demonio, ¬°ahora comprobaremos si la ha aplicado (gracias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">inkvizitor68sl</a> )! <br><pre> <code class="bash hljs">docker info | awk <span class="hljs-string"><span class="hljs-string">'/Root Dir/ {print $NF}'</span></span></code> </pre> <br>  6. Comenzamos nuestra aplicaci√≥n: <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  7. Verificar <br><br>  Y aqu√≠ comienza la diversi√≥n, DBMS, MQ, ¬°todo est√° bien!  La base est√° intacta, todo funciona ... excepto nginx.  Tenemos nuestro propio ensamblaje nginx con kerberos <s>y cortesanas</s> .  Y ver los registros del contenedor indicaba que no pod√≠a escribir en / var / tmp - Permiso denegado.  Estiro los dedos con whisky e intento analizar la situaci√≥n ... ¬øC√≥mo es eso?  La imagen de la ventana acoplable no cambi√≥.  Acabamos de mover el directorio.  Siempre funcion√≥, y aqu√≠ est√° para ti ... En aras del experimento, entr√© en el contenedor con bol√≠grafos y cambi√© los derechos de este directorio, hab√≠a <u>root, root 755</u> , dio <u>root, root 777</u> .  Y todo comenz√≥ ... Un pensamiento son√≥ en mi cabeza, una especie de tonter√≠a ... Pens√©, bueno, tal vez no tuve en cuenta algo ... <br><br>  Decid√≠ que nos gustaban los derechos de acceso a los archivos durante la transferencia.  Detuvieron la aplicaci√≥n, el demonio docker, eliminaron el nuevo directorio e hicieron una copia del directorio / var / lib / docker que ya usa <code>rsync -a</code> . <br><br>  Creo que ahora todo est√° bien, estamos elevando la ventana acoplable, la aplicaci√≥n. <br><br>  III ... el problema persiste ... Mi ojo tembl√≥.  Me apresur√© a la consola de mi m√°quina virtual, donde estoy ejecutando varias pruebas, tuve esta imagen nginx y me met√≠ dentro del contenedor, y aqu√≠ los derechos ra√≠z, root 777 est√°n en el directorio / var / tmp. Es decir, los mismos que tuve que configurar con mis manos .  ¬°Pero las im√°genes son id√©nticas! <br><br>  <u>En todas partes se usa FS xfs.</u> <br><br>  Compar√© a trav√©s del comando <br><br><pre> <code class="bash hljs">docker inspect my-nginx:12345</code> </pre> <br>  Todos los hashes son id√©nticos, todos uno a uno.  Tanto en el servidor como en mi virtualka.  Elimin√© la imagen nginx local y volv√≠ a poner en cola el registro, que por varias razones est√° en la misma m√°quina.  Y el problema es el mismo ... Ahora mi segundo ojo se crisp√≥. <br><br>  No recuerdo qu√© pensamientos hab√≠a en mi cabeza, adem√°s de los gritos de "AAAAAAA" y otras cosas.  En la calle a las 4 en punto de la ma√±ana, las fuentes de la ventana acoplable se utilizaron para comprender el principio de capas de im√°genes hash.  Abri√≥ la tercera lata de energ√≠a.  Y al final, me di cuenta de que el hashing solo tiene en cuenta el archivo, su contenido, ¬°pero <b>NO EL DERECHO DE ACCESO</b> !  Es decir, de alguna manera misteriosa, los derechos fueron vencidos, y selinux est√° deshabilitado, no se usa acl, no est√° presente un bit adhesivo. <br><br>  Elimin√© la imagen local, tambi√©n elimin√© la imagen del registro de Docker y la comenc√© de nuevo.  Y funcion√≥.  Resulta que durante la transferencia se violaron los derechos, tanto dentro de la imagen local como dentro de la imagen que se encuentra en el registro.  Como dije, por varias razones, estaba ubicado en el mismo auto.  Y como resultado en un directorio / var / lib / docker. <br><br>  Y anticipando la pregunta de si trataron de devolver la mirada del acoplador al antiguo cat√°logo, no, lamentablemente, las circunstancias no lo permitieron.  S√≠, y realmente quer√≠a resolverlo. <br><br>  Despu√©s de escribir este art√≠culo, la soluci√≥n al problema me parece obvia, pero en el momento del an√°lisis no parec√≠a ser as√≠.  Honestamente busqu√© en Google y no encontr√© situaciones similares. <br><br>  En pocas palabras: resolv√≠ el problema, no entend√≠ la raz√≥n = ( <br><br>  Si alguien sabe / adivina / tuvo una visi√≥n sobre las posibles causas de este problema, ¬°me alegrar√° mucho verte en los comentarios! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/462013/">https://habr.com/ru/post/462013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../462003/index.html">C√≥mo publiqu√© PWA en Svelte en Google Play</a></li>
<li><a href="../462005/index.html">Caracter√≠sticas de Google PageSpeed: calificaci√≥n mejorada del sitio y ranking de b√∫squeda</a></li>
<li><a href="../462007/index.html">Desarrollando scripts robustos de Python</a></li>
<li><a href="../462009/index.html">Tendencias de programaci√≥n: ¬øqu√© se puede esperar en 2020?</a></li>
<li><a href="../462011/index.html">Geoservicios web. Resumen de soluciones modernas</a></li>
<li><a href="../462015/index.html">Universo de informes de SAP</a></li>
<li><a href="../462021/index.html">C√≥mo dejar de hacer lo mismo</a></li>
<li><a href="../462023/index.html">Cascadeur: el futuro de la animaci√≥n del juego</a></li>
<li><a href="../462025/index.html">Modelo de datos de red relacional</a></li>
<li><a href="../462027/index.html">C√≥mo Dark implementa el c√≥digo de 50 ms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>