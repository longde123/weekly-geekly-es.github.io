<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç≤ üë®üèø‚Äçüè´ ü§Æ Automatizaci√≥n de suministro de flujo Apache NiFi üì§ üíáüèª ‚úçüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! 



 La tarea es la siguiente: hay un flujo, presentado en la imagen de arriba, que debe implementarse en N servidores con Apache NiFi ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatizaci√≥n de suministro de flujo Apache NiFi</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476722/">  Hola a todos! <br><br><img src="https://habrastorage.org/webt/jv/w6/ho/jvw6hodwifbfkov69ezswvjbx_k.png"><br><br>  La tarea es la siguiente: hay un flujo, presentado en la imagen de arriba, que debe implementarse en N servidores con <a href="https://nifi.apache.org/">Apache NiFi</a> .  Prueba de flujo: el archivo se genera y se env√≠a a otra instancia de NiFi.  Los datos se transmiten utilizando el protocolo de sitio a sitio de NiFi. <br><a name="habracut"></a><br><hr>  <em>NiFi Site to Site (S2S) es una forma segura y f√°cilmente personalizable de transferir datos entre instancias de NiFi.</em>  <em>Vea c√≥mo funciona el S2S en la <a href="https://docs.cloudera.com/HDPDocuments/HDF2/HDF-2.1.2/bk_dataflow-user-guide/content/site-to-site.html">documentaci√≥n</a> y es importante no olvidar configurar la instancia de NiFi para habilitar S2S. Consulte <a href="https://docs.cloudera.com/HDPDocuments/HDF2/HDF-2.1.2/bk_dataflow-administration/content/site_to_site_properties.html">aqu√≠</a> .</em> <em><br><br></em>  <em>En esos casos, cuando se trata de la transferencia de datos mediante S2S, una instancia se denomina cliente, el segundo servidor.</em>  <em>El cliente env√≠a datos, el servidor env√≠a.</em>  <em>Dos formas de configurar la transferencia de datos entre ellos:</em> <em><br><br></em> <ol><li>  <strong>Empujar</strong>  Desde una instancia de cliente, los datos se env√≠an utilizando el Grupo de proceso remoto (RPG).  En una instancia de servidor, los datos se reciben utilizando el puerto de entrada. </li><li>  <strong>Tirar</strong>  El servidor recibe datos utilizando el RPG, el cliente env√≠a utilizando el puerto de salida. </li></ol><hr><br>  Almacenamos el flujo para rodar en el registro de Apache. <br><br><hr>  <em>Apache NiFi Registry es un subproyecto de Apache NiFi que proporciona una herramienta para almacenar el flujo y el control de versiones.</em>  <em>Una especie de imb√©cil.</em>  <em>La informaci√≥n sobre la instalaci√≥n, configuraci√≥n y trabajo con el registro se puede encontrar en la <a href="https://nifi.apache.org/registry">documentaci√≥n oficial</a> .</em>  <em>El flujo para el almacenamiento se combina en un grupo de procesos y se almacena como tal en el registro.</em>  <em>M√°s adelante en el art√≠culo volveremos a esto.</em> <em><br></em> <hr><br>  Al principio, cuando N es un n√∫mero peque√±o, el flujo se entrega y actualiza manualmente en un tiempo aceptable. <br><br>  Pero con el crecimiento de N, hay m√°s problemas: <br><br><ol><li>  El flujo de actualizaci√≥n lleva m√°s tiempo.  Es necesario ir a todos los servidores. </li><li>  Hay errores al actualizar las plantillas.  Aqu√≠ se actualizaron, pero aqu√≠ se olvidaron </li><li>  errores humanos al realizar una gran cantidad de operaciones del mismo tipo </li></ol><br>  Todo esto nos lleva al hecho de que necesitamos automatizar el proceso.  Intent√© las siguientes formas de resolver este problema: <br><br><ol><li>  Use MiNiFi en lugar de NiFi </li><li>  NiFi CLI </li><li>  NiPyAPI </li></ol><br><h1>  Usando MiNiFi </h1><br>  <a href="https://nifi.apache.org/minifi/index.html">Apache MiNiFy</a> es un subproyecto de Apache NiFi.  MiNiFy es un agente compacto que utiliza los mismos procesadores que NiFi, lo que le permite crear el mismo flujo que en NiFi.  La ligereza del agente se logra, entre otras cosas, debido a que MiNiFy no tiene una interfaz gr√°fica para la configuraci√≥n del flujo.  La falta de una interfaz gr√°fica en MiNiFy significa que es necesario resolver el problema de la entrega de flujo en minifi.  Como MiNiFy se usa activamente en IOT, hay muchos componentes y el proceso de entrega de flujo a las instancias finales de minifi necesita ser automatizado.  Una tarea familiar, ¬øverdad? <br><br>  Otro subproyecto ayudar√° a resolver este problema: MiNiFi C2 Server.  Este producto est√° destinado a ser un punto central en la arquitectura de las configuraciones continuas.  C√≥mo configurar el entorno: descrito en <a href="https://habr.com/ru/company/itsumma/blog/415933/">este art√≠culo</a> sobre Habr√© y suficiente informaci√≥n para resolver la tarea.  MiNiFi junto con el servidor C2 actualiza autom√°ticamente la configuraci√≥n en casa.  El √∫nico inconveniente de este enfoque es que tiene que crear plantillas en el servidor C2, una confirmaci√≥n de registro simple no es suficiente. <br><br>  La opci√≥n descrita en el art√≠culo anterior funciona y no es dif√≠cil de implementar, pero no olvide lo siguiente: <br><br><ol><li>  En minifi no hay todos los procesadores de nifi </li><li>  Las versiones de procesador en Minifi se quedan atr√°s de las versiones de procesador en NiFi. </li></ol><br>  Al momento de escribir, la √∫ltima versi√≥n de NiFi es 1.9.2.  La versi√≥n del procesador de la √∫ltima versi√≥n de MiNiFi es 1.7.0.  Se pueden agregar procesadores a MiNiFi, pero debido a las discrepancias de versi√≥n entre los procesadores NiFi y MiNiFi esto puede no funcionar. <br><br><h1>  NiFi CLI </h1><br>  A juzgar por la <a href="https://nifi.apache.org/docs/nifi-docs/html/toolkit-guide.html">descripci√≥n de la</a> herramienta en el sitio web oficial, es una herramienta para automatizar la interacci√≥n de NiFI y NiFi Registry en el campo de la entrega de flujo o el control de procesos.  Para comenzar, esta herramienta debe descargarse <a href="https://nifi.apache.org/download.html">desde aqu√≠</a> . <br><br>  Ejecute la utilidad <br><br><pre><code class="plaintext hljs">./bin/cli.sh _ ___ _ Apache (_) .' ..](_) , _ .--. __ _| |_ __ )\ [ `.-. | [ |'-| |-'[ | / \ | | | | | | | | | | ' ' [___||__][___][___] [___]', ,' `' CLI v1.9.2 Type 'help' to see a list of available commands, use tab to auto-complete.</code> </pre> <br>  Para que podamos cargar el flujo necesario desde el registro, necesitamos conocer los identificadores de la cesta (identificador de dep√≥sito) y el flujo mismo (identificador de flujo).  Estos datos se pueden obtener a trav√©s de cli o en la interfaz web del registro NiFi.  La interfaz web se ve as√≠: <br><br><img src="https://habrastorage.org/webt/32/zw/e-/32zwe-t2p220zehsvlpy_1se6py.png"><br><br>  El uso de la CLI hace esto: <br><br><pre> <code class="plaintext hljs">#&gt; registry list-buckets -u http://nifi-registry:18080 # Name Id Description - -------------- ------------------------------------ ----------- 1 test_bucket 709d387a-9ce9-4535-8546-3621efe38e96 (empty) #&gt; registry list-flows -b 709d387a-9ce9-4535-8546-3621efe38e96 -u http://nifi-registry:18080 # Name Id Description - ------------ ------------------------------------ ----------- 1 test_flow d27af00a-5b47-4910-89cd-9c664cd91e85</code> </pre><br>  Comenzamos la importaci√≥n del grupo de procesos desde el registro: <br><br><pre> <code class="plaintext hljs">#&gt; nifi pg-import -b 709d387a-9ce9-4535-8546-3621efe38e96 -f d27af00a-5b47-4910-89cd-9c664cd91e85 -fv 1 -u http://nifi:8080 7f522a13-016e-1000-e504-d5b15587f2f3</code> </pre><br>  El punto importante es que cualquier instancia de nifi se puede especificar como el host en el que rodamos el grupo de procesos. <br><br>  Grupo de procesos agregado con procesadores detenidos, deben iniciarse <br><br><pre> <code class="plaintext hljs">#&gt; nifi pg-start -pgid 7f522a13-016e-1000-e504-d5b15587f2f3 -u http://nifi:8080</code> </pre><br>  Genial, los procesadores comenzaron.  Sin embargo, de acuerdo con las condiciones del problema, necesitamos instancias de NiFi para enviar datos a otras instancias.  Suponga que selecciona el m√©todo Push para transferir datos al servidor.  Para organizar la transferencia de datos, debe habilitar la transmisi√≥n de datos (Habilitar transmisi√≥n) en el Grupo de proceso remoto (RPG) agregado, que ya est√° incluido en nuestro flujo. <br><br><img src="https://habrastorage.org/webt/bh/7w/_m/bh7w_m1qbd_5pbookh6hex9nkqs.png"><br><br>  En la documentaci√≥n en la CLI y otras fuentes, no encontr√© una manera de habilitar la transferencia de datos.  Si sabe c√≥mo hacer esto, escriba los comentarios. <br><br>  Como tenemos bash y estamos listos para llegar al final, ¬°encontraremos una salida!  Puede usar la API NiFi para resolver este problema.  Utilizamos el siguiente m√©todo, tomamos la ID de los ejemplos anteriores (en nuestro caso es 7f522a13-016e-1000-e504-d5b15587f2f3).  Descripci√≥n de los m√©todos API de NiFi <a href="https://nifi.apache.org/docs/nifi-docs/rest-api/index.html">aqu√≠</a> . <br><br><img src="https://habrastorage.org/webt/ii/nx/9c/iinx9ckcphh4vdld6_8vwjra8mc.png"><br>  En cuerpo, debe pasar JSON, de la siguiente forma: <br><br><pre> <code class="plaintext hljs">{ "revision": { "clientId": "value", "version": 0, "lastModifier": "value" }, "state": "value", "disconnectedNodeAcknowledged": true }</code> </pre><br>  Par√°metros que deben rellenarse para "trabajar": <br>  <strong>estado</strong> : <strong>estado de</strong> transferencia de datos.  TRANSMISI√ìN disponible para permitir la transferencia de datos, DETENIDO para apagar <br>  <strong>version</strong> - versi√≥n del procesador <br><br>  la versi√≥n predeterminada ser√° 0 cuando se cree, pero estos par√°metros se pueden obtener utilizando el m√©todo <br><br><img src="https://habrastorage.org/webt/5x/ul/nv/5xulnvdp0w9a-jtf3oqapfbdghs.png"><br><br>  Para los amantes de los scripts de bash, este m√©todo puede parecer adecuado, pero es dif√≠cil para m√≠: los scripts de bash no son mis favoritos.  El siguiente m√©todo es m√°s interesante y c√≥modo en mi opini√≥n. <br><br><h1>  NiPyAPI </h1><br>  NiPyAPI es una biblioteca de Python para interactuar con instancias de NiFi.  <a href="https://nipyapi.readthedocs.io/en/latest/">La p√°gina de documentaci√≥n</a> contiene la informaci√≥n necesaria para trabajar con la biblioteca.  El inicio r√°pido se describe en un <a href="https://github.com/Chaffelson/nipyapi">proyecto</a> github. <br><br>  Nuestro script para implementar la configuraci√≥n es un programa Python.  Pasamos a la codificaci√≥n. <br>  Configuramos configuraciones para m√°s trabajo.  Necesitaremos los siguientes par√°metros: <br><br><pre> <code class="plaintext hljs">nipyapi.config.nifi_config.host = 'http://nifi:8080/nifi-api' #  nifi-api ,    process group nipyapi.config.registry_config.host = 'http://nifi-registry:18080/nifi-registry-api' #  nifi-registry-api registry nipyapi.config.registry_name = 'MyBeutifulRegistry' # registry,      nifi nipyapi.config.bucket_name = 'BucketName' # bucket,    flow nipyapi.config.flow_name = 'FlowName' # flow,  </code> </pre><br>  Adem√°s, insertar√© los nombres de los m√©todos de esta biblioteca, que se describen <a href="https://nipyapi.readthedocs.io/en/latest/nipyapi-docs/nipyapi.html">aqu√≠</a> . <br><br>  Conecte el registro a la instancia de nifi con <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.create_registry_client</code> </pre> <br>  En este paso, tambi√©n puede agregar una verificaci√≥n de que el registro ya se ha agregado a la instancia; para esto, puede usar el m√©todo <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.list_registry_clients</code> </pre> <br>  Encuentre un balde para seguir buscando flujo en la canasta. <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_registry_bucket</code> </pre> <br>  Buscar cubo para flujo <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_flow_in_bucket</code> </pre> <br>  Adem√°s, es importante comprender si este grupo de procesos ya se ha agregado.  El grupo de procesos se coloca en las coordenadas y puede surgir una situaci√≥n cuando se superpone una segunda encima de un componente.  Verifiqu√©, esto puede ser :) Para agregar todo el grupo de procesos, utilizamos el m√©todo <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.list_all_process_groups</code> </pre> <br>  y luego podemos buscar, por ejemplo, por nombre. <br><br>  No describir√© el proceso de actualizaci√≥n de la plantilla, solo dir√© que si se agregan procesadores en la nueva versi√≥n de la plantilla, entonces no hay problemas con la presencia de mensajes en las colas.  Pero si se eliminan los procesadores, entonces pueden surgir problemas (nifi no permite que se elimine el procesador si se ha acumulado una cola de mensajes frente a √©l).  Si est√° interesado en c√≥mo resolv√≠ este problema, escr√≠bame, por favor, discutiremos este punto.  Contacto al final del art√≠culo.  Pasemos al paso de agregar un grupo de procesos. <br><br>  Al depurar el script, me encontr√© con una caracter√≠stica de que la √∫ltima versi√≥n del flujo no siempre se extrae, por lo que recomiendo que esta versi√≥n se aclare primero: <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.get_latest_flow_ver</code> </pre> <br>  Grupo de proceso de implementaci√≥n: <br><br><pre> <code class="plaintext hljs">nipyapi.versioning.deploy_flow_version</code> </pre> <br>  Iniciamos procesadores: <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.schedule_process_group</code> </pre> <br>  En el bloque CLI, ¬øse escribi√≥ que la transferencia de datos no se activa autom√°ticamente en el grupo de proceso remoto?  Al implementar el script, me encontr√© con este problema tambi√©n.  En ese momento, no tuve √©xito en iniciar la transferencia de datos utilizando la API y decid√≠ escribir al desarrollador de la biblioteca NiPyAPI y pedirle consejo / ayuda.  El desarrollador me respondi√≥, discutimos el problema y escribi√≥ que necesitaba tiempo para "verificar algo".  Y ahora, despu√©s de un par de d√≠as, llega una carta en la que se escribe una funci√≥n de Python que resuelve mi problema de lanzamiento.  En ese momento, la versi√≥n NiPyAPI era 0.13.3 y, por supuesto, no hab√≠a nada de eso en ella.  Pero en la versi√≥n 0.14.0, que se lanz√≥ recientemente, esta funci√≥n ya se ha incluido en la biblioteca.  Reunirse <br><br><pre> <code class="plaintext hljs">nipyapi.canvas.set_remote_process_group_transmission</code> </pre> <br>  Entonces, usando la biblioteca NiPyAPI, conectamos el registro, el flujo continuo e incluso comenzamos los procesadores y la transferencia de datos.  Luego puede peinar el c√≥digo, agregar todo tipo de comprobaciones, registros y eso es todo.  Pero esta es una historia completamente diferente. <br><br>  De las opciones de automatizaci√≥n que consider√©, esta √∫ltima me pareci√≥ la m√°s eficiente.  En primer lugar, este sigue siendo c√≥digo de Python, en el que puede incrustar c√≥digo de programa auxiliar y aprovechar al m√°ximo el lenguaje de programaci√≥n.  En segundo lugar, el proyecto NiPyAPI se est√° desarrollando activamente y, en caso de problemas, puede escribir al desarrollador.  En tercer lugar, NiPyAPI sigue siendo una herramienta m√°s flexible para interactuar con NiFi para resolver problemas complejos.  Por ejemplo, al determinar si las colas de mensajes est√°n vac√≠as ahora en flujo y si el grupo de procesos se puede actualizar. <br><br>  Eso es todo.  Describ√≠ 3 enfoques para automatizar la entrega de flujo en NiFi, dificultades que un desarrollador puede encontrar y di un c√≥digo de trabajo para automatizar la entrega.  Si est√° tan interesado en este tema, <a href="">¬°escriba!</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/476722/">https://habr.com/ru/post/476722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../476710/index.html">Inscripci√≥n abierta: inmersi√≥n profunda en TI en Marte</a></li>
<li><a href="../476712/index.html">Servicio para reuniones aleatorias con extra√±os, pero no para citas. Historial de inicio de Random Coffee</a></li>
<li><a href="../476714/index.html">Operaci√≥n de aprendizaje autom√°tico en Mail.ru Mail</a></li>
<li><a href="../476718/index.html">Historia de una radio nacional: Mussolini de Rural Radio y Joseph Goebbels l√°mparas c√°lidas</a></li>
<li><a href="../476720/index.html">C√≥mo identificar un empleado potencial en la etapa de curr√≠culum</a></li>
<li><a href="../476724/index.html">Instale Vmware ESXi en Mac Pro 1.1</a></li>
<li><a href="../476726/index.html">Graduado de la Universidad de Innopolis sobre estudiar en la Universidad de Grenoble, AI, ingl√©s con franc√©s y queso con chinches</a></li>
<li><a href="../476728/index.html">Estrategia de contenido para empresas B2B: casos y listas de verificaci√≥n</a></li>
<li><a href="../476734/index.html">Autodiagn√≥stico de discos duros y recuperaci√≥n de datos</a></li>
<li><a href="../476736/index.html">Hunt for Threat Hunters: ¬øc√≥mo encontrar y capacitar especialistas competentes?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>