<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö± üïµüèª üë©üèø‚Äçüéì Optimisation de Firebird et Linux pour une base de donn√©es de 691 Go avec plus de 1000 utilisateurs üëãüèº üëäüèæ üë®‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firebird est un SGBD ouvert tr√®s populaire en Russie, et malgr√© l'absence de campagnes de marketing bruyantes, il est utilis√© dans un grand nombre de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimisation de Firebird et Linux pour une base de donn√©es de 691 Go avec plus de 1000 utilisateurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476636/"> Firebird est un SGBD ouvert tr√®s populaire en Russie, et malgr√© l'absence de campagnes de marketing bruyantes, il est utilis√© dans un grand nombre de syst√®mes critiques, en particulier dans les syst√®mes d'automatisation m√©dicaux et d'√âtat. <br><br>  La taille de la base de donn√©es et le nombre d'utilisateurs actifs dans de tels syst√®mes sont g√©n√©ralement assez importants, donc dans cet article, je parlerai de l'exp√©rience de l'optimisation des param√®tres Firebird et Linux sur la base d'exemples sp√©cifiques de grandes bases de donn√©es Firebird √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BeZdorov</a> (Ingosstrakh), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AlfaZdrav</a> , et je <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parlerai de l'</a> exp√©rience d'autres soci√©t√©s d'optimisation Firebird + Linux. <br><br>  Examinons de plus pr√®s le sujet de l'optimisation - Firebird 3.0.5 DBMS (avec extensions HQbird), sert une base de donn√©es de 691 Go (actuellement) avec 1000-1100 utilisateurs quotidiens, fonctionne sur Linux CentOS 7, le serveur utilise un fer HP DL380.  La r√©plication vers le serveur de sauvegarde est configur√©e pour la base de donn√©es (la question de la r√©plication sort du cadre de cet article). <br><a name="habracut"></a><br>  Le SGBD dessert le syst√®me d'information m√©dicale Infoklinika (produit par la soci√©t√© russe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Smart Delta Systems</a> ), qui est l'un des syst√®mes d'information m√©dicale les plus populaires en Russie. <br><br>  Jetons un coup d'≈ìil aux d√©tails (les captures d'√©cran sont extraites de HQbird plus tard) du fonctionnement de cette base de donn√©es: <br><br>  Les donn√©es sont ins√©r√©es de mani√®re intensive dans la base de donn√©es - un gain quotidien d'environ 0,4 √† 0,5 Go <br><br><img src="https://habrastorage.org/webt/vf/v7/4k/vfv74kl3pcxkou42snnuyv98fqg.png"><br><br>  1000-1100 connexions est la charge quotidienne habituelle: <br><br><img src="https://habrastorage.org/webt/73/qj/5t/73qj5tu1spoxlkq7debfz8ifn2q.png"><br><br>  Malgr√© une croissance intensive et un travail actif, la base de donn√©es ne contient pas de quantit√© significative de versions de d√©chets des enregistrements - √† la fois gr√¢ce √† des applications √©crites avec une bonne connaissance de l'architecture multi-versions et en raison d'un garbage collection correctement configur√©: <br><br><img src="https://habrastorage.org/webt/sy/zg/rj/syzgrjtckhyhydolkmeufwwgb_q.png"><br><br>  Marqueurs de transaction dans la zone verte: <br><br><img src="https://habrastorage.org/webt/vn/1h/wu/vn1hwu2celimgvpgtioyfugumsi.png"><br><br>  Soit dit en passant, notez que les donn√©es dans la base de donn√©es sont des cha√Ænes, des blobs sont pr√©sents, mais il y en a peu - seulement 10 Go sur 690 Go de la taille totale. <br><br>  La nature de la charge de la base de donn√©es est mixte, 75% des op√©rations de lecture et 25% d'√©criture: <br><br><img src="https://habrastorage.org/webt/k2/gr/xz/k2grxztnytufblqb0y6idmfljeo.png"><br><br><h3>  Le fer </h3><br>  Le serveur qui dessert ce syst√®me n'est pas mauvais, mais loin d'√™tre haut de gamme: <br><br><pre><code class="plaintext hljs">HP ProLiant DL380p Gen8, Gen8 2x Xeon(R) CPU E5v2 @ 2.60GHz, 24 logical cores with HT 320Gb RAM, 4 network cards</code> </pre> <br>  Le sous-syst√®me de disque se compose de deux parties: un disque local de 745 Go et une double connexion Fibre Channel 2 vers le SAN, avec une partition de 1,8 To. <br><br><h3>  Syst√®me d'exploitation </h3><br>  Avec CentOS 7, version du noyau: <br><br><pre> <code class="plaintext hljs">Linux version 3.10.0-957.21.3.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) ) #1 SMP Tue Jun 18 16:35:19 UTC 2019</code> </pre><br>  √Ä la question logique, pourquoi le noyau le plus moderne et CentOS 8 ne sont pas utilis√©s, la r√©ponse est √©galement logique - la migration des syst√®mes critiques ne se produit qu'apr√®s la publication de plusieurs versions mineures et des tests rigoureux - c'est l'un de ces cas o√π un bogue connu vaut mieux que deux inconnues. <br><br>  Cependant, il convient de noter que jusqu'en 2017, le syst√®me fonctionnait sur CentOS 6.x, et apr√®s la migration, une am√©lioration significative des indicateurs de performance a √©t√© constat√©e. <br><br><h2>  Configuration Linux </h2><br><h3>  Une personnalisation Linux absolument essentielle pour Firebird </h3><br>  Il y a 2 param√®tres qui doivent √™tre augment√©s sur tous les serveurs Linux sur lesquels Firebird fonctionne - le nombre de zones de m√©moire virtuelle (VMA) et le nombre de fichiers ouverts pour le processus Firebird. <br><br>  <b>1. VMA</b> <br><br>  Le num√©ro VMA par d√©faut est 64 Ko, il doit √™tre augment√© 4 fois, pour cela, ajoutez la ligne dans sysctl.conf <br><br><pre> <code class="bash hljs">vm.max_map_count=262144</code> </pre> <br>  Pour v√©rifier la valeur actuelle, utilisez la commande <br><br><pre> <code class="bash hljs">sysctl vm.max_map_count</code> </pre> <br>  <b>2. Max fichiers ouverts</b> <br><br>  Firebird ouvre jusqu'√† 20 descripteurs (descripteurs de fichiers) pour chaque connexion √† la base de donn√©es (compte tenu du fait que sous Linux toutes les ressources ressemblent √† des fichiers), le nombre maximal de fichiers ouverts par d√©faut (g√©n√©ralement 4096) peut donc √™tre √©puis√© tr√®s rapidement. <br><br>  Pour v√©rifier le nombre de fichiers disponibles pour Firebird, il est pr√©f√©rable de regarder les limites du fichier ex√©cutable Firebird: <br><br><pre> <code class="bash hljs">cat /proc/$(pgrep firebird)/limits</code> </pre> <br>  o√π v√©rifier la valeur de Max Open Files et les augmenter si n√©cessaire. <br><br>  Pour augmenter le param√®tre Max Open Files pour Firebird, nous avons ajout√© la ligne au fichier firebird-superserver.service dans la section [service]: <br><br><pre> <code class="bash hljs">LimitNOFILE=49999</code> </pre> <br><h3>  Configuration Linux en option </h3><br>  Sur ce serveur, nous avons √©galement effectu√© les r√©glages suivants <br><br>  <b>1. √âchange r√©duit</b> <br><br>  √âtant donn√© que le serveur est exclusivement d√©di√© au SGBD Firebird et que nous voulons utiliser efficacement la RAM sous le cache du SGBD et le cache de fichiers du syst√®me d'exploitation, nous r√©duisons la perm√©abilit√© de 60% √† 10% par d√©faut, pour cela nous avons ajout√© sysctl.conf <br><br><pre> <code class="bash hljs">vm.swappiness=10</code> </pre> <br>  <b>2. Augmentation de la taille minimale de m√©moire r√©serv√©e pour les processus OS sp√©ciaux</b> <br><br><pre> <code class="bash hljs">vm.min_free_kbytes=1048576</code> </pre> <br>  soit 1 Go de m√©moire.  Ce param√®tre affecte indirectement la d√©fragmentation de la m√©moire. <br><br>  Veuillez noter que ce param√®tre est individuel - √©tant donn√© que nous avons 320 Go de RAM, 1 Go n'est pas tellement, mais dans le cas d'une petite quantit√© de m√©moire (par exemple, 32 Go), 1 Go pourrait √™tre trop. <br><br>  <b>3. Keepalive r√©duit</b> <br><br>  Firebird s'appuie sur des intervalles de keepalive pour v√©rifier l'√©tat de la connexion, et la valeur par d√©faut de keepalive peut √™tre tr√®s grande.  En le limitant √† 300 secondes, on se d√©barrasse des connexions suspendues <br><br><pre> <code class="bash hljs">net.ipv4.tcp_keepalive_time=300 net.ipv4.tcp_keepalive_probes=5 net.ipv4.tcp_keepalive_intvl=15</code> </pre> <br><h3>  Plus d'optimisation Linux </h3><br>  Pourquoi sommes-nous limit√©s √† un si petit nombre de param√®tres Linux? <br><br>  Premi√®rement, nous adoptons une approche conservatrice pour r√©gler les serveurs avec Linux (qui s'am√©liore de plus en plus avec chaque nouvelle version), et deuxi√®mement, cette base de donn√©es Firebird n'est ni extr√™mement grande ni la plus charg√©e, et Linux fait face aux param√®tres sp√©cifi√©s avec vos t√¢ches. <br><br>  Bien s√ªr, il existe plusieurs autres param√®tres qui peuvent √™tre utilis√©s pour optimiser Firebird sur Linux - par exemple, un certain nombre de choses int√©ressantes ont √©t√© pr√©sent√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©sentation de la base de donn√©es Firebird 3 To (RedBaza)</a> du Federal Bailiff Service. <br><br><h2>  Configurer Firebird </h2><br>  Les fichiers de configuration de la communaut√© Firebird avec firebirdsql.org sont configur√©s de mani√®re tr√®s conservatrice, et sur un serveur plus ou moins puissant, vous devez modifier les fichiers de configuration et s√©lectionner soigneusement l'architecture utilis√©e (dans Firebird 3.0, il existe 2 types de connexions: Embedded et NetworkServer, et 3 types d'architectures: SuperServer , SuperClassic, Classic). <br>  En outre, vous devez utiliser les param√®tres de chaque base de donn√©es - c'est-√†-dire  mettre les param√®tres critiques dans databases.conf, en r√©f√©rence √† une base de donn√©es sp√©cifique. <br><br>  Dans notre cas, nous avons choisi l'architecture SuperServer, la plus populaire de la version 3.0, car  il utilise efficacement des processeurs multic≈ìurs et dispose d'un cache partag√© pour toutes les connexions (mais s√©par√© pour chaque base de donn√©es). <br><br>  Voici les fichiers de configuration (valeurs li√©es aux performances uniquement): <br><br>  <b>firebird.conf - fichier de configuration pour toutes les bases de donn√©es sur le serveur</b> <br><br><pre> <code class="plaintext hljs">DefaultDbCachePages = 50K # pages FileSystemCacheThreshold = 300K # pages TempBlockSize = 2M # bytes TempCacheLimit = 20480M # bytes LockMemSize = 30M # bytes LockHashSlots = 30011 WireCompression = true ServerMode = Super ExtConnPoolSize = 500 # HQBird ExtConnPoolLifeTime = 14200 # HQBird SortDataStorageThreshold = 8192 #HQbird reports queries</code> </pre> <br>  En termes de performances, les param√®tres cl√©s sont les suivants: <br><br>  <b>1. DefaultDbCachePages = 50K # il est mesur√© en pages, sur une base de donn√©es, √† la page 16K = 0.8Gb</b> <br><br>  La taille du cache de page DefaultDbCachePages dans firebird.conf est sp√©cialement d√©finie par d√©faut √† 800 Mo afin que la base de donn√©es de test encombr√©e accidentellement sur le serveur n'essaye pas de prendre une √©norme quantit√© de RAM. <br><br>  <b>2. FileSystemCacheThreshold = 300K # pages</b> <br><br>  Il est important de d√©finir ce param√®tre sur une valeur sup√©rieure √† DefaultDBCachePages afin de permettre l'utilisation du cache de fichiers du syst√®me d'exploitation. <br><br>  <b>3. TempCacheLimit = 20480M # octets</b> <br><br>  Ce param√®tre d√©finit la taille de la m√©moire pour les requ√™tes avec tri (et certaines autres op√©rations) et est individuel pour chaque syst√®me. <br>  √Ä la suite de la surveillance de la taille des tris, nous avons constat√© que 20 Go est optimal pour cette base de donn√©es. <br><br>  <b>4. LockMemSize et LockHashSlots - param√®tres de la table de verrouillage</b> <br><br>  Ces param√®tres d√©terminent la taille initiale de la table de verrouillage et le nombre d'emplacements pour le calcul de la fonction de hachage. <br><br>  <b>5. WireCompression = True</b> <br><br>  La configuration du trafic compress√© entre les clients et les serveurs est particuli√®rement utile avec une instruction d'ex√©cution intensive sur externe, qui ex√©cute l'application cliente. <br><br>  Les param√®tres restants sont d√©crits dans firebird.conf lui-m√™me et dans la documentation connexe de Firebird et HQbird. <br><br>  Nous avons effectu√© les r√©glages les plus importants dans <b>databases.conf</b> , avec la base de donn√©es exacte <br><br><pre> <code class="plaintext hljs">database1 = /data/database1.fdb { DefaultDbCachePages = 14080K # 16K pages, 220 GB FileSystemCacheThreshold = 15361K TempSpaceCacheThreshold=2G #HQbird only, track big sorts LockHashSlots = 40099 LockMemSize = 50M }</code> </pre> <br>  Comme vous pouvez le deviner, la principale difficult√© dans ce cas est de savoir comment calculer correctement la taille de la m√©moire allou√©e par notre grande base de donn√©es. <br><br>  Pour Firebird 3.0 avec architecture SuperServer, il existe deux approches - conservatrice, qui est utilis√©e sur les serveurs avec une petite quantit√© de RAM (jusqu'√† 32 Go inclus), qui consiste √† allouer pas plus de 25% de RAM pour le cache de pages, et le reste d√©pend du syst√®me d'exploitation de fichiers syst√®mes, et le r√©glage fin, lorsque nous d√©terminons pr√©cis√©ment la taille optimale pour le tri, allouons une certaine taille de m√©moire pour le noyau du syst√®me d'exploitation, r√©servons une certaine quantit√© de m√©moire pour les op√©rations de fichiers massives (par exemple, la sauvegarde),  le reste allou√© pour le cache de page. <br><br>  Dans le deuxi√®me cas, il n'est pas possible d'obtenir imm√©diatement la taille de cache optimale, car la nature de la charge peut diff√©rer consid√©rablement pour diff√©rents types de bases de donn√©es, mais apr√®s plusieurs it√©rations, vous pouvez obtenir un excellent r√©sultat. <br><br><h3>  Erreurs courantes dans la configuration de Firebird </h3><br>  Les erreurs typiques sont les suivantes: <br><br>  1) La taille du cache de page sp√©cifi√©e explicitement sur la page d'en-t√™te de base de donn√©es, qui remplace les valeurs sp√©cifi√©es dans firebird.conf et databases.conf. <br><br>  Cette erreur se produit particuli√®rement souvent lors du changement d'architecture de Classic / SuperClassic en SuperServer - si la taille du cache pour la connexion Classic / SuperClassic fonctionne correctement avec une petite taille clairement indiqu√©e (500-2000 pages), alors un cache beaucoup plus grand est n√©cessaire pour SuperServer. <br>  Pour v√©rifier, ex√©cutez la commande <br><br><pre> <code class="plaintext hljs">gstat -h databasepathname</code> </pre> <br>  et v√©rifiez la valeur des <code>Page Buffers</code> - elle doit √™tre 0, puis Firebird utilisera les valeurs de databases.conf ou firebird.conf. <br><br>  Pour r√©initialiser le param√®tre de cache de page sur la page d'en-t√™te, ex√©cutez la commande <br><br><pre> <code class="plaintext hljs">gfix -buff 0 databasepathname</code> </pre> <br>  2) Lors de l'augmentation du cache de pages, ils oublient d'augmenter le FileSystemCacheThreshold, ce qui entra√Æne la d√©connexion du cache de fichiers, ce qui r√©duit les performances. <br><br>  3) Utilisation de la taille de page de base de donn√©es par d√©faut (4096 ou 8192), tandis que pour les grandes bases de donn√©es, vous devez utiliser 16 Ko. <br><br><h2>  Conclusion </h2><br>  En g√©n√©ral, plus de 1000 utilisateurs Firebird sur fer, correspondant √† la charge configur√©e par Linux et configur√©e par Firebird, fonctionnent sans probl√®me.  Il y a une marge sur ce serveur en termes de performances, qui a √©t√© test√© √† des charges de pointe pour jusqu'√† 1500-1800 utilisateurs. <br><br>  Parmi les distributions Linux pour la base de donn√©es Firebird avec une charge similaire, la plus populaire est CentOS 7, la version recommand√©e est Firebird 3.0. <br><br>  Si vous avez des questions, je me ferai un plaisir de vous r√©pondre dans les commentaires, ou par email ak@ibase.ru. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476636/">https://habr.com/ru/post/fr476636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476618/index.html">Comment j'ai con√ßu le kit Focus</a></li>
<li><a href="../fr476620/index.html">SP701 + PCAM-5C + 15 minutes + VITIS = Easy MIPI sur FPGA</a></li>
<li><a href="../fr476624/index.html">Pipelines de qualit√© dans le d√©veloppement mobile, partie 1: Android</a></li>
<li><a href="../fr476626/index.html">PVS-Studio dans les nuages: GitLab CI / CD</a></li>
<li><a href="../fr476628/index.html">PVS-Studio passe aux nuages: GitLab CI / CD</a></li>
<li><a href="../fr476640/index.html">Protection de Zimbra OSE contre la force brute et les attaques DoS</a></li>
<li><a href="../fr476644/index.html">Couches linguistiques</a></li>
<li><a href="../fr476646/index.html">Fusion √† 3 voies dans werf: d√©ploiement dans Kubernetes avec Helm "sous st√©ro√Ødes"</a></li>
<li><a href="../fr476648/index.html">Lenovo √† FINOPOLIS 2019</a></li>
<li><a href="../fr476650/index.html">La place de l'√©num√©ration dans le monde en mutation d'aujourd'hui</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>