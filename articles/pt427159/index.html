<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèª üíõ üëµüèø Coletamos logs do firewall Mikrotik em um banco de dados üöÄ üßëüèø‚Äçü§ù‚Äçüßëüèª ü§πüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Boa tarde 

 Quero dizer com que facilidade e natural voc√™ pode configurar um servidor de coleta de metadados de tr√°fego de rede para roteadores Mikro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Coletamos logs do firewall Mikrotik em um banco de dados</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/">  Boa tarde <br><br>  Quero dizer com que facilidade e natural voc√™ pode configurar um servidor de coleta de metadados de tr√°fego de rede para roteadores Mikrotik. <br><br>  <b>Objetivo:</b> O objetivo ser√° armazenar os logs de firewall "mastigados" em um banco de dados para an√°lise posterior. <br><br>  <b>Significa:</b> Qualquer distribui√ß√£o Linux nova com o rsyslogd v8 e superior √© adequada para implementa√ß√£o, talvez a sintaxe proposta tamb√©m funcione na v7.  Tamb√©m precisamos de um DBMS, eu escolhi o mariadb.  O crescimento do banco de dados varia de acordo com o n√∫mero de regras registradas, porque o tamanho da unidade √© a seu crit√©rio, no meu caso, s√£o registradas 30 a 40 regras, o que equivale a 1200 mil linhas por dia.  Durante o m√™s de uso do banco de dados, incluindo √≠ndices, ele cresceu para 3,8 GB. <br><br>  <b>Mec√¢nica: O</b> roteador envia um log para o servidor remoto via UDP.  Usando express√µes regulares, o servidor rsyslog limpa seq√º√™ncias de informa√ß√µes desnecess√°rias, gera uma inser√ß√£o SQL e a envia ao DBMS.  O DBMS, usando um gatilho antes da inser√ß√£o, executa limpeza e separa√ß√£o adicionais de campos que n√£o puderam ser analisados ‚Äã‚Äãno rsyslog. <br><a name="habracut"></a><br><h4>  <b>Configurar o RSYSLOG</b> </h4><br>  Editando o arquivo /etc/rsyslog.conf <br>  Adicione as seguintes linhas l√°: <br><br><pre><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  Assim, carregamos os m√≥dulos necess√°rios e abrimos a porta 514 UDP. <br><br>  A linha de log do Mikrotik fica assim: <br><br><pre> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  Como voc√™ pode ver, muitos extras para armazenamento no banco de dados e uma sele√ß√£o clara ser√£o dif√≠ceis. <br>  Em teoria, preciso adicionar esses dados: <br><br><pre> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  N√£o consegui obter essa linha usando apenas um rsyslog.  Os usu√°rios regulares do Rsyslog usam POSIX ERE / BRE, portanto, n√£o h√° como aplicar recursos como lookahead ou lookbehind. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Existe</a> uma ferramenta que permite depurar usu√°rios regulares, tente, talvez voc√™ possa separar a porta do endere√ßo, bem como o nome da interface entre in: e out:.  Lembre-se de que alguns protocolos de esporte e de dados est√£o ausentes. <br><br>  Em geral, minha sa√≠da foi a seguinte: <br><br><pre> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">H√°</a> documenta√ß√£o sobre como preparar os regulares do rsyslog. <br><br>  No formato final, o arquivo de configura√ß√£o para receber o log do Mikrotik /etc/rsyslog.d/20-remote.conf ter√° a seguinte apar√™ncia: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  Na primeira linha, a descri√ß√£o do modelo (modelo) √© uma linha de c√≥digo SQL para transferi-lo para o DBMS. <br>  A segunda linha √© a condi√ß√£o em que a a√ß√£o ocorrer√°, ou seja, o registro no DBMS. <br>  A condi√ß√£o se parece com a seguinte: se a origem do log = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) E se a linha msg contiver ‚Äúfirewall‚Äù (e ($ syslogtag cont√©m ‚Äúfirewall‚Äù)), use o m√≥dulo ommysql com par√¢metros de conex√£o ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) chamamos o modelo tpl_traflog ( <code>template="tpl_traflog")</code> ) e, depois disso, paramos o processamento adicional da linha ( <code>stop}</code> ). <br><br>  √â poss√≠vel que, no seu caso, algo d√™ errado, seja devido aos nomes das interfaces ou prefixos de log, talvez algo mais.  Para depura√ß√£o, faremos o seguinte, comentaremos na segunda linha, adicionaremos um novo modelo e duas novas condi√ß√µes: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  Reinicie o logger. <br><br>  O modelo tpl_traflog_test √© semelhante ao tpl_traflog, mas sem o SQL INSERT. <br><br>  A primeira condi√ß√£o adiciona a linha n√£o processada% msg% ao arquivo /var/log/remote/192.168.0.230.log, porque o modelo n√£o est√° especificado. <br><br>  A segunda condi√ß√£o adiciona a linha processada ao mesmo arquivo. <br>  Portanto, ser√° mais conveniente comparar. <br>  Em seguida, prepare o banco de dados. <br><br><h4>  <b>Preparamos um banco de dados</b> </h4><br>  Abaixaremos a configura√ß√£o do DBMS, tudo √© padr√£o aqui. <br><br>  Iniciamos o console do mysql e executamos o seguinte c√≥digo: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  A tabela est√° pronta, o usu√°rio est√°. <br><br>  Agora adicione um gatilho, ele far√° o que o logger falhou ao separar o endere√ßo da porta, limpar os nomes das interfaces, remover os colchetes da bandeira: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE procura o segundo par√¢metro ap√≥s o ponto decimal (temporada regular) e o substitui pelo terceiro par√¢metro; no nosso caso, n√£o h√° nada entre aspas; portanto, ele simplesmente remove o que encontra. <br><br>  Vamos fazer uma inser√ß√£o de teste, semelhante √† maneira como o logger far√°: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Vamos ver o que aconteceu: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  Se tudo estiver correto, siga em frente.  Caso contr√°rio, procure o erro. <br><br>  Adicione pelo menos um √≠ndice.  Eu n√£o sou mestre em criar √≠ndices, mas como eu o entendo, no mysql √© mais correto usar √≠ndices com campos de jun√ß√£o diferentes para consultas diferentes, pois uma consulta pode usar apenas um √≠ndice (ou estou errado?).  Se voc√™ entender, fa√ßa-o a seu crit√©rio. <br>  Muitas vezes tenho que fazer solicita√ß√µes com um prefixo espec√≠fico, ent√£o adicionei este √≠ndice: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  Feito. <br><br>  Agora voc√™ precisa come√ßar a enviar o roteador, adicionar as configura√ß√µes e a√ß√µes do servidor de log remoto, adicionar a op√ß√£o de log a uma das regras de firewall, adicionar um prefixo de no m√°ximo 24 caracteres. <br><br>  No console Mikrotik, √© algo como isto: <br><br><pre> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  Onde 192.168.0.230 √© o endere√ßo do roteador, 192.168.0.19 √© o endere√ßo do servidor de log para os logs do firewall e 192.168.0.94 √© outro servidor de log, eu tenho os logs do sistema Mikrotik, n√£o precisamos dele agora.  Nossa configura√ß√£o √© remota2. <br><br>  Em seguida, veja o que se enquadra no arquivo: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  As linhas do roteador devem ser espalhadas no arquivo, a menos que sua regra funcione com bastante frequ√™ncia. <br><br>  Se alguns campos estiverem ausentes, ou seja, a sequ√™ncia datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len n√£o for seguida, voc√™ poder√° tentar alterar o par√¢metro nos modelos de depura√ß√£o do logger, substitua BLANK por DLFT.  Ent√£o, em vez do vazio de qualquer campo, algumas letras aparecer√£o, n√£o lembro quais.  Se isso acontecer, algo est√° errado com a programa√ß√£o regular e voc√™ precisar√° corrigi-la. <br><br>  Se tudo correu como deveria, desative as condi√ß√µes de teste e o modelo. <br><br>  Voc√™ tamb√©m precisa executar a configura√ß√£o padr√£o em /etc/rsyslog.d/ abaixo, renomei-a para 50-default.conf para que os logs remotos n√£o sejam despejados no log do sistema / var / log / message <br>  Reinicie o logger. <br><br>  Vamos esperar um pouco at√© que nosso banco de dados esteja cheio.  Ent√£o podemos come√ßar a sele√ß√£o. <br><br>  <b>Algumas consultas para um exemplo:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Para ver o tamanho do banco de dados e o n√∫mero de linhas:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  Quase 4 GB cresceram em um m√™s, mas isso depende do n√∫mero e das propriedades das regras de firewall registradas <br></div></div><br><div class="spoiler">  <b class="spoiler_title">N√∫mero de prefixos registrados</b> <div class="spoiler_text">  O n√∫mero de prefixos registrados n√£o √© igual ao n√∫mero de regras, algumas regras funcionam com um prefixo, mas ainda quantos prefixos totais?  e quantas regras foram elaboradas para eles? <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET √© o l√≠der, por esse prefixo, voc√™ pode encontrar todos os que acessaram a Internet a partir de nossa rede local, protocolos e portas s√£o registrados, chegar√° a hora e o acesso ser√° fechado para alguns.  Existem dados de refer√™ncia para trabalhos futuros sobre bugs. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">L√≠der da lan√ßa Smtp</b> <div class="spoiler_text">  Vamos ver quem hoje tentou acessar o servidor smtp: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  Claramente, o n√≥ 191.96.249.92 √© o vencedor hoje.  Vamos ver em quais regras registradas ele ainda apareceu: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  Este √© especializado apenas em smtp, ~ 1% dos acessos por tentar adivinhar a senha ou tentar enviar um pouco de lixo; o restante foi para a casa de banhos. <br><br>  A solicita√ß√£o demorou 10 minutos, √© muito, os √≠ndices atuais n√£o s√£o adequados para ela ou voc√™ pode reformular a solicita√ß√£o, mas agora n√£o falaremos sobre isso. <br></div></div><br>  No futuro, est√° planejado estragar a interface da web com consultas e formul√°rios padr√£o. <br>  O vetor √© dado, espero que este artigo seja √∫til. <br><br>  Obrigado a todos! <br><br>  <b>Refer√™ncias:</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o Rsyslog</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o do mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o de log do Mikrotik</a> <br><br>  Obrigado √† comunidade LOR pelas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dicas.</a> <br><br>  <b>UPD.1</b> <br>  Adicionado o campo de sinalizadores ao banco de dados, agora voc√™ pode acompanhar a dura√ß√£o da conex√£o capturando SYN, FIN. <br>  Corrigidos alguns erros nos regulares do rsyslog, bem como nos gatilhos do mysql. <br><br>  Curiosamente, a regra padr√£o defconf: drop invalid remove todos os pacotes finais de conex√µes TCP, como resultado, todos os n√≥s que tentam fechar a conex√£o na ci√™ncia falham, enviando v√°rios FINs.  Isso est√° certo? <br><br>  Eu adicionei uma regra que permite a travessia do TCP com sinalizadores ACK, FIN. <br><br>  Sob o spoiler SQL, um procedimento que mostra o tempo das conex√µes TCP nos √∫ltimos cinco minutos <br><div class="spoiler">  <b class="spoiler_title">connections_list ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  Como resultado do procedimento, duas tabelas tempor√°rias ser√£o criadas. <br>  A tabela <b>conn_syn_fin</b> cont√©m entradas de log com os sinalizadores SYN e FIN e, em seguida, √© realizada uma pesquisa usando o cursor nesta tabela. <br>  A tabela sem <b>conex√£o</b> cont√©m uma lista de conex√µes, abertas e conclu√≠das, conclu√≠das com uma dura√ß√£o de abertura, respectivamente, n√£o. <br>  Observe o tempo de amostragem menos cinco minutos a partir da hora atual.  Meu pedido √© lento.  Lentamente, ele percorre a pesquisa do cursor, processa cerca de 10 registros por segundo, tenta acelerar de todas as formas, mas o tempo de execu√ß√£o √© sempre o mesmo. <br>  Observe tamb√©m que este procedimento √© apenas para fins de demonstra√ß√£o.  Se voc√™ precisar fazer uma sele√ß√£o para um src / sport / dst / dport espec√≠fico, √© melhor fazer um procedimento separado semelhante a este.  Se voc√™ √© um mestre sql, pode escrever sua consulta melhor. <br><br><div class="spoiler">  <b class="spoiler_title">chame connections_list ();</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  Ap√≥s a conclus√£o do procedimento, as tabelas tempor√°rias <b>conn_syn_fin</b> e <b>connless</b> permanecem, voc√™ pode v√™-las com mais detalhes se encontrar algo suspeito ou n√£o confi√°vel.  Ap√≥s o in√≠cio do procedimento, as tabelas antigas s√£o exclu√≠das e novas s√£o exibidas.  Escreva se encontrar algum erro. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427159/">https://habr.com/ru/post/pt427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427145/index.html">A melhor maneira de come√ßar a estudar gen√©tica moderna, biologia molecular, engenharia gen√©tica e gen√¥mica</a></li>
<li><a href="../pt427147/index.html">‚ÄúModelo de Refer√™ncia BIAN‚Äù para o setor banc√°rio ou como parar de reinventar a roda</a></li>
<li><a href="../pt427149/index.html">Alto-falantes RADIOTEHNIKA S-30 antigos para novos</a></li>
<li><a href="../pt427151/index.html">O processo educacional em TI: Olympiads, bolsas, programas de apoio e comunidades da Universidade ITMO</a></li>
<li><a href="../pt427155/index.html">Southampton Filter Bus - O primeiro passo para cidades mais limpas</a></li>
<li><a href="../pt427163/index.html">Novo material ajudar√° a tornar as usinas t√©rmicas solares mais eficientes</a></li>
<li><a href="../pt427165/index.html">Como desenvolver testes de integra√ß√£o para o Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../pt427169/index.html">Tesla removeu silenciosamente a op√ß√£o de piloto autom√°tico completo</a></li>
<li><a href="../pt427171/index.html">Seguran√ßa deixando voc√™</a></li>
<li><a href="../pt427173/index.html">A telefonia √© mais barata que a gratuita?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>