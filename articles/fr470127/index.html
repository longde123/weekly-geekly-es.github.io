<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíñ üòï ‚ÜòÔ∏è Compositeur avec une longue m√©moire √† court terme üíã üîå üêà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Composer automatiquement de la musique 

 Presque imm√©diatement apr√®s avoir appris la programmation, j'ai voulu cr√©er un logiciel capable de composer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compositeur avec une longue m√©moire √† court terme</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470127/"><h2>  Composer automatiquement de la musique </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e91/f1e/b09/e91f1eb09e53ad458aaaeca5650b59aa.jpg" width="500"></div><br>  Presque imm√©diatement apr√®s avoir appris la programmation, j'ai voulu cr√©er un logiciel capable de composer de la musique. <br><br>  Pendant plusieurs ann√©es, j'ai fait des tentatives primitives pour composer automatiquement de la musique pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Visions of Chaos</a> .  Fondamentalement, des formules math√©matiques simples ou des mutations g√©n√©tiques de s√©quences al√©atoires de notes ont √©t√© utilis√©es.  Ayant r√©cemment obtenu un succ√®s modeste dans l'√©tude et l'application de TensorFlow et de r√©seaux de neurones pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">rechercher des automates cellulaires</a> , j'ai d√©cid√© d'essayer d'utiliser des r√©seaux de neurones pour cr√©er de la musique. <br><br><h2>  Comment √ßa marche </h2><br>  Le compositeur enseigne un r√©seau neuronal √† m√©moire √† court terme (LSTM).  Les r√©seaux LSTM sont bien adapt√©s pour pr√©dire la suite des s√©quences de donn√©es.  En savoir plus sur LSTM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0db/ce9/120/0dbce9120efb949af9aff64a8177c02f.png" title="LSTM - Cliquez pour la taille d'origine" width="500"></div><br>  Un r√©seau LSTM re√ßoit diff√©rentes s√©quences de notes (dans ce cas, il s'agit de fichiers midi √† canal unique).  Apr√®s une formation suffisante, elle a l'opportunit√© de cr√©er une musique similaire au mat√©riel p√©dagogique. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f1/b32/98d/3f1b3298dededa70f51a95d42727aaf0.png" title="LSTM - Cliquez pour la taille d'origine" width="500"></div><br>  Les composants internes LSTM peuvent sembler intimidants, mais l'utilisation de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">TensorFlow</a> et / ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Keras</a> simplifie consid√©rablement la cr√©ation et l'exp√©rimentation LSTM. <br><br><h2>  Musique source pour la formation de mod√®les </h2><br>  Pour des r√©seaux LSTM aussi simples, il nous suffit que les compositions sources soient un seul canal midi.  Les fichiers midi du solo au piano sont parfaits pour cela.  J'ai trouv√© des fichiers midi avec des solos de piano sur la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">page Midi Piano classique</a> et des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">fichiers mfiles</a> , et je les ai utilis√©s pour entra√Æner mes mod√®les. <br><br>  J'ai mis la musique de diff√©rents compositeurs dans des dossiers s√©par√©s.  Gr√¢ce √† cela, l'utilisateur peut s√©lectionner Bach, cliquer sur le bouton Composer et obtenir une chanson qui (esp√©rons-le) ressemblera √† Bach. <br><br><h2>  Mod√®le LSTM </h2><br>  Le mod√®le sur la base duquel j'ai √©crit le code a s√©lectionn√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet exemple de l'</a> auteur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Sigur√∞ur Sk√∫li Sigurgeirsson</a> , √† propos duquel il √©crit plus en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> . <br><br>  J'ai ex√©cut√© le script lstm.py et apr√®s 15 heures, il a termin√© la formation.  Lorsque j'ai ex√©cut√© predit.py pour g√©n√©rer les fichiers midi, j'ai √©t√© d√©√ßu car ils consistaient en une seule note r√©p√©titive.  En r√©p√©tant la formation deux fois, j'ai obtenu les m√™mes r√©sultats. <br><br>  Mod√®le source <br><br><pre><code class="python hljs">model = Sequential() model.add(CuDNNLSTM(<span class="hljs-number"><span class="hljs-number">512</span></span>,input_shape=(network_input.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>], network_input.shape[<span class="hljs-number"><span class="hljs-number">2</span></span>]),return_sequences=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.3</span></span>)) model.add(CuDNNLSTM(<span class="hljs-number"><span class="hljs-number">512</span></span>, return_sequences=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.3</span></span>)) model.add(CuDNNLSTM(<span class="hljs-number"><span class="hljs-number">512</span></span>)) model.add(Dense(<span class="hljs-number"><span class="hljs-number">256</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.3</span></span>)) model.add(Dense(n_vocab)) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)) model.compile(loss=<span class="hljs-string"><span class="hljs-string">'categorical_crossentropy'</span></span>, optimizer=<span class="hljs-string"><span class="hljs-string">'rmsprop'</span></span>,metrics=[<span class="hljs-string"><span class="hljs-string">"accuracy"</span></span>])</code> </pre> <br>  Apr√®s avoir ajout√© une sortie graphique au script, j'ai vu pourquoi mon mod√®le ne fonctionnait pas.  La pr√©cision n'a pas augment√© avec le temps, comme il se doit.  Voir ci-dessous dans le post pour de bons graphiques qui montrent √† quoi devrait ressembler le mod√®le de travail. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/28c/2ef/19d/28c2ef19dee58e8235a240b536162ceb.jpg" title="Cliquez pour la taille d'origine" width="500"></div><br>  Je ne savais pas pourquoi c'√©tait arriv√©.  mais a abandonn√© ce mod√®le et a commenc√© √† ajuster les param√®tres. <br><br><pre> <code class="python hljs">model = Sequential() model.add(CuDNNLSTM(<span class="hljs-number"><span class="hljs-number">512</span></span>, input_shape=(network_input.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>], network_input.shape[<span class="hljs-number"><span class="hljs-number">2</span></span>]), return_sequences=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.2</span></span>)) model.add(BatchNormalization()) model.add(CuDNNLSTM(<span class="hljs-number"><span class="hljs-number">256</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.2</span></span>)) model.add(BatchNormalization()) model.add(Dense(<span class="hljs-number"><span class="hljs-number">128</span></span>, activation=<span class="hljs-string"><span class="hljs-string">"relu"</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.2</span></span>)) model.add(BatchNormalization()) model.add(Dense(n_vocab)) model.add(Activation(<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)) model.compile(loss=<span class="hljs-string"><span class="hljs-string">'categorical_crossentropy'</span></span>, optimizer=<span class="hljs-string"><span class="hljs-string">'adam'</span></span>,metrics=[<span class="hljs-string"><span class="hljs-string">"accuracy"</span></span>])</code> </pre> <br>  Il est plus compact et a moins de couches LSTM.  J'ai √©galement ajout√© BatchNormalization, le voyant dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">vid√©o sentdex</a> .  Tr√®s probablement, il existe de meilleurs mod√®les, mais celui-ci a tr√®s bien fonctionn√© dans toutes mes s√©ances d'entra√Ænement. <br><br>  Notez que dans les deux mod√®les, j'ai remplac√© LSTM par CuDNNLSTM.  J'ai donc obtenu une formation LSTM beaucoup plus rapide gr√¢ce √† l'utilisation de Cuda.  Si vous ne disposez pas d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">GPU avec prise en charge Cuda</a> , vous devez utiliser LSTM.  Merci √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">sendtex</a> pour cette astuce.  L'apprentissage de nouveaux mod√®les et la composition de fichiers midi √† l'aide de CuDNNLSTM est environ cinq fois plus rapide. <br><br><h2>  Pendant combien de temps le mod√®le doit-il √™tre form√© </h2><br>  La similitude des r√©sultats avec la musique originale d√©pend de la dur√©e de la formation du mod√®le (le nombre d'√©poques).  S'il y a trop peu d'√©poques, le r√©sultat r√©sultant aura trop de notes r√©p√©titives.  S'il y a trop d'√©poques, le mod√®le sera recycl√© et copiera simplement la musique originale. <br><br>  Mais comment savoir combien d'√©poques s'arr√™ter? <br><br>  Une solution simple consiste √† ajouter un rappel qui stocke le mod√®le et le graphique de pr√©cision / perte toutes les 50 √©poques lors d'une session d'entra√Ænement sur 500 √©poques.  Gr√¢ce √† cela, apr√®s avoir termin√© la formation, vous obtiendrez des mod√®les et des graphiques avec un incr√©ment de 50 √©poques, montrant comment la formation se d√©roule. <br><br>  Voici les r√©sultats des graphiques d'une course avec sauvegarde toutes les 50 √©poques, combin√©s en un GIF anim√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e93/357/716/e933577163ece7cc7e679edec71d0b90.gif"></div><br>  Ce sont les graphiques que nous voulons voir.  Les pertes devraient chuter et rester faibles.  La pr√©cision devrait augmenter et rester proche de 100%. <br><br>  Il est n√©cessaire d'utiliser un mod√®le dont le nombre d'√©poques correspond au moment o√π les graphiques ont atteint leurs limites pour la premi√®re fois.  Pour le graphique ci-dessus, ce sera 150 √©poques.  Si vous utilisez des mod√®les plus anciens, ils seront recycl√©s et entra√Æneront tr√®s probablement une simple copie du mat√©riel source. <br><br>  Le mod√®le correspondant √† ces colonnes a √©t√© form√© sur des fichiers midi de la cat√©gorie Anthems extraits <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">d'ici</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Sortie de donn√©es midi dans un mod√®le de 150 √©poques. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Sortie midi dans un mod√®le de 100 √©poques. <br><br>  M√™me un mod√®le avec 100 √©poques peut copier la source trop pr√©cis√©ment.  Cela peut √™tre d√ª √† un √©chantillon relativement petit de fichiers midi pour la formation.  Avec plus de notes, l'apprentissage est meilleur. <br><br><h2>  Quand l'apprentissage tourne mal </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/166/c17/97c/166c1797ceb0baa6894a982d55ce12ed.jpg" title="Cliquez pour la taille d'origine" width="500"></div><br>  L'image ci-dessus montre un exemple de ce qui peut et se produit pendant l'entra√Ænement.  Les pertes sont r√©duites et la pr√©cision est augment√©e, comme d'habitude, mais soudain, elles commencent √† devenir folles.  √Ä ce stade, cela peut √©galement valoir la peine de s'arr√™ter.  Le mod√®le n'apprendra plus (du moins d'apr√®s mon exp√©rience) correctement.  Dans ce cas, le mod√®le enregistr√© avec 100 √©poques est encore trop al√©atoire et avec 150 √©poques, le moment de d√©faillance du mod√®le est d√©j√† pass√©.  Maintenant, je suis sauv√© toutes les 25 √©poques pour trouver exactement le moment id√©al du mod√®le avec la meilleure formation, avant m√™me qu'elle ne se recycle et ne s'√©crase. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/486/65a/eea/48665aeea577e093ad0d944a4b4a3a35.jpg" title="Cliquez pour la taille d'origine" width="500"></div><br>  Un autre exemple d'erreur d'apprentissage.  Ce mod√®le a √©t√© form√© sur des fichiers midi pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> .  Dans ce cas, elle a bien tenu pendant un peu plus de 200 √©poques.  Lors de l'utilisation d'un mod√®le √† 200 √©poques, le r√©sultat suivant est obtenu en Midi. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Sans la cr√©ation de graphiques, nous ne saurions jamais si le mod√®le a des probl√®mes et quand ils sont survenus, et nous ne pourrions pas non plus obtenir un bon mod√®le sans repartir de z√©ro. <br><br><h2>  Autres exemples </h2><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le √† 75 √©poques, cr√©√© √† partir des compositions de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Chopin</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le des ann√©es 50 bas√© sur des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">fichiers Midi pour les compositions de No√´l</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 100 √©poques bas√© sur des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">fichiers Midi pour des compositions de No√´l</a> .  Mais sont-ils vraiment ¬´No√´l¬ª? <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 300 √©poques bas√© sur des fichiers Bach Midi pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">d'ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">d'ici</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 200 √©poques bas√© sur le seul fichier Midi de Balakirev pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Mod√®le √† 200 √©poques, bas√© sur des compositions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Debussy</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 175 √®res bas√© sur les compositions de Mozart. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le √† 100 √©poques bas√© sur les compositions de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Schubert</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le datant de 200 ans bas√© sur des compositions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Schumann</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 200 ans bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">les</a> compositions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">de Tcha√Økovski</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le avec 175 √©poques bas√© sur des chansons folkloriques. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Mod√®le √† 100 √©poques bas√© sur des berceuses. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le centenaire bas√© sur la musique de mariage. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b21/d24/c00/b21d24c00c73a214714352d2c3b1f900.png" title="Cliquez pour √©couter Midi" width="26"></a> <br><br>  Un mod√®le de 200 √©poques bas√© sur mes propres fichiers midi extraits de mes bandes sonores <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">vid√©o YouTube</a> .  Il peut √™tre un peu recycl√© car il g√©n√®re essentiellement des copies de mes courts fichiers MIDI √† un et deux temps. <br><br><h2>  Les scores </h2><br>  Une fois <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">vos</a> fichiers midi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">r√©cup√©r√©s</a> , vous pouvez utiliser des outils en ligne comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">SolMiRe</a> pour les convertir en partitions.  Vous trouverez ci-dessous la partition du fichier midi Softology 200-epoch pr√©sent√© ci-dessus. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e4/7fe/2cc/1e47fe2cc3cada4e27671bfe27397226.jpg" title="Cliquez pour la taille d'origine" width="500"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccd/2ff/dff/ccd2ffdff1344ef7ad97a210dba6b17e.jpg" title="Cliquez pour la taille d'origine" width="500"></div><br><h2>  O√π puis-je tester le compositeur </h2><br>  LSTM Composer est d√©sormais inclus dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">Visions of Chaos</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29c/abd/6ac/29cabd6acecf1baf6fd9f99e531d1f9e.jpg" width="500"></div><br>  S√©lectionnez un style dans la liste d√©roulante et cliquez sur Composer.  Si vous avez install√© le minimum de Python et TensorFlow n√©cessaires (voir les instructions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener">ici</a> ), en quelques secondes (si vous avez un GPU rapide), vous recevrez un nouveau fichier midi compos√© par une machine que vous pouvez √©couter et utiliser √† d'autres fins.  Aucun droit d'auteur, aucune redevance.  Si vous n'aimez pas les r√©sultats, vous pouvez cliquer √† nouveau sur Composer et apr√®s quelques secondes, une nouvelle composition sera pr√™te. <br><br>  Les r√©sultats ne peuvent pas encore √™tre consid√©r√©s comme des compositions √† part enti√®re, mais ils ont d'int√©ressantes petites s√©quences de notes que je vais utiliser pour cr√©er de la musique √† l'avenir.  √Ä cet √©gard, le compositeur LSTM peut √™tre une bonne source d'inspiration pour de nouvelles compositions. <br><br><h2>  Source Python </h2><br>  Vous trouverez ci-dessous le code de script Python que j'ai utilis√© pour la formation et les pr√©visions LSTM.  Pour que ces scripts fonctionnent, il n'est pas n√©cessaire d'installer Visions of Chaos, et l'apprentissage et la g√©n√©ration de midi fonctionneront √† partir de la ligne de commande. <br><br>  Voici le script de formation <code>lstm_music_train.py</code> <br><br><div class="spoiler">  <b class="spoiler_title">lstm_music_train.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># based on code from https://github.com/Skuldur/Classical-Piano-Composer # to use this script pass in; # 1. the directory with midi files # 2. the directory you want your models to be saved to # 3. the model filename prefix # 4. how many total epochs you want to train for # eg python -W ignore "C:\\LSTM Composer\\lstm_music_train.py" "C:\\LSTM Composer\\Bach\\" "C:\\LSTM Composer\\" "Bach" 500 import os import tensorflow as tf # ignore all info and warning messages os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2' tf.compat.v1.logging.set_verbosity(tf.compat.v1.logging.ERROR) import glob import pickle import numpy import sys import keras import matplotlib.pyplot as plt from music21 import converter, instrument, note, chord from datetime import datetime from keras.models import Sequential from keras.layers.normalization import BatchNormalization from keras.layers import Dense from keras.layers import Dropout from keras.layers import CuDNNLSTM from keras.layers import Activation from keras.utils import np_utils from keras.callbacks import TensorBoard from shutil import copyfile # name of midi file directory, model directory, model file prefix, and epochs mididirectory = str(sys.argv[1]) modeldirectory = str(sys.argv[2]) modelfileprefix = str(sys.argv[3]) modelepochs = int(sys.argv[4]) notesfile = modeldirectory + modelfileprefix + '.notes' # callback to save model and plot stats every 25 epochs class CustomSaver(keras.callbacks.Callback): def __init__(self): self.epoch = 0 # This function is called when the training begins def on_train_begin(self, logs={}): # Initialize the lists for holding the logs, losses and accuracies self.losses = [] self.acc = [] self.logs = [] def on_epoch_end(self, epoch, logs={}): # Append the logs, losses and accuracies to the lists self.logs.append(logs) self.losses.append(logs.get('loss')) self.acc.append(logs.get('acc')*100) # save model and plt every 50 epochs if (epoch+1) % 25 == 0: sys.stdout.write("\nAuto-saving model and plot after {} epochs to ".format(epoch+1)+"\n"+modeldirectory + modelfileprefix + "_" + str(epoch+1).zfill(3) + ".model\n"+modeldirectory + modelfileprefix + "_" + str(epoch+1).zfill(3) + ".png\n\n") sys.stdout.flush() self.model.save(modeldirectory + modelfileprefix + '_' + str(epoch+1).zfill(3) + '.model') copyfile(notesfile,modeldirectory + modelfileprefix + '_' + str(epoch+1).zfill(3) + '.notes'); N = numpy.arange(0, len(self.losses)) # Plot train loss, train acc, val loss and val acc against epochs passed plt.figure() plt.subplots_adjust(hspace=0.7) plt.subplot(2, 1, 1) # plot loss values plt.plot(N, self.losses, label = "train_loss") plt.title("Loss [Epoch {}]".format(epoch+1)) plt.xlabel('Epoch') plt.ylabel('Loss') plt.subplot(2, 1, 2) # plot accuracy values plt.plot(N, self.acc, label = "train_acc") plt.title("Accuracy % [Epoch {}]".format(epoch+1)) plt.xlabel("Epoch") plt.ylabel("Accuracy %") plt.savefig(modeldirectory + modelfileprefix + '_' + str(epoch+1).zfill(3) + '.png') plt.close() # train the neural network def train_network(): sys.stdout.write("Reading midi files...\n\n") sys.stdout.flush() notes = get_notes() # get amount of pitch names n_vocab = len(set(notes)) sys.stdout.write("\nPreparing note sequences...\n") sys.stdout.flush() network_input, network_output = prepare_sequences(notes, n_vocab) sys.stdout.write("\nCreating CuDNNLSTM neural network model...\n") sys.stdout.flush() model = create_network(network_input, n_vocab) sys.stdout.write("\nTraining CuDNNLSTM neural network model...\n\n") sys.stdout.flush() train(model, network_input, network_output) # get all the notes and chords from the midi files def get_notes(): # remove existing data file if it exists if os.path.isfile(notesfile): os.remove(notesfile) notes = [] for file in glob.glob("{}/*.mid".format(mididirectory)): midi = converter.parse(file) sys.stdout.write("Parsing %s ...\n" % file) sys.stdout.flush() notes_to_parse = None try: # file has instrument parts s2 = instrument.partitionByInstrument(midi) notes_to_parse = s2.parts[0].recurse() except: # file has notes in a flat structure notes_to_parse = midi.flat.notes for element in notes_to_parse: if isinstance(element, note.Note): notes.append(str(element.pitch)) elif isinstance(element, chord.Chord): notes.append('.'.join(str(n) for n in element.normalOrder)) with open(notesfile,'wb') as filepath: pickle.dump(notes, filepath) return notes # prepare the sequences used by the neural network def prepare_sequences(notes, n_vocab): sequence_length = 100 # get all pitch names pitchnames = sorted(set(item for item in notes)) # create a dictionary to map pitches to integers note_to_int = dict((note, number) for number, note in enumerate(pitchnames)) network_input = [] network_output = [] # create input sequences and the corresponding outputs for i in range(0, len(notes) - sequence_length, 1): sequence_in = notes[i:i + sequence_length] # needs to take into account if notes in midi file are less than required 100 ( mod ? ) sequence_out = notes[i + sequence_length] # needs to take into account if notes in midi file are less than required 100 ( mod ? ) network_input.append([note_to_int[char] for char in sequence_in]) network_output.append(note_to_int[sequence_out]) n_patterns = len(network_input) # reshape the input into a format compatible with CuDNNLSTM layers network_input = numpy.reshape(network_input, (n_patterns, sequence_length, 1)) # normalize input network_input = network_input / float(n_vocab) network_output = np_utils.to_categorical(network_output) return (network_input, network_output) # create the structure of the neural network def create_network(network_input, n_vocab): ''' """ create the structure of the neural network """ model = Sequential() model.add(CuDNNLSTM(512, input_shape=(network_input.shape[1], network_input.shape[2]), return_sequences=True)) model.add(Dropout(0.3)) model.add(CuDNNLSTM(512, return_sequences=True)) model.add(Dropout(0.3)) model.add(CuDNNLSTM(512)) model.add(Dense(256)) model.add(Dropout(0.3)) model.add(Dense(n_vocab)) model.add(Activation('softmax')) model.compile(loss='categorical_crossentropy', optimizer='rmsprop',metrics=["accuracy"]) ''' model = Sequential() model.add(CuDNNLSTM(512, input_shape=(network_input.shape[1], network_input.shape[2]), return_sequences=True)) model.add(Dropout(0.2)) model.add(BatchNormalization()) model.add(CuDNNLSTM(256)) model.add(Dropout(0.2)) model.add(BatchNormalization()) model.add(Dense(128, activation="relu")) model.add(Dropout(0.2)) model.add(BatchNormalization()) model.add(Dense(n_vocab)) model.add(Activation('softmax')) model.compile(loss='categorical_crossentropy', optimizer='adam',metrics=["accuracy"]) return model # train the neural network def train(model, network_input, network_output): # saver = CustomSaver() # history = model.fit(network_input, network_output, epochs=modelepochs, batch_size=50, callbacks=[tensorboard]) history = model.fit(network_input, network_output, epochs=modelepochs, batch_size=50, callbacks=[CustomSaver()]) # evaluate the model print("\nModel evaluation at the end of training") train_acc = model.evaluate(network_input, network_output, verbose=0) print(model.metrics_names) print(train_acc) # save trained model model.save(modeldirectory + modelfileprefix + '_' + str(modelepochs) + '.model') # delete temp notes file os.remove(notesfile) if __name__ == '__main__': train_network()</span></span></code> </pre> </div></div><br>  Et voici le script de g√©n√©ration midi <code>lstm_music_predict.py</code> : <br><br><div class="spoiler">  <b class="spoiler_title">lstm_music_predict.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># based on code from https://github.com/Skuldur/Classical-Piano-Composer # to use this script pass in; # 1. path to notes file # 2. path to model # 3. path to midi output # eg python -W ignore "C:\\LSTM Composer\\lstm_music_predict.py" "C:\\LSTM Composer\\Bach.notes" "C:\\LSTM Composer\\Bach.model" "C:\\LSTM Composer\\Bach.mid" # ignore all info and warning messages import os os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2' import tensorflow as tf tf.compat.v1.logging.set_verbosity(tf.compat.v1.logging.ERROR) import pickle import numpy import sys import keras.models from music21 import instrument, note, stream, chord from keras.models import Sequential from keras.layers import Dense from keras.layers import Dropout from keras.layers import Activation # name of weights filename notesfile = str(sys.argv[1]) modelfile = str(sys.argv[2]) midifile = str(sys.argv[3]) # generates a piano midi file def generate(): sys.stdout.write("Loading notes data file...\n\n") sys.stdout.flush() #load the notes used to train the model with open(notesfile, 'rb') as filepath: notes = pickle.load(filepath) sys.stdout.write("Getting pitch names...\n\n") sys.stdout.flush() # Get all pitch names pitchnames = sorted(set(item for item in notes)) # Get all pitch names n_vocab = len(set(notes)) sys.stdout.write("Preparing sequences...\n\n") sys.stdout.flush() network_input, normalized_input = prepare_sequences(notes, pitchnames, n_vocab) sys.stdout.write("Loading LSTM neural network model...\n\n") sys.stdout.flush() model = create_network(normalized_input, n_vocab) sys.stdout.write("Generating note sequence...\n\n") sys.stdout.flush() prediction_output = generate_notes(model, network_input, pitchnames, n_vocab) sys.stdout.write("\nCreating MIDI file...\n\n") sys.stdout.flush() create_midi(prediction_output) # prepare the sequences used by the neural network def prepare_sequences(notes, pitchnames, n_vocab): # map between notes and integers and back note_to_int = dict((note, number) for number, note in enumerate(pitchnames)) sequence_length = 100 network_input = [] output = [] for i in range(0, len(notes) - sequence_length, 1): sequence_in = notes[i:i + sequence_length] sequence_out = notes[i + sequence_length] network_input.append([note_to_int[char] for char in sequence_in]) output.append(note_to_int[sequence_out]) n_patterns = len(network_input) # reshape the input into a format compatible with LSTM layers normalized_input = numpy.reshape(network_input, (n_patterns, sequence_length, 1)) # normalize input normalized_input = normalized_input / float(n_vocab) return (network_input, normalized_input) # create the structure of the neural network def create_network(network_input, n_vocab): model = keras.models.load_model(modelfile) return model # generate notes from the neural network based on a sequence of notes def generate_notes(model, network_input, pitchnames, n_vocab): # pick a random sequence from the input as a starting point for the prediction start = numpy.random.randint(0, len(network_input)-1) int_to_note = dict((number, note) for number, note in enumerate(pitchnames)) pattern = network_input[start] prediction_output = [] # generate 500 notes for note_index in range(500): prediction_input = numpy.reshape(pattern, (1, len(pattern), 1)) prediction_input = prediction_input / float(n_vocab) prediction = model.predict(prediction_input, verbose=0) index = numpy.argmax(prediction) result = int_to_note[index] prediction_output.append(result) pattern.append(index) pattern = pattern[1:len(pattern)] if (note_index + 1) % 50 == 0: sys.stdout.write("{} out of 500 notes generated\n".format(note_index+1)) sys.stdout.flush() return prediction_output # convert the output from the prediction to notes and create a midi file from the notes def create_midi(prediction_output): offset = 0 output_notes = [] # create note and chord objects based on the values generated by the model for pattern in prediction_output: # pattern is a chord if ('.' in pattern) or pattern.isdigit(): notes_in_chord = pattern.split('.') notes = [] for current_note in notes_in_chord: new_note = note.Note(int(current_note)) new_note.storedInstrument = instrument.Piano() notes.append(new_note) new_chord = chord.Chord(notes) new_chord.offset = offset output_notes.append(new_chord) # pattern is a note else: new_note = note.Note(pattern) new_note.offset = offset new_note.storedInstrument = instrument.Piano() output_notes.append(new_note) # increase offset each iteration so that notes do not stack offset += 0.5 midi_stream = stream.Stream(output_notes) midi_stream.write('midi', fp=midifile) if __name__ == '__main__': generate()</span></span></code> </pre> </div></div><br><h2>  Tailles des fichiers mod√®les </h2><br>  L'inconv√©nient d'inclure des r√©seaux de neurones dans Visions of Chaos est la taille des fichiers.  Si la g√©n√©ration du mod√®le √©tait plus rapide, j'ajouterais simplement un bouton pour que l'utilisateur final puisse entra√Æner les mod√®les lui-m√™me.  Mais comme certaines sessions de formation pour de nombreux mod√®les peuvent prendre plusieurs jours, ce n'est pas particuli√®rement pratique.  Il m'a sembl√© qu'il valait mieux faire toute la formation et les tests vous-m√™me, et n'ajouter que les meilleurs mod√®les de travail.  Cela signifie √©galement que l'utilisateur final n'a qu'√† appuyer sur un bouton, et les mod√®les form√©s cr√©eront des compositions musicales. <br><br>  Chacun des mod√®les a une taille de 22 m√©gaoctets.  Dans les conditions de l'Internet moderne, ce n'est pas tant que √ßa, mais au fil des ann√©es de d√©veloppement, Visions of Chaos a grandi progressivement, et ce n'est que r√©cemment qu'il est soudainement pass√© de 70 √† 91 Mo (en raison du mod√®le de recherche d'automates cellulaires).  Par cons√©quent, je n'ai jusqu'√† pr√©sent ajout√© qu'un seul mod√®le au programme d'installation principal de Visions of Chaos.  Pour les utilisateurs qui en veulent plus, j'ai publi√© un lien vers 1 autre Go de mod√®les.  Ils peuvent √©galement utiliser le script ci-dessus pour cr√©er leurs propres mod√®les √† partir de leurs fichiers midi. <br><br><h2>  Et ensuite? </h2><br>  √Ä ce stade, le compositeur LSTM est l'exemple le plus simple d'utilisation de r√©seaux de neurones pour composer de la musique. <br><br>  J'ai d√©j√† trouv√© d'autres compositeurs de musique sur des r√©seaux de neurones que j'exp√©rimenterai √† l'avenir, vous pouvez donc vous attendre √† ce que dans Visions of Chaos, il y ait de nouvelles possibilit√©s pour composer automatiquement de la musique. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470127/">https://habr.com/ru/post/fr470127/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470115/index.html">Votre navigateur mobile rend la conduite difficile</a></li>
<li><a href="../fr470117/index.html">Se pr√©parer pour combiner</a></li>
<li><a href="../fr470121/index.html">√âcoles de programmation d'entreprise ou comment entrer en informatique</a></li>
<li><a href="../fr470123/index.html">Pi√®ge financier Yandex.Money</a></li>
<li><a href="../fr470125/index.html">Ne jugez pas strictement le code de quelqu'un d'autre</a></li>
<li><a href="../fr470129/index.html">Gestion de la m√©moire d√©clarative</a></li>
<li><a href="../fr470133/index.html">Comment collecter des m√©triques non d√©form√©es par r√©f√©rence temporelle avec Prometheus</a></li>
<li><a href="../fr470135/index.html">Une application web interactive sans programmation? C'est facile! Mavo dans tes bras</a></li>
<li><a href="../fr470145/index.html">"Attention, SAF!": Pourquoi le ticket militaire est-il dangereux dans la publicit√©, pourquoi est-il important de conna√Ætre les math√©matiques et si la v√©rit√© nue est toujours n√©cessaire</a></li>
<li><a href="../fr470149/index.html">Il n'y aura pas de collections immuables en Java - ni maintenant ni jamais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>