<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚗 🤰🏽 🤝 Versiegelte Klassen. Semantik gegen Leistung 🥇 👝 🧝🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wahrscheinlich nicht ich allein, nachdem ich die Dokumentation über versiegelte Klassen gelesen hatte, dachte ich: „Okay. Vielleicht wird es eines Tag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Versiegelte Klassen. Semantik gegen Leistung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430014/">  Wahrscheinlich nicht ich allein, nachdem ich die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation über versiegelte Klassen</a> gelesen hatte, dachte ich: „Okay.  Vielleicht wird es eines Tages nützlich sein. “  Später, als ich in meiner Arbeit einige Aufgaben traf, bei denen ich dieses Tool erfolgreich einsetzen konnte, dachte ich: „Nicht schlecht.  Sie sollten oft über die Anwendung nachdenken. “  Und schließlich stieß ich auf eine Beschreibung der Aufgabenklasse im Buch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Effective Java (Joshua Bloch, 3.)</a> (ja, im Buch über Java). <br><br>  Schauen wir uns eine Anwendung an und bewerten sie hinsichtlich Semantik und Leistung. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/th/tb/bb/thtbbbw3gitb5qb4n5sxhgq0oag.jpeg"></div><a name="habracut"></a><br>  Ich denke, jeder, der mit der Benutzeroberfläche gearbeitet hat, hat die Implementierung der Interaktion der Benutzeroberfläche mit dem <i>Dienst</i> in bestimmten <i>Zuständen erreicht</i> , in denen eine <i>Typmarkierung</i> eines der Attribute war.  Die Mechanik der Verarbeitung des nächsten Zustands in solchen Implementierungen hängt normalerweise direkt von der angegebenen Markierung ab.  Zum Beispiel eine solche Implementierung der <b>State-</b> Klasse: <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> type: Type, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: String?, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> error: Throwable? ) { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class"> </span></span>{ LOADING, ERROR, EMPTY, DATA } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Wir listen die Nachteile einer solchen Implementierung auf (probieren Sie es selbst aus)</b> <div class="spoiler_text"><blockquote>  Anmerkungen aus Kapitel 23 des Buches „Klassenhierarchien gegenüber markierten Klassen bevorzugen“.  Ich schlage vor, sie kennenzulernen. </blockquote><br><ol><li>  Speicherverbrauch für Attribute, die nur für bestimmte Typen initialisiert werden.  Der Faktor kann bei großen Mengen signifikant sein.  Die Situation wird noch verschärft, wenn Standardobjekte zum Auffüllen der Attribute erstellt werden. </li><li>  Übermäßige semantische Belastung.  Der Benutzer der Klasse muss überwachen, welcher Typ und welche Attribute verfügbar sind. </li><li>  Komplizierte Unterstützung in Geschäftslogikklassen.  Angenommen, eine Implementierung, bei der ein Objekt einige Operationen an seinen Daten ausführen kann.  Eine solche Klasse sieht aus wie ein <i>Mähdrescher</i> , und das Hinzufügen eines neuen Typs oder einer neuen Operation kann schwierig werden. </li></ol><br></div></div><br>  Die Verarbeitung eines neuen Status könnte folgendermaßen aussehen: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">State</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>(state.type) { State.Type.LOADING -&gt; onLoading() State.Type.ERROR -&gt; state.error?.run(::onError) ?: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> AssertionError(<span class="hljs-string"><span class="hljs-string">"Unexpected error state: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>) State.Type.EMPTY -&gt; onEmpty() State.Type.DATA -&gt; state.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>?.run(::onData) ?: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> AssertionError(<span class="hljs-string"><span class="hljs-string">"Unexpected data state: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$state</span></span></span><span class="hljs-string">"</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEmpty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">data</span></span></span></span><span class="hljs-function"><span class="hljs-params">: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> {}</code> </pre><br>  Bitte beachten Sie, dass der Compiler für Zustände wie ERROR und DATA die Sicherheit der Verwendung von Attributen nicht bestimmen kann, sodass der Benutzer redundanten Code schreiben muss.  Änderungen in der Semantik können nur zur Laufzeit erkannt werden. <br><br><h3>  Versiegelte Klasse </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/956/e26/aba/956e26abadccbdf82049a80523cf6c87.jpg" alt="Bild"></div><br>  Durch einfaches Refactoring können wir unseren <b>Staat</b> in eine Gruppe von Klassen aufteilen: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stateless</span></span></span><span class="hljs-class">  -     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Loading</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span></span>() <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> error: Throwable) : State() <span class="hljs-comment"><span class="hljs-comment">//  ,     ,  stateless  -  singleton object Empty : State() data class Data(val data: String) : State()</span></span></code> </pre><br>  Auf der Benutzerseite erhalten wir eine Statusverarbeitung, bei der die Zugänglichkeit von Attributen auf Sprachebene bestimmt wird und Missbrauch bei der Kompilierung zu Fehlern führt: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">State</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>(state) { Loading -&gt; onLoading() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Error -&gt; onError(state.error) Empty -&gt; onEmpty() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Data -&gt; onData(state.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) } }</code> </pre><br>  Da in Kopien nur signifikante Attribute vorhanden sind, können wir über das Speichern von Speicher und vor allem das Verbessern der Semantik sprechen.  Benutzer versiegelter Klassen müssen die Regeln für die Arbeit mit Attributen abhängig von der <i>Typmarkierung</i> nicht manuell implementieren. Die Verfügbarkeit von Attributen wird durch die Trennung in Typen sichergestellt. <br><br><h3>  Ist das alles kostenlos? </h3><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text">  Nein, nicht kostenlos. <br></div></div><br>  Die Java-Entwickler, die Kotlin ausprobiert haben, müssen sich den dekompilierten Code angesehen haben, um zu sehen, wie die Kotlin-Java-Begriffe aussehen.  Ein Ausdruck mit <b>wann</b> sieht ungefähr so ​​aus: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NotNull State state)</span></span></span><span class="hljs-function"> </span></span>{ Intrinsics.checkParameterIsNotNull(state, <span class="hljs-string"><span class="hljs-string">"state"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intrinsics.areEqual(state, Loading.INSTANCE)) { onLoading(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Error) { onError(((Error)state).getError()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intrinsics.areEqual(state, Empty.INSTANCE)) { onEmpty(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Data) { onData(((Data)state).getData()); } }</code> </pre><br>  Zweige mit einer Fülle von <b>Instanzen</b> können aufgrund von Stereotypen über das „Zeichen für schlechten Code“ und die „Auswirkungen auf die Leistung“ alarmierend sein, aber wir haben keine Ahnung.  Es ist notwendig, die Ausführungsgeschwindigkeit irgendwie zu vergleichen, zum Beispiel mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jmh</a> . <br><br>  Basierend auf dem Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">„Die Geschwindigkeit von Java-Code korrekt messen“</a> wurde ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Test zur</a> Verarbeitung von vier Zuständen (LOADING, ERROR, EMPTY, DATA) erstellt. Hier sind die Ergebnisse: <br><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units CompareSealedVsTagged.sealed thrpt 500 940739,966 ± 5350,341 ops/s CompareSealedVsTagged.tagged thrpt 500 1281274,381 ± 10675,956 ops/s</code> </pre><br>  Es ist ersichtlich, dass die versiegelte Implementierung 25% langsamer arbeitet (es wurde angenommen, dass die Verzögerung 10-15% nicht überschreiten würde). <br><br>  Wenn wir bei vier Typen eine viertel Verzögerung haben, mit zunehmenden Typen (Anzahl der Überprüfungsinstanzen), sollte die Verzögerung nur zunehmen.  Um dies zu überprüfen, erhöhen wir die Anzahl der Typen auf 16 (nehmen wir an, wir haben es geschafft, eine so breite Hierarchie zu erhalten): <br><br><pre> <code class="plaintext hljs">Benchmark Mode Cnt Score Error Units CompareSealedVsTagged.sealed thrpt 500 149493,062 ± 622,313 ops/s CompareSealedVsTagged.tagged thrpt 500 235024,737 ± 3372,754 ops/s</code> </pre><br>  Zusammen mit einem Rückgang der Produktivität stieg die Verzögerung der versiegelten Verkäufe auf 35% - kein Wunder geschah. <br><br><h3>  Fazit </h3><br>  In diesem Artikel haben wir Amerika nicht entdeckt, und versiegelte Implementierungen in Branchen funktionieren beispielsweise langsamer als Linkvergleiche. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dq/et/y-/dqety-iylhzbywcxttnbxtu29ri.jpeg"></div><br>  Dennoch müssen einige Gedanken geäußert werden: <br><br><ul><li>  In den meisten Fällen möchten wir mit einer guten Codesemantik arbeiten und die Entwicklung aufgrund zusätzlicher Hinweise aus der IDE und den Compilerprüfungen beschleunigen. In solchen Fällen können Sie versiegelte Klassen verwenden </li><li>  Wenn Sie die Leistung einer Aufgabe nicht beeinträchtigen können, sollten Sie die versiegelte Implementierung vernachlässigen und beispielsweise durch eine Tagget-Implementierung ersetzen.  Vielleicht sollten Sie Kotlin ganz zugunsten von Sprachen auf niedrigerer Ebene aufgeben </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430014/">https://habr.com/ru/post/de430014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430002/index.html">Red Hat Enterprise Linux 8 Beta - Zur gleichen Zeit mit der Welt</a></li>
<li><a href="../de430004/index.html">Nicht zertifizierter GPS-Tracker aus China. Ist es in Russland legal?</a></li>
<li><a href="../de430006/index.html">Data Science-Projekt von der Forschung bis zur Implementierung am Beispiel von Talking Hat</a></li>
<li><a href="../de430008/index.html">Ugears: Pferde, Segeln und andere königliche Unterhaltungen</a></li>
<li><a href="../de430010/index.html">Offene Lektion "Wie man nicht: Anti-Beispiele bei der Analyse von Geschäftsprozessen"</a></li>
<li><a href="../de430016/index.html">Wissenschaftler geben verwirrt zu, dass sie das genaue Ausmaß der Gravitationswechselwirkung immer noch nicht kennen</a></li>
<li><a href="../de430024/index.html">Wie ein Flugzeugabsturz die IT-Analyse verbessern kann</a></li>
<li><a href="../de430026/index.html">Nio beherbergt 18 Batteriewechselstationen, die mehr als 2.000 km Autobahn abdecken</a></li>
<li><a href="../de430028/index.html">10 bevorstehende Konferenzen und Hackathons in Moskau</a></li>
<li><a href="../de430030/index.html">Wie wir den Sport-Scout durch ein neuronales Netzwerk ersetzt haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>