<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôâÔ∏è üíü ü§ù Unit menguji skrip basis data üöò üç≥ üï¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Menerima kenyamanan menggunakan tes unit pada C ++ favorit saya, saya mencoba untuk mentransfer pengalaman saya ke TSQL, terutama karena majikan baru ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unit menguji skrip basis data</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417569/"> Menerima kenyamanan menggunakan tes unit pada C ++ favorit saya, saya mencoba untuk mentransfer pengalaman saya ke TSQL, terutama karena majikan baru suka inisiatif yang berguna di lapangan dan mendistribusikan roti untuk itu. <br><br>  Saya melihat melalui beberapa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kerangka kerja terkenal,</a> saya sampai pada kesimpulan bahwa, sebagai aturan, mereka besar dan membawa sintaks tambahan yang perlu dipelajari tambahan. <br><br>  Beberapa kerangka kerja bekerja dengan indah dan menyenangkan mata manajer, kepada siapa mereka ditampilkan, tetapi memiliki sejumlah keterbatasan yang saya tidak suka. <br><br>  Saya ingin mengimplementasikan semuanya pada TSQL halal-halal-Orthodox murni. <br><a name="habracut"></a><br>  Dari waktu ke waktu, mengalihkan perhatian dari pengembangan utama selama beberapa tahun karena mengasah struktur skrip, saya memutuskan untuk membagikannya kepada Anda (tetapi masih berhasil menghasilkan skrip 3,5 Mb). <br><br>  Persyaratan dasar saya sederhana - Saya harus melakukan uji unit dalam file tanpa perlu gerakan dan perangkat lunak khusus - hanya hardcore: sqlcmd atau MSSMS. <br><br>  Tidak ada perubahan yang dilakukan pada database di mana tes dilakukan - semuanya digulung kembali ke awal skrip. <br><br>  Hanya satu batasan yang ditetapkan - tes harus bekerja dalam database kosong (data awal mungkin), jika tidak Anda bosan membongkar semua opsi. <br><br>  Tugas utama adalah menguji logika dan menjaga integritas logika. <br><br>  Untuk ini, saya letakkan judul berikut di awal tes: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> PRINT <span class="hljs-string"><span class="hljs-string">'-------------------------------- CLR Unit tests for Habr Logic ---------------------------------'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> device) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RAISERROR (<span class="hljs-string"><span class="hljs-string">'FAILED: database must be empty for this unit test'</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Saya mencoba untuk tidak membuat tes unit lebih lama dari beberapa layar, meskipun ini tidak mudah, dalam kasus logika yang kompleks. <br><br>  Tes unit tipikal terlihat seperti ini dan memiliki 3 bagian utama: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRAN TestClr2 <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @test_name sysname = (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_tran_active_transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> transaction_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> transaction_begin_time <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>) + <span class="hljs-string"><span class="hljs-string">' [fn_calculate_dev_status] record for device has wrong range'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- 1. prepare data for unit test insert into device (mli, oxygen, stamp ) values ('111', 5.55, getdate() ) -- 2. execute unit test -- SELECT dbo.fn_calculate_dev_status( 111, 0.1, 1.2) declare @result int = ( SELECT dbo.fn_calculate_dev_status( '111', 0.1, 1.2) ) END TRY BEGIN CATCH SELECT ERROR_NUMBER() AS ErrorNumber, ERROR_SEVERITY() AS ErrorSeverity, ERROR_STATE() AS ErrorState , @test_name AS ErrorProcedure, ERROR_LINE() AS ErrorLine, ERROR_MESSAGE() AS ErrorMessage END CATCH -- 3. result verification IF @result &lt;&gt; 0 RAISERROR ('FAILED: %s no data for device should be presented %d ', 16, -1, @test_name, @result ) ELSE print 'PASSED ' + @test_name ROLLBACK TRAN TestClr2 GO</span></span></code> </pre> <br>  <b>- 1. menyiapkan data untuk unit test</b> <br><br>  Di sini kita bisa mengisi tabel yang diperlukan dengan data dan menyiapkan beberapa variabel sementara atau tabel agar tidak mengacaukan kode di bagian pengujian. <br><br>  <b>- 2. jalankan unit test</b> <br><br>  Di sini, sebagai aturan, ia dapat berfungsi, panggilan fungsi, atau prosedur, atau perubahan tabel, jika kami menguji logika pemicu. <br><br>  <b>- 3. verifikasi hasil</b> <br><br>  Di bagian pengujian ini, kami memeriksa bagaimana keadaan objek database telah berubah, atau hasil dari fungsi-prosedur yang diuji. <br><br>  Jika fungsi prosedur mengembalikan catatan, maka kami memasukkannya ke tabel sementara dan menganalisisnya. <br><br>  Hasil agregat dan disiapkan dibandingkan dengan standar dan melemparkan pengecualian jika semuanya gagal. <br><br>  Dengan Oracle, semuanya sedikit lebih rumit - saya tidak bisa melakukan penulisan dan menjalankan tes dalam bentuk itu dan dalam ideologi yang sama, bukan dari sedikit pengalaman - kami berhenti mendukung Oracle untuk produk kami. <br><br>  Setiap unit tes dikeluarkan sebagai prosedur: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> UnitTest9_TRG_JOBLOGDETAIL <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> v_message VARCHAR2(<span class="hljs-number"><span class="hljs-number">255</span></span>) := <span class="hljs-string"><span class="hljs-string">'UnitTest9_TRG_JOBLOGDETAIL: INSERT joblogdetail]- joblogdetail_result not Failed and joblogdetail_endtime is null '</span></span>; v_maxdate date := '2014/01/01'; v_cnt NUMBER := 0; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">savepoint</span></span> my_savepoint; &lt;b&gt;<span class="hljs-comment"><span class="hljs-comment">-- 1. prepare data for unit test&lt;/b&gt; insert into device ( dev_datecreated, dev_create_user, dev_ipaddress, dev_serialnumber , dev_productid, dev_manufacturer, dev_model, dev_id, dev_status, dev_functions) values (sysdate, 'Joe', '1.127.0.1', 'GSN-6238-N34', 'PRTF-452', 'Pinter Company', 'CM6003', 1, 1, 1 ); insert into joblog (JOBLOG_ID, joblog_starttime, joblog_progress) values (11, sysdate, 1); insert into joblog_template (JOBLOG_TEMPLATE_ID, joblog_id, joblog_templatename, joblog_templatetype) values (111, 11, N'joblog_template_test', 1); &lt;b&gt;-- 2. execute unit test&lt;/b&gt; insert into joblogdetail ( JOBLOGDETAIL_ID, joblog_template_id, joblogdetail_function, joblogdetail_functiondetail, joblogdetail_result, joblogdetail_dev_id, joblogdetail_starttime, joblogdetail_endtime) values ( 1111, 111, 1, 1, 40, 1, v_maxdate, v_maxdate); &lt;b&gt;-- 3. result verification&lt;/b&gt; SELECT count(dev_id) INTO v_cnt FROM device where dev_last_comm_time = v_maxdate; IF 1 &lt;&gt; v_cnt THEN DBMS_OUTPUT.PUT_LINE( 'FAILED: ' || v_message || ': Should not be update dev_last_comm_time: ' || TO_CHAR(v_maxdate)); ELSE DBMS_OUTPUT.PUT_LINE( 'PASSED: ' || v_message ); END IF; rollback to my_savepoint; END; /</span></span></code> </pre><br>  Pada file tes yang sama di akhir, Anda harus melakukan pembersihan database dari tes yang dibuat dan dijalankan. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> serveroutput <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> FEEDBACK <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>; spool C:\dist\test.spl; exec UnitTest_empty_database; exec UnitTest3297_TRGBFR_UDEVICE(1); exec UnitTest5_TRG_BF_UDEVICE; exec UnitTest_3062a; ... spool off; / <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> UnitTest_3062; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> UnitTest_BIRDIESEC_3344; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> UnitTest_empty_database; ... <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> FEEDBACK <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>;</code> </pre> <br>  Itu saja. <br><br>  Kemudian Anda hanya menghasilkan file, dibagi ke dalam kategori jenis: pemicu, fungsi, prosedur, laporan, objek besar dan khusus dari logika bisnis, dan tentu saja, untuk setiap objek basis data. <br><br>  Hampir semua pengembang basis data mengerutkan kening dan berkata - mengapa saya harus, biarkan penguji melakukan ini.  Jika database tidak memiliki logika dari kata sama sekali, maka saya setuju dengan mereka, tetapi jika ada banyak, maka mereka secara alami menyelamatkan saraf, reputasi dan uang. <br><br>  Sebuah contoh <br><br>  Kami memiliki pohon antarmuka web koneksi logis antara objek pohon seperti Amerika -&gt; Kanada -&gt; Ontario -&gt; Waterloo, Asia -&gt; Jepang -&gt; Tokyo -&gt; Ebina, yaitu, seluruh bola kantor geografis. <br><br>  Setiap node tersebut memiliki aturan yang sangat kompleks, pengguna atau aturan atau generator menetapkan perangkat. <br><br>  Akibatnya, bahkan instruksi yang dijelaskan secara rinci dalam langkah-langkah menghancurkan semua orang, bahkan mereka yang berpartisipasi dalam diskusi dan pengembangan logika ini. <br><br>  Lebih dari lima puluh langkah instruksi dengan set data yang berbeda - semuanya didokumentasikan secara rinci. <br><br>  Setiap perubahan atau penambahan pada logika adalah jam verifikasi manual yang tidak ada yang rusak. <br>  Refactoring kematian serupa. <br><br>  Setelah saya membahas logika dengan unit test, semuanya diperiksa oleh sutra dan saya yakin semuanya berfungsi sebagaimana mestinya. <br><br>  Setiap pengembang java menggunakan saya, melemparkan guntur dan kilat (berpikir sendiri tentang tangan saya yang bengkok) dengan mudah dilakukan dengan menjalankan tes yang sesuai. <br><br>  Beberapa menit dan semua orang puas.  Setiap perubahan kode fatal dalam ketidakhadiran saya akan cepat dilaporkan kepada saya melalui surat. <br><br>  Secara alami, sebagai orang yang malas, saya memutuskan untuk mengotomatisasi segalanya untuk Continuous Automation dan menulis bubur dari batch dan python. <br><br>  Saya meminta Anda untuk mengeksekusi sedikit, dalam pengembangan sehari-hari hampir selusin bahasa dan lingkungan di mana Anda harus melompat, ada kekurangan waktu untuk menjilat semuanya dan menempatkannya dalam tampilan profesional. <br><br>  Saya tidak ingin melakukan segalanya di Windows PowerShell - melompat kami masih berjalan di sana-sini pada Windows95 tertanam. <br><br>  Saya ingin membuat semua panggilan dengan Python, tetapi ternyata beberapa konstruksi sql (XML-parsing dalam cte) tidak didukung tidak hanya di pustaka python, tetapi juga dalam .NET, jadi saya melakukan scripting melalui sqlcmd. <br><br>  Kode diposting di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br>  Untuk menjalankan contoh yang berfungsi, cukup edit 2 file: smtppart.py dan config.ini - nama server SMTP, port dan email tempat pesan kesalahan akan dihapus. <br><br>  Skrip pertama kali mencoba untuk mendapatkan pembaruan terbaru dari svn (ganti dengan milik Anda - git, terpaksa, ...). <br><br>  Kemudian basis bersih dibuat dari skrip dengan nama acak, tes unit diluncurkan di dalamnya, kemudian basis dihapus. <br><br>  Membuat database skrip 80 Mb dan tes 3,5 Mb (bagian utama dari skema sudah dilakukan sebelum saya bergabung dengan perusahaan, jadi saya menguji hanya bagian saya) dilakukan pada mesin saya dalam waktu sekitar 15 menit.  Saya hanya punya waktu untuk minum secangkir kopi sebelum komit terakhir. <br><br>  Jika ada kesalahan, maka hasil kesalahan akan dikirim ke email. <br><br>  Instalasi ketergantungan dijelaskan dalam file: readme.txt <br><br>  Setelah setiap perubahan kode, Anda harus secara manual mengatur kode hash (akan terlihat di baris perintah) di file config.ini - pesan akan datang bahkan jika kode diubah dan tidak ada yang rusak - jadi saya dapat mengontrol perubahan dalam kode sehingga saya dapat memeriksa perubahan tanpa Keterlibatan saya sebelumnya. <br><br><img src="https://habrastorage.org/webt/vl/gg/rz/vlggrzeogy7ycduxjb1rjljxzmm.gif"><br><br>  Peluncuran semua tes unit dalam file autorun.bat dapat ditempatkan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Penjadwal Tugas Windows</a> untuk berjalan 1-2 hari sebelum perusahaan membangun atau setelah meninggalkan rumah - jika ada yang rusak di malam hari - Anda dapat melihat apa yang terjadi di depan TV dan dengan cepat memperbaikinya. <br><br>  Saya tahu bahwa dalam unit test itu yang paling sulit untuk mengatur semuanya, dan kemudian itu mudah dan menyenangkan untuk menulis tes, meskipun itu bisa sulit dan sulit, tetapi perlu.  Semoga sukses dalam pengujian, saya harap saran saya akan membantu seseorang. <br><br>  Saya akan dengan senang hati menerima saran jika sesuatu dapat ditingkatkan di suatu tempat dan menyisir kode, jangan menilai dengan ketat. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id417569/">https://habr.com/ru/post/id417569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id417557/index.html">Ikhtisar Mesin Laser CNC LaserSolid</a></li>
<li><a href="../id417559/index.html">Bagaimana China membuat Apple menyimpan kunci enkripsi pengguna iCloud di server negara Cina</a></li>
<li><a href="../id417561/index.html">Call of the Date, atau How adalah Mail kedua.Ru Mail hackathon</a></li>
<li><a href="../id417563/index.html">Berkat WebAssembly, Anda dapat menulis Frontend on Go</a></li>
<li><a href="../id417565/index.html">Google akan meletakkan kabel pribadi melintasi Atlantik</a></li>
<li><a href="../id417571/index.html">Bandit multi-bersenjata dalam rekomendasi</a></li>
<li><a href="../id417573/index.html">Pengembang AI yang terkenal di dunia sepakat untuk tidak membuat senjata pintar</a></li>
<li><a href="../id417577/index.html">Mesin CNC patut diperhatikan dari 3Dtool</a></li>
<li><a href="../id417579/index.html">Walmart dan Microsoft bekerja sama untuk melawan Amazon</a></li>
<li><a href="../id417581/index.html">Tidak, Anda tidak perlu belajar mesin. Anda membutuhkan SQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>