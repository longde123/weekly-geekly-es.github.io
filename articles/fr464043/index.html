<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì£ üë©‚Äçüöí üöú Histoire du convertisseur Ethernet-CAN üñáÔ∏è ‚õîÔ∏è üßíüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une journ√©e claire et ensoleill√©e pour le travail a n√©cessit√© un convertisseur d'interface CAN vers Ethernet peu co√ªteux. Naturellement, la recherche ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Histoire du convertisseur Ethernet-CAN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464043/">  Une journ√©e claire et ensoleill√©e pour le travail a n√©cessit√© un convertisseur d'interface CAN vers Ethernet peu co√ªteux.  Naturellement, la recherche a commenc√© avec des solutions toutes faites, mais, comme cela arrive souvent, il a finalement √©t√© d√©cid√© de d√©velopper leur propre √©chantillon.  Naturellement, l‚Äôenthousiasme de l‚Äôauteur n‚Äôa pas pu r√©sister et s‚Äôest limit√© √† une telle fonctionnalit√© ¬´tronqu√©e¬ª.  Qu'en est-il venu, comment et pourquoi - sous la coupe. <br><br><img src="https://habrastorage.org/webt/9c/j9/x_/9cj9x_lrqkpkajyzd6irhhqkfmu.jpeg" alt="image"><br><a name="habracut"></a><br>  <b>R√©sum√© g√©n√©ral.</b>  La photo ci-dessus montre un mod√®le 3D de la carte que j'ai d√©velopp√©e en utilisant CAD Altium Designer.  Caract√©ristiques et fonctionnalit√©s cl√©s: <br><br><ul><li>  Ethernet 10 \ 100 Mb </li><li>  Rtc </li><li>  MicroSD (FAT12, FAT16, FAT32) 4 Go </li><li>  RS232 \ RS485 </li><li>  CAN </li><li>  Buzzer </li><li>  3 LED utilisateur </li><li>  GPIO </li><li>  EEPROM 32 KB </li><li>  FLASH 2 Mo </li><li>  I2C </li><li>  SPI </li><li>  UART </li><li>  SW \ JTAG </li><li>  S√©rie USB (port COM) </li><li>  Puissance: miniUSB 5V \ External 9..24V </li></ul><br>  Le co√ªt de la carte collect√©e est d'environ 5000 R. Le projet est de nature open source, les sources peuvent √™tre trouv√©es sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b><u>github</u></b></a> .  Ce qui s'est av√©r√© en cons√©quence, en plus de la fonctionnalit√© principale, peut √™tre consid√©r√© comme une bonne carte de d√©bogage pour travailler avec le microcontr√¥leur STM32. <br><br>  Et maintenant aux d√©tails de la cr√©ation. <br><br><h3>  <b>Mat√©riel informatique</b> </h3><br>  L'√©tude de ce probl√®me a commenc√© par la recherche et l'√©valuation de solutions toutes faites.  Les principales exigences √©taient les suivantes: <br><br><ol><li>  conversion des trames CAN2.0B entrantes en paquets TCP \ IP et vice versa; </li><li>  √† faible co√ªt, par cons√©quent, la mise en ≈ìuvre d'un dispositif bas√© sur un microcontr√¥leur. </li></ol><br>  Des coll√®gues chinois ont plusieurs solutions industrielles, mais pas bon march√©, donc un repr√©sentant du convertisseur d'interface CAN-Ethernet PIRS de production nationale a √©t√© livr√© √† notre bureau pour un test.  Selon les capacit√©s et caract√©ristiques d√©crites, l'appareil satisfaisait le modeste T.Z., il ne restait plus qu'√† v√©rifier les performances en pratique, ce que j'ai fait, arm√© de Wireshark et de l'oscilloscope.  Pour une raison inconnue, lors de l'envoi de paquets vers le p√©riph√©rique TCP √† la sortie du p√©riph√©rique, o√π des trames CAN √©taient cens√©es appara√Ætre, des s√©quences avec des niveaux CAN physiques (paire diff√©rentielle) mais un protocole d'interface UART logique (avec des bits de d√©marrage et d'arr√™t) crachent.  En ouvrant le bo√Ætier, en ouvrant la documentation des microcircuits et en faisant sonner les pistes de la carte, j'ai trouv√© qu'en effet, les broches RX et TX (UART) du microcontr√¥leur sont connect√©es √† l'√©metteur-r√©cepteur CAN et sont connect√©es √† un connecteur externe de celui-ci.  Ainsi, aucun support mat√©riel pour la norme CAN2.0B n'√©tait √† pr√©voir. <br><br>  Voici ce que j'ai vu sur la sortie CANL de "PIRS CAN-Ethernet" lors de l'envoi de deux octets de donn√©es [ <b>0xF0</b> ] et [ <b>0x0A</b> ] sur TCP \ IP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6db/dca/c5a/6dbdcac5aec7d91503f4a5f86e28c42b.jpg" alt="image"><br><br>  L'ordre des bits est invers√©, mais vous pouvez le g√©rer par programme, mais il est d√©j√† plus difficile de faire quelque chose au niveau de l'application avec des bits de d√©marrage et d'arr√™t dans chaque octet, car  ils sont ins√©r√©s dans le mat√©riel. <br><br>  Et voici √† quoi devrait ressembler la "vraie" trame CAN2.0B avec les deux m√™mes octets de donn√©es: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/674/9b2/244/6749b2244e3b9aa0b7564701f285131a.jpg" alt="image"><br><br>  Comme vous pouvez le voir sur l'oscillogramme, en plus des octets de donn√©es, la trame contient de nombreux bits de service du protocole ainsi que des bits de bourrage, et surtout, ils vont en continu sans aucun bit de d√©marrage et d'arr√™t!  (Pour ceux qui sont int√©ress√©s, sous le spoiler une description d√©taill√©e de ce package). <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/54b/834/618/54b8346189dcb5ecdd01f83bcaab0e1b.jpg" alt="image"><br><br>  Les 4 premiers octets sont l'identifiant de trame.  Vous pouvez en savoir plus sur le format CAN √† partir de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[1]</a> <br></div></div><br>  Ainsi, il n'a pas √©t√© possible pour moi de r√©soudre le probl√®me d'incompatibilit√© des trames CAN et UART avec une m√©thode logicielle, et, en regardant les r√©sultats de la recherche interm√©diaire avec un regard d√©√ßu, il a √©t√© d√©cid√© de d√©velopper notre propre prototype du dispositif requis. <br><br>  √âtant donn√© qu'il √©tait d√©sormais possible de prendre le contr√¥le d'une plus large gamme de caract√©ristiques techniques de l'appareil, les exigences suivantes ont √©t√© ajout√©es: <br><br>  3. La capacit√© d'alimenter de 12-24 V dans les syst√®mes de transport; <br>  4. La pr√©sence de m√©moire externe pour stocker les journaux; <br>  5. Les dimensions de la carte ne d√©passent pas 86x80 mm. <br>  6. Plage de temp√©ratures de fonctionnement -40..85 ¬∞  <br><br>  La c√©l√®bre <b>plate-</b> forme <b>STM32F407VET6</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[2] a</a> √©t√© choisie comme cerveau du nouvel appareil, qui prend en charge le mat√©riel pour toutes les interfaces n√©cessaires et une bonne alimentation en m√©moire RAM et FLASH.  Apr√®s avoir peaufin√© Internet, l'√©metteur-r√©cepteur <b>DP83848IVV</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[3] a</a> √©t√© choisi comme PHY Ethernet, qui a, √† mon avis, une bonne documentation et suffisamment d'exemples de sch√©mas de connexion et de routage.  En tant que m√©moire non volatile externe pour le stockage des journaux, j'ai choisi SPI FLASH 2 Mo et SPI EEPROM pour stocker divers param√®tres.  De plus, la protection de l'alimentation contre les surtensions, l'inversion de polarit√© a √©t√© ajout√©e.  Apr√®s N soirs et M week-ends, un sch√©ma de circuit et une trace de la carte de circuit imprim√© de l'appareil de la premi√®re version ont √©t√© compil√©s.  Parce que  il y avait assez d'espace sur la carte, mais je ne voulais pas laisser les jambes MK inactives, en plus de la fonctionnalit√© principale, la carte a √©t√© ajout√©e: <br><br><ul><li>  outils de d√©bogage SW, JTAG; </li><li>  Commutateur 8 DIP; </li><li>  micro-USB (USB s√©rie); </li><li>  RS-232; </li><li>  UART </li><li>  I2C; </li><li>  GPIO </li></ul><br>  L'id√©e √©tait que, si n√©cessaire, la carte √©tait pr√™te √† √©tendre les fonctionnalit√©s en installant des composants suppl√©mentaires.  De plus, les si√®ges de rechange n'affectent pas le co√ªt de production.  D'un c√¥t√©, malheureusement, √† cause de cela, il n'√©tait pas possible de tout adapter, donc la carte s'est av√©r√©e √™tre 86x80mm bilat√©rale, min.  largeur de voie 0,25 mm, diam√®tre de trou min 0,6 mm. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1da/700/38b/1da70038b98ca9c7019df4d0f984d5d2.jpg" alt="image"><br>  <i>La premi√®re version de la conception PCB</i> <br><br>  Plus tard, deux √©chantillons de test ont √©t√© command√©s et assembl√©s avec un ensemble complet de p√©riph√©riques pour la recherche.  Afin d'√©conomiser de l'argent, la planche a √©t√© fabriqu√©e sans masque et a donc une couleur si inhabituelle. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db9/db1/5e4/db9db15e4cc7c7e0b2da0ed782d4a28b.jpg" alt="image"><br><br>  Avec l'aide de STM32CubeMX, j'ai esquiss√© un firmware de test avec un test de l'op√©rabilit√© des principaux modules p√©riph√©riques de l'appareil et, en premi√®re approximation, tout a fonctionn√© sauf le lancement du MK √† partir d'un quartz externe de 8 MHz.  Il s'est av√©r√© qu'en raison de mon erreur lors de l'√©laboration de la sp√©cification, les mauvais condensateurs de charge ont √©t√© soud√©s.  Mais cela n'a pas emp√™ch√© le STM32F407 de fonctionner avec un g√©n√©rateur RC interne.  Quand j'ai pu cingler mon appareil, il n'y avait aucune joie de retenue.  J'ai pris le plus de temps avec la trace Ethernet PHY.  Ensuite, dans le navigateur, j'ai vu ma page http de test et me suis calm√© avec les tests. <br><br>  La production des premiers √©chantillons des planches a √©t√© command√©e √† Zelenograd.  Et, malgr√© le fait que le co√ªt de ¬´avec¬ª le masque et ¬´sans¬ª √©tait presque deux fois diff√©rent, je ne recommande pas de le faire m√™me au stade du prototype, car, en r√®gle g√©n√©rale, c'est √† ce stade que les erreurs de trace apparaissent et que quelque chose se passe souder.  Mais se saouler sur les pistes ¬´nues¬ª est extr√™mement d√©sagr√©able, √©conomiser de l'argent, mais pratiquement pas de nerfs.  Oui, et deviner alors s'il y a eu une courte pause quelque part ou si la trace est incorrecte - un tel plaisir.  En raison de mon inexp√©rience, de la soudure d'un r√©sonateur √† quartz et de condensateurs de charge, j'ai tu√© un √©chantillon. <br><br>  √Ä ce moment-l√†, au travail, dans les bacs, il y avait un morceau de fer capable de r√©soudre la t√¢che de conversion dans le projet actuel, mais, en plus de la grande taille et du co√ªt, ayant √©crit un micrologiciel pour cela, j'ai rencontr√© des probl√®mes li√©s √† la taille de la RAM et √† la fonctionnalit√© tronqu√©e de la pile TCP \ IP MK LPC2368.  Le d√©sir de rendre votre appareil ne fait donc que s'intensifier. <br>  Ayant soigneusement √©tudi√© les lacunes de la premi√®re version, j'ai r√©fl√©chi sans r√©fl√©chir √† la seconde.  Et encore une fois, je voulais ajouter un ¬´carnet de commandes pour l'avenir¬ª, incorporant les composants suivants dans le facteur de forme pr√©c√©dent: <br><br><ul><li>  Prise en charge RTC avec batterie; </li><li>  RS-485; </li><li>  micro-SD; </li><li>  tweeter buzzer; </li><li>  Option d'alimentation USB </li><li>  SPI vers connecteur externe; </li><li>  Alimentation 5V et 3,3V vers un connecteur externe. </li></ul><br>  Entre autres choses, la protection actuelle de l'alimentation et les diodes TVS sur les connecteurs utilisateur ont √©t√© ajout√©es. <br><br>  Le r√©sultat est une sorte de carte de d√©veloppement avec la possibilit√© de connecter des modules externes.  Cette fois, j'ai command√© une planche en Chine.  Le montage a √©t√© effectu√© avec nous. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/924/1b4/c09/9241b4c09c97f002b49cd58dab0ab45b.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bde/d6e/f48/bded6ef48b3f6910968a1ae26c7500f4.jpg" alt="image"><br>  <i>La deuxi√®me version du tableau</i> <br><br>  Pour la deuxi√®me version, j'ai compris la mod√©lisation 3D dans Altium Designer, ce qui a beaucoup aid√© √† √©viter les erreurs dans le positionnement relatif des composants sur deux c√¥t√©s (il s'est av√©r√© que l'Internet avait d√©j√† beaucoup de mod√®les pr√™ts √† l'emploi de composants SMD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[4]</a> ).  Ainsi, toutes les erreurs de la premi√®re version ont √©t√© corrig√©es, les innovations ont montr√© leur efficacit√©, ce qui m'a fait tr√®s plaisir. <br><br><h3>  Firmware </h3><br>  La description du code d√©passe le cadre de cette partie, cependant je voudrais dire quelques mots sur le composant logiciel.  Dans mon appareil, j'ai d√©cid√© d'utiliser la pile FreeRTOS + LwIP.  Il existe un nombre suffisant d'articles √† leur sujet, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[5]</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[6]</a> , il ne devrait donc pas √™tre difficile de les lier √† votre projet.  En bref, LwIP est une pile TCP \ IP pour les syst√®mes embarqu√©s, caract√©ris√©e par une faible consommation de RAM et une API pratique (il y a m√™me un shell de socket BCD).  J'ai utilis√© l'API netconn.  Au moyen de FreeRTOS, tout le travail de la pile TCP \ IP est plac√© dans un flux distinct de l'application.  En plus du travail principal (connexion d'un serveur TCP externe au bus CAN), un serveur Web distinct tourne dans un flux ind√©pendant pour acc√©der aux param√®tres de l'appareil.  Une telle interface Web est destin√©e √† la surveillance et √† la configuration des param√®tres de l'appareil - d√©finition de diff√©rents modes de fonctionnement, vitesses de transmission, adresses, etc.  Je ne sais pas encore s'il sera possible de faire une mise √† jour du firmware par ce biais. <br><br><h3>  Conclusion </h3><br>  Ce fut mon premier (et j'esp√®re que ce n'est pas le dernier) projet mat√©riel d'une telle complexit√© et, malgr√© les erreurs commises, la deuxi√®me version de la carte, je pense, peut √™tre consid√©r√©e comme r√©ussie.  √Ä chaque it√©ration, il y avait beaucoup de doutes, mais, n√©anmoins, encore une fois, je suis convaincu que si vous n'essayez pas, rien ne se passera s√ªrement. <br><br><h3>  Sources utilis√©es </h3><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Wikipedia / Controller_Area_Network</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fiche technique STM32F407VET6</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fiche technique DP83848</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mod√®les 3D</a> <br>  5. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Introduction √† FreeRTOS</a> <br>  6. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Introduction au LwIP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464043/">https://habr.com/ru/post/fr464043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464027/index.html">Comment survivre au contenu √† l'√®re de l'explosion de l'information</a></li>
<li><a href="../fr464031/index.html">¬´Finds of an Audiomaniac¬ª: les cartes son comme moyen de se plonger dans l'atmosph√®re d'une ville inconnue</a></li>
<li><a href="../fr464037/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 472 (30/07/2019 - 05.08.2019)</a></li>
<li><a href="../fr464039/index.html">R√©seaux de neurones et apprentissage profond: un tutoriel en ligne, chapitre 6, partie 2: progr√®s r√©cents dans la reconnaissance d'images</a></li>
<li><a href="../fr464041/index.html">Pourquoi les meilleurs pilotes de chasse ont souvent de gros ennuis</a></li>
<li><a href="../fr464045/index.html">Comment je traine presque en temps r√©el en 1997</a></li>
<li><a href="../fr464053/index.html">Nota: Algorithme de s√©lection et de rotation des pistes</a></li>
<li><a href="../fr464055/index.html">Nous √©tudions les donn√©es collect√©es par Xiaomi Mi Band pour l'ann√©e</a></li>
<li><a href="../fr464057/index.html">Hilbert, Lebesgue ... et le vide</a></li>
<li><a href="../fr464063/index.html">Couper le c√¢ble en 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>