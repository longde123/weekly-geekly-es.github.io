<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï° üë©üèø‚Äçü§ù‚Äçüë©üèº üì∫ Eskalation von Windows-Berechtigungen ü§∞üèø üéµ üßöüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Managementpraxis f√ºr Informationssicherheit: Pentest 
 Erh√∂hen der Benutzerrechte auf Windows-Dom√§nenadministratorebene 

 Einf√ºhrung 
 Ein gutes Info...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eskalation von Windows-Berechtigungen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423937/"><h2>  Managementpraxis f√ºr Informationssicherheit: Pentest </h2><br>  <b>Erh√∂hen der Benutzerrechte auf Windows-Dom√§nenadministratorebene</b> <br><br><h4>  Einf√ºhrung </h4><br>  Ein gutes Informationssicherheits-Managementsystem (ISMS) erfordert eine regelm√§√üige Bewertung seiner Wirksamkeit.  F√ºr solche Bewertungen gibt es verschiedene Methoden, von denen eine die sogenannte ist.  "Penetrationstest" oder Pentest - eine autorisierte Simulation eines Hackerangriffs auf ein Informationssystem, um Schwachstellen in seinem Schutz zu identifizieren, bevor sie von einem echten Angreifer entdeckt werden.  In diesem Fall k√∂nnen alle im wirklichen Leben verf√ºgbaren Hacker-Tools, Exploits, Methoden usw. verwendet werden. <br><br>  In diesem Artikel wird eine dieser Anti-Hacking-Methoden beschrieben, mit denen die Berechtigungen eines normalen Microsoft Windows-Dom√§nenbenutzers auf die Ebene eines Dom√§nenadministrators erh√∂ht werden sollen.  Der Artikel basierte auf einem Bericht √ºber die Ergebnisse eines Tests, der in die Praxis umgesetzt wurde.  Aus Gr√ºnden der Vertraulichkeit werden alle Informationen, die die Identifizierung des Veranstaltungsortes erm√∂glichen (Domain- und Hostnamen, Konten usw.), gel√∂scht oder ge√§ndert.  Der Artikel zeigt die grundlegenden Techniken. Zum besseren Verst√§ndnis habe ich die theoretischen Grundlagen und Schwachstellen angegeben, die f√ºr bestimmte Versionen von Betriebssystemen verwendet werden, sowie allgemeine Empfehlungen zum Schutz.  Obwohl die meisten dieser Windows-Versionen zum Zeitpunkt der Ver√∂ffentlichung als veraltet gelten, kann dieser Artikel f√ºr unerfahrene Systemadministratoren hilfreich sein, um die Methoden zum Schutz von Anmeldeinformationen in einer Windows-Umgebung besser zu verstehen. <br><a name="habracut"></a><br><h4>  Beschreibung des Testobjekts </h4><br>  Das Testobjekt ist ziemlich Standard - das Informationssystem eines kleinen Unternehmens (weniger als 200 Mitarbeiter), das sich auf Softwareentwicklung spezialisiert hat.  Das interne Netzwerk des Unternehmens ist ebenfalls typisch: DF√ú-Gigabit-Ethernet, Microsoft Windows-Dom√§ne (wir nennen es CORP.LOCAL).  Interne Hosts werden basierend auf ihrer funktionalen Zugeh√∂rigkeit in IP-Subnetze unterteilt (z. B. eine Gruppe von Entwicklern, Qualit√§tsingenieuren, Personalabteilung, Buchhaltung, Marketing, Top-Management, Einrichtungen usw.). Die gesamte Segmentierung erfolgt √ºber den L3-Switch .  Es gibt auch einen Park interner Server, der einem separaten IP-Subnetz zugeordnet ist und Folgendes enth√§lt: zwei Windows Server 2008-Dom√§nencontroller mit integriertem DNS, einen internen Mailserver mit Exchange, einen Dateiserver, einen Terminalserver und einige andere Hilfsserver mit Windows und Linux.  Unabh√§ngig davon ist ein Testlabor mit einer Flotte von Computern zu erw√§hnen, auf denen verschiedene Versionen von Microsoft Windows (sowohl Desktop als auch Server) ausgef√ºhrt werden und die zum Testen der entwickelten Software entwickelt wurden.  Der Zugriff auf die Hosts des Testlabors steht allen Mitarbeitern zur Verf√ºgung.  Die Hauptversion des Desktop-Betriebssystems ist Windows 7. Auf Desktop-Computern und Servern wird schlecht konfigurierte Antivirensoftware verschiedener Hersteller installiert (von Symantec, Kaspersky und Trend Micro, warum eine schlecht konfigurierte sp√§ter besprochen wird). <br><br><h4>  Eindringlingsmodell </h4><br>  Eindringling - Ein interner Mitarbeiter, der √ºber ein nicht privilegiertes Benutzerkonto in der Dom√§ne, einen Desktop-Computer und physischen Zugriff auf Testcomputer verf√ºgt (m√∂glicherweise √ºber einen Unternehmens-Laptop), jedoch keine lokalen Administratorrechte f√ºr einen dieser Computer besitzt.  Au√üerdem kann das Eindringlingskonto die Einstellungen der Antivirensoftware nicht √§ndern.  Der Angreifer beabsichtigt, einen Zugriff zu erhalten, der dem Zugriff des Administrators auf den Dom√§nencontroller und / oder den Dateiserver entspricht. <br><br>  Wie wir sehen, sind sowohl das Modell des Eindringlings als auch die Beschreibung des Unternehmens recht typisch. <br><br><h3>  Angriffsimplementierung </h3><br><h4>  Schritt 0. Sammlung von Informationen √ºber das interne Netzwerk </h4><br>  Wir handeln also im Namen des T√§ters.  In diesem Schritt m√ºssen wir Informationen sammeln √ºber: <br><br><ul><li>  interne Adressierung und Subnetz </li><li>  Hostnamen und IP-Adressen, zun√§chst interessieren wir uns f√ºr eine Liste von Servern </li><li>  unter Verwendung des NetBIOS-Protokolls. </li></ul><br>  Zun√§chst erhalten wir mit dem Dienstprogramm ipconfig die IP-Adressen der DNS-Server: 192.168.12.1 und 192.168.12.2.  Weil  DNS ist in Active Directory integriert, was Grund zu der Annahme gibt, dass wir die IP-Adressen von Dom√§nencontrollern kennen.  Als N√§chstes versuchen wir mit dem Dienstprogramm nslookup im interaktiven Modus, eine Liste aller Hosts in der Zone corp.local abzurufen: <br><br>  <i>&gt; ls ‚Äìd corp.local&gt; Datei</i> <br><br>  Tats√§chlich initiiert dieser Befehl eine vollst√§ndige DNS-Zonen√ºbertragung und speichert sie in einer Datei.  Viele Administratoren vergessen, Einschr√§nkungen f√ºr die Zonen√ºbertragung f√ºr das interne Netzwerk festzulegen, was es einem potenziellen Angreifer erleichtert, Informationen √ºber die Infrastruktur des Unternehmens zu sammeln. Weitere Informationen finden Sie unter [12]. <br><br>  <b>Ergebnis.</b>  Erfolg.  Bei einer ungesch√ºtzten Zonen√ºbertragung erhielten wir eine vollst√§ndige Liste der internen Hostnamen, einschlie√ülich der Server, und ihrer IP-Adressen.  Mit den Dienstprogrammen nbtstat, telnet sowie einem der g√§ngigen Schwachstellenscanner kann ein Angreifer Informationen √ºber die Plattform, ausgef√ºhrte Dienste und Betriebssystemversionen auf den f√ºr ihn interessanten Hosts sammeln. <br><br><h4>  Schritt 1. Beziehen Sie lokale Administratorrechte </h4><br>  <b>Theorie</b>  Um das lokale Administratorkennwort zu erhalten, wird ein Angriff auf den in der Systemregistrierung gespeicherten Hashwert dieses Kennworts angewendet.  Trotz der Tatsache, dass die Hash-Funktion mathematisch irreversibel ist, ist die Kennwortberechnung durch direkte Aufz√§hlung ihrer Werte zusammen mit einem W√∂rterbuchangriff m√∂glich.  Windows hat in der Vergangenheit zwei Algorithmen zur Berechnung einer Kennwort-Hash-Funktion verwendet: den √§lteren LM-Algorithmus und den neueren NT-Algorithmus (manchmal auch als NTLM bezeichnet).  Die LM-Hash-Funktion ist aufgrund ihrer geringen Rechenkomplexit√§t anf√§llig, sodass ihre Werte auch auf einem schwachen Computer aufgelistet werden k√∂nnen.  Das Vorhandensein von LM- und NT-Kennwort-Hashes in der Systemregistrierung stellt sicher, dass der Angreifer diese in akzeptabler Zeit knacken kann.  Der LM-Hashwert bei den Standardeinstellungen wird in der Registrierung von Windows XP / 2003 gespeichert, was diese Systeme f√ºr den Hacker besonders attraktiv macht.  Die NT-Hash-Funktion ist rechnerisch komplexer, die Aufz√§hlung ihrer Werte wird jedoch erheblich vereinfacht, da f√ºr sie vorberechnete Wertetabellen (sogenannte Rainbow-Tabellen) verf√ºgbar sind - sie reduzieren die Berechnung des Hash-Werts auf die Suche nach dem gew√ºnschten Hash unter vorberechnete Werte. <br><br>  <b>Angriffsobjekt.</b>  Passwort-Hashes in der SAM-Datenbank (Registrierung).  In unserem Fall sind dies alles Maschinen, auf die wir physischen Zugriff haben.  Erstens ist dies unser funktionierender Desktop und zweitens Hosts f√ºr die Durchf√ºhrung von Tests. <br><br>  <b>Implementierung.</b>  Bei Computern mit physischem Zugriff f√ºhren wir den folgenden Vorgang aus: Booten von einem externen Medium (mithilfe einer Windows-Vorinstallationsumgebungs-CD oder Linux Live-CD), Mounten der NTFS-Systempartition und Kopieren der Registrierungszweige HKLM \ SYSTEM und HKLM \ SAM (% WINDIR-Dateien) % \ System32 \ Config \ System bzw.% WINDIR% \ System32 \ Config \ Sam).  Wir achten besonders auf Computer mit Windows XP \ Windows 2003, auf denen der LM-Hash wahrscheinlich zu finden ist.  Um Passw√∂rter aus den kopierten Registrierungsdateien zu sichern, verwenden wir die Tools [1], [2] (alle Links am Ende des Artikels).  Ergebnis: <br><br><img src="https://habrastorage.org/webt/kn/jq/wm/knjqwm1nlf7ljjd99ndwh60bngg.png" alt="Bild"><br><br>  Die letzte Zeile enth√§lt den erforderlichen NT-Hash des lokalen Administrators.  Auf Hosts aus dem Testlabor (nennen wir diese Hosts LAB1 und LAB2) finden wir einen LM-Hash ungleich Null: <br><br><img src="https://habrastorage.org/webt/sz/wi/30/szwi30d1cje8gsfkiok70xtnuyy.png" alt="Bild"><br><br><img src="https://habrastorage.org/webt/1j/g5/l-/1jg5l-dgphti0eayxdcozs-onts.png" alt="Bild"><br><br>  Also haben wir NT- und LM-Hashes.  Aber wie kann man das Passwort von ihnen wiederherstellen?  Dazu verwenden wir dieselben Tools [1], [2] sowie die Online-Hash-Reverse-Dienste [8] - [11]: <br><br><img src="https://habrastorage.org/webt/qx/dk/70/qxdk70sdc94zqcuzmxkavjeu4tg.png" alt="Bild"><br><br>  Hinweis: Das eigentliche Passwort bestand aus dem Namen des Unternehmens mit einem kleinen Modifikator und brach bei einem W√∂rterbuchangriff schnell zusammen. <br><br>  <b>Ergebnis.</b>  Erfolg.  Die Passw√∂rter wurden vom lokalen Administratorkonto und von zwei Testcomputern vom lokalen Administratorkonto empfangen (seien es "Pa $$ word1" und "Pa $$ word2").  Aber helfen sie dabei, Domain-Administratorrechte zu erhalten?  Dar√ºber weiter. <br><br><h4>  Schritt 2. Abrufen der Anmeldeinformationen des Dom√§nenadministrators </h4><br>  <b>Theorie</b>  In den meisten F√§llen reicht es aus, den Wert des NT-Hash des Kennworts f√ºr den Dom√§nenadministrator abzurufen.  Dies liegt an der Tatsache, dass bei der √úberpr√ºfung eines Benutzers mithilfe des NTLM-Protokolls das authentifizierte System dem Authentifizierer nur den NT-Hash anzeigt und keine Kennwort√ºberpr√ºfung erfolgt.  NT-Hash kann aus dem sogenannten erhalten werden  LSA-Speicher unter Bezugnahme auf die sogenannte  Administrator-Anmeldesitzungen (Anmeldesitzung ist ein spezieller Datenbereich, der vom Winlogon-Prozess erstellt wird und in dem der Benutzername, die Anmeldedom√§ne und der NT-Kennwort-Hashwert zusammen gespeichert werden. Dies wird als LSA-Geheimnis bezeichnet.)  Dieser NT-Hash wird vom NTLMSSP-Prozess f√ºr die NTLM-Authentifizierung verwendet.  Die Anmeldesitzung wird st√§ndig gespeichert, w√§hrend das Konto im System angemeldet ist.  Sie k√∂nnen einen NT-Hash auch von einer NTLM-Administratorauthentifizierungssitzung abfangen.  Dar√ºber hinaus ist das Abrufen eines Administratorkennworts aus dem DCC-Cache (Domain Cached Credentials) m√∂glich.  DCC ist ein lokaler Cache, der gef√ºllt wird, wenn sich ein Benutzer erfolgreich bei einer Dom√§ne anmeldet.  Der Zweck des DCC-Cache besteht darin, den Benutzer authentifizieren zu k√∂nnen, wenn der Dom√§nencontroller nicht verf√ºgbar ist. <br><br>  <b>Angriffsobjekte:</b> <br><br><ul><li>  DCC-Hashes (HKLM \ Security-Registrierungszweig). </li><li>  Dom√§nenadministrator-Anmeldesitzung (LSA-Geheimnis). </li><li>  Abfangen von NTLM-Sitzungen (aufgrund gr√∂√üerer praktischer Komplexit√§t nicht ber√ºcksichtigt). </li></ul><br>  <b>√úbe.</b>  Viele Windows-Administratoren verwenden ein Dom√§nenadministratorkonto, um verschiedene Arten von Vorg√§ngen auf den Computern der Benutzer auszuf√ºhren.  Gleichzeitig fallen seine Daten in den DCC-Cache.  Versuchen Sie daher zun√§chst, das Kennwort aus dem DCC-Cache abzurufen.  Wir gehen zu unserer Workstation, speichern den Registrierungszweig HKLM \ Security und importieren ihn in [1].  Weil  Wir haben ein lokales Administratorkennwort. Wir m√ºssen den Computer nicht mehr von externen Medien starten, um die Registrierung zu speichern: <br><br><img src="https://habrastorage.org/webt/up/6p/v3/up6pv3qirtuto8wcxfk6lkofkqq.png" alt="Bild"><br><br>  Der Cache enth√§lt die Kennwortdaten von drei Konten.  Das letzte Konto (*** Benutzer) interessiert uns nicht, das zweite Konto verf√ºgt nicht √ºber die erforderlichen Berechtigungen, aber der Benutzer Shadmin sieht aus wie der Administrator, den Sie suchen.  Leider weist der MS-CACHE2-Algorithmus eine gro√üe Rechenkomplexit√§t auf und ein direkter Brute-Force-Angriff ist ineffizient.  Die MS-CACHEv2-Funktion enth√§lt ein ‚ÄûRechengeheimnis‚Äú - Salt (der Kontoname wird als ‚ÄûSalt‚Äú verwendet)), wodurch sie vor Angriffen auf Rainbow-Tabellen gesch√ºtzt ist.  In Zukunft werden jedoch m√∂glicherweise Hash-Wertetabellen f√ºr Standardkonten angezeigt - "Administrator", "Administrator" usw.  Aus Gr√ºnden des Interesses senden wir den gefundenen ‚ÄûCache-Hash‚Äú an den Cloud-Dienst [8] - [11] (√ºber die Ergebnisse und die Wirksamkeit solcher Dienste am Ende des Artikels).  W√§hrend die Cloud nachdenkt, versuchen wir andere DCCs zu finden.  Wir analysieren die in Schritt 0 erhaltene Hostliste und √ºberpr√ºfen anhand der in Schritt 1 erhaltenen Kennw√∂rter, auf welche Server wir unter dem lokalen Administrator zugreifen k√∂nnen. Da der lokale Administrator auf dem Dom√§nencontroller blockiert ist und der Mailserver normalerweise besser gesch√ºtzt ist, m√ºssen Sie experimentieren sekund√§re Server.  In unserem Fall wurde in der Liste der Server ein Server mit dem unauff√§lligen Namen Upd gefunden.  Die Anmeldung mit dem in Schritt 1 gefundenen Passwort "Pa $$ word2" ist erfolgreich.  Wir finden das auf dem Upd-Host: <br><br><ol><li>  Keine Antivirensoftware installiert. </li><li>  Es wird Apache ausgef√ºhrt, der Verwaltungsserver f√ºr Unternehmens-Antivirenprogramme (dies bedeutet, dass auch ein Kennwort f√ºr das Konto vorhanden ist, mit dem Antivirensoftware remote installiert wird, und Sie k√∂nnen es theoretisch von dort herunterladen). </li><li>  Der Host √ºberwacht keine fehlgeschlagenen Anmeldeversuche. </li><li>  Betriebssystemversion - Windows 2008 R2. </li></ol><br>  Nach dem Speichern der HKLM \ Security-Registrierung erhalten wir den DCC-Hash des CORP.LOCAL \ Administrator-Kontos (und mehrerer anderer): <br><br><img src="https://habrastorage.org/webt/a5/3t/--/a53t--0v2fycjxm29xiytiqri3g.png" alt="Bild"><br><br>  Theoretisch k√∂nnen Sie versuchen, das Kennwort f√ºr den Administrator √ºber einen Cloud-Dienst zu finden.  Wie oben erw√§hnt, ist ein Brute-Force-Angriff auf MS-CACHEv2 jedoch nutzlos (obwohl es m√∂glich ist, dass sich die Situation in ein paar Jahren √§ndern wird).  Lassen Sie DCC in Ruhe und suchen Sie nach Anmeldesitzungen.  √úberpr√ºfen Sie, welcher Benutzer am Upd-Host angemeldet ist: <br><br><img src="https://habrastorage.org/webt/57/ri/fa/57rifa8peyelwyvtbw6d4nwrofu.png" alt="Bild"><br><br>  Wir sehen, dass zwei inaktive Sitzungen auf dem Upd-Computer h√§ngen - der Administrator und der Benutzer Shadmin, die uns bereits bekannt sind, was bedeutet, dass wir NT-Hashes ihrer Passw√∂rter erhalten k√∂nnen, indem wir das LSA-Geheimnis stehlen.  Dies ist der Schl√ºssel zum Erfolg des gesamten Angriffs.  Verwenden Sie den Lslsass-Exploit [3], um einen Hash zu stehlen.  Um es auszuf√ºhren, ben√∂tigen Sie lokale Administratorrechte (oder besser gesagt Rechte zum Debuggen von Prozessen), die wir bereits haben.  Wir erhalten die Liste der LSA-Geheimnisse (im Format "Dom√§ne \ Konto: LM-Hash: NT-Hash :::"): <br><br><pre><code class="hljs pgsql">lslsass v1<span class="hljs-number"><span class="hljs-number">.0</span></span> - Copyright (C) <span class="hljs-number"><span class="hljs-number">2010</span></span> Bjorn Brolin, Truesec (www.truesec.com) <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> Lsass pid: <span class="hljs-number"><span class="hljs-number">520</span></span> Lsass process <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:&lt;i&gt;<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e&lt;/i&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token UPD\Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">8833</span></span>c58febc977799520e7536bb2011e::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>\UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \UPD$::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>:<span class="hljs-number"><span class="hljs-number">68987</span></span>a0fb5529dbf99d5eac3bfce773b::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \Administrator::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; c690e441dc78bc5da8b389e78daa6392 &lt;/b&gt;::: <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">primary</span></span> token <span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> token CORP.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> \shadmin::<span class="hljs-number"><span class="hljs-number">00000000000000000000000000000000</span></span>: &lt;b&gt; <span class="hljs-number"><span class="hljs-number">5794</span></span>cba8b464364eacf366063ff70e78 &lt;/b&gt; :::</code> </pre> <br>  Die fett hervorgehobenen Zeilen enthalten die erforderlichen Kennwort-Hashes.  Beachten Sie auch den kursiven Hash in der sechsten Zeile.  Wir haben ihn schon irgendwo gesehen, oder? <br><br>  <b>Ergebnis.</b>  Erfolg.  Wir haben den NT-Passwort-Hash des Domain-Administratorkontos in unseren H√§nden.  Aber was n√ºtzt ein Hash, wenn es nicht m√∂glich ist, das urspr√ºngliche Passwort in einer akzeptablen Zeit wiederherzustellen?  Dar√ºber im n√§chsten Schritt. <br><br><h4>  Schritt 3. NTLM-Authentifizierungssitzung betr√ºgen </h4><br>  <b>Theorie</b>  Windows verwendet niemals ein reines Kennwort zur Authentifizierung, das authentifizierte System zeigt immer einen Hash an.  Daraus ergibt sich die Idee: Wenn Sie den Benutzernamen, die Anmeldedom√§ne und den NT-Hash in der Anmeldesitzung des angemeldeten Benutzers durch die entsprechenden Dom√§nenadministratorwerte ersetzen, k√∂nnen Sie sich mithilfe des NTLM-Protokolls vor dem Remotesystem als Dom√§nenadministrator authentifizieren.  Dieser Angriff [7] ist nur mit Authentifizierung √ºber das NTLM-Protokoll m√∂glich.  Trotz der weit verbreiteten Verwendung des Kerberos-Protokolls ist NTLM die einzige M√∂glichkeit, einen Client beim Zugriff auf eine Netzwerkfreigabe nicht √ºber den symbolischen Namen, sondern √ºber die IP-Adresse zu authentifizieren [13]. <br><br>  <b>Angriffsobjekt.</b>  Anmeldesitzung des lokalen Administrators. <br><br>  <b>√úbe.</b>  Es stehen verschiedene Exploits zur Verf√ºgung, mit denen Sie einen Angriff auf die Windows Server 2008 x86- und x64-Plattformen implementieren k√∂nnen.  Der Haupt-Exploit ist der Windows Credentials Editor [4].  Um den Angriff auszuf√ºhren, gehen wir mit den Anmeldeinformationen "Administrator" \ "Pa $$ word2" zum LAB2-Host.  Mit [4] ersetzen wir den Kontonamen, die Anmeldedom√§ne und die NT-Hashdaten in der Anmeldesitzung durch die entsprechenden Shadmin-Werte, die wir im vorherigen Schritt erhalten haben: <br><br><img src="https://habrastorage.org/webt/ww/kp/hc/wwkphcbxcv5fjhsrlk_1ydcakze.png" alt="Bild"><br><br>  Der Name des Dom√§nenadministratorkontos und sein NT-Hash werden als Argument √ºber die Befehlszeile an den Befehl wce √ºbergeben.  Ergebnis - Der Hash wurde erfolgreich ge√§ndert.  Ich stelle fest, dass sich die Mitgliedschaft des Benutzers in der Gruppe und das Zugriffstoken w√§hrend des Angriffs nicht √§ndern: <br><br><img src="https://habrastorage.org/webt/jg/jn/ym/jgjnymw3o3j8yv9cfd1sjojagbe.png" alt="Bild"><br><br>  Wir sind immer noch der lokale Administrator. Der Hostname in Gr√ºn im obigen Screenshot ist mit Gr√ºn - LAB2 verschmiert.  W√§hrend der NTLM-Authentifizierung wird dem Remote-System jedoch der CORP.LOCAL-Dom√§nenname, der Shadmin-Benutzername und der Shadmin-Kennwort-Hash angezeigt.  Hier ist ein Speicherauszug eines einzelnen Netzwerkpakets mit einer NTLM-Sicherheits-Blob-Sitzung: <br><br><img src="https://habrastorage.org/webt/tt/c7/_x/ttc7_xrvp9e81zvathjqultz5sc.png" alt="Bild"><br><br>  Der Domainname (CORP.LOCAL) und der Hostname (LAB2) sind gr√ºn ausgegraut. Ein Konto wird angezeigt - Shadmin.  Jetzt versuchen wir, mit dem Befehl net use unter Verwendung der IP-Adresse des Dom√§nencontrollers eine Verbindung zur Root-Partition des Systemvolumes auf dem Dom√§nencontroller herzustellen: <br><br><img src="https://habrastorage.org/webt/ja/ga/2h/jaga2h8xrnj_wbn5acv-fe6zlqs.png" alt="Bild"><br><br>  Erfolgreich.  Um den Zugriff zu √ºberpr√ºfen, habe ich eine Textdatei im Stammverzeichnis erstellt (siehe Screenshot).  Nachdem Sie auf der Festplatte des Dom√§nencontrollers eine Batchdatei mit der erforderlichen Befehlsfolge erstellt haben, k√∂nnen Sie mit [5] die erforderliche Operation auf dem Dom√§nencontroller ausf√ºhren (z. B. den Benutzer zur Gruppe der Dom√§nenadministratoren hinzuf√ºgen).  Der Vorgang wird mit den Rechten des Shadmin-Kontos ausgef√ºhrt.  Erstellen Sie zur Veranschaulichung eine einfache Batchdatei auf einem Remote-Host, die einen lokalen Benutzer hinzuf√ºgt: <br><br>  <i>net user TstUsr Pa $$ word / add</i> <br><br>  F√ºhren Sie es remote vom LAB2-Host aus: <br><br><img src="https://habrastorage.org/webt/q3/3l/qf/q33lqf4cb4u9rw8zwqpcfpwhw-c.png" alt="Bild"><br><br>  Es wird auf dem Remote-System 192.168.13.125 mit den Berechtigungen des Benutzers unserer aktuellen Sitzung ausgef√ºhrt - shadmin (d. H. Dom√§nenadministrator).  Wir pr√ºfen: <br><br><img src="https://habrastorage.org/webt/cq/oj/wp/cqojwpt8bb1c0volgimww9gsv-c.png" alt="Bild"><br><br>  Die zweite Ausgabe des Befehls net user zeigt den neuen Benutzer.  Trotz der Unm√∂glichkeit, Anwendungen zu starten, die auf diese Weise eine interaktive Benutzerinteraktion erfordern (z. B. MMC-Snap-Ins), kann eine Vielzahl von Aktionen mithilfe von Skripten ausgef√ºhrt werden. <br><br>  <b>Ergebnis.</b>  Erfolg.  Zugriff auf das Dateisystem und die Shell des Dom√§nencontrollers erhalten. <br><br><h4>  Zusammenfassung </h4><br>  Kurz gesagt sah die Angriffskette folgenderma√üen aus: Sammeln von Informationen zur Netzwerkstruktur -&gt; Abrufen eines lokalen Administratorkennworts -&gt; Verwenden dieses Kennworts zum Anmelden bei einem der sekund√§ren Server -&gt; Diebstahl von Dom√§nenadministratoranmeldeinformationen "unbeaufsichtigt" -&gt; √Ñndern Ihrer Anmeldesitzung und Eskalation von Privilegien. <br><br>  Der Erfolg des Angriffs wurde erleichtert durch: <br><br><ol><li>  Schwacher Schutz der DNS-Zone vor √úbertragung auf nicht vertrauensw√ºrdige Hosts. </li><li>  Schwache Passwortrichtlinie.  Die meisten Dom√§nencomputer verwendeten dasselbe Kennwort f√ºr das lokale Administratorkonto, das f√ºr einen W√∂rterbuchangriff anf√§llig war. </li><li>  Das Fehlen oder die schwache Konfiguration von Antivirensoftware auf kritischen Hosts. </li><li>  Schwacher Schutz vor Kennwort-Hashes - zwei inaktive Administrator-Anmeldesitzungen auf dem Upd-Host, LM-Hashes in der SAM-Datenbank. </li><li>  Schlechte Pr√ºfungsrichtlinien. </li></ol><br><br>  Darauf aufbauend k√∂nnen allgemeine Schutzempfehlungen abgeleitet werden: <br><br>  0. Verstecken Sie die interne Struktur des Netzwerks gr√ºndlich vor potenziellen Angreifern.  Daher sollten Benutzer nicht in der Lage sein, den vollst√§ndigen Inhalt der DNS-Zonendatei abzurufen.  Nicht vertrauensw√ºrdige Benutzer (z. B. Auszubildende, Mitarbeiter, die den Testzeitraum noch nicht abgeschlossen haben usw.) ist es sinnvoll, mithilfe von NAT in ein separates Subnetz zu wechseln, um Adressen zu f√§lschen (z. B. zum √Ñndern von DNS-Antworten). <br><br>  1. Die richtige Richtlinie zum Zuweisen von Kennw√∂rtern zum lokalen Administrator.  Das lokale Administratorkennwort muss auf Hosts mit unterschiedlichem Schutzgrad gegen unbefugten Zugriff unterschiedlich sein.  Das Kompromittieren des lokalen Administratorkennworts auf einem der Dom√§nenhosts sollte die M√∂glichkeit minimieren, dass ein Angreifer dieses Kennwort verwendet. <br><br>  2. Die Speicherung des LM-Hashs in SAM sollte durch Sicherheitsrichtlinien verboten werden. <br><br>  3. Verwenden Sie den Namen des Unternehmens oder seiner Domain nicht als Teil des Administratorkennworts.) Dies erschwert es einem Angreifer, das W√∂rterbuch anzugreifen.  Vergessen Sie sich aber auch bei Verwendung eines komplexen Passworts nicht und √ºberpr√ºfen Sie den Hash regelm√§√üig mithilfe von Onlinediensten auf Haltbarkeit. <br><br>  4. Es wird nicht empfohlen, Routinevorg√§nge auf Dom√§nencomputern unter dem Dom√§nenadministratorkonto auszuf√ºhren.  Dadurch wird das Konto vor dem Abfangen von Anmeldesitzungsdaten und vor dem Abrufen des Kennwort-Hash in den DCC-Cache gesch√ºtzt. <br><br>  5. Machen Sie es sich zur Regel, die Anmeldesitzung des Dom√§nenadministrators nicht unbeaufsichtigt zu lassen.  Best Practice: Arbeit beendet - abmelden. <br><br>  6. LSA-Spoofing-Dienstprogramme sind recht klein.  Es ist sinnvoll, ihre Entwicklung zu verfolgen und ihre erfolgreiche Erkennung durch Antivirensoftware f√ºr Unternehmen zu √ºberpr√ºfen. <br><br>  7. Ein Benutzer sollte selbst mit lokalen Administratorrechten nicht in der Lage sein, die Einstellungen eines Unternehmens-Antivirenprogramms zu √§ndern.  Das Deaktivieren des Antiviren-Dienstes auf Dom√§nenarbeitsstationen sollte zu einer Benachrichtigung des Dom√§nenadministrators f√ºhren (in diesem Sinne hat Symantec Endpoint Protection w√§hrend des Tests gut funktioniert). <br><br><h4>  Anhang 1. Antivirenverhalten </h4><br>  Die Computer des Unternehmens verwendeten drei Arten von Antivirenprogrammen: KAV, das zum Zeitpunkt des Symantec Endpoint Protection-Tests aktuell war, und ein veraltetes Produkt von Trend Micro.  In den meisten F√§llen wurden die w√§hrend des Angriffs verwendeten Tools als Hack-Tool / Rootkit / Trojaner identifiziert.  KAV l√∂schte sie ohne Vorwarnung, und SEP (sogar ausgeschaltet) gab eine Warnung aus und verschob sie in die Quarant√§ne, um den Start zu verhindern.  Wenn Sie jedoch √ºber lokale Administratorrechte verf√ºgen, k√∂nnen Sie KAV deaktivieren. Der SEP-Schutz wurde umgangen, indem Sie manuell einen Ausnahmepfad f√ºr die √úberpr√ºfung festlegen und erneut das lokale Administratorkonto verwenden.  Das auf einigen Hosts installierte Antivirenprogramm von Trend Micro reagierte in keiner Weise auf den Start von Exploits. <br><br><h4>  Nachtrag 2. Effizienz der Nutzung von Online-Hash-√úberpr√ºfungsdiensten </h4><br>  Es gibt viele Online-Dienste, um die St√§rke von Passwort-Hashes zu testen.  Mit ihnen k√∂nnen Sie mit den g√§ngigsten Hashes arbeiten - LM, NTLM, MD4, MD5, WPA, mit Hashes mit Salz usw.  Um den Hash zu √ºberpr√ºfen, wird die direkte Aufz√§hlung unter Verwendung der Verarbeitungsleistung moderner GPUs, W√∂rterbuchaufz√§hlung, Hybridangriffe usw. verwendet.  Nach dem √ñffnen kann der Hash die Datenbank auff√ºllen und in Zukunft verwendet werden.  Der Dienst kann kostenlos sein, um ein kurzes Passwort (weniger als 8 Zeichen) zu √ºberpr√ºfen oder eine geringe Geb√ºhr zu erheben.  W√§hrend des Tests habe ich vier solcher Dienste verwendet. Die Links finden Sie am Ende des Artikels.  Ich habe mehrere in Schritt 2 gefundene Hashes gesendet und nach 15 Monaten eine Benachrichtigung vom Online-Hash-Crack-Dienst [9] √ºber die erfolgreiche Wiederherstellung eines dieser Hashes erhalten. <br><br><h4>  Referenzen </h4><br>  <b>Gebrauchte Werkzeuge</b> <br><br>  [1] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cain &amp; Abel</a> - ein Tool zur Wiederherstellung von Passw√∂rtern f√ºr Microsoft-Betriebssysteme.  Es erm√∂glicht die einfache Wiederherstellung verschiedener Arten von Kennw√∂rtern, indem das Netzwerk durchsucht, verschl√ºsselte Kennw√∂rter mithilfe von Dictionary-, Brute-Force- und Cryptanalysis-Angriffen geknackt, VoIP-Konversationen aufgezeichnet, verschl√ºsselte Kennw√∂rter dekodiert, drahtlose Netzwerkschl√ºssel wiederhergestellt, Kennwortfelder aufgedeckt, zwischengespeicherte Kennw√∂rter aufgedeckt und das Routing analysiert werden Protokolle. <br>  [2] L0pht Crack. <br>  [3] Lslsass-Exploit.  Gibt sichere Passwort-Hashes f√ºr Anmeldesitzungen aus dem lsass-Prozess aus. <br>  [4] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Windows Credentials Editor</a> nach dem Exploit.  Tool zum √Ñndern von Anmeldeinformationen. <br>  [5] PsExec von PS Tools <br><br>  <b>Detaillierte Beschreibungen der Sicherheitsanf√§lligkeiten</b> <br><br>  [6] Artikelserie ‚ÄûEffektiv einen Passwort-Hash unter Windows erhalten‚Äú unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.securitylab.ru</a> <br>  [7] Pass-the-Hash, eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beschreibung eines Angriffs</a> auf ein Remote-System, indem es mit einem kompromittierten Hash versehen wird. <br><br>  <b>Cloud Hash Hacking Services</b> <br>  [8] Question-defense.com (scheint zum Zeitpunkt der Ver√∂ffentlichung nicht in Ordnung zu sein () <br>  [9] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.onlinehashcrack.com</a> <br>  [10] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.cloudcracker.com</a> <br>  [11] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Online-Hash-Killer</a> <br><br>  <b>Zus√§tzliche Materialien</b> <br><br>  [12] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sicherheits- und DNS-Optimierung in Windows Server</a> <br>  [13] <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kerberos wird nicht verwendet, wenn Sie √ºber die IP-Adresse eine Verbindung zu SMB-Freigaben herstellen</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423937/">https://habr.com/ru/post/de423937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423925/index.html">Offenes Webinar "Seltsame rekursive Vorlage"</a></li>
<li><a href="../de423927/index.html">10 vielversprechende Suchmaschinen zur Verbesserung der SEO</a></li>
<li><a href="../de423931/index.html">Wie kann ich die SMS-Authentifizierung umgehen, wenn ich eine Verbindung zu √∂ffentlichen Wi-Fi-Netzwerken herstelle?</a></li>
<li><a href="../de423933/index.html">Microsoft Office Security: Eingebettete Objekte</a></li>
<li><a href="../de423935/index.html">Embox beantwortet beliebte Fragen des TechTrain IT-Festivals</a></li>
<li><a href="../de423939/index.html">Dynamische Programmierung oder Teilen und Erobern</a></li>
<li><a href="../de423941/index.html">Berichte von iOS mitap Redmadrobot</a></li>
<li><a href="../de423943/index.html">Offline-Einzelhandelspreisoptimierung</a></li>
<li><a href="../de423945/index.html">Der Oberste Gerichtshof hat das Verfahren f√ºr die Pr√ºfung von F√§llen mit Reposts und Likes festgelegt</a></li>
<li><a href="../de423947/index.html">Unsere pers√∂nlichen Daten kosten Sie nichts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>