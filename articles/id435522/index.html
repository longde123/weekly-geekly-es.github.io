<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â¤ï¸ ğŸ¤“ ğŸ¤½ğŸ¿ Snapshot acara di Axonframework 3, meningkatkan kinerja ğŸ‘¨ğŸ½â€ğŸ“ ğŸ•— ğŸ¤±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ikhtisar kerangka kerja axonframework 
 Axonframework adalah kerangka kerja yang menerapkan beberapa prinsip dan pola desain seperti: 

 CQRS - Memisa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Snapshot acara di Axonframework 3, meningkatkan kinerja</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435522/"><h3>  Ikhtisar kerangka kerja axonframework </h3><br>  Axonframework adalah kerangka kerja yang menerapkan beberapa prinsip dan pola desain seperti: <br><br>  <b>CQRS</b> - Memisahkan pemrosesan permintaan untuk membaca dan menulis data <br>  <b>Sumber Acara</b> adalah ketika keadaan aplikasi disimpan sebagai rantai acara. <br>  <b>DDD Aggregate</b> - objek domain yang menyimpan status <br><br>  Salah satu kelemahan menyimpan keadaan akhir suatu aplikasi dalam bentuk rangkaian peristiwa adalah jumlah peristiwa yang disimpan dan diproses.  Untungnya, Axonframework memungkinkan Anda membuat acara snapshot, yang berisi hasil dari beberapa peristiwa (peristiwa domain). <br><a name="habracut"></a><br><h3>  Cuplikan Acara </h3><br>  Snapshot event - ini adalah nilai yang dihasilkan dari beberapa peristiwa (peristiwa domain).  Ini memungkinkan Anda untuk dengan cepat membuat ulang keadaan Agregat.  Penting untuk dipahami bahwa snapshot dibuat dari peristiwa yang digunakan untuk Unit tertentu dengan pengidentifikasi unik. <br><br>  Sebagai contoh ( <i>Gbr. 1</i> ), kami mengatur konfigurasi untuk membuat snapshot untuk setiap dua peristiwa (ambang = 2 - untuk tujuan ilustrasi).  Dalam hal ini, ketika dua peristiwa mengubah status Unit, satu gambar akan dibuat dengan nilai yang dihasilkan dari dua peristiwa sebelumnya. <br><br><img src="https://habrastorage.org/webt/_r/zu/9a/_rzu9apczumi6zijbcafynqajwy.png"><br>  <i>Gambar 1. Cuplikan dari dua peristiwa.</i>  <i>(ambang = 2)</i> <br><br>  Perhatikan contoh yang lebih rumit ( <i>Gbr. 2</i> ), konfigurasi juga menentukan ambang 2 sehingga snapshot dibuat setiap dua peristiwa.  Ketika 2 acara mengubah status Unit, satu gambar akan dibuat.  Selanjutnya, 2 peristiwa lainnya mengubah status Unit dan gambar baru tidak dibuat, tetapi yang sudah ada diperbarui. <br><br><img src="https://habrastorage.org/webt/pt/27/ot/pt27ot4awkpcgksfxfv7lxo7idg.png"><br>  <i>2 Hasil dari rantai peristiwa dalam satu gambar (ambang = 2)</i> <br><br><h3>  Performa </h3><br>  Di satu sisi, ketika rantai panjang peristiwa terakumulasi dalam suatu aplikasi, dibutuhkan waktu untuk membaca dan memproses sejumlah besar peristiwa untuk menciptakan kembali keadaan Unit.  Di sisi lain, jika Anda membuat snapshot, keadaan Unit akan dibuat kembali dengan cepat, tetapi akan butuh waktu untuk membuat snapshot.  Keseimbangan harus dicapai antara kedua situasi ini. <br><br><img src="https://habrastorage.org/webt/8z/he/hb/8zhehbkall5aane2widtwjath-k.png"><br>  <i>Gbr. 3 Performa tanpa mengambil snapshot</i> <br><br><img src="https://habrastorage.org/webt/ct/ag/4-/ctag4-2ofkhzu5_osyqvav8uuki.png"><br>  <i>Gambar. 4 Performa dengan snapshot (ambang = 3)</i> <br><br>  Secara default, snapshot dibuat di utas yang disebut metode scheduleSnapshot ().  Pengaturan ini tidak disarankan untuk lingkungan tempur (lihat Gbr. 4 / entri). <br><br>  Di bawah ini adalah contoh kode menggunakan ThreadPoolExecutor (...) yang akan menyediakan utas terpisah untuk membuat snapshot.  Dalam hal ini, klien kami tidak akan melihat perlambatan dalam aplikasi dan waktu yang diberikan untuk membuat snapshot. <br><br><h3>  Kode </h3><br>  Untuk mengaktifkan pembuatan snapshot, Anda perlu membuat sedikit perubahan pada kode aplikasi.  Anotasi agregat menunjukkan nama repositori yang digunakan dalam kode kelas konfigurasi.  Di kelas konfigurasi, ambang batas untuk membuat snapshot, metode untuk membuat snapshot, repositori, dll. Diindikasikan. <br><br>  AxonConfig.java <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EventStore eventStore; <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringAggregateSnapshotterFactoryBean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">springAggregateSnapshotterFactoryBean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringAggregateSnapshotterFactoryBean(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> SpringAggregateSnapshotter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snapshotter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ParameterResolverFactory parameterResolverFactory, EventStore eventStore, TransactionManager transactionManager)</span></span></span><span class="hljs-function"> </span></span>{ Executor executor = Executors.newFixedThreadPool(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringAggregateSnapshotter(eventStore, parameterResolverFactory, executor, transactionManager); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(<span class="hljs-string"><span class="hljs-string">"reservationRepository"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EventSourcingRepository&lt;Reservation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservationRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Snapshotter snapshotter, ParameterResolverFactory parameterResolverFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventSourcingRepository&lt;Reservation&gt;(reservationAggregateFactory(), eventStore, parameterResolverFactory, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventCountSnapshotTriggerDefinition(snapshotter, <span class="hljs-number"><span class="hljs-number">50</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span>(name = <span class="hljs-string"><span class="hljs-string">"reservationAggregateFactory"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AggregateFactory&lt;Reservation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservationAggregateFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SpringPrototypeAggregateFactory&lt;Reservation&gt; aggregateFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpringPrototypeAggregateFactory&lt;&gt;(); aggregateFactory.setPrototypeBeanName(<span class="hljs-string"><span class="hljs-string">"reservation"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aggregateFactory; }</code> </pre> <br>  Reservation.java <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aggregate</span></span>(repository = <span class="hljs-string"><span class="hljs-string">"reservationRepository"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reservation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//â€¦ }</span></span></code> </pre><br>  Patut dicatat bahwa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">utas</a> diskusi Google Groups berisi contoh dan diskusi kode yang bermanfaat. <br><br><h3>  Pilih ambang untuk foto </h3><br><br>  <b>5.1.</b>  <b>Cara teoretis</b> <br><br>  Mari kita hitung jumlah peristiwa yang bisa diterapkan ke Unit di kelas EventListener.  Kemudian secara teoritis kami memperkirakan jumlah rata-rata peristiwa yang diterapkan pada Unit dalam situasi tipikal dan menetapkan nilai sedikit kurang dari ini sebagai ambang batas untuk membuat gambar.  Ini dapat dilakukan jika aplikasi baru saja dibuat dan tidak ada data nyata untuk dianalisis. <br><br>  <b>5.2.</b>  <b>Cara praktis</b> <br><br>  Kami menganalisis data dari database, dan kami menganggap bahwa database digunakan oleh MongoDB dan berfungsi di dalam wadah buruh pelabuhan. <br><br><pre> <code class="bash hljs">&gt; docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it &lt;container-id&gt; mongo &gt; show dbs admin 0.000GB axonframework 0.000GB <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 0.000GB &gt; use axonframework switched to db axonframework &gt; show collections domainevents sagas snapshotevents &gt; db.domainevents.<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span></span>() { â€œ_idâ€ : ObjectId(â€œ5bb1dc8d4446d63bcc765febâ€), â€œaggregateIdentifierâ€ : â€œb1e320d5â€“58aa-4b9b-a667-aa724900592fâ€, â€œ<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>â€ : â€œReservationâ€, â€œsequenceNumberâ€ : NumberLong(0), â€œserializedPayloadâ€ : â€œ&lt;com.example.ReservationStarted&gt;&lt;reservationIdentifier&gt;b1e320d5â€“58aa-4b9b-a667-aa724900592f&lt;/reservationIdentifier&gt;&lt;duration resolves-to=\â€java.time.Ser\â€&gt;&lt;byte&gt;1&lt;/byte&gt;&lt;long&gt;2400&lt;/long&gt;&lt;int&gt;0&lt;/int&gt;&lt;/duration&gt;&lt;/com.example.ReservationStarted&gt;â€, â€œtimestampâ€ : â€œ2018â€“10â€“01T08:36:29.434Zâ€, â€œpayloadTypeâ€ : â€œcom.example.ReservationStartedâ€, â€œpayloadRevisionâ€ : null, â€œserializedMetaDataâ€ : â€œ&lt;meta-data&gt;&lt;entry&gt;&lt;string&gt;traceId&lt;/string&gt;&lt;string&gt;b090b86a-ec89â€“484b-ae9f-e4fa0f9bcd39&lt;/string&gt;&lt;/entry&gt;&lt;entry&gt;&lt;string&gt;correlationId&lt;/string&gt;&lt;string&gt;b090b86a-ec89â€“484b-ae9f-e4fa0f9bcd39&lt;/string&gt;&lt;/entry&gt;&lt;/meta-data&gt;â€, â€œeventIdentifierâ€ : â€œf324f021â€“50b4â€“4e91â€“84d0-f8c4425f3eb9â€ }</code> </pre><br>  Setiap peristiwa yang tersimpan berisi bidang Agregat Identifikasi, yang dengannya kami menghitung jumlah acara yang diterapkan untuk setiap Agregat dengan kueri sederhana: <br><br><pre> <code class="bash hljs">db.domainevents.aggregate([ {<span class="hljs-variable"><span class="hljs-variable">$group</span></span>: {_id: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$aggregateIdentifier</span></span></span><span class="hljs-string">"</span></span>, count: {<span class="hljs-variable"><span class="hljs-variable">$sum</span></span>: 1} } }, {<span class="hljs-variable"><span class="hljs-variable">$sort</span></span> : {count : -1} } ]); { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"0d84afd1-f199-45c8-b50e-7d9ebfa4c8fb"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"49de7c32-38ea-435a-b837-ccdb61ec0baa"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"12957b0b-af05-47c4-a3d8-968b75cf9ffb"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 136 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"97a24559-ee3a-43e7-a6be-1eb6840b662a"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"b6aeb1af-0620-4b02-8de3-c2446c2f7d83"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"b385aaf4-3338-489f-8d1b-4600d5e088b9"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"5970327f-9551-4945-94e9-3844c0cd3543"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 132 } ... { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"0182239h-3948-3334-98t5-9643j4ld8346"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : 1 }</code> </pre><br>  Ambang batas untuk membuat foto dapat dipilih di bawah rata-rata sehingga foto dibuat secara efektif.  Dalam hal ini, nilai 50 baik-baik saja. <br><br><h3>  Memeriksa aktivasi snapshot </h3><br><pre> <code class="bash hljs">&gt; mongo &gt; show dbs admin 0.000GB axonframework 0.000GB <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 0.000GB &gt; use axonframework &gt; show collections domainevents sagas snapshotevents &gt; db.domainevents.count() 515 &gt; db.snapshotevents.count() 7</code> </pre><br>  Jika koleksi snapshotevents tidak kosong dan berisi snapshot, maka pembuatan snapshot telah berhasil diaktifkan. <br><br><h3>  Pilihan foto lainnya </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi</a> menyebutkan variasi lain tentang cara mengaktifkan pembuatan snapshot, misalnya: <br><br><ul><li>  jumlah peristiwa yang dihasilkan sejak foto terakhir melebihi ambang batas </li><li>  Inisialisasi unit habis </li><li>  waktu tunda, dll.  dll. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id435522/">https://habr.com/ru/post/id435522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id435508/index.html">Bagaimana cara membuat komputer terbaik di Rusia? Wawancara dengan Artyom Smirnov dari HYPERPC</a></li>
<li><a href="../id435510/index.html">Mikroelektronika, neurofisiologi dan pembelajaran mesin, goyang tetapi tidak tercampur</a></li>
<li><a href="../id435512/index.html">Pengembang Royole Menunjukkan Smartphone Fleksibel yang Dapat Dilipat</a></li>
<li><a href="../id435514/index.html">Di Rusia, mereka mengembangkan prosesor untuk mempercepat jaringan saraf</a></li>
<li><a href="../id435520/index.html">Kami menulis bahasa pemrograman kami, bagian 3: Arsitektur penerjemah. Analisis struktur bahasa dan ekspresi matematika</a></li>
<li><a href="../id435526/index.html">Petualangan dengan Cluster Rumah Kubernetes</a></li>
<li><a href="../id435528/index.html">5 alasan untuk sukses: mengapa Amazon telah menjadi perusahaan paling mahal di dunia</a></li>
<li><a href="../id435530/index.html">Langganan Berbayar - Ketergantungan Koneksi Otomatis pada Perangkat Seluler</a></li>
<li><a href="../id435532/index.html">Tornado vs Aiohttp: sebuah perjalanan ke belantara kerangka asinkron</a></li>
<li><a href="../id435534/index.html">Ilmu Data: Buku-Buku Tingkat Awal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>