<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úä üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ ‚õàÔ∏è F√°cil e f√°cil de implantar aplicativos no cartucho Tarantool (parte 2) ü§≤üèº üåÜ üßúüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mais recentemente, falamos sobre como implantar aplicativos escritos no Tarantool Cartridge . Por√©m, como a opera√ß√£o n√£o termina na implanta√ß√£o, hoje ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>F√°cil e f√°cil de implantar aplicativos no cartucho Tarantool (parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/"><p><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p>  Mais recentemente, <a href="https://habr.com/ru/company/mailru/blog/478710/">falamos</a> sobre como implantar aplicativos escritos no <a href="https://habr.com/ru/company/mailru/blog/465503/">Tarantool Cartridge</a> .  Por√©m, como a opera√ß√£o n√£o termina na implanta√ß√£o, hoje atualizaremos nosso aplicativo e entenderemos como gerenciar a topologia, o sharding e a autoriza√ß√£o, al√©m de alterar a configura√ß√£o das fun√ß√µes. </p><br><p>  Inquisidor, por favor, corte! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis">  Onde paramos </h2><br><p>  A √∫ltima vez que configuramos a seguinte topologia: </p><br><p><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p> <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">O reposit√≥rio de</a> exemplo conseguiu mudar um pouco, novos arquivos apareceram l√°, <code>getting-started-app-2.0.0-0.rpm</code> e <code>hosts.updated.2.yml</code> .  Voc√™ n√£o precisa extrair a nova vers√£o, basta fazer o download do pacote no <a href="">link</a> , e o <code>hosts.updated.2.yml</code> necess√°rio apenas para que voc√™ possa espreitar l√° em caso de dificuldades em alterar o invent√°rio atual. </p><br><p>  Se voc√™ concluiu todas as etapas da parte anterior deste tutorial, agora no <code>hosts.yml</code> hosts.yml h√° uma configura√ß√£o de cluster com duas r√©plicas de <code>storage</code> (no reposit√≥rio, este √© <code>hosts.updated.yml</code> ). </p><br><p>  Crie nossas m√°quinas virtuais: </p><br><pre> <code class="bash hljs">$ vagrant up</code> </pre> <br><p>  Instale a nova vers√£o do cartucho Tarantool de fun√ß√£o Ansible (ele conseguiu mudar, √© claro, para melhor): </p><br><pre> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p>  Portanto, a configura√ß√£o atual do cluster: </p><br><pre> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p>  V√° para <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> e verifique se o cluster est√° no estado correto. </p><br><p>  Tudo √© o mesmo da √∫ltima vez: mudaremos gradualmente esse arquivo e observaremos como o cluster muda.  Voc√™ sempre pode olhar para a vers√£o final em <code>hosts.updated.2.yml</code> </p><br><p>  Ent√£o aqui vamos n√≥s! </p><br><h2 id="obnovlyaem-prilozhenie">  Atualizando o aplicativo </h2><br><p>  Para come√ßar, vamos atualizar nosso aplicativo.  Verifique se voc√™ possui o arquivo <code>getting-started-app-2.0.0-0.rpm</code> no diret√≥rio atual (caso contr√°rio, fa√ßa o <a href="">download</a> do reposit√≥rio). </p><br><p>  Especifique o caminho para a nova vers√£o do pacote: </p><br><pre> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p>  Especificamos <code>cartridge_enable_tarantool_repo: false</code> para que a fun√ß√£o n√£o conecte o reposit√≥rio ao pacote Tarantool, que j√° instalamos na √∫ltima vez.  Isso ir√° acelerar um pouco o processo de implanta√ß√£o, mas n√£o √© absolutamente necess√°rio. </p><br><p>  Inicie o manual com a tag de <code>cartridge-instances</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p>  E verificamos se o pacote foi atualizado: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p>  Verifique se a vers√£o se tornou <code>2.0.0</code> : </p><br><pre> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p>  Agora voc√™ pode experimentar com seguran√ßa a nova vers√£o do aplicativo. </p><br><h2 id="vklyuchaem-shardirovanie">  Ativar sharding </h2><br><p>  Vamos ativar o sharding para que possamos assumir o controle das r√©plicas de <code>storage</code> posteriormente.  Isso √© feito de maneira muito simples.  Inclua a vari√°vel <code>cartridge_bootstrap_vshard</code> se√ß√£o <code>all.vars</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Lan√ßamos: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Observe que especificamos a etiqueta de <code>cartridge-config</code> do <code>cartridge-config</code> para executar apenas tarefas envolvidas na configura√ß√£o do cluster. </p><br><p>  Abra a interface do usu√°rio da Web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> e verifique se nossos buckets s√£o distribu√≠dos pelos conjuntos de r√©plicas de armazenamento na propor√ß√£o <code>2:3</code> (n√≥s especificamos esses pesos para nossos conjuntos de r√©plicas, lembra?): </p><br><p><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover">  Ativar failover autom√°tico </h2><br><p>  E agora vamos ativar o modo de failover autom√°tico para que possamos descobrir o que √© e como funciona um pouco mais tarde. </p><br><p>  Adicione o sinalizador <code>cartridge_failover</code> √† configura√ß√£o: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Novamente, iniciamos as tarefas de gerenciamento de cluster: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Depois de concluir com √™xito o manual, voc√™ pode acessar a interface da Web da Web e verificar se a op√ß√£o <code>Failover</code> no canto superior direito est√° ativada.  Para desativar o modo de failover autom√°tico, basta alterar o valor de <code>cartridge_failover</code> para <code>false</code> e executar o manual novamente. </p><br><p>  √â hora de descobrir que tipo de regime √© esse e por que o ativamos. </p><br><h2 id="razbiraemsya-s-failover-om">  Lidamos com failover </h2><br><p>  Voc√™ provavelmente notou a vari√°vel <code>failover_priority</code> que especificamos para cada replicaset.  Vamos ver o que √©. </p><br><p>  O cartucho Tarantool fornece um modo de failover autom√°tico.  Cada replicaset possui um l√≠der - a inst√¢ncia na qual est√° sendo gravada.  Se algo acontecer com o l√≠der, uma das observa√ß√µes assumir√° seu papel.  Qual?  Vamos dar uma olhada no conjunto de r√©plicas de <code>storage-2</code> : </p><br><pre> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p>  A inst√¢ncia <code>storage-2</code> que especificamos primeiro em <code>failover_priority</code> .  Na interface da Web, ele aparece primeiro na lista de inst√¢ncias de replicaset e √© marcado com uma coroa verde.  Este √© o l√≠der - a primeira inst√¢ncia especificada em <code>failover_priority</code> : </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Agora vamos ver o que acontece se algo acontecer com o l√≠der do replicaset.  Entramos na m√°quina virtual e paramos a inst√¢ncia do <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p>  De volta √† interface da Web: </p><br><p><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p>  A coroa na inst√¢ncia de <code>storage-2</code> ficou vermelha - isso significa que o l√≠der designado n√£o √© √≠ntegro.  Mas <code>storage-2-replica</code> tem uma coroa verde - essa inst√¢ncia assumiu as responsabilidades de lideran√ßa at√© o <code>storage-2</code> retornar ao servi√ßo.  Este √© um failover autom√°tico em a√ß√£o. </p><br><p>  Vamos reviver o <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p>  Tudo voltou √† estaca zero: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Vamos mudar a ordem das inst√¢ncias na prioridade do failover.  <code>storage-2-replica</code> inst√¢ncia do <code>storage-2-replica</code> um l√≠der e removeremos o <code>storage-2</code> da lista em geral: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p>  Execute <code>cartridge-replicasets</code> para inst√¢ncias do grupo <code>replicaset_storage_2</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Vamos para <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> e vemos que o l√≠der mudou: </p><br><p><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p>  Mas removemos a inst√¢ncia <code>storage-2</code> da configura√ß√£o, por que ela ainda est√° aqui?  O fato √© que o Cartridge, recebendo um novo valor de <code>failover_priority</code> organiza as inst√¢ncias da seguinte maneira: a primeira inst√¢ncia da lista se torna a l√≠der e as demais inst√¢ncias indicadas.  Inst√¢ncias n√£o mencionadas em <code>failover_priority</code> ser√£o ordenadas pelo UUID e anexadas ao final. </p><br><h2 id="izgnanie-instansa">  Inst√¢ncia de ex√≠lio </h2><br><p>  Mas e se quisermos excluir a inst√¢ncia da topologia?  Tudo √© muito simples: voc√™ precisa passar a bandeira <code>expelled</code> .  Vamos excluir a inst√¢ncia de <code>storage-2-replica</code> .  Ele √© o l√≠der agora, ent√£o Cartridge n√£o nos permitir√° fazer isso.  Mas n√£o temos medo de dificuldades e ainda tentamos: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p>  Especificamos a <code>cartridge-replicasets</code> , pois expulsar uma inst√¢ncia √© uma altera√ß√£o na topologia: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Execute o manual e veja o erro: </p><br><p><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p>  Como acabamos de ver, o Cartridge n√£o justifica expulsar o atual l√≠der do replicaset da topologia.  Isso √© bastante l√≥gico, como a replica√ß√£o √© ass√≠ncrona, a exclus√£o de um l√≠der provavelmente levar√° √† perda de dados.  Precisamos especificar outro l√≠der e somente depois excluir a inst√¢ncia.  A fun√ß√£o primeiro aplicar√° a nova configura√ß√£o do replicaset e depois lidar√° com a exce√ß√£o.  Portanto, alteramos <code>failover_priority</code> e executamos o manual novamente: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Voila, a inst√¢ncia de <code>storage-2-replica</code> desapareceu da topologia! </p><br><p><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p>  Observe que o ex√≠lio da inst√¢ncia √© realmente final e irrevog√°vel.  Ap√≥s remover a inst√¢ncia da topologia, nossa fun√ß√£o ansible interromper√° o servi√ßo systemd e excluir√° todos os arquivos desta inst√¢ncia. </p><br><p><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p>  Se voc√™ mudar de id√©ia de repente e decidir que o replicaset de <code>storage-2</code> ainda precisa de uma segunda inst√¢ncia, n√£o poder√° restaur√°-lo.  O cartucho lembra o UUID de todas as inst√¢ncias que deixaram a topologia e n√£o permitir√° que o ex√≠lio retorne.  Voc√™ pode criar uma nova inst√¢ncia com o mesmo nome e configura√ß√£o, mas obviamente ela ter√° um UUID diferente; portanto, o Cartucho permitir√° a associa√ß√£o. </p><br><h2 id="udalenie-replikaseta">  Removendo o Replicaset </h2><br><p>  J√° descobrimos que n√£o teremos permiss√£o para expulsar o l√≠der do replicaset.  Mas e se quisermos remover permanentemente a r√©plica do <code>storage-2</code> ?  Existe, √© claro, uma sa√≠da. </p><br><p>  Para n√£o perder dados, primeiro devemos transferir todos os buckets para o <code>storage-1</code> , para isso definimos o peso do replicaet do <code>storage-2</code> como <code>0</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p>  Inicie o gerenciamento de topologia: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Abra a interface do usu√°rio da Web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> e observe como todos os buckets fluem para o <code>storage-1</code> : </p><br><p><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p>  Definimos o l√≠der do <code>storage-2</code> como o sinalizador expulso e nos despedimos deste replicaset: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p>  Observe que desta vez n√£o especificamos a op√ß√£o de <code>limit</code> , pois pelo menos uma inst√¢ncia de todas para a qual lan√ßamos o manual n√£o deve ser marcada como <code>expelled</code> . </p><br><p>  Ent√£o, retornamos √† topologia original: </p><br><p><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya">  Entrar </h2><br><p>  Proponho me distrair do gerenciamento de conjuntos de r√©plicas e pensar em seguran√ßa.  Agora, qualquer usu√°rio n√£o autorizado pode gerenciar o cluster por meio da interface da Web.  Concordo, parece mais ou menos. </p><br><p>  O cartucho oferece a capacidade de conectar seu pr√≥prio m√≥dulo de autoriza√ß√£o, como LDAP (ou o que voc√™ tiver l√°), e us√°-lo para gerenciar usu√°rios e seu acesso ao aplicativo.  Mas usaremos o m√≥dulo de autoriza√ß√£o interno, que o Cartucho usa por padr√£o.  Este m√≥dulo permite executar opera√ß√µes b√°sicas com os usu√°rios (excluir, adicionar, editar) e implementa a fun√ß√£o de verifica√ß√£o de senha. <br>  Observe que nosso papel ans√≠vel requer o back-end de autoriza√ß√£o para implementar todas essas fun√ß√µes. </p><br><p>  Ent√£o, passamos da teoria para a pr√°tica.  Primeiro, torne a autoriza√ß√£o obrigat√≥ria, defina os par√¢metros da sess√£o e adicione um novo usu√°rio: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p>  O gerenciamento da autoriza√ß√£o √© realizado como parte das tarefas de <code>cartridge-config</code> do <code>cartridge-config</code> esta tag: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Em <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard, uma</a> surpresa nos espera: </p><br><p><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p>  Voc√™ pode fazer login com o <code>username</code> e <code>password</code> nosso novo usu√°rio ou como <code>admin</code> - o usu√°rio padr√£o.  Sua senha √© cookie de cluster, n√≥s especificamos esse valor na vari√°vel <code>cartridge_cluster_cookie</code> (este √© o <code>app-default-cookie</code> , voc√™ n√£o pode espiar). </p><br><p>  Ap√≥s um login bem-sucedido, abra a guia <code>Users</code> para garantir que tudo correu bem: </p><br><p><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p>  Experimente adicionar novos usu√°rios e alterar suas configura√ß√µes.  Para excluir um usu√°rio, especifique o sinalizador delete <code>deleted: true</code> para ele.  Os valores de <code>email</code> e nome <code>fullname</code> n√£o s√£o usados ‚Äã‚Äãpelo Cartucho, mas voc√™ pode especific√°-los por conveni√™ncia. </p><br><h2 id="konfiguraciya-prilozheniya">  Configura√ß√£o da aplica√ß√£o </h2><br><p>  Vamos lembrar como tudo come√ßou. </p><br><p>  Implementamos um pequeno aplicativo que armazena dados sobre clientes e suas contas banc√°rias.  Como voc√™ se lembra, este aplicativo tem 2 fun√ß√µes: <code>api</code> e <code>storage</code> .  A fun√ß√£o de <code>storage</code> lida com armazenamento de dados e implementa sharding usando a <code>vshard-storage</code> .  A segunda fun√ß√£o, <code>api</code> , implementa um servidor HTTP com uma API para gerenciamento de dados e, dentro dela, est√° conectada outra fun√ß√£o padr√£o, <code>vshard-router</code> , que controla o sharding. </p><br><p>  Ent√£o, fazemos a primeira solicita√ß√£o para a API do aplicativo.  Adicione um novo cliente: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p>  Em resposta, temos algo parecido com isto: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p>  Observe que no URL especificamos a porta da inst√¢ncia <code>app-1</code> , <code>8082</code> , porque ela implementa essa API. </p><br><p>  Agora vamos atualizar o saldo do nosso novo usu√°rio: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Na resposta, vemos o saldo atualizado: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p>  √ìtimo, tudo funciona!  A API √© implementada, o cartucho est√° envolvido no compartilhamento de dados, j√° configuramos a prioridade de failover para casos de emerg√™ncia e at√© a autoriza√ß√£o ativada.  √â hora de fazer a configura√ß√£o do aplicativo. </p><br><p>  A configura√ß√£o atual do cluster √© armazenada em um arquivo de configura√ß√£o distribu√≠do.  Cada inst√¢ncia mant√©m uma c√≥pia desse arquivo e o Cartucho garante sua sincroniza√ß√£o entre todos os n√≥s do cluster.  Podemos especificar a configura√ß√£o das fun√ß√µes de nosso aplicativo neste arquivo e o Cartridge cuidar√° da distribui√ß√£o da nova configura√ß√£o em todas as inst√¢ncias. </p><br><p>  Vamos dar uma olhada no conte√∫do atual deste arquivo.  V√° para a guia <code>Cofiguration files</code> e clique no bot√£o <code>Download</code> : </p><br><p><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p>  No <code>config.yml</code> config.yml baixado <code>config.yml</code> encontramos uma tabela vazia.  N√£o √© de admirar, porque ainda n√£o especificamos nenhum par√¢metro: </p><br><pre> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p>  De fato, o arquivo de configura√ß√£o do nosso cluster n√£o est√° vazio, ele armazena a topologia atual, as configura√ß√µes de autoriza√ß√£o e as configura√ß√µes de sharding.  Mas o Cartucho n√£o ser√° t√£o f√°cil de compartilhar essas informa√ß√µes, elas se destinam ao uso interno e, portanto, s√£o armazenadas em se√ß√µes ocultas do sistema, que n√£o podemos editar. </p><br><p>  Cada fun√ß√£o de aplicativo pode usar uma ou mais se√ß√µes de configura√ß√£o.  O download de uma nova configura√ß√£o ocorre em dois est√°gios: primeiro, todas as fun√ß√µes verificam se est√£o prontas para aceitar novos par√¢metros.  Se n√£o houver obje√ß√£o, as altera√ß√µes ser√£o aplicadas; se algu√©m for contra, ocorrer√° uma revers√£o. </p><br><p>  Vamos voltar ao nosso aplicativo.  A fun√ß√£o da <code>api</code> usa a se√ß√£o de <code>max-balance</code> , onde o saldo m√°ximo permitido √© armazenado em uma conta do cliente.  Vamos configurar esta se√ß√£o, mas, √© claro, n√£o manualmente, mas usando nossa fun√ß√£o Ansible. </p><br><p>  Portanto, agora a configura√ß√£o do aplicativo (ou melhor, parte dela dispon√≠vel para n√≥s) √© uma tabela vazia.  Adicione uma se√ß√£o de <code>max-balance</code> com um valor de <code>100000</code> .  Escrevemos a vari√°vel <code>cartridge_app_config</code> em nosso arquivo de invent√°rio: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p>  Especificamos o nome da se√ß√£o, <code>max-balance</code> e seu conte√∫do, <code>body</code> .  O conte√∫do de uma se√ß√£o pode n√£o ser apenas um n√∫mero, tamb√©m pode ser uma tabela ou uma linha, dependendo de como a fun√ß√£o √© escrita e que tipo de valor voc√™ deseja usar. </p><br><p>  Lan√ßamos: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  E verificamos se o saldo m√°ximo permitido realmente mudou: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  Em resposta, obtemos um erro, como quer√≠amos: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p>  Voc√™ pode baixar novamente o arquivo de configura√ß√£o na guia <code>Configuraion files</code> do <code>Configuraion files</code> para garantir que uma nova se√ß√£o apare√ßa l√°: </p><br><pre> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p>  Tente adicionar novas se√ß√µes √† configura√ß√£o do aplicativo, altere seu conte√∫do ou exclua-o completamente (para isso, √© necess√°rio definir o sinalizador delete <code>deleted: true</code> na se√ß√£o). </p><br><p>  Voc√™ pode descobrir como usar uma configura√ß√£o distribu√≠da em fun√ß√µes na <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">documenta√ß√£o</a> do Tarantool Cartridge. </p><br><p>  Lembre-se de chamar a <code>vagrant halt</code> para parar as <code>vagrant halt</code> quando terminar de trabalhar com elas. </p><br><h2 id="v-zaklyuchenie">  Em conclus√£o </h2><br><p>  Na √∫ltima vez, aprendemos como implantar aplicativos de cartucho Tarantool distribu√≠dos usando uma fun√ß√£o Ansible especial.  Hoje atualizamos o aplicativo e tamb√©m dominamos o gerenciamento da topologia, sharding, autoriza√ß√£o e configura√ß√£o do aplicativo. </p><br><p>  N√£o pare por a√≠, aprenda <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">diferentes abordagens</a> para escrever manuais de Ansible e use seus aplicativos com o m√°ximo conforto. </p><br><p>  Se algo n√£o funcionar para voc√™ ou se voc√™ tiver id√©ias sobre como melhorar nosso papel, sinta-se √† vontade para iniciar um <a href="https://github.com/tarantool/ansible-cartridge/issues/new">ticket</a> .  Sempre ajudaremos na solu√ß√£o do seu problema e teremos prazer em ofertas interessantes! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484192/">https://habr.com/ru/post/pt484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484178/index.html">Switch Ethernet inteligente para o planeta Terra</a></li>
<li><a href="../pt484180/index.html">PBX virtual Rostelecom: o que e como pode ser feito atrav√©s da API</a></li>
<li><a href="../pt484182/index.html">Xenobots: nanorob√¥s vivos de c√©lulas de sapo</a></li>
<li><a href="../pt484186/index.html">LDAP - "autentica√ß√£o" √© um antipadr√£o</a></li>
<li><a href="../pt484188/index.html">Padr√µes de Design de Banco de Dados</a></li>
<li><a href="../pt484194/index.html">Kubernetes traduzido em crian√ßas</a></li>
<li><a href="../pt484196/index.html">Gravando som JS de um microfone ou coment√°rios de voz</a></li>
<li><a href="../pt484198/index.html">Verso da moeda: quem ganhou e perdeu com o crescimento das a√ß√µes da Tesla</a></li>
<li><a href="../pt484200/index.html">Como definir metas para alcan√ß√°-las</a></li>
<li><a href="../pt484202/index.html">Aprendizado de m√°quina na an√°lise est√°tica do c√≥digo-fonte do programa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>