<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ñ´Ô∏è ‚ú°Ô∏è üöì Die Gefahren unsachgem√§√üer Optimierungen üöá ‚úçüèª üêí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn es darum geht, das System f√ºr maximale Leistung zu optimieren, kann es sehr leicht sein, Fehler zu machen, wenn Sie die Praktiken anderer r√ºcksic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Gefahren unsachgem√§√üer Optimierungen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471906/"> Wenn es darum geht, das System f√ºr maximale Leistung zu optimieren, kann es sehr leicht sein, Fehler zu machen, wenn Sie die Praktiken anderer r√ºcksichtslos anwenden.  Eine solche Praxis besteht darin, Nobarrier beim Mounten von Dateisystemen anzugeben. <br><br><a name="habracut"></a><h2>  Wie diese Notiz geboren wurde </h2><br>  Ich arbeite als Ingenieur bei Mail.Ru Cloud Solutions und besch√§ftige mich haupts√§chlich mit allen m√∂glichen Problemen ‚Äûrund um‚Äú den Blockspeicher, auf dem die virtuellen Maschinen unserer Benutzer liegen - und dementsprechend treten h√§ufig interessante F√§lle im Zusammenhang mit der Leistung und Stabilit√§t virtueller Maschinen auf, die ausgef√ºhrt werden Anwendungen - und insbesondere Datenbanken. <br><br>  In der Regel sehen wir in fast der H√§lfte der F√§lle w√§hrend der ‚ÄûNachbesprechung‚Äú dasselbe - ein Dateisystem, das mit der Nobarrier-Option bereitgestellt wird.  Und wenn wir fragen: "Warum haben Sie diese Option geschrieben?", Erhalten wir fast immer eine der Antwortoptionen: "Mir wurde gesagt, dass sie schneller ist. Ich habe gelesen, dass sie schneller ist. Ich wurde so eingerichtet." Danach versuchen wir h√∂flich und sorgf√§ltig, dies zu erkl√§ren SO muss nicht.  Warum?  Denn dies ist der erste sichere Schritt auf dem Weg zum Datenverlust. <br><br><h2>  Kurzer Ausflug </h2><br>  Dateisystem - Die Struktur ist sehr komplex und hoch geladen.  Um maximale Leistung zu gew√§hrleisten, werden Caching und parallele Aufzeichnung aktiv verwendet.  Dementsprechend geht ein Teil der Daten in den Cache und wird nach M√∂glichkeit / Bedarf oder "on demand" verworfen.  Eine Barriere ist eine spezielle Operation, um zu erzwingen, dass alle Caches auf die Festplatte geleert werden. <br><br>  Wenn es um Datenbanken geht, m√ºssen wir sicherstellen, dass die dem Client (Clientanwendung) best√§tigte Transaktion dauerhaft ist und nicht verschwindet. Einerseits verwenden DBMS aktiv ihr eigenes Caching, um maximale Leistung zu erzielen - und um Konsistenz zu gew√§hrleisten. Journaling wird verwendet - die √Ñnderung wird in das Protokoll geschrieben, das Protokoll wird "synchronisiert" und dann wird die √Ñnderung in die Daten geschrieben (und wenn sie geschrieben wird, gelangt sie in den Cache).  Wenn das Protokoll voll ist, wird eine erzwungene Synchronisierung mit allen Daten im Cache durchgef√ºhrt, und das Protokoll wird erneut gef√ºllt. <br><br><h2>  Synchronisierungsvorgang </h2><br>  Wenn die Synchronisierung ausgef√ºhrt wird, l√∂scht das Betriebssystem nicht nur den Seiten-Cache, sondern sendet standardm√§√üig einen Befehl zum Leeren aller Festplatten-Caches (und dies m√∂glicherweise wiederholt) - den sogenannten  <b>sp√ºlen</b> .  Das L√∂schen von Puffern ist ‚Äûteuer‚Äú und nimmt viel Zeit in Anspruch - dies ist jedoch erforderlich, da in Dateisystemen die Reihenfolge des Schreibens wichtig ist. Wenn dies verletzt wird, kann sich beispielsweise herausstellen, dass die Datei bei einem pl√∂tzlichen Neustart anstelle von Daten M√ºll enth√§lt, da das Ger√§t beschlossen, die Aufzeichnung neu zu ordnen.  Und wenn durch Flush alle Caches zwangsweise geleert werden - dies stellt sicher, dass zuerst geschrieben wird, was vor dem Flush ist, und erst dann, was danach passiert -, dh eine ‚ÄûBarriere‚Äú erstellt wird, die die Eintr√§ge in ‚Äûvor der Barriere‚Äú und ‚Äûnach der Barriere‚Äú (von hier aus) unterteilt und der Name "Barriere schreiben") - und dies erm√∂glicht es zu gew√§hrleisten, dass die Aufzeichnungen nach der Barriere nicht fr√ºher als die Aufzeichnungen vor der Barriere angewendet werden. <br><br><h2>  Nobarrier-Effekt </h2><br>  Die Nobarrier-Option deaktiviert das Senden von Forced Flush, w√§hrend das Dateisystem ausgef√ºhrt wird.  Dies f√ºhrt dazu, dass die Datens√§tze neu angeordnet werden k√∂nnen - und wenn ein Fehler auftritt, das Dateisystem (und im Allgemeinen die Daten im allgemeinen Fall) m√∂glicherweise nicht konsistent sind - erinnern wir uns an das, was im vorherigen Absatz √ºber die Aufzeichnungsreihenfolge erw√§hnt wurde. <br><br>  Warum ist diese Option enthalten?  Bei kosteng√ºnstigen SSDs ist der Flush-Betrieb sehr teuer. Beispielsweise f√ºhren kosteng√ºnstige SSDs (und viele teure SSDs, die als ‚ÄûServer‚Äú positioniert sind) 10 bis 20.000 Schreibvorg√§nge pro Sekunde ohne Flush aus und fallen bei eingeschaltetem Flush auf 1-2 Tausend ab.  In solchen F√§llen bietet Nobarrier eine erhebliche Leistungssteigerung, wodurch die oben beschriebenen Risiken f√ºr die Datenintegrit√§t entstehen. <br><br><h2>  Virtuelle Umgebung </h2><br>  Im Fall einer virtuellen Maschine - wenn wir beispielsweise √ºber die klassische Konfiguration virtueller Maschinen auf einem Linux-Hypervisor sprechen - haben wir QEMU - einen Prozess, der tats√§chlich f√ºr die Emulation von E / A f√ºr das Gastbetriebssystem verantwortlich ist.  Und was am wichtigsten ist: Wenn wir in einer virtuellen Maschine nicht dateibasierte Festplatten verwenden, liegt der Cache einer solchen virtuellen Festplatte (pl√∂tzlich!?) Im Benutzerbereich - im Adressraum des entsprechenden QEMU-Prozesses.  Und wenn dieser Prozess abst√ºrzt - zum Beispiel laut SEGFAULT / SIGSEGV -, sterben alle seine Caches damit ab.  Ein Beispiel f√ºr einen solchen Blockger√§tetreiber ist der RBD (Ceph) -Treiber. <br><br>  Und selbst wenn Sie beispielsweise nicht Ceph, sondern iSCSI / FC verwenden, verschwindet die Fehlerstufe nicht - sie wechselt einfach von QEMU zum Host-Betriebssystem (Hypervisor).  Der Hypervisor ist gefallen - sein Seitencache ist gestorben (dies gilt f√ºr io = 'threads' in Kombination mit cache = 'writeback' oder cache = 'unsicher').  Ups <br><br><h2>  s / Cloud / Alien-Computer / g </h2><br>  Wenn Ihre virtuelle Maschine in der Cloud bereitgestellt wird ... Dann wissen Sie nicht, wie der Hypervisor konfiguriert ist, wie QEMU konfiguriert ist, welche Festplattentreiber betroffen sind, ob der Seitencache des Hosts funktioniert usw., und Sie k√∂nnen dies in den allermeisten F√§llen nicht beeinflussen.  Und selbst wenn es Ihre Cloud ist - wo Sie all dies wissen und es mehr oder weniger kontrollieren -, ist es keineswegs eine Tatsache, dass Ihr Hypervisor nicht "herunterf√§llt" - und den gesamten Datencache vergr√§bt. <br><br><h2>  Zusammenfassung </h2><br>  Die Verwendung von Nobarrier in der Cloud bedeutet, dass Sie Ihre Daten sehr wahrscheinlich gef√§hrden.  Sind Sie sicher, dass Sie auf Kosten solcher Risiken eine h√∂here Produktivit√§t erzielen m√∂chten? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de471906/">https://habr.com/ru/post/de471906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de471886/index.html">VMmanager 6: Einf√ºhrung in die Box und Vergleich mit der vorherigen Generation</a></li>
<li><a href="../de471890/index.html">Variationsinferenz - was ist das und was isst es?</a></li>
<li><a href="../de471892/index.html">6 praktische Geschichten von unseren SRE-Wochentagen</a></li>
<li><a href="../de471896/index.html">Das Inside Playbook. Netzwerkfunktionen in der neuen Ansible Engine 2.9</a></li>
<li><a href="../de471904/index.html">Ressourcenplaner bei HPE InfoSight</a></li>
<li><a href="../de471908/index.html">Die unerwartete Sch√∂nheit von Primzahlen</a></li>
<li><a href="../de471912/index.html">Englisch lernen: 7 praktische M√∂glichkeiten, Ihren Wortschatz zu erweitern</a></li>
<li><a href="../de471914/index.html">Funktionsweise des Sega Mega Drive-Grafiksystems: Videoanzeigeprozessor</a></li>
<li><a href="../de471918/index.html">SwiftUI: Bekanntschaft</a></li>
<li><a href="../de471924/index.html">Einf√ºhrung in Sass-Module</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>