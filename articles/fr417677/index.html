<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☠️ 🎿 🕑 Migration d'un projet de yii1 vers yii2 via un travail unique 👨🏾‍✈️ 😮 ♈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="«À quelques reprises», j'ai dû faire face à la migration de projets de yii1 à yii2 et je veux partager mon expérience avec la communauté. Il n'y a rie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration d'un projet de yii1 vers yii2 via un travail unique</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417677/"><img src="https://habrastorage.org/webt/82/pe/wu/82pewu1kgru2yvayuvehfbeb258.jpeg"><br><br>  «À quelques reprises», j'ai dû faire face à la migration de projets de yii1 à yii2 et je veux partager mon expérience avec la communauté.  Il n'y a rien de compliqué dans ce processus et il n'y aura pas de révélations.  La nature de la publication est votre expérience + tutoriel pour les débutants. <br><br><h4>  Contexte </h4><br>  Si les projets historiquement réalisés sur la première version de yii continuent d'évoluer, alors chaque développeur qui travaille avec eux tôt ou tard se <i>pose</i> la question: «à <i>quel point ce serait bien si c'était sur yii2</i> ». <br><br>  Mais les choses ne dépassent généralement pas les pensées, car  la quantité de travail semble colossale.  En règle générale, le volume est énorme, mais toujours pas prohibitif - selon le proverbe «les yeux ont peur».  De plus, pour la transition vers l'action, une certaine volonté est nécessaire (je prépare en interne la migration du premier projet depuis près d'un an). <br><br>  Mon idée de migration est sous cat. <br><a name="habracut"></a><br>  Avant de "montrer le code", j'écrirai beaucoup de lettres "pourquoi ai-je fait cela", car  des raisons déterminent la nature du travail.  J'ai eu 2 cas similaires. <br><br>  Dans le premier projet, tout était simple.  Je suis à la fois copropriétaire et seul développeur.  Par conséquent, la raison pour laquelle "je suis juste fatigué d'écrire en yii1" est assez convaincante.  L'écriture doit être "élevée", sinon le résultat peut être une <s>merde de</s> mauvaise qualité. <br><br>  Dans le second cas, je suis entrepreneur dans un projet qui a été écrit par différents développeurs depuis longtemps sans architecture claire.  Par conséquent, la sortie était un énorme tas de code hérité.  Une réécriture comme celle-ci est plus facile à <s>tirer vous-même en</s> quittant; le client ne reconnaît pas le refactoring pour le refactoring, donc chaque nouveau développeur a encore plus augmenté le tas. <br><br>  La situation est dans l'impasse: tout le monde comprend qu'il y a un problème avec le code, mais ils ne peuvent pas sortir de ce cercle.  J'ai suggéré une migration modulaire progressive vers yii2.  Après 1,5 mois, une partie du site a commencé à fonctionner sur yii2, ce qui signifie qu'il y a un endroit pour migrer et une infrastructure où vous pouvez travailler de manière significative.  Bien sûr, vous pouvez continuer à mal écrire, mais vous ne pouvez plus vous justifier avec le «regard sur ce qu'est l'horreur». <br><br><h3>  Réfléchissez avant de commencer </h3><br>  Pour ma part, j'ai identifié plusieurs règles.  Si vous lancez une migration, alors soit ils doivent être respectés, soit vous ne devez pas la démarrer. <br><br><ol><li>  Il est nécessaire de <i>comprendre et d'accepter</i> «pourquoi avons-nous besoin d'hémorroïdes».  Il peut y avoir n'importe quelle motivation, mais elle devrait l'emporter sur tous les inconvénients avec une grande marge. </li><li>  Vous ne devez pas démarrer la migration si le projet n'a pas d'avenir clair dans les prévisions 2 à 3 ans à l'avance.  Ou vous le faites pour le plaisir. </li><li>  Nous écrivons toutes les nouvelles fonctionnalités, tous les développements, tous les nouveaux sur yii2.  En yii1, seul le support devrait rester.  Si cette règle n'est pas respectée, vous recevrez immédiatement 2 branches actives, ce qui nécessitera 2 fois plus de ressources.  Et, comme il n'y a toujours pas assez de ressources, tout cela peut s'arrêter. </li><li>  Ne définissez pas la tâche «réécrire bêtement tout ce qui est».  «Tout réécrire» est si abstrait et ennuyeux que si vous le dites à votre équipe dans ce libellé, vous pouvez lire beaucoup de choses intéressantes à leur sujet dans leurs visages tristes. </li><li>  Parce que  même si «tout ce que vous voulez» ne peut pas être réécrit immédiatement, alors vous avez besoin d'un plan de migration progressive - par pages, par services, par modules. </li><li>  La chose la plus importante!  Il est préférable de considérer la migration vers yii2 comme une refonte profonde de l'ensemble du projet visant au développement.  Ensuite, il peut s'avérer qu'un tiers du projet n'a pas du tout besoin d'être réécrit (s'il fonctionne bien "tel quel" et ne nécessite qu'un soutien minimal), et qu'une partie du projet peut être magnifiquement enterrée.  C'est-à-dire  non seulement de tuer des services / pages, mais aussi de refaire le projet afin qu'ils ne soient tout simplement pas nécessaires. </li></ol><br><h3>  Idée de migration </h3><br>  Mon idée de migration est la collaboration simultanée de deux branches d'un même projet sur yii1 et yii2 dans le même domaine, sur le même hôte virtuel.  Progressivement, portez étape par étape les services / pages / modules vers yii2. <br><br>  Par exemple, il existe un site qui fonctionne sur yii1 <br><br><pre><code class="dos hljs">site.ru/ #  site.ru/news #  site.ru/pages #  site.ru/comments # </code> </pre> <br>  Nous avons copié les nouvelles sur yii2, reçu: <br><br><pre> <code class="dos hljs">site.ru/ #  site.ru/news #  (yii2) site.ru/pages #  site.ru/comments # </code> </pre> <br>  Avis réécrits, reçus <br><br><pre> <code class="dos hljs">site.ru/ #  site.ru/news #  (yii2) site.ru/pages #  site.ru/comments #  (yii2)</code> </pre> <br>  Et donc progressivement, page par page, jusqu'à ce que nous réécrivions tout ce que nous voulons réécrire.  Il est clair que plus nous réécrivons, plus le processus se déroule facilement.  Le plus difficile est toujours la première étape: première page, premier module, premier service. <br><br><h2>  Première partie  Juste pour travailler en même temps </h2><br>  J'ajouterai des tautologies, mais tout est vraiment simple.  Dans le cas le plus simple, conservez les deux branches (yii1 et yii2) dans le même espace de travail, comme ceci: <br><br><pre> <code class="dos hljs">/var/www/site/htdocs/ - DOCUMENT_ROOT   /var/www/site/yii1/ -   yii1 /var/www/site/yii2/ -   yii2</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Ou alors</b> <div class="spoiler_text"><pre> <code class="dos hljs">/var/www/site/public_html/ - DOCUMENT_ROOT   /var/www/site/protected/ -   yii1 /var/www/site/yii2/ -   yii2</code> </pre> <br>  ou alors <br><pre> <code class="dos hljs">/var/www/site/ - DOCUMENT_ROOT   /var/www/site/protected/ -   yii1 /var/www/site/yii2/ -   yii2</code> </pre><br></div></div><br>  Peu importe comment nommer et placer des répertoires.  Il est nécessaire de s'assurer que le code sur yii1 et yii2 se trouve à proximité et est disponible pour fonctionner dans un hôte virtuel.  Et toute la magie du travail simultané sera dans les scripts d'entrée index.php et .htaccess. <br><br><h4>  Quels sont les avantages de cette approche: </h4><br><ul><li>  Dans votre environnement de développement, 2 branches de projet seront disponibles immédiatement.  Cela peut être pratique, car  pendant longtemps, vous devez travailler avec eux en même temps, en changeant d'avant en arrière. <br></li><li>  Les deux projets auront un accès direct à DOCUMENT_ROOT, ce qui est important pour un travail simple avec la statique css / js. </li></ul><br>  Les inconvénients peuvent être à la fois esthétiques (par type: quel obstacle à interférer tous ensemble), et associés à un travail multi-utilisateurs.  Oui, vous pouvez fractionner les emplacements de stockage de code et fractionner les projets dans un environnement de développement.  Cela ne change pas l'essence, ajoutez simplement des nuances. <br><br>  Personnellement, j'ai créé un projet distinct pour la branche yii2 dans l'EDI, même lorsque les fichiers de branche se trouvaient physiquement à proximité. <br><br><h3>  Exemple de base.  Sources des branches de projet yii1 / yii2 dans un répertoire </h3><br>  DOCUMENT_ROOT utilise 2 scripts d'entrée. <br><br><pre> <code class="dos hljs">index.php -  yii1 index_yii2.php -  yii2.</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Dans la structure des fichiers</b> <div class="spoiler_text"><pre> <code class="dos hljs">htdocs/ htdocs/index.php htdocs/index_yii2.php yii1/ yii2/</code> </pre><br></div></div><br>  <b>index.php</b> <br>  Si vous ne changez pas la structure de fichiers du projet en yii1, votre index.php restera inchangé. <br><br><div class="spoiler">  <b class="spoiler_title">Par exemple</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* * -     . *   , ..     yii1 index.php *       . */</span></span> $app = Yii::createApplication(<span class="hljs-string"><span class="hljs-string">'WebApplication'</span></span>, $config); $app-&gt;run(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br></div></div><br>  <b>index_yii2.php</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> defined(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); defined(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>, <span class="hljs-string"><span class="hljs-string">'dev'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     yii2  index_yii2.php, //      «». $path = '/../yii2/'; require(__DIR__ . $path.'vendor/autoload.php'); require(__DIR__ . $path.'vendor/yiisoft/yii2/Yii.php'); require(__DIR__ . $path.'common/config/bootstrap.php'); require(__DIR__ . $path.'frontend/config/bootstrap.php'); $config = yii\helpers\ArrayHelper::merge( require(__DIR__ . $path.'common/config/main.php'), require(__DIR__ . $path.'common/config/main-local.php'), require(__DIR__ . $path.'frontend/config/main.php'), require(__DIR__ . $path.'frontend/config/main-local.php') ); (new yii\web\Application($config))-&gt;run();</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><br>  <b>.htaccess</b> <br>  Dans .htaccess, nous ferons le routage entre yii1 et yii2 <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Options</span></span></span></span> +FollowSymlinks RewriteEngine <span class="hljs-literal"><span class="hljs-literal">On</span></span> RewriteBase / #    yii2 # #   RewriteRule ^test index_yii2.php<span class="hljs-meta"><span class="hljs-meta"> [L] RewriteRule ^news index_yii2.php [L] #   action RewriteRule ^page/one index_yii2.php [L] #       RewriteCond %{REQUEST_FILENAME} !-f RewriteCond %{REQUEST_FILENAME} !-d #     yii1 RewriteRule . index.php</span></span></code> </pre><br>  C'est-à-dire  Les URL suivantes sont gérées par index_yii2.php et exécutées sur yii2. <br><br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">https://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">site</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">https</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">site</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">news</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">https</span></span></span><span class="hljs-function">://</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">site</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">page</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">one</span></span></span></span></code> </pre><br>  Le reste du site est index.php (yii1). <br><br>  Il s'agit d'un lancement simultané de base.  Bien sûr, chacun aura ses propres nuances: une équipe, des utilisateurs, des droits d'accès, des serveurs, différents référentiels, etc.  Et chacun aura son propre jardin. <br><br><h3>  Les codes sources des branches yii1 / yii2 sont distribués dans des répertoires </h3><br>  Par exemple, si vous avez votre propre serveur, vous pouvez publier le stockage des branches de projet dans différents répertoires. <br><br><pre> <code class="dos hljs">/var/www/site/htdocs - DOCUMENT_ROOT    site.ru /var/www/site/protected -   yii1 /srv/site_yii2 -   yii2</code> </pre><br>  Ensuite, vous devez modifier le chemin d'accès au répertoire avec le projet yii2 dans index_yii2.php.  Bien sûr, cela fonctionnera s'il est désactivé ou si open_basedir est configuré.  Plus les droits correspondants sur le serveur et désactivé / configuré, SELinux. <br><br><div class="spoiler">  <b class="spoiler_title">index_yii2.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> defined(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_DEBUG'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); defined(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> define(<span class="hljs-string"><span class="hljs-string">'YII_ENV'</span></span>, <span class="hljs-string"><span class="hljs-string">'dev'</span></span>); $pathYii2 = <span class="hljs-string"><span class="hljs-string">'/srv/site_yii2/'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'vendor/yiisoft/yii2/Yii.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'common/config/bootstrap.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'frontend/config/bootstrap.php'</span></span>; $config = yii\helpers\ArrayHelper::merge( <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'common/config/main.php'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'common/config/main-local.php'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'frontend /config/main.php'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> $pathYii2 . <span class="hljs-string"><span class="hljs-string">'frontend /config/main-local.php'</span></span> ); (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> yii\web\Application($config))-&gt;run();<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br></div></div><br><h3>  Et ensuite </h3><br>  S'il y a des utilisateurs sur le site, alors l'autorisation unique est un élément critique sans lequel le fonctionnement simultané de 2 succursales est, en fait, impossible.  Dans le prochain article, j'ai l'intention de montrer à quel point il est facile d'organiser une seule autorisation.  Par exemple, l'autorisation elle-même reste dans yii1, mais les utilisateurs autorisés sont visibles de manière transparente dans la branche yii2 ou vice versa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417677/">https://habr.com/ru/post/fr417677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417665/index.html">La grammaire anglaise comme mathématique. Par où commencer pour ceux qui n'ont pas travaillé</a></li>
<li><a href="../fr417667/index.html">AI. Traqueur de barrière tactique</a></li>
<li><a href="../fr417671/index.html">Nouvelles fonctionnalités du langage de programmation ABAP dans les webinaires de SAP</a></li>
<li><a href="../fr417673/index.html">L'enquête mène à Solar Dozor: 5 cas non standard révélés par DLP</a></li>
<li><a href="../fr417675/index.html">Localisation de jeux et d'applications dans Unity. Rapide et facile</a></li>
<li><a href="../fr417679/index.html">L'héritage grave du passé. Problèmes de ligne de commande Windows</a></li>
<li><a href="../fr417681/index.html">Immersion en développement sur Ethereum. Partie 5: Oraclize</a></li>
<li><a href="../fr417683/index.html">Code obsolète - Code tiers</a></li>
<li><a href="../fr417685/index.html">Webinaires Skillbox Friday: continuer à apprendre gratuitement</a></li>
<li><a href="../fr417687/index.html">Asymétrie de vie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>